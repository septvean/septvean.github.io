[{"id":0,"href":"/backend/python/aiohttp/tutorial/","title":"Aiohttp åŸºç¡€æ•™ç¨‹","parent":"Aiohttp","content":" 1. aiohttp æ˜¯ä»€ä¹ˆï¼Ÿ aiohttp æ˜¯ Python æœ€ä¸»æµçš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯/æœåŠ¡ç«¯åº“ï¼Œä¸ asyncio æ­é…ä½¿ç”¨ã€‚\nç›¸æ¯” requestsï¼š\nèƒ½åŠ› requests aiohttp å¼‚æ­¥ âŒ âœ… å¹¶å‘å¤§é‡è¯·æ±‚ âŒ âœ… æ–‡ä»¶ä¸‹è½½ âœ… âœ… æµå¼è¯»å– âœ… âœ… è¿æ¥æ±  âŒ âœ… ä¸»è¦ç”¨äºï¼š\nâ—ï¸é«˜å¹¶å‘ HTTP è¯·æ±‚ â—ï¸API é‡‡é›†/çˆ¬è™« â—ï¸å¼‚æ­¥å¾®æœåŠ¡å®¢æˆ·ç«¯ â—ï¸ä¸‹è½½å¤§æ–‡ä»¶ï¼ˆæµå¼ï¼‰ 2. å®‰è£… pip install aiohttp 3. æœ€åŸºæœ¬çš„ GET/POST GET è¯·æ±‚ import aiohttp import asyncio async def main(): async with aiohttp.ClientSession() as session: async with session.get(\u0026#34;https://httpbin.org/get\u0026#34;) as resp: print(await resp.json()) asyncio.run(main()) POST è¯·æ±‚ï¼ˆJSONï¼‰ async with session.post(\u0026#34;https://httpbin.org/post\u0026#34;, json={\u0026#34;a\u0026#34;: 1}) as resp: data = await resp.json() 4. æ·»åŠ  Headers / Token headers = { \u0026#34;Authorization\u0026#34;: \u0026#34;Bearer your-token\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;martin/1.0\u0026#34; } async with session.get(url, headers=headers) as resp: data = await resp.json() ç”¨ FastAPI + JWTï¼Œè¿™ä¸ªå†™æ³•å¾ˆå¸¸ç”¨ã€‚\n5. Query å‚æ•° params = {\u0026#34;page\u0026#34;: 1, \u0026#34;size\u0026#34;: 20} async with session.get(url, params=params) as resp: print(await resp.json()) aiohttp ä¼šè‡ªåŠ¨ç¼–ç ã€‚\n6. è¶…æ—¶è®¾ç½® timeout = aiohttp.ClientTimeout(total=10) # æ€»è¶…æ—¶ 10 ç§’ async with aiohttp.ClientSession(timeout=timeout) as session: ... 7. Cookie async with session.get(url, cookies={\u0026#39;sessionid\u0026#39;: \u0026#39;abc123\u0026#39;}) as resp: ... 8. æ–‡ä»¶ä¸‹è½½ï¼ˆæµå¼è¯»å– ğŸ”¥ï¼‰ è¿™æ˜¯ aiohttp æœ€å¸¸ç”¨çš„åœºæ™¯ä¹‹ä¸€ï¼š\nasync def download(url, filepath): async with aiohttp.ClientSession() as session: async with session.get(url) as resp: with open(filepath, \u0026#34;wb\u0026#34;) as f: async for chunk in resp.content.iter_chunked(1024): f.write(chunk) asyncio.run(download(\u0026#34;https://example.com/file.zip\u0026#34;, \u0026#34;file.zip\u0026#34;)) æ”¯æŒå¤§æ–‡ä»¶ï¼Œä¸ä¼šçˆ†å†…å­˜ã€‚\n9. ä¸Šä¼ æ–‡ä»¶ï¼ˆmultipartï¼‰ data = aiohttp.FormData() data.add_field(\u0026#34;file\u0026#34;, open(\u0026#34;a.jpg\u0026#34;, \u0026#34;rb\u0026#34;), filename=\u0026#34;a.jpg\u0026#34;) async with session.post(url, data=data) as resp: print(await resp.json()) 10. ä½¿ç”¨è¿æ¥æ± ï¼ˆæ¨èç”¨äºå¤§é‡è¯·æ±‚ï¼‰ conn = aiohttp.TCPConnector(limit=100) # æœ€å¤§100ä¸ªè¿æ¥ async with aiohttp.ClientSession(connector=conn) as session: ... é«˜å¹¶å‘æ—¶æ¨èè®¾ç½® limitã€‚\n11. å¹¶å‘æ‰¹é‡è¯·æ±‚ï¼ˆæ ¸å¿ƒåŠŸèƒ½ğŸ”¥ï¼‰ import asyncio import aiohttp async def fetch(session, url): async with session.get(url) as resp: return await resp.text() async def main(): urls = [ \u0026#34;https://httpbin.org/get?a=1\u0026#34;, \u0026#34;https://httpbin.org/get?a=2\u0026#34;, \u0026#34;https://httpbin.org/get?a=3\u0026#34;, ] async with aiohttp.ClientSession() as session: tasks = [fetch(session, u) for u in urls] results = await asyncio.gather(*tasks) print(results) asyncio.run(main()) é«˜å¹¶å‘å¤„ç† API / çˆ¬è™«ï¼Œæ€§èƒ½éå¸¸å¼ºã€‚\n12. æ•è·å¼‚å¸¸ from aiohttp import ClientError try: async with session.get(url) as resp: resp.raise_for_status() except ClientError as e: print(f\u0026#34;è¯·æ±‚å¤±è´¥: {e}\u0026#34;) 13. aiohttp æœåŠ¡ç«¯ï¼ˆå¯é€‰ï¼‰ ä½ å¯èƒ½ä¸å¸¸ç”¨ï¼ŒFastAPI æ›´ç°ä»£ä¸€äº›ã€‚\næœ€ç®€æœåŠ¡å™¨ï¼š\nfrom aiohttp import web async def hello(request): return web.json_response({\u0026#34;msg\u0026#34;: \u0026#34;Hello\u0026#34;}) app = web.Application() app.add_routes([web.get(\u0026#39;/\u0026#39;, hello)]) web.run_app(app, port=8000) 14. æœ€ä½³å®è·µæ±‡æ€»ï¼ˆé€‚åˆç”Ÿäº§ï¼‰ åœºæ™¯ æ¨èå†™æ³• é«˜å¹¶å‘ API è°ƒç”¨ ç»Ÿä¸€ ClientSessionï¼Œä½¿ç”¨è¿æ¥æ±  æ–‡ä»¶ä¸‹è½½ async for chunk æµå¼è¯»å– ä¸Šä¼  FormData Token headers è®¿é—®ç¬¬ä¸‰æ–¹æœåŠ¡ è®¾ç½®è¶…æ—¶ + é‡è¯• å¼‚æ­¥ä»»åŠ¡æ±  asyncio.gather 15. å¸¸ç”¨æ¨¡å¼ï¼šä¼šè¯å¤ç”¨ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ class AsyncHTTPClient: def __init__(self): self.session = aiohttp.ClientSession( timeout=aiohttp.ClientTimeout(total=10), connector=aiohttp.TCPConnector(limit=100) ) async def get(self, url, **kwargs): async with self.session.get(url, **kwargs) as resp: return await resp.json() async def close(self): await self.session.close() client = AsyncHTTPClient() è¿™ç§å†™æ³•å¯ä»¥ç›´æ¥ç”¨åœ¨ä½ çš„ FastAPI é¡¹ç›®é‡Œä½œä¸ºå•ä¾‹ï¼Œæ€§èƒ½éå¸¸å¥½ã€‚\n","description":" 1. aiohttp æ˜¯ä»€ä¹ˆï¼Ÿ aiohttp æ˜¯ Python æœ€ä¸»æµçš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯/æœåŠ¡ç«¯åº“ï¼Œä¸ asyncio æ­é…ä½¿ç”¨ã€‚\nç›¸æ¯” requestsï¼š\nèƒ½åŠ› requests aiohttp å¼‚æ­¥ âŒ âœ… å¹¶å‘å¤§é‡è¯·æ±‚ âŒ âœ… æ–‡ä»¶ä¸‹è½½ âœ… âœ… æµå¼è¯»å– âœ… âœ… è¿æ¥æ±  âŒ âœ… ä¸»è¦ç”¨äºï¼š\nâ—ï¸é«˜å¹¶å‘ HTTP è¯·æ±‚ â—ï¸API é‡‡é›†/çˆ¬è™« â—ï¸å¼‚æ­¥å¾®æœåŠ¡å®¢æˆ·ç«¯ â—ï¸ä¸‹è½½å¤§æ–‡ä»¶ï¼ˆæµå¼ï¼‰ 2. å®‰è£… pip install aiohttp 3. æœ€åŸºæœ¬çš„ GET/POST GET è¯·æ±‚ import aiohttp import asyncio async def main(): async with aiohttp.ClientSession() as session: async with session.get(\u0026#34;https://httpbin.org/get\u0026#34;) as resp: print(await resp.json()) asyncio.run(main()) POST è¯·æ±‚ï¼ˆJSONï¼‰ async with session.post(\u0026#34;https://httpbin.org/post\u0026#34;, json={\u0026#34;a\u0026#34;: 1}) as resp: data = await resp.json() 4. æ·»åŠ  Headers / Token headers = { \u0026#34;Authorization\u0026#34;: \u0026#34;Bearer your-token\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;martin/1.0\u0026#34; } async with session.get(url, headers=headers) as resp: data = await resp.json() ç”¨ FastAPI + JWTï¼Œè¿™ä¸ªå†™æ³•å¾ˆå¸¸ç”¨ã€‚\n"},{"id":1,"href":"/operations/ansible/tutorial/","title":"Ansible åŸºç¡€æ•™ç¨‹","parent":"Ansible","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€ç³»ç»ŸåŒ–ã€å¯ç”¨äºç”Ÿäº§çš„ Ansible è¯¦ç»†ä»‹ç»ï¼ŒåŒ…å«æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€æœ€ä½³å®è·µã€å¸¸ç”¨æ¨¡å—ã€ç›®å½•ç»“æ„ç¤ºä¾‹ã€Playbook è®¾è®¡è§„èŒƒï¼Œä»¥åŠé€‚åˆä½  Kubernetes / Linux / DevOps åœºæ™¯çš„å®æˆ˜å»ºè®®ã€‚\nğŸ§© ä¸€ã€Ansible æ˜¯ä»€ä¹ˆï¼Ÿ Ansible = è‡ªåŠ¨åŒ–è¿ç»´ + é…ç½®ç®¡ç† + åº”ç”¨éƒ¨ç½² + ç¼–æ’å·¥å…·\nç‰¹ç‚¹ï¼š\nAgentlessï¼ˆæ— å®¢æˆ·ç«¯ï¼‰ï¼šè¢«ç®¡ç†èŠ‚ç‚¹é€šè¿‡ SSH æˆ– WinRMï¼Œä¸éœ€è¦å®‰è£…å®¢æˆ·ç«¯ç¨‹åº Idempotentï¼ˆå¹‚ç­‰ï¼‰ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼ˆè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ”¹å˜ï¼‰ Declarativeï¼ˆå£°æ˜å¼ï¼‰ï¼šå†™â€œæƒ³è¦çš„çŠ¶æ€â€ï¼Œç”± Ansible è´Ÿè´£å®ç° Simpleï¼ˆæ˜“ä¸Šæ‰‹ï¼‰ï¼šæ ¸å¿ƒç”¨ YAML Extensibleï¼ˆæ‰©å±•æ€§å¼ºï¼‰ï¼šæ¨¡å—ã€æ’ä»¶ã€è§’è‰²ä½“ç³»éå¸¸çµæ´» é€‚åˆå¤šå¹³å°ï¼šLinuxã€Unixã€Windowsã€ç½‘ç»œè®¾å¤‡ï¼ˆCiscoã€Juniperï¼‰ã€äº‘å¹³å°ï¼ˆAWSã€AliCloudï¼‰ é€‚ç”¨äºï¼š\næœåŠ¡å™¨ä¸€é”®åˆå§‹åŒ– Kubernetes é›†ç¾¤éƒ¨ç½² CI/CD ç¯å¢ƒè‡ªåŠ¨åŒ– åº”ç”¨å‘å¸ƒï¼ˆNginxã€MySQLã€Redisã€PostgreSQLã€Dockerï¼‰ é˜²ç«å¢™ / ç½‘ç»œè®¾å¤‡é…ç½® æ‰¹é‡ä½œä¸šæ‰§è¡Œï¼ˆlike SaltStack, but agentlessï¼‰ ğŸ› ï¸ äºŒã€Ansible çš„æ¶æ„ Ansible Controllerï¼ˆæ§åˆ¶èŠ‚ç‚¹ï¼‰ | |â€”â€” SSH / WinRM / API | Managed Hostsï¼ˆè¢«ç®¡èŠ‚ç‚¹ï¼‰ æ ¸å¿ƒç»„æˆï¼š\nç»„ä»¶ è¯´æ˜ Inventory ä¸»æœºæ¸…å•ï¼ˆä¸»æœºç»„ã€å˜é‡ï¼‰ Module æ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½æ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰ Play å®šä¹‰â€œå¯¹å“ªäº›ä¸»æœºæ‰§è¡Œå“ªäº›ä»»åŠ¡â€ Playbook YAML æ–‡ä»¶ï¼ŒåŒ…å«å¤šä¸ª Play Role ç»“æ„åŒ–è„šæœ¬é›†åˆï¼ˆæ¨¡æ¿ã€å˜é‡ã€ä»»åŠ¡ï¼‰ Facts è‡ªåŠ¨æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼ˆCPU/Mem/OS/ç½‘å¡ï¼‰ Plugins æ‰§è¡Œæ’ä»¶ï¼Œå¦‚ connectionã€lookupsã€filters ğŸ“¦ ä¸‰ã€Ansible Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰ åŸºç¡€å†™æ³•ï¼š\n[web] 192.168.1.10 192.168.1.11 [db] db01 ansible_host=192.168.1.20 ansible_user=root åˆ†ç»„åµŒå¥—ï¼š\n[prod:children] web db Group Vars:\n# group_vars/web.yml http_port: 80 max_clients: 200 Host Vars:\n# host_vars/db01.yml mysql_port: 3306 ğŸ¯ å››ã€Moduleï¼ˆæ¨¡å—ï¼‰ Ansible çš„æ ¸å¿ƒæ˜¯æ¨¡å—ã€‚å¸¸ç”¨æ¨¡å—åˆ†ç±»å¦‚ä¸‹ï¼š\nğŸ“Œ 1. ç³»ç»Ÿç®¡ç† æ¨¡å— ä½œç”¨ shell / command æ‰§è¡Œå‘½ä»¤ï¼ˆéä¼˜å…ˆï¼Œå°½é‡ç”¨ä¸“ç”¨æ¨¡å—ï¼‰ user / group ç®¡ç†ç”¨æˆ·ã€æƒé™ service ç®¡ç†ç³»ç»ŸæœåŠ¡ cron å®šæ—¶ä»»åŠ¡ lineinfile ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­ç‰¹å®šè¡Œ copy / template ä¸Šä¼ æ–‡ä»¶ä¸æ¨¡æ¿ ğŸ“Œ 2. æ–‡ä»¶ä¸ç›®å½• æ¨¡å— ä½œç”¨ file åˆ›å»ºç›®å½•ã€è½¯é“¾ã€ä¿®æ”¹æƒé™ unarchive è§£å‹æ–‡ä»¶ synchronize rsync åŒæ­¥ ğŸ“Œ 3. è½¯ä»¶åŒ… æ¨¡å— ä½œç”¨ yum RHEL/CentOS apt Ubuntu/Debian package é€šç”¨æ¥å£ ğŸ“Œ 4. æ•°æ®åº“ æ¨¡å— ç”¨é€” mysql_db / mysql_user MySQL ç›¸å…³ postgresql_db / postgresql_user PostgreSQL mongodb_user MongoDB ğŸ“Œ 5. äº‘å¹³å°ä¸å®¹å™¨ æ¨¡å— ç”¨é€” docker_container åˆ›å»º/ç®¡ç† Docker å®¹å™¨ docker_image æ‹‰å–é•œåƒ k8s Kubernetes èµ„æºç®¡ç† â­ äº”ã€Playbook ç»“æ„ ä¾‹å­ï¼šéƒ¨ç½² Nginx\n- name: Install Nginx hosts: web become: yes tasks: - name: Install package apt: name: nginx state: present - name: Copy nginx conf template: src: nginx.conf.j2 dest: /etc/nginx/nginx.conf notify: restart nginx handlers: - name: restart nginx service: name: nginx state: restarted ç‰¹ç‚¹ï¼š\nå¹‚ç­‰ è‡ªåŠ¨è§¦å‘ handler æ¨¡å—åŒ–é…ç½® â™»ï¸ å…­ã€Rolesï¼ˆç”Ÿäº§å¼ºçƒˆæ¨èï¼‰ Roles = å®Œæ•´çš„è½¯ä»¶éƒ¨ç½²æ¨¡æ¿ã€‚\nç»“æ„ï¼š\nroles/ nginx/ tasks/ templates/ files/ vars/ handlers/ meta/ ä½¿ç”¨æ–¹å¼ï¼š\n- hosts: web roles: - nginx ä½ é¡¹ç›®é‡Œæ¯ä¸ªæœåŠ¡å»ºè®®ç”¨ä¸€ä¸ª Roleï¼šmysqlã€redisã€kubeletã€dockerã€node-exporterâ€¦\nâš™ï¸ ä¸ƒã€Ansible Galaxyï¼ˆå®˜æ–¹/ç¤¾åŒºè§’è‰²å¸‚åœºï¼‰ å®‰è£…ç¤¾åŒº Nginx è§’è‰²ï¼š\nansible-galaxy install geerlingguy.nginx ä½ å¯ä»¥å¿«é€Ÿè·å–å®˜æ–¹æœ€ä½³å®è·µç»“æ„ã€‚\nğŸ§ª å…«ã€Ansible å®æˆ˜æŠ€å·§ï¼ˆç»™ä½  Kubernetes/DevOps åœºæ™¯ï¼‰ 1. ä¸€é”®åˆå§‹åŒ–æœåŠ¡å™¨ è®¾ç½® hostname ç¦ç”¨ swapï¼ˆKubernetes è¦æ±‚ï¼‰ ä¼˜åŒ– sysctl é…ç½® limits å®‰è£…åŸºæœ¬è½¯ä»¶åŒ… é…ç½®æ—¶åŒº é…ç½® Docker / Containerd å†™ä¸€ä¸ª init_server role å³å¯ã€‚\n2. Kubernetes é›†ç¾¤éƒ¨ç½² ä½ å¯ä»¥ä½¿ç”¨ Ansibleï¼š\néƒ¨ç½² K8Sï¼ˆkubeadmï¼‰ éƒ¨ç½² Calico / Cilium è‡ªåŠ¨ç”Ÿæˆ kubeadm-config.yaml åŒæ­¥è¯ä¹¦ å‡çº§é›†ç¾¤ éå¸¸é€‚åˆ Calico/kube-proxy è°ƒä¼˜åœºæ™¯ã€‚\n3. åº”ç”¨å‘å¸ƒï¼ˆNginx/MySQL/Redis/PostgreSQLï¼‰ ç»“åˆä»¥ä¸‹æ¨¡å—ï¼š\ntemplate ç”Ÿæˆé…ç½® service ç®¡ç†æœåŠ¡ synchronize éƒ¨ç½²é™æ€æ–‡ä»¶ docker_container æ‰˜ç®¡åº”ç”¨ ğŸ“š ä¹ã€ç”Ÿäº§çº§æœ€ä½³å®è·µ é¿å…ä½¿ç”¨ shell/command é™¤éæ²¡æœ‰æ¨¡å—å¯ç”¨ï¼Œå¦åˆ™ä¸è¦ç”¨ shellã€‚\nä½¿ç”¨ roles ç»“æ„åŒ–é¡¹ç›® ç”Ÿäº§ç¯å¢ƒæ¨èï¼š\nproject/ inventories/ roles/ playbooks/ group_vars/ host_vars/ ä½¿ç”¨ Vault åŠ å¯†å¯†ç  ä¾‹å¦‚æ•°æ®åº“å¯†ç ï¼š\nansible-vault encrypt group_vars/prod/db.yml ä½¿ç”¨ tags æ§åˆ¶æ‰§è¡Œ ä¾‹å¦‚åªåšåˆå§‹åŒ–ï¼š\nansible-playbook site.yml --tags init é¿å…æŠŠå˜é‡å†™æ­»ï¼Œä½¿ç”¨ group_vars ğŸ—ï¸ åã€æ¨èç›®å½•ç»“æ„ï¼ˆä¼ä¸šçº§ï¼‰ ansible/ inventories/ prod/ hosts group_vars/ host_vars/ staging/ playbooks/ site.yml init.yml deploy.yml roles/ common/ docker/ node_exporter/ nginx/ mysql/ redis/ ğŸ“¦ åä¸€ã€å¸¸ç”¨å‘½ä»¤ ansible all -m ping ansible-playbook site.yml -i inventories/prod/hosts ansible-vault encrypt file.yml ansible-playbook --list-hosts site.yml ansible-playbook --tags init init.yaml ","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€ç³»ç»ŸåŒ–ã€å¯ç”¨äºç”Ÿäº§çš„ Ansible è¯¦ç»†ä»‹ç»ï¼ŒåŒ…å«æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€æœ€ä½³å®è·µã€å¸¸ç”¨æ¨¡å—ã€ç›®å½•ç»“æ„ç¤ºä¾‹ã€Playbook è®¾è®¡è§„èŒƒï¼Œä»¥åŠé€‚åˆä½  Kubernetes / Linux / DevOps åœºæ™¯çš„å®æˆ˜å»ºè®®ã€‚\nğŸ§© ä¸€ã€Ansible æ˜¯ä»€ä¹ˆï¼Ÿ Ansible = è‡ªåŠ¨åŒ–è¿ç»´ + é…ç½®ç®¡ç† + åº”ç”¨éƒ¨ç½² + ç¼–æ’å·¥å…·\nç‰¹ç‚¹ï¼š\nAgentlessï¼ˆæ— å®¢æˆ·ç«¯ï¼‰ï¼šè¢«ç®¡ç†èŠ‚ç‚¹é€šè¿‡ SSH æˆ– WinRMï¼Œä¸éœ€è¦å®‰è£…å®¢æˆ·ç«¯ç¨‹åº Idempotentï¼ˆå¹‚ç­‰ï¼‰ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼ˆè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ”¹å˜ï¼‰ Declarativeï¼ˆå£°æ˜å¼ï¼‰ï¼šå†™â€œæƒ³è¦çš„çŠ¶æ€â€ï¼Œç”± Ansible è´Ÿè´£å®ç° Simpleï¼ˆæ˜“ä¸Šæ‰‹ï¼‰ï¼šæ ¸å¿ƒç”¨ YAML Extensibleï¼ˆæ‰©å±•æ€§å¼ºï¼‰ï¼šæ¨¡å—ã€æ’ä»¶ã€è§’è‰²ä½“ç³»éå¸¸çµæ´» é€‚åˆå¤šå¹³å°ï¼šLinuxã€Unixã€Windowsã€ç½‘ç»œè®¾å¤‡ï¼ˆCiscoã€Juniperï¼‰ã€äº‘å¹³å°ï¼ˆAWSã€AliCloudï¼‰ é€‚ç”¨äºï¼š\næœåŠ¡å™¨ä¸€é”®åˆå§‹åŒ– Kubernetes é›†ç¾¤éƒ¨ç½² CI/CD ç¯å¢ƒè‡ªåŠ¨åŒ– åº”ç”¨å‘å¸ƒï¼ˆNginxã€MySQLã€Redisã€PostgreSQLã€Dockerï¼‰ é˜²ç«å¢™ / ç½‘ç»œè®¾å¤‡é…ç½® æ‰¹é‡ä½œä¸šæ‰§è¡Œï¼ˆlike SaltStack, but agentlessï¼‰ ğŸ› ï¸ äºŒã€Ansible çš„æ¶æ„ Ansible Controllerï¼ˆæ§åˆ¶èŠ‚ç‚¹ï¼‰ | |â€”â€” SSH / WinRM / API | Managed Hostsï¼ˆè¢«ç®¡èŠ‚ç‚¹ï¼‰ æ ¸å¿ƒç»„æˆï¼š\n"},{"id":2,"href":"/backend/python/arrow/tutorial/","title":"Arrow åŸºç¡€æ•™ç¨‹","parent":"Arrow","content":"arrow æ˜¯ä¸€ä¸ªæ¯” datetime æ›´å¥½ç”¨çš„æ—¶é—´åº“ï¼Œè¯­æ³•è¶…ç®€æ´ï¼Œé€‚åˆå†™å¿«é€Ÿè„šæœ¬ã€Web åç«¯ï¼ˆFastAPI/Flaskï¼‰ã€æ•°æ®åˆ†æç­‰ã€‚\n1. å®‰è£… pip install arrow 2. åŸºæœ¬ä½¿ç”¨ è·å–å½“å‰æ—¶é—´\nimport arrow now = arrow.now() print(now) è·å– UTC æ—¶é—´\narrow.utcnow() æŒ‡å®š timezone\narrow.now(\u0026#34;Asia/Shanghai\u0026#34;) 3. æ—¶é—´æ ¼å¼åŒ–ï¼ˆæœ€å¸¸ç”¨ï¼‰ æ ¼å¼åŒ–\nnow = arrow.now() now.format(\u0026#34;YYYY-MM-DD HH:mm:ss\u0026#34;) è¾“å‡ºç¤ºä¾‹ï¼š\n2025-02-28 17:23:11 4. è§£æå­—ç¬¦ä¸²æ—¶é—´ï¼ˆè¶…å¼ºåŠŸèƒ½ï¼‰ è‡ªåŠ¨è§£æï¼ˆæ™ºèƒ½ï¼‰\narrow.get(\u0026#34;2025-02-28 15:00\u0026#34;) æŒ‡å®šæ ¼å¼è§£æ\narrow.get(\u0026#34;2025/02/28 15:00\u0026#34;, \u0026#34;YYYY/MM/DD HH:mm\u0026#34;) æ—¶é—´æˆ³è§£æ\narrow.get(1700000000) 5. æ—¶é—´åç§»ï¼ˆshiftï¼‰ åŠ å‡æ—¶é—´\nnow.shift(days=+1) # æ˜å¤© now.shift(hours=-5) # å‰5å°æ—¶ now.shift(weeks=+2) # ä¸¤å‘¨å æ”¯æŒå¤šä¸ªå•ä½ä¸€èµ·ç”¨\nnow.shift(days=1, hours=2) 6. replaceï¼ˆæ›¿æ¢æ—¥æœŸã€æ—¶é—´ï¼‰ now.replace(hour=0, minute=0, second=0) # å½“å¤©é›¶ç‚¹ now.replace(day=1) # æœ¬æœˆ1å· 7. æ—¶åŒºè½¬æ¢ï¼ˆè¶…ç®€å•ï¼‰ è½¬æ¢åˆ°ä¸Šæµ·æ—¶åŒº\nutc = arrow.utcnow() utc.to(\u0026#34;Asia/Shanghai\u0026#34;) ä»ä»»æ„ timezone è½¬æ¢\nt = arrow.get(\u0026#34;2025-02-28 10:00\u0026#34;, tzinfo=\u0026#34;UTC\u0026#34;) t.to(\u0026#34;Asia/Shanghai\u0026#34;) 8. æ—¶é—´åŒºé—´æ“ä½œï¼ˆrangeï¼‰ ç”Ÿæˆä¸€ä¸ªåŒºé—´ä¸­çš„æ—¥æœŸ\nä¾‹ï¼šæ¯å¤©é€’å¢\nfor dt in arrow.Arrow.range(\u0026#34;day\u0026#34;, arrow.get(\u0026#34;2025-01-01\u0026#34;), arrow.get(\u0026#34;2025-01-05\u0026#34;)): print(dt) ä¾‹ï¼šæ¯å°æ—¶é€’å¢\narrow.Arrow.range(\u0026#34;hour\u0026#34;, start, end) æ”¯æŒï¼šyear, month, week, day, hour, minute, second\n9. äººæ€§åŒ–æ—¶é—´ï¼ˆhumanizeï¼‰ æ˜¾ç¤ºç±»ä¼¼ â€œ3 å°æ—¶å‰â€ã€â€œåˆšåˆšâ€\narrow.get(\u0026#34;2025-02-27\u0026#34;).humanize() æŒ‡å®š localeï¼ˆä¸­æ–‡ï¼‰\narrow.get(\u0026#34;2025-02-27\u0026#34;).humanize(locale=\u0026#34;zh\u0026#34;) ç¤ºä¾‹è¾“å‡ºï¼š\n1 å¤©å‰ 10. å¸¸ç”¨æ“ä½œå¤§å…¨ï¼ˆé€ŸæŸ¥ï¼‰ è·å–å½“æ—¥é›¶ç‚¹\narrow.now().floor(\u0026#34;day\u0026#34;) è·å–å½“æœˆå¼€å§‹/ç»“æŸ\narrow.now().floor(\u0026#34;month\u0026#34;) arrow.now().ceil(\u0026#34;month\u0026#34;) æ—¶é—´æˆ³è½¬æ¢\narrow.now().timestamp() # ç§’ arrow.now().int_timestamp # ç§’ï¼ˆintï¼‰ è½¬ ISO æ ¼å¼\narrow.now().isoformat() åˆ¤æ–­æ—¶é—´å·®\nt1 = arrow.now() t2 = arrow.now().shift(hours=+5) diff = (t2 - t1).total_seconds() 11. ä¸ Python datetime äº’è½¬ è½¬ datetime\narrow.now().datetime ä» datetime è·å– Arrow\nimport datetime arrow.get(datetime.datetime.utcnow()) 12. Arrow æœ€ä½³å®è·µï¼ˆé€‚åˆ FastAPIï¼‰ è·å–å½“å‰æ—¶é—´ï¼ˆUTCï¼‰\nutc_now = arrow.utcnow() ç»Ÿä¸€æ ¼å¼åŒ–ç”¨äºæ•°æ®åº“æ—¥å¿—\nutc_now.format(\u0026#34;YYYY-MM-DD HH:mm:ss\u0026#34;) âŒ ä¸æ¨èï¼šä½¿ç”¨ Python çš„ datetime + æ‰‹åŠ¨æ—¶åŒºå¤„ç†\nâœ… æ¨èï¼šArrow çš„ .to() ç»Ÿä¸€ç®¡ç†\n","description":"arrow æ˜¯ä¸€ä¸ªæ¯” datetime æ›´å¥½ç”¨çš„æ—¶é—´åº“ï¼Œè¯­æ³•è¶…ç®€æ´ï¼Œé€‚åˆå†™å¿«é€Ÿè„šæœ¬ã€Web åç«¯ï¼ˆFastAPI/Flaskï¼‰ã€æ•°æ®åˆ†æç­‰ã€‚\n1. å®‰è£… pip install arrow 2. åŸºæœ¬ä½¿ç”¨ è·å–å½“å‰æ—¶é—´\nimport arrow now = arrow.now() print(now) è·å– UTC æ—¶é—´\narrow.utcnow() æŒ‡å®š timezone\narrow.now(\u0026#34;Asia/Shanghai\u0026#34;) 3. æ—¶é—´æ ¼å¼åŒ–ï¼ˆæœ€å¸¸ç”¨ï¼‰ æ ¼å¼åŒ–\n"},{"id":3,"href":"/backend/python/beautiful-soup/tutorial/","title":"Beautiful Soup åŸºç¡€æ•™ç¨‹","parent":"Beautiful Soup","content":"å®˜æ–¹é“¾æ¥:\nå®˜æ–¹ä¸»é¡µ: https://www.crummy.com/software/BeautifulSoup/ å®˜æ–¹æ–‡æ¡£: https://www.crummy.com/software/BeautifulSoup/bs4/doc/ PyPié¡µé¢: https://pypi.org/project/beautifulsoup4/ Beautiful Soup Documentation Beautiful Soup is a Python library for pulling data out of HTML and XML files. It works with your favorite parser to provide idiomatic ways of navigating, searching, and modifying the parse tree. It commonly saves programmers hours or days of work.\nBeautiful Soup æ˜¯ä¸€ä¸ª Python åº“ï¼Œç”¨äºä» HTML å’Œ XML æ–‡ä»¶ä¸­æå–æ•°æ®ã€‚å®ƒå¯ä¸æ‚¨å¸¸ç”¨çš„è§£æå™¨é…åˆä½¿ç”¨ï¼Œæä¾›ç¬¦åˆæƒ¯ç”¨ä¹ æƒ¯çš„æ–¹å¼æ¥æµè§ˆã€æœç´¢å’Œä¿®æ”¹è§£ææ ‘ã€‚å®ƒé€šå¸¸èƒ½ä¸ºç¨‹åºå‘˜èŠ‚çœæ•°å°æ—¶ç”šè‡³æ•°å¤©çš„å·¥ä½œæ—¶é—´ã€‚\nThese instructions illustrate all major features of Beautiful Soup 4, with examples. I show you what the library is good for, how it works, how to use it, how to make it do what you want, and what to do when it violates your expectations.\nè¿™äº›è¯´æ˜é€šè¿‡ç¤ºä¾‹å±•ç¤ºäº† Beautiful Soup 4 çš„æ‰€æœ‰ä¸»è¦åŠŸèƒ½ã€‚æˆ‘å°†å‘æ‚¨å±•ç¤ºè¯¥åº“çš„ç”¨é€”ã€å·¥ä½œåŸç†ã€ä½¿ç”¨æ–¹æ³•ã€å¦‚ä½•ä½¿å…¶å®ç°æ‚¨æƒ³è¦çš„åŠŸèƒ½ï¼Œä»¥åŠå½“å®ƒä¸ç¬¦åˆæ‚¨çš„é¢„æœŸæ—¶è¯¥å¦‚ä½•å¤„ç†ã€‚\nThis document covers Beautiful Soup version 4.14.2. The examples in this documentation were written for Python 3.8.\næœ¬æ–‡æ¡£é€‚ç”¨äº Beautiful Soup 4.14.2 ç‰ˆæœ¬ã€‚æœ¬æ–‡æ¡£ä¸­çš„ç¤ºä¾‹æ˜¯ä¸º Python 3.8 ç¼–å†™çš„ã€‚\nYou might be looking for the documentation for Beautiful Soup 3. If so, you should know that Beautiful Soup 3 is no longer being developed and that all support for it was dropped on December 31, 2020. If you want to learn about the differences between Beautiful Soup 3 and Beautiful Soup 4, see Porting code to BS4.\næ‚¨å¯èƒ½æ­£åœ¨å¯»æ‰¾ Beautiful Soup 3 çš„æ–‡æ¡£ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œæ‚¨åº”è¯¥çŸ¥é“ Beautiful Soup 3 å·²åœæ­¢å¼€å‘ï¼Œå¹¶ä¸”æ‰€æœ‰æ”¯æŒå·²äº 2020 å¹´ 12 æœˆ 31 æ—¥ç»ˆæ­¢ã€‚å¦‚æœæ‚¨æƒ³äº†è§£ Beautiful Soup 3 å’Œ Beautiful Soup 4 ä¹‹é—´çš„åŒºåˆ«ï¼Œè¯·å‚é˜…â€œå°†ä»£ç ç§»æ¤åˆ° BS4â€ã€‚\nGetting help If you have questions about Beautiful Soup, or run into problems, send mail to the discussion group. If your problem involves parsing an HTML document, be sure to mention what the diagnose() function says about that document.\nå¦‚æœæ‚¨å¯¹ Beautiful Soup æœ‰ä»»ä½•ç–‘é—®æˆ–é‡åˆ°é—®é¢˜ï¼Œ è¯·å‘é€é‚®ä»¶è‡³è®¨è®ºç»„ã€‚å¦‚æœæ‚¨çš„ç–‘é—®æ¶‰åŠè§£æ HTML æ–‡æ¡£ï¼Œè¯·åŠ¡å¿…è¯´æ˜ diagnose() å‡½æ•°å¯¹è¯¥æ–‡æ¡£çš„è¯Šæ–­ç»“æœã€‚\nWhen reporting an error in this documentation, please mention which translation you\u0026rsquo;re reading.\næŠ¥å‘Šæœ¬æ–‡æ¡£ä¸­çš„é”™è¯¯æ—¶ï¼Œè¯·è¯´æ˜æ‚¨æ­£åœ¨é˜…è¯»çš„æ˜¯å“ªä¸ªè¯‘æœ¬ã€‚\nAPI documentation This document is written like an instruction manual, but you can also read traditional API documentation generated from the Beautiful Soup source code. If you want details about Beautiful Soup\u0026rsquo;s internals, or a feature not covered in this document, try the API documentation.\næœ¬æ–‡æ¡£ä»¥æ“ä½œæ‰‹å†Œçš„å½¢å¼ç¼–å†™ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥é˜…è¯» æ ¹æ® Beautiful Soup æºä»£ç ç”Ÿæˆçš„ä¼ ç»Ÿ API æ–‡æ¡£ ã€‚å¦‚æœæ‚¨æƒ³äº†è§£ Beautiful Soup çš„å†…éƒ¨æœºåˆ¶æˆ–æœ¬æ–‡æ¡£æœªæ¶µç›–çš„åŠŸèƒ½ï¼Œè¯·æŸ¥é˜… API æ–‡æ¡£ã€‚\nQuick Start Here\u0026rsquo;s an HTML document I\u0026rsquo;ll be using as an example throughout this document. It\u0026rsquo;s part of a story from Alice in Wonderland:\nhtml_doc = \u0026#34;\u0026#34;\u0026#34;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;The Dormouse\u0026#39;s story\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p class=\u0026#34;title\u0026#34;\u0026gt;\u0026lt;b\u0026gt;The Dormouse\u0026#39;s story\u0026lt;/b\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;p class=\u0026#34;story\u0026#34;\u0026gt;Once upon a time there were three little sisters; and their names were \u0026lt;a href=\u0026#34;http://example.com/elsie\u0026#34; class=\u0026#34;sister\u0026#34; id=\u0026#34;link1\u0026#34;\u0026gt;Elsie\u0026lt;/a\u0026gt;, \u0026lt;a href=\u0026#34;http://example.com/lacie\u0026#34; class=\u0026#34;sister\u0026#34; id=\u0026#34;link2\u0026#34;\u0026gt;Lacie\u0026lt;/a\u0026gt; and \u0026lt;a href=\u0026#34;http://example.com/tillie\u0026#34; class=\u0026#34;sister\u0026#34; id=\u0026#34;link3\u0026#34;\u0026gt;Tillie\u0026lt;/a\u0026gt;; and they lived at the bottom of a well.\u0026lt;/p\u0026gt; \u0026lt;p class=\u0026#34;story\u0026#34;\u0026gt;...\u0026lt;/p\u0026gt; \u0026#34;\u0026#34;\u0026#34; Running the \u0026ldquo;three sisters\u0026rdquo; document through Beautiful Soup gives us a BeautifulSoup object, which represents the document as a nested data structure:\nfrom bs4 import BeautifulSoup soup = BeautifulSoup(html_doc, \u0026#39;html.parser\u0026#39;) print(soup.prettify()) # \u0026lt;html\u0026gt; # \u0026lt;head\u0026gt; # \u0026lt;title\u0026gt; # The Dormouse\u0026#39;s story # \u0026lt;/title\u0026gt; # \u0026lt;/head\u0026gt; # \u0026lt;body\u0026gt; # \u0026lt;p class=\u0026#34;title\u0026#34;\u0026gt; # \u0026lt;b\u0026gt; # The Dormouse\u0026#39;s story # \u0026lt;/b\u0026gt; # \u0026lt;/p\u0026gt; # \u0026lt;p class=\u0026#34;story\u0026#34;\u0026gt; # Once upon a time there were three little sisters; and their names were # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/elsie\u0026#34; id=\u0026#34;link1\u0026#34;\u0026gt; # Elsie # \u0026lt;/a\u0026gt; # , # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/lacie\u0026#34; id=\u0026#34;link2\u0026#34;\u0026gt; # Lacie # \u0026lt;/a\u0026gt; # and # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/tillie\u0026#34; id=\u0026#34;link3\u0026#34;\u0026gt; # Tillie # \u0026lt;/a\u0026gt; # ; and they lived at the bottom of a well. # \u0026lt;/p\u0026gt; # \u0026lt;p class=\u0026#34;story\u0026#34;\u0026gt; # ... # \u0026lt;/p\u0026gt; # \u0026lt;/body\u0026gt; # \u0026lt;/html\u0026gt; Here are some simple ways to navigate that data structure:\nsoup.title # \u0026lt;title\u0026gt;The Dormouse\u0026#39;s story\u0026lt;/title\u0026gt; soup.title.name # u\u0026#39;title\u0026#39; soup.title.string # u\u0026#39;The Dormouse\u0026#39;s story\u0026#39; soup.title.parent.name # u\u0026#39;head\u0026#39; soup.p # \u0026lt;p class=\u0026#34;title\u0026#34;\u0026gt;\u0026lt;b\u0026gt;The Dormouse\u0026#39;s story\u0026lt;/b\u0026gt;\u0026lt;/p\u0026gt; soup.p[\u0026#39;class\u0026#39;] # u\u0026#39;title\u0026#39; soup.a # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/elsie\u0026#34; id=\u0026#34;link1\u0026#34;\u0026gt;Elsie\u0026lt;/a\u0026gt; soup.find_all(\u0026#39;a\u0026#39;) # [\u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/elsie\u0026#34; id=\u0026#34;link1\u0026#34;\u0026gt;Elsie\u0026lt;/a\u0026gt;, # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/lacie\u0026#34; id=\u0026#34;link2\u0026#34;\u0026gt;Lacie\u0026lt;/a\u0026gt;, # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/tillie\u0026#34; id=\u0026#34;link3\u0026#34;\u0026gt;Tillie\u0026lt;/a\u0026gt;] soup.find(id=\u0026#34;link3\u0026#34;) # \u0026lt;a class=\u0026#34;sister\u0026#34; href=\u0026#34;http://example.com/tillie\u0026#34; id=\u0026#34;link3\u0026#34;\u0026gt;Tillie\u0026lt;/a\u0026gt; One common task is extracting all the URLs found within a page\u0026rsquo;s tags:\nfor link in soup.find_all(\u0026#39;a\u0026#39;): print(link.get(\u0026#39;href\u0026#39;)) # http://example.com/elsie # http://example.com/lacie # http://example.com/tillie Another common task is extracting all the text from a page:\nprint(soup.get_text()) # The Dormouse\u0026#39;s story # # The Dormouse\u0026#39;s story # # Once upon a time there were three little sisters; and their names were # Elsie, # Lacie and # Tillie; # and they lived at the bottom of a well. # # ... Does this look like what you need? If so, read on.\nä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€å®ç”¨ã€æœ€ç®€æ´çš„ Beautiful Soup ä½¿ç”¨æŒ‡å—ï¼Œæ¶µç›–å¸¸ç”¨æ“ä½œï¼šè§£æã€æŸ¥æ‰¾ã€é€‰æ‹©å™¨ã€æå–å±æ€§ã€éå†ã€ä¿®æ”¹ã€æäº¤è¡¨å•ç­‰ã€‚ä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç”¨ã€‚\nğŸŒ± BeautifulSoup æœ€å¸¸ç”¨é€ŸæŸ¥è¡¨ï¼ˆPythonï¼‰\nğŸ“¦ 1. å®‰è£… pip install beautifulsoup4 lxml ğŸ¥£ 2. åŸºæœ¬ç”¨æ³• from bs4 import BeautifulSoup html = \u0026#34;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;Hello\u0026lt;/h1\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34; soup = BeautifulSoup(html, \u0026#34;lxml\u0026#34;) print(soup.h1.text) ğŸ” 3. åŸºæœ¬æŸ¥æ‰¾ find() æ‰¾ä¸€ä¸ª soup.find(\u0026#34;div\u0026#34;) soup.find(\u0026#34;div\u0026#34;, id=\u0026#34;main\u0026#34;) soup.find(\u0026#34;div\u0026#34;, class_=\u0026#34;item\u0026#34;) find_all() æ‰¾å¤šä¸ª soup.find_all(\u0026#34;a\u0026#34;) soup.find_all(\u0026#34;a\u0026#34;, limit=5) ğŸ¯ 4. CSS é€‰æ‹©å™¨ï¼ˆå¼ºçƒˆæ¨èï¼‰ select() soup.select(\u0026#34;div.item a\u0026#34;) soup.select(\u0026#34;.price\u0026#34;) soup.select(\u0026#34;#main \u0026gt; ul \u0026gt; li\u0026#34;) select_one() soup.select_one(\u0026#34;.title\u0026#34;).text ğŸ“„ 5. è·å–æ–‡æœ¬ä¸å±æ€§ æ–‡æœ¬\nelement.text.strip() element.get_text() å±æ€§\nelement[\u0026#34;href\u0026#34;] element.get(\u0026#34;src\u0026#34;) ğŸŒ² 6. èŠ‚ç‚¹éå† tag.parent tag.parents tag.children tag.descendants tag.next_sibling tag.previous_sibling ğŸ”§ 7. ä¿®æ”¹ DOM tag = soup.find(\u0026#34;h1\u0026#34;) tag.string = \u0026#34;New Title\u0026#34; new_div = soup.new_tag(\u0026#34;div\u0026#34;, **{\u0026#34;class\u0026#34;: \u0026#34;box\u0026#34;}) soup.body.append(new_div) ğŸŒ 8. é…åˆ requests ä½¿ç”¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ import requests from bs4 import BeautifulSoup url = \u0026#34;https://example.com\u0026#34; html = requests.get(url).text soup = BeautifulSoup(html, \u0026#34;lxml\u0026#34;) for a in soup.select(\u0026#34;a\u0026#34;): print(a.text, a[\u0026#34;href\u0026#34;]) ğŸ“‘ 9. è§£æè¡¨æ ¼ rows = soup.select(\u0026#34;table tr\u0026#34;) for row in rows: cols = [td.text.strip() for td in row.select(\u0026#34;td, th\u0026#34;)] print(cols) ğŸ§ª 10. æœç´¢åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ ‡ç­¾ soup.find_all(string=lambda text: \u0026#34;å…³é”®å­—\u0026#34; in text) ğŸ§¼ 11. å»é™¤ script / style for tag in soup([\u0026#34;script\u0026#34;, \u0026#34;style\u0026#34;]): tag.decompose() ğŸš€ 12. å®æˆ˜ç¤ºä¾‹ï¼šçˆ¬å–æ ‡é¢˜å’Œé“¾æ¥ import requests from bs4 import BeautifulSoup html = requests.get(\u0026#34;https://news.ycombinator.com\u0026#34;).text soup = BeautifulSoup(html, \u0026#34;lxml\u0026#34;) for item in soup.select(\u0026#34;.titleline \u0026gt; a\u0026#34;): print(item.text, item[\u0026#34;href\u0026#34;]) ","description":"å®˜æ–¹é“¾æ¥:\nå®˜æ–¹ä¸»é¡µ: https://www.crummy.com/software/BeautifulSoup/ å®˜æ–¹æ–‡æ¡£: https://www.crummy.com/software/BeautifulSoup/bs4/doc/ PyPié¡µé¢: https://pypi.org/project/beautifulsoup4/ Beautiful Soup Documentation Beautiful Soup is a Python library for pulling data out of HTML and XML files. It works with your favorite parser to provide idiomatic ways of navigating, searching, and modifying the parse tree. It commonly saves programmers hours or days of work.\n"},{"id":4,"href":"/backend/python/cryptography/tutorial/","title":"cryptography åŸºç¡€æ•™ç¨‹","parent":"Cryptography","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ è¶…å®ç”¨ + æ¸…æ™°åˆ†å±‚çš„ã€ŠPython cryptography åº“ æ•™ç¨‹ã€‹ï¼Œæ¶µç›–å¸¸ç”¨åŠŸèƒ½ã€æœ€ä½³å®è·µã€å¸¸è§é”™è¯¯å¤„ç†ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®ã€‚å†…å®¹åŸºäºæœ€æ–°ç‰ˆï¼ˆcryptography â‰¥ 42+ï¼‰é£æ ¼ï¼Œä¿è¯ä½ é©¬ä¸Šèƒ½ç”¨ã€‚\nğŸ§© Python cryptography åº“æ•™ç¨‹ é€‚åˆï¼šåç«¯å¼€å‘è€… / å®‰å…¨å¼€å‘ / Token / åŠ å¯†å­˜å‚¨ / HTTPS / JWT / éå¯¹ç§°åŠ å¯†\nç›®å½•\nğŸ“¦ å®‰è£… ğŸ” é«˜å±‚ï¼ˆFernetï¼‰å¯¹ç§°åŠ å¯† ğŸ— ä½å±‚ï¼ˆHazmatï¼‰AES-GCM ğŸ”‘ éå¯¹ç§° RSAï¼ˆç”Ÿæˆå¯†é’¥ / åŠ è§£å¯† / ç­¾åï¼‰ ğŸ”‘ éå¯¹ç§° ECCï¼ˆæ›´å¿«ã€æ›´å®‰å…¨ï¼‰ ğŸ§¾ å“ˆå¸Œï¼ˆSHA256ã€HMACï¼‰ ğŸ« JWT è‡ªå»ºç­¾åç³»ç»Ÿï¼ˆä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼‰ ğŸ“ æ–‡ä»¶åŠ å¯† ğŸ›¡ è¯ä¹¦ã€TLS å·¥å…·ï¼ˆX509ï¼‰ ğŸ§¨ é”™è¯¯å¤„ç† ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. å®‰è£… pip install cryptography 2. ğŸ” Fernetï¼ˆæœ€ç®€å•å¯é çš„å¯¹ç§°åŠ å¯†ï¼‰ Fernet å°è£…äº† AES + HMACï¼Œå‡ ä¹æ˜¯â€œæ‹¿æ¥å°±ç”¨â€çš„å®‰å…¨æ–¹æ¡ˆã€‚\nç”Ÿæˆå¯†é’¥\nfrom cryptography.fernet import Fernet key = Fernet.generate_key() print(key) åŠ å¯† \u0026amp; è§£å¯†\nfrom cryptography.fernet import Fernet key = Fernet.generate_key() f = Fernet(key) token = f.encrypt(b\u0026#34;hello world\u0026#34;) plain = f.decrypt(token) print(token, plain) ç‰¹ç‚¹\nAES128 + HMAC-SHA256 ç»„åˆ é»˜è®¤æä¾›æ—¶é—´æˆ³ æ˜“ç”¨ã€å®‰å…¨ã€é€‚åˆç»å¤§éƒ¨åˆ†â€œåŠ å¯†å­—ç¬¦ä¸²/æ•æ„Ÿé…ç½®â€åœºæ™¯ 3. ğŸ§ª Hazmat å±‚ AES-GCMï¼ˆé«˜çº§å¯¹ç§°åŠ å¯†ï¼‰ é€‚åˆä½ éœ€è¦ï¼š\nè‡ªå·±å¤„ç† IV / tag åŠ å¯†äºŒè¿›åˆ¶æ•°æ® ä¸å…¶ä»–è¯­è¨€äº’é€šï¼ˆAES-GCM æ˜¯æ ‡å‡†ï¼‰ AES-GCM ç¤ºä¾‹\nimport os from cryptography.hazmat.primitives.ciphers.aead import AESGCM key = AESGCM.generate_key(bit_length=256) aesgcm = AESGCM(key) nonce = os.urandom(12) # æ¨è 12 å­—èŠ‚ data = b\u0026#34;secret message\u0026#34; aad = b\u0026#34;authenticated data\u0026#34; ciphertext = aesgcm.encrypt(nonce, data, aad) plaintext = aesgcm.decrypt(nonce, ciphertext, aad) print(ciphertext, plaintext) 4. ğŸ”‘ RSAï¼ˆç”Ÿæˆå¯†é’¥ / åŠ å¯† / ç­¾åï¼‰ ç”Ÿæˆ RSA å¯†é’¥\nfrom cryptography.hazmat.primitives.asymmetric import rsa from cryptography.hazmat.primitives import serialization private_key = rsa.generate_private_key( public_exponent=65537, key_size=2048 ) pem = private_key.private_bytes( encoding=serialization.Encoding.PEM, format=serialization.PrivateFormat.PKCS8, encryption_algorithm=serialization.NoEncryption(), ) print(pem.decode()) RSA åŠ å¯† \u0026amp; è§£å¯†ï¼ˆOAEPï¼‰\nfrom cryptography.hazmat.primitives.asymmetric import padding from cryptography.hazmat.primitives import hashes public_key = private_key.public_key() ciphertext = public_key.encrypt( b\u0026#34;hello\u0026#34;, padding.OAEP( mgf=padding.MGF1(algorithm=hashes.SHA256()), algorithm=hashes.SHA256(), label=None ) ) plaintext = private_key.decrypt( ciphertext, padding.OAEP( mgf=padding.MGF1(algorithm=hashes.SHA256()), algorithm=hashes.SHA256(), label=None ) ) 5. ğŸ§© ECCï¼ˆæ›´å¿«ä¸”æ›´å¼ºçš„éå¯¹ç§°åŠ å¯†ï¼‰ æ¨è Curve25519 / Ed25519ã€‚\nEd25519 ç­¾å\nfrom cryptography.hazmat.primitives.asymmetric.ed25519 import Ed25519PrivateKey private_key = Ed25519PrivateKey.generate() public_key = private_key.public_key() msg = b\u0026#34;hello\u0026#34; signature = private_key.sign(msg) public_key.verify(signature, msg) ä¼˜ç‚¹ï¼š\nå¯†é’¥æ›´çŸ­ é€Ÿåº¦æ¯” RSA å¿« éå¸¸é€‚åˆç­¾åï¼ˆJWTã€API ç­¾åï¼‰ 6. ğŸ§¾ å“ˆå¸Œä¸ HMAC SHA256\nfrom cryptography.hazmat.primitives import hashes digest = hashes.Hash(hashes.SHA256()) digest.update(b\u0026#34;hello\u0026#34;) print(digest.finalize().hex()) HMAC\nfrom cryptography.hazmat.primitives.hmac import HMAC h = HMAC(b\u0026#34;secret-key\u0026#34;, hashes.SHA256()) h.update(b\u0026#34;hello\u0026#34;) tag = h.finalize() print(tag.hex()) 7. ğŸ« è‡ªå»º JWTï¼ˆHS256 / RS256 / EdDSAï¼‰ ä¸ä¾èµ– PyJWTï¼Œç”¨ cryptography åŸç”Ÿå®ç°ã€‚\nHS256ï¼ˆå¯¹ç§°ï¼‰\nimport base64 import json from cryptography.hazmat.primitives import hmac, hashes def b64(x): return base64.urlsafe_b64encode(x).rstrip(b\u0026#39;=\u0026#39;) header = b64(json.dumps({\u0026#34;alg\u0026#34;: \u0026#34;HS256\u0026#34;, \u0026#34;typ\u0026#34;: \u0026#34;JWT\u0026#34;}).encode()) payload = b64(json.dumps({\u0026#34;uid\u0026#34;: 1}).encode()) msg = header + b\u0026#34;.\u0026#34; + payload h = hmac.HMAC(b\u0026#34;secret\u0026#34;, hashes.SHA256()) h.update(msg) sig = b64(h.finalize()) jwt = msg + b\u0026#34;.\u0026#34; + sig print(jwt.decode()) 8. ğŸ“ æ–‡ä»¶åŠ å¯†ï¼ˆAES-GCMï¼‰ import os from cryptography.hazmat.primitives.ciphers.aead import AESGCM key = AESGCM.generate_key(256) aes = AESGCM(key) with open(\u0026#34;input.bin\u0026#34;, \u0026#34;rb\u0026#34;) as f: data = f.read() nonce = os.urandom(12) ciphertext = aes.encrypt(nonce, data, None) with open(\u0026#34;input.bin.enc\u0026#34;, \u0026#34;wb\u0026#34;) as f: f.write(nonce + ciphertext) 9. ğŸ›¡ è¯ä¹¦ï¼ˆX509ï¼‰ç”Ÿæˆ ç”Ÿæˆç®€æ˜“è‡ªç­¾è¯ä¹¦\nimport datetime from cryptography.x509 import NameOID from cryptography import x509 from cryptography.hazmat.primitives import hashes subject = issuer = x509.Name([ x509.NameAttribute(NameOID.COUNTRY_NAME, u\u0026#34;US\u0026#34;), x509.NameAttribute(NameOID.COMMON_NAME, u\u0026#34;test.local\u0026#34;), ]) cert = ( x509.CertificateBuilder() .subject_name(subject) .issuer_name(issuer) .public_key(private_key.public_key()) .serial_number(x509.random_serial_number()) .not_valid_before(datetime.datetime.utcnow()) .not_valid_after(datetime.datetime.utcnow() + datetime.timedelta(days=365)) .sign(private_key, hashes.SHA256()) ) print(cert.public_bytes(serialization.Encoding.PEM).decode()) 10. ğŸ§¨ å¸¸è§é”™è¯¯å¤„ç† é”™è¯¯ åŸå›  è§£å†³ InvalidTag AES-GCM è§£å¯†å¤±è´¥ï¼ˆå¯†é’¥/nonce/AAD é”™è¯¯ï¼‰ ä¿è¯ nonce ä¸é‡å¤ / éªŒè¯ AAD UnsupportedAlgorithm ä½¿ç”¨è¿‡æ—¶ç®—æ³• ä½¿ç”¨ SHA256+ / AES-GCM ValueError: Encryption/decryption failed RSA å¡«å……ä¸åŒ¹é… ä½¿ç”¨ OAEPï¼Œé¿å… PKCS1v1.5 11. ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ å¯¹ç§°åŠ å¯†ï¼šä¼˜å…ˆä½¿ç”¨ AES-GCM ç®€å•å­—ç¬¦ä¸²åŠ å¯†ï¼šFernet ç­¾åï¼šEd25519 å…¬é’¥åŠ å¯†ï¼šRSA-OAEP æˆ– X25519 å¯†é’¥å­˜å‚¨æ”¾åœ¨ï¼š\nKubernetes secret Vault ç¯å¢ƒå˜é‡ + æ–‡ä»¶æŒ‚è½½ âŒ ä¸è¦ï¼š\nä¸è¦é‡å¤ä½¿ç”¨ AES-GCM nonce ä¸è¦ä½¿ç”¨ DES / RC4 / ECB ä¸è¦æŠŠç§é’¥æäº¤åˆ° Git ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ è¶…å®ç”¨ + æ¸…æ™°åˆ†å±‚çš„ã€ŠPython cryptography åº“ æ•™ç¨‹ã€‹ï¼Œæ¶µç›–å¸¸ç”¨åŠŸèƒ½ã€æœ€ä½³å®è·µã€å¸¸è§é”™è¯¯å¤„ç†ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®ã€‚å†…å®¹åŸºäºæœ€æ–°ç‰ˆï¼ˆcryptography â‰¥ 42+ï¼‰é£æ ¼ï¼Œä¿è¯ä½ é©¬ä¸Šèƒ½ç”¨ã€‚\nğŸ§© Python cryptography åº“æ•™ç¨‹ é€‚åˆï¼šåç«¯å¼€å‘è€… / å®‰å…¨å¼€å‘ / Token / åŠ å¯†å­˜å‚¨ / HTTPS / JWT / éå¯¹ç§°åŠ å¯†\nç›®å½•\nğŸ“¦ å®‰è£… ğŸ” é«˜å±‚ï¼ˆFernetï¼‰å¯¹ç§°åŠ å¯† ğŸ— ä½å±‚ï¼ˆHazmatï¼‰AES-GCM ğŸ”‘ éå¯¹ç§° RSAï¼ˆç”Ÿæˆå¯†é’¥ / åŠ è§£å¯† / ç­¾åï¼‰ ğŸ”‘ éå¯¹ç§° ECCï¼ˆæ›´å¿«ã€æ›´å®‰å…¨ï¼‰ ğŸ§¾ å“ˆå¸Œï¼ˆSHA256ã€HMACï¼‰ ğŸ« JWT è‡ªå»ºç­¾åç³»ç»Ÿï¼ˆä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼‰ ğŸ“ æ–‡ä»¶åŠ å¯† ğŸ›¡ è¯ä¹¦ã€TLS å·¥å…·ï¼ˆX509ï¼‰ ğŸ§¨ é”™è¯¯å¤„ç† ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ 1. å®‰è£… pip install cryptography 2. ğŸ” Fernetï¼ˆæœ€ç®€å•å¯é çš„å¯¹ç§°åŠ å¯†ï¼‰ Fernet å°è£…äº† AES + HMACï¼Œå‡ ä¹æ˜¯â€œæ‹¿æ¥å°±ç”¨â€çš„å®‰å…¨æ–¹æ¡ˆã€‚\n"},{"id":5,"href":"/operations/debezium/tutorial/","title":"Debezium åŸºç¡€æ•™ç¨‹","parent":"Debezium","content":"å†…å®¹ï¼šå®ƒæ˜¯ä»€ä¹ˆ -\u0026gt; åŸç† -\u0026gt; æ¶æ„ -\u0026gt; æ”¯æŒçš„æ•°æ®åº“ -\u0026gt; æ•°æ®æ ¼å¼ -\u0026gt; ä¸ Kafka/ES çš„é›†æˆ -\u0026gt; ç”Ÿäº§æœ€ä½³å®è·µ -\u0026gt; å¸¸è§å‘\nğŸš€ Debezium æ˜¯ä»€ä¹ˆï¼Ÿ Debezium æ˜¯ä¸€ä¸ªåŸºäº CDCï¼ˆChange Data Captureï¼Œå˜æ›´æ•°æ®æ•è·ï¼‰çš„å¼€æºç»„ä»¶ï¼Œ ç”¨äº å®æ—¶æ•è·æ•°æ®åº“ä¸­ INSERT / UPDATE / DELETE çš„å˜åŒ–ï¼Œå¹¶å°†å˜åŒ–äº‹ä»¶å‘é€åˆ° Kafkaï¼ˆæˆ– Kafka Connect Sinkï¼‰ã€‚\nDebezium = æŠŠæ•°æ®åº“çš„ binlog / WALï¼Œå®æ—¶å˜æˆç»“æ„åŒ–äº‹ä»¶æµ\nâ˜˜ï¸ Debezium è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆè½®è¯¢ DBï¼‰çš„é—®é¢˜ï¼š\næ€§èƒ½å·®ï¼ˆåå¤æ‰«è¡¨ï¼‰ å»¶è¿Ÿé«˜ï¼ˆåˆ†é’Ÿçº§ï¼‰ æ— æ³•æ„ŸçŸ¥ DELETE éš¾ä¿è¯é¡ºåºå’Œä¸€è‡´æ€§ Debezium çš„ä¼˜åŠ¿ï¼š\nèƒ½åŠ› Debezium å®æ—¶æ€§ ç§’çº§ æ•°æ®æ¥æº æ•°æ®åº“æ—¥å¿—ï¼ˆä¸æ˜¯ SQLï¼‰ DELETE æ„ŸçŸ¥ âœ… é¡ºåºä¿è¯ âœ…ï¼ˆåˆ†åŒºå†…ï¼‰ å¯å›æ”¾ âœ…ï¼ˆKafkaï¼‰ å¯¹ DB å‹åŠ› æä½ ğŸ§© Debezium çš„æ•´ä½“æ¶æ„ MySQL / PostgreSQL â”‚ â”‚ binlog / WAL â–¼ Debezium Connector â”‚ â”‚ Change Eventï¼ˆJSON / Avroï¼‰ â–¼ Kafka Topic â”‚ â”œâ”€â”€ Elasticsearch Sink â”œâ”€â”€ Flink / Spark â”œâ”€â”€ Cache / Search / BI Debezium æœ¬èº«ä¸æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œè€Œæ˜¯ Kafka Connect çš„ä¸€ä¸ª Source Connectorã€‚ ğŸ” Debezium å·¥ä½œåŸç†ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ åˆå§‹åŒ–ï¼ˆSnapshotï¼‰ ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼š\nDebezium ä¼šå¯¹è¡¨åšä¸€æ¬¡ ä¸€è‡´æ€§å¿«ç…§ æŠŠå½“å‰è¡¨çš„æ‰€æœ‰æ•°æ®å‘é€åˆ° Kafka åŒæ—¶è®°å½•å½“å‰ binlog / WAL ä½ç‚¹ âš ï¸ Snapshot åªå‘ç”Ÿä¸€æ¬¡ï¼ˆå¯é…ç½®ï¼‰\n2ï¸âƒ£ å®æ—¶å˜æ›´æ•è·ï¼ˆCDCï¼‰ ä¹‹åï¼š\nDebezium æŒç»­ç›‘å¬ binlog / WAL ä»»ä½• INSERT / UPDATE / DELETE éƒ½ä¼šç”Ÿæˆä¸€æ¡äº‹ä»¶å†™å…¥ Kafka 3ï¸âƒ£ ä½ç‚¹ç®¡ç†ï¼ˆOffsetï¼‰ Debezium ä¼šè®°å½•ï¼š\nbinlog æ–‡ä»¶å + positionï¼ˆMySQLï¼‰ LSNï¼ˆPostgreSQLï¼‰ ä¿è¯ï¼š\nä¸ä¸¢æ•°æ® ä¸é‡å¤æ¶ˆè´¹ å¯æ–­ç‚¹æ¢å¤ ğŸ—„ï¸ Debezium æ”¯æŒå“ªäº›æ•°æ®åº“ï¼Ÿ æ•°æ®åº“ æ–¹å¼ MySQL binlog PostgreSQL WAL Oracle redo log SQL Server CDC / log MongoDB oplog DB2 log ä½ å…³å¿ƒçš„é‡ç‚¹ï¼š\nMySQLï¼šROW æ ¼å¼ binlog PostgreSQLï¼šlogical replication + WAL ğŸ¬ Debezium + MySQLï¼ˆé‡ç‚¹ï¼‰ MySQL å¿…é¡»æ»¡è¶³\n[mysqld] server-id = 223344 log-bin = mysql-bin binlog_format = ROW binlog_row_image = FULL ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ ROWï¼Ÿ\nDebezium éœ€è¦æ‹¿åˆ° æ¯ä¸€è¡Œçš„å‰åå˜åŒ–\nMySQL Connector æ ¸å¿ƒå‚æ•°\n{ \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.mysql.MySqlConnector\u0026#34;, \u0026#34;database.hostname\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;database.port\u0026#34;: \u0026#34;3306\u0026#34;, \u0026#34;database.user\u0026#34;: \u0026#34;debezium\u0026#34;, \u0026#34;database.password\u0026#34;: \u0026#34;pwd\u0026#34;, \u0026#34;database.server.id\u0026#34;: \u0026#34;184054\u0026#34;, \u0026#34;database.server.name\u0026#34;: \u0026#34;mysql01\u0026#34;, \u0026#34;database.include.list\u0026#34;: \u0026#34;app_db\u0026#34;, \u0026#34;table.include.list\u0026#34;: \u0026#34;app_db.users\u0026#34;, \u0026#34;snapshot.mode\u0026#34;: \u0026#34;initial\u0026#34; } ğŸ˜ Debezium + PostgreSQLï¼ˆé‡ç‚¹ï¼‰ PostgreSQL å¿…é¡»é…ç½®\nwal_level = logical max_replication_slots = 10 max_wal_senders = 10 å¹¶åˆ›å»º replication slotã€‚\nPG Connector ç¤ºä¾‹\n{ \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.postgresql.PostgresConnector\u0026#34;, \u0026#34;database.hostname\u0026#34;: \u0026#34;pg\u0026#34;, \u0026#34;database.port\u0026#34;: \u0026#34;5432\u0026#34;, \u0026#34;database.user\u0026#34;: \u0026#34;debezium\u0026#34;, \u0026#34;database.password\u0026#34;: \u0026#34;pwd\u0026#34;, \u0026#34;database.dbname\u0026#34;: \u0026#34;app\u0026#34;, \u0026#34;slot.name\u0026#34;: \u0026#34;debezium_slot\u0026#34;, \u0026#34;publication.name\u0026#34;: \u0026#34;dbz_pub\u0026#34;, \u0026#34;table.include.list\u0026#34;: \u0026#34;public.users\u0026#34; } ğŸ“¦ Debezium äº‹ä»¶æ ¼å¼ ä¸€æ¡ UPDATE äº‹ä»¶ç»“æ„\n{ \u0026#34;before\u0026#34;: { \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34; }, \u0026#34;after\u0026#34;: { \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;Tommy\u0026#34; }, \u0026#34;op\u0026#34;: \u0026#34;u\u0026#34;, \u0026#34;ts_ms\u0026#34;: 1710000000000 } op ç±»å‹\nå€¼ å«ä¹‰ c insert u update d delete r snapshot ğŸ”„ Debezium -\u0026gt; Elasticsearch åŒæ­¥ æ¨èæ–¹å¼ï¼ˆç”Ÿäº§çº§ï¼‰\nDebezium -\u0026gt; Kafka -\u0026gt; Elasticsearch Sink\nå…³é”®ç‚¹\nDB ä¸»é”® -\u0026gt; ES _id UPDATE -\u0026gt; index DELETE -\u0026gt; delete Kafka consumer group å®ç°å¹¶è¡Œ ES Sink ç¤ºä¾‹é€»è¾‘\ntransforms=unwrap transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState transforms.unwrap.drop.tombstones=true âš ï¸ Debezium å¸¸è§å‘ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ è¡¨å¿…é¡»æœ‰ä¸»é”® æ²¡æœ‰ä¸»é”®ï¼š\næ— æ³•ç”Ÿæˆç¨³å®šäº‹ä»¶ ES æ— æ³•å¹‚ç­‰å†™å…¥ 2ï¸âƒ£ WAL / binlog ç§¯å‹ ä¸‹æ¸¸æ¶ˆè´¹æ…¢ -\u0026gt; binlog/WAL ä¸ä¼šè¢«æ¸…ç† -\u0026gt; ç£ç›˜çˆ†æ»¡\nğŸ‘‰ å¿…é¡»ç›‘æ§ lag\n3ï¸âƒ£ Snapshot æœŸé—´å‹åŠ› é¦–æ¬¡ snapshotï¼š\nä¼šæ‰«å…¨è¡¨ éœ€é¿å¼€ä¸šåŠ¡é«˜å³° 4ï¸âƒ£ Schema å˜æ›´ ALTER TABLE ä¼šäº§ç”Ÿ schema change äº‹ä»¶ ä¸‹æ¸¸éœ€è¦èƒ½å®¹å¿å­—æ®µå˜åŒ– ğŸ§ª Debezium vs å…¶å®ƒæ–¹æ¡ˆ æ–¹æ¡ˆ å®æ—¶æ€§ å‹åŠ› DELETE å¤æ‚åº¦ Logstash JDBC ä½ é«˜ âŒ ä½ è‡ªç ”è½®è¯¢ ä½ é«˜ âŒ ä¸­ Debezium é«˜ æä½ âœ… é«˜ å®˜æ–¹ Connector ä¸­ ä½ éƒ¨åˆ† ä½ â˜˜ï¸ æ€»ç»“ Debezium æ˜¯ä¸€ä¸ªåŸºäº CDC çš„æ•°æ®åŒæ­¥ç»„ä»¶ï¼Œ é€šè¿‡ç›‘å¬ MySQL çš„ binlog æˆ– PostgreSQL çš„ WALï¼Œ å®æ—¶æ•è· INSERT / UPDATE / DELETEï¼Œ ä»¥äº‹ä»¶æµçš„å½¢å¼å‘é€åˆ° Kafkaã€‚\nç›¸æ¯”è½®è¯¢æ•°æ®åº“ï¼Œå®ƒå»¶è¿Ÿä½ã€å¯¹æºåº“å‹åŠ›æå°ã€æ”¯æŒ deleteã€æ”¯æŒå›æ”¾ï¼Œ éå¸¸é€‚åˆæ„å»ºå®æ—¶åŒæ­¥åˆ° Elasticsearchã€ç¼“å­˜æˆ–æ•°æ®ä»“åº“çš„æ¶æ„ã€‚\nè¡¥å…… Debezium æ˜¯ä¸€ä¸ªåŸºäº CDCï¼ˆChange Data Captureï¼Œå˜æ›´æ•°æ®æ•è·ï¼‰ çš„å¼€æºå·¥å…·ï¼Œç”¨æ¥å®æ—¶ç›‘å¬æ•°æ®åº“çš„å¢åˆ æ”¹ï¼ˆDMLï¼‰ä»¥åŠéƒ¨åˆ† DDL å˜åŒ–ï¼Œå¹¶æŠŠè¿™äº›å˜åŒ–ä»¥äº‹ä»¶æµçš„å½¢å¼å‘é€å‡ºå»ï¼ˆé€šå¸¸åˆ° Kafkaï¼‰ã€‚\nDebezium = æŠŠæ•°æ®åº“çš„ binlog / WAL å˜æˆå®æ—¶äº‹ä»¶æµ\næ ¸å¿ƒèƒ½åŠ› âœ… å®æ—¶æ•è· INSERT / UPDATE / DELETE âœ… é¡ºåºä¸€è‡´ã€è‡³å°‘ä¸€æ¬¡ï¼ˆat-least-onceï¼‰ è¯­ä¹‰ âœ… å´©æºƒå¯æ¢å¤ï¼ˆåŸºäº offsetï¼‰ âœ… æ”¯æŒ è¡¨ç»“æ„å˜æ›´ï¼ˆéƒ¨åˆ† DDLï¼‰ âœ… ä¸ä¾µå…¥ä¸šåŠ¡ä»£ç  æ”¯æŒçš„æ•°æ®åº“ å¸¸ç”¨çš„ï¼š\nMySQL / MariaDBï¼ˆbinlogï¼‰ PostgreSQLï¼ˆWAL / logical replicationï¼‰ MongoDBï¼ˆoplogï¼‰ Oracle SQL Server Db2 æ¶æ„ç»„æˆ [ Database ] â†“ (binlog / WAL) [ Debezium Connector ] â†“ [ Kafka Topic ] â†“ [ ä¸‹æ¸¸ç³»ç»Ÿ ] Debezium æœ¬è´¨æ˜¯ Kafka Connect çš„ä¸€ç±» Source Connectorã€‚\näº‹ä»¶æ•°æ®æ ¼å¼ï¼ˆå…¸å‹ï¼‰ { \u0026#34;before\u0026#34;: { \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;old\u0026#34; }, \u0026#34;after\u0026#34;: { \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;new\u0026#34; }, \u0026#34;op\u0026#34;: \u0026#34;u\u0026#34;, \u0026#34;ts_ms\u0026#34;: 1730000000000 } op å«ä¹‰ï¼š\nc -\u0026gt; createï¼ˆinsertï¼‰ u -\u0026gt; update d -\u0026gt; delete r -\u0026gt; snapshotï¼ˆå¿«ç…§ï¼‰ å¸¸è§ä½¿ç”¨åœºæ™¯ ğŸ” æ•°æ®åŒæ­¥ï¼ˆMySQL -\u0026gt; Elasticsearch / ClickHouseï¼‰ â˜˜ï¸ äº‹ä»¶é©±åŠ¨æ¶æ„ ğŸ“Š å®æ—¶æ•°ä»“ / å®æ—¶åˆ†æ ğŸ”Œ å¾®æœåŠ¡è§£è€¦ï¼ˆæ•°æ®åº“äº‹ä»¶åŒ–ï¼‰ ğŸ§ª å®¡è®¡ / æ•°æ®å˜æ›´è¿½è¸ª Debezium vs ä¼ ç»Ÿæ–¹æ¡ˆ æ–¹æ¡ˆ é—®é¢˜ å®šæ—¶å…¨é‡åŒæ­¥ å»¶è¿Ÿé«˜ã€å‹åŠ›å¤§ ä¸šåŠ¡ä»£ç å‘æ¶ˆæ¯ å¼ºä¾µå…¥ã€æ˜“æ¼ Debezium âœ… å®æ—¶ã€ä½ä¾µå…¥ã€å¯é  PostgreSQL ç‰¹åˆ«æ³¨æ„ï¼ˆä½ å¸¸ç”¨ï¼‰ å¿…é¡»å¼€å¯ logical replication ä½¿ç”¨ wal_level = logical ä¸º Debezium åˆ›å»º replication slot è¡¨å¿…é¡»æœ‰ ä¸»é”® å¸¸è§å‘ âš ï¸ è¡¨æ²¡ä¸»é”® -\u0026gt; update/delete ä¼šæœ‰é—®é¢˜ âš ï¸ binlog/WAL ä¿ç•™ç­–ç•¥ä¸å½“ -\u0026gt; slot å †ç§¯ âš ï¸ å¤§è¡¨ snapshot é˜¶æ®µå‹åŠ›å¤§ âš ï¸ exactly-once â‰  äº‹åŠ¡çº§ä¸€è‡´ï¼ˆéœ€ä¸‹æ¸¸å¤„ç†ï¼‰ å…¸å‹ç»„åˆ Debezium + Kafka + Kafka Streams / Flink Debezium + Kafka + Elasticsearch Debezium + Kafka + ClickHouse Debezium + Kafka + FastAPI æ¶ˆè´¹ ","description":"å†…å®¹ï¼šå®ƒæ˜¯ä»€ä¹ˆ -\u0026gt; åŸç† -\u0026gt; æ¶æ„ -\u0026gt; æ”¯æŒçš„æ•°æ®åº“ -\u0026gt; æ•°æ®æ ¼å¼ -\u0026gt; ä¸ Kafka/ES çš„é›†æˆ -\u0026gt; ç”Ÿäº§æœ€ä½³å®è·µ -\u0026gt; å¸¸è§å‘\nğŸš€ Debezium æ˜¯ä»€ä¹ˆï¼Ÿ Debezium æ˜¯ä¸€ä¸ªåŸºäº CDCï¼ˆChange Data Captureï¼Œå˜æ›´æ•°æ®æ•è·ï¼‰çš„å¼€æºç»„ä»¶ï¼Œ ç”¨äº å®æ—¶æ•è·æ•°æ®åº“ä¸­ INSERT / UPDATE / DELETE çš„å˜åŒ–ï¼Œå¹¶å°†å˜åŒ–äº‹ä»¶å‘é€åˆ° Kafkaï¼ˆæˆ– Kafka Connect Sinkï¼‰ã€‚\nDebezium = æŠŠæ•°æ®åº“çš„ binlog / WALï¼Œå®æ—¶å˜æˆç»“æ„åŒ–äº‹ä»¶æµ\nâ˜˜ï¸ Debezium è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆè½®è¯¢ DBï¼‰çš„é—®é¢˜ï¼š\n"},{"id":6,"href":"/database/design/","title":"Design","parent":"Database","content":"Document List:\nB-Tree å’Œ B\u0026#43;Tree çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠ MySQL å’Œ PostgreSQL ç›¸å…³çš„åŒºåˆ«ã€‚ WAL å­—ç¬¦ä¸²å­˜å‚¨ç±»å‹é€‰æ‹© æ•°æ®åº“è®¾è®¡ä¸‰å¤§èŒƒå¼ è½¯åˆ é™¤ \u0026#43; ç”Ÿå‘½å‘¨æœŸ ","description":"Document List:\nB-Tree å’Œ B\u0026#43;Tree çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠ MySQL å’Œ PostgreSQL ç›¸å…³çš„åŒºåˆ«ã€‚ WAL å­—ç¬¦ä¸²å­˜å‚¨ç±»å‹é€‰æ‹© æ•°æ®åº“è®¾è®¡ä¸‰å¤§èŒƒå¼ è½¯åˆ é™¤ \u0026#43; ç”Ÿå‘½å‘¨æœŸ "},{"id":7,"href":"/operations/docker/faq/","title":"Docker FAQ","parent":"Docker","content":"å†…å®¹ï¼šåŸºç¡€æ¦‚å¿µã€é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€å­˜å‚¨ã€Composeã€Registryã€ä¼˜åŒ–ã€å®‰å…¨ã€ç”Ÿäº§è¿ç»´å®è·µã€‚\n1ï¸âƒ£ Docker åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Dockerï¼Ÿ Docker æ˜¯ä¸€ä¸ªåŸºäº å®¹å™¨æŠ€æœ¯ çš„åº”ç”¨æ‰“åŒ…ã€åˆ†å‘ã€éƒ¨ç½²å¹³å°ï¼Œè§£å†³äº†ï¼š\nåº”ç”¨ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ æ‰“åŒ…ä¸è¿ç§»å›°éš¾ éƒ¨ç½²æµç¨‹å¤æ‚ æ ¸å¿ƒä¼˜åŠ¿ï¼šæ„å»ºä¸€æ¬¡ï¼Œåˆ°å¤„è¿è¡Œã€‚\n2. é•œåƒï¼ˆImageï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ é•œåƒæ˜¯ åªè¯»æ¨¡æ¿ï¼Œç±»ä¼¼ï¼š\nä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¿«ç…§ åŒ…å«ç¨‹åºå’Œè¿è¡Œç¯å¢ƒ é•œåƒå¯åˆ†ä¸ºï¼š\nåŸºç¡€é•œåƒï¼ˆå¦‚ ubuntuã€pythonï¼‰ åº”ç”¨é•œåƒï¼ˆåŸºäºåŸºç¡€é•œåƒæ„å»ºï¼‰ 3. å®¹å™¨ï¼ˆContainerï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ å®¹å™¨æ˜¯é•œåƒçš„è¿è¡Œå®ä¾‹ï¼ŒåŒ…å«ï¼š\nè¿›ç¨‹ æ–‡ä»¶ç³»ç»Ÿå†™å±‚ ç½‘ç»œéš”ç¦» cgroups èµ„æºé™åˆ¶ å®¹å™¨æ˜¯è½»é‡çº§â€œè¿›ç¨‹çº§è™šæ‹ŸåŒ–â€ã€‚\n4. Docker ä¸ è™šæ‹Ÿæœºï¼ˆVMï¼‰çš„åŒºåˆ«ï¼Ÿ å¯¹æ¯”é¡¹ Docker è™šæ‹Ÿæœº å¯åŠ¨é€Ÿåº¦ ç§’çº§ åˆ†é’Ÿçº§ èµ„æºå¼€é”€ ä½ é«˜ éš”ç¦»æ–¹å¼ è¿›ç¨‹çº§ï¼ˆNamespace + cgroupsï¼‰ å®Œæ•´æ“ä½œç³»ç»Ÿ é•œåƒä½“ç§¯ å° å¤§ éƒ¨ç½²æ–¹å¼ å¿«é€Ÿä¾¿æº ç¬¨é‡ 5. ä»€ä¹ˆæ˜¯ Dockerfileï¼Ÿ Dockerfile æ˜¯ç”¨äº æ„å»ºé•œåƒçš„è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…å«ï¼š\nFROM RUN COPY CMD EXPOSE ENTRYPOINT 6. ä»€ä¹ˆæ˜¯ OCIï¼Ÿ OCI = Open Container Initiative\nè§„èŒƒåŒ…æ‹¬ï¼š\né•œåƒè§„èŒƒï¼ˆImage Specï¼‰ è¿è¡Œæ—¶è§„èŒƒï¼ˆRuntime Specï¼Œå¦‚ runcï¼‰ Docker å·²éµä» OCIã€‚\n2ï¸âƒ£ é•œåƒ 7. é•œåƒåˆ†å±‚æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦åˆ†å±‚ï¼Ÿ é•œåƒæ˜¯ç”±å¤šå±‚æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œæ¯æ¡æŒ‡ä»¤ï¼ˆRUN/COPYï¼‰ä¼šç”Ÿæˆä¸€å±‚ã€‚\nå¥½å¤„ï¼š\nå±‚å¯å¤ç”¨ï¼ˆæé«˜æ„å»ºé€Ÿåº¦ï¼‰ èŠ‚çœç©ºé—´ æ„å»ºæ—¶å¯ä»¥åˆ©ç”¨ç¼“å­˜ 8. COPY å’Œ ADD åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ COPY \u0026ndash; å¤åˆ¶æ–‡ä»¶ï¼ˆæ¨èï¼‰\nADD \u0026ndash; é™„åŠ åŠŸèƒ½ï¼š\nè‡ªåŠ¨è§£å‹ tar æ”¯æŒ URL ä¸‹è½½ æœ€ä½³å®è·µï¼šæ°¸è¿œä¼˜å…ˆä½¿ç”¨ COPYã€‚\n9. CMD å’Œ ENTRYPOINT åŒºåˆ«ï¼Ÿ æŒ‡ä»¤ ä½œç”¨ CMD é»˜è®¤å‘½ä»¤ï¼Œå¯è¢«è¦†ç›– ENTRYPOINT ä¸»å‘½ä»¤ï¼Œä¸ä¼šè¢«è¦†ç›– æœ€ä½³å®è·µï¼š\nENTRYPOINT [\u0026#34;nginx\u0026#34;] CMD [\u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] 10. WORKDIRã€ENVã€EXPOSE çš„ä½œç”¨ï¼Ÿ WORKDIRï¼šè®¾ç½®å·¥ä½œç›®å½• ENVï¼šè®¾ç½®ç¯å¢ƒå˜é‡ EXPOSEï¼šå£°æ˜é•œåƒç›‘å¬çš„ç«¯å£ï¼ˆä»…æ–‡æ¡£æ„ä¹‰ï¼‰ 11. å¦‚ä½•å‡å°‘é•œåƒä½“ç§¯ï¼Ÿï¼ˆéå¸¸å¸¸è§ï¼‰ ä½¿ç”¨ slim/alpine/distroless å¤šé˜¶æ®µæ„å»ºï¼ˆmulti-stageï¼‰ åˆå¹¶ RUN æ¸…ç†ç¼“å­˜ï¼ˆapt clean / npm cache cleanï¼‰ ä½¿ç”¨ .dockerignore 12. å¦‚ä½•åŠ å¿« Docker build é€Ÿåº¦ï¼Ÿ åˆç†ä½¿ç”¨ç¼“å­˜ ä¼˜å…ˆ COPY package.json / go.mod å¤šé˜¶æ®µæ„å»º ä½¿ç”¨ BuildKit 3ï¸âƒ£ å®¹å™¨è¿è¡Œç›¸å…³ 13. docker run çš„é‡è¦å‚æ•°æœ‰å“ªäº›ï¼Ÿ -d åå°è¿è¡Œ -p ç«¯å£æ˜ å°„ -v æ•°æ®å·æŒ‚è½½ \u0026ndash;name å®¹å™¨å \u0026ndash;network æŒ‡å®šç½‘ç»œ \u0026ndash;restart=always è‡ªåŠ¨æ‹‰èµ· -e ç¯å¢ƒå˜é‡ 14. å®¹å™¨å’Œå®¿ä¸»æœºå…±äº«å“ªäº›èµ„æºï¼Ÿ å†…æ ¸ ç½‘ç»œï¼ˆé€šè¿‡ Namespace éš”ç¦»ï¼‰ æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ï¼ˆmountï¼‰ CPU/å†…å­˜é™åˆ¶ï¼ˆcgroupsï¼‰ 15. å¦‚ä½•è¿›å…¥å®¹å™¨ï¼Ÿ docker exec -it \u0026lt;container\u0026gt; /bin/bash 16. å¦‚ä½•æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼Ÿ docker logs -f 17. ä»€ä¹ˆæ˜¯ docker restart policyï¼Ÿ no always unless-stopped on-failure 4ï¸âƒ£ Docker ç½‘ç»œ 18. Docker ç½‘ç»œæ¨¡å¼æœ‰å“ªäº›ï¼Ÿ æ¨¡å¼ è¯´æ˜ bridge é»˜è®¤æ¨¡å¼ï¼Œç§ç½‘ host ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ none æ— ç½‘ç»œ container å…±ç”¨å¦ä¸€ä¸ªå®¹å™¨çš„ç½‘ç»œ 19. ä»€ä¹ˆæ˜¯ç«¯å£æ˜ å°„ï¼Ÿ docker run -p 8080:80 nginx å·¦ï¼šå®¿ä¸»æœº å³ï¼šå®¹å™¨ 20. ä»€ä¹ˆæ˜¯ Docker overlay ç½‘ç»œï¼Ÿ åœ¨ Swarm æˆ– Kubernetes ä¸­è·¨ä¸»æœºé€šä¿¡çš„ç½‘ç»œã€‚\n5ï¸âƒ£ Docker å­˜å‚¨ï¼ˆvolumeï¼‰ 21. æ•°æ®å· Volume æ˜¯ä»€ä¹ˆï¼Ÿ å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«çš„æŒä¹…æ•°æ®ç›®å½•ã€‚\nå¥½å¤„ï¼š\nå¤šå®¹å™¨å…±äº«æ•°æ® å®¹å™¨é”€æ¯åæ•°æ®ä¿ç•™ æ€§èƒ½ä¼˜äº bind mount 22. bind mount ä¸ volume åŒºåˆ«ï¼Ÿ å¯¹æ¯”é¡¹ Volume Bind mount æ€§èƒ½ é«˜ ä¸­ç­‰ çµæ´»æ€§ ä¸­ é«˜ éš”ç¦» é«˜ ä½ï¼ˆç›´æ¥è®¿é—®å®¿ä¸»æœºç›®å½•ï¼‰ Portability å¥½ å·® 23. å¦‚ä½•æ¸…ç†æ‰€æœ‰æ— ç”¨é•œåƒä¸ volumeï¼Ÿ docker system prune -a docker volume prune 6ï¸âƒ£ é•œåƒä»“åº“ï¼ˆRegistryï¼‰ 24. Docker Hub ä¸ Registry çš„åŒºåˆ«ï¼Ÿ Docker Hubï¼šå…¬å¼€ä»“åº“ï¼ˆSaaSï¼‰ Registryï¼šä¼ä¸šç§æœ‰ä»“åº“ 25. å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰ Registryï¼Ÿ docker run -d -p 5000:5000 registry:2 26. å¦‚ä½•ç»™é•œåƒæ‰“æ ‡ç­¾å¹¶æ¨é€ï¼Ÿ docker tag myapp registry:5000/myapp docker push registry:5000/myapp 7ï¸âƒ£ Docker Compose 27. Docker Compose æ˜¯ä»€ä¹ˆï¼Ÿ Compose æ˜¯ä¸€ä¸ª å¤šå®¹å™¨ç¼–æ’å·¥å…·ï¼Œç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨åº”ç”¨ã€‚\n28. docker-compose.yml å¸¸è§å­—æ®µï¼Ÿ services: app: image: xxx build: . ports: - \u0026#34;8080:80\u0026#34; volumes: - ./data:/data 29. compose up / down åŒºåˆ«ï¼Ÿ docker compose up -d # å¯åŠ¨ docker compose down # åˆ é™¤å®¹å™¨ã€ç½‘ç»œ 8ï¸âƒ£ Docker æ€§èƒ½ä¼˜åŒ– 30. å¦‚ä½•ä¼˜åŒ– Docker å¯åŠ¨é€Ÿåº¦ï¼Ÿ ä½¿ç”¨æ›´å°åŸºç¡€é•œåƒ ç²¾ç®€é•œåƒå±‚ é¿å…åœ¨å®¹å™¨å…¥å£æ‰§è¡Œå¤æ‚è„šæœ¬ 31. å¦‚ä½•ä¼˜åŒ– Docker é•œåƒå¤§å°ï¼Ÿ ä½¿ç”¨ alpine/slim å¤šé˜¶æ®µæ„å»º dockerignore æ¸…ç†ç¼“å­˜ 32. Docker IO æ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ é¿å…é¢‘ç¹å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ ä½¿ç”¨ volume é¿å… journal/log åœ¨å®¹å™¨ä¸­å †ç§¯ 9ï¸âƒ£ Docker å®‰å…¨ 33. å¦‚ä½•æé«˜ Docker å®‰å…¨æ€§ï¼Ÿ é•œåƒä¸è¦ä½¿ç”¨ latest ä¸è¦åœ¨å®¹å™¨å†…è¿è¡Œ root ä½¿ç”¨ seccompã€AppArmor å…³é—­ä¸å¿…è¦çš„ capability ä¸è¦æŠŠ secrets å†™å…¥é•œåƒ 34. PID éš”ç¦»æ˜¯ä»€ä¹ˆï¼Ÿ ä¸åŒå®¹å™¨çš„è¿›ç¨‹äº’ä¸å¯è§ã€‚\n35. Docker æ˜¯å¦‚ä½•å®ç°éš”ç¦»çš„ï¼Ÿ Namespaceï¼ˆpid/net/ipc/uts/mountï¼‰ cgroupsï¼ˆCPU/å†…å­˜é™åˆ¶ï¼‰ UnionFSï¼ˆAUFS/overlayfsï¼‰ ğŸ”Ÿ ä¼ä¸šå®æˆ˜ä¸æ•…éšœå¤„ç† 36. å¦‚ä½•å®šä½å®¹å™¨ CPU è¿‡é«˜ï¼Ÿ docker stats docker top \u0026lt;container\u0026gt; è¿›å…¥å®¹å™¨åï¼š\ntop ps aux 37. å®¹å™¨ç£ç›˜å ç”¨å˜å¤§å¦‚ä½•æ’æŸ¥ï¼Ÿ docker system df å®¹å™¨å†™å…¥å¤§é‡æ—¥å¿— volume å†™å…¥è¿‡å¤šæ•°æ® overlay2 æ–‡ä»¶è†¨èƒ€ 38. é•œåƒæ„å»ºå¤±è´¥å¦‚ä½•æ’æŸ¥ï¼Ÿ æ£€æŸ¥ Dockerfile æŒ‡ä»¤é¡ºåº ä½¿ç”¨ \u0026ndash;progress=plain \u0026ndash;no-cache è§‚å¯Ÿè¯¦ç»†æ—¥å¿— æ£€æŸ¥ dockerignore 39. å¦‚ä½•å®ç°ç°åº¦å‘å¸ƒï¼Ÿ æ–¹æ¡ˆï¼š\nè¿è¡Œå¤šä¸ªç‰ˆæœ¬çš„å®¹å™¨ é€šè¿‡ Nginx/LB é…ç½®æƒé‡ Kubernetes Deploymentï¼ˆæ»šåŠ¨å‡çº§ï¼‰ 40. Docker Swarm å’Œ Kubernetes çš„å…³ç³»ï¼Ÿ å¯¹æ¯”é¡¹ Swarm Kubernetes åŠŸèƒ½ä¸°å¯Œ âŒ âœ… ç¤¾åŒºæ”¯æŒ å¼± å¼º å­¦ä¹ æˆæœ¬ ä½ é«˜ ä¼ä¸šä½¿ç”¨é‡ ä½ æé«˜ å¦‚ä»Šä¼ä¸šåŸºæœ¬éƒ½è¿è¡Œ Kubernetesã€‚\n","description":"å†…å®¹ï¼šåŸºç¡€æ¦‚å¿µã€é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€å­˜å‚¨ã€Composeã€Registryã€ä¼˜åŒ–ã€å®‰å…¨ã€ç”Ÿäº§è¿ç»´å®è·µã€‚\n1ï¸âƒ£ Docker åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Dockerï¼Ÿ Docker æ˜¯ä¸€ä¸ªåŸºäº å®¹å™¨æŠ€æœ¯ çš„åº”ç”¨æ‰“åŒ…ã€åˆ†å‘ã€éƒ¨ç½²å¹³å°ï¼Œè§£å†³äº†ï¼š\nåº”ç”¨ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ æ‰“åŒ…ä¸è¿ç§»å›°éš¾ éƒ¨ç½²æµç¨‹å¤æ‚ æ ¸å¿ƒä¼˜åŠ¿ï¼šæ„å»ºä¸€æ¬¡ï¼Œåˆ°å¤„è¿è¡Œã€‚\n2. é•œåƒï¼ˆImageï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ é•œåƒæ˜¯ åªè¯»æ¨¡æ¿ï¼Œç±»ä¼¼ï¼š\n"},{"id":8,"href":"/database/elasticsearch/faq/","title":"ElasticSearch FAQ","parent":"ElasticSearch","content":"å†…å®¹ï¼šåŸºç¡€ã€å€’æ’ç´¢å¼•ã€å†™å…¥åŸç†ã€æŸ¥è¯¢ã€é›†ç¾¤ã€åˆ†ç‰‡ã€æ€§èƒ½è°ƒä¼˜ã€å†·çƒ­åˆ†ç¦»ã€å®‰å…¨ã€ES 7/8 æ–°ç‰¹æ€§ç­‰ã€‚\nâ­ ç›®å½•\nä¸€ã€åŸºç¡€æ¦‚å¿µ äºŒã€å€’æ’ç´¢å¼• / Lucene åŸç† ä¸‰ã€å†™å…¥æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ å››ã€æŸ¥è¯¢æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ äº”ã€åˆ†ç‰‡ / å‰¯æœ¬ / è·¯ç”± å…­ã€é›†ç¾¤ä¸èŠ‚ç‚¹è§’è‰² ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•ã€æœç´¢ï¼‰ å…«ã€æ•°æ®å»ºæ¨¡ ä¹ã€ES è¿ç»´ åã€å¸¸è§æ•…éšœ åä¸€ã€å®‰å…¨ä¸æƒé™ åäºŒã€å†·çƒ­åˆ†ç¦» / ILM åä¸‰ã€ç›¸å…³ç”Ÿæ€ï¼ˆKibanaã€Logstashã€Beatsï¼‰ ä¸€ã€åŸºç¡€æ¦‚å¿µ 1. ElasticSearch æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå¿«ï¼Ÿ å›ç­”ç²¾è¦ï¼š\nElasticSearch æ˜¯åŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚\nå®ƒå¿«çš„åŸå› ï¼š\nå€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰ åˆ†å¸ƒå¼åˆ†ç‰‡å¹¶è¡ŒæŸ¥è¯¢ åˆ—å¼å­˜å‚¨ï¼ˆdoc_valuesï¼‰ å†…å­˜ç¼“å­˜ï¼ˆfile cache / query cache / shard request cacheï¼‰ é«˜æ•ˆçš„å†™å…¥ä¸ segment merge äºŒã€å€’æ’ç´¢å¼•åŸç† 2. ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ å€’æ’ç´¢å¼•æ˜¯ï¼š\nå•è¯ -\u0026gt; å‡ºç°åœ¨å“ªäº›æ–‡æ¡£ -\u0026gt; æ–‡æ¡£ä¸­çš„ä½ç½®\né€‚åˆå…¨æ–‡æ£€ç´¢ï¼ŒæŸ¥è¯¢å¤æ‚æ–‡æœ¬é€Ÿåº¦è¿œè¿œå¿«äºå…³ç³»å‹æ•°æ®åº“ã€‚\n3. å€’æ’ç´¢å¼•ä¸ºä»€ä¹ˆå¿«ï¼Ÿ å…³é”®è¯ç›´æ¥å¯¹åº”æ–‡æ¡£åˆ—è¡¨ï¼Œæ— éœ€æ‰«ææ•´å¼ è¡¨ ç»“æ„é€‚åˆå¤§è§„æ¨¡å¹¶è¡Œæœç´¢ Lucene å¯¹ç´¢å¼•è¿›è¡Œäº†å¤§é‡ä¼˜åŒ–ï¼šè·³è¡¨ã€FSTã€å‹ç¼©å­˜å‚¨ ä¸‰ã€å†™å…¥æµç¨‹ 4. ElasticSearch æ–‡æ¡£å†™å…¥æµç¨‹ï¼Ÿ æµç¨‹å¦‚ä¸‹ï¼š\nåè°ƒèŠ‚ç‚¹æ¥æ”¶è¯·æ±‚ æ ¹æ® routing è®¡ç®—ç›®æ ‡ primary shard å†™å…¥ lucene å†…å­˜ buffer å®šæœŸ refresh -\u0026gt; ç”Ÿæˆ segmentï¼Œå¯è¢«æœç´¢ translog è®°å½•å†™å…¥æ—¥å¿— åå° merge åˆå¹¶å° segment å‰¯æœ¬åŒæ­¥ 5. refresh æ˜¯ä»€ä¹ˆï¼Ÿflush æ˜¯ä»€ä¹ˆï¼Ÿ refreshï¼ˆé»˜è®¤ 1 ç§’ï¼‰ï¼šåˆ·æ–°å†…å­˜ bufferï¼Œç”Ÿæˆå¯æœç´¢ segment -\u0026gt; æ•°æ®â€œå¯è¢«æŸ¥è¯¢â€ã€‚ flushï¼šæ¸…ç©º translog -\u0026gt; ä¿è¯æ•°æ®æŒä¹…åŒ–ã€‚ å››ã€æŸ¥è¯¢æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ 6. ElasticSearch æŸ¥è¯¢æµç¨‹ï¼Ÿ åè°ƒèŠ‚ç‚¹æ‹†åˆ†æŸ¥è¯¢ -\u0026gt; å‘é€åˆ°æ¯ä¸ª shard æ¯ä¸ª shard æŸ¥è¯¢è‡ªå·±çš„å€’æ’ç´¢å¼• è¿”å› top N åè°ƒèŠ‚ç‚¹åˆå¹¶ç»“æœ è¿”å›æœ€ç»ˆæ’åºåçš„ç»“æœ äº”ã€åˆ†ç‰‡ / å‰¯æœ¬ / è·¯ç”± 7. ä¸ºä»€ä¹ˆ ES è¦åˆ†ç‰‡ï¼Ÿ æ”¯æŒæ°´å¹³æ‰©å±• æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢ é¿å…å•èŠ‚ç‚¹æ— æ³•å­˜å‚¨è¶…å¤§æ•°æ® 8. åˆ†ç‰‡é€‰å¤šäº†æœ‰ä»€ä¹ˆåå¤„ï¼Ÿ å° segment å¤ªå¤š -\u0026gt; æœç´¢æ…¢ merge å‹åŠ›å¤§ å†…å­˜å ç”¨é«˜ æœ€ä½³å®è·µï¼šå• shard æ§åˆ¶åœ¨ 20â€“50 GBã€‚\n9. ES çš„è·¯ç”±ç®—æ³•ï¼Ÿ é»˜è®¤ï¼š\nshard = hash(_routing) % number_of_primary_shards\næ‰€ä»¥ åˆ†ç‰‡æ•°ä¸èƒ½ä¿®æ”¹ï¼ˆä¸»åˆ†ç‰‡æ•°å›ºå®šï¼‰ã€‚\n10. Replica å‰¯æœ¬çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ è¯»é«˜å¯ç”¨ï¼ˆæé«˜æŸ¥è¯¢æ€§èƒ½ï¼‰ æ•…éšœè½¬ç§»ï¼ˆä¸»åˆ†ç‰‡æŒ‚äº†ï¼Œå‰¯æœ¬æå‡ä¸ºä¸»åˆ†ç‰‡ï¼‰ å…­ã€é›†ç¾¤ã€èŠ‚ç‚¹è§’è‰² 11. ä»€ä¹ˆæ˜¯ master èŠ‚ç‚¹ï¼Ÿ è´Ÿè´£ï¼š\nç®¡ç†é›†ç¾¤çŠ¶æ€ é€‰ä¸» åˆ›å»ºåˆ é™¤ç´¢å¼• åˆ†ç‰‡è°ƒåº¦ å¸¸è§é”™è¯¯ï¼šæŠŠ master å½“æˆæ•°æ®èŠ‚ç‚¹ä½¿ç”¨ -\u0026gt; å´©æºƒé£é™©ã€‚\n12. ES 7/8 æœ‰å“ªäº›èŠ‚ç‚¹è§’è‰²ï¼Ÿ ç®€è¦åˆ—å‡ºï¼š\nmaster data_hot / data_warm / data_cold / data_frozen ingest transform ml coordinating-only ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•ã€æœç´¢ï¼‰ 13. å†™å…¥æ€§èƒ½æ€ä¹ˆä¼˜åŒ–ï¼Ÿ ä½¿ç”¨ bulk æ‰¹é‡å†™å…¥ é™ä½ refresh_intervalï¼ˆé»˜è®¤ 1sï¼Œå¯æ”¹æˆ 5sï¼‰ ä½¿ç”¨ Autogenerated ID ä¸è¦é¢‘ç¹æ›´æ–°æ–‡æ¡£ï¼ˆå› ä¸ºæ›´æ–°æœ¬è´¨æ˜¯åˆ é™¤+æ–°å¢ï¼‰ åˆç†çš„åˆ†ç‰‡æ•°é‡ ä½¿ç”¨ SSD 14. æœç´¢æ€§èƒ½æ€ä¹ˆä¼˜åŒ–ï¼Ÿ ä½¿ç”¨ filterï¼ˆå¯ç¼“å­˜ï¼‰ keyword ä»£æ›¿ textï¼ˆä¸åˆ†è¯ï¼‰ å…³é—­ä¸å¿…è¦çš„å­—æ®µï¼ˆ\u0026ldquo;index\u0026rdquo;: falseï¼‰ ä½¿ç”¨ doc_valuesï¼Œç¦ç”¨ fielddata å°½é‡ä½¿ç”¨ Term æŸ¥è¯¢ï¼Œä¸ç”¨ wildcard å‰ç¼€æœç´¢ å…«ã€æ•°æ®å»ºæ¨¡ 15. text å’Œ keyword çš„åŒºåˆ«ï¼Ÿ å­—æ®µç±»å‹ æ˜¯å¦åˆ†è¯ ä½¿ç”¨åœºæ™¯ text æ˜¯ å…¨æ–‡æ£€ç´¢ keyword å¦ ç²¾ç¡®åŒ¹é…/èšåˆ/æ’åº 16. mapping ä¸ºä»€ä¹ˆè¦é™æ€å®šä¹‰ï¼Œä¸è¦ä¾èµ– dynamicï¼Ÿ dynamic ä¼šå¯¼è‡´å­—æ®µçˆ†ç‚¸ï¼ˆfield explosionï¼‰ å¯¼è‡´é›†ç¾¤çŠ¶æ€è†¨èƒ€ å½±å“æœç´¢æ€§èƒ½ ä¹ã€è¿ç»´ 17. å¦‚ä½•æ‰©å®¹ ESï¼Ÿ å¢åŠ æ•°æ®èŠ‚ç‚¹ -\u0026gt; shard è‡ªåŠ¨ re-balance å¢åŠ  master èŠ‚ç‚¹æé«˜ç¨³å®šæ€§ å¢åŠ åè°ƒèŠ‚ç‚¹æå‡æœç´¢æ€§èƒ½ 18. å¦‚ä½•æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€ï¼Ÿ GET _cluster/health è¾“å‡º green/yellow/redã€‚\n19. ä»€ä¹ˆæƒ…å†µä¸‹å‡ºç° yellowï¼Ÿ å‰¯æœ¬æœªåˆ†é… å•èŠ‚ç‚¹é›†ç¾¤ï¼ˆæ­£å¸¸ï¼‰ åã€å¸¸è§æ•…éšœ 20. é›†ç¾¤å˜çº¢æ€ä¹ˆåŠï¼Ÿ å¸¸è§åŸå› ï¼š\næŸäº›ä¸»åˆ†ç‰‡ä¸¢å¤± èŠ‚ç‚¹æ‰çº¿ ç£ç›˜æ»¡ï¼ˆå¸¸è§ï¼ï¼‰ å¤„ç†ï¼š\næŸ¥çœ‹ _cluster/allocation/explain é‡Šæ”¾ç£ç›˜ç©ºé—´ æ¢å¤å¿«ç…§ 21. ä¸ºä»€ä¹ˆ ES å ç”¨ç£ç›˜æ¯”ä½ çš„æ•°æ®å¤§ï¼Ÿ åŸå› ï¼š\nå€’æ’ç´¢å¼•æˆæœ¬é«˜ segment + merge å‰¯æœ¬ ç´¢å¼•å­˜å‚¨ç»“æ„æœ¬èº«å‹ç¼©æ¯”ä½ åä¸€ã€å®‰å…¨ä¸æƒé™ 22. å¦‚ä½•å¼€å¯ ElasticSearch å®‰å…¨è®¤è¯ï¼Ÿ ES 8 é»˜è®¤å¼€å¯ X-Pack Securityï¼š\nTLS ç”¨æˆ·è§’è‰²ç®¡ç†ï¼ˆRBACï¼‰ API Key Token åäºŒã€å†·çƒ­åˆ†ç¦» / ILM 23. å†·çƒ­åˆ†ç¦»æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ çƒ­èŠ‚ç‚¹é«˜æ€§èƒ½ï¼šå†™å…¥æ›´å¿« å†·èŠ‚ç‚¹é«˜å®¹é‡ï¼šæˆæœ¬æ›´ä½ ILM æ§åˆ¶ index ç”Ÿå‘½å‘¨æœŸ 24. è®²ä¸€ä¸‹ ILM çš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ ä¸€èˆ¬æµç¨‹ï¼š\nHot -\u0026gt; Warm -\u0026gt; Cold -\u0026gt; Frozen -\u0026gt; Delete\næ¯ä¸ªé˜¶æ®µæ§åˆ¶ï¼š\nrollover forcemerge allocate åˆ°ä¸åŒèŠ‚ç‚¹ searchable snapshot åä¸‰ã€ELK / EFK ç”Ÿæ€ 25. Logstashã€Beatsã€ElasticSearchã€Kibana çš„èŒè´£ï¼Ÿ Filebeatï¼šè½»é‡é‡‡é›†æ—¥å¿— Logstashï¼šLog pipelineï¼ˆè¿‡æ»¤ã€è§£æã€grokï¼‰ Kafkaï¼ˆå¯é€‰ï¼‰ï¼šç¼“å­˜/å‰Šå³°/è§£è€¦ ElasticSearchï¼šæœç´¢ä¸å­˜å‚¨ Kibanaï¼šå±•ç¤ºä¸å¯è§†åŒ– åå››ã€æ¦‚è¿° ElasticSearch å¿«æ˜¯å› ä¸ºå€’æ’ç´¢å¼• + Lucene + åˆ†å¸ƒå¼ + å¹¶è¡Œæœç´¢ + åˆ—å¼å­˜å‚¨ã€‚\nå†™å…¥æ˜¯ï¼šbuffer -\u0026gt; segment -\u0026gt; refresh -\u0026gt; translog -\u0026gt; flush -\u0026gt; mergeã€‚\nåˆ†ç‰‡æ•°ä¸è¦å¤ªå¤šï¼Œå• shard æ§åˆ¶ 20â€“50GBã€‚\nä½¿ç”¨ filterã€keywordã€doc_values ä¼˜åŒ–æœç´¢ã€‚\né  ILM åšå†·çƒ­åˆ†ç¦»ï¼Œæé«˜æ€§èƒ½å’Œé™ä½æˆæœ¬ã€‚\nmaster åªè´Ÿè´£ç®¡ç†ï¼Œä¸å­˜æ•°æ®ã€‚\næŸ¥è¯¢å’Œå†™å…¥è·¯å¾„è¦å®Œå…¨ç†è§£ã€‚\n","description":"å†…å®¹ï¼šåŸºç¡€ã€å€’æ’ç´¢å¼•ã€å†™å…¥åŸç†ã€æŸ¥è¯¢ã€é›†ç¾¤ã€åˆ†ç‰‡ã€æ€§èƒ½è°ƒä¼˜ã€å†·çƒ­åˆ†ç¦»ã€å®‰å…¨ã€ES 7/8 æ–°ç‰¹æ€§ç­‰ã€‚\nâ­ ç›®å½•\nä¸€ã€åŸºç¡€æ¦‚å¿µ äºŒã€å€’æ’ç´¢å¼• / Lucene åŸç† ä¸‰ã€å†™å…¥æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ å››ã€æŸ¥è¯¢æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ äº”ã€åˆ†ç‰‡ / å‰¯æœ¬ / è·¯ç”± å…­ã€é›†ç¾¤ä¸èŠ‚ç‚¹è§’è‰² ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•ã€æœç´¢ï¼‰ å…«ã€æ•°æ®å»ºæ¨¡ ä¹ã€ES è¿ç»´ åã€å¸¸è§æ•…éšœ åä¸€ã€å®‰å…¨ä¸æƒé™ åäºŒã€å†·çƒ­åˆ†ç¦» / ILM åä¸‰ã€ç›¸å…³ç”Ÿæ€ï¼ˆKibanaã€Logstashã€Beatsï¼‰ ä¸€ã€åŸºç¡€æ¦‚å¿µ 1. ElasticSearch æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå¿«ï¼Ÿ å›ç­”ç²¾è¦ï¼š\nElasticSearch æ˜¯åŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚\n"},{"id":9,"href":"/backend/python/fastapi/tutorial/","title":"FastAPI åŸºç¡€æ•™ç¨‹","parent":"FastAPI","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å®ç”¨ã€å¯ç›´æ¥ä¸Šæ‰‹é¡¹ç›®çš„ FastAPI æ•™ç¨‹ã€‚\nä¸æ˜¯é‚£ç§åªè®²æ¦‚å¿µçš„ï¼Œè€Œæ˜¯ç»“åˆä½ ç°åœ¨çš„æŠ€æœ¯æ ˆï¼ˆFastAPI + SQLAlchemy ORM + PostgreSQL + JWT + Casbin + UMI + AntDï¼‰å»å†™çš„ é¡¹ç›®çº§æ•™ç¨‹ã€‚\nå†…å®¹åˆ†ä¸º åŸºç¡€ -\u0026gt; å®æˆ˜ -\u0026gt; å·¥ç¨‹åŒ–æœ€ä½³å®è·µ ä¸‰ä¸ªéƒ¨åˆ†ã€‚\nğŸš€ ä¸€ã€FastAPI åŸºç¡€å…¥é—¨ï¼ˆ10 åˆ†é’ŸæŒæ¡ï¼‰ 1.1 å®‰è£… pip install fastapi uvicorn[standard] 1.2 æœ€ç®€å•çš„ç¤ºä¾‹ from fastapi import FastAPI app = FastAPI() @app.get(\u0026#34;/\u0026#34;) async def index(): return {\u0026#34;msg\u0026#34;: \u0026#34;Hello FastAPI\u0026#34;} è¿è¡Œï¼š\nuvicorn main:app --reload è®¿é—®ï¼šhttp://127.0.0.1:8000/docs\nSwagger æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆã€‚\nğŸ“Œ äºŒã€è·¯ç”±ï¼ˆRouterï¼‰ä¸é¡¹ç›®ç»“æ„ æ¨è æ¨¡å—åŒ–ç»“æ„ï¼ˆä½ å·²ç»åœ¨ä½¿ç”¨ï¼‰ï¼š\napp/ api/ users.py auth.py roles.py permissions.py core/ config.py security.py db/ base.py session.py models/ user.py role.py permission.py schemas/ user.py role.py main.py åœ¨ main.py æ³¨å†Œè·¯ç”±ï¼š\nfrom fastapi import FastAPI from api import users, auth app = FastAPI() app.include_router(auth.router, prefix=\u0026#34;/api/auth\u0026#34;) app.include_router(users.router, prefix=\u0026#34;/api/users\u0026#34;) ğŸ§± ä¸‰ã€Pydantic æ¨¡å‹ï¼ˆSchemasï¼‰ è¯·æ±‚æ¨¡å‹ + å“åº”æ¨¡å‹ï¼š\nfrom pydantic import BaseModel, EmailStr class UserCreate(BaseModel): username: str email: EmailStr password: str class UserOut(BaseModel): id: int username: str email: str class Config: from_attributes = True FastAPI ä¼šè‡ªåŠ¨éªŒè¯è¾“å…¥ã€‚\nğŸ—„ å››ã€æ•°æ®åº“ï¼šSQLAlchemy ORMï¼ˆAsync ç‰ˆæœ¬ï¼‰ ä½ é¡¹ç›®ä¸­ä½¿ç”¨ Async SQLAlchemy 2.0 æ˜¯æœ€ä½³æ–¹æ¡ˆã€‚\n4.1 æ•°æ®åº“è¿æ¥ # db/session.py from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker engine = create_async_engine( \u0026#34;postgresql+asyncpg://user:pass@localhost:5432/dbname\u0026#34;, echo=False, ) AsyncSessionLocal = async_sessionmaker( engine, expire_on_commit=False ) async def get_db(): async with AsyncSessionLocal() as session: yield session 4.2 ORM æ¨¡å‹ # db/models/user.py from sqlalchemy.orm import Mapped, mapped_column from sqlalchemy import String, Integer from db.session import Base class User(Base): __tablename__ = \u0026#34;users\u0026#34; id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True) username: Mapped[str] = mapped_column(String(50), unique=True) email: Mapped[str] = mapped_column(String(100), unique=True) password: Mapped[str] = mapped_column(String(255)) ğŸ” äº”ã€JWT ç™»å½•é‰´æƒï¼ˆä½ é¡¹ç›®æ­£åœ¨ä½¿ç”¨ï¼‰ 5.1 å®‰è£…ä¾èµ– pip install python-jose passlib[bcrypt] python-multipart 5.2 åˆ›å»º JWT å·¥å…·ï¼ˆä½ å·²è¦æ±‚é›†æˆ bcryptï¼‰ # core/security.py from datetime import datetime, timedelta from jose import jwt from passlib.context import CryptContext SECRET_KEY = \u0026#34;your-secret\u0026#34; ALGORITHM = \u0026#34;HS256\u0026#34; pwd_context = CryptContext(schemes=[\u0026#34;bcrypt\u0026#34;], deprecated=\u0026#34;auto\u0026#34;) def hash_password(password: str): return pwd_context.hash(password) def verify_password(password: str, hashed: str): return pwd_context.verify(password, hashed) def create_access_token(data: dict, expires_minutes=60): to_encode = data.copy() expire = datetime.utcnow() + timedelta(minutes=expires_minutes) to_encode.update({\u0026#34;exp\u0026#34;: expire}) return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM) 5.3 ç™»å½•æ¥å£ # api/auth.py from fastapi import APIRouter, Depends, HTTPException from core.security import verify_password, create_access_token from db.session import get_db from sqlalchemy import select from db.models.user import User router = APIRouter() @router.post(\u0026#34;/login\u0026#34;) async def login(data: dict, db=Depends(get_db)): stmt = select(User).where(User.username == data[\u0026#34;username\u0026#34;]) result = await db.execute(stmt) user = result.scalar_one_or_none() if not user or not verify_password(data[\u0026#34;password\u0026#34;], user.password): raise HTTPException(401, \u0026#34;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯\u0026#34;) token = create_access_token({\u0026#34;id\u0026#34;: user.id}) return {\u0026#34;token\u0026#34;: token} âš– å…­ã€æƒé™æ§åˆ¶ï¼šCasbinï¼ˆä½ é¡¹ç›®æ­£åœ¨ä½¿ç”¨ï¼‰ å®‰è£…ï¼š\npip install casbin casbin_sqlalchemy_adapter é›†æˆç¤ºä¾‹ï¼ˆæ ¸å¿ƒä»£ç ï¼‰\nfrom fastapi import Depends, HTTPException from casbin import Enforcer from core.casbin import enforcer def check_permission(sub: str, obj: str, act: str): if not enforcer.enforce(sub, obj, act): raise HTTPException(status_code=403, detail=\u0026#34;æƒé™ä¸è¶³\u0026#34;) å¯åœ¨è·¯ç”±ä¸­ä½¿ç”¨ï¼š\n@router.get(\u0026#34;/roles\u0026#34;) async def get_roles(user=Depends(get_current_user)): check_permission(user.role_code, \u0026#34;roles\u0026#34;, \u0026#34;read\u0026#34;) ğŸ§© ä¸ƒã€è¿”å› JSONï¼šé€šç”¨ ORM -\u0026gt; JSON è½¬æ¢å·¥å…·ï¼ˆä½ è¦æ±‚è¿‡ï¼‰ ç¤ºä¾‹ï¼š\nfrom datetime import date, datetime def to_dict_list(result, fields: list[str] | None = None): data = [] for item in result: row = {} for key in fields or item.__dict__.keys(): val = getattr(item, key, None) if isinstance(val, (datetime, date)): val = val.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) if isinstance(val, datetime) else val.strftime(\u0026#34;%Y-%m-%d\u0026#34;) elif isinstance(val, str): val = val.strip() row[key] = val data.append(row) return data ğŸ“¦ å…«ã€ä¸Šä¼ ã€ä¸‹è½½ æ–‡ä»¶ ä¸Šä¼ ï¼š\nfrom fastapi import UploadFile @router.post(\u0026#34;/upload\u0026#34;) async def upload(file: UploadFile): content = await file.read() with open(f\u0026#34;files/{file.filename}\u0026#34;, \u0026#34;wb\u0026#34;) as f: f.write(content) return {\u0026#34;msg\u0026#34;: \u0026#34;ok\u0026#34;} ä¸‹è½½ï¼š\nfrom fastapi.responses import FileResponse @router.get(\u0026#34;/download\u0026#34;) async def download(): return FileResponse(\u0026#34;files/test.pdf\u0026#34;) ğŸ“¡ ä¹ã€FastAPI ä¸­é—´ä»¶ç¤ºä¾‹ï¼ˆæ—¥å¿—ã€è·¨åŸŸï¼‰ from fastapi.middleware.cors import CORSMiddleware app.add_middleware( CORSMiddleware, allow_origins=[\u0026#34;*\u0026#34;], allow_credentials=True, allow_methods=[\u0026#34;*\u0026#34;], allow_headers=[\u0026#34;*\u0026#34;], ) âš™ åã€å·¥ç¨‹åŒ–æœ€ä½³å®è·µï¼ˆå¼ºçƒˆæ¨èï¼‰ ä½ æ„å»ºåç«¯ç³»ç»Ÿæ—¶ï¼Œéœ€è¦ä»¥ä¸‹è§„èŒƒï¼š\nâœ… é…ç½®æ–‡ä»¶ Configï¼ˆåŒºåˆ† dev/prodï¼‰ ä½¿ç”¨ pydantic-settingsã€‚\nâœ… å¼‚æ­¥ SQLAlchemy å·¥å…·å‡½æ•° ä½ æ­£åœ¨å°è£… async insert/update/deleteï¼Œå¯é‡‡ç”¨ï¼š\nasync def db_insert(db: AsyncSession, obj): db.add(obj) await db.commit() await db.refresh(obj) return obj âœ… é”™è¯¯ç»Ÿä¸€å¤„ç† ç»Ÿä¸€è¾“å‡ºï¼š\n{\u0026#34;code\u0026#34;: 400, \u0026#34;msg\u0026#34;: \u0026#34;xxx\u0026#34;, \u0026#34;data\u0026#34;: null} âœ… æ—¥å¿— loguru + æ—‹è½¬æ—¥å¿—ã€‚\nâœ… é¡¹ç›®æ¨¡æ¿æ¨è ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å®ç”¨ã€å¯ç›´æ¥ä¸Šæ‰‹é¡¹ç›®çš„ FastAPI æ•™ç¨‹ã€‚\nä¸æ˜¯é‚£ç§åªè®²æ¦‚å¿µçš„ï¼Œè€Œæ˜¯ç»“åˆä½ ç°åœ¨çš„æŠ€æœ¯æ ˆï¼ˆFastAPI + SQLAlchemy ORM + PostgreSQL + JWT + Casbin + UMI + AntDï¼‰å»å†™çš„ é¡¹ç›®çº§æ•™ç¨‹ã€‚\nå†…å®¹åˆ†ä¸º åŸºç¡€ -\u0026gt; å®æˆ˜ -\u0026gt; å·¥ç¨‹åŒ–æœ€ä½³å®è·µ ä¸‰ä¸ªéƒ¨åˆ†ã€‚\nğŸš€ ä¸€ã€FastAPI åŸºç¡€å…¥é—¨ï¼ˆ10 åˆ†é’ŸæŒæ¡ï¼‰ 1.1 å®‰è£… pip install fastapi uvicorn[standard] 1.2 æœ€ç®€å•çš„ç¤ºä¾‹ from fastapi import FastAPI app = FastAPI() @app.get(\u0026#34;/\u0026#34;) async def index(): return {\u0026#34;msg\u0026#34;: \u0026#34;Hello FastAPI\u0026#34;} è¿è¡Œï¼š\n"},{"id":10,"href":"/operations/git/faq/","title":"Git FAQ","parent":"Git","content":" ä¸€ã€Git åŸºç¡€ 1. Git å’Œ SVN çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ å¯¹æ¯”ç»´åº¦ Git SVN ç‰ˆæœ¬åº“æ¨¡å‹ åˆ†å¸ƒå¼ï¼Œæ¯äººéƒ½æœ‰å®Œæ•´ä»“åº“ é›†ä¸­å¼ï¼Œä¾èµ–ä¸­å¤®æœåŠ¡å™¨ åˆ†æ”¯ è½»é‡ï¼Œå‡ ä¹å…è´¹ å¤åˆ¶ç›®å½•ï¼Œé‡ æäº¤é€Ÿåº¦ å¿«ï¼Œæœ¬åœ°æäº¤ æ…¢ï¼Œéœ€è¦ç½‘ç»œ ç¦»çº¿å·¥ä½œ å®Œå…¨æ”¯æŒ ä¸èƒ½ å­˜å‚¨ç»“æ„ å†…å®¹å¯»å€ï¼ˆå¯¹è±¡ï¼‰ æ–‡ä»¶å·®å¼‚ åˆå¹¶å†²çªå¤„ç† å¼ºå¤§ ä¸€èˆ¬ æ€»ç»“ï¼š\nGit æ˜¯åˆ†å¸ƒå¼çš„ã€ä»¥å†…å®¹ä¸ºæ ¸å¿ƒã€åˆ†æ”¯æå¿«ã€åˆå¹¶å¼ºçš„ç°ä»£å·¥å…·ã€‚\n2. Git å·¥ä½œåŒºã€æš‚å­˜åŒºã€ç‰ˆæœ¬åº“åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ å·¥ä½œåŒºï¼ˆworking directoryï¼‰ï¼šä½ çš„ä»£ç æ‰€åœ¨ç›®å½•ã€‚ æš‚å­˜åŒºï¼ˆstage/indexï¼‰ï¼šgit add åè¿›å…¥çš„åŒºåŸŸã€‚ æœ¬åœ°ä»“åº“ï¼ˆrepositoryï¼‰ï¼š.git ç›®å½•ï¼Œå­˜å‚¨ commitã€tree å¯¹è±¡ã€‚ è¿œç¨‹ä»“åº“ï¼ˆoriginï¼‰ï¼šGitLab/GitHub ä¸Šçš„ä»“åº“ã€‚ æµç¨‹å›¾ï¼š\nå·¥ä½œåŒº -\u0026gt; git add -\u0026gt; æš‚å­˜åŒº -\u0026gt; git commit -\u0026gt; æœ¬åœ°åº“ -\u0026gt; git push -\u0026gt; è¿œç¨‹åº“\n3. HEADã€working treeã€index çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ HEADï¼šå½“å‰åœ¨å“ªä¸ª commit æˆ–åˆ†æ”¯ä¸Š Indexï¼šæš‚å­˜åŒºå¿«ç…§ Working Treeï¼šå·¥ä½œåŒºæ–‡ä»¶ å›¾ç¤ºï¼š\nHEAD -\u0026gt; Index -\u0026gt; Working Tree\n4. Git resetã€checkoutã€revert åŒºåˆ«ï¼Ÿ å‘½ä»¤ ä½œç”¨ æ˜¯å¦ä¿®æ”¹å†å² æ˜¯å¦å±é™© åœºæ™¯ reset å›æ»šåˆ°æ—§ç‰ˆæœ¬ æ˜¯ å±é™© ä½ æƒ³é‡å†™å†å² revert ç”Ÿæˆä¸€ä¸ªæ–°æäº¤ç”¨äºâ€œæ’¤é”€â€æŸæ¬¡æäº¤ å¦ å®‰å…¨ å·² push çš„ä»£ç  checkout åˆ‡æ¢åˆ†æ”¯/æ¢å¤æ–‡ä»¶ å¦ å®‰å…¨ æŸ¥çœ‹æ—§ä»£ç  5. git fetch å’Œ git pull çš„åŒºåˆ«ï¼Ÿ fetchï¼šåªæ‹‰å–ï¼Œä¸åˆå¹¶ï¼ˆå®‰å…¨ï¼‰ pull = fetch + merge ä¹Ÿå¯ pull \u0026ndash;rebase å»ºè®®ï¼š\næ°¸è¿œä¸è¦ç›´æ¥ç”¨ git pullï¼Œç”¨ï¼š\ngit pull --rebase äºŒã€åˆ†æ”¯ / åˆå¹¶ / Rebase 6. merge å’Œ rebase çš„åŒºåˆ«ï¼Ÿ merge\nä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ merge commit ä¿ç•™åˆ†æ”¯å†å² å†å²å˜å¤æ‚ rebase\næŠŠä½ çš„ commitâ€œç§»åŠ¨â€åˆ°æœ€æ–°åˆ†æ”¯ä¸Š å†å²æ›´å¹²å‡€ ä¼šé‡å†™ commitï¼ˆå±é™©ï¼‰ åŸåˆ™ï¼š\nå·² push çš„ä¿æŒ merge æœª push çš„å¯ä»¥ rebase 7. ä»€ä¹ˆæ˜¯ fast-forward mergeï¼Ÿ å½“ç›®æ ‡åˆ†æ”¯æ²¡æœ‰é¢å¤– commit æ—¶ï¼š\nmaster: A -\u0026gt; B feature: A -\u0026gt; B -\u0026gt; C åˆå¹¶åªéœ€è¦ç§»åŠ¨æŒ‡é’ˆ\nä¸ä¼šç”Ÿæˆ merge commitã€‚\n8. ä»€ä¹ˆæ˜¯å†²çªï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ å†²çªå‘ç”Ÿäºä¸¤äººåŒæ—¶ä¿®æ”¹åŒä¸€ä»£ç åŒºåŸŸã€‚è§£å†³æ–¹å¼ï¼š\nç¼–è¾‘å†²çªæ–‡ä»¶ åˆ é™¤æ ‡è®°è¡Œï¼ˆ\u0026laquo;\u0026laquo;\u0026laquo;\u0026lt;, =======, \u0026raquo;\u0026raquo;\u0026raquo;\u0026gt;ï¼‰ git add git commit 9. å¦‚ä½•åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼Ÿ git branch -d feature/a å¼ºåˆ¶åˆ é™¤ï¼ˆæœªåˆå¹¶ï¼‰ï¼š\ngit branch -D feature/a 10. å¦‚ä½•åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼Ÿ git push origin --delete feature/a ä¸‰ã€é«˜çº§ 11. ä»€ä¹ˆæ˜¯ Git å¯¹è±¡ï¼Ÿcommit å†…éƒ¨æ˜¯ä»€ä¹ˆï¼Ÿ Git æœ‰ 4 ç±»å¯¹è±¡ï¼š\nblobï¼šæ–‡ä»¶å†…å®¹ treeï¼šç›®å½• commitï¼šåŒ…å« treeã€ä½œè€…ã€æ—¶é—´ã€çˆ¶ commit tagï¼šæŒ‡å‘ commit commit æ˜¯æŒ‡å‘ tree çš„æŒ‡é’ˆã€‚\n12. Git å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªæ–‡ä»¶å†…å®¹æ˜¯å¦ç›¸åŒï¼Ÿ Git ä¸çœ‹ä¿®æ”¹æ—¶é—´ Git çœ‹å†…å®¹ SHA-1 å“ˆå¸Œ å†…å®¹ä¸€è‡´ -\u0026gt; å“ˆå¸Œä¸€è‡´ -\u0026gt; æ–‡ä»¶è§†ä¸ºç›¸åŒå¯¹è±¡ -\u0026gt; ä¸é‡å¤å­˜å‚¨\n13. Git stash ç”¨æ³•ï¼Ÿ ä¿å­˜å½“å‰æœªæäº¤çš„ä¿®æ”¹ï¼š\ngit stash æ¢å¤ï¼š\ngit stash pop æŸ¥çœ‹ï¼š\ngit stash list 14. å¦‚ä½•æŸ¥çœ‹æŸä¸ªæ–‡ä»¶çš„ä¿®æ”¹å†å²ï¼Ÿ git log -- filename 15. å¦‚ä½•æŸ¥çœ‹æŸä¸€è¡Œæ˜¯è°æ”¹çš„ï¼Ÿ git blame filename 16. å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ªåˆ†æ”¯ï¼Ÿ git diff branch1..branch2 17. å¦‚ä½•åª clone æŸä¸ªåˆ†æ”¯ï¼Ÿ git clone -b develop --single-branch URL 18. Git shallow cloneï¼ˆæµ…å…‹éš†ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ git clone --depth 1 URL åªå…‹éš†æœ€æ–° commitã€‚\nç”¨é€”ï¼šCI èŠ‚çœæ—¶é—´ã€‚\nå››ã€CI/CDã€çœŸå®ç¯å¢ƒ 19. GitLab CI æ‰§è¡Œ merge æŠ¥é”™ MERGE_HEAD missingï¼Ÿ è¯´æ˜ï¼š\nå½“å‰ç›®å½•æ²¡æœ‰ git merge éœ€è¦ git fetch å’Œ git merge çš„æ­£ç¡®é¡ºåº ä¿®å¤ï¼š\ngit fetch origin target-branch git merge origin/target-branch 20. Git å‡­è¯ç¼“å­˜æœ‰å“ªäº›æ–¹å¼ï¼Ÿ ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š\nå‘½ä»¤è¡Œ -c è®¾ç½® ç¯å¢ƒå˜é‡ GIT_* credential.helper=storeï¼ˆæ–‡ä»¶ï¼‰ ç³»ç»Ÿçº§ ~/.git-credentials 21. å¦‚ä½•è®© git push ä½¿ç”¨æŒ‡å®š credentials æ–‡ä»¶ï¼Ÿ git -c credential.helper=\u0026#34;store --file=/tmp/cred\u0026#34; push å¹¶ä¸”åˆ é™¤é»˜è®¤è¯»å–ï¼š\ngit -c credential.useHttpPath=true \\ -c credential.helper=\u0026#34;store --file=/tmp/cred\u0026#34; \\ push 22. Git å¦‚ä½•å¼ºåˆ¶ä¸è¯»å– ~/.git-credentialsï¼Ÿ git -c credential.helper= push æˆ–ï¼š\ngit -c credential.helper=\u0026#34;store --file=/tmp/cred\u0026#34; \\ -c credential.helper= \\ push äº”ã€åœºæ™¯ 23. å¦‚æœä½ è¯¯åˆ äº†ä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚ä½•æ‰¾å›ï¼Ÿ ä½¿ç”¨ reflogï¼š\ngit reflog git checkout \u0026lt;commit\u0026gt; git branch recovery 24. å¦‚ä½•å›æ»šä¸€ä¸ªå·²ç» push çš„ commitï¼Ÿ ä½¿ç”¨ revertï¼š\ngit revert \u0026lt;commit\u0026gt; ä¸è¦ç”¨ resetï¼\n25. å¦‚ä½•æŸ¥çœ‹æŸä¸ª Tag æ˜¯åŸºäºå“ªä¸ª commitï¼Ÿ git show tagname 26. ä¸€ä¸ªæ–‡ä»¶è¢«åˆ äº†ï¼Œå¦‚ä½•æ‰¾å›ï¼Ÿ git checkout HEAD -- path/file.txt 27. CI ä¸­ git pull æ€»æ˜¯è¦è¾“å…¥å¯†ç æ€ä¹ˆåŠï¼Ÿ ä½¿ç”¨ï¼š\ngit -c credential.helper= -c credential.helper=\u0026#34;store --file=/cred\u0026#34; pull å…­ã€å®æˆ˜å‘½ä»¤ å¸¸ç”¨æŸ¥çœ‹å‘½ä»¤\ngit status git log --oneline --graph --decorate git branch -a git remote -v å¸¸ç”¨åˆå¹¶å‘½ä»¤\ngit merge xxx git rebase xxx å¸¸ç”¨æ’¤é”€å‘½ä»¤\ngit reset --hard git revert git checkout -- file ","description":" ä¸€ã€Git åŸºç¡€ 1. Git å’Œ SVN çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ å¯¹æ¯”ç»´åº¦ Git SVN ç‰ˆæœ¬åº“æ¨¡å‹ åˆ†å¸ƒå¼ï¼Œæ¯äººéƒ½æœ‰å®Œæ•´ä»“åº“ é›†ä¸­å¼ï¼Œä¾èµ–ä¸­å¤®æœåŠ¡å™¨ åˆ†æ”¯ è½»é‡ï¼Œå‡ ä¹å…è´¹ å¤åˆ¶ç›®å½•ï¼Œé‡ æäº¤é€Ÿåº¦ å¿«ï¼Œæœ¬åœ°æäº¤ æ…¢ï¼Œéœ€è¦ç½‘ç»œ ç¦»çº¿å·¥ä½œ å®Œå…¨æ”¯æŒ ä¸èƒ½ å­˜å‚¨ç»“æ„ å†…å®¹å¯»å€ï¼ˆå¯¹è±¡ï¼‰ æ–‡ä»¶å·®å¼‚ åˆå¹¶å†²çªå¤„ç† å¼ºå¤§ ä¸€èˆ¬ æ€»ç»“ï¼š\nGit æ˜¯åˆ†å¸ƒå¼çš„ã€ä»¥å†…å®¹ä¸ºæ ¸å¿ƒã€åˆ†æ”¯æå¿«ã€åˆå¹¶å¼ºçš„ç°ä»£å·¥å…·ã€‚\n"},{"id":11,"href":"/operations/gitlab/faq/","title":"GitLab FAQ","parent":"GitLab","content":"å†…å®¹ï¼šåŸºç¡€ã€é«˜çº§ã€æ¶æ„ã€Runnerã€CI/CDã€è¿ç»´ã€å®‰å…¨åˆè§„ç­‰\nä¸€ã€GitLab åŸºç¡€æ¦‚å¿µ 1. GitLab æ˜¯ä»€ä¹ˆï¼Ÿä¸ GitHub çš„åŒºåˆ«ï¼Ÿ GitLab æ˜¯ä¸€ä¸ª åŸºäº Git çš„ä»£ç æ‰˜ç®¡ + DevOps å¹³å°ï¼Œé›†æˆ ä»£ç ç®¡ç†ã€CI/CDã€Issueã€WIKIã€è‡ªåŠ¨åŒ–ã€å®‰å…¨æ‰«æã€éƒ¨ç½² ç­‰åŠŸèƒ½ã€‚\nä¸ GitHub åŒºåˆ«ï¼š\né¡¹ç›® GitLab GitHub éƒ¨ç½²æ–¹å¼ æ”¯æŒè‡ªå»ºï¼ˆå¼€æºç‰ˆï¼‰ ä¸»è¦ SaaS CI å†…ç½® GitLab CI éœ€è¦ GitHub Actions æƒé™ \u0026amp; é¡¹ç›®ç®¡ç† æ›´ä¼ä¸šåŒ– æ›´å¼€å‘è€…ç¤¾åŒºåŒ– DevOps é›†æˆ One-Stop æ–¹æ¡ˆ éœ€è¦æ•´åˆå…¶ä»–å·¥å…· 2. GitLab CE å’Œ EE çš„åŒºåˆ«ï¼Ÿ CEï¼ˆCommunity Editionï¼‰ï¼šå¼€æºã€å…è´¹ï¼Œæ»¡è¶³ä¸­å°å›¢é˜Ÿ\nEEï¼ˆEnterprise Editionï¼‰ï¼šé—­æºï¼Œæä¾›é«˜çº§åŠŸèƒ½ï¼Œå¦‚ï¼š\né«˜çº§æƒé™ä¸å®¡è®¡æ—¥å¿— åˆè§„æ²»ç† å®‰å…¨æ‰«æã€SASTã€DAST é›†ç¾¤æ¶æ„ã€Geo å¤åˆ¶ 3. GitLab çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ Gitalyï¼šGit å­˜å‚¨è¯»å†™æœåŠ¡ PostgreSQLï¼šæ•°æ®åº“ Redisï¼šç¼“å­˜ä¸é˜Ÿåˆ— Sidekiqï¼šåå°ä»»åŠ¡ Pumaï¼šHTTP è¯·æ±‚å¤„ç† Nginxï¼šåå‘ä»£ç† GitLab Shellï¼šå¤„ç† SSH Prometheus + Grafanaï¼šç›‘æ§ Runnerï¼šæ‰§è¡Œ CI/CD äºŒã€GitLab æƒé™ä¸é¡¹ç›®ç®¡ç† 4. GitLab æƒé™ç­‰çº§æœ‰å“ªäº›ï¼Ÿ Guest Reporter Developer Maintainer Ownerï¼ˆGroupï¼‰ 5. Protected Branch æ˜¯ä»€ä¹ˆï¼Ÿ ç”¨äºä¿æŠ¤é‡è¦åˆ†æ”¯ï¼ˆå¦‚ masterã€mainã€releaseï¼‰\né™åˆ¶ï¼š\nè°å¯ä»¥ pushï¼Ÿ è°å¯ä»¥åˆå¹¶ï¼Ÿ è°å¯ä»¥åš force-pushï¼ˆé€šå¸¸ç¦æ­¢ï¼‰ 6. Merge Request åˆå¹¶ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ Merge commit Squash merge Rebase and merge ä¸‰ã€GitLab CI/CD 7. ä»€ä¹ˆæ˜¯ GitLab CIï¼Ÿæ ¸å¿ƒæ¦‚å¿µï¼Ÿ CI/CD ç”± .gitlab-ci.yml é©±åŠ¨\næ ¸å¿ƒæ¦‚å¿µï¼š\nPipelineï¼šæ•´ä¸ªæµæ°´çº¿ Stageï¼šé˜¶æ®µ Jobï¼šä»»åŠ¡ Runnerï¼šæ‰§è¡Œå™¨ Artifactsï¼šäº§ç‰© Cacheï¼šç¼“å­˜ Variablesï¼šå˜é‡ Environmentï¼šç¯å¢ƒï¼ˆå¦‚ dev/test/prodï¼‰ 8. Runner æœ‰å‡ ç§ç±»å‹ï¼Ÿ Runner ç±»å‹ ç‰¹ç‚¹ shared runner æ•´ä¸ª GitLab å…±ç”¨ group runner æŸä¸ª group ä½¿ç”¨ project runner æŸä¸ªé¡¹ç›®ä½¿ç”¨ specific runner å• Runner ç»‘å®šé¡¹ç›® autoscaling runner è‡ªåŠ¨åˆ›å»º VM / K8S Pod 9. Runner Executor æ‰§è¡Œå™¨æœ‰å“ªäº›ï¼Ÿ Executor æè¿° shell åœ¨å®¿ä¸»æœºæ‰§è¡Œ docker æœ€å¸¸ç”¨ï¼Œéš”ç¦»å¥½ docker+machine è‡ªåŠ¨æ‰©å®¹ kubernetes ä¼ä¸šçº§å¸¸ç”¨ ssh è¿œç¨‹æ‰§è¡Œ virtualbox å·²ä¸å¸¸ç”¨ 10. .gitlab-ci.yml çš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ æœ€æ ‡å‡†ç®€ç­”ï¼š\nstages: - build - test - deploy variables: {} build_job: stage: build script: - make build å››ã€Artifactsã€Cacheã€Dependencies 11. Artifacts ä¸ Cache çš„åŒºåˆ«ï¼Ÿ é¡¹ç›® Artifacts Cache ç›®çš„ ä¼ é€’æ–‡ä»¶åˆ°ä¸‹ä¸€ Job åŠ é€Ÿ/ç¼“å­˜ä¾èµ– ç”Ÿå‘½å‘¨æœŸ Pipeline ç»“æŸåå¯ä¸‹è½½ åœ¨ Runner å­˜æ´»æœŸé—´ ä½¿ç”¨åœºæ™¯ build -\u0026gt; test -\u0026gt; deploy node_modulesã€.m2ã€pip cache 12. å¦‚ä½•åœ¨ job ä¹‹é—´ä¼ æ–‡ä»¶ï¼Ÿ ä½¿ç”¨ artifactsï¼š\nbuild: stage: build artifacts: paths: - dist/ äº”ã€GitLab è¿›é˜¶ï¼šDeploy ä¸ Environment 13. GitLab CI å¦‚ä½•åšéƒ¨ç½²ï¼Ÿ é€šè¿‡ï¼š\nenvironment deploy é˜¶æ®µ k8s é›†æˆ æˆ–è°ƒç”¨å¤–éƒ¨è„šæœ¬ 14. GitLab Auto DevOps æ˜¯ä»€ä¹ˆï¼Ÿ GitLab æä¾›çš„è‡ªåŠ¨åŒ– CI/CD æ¨¡æ¿ï¼ˆè‡ªåŠ¨ build -\u0026gt; test -\u0026gt; deploy -\u0026gt; monitorï¼‰\nä¾èµ–ï¼š\nK8S é›†ç¾¤ Helm Docker Registry å…­ã€GitLab å®¹å™¨ Registry\n15. GitLab å¦‚ä½•ä½œä¸º Docker Registryï¼Ÿ æ¨é€æµç¨‹ï¼š\ndocker login registry.gitlab.com docker build -t registry.gitlab.com/group/project/app:tag . docker push registry.gitlab.com/group/project/app:tag è‡ªå»ºç‰ˆéœ€å¼€å¯ï¼š\nregistry[\u0026#39;enable\u0026#39;] = true 16. å¦‚ä½•åœ¨ CI ä¸­ç™»å½• Registryï¼Ÿ ä½¿ç”¨ $CI_REGISTRY_USERã€$CI_REGISTRY_PASSWORD è‡ªåŠ¨ç™»å½•ã€‚\nä¸ƒã€GitLab å®‰å…¨ä¸å®¡è®¡ 17. GitLab å¦‚ä½•å®ç° Secret ç®¡ç†ï¼Ÿ CI/CD Variables Maskedï¼ˆéšè—ï¼‰ Protectedï¼ˆä»…å¯åœ¨ protected åˆ†æ”¯ä½¿ç”¨ï¼‰ 18. GitLab å¦‚ä½•é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Ÿ å¼ºåˆ¶ MR Review Protected variables é˜²æ­¢ force push GitLab secret detectionï¼ˆEEï¼‰ å…«ã€GitLab è¿ç»´ 19. GitLab çš„å¤‡ä»½æ–¹å¼ï¼Ÿ gitlab-backup create å¤‡ä»½ï¼šæ•°æ® + é…ç½® å¯ä»¥ rsync Git å­˜å‚¨ æ”¯æŒå¯¹è±¡å­˜å‚¨ï¼ˆMinIO/S3ï¼‰ 20. GitLab å¦‚ä½•å‡çº§ï¼Ÿéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ æ³¨æ„ï¼š\nå‡çº§è·¯å¾„ä¸èƒ½è·¨å¤ªå¤§ç‰ˆæœ¬ æŸ¥çœ‹ release notes å¤‡ä»½ Zero downtime ä¾èµ– EE 21. GitLab æ€§èƒ½ä¼˜åŒ–æ–¹å¼ï¼Ÿ Gitaly ä¸ Git å­˜å‚¨ç‹¬ç«‹ Sidekiq åˆ†ç¦» Redis é›†ç¾¤ PostgreSQL å¤–ç½® + HA ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆMinIO / S3ï¼‰ ä¹ã€GitLab Runner 22. Runner ä¸ºä»€ä¹ˆ Pendingï¼Ÿ å¸¸è§åŸå› ï¼š\nRunner æ²¡ tagï¼Œjob éœ€è¦ tag Runner offline Runner æ²¡æœ‰åŒ¹é… executor å¹¶å‘æ•°å¤ªå° job é™åˆ¶ only/except è§„åˆ™ 23. å¦‚ä½•å‡å°‘ Pipeline æ‰§è¡Œæ—¶é—´ï¼Ÿ å¹¶è¡Œ job ä½¿ç”¨ cache ä½¿ç”¨ artifacts ä¼ é€’äº§ç‰© åªæ„å»º changed è·¯å¾„ï¼ˆrulesï¼‰ ä½¿ç”¨ Docker ç¼“å­˜å±‚ åã€ç»¼åˆåœºæ™¯ 24. å¦‚ä½•å®ç°å¤šç¯å¢ƒï¼ˆdev/test/prodï¼‰éƒ¨ç½²ï¼Ÿ é€šè¿‡ environmentï¼š\ndeploy_dev: stage: deploy environment: name: dev script: ./scripts/deploy-dev.sh 25. å¦‚ä½•åšåŸºäº Tag çš„è‡ªåŠ¨å‘å¸ƒï¼Ÿ rules: - if: \u0026#39;$CI_COMMIT_TAG\u0026#39; when: always 26. å¦‚ä½•æŒ‰å¾®æœåŠ¡æ‹†åˆ† CIï¼Ÿ Monorepo ä½¿ç”¨ rules: changes æ¯ä¸ªç›®å½•å¯¹åº”ä¸€ç»„ job å‡å°‘ä¸å¿…è¦æ„å»º 27. å¦‚ä½•æ„å»ºã€æ¨é€ã€éƒ¨ç½² Docker é•œåƒï¼Ÿ æ ‡å‡†ç­”æ¡ˆï¼š\nbuild: stage: build script: - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA . - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA 28. CI/CD å¦‚ä½•å®ç°è“ç»¿éƒ¨ç½²ï¼Ÿ éœ€è¦ K8S ä¸¤å¥— service / deployment GitLab CI è°ƒ Helm åˆ‡æ¢ç‰ˆæœ¬ åä¸€ã€è¿›é˜¶ 29. GitLab CI ä¸ Jenkins çš„å¯¹æ¯”ï¼Ÿ æ ¸å¿ƒåŒºåˆ«æ€»ç»“ï¼š\nå¯¹æ¯”é¡¹ GitLab CI Jenkins é…ç½®æ–¹å¼ YAMLï¼ˆä»£ç å³æµç¨‹ï¼‰ Web UI / Jenkinsfile ä¾èµ– GitLab å†…ç½® ç‹¬ç«‹å¹³å° æ’ä»¶ å°‘ï¼Œä½†ç¨³å®š æ’ä»¶ç”Ÿæ€å¤§ä½†æ˜“å‡ºé—®é¢˜ ä½¿ç”¨åœºæ™¯ ä¸­å°å›¢é˜Ÿã€K8S åœºæ™¯å¼º ä¼ä¸šçº§ã€å¤§è§„æ¨¡æ’ä»¶æ‰©å±• æ¶æ„ æ›´è½»é‡ æ›´çµæ´»ã€ä½†è¦ç»´æŠ¤ 30. GitLab + Kubernetes CI/CD çš„ä¼˜åŠ¿ï¼Ÿ åŸç”Ÿæ”¯æŒ Auto DevOps Review Apps Canary / Blue-Green å®¹å™¨åŒ–æ„å»ºæ›´å¿«æ›´ç¨³å®š ","description":"å†…å®¹ï¼šåŸºç¡€ã€é«˜çº§ã€æ¶æ„ã€Runnerã€CI/CDã€è¿ç»´ã€å®‰å…¨åˆè§„ç­‰\nä¸€ã€GitLab åŸºç¡€æ¦‚å¿µ 1. GitLab æ˜¯ä»€ä¹ˆï¼Ÿä¸ GitHub çš„åŒºåˆ«ï¼Ÿ GitLab æ˜¯ä¸€ä¸ª åŸºäº Git çš„ä»£ç æ‰˜ç®¡ + DevOps å¹³å°ï¼Œé›†æˆ ä»£ç ç®¡ç†ã€CI/CDã€Issueã€WIKIã€è‡ªåŠ¨åŒ–ã€å®‰å…¨æ‰«æã€éƒ¨ç½² ç­‰åŠŸèƒ½ã€‚\nä¸ GitHub åŒºåˆ«ï¼š\né¡¹ç›® GitLab GitHub éƒ¨ç½²æ–¹å¼ æ”¯æŒè‡ªå»ºï¼ˆå¼€æºç‰ˆï¼‰ ä¸»è¦ SaaS CI å†…ç½® GitLab CI éœ€è¦ GitHub Actions æƒé™ \u0026amp; é¡¹ç›®ç®¡ç† æ›´ä¼ä¸šåŒ– æ›´å¼€å‘è€…ç¤¾åŒºåŒ– DevOps é›†æˆ One-Stop æ–¹æ¡ˆ éœ€è¦æ•´åˆå…¶ä»–å·¥å…· 2. GitLab CE å’Œ EE çš„åŒºåˆ«ï¼Ÿ CEï¼ˆCommunity Editionï¼‰ï¼šå¼€æºã€å…è´¹ï¼Œæ»¡è¶³ä¸­å°å›¢é˜Ÿ\n"},{"id":12,"href":"/management/operations/itom/","title":"IT è¿ç»´ç®¡ç†","parent":"Operations","content":"ç›®æ ‡ï¼šä½œä¸ºã€ŠIT è¿ç»´ç®¡ç†å®Œæ•´èƒ½åŠ›æ¨¡å‹ã€‹æˆ–ã€Šè¿ç»´ä½“ç³»å»ºè®¾æ–¹æ¡ˆã€‹ä½¿ç”¨ã€‚\nå®šä½è¯´æ˜ IT è¿ç»´ç®¡ç†ï¼ˆIT Operations Management, ITOMï¼‰ æ˜¯é€šè¿‡æŠ€æœ¯æ‰‹æ®µä¸ç®¡ç†æµç¨‹ï¼Œå¯¹ä¼ä¸šçš„ç¡¬ä»¶ã€è½¯ä»¶ã€ç½‘ç»œå’Œæ•°æ®ç­‰ IT èµ„æºè¿›è¡Œ è§„åˆ’ã€å»ºè®¾ã€è¿è¡Œã€å˜æ›´ã€ä¿éšœä¸æŒç»­ä¼˜åŒ–ï¼Œå…¨é¢ç®¡ç†å’Œç»´æŠ¤ï¼Œ ä»¥ç¡®ä¿ IT ç³»ç»Ÿ ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œï¼Œæ”¯æ’‘ä¸šåŠ¡è¿ç»­æ€§å¹¶æŒç»­åˆ›é€ ä¸šåŠ¡ä»·å€¼ã€‚\nå…¶æ ¸å¿ƒç›®æ ‡æ˜¯ä¿éšœä¸šåŠ¡è¿ç»­æ€§ï¼Œæå‡æœåŠ¡è´¨é‡ï¼Œå¹¶é™ä½è¿ç»´æˆæœ¬ã€‚\nIT è¿ç»´ç®¡ç† = å¯¹ IT ç³»ç»Ÿ â€œä»è§„åˆ’ -\u0026gt; å»ºè®¾ -\u0026gt; è¿è¡Œ -\u0026gt; å˜æ›´ -\u0026gt; é£é™© -\u0026gt; ä¼˜åŒ– -\u0026gt; é€€å½¹â€ çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†\næ ¸å¿ƒèŒè´£ä¸å†…å®¹ ä¸€ã€è¿ç»´ç³»ç»Ÿæ¶æ„è§„åˆ’ï¼ˆé¡¶å±‚è®¾è®¡ï¼‰ ç›®çš„ï¼šé€šè¿‡å‰ç½®è§„åˆ’è¿ç»´ä½“ç³»ä¸ç³»ç»Ÿæ¶æ„ï¼Œä»æºå¤´ä¿éšœç³»ç»Ÿçš„ç¨³å®šæ€§ã€å¯æ‰©å±•æ€§ä¸å¯è¿ç»´æ€§ã€‚\næ¶æ„è§„åˆ’ç›®æ ‡\nç¨³å®šæ€§ï¼šé«˜å¯ç”¨ã€å®¹ç¾ å¯æ‰©å±•æ€§ï¼šæ°´å¹³ / å‚ç›´æ‰©å±• å¯è¿ç»´æ€§ï¼šå¯ç›‘æ§ã€å¯å›æ»šã€å¯è‡ªåŠ¨åŒ– å®‰å…¨æ€§ï¼šæƒé™ã€éš”ç¦»ã€å®¡è®¡ æˆæœ¬å¯æ§ï¼šèµ„æºåˆ©ç”¨ç‡ã€æˆæœ¬ä¼˜åŒ– æ¶æ„è§„åˆ’å†…å®¹\nåŸºç¡€æ¶æ„é€‰å‹ ç‰©ç†æœº / è™šæ‹Ÿæœº / äº‘ å•æœº / é›†ç¾¤ ç³»ç»Ÿæ¶æ„æ¨¡å¼ å•ä½“ / å¾®æœåŠ¡ æœ‰çŠ¶æ€ / æ— çŠ¶æ€ éƒ¨ç½²æ¶æ„è®¾è®¡ å•æœºéƒ¨ç½² ä¸»ä» / å¤šå‰¯æœ¬ å¤šæœºæˆ¿ / å¤šåœ°åŸŸ é«˜å¯ç”¨ä¸å®¹ç¾ HAï¼šä¸»å¤‡ / å¤šæ´» DRï¼šå†·å¤‡ / çƒ­å¤‡ è¿ç»´å¹³å°ä¸å·¥å…·é“¾è§„åˆ’ ç›‘æ§ã€æ—¥å¿—ã€å‘å¸ƒã€è‡ªåŠ¨åŒ–å¹³å° ğŸ‘‰ ç›®æ ‡ï¼šä»æºå¤´æå‡ç³»ç»Ÿå¯è¿ç»´æ€§ä¸é•¿æœŸç¨³å®šæ€§ã€‚\näºŒã€è¿è¡Œç¯å¢ƒç»´æŠ¤ï¼ˆç¯å¢ƒç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰ ç›®çš„ï¼šç¡®ä¿å„ç±»è¿è¡Œç¯å¢ƒåœ¨æ­å»ºã€å‡çº§å’Œæ‰©å®¹è¿‡ç¨‹ä¸­ä¿æŒä¸€è‡´æ€§ã€ç¨³å®šæ€§å’Œå¯æ§æ€§ã€‚\nç¯å¢ƒç±»å‹ç®¡ç†\nå¼€å‘ç¯å¢ƒï¼ˆDEVï¼‰ æµ‹è¯•ç¯å¢ƒï¼ˆTESTï¼‰ é¢„å‘å¸ƒç¯å¢ƒï¼ˆSTAGINGï¼‰ ç”Ÿäº§ç¯å¢ƒï¼ˆPRODï¼‰ ç¯å¢ƒæ­å»º\næ“ä½œç³»ç»Ÿåˆå§‹åŒ– åŸºç¡€è¿è¡Œç¯å¢ƒï¼ˆJDK / Python / Docker ç­‰ï¼‰ ä¸­é—´ä»¶éƒ¨ç½²ï¼ˆMySQL / Redis / MQï¼‰ ç½‘ç»œã€é˜²ç«å¢™ã€å®‰å…¨ç­–ç•¥é…ç½® ç¯å¢ƒå‡çº§\nOS å‡çº§ ä¸­é—´ä»¶ç‰ˆæœ¬å‡çº§ Runtime å‡çº§ï¼ˆJDK / Python / Nodeï¼‰ ä¾èµ–ç»„ä»¶å‡çº§ ç¯å¢ƒæ‰©å®¹\nè®¡ç®—èµ„æºæ‰©å®¹ï¼ˆCPU / å†…å­˜ï¼‰ å­˜å‚¨æ‰©å®¹ å®ä¾‹ä¸é›†ç¾¤èŠ‚ç‚¹æ¨ªå‘æ‰©å±• ğŸ‘‰ ç›®æ ‡ï¼šç¯å¢ƒç¨³å®šã€ç‰ˆæœ¬å¯æ§ã€å®¹é‡å¯é¢„æµ‹ã€‚\nä¸‰ã€è®¾å¤‡ä¸åŸºç¡€è®¾æ–½ç®¡ç† ç›®çš„ï¼šå¯¹åº•å±‚ç¡¬ä»¶ä¸åŸºç¡€è®¾æ–½è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œä¿éšœ IT èµ„æºé•¿æœŸç¨³å®šè¿è¡Œå¹¶é™ä½ç¡¬ä»¶æ•…éšœé£é™©ã€‚\næœåŠ¡å™¨ã€ç½‘ç»œã€å­˜å‚¨è®¾å¤‡ç»Ÿä¸€ç®¡ç† IT èµ„äº§ç™»è®°ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç† ç¡¬ä»¶å¥åº·ç›‘æ§ æ•…éšœè®¾å¤‡æ›´æ¢ä¸ç»´æŠ¤ å››ã€é¡¹ç›®ä¸Šçº¿ä¸å‘å¸ƒç®¡ç† ç›®çš„ï¼šé€šè¿‡è§„èŒƒåŒ–çš„å‘å¸ƒæµç¨‹å’Œç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿä¸Šçº¿è¿‡ç¨‹å®‰å…¨ã€å¯æ§ä¸”æ”¯æŒå¿«é€Ÿå›æ»šã€‚\né¡¹ç›®ä¸Šçº¿æµç¨‹\néœ€æ±‚ç¡®è®¤ -\u0026gt; ç¯å¢ƒå‡†å¤‡ -\u0026gt; æ„å»ºåˆ¶å“ -\u0026gt; éƒ¨ç½² -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; éªŒè¯ -\u0026gt; æ­£å¼ä¸Šçº¿ åˆ¶å“ï¼šJARåŒ…ã€Dockeré•œåƒã€äºŒè¿›åˆ¶æ–‡ä»¶ ç­‰ç­‰ å‘å¸ƒç­–ç•¥\næ»šåŠ¨å‘å¸ƒ è“ç»¿å‘å¸ƒ é‡‘ä¸é›€å‘å¸ƒ ç°åº¦å‘å¸ƒ å‘å¸ƒä¿éšœ\nå‘å¸ƒå‰æ£€æŸ¥æ¸…å• å‘å¸ƒçª—å£ç®¡ç† å›æ»šæ–¹æ¡ˆ å‘å¸ƒè®°å½•ä¸å®¡è®¡ ğŸ‘‰ ç›®æ ‡ï¼šä¸Šçº¿å®‰å…¨ã€å¯æ§ã€å¯å›æ»šã€‚\näº”ã€é¡¹ç›®å‡çº§ä¸å˜æ›´ç®¡ç† ç›®çš„ï¼šåœ¨ç³»ç»Ÿæ¼”è¿›è¿‡ç¨‹ä¸­é™ä½å‡çº§å’Œå˜æ›´å¸¦æ¥çš„é£é™©ï¼Œé¿å…å› å˜æ›´å¯¼è‡´ä¸šåŠ¡ä¸­æ–­æˆ–ç³»ç»Ÿä¸ç¨³å®šã€‚\né¡¹ç›®å‡çº§\nåº”ç”¨ç‰ˆæœ¬å‡çº§ é…ç½®å‡çº§ æ•°æ®åº“ç»“æ„å‡çº§ ä¸­é—´ä»¶å‡çº§ å˜æ›´ç®¡ç†ï¼ˆITILï¼‰\nå˜æ›´ç”³è¯· é£é™©è¯„ä¼° å®¡æ‰¹ æ‰§è¡Œ éªŒè¯ å˜æ›´å›æº¯ ğŸ‘‰ ç›®æ ‡ï¼šé™ä½å˜æ›´é£é™©ï¼Œé¿å…å‡çº§äº‹æ•…ã€‚\nå…­ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸è¿ç»´ï¼ˆæ ¸å¿ƒèƒ½åŠ›ï¼‰ ç›®çš„ï¼šä»¥è‡ªåŠ¨åŒ–æ‰‹æ®µå‡å°‘äººå·¥æ“ä½œï¼Œæé«˜è¿ç»´æ•ˆç‡ã€ä¸€è‡´æ€§å’Œç³»ç»Ÿäº¤ä»˜è´¨é‡ã€‚\nè‡ªåŠ¨åŒ–éƒ¨ç½²\nCI/CD æµæ°´çº¿ æ„å»º -\u0026gt; æµ‹è¯• -\u0026gt; å‘å¸ƒ åˆ¶å“åº“ç®¡ç† ä¸€é”®éƒ¨ç½² / å›æ»š è‡ªåŠ¨åŒ–è¿ç»´\nè‡ªåŠ¨æ‰©ç¼©å®¹ è‡ªåŠ¨é‡å¯ è‡ªåŠ¨å·¡æ£€ è‡ªåŠ¨ä¿®å¤ï¼ˆè‡ªæ„ˆï¼‰ å·¥å…·é“¾\nJenkins / GitLab CI Ansible / Terraform Kubernetes / Helm Argo CD / Fluxï¼ˆGitOpsï¼‰ ğŸ‘‰ ç›®æ ‡ï¼šå‡å°‘äººä¸ºæ“ä½œï¼Œæé«˜æ•ˆç‡ä¸ä¸€è‡´æ€§ã€‚\nä¸ƒã€æ—¥å¿—ç®¡ç†ä¸æ—¥å¿—æ”¶é›† ç›®çš„ï¼šé€šè¿‡é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†ï¼Œä¸ºæ•…éšœæ’æŸ¥ã€æ€§èƒ½åˆ†æå’Œå®‰å…¨å®¡è®¡æä¾›å¯é çš„æ•°æ®æ”¯æ’‘ã€‚\næ—¥å¿—ç±»å‹\nç³»ç»Ÿæ—¥å¿— åº”ç”¨æ—¥å¿— ä¸­é—´ä»¶æ—¥å¿— å®‰å…¨å®¡è®¡æ—¥å¿— æ—¥å¿—ç®¡ç†\næ—¥å¿—é›†ä¸­é‡‡é›†ï¼ˆFilebeat / Fluentd / Vectorï¼‰ æ—¥å¿—ç»Ÿä¸€å­˜å‚¨ æ—¥å¿—æ ¼å¼è§„èŒƒåŒ– æ—¥å¿—åˆ†æ\næ•…éšœå®šä½ è¡Œä¸ºå®¡è®¡ æ€§èƒ½åˆ†æ å®‰å…¨åˆ†æ å…«ã€ç³»ç»Ÿç›‘æ§ä¸å‘Šè­¦ç®¡ç† ç›®çš„ï¼šå®æ—¶æŒæ¡ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œå®ç°é—®é¢˜æå‰å‘ç°å’Œä¸»åŠ¨é¢„è­¦ï¼Œé™ä½æ•…éšœå½±å“èŒƒå›´ã€‚\nç›‘æ§å¯¹è±¡\nä¸»æœº å®¹å™¨ / Pod åº”ç”¨ æ•°æ®åº“ ç½‘ç»œ ä¸šåŠ¡æŒ‡æ ‡ å‘Šè­¦ä½“ç³»\né˜ˆå€¼å‘Šè­¦ è¶‹åŠ¿å‘Šè­¦ å¼‚å¸¸æ£€æµ‹ å‘Šè­¦åˆ†çº§ å‘Šè­¦æ²»ç†\nå‘Šè­¦æ”¶æ•› å‘Šè­¦æŠ‘åˆ¶ å‘Šè­¦å‡çº§ å‘Šè­¦é—­ç¯ ğŸ‘‰ ç›®æ ‡ï¼šé—®é¢˜å¯é¢„è­¦ï¼Œæ•…éšœå¯æå‰å‘ç°ã€‚\nä¹ã€æ•…éšœæ’æŸ¥ä¸é—®é¢˜ç®¡ç† ç›®çš„ï¼šå¿«é€Ÿå®šä½å’Œè§£å†³ç³»ç»Ÿæ•…éšœï¼Œå¹¶é€šè¿‡æ ¹å› åˆ†ææŒç»­é™ä½é—®é¢˜å¤å‘ç‡ã€‚\næ•…éšœæ’æŸ¥\nç¨‹åºçŠ¶æ€ èµ„æºçŠ¶æ€ï¼ˆCPU / å†…å­˜ / IO / ç½‘ç»œï¼‰ é›†ç¾¤çŠ¶æ€ æ—¥å¿—åˆ†æ å®¢æˆ·ç«¯å¼‚å¸¸ é—®é¢˜ç®¡ç†\näº‹ä»¶ï¼ˆIncidentï¼‰ é—®é¢˜ï¼ˆProblemï¼‰ æ ¹å› åˆ†æï¼ˆRCAï¼‰ é˜²æ­¢å¤å‘ ğŸ‘‰ ç›®æ ‡ï¼šç¼©çŸ­ MTTRï¼ˆå¹³å‡æ•…éšœä¿®å¤/æ¢å¤/å“åº”æ—¶é—´ï¼‰ï¼Œé¿å…é‡å¤äº‹æ•…ã€‚\nåã€æ€§èƒ½ç®¡ç†ä¸å®¹é‡ä¼˜åŒ– ç›®çš„ï¼šåœ¨ä¸šåŠ¡å¢é•¿è¿‡ç¨‹ä¸­ä¿éšœç³»ç»Ÿæ€§èƒ½ç¨³å®šï¼ŒåŒæ—¶æå‡èµ„æºåˆ©ç”¨ç‡å¹¶æ§åˆ¶è¿ç»´æˆæœ¬ã€‚\næ€§èƒ½ç®¡ç†\nç³»ç»Ÿ / åº”ç”¨ / æ•°æ®åº“æ€§èƒ½ç›‘æ§ æ¥å£å“åº”æ—¶é—´åˆ†æ æ€§èƒ½åŸºçº¿å»ºç«‹ æ­£å¸¸å€¼èŒƒå›´ å³°å€¼æ‰¿è½½èƒ½åŠ› å®¹é‡ç“¶é¢ˆç‚¹ æ€§èƒ½ä¼˜åŒ–\nå‚æ•°è°ƒä¼˜ æ¶æ„ä¼˜åŒ– SQL ä¼˜åŒ– ç¼“å­˜ç­–ç•¥ å®¹é‡ç®¡ç†\nå®¹é‡é¢„æµ‹ ç“¶é¢ˆåˆ†æ èµ„æºåˆ©ç”¨ç‡ä¼˜åŒ– æˆæœ¬æ§åˆ¶ åä¸€ã€æ•°æ®å­˜å‚¨ã€å¤‡ä»½ä¸æ¢å¤ ç›®çš„ï¼šä¿éšœæ•°æ®å®‰å…¨ä¸å®Œæ•´æ€§ï¼Œåœ¨æ•…éšœæˆ–ç¾éš¾å‘ç”Ÿæ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤ä¸šåŠ¡æ•°æ®ã€‚\nå¤‡ä»½ç­–ç•¥\nå…¨é‡å¤‡ä»½ å¢é‡å¤‡ä»½ å®šæ—¶å¤‡ä»½ æ¢å¤èƒ½åŠ›\nå•è¡¨æ¢å¤ å…¨åº“æ¢å¤ æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ æ¼”ç»ƒ\nå®šæœŸæ¢å¤æ¼”ç»ƒ æ¢å¤æ—¶é—´è¯„ä¼°ï¼ˆRTOï¼‰ æ•°æ®ä¸¢å¤±è¯„ä¼°ï¼ˆRPOï¼‰ ğŸ‘‰ ç›®æ ‡ï¼šä¿éšœæ•°æ®å®‰å…¨ä¸ä¸šåŠ¡è¿ç»­æ€§ã€‚\nåäºŒã€å®‰å…¨ç®¡ç†ä¸é£é™©æ§åˆ¶ ç›®çš„ï¼šé˜²èŒƒå®‰å…¨å¨èƒå’Œé£é™©äº‹ä»¶ï¼Œä¿æŠ¤ç³»ç»Ÿã€æ•°æ®å’Œä¸šåŠ¡å…å—å®‰å…¨æ”»å‡»ä¸åˆè§„é£é™©ã€‚\næƒé™ä¸è´¦å·ç®¡ç† æ¼æ´æ‰«æä¸ä¿®å¤ å®‰å…¨å®¡è®¡ å®‰å…¨äº‹ä»¶å“åº” åä¸‰ã€åº”æ€¥å“åº”ä¸åº”æ€¥æ¼”ç»ƒ ç›®çš„ï¼šåœ¨çªå‘äº‹ä»¶æˆ–æç«¯æƒ…å†µä¸‹ï¼Œç¡®ä¿å›¢é˜Ÿå…·å¤‡å¿«é€Ÿå“åº”å’Œæ¢å¤ä¸šåŠ¡çš„èƒ½åŠ›ã€‚\nåº”æ€¥é¢„æ¡ˆåˆ¶å®š å®šæœŸåº”æ€¥æ¼”ç»ƒ äº‹ä»¶å¤„ç†ä¸å¤ç›˜ æŒç»­æ”¹è¿›åº”æ€¥èƒ½åŠ› åº”æ€¥é¢„æ¡ˆ\nç³»ç»Ÿå®•æœº æ•°æ®ä¸¢å¤± ç½‘ç»œä¸­æ–­ å®‰å…¨äº‹ä»¶ åº”æ€¥æ¼”ç»ƒ\næ¼”ç»ƒæµç¨‹ æ¼”ç»ƒè®°å½• æ¼”ç»ƒå¤ç›˜ æ”¹è¿›æªæ–½ åå››ã€è¿ç»´æ–‡æ¡£ä¸è§„èŒƒä½“ç³» ç›®çš„ï¼šé€šè¿‡æ ‡å‡†åŒ–æ–‡æ¡£å’Œæµç¨‹ï¼Œé™ä½äººå‘˜ä¾èµ–ï¼Œæå‡å›¢é˜Ÿåä½œæ•ˆç‡å’Œè¿ç»´äº¤ä»˜ç¨³å®šæ€§ã€‚\næ–‡æ¡£ä½“ç³»\næ¶æ„æ–‡æ¡£ è¿ç»´æ‰‹å†Œ æ•…éšœæ‰‹å†Œ SOP è§„èŒƒä½“ç³»\nå‘å¸ƒè§„èŒƒ å˜æ›´è§„èŒƒ æƒé™è§„èŒƒ å®‰å…¨è§„èŒƒ åäº”ã€è¿ç»´ä»·å€¼è¯„ä¼°ä¸æŒç»­æ”¹è¿› ç›®çš„ï¼šä»¥æ•°æ®å’ŒæŒ‡æ ‡è¡¡é‡è¿ç»´æˆæ•ˆï¼ŒæŒç»­ä¼˜åŒ–è¿ç»´ä½“ç³»ï¼Œä½¿è¿ç»´å·¥ä½œä¸ä¸šåŠ¡ä»·å€¼ä¿æŒä¸€è‡´ã€‚\nSLA / SLO / SLI MTTR / MTBF è¿ç»´æˆæœ¬ è‡ªåŠ¨åŒ–ç‡ ä¸šåŠ¡æ»¡æ„åº¦ æ ¸å¿ƒç›®æ ‡ ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œ: ç¡®ä¿ITç³»ç»Ÿä¸é—´æ–­è¿è¡Œï¼Œæ”¯æ’‘ä¼ä¸šä¸šåŠ¡ã€‚ æå‡æœåŠ¡è´¨é‡: é€šè¿‡æ ‡å‡†åŒ–æµç¨‹å’Œå¿«é€Ÿå“åº”ï¼Œæé«˜ç”¨æˆ·æ»¡æ„åº¦ã€‚ é™ä½è¿ç»´æˆæœ¬: é€šè¿‡èµ„æºä¼˜åŒ–ã€è‡ªåŠ¨åŒ–å·¥å…·ç­‰æ‰‹æ®µï¼Œæé«˜æ•ˆç‡å¹¶èŠ‚çº¦å¼€æ”¯ã€‚ ç®¡ç†æ¨¡å¼ è‡ªä¸»è¿ç»´: ä¼ä¸šè‡ªè¡Œç®¡ç†éƒ¨åˆ†ITèµ„æºã€‚ å¤–åŒ…è¿ç»´: å°†éƒ¨åˆ†ITèµ„æºçš„è¿ç»´å·¥ä½œå§”æ‰˜ç»™ç¬¬ä¸‰æ–¹å…¬å¸ã€‚ æ··åˆæ¨¡å¼: ç»“åˆè‡ªä¸»è¿ç»´å’Œå¤–åŒ…è¿ç»´ï¼Œç”±ä¼ä¸šè‡ªè¡Œå†³å®šå†…å¤–éƒ¨åˆ†å·¥ã€‚ å…³é”®æŠ€æœ¯ä¸è¶‹åŠ¿ è‡ªåŠ¨åŒ–è¿ç»´: åˆ©ç”¨å·¥å…·å®ç°ä»»åŠ¡è‡ªåŠ¨åŒ–ï¼Œæé«˜æ•ˆç‡ï¼Œå‡å°‘äººå·¥æˆæœ¬ã€‚ å¯è§†åŒ–ä¸åˆ†æ: é€šè¿‡ç®¡ç†ç³»ç»Ÿé€è§†ITæ•°æ®ï¼Œæä¾›ç«¯åˆ°ç«¯çš„å®æ—¶åˆ†æèƒ½åŠ›ã€‚ äº‘åŸç”Ÿç®¡ç†: ç®¡ç†äº‘ç«¯å’Œæœ¬åœ°åŒ–çš„ITèµ„æºï¼ŒåŒ…æ‹¬äº‘æœåŠ¡ã€‚ è¿œç¨‹è¿ç»´: åˆ©ç”¨è¿œç¨‹æŠ€æœ¯ä¼˜åŒ–ç®¡ç†æµç¨‹ã€‚ æ€»ç»“ ç°ä»£ IT è¿ç»´ç®¡ç†ä¸æ˜¯ â€œä¿®æœåŠ¡å™¨â€ï¼Œè€Œæ˜¯é€šè¿‡å·¥ç¨‹åŒ–ã€ä½“ç³»åŒ–ã€è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼Œä¿éšœä¸šåŠ¡ä¸šåŠ¡ç³»ç»Ÿåœ¨ä»»ä½•å˜åŒ–ä¸é£é™©ä¸‹éƒ½ â€œå¯æ§ã€å¯æ¢å¤ã€å¯æŒç»­â€ã€‚\nIT è¿ç»´ç®¡ç†çš„æ ¸å¿ƒç›®æ ‡ï¼Œæ˜¯é€šè¿‡ä½“ç³»åŒ–ä¸å·¥ç¨‹åŒ–æ‰‹æ®µï¼Œå°†ä¸ç¡®å®šçš„ç³»ç»Ÿè¿è¡Œé£é™©ï¼Œè½¬åŒ–ä¸ºå¯æ§ã€å¯è¡¡é‡ã€å¯æŒç»­æ”¹è¿›çš„è¿ç»´èƒ½åŠ›ã€‚\næ‰©å±• MTTR MTTRï¼ˆMean Time To Repair/Recover/Restore/Respondï¼Œå¹³å‡æ•…éšœä¿®å¤/æ¢å¤/å“åº”æ—¶é—´ï¼‰æ˜¯è¡¡é‡ç³»ç»Ÿã€è®¾å¤‡æˆ–æœåŠ¡ä»æ•…éšœçŠ¶æ€æ¢å¤åˆ°æ­£å¸¸å·¥ä½œçŠ¶æ€æ‰€éœ€çš„å¹³å‡æ—¶é—´ã€‚è¯¥æŒ‡æ ‡ç”¨äºè¯„ä¼°è¿ç»´æ•ˆç‡ã€ç³»ç»Ÿå¯ç»´æŠ¤æ€§åŠæœåŠ¡ä¸­æ–­å¯¹ç”¨æˆ·çš„å½±å“ï¼ŒMTTRå€¼è¶Šå°ï¼Œè¡¨æ˜ç³»ç»Ÿå¯é æ€§ä¸æ¢å¤èƒ½åŠ›è¶Šé«˜ã€‚\nMTTR çš„ä¸»è¦å«ä¹‰ä¸è§£æ æ ¸å¿ƒå®šä¹‰ï¼šä»£è¡¨ä»æ•…éšœå‘ç”Ÿã€æ£€æµ‹åˆ°ä¿®å¤å®Œæˆã€æ¢å¤æ­£å¸¸è¿è¡Œæ‰€éœ€çš„å…¨éƒ¨å¹³å‡æ—¶é—´ã€‚\nè®¡ç®—å…¬å¼ï¼š (\\text{MTTR}=\\frac{\\text{æ€»åœæœºæ—¶é—´}}{\\text{æ•…éšœæ¬¡æ•°}})ã€‚\né€‚ç”¨åœºæ™¯ï¼š\nIT ä¸è½¯ä»¶è¿ç»´ (DevOps)ï¼š è¡¡é‡æœåŠ¡ä¸­æ–­çš„ä¿®å¤é€Ÿåº¦ï¼Œæ˜¯æ ¸å¿ƒç¨³å®šæ€§æŒ‡æ ‡ã€‚ è®¾å¤‡ç»´ä¿®å·¥ç¨‹ï¼š è¡¡é‡ç»´ä¿®äººå‘˜æˆ–æµç¨‹çš„å¯ç»´æŠ¤æ€§ã€‚ ç»„æˆéƒ¨åˆ†ï¼ˆMTT Xï¼‰ï¼š çœŸæ­£çš„æ•…éšœä¿®å¤æµç¨‹é€šå¸¸åŒ…æ‹¬ï¼š\nMTTD (Mean Time To Detect)ï¼šå¹³å‡æ£€æµ‹æ—¶é—´ã€‚ MTTK (Mean Time To Know)ï¼š å¹³å‡è¯Šæ–­æ—¶é—´ã€‚ MTTF (Mean Time To Fix)ï¼š å¹³å‡ä¿®å¤æ—¶é—´ã€‚ MTTV (Mean Time To Verify)ï¼š å¹³å‡éªŒè¯æ—¶é—´ã€‚ ç›¸å…³æŒ‡æ ‡ï¼š\nMTBF (Mean Time Between Failures)ï¼š å¹³å‡æ— æ•…éšœå·¥ä½œæ—¶é—´ï¼Œè¡¡é‡å¯é æ€§ã€‚ MTTF (Mean Time To Failure)ï¼š å¹³å‡é¦–æ¬¡æ•…éšœæ—¶é—´ï¼Œè¡¡é‡å¯¿å‘½ã€‚ ç¼©çŸ­ MTTR çš„æ–¹æ³•** åˆ¶å®šæ ‡å‡†æ“ä½œæµç¨‹ï¼ˆRunbookï¼‰ã€‚ å¼•å…¥è‡ªåŠ¨åŒ–å·¥å…·å’Œç›‘æ§ç³»ç»Ÿ (SOAR)ã€‚ æé«˜è¯Šæ–­å’Œä¿®å¤æŠ€æœ¯çš„åŸ¹è®­ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼ŒMTTR æ˜¯è¯„ä¼°æ•…éšœå½±å“ç¨‹åº¦å’Œç»´æŠ¤å›¢é˜Ÿæ•ˆç‡çš„å…³é”®æŒ‡æ ‡ã€‚\n","description":"ç›®æ ‡ï¼šä½œä¸ºã€ŠIT è¿ç»´ç®¡ç†å®Œæ•´èƒ½åŠ›æ¨¡å‹ã€‹æˆ–ã€Šè¿ç»´ä½“ç³»å»ºè®¾æ–¹æ¡ˆã€‹ä½¿ç”¨ã€‚\nå®šä½è¯´æ˜ IT è¿ç»´ç®¡ç†ï¼ˆIT Operations Management, ITOMï¼‰ æ˜¯é€šè¿‡æŠ€æœ¯æ‰‹æ®µä¸ç®¡ç†æµç¨‹ï¼Œå¯¹ä¼ä¸šçš„ç¡¬ä»¶ã€è½¯ä»¶ã€ç½‘ç»œå’Œæ•°æ®ç­‰ IT èµ„æºè¿›è¡Œ è§„åˆ’ã€å»ºè®¾ã€è¿è¡Œã€å˜æ›´ã€ä¿éšœä¸æŒç»­ä¼˜åŒ–ï¼Œå…¨é¢ç®¡ç†å’Œç»´æŠ¤ï¼Œ ä»¥ç¡®ä¿ IT ç³»ç»Ÿ ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œï¼Œæ”¯æ’‘ä¸šåŠ¡è¿ç»­æ€§å¹¶æŒç»­åˆ›é€ ä¸šåŠ¡ä»·å€¼ã€‚\nå…¶æ ¸å¿ƒç›®æ ‡æ˜¯ä¿éšœä¸šåŠ¡è¿ç»­æ€§ï¼Œæå‡æœåŠ¡è´¨é‡ï¼Œå¹¶é™ä½è¿ç»´æˆæœ¬ã€‚\nIT è¿ç»´ç®¡ç† = å¯¹ IT ç³»ç»Ÿ â€œä»è§„åˆ’ -\u0026gt; å»ºè®¾ -\u0026gt; è¿è¡Œ -\u0026gt; å˜æ›´ -\u0026gt; é£é™© -\u0026gt; ä¼˜åŒ– -\u0026gt; é€€å½¹â€ çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†\næ ¸å¿ƒèŒè´£ä¸å†…å®¹ ä¸€ã€è¿ç»´ç³»ç»Ÿæ¶æ„è§„åˆ’ï¼ˆé¡¶å±‚è®¾è®¡ï¼‰ ç›®çš„ï¼šé€šè¿‡å‰ç½®è§„åˆ’è¿ç»´ä½“ç³»ä¸ç³»ç»Ÿæ¶æ„ï¼Œä»æºå¤´ä¿éšœç³»ç»Ÿçš„ç¨³å®šæ€§ã€å¯æ‰©å±•æ€§ä¸å¯è¿ç»´æ€§ã€‚\n"},{"id":13,"href":"/management/operations/core/","title":"ITè¿ç»´ç®¡ç†ï¼šä½“ç³»åŒ–æ¼”è¿›ä¸ä»·å€¼åˆ›é€ ","parent":"Operations","content":" ä¸€ã€å®šä¹‰ä¸æˆ˜ç•¥å®šä½ ITè¿ç»´ç®¡ç†(Information Technology Operations Management)æ˜¯å¯¹ä¼ä¸šITåŸºç¡€è®¾æ–½ã€åº”ç”¨ç³»ç»Ÿã€ç½‘ç»œã€æœåŠ¡å™¨åŠæ•°æ®èµ„äº§è¿›è¡Œå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé€šè¿‡æ ‡å‡†åŒ–æµç¨‹ã€è‡ªåŠ¨åŒ–å·¥å…·ä¸ä¸“ä¸šåŒ–å›¢é˜Ÿï¼Œç¡®ä¿ITæœåŠ¡ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œï¼Œå¹¶æŒç»­åˆ›é€ ä¸šåŠ¡ä»·å€¼çš„ç»¼åˆæ€§å·¥ä½œä½“ç³»ã€‚\n1.1 ä»·å€¼æ¼”è¿› ç°ä»£ITè¿ç»´å·²ä»ä¼ ç»Ÿçš„\u0026quot;ä¿éšœå¯ç”¨æ€§\u0026quot;è§’è‰²ï¼Œé€æ­¥æ¼”è¿›ä¸º\u0026quot;ä¸šåŠ¡ä»·å€¼åˆ›é€ è€…\u0026quot;ï¼š\næˆæœ¬ä¸­å¿ƒ -\u0026gt; ä»·å€¼ä¸­å¿ƒï¼šä»å•çº¯æ§åˆ¶ITæ”¯å‡ºï¼Œè½¬å˜ä¸ºé€šè¿‡è¿ç»´ä¼˜åŒ–ç›´æ¥è´¡çŒ®ä¸šåŠ¡å¢é•¿ è¢«åŠ¨å“åº” -\u0026gt; ä¸»åŠ¨èµ‹èƒ½ï¼šä»äº‹åæ•…éšœå¤„ç†ï¼Œè½¬å‘é€šè¿‡æ•°æ®æ´å¯Ÿé©±åŠ¨ä¸šåŠ¡å†³ç­– æŠ€æœ¯å¯¼å‘ -\u0026gt; ä¸šåŠ¡å¯¼å‘ï¼šè¿ç»´KPIä¸ä¸šåŠ¡KPIæ·±åº¦ç»‘å®šï¼Œå¦‚ç³»ç»Ÿç¨³å®šæ€§ä¸å®¢æˆ·ç•™å­˜ç‡å…³è”åˆ†æ 1.2 æ¼”è¿›å†ç¨‹ é˜¶æ®µ æ—¶é—´ ç‰¹å¾ ä»·å€¼å®šä½ å…¸å‹æŒ‡æ ‡ åŸºç¡€è¿ç»´ 2000-2010 ä»¥ç¨³å®šæ€§ä¸ºä¸­å¿ƒ ä¿éšœä¸šåŠ¡è¿ç»­æ€§ ç³»ç»Ÿå¯ç”¨ç‡ã€æ•…éšœæ¢å¤æ—¶é—´ æµç¨‹è¿ç»´ 2010-2015 ITIL/ITSMè½åœ° æµç¨‹è§„èŒƒåŒ– æµç¨‹åˆè§„ç‡ã€SLAè¾¾æˆç‡ è‡ªåŠ¨åŒ–è¿ç»´ 2015-2020 DevOps/SREå®è·µ æ•ˆç‡æå‡ éƒ¨ç½²é¢‘ç‡ã€å˜æ›´æˆåŠŸç‡ æ™ºèƒ½è¿ç»´ 2020-è‡³ä»Š AIOpsä¸ä»·å€¼å¯¼å‘ ä¸šåŠ¡èµ‹èƒ½ ä¸šåŠ¡å½±å“åº¦ã€ä»·å€¼è´¡çŒ®ç‡ äºŒã€æ ¸å¿ƒå†…å®¹ä½“ç³»åŒ–æ‰©å±• 2.1 åŸºç¡€è®¾æ–½å…¨æ ˆç®¡ç† ç‰©ç†/è™šæ‹Ÿèµ„æºç®¡ç†ï¼šæœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€å­˜å‚¨è®¾å¤‡çš„çŠ¶æ€ç›‘æ§ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç† äº‘èµ„æºæ²»ç†ï¼šå¤šäº‘/æ··åˆäº‘ç¯å¢ƒä¸‹çš„èµ„æºç»Ÿä¸€ç®¡ç†ã€æˆæœ¬ä¼˜åŒ–ä¸åˆè§„æ§åˆ¶ è¾¹ç¼˜èŠ‚ç‚¹ç®¡ç†ï¼šIoT/è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹çš„åˆ†å¸ƒå¼åŸºç¡€è®¾æ–½ç®¡æ§ å®è·µæ•°æ®ï¼šæŸé‡‘èæœºæ„é€šè¿‡èµ„æºæ²»ç†ï¼Œå°†æœåŠ¡å™¨å¹³å‡åˆ©ç”¨ç‡ä»15%æå‡è‡³45%ï¼Œå¹´èŠ‚çœç¡¬ä»¶æˆæœ¬1200ä¸‡ 2.2 åº”ç”¨ç³»ç»Ÿå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç† éƒ¨ç½²ä¸å‘å¸ƒï¼šCI/CDæµæ°´çº¿æ„å»ºï¼Œæ”¯æŒè“ç»¿/é‡‘ä¸é›€/æ»šåŠ¨ç­‰å¤šç§å‘å¸ƒç­–ç•¥ è¿è¡Œä¿éšœï¼šå…¨é“¾è·¯ç›‘æ§è¦†ç›–åŸºç¡€è®¾æ–½ã€åº”ç”¨æ€§èƒ½ã€ä¸šåŠ¡æŒ‡æ ‡ä¸‰å±‚ æ•…éšœç®¡ç†ï¼šå»ºç«‹\u0026quot;é¢„é˜²-å‘ç°-å®šä½-è§£å†³-å¤ç›˜\u0026quot;é—­ç¯æœºåˆ¶ æœ€ä½³å®è·µï¼šæŸç”µå•†å¹³å°å®ç°æ ¸å¿ƒæœåŠ¡æ¯æ—¥200+æ¬¡è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå˜æ›´æˆåŠŸç‡99.8% 2.3 æ·±åº¦å®‰å…¨è¿ç»´ çºµæ·±é˜²å¾¡ä½“ç³»ï¼šç½‘ç»œå±‚ã€ä¸»æœºå±‚ã€åº”ç”¨å±‚ã€æ•°æ®å±‚å››å±‚é˜²æŠ¤ æ¼æ´ç®¡ç†é—­ç¯ï¼šè‡ªåŠ¨æ‰«æ -\u0026gt; é£é™©è¯„ä¼° -\u0026gt; ä¿®å¤éªŒè¯ -\u0026gt; å›å½’æµ‹è¯• é›¶ä¿¡ä»»æ¶æ„ï¼šæœ€å°æƒé™åŸåˆ™ï¼ŒæŒç»­éªŒè¯ï¼ŒåŠ¨æ€æˆæƒ åˆè§„ç®¡ç†ï¼šç­‰ä¿2.0ã€ISO27001ã€GDPRç­‰åˆè§„æ€§è‡ªåŠ¨åŒ–æ£€æŸ¥ æ¡ˆä¾‹ï¼šæŸäº’è”ç½‘å…¬å¸é€šè¿‡è‡ªåŠ¨åŒ–æ¼æ´ç®¡ç†å¹³å°ï¼Œå°†é«˜å±æ¼æ´å¹³å‡ä¿®å¤æ—¶é—´ä»14å¤©ç¼©çŸ­è‡³72å°æ—¶ 2.4 é…ç½®ä¸èµ„äº§ç®¡ç† CMDBå»ºè®¾ï¼šITèµ„äº§ä¸é…ç½®é¡¹çš„è‡ªåŠ¨å‘ç°ã€å…³ç³»æ˜ å°„ä¸å˜æ›´è·Ÿè¸ª ç‰ˆæœ¬æ§åˆ¶ï¼šåŸºç¡€è®¾æ–½å³ä»£ç (IaC)ï¼Œé…ç½®ç‰ˆæœ¬åŒ–ç®¡ç† ä¾èµ–åˆ†æï¼šå…³é”®ä¸šåŠ¡ç³»ç»Ÿä¾èµ–å…³ç³»å¯è§†åŒ–ï¼Œå˜æ›´å½±å“è¯„ä¼° æˆç†Ÿåº¦æ¼”è¿›ï¼šä»æ‰‹å·¥Excelè®°å½• -\u0026gt; åŠè‡ªåŠ¨åŒ–å·¥å…· -\u0026gt; å…¨è‡ªåŠ¨å‘ç°ä¸ç®¡ç† 2.5 æœåŠ¡ç®¡ç†ç²¾ç»†åŒ– äº‹ä»¶ç®¡ç†ï¼šæ™ºèƒ½å‘Šè­¦é™å™ªï¼Œåˆ†çº§å“åº”æœºåˆ¶ï¼Œå¹³å‡15åˆ†é’Ÿå†…å“åº”P1çº§äº‹ä»¶ é—®é¢˜ç®¡ç†ï¼šæ ¹å› åˆ†æ(RCA)ï¼Œé¢„é˜²æ€§æ”¹è¿›æªæ–½ï¼Œé—®é¢˜å¤å‘ç‡\u0026lt;5% å˜æ›´ç®¡ç†ï¼šæ ‡å‡†åŒ–å˜æ›´æµç¨‹ï¼Œè‡ªåŠ¨åŒ–é£é™©è¯„ä¼°ï¼Œå˜æ›´æˆåŠŸç‡\u0026gt;95% æœåŠ¡çº§åˆ«ç®¡ç†ï¼šSLA/SLO/SLIæ˜ç¡®å®šä¹‰ï¼Œå®æ—¶ç›‘æ§è¾¾æˆæƒ…å†µ å®è·µä»·å€¼ï¼šæŸç”µä¿¡ä¼ä¸šé€šè¿‡æœåŠ¡ç®¡ç†ä¼˜åŒ–ï¼Œå®¢æˆ·æ»¡æ„åº¦æå‡32%ï¼Œè¿ç»´æˆæœ¬é™ä½25% 2.6 å®¹é‡ä¸æ€§èƒ½ç®¡ç† å®¹é‡è§„åˆ’ï¼šåŸºäºä¸šåŠ¡å¢é•¿æ¨¡å‹çš„èµ„æºéœ€æ±‚é¢„æµ‹ï¼Œé¢„ç•™20%ç¼“å†²åŒº æ€§èƒ½ä¼˜åŒ–ï¼š ç³»ç»Ÿå±‚ï¼šå†…æ ¸å‚æ•°ã€IOè°ƒåº¦ä¼˜åŒ– åº”ç”¨å±‚ï¼šJVMè°ƒä¼˜ã€SQLä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥ æ¶æ„å±‚ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€å¼‚æ­¥åŒ– æˆæœ¬æ•ˆç›Šå¹³è¡¡ï¼šæ€§èƒ½æå‡ä¸èµ„æºæˆæœ¬çš„æœ€ä¼˜å¹³è¡¡ç‚¹åˆ†æ æ•°æ®æ´å¯Ÿï¼šæŸé›¶å”®ä¼ä¸šé€šè¿‡æ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æ’‘618å¤§ä¿ƒæœŸé—´äº¤æ˜“é‡å¢é•¿300%ï¼Œèµ„æºæˆæœ¬ä»…å¢åŠ 40% 2.7 æ•°æ®è¿ç»´ç®¡ç† æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šä»åˆ›å»ºã€ä½¿ç”¨ã€å½’æ¡£åˆ°é”€æ¯çš„å…¨æµç¨‹ç®¡æ§ å¤‡ä»½ä¸æ¢å¤ï¼šéµå¾ª 3-2-1 åŸåˆ™ (3ä»½å‰¯æœ¬ã€2ç§ä»‹è´¨ã€1ä»½å¼‚åœ°)ï¼ŒRTO\u0026lt;30åˆ†é’Ÿ æ•°æ®è´¨é‡ä¿éšœï¼šå®Œæ•´æ€§ã€ä¸€è‡´æ€§ã€å‡†ç¡®æ€§ç›‘æ§ ä»·å€¼æŒ–æ˜ï¼šè¿ç»´æ•°æ®è½¬åŒ–ä¸ºä¸šåŠ¡æ´å¯Ÿï¼Œå¦‚ç”¨æˆ·è¡Œä¸ºåˆ†æã€ä¸šåŠ¡é¢„æµ‹ åˆè§„æ€§ï¼šæ»¡è¶³æ•°æ®å®‰å…¨æ³•ã€ä¸ªäººä¿¡æ¯ä¿æŠ¤ç­‰æ³•è§„è¦æ±‚ 2.8 å¯è§‚æµ‹æ€§ä½“ç³» ä¸‰å¤§æ”¯æŸ±èåˆï¼šMetrics(æŒ‡æ ‡)ã€Logs(æ—¥å¿—)ã€Traces(é“¾è·¯)ç»Ÿä¸€åˆ†æ ä¸šåŠ¡å¯è§‚æµ‹æ€§ï¼šè¶…è¶ŠæŠ€æœ¯æŒ‡æ ‡ï¼Œå…³æ³¨äº¤æ˜“æˆåŠŸç‡ã€ç”¨æˆ·è½¬åŒ–ç‡ç­‰ä¸šåŠ¡KPI æ™ºèƒ½åˆ†æï¼šå¼‚å¸¸æ£€æµ‹ã€è¶‹åŠ¿é¢„æµ‹ã€æ ¹å› æ¨è å®è·µæˆæ•ˆï¼šæŸè¯åˆ¸å…¬å¸é€šè¿‡å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œå°†æ•…éšœå®šä½æ—¶é—´ä»2å°æ—¶ç¼©çŸ­è‡³8åˆ†é’Ÿ ä¸‰ã€æ–¹æ³•è®ºä½“ç³»ä¸å®æ–½è·¯å¾„ 3.1 æ ¸å¿ƒæ¡†æ¶å¯¹æ¯”ä¸é€‰æ‹© æ¡†æ¶ æ ¸å¿ƒç†å¿µ é€‚ç”¨åœºæ™¯ å®æ–½éš¾åº¦ ä»·å€¼å‘¨æœŸ ITIL æœåŠ¡ä»·å€¼ä½“ç³»ï¼Œæµç¨‹é©±åŠ¨ ä¼ ç»Ÿä¼ä¸šã€å¤§å‹ç»„ç»‡ é«˜ 6-12ä¸ªæœˆ DevOps åä½œæ–‡åŒ–ï¼Œè‡ªåŠ¨åŒ–æµæ°´çº¿ äº’è”ç½‘ã€æ•æ·å›¢é˜Ÿ ä¸­ 3-6ä¸ªæœˆ SRE ç”¨è½¯ä»¶å·¥ç¨‹è§£å†³è¿ç»´é—®é¢˜ å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ é«˜ 6-18ä¸ªæœˆ ISO20000 æ ‡å‡†åŒ–è®¤è¯ï¼Œåˆè§„é©±åŠ¨ é‡‘èã€æ”¿åºœç­‰å¼ºç›‘ç®¡è¡Œä¸š é«˜ 12-18ä¸ªæœˆ 3.2 èåˆå®æ–½è·¯å¾„ é˜¶æ®µ1ï¼šåŸºç¡€å¤¯å® (1-3ä¸ªæœˆ) â”œâ”€â”€ æ ¸å¿ƒç›‘æ§è¦†ç›– â”œâ”€â”€ åŸºç¡€æµç¨‹å®šä¹‰ â””â”€â”€ å›¢é˜Ÿèƒ½åŠ›è¯„ä¼° é˜¶æ®µ2ï¼šæµç¨‹ä¼˜åŒ– (3-6ä¸ªæœˆ) â”œâ”€â”€ ITILæ ¸å¿ƒæµç¨‹è½åœ° â”œâ”€â”€ è‡ªåŠ¨åŒ–å·¥å…·é“¾å»ºè®¾ â””â”€â”€ æœåŠ¡ç›®å½•å®šä¹‰ é˜¶æ®µ3ï¼šèƒ½åŠ›æå‡ (6-12ä¸ªæœˆ) â”œâ”€â”€ DevOpsæ–‡åŒ–åŸ¹å…» â”œâ”€â”€ æ·±åº¦è‡ªåŠ¨åŒ– â””â”€â”€ æ•°æ®é©±åŠ¨å†³ç­– é˜¶æ®µ4ï¼šä»·å€¼åˆ›é€  (12+ä¸ªæœˆ) â”œâ”€â”€ AIOpsèƒ½åŠ›æ„å»º â”œâ”€â”€ ä¸šåŠ¡ä»·å€¼é‡åŒ– â””â”€â”€ æŒç»­åˆ›æ–°æœºåˆ¶ 3.3 è½¬å‹å…³é”®æˆåŠŸå› ç´  é«˜å±‚æ”¯æŒï¼šCIO/CTOäº²è‡ªæ¨åŠ¨ï¼Œå°†è¿ç»´è½¬å‹çº³å…¥ä¼ä¸šæˆ˜ç•¥ äººæ‰åŸ¹å…»ï¼šå»ºç«‹æŠ€èƒ½çŸ©é˜µï¼Œå®æ–½\u0026quot;è¿ç»´å·¥ç¨‹å¸ˆ -\u0026gt; SRE -\u0026gt; ä¸šåŠ¡èµ‹èƒ½ä¸“å®¶\u0026quot;è½¬å‹è·¯å¾„ å·¥å…·èµ‹èƒ½ï¼šç»Ÿä¸€è¿ç»´å¹³å°å»ºè®¾ï¼Œæ‰“ç ´æ•°æ®å­¤å²› åº¦é‡é©±åŠ¨ï¼šå»ºç«‹ä»æŠ€æœ¯æŒ‡æ ‡åˆ°ä¸šåŠ¡ä»·å€¼çš„ç«¯åˆ°ç«¯åº¦é‡ä½“ç³» æ–‡åŒ–å˜é©ï¼šä»\u0026quot;è´£å¤‡æ–‡åŒ–\u0026quot;åˆ°\u0026quot;å­¦ä¹ æ–‡åŒ–\u0026quot;ï¼Œé¼“åŠ±é€æ˜ä¸åˆ†äº« å››ã€å‘å±•è¶‹åŠ¿ä¸å‰ç» 4.1 æ™ºèƒ½åŒ–è¿ç»´(AIOps)æ·±åº¦æ¼”è¿› å®æ–½è·¯å¾„ï¼šå•ç‚¹åœºæ™¯(å¼‚å¸¸æ£€æµ‹) -\u0026gt; å‚ç›´é¢†åŸŸ(æ—¥å¿—åˆ†æ) -\u0026gt; æ¨ªå‘æ‰“é€š(å…¨æ ˆæ™ºèƒ½) å…³é”®æŠ€æœ¯ï¼š æ—¶åºæ•°æ®åˆ†æï¼šLSTMã€Prophetç­‰ç®—æ³•é¢„æµ‹æŒ‡æ ‡è¶‹åŠ¿ å¼‚å¸¸æ£€æµ‹ï¼šæ— ç›‘ç£å­¦ä¹ è‡ªåŠ¨å‘ç°å¼‚å¸¸æ¨¡å¼ æ ¹å› åˆ†æï¼šçŸ¥è¯†å›¾è°±+å› æœæ¨ç†å®šä½é—®é¢˜æ ¹æº æˆç†Ÿåº¦æ¨¡å‹ï¼šä»\u0026quot;äººå·¥å†³ç­–+å·¥å…·è¾…åŠ©\u0026quot;åˆ°\u0026quot;äººæœºååŒ\u0026quot;å†åˆ°\u0026quot;è‡ªä¸»è¿ç»´\u0026quot; å®è·µæ¡ˆä¾‹ï¼šæŸé“¶è¡Œé€šè¿‡AIOpså¹³å°ï¼Œæå‰45åˆ†é’Ÿé¢„æµ‹æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆï¼Œé¿å…äº†å¯èƒ½çš„äº¤æ˜“ä¸­æ–­ 4.2 äº‘åŸç”Ÿè¿ç»´æ–°èŒƒå¼ æ ¸å¿ƒè½¬å˜ï¼š ä»\u0026quot;ç®¡ç†æœåŠ¡å™¨\u0026quot;åˆ°\u0026quot;ç®¡ç†æœåŠ¡\u0026quot; ä»\u0026quot;é™æ€é…ç½®\u0026quot;åˆ°\u0026quot;åŠ¨æ€ç¼–æ’\u0026quot; ä»\u0026quot;æ•…éšœæ¢å¤\u0026quot;åˆ°\u0026quot;è‡ªæ„ˆèƒ½åŠ›\u0026quot; å…³é”®æŠ€æœ¯æ ˆï¼š å®¹å™¨è¿è¡Œæ—¶ï¼šDockerã€containerd ç¼–æ’å¹³å°ï¼šKubernetesåŠç”Ÿæ€ æœåŠ¡æ²»ç†ï¼šIstioã€Linkerd å¯è§‚æµ‹æ€§ï¼šPrometheusã€OpenTelemetry è¿è¥æ¨¡å¼ï¼šå¹³å°å·¥ç¨‹(Platform Engineering)ï¼Œå†…éƒ¨å¼€å‘è€…å¹³å°(IDP)å»ºè®¾ 4.3 ä»·å€¼å¯¼å‘è¿ç»´(ValueOps) ä»·å€¼åº¦é‡ä½“ç³»ï¼š\nITä»·å€¼ = ä¸šåŠ¡æ•æ·æ€§ Ã— ç³»ç»Ÿç¨³å®šæ€§ Ã— èµ„æºæ•ˆç‡ ä¸šåŠ¡æŒ‡æ ‡æ˜ å°„ï¼š\nç³»ç»Ÿå¯ç”¨ç‡ -\u0026gt; å®¢æˆ·ç•™å­˜ç‡ éƒ¨ç½²é¢‘ç‡ -\u0026gt; äº§å“åˆ›æ–°é€Ÿåº¦ èµ„æºåˆ©ç”¨ç‡ -\u0026gt; ä¸šåŠ¡æ‰©å±•æˆæœ¬ ä»·å€¼å¯è§†åŒ–ï¼šè¿ç»´æŠ•å…¥ä¸ä¸šåŠ¡æˆæœçš„ç›´æ¥å…³è”åˆ†æï¼ŒROIé‡åŒ–å±•ç¤º\näº”ã€å…³é”®æŒ‘æˆ˜ä¸åº”å¯¹ç­–ç•¥ 5.1 ç³»ç»Ÿå¤æ‚åº¦ç®¡ç† æŒ‘æˆ˜ï¼šå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œç³»ç»Ÿç»„ä»¶æ•°é‡æ¿€å¢ï¼Œä¾èµ–å…³ç³»å¤æ‚ åº”å¯¹ç­–ç•¥ï¼š æœåŠ¡ç½‘æ ¼å®æ–½ï¼Œè§£è€¦ä¸šåŠ¡é€»è¾‘ä¸åŸºç¡€è®¾æ–½å…³æ³¨ç‚¹ å¯è§‚æµ‹æ€§ä½“ç³»æ„å»ºï¼Œç»Ÿä¸€ç›‘æ§ä¸åˆ†æå¹³å° ä¾èµ–å…³ç³»å¯è§†åŒ–ï¼Œå½±å“èŒƒå›´å¿«é€Ÿè¯„ä¼° 5.2 å®‰å…¨ä¸åˆè§„å‹åŠ› æŒ‘æˆ˜ï¼šæ”»å‡»é¢æ‰©å¤§ï¼Œåˆè§„è¦æ±‚æ—¥ç›Šä¸¥æ ¼ åº”å¯¹ç­–ç•¥ï¼š å®‰å…¨å·¦ç§»ï¼šDevSecOpsï¼Œå®‰å…¨å†…åµŒè‡³å¼€å‘æµç¨‹ è‡ªåŠ¨åŒ–åˆè§„ï¼šç­–ç•¥å³ä»£ç ï¼Œè‡ªåŠ¨åˆè§„æ£€æŸ¥ é›¶ä¿¡ä»»æ¶æ„ï¼šæŒç»­éªŒè¯ï¼Œæœ€å°æƒé™ 5.3 äººæ‰è½¬å‹å›°å¢ƒ æŒ‘æˆ˜ï¼šä¼ ç»Ÿè¿ç»´æŠ€èƒ½ä¸æ–°å…´éœ€æ±‚è„±èŠ‚ åº”å¯¹ç­–ç•¥ï¼š èƒ½åŠ›æ¨¡å‹é‡æ„ï¼šå®šä¹‰SREã€å¹³å°å·¥ç¨‹å¸ˆç­‰æ–°è§’è‰²èƒ½åŠ›å›¾è°± å­¦ä¹ è·¯å¾„è§„åˆ’ï¼šä»è„šæœ¬èƒ½åŠ› -\u0026gt; ç¼–ç¨‹èƒ½åŠ› -\u0026gt; æ¶æ„èƒ½åŠ›æ¸è¿›å¼åŸ¹å…» å¤–éƒ¨ç”Ÿæ€åˆä½œï¼šä¸äº‘å‚å•†ã€å·¥å…·æä¾›å•†å…±å»ºèƒ½åŠ› 5.4 å·¥å…·é“¾æ•´åˆéš¾é¢˜ æŒ‘æˆ˜ï¼šå·¥å…·ç¢ç‰‡åŒ–ï¼Œæ•°æ®å­¤å²›ä¸¥é‡ åº”å¯¹ç­–ç•¥ï¼š ç»Ÿä¸€å¹³å°å»ºè®¾ï¼šæ ¸å¿ƒå¹³å°+å¼€æ”¾æ¥å£ æ•°æ®ä¸­å°æ„å»ºï¼šè¿ç»´æ•°æ®ç»Ÿä¸€é‡‡é›†ã€å¤„ç†ã€åˆ†æ ä»·å€¼ä¼˜å…ˆåŸåˆ™ï¼šèšç„¦é«˜ä»·å€¼åœºæ™¯ï¼Œé¿å…å·¥å…·å †ç Œ å…­ã€æˆåŠŸå®è·µä¸å¯ç¤º 6.1 é‡‘èè¡Œä¸šï¼šæŸå¤§å‹é“¶è¡Œè¿ç»´è½¬å‹ èƒŒæ™¯ï¼šæ ¸å¿ƒç³»ç»Ÿå¤æ‚åº¦é«˜ï¼Œç›‘ç®¡è¦æ±‚ä¸¥æ ¼ï¼Œåˆ›æ–°é€Ÿåº¦æ…¢ è½¬å‹è·¯å¾„ï¼š å»ºç«‹\u0026quot;ä¸¤åœ°ä¸‰ä¸­å¿ƒ\u0026quot;å®¹ç¾æ¶æ„ï¼ŒRTO\u0026lt;30åˆ†é’Ÿ æ„å»ºè‡ªåŠ¨åŒ–å˜æ›´å¹³å°ï¼Œå˜æ›´æˆåŠŸç‡ä»85%æå‡è‡³99.5% å¼•å…¥AIOpså¹³å°ï¼Œå®ç°30%å¸¸è§æ•…éšœè‡ªåŠ¨ä¿®å¤ æˆæ•ˆï¼šå…¨å¹´é‡å¤§æ•…éšœæ¬¡æ•°ä»12æ¬¡é™è‡³2æ¬¡ï¼Œå®¢æˆ·æŠ•è¯‰å‡å°‘65%ï¼Œåˆ›æ–°é¡¹ç›®äº¤ä»˜å‘¨æœŸç¼©çŸ­40% 6.2 äº’è”ç½‘è¡Œä¸šï¼šæŸç”µå•†å¹³å°å¤§ä¿ƒä¿éšœ èƒŒæ™¯ï¼šæµé‡æ´ªå³°å‹åŠ›å¤§ï¼Œç³»ç»Ÿç¨³å®šæ€§è¦æ±‚æé«˜ å…³é”®ä¸¾æªï¼š å…¨é“¾è·¯å‹æµ‹ï¼šæ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸ºï¼Œç²¾å‡†å®¹é‡è§„åˆ’ ä¸‰çº§å¼¹æ€§ä¼¸ç¼©ï¼šç§’çº§è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œåº”å¯¹æµé‡æ³¢åŠ¨ æ··æ²Œå·¥ç¨‹å¸¸æ€åŒ–ï¼šæ¯å‘¨æ•…éšœæ³¨å…¥æ¼”ç»ƒï¼Œæå‡ç³»ç»ŸéŸ§æ€§ æˆæ•ˆï¼šåŒ11æœŸé—´ç³»ç»Ÿå¯ç”¨æ€§99.995%ï¼Œè®¢å•å³°å€¼å¤„ç†èƒ½åŠ›æå‡300%ï¼ŒITèµ„æºæˆæœ¬é™ä½35% 6.3 ä¼ ç»Ÿä¼ä¸šï¼šæŸåˆ¶é€ ä¼ä¸šæ•°å­—åŒ–è½¬å‹ èƒŒæ™¯ï¼šç³»ç»Ÿè€æ—§ï¼Œè¿ç»´æ•ˆç‡ä½ä¸‹ï¼Œä¸šåŠ¡æ”¯æŒèƒ½åŠ›å¼± è½¬å‹ç­–ç•¥ï¼š ä¸‰å¹´ä¸‰æ­¥èµ°ï¼šæ ‡å‡†åŒ– -\u0026gt; è‡ªåŠ¨åŒ– -\u0026gt; æ™ºèƒ½åŒ– ä¸šåŠ¡ä»·å€¼å¯¼å‘ï¼šèšç„¦ç”Ÿäº§çº¿åœæœºæ—¶é—´ã€è®¢å•äº¤ä»˜é€Ÿåº¦ç­‰ä¸šåŠ¡æŒ‡æ ‡ æ¸è¿›å¼äº‘åŒ–ï¼šæ ¸å¿ƒç³»ç»Ÿæ··åˆéƒ¨ç½²ï¼Œéæ ¸å¿ƒç³»ç»Ÿå…¨é¢ä¸Šäº‘ æˆæ•ˆï¼šç³»ç»Ÿå¹³å‡æ— æ•…éšœæ—¶é—´æå‡400%ï¼ŒITæœåŠ¡è¯·æ±‚å“åº”æ—¶é—´ä»8å°æ—¶ç¼©çŸ­è‡³30åˆ†é’Ÿï¼Œå¹´åº¦ITæˆæœ¬é™ä½30% ä¸ƒã€æ€»ç»“ä¸å±•æœ› ç°ä»£åŒ–ITè¿ç»´ç®¡ç†å·²è¶…è¶Šä¼ ç»Ÿçš„\u0026quot;ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œ\u0026quot;èŒƒç•´ï¼Œæ­£ç»å†ä»æŠ€æœ¯é©±åŠ¨åˆ°ä¸šåŠ¡é©±åŠ¨ã€ä»è¢«åŠ¨å“åº”åˆ°ä¸»åŠ¨åˆ›æ–°ã€ä»æˆæœ¬ä¸­å¿ƒåˆ°ä»·å€¼ä¸­å¿ƒçš„æˆ˜ç•¥è½¬å‹ã€‚\næ ¸å¿ƒæˆåŠŸè¦ç´ åœ¨äºæ„å»º\u0026quot;ä¸‰ä½ä¸€ä½“\u0026quot;çš„è¿ç»´ä½“ç³»ï¼š\näººï¼šä¸“ä¸šåŒ–å›¢é˜Ÿï¼ŒæŠ€èƒ½æŒç»­æ›´æ–°ï¼Œä»·å€¼å¯¼å‘æ€ç»´ æµç¨‹ï¼šæ ‡å‡†åŒ–ä½†ä¸åƒµåŒ–ï¼Œè‡ªåŠ¨åŒ–ä½†ä¸å¤±æ§ï¼Œåº¦é‡é©±åŠ¨æŒç»­ä¼˜åŒ– æŠ€æœ¯ï¼šå·¥å…·é“¾æ•´åˆè€Œéå †ç Œï¼Œæ•°æ®é©±åŠ¨è€Œéç»éªŒä¸»ä¹‰ï¼Œå¼€æ”¾ç”Ÿæ€è€Œéå°é—­ç³»ç»Ÿ æœªæ¥äº”å¹´å‘å±•è¶‹åŠ¿ï¼š\nAIOpsæ·±åº¦åº”ç”¨ï¼šä»å•ç‚¹åœºæ™¯å‘å…¨æ ˆæ™ºèƒ½æ¼”è¿›ï¼Œè¾…åŠ©å†³ç­–å‘è‡ªä¸»å†³ç­–è¿‡æ¸¡ è¿ç»´å¹³æ°‘åŒ–ï¼šä½ä»£ç /æ— ä»£ç è¿ç»´å·¥å…·ï¼Œä¸šåŠ¡äººå‘˜å‚ä¸ç®€å•è¿ç»´ä»»åŠ¡ è¾¹ç¼˜æ™ºèƒ½è¿ç»´ï¼šIoT/è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼è‡ªæ²»è¿ç»´ä½“ç³» ä»·å€¼æ˜¾æ€§åŒ–ï¼šITè¿ç»´KPIä¸ä¸šåŠ¡KPIæ·±åº¦èåˆï¼Œä»·å€¼é‡åŒ–æˆä¸ºå¸¸æ€ ç»ˆæç›®æ ‡æ˜¯å®ç°\u0026quot;æ— æ„Ÿè¿ç»´\u0026quot;â€”â€”åŸºç¡€è®¾æ–½ä¸åº”ç”¨ç³»ç»Ÿç¨³å®šã€é«˜æ•ˆã€å®‰å…¨è¿è¡Œï¼Œä¸šåŠ¡ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œé—®é¢˜åœ¨å½±å“ä¸šåŠ¡å‰å·²è¢«è§£å†³ï¼ŒITè¿ç»´æˆä¸ºä¼ä¸šåˆ›æ–°ä¸å¢é•¿çš„æ ¸å¿ƒå¼•æ“è€Œéæ”¯æ’‘è§’è‰²ã€‚è¿™è¦æ±‚è¿ç»´å›¢é˜Ÿä¸ä»…å…·å¤‡æŠ€æœ¯èƒ½åŠ›ï¼Œæ›´è¦ç†è§£ä¸šåŠ¡æœ¬è´¨ï¼Œå°†æŠ€æœ¯ä»·å€¼è½¬åŒ–ä¸ºå•†ä¸šä»·å€¼ï¼ŒçœŸæ­£æˆä¸ºä¼ä¸šæ•°å­—åŒ–è½¬å‹çš„æˆ˜ç•¥ä¼™ä¼´ã€‚\n","description":" ä¸€ã€å®šä¹‰ä¸æˆ˜ç•¥å®šä½ ITè¿ç»´ç®¡ç†(Information Technology Operations Management)æ˜¯å¯¹ä¼ä¸šITåŸºç¡€è®¾æ–½ã€åº”ç”¨ç³»ç»Ÿã€ç½‘ç»œã€æœåŠ¡å™¨åŠæ•°æ®èµ„äº§è¿›è¡Œå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œé€šè¿‡æ ‡å‡†åŒ–æµç¨‹ã€è‡ªåŠ¨åŒ–å·¥å…·ä¸ä¸“ä¸šåŒ–å›¢é˜Ÿï¼Œç¡®ä¿ITæœåŠ¡ç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆè¿è¡Œï¼Œå¹¶æŒç»­åˆ›é€ ä¸šåŠ¡ä»·å€¼çš„ç»¼åˆæ€§å·¥ä½œä½“ç³»ã€‚\n1.1 ä»·å€¼æ¼”è¿› ç°ä»£ITè¿ç»´å·²ä»ä¼ ç»Ÿçš„\u0026quot;ä¿éšœå¯ç”¨æ€§\u0026quot;è§’è‰²ï¼Œé€æ­¥æ¼”è¿›ä¸º\u0026quot;ä¸šåŠ¡ä»·å€¼åˆ›é€ è€…\u0026quot;ï¼š\næˆæœ¬ä¸­å¿ƒ -\u0026gt; ä»·å€¼ä¸­å¿ƒï¼šä»å•çº¯æ§åˆ¶ITæ”¯å‡ºï¼Œè½¬å˜ä¸ºé€šè¿‡è¿ç»´ä¼˜åŒ–ç›´æ¥è´¡çŒ®ä¸šåŠ¡å¢é•¿ è¢«åŠ¨å“åº” -\u0026gt; ä¸»åŠ¨èµ‹èƒ½ï¼šä»äº‹åæ•…éšœå¤„ç†ï¼Œè½¬å‘é€šè¿‡æ•°æ®æ´å¯Ÿé©±åŠ¨ä¸šåŠ¡å†³ç­– æŠ€æœ¯å¯¼å‘ -\u0026gt; ä¸šåŠ¡å¯¼å‘ï¼šè¿ç»´KPIä¸ä¸šåŠ¡KPIæ·±åº¦ç»‘å®šï¼Œå¦‚ç³»ç»Ÿç¨³å®šæ€§ä¸å®¢æˆ·ç•™å­˜ç‡å…³è”åˆ†æ 1.2 æ¼”è¿›å†ç¨‹ é˜¶æ®µ æ—¶é—´ ç‰¹å¾ ä»·å€¼å®šä½ å…¸å‹æŒ‡æ ‡ åŸºç¡€è¿ç»´ 2000-2010 ä»¥ç¨³å®šæ€§ä¸ºä¸­å¿ƒ ä¿éšœä¸šåŠ¡è¿ç»­æ€§ ç³»ç»Ÿå¯ç”¨ç‡ã€æ•…éšœæ¢å¤æ—¶é—´ æµç¨‹è¿ç»´ 2010-2015 ITIL/ITSMè½åœ° æµç¨‹è§„èŒƒåŒ– æµç¨‹åˆè§„ç‡ã€SLAè¾¾æˆç‡ è‡ªåŠ¨åŒ–è¿ç»´ 2015-2020 DevOps/SREå®è·µ æ•ˆç‡æå‡ éƒ¨ç½²é¢‘ç‡ã€å˜æ›´æˆåŠŸç‡ æ™ºèƒ½è¿ç»´ 2020-è‡³ä»Š AIOpsä¸ä»·å€¼å¯¼å‘ ä¸šåŠ¡èµ‹èƒ½ ä¸šåŠ¡å½±å“åº¦ã€ä»·å€¼è´¡çŒ®ç‡ äºŒã€æ ¸å¿ƒå†…å®¹ä½“ç³»åŒ–æ‰©å±• 2.1 åŸºç¡€è®¾æ–½å…¨æ ˆç®¡ç† ç‰©ç†/è™šæ‹Ÿèµ„æºç®¡ç†ï¼šæœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€å­˜å‚¨è®¾å¤‡çš„çŠ¶æ€ç›‘æ§ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç† äº‘èµ„æºæ²»ç†ï¼šå¤šäº‘/æ··åˆäº‘ç¯å¢ƒä¸‹çš„èµ„æºç»Ÿä¸€ç®¡ç†ã€æˆæœ¬ä¼˜åŒ–ä¸åˆè§„æ§åˆ¶ è¾¹ç¼˜èŠ‚ç‚¹ç®¡ç†ï¼šIoT/è¾¹ç¼˜è®¡ç®—åœºæ™¯ä¸‹çš„åˆ†å¸ƒå¼åŸºç¡€è®¾æ–½ç®¡æ§ å®è·µæ•°æ®ï¼šæŸé‡‘èæœºæ„é€šè¿‡èµ„æºæ²»ç†ï¼Œå°†æœåŠ¡å™¨å¹³å‡åˆ©ç”¨ç‡ä»15%æå‡è‡³45%ï¼Œå¹´èŠ‚çœç¡¬ä»¶æˆæœ¬1200ä¸‡ 2.2 åº”ç”¨ç³»ç»Ÿå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç† éƒ¨ç½²ä¸å‘å¸ƒï¼šCI/CDæµæ°´çº¿æ„å»ºï¼Œæ”¯æŒè“ç»¿/é‡‘ä¸é›€/æ»šåŠ¨ç­‰å¤šç§å‘å¸ƒç­–ç•¥ è¿è¡Œä¿éšœï¼šå…¨é“¾è·¯ç›‘æ§è¦†ç›–åŸºç¡€è®¾æ–½ã€åº”ç”¨æ€§èƒ½ã€ä¸šåŠ¡æŒ‡æ ‡ä¸‰å±‚ æ•…éšœç®¡ç†ï¼šå»ºç«‹\u0026quot;é¢„é˜²-å‘ç°-å®šä½-è§£å†³-å¤ç›˜\u0026quot;é—­ç¯æœºåˆ¶ æœ€ä½³å®è·µï¼šæŸç”µå•†å¹³å°å®ç°æ ¸å¿ƒæœåŠ¡æ¯æ—¥200+æ¬¡è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå˜æ›´æˆåŠŸç‡99.8% 2.3 æ·±åº¦å®‰å…¨è¿ç»´ çºµæ·±é˜²å¾¡ä½“ç³»ï¼šç½‘ç»œå±‚ã€ä¸»æœºå±‚ã€åº”ç”¨å±‚ã€æ•°æ®å±‚å››å±‚é˜²æŠ¤ æ¼æ´ç®¡ç†é—­ç¯ï¼šè‡ªåŠ¨æ‰«æ -\u0026gt; é£é™©è¯„ä¼° -\u0026gt; ä¿®å¤éªŒè¯ -\u0026gt; å›å½’æµ‹è¯• é›¶ä¿¡ä»»æ¶æ„ï¼šæœ€å°æƒé™åŸåˆ™ï¼ŒæŒç»­éªŒè¯ï¼ŒåŠ¨æ€æˆæƒ åˆè§„ç®¡ç†ï¼šç­‰ä¿2.0ã€ISO27001ã€GDPRç­‰åˆè§„æ€§è‡ªåŠ¨åŒ–æ£€æŸ¥ æ¡ˆä¾‹ï¼šæŸäº’è”ç½‘å…¬å¸é€šè¿‡è‡ªåŠ¨åŒ–æ¼æ´ç®¡ç†å¹³å°ï¼Œå°†é«˜å±æ¼æ´å¹³å‡ä¿®å¤æ—¶é—´ä»14å¤©ç¼©çŸ­è‡³72å°æ—¶ 2.4 é…ç½®ä¸èµ„äº§ç®¡ç† CMDBå»ºè®¾ï¼šITèµ„äº§ä¸é…ç½®é¡¹çš„è‡ªåŠ¨å‘ç°ã€å…³ç³»æ˜ å°„ä¸å˜æ›´è·Ÿè¸ª ç‰ˆæœ¬æ§åˆ¶ï¼šåŸºç¡€è®¾æ–½å³ä»£ç (IaC)ï¼Œé…ç½®ç‰ˆæœ¬åŒ–ç®¡ç† ä¾èµ–åˆ†æï¼šå…³é”®ä¸šåŠ¡ç³»ç»Ÿä¾èµ–å…³ç³»å¯è§†åŒ–ï¼Œå˜æ›´å½±å“è¯„ä¼° æˆç†Ÿåº¦æ¼”è¿›ï¼šä»æ‰‹å·¥Excelè®°å½• -\u0026gt; åŠè‡ªåŠ¨åŒ–å·¥å…· -\u0026gt; å…¨è‡ªåŠ¨å‘ç°ä¸ç®¡ç† 2.5 æœåŠ¡ç®¡ç†ç²¾ç»†åŒ– äº‹ä»¶ç®¡ç†ï¼šæ™ºèƒ½å‘Šè­¦é™å™ªï¼Œåˆ†çº§å“åº”æœºåˆ¶ï¼Œå¹³å‡15åˆ†é’Ÿå†…å“åº”P1çº§äº‹ä»¶ é—®é¢˜ç®¡ç†ï¼šæ ¹å› åˆ†æ(RCA)ï¼Œé¢„é˜²æ€§æ”¹è¿›æªæ–½ï¼Œé—®é¢˜å¤å‘ç‡\u0026lt;5% å˜æ›´ç®¡ç†ï¼šæ ‡å‡†åŒ–å˜æ›´æµç¨‹ï¼Œè‡ªåŠ¨åŒ–é£é™©è¯„ä¼°ï¼Œå˜æ›´æˆåŠŸç‡\u0026gt;95% æœåŠ¡çº§åˆ«ç®¡ç†ï¼šSLA/SLO/SLIæ˜ç¡®å®šä¹‰ï¼Œå®æ—¶ç›‘æ§è¾¾æˆæƒ…å†µ å®è·µä»·å€¼ï¼šæŸç”µä¿¡ä¼ä¸šé€šè¿‡æœåŠ¡ç®¡ç†ä¼˜åŒ–ï¼Œå®¢æˆ·æ»¡æ„åº¦æå‡32%ï¼Œè¿ç»´æˆæœ¬é™ä½25% 2.6 å®¹é‡ä¸æ€§èƒ½ç®¡ç† å®¹é‡è§„åˆ’ï¼šåŸºäºä¸šåŠ¡å¢é•¿æ¨¡å‹çš„èµ„æºéœ€æ±‚é¢„æµ‹ï¼Œé¢„ç•™20%ç¼“å†²åŒº æ€§èƒ½ä¼˜åŒ–ï¼š ç³»ç»Ÿå±‚ï¼šå†…æ ¸å‚æ•°ã€IOè°ƒåº¦ä¼˜åŒ– åº”ç”¨å±‚ï¼šJVMè°ƒä¼˜ã€SQLä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥ æ¶æ„å±‚ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ã€å¼‚æ­¥åŒ– æˆæœ¬æ•ˆç›Šå¹³è¡¡ï¼šæ€§èƒ½æå‡ä¸èµ„æºæˆæœ¬çš„æœ€ä¼˜å¹³è¡¡ç‚¹åˆ†æ æ•°æ®æ´å¯Ÿï¼šæŸé›¶å”®ä¼ä¸šé€šè¿‡æ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æ’‘618å¤§ä¿ƒæœŸé—´äº¤æ˜“é‡å¢é•¿300%ï¼Œèµ„æºæˆæœ¬ä»…å¢åŠ 40% 2.7 æ•°æ®è¿ç»´ç®¡ç† æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šä»åˆ›å»ºã€ä½¿ç”¨ã€å½’æ¡£åˆ°é”€æ¯çš„å…¨æµç¨‹ç®¡æ§ å¤‡ä»½ä¸æ¢å¤ï¼šéµå¾ª 3-2-1 åŸåˆ™ (3ä»½å‰¯æœ¬ã€2ç§ä»‹è´¨ã€1ä»½å¼‚åœ°)ï¼ŒRTO\u0026lt;30åˆ†é’Ÿ æ•°æ®è´¨é‡ä¿éšœï¼šå®Œæ•´æ€§ã€ä¸€è‡´æ€§ã€å‡†ç¡®æ€§ç›‘æ§ ä»·å€¼æŒ–æ˜ï¼šè¿ç»´æ•°æ®è½¬åŒ–ä¸ºä¸šåŠ¡æ´å¯Ÿï¼Œå¦‚ç”¨æˆ·è¡Œä¸ºåˆ†æã€ä¸šåŠ¡é¢„æµ‹ åˆè§„æ€§ï¼šæ»¡è¶³æ•°æ®å®‰å…¨æ³•ã€ä¸ªäººä¿¡æ¯ä¿æŠ¤ç­‰æ³•è§„è¦æ±‚ 2.8 å¯è§‚æµ‹æ€§ä½“ç³» ä¸‰å¤§æ”¯æŸ±èåˆï¼šMetrics(æŒ‡æ ‡)ã€Logs(æ—¥å¿—)ã€Traces(é“¾è·¯)ç»Ÿä¸€åˆ†æ ä¸šåŠ¡å¯è§‚æµ‹æ€§ï¼šè¶…è¶ŠæŠ€æœ¯æŒ‡æ ‡ï¼Œå…³æ³¨äº¤æ˜“æˆåŠŸç‡ã€ç”¨æˆ·è½¬åŒ–ç‡ç­‰ä¸šåŠ¡KPI æ™ºèƒ½åˆ†æï¼šå¼‚å¸¸æ£€æµ‹ã€è¶‹åŠ¿é¢„æµ‹ã€æ ¹å› æ¨è å®è·µæˆæ•ˆï¼šæŸè¯åˆ¸å…¬å¸é€šè¿‡å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œå°†æ•…éšœå®šä½æ—¶é—´ä»2å°æ—¶ç¼©çŸ­è‡³8åˆ†é’Ÿ ä¸‰ã€æ–¹æ³•è®ºä½“ç³»ä¸å®æ–½è·¯å¾„ 3.1 æ ¸å¿ƒæ¡†æ¶å¯¹æ¯”ä¸é€‰æ‹© æ¡†æ¶ æ ¸å¿ƒç†å¿µ é€‚ç”¨åœºæ™¯ å®æ–½éš¾åº¦ ä»·å€¼å‘¨æœŸ ITIL æœåŠ¡ä»·å€¼ä½“ç³»ï¼Œæµç¨‹é©±åŠ¨ ä¼ ç»Ÿä¼ä¸šã€å¤§å‹ç»„ç»‡ é«˜ 6-12ä¸ªæœˆ DevOps åä½œæ–‡åŒ–ï¼Œè‡ªåŠ¨åŒ–æµæ°´çº¿ äº’è”ç½‘ã€æ•æ·å›¢é˜Ÿ ä¸­ 3-6ä¸ªæœˆ SRE ç”¨è½¯ä»¶å·¥ç¨‹è§£å†³è¿ç»´é—®é¢˜ å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ é«˜ 6-18ä¸ªæœˆ ISO20000 æ ‡å‡†åŒ–è®¤è¯ï¼Œåˆè§„é©±åŠ¨ é‡‘èã€æ”¿åºœç­‰å¼ºç›‘ç®¡è¡Œä¸š é«˜ 12-18ä¸ªæœˆ 3.2 èåˆå®æ–½è·¯å¾„ é˜¶æ®µ1ï¼šåŸºç¡€å¤¯å® (1-3ä¸ªæœˆ) â”œâ”€â”€ æ ¸å¿ƒç›‘æ§è¦†ç›– â”œâ”€â”€ åŸºç¡€æµç¨‹å®šä¹‰ â””â”€â”€ å›¢é˜Ÿèƒ½åŠ›è¯„ä¼° é˜¶æ®µ2ï¼šæµç¨‹ä¼˜åŒ– (3-6ä¸ªæœˆ) â”œâ”€â”€ ITILæ ¸å¿ƒæµç¨‹è½åœ° â”œâ”€â”€ è‡ªåŠ¨åŒ–å·¥å…·é“¾å»ºè®¾ â””â”€â”€ æœåŠ¡ç›®å½•å®šä¹‰ é˜¶æ®µ3ï¼šèƒ½åŠ›æå‡ (6-12ä¸ªæœˆ) â”œâ”€â”€ DevOpsæ–‡åŒ–åŸ¹å…» â”œâ”€â”€ æ·±åº¦è‡ªåŠ¨åŒ– â””â”€â”€ æ•°æ®é©±åŠ¨å†³ç­– é˜¶æ®µ4ï¼šä»·å€¼åˆ›é€  (12+ä¸ªæœˆ) â”œâ”€â”€ AIOpsèƒ½åŠ›æ„å»º â”œâ”€â”€ ä¸šåŠ¡ä»·å€¼é‡åŒ– â””â”€â”€ æŒç»­åˆ›æ–°æœºåˆ¶ 3.3 è½¬å‹å…³é”®æˆåŠŸå› ç´  é«˜å±‚æ”¯æŒï¼šCIO/CTOäº²è‡ªæ¨åŠ¨ï¼Œå°†è¿ç»´è½¬å‹çº³å…¥ä¼ä¸šæˆ˜ç•¥ äººæ‰åŸ¹å…»ï¼šå»ºç«‹æŠ€èƒ½çŸ©é˜µï¼Œå®æ–½\u0026quot;è¿ç»´å·¥ç¨‹å¸ˆ -\u0026gt; SRE -\u0026gt; ä¸šåŠ¡èµ‹èƒ½ä¸“å®¶\u0026quot;è½¬å‹è·¯å¾„ å·¥å…·èµ‹èƒ½ï¼šç»Ÿä¸€è¿ç»´å¹³å°å»ºè®¾ï¼Œæ‰“ç ´æ•°æ®å­¤å²› åº¦é‡é©±åŠ¨ï¼šå»ºç«‹ä»æŠ€æœ¯æŒ‡æ ‡åˆ°ä¸šåŠ¡ä»·å€¼çš„ç«¯åˆ°ç«¯åº¦é‡ä½“ç³» æ–‡åŒ–å˜é©ï¼šä»\u0026quot;è´£å¤‡æ–‡åŒ–\u0026quot;åˆ°\u0026quot;å­¦ä¹ æ–‡åŒ–\u0026quot;ï¼Œé¼“åŠ±é€æ˜ä¸åˆ†äº« å››ã€å‘å±•è¶‹åŠ¿ä¸å‰ç» 4.1 æ™ºèƒ½åŒ–è¿ç»´(AIOps)æ·±åº¦æ¼”è¿› å®æ–½è·¯å¾„ï¼šå•ç‚¹åœºæ™¯(å¼‚å¸¸æ£€æµ‹) -\u0026gt; å‚ç›´é¢†åŸŸ(æ—¥å¿—åˆ†æ) -\u0026gt; æ¨ªå‘æ‰“é€š(å…¨æ ˆæ™ºèƒ½) å…³é”®æŠ€æœ¯ï¼š æ—¶åºæ•°æ®åˆ†æï¼šLSTMã€Prophetç­‰ç®—æ³•é¢„æµ‹æŒ‡æ ‡è¶‹åŠ¿ å¼‚å¸¸æ£€æµ‹ï¼šæ— ç›‘ç£å­¦ä¹ è‡ªåŠ¨å‘ç°å¼‚å¸¸æ¨¡å¼ æ ¹å› åˆ†æï¼šçŸ¥è¯†å›¾è°±+å› æœæ¨ç†å®šä½é—®é¢˜æ ¹æº æˆç†Ÿåº¦æ¨¡å‹ï¼šä»\u0026quot;äººå·¥å†³ç­–+å·¥å…·è¾…åŠ©\u0026quot;åˆ°\u0026quot;äººæœºååŒ\u0026quot;å†åˆ°\u0026quot;è‡ªä¸»è¿ç»´\u0026quot; å®è·µæ¡ˆä¾‹ï¼šæŸé“¶è¡Œé€šè¿‡AIOpså¹³å°ï¼Œæå‰45åˆ†é’Ÿé¢„æµ‹æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆï¼Œé¿å…äº†å¯èƒ½çš„äº¤æ˜“ä¸­æ–­ 4.2 äº‘åŸç”Ÿè¿ç»´æ–°èŒƒå¼ æ ¸å¿ƒè½¬å˜ï¼š ä»\u0026quot;ç®¡ç†æœåŠ¡å™¨\u0026quot;åˆ°\u0026quot;ç®¡ç†æœåŠ¡\u0026quot; ä»\u0026quot;é™æ€é…ç½®\u0026quot;åˆ°\u0026quot;åŠ¨æ€ç¼–æ’\u0026quot; ä»\u0026quot;æ•…éšœæ¢å¤\u0026quot;åˆ°\u0026quot;è‡ªæ„ˆèƒ½åŠ›\u0026quot; å…³é”®æŠ€æœ¯æ ˆï¼š å®¹å™¨è¿è¡Œæ—¶ï¼šDockerã€containerd ç¼–æ’å¹³å°ï¼šKubernetesåŠç”Ÿæ€ æœåŠ¡æ²»ç†ï¼šIstioã€Linkerd å¯è§‚æµ‹æ€§ï¼šPrometheusã€OpenTelemetry è¿è¥æ¨¡å¼ï¼šå¹³å°å·¥ç¨‹(Platform Engineering)ï¼Œå†…éƒ¨å¼€å‘è€…å¹³å°(IDP)å»ºè®¾ 4.3 ä»·å€¼å¯¼å‘è¿ç»´(ValueOps) ä»·å€¼åº¦é‡ä½“ç³»ï¼š\n"},{"id":14,"href":"/operations/jenkins/faq/","title":"Jenkins FAQ","parent":"Jenkins","content":"å†…å®¹ï¼š\nJenkins åŸºç¡€æ¦‚å¿µ Jenkins æ¶æ„ä¸é›†ç¾¤ Jenkins Pipelineï¼ˆDeclarative/Scriptedï¼‰ Jenkins è¿ç»´ä¸ä¼˜åŒ– Jenkins ä¸ Gitã€Dockerã€Kubernetesã€DevOps åœºæ™¯ ä¸€ã€Jenkins åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Jenkinsï¼Ÿ Jenkins æ˜¯ä¸€ä¸ªå¼€æºçš„ CI/CD è‡ªåŠ¨åŒ–ç³»ç»Ÿï¼Œç”¨äºæŒç»­é›†æˆã€æŒç»­äº¤ä»˜ã€è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰å„ç§ä»»åŠ¡ã€‚\næ ¸å¿ƒç‰¹ç‚¹ï¼š\næ’ä»¶ä¸°å¯Œï¼ˆ1800+ï¼‰ æ”¯æŒ Pipeline åˆ†å¸ƒå¼æ„å»ºï¼ˆMaster/Agent æ¨¡å¼ï¼‰ æ”¯æŒå¤šç§ SCMï¼ˆGitã€SVNã€GitHub/GitLab ç­‰ï¼‰ ä¸°å¯Œçš„è§¦å‘æ–¹å¼ï¼ˆWebhookã€å®šæ—¶ã€æ‰‹åŠ¨ã€å¤šåˆ†æ”¯ï¼‰ 2. Jenkins çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ Jenkins Masterï¼ˆControllerï¼‰ è´Ÿè´£ UIã€ä»»åŠ¡è°ƒåº¦ã€æ’ä»¶ç®¡ç†ã€é›†ç¾¤ç®¡ç† Jenkins Agentï¼ˆNodeï¼‰ çœŸæ­£æ‰§è¡Œæ„å»ºä»»åŠ¡ Executor æ¯ä¸ª Agent å†…çš„æ‰§è¡Œçº¿ç¨‹æ•° Plugin æ’ä»¶ç³»ç»Ÿ Job / é¡¹ç›® Pipelineï¼ˆJenkinsfileï¼‰ 3. Jenkins æœ‰å“ªäº›å¸¸è§ Job ç±»å‹ï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Job ç±»å‹ ç”¨é€” ç‰¹ç‚¹ Freestyle Project ä¼ ç»Ÿ Job é…ç½®ç®€å•ï¼Œä½†æ‰©å±•æ€§å·® Pipeline Jenkinsfile é©±åŠ¨ æ”¯æŒå®Œæ•´ CI/CD ä»£ç åŒ– Multibranch Pipeline è‡ªåŠ¨æ‰«æå¤šåˆ†æ”¯ æ”¯æŒ Git Flow Folder ç»„ç»‡ Job ç»“æ„åŒ–ç®¡ç† GitHub Organization è‡ªåŠ¨ç®¡ç†æ•´ä¸ª GitHub org å¤§å‹å›¢é˜Ÿå¸¸ç”¨ ç°åœ¨å¤§å¤šæ•°ä¼ä¸šéƒ½é‡‡ç”¨ Multibranch Pipeline + Jenkinsfileã€‚\n4. Jenkins å’Œ GitLab CIã€GitHub Actions æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ CI/CD ä¼˜ç‚¹ ç¼ºç‚¹ Jenkins çµæ´»ã€æ’ä»¶å¤šã€è‡ªå»ºã€å®‰å…¨æ€§å¼º éœ€è¦è¿ç»´ã€æ’ä»¶å…¼å®¹é—®é¢˜ GitLab CI å†…ç½®åœ¨ GitLab ä¸­ã€æ— éœ€å¤æ‚è¿ç»´ æ•´ä½“æ€§èƒ½å— GitLab å½±å“ GitHub Actions è‡ªå¸¦ GitHubã€ç®€å•æ˜“ç”¨ã€äº‹ä»¶é©±åŠ¨ ç§æœ‰ Runner éœ€è¦è¿ç»´ ç®€è€Œè¨€ä¹‹ï¼š\nå¤§å‹ä¼ä¸š -\u0026gt; Jenkins ä¸­å‹å›¢é˜Ÿ -\u0026gt; GitLab CI GitHub ç¤¾åŒºé¡¹ç›® -\u0026gt; GitHub Actions äºŒã€Jenkins æ¶æ„ä¸é›†ç¾¤ 5. Jenkins å¦‚ä½•å®ç°åˆ†å¸ƒå¼æ„å»ºï¼Ÿ é€šè¿‡ Masterï¼ˆControllerï¼‰+ Agentï¼ˆNodeï¼‰ æ¨¡å¼ï¼š\nAgent è¿æ¥æ–¹å¼ï¼š\nSSHï¼ˆæœ€å¸¸ç”¨ï¼‰ JNLP Docker Agent Kubernetes Agentï¼ˆCloudï¼‰ ä¼˜åŠ¿ï¼š\nåˆ†æ‹…æ„å»ºå‹åŠ› ä½¿ç”¨ä¸åŒç¯å¢ƒï¼ˆLinux/Windows/macOSï¼‰ æ‰©å¤§æ¨ªå‘æ‰©å®¹èƒ½åŠ› 6. å¦‚ä½•æé«˜ Jenkins çš„æ‰©å±•æ€§ï¼Ÿ ä½¿ç”¨ Master + å¤š Agent ä½¿ç”¨ Kubernetes åŠ¨æ€ Agentï¼ˆä¼ä¸šæœ€ä½³æ–¹æ¡ˆï¼‰ ç‹¬ç«‹æ„å»ºèµ„æºï¼Œé¿å… Master æ‰§è¡Œä»»åŠ¡ é€šè¿‡ NFS/å¯¹è±¡å­˜å‚¨å­˜æ”¾æ„å»ºç¼“å­˜ ä½¿ç”¨ nginx åšåå‘ä»£ç† ä½¿ç”¨ CasCï¼ˆConfiguration as Codeï¼‰è‡ªåŠ¨åŒ–ç®¡ç† Jenkins 7. Jenkins å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿï¼ˆHAï¼‰ å¸¸è§æ–¹æ¡ˆï¼š\nActive-Backupï¼ˆæœ€å¸¸ç”¨ï¼‰\nä¸¤å° Jenkins Master å…±äº« NFSï¼ˆJENKINS_HOMEï¼‰ Keepalived + VIP -\u0026gt; ä¸»æŒ‚äº†ï¼Œå¤‡ç«‹åˆ»æ¥ç®¡\nKubernetes + StatefulSet + RWO PVC\n-\u0026gt; é›†ç¾¤è‡ªåŠ¨é‡å»º\næ‹†åˆ† Master ä¸ Agents\nä½¿ç”¨ CasC è‡ªåŠ¨æ¢å¤é…ç½®\n8. Jenkins JENKINS_HOME ç›®å½•åŒ…å«ä»€ä¹ˆï¼Ÿ Job é…ç½®ï¼ˆconfig.xmlï¼‰ Jenkins å…¨å±€é…ç½® æ’ä»¶ \u0026amp; æ’ä»¶é…ç½® æ„å»ºè®°å½• å‡­æ®ï¼ˆCredentialsï¼‰ Script Console è„šæœ¬ å¤‡ä»½ Jenkins = å¤‡ä»½ JENKINS_HOMEã€‚\nä¸‰ã€Jenkins Pipelineï¼ˆDeclarative \u0026amp; Scriptedï¼‰ 9. Declarative Pipeline å’Œ Scripted Pipeline åŒºåˆ«ï¼Ÿ ç±»å‹ Declarative Scripted ç»“æ„ å¼ºç»“æ„ï¼Œå›ºå®šå­—æ®µ çµæ´»ã€Groovy è„šæœ¬ éš¾åº¦ ç®€å• è¾ƒéš¾ ä¼ä¸šå¸¸ç”¨ â­â­â­â­â­ â­â­â­â­ Declarative ä¾‹å­ï¼š\npipeline { agent any stages { stage(\u0026#39;Build\u0026#39;) { steps { echo \u0026#34;Hello\u0026#34; } } } } Scripted ä¾‹å­ï¼š\nnode { stage(\u0026#39;Build\u0026#39;) { echo \u0026#34;Hello\u0026#34; } } 10. Jenkinsfile ä¸­å¸¸è§çš„è§¦å‘æ–¹å¼ï¼Ÿ æ‰‹åŠ¨è§¦å‘\nCronï¼š\ntriggers { cron(\u0026#39;H 2 * * *\u0026#39;) } GitHub Webhook\nPoll SCM\ninput æ‰‹åŠ¨ç¡®è®¤\n11. å¦‚ä½•åœ¨ Jenkinsfile ä½¿ç”¨ Credentialsï¼Ÿ withCredentials([string(credentialsId: \u0026#39;token\u0026#39;, variable: \u0026#39;TK\u0026#39;)]) { sh \u0026#34;echo $TK\u0026#34; } SSH Keyï¼š\nsshagent([\u0026#39;github-ssh\u0026#39;]) { sh \u0026#39;git pull\u0026#39; } 12. Jenkinsfile ä¸­å¦‚ä½•åšåˆ†æ”¯æ§åˆ¶ï¼Ÿï¼ˆé‡ç‚¹ï¼‰ when { branch \u0026#39;main\u0026#39; } æˆ–ï¼š\nwhen { anyOf { branch \u0026#39;main\u0026#39; branch pattern: \u0026#34;release/.*\u0026#34;, comparator: \u0026#34;REGEXP\u0026#34; } } 13. å¦‚ä½•å¤„ç† Pipeline ä¸­æ–­ï¼Ÿ timeout(time: 5, unit: \u0026#39;MINUTES\u0026#39;) { // your steps } æˆ–ï¼š\ncatchError(buildResult: \u0026#39;FAILURE\u0026#39;) { sh \u0026#34;make test\u0026#34; } å››ã€Jenkins è¿ç»´ä¸ä¼˜åŒ– 14. Jenkins æ€ä¹ˆåšå¤‡ä»½ï¼Ÿ æœ€ç®€å•ï¼š\nåœæ­¢ Jenkins å‹ç¼© $JENKINS_HOME ä¼ä¸šçº§ï¼š\nå¤‡ä»½ JENKINS_HOME CasC å¤‡ä»½é…ç½® ä½¿ç”¨ NFS / S3 åç«¯ ä½¿ç”¨ Jenkins Backup æ’ä»¶ 15. Jenkins æ€§èƒ½ä¼˜åŒ–æ€ä¹ˆåšï¼Ÿ ç¦æ­¢ Master æ‰§è¡Œ Jobï¼ˆ0 executorsï¼‰\nå‡å°‘ä¸å¿…è¦æ’ä»¶ï¼ˆç‰¹åˆ«æ˜¯ Blue Oceanã€Build Pipeline Viewï¼‰\nå®šæœŸæ¸…ç†è€æ„å»ºè®°å½•\nä¼˜åŒ– JVM å‚æ•°ä¾‹å¦‚ï¼š\n-Xms2G -Xmx4G -XX:+UseG1GC ä½¿ç”¨ Kubernetes åŠ¨æ€ Agent\nä½¿ç”¨å¤–éƒ¨ç¼“å­˜ï¼ˆMaven/Gradle ç¼“å­˜ï¼‰\n16. å¦‚ä½•æ’æŸ¥ Jenkins æ„å»ºé€Ÿåº¦æ…¢ï¼Ÿ ä» 3 ä¸ªæ–¹å‘ï¼š\nJenkins æœ¬èº« CPU/å†…å­˜ä¸è¶³ æ’ä»¶è¿‡å¤š Agent æ€§èƒ½é—®é¢˜ IOã€CPUã€ç½‘ç»œ æ„å»ºä»»åŠ¡æœ¬èº« Docker Pull å¾ˆæ…¢ Maven ä¸‹è½½ä¾èµ–æ…¢ï¼ˆæ¢æºï¼‰ äº”ã€Jenkins ä¸ DevOpsï¼ˆGitã€Dockerã€K8Sï¼‰ 17. Jenkins ä¸ GitHub Webhook åŒºåˆ«ï¼Ÿ Webhookï¼šä¸»åŠ¨æ¨é€\nJenkins ç«‹å³æ‰§è¡Œ\nPoll SCMï¼šè½®è¯¢æ‹‰å–\næ¯å‡ åˆ†é’Ÿå» GitHub æ‹‰ä¸€æ¬¡ -\u0026gt; å®¹æ˜“è¢« GitHub é™åˆ¶ ä¼ä¸šç»Ÿä¸€ä½¿ç”¨ Webhookã€‚\n18. Jenkins å¦‚ä½•æ„å»º Docker é•œåƒï¼Ÿ Docker Pipelineï¼š\ndocker.build(\u0026#34;repo/app:${env.BUILD_NUMBER}\u0026#34;) æ¨é€é•œåƒï¼š\nwithCredentials([usernamePassword(credentialsId: \u0026#39;dockerhub\u0026#39;, usernameVariable: \u0026#39;USER\u0026#39;, passwordVariable: \u0026#39;PASS\u0026#39;)]) { sh \u0026#34;docker login -u $USER -p $PASS\u0026#34; sh \u0026#34;docker push repo/app:${env.BUILD_NUMBER}\u0026#34; } 19. Jenkins å¦‚ä½•éƒ¨ç½²åˆ° Kubernetesï¼Ÿ æœ€ç®€ç¤ºä¾‹ï¼š\nsh \u0026#34;kubectl apply -f k8s/deployment.yaml\u0026#34; ä½¿ç”¨ kubeconfigï¼š\nwithCredentials([file(credentialsId: \u0026#39;kubeconfig\u0026#39;, variable: \u0026#39;KCFG\u0026#39;)]) { sh \u0026#34;kubectl --kubeconfig=$KCFG apply -f k8s/\u0026#34; } 20. Jenkinsfile å¦‚ä½•åšç°åº¦å‘å¸ƒï¼Ÿ Blue/Green Canary K8S åˆ†æ‰¹æ»šåŠ¨ï¼ˆRollingUpdateï¼‰ åˆ©ç”¨ istio/nginx å®ç°æµé‡åˆ‡æ¢ ç¤ºä¾‹ï¼ˆK8Sï¼‰ï¼š\nsh \u0026#34;kubectl rollout restart deployment app\u0026#34; ","description":"å†…å®¹ï¼š\nJenkins åŸºç¡€æ¦‚å¿µ Jenkins æ¶æ„ä¸é›†ç¾¤ Jenkins Pipelineï¼ˆDeclarative/Scriptedï¼‰ Jenkins è¿ç»´ä¸ä¼˜åŒ– Jenkins ä¸ Gitã€Dockerã€Kubernetesã€DevOps åœºæ™¯ ä¸€ã€Jenkins åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Jenkinsï¼Ÿ Jenkins æ˜¯ä¸€ä¸ªå¼€æºçš„ CI/CD è‡ªåŠ¨åŒ–ç³»ç»Ÿï¼Œç”¨äºæŒç»­é›†æˆã€æŒç»­äº¤ä»˜ã€è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰å„ç§ä»»åŠ¡ã€‚\næ ¸å¿ƒç‰¹ç‚¹ï¼š\næ’ä»¶ä¸°å¯Œï¼ˆ1800+ï¼‰ æ”¯æŒ Pipeline åˆ†å¸ƒå¼æ„å»ºï¼ˆMaster/Agent æ¨¡å¼ï¼‰ æ”¯æŒå¤šç§ SCMï¼ˆGitã€SVNã€GitHub/GitLab ç­‰ï¼‰ ä¸°å¯Œçš„è§¦å‘æ–¹å¼ï¼ˆWebhookã€å®šæ—¶ã€æ‰‹åŠ¨ã€å¤šåˆ†æ”¯ï¼‰ 2. Jenkins çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ Jenkins Masterï¼ˆControllerï¼‰ è´Ÿè´£ UIã€ä»»åŠ¡è°ƒåº¦ã€æ’ä»¶ç®¡ç†ã€é›†ç¾¤ç®¡ç† Jenkins Agentï¼ˆNodeï¼‰ çœŸæ­£æ‰§è¡Œæ„å»ºä»»åŠ¡ Executor æ¯ä¸ª Agent å†…çš„æ‰§è¡Œçº¿ç¨‹æ•° Plugin æ’ä»¶ç³»ç»Ÿ Job / é¡¹ç›® Pipelineï¼ˆJenkinsfileï¼‰ 3. Jenkins æœ‰å“ªäº›å¸¸è§ Job ç±»å‹ï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ Job ç±»å‹ ç”¨é€” ç‰¹ç‚¹ Freestyle Project ä¼ ç»Ÿ Job é…ç½®ç®€å•ï¼Œä½†æ‰©å±•æ€§å·® Pipeline Jenkinsfile é©±åŠ¨ æ”¯æŒå®Œæ•´ CI/CD ä»£ç åŒ– Multibranch Pipeline è‡ªåŠ¨æ‰«æå¤šåˆ†æ”¯ æ”¯æŒ Git Flow Folder ç»„ç»‡ Job ç»“æ„åŒ–ç®¡ç† GitHub Organization è‡ªåŠ¨ç®¡ç†æ•´ä¸ª GitHub org å¤§å‹å›¢é˜Ÿå¸¸ç”¨ ç°åœ¨å¤§å¤šæ•°ä¼ä¸šéƒ½é‡‡ç”¨ Multibranch Pipeline + Jenkinsfileã€‚\n"},{"id":15,"href":"/operations/kafka/faq/","title":"Kafka FAQ","parent":"Kafka","content":"å†…å®¹ï¼šåŸºç¡€ã€åŸç†ã€ç”Ÿäº§ã€æ¶ˆè´¹ã€å­˜å‚¨ã€åˆ†åŒºã€å‰¯æœ¬ã€äº‹åŠ¡ã€è°ƒä¼˜ã€è¿ç»´ã€æ•…éšœç­‰ã€‚\n1. Kafka ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿåº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ Kafka å¿«çš„åŸå› ä¸»è¦æœ‰ 5 ç‚¹ï¼š\né¡ºåºå†™ç£ç›˜ï¼ˆSequential Writeï¼‰\nKafka çš„ log segment æ˜¯è¿½åŠ å†™ï¼Œç£ç›˜é¡ºåºå†™æ¯”éšæœºå†™å¿«å‡ ä¸ªæ•°é‡çº§ã€‚\né›¶æ‹·è´ï¼ˆZero Copyï¼‰\nä½¿ç”¨ sendfile()ï¼Œæ•°æ®ç›´æ¥ä» Page Cache -\u0026gt; NICï¼Œå‡å°‘ç”¨æˆ·æ€/å†…æ ¸æ€æ‹·è´ã€‚\nPage Cache å¼ºä¾èµ–\nKafka ä¸è‡ªå·±ç¼“å­˜æ•°æ®ï¼Œç›´æ¥åˆ©ç”¨ Linux PageCacheï¼Œæé«˜è¯»å†™æ€§èƒ½ã€‚\næ‰¹é‡å¤„ç†ï¼ˆBatch \u0026amp; Compressionï¼‰\nProducer æ‰¹é‡å†™ï¼ˆbatch.size + linger.msï¼‰ï¼ŒBroker ç«¯æ¶ˆæ¯å‹ç¼©ã€‚\nåˆ†åŒºå¹¶è¡Œï¼ˆPartition Parallelï¼‰\nTopic å¤šåˆ†åŒºå¹¶è¡Œè¯»å†™ï¼Œååçº¿æ€§æå‡ã€‚\n2. Kafka çš„ Topicã€Partitionã€Replica å„æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦è®¾è®¡æˆè¿™æ ·ï¼Ÿ Topicï¼šæ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ã€‚ Partitionï¼šå­˜å‚¨å’Œå¹¶è¡Œåº¦çš„æœ€å°å•ä½ã€‚åˆ†åŒºè¶Šå¤šï¼Œååè¶Šé«˜ã€‚ Replicaï¼šå‰¯æœ¬ï¼Œç”¨äºå®¹ç¾ä¸é«˜å¯ç”¨ã€‚ è®¾è®¡åˆ†åŒºæ˜¯å› ä¸ºï¼š\næå‡ååï¼ˆå¹¶è¡Œå†™å…¥/è¯»å–ï¼‰ æ”¯æŒé›†ç¾¤æ°´å¹³æ‰©å±• HA ä¾èµ–å‰¯æœ¬æœºåˆ¶ 3. Kafka çš„ ISR æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ ISR å…¨ç§° In-Sync Replicaï¼ˆåŒæ­¥å‰¯æœ¬é›†åˆï¼‰\nåªæœ‰åŒæ­¥è¿›åº¦è¶³å¤Ÿå¿«çš„ Follower æ‰èƒ½è¿›å…¥ ISR Leader æŒ‚æ‰æ—¶ åªèƒ½ä» ISR ä¸­é€‰æ–°çš„ Leader é…åˆ min.insync.replicas + acks=all ä¿è¯æ•°æ®ä¸ä¸¢ ISR æ˜¯ Kafka ä¿è¯é«˜å¯é æ€§ï¼ˆé«˜ä¸€è‡´æ€§ï¼‰çš„å…³é”®ã€‚\n4. Kafka çš„ HWã€LEOã€LSO åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ LEOï¼ˆLog End Offsetï¼‰ï¼šæ¯ä¸ªå‰¯æœ¬è‡ªå·±çš„å†™å…¥è¿›åº¦ã€‚ HWï¼ˆHigh Watermarkï¼‰ï¼šæ‰€æœ‰ ISR å‰¯æœ¬éƒ½åŒæ­¥åˆ°çš„æ•°æ®åç§»é‡ï¼Œæ¶ˆè´¹è€…åªèƒ½è¯»åˆ° HW ä»¥å†…çš„æ•°æ®ã€‚ LSOï¼šç”¨äºäº‹åŠ¡çš„é€»è¾‘ç‚¹ï¼ˆå¾ˆå°‘é—®ï¼‰ é‡ç‚¹ï¼š\næ¶ˆè´¹è€…åªèƒ½æ¶ˆè´¹åˆ° HW ä»¥å†…çš„æ¶ˆæ¯ï¼Œä¸ä¼šçœ‹åˆ°æœªåŒæ­¥å®Œæˆçš„æ•°æ®ã€‚\n5. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Ÿ â‘  ç”Ÿäº§ç«¯ï¼ˆProducerï¼‰ å¼€å¯å¹‚ç­‰æ€§ï¼š\nenable.idempotence=true å¼€å¯æœ€å¼ºå†™å…¥ç­–ç•¥ï¼š\nacks=all retries=âˆ â‘¡ Broker è®¾ç½®ï¼š\nmin.insync.replicas \u0026gt;= 2 replication.factor \u0026gt;= 3 â‘¢ æ¶ˆè´¹ç«¯ï¼ˆConsumerï¼‰ å…³é—­è‡ªåŠ¨æäº¤ offset æ‰‹åŠ¨åœ¨ä¸šåŠ¡å®Œæˆåæäº¤ offset 6. Kafka å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸é‡å¤ï¼Ÿ Producer ä½¿ç”¨å¹‚ç­‰æ€§ + äº‹åŠ¡ï¼š\nenable.idempotence=true transactional.id=xxx Consumer ä½¿ç”¨ å¹‚ç­‰æ¶ˆè´¹é€»è¾‘ï¼ˆå¦‚é€šè¿‡ä¸»é”®å”¯ä¸€çº¦æŸï¼‰\nç»™å‡ºä¸€å¥é‡‘å¥ï¼š\nKafka ä¿è¯ä¸ä¸¢ï¼Œä½†ä¸ä¿è¯ä¸é‡å¤ã€‚éœ€è¦ä¸šåŠ¡ç«¯å®ç°å¹‚ç­‰æ¶ˆè´¹ã€‚\n7. Kafka å¦‚ä½•åšåˆ° Exactly Onceï¼Ÿ åŒ…æ‹¬ 3 éƒ¨åˆ†ï¼š\nå¹‚ç­‰æ€§ Producer äº‹åŠ¡æ€§ Producerï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ äº‹åŠ¡æ€§æ¶ˆè´¹ï¼ˆcommit offset å†™å…¥åŒä¸€ä¸ªäº‹åŠ¡ï¼‰ è¿™æ˜¯ Kafka Streams å’Œ Flink æœ€ç»å…¸çš„åœºæ™¯ã€‚\n8. Kafka é‡å¹³è¡¡ï¼ˆRebalanceï¼‰æ˜¯ä»€ä¹ˆï¼Ÿå‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿ Rebalance = æ¶ˆè´¹è€…ç»„å†…éƒ¨æ¶ˆè´¹è€…å˜åŒ–æ—¶ï¼Œé‡æ–°åˆ†é…åˆ†åŒºã€‚\nå‘ç”Ÿåœ¨ï¼š\næ–° consumer åŠ å…¥ consumer é€€å‡º consumer å´©æºƒè¢«æ£€æµ‹åˆ°ï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰ åˆ†åŒºæ•°é‡å˜æ›´ï¼ˆalter partitionsï¼‰ group coordinator åˆ‡æ¢ å½±å“ï¼šæ¶ˆè´¹ä¼šæš‚åœï¼Œååä¸‹é™\nä¼˜åŒ–æ‰‹æ®µï¼š\nsession.timeout.ms è°ƒå¤§ max.poll.interval.ms é…ç½®åˆç† ä½¿ç”¨ Cooperative Rebalanceï¼ˆKafka 2.4+ï¼‰ é¿å…é¢‘ç¹é‡å¯ consumer 9. Kafka åˆ†åŒºè¶Šå¤šè¶Šå¥½å—ï¼Ÿ ç»ä¸æ˜¯ã€‚\nç¼ºç‚¹ï¼š\næ›´å¤šæ–‡ä»¶å¥æŸ„ æ›´å¤šç½‘ç»œè¿æ¥ Leader é€‰ä¸¾å¼€é”€æ›´å¤§ å»¶è¿Ÿä¸Šå‡ Controller è´Ÿè½½æ›´é«˜ rebalance æ›´æ…¢ æœ€ä½³åˆ†åŒºæ•°ç»éªŒï¼š\nåˆ†åŒº = ç”Ÿäº§åå / å•åˆ†åŒºæœ€å¤§åå ä¸šåŠ¡å³°å€¼ QPS å¤§ï¼Œå¯ä»¥å¤šç”¨ä¸€äº›åˆ†åŒºã€‚\n10. Kafka çš„ Zero-copy æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ é€šè¿‡ sendfile() ç³»ç»Ÿè°ƒç”¨å®ç°ï¼š\nç”¨æˆ·æ€ -\u0026gt; å†…æ ¸æ€ -\u0026gt; ç”¨æˆ·æ€ -\u0026gt; NIC å‡å°‘ä¸ºï¼š\nPageCache -\u0026gt; NIC ä¸ç»è¿‡ç”¨æˆ·æ€ï¼Œå‡å°‘æ‹·è´æ¬¡æ•°ï¼Œæé«˜ååã€‚\n11. Kafka çš„ Leader é€‰ä¸¾æµç¨‹ï¼Ÿ Zookeeper æ¨¡å¼ï¼š\nController ç›‘å¬ broker ä¸Šçº¿/ä¸‹çº¿äº‹ä»¶ å‘ç° Leader å®•æœº Controller ä» ISR ä¸­é€‰æ‹©æ–° Leader æ›´æ–°å…ƒæ•°æ®åˆ° ZK é€šçŸ¥æ‰€æœ‰ Broker KRaft æ¨¡å¼ï¼š\nä½¿ç”¨ Raft åè®®é€‰ä¸¾ ä¸ä¾èµ– Zookeeper 12. Kafka çš„æ¶ˆè´¹è€…æ˜¯æ¨æ¨¡å¼è¿˜æ˜¯æ‹‰æ¨¡å¼ï¼Ÿ æ‹‰æ¨¡å¼ï¼ˆPullï¼‰\nåŸå› ï¼š\nConsumer è‡ªè¡Œå†³å®šæ¶ˆè´¹é€Ÿåº¦ å‡å°‘ Broker å‹åŠ› å¯æ‰¹é‡æ‹‰å–ï¼Œæé«˜åå 13. Kafka Page Cache ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ Kafka ä¾èµ– OS Page Cache æå‡ï¼š\nå†™æ€§èƒ½ï¼ˆé¡ºåºå†™-\u0026gt;Page Cacheï¼‰ è¯»æ€§èƒ½ï¼ˆçƒ­æ•°æ®åœ¨ Cacheï¼‰ Kafka ä¸åšç”¨æˆ·æ€ç¼“å­˜ï¼Œå®Œå…¨æŠŠç¼“å­˜äº¤ç»™ Linuxã€‚\n14. Kafka æ€ä¹ˆé¿å…è„‘è£‚ï¼Ÿ é ä¸¤ä¸ªæœºåˆ¶ï¼š\nISR + min.insync.replicas\nåªæœ‰ ISR èƒ½é€‰ä¸º leader\nunclean.leader.election\nunclean.leader.election.enable=false é¿å…ä»ä¸åŒæ­¥çš„ Follower ä¸­é€‰ Leader å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚\n15. Kafka å¦‚ä½•å¤„ç†æ¶ˆæ¯ç§¯å‹ï¼ˆLagï¼‰ï¼Ÿ å¤„ç†ç­–ç•¥ï¼š\nå¢åŠ  Consumer å®ä¾‹ å¢åŠ  Topic åˆ†åŒº æå‡ Consumer poll æ‰¹é‡æ•° ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†æ¶ˆæ¯ Producer é™å‹ï¼ˆæ§åˆ¶å†™å…¥é€Ÿåº¦ï¼‰ å…³é”®å‘½ä»¤ï¼š\nkafka-consumer-groups.sh --describe --group xxx 16. Kafka ä¸­ Log Compaction æ˜¯ä»€ä¹ˆï¼Ÿ log.cleanup.policy = compact ä¿ç•™æ¯ä¸ª key çš„æœ€æ–° valueã€‚\né€‚ç”¨äºï¼š\nè´¦å·çŠ¶æ€ é…ç½®åŒæ­¥ å»é‡åœºæ™¯ 17. Kafka å¦‚ä½•å®ç°å¹‚ç­‰æ€§ Producerï¼Ÿ é  Producer IDï¼ˆPIDï¼‰+ sequence numberï¼ˆåºå·ï¼‰\nBroker æ£€æŸ¥æ˜¯å¦é‡å¤ï¼š\nå¦‚æœ seq ä¸ä¸Šæ¬¡ç›¸åŒ -\u0026gt; ä¸¢å¼ƒ å¦‚æœæ›´å¤§ -\u0026gt; æ­£å¸¸å†™å…¥ 18. Kafka é›†ç¾¤æ‰©å®¹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ æ‰© Broker åï¼š\nåˆ†åŒºä¸ä¼šè‡ªåŠ¨è¿ç§» éœ€è¦ reassign partitions æ‰‹åŠ¨å‡è¡¡ è¿™æ˜¯è¿ç»´å¸¸è§é™·é˜±ã€‚\n19. Kafka çš„äº‹åŠ¡åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ ä¸¤é˜¶æ®µæäº¤ï¼š\nPrepareï¼ˆå†™äº‹åŠ¡æ—¥å¿—ï¼‰ Commitï¼ˆæäº¤ Write + Offsetï¼‰ é€‚ç”¨äºï¼š\nExactly Once Kafka Streams Flink Connector 20. Kafka ä¸ RabbitMQ åŒºåˆ«ï¼Ÿ ç»´åº¦ Kafka RabbitMQ æ¨¡å‹ æ—¥å¿—ç³»ç»Ÿ æ¶ˆæ¯é˜Ÿåˆ— åå é«˜ï¼ˆç™¾ä¸‡çº§ï¼‰ ä¸­ä½ é¡ºåºæ€§ åˆ†åŒºå†…æœ‰åº é˜Ÿåˆ—å†…æœ‰åº å»¶è¿Ÿ ç¨é«˜ ä½ ä½¿ç”¨åœºæ™¯ å¤§æ•°æ®ã€æ—¥å¿—ã€é“¾è·¯è·Ÿè¸ª ä¸šåŠ¡æ¶ˆæ¯ã€ä»»åŠ¡é˜Ÿåˆ— Kafka æ˜¯åˆ†å¸ƒå¼æ—¥å¿—ç³»ç»Ÿï¼ŒRabbitMQ æ˜¯ç”¨äºä¸šåŠ¡è§£è€¦çš„ MQã€‚\n","description":"å†…å®¹ï¼šåŸºç¡€ã€åŸç†ã€ç”Ÿäº§ã€æ¶ˆè´¹ã€å­˜å‚¨ã€åˆ†åŒºã€å‰¯æœ¬ã€äº‹åŠ¡ã€è°ƒä¼˜ã€è¿ç»´ã€æ•…éšœç­‰ã€‚\n1. Kafka ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿåº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ Kafka å¿«çš„åŸå› ä¸»è¦æœ‰ 5 ç‚¹ï¼š\né¡ºåºå†™ç£ç›˜ï¼ˆSequential Writeï¼‰\nKafka çš„ log segment æ˜¯è¿½åŠ å†™ï¼Œç£ç›˜é¡ºåºå†™æ¯”éšæœºå†™å¿«å‡ ä¸ªæ•°é‡çº§ã€‚\né›¶æ‹·è´ï¼ˆZero Copyï¼‰\nä½¿ç”¨ sendfile()ï¼Œæ•°æ®ç›´æ¥ä» Page Cache -\u0026gt; NICï¼Œå‡å°‘ç”¨æˆ·æ€/å†…æ ¸æ€æ‹·è´ã€‚\nPage Cache å¼ºä¾èµ–\nKafka ä¸è‡ªå·±ç¼“å­˜æ•°æ®ï¼Œç›´æ¥åˆ©ç”¨ Linux PageCacheï¼Œæé«˜è¯»å†™æ€§èƒ½ã€‚\næ‰¹é‡å¤„ç†ï¼ˆBatch \u0026amp; Compressionï¼‰\nProducer æ‰¹é‡å†™ï¼ˆbatch.size + linger.msï¼‰ï¼ŒBroker ç«¯æ¶ˆæ¯å‹ç¼©ã€‚\nåˆ†åŒºå¹¶è¡Œï¼ˆPartition Parallelï¼‰\nTopic å¤šåˆ†åŒºå¹¶è¡Œè¯»å†™ï¼Œååçº¿æ€§æå‡ã€‚\n2. Kafka çš„ Topicã€Partitionã€Replica å„æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦è®¾è®¡æˆè¿™æ ·ï¼Ÿ Topicï¼šæ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ã€‚ Partitionï¼šå­˜å‚¨å’Œå¹¶è¡Œåº¦çš„æœ€å°å•ä½ã€‚åˆ†åŒºè¶Šå¤šï¼Œååè¶Šé«˜ã€‚ Replicaï¼šå‰¯æœ¬ï¼Œç”¨äºå®¹ç¾ä¸é«˜å¯ç”¨ã€‚ è®¾è®¡åˆ†åŒºæ˜¯å› ä¸ºï¼š\n"},{"id":16,"href":"/operations/kubernetes/faq/","title":"Kubernetes FAQ","parent":"Kubernetes","content":" ä¸€ã€Kubernetes åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Kubernetesï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ Kubernetes æ˜¯è‡ªåŠ¨åŒ–å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼Œä¸»è¦è§£å†³ï¼š\nè¦è§£å†³çš„é—®é¢˜ Kubernetes æä¾›çš„èƒ½åŠ› æœåŠ¡æ•°é‡å¤šã€æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ è‡ªåŠ¨éƒ¨ç½² Deployment æœåŠ¡éœ€è¦æ°´å¹³æ‰©ç¼©å®¹ HPAã€ReplicaSet æœåŠ¡ä¼šæ•…éšœ è‡ªåŠ¨è‡ªæ„ˆï¼ˆé‡å¯ Podã€æ¼‚ç§»èŠ‚ç‚¹ï¼‰ æœåŠ¡ä¹‹é—´éœ€è¦é€šä¿¡ Service / DNS éœ€è¦è·¨æœºæˆ¿éƒ¨ç½² æ§åˆ¶å¹³é¢ + å¹¿ä¹‰è°ƒåº¦ åº”ç”¨éœ€è¦å¯è§‚æµ‹æ€§ Eventsã€Logsã€Metrics 2. Pod æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥ç®¡ç†å®¹å™¨ï¼Ÿ Pod æ˜¯ Kubernetes æœ€å°è°ƒåº¦å•ä½ï¼Œå°è£…ä¸€ä¸ªæˆ–å¤šä¸ªå…±äº«ç½‘ç»œã€å…±äº«å­˜å‚¨çš„å®¹å™¨ã€‚\nåŸå› ï¼š\nå®¹å™¨ä¹‹é—´éœ€è¦å…±äº« IPã€ç«¯å£ã€Volumeã€‚ Kubernetes è°ƒåº¦çš„åŸºæœ¬å•ä½æ˜¯ Podï¼Œè€Œä¸æ˜¯å®¹å™¨ã€‚ Sidecar æ¨¡å¼ï¼ˆå¦‚ envoyã€log-agentï¼‰å¿…é¡»åœ¨åŒä¸€ä¸ª Pod æ‰èƒ½å…±äº«èµ„æºã€‚ 3. Deploymentã€StatefulSetã€DaemonSet åŒºåˆ«ï¼Ÿ Workload ä½¿ç”¨åœºæ™¯ ç‰¹ç‚¹ Deployment Webã€API æœåŠ¡ æ— çŠ¶æ€ã€éšæ„æ‰©ç¼©ã€æ»šåŠ¨æ›´æ–° StatefulSet DBã€MQã€Redisã€ElasticSearch æœ‰åºéƒ¨ç½²ã€æœ‰æŒä¹…å­˜å‚¨ã€ç¨³å®šDNS DaemonSet æ—¥å¿—æ”¶é›†ã€ç›‘æ§ã€ç½‘ç»œæ’ä»¶ æ¯ä¸ªèŠ‚ç‚¹éƒ½éƒ¨ç½²ä¸€ä¸ª ä»€ä¹ˆæ—¶å€™ç”¨ StatefulSetï¼Ÿ\nå½“ Pod éœ€è¦ç¨³å®šèº«ä»½ã€ç‹¬ç«‹å­˜å‚¨ã€é¡ºåºéƒ¨ç½²æ—¶ã€‚\näºŒã€è°ƒåº¦ã€Nodeã€Taint / Toleration 4. Kubernetes è°ƒåº¦æµç¨‹ï¼Ÿ Filterï¼ˆé¢„é€‰ï¼‰ï¼šèƒ½è·‘çš„èŠ‚ç‚¹ï¼Ÿï¼ˆèµ„æºã€æ±¡ç‚¹ã€äº²å’Œæ€§ï¼‰ Scoreï¼ˆæ‰“åˆ†ï¼‰ï¼šå“ªä¸ªèŠ‚ç‚¹æ›´é€‚åˆï¼Ÿ Bindï¼ˆç»‘å®šï¼‰ï¼šæŠŠ Pod æŒ‡å®šåˆ°èŠ‚ç‚¹ 5. èŠ‚ç‚¹ä¸å¯è°ƒåº¦æ€ä¹ˆå¤„ç†ï¼Ÿ å¯èƒ½çŠ¶æ€ï¼š\nNotReady MemoryPressure DiskPressure NetworkUnavailable æ’æŸ¥ï¼š\nkubectl describe node nodex journalctl -u kubelet -f 6. Taint / Toleration æ˜¯ä»€ä¹ˆï¼Ÿ Taintï¼šç»™èŠ‚ç‚¹è®¾ç½®é™åˆ¶\nTolerationï¼šPod çš„å®¹å¿ç­–ç•¥\nä½¿ç”¨åœºæ™¯ï¼š\nè®©éƒ¨åˆ†èŠ‚ç‚¹åªè·‘ç‰¹å®šä¸šåŠ¡ GPU èŠ‚ç‚¹éš”ç¦» master èŠ‚ç‚¹éš”ç¦» å‘½ä»¤ï¼š\nkubectl taint nodes node1 key=value:NoSchedule ä¸‰ã€Service / ç½‘ç»œ / Ingress 7. ClusterIPã€NodePortã€LoadBalancer åŒºåˆ«ï¼Ÿ ç±»å‹ é€‚ç”¨åœºæ™¯ ç‰¹ç‚¹ ClusterIP é›†ç¾¤å†…éƒ¨é€šä¿¡ é»˜è®¤ç±»å‹ NodePort å¤–éƒ¨è®¿é—® å ç”¨ node ç«¯å£ LoadBalancer äº‘å‚å•†è´Ÿè½½å‡è¡¡ ä¾èµ–äº‘å¹³å° 8. Service ä¸ºä»€ä¹ˆèƒ½è‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼Ÿ kube-proxy ç»´æŠ¤ iptables/ipvs è§„åˆ™ æ¯æ¬¡ Service æ›´æ–°ï¼Œkube-proxy é‡å†™è½¬å‘è§„åˆ™ å®¢æˆ·ç«¯è®¿é—® Virtual IPï¼ˆVIPï¼‰è‡ªåŠ¨è½®è¯¢ Endpoints Pod é‡å»ºå IP å˜äº†æ€ä¹ˆåŠï¼Ÿ\nService æ°¸ä¹…ä¸å˜ï¼ŒPod çš„ IP è‡ªåŠ¨æ›´æ–°åˆ° Endpointsã€‚\n9. Ingress æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå’Œ Service æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ Service æ˜¯â€œL4â€ï¼ŒIngress æ˜¯â€œL7â€ Ingress æ§åˆ¶å™¨è´Ÿè´£ï¼š URL è·¯ç”± HTTPSï¼ˆTLSï¼‰ åå‘ä»£ç† ä¸ƒå±‚è´Ÿè½½å‡è¡¡ å››ã€å­˜å‚¨ 10. PV / PVC / StorageClass åŒºåˆ«ï¼Ÿ æ¦‚å¿µ è§’è‰² ç±»æ¯” PV æŒä¹…å· äº‘ç›˜ PVC æŒä¹…å·ç”³è¯· äº‘ç›˜ç”³è¯·è®¢å• StorageClass è‡ªåŠ¨åˆ›å»º PV çš„æ¨¡æ¿ äº‘ç›˜è§„æ ¼ï¼ˆSSDã€HDDï¼‰ 11. StatefulSet å’Œ PVC çš„å…³ç³»ï¼Ÿ æ¯ä¸ª Pod ä¼šè‡ªåŠ¨åˆ›å»ºè‡ªå·±çš„ PVC PVC ä¸ä¼šå› ä¸º Pod é‡å»ºè€Œåˆ é™¤ æœ‰é¡ºåºæ€§ 0 -\u0026gt; 1 -\u0026gt; 2 äº”ã€Deployment / æ›´æ–° / å›æ»š 12. Deployment æ»šåŠ¨æ›´æ–°åŸç†ï¼Ÿ åˆ›å»ºæ–°çš„ ReplicaSetï¼ˆRSï¼‰ æŒ‰ç­–ç•¥ï¼ˆmaxUnavailable / maxSurgeï¼‰æ»šåŠ¨æ›¿æ¢ æ›¿æ¢å®Œæˆæ—§ RS ä¿ç•™ï¼ˆç”¨äºå›æ»šï¼‰ 13. å¦‚ä½•å¼ºåˆ¶æ›´æ–° latest é•œåƒï¼Ÿ imagePullPolicy: Always æˆ–\nkubectl rollout restart deploy/myapp 14. Pod ç”Ÿå‘½å‘¨æœŸ Pending Running Succeeded Failed Unknown å®¹å™¨çŠ¶æ€ï¼š\nWaitingï¼ˆæ‹‰é•œåƒï¼‰ Running Terminatedï¼ˆé€€å‡ºç ï¼‰ å…­ã€å®‰å…¨ã€RBACã€TLS 15. RBAC æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚\nå¯¹è±¡ï¼š\nRole / ClusterRole RoleBinding / ClusterRoleBinding ServiceAccount ä¾‹å¦‚ï¼š\nkubectl auth can-i get pods --as=system:serviceaccount:dev:tester 16. ä¸ºä»€ä¹ˆè®¿é—® apiserver ä¼šå‡ºç° x509 é”™è¯¯ï¼Ÿ åŸå› ï¼šè¯ä¹¦ SAN ä¸åŒ…å«è®¿é—®çš„ IP/åŸŸåã€‚\nè§£å†³ï¼š\nkubeadm init --apiserver-cert-extra-sans=\u0026#34;api.example.com,10.0.0.10\u0026#34; ä¸ƒã€æ•…éšœæ’æŸ¥ 17. Pod ä¸€ç›´å¤„äº Pendingï¼Ÿ å¸¸è§åŸå› ï¼š\nPVC æ— æ³•ç»‘å®šï¼ˆæ— å¯ç”¨ PVï¼‰ æ— å¯è°ƒåº¦èŠ‚ç‚¹ï¼ˆèµ„æºä¸è¶³ã€æ±¡ç‚¹ï¼‰ èŠ‚ç‚¹ Label ä¸åŒ¹é… èŠ‚ç‚¹ NotReady æ£€æŸ¥ï¼š\nkubectl describe pod pod-name kubectl get events --sort-by=.metadata.creationTimestamp 18. Pod CrashLoopBackOff å¦‚ä½•æ’æŸ¥ï¼Ÿ æŸ¥çœ‹æ—¥å¿—ï¼š\nkubectl logs pod --previous æŸ¥çœ‹å®¹å™¨å¯åŠ¨å‘½ä»¤ï¼š\nkubectl describe pod æ˜¯å¦æ¢é’ˆå¤±è´¥ï¼ˆliveness/readinessï¼‰ï¼š\nkubectl describe pod | grep -i probe 19. ImagePullBackOff å¦‚ä½•æ’æŸ¥ï¼Ÿ é•œåƒä¸å­˜åœ¨ Docker Hub é™æµ ç§æœ‰ä»“åº“ Secret é”™è¯¯ kubectl describe pod | grep -A3 \u0026#34;Image\u0026#34; 20. Node NotReady çš„åŸå› ï¼Ÿ kubelet é“¾ä¸ä¸Š API Server ç£ç›˜å‹åŠ› å†…å­˜å‹åŠ› ç½‘ç»œæ–­å¼€ containerd/cri dockerd å¤±è´¥ å…«ã€ç½‘ç»œï¼ˆè¿›é˜¶ï¼‰ 21. Pod ç½‘ç»œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ Calico ç¤ºä¾‹ï¼š\næ¯ä¸ª Pod æ‹¥æœ‰ç‹¬ç«‹ IPï¼ˆæ¥è‡ª CNI æ’ä»¶ï¼‰ CNI è´Ÿè´£åˆ›å»º Pod veth pair è·¯ç”±ç®¡ç†ç»Ÿä¸€ç”± Linux å†…æ ¸ + CNI ç»„ä»¶ç»´æŠ¤ Service ç”± kube-proxy æä¾›è½¬å‘ï¼ˆiptables/ipvsï¼‰ 22. Calicoã€Flannelã€Cilium åŒºåˆ«ï¼Ÿ ç½‘ç»œæ’ä»¶ ç‰¹ç‚¹ æŠ€æœ¯ Calicoï¼ˆæ¨èï¼‰ é«˜æ€§èƒ½ã€BGPã€eBPF è·¯ç”±ä¸ºä¸» Flannel ç®€å•ã€å…¼å®¹æ€§é«˜ VXLANã€å°åŒ… Cilium eBPFã€L7ã€ç½‘ç»œå®‰å…¨ eBPF 23. iptables å’Œ ipvs åŒºåˆ«ï¼Ÿ é¡¹ iptables ipvs æ€§èƒ½ ä¸­ç­‰ é«˜ è¿æ¥è·Ÿè¸ª æœ‰ æ—  åŠŸèƒ½ å•æœºé˜²ç«å¢™ å››å±‚è´Ÿè½½å‡è¡¡ é€‚ç”¨ å°è§„æ¨¡ ä¸­å¤§å‹é›†ç¾¤ ä¹ã€etcd / æ§åˆ¶å¹³é¢ 24. etcd ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½æ»¡ç£ç›˜ï¼Ÿ Kubernetes æ‰€æœ‰çŠ¶æ€ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ etcd æ»¡ç£ç›˜ä¼šå¯¼è‡´ï¼š å†™å…¥å¤±è´¥ Leader é€‰ä¸¾å¤±è´¥ API Server æ— æ³•è¯»å†™ 25. kube-apiserverã€controller-managerã€scheduler èŒè´£ï¼Ÿ ç»„ä»¶ èŒè´£ kube-apiserver æ‰€æœ‰è¯·æ±‚å…¥å£ï¼Œè®¤è¯ã€æˆæƒã€å‡†å…¥ kube-controller-manager å‰¯æœ¬æ§åˆ¶ã€è‡ªæ„ˆã€Serviceã€Node æ§åˆ¶ kube-scheduler é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ kubelet ç®¡ç†æœ¬æœº Pod kube-proxy ç»´æŠ¤ Service è½¬å‘è§„åˆ™ åã€è¿ç»´ / ç”Ÿäº§ 26. å¦‚ä½•ä¼˜é›…å…³é—­ä¸€ä¸ª Podï¼Ÿ SIGTERMï¼ˆgrace periodï¼‰ readiness probe fail -\u0026gt; ä» LB ç§»é™¤ ç­‰å¾… preStop SIGKILLï¼ˆåˆ°è¾¾ timeoutï¼‰ 27. å¦‚ä½•éš”ç¦»ç”Ÿäº§ä¸æµ‹è¯•ç¯å¢ƒï¼Ÿ Namespace Taint/Toleration NetworkPolicy RBAC èŠ‚ç‚¹æ±  28. å¦‚ä½•é™åˆ¶ Pod çš„èµ„æºæ¶ˆè€—ï¼Ÿ resources: requests: cpu: 500m limits: cpu: 1 requests å†³å®šè°ƒåº¦ limits å†³å®šä¸Šé™ åä¸€ã€äº‘åŸç”Ÿ 29. ä»€ä¹ˆæ˜¯ Sidecarï¼Ÿæœ‰å“ªäº›ç”¨é€”ï¼Ÿ å…¸å‹ç”¨é€”ï¼š\nEnvoy / Istioï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰ æ—¥å¿—æ”¶é›†ï¼ˆfluentdï¼‰ ç›‘æ§ agent æ•°æ®åŒæ­¥ 30. ä¸ºä»€ä¹ˆç”Ÿäº§ç¯å¢ƒæœ€å¥½ä¸ç”¨ latestï¼Ÿ ä¸å¯é¢„æœŸ ä¸å¯å›æ»š ä¼šå¯¼è‡´èŠ‚ç‚¹ç¼“å­˜æ··ä¹± CICD æ— æ³•ç®¡ç†ç‰ˆæœ¬ ","description":" ä¸€ã€Kubernetes åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Kubernetesï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ Kubernetes æ˜¯è‡ªåŠ¨åŒ–å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼Œä¸»è¦è§£å†³ï¼š\nè¦è§£å†³çš„é—®é¢˜ Kubernetes æä¾›çš„èƒ½åŠ› æœåŠ¡æ•°é‡å¤šã€æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ è‡ªåŠ¨éƒ¨ç½² Deployment æœåŠ¡éœ€è¦æ°´å¹³æ‰©ç¼©å®¹ HPAã€ReplicaSet æœåŠ¡ä¼šæ•…éšœ è‡ªåŠ¨è‡ªæ„ˆï¼ˆé‡å¯ Podã€æ¼‚ç§»èŠ‚ç‚¹ï¼‰ æœåŠ¡ä¹‹é—´éœ€è¦é€šä¿¡ Service / DNS éœ€è¦è·¨æœºæˆ¿éƒ¨ç½² æ§åˆ¶å¹³é¢ + å¹¿ä¹‰è°ƒåº¦ åº”ç”¨éœ€è¦å¯è§‚æµ‹æ€§ Eventsã€Logsã€Metrics 2. Pod æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥ç®¡ç†å®¹å™¨ï¼Ÿ Pod æ˜¯ Kubernetes æœ€å°è°ƒåº¦å•ä½ï¼Œå°è£…ä¸€ä¸ªæˆ–å¤šä¸ªå…±äº«ç½‘ç»œã€å…±äº«å­˜å‚¨çš„å®¹å™¨ã€‚\n"},{"id":17,"href":"/operations/linux/","title":"Linux","parent":"Operations","content":"Document List:\nLinux æ ¸å¿ƒæ¦‚å¿µ Linux å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰ Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰ Linux ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ Linux è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices \u0026amp; Driversï¼‰ Linux è¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰ Linux cgroups Linux Namespace Linux NUMA Linux UnionFS libc overlay2 runc shell systemd systemd å’Œ runc ä¹‹é—´çš„å…³ç³» Linux å†…æ ¸ç©ºé—´äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿ ä¸ namespacesã€cgroups ç­‰ç­‰çš„å…³ç³» overlay2 ä¸ºä»€ä¹ˆå¯¹æ•°æ®åº“ä¸å‹å¥½ overlay2 å’Œ UnionFS çš„è”ç³» ä»ç¡¬ä»¶åˆ°å®¹å™¨ å®¹å™¨å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶èµ„æº æ•°æ®åº“ä¸ºä»€ä¹ˆä¸é€‚åˆè·‘åœ¨å®¹å™¨ ç¡¬ä»¶ å†…æ ¸ è™šæ‹ŸåŒ– å®¹å™¨åŒ– MySQL / PostgreSQL NUMA æœ€ä½³å®è·µ MySQL / PostgreSQL é’ˆå¯¹ cgroupsï¼ˆv2ï¼‰çš„è°ƒä¼˜æ¸…å• å¤šåº”ç”¨åœºæ™¯ NUMA å®è·µ æ€§èƒ½ä¼˜åŒ– Docker ä½¿ç”¨çš„æ˜¯å“ªä¸ªå†…æ ¸ Docker éƒ¨ç½²æ•°æ®åº“ vs å®¿ä¸»æœºç›´è£…æ•°æ®åº“ Drop Caches irqbalance journal Linux å†…æ ¸ \u0026#34;ä¸€è°ƒå°±ç¿»è½¦\u0026#34; å±é™©å‚æ•°æ¸…å• Linux å†…æ ¸ æ ¹æ® CPU å’Œ å†…å­˜ åŠ¨æ€è°ƒæ•´ Linux ç£ç›˜æŒ‚è½½ä¸æ€§èƒ½ä¼˜åŒ– Linux ç³»ç»Ÿï¼Œå†…ç½‘æœåŠ¡å™¨ï¼Œæœ‰æ²¡æœ‰å¿…è¦ç¦ç”¨ IPv6ï¼Ÿ Linux ç³»ç»Ÿæ•…éšœæ’æŸ¥ -- rpcbind lsblk nftables RHEL ç³»åˆ— vs Debian ç³»åˆ— RHEL ç³»åˆ—ç³»ç»Ÿåˆå§‹åŒ–æ–¹æ¡ˆ rsync swap swap | å¯ç”¨ swap | ç¦ç”¨ sysbench sysctl -- net.core.default_qdisc sysctl ä¼šåŠ è½½å“ªäº›ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼ŸåŠ è½½é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ systemctl systemd ç¯å¢ƒå˜é‡ PATH XFS log XFS ç¦ç”¨ atime å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨ å¦‚ä½•è®¡ç®—å†…å­˜å®é™…å‰©ä½™å¤šå°‘ æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰æ˜¯å¦åº”è¯¥å…³é—­ irqbalance æ—¥å¿—æ¸…ç† æ£€æŸ¥ç¡¬ç›˜æ˜¯ SSD è¿˜æ˜¯ HDD æ£€æŸ¥ç¡¬ç›˜è¯»å†™é€Ÿåº¦ ","description":"Document List:\nLinux æ ¸å¿ƒæ¦‚å¿µ Linux å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰ Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰ Linux ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ Linux è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices \u0026amp; Driversï¼‰ Linux è¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰ Linux cgroups Linux Namespace Linux NUMA Linux UnionFS libc overlay2 runc shell systemd systemd å’Œ runc ä¹‹é—´çš„å…³ç³» Linux å†…æ ¸ç©ºé—´äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿ ä¸ namespacesã€cgroups ç­‰ç­‰çš„å…³ç³» overlay2 ä¸ºä»€ä¹ˆå¯¹æ•°æ®åº“ä¸å‹å¥½ overlay2 å’Œ UnionFS çš„è”ç³» ä»ç¡¬ä»¶åˆ°å®¹å™¨ å®¹å™¨å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶èµ„æº æ•°æ®åº“ä¸ºä»€ä¹ˆä¸é€‚åˆè·‘åœ¨å®¹å™¨ ç¡¬ä»¶ å†…æ ¸ è™šæ‹ŸåŒ– å®¹å™¨åŒ– MySQL / PostgreSQL NUMA æœ€ä½³å®è·µ MySQL / PostgreSQL é’ˆå¯¹ cgroupsï¼ˆv2ï¼‰çš„è°ƒä¼˜æ¸…å• å¤šåº”ç”¨åœºæ™¯ NUMA å®è·µ æ€§èƒ½ä¼˜åŒ– Docker ä½¿ç”¨çš„æ˜¯å“ªä¸ªå†…æ ¸ Docker éƒ¨ç½²æ•°æ®åº“ vs å®¿ä¸»æœºç›´è£…æ•°æ®åº“ Drop Caches irqbalance journal Linux å†…æ ¸ \u0026#34;ä¸€è°ƒå°±ç¿»è½¦\u0026#34; å±é™©å‚æ•°æ¸…å• Linux å†…æ ¸ æ ¹æ® CPU å’Œ å†…å­˜ åŠ¨æ€è°ƒæ•´ Linux ç£ç›˜æŒ‚è½½ä¸æ€§èƒ½ä¼˜åŒ– Linux ç³»ç»Ÿï¼Œå†…ç½‘æœåŠ¡å™¨ï¼Œæœ‰æ²¡æœ‰å¿…è¦ç¦ç”¨ IPv6ï¼Ÿ Linux ç³»ç»Ÿæ•…éšœæ’æŸ¥ -- rpcbind lsblk nftables RHEL ç³»åˆ— vs Debian ç³»åˆ— RHEL ç³»åˆ—ç³»ç»Ÿåˆå§‹åŒ–æ–¹æ¡ˆ rsync swap swap | å¯ç”¨ swap | ç¦ç”¨ sysbench sysctl -- net.core.default_qdisc sysctl ä¼šåŠ è½½å“ªäº›ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼ŸåŠ è½½é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ systemctl systemd ç¯å¢ƒå˜é‡ PATH XFS log XFS ç¦ç”¨ atime å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨ å¦‚ä½•è®¡ç®—å†…å­˜å®é™…å‰©ä½™å¤šå°‘ æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰æ˜¯å¦åº”è¯¥å…³é—­ irqbalance æ—¥å¿—æ¸…ç† æ£€æŸ¥ç¡¬ç›˜æ˜¯ SSD è¿˜æ˜¯ HDD æ£€æŸ¥ç¡¬ç›˜è¯»å†™é€Ÿåº¦ "},{"id":18,"href":"/backend/python/loguru/tutorial/","title":"Loguru åŸºç¡€æ•™ç¨‹","parent":"Loguru","content":"loguru æ˜¯ Python æœ€å¥½ç”¨çš„æ—¥å¿—åº“ä¹‹ä¸€ï¼Œå‡ ä¹é›¶é…ç½®ã€è¯­æ³•ä¼˜é›…ã€åŠŸèƒ½å¼ºå¤§ï¼Œæ¯”æ ‡å‡†åº“ logging ç®€å•å¾ˆå¤šã€‚\n1. ğŸ“¦ å®‰è£… pip install loguru 2. ğŸš€ å¿«é€Ÿä¸Šæ‰‹ from loguru import logger logger.info(\u0026#34;Hello, Loguru!\u0026#34;) è¿è¡Œç›´æ¥è¾“å‡ºï¼š\n2025-11-30 18:19:10.123 | INFO | __main__: \u0026lt;module\u0026gt;: 3 - Hello, Loguru! é»˜è®¤å°±å¸¦æ—¶é—´ã€çº§åˆ«ã€æ–‡ä»¶åã€è¡Œå·ã€‚\n3. ğŸ“ åŸºæœ¬ç”¨æ³•ç¤ºä¾‹ 3.1 æ—¥å¿—çº§åˆ« Loguru é»˜è®¤æ”¯æŒï¼š\ntraceï¼ˆæ¯” debug æ›´ç»†ï¼‰ debug info successï¼ˆloguru ç‰¹æœ‰ï¼‰ warning error critical logger.debug(\u0026#34;è°ƒè¯•ä¿¡æ¯\u0026#34;) logger.info(\u0026#34;ä¸€èˆ¬ä¿¡æ¯\u0026#34;) logger.success(\u0026#34;æˆåŠŸæç¤º\u0026#34;) logger.error(\u0026#34;é”™è¯¯æç¤º\u0026#34;) 4. ğŸ¨ è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ logger.add(\u0026#34;app.log\u0026#34;, format=\u0026#34;{time:YYYY-MM-DD HH:mm:ss} | {level} | {message}\u0026#34;) ä½ å¯ä»¥è‡ªå®šä¹‰å­—æ®µï¼š\n{time} {level} {message} {file} {line} {function} {process} {thread} 5. âœ¨ æ·»åŠ æ–‡ä»¶æ—¥å¿—ï¼ˆè‡ªåŠ¨åˆ‡å‰²ã€å‹ç¼©ï¼‰ Loguru çš„æ€æ‰‹çº§åŠŸèƒ½ä¹‹ä¸€ï¼šè‡ªåŠ¨æŒ‰å¤§å°ã€æ—¶é—´åˆ‡å‰² + è‡ªåŠ¨ä¿ç•™æ•°é‡ + è‡ªåŠ¨å‹ç¼©\n5.1 æŒ‰å¤§å°åˆ‡å‰² logger.add(\u0026#34;app.log\u0026#34;, rotation=\u0026#34;10 MB\u0026#34;) 5.2 æŒ‰æ—¥æœŸåˆ‡å‰² logger.add(\u0026#34;app.log\u0026#34;, rotation=\u0026#34;00:00\u0026#34;) # æ¯å¤©é›¶ç‚¹ç”Ÿæˆæ–°æ—¥å¿— 5.3 æŒ‰æ—¶é—´é—´éš”åˆ‡å‰² logger.add(\u0026#34;app.log\u0026#34;, rotation=\u0026#34;1 week\u0026#34;) 5.4 è‡ªåŠ¨å‹ç¼©ä¸ä¿ç•™ logger.add(\u0026#34;app.log\u0026#34;, rotation=\u0026#34;10 MB\u0026#34;, retention=\u0026#34;30 days\u0026#34;, compression=\u0026#34;zip\u0026#34;) è¯´æ˜ï¼š\nretentionï¼šæ—¥å¿—ä¿å­˜æ—¶é—´ compressionï¼šâ€œzipâ€/â€œgzâ€/â€œbz2â€/â€œxzâ€ 6. ğŸ” æ—¥å¿—è¾“å‡ºåˆ°å¤šç›®æ ‡ï¼ˆç»ˆç«¯ + æ–‡ä»¶ï¼‰ logger.add(\u0026#34;app.log\u0026#34;) logger.info(\u0026#34;è¿™æ¡ä¼šåŒæ—¶æ‰“å°åˆ°ç»ˆç«¯å’Œæ–‡ä»¶\u0026#34;) 7. ğŸ”¥ æ•è·å¼‚å¸¸å †æ ˆ éå¸¸çˆ½çš„åŠŸèƒ½ï¼š\n@logger.catch def main(): 1 / 0 main() æ•ˆæœï¼šè‡ªåŠ¨æ‰“å°å®Œæ•´ tracebackï¼Œä¸éœ€è¦å†å†™ try/exceptã€‚\nå¦‚æœä½ æƒ³è‡ªå®šä¹‰çº§åˆ«ï¼š\n@logger.catch(level=\u0026#34;ERROR\u0026#34;) def run(): pass 8. ğŸ§© ä¸æ ‡å‡† logging å…¼å®¹ï¼ˆFastAPI ç­‰åœºæ™¯å¿…å¤‡ï¼‰ å¾ˆå¤šæ¡†æ¶ï¼ˆå¦‚ FastAPIã€uvicornï¼‰å†…éƒ¨ç”¨æ ‡å‡†åº“ loggingã€‚\nä½ å¯ä»¥æ‹¦æˆªå®ƒä»¬ï¼Œç»Ÿä¸€ç”¨ loguruï¼š\nimport logging from loguru import logger import sys class InterceptHandler(logging.Handler): def emit(self, record): logger_opt = logger.opt(depth=6, exception=record.exc_info) logger_opt.log(record.levelname, record.getMessage()) logging.basicConfig(handlers=[InterceptHandler()], level=0) logger.add(sys.stdout, level=\u0026#34;INFO\u0026#34;) FastAPI å¯ç›´æ¥æ•´åˆã€‚\n9. ğŸ“ æŒ‰æ¨¡å—åŠ¨æ€åˆ›å»ºæ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸ç”¨ï¼‰ logger.add(\u0026#34;logs/{time:YYYYMMDD}/{level}.log\u0026#34;, rotation=\u0026#34;1 day\u0026#34;, retention=\u0026#34;7 days\u0026#34;) æ•ˆæœï¼š\nlogs/20251130/INFO.log logs/20251130/ERROR.log ... 10. ğŸ§µ åŒæ­¥ + å¼‚æ­¥å®‰å…¨ Loguru æœ¬èº«çº¿ç¨‹å®‰å…¨ï¼Œä¹Ÿèƒ½ç”¨äº multiprocessingï¼Œä½†éœ€è¦æ³¨æ„ï¼š\nlogger.add(\u0026#34;app.log\u0026#34;, enqueue=True) enqueue=True ä½¿ç”¨é˜Ÿåˆ—ï¼Œä¿è¯å¤šè¿›ç¨‹ç¯å¢ƒä¸ä¼šæ—¥å¿—é”™ä¹±ã€‚\n11. ğŸ”§ ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼ˆç›´æ¥ç”¨ï¼‰ from loguru import logger import sys logger.remove() # ç§»é™¤é»˜è®¤æ§åˆ¶å°è¾“å‡º logger.add(sys.stdout, level=\u0026#34;INFO\u0026#34;, format=\u0026#34;\u0026lt;green\u0026gt;{time:YYYY-MM-DD HH:mm:ss}\u0026lt;/green\u0026gt; \u0026#34; \u0026#34;| \u0026lt;level\u0026gt;{level}\u0026lt;/level\u0026gt; \u0026#34; \u0026#34;| \u0026lt;cyan\u0026gt;{name}\u0026lt;/cyan\u0026gt;:\u0026lt;cyan\u0026gt;{line}\u0026lt;/cyan\u0026gt; \u0026#34; \u0026#34;- \u0026lt;level\u0026gt;{message}\u0026lt;/level\u0026gt;\u0026#34;) logger.add(\u0026#34;logs/app.log\u0026#34;, rotation=\u0026#34;100 MB\u0026#34;, retention=\u0026#34;14 days\u0026#34;, compression=\u0026#34;zip\u0026#34;, enqueue=True, encoding=\u0026#34;utf-8\u0026#34;) logger.success(\u0026#34;Loguru åˆå§‹åŒ–å®Œæ¯•ï¼\u0026#34;) è¿™å¥—é…ç½®é€‚ç”¨äºï¼š\nFastAPI Flask Django å®šæ—¶ä»»åŠ¡è„šæœ¬ åç«¯æœåŠ¡ Docker ç”Ÿäº§éƒ¨ç½² 12. ğŸ“š æ›´å¤šé«˜çº§åŠŸèƒ½ ğŸ“Œ åŠ¨æ€è¿‡æ»¤ä¸åŒçº§åˆ«æ—¥å¿—åˆ°ä¸åŒæ–‡ä»¶\nlogger.add(\u0026#34;error.log\u0026#34;, level=\u0026#34;ERROR\u0026#34;) logger.add(\u0026#34;info.log\u0026#34;, filter=lambda r: r[\u0026#34;level\u0026#34;].name == \u0026#34;INFO\u0026#34;) ğŸ“Œ å»¶è¿Ÿå†™å…¥ï¼ˆå‡å°‘ IOï¼‰\nlogger.add(\u0026#34;app.log\u0026#34;, buffer_size=1024) ","description":"loguru æ˜¯ Python æœ€å¥½ç”¨çš„æ—¥å¿—åº“ä¹‹ä¸€ï¼Œå‡ ä¹é›¶é…ç½®ã€è¯­æ³•ä¼˜é›…ã€åŠŸèƒ½å¼ºå¤§ï¼Œæ¯”æ ‡å‡†åº“ logging ç®€å•å¾ˆå¤šã€‚\n1. ğŸ“¦ å®‰è£… pip install loguru 2. ğŸš€ å¿«é€Ÿä¸Šæ‰‹ from loguru import logger logger.info(\u0026#34;Hello, Loguru!\u0026#34;) è¿è¡Œç›´æ¥è¾“å‡ºï¼š\n2025-11-30 18:19:10.123 | INFO | __main__: \u0026lt;module\u0026gt;: 3 - Hello, Loguru! é»˜è®¤å°±å¸¦æ—¶é—´ã€çº§åˆ«ã€æ–‡ä»¶åã€è¡Œå·ã€‚\n"},{"id":19,"href":"/operations/lvs/faq/","title":"LVS FAQ","parent":"LVS","content":"å†…å®¹ï¼šåŸºç¡€ã€åŸç†ã€æ¶æ„ã€æ’é”™ã€ä¸ Nginx/HAProxy å¯¹æ¯”ã€LVS å†…æ ¸æœºåˆ¶ã€Keepalived ç›¸å…³ç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µç±» 1. ä»€ä¹ˆæ˜¯ LVSï¼Ÿå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ LVSï¼ˆLinux Virtual Serverï¼‰æ˜¯å†…æ ¸çº§å››å±‚è´Ÿè½½å‡è¡¡æ¡†æ¶ã€‚\nä½œç”¨ï¼š\næä¾›é«˜å¹¶å‘ã€é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ æ”¯æŒ TCP/UDP å››å±‚åè®® é€šå¸¸é…åˆ Keepalived åšä¸»å¤‡ HA ä¼˜ç‚¹ï¼š\nå†…æ ¸è½¬å‘ -\u0026gt; æ€§èƒ½æé«˜ æ¶æ„ç®€å•ï¼Œç¨³å®šå¯é  é€‚åˆå¤§è§„æ¨¡ä¸šåŠ¡ 2. LVS çš„ä¸‰ç§å·¥ä½œæ¨¡å¼æ˜¯ä»€ä¹ˆï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ â‘  LVS-NATï¼ˆä¿®æ”¹æº/ç›®æ ‡åœ°å€ï¼‰ è¯·æ±‚å’Œå“åº”éƒ½ç»è¿‡ Directorï¼ˆç“¶é¢ˆï¼‰ RS é»˜è®¤è·¯ç”±æŒ‡å‘ Director æ”¯æŒä»»æ„ OS â‘¡ LVS-DRï¼ˆç›´æ¥è·¯ç”±ï¼‰ \u0026lt;- ç”Ÿäº§æœ€å¸¸ç”¨ Director åªæ”¶è¯·æ±‚ RS ç›´æ¥å›åŒ…ç»™å®¢æˆ·ç«¯ RS å¿…é¡»ä¸ Director åœ¨åŒä¸€äºŒå±‚ç½‘ç»œ éœ€è¦å…³é—­ ARP æŠ¢ç­” â‘¢ LVS-TUNï¼ˆIP éš§é“ï¼‰ ç”¨ IPIP éš§é“è½¬å‘è¯·æ±‚ RS å¯è·¨æœºæˆ¿ RS å›åŒ…ä¸ç»è¿‡ Director 3. LVS ä¼˜ç‚¹å’Œç¼ºç‚¹åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ ä¼˜ç‚¹ï¼š\nå†…æ ¸æ€è´Ÿè½½å‡è¡¡ -\u0026gt; æ€§èƒ½æå¼º è½¬å‘å¼€é”€æä½ æ”¯æŒç™¾ä¸‡å¹¶å‘ ç¨³å®šã€æˆç†Ÿã€å¯é  æ— éœ€ä¿®æ”¹åç«¯åº”ç”¨ ç¼ºç‚¹ï¼š\nä»…å››å±‚ï¼ˆTCP/UDPï¼‰ åŠŸèƒ½ç®€å•ï¼Œä¸æ”¯æŒä¸ƒå±‚ï¼ˆURL/COOKIE/HEADERï¼‰ é…ç½®ä¸ç›´è§‚ï¼Œå…³è” Keepalived ä¸æ”¯æŒ SSL ç»ˆæ­¢ DRæ¨¡å¼éœ€è¦äºŒå±‚ç½‘ç»œé™åˆ¶ äºŒã€å·¥ä½œåŸç†ç±» 4. LVS-DR æ¨¡å¼ä¸ºä»€ä¹ˆéœ€è¦å…³é—­ ARPï¼Ÿå¦‚ä½•å…³é—­ï¼Ÿ å› ä¸º Director å’Œ RS éƒ½ä¼šæŒæœ‰ VIPï¼Œ\nå¦‚æœ RS å›ç­” ARPï¼Œä¼šå¯¼è‡´å®¢æˆ·ç«¯ç›´æ¥è®¿é—®åˆ° RSï¼Œç»•è¿‡ LVSã€‚\nè§£å†³ï¼šRS ä¸Šè®¾ç½® ARP å¿½ç•¥å’Œ ARP å®£å‘Šè§„åˆ™ï¼š\nnet.ipv4.conf.all.arp_ignore = 1 net.ipv4.conf.all.arp_announce = 2 5. LVS æ˜¯å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡çš„ï¼Ÿ ä½¿ç”¨å†…æ ¸æ¨¡å— ip_vsï¼Œé€šè¿‡ï¼š\næ³¨å†Œè™šæ‹ŸæœåŠ¡ï¼ˆVIP + PORTï¼‰ æ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹© RS è½¬å‘åŒ…ï¼ˆDR/NAT/TUNï¼‰ ä½¿ç”¨è¿æ¥è·Ÿè¸ªåŒæ­¥ï¼ˆconntrackï¼‰ æ•°æ®ç»“æ„ï¼š\nip_vs_service ip_vs_dest ip_vs_conn 6. LVS ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ å®Œå…¨åœ¨å†…æ ¸æ€è½¬å‘ï¼Œä¸éœ€è¦ç”¨æˆ·æ€åˆ‡æ¢ åŸºäº hash table åšè¿æ¥è°ƒåº¦ æ— çŠ¶æ€ï¼ˆæˆ–å¼±çŠ¶æ€ï¼‰è½¬å‘ ä¸åšä¸ƒå±‚è§£æ ä¸‰ã€è°ƒåº¦ç®—æ³•ç±» 7. LVS æ”¯æŒå“ªäº›è°ƒåº¦ç®—æ³•ï¼Ÿå“ªå‡ ä¸ªæœ€å¸¸ç”¨ï¼Ÿ é™æ€ï¼š\nRRï¼ˆè½®è¯¢ï¼‰ WRRï¼ˆæƒé‡è½®è¯¢ï¼‰ SHï¼ˆæºåœ°å€ hashï¼‰ DHï¼ˆç›®æ ‡åœ°å€ hashï¼‰ åŠ¨æ€ï¼š\nLCï¼ˆæœ€å°‘è¿æ¥ï¼‰ WLCï¼ˆåŠ æƒæœ€å°‘è¿æ¥ï¼‰-\u0026gt; ç”Ÿäº§æœ€å¸¸ç”¨ SEDï¼ˆæœ€çŸ­æœŸæœ›å»¶è¿Ÿï¼‰ NQï¼ˆä¸æ’é˜Ÿï¼‰ ç”Ÿäº§ä½¿ç”¨æœ€å¤šçš„ï¼š\nWLC WRR SHï¼ˆç”¨äº session ä¿æŒï¼‰ 8. LVS å¦‚ä½•å®ç° session ç²˜æ»ï¼Ÿ ä¸¤ç§æ–¹å¼ï¼š\nè°ƒåº¦ç®—æ³•ä½¿ç”¨ SHï¼ˆæºåœ°å€ hashï¼‰ ä½¿ç”¨ persistence_timeoutï¼ˆä¼šè¯ä¿æŒæ—¶é—´ï¼‰ ä¾‹å¦‚ï¼š\npersistence_timeout 300 å››ã€æ¶æ„/éƒ¨ç½²ç±» 9. LVS + Keepalived æ¶æ„æ˜¯ä»€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ Keepalivedï¼Ÿ Keepalived ä½œç”¨ï¼š\nâ‘  VRRP å®ç° VIP æ¼‚ç§»ï¼ˆé«˜å¯ç”¨ï¼‰ â‘¡ å¥åº·æ£€æŸ¥ RSï¼ˆæ•…éšœç§»é™¤ï¼‰ â‘¢ è‡ªåŠ¨ç»´æŠ¤ ipvs è§„åˆ™ æ¶æ„ï¼š\nVIP - Keepalived (MASTER) VIP - Keepalived (BACKUP) | LVS (DR/NAT/TUN) | RS1/RS2/RS3 10. LVS DR æ¨¡å¼ä¸­ RS å¿…é¡»æ»¡è¶³å“ªäº›æ¡ä»¶ï¼Ÿ RS å’Œ LVS å¿…é¡»ä½äº åŒä¸€äºŒå±‚ç½‘ç»œ RS å¿…é¡»ç»‘å®š VIP åˆ° lo RS å¿…é¡»å…³é—­ ARP æŠ¢ç­” RS çš„ real IP å’Œç½‘å…³å¿…é¡»æ­£ç¡®é…ç½® 11. LVS-NAT ä¸ºä»€ä¹ˆæ›´å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Ÿ å› ä¸ºï¼š\nè¯·æ±‚å’Œå“åº”éƒ½ç»è¿‡ Director Director æ‰¿å—åŒå€æµé‡ NAT ä¿®æ”¹åŒ…å¤´ -\u0026gt; CPU è´Ÿè½½æ›´é«˜ DR æ¨¡å¼ä¸ä¼šã€‚\näº”ã€æ•…éšœæ’æŸ¥ç±» 12. è®¿é—® VIP æ— å“åº”ï¼Œä½† LVS é…ç½®æ­£å¸¸ï¼ŒåŸå› å¯èƒ½æ˜¯ä»€ä¹ˆï¼Ÿ å¸¸è§æ’æŸ¥æ–¹å‘ï¼š\nRS æœªå…³é—­ ARP -\u0026gt; æŠ¢ç­” VIP DR æ¨¡å¼ä¸­ RS ä¸ä¸ LVS åœ¨åŒä¸€ç½‘æ®µ é˜²ç«å¢™é˜»æ­¢ VRRP ç»„æ’­ï¼ˆKeepalivedï¼‰ RS å›åŒ…èµ°é”™è·¯ç”±ï¼ˆæ²¡æœ‰ direct returnï¼‰ èŠ‚ç‚¹æ²¡æœ‰ç»‘å®š VIP keepalived æœªç”Ÿæ•ˆ / é…ç½®å†™é”™ 13. VIP æ¼‚ç§»åä»è®¿é—®æ—§èŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆï¼Ÿ ARP ç¼“å­˜æœªåˆ·æ–°ã€‚\nè§£å†³åŠæ³•ï¼š\nKeepalived å¼€å¯ GARPï¼š\ngarp_master_delay 1 garp_master_refresh 5 garp_master_repeat 5 14. RS å¥åº·æ£€æŸ¥ä¸ç”Ÿæ•ˆï¼ŸåŸå› ï¼Ÿ TCP_CHECK ç«¯å£é”™è¯¯ RS é˜²ç«å¢™æ‹’ç»æ¢æµ‹æµé‡ è„šæœ¬æ£€æŸ¥ï¼ˆMISC_CHECKï¼‰æ— å¯æ‰§è¡Œæƒé™ Keepalived é…ç½®é¡ºåºé”™è¯¯ delay_loop è¿‡å¤§ å…­ã€å¯¹æ¯”ç±» 15. LVS ä¸ Nginxã€HAProxy çš„åŒºåˆ«ï¼Ÿé€‚ç”¨åœºæ™¯ï¼Ÿ LVS ä¼˜åŠ¿ï¼š\næœ€é«˜æ€§èƒ½ï¼ˆå†…æ ¸æ€è½¬å‘ï¼‰ å››å±‚è´Ÿè½½å‡è¡¡ éå¸¸ç¨³å®š LVS åŠ£åŠ¿ï¼š\nä¸æ”¯æŒä¸ƒå±‚ é…ç½®ä¸å¦‚ Nginx/HAProxy çµæ´» ä¸æ”¯æŒ SSLã€å‹ç¼©ã€URL/COOKIE è·¯ç”± HAProxy ä¼˜ç‚¹ï¼š\nå››å±‚ + ä¸ƒå±‚ å¥åº·æ£€æŸ¥èƒ½åŠ›æœ€å¼º æ€§èƒ½ä¹Ÿå¾ˆé«˜ï¼ˆç”¨æˆ·æ€ï¼‰ Nginx ä¼˜ç‚¹ï¼š\nä¸ƒå±‚èƒ½åŠ›å¼º é™æ€èµ„æºå¼º SSLã€Rewriteã€é™æµèƒ½åŠ›å¼º ç»“è®ºï¼š\nåœºæ™¯ é€‰æ‹© å››å±‚æé«˜æ€§èƒ½ LVS å››å±‚å’Œä¸ƒå±‚æ··åˆå¤æ‚è½¬å‘ HAProxy ä¸ƒå±‚èƒ½åŠ›å¼ºï¼Œéœ€è¦ URL/Cookie/SSL Nginx 16. ä¸ºä»€ä¹ˆå…¬å¸é€šå¸¸ä½¿ç”¨ã€ŒLVS + Nginxã€ï¼Ÿ æ¶æ„ï¼š\nLVSï¼ˆå››å±‚é«˜æ€§èƒ½ï¼‰ â†“ Nginxï¼ˆä¸ƒå±‚èƒ½åŠ›ï¼‰ â†“ Application ä¼˜ç‚¹ï¼š\nLVS æ‰¿æ‹…å·¨é‡ TCP é“¾æ¥ Nginx åšä¸ƒå±‚è·¯ç”±ã€é™æµã€å‹ç¼©ã€SSL æ›´çµæ´»ä¸”æ›´ç¨³å®š ä¸ƒã€æ·±å…¥åŸç†ç±»ï¼ˆä¸­é«˜çº§ï¼‰ 17. LVS å¦‚ä½•ä¿æŒé•¿è¿æ¥ï¼Œæ¯”å¦‚ Redis/TCPï¼Ÿ ä½¿ç”¨ï¼š\nDR/TUN æ¨¡å¼ï¼ˆåç«¯ç›´æ¥å›åŒ…ï¼‰ session ç²˜æ»ï¼ˆSH / persistence_timeoutï¼‰ 18. LVS çš„è¿æ¥åŒæ­¥ï¼ˆconn syncï¼‰æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨ï¼Ÿ ä¸¤ä¸ª LVS Directorï¼ˆä¸»/å¤‡ï¼‰ä¹‹é—´åŒæ­¥è¿æ¥çŠ¶æ€ï¼š\nsync_master # ä¸» sync_backup # å¤‡ ä½œç”¨ï¼š\nä¸»æœºæŒ‚æ‰æ—¶ï¼Œå¤‡æœºèƒ½ç»§ç»­å¤„ç†è¿æ¥ ä¿è¯æ— æ„Ÿåˆ‡æ¢ å¤§å‹ä¸šåŠ¡å¿…é¡»å¼€å¯ 19. LVS å¯¹ UDP çš„æ”¯æŒå¦‚ä½•ï¼Ÿ æ”¯æŒéå¸¸å¥½ã€‚\nUDP æ— è¿æ¥ï¼Œå› æ­¤ï¼š\nè°ƒåº¦ç®—æ³•ç®€å• æ— éœ€è¿æ¥è·Ÿè¸ª æ€§èƒ½æ›´é«˜ é€‚åˆ DNSã€æ¸¸æˆã€æ¨æµç­‰ä¸šåŠ¡ã€‚\n20. LVS å¦‚ä½•ä¿è¯ç¨³å®šæ€§ï¼Ÿä¸ºä»€ä¹ˆé€‚ç”¨äºå¤§è§„æ¨¡ä¸šåŠ¡ï¼Ÿ 20 å¹´ä»¥ä¸Šæˆç†Ÿé¡¹ç›® å®Œå…¨è¿è¡Œåœ¨ Linux å†…æ ¸ æ— ä¸šåŠ¡é€»è¾‘ï¼ŒåŠŸèƒ½æç®€ é“¾æ¥è¡¨ç»“æ„ä¼˜åŒ– Hash bucket å‡ ä¹ O(1) æŸ¥è¯¢ é…åˆ Keepalived èƒ½è‡ªåŠ¨åŒ– HA å’Œå¥åº·æ£€æŸ¥ å…«ã€ç»¼åˆåœºæ™¯é¢˜ï¼ˆä¸­é«˜çº§ï¼‰ 21. å…¬å¸æœ‰è·¨æœºæˆ¿æœåŠ¡ï¼Œé€‰æ‹©å“ªç§ LVS æ¨¡å¼ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ LVS-TUNï¼ˆTunnelingï¼‰\nç†ç”±ï¼š\nRS å¯ä»¥ä¸åœ¨åŒä¸€ç‰©ç†ç½‘æ®µ RS å¯ä»¥è·¨ä¸‰å±‚ã€è·¨åœ°åŸŸ DR æ¨¡å¼å¿…é¡»åœ¨äºŒå±‚ç½‘ç»œ -\u0026gt; ä¸æ»¡è¶³ 22. å¦‚æœåç«¯ Server éœ€è¦çœ‹åˆ°çœŸå®å®¢æˆ·ç«¯ IPï¼Œæ€ä¹ˆåŠï¼Ÿ DR/TUN æ¨¡å¼ï¼šRS èƒ½çœ‹åˆ°çœŸå® IP NAT æ¨¡å¼ï¼šçœ‹åˆ°çš„æ˜¯ LVS çš„ IPï¼Œéœ€è¦ç”¨ï¼š X-Forwarded-Forï¼ˆä¸ƒå±‚ï¼‰ æˆ–è€… DNAT ä¿ç•™æºåœ°å€ï¼ˆéœ€è¦é«˜çº§é…ç½®ï¼‰ 23. LVS æœ‰å“ªäº›å®‰å…¨éšæ‚£ï¼Ÿ VIP æŠ¢å ï¼ˆARPï¼‰ VRRP ç»„æ’­è¢«æ‹¦æˆªåå¯¼è‡´åˆ‡æ¢å¤±è´¥ æºåœ°å€æ¬ºéª—ï¼ˆDR/TUNæ¨¡å¼ï¼Œéœ€ ACLï¼‰ RS ç›´æ¥æš´éœ²çœŸå® IPï¼ˆå»ºè®®é˜²ç«å¢™é™åˆ¶ï¼‰ ä¹ã€è¿›é˜¶ 24. å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„è´Ÿè½½å‡è¡¡æ¶æ„ï¼Ÿ LVSï¼ˆå››å±‚ï¼‰ + Keepalivedï¼ˆHAï¼‰\nå†…éƒ¨åˆ†å‘ Nginx/HAProxyï¼ˆä¸ƒå±‚ï¼‰ åç«¯å¾®æœåŠ¡ / å®¹å™¨æœåŠ¡ èŠ‚ç‚¹å¥åº·æ£€æŸ¥ Auto Scaling æ—¥å¿—ã€ç›‘æ§ã€å‘Šè­¦ 25. å¦‚ä½•å¿«é€Ÿæ’æŸ¥ LVS æ•…éšœï¼Ÿï¼ˆä½ çš„æ€è·¯æ˜¯ä»€ä¹ˆï¼‰ æ£€æŸ¥ VIP æ˜¯å¦å­˜åœ¨ æ£€æŸ¥ LVS é…ç½®ï¼ˆipvsadm -Lnï¼‰ æ£€æŸ¥ Keepalived çŠ¶æ€ï¼ˆVIP æ˜¯å¦æ¼‚ç§»ï¼‰ æ£€æŸ¥ ARP æ˜¯å¦æ­£ç¡®ï¼ˆRSç«¯ï¼‰ æ£€æŸ¥è·¯ç”±å›åŒ…é“¾è·¯ æŠ“åŒ…åˆ†æï¼ˆtcpdump -i eth0 host VIPï¼‰ æŸ¥çœ‹å¥åº·æ£€æŸ¥æ—¥å¿— ","description":"å†…å®¹ï¼šåŸºç¡€ã€åŸç†ã€æ¶æ„ã€æ’é”™ã€ä¸ Nginx/HAProxy å¯¹æ¯”ã€LVS å†…æ ¸æœºåˆ¶ã€Keepalived ç›¸å…³ç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µç±» 1. ä»€ä¹ˆæ˜¯ LVSï¼Ÿå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ LVSï¼ˆLinux Virtual Serverï¼‰æ˜¯å†…æ ¸çº§å››å±‚è´Ÿè½½å‡è¡¡æ¡†æ¶ã€‚\nä½œç”¨ï¼š\næä¾›é«˜å¹¶å‘ã€é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ æ”¯æŒ TCP/UDP å››å±‚åè®® é€šå¸¸é…åˆ Keepalived åšä¸»å¤‡ HA ä¼˜ç‚¹ï¼š\nå†…æ ¸è½¬å‘ -\u0026gt; æ€§èƒ½æé«˜ æ¶æ„ç®€å•ï¼Œç¨³å®šå¯é  é€‚åˆå¤§è§„æ¨¡ä¸šåŠ¡ 2. LVS çš„ä¸‰ç§å·¥ä½œæ¨¡å¼æ˜¯ä»€ä¹ˆï¼ŸåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ â‘  LVS-NATï¼ˆä¿®æ”¹æº/ç›®æ ‡åœ°å€ï¼‰ è¯·æ±‚å’Œå“åº”éƒ½ç»è¿‡ Directorï¼ˆç“¶é¢ˆï¼‰ RS é»˜è®¤è·¯ç”±æŒ‡å‘ Director æ”¯æŒä»»æ„ OS â‘¡ LVS-DRï¼ˆç›´æ¥è·¯ç”±ï¼‰ \u0026lt;- ç”Ÿäº§æœ€å¸¸ç”¨ Director åªæ”¶è¯·æ±‚ RS ç›´æ¥å›åŒ…ç»™å®¢æˆ·ç«¯ RS å¿…é¡»ä¸ Director åœ¨åŒä¸€äºŒå±‚ç½‘ç»œ éœ€è¦å…³é—­ ARP æŠ¢ç­” â‘¢ LVS-TUNï¼ˆIP éš§é“ï¼‰ ç”¨ IPIP éš§é“è½¬å‘è¯·æ±‚ RS å¯è·¨æœºæˆ¿ RS å›åŒ…ä¸ç»è¿‡ Director 3. LVS ä¼˜ç‚¹å’Œç¼ºç‚¹åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ ä¼˜ç‚¹ï¼š\n"},{"id":20,"href":"/database/mongo/faq/","title":"MongoDB FAQ","parent":"MongoDB","content":"å†…å®¹ï¼šåŸºç¡€ã€ç´¢å¼•ã€äº‹åŠ¡ã€æ€§èƒ½ä¼˜åŒ–ã€å¤åˆ¶é›†ã€åˆ†ç‰‡ã€åœºæ™¯é¢˜ï¼ŒæŒ‰ç…§éš¾åº¦ä»åˆçº§åˆ°é«˜çº§æ’åˆ—ã€‚\nä¸€ã€MongoDB åŸºç¡€æ¦‚å¿µé¢˜ 1. ä»€ä¹ˆæ˜¯ MongoDBï¼Ÿå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ªå¼€æºã€åˆ†å¸ƒå¼ã€é¢å‘æ–‡æ¡£çš„ NoSQL æ•°æ®åº“ï¼Œé‡‡ç”¨ BSON æ ¼å¼å­˜å‚¨æ•°æ®ã€‚\næ ¸å¿ƒç‰¹ç‚¹ï¼š\næ— æ¨¡å¼ï¼ˆSchema-Freeï¼‰ æ–‡æ¡£æ¨¡å‹ï¼ˆæ”¯æŒåµŒå¥—ç»“æ„ï¼‰ é«˜æ€§èƒ½ã€é«˜å¹¶å‘ åŸç”Ÿæ”¯æŒæ¨ªå‘æ‰©å±•ï¼ˆShardingï¼‰ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆReplica Setï¼‰ ä¸°å¯ŒæŸ¥è¯¢ï¼ˆåŒ…æ‹¬èšåˆã€åœ°ç†ä½ç½®ã€å…¨æ–‡ç´¢å¼•ï¼‰ 2. MongoDB çš„æ•°æ®æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB ä½¿ç”¨ æ–‡æ¡£ï¼ˆDocumentï¼‰ ä½œä¸ºæœ€å°å­˜å‚¨å•ä½ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“çš„ä¸€è¡Œã€‚\næ–‡æ¡£ -\u0026gt; BSON é›†åˆï¼ˆCollectionï¼‰ -\u0026gt; è¡¨ æ•°æ®åº“ï¼ˆDatabaseï¼‰ -\u0026gt; æ•°æ®åº“ 3. MongoDB çš„ BSON æ˜¯ä»€ä¹ˆï¼Ÿ BSON = Binary JSON\nç›¸æ¯” JSONï¼š\næ”¯æŒæ›´å¤šæ•°æ®ç±»å‹ï¼ˆdateã€binaryã€decimal128ï¼‰ è¯»å–å¿« æœ‰é•¿åº¦å­—æ®µï¼Œå¯é¡ºåºæ‰«æ äºŒã€ç´¢å¼• 4. MongoDB ä¸­æœ‰å“ªäº›ç±»å‹çš„ç´¢å¼•ï¼Ÿ å¸¸è§ç´¢å¼•ç±»å‹ï¼š\nå•å­—æ®µç´¢å¼• å¤åˆç´¢å¼•ï¼ˆCompoundï¼‰ å”¯ä¸€ç´¢å¼•ï¼ˆuniqueï¼‰ TTL ç´¢å¼• å“ˆå¸Œç´¢å¼•ï¼ˆHashedï¼‰ æ–‡æœ¬ç´¢å¼•ï¼ˆTextï¼‰ åœ°ç†ä½ç½®ç´¢å¼•ï¼ˆ2dsphereï¼‰ 5. ä»€ä¹ˆæ˜¯å¤åˆç´¢å¼•çš„â€œå·¦å‰ç¼€åŸåˆ™â€ï¼Ÿ å¦‚ç´¢å¼•ï¼š\n{ a: 1, b: 1, c: 1 } å¯ç”¨äºï¼š\na a + b a + b + c ä¸èƒ½ç”¨äºï¼š\nb c b + c 6. explain() è¾“å‡ºé‡Œçš„ COLLSCAN æ˜¯ä»€ä¹ˆï¼Ÿ COLLSCAN = å…¨è¡¨æ‰«æ\nè¡¨ç¤ºæ²¡æœ‰èµ°ç´¢å¼•ï¼Œæ˜¯æ€§èƒ½é—®é¢˜çš„æœ€å¤§æ ¹æºã€‚\n7. å¦‚ä½•åˆ¤æ–­æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Ÿ ä½¿ç”¨ï¼š\ndb.collection.find({...}).explain(\u0026#34;executionStats\u0026#34;) å…³æ³¨å­—æ®µï¼š\nstage æ˜¯å¦åŒ…å« IXSCAN totalDocsExamined æ˜¯å¦è¿œå°äº nReturned 8. MongoDB å¤šå­—æ®µæ’åºæ—¶å¿…é¡»æœ‰ç´¢å¼•å—ï¼Ÿ æ˜¯çš„ã€‚\nMongoDB åªèƒ½åœ¨ ç´¢å¼•é¡ºåºå®Œå…¨åŒ¹é… çš„æƒ…å†µä¸‹è¿›è¡Œæ’åºã€‚\nä¸‰ã€äº‹åŠ¡ \u0026amp; å†™å…¥ 9. MongoDB æ”¯æŒäº‹åŠ¡å—ï¼Ÿ æ”¯æŒã€‚\nä» MongoDB 4.0 å¼€å§‹æ”¯æŒ å¤šæ–‡æ¡£ ACID äº‹åŠ¡ï¼ˆReplica Setï¼‰\nä» 4.2 èµ·æ”¯æŒ åˆ†ç‰‡é›†ç¾¤äº‹åŠ¡ï¼ˆShardingï¼‰\n10. MongoDB äº‹åŠ¡æ€§èƒ½ä¸ MySQL å¯¹æ¯”ï¼Ÿ MongoDB çš„äº‹åŠ¡æ€§èƒ½æ›´å·®ï¼Œå› ä¸ºå…¶æ–‡æ¡£æ¨¡å‹åŸæœ¬å°±è®¾è®¡ä¸ºå‡å°‘äº‹åŠ¡åœºæ™¯ã€‚\nMongoDB äº‹åŠ¡é€‚ç”¨äºï¼š\nå¤šé›†åˆè·¨æ–‡æ¡£ä¸€è‡´æ€§ é‡‘èçº§ä¸šåŠ¡æå°‘ä½¿ç”¨çš„åœºæ™¯ 11. ä»€ä¹ˆæ˜¯ upsertï¼Ÿ å¦‚æœä¸å­˜åœ¨ -\u0026gt; æ’å…¥ å¦‚æœå­˜åœ¨ -\u0026gt; æ›´æ–° ç›¸å½“äº MySQL çš„ï¼š\ninsert ... on duplicate key update 12. å†™å…¥ä¼šè§¦å‘ document move æ˜¯ä»€ä¹ˆï¼Ÿ å½“æ–‡æ¡£å¤§å°å˜å¤§æ—¶ï¼Œéœ€è¦ç§»åŠ¨åˆ°æ–°çš„æ•°æ®é¡µï¼Œä¼šå¯¼è‡´ï¼š\næ€§èƒ½é™ä½ ç£ç›˜ I/O å¢åŠ  å¤åˆ¶é›† oplog å¢å¤§ é¿å…æ–¹æ³•ï¼š\nä¸è¦é¢‘ç¹å¢åŠ /å‡å°‘æ–‡æ¡£å­—æ®µ å¤§å­—æ®µæ‹†åˆ†å­é›†åˆ å››ã€æ€§èƒ½ä¼˜åŒ– 13. MongoDB æ€§èƒ½æ…¢ä¸€èˆ¬æœ‰å“ªäº›åŸå› ï¼Ÿ å¸¸è§ TOP åŸå› ï¼š\næ— ç´¢å¼• -\u0026gt; COLLSCANï¼ˆæœ€å¸¸è§ï¼‰ å¤åˆç´¢å¼•æœªå‘½ä¸­ æŸ¥è¯¢è¿”å›å­—æ®µè¿‡å¤šï¼ˆæœªä½¿ç”¨æŠ•å½±ï¼‰ å†™å…¥å¤ªé¢‘ç¹å¯¼è‡´é” æ–‡æ¡£å¤ªå¤§ï¼ˆ\u0026gt;16MB é™åˆ¶ï¼‰ COUNT() è¿‡æ…¢ äº‹åŠ¡é•¿æ—¶é—´å ç”¨é” ç£ç›˜ I/O é«˜ 14. å¦‚ä½•ä¼˜åŒ– MongoDB åˆ†é¡µï¼Ÿ ä¸è¦ä½¿ç”¨ï¼š\nskip + limit å› ä¸º skip éœ€è¦æ‰«æ N æ¡è®°å½•ã€‚\nä½¿ç”¨ï¼š\n{_id: {$gt: last_id}} // â€œæ¸¸æ ‡åˆ†é¡µâ€ limit 10 15. å¦‚ä½•æé«˜æ‰¹é‡å†™å…¥æ€§èƒ½ï¼Ÿ ä½¿ç”¨ï¼š\nbulkWrite() è€Œä¸æ˜¯å¾ªç¯ insertã€‚\n16. MongoDB ä¸ºä»€ä¹ˆæ›´é€‚åˆè¯»å¤šå†™å°‘ä¸šåŠ¡ï¼Ÿ å› ä¸º MongoDB å†™å…¥éœ€è¦ï¼š\nå†™ journal å†™æ•°æ®æ–‡ä»¶ å¤åˆ¶åˆ°å‰¯æœ¬é›†å…¶ä»–èŠ‚ç‚¹ æ›´æ–°å¤šä¸ªç´¢å¼• å†™æ”¾å¤§æ˜¾è‘—æ¯” MySQL å¤§ã€‚\n17. ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ allowDiskUseï¼Ÿ å½“èšåˆç®¡é“éœ€è¦å¤§é‡å†…å­˜ï¼š\ndb.col.aggregate([...], { allowDiskUse: true }) äº”ã€å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ 18. MongoDB å¤åˆ¶é›†çš„é€‰ä¸¾è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ åŸºäº Raft ç±»ä¼¼æœºåˆ¶ã€‚\né€‰ä¸¾æ¡ä»¶ï¼š\næˆå‘˜ ping å¯è¾¾ ç¥¨æ•°è¿‡åŠ ä¼˜å…ˆçº§ä¼˜å…ˆï¼ˆpriorityï¼‰ oplog æ•°æ®æœ€æ–° 19. PRIMARY ä¸ºä»€ä¹ˆä¼šå˜ SECONDARYï¼Ÿ åŸå› ï¼š\nç½‘ç»œä¸é€š å¿ƒè·³è¶…æ—¶ ä¼˜å…ˆçº§ä½ oplog è¿½ä¸ä¸Š èµ„æºä¸è¶³ï¼ˆå†…å­˜/CPU è¿‡é«˜ï¼‰ 20. ä»€ä¹ˆæ˜¯ oplogï¼Ÿä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ oplogï¼ˆoperation logï¼‰æ˜¯ å¤åˆ¶é›†çš„æ•°æ®å¤åˆ¶æ—¥å¿—ã€‚\nSECONDARY èŠ‚ç‚¹ä» oplog åŒæ­¥æ•°æ®ã€‚\nå…³é”®å‚æ•°ï¼š\noplog å¤§å°ï¼ˆè¦ä¿è¯è‡³å°‘ 24 å°æ—¶çª—å£ï¼‰ oplog è½åå¤ªä¹…ä¼šå¯¼è‡´éœ€è¦å…¨é‡å¤åˆ¶ 21. å¤åˆ¶é›†èŠ‚ç‚¹å»¶è¿Ÿå¦‚ä½•æŸ¥çœ‹ï¼Ÿ rs.printSlaveReplicationInfo() å…­ã€åˆ†ç‰‡ï¼ˆShardingï¼‰ 22. MongoDB ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ï¼Ÿ å› ä¸ºå•ä¸ªèŠ‚ç‚¹ï¼š\nå†…å­˜æœ‰é™ ç£ç›˜æœ‰é™ IOPS ä¸å¤Ÿ QPS è´Ÿè½½ç“¶é¢ˆ åˆ†ç‰‡å¯æ¨ªå‘æ‰©å®¹è‡³æ— é™å®¹é‡ã€‚\n23. åˆ†ç‰‡é”®åº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ æœ€ä½³å®è·µï¼š\né«˜åŸºæ•°ï¼ˆhigh cardinalityï¼‰ å†™å…¥å‡åŒ€ é¿å…å•è°ƒé€’å¢ æ¨èï¼š\nhashed(_id) hashed(user_id) 24. é”™è¯¯çš„åˆ†ç‰‡é”®ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ å…¸å‹é—®é¢˜ï¼š\næ•°æ®çƒ­ç‚¹ï¼ˆæ‰€æœ‰å†™å…¥é›†ä¸­åˆ°ä¸€ä¸ªåˆ†ç‰‡ï¼‰ chunk åˆ†è£‚/è¿ç§»é€Ÿåº¦æ…¢ èŠ‚ç‚¹è´Ÿè½½ä¸å‡è¡¡ 25. shard key æ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼Ÿ ä¸èƒ½ä¿®æ”¹ï¼ˆå‡ ä¹ä¸å¯èƒ½ï¼‰ã€‚\nMongoDB è®¾è®¡ä¸­ shard key æ˜¯æ°¸ä¹…æ€§çš„ã€‚\nä¸ƒã€å®‰å…¨ 26. å¦‚ä½•å¯ç”¨ MongoDB ç”¨æˆ·éªŒè¯ï¼Ÿ mongod.confï¼š\nsecurity: authorization: enabled 27. MongoDB æ¨èä½¿ç”¨ä»€ä¹ˆè®¤è¯æ–¹å¼ï¼Ÿ SCRAM-SHA-256\næ¯” SHA-1 æ›´å®‰å…¨ã€‚\n28. MongoDB å¦‚ä½•è¿›è¡Œæƒé™æ§åˆ¶ï¼Ÿ åŸºäºï¼š\nç”¨æˆ·ï¼ˆuserï¼‰ è§’è‰²ï¼ˆroleï¼‰ æ•°æ®åº“ï¼ˆdbï¼‰ ä¾‹å¦‚ï¼š\nreadWrite dbAdmin clusterAdmin backup restore å…«ã€å®æˆ˜åœºæ™¯ 29. å¦‚æœ MongoDB çš„ CPU 100% æ€ä¹ˆæ’æŸ¥ï¼Ÿ æ’æŸ¥æ€è·¯ï¼š\ncurrentOp() æŸ¥çœ‹å“ªäº›æŸ¥è¯¢åœ¨è·‘ explain() æ˜¯å¦å‡ºç° COLLSCAN çœ‹æ˜¯å¦èµ°äº†å…¨æ–‡ç´¢å¼• è§‚å¯Ÿ WiredTiger cache è§‚å¯Ÿæ˜¯å¦å¤§é‡ fetch æ–‡æ¡£ çœ‹æ˜¯å¦æœ‰å¤§ $in æŸ¥è¯¢ æ˜¯å¦æœ‰æ— ç´¢å¼•çš„ $lookup æ˜¯å¦æœ‰é•¿äº‹åŠ¡å¡ä½é” 30. å¦‚æœ MongoDB å†™å…¥çªç„¶å˜æ…¢æ€ä¹ˆåŠï¼Ÿ å¯èƒ½åŸå› ï¼š\nç´¢å¼•å¤ªå¤š -\u0026gt; å†™å…¥å˜æ…¢ journal å†™å…¥æ…¢ï¼ˆç£ç›˜ I/Oï¼‰ æ–‡æ¡£è¿‡å¤§ åˆ†ç‰‡å¹³è¡¡å¯¼è‡´ chunk migrate é˜»å¡ å¤åˆ¶é›†å»¶è¿Ÿå¤§ ä¸»èŠ‚ç‚¹é”ç­‰å¾… æ’æŸ¥ï¼š\ndb.serverStatus() iostat rs.printSlaveReplicationInfo() 31. MongoDB é›†åˆéå¸¸å¤§æ—¶å¦‚ä½•æå‡æ€§èƒ½ï¼Ÿ ç­–ç•¥ï¼š\nåˆ›å»ºå¿…è¦ç´¢å¼• çƒ­ç‚¹å­—æ®µåˆ†ç‰‡ ä½¿ç”¨å‹ç¼© ä¸è¦æŸ¥è¯¢å¤§æ–‡æ¡£ ç¦æ­¢ deep skip ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ å®šæœŸ archive å½’æ¡£æ—§æ•°æ® å°†å¤§å­—æ®µï¼ˆå¦‚å›¾ç‰‡ï¼‰æ‹†åˆ†å­˜å‚¨åˆ° GridFS 32. å¦‚ä½•åˆ¤æ–­ MongoDB åˆ†ç‰‡æ˜¯å¦ imbalanceï¼ˆä¸å‡è¡¡ï¼‰ï¼Ÿ è¿è¡Œï¼š\nsh.status() æ£€æŸ¥ï¼š\nchunk åˆ†å¸ƒ æ¯ä¸ª shard çš„æ•°æ®é‡å·®å¼‚ balancer æ˜¯å¦è¿è¡Œ 33. å¦‚æœ shard key é€‰é”™äº†æ€ä¹ˆåŠï¼Ÿ è§£å†³æ–¹æ¡ˆï¼š\næ–°å»ºä¸€ä¸ªæ–°çš„ collection -\u0026gt; æ­£ç¡® shard key å¯¼å…¥æ•°æ® -\u0026gt; è½æ–° collection é€æ¸åˆ‡æ¢ä¸šåŠ¡åˆ°æ–°çš„ collection MongoDB ä¸æ”¯æŒç›´æ¥ä¿®æ”¹ shard keyã€‚\n34. MongoDB çš„æ–‡æ¡£æ¨¡å‹æœ‰å“ªäº›åæ¨¡å¼ï¼Ÿ åä¾‹ï¼š\næ–‡æ¡£å¤ªå¤§ å¤ªå¤šåµŒå¥—ç»“æ„ æ•°ç»„æ— é™å¢é•¿ å•æ–‡æ¡£å•å­—æ®µè¿‡å·¨å¤§ï¼ˆ\u0026gt;16MBï¼‰ å­æ–‡æ¡£æ›´æ–°è¿‡å¤š -\u0026gt; document move ä¹ã€é«˜çº§ï¼ˆæ¶æ„å¸ˆï¼‰ 35. WiredTiger Cache æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ WiredTiger Cache æ§åˆ¶ MongoDB å†…å­˜åˆ†é…ï¼ˆ50% å†…å­˜ï¼‰ã€‚\nä½œç”¨ï¼š\nå­˜æ”¾çƒ­æ•°æ® å­˜æ”¾ç´¢å¼• è¯»å†™ç¼“å­˜ Cache miss ä¼šï¼š\nè§¦å‘ç£ç›˜ I/O æ€§èƒ½æ€¥å‰§ä¸‹é™ 36. MongoDB ä¸­çš„é”æ˜¯æ€æ ·çš„ï¼Ÿ æ–‡æ¡£çº§é”ï¼ˆå†™å…¥é”å•æ–‡æ¡£ï¼Œä¸é”é›†åˆï¼‰ å…¨å±€é”ï¼ˆå…ƒæ•°æ®æ“ä½œï¼‰ è¯»å†™é”ï¼ˆShare/Exclusiveï¼‰ ç´¢å¼•åˆ›å»ºæ—¶å¯èƒ½å…¨å±€é” 37. å¦‚ä½•å¤„ç†çƒ­ç‚¹å†™å…¥é—®é¢˜ï¼Ÿ è§£å†³æ–¹æ³•ï¼š\nhashed shard key æ‹†åˆ†æˆå¤šä¸ªé›†åˆï¼ˆå†·çƒ­åˆ†ç¦»ï¼‰ å¢åŠ å¤šä¸ª mongos å‡å°‘çƒ­ç‚¹å­—æ®µæ›´æ–° 38. MongoDB å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ é€šè¿‡ï¼š\nWrite Concern Read Concern Multi-Document Transactions Majority Quorum 39. ä»€ä¹ˆæ˜¯ Write Concernï¼Ÿæœ‰å“ªäº›çº§åˆ«ï¼Ÿ æ§åˆ¶å†™å…¥ç¡®è®¤çº§åˆ«ï¼š\n0 fire-and-forget 1 primary majorityï¼ˆæ¨èï¼‰ w: \u0026lt;num\u0026gt; n ä¸ªèŠ‚ç‚¹ç¡®è®¤ 40. å¦‚ä½•åš MongoDB å¤‡ä»½æ¢å¤ï¼Ÿ å·¥å…·ï¼š\nmongodump/mongorestore mongoexport å…¨é‡ç‰©ç†å¤åˆ¶ï¼ˆLVM snapshotï¼‰ å¤åˆ¶é›†æ‹‰æ•°æ® ","description":"å†…å®¹ï¼šåŸºç¡€ã€ç´¢å¼•ã€äº‹åŠ¡ã€æ€§èƒ½ä¼˜åŒ–ã€å¤åˆ¶é›†ã€åˆ†ç‰‡ã€åœºæ™¯é¢˜ï¼ŒæŒ‰ç…§éš¾åº¦ä»åˆçº§åˆ°é«˜çº§æ’åˆ—ã€‚\nä¸€ã€MongoDB åŸºç¡€æ¦‚å¿µé¢˜ 1. ä»€ä¹ˆæ˜¯ MongoDBï¼Ÿå®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ªå¼€æºã€åˆ†å¸ƒå¼ã€é¢å‘æ–‡æ¡£çš„ NoSQL æ•°æ®åº“ï¼Œé‡‡ç”¨ BSON æ ¼å¼å­˜å‚¨æ•°æ®ã€‚\næ ¸å¿ƒç‰¹ç‚¹ï¼š\næ— æ¨¡å¼ï¼ˆSchema-Freeï¼‰ æ–‡æ¡£æ¨¡å‹ï¼ˆæ”¯æŒåµŒå¥—ç»“æ„ï¼‰ é«˜æ€§èƒ½ã€é«˜å¹¶å‘ åŸç”Ÿæ”¯æŒæ¨ªå‘æ‰©å±•ï¼ˆShardingï¼‰ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆReplica Setï¼‰ ä¸°å¯ŒæŸ¥è¯¢ï¼ˆåŒ…æ‹¬èšåˆã€åœ°ç†ä½ç½®ã€å…¨æ–‡ç´¢å¼•ï¼‰ 2. MongoDB çš„æ•°æ®æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB ä½¿ç”¨ æ–‡æ¡£ï¼ˆDocumentï¼‰ ä½œä¸ºæœ€å°å­˜å‚¨å•ä½ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“çš„ä¸€è¡Œã€‚\n"},{"id":21,"href":"/database/mysql/faq/","title":"MySQL FAQ","parent":"MySQL","content":"å†…å®¹ï¼š\nåŸºç¡€ ç´¢å¼• / é” / äº‹åŠ¡ / éš”ç¦»çº§åˆ« MVCC åº•å±‚ æ—¥å¿—ï¼ˆredo/undo/binlogï¼‰ SQL ä¼˜åŒ– ä¸»ä»å¤åˆ¶ä¸ä¸€è‡´æ€§ å­˜å‚¨å¼•æ“ é«˜å¯ç”¨ / é›†ç¾¤ ç›®å½•\nMySQL åŸºç¡€ InnoDB ç´¢å¼• InnoDB é” äº‹åŠ¡ä¸éš”ç¦»çº§åˆ« æ—¥å¿—ç³»ç»Ÿï¼ˆundo/redo/binlogï¼‰ MVCC SQL è°ƒä¼˜ ä¸»ä»å¤åˆ¶ é«˜å¯ç”¨æ–¹æ¡ˆ å¤§è¡¨ä¼˜åŒ– å­˜å‚¨å¼•æ“å¯¹æ¯” ç»¼åˆâ€œéš¾åº¦æå‡é¢˜â€ ä¸€ã€MySQL åŸºç¡€ 1. MySQL çš„å­˜å‚¨å¼•æ“æœ‰å“ªäº›ï¼ŸInnoDB æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ ğŸ”¥ InnoDB æ˜¯ MySQL é»˜è®¤å¼•æ“ï¼Œæ”¯æŒï¼š\näº‹åŠ¡ï¼ˆACIDï¼‰ è¡Œçº§é”ï¼ˆæœ€å°é”ç²’åº¦ï¼‰ MVCCï¼ˆé«˜å¹¶å‘ï¼‰ å¤–é”® B+Tree ç´¢å¼• redo + undo æŒä¹…åŒ–æœºåˆ¶ å…¶å®ƒå­˜å‚¨å¼•æ“ï¼š\nå¼•æ“ ç‰¹ç‚¹ MyISAM ä¸æ”¯æŒäº‹åŠ¡ã€è¡¨çº§é”ã€è¯»å–å¿«ã€å´©æºƒå¯èƒ½ä¸¢æ•°æ® Memory æ•°æ®åœ¨å†…å­˜ã€æå¿«ã€é‡å¯ä¸¢å¤± Archive ä»…æ”¯æŒ INSERT/SELECTï¼ˆå½’æ¡£ï¼‰ 2. varchar ä¸ char çš„åŒºåˆ«ï¼Ÿ char å›ºå®šé•¿åº¦ï¼šé€‚åˆèº«ä»½è¯å·ã€MD5 ç­‰å®šé•¿å­—æ®µ varchar å¯å˜é•¿åº¦ï¼šèŠ‚çœç©ºé—´ï¼Œé€‚åˆå­—ç¬¦ä¸² 3. FLOAT å’Œ DECIMAL åŒºåˆ«ï¼Ÿ FLOATï¼šä¸ç²¾ç¡®ï¼Œæµ®ç‚¹è¿ç®— DECIMALï¼šç²¾ç¡®è®¡ç®—ï¼ˆé‡‘èé‡‘é¢ç”¨å®ƒï¼‰ äºŒã€ç´¢å¼• 4. ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆèƒ½æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Ÿ ç´¢å¼•æ˜¯ç”¨ B+Tree ç»„ç»‡çš„æ•°æ®ç»“æ„ï¼Œä½¿å¾—ï¼š\næŸ¥æ‰¾å¤æ‚åº¦ä» O(n) -\u0026gt; O(log n) èŒƒå›´æŸ¥æ‰¾è¿ç»­ï¼ˆå¶å­èŠ‚ç‚¹é“¾è¡¨ï¼‰ 5. B+Tree ä¸ºä»€ä¹ˆæ¯” B-Tree æ›´é€‚åˆä½œç´¢å¼•ï¼Ÿ åªæœ‰å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼ˆB-Tree æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨æ•°æ®ï¼‰ éå¶èŠ‚ç‚¹æ›´å° -\u0026gt; ä¸€ä¸ªé¡µé¢èƒ½å­˜æ›´å¤šèŠ‚ç‚¹ -\u0026gt; æ ‘æ›´çŸ® é¡ºåºé“¾æŒ‡é’ˆæ”¯æŒ èŒƒå›´æŸ¥è¯¢ï¼ˆBETWEEN/LIKE \u0026lsquo;xxx%\u0026rsquo;ï¼‰ 6. MySQL ä½•æ—¶ä½¿ç”¨ç´¢å¼•ï¼Ÿ ç²¾ç¡®åŒ¹é… èŒƒå›´æŸ¥è¯¢ï¼ˆ\u0026gt;, \u0026lt;, betweenï¼‰ å‰ç¼€æŸ¥è¯¢ï¼ˆlike \u0026lsquo;abc%\u0026rsquo;ï¼‰ join on å­—æ®µ order by å¯ä¼˜åŒ–ï¼ˆç´¢å¼•æœ‰åºï¼‰ 7. å“ªäº›æƒ…å†µç´¢å¼•å¤±æ•ˆï¼Ÿ å‡½æ•°æ“ä½œï¼šwhere DATE(create_time) = \u0026lsquo;2024-01-01\u0026rsquo; å­—æ®µç±»å‹ä¸ä¸€è‡´ï¼šage = \u0026lsquo;20\u0026rsquo; å·¦æ¨¡ç³Šï¼šLIKE \u0026lsquo;%abc\u0026rsquo; OR å‰åå­—æ®µä¸ä¸€è‡´ è´Ÿå‘æŸ¥è¯¢ï¼š!=, \u0026lt;\u0026gt;, NOT IN 8. è”åˆç´¢å¼•ä¸ºä»€ä¹ˆéµå¾ªæœ€å·¦å‰ç¼€ï¼Ÿ å› ä¸º B+Tree æ˜¯æŒ‰ï¼š(a,b,c) ä»å·¦åˆ°å³æ’åºç»„ç»‡çš„ï¼Œä¸çŸ¥é“ a çš„å€¼ï¼Œå°±æ— æ³•å®šä½ b,cã€‚\n9. è¦†ç›–ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿ æŸ¥è¯¢å­—æ®µå…¨éƒ¨åœ¨äºŒçº§ç´¢å¼•é‡Œï¼Œç›´æ¥ä» ç´¢å¼•æ ‘ è¿”å›ï¼Œä¸å›è¡¨ï¼Œé€Ÿåº¦æå¿«ã€‚\nä¾‹å¦‚ï¼š\nSELECT id, name FROM user WHERE name=\u0026#39;abc\u0026#39;; å¦‚æœ name æ˜¯äºŒçº§ç´¢å¼• -\u0026gt; è¦†ç›–ç´¢å¼•ã€‚\n10. å›è¡¨æ˜¯ä»€ä¹ˆï¼Ÿ éä¸»é”®ç´¢å¼•åªèƒ½å–åˆ°ä¸»é”®ï¼Œå†å»ä¸»é”® B+Tree ä¸­æŸ¥çœŸå®è¡Œæ•°æ®ã€‚\nå¤šä¸€æ¬¡ IO -\u0026gt; è¾ƒæ…¢ã€‚\nä¸‰ã€é”ï¼ˆè¡Œé” / é—´éš™é” / Next-Keyï¼‰ 11. MySQL é”æœ‰å“ªäº›ç±»å‹ï¼Ÿ æŒ‰ç…§ç²’åº¦ï¼š\nè¡¨é” è¡Œé”ï¼ˆRecord Lockï¼‰ é—´éš™é”ï¼ˆGap Lockï¼‰ Next-Key Lockï¼ˆRecord + Gapï¼‰ 12. æ›´æ–°/åˆ é™¤æ—¶ï¼Œä¼šåŠ ä»€ä¹ˆé”ï¼Ÿ èŒƒå›´æŸ¥è¯¢ï¼š\nUPDATE ... WHERE age BETWEEN 10 AND 20; DELETE ... -\u0026gt; è‡ªåŠ¨åŠ  Next-Key Lockï¼ˆé˜»æ­¢ INSERT/UPDATE/DELETEï¼‰\nå•ç‚¹æŸ¥è¯¢ï¼š\nUPDATE ... WHERE id=1; -\u0026gt; åŠ  è®°å½•é”\n13. æ­»é”æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ æ­»é”ï¼šä¸¤ä¸ªäº‹åŠ¡äº’ç›¸å æœ‰é”ï¼Œå¯¼è‡´äº’ç›¸ç­‰å¾…ã€‚\nè§£å†³ï¼š\nç¼©å°é”èŒƒå›´ å‡å°‘èŒƒå›´æŸ¥è¯¢ å›ºå®šè®¿é—®é¡ºåº ä½¿ç”¨æ›´å°çš„äº‹åŠ¡ å››ã€äº‹åŠ¡ä¸éš”ç¦»çº§åˆ« 14. äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰ï¼Ÿ Atomicityï¼ˆåŸå­æ€§ï¼‰ Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ Isolationï¼ˆéš”ç¦»æ€§ï¼‰ Durabilityï¼ˆæŒä¹…æ€§ï¼‰ 15. MySQL æ”¯æŒå“ªäº›éš”ç¦»çº§åˆ«ï¼Ÿ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED âœ… âœ… âœ… READ COMMITTED âŒ âœ… âœ… REPEATABLE READï¼ˆé»˜è®¤ï¼‰ âŒ âŒ âœ… (ç”¨Next-Key) SERIALIZABLE âŒ âŒ âŒ 16. RR éš”ç¦»çº§åˆ«å¦‚ä½•é¿å…å¹»è¯»ï¼Ÿ ä½¿ç”¨ Next-Key Lockï¼ˆè®°å½•é” + é—´éš™é”ï¼‰é”ä½èŒƒå›´ï¼Œé˜»æ­¢èŒƒå›´å†… INSERTã€‚\näº”ã€æ—¥å¿—ç³»ç»Ÿ 17. InnoDB ä¸ºä»€ä¹ˆéœ€è¦ redo logï¼Ÿ é‡å¯åæ¢å¤æœªåˆ·ç›˜çš„æ•°æ® -\u0026gt; ä¿è¯ æŒä¹…æ€§ï¼ˆDï¼‰\n18. unlink undo log æ˜¯ä»€ä¹ˆï¼Ÿ undo log ç”¨æ¥ï¼š\nMVCC ç‰ˆæœ¬é“¾ äº‹åŠ¡å›æ»š 19. binlog ä¸ redo log åŒºåˆ«ï¼Ÿ å†…å®¹ redo log binlog å±‚çº§ InnoDB å¼•æ“ MySQL Server å±‚ ä½œç”¨ å´©æºƒæ¢å¤ ä¸»ä»å¤åˆ¶ / å®¡è®¡ æ˜¯å¦è¦†ç›– å¾ªç¯å†™ è¿½åŠ å†™ å†™å…¥æ—¶æœº äº‹åŠ¡ä¸­å¤šæ¬¡å†™ æäº¤æ—¶ä¸€æ¬¡å†™ 20. ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ ä¿è¯ï¼š\nredo log ä¸ binlog ä¸€è‡´\näº‹åŠ¡æäº¤æµç¨‹ï¼š\nå†™ redoï¼ˆprepareï¼‰ å†™ binlog redo commit å…­ã€MVCC 21. MVCC æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ ä¾é ï¼š\nundo logï¼ˆæ—§ç‰ˆæœ¬ï¼‰ read viewï¼ˆå¯è§æ€§è§„åˆ™ï¼‰ hidden columnsï¼ˆtrx_id / roll_pointerï¼‰ 22. MVCC èƒ½è§£å†³ä»€ä¹ˆï¼Ÿ é«˜å¹¶å‘æŸ¥è¯¢ï¼ˆSELECT æ— éœ€åŠ é”ï¼‰ é¿å…è¯»å†™å†²çª å¿«ç…§è¯» ä¸ƒã€SQL è°ƒä¼˜ 23. å¦‚ä½•åˆ†æ SQL æ€§èƒ½ï¼Ÿ EXPLAIN SHOW PROFILE trace ä¼˜åŒ–å™¨ performance_schema slow logï¼ˆæ…¢ SQLï¼‰ 24. EXPLAIN çš„å…³é”®å­—æ®µï¼Ÿ å­—æ®µ æ„ä¹‰ type ç³»ç»Ÿ/const/ref/range/index/ALL key ä½¿ç”¨çš„ç´¢å¼• rows æ‰«æè¡Œæ•°ä¼°è®¡ extra æ˜¯å¦ Using index ç­‰ 25. order by å¦‚ä½•ä¼˜åŒ–ï¼Ÿ éµå¾ªç´¢å¼•é¡ºåº where å’Œ order by ä½¿ç”¨åŒä¸€ç´¢å¼• é¿å… filesort 26. count(*) ä¸ºä»€ä¹ˆå¿«ï¼Ÿ InnoDB åšäº†ä¼˜åŒ–ï¼šä¸å–å‡ºè¡Œå†…å®¹ï¼Œç›´æ¥æŒ‰è¡Œæ‰«æï¼ˆå¯èƒ½åˆ©ç”¨äºŒçº§ç´¢å¼•ï¼‰\n8ã€ä¸»ä»å¤åˆ¶ 27. MySQL ä¸»ä»åŒæ­¥åŸç†ï¼ˆç»å…¸ä¸‰é˜¶æ®µï¼‰ï¼Ÿ master å†™å…¥ binlog replica IO çº¿ç¨‹æŠŠ binlog æ‹‰åˆ° relay log SQL çº¿ç¨‹æ‰§è¡Œ relay log 28. å¦‚ä½•ç¡®ä¿ä¸»ä»ä¸€è‡´æ€§ï¼Ÿ è®¾ç½® sync_binlog=1 è®¾ç½® innodb_flush_log_at_trx_commit=1 semisync åŠåŒæ­¥ ä¹ã€é«˜å¯ç”¨ 29. MySQL é«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ MGRï¼ˆå®˜æ–¹ï¼Œå¼ºä¸€è‡´ï¼‰ InnoDB Clusterï¼ˆMGR å°è£…ï¼‰ Semi-Syncï¼ˆåŠåŒæ­¥ï¼‰ MHAï¼ˆè‡ªåŠ¨åˆ‡æ¢ï¼‰ Orchestratorï¼ˆå¤§è§„æ¨¡é›†ç¾¤ï¼‰ PXC / Galeraï¼ˆå¼ºä¸€è‡´ï¼‰ åã€å¤§è¡¨ä¼˜åŒ– 30. å¦‚ä½•å¤„ç† 1 äº¿è¡Œçš„å¤§è¡¨ï¼Ÿ åˆ†åŒºï¼ˆrange/hashï¼‰ å‚ç›´/æ°´å¹³æ‹†åˆ† ç´¢å¼•ä¼˜åŒ– å¢é‡å½’æ¡£ï¼ˆæŒ‰æœˆå¤‡ä»½ï¼‰ çƒ­/å†·åˆ†ç¦» æŒ‰æ—¶é—´åˆ†è¡¨ åä¸€ã€å­˜å‚¨å¼•æ“å¯¹æ¯” 31. InnoDB vs MyISAMï¼Ÿ ç‰¹æ€§ InnoDB MyISAM äº‹åŠ¡ âœ… âŒ è¡Œé” âœ… âŒï¼ˆåªæœ‰è¡¨é”ï¼‰ å´©æºƒæ¢å¤ âœ… âŒ å¤–é”® âœ… âŒ åäºŒã€é«˜çº§ 32. ä¸ºä»€ä¹ˆ MySQL æ²¡æœ‰ä½¿ç”¨ Hash ç´¢å¼•è€Œæ˜¯ä½¿ç”¨ B+Treeï¼Ÿ èŒƒå›´æŸ¥è¯¢å·® ä¸æ”¯æŒæ’åº ä¸æ”¯æŒå‰ç¼€åŒ¹é… ä¸æ”¯æŒå¤šåˆ—è”åˆç´¢å¼• 33. æ•°æ®åº“ä¸ºä»€ä¹ˆè¦ç”¨ WALï¼ˆWrite-Ahead Loggingï¼‰ï¼Ÿ ä¿è¯ï¼š\nå…ˆå†™æ—¥å¿—ï¼Œåå†™æ•°æ®é¡µ å´©æºƒæ¢å¤æ›´å¿«ï¼ˆredo logï¼‰ 34. ä¸ºä»€ä¹ˆå†™å…¥å‰å¿…é¡»å…ˆå†™ redo logï¼Ÿ é¿å…ï¼š\nå´©æºƒé€ æˆæ•°æ®ä¸¢å¤± æ•°æ®é¡µéƒ¨åˆ†å†™å…¥å¯¼è‡´é¡µæŸå 35. ä¸ºä»€ä¹ˆ InnoDB ä½¿ç”¨ MVCC è€Œä¸æ˜¯åŠ è¯»é”ï¼Ÿ åŠ è¯»é” -\u0026gt; å…¨å±€é” -\u0026gt; è¯»å†™å†²çª -\u0026gt; å¹¶å‘èƒ½åŠ›æå·®\nMVCC -\u0026gt; éé”å®šä¸€è‡´æ€§è¯»\n36. å¦‚ä½•æ’æŸ¥é”ç­‰å¾…ï¼Ÿ show processlist; show engine innodb status \\G; performance_schema.data_locks 37. å¦‚ä½•æ’æŸ¥ â€œwaiting for table metadata lockâ€ï¼Ÿ ç«äº‰ DDLï¼Œè§£å†³ï¼š\né¿å…ä¸šåŠ¡é«˜å³°æ‰§è¡Œ DDL ä½¿ç”¨ pt-online-schema-change ä½¿ç”¨ gh-ost ","description":"å†…å®¹ï¼š\nåŸºç¡€ ç´¢å¼• / é” / äº‹åŠ¡ / éš”ç¦»çº§åˆ« MVCC åº•å±‚ æ—¥å¿—ï¼ˆredo/undo/binlogï¼‰ SQL ä¼˜åŒ– ä¸»ä»å¤åˆ¶ä¸ä¸€è‡´æ€§ å­˜å‚¨å¼•æ“ é«˜å¯ç”¨ / é›†ç¾¤ ç›®å½•\nMySQL åŸºç¡€ InnoDB ç´¢å¼• InnoDB é” äº‹åŠ¡ä¸éš”ç¦»çº§åˆ« æ—¥å¿—ç³»ç»Ÿï¼ˆundo/redo/binlogï¼‰ MVCC SQL è°ƒä¼˜ ä¸»ä»å¤åˆ¶ é«˜å¯ç”¨æ–¹æ¡ˆ å¤§è¡¨ä¼˜åŒ– å­˜å‚¨å¼•æ“å¯¹æ¯” ç»¼åˆâ€œéš¾åº¦æå‡é¢˜â€ ä¸€ã€MySQL åŸºç¡€ 1. MySQL çš„å­˜å‚¨å¼•æ“æœ‰å“ªäº›ï¼ŸInnoDB æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ ğŸ”¥ InnoDB æ˜¯ MySQL é»˜è®¤å¼•æ“ï¼Œæ”¯æŒï¼š\n"},{"id":22,"href":"/operations/nacos/faq/","title":"Nacos FAQ","parent":"Nacos","content":"å†…å®¹ï¼šåŸºç¡€ã€æ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒã€é›†ç¾¤ã€é«˜å¯ç”¨ã€åŸç†ã€æ€§èƒ½ã€è¿ç»´ã€Spring Cloud Alibaba é›†æˆç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µç±» 1. ä»€ä¹ˆæ˜¯ Nacosï¼Ÿèƒ½åšä»€ä¹ˆï¼Ÿ Nacos æ˜¯é˜¿é‡Œå¼€æºçš„ æœåŠ¡æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒï¼Œä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›ï¼š\nNamingï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰\næœåŠ¡æ³¨å†Œ/å‘ç° å¥åº·æ£€æŸ¥ è´Ÿè½½å‡è¡¡ Configï¼ˆé…ç½®ä¸­å¿ƒï¼‰\né…ç½®çƒ­æ›´æ–° é…ç½®ç›‘å¬ å¤šç¯å¢ƒéš”ç¦» Gray é…ç½®ï¼ˆç°åº¦ï¼‰ æ ¸å¿ƒç›®æ ‡æ˜¯å¸®åŠ©å¾®æœåŠ¡æ²»ç†ã€‚\n2 Nacos å’Œ Eureka çš„åŒºåˆ«ï¼Ÿ ç‰¹æ€§ Nacos Eureka æ³¨å†Œä¸­å¿ƒæ”¯æŒ âœ…ï¼ˆå¼ºï¼‰ âœ… é…ç½®ä¸­å¿ƒ âœ…ï¼ˆå¼ºï¼‰ âŒ é›†ç¾¤ä¸€è‡´æ€§åè®® Distro + Raft AP å¥åº·æ£€æŸ¥ æœåŠ¡ç«¯ä¸»åŠ¨æ£€æŸ¥ å®¢æˆ·ç«¯å¿ƒè·³ gRPC é€šä¿¡ âœ…ï¼ˆå¼ºï¼‰ âŒ åŠ¨æ€é…ç½® âœ… âŒ æƒé™æ§åˆ¶ âœ… âŒ Nacos æ˜¯â€œæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒâ€ï¼ŒåŠŸèƒ½è¿œå¼ºäº Eurekaã€‚\n3 Nacos çš„æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ Standaloneï¼ˆå•æœºæ¨¡å¼ï¼‰ Clusterï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ Embeddedï¼ˆåµŒå…¥å¼ï¼Œä½¿ç”¨ Derby æ•°æ®åº“ï¼‰ ç”Ÿäº§å¿…é¡»ç”¨ é›†ç¾¤ + MySQLã€‚\näºŒã€æ³¨å†Œä¸­å¿ƒï¼ˆNamingï¼‰ç±» 4. Nacos æ³¨å†Œä¸­å¿ƒå¦‚ä½•å®ç°æœåŠ¡æ³¨å†Œï¼Ÿ å®¢æˆ·ç«¯é€šè¿‡ gRPCï¼ˆ9848ï¼‰å‘ Nacos å‘é€ï¼š\nå®ä¾‹ IP Port Weight Ephemeralï¼ˆä¸´æ—¶å®ä¾‹ï¼‰ Metadata Nacos æ¥æ”¶åå†™å…¥å†…å­˜å¹¶æŒä¹…åŒ–åˆ° MySQLï¼ˆéä¸´æ—¶ï¼‰ã€‚\n5. ä¸´æ—¶å®ä¾‹ï¼ˆEphemeralï¼‰ vs éä¸´æ—¶å®ä¾‹ï¼Ÿ ç±»å‹ ä¸´æ—¶å®ä¾‹ éä¸´æ—¶å®ä¾‹ æ˜¯å¦ä¾èµ–å¿ƒè·³ æ˜¯ å¦ å¿ƒè·³ä¸¢å¤±æ˜¯å¦ä¸‹çº¿ ä¼š ä¸ä¼š æ˜¯å¦æŒä¹…åŒ–åˆ° DB å¦ æ˜¯ å¤šç”¨äº å¾®æœåŠ¡ ç‰©ç†è®¾å¤‡/IoT 6. Nacos å¦‚ä½•åšå¥åº·æ£€æŸ¥ï¼Ÿ Nacos æ”¯æŒä¸¤ç§ï¼š\nå®¢æˆ·ç«¯å¿ƒè·³ï¼ˆé»˜è®¤ï¼‰ æœåŠ¡ç«¯ä¸»åŠ¨æ¢æµ‹ï¼ˆHTTP/TCP æ£€æŸ¥ï¼‰\u0026ndash;å¯é€‰ ä¸´æ—¶å®ä¾‹ä¾èµ–å¿ƒè·³ã€‚\n7. Nacos æœåŠ¡æ³¨å†Œä¸ºä½•ä½¿ç”¨ gRPCï¼Ÿ æ¨é€å®æ—¶æ€§é«˜ é›†ç¾¤åŒæ­¥å¿« åŒå‘æµé€šä¿¡ï¼Œæ•ˆç‡é«˜ æ›¿ä»£äº†æ—§çš„ HTTP é•¿è½®è¯¢ 8. ä¸ºä»€ä¹ˆä¼šå‡ºç°æœåŠ¡ä¸Šä¸‹çº¿é¢‘ç¹ï¼Ÿ å¸¸è§åŸå› ï¼š\ngRPCï¼ˆ9848ï¼‰è¢«é˜²ç«å¢™æ‹¦æˆª å®¢æˆ·ç«¯å¿ƒè·³ä¸¢åŒ… K8S LivenessProbe å¤ªä¸¥æ ¼ ä¸åŒèŠ‚ç‚¹æ•°æ®ä¸åŒæ­¥ ä¸‰ã€é…ç½®ä¸­å¿ƒï¼ˆConfigï¼‰ç±» 9. Nacos é…ç½®æ¨é€åŸç†ï¼Ÿ Nacos 2.x ä½¿ç”¨ gRPC push ä»£æ›¿ 1.x çš„ é•¿è½®è¯¢ã€‚\næµç¨‹ï¼š\nå®¢æˆ·ç«¯å»ºç«‹ gRPC stream æœåŠ¡ç«¯ç›‘å¬é…ç½®å˜æ›´ æœ‰å˜æ›´å³æ—¶æ¨é€åˆ°å®¢æˆ·ç«¯ å®¢æˆ·ç«¯åˆ·æ–°é…ç½® 10. DataId / Group / Namespace çš„åŒºåˆ«ï¼Ÿ å…ƒç´  ä½œç”¨ DataId ä¸€ä¸ªå…·ä½“é…ç½®æ–‡ä»¶å Group ä¸šåŠ¡ç»´åº¦éš”ç¦»ï¼ˆæ¯”å¦‚ order-serviceï¼‰ Namespace ç¯å¢ƒéš”ç¦»ï¼ˆdev/test/prodï¼‰ 11. ä¸¤ä¸ªæœåŠ¡ DataId ç›¸åŒä¼šå†²çªå—ï¼Ÿ ä¸ä¼šï¼Œåªè¦ Group æˆ– Namespace ä¸åŒã€‚\nå››ã€é›†ç¾¤ä¸å­˜å‚¨ç±» 12. Nacos é›†ç¾¤åŸç†ï¼Ÿå¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Ÿ Nacos é›†ç¾¤éœ€è¦ 3 ä¸ªä»¥ä¸ŠèŠ‚ç‚¹ã€‚\næ ¸å¿ƒï¼š\nä½¿ç”¨ Distro åè®® å¤„ç†ä¸´æ—¶å®ä¾‹ ä½¿ç”¨ Raft å¤„ç†æŒä¹…åŒ–æ•°æ® æ•°æ®æŒä¹…åŒ–åœ¨ MySQL å¤§å¤šæ•°å†™è¯·æ±‚å…¨éƒ¨å†™å…¥ MySQLï¼Œå†åŒæ­¥åˆ°é›†ç¾¤å…¶ä»–èŠ‚ç‚¹ã€‚\n13. ä¸ºä»€ä¹ˆ Nacos ä¸èƒ½ä½¿ç”¨ 2 èŠ‚ç‚¹é›†ç¾¤ï¼Ÿ ä¼š è„‘è£‚ã€‚Nacos éœ€è¦ \u0026gt;=3 èŠ‚ç‚¹æ‰èƒ½ä¿è¯ä¸€è‡´æ€§ã€‚\n14. ä¸ºä»€ä¹ˆ Nacos å¿…é¡»ä½¿ç”¨ MySQLï¼Ÿ å› ä¸ºï¼š\né…ç½®ä¸­å¿ƒéœ€è¦æŒä¹…åŒ– æŒä¹…å®ä¾‹éœ€è¦å­˜å‚¨ é›†ç¾¤åŒæ­¥éœ€è¦ç»Ÿä¸€çš„å­˜å‚¨ 15. cluster.conf é…é”™ä¼šæ€æ ·ï¼Ÿ èŠ‚ç‚¹äº’ç›¸ä¸è®¤è¯† æœåŠ¡æ³¨å†Œä¸ä¸€è‡´ å®¢æˆ·ç«¯çœ‹åˆ°çš„èŠ‚ç‚¹ä¸ä¸€è‡´ èŠ‚ç‚¹äº’ç›¸å¥åº·æ£€æŸ¥å¤±è´¥ äº”ã€Nacos ä¸ Spring Cloud Alibaba 16. Spring Cloud Alibaba å¦‚ä½•ä¸ Nacos é›†æˆï¼Ÿ ä½¿ç”¨ä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-alibaba-nacos-discovery\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®ï¼š\nspring: cloud: nacos: server-addr: nacos:8848 17. @RefreshScope æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ è®© Bean æ”¯æŒåŠ¨æ€åˆ·æ–°ã€‚\næ—  @RefreshScope -\u0026gt; ä¿®æ”¹é…ç½®æ— æ³•åˆ·æ–° æœ‰ @RefreshScope -\u0026gt; è‡ªåŠ¨æ›´æ–° 18. ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯é…ç½®ä¸åˆ·æ–°ï¼Ÿ åŸå› ï¼š\n@RefreshScope æœªåŠ  gRPC é€šé“æ–­å¼€ å®¢æˆ·ç«¯ä½¿ç”¨äº†å•èŠ‚ç‚¹è€Œä¸æ˜¯ LB YAML æ ¼å¼é”™è¯¯ å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸æ¶æ„ç±» 19. Nacos æ€§èƒ½ç“¶é¢ˆæ˜¯ä»€ä¹ˆï¼Ÿ MySQL å†™å…¥æ…¢ï¼ˆæœ€ä¸»è¦ï¼‰ JVM GC å¯¼è‡´å¡é¡¿ é…ç½®æ¨é€è¿‡å¤š åŒæ—¶ç›‘å¬é…ç½®çš„å®¢æˆ·ç«¯å¤ªå¤š 20. å¦‚ä½•æå‡ Nacos é›†ç¾¤æ€§èƒ½ï¼Ÿ è°ƒæ•´ JVMï¼š-Xms4g -Xmx4g MySQL buffer pool è°ƒå¤§ ä¸º config_info åŠ ç´¢å¼• ä½¿ç”¨ namespace åˆ†ç¯å¢ƒ æœåŠ¡æ‹† group æ‰©å®¹ Nacos èŠ‚ç‚¹ 21. Nacos å¦‚ä½•ä¿è¯ AP/CP åˆ‡æ¢ï¼Ÿ æ³¨å†Œä¸­å¿ƒï¼ˆä¸´æ—¶å®ä¾‹ï¼‰-\u0026gt; AP é…ç½®ä¸­å¿ƒï¼ˆæŒä¹…åŒ–ï¼‰-\u0026gt; CP Nacos åŒæ—¶æ»¡è¶³ AP å’Œ CPã€‚\nä¸ƒã€æ•…éšœæ’æŸ¥ç±»\n22. æœåŠ¡æ³¨å†Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ æ£€æŸ¥ï¼š\ngRPC ç«¯å£ 9848 Nacos server-addr é…ç½®æ˜¯å¦å†™äº† LB èŠ‚ç‚¹é—´ 7848 æ˜¯å¦äº’é€š æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ /nacos/v1/ns/operator/servers æŸ¥çœ‹ naming-server.log 23. é…ç½®ä¸åˆ·æ–°æ€ä¹ˆåŠï¼Ÿ æ’æŸ¥ï¼š\ntelnet 9848 YAML æ ¼å¼ @RefreshScope DataId / Namespace æ˜¯å¦æ­£ç¡® config-server.log æ˜¯å¦æŠ¥é”™ 24. ä¸ºä»€ä¹ˆ Nacos èŠ‚ç‚¹çŠ¶æ€æ˜¾ç¤º DOWNï¼Ÿ åŸå› ï¼š\n7848 æœªæ‰“é€š cluster.conf é…é”™ Docker/K8S NAT é—®é¢˜ æ—¶é’Ÿä¸åŒæ­¥ å…«ã€å®‰å…¨ä¸è¿ç»´ç±» 25. Nacos æƒé™æ§åˆ¶å¦‚ä½•åšï¼Ÿ é€šè¿‡ Auth + Tokenï¼š\nç”¨æˆ·ç®¡ç† è§’è‰²ç®¡ç† æƒé™æ§åˆ¶ï¼ˆnamespace çº§åˆ«ï¼‰ 26. å¦‚ä½•å¤‡ä»½ Nacosï¼Ÿ åªéœ€è¦å¤‡ä»½ MySQLï¼š\nmysqldump nacos \u0026gt; nacos.sql é…ç½®ä¸­å¿ƒæ‰€æœ‰æ•°æ®éƒ½åœ¨ DB ä¸­ã€‚\nä¹ è¿›é˜¶ 27. Nacos ä¸ºä»€ä¹ˆåœ¨ 2.x å¼•å…¥ gRPCï¼Ÿ å› ä¸ºï¼š\nHTTP é•¿è½®è¯¢è€—èµ„æº æ¨é€éœ€è¦å®æ—¶æ€§ èŠ‚ç‚¹é—´åŒæ­¥éœ€è¦é«˜æ€§èƒ½ æ”¯æŒé•¿è¿æ¥ ç»Ÿä¸€é€šä¿¡åè®® 28. Nacos æ˜¯å¦‚ä½•ä¿è¯æœåŠ¡ä¿¡æ¯æœ€ç»ˆä¸€è‡´çš„ï¼Ÿ ä¸´æ—¶å®ä¾‹ -\u0026gt; Distro åè®®ï¼ˆAPï¼‰ æŒä¹…åŒ–æ•°æ® -\u0026gt; Raftï¼ˆCPï¼‰ MySQL ç»Ÿä¸€å­˜å‚¨ èŠ‚ç‚¹é—´å®šæ—¶å…¨åŒæ­¥ 29. Nacos å¦‚ä½•å¤„ç†å¤§è§„æ¨¡å®¢æˆ·ç«¯ (\u0026gt;10 ä¸‡å®ä¾‹)ï¼Ÿ å®¢æˆ·ç«¯åˆ†æ‰¹æ¨é€ å‹ç¼©æ¨é€æ•°æ® gRPC å¤ç”¨è¿æ¥ æ‹‰æ¨¡å¼ + æ¨æ¨¡å¼ç»“åˆ å¤§è§„æ¨¡æƒ…å†µä¸‹éœ€è¦ å¤šé›†ç¾¤åˆ†åŒº ","description":"å†…å®¹ï¼šåŸºç¡€ã€æ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒã€é›†ç¾¤ã€é«˜å¯ç”¨ã€åŸç†ã€æ€§èƒ½ã€è¿ç»´ã€Spring Cloud Alibaba é›†æˆç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µç±» 1. ä»€ä¹ˆæ˜¯ Nacosï¼Ÿèƒ½åšä»€ä¹ˆï¼Ÿ Nacos æ˜¯é˜¿é‡Œå¼€æºçš„ æœåŠ¡æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒï¼Œä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›ï¼š\nNamingï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰\næœåŠ¡æ³¨å†Œ/å‘ç° å¥åº·æ£€æŸ¥ è´Ÿè½½å‡è¡¡ Configï¼ˆé…ç½®ä¸­å¿ƒï¼‰\né…ç½®çƒ­æ›´æ–° é…ç½®ç›‘å¬ å¤šç¯å¢ƒéš”ç¦» Gray é…ç½®ï¼ˆç°åº¦ï¼‰ æ ¸å¿ƒç›®æ ‡æ˜¯å¸®åŠ©å¾®æœåŠ¡æ²»ç†ã€‚\n2 Nacos å’Œ Eureka çš„åŒºåˆ«ï¼Ÿ ç‰¹æ€§ Nacos Eureka æ³¨å†Œä¸­å¿ƒæ”¯æŒ âœ…ï¼ˆå¼ºï¼‰ âœ… é…ç½®ä¸­å¿ƒ âœ…ï¼ˆå¼ºï¼‰ âŒ é›†ç¾¤ä¸€è‡´æ€§åè®® Distro + Raft AP å¥åº·æ£€æŸ¥ æœåŠ¡ç«¯ä¸»åŠ¨æ£€æŸ¥ å®¢æˆ·ç«¯å¿ƒè·³ gRPC é€šä¿¡ âœ…ï¼ˆå¼ºï¼‰ âŒ åŠ¨æ€é…ç½® âœ… âŒ æƒé™æ§åˆ¶ âœ… âŒ Nacos æ˜¯â€œæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒâ€ï¼ŒåŠŸèƒ½è¿œå¼ºäº Eurekaã€‚\n"},{"id":23,"href":"/operations/nginx/faq/","title":"Nginx FAQ","parent":"Nginx","content":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€æ€§èƒ½ä¼˜åŒ–ã€æ•…éšœæ’æŸ¥ã€é…ç½®ç»†èŠ‚ã€HTTPSã€HTTP/2ã€OpenResty ç­‰ã€‚\nä¸€ã€åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ 1. Nginx çš„å·¥ä½œæ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ åŸºäº å¤šè¿›ç¨‹ + å•çº¿ç¨‹ + å¼‚æ­¥éé˜»å¡äº‹ä»¶é©±åŠ¨ï¼ˆepollï¼‰ master è´Ÿè´£ç®¡ç†ï¼Œworker å¤„ç†è¯·æ±‚ æ¯ä¸ª worker ç”¨å¼‚æ­¥ IOï¼ˆepoll/kqueueï¼‰å¤„ç†å¤§é‡è¿æ¥ æ— çº¿ç¨‹åˆ‡æ¢ä¸Šä¸‹æ–‡å¼€é”€ Nginx é‡‡ç”¨äº† â€œmaster + workerâ€ æ¨¡å‹ï¼Œworker ä½¿ç”¨ epoll äº‹ä»¶é©±åŠ¨æ¨¡å‹å¤„ç†è¯·æ±‚ï¼Œå¼‚æ­¥éé˜»å¡ï¼Œæ— éœ€ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºçº¿ç¨‹ï¼Œå› æ­¤ä¸Šä¸‹æ–‡åˆ‡æ¢å°‘ã€å¼€é”€å°ï¼Œä¸ä¼šè¢«æ…¢è¿æ¥é˜»å¡ï¼Œå› æ­¤ååé‡é«˜ã€å»¶è¿Ÿä½ã€‚\n2. Nginx å¸¸è§çš„å‡ ç§è§’è‰²ï¼ˆç”¨é€”ï¼‰ï¼Ÿ åå‘ä»£ç†ï¼šåç«¯é›†ç¾¤è´Ÿè½½å‡è¡¡ æ­£å‘ä»£ç†ï¼šä»£ç†å®¢æˆ·ç«¯è®¿é—®å¤–ç½‘ HTTP æœåŠ¡å™¨ï¼šç”¨ä½œ Web Serverï¼ˆé™æ€èµ„æºï¼‰ è´Ÿè½½å‡è¡¡å™¨ï¼šRound robin / IP hash / Least connections ç­‰ ç¼“å­˜æœåŠ¡å™¨ï¼šFastCGI cache / proxy cache API ç½‘å…³ / ACL é™åˆ¶ / WAF 3. Nginx æ”¯æŒå“ªäº›è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Ÿ æ ‡å‡†ç®—æ³•ï¼š\nround robinï¼ˆé»˜è®¤ï¼‰ weighted round robin least_connï¼ˆæœ€å°‘è¿æ¥ï¼‰ ip_hashï¼ˆç²˜æ€§ï¼‰ hashï¼ˆURI çº§åˆ« hashï¼‰ æ‰©å±•ï¼š\nfairï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼ŒæŒ‰å“åº”é€Ÿåº¦ï¼‰ consistent hashï¼ˆä¸€è‡´æ€§ Hashï¼Œupstream_chashï¼‰ 4. Nginx æœ‰å“ªäº›å¸¸è§æ¨¡å—ï¼Ÿ http æ¨¡å—ï¼šåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ stream æ¨¡å—ï¼šTCP/UDP å››å±‚ä»£ç† mail æ¨¡å— realip æ¨¡å—ï¼šè·å–çœŸå® IP ssl æ¨¡å— gzip æ¨¡å— rewrite æ¨¡å— proxy / fastcgi / uwsgi æ¨¡å— äºŒã€é…ç½®ä¸å®æˆ˜åœºæ™¯ 5. Nginx ä¸­ root ä¸ alias çš„åŒºåˆ«ï¼Ÿ æŒ‡ä»¤ è¡Œä¸º root ä¼šæ‹¼æ¥ location è·¯å¾„ alias ä¸ä¼šè‡ªåŠ¨æ‹¼æ¥è·¯å¾„ ç¤ºä¾‹ï¼š\nlocation /img/ { root /data/web; } å®é™…æ–‡ä»¶è·¯å¾„ï¼š/data/web/img/xxx.jpg\nlocation /img/ { alias /data/web/images/; } å®é™…æ–‡ä»¶è·¯å¾„ï¼š/data/web/images/xxx.jpg\n6. Nginx ä¸­ try_files çš„ä½œç”¨ï¼Ÿ æŒ‰é¡ºåºæ£€æŸ¥æ–‡ä»¶/ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œæœ€å fallback åˆ°æŸä¸ª URIã€‚\nå¸¸ç”¨äº SPAï¼ˆå¦‚ React/ Vueï¼‰ï¼š\ntry_files $uri $uri/ /index.html; 7. proxy_pass å†™æ³•ï¼šå¸¦è·¯å¾„ vs ä¸å¸¦è·¯å¾„åŒºåˆ«ï¼Ÿ ä¸å¸¦ /ï¼š\nlocation /api/ { proxy_pass http://backend; } ä¼šä¿ç•™ /api/ã€‚\nå¸¦ /ï¼š\nproxy_pass http://backend/; ä¼šæˆªæ–­ /api/ã€‚\nä¸‰ã€HTTPS / HTTP/2 / SSL 8. å¦‚ä½•å¯ç”¨ HTTP/2ï¼Ÿ æ–°ç‰ˆ Nginx æ˜¯ï¼š\nlisten 443 ssl; http2 on; 9. Nginx å¦‚ä½•å¤„ç† HTTPS ç»ˆæ­¢ï¼ˆSSL terminationï¼‰ï¼Ÿ Nginx è§£ TLSï¼Œåç«¯ä½¿ç”¨ httpï¼š\nproxy_set_header X-Forwarded-Proto $scheme; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 10. å¦‚ä½•å¯ç”¨ WebSocket è½¬å‘ï¼Ÿ éœ€è¦ Upgrade å¤´ï¼š\nproxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; å››ã€åå‘ä»£ç†ä¸ X-Forwarded ç³»åˆ— 11. X-Forwarded-For ä¸ X-Real-IP åŒºåˆ«ï¼Ÿ å¤´éƒ¨ å«ä¹‰ X-Forwarded-For å®¢æˆ·ç«¯ + æ‰€æœ‰ä»£ç†é“¾è·¯ IP X-Real-IP æœ€æ¥è¿‘ Nginx çš„ä¸Šä¸€è·³ å¸¸ç”¨ï¼š\nproxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 12. ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ proxy_redirectï¼Ÿ å½“åç«¯è¿”å› 302/Location æ—¶è·¯å¾„ä¸å¯¹ï¼š\nLocation: http://127.0.0.1/ æ”¹æˆï¼š\nLocation: https://yourdomain.com/abc/ ä»£è¡¨æ€§ä¾‹å­ï¼šJenkinsã€GitLabã€Keycloakã€‚\näº”ã€è´Ÿè½½å‡è¡¡è¿›é˜¶ 13. upstream ä¸­ keepalive æœ‰ä»€ä¹ˆç”¨ï¼Ÿ ä¿æŒä¸åç«¯çš„é•¿è¿æ¥ï¼Œå‡å°‘ TCP å»ºç«‹æˆæœ¬ï¼š\nupstream backend { server 10.0.0.1; keepalive 32; } æå‡é«˜å¹¶å‘æ€§èƒ½ã€‚\n14. upstream æœåŠ¡å™¨å¥åº·æ£€æŸ¥å¦‚ä½•å®ç°ï¼Ÿ Nginx å¼€æºç‰ˆï¼šæ— ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼Œåªèƒ½é€šè¿‡å¤±è´¥å°è¯•è¢«åŠ¨æ£€æŸ¥ã€‚\nä¼ä¸šç‰ˆ / openresty çš„ lua + healthcheck å¯ä»¥å®ç°ä¸»åŠ¨æ¢æµ‹ã€‚\n15. å¦‚ä½•å®ç° session stickyï¼Ÿ ip_hash sticky cookieï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ upstream_hashï¼ˆkeyï¼‰ å…­ã€æ€§èƒ½ä¼˜åŒ–ç±» 16. worker_processes å¦‚ä½•è®¾ç½®ï¼Ÿ é€šå¸¸ä¸ CPU æ ¸å¿ƒæ•°ä¸€è‡´ï¼š\nworker_processes auto; 17. worker_connections å¦‚ä½•è®¡ç®—æœ€å¤§å¹¶å‘ï¼Ÿ æœ€å¤§å¹¶å‘ = worker_processes * worker_connections\n18. sendfile / tcp_nopush / tcp_nodelay çš„ä½œç”¨ï¼Ÿ sendfileï¼šé›¶æ‹·è´å‘é€ï¼Œæé«˜é™æ€æ–‡ä»¶æ€§èƒ½ tcp_nopushï¼šé…åˆ sendfileï¼Œè®©å¤§åŒ…ä¼˜å…ˆå‘é€ tcp_nodelayï¼šç”¨äºå®æ—¶å“åº”ï¼ˆå¦‚å°åŒ…ï¼‰ æ¨èç”Ÿäº§é…ç½®ï¼š\nsendfile on; tcp_nopush on; tcp_nodelay on; 19. proxy_buffering on/off åŒºåˆ«ï¼Ÿ åŠŸèƒ½ on off ç¼“å†²åç«¯å“åº” æ˜¯ å¦ èƒ½åŠ é€Ÿç”¨æˆ·ï¼Ÿ æ˜¯ å¦ èƒ½ä¿æŠ¤åç«¯ï¼Ÿ æ˜¯ å¦ WebSocket / SSE å¦ å¿…é¡» off Jenkins å®˜æ–¹ï¼šproxy_buffering off;\n20. gzip å‹ç¼©æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼Ÿ ä¸è¦å‹ç¼©å›¾ç‰‡/video åªå‹ç¼©æ–‡æœ¬ç±»ï¼šhtml/json/css/js é¿å…å‹ç¼©å·²å‹ç¼©å†…å®¹ ä¸ƒã€Nginx æ•…éšœæ’æŸ¥ 21. 502 / 504 å¸¸è§åŸå› ï¼Ÿ 502ï¼ˆBad Gatewayï¼‰\nåç«¯æœåŠ¡æŒ‚äº† åç«¯ç«¯å£æ— æ³•è®¿é—® FastCGI è¶…æ—¶ PHP-FPM æ…¢ / å´©æºƒ 504ï¼ˆGateway Timeoutï¼‰\nåç«¯å“åº”æ…¢ proxy_read_timeout å¤ªå° 22. Nginx é…ç½®ç”Ÿæ•ˆä½†æµè§ˆå™¨ä¸å˜ï¼Ÿ å¸¸è§åŸå› ï¼š\nupstream ç¼“å­˜ CDN ç¼“å­˜ æµè§ˆå™¨ç¼“å­˜ï¼ˆå¼ºç¼“å­˜ï¼‰ proxy_cache æœªå…³é—­ å†—ä½™ server block ä¼˜å…ˆçº§é”™è¯¯ï¼ˆç«¯å£/hostï¼‰ 23. Nginx æ—¥å¿—ä¸­å¦‚ä½•å®šä½é—®é¢˜ï¼Ÿ æ ¸å¿ƒè°ƒè¯•æ—¥å¿—ï¼š\nerror.log debug; access.log combined; debug æ¨¡å¼ï¼š\nerror_log /var/log/nginx/error.log debug; å…«ã€OpenResty å’Œ Nginx lua æ‰©å±• 24. OpenResty æ˜¯ä»€ä¹ˆï¼Ÿ åŸºäº Nginx + LuaJIT çš„é«˜æ€§èƒ½å¹³å°ï¼Œå¯ç”¨äºï¼š\nAPI ç½‘å…³ åŠ¨æ€ WAF å¤æ‚è·¯ç”± åŠ¨æ€é™æµ ç¼“å­˜ç³»ç»Ÿ 25. Nginx + Lua çš„å…¸å‹ä½¿ç”¨åœºæ™¯ï¼Ÿ åŠ¨æ€åˆ†æµ / AB test å¤æ‚é‰´æƒ token æ ¡éªŒ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ åŠ¨æ€ upstream ä¹ã€çœŸé¢˜ / æ·±åº¦é¢˜ 26. Nginx ä¸ºä½•é€‚åˆé«˜å¹¶å‘ï¼Ÿ å¼‚æ­¥éé˜»å¡äº‹ä»¶é©±åŠ¨ï¼ˆepollï¼‰ worker å•çº¿ç¨‹æ— é”ç«äº‰ å†…å­˜ç®¡ç†ä¼˜ç§€ï¼ˆpoolï¼‰ é›¶æ‹·è´ sendfile å¤šæ ¸åˆ©ç”¨ç‡é«˜ï¼ˆworker_processes autoï¼‰ ç¨³å®šæˆç†Ÿ 27. Nginx æ€æ ·å¤„ç†ä¸€ä¸ª HTTP è¯·æ±‚ï¼Ÿï¼ˆæµç¨‹ï¼‰ master fork å‡º workers worker æ¥æ”¶è¿æ¥ event æ¨¡å‹ï¼ˆepollï¼‰å°†äº‹ä»¶åŠ å…¥é˜Ÿåˆ— http æ¨¡å—è§£æè¯·æ±‚ åŒ¹é… location è½¬å‘åˆ° upstream æˆ–è¿”å›é™æ€æ–‡ä»¶ è®°å½•æ—¥å¿— æ¯ä¸€æ­¥éƒ½å¯è¢«æ¨¡å— hookã€‚\n","description":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ã€æ€§èƒ½ä¼˜åŒ–ã€æ•…éšœæ’æŸ¥ã€é…ç½®ç»†èŠ‚ã€HTTPSã€HTTP/2ã€OpenResty ç­‰ã€‚\nä¸€ã€åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ 1. Nginx çš„å·¥ä½œæ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ åŸºäº å¤šè¿›ç¨‹ + å•çº¿ç¨‹ + å¼‚æ­¥éé˜»å¡äº‹ä»¶é©±åŠ¨ï¼ˆepollï¼‰ master è´Ÿè´£ç®¡ç†ï¼Œworker å¤„ç†è¯·æ±‚ æ¯ä¸ª worker ç”¨å¼‚æ­¥ IOï¼ˆepoll/kqueueï¼‰å¤„ç†å¤§é‡è¿æ¥ æ— çº¿ç¨‹åˆ‡æ¢ä¸Šä¸‹æ–‡å¼€é”€ Nginx é‡‡ç”¨äº† â€œmaster + workerâ€ æ¨¡å‹ï¼Œworker ä½¿ç”¨ epoll äº‹ä»¶é©±åŠ¨æ¨¡å‹å¤„ç†è¯·æ±‚ï¼Œå¼‚æ­¥éé˜»å¡ï¼Œæ— éœ€ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºçº¿ç¨‹ï¼Œå› æ­¤ä¸Šä¸‹æ–‡åˆ‡æ¢å°‘ã€å¼€é”€å°ï¼Œä¸ä¼šè¢«æ…¢è¿æ¥é˜»å¡ï¼Œå› æ­¤ååé‡é«˜ã€å»¶è¿Ÿä½ã€‚\n2. Nginx å¸¸è§çš„å‡ ç§è§’è‰²ï¼ˆç”¨é€”ï¼‰ï¼Ÿ åå‘ä»£ç†ï¼šåç«¯é›†ç¾¤è´Ÿè½½å‡è¡¡ æ­£å‘ä»£ç†ï¼šä»£ç†å®¢æˆ·ç«¯è®¿é—®å¤–ç½‘ HTTP æœåŠ¡å™¨ï¼šç”¨ä½œ Web Serverï¼ˆé™æ€èµ„æºï¼‰ è´Ÿè½½å‡è¡¡å™¨ï¼šRound robin / IP hash / Least connections ç­‰ ç¼“å­˜æœåŠ¡å™¨ï¼šFastCGI cache / proxy cache API ç½‘å…³ / ACL é™åˆ¶ / WAF 3. Nginx æ”¯æŒå“ªäº›è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Ÿ æ ‡å‡†ç®—æ³•ï¼š\n"},{"id":24,"href":"/backend/python/official/","title":"Official","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£ï¼š\nPython æ•™ç¨‹ Python è¯­è¨€å‚è€ƒæ‰‹å†Œ Python æ ‡å‡†åº“ Python æŒ‡å— Directory List:\nPython FAQ Python åŸºç¡€æ•™ç¨‹ Python æ ¸å¿ƒæ¦‚å¿µ Python å®˜æ–¹æ•™ç¨‹æ€»ç»“ Python é«˜çº§ç”¨æ³• Python é‡ç‚¹å’Œéš¾ç‚¹ Python æœ€ä½³å®è·µ Python æƒ¯ç”¨æ³• next/map/filter/lambda æœ€ä½³å®è·µ Async (å¼‚æ­¥) Async \u0026#43; Multiprocessing Asyncio Basic Operations (åŸºæœ¬è¿ç®—) Built-in Functions (å†…ç½®å‡½æ•°) Built-in Types (å†…ç½®ç±»å‹) Class (ç±») Closure (é—­åŒ…) Collections (å¢å¼ºæ•°æ®ç»“æ„) Context (ä¸Šä¸‹æ–‡) Copy (æ‹·è´) Data Processing (æ•°æ®å¤„ç†) Datetime (æ—¥æœŸæ—¶é—´) Decimal (åè¿›åˆ¶å°æ•°) Decorator -- classmethod Decorator -- dataclass Decorator -- property Decorator -- staticmethod Decorator -- staticmethod / classmethod / property çš„è¶…å¼ºå¯¹æ¯”è¡¨ Decorator (è£…é¥°å™¨) Dict (å­—å…¸) Enumerate (æšä¸¾) Eval å‡½æ•° f-string Filter å‡½æ•° For (å¾ªç¯) Function (å‡½æ•°) Functional Programming (å‡½æ•°å¼ç¼–ç¨‹) Functools -- cache Functools -- cached_property Functools -- cmp_to_key Functools -- lru_cache Functools -- partial Functools -- partialmethod Functools -- reduce Functools -- singledispatch Functools -- singledispatchmethod Functools -- total_ordering Functools -- update_wrapper Functools -- wraps Get ENV (è·å–ç¯å¢ƒå˜é‡) If (æ¡ä»¶åˆ¤æ–­) Itertools (é«˜æ€§èƒ½è¿­ä»£å™¨å·¥å…·åº“) JSON Lambda Lazy (æƒ°æ€§) List (åˆ—è¡¨) List / Tuple / Set Map å‡½æ•° Match (åŒ¹é…) Multiprocessing (å¤šè¿›ç¨‹) Next å‡½æ•° OS åº“ Queue (é˜Ÿåˆ—) Random Range Regex (æ­£åˆ™è¡¨è¾¾å¼) Regex compile (æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘) Set (é›†åˆ) Sort (æ’åº) String (å­—ç¬¦ä¸²) TOML Try Tuple (å…ƒç»„) Unpacking (è§£åŒ…) Variable (å˜é‡) While (å¾ªç¯) With Yield å‡½æ•° Zip å‡½æ•° ","description":"å®˜æ–¹æ–‡æ¡£ï¼š\nPython æ•™ç¨‹ Python è¯­è¨€å‚è€ƒæ‰‹å†Œ Python æ ‡å‡†åº“ Python æŒ‡å— Directory List:\nPython FAQ Python åŸºç¡€æ•™ç¨‹ Python æ ¸å¿ƒæ¦‚å¿µ Python å®˜æ–¹æ•™ç¨‹æ€»ç»“ Python é«˜çº§ç”¨æ³• Python é‡ç‚¹å’Œéš¾ç‚¹ Python æœ€ä½³å®è·µ Python æƒ¯ç”¨æ³• next/map/filter/lambda æœ€ä½³å®è·µ Async (å¼‚æ­¥) Async \u0026#43; Multiprocessing Asyncio Basic Operations (åŸºæœ¬è¿ç®—) Built-in Functions (å†…ç½®å‡½æ•°) Built-in Types (å†…ç½®ç±»å‹) Class (ç±») Closure (é—­åŒ…) Collections (å¢å¼ºæ•°æ®ç»“æ„) Context (ä¸Šä¸‹æ–‡) Copy (æ‹·è´) Data Processing (æ•°æ®å¤„ç†) Datetime (æ—¥æœŸæ—¶é—´) Decimal (åè¿›åˆ¶å°æ•°) Decorator -- classmethod Decorator -- dataclass Decorator -- property Decorator -- staticmethod Decorator -- staticmethod / classmethod / property çš„è¶…å¼ºå¯¹æ¯”è¡¨ Decorator (è£…é¥°å™¨) Dict (å­—å…¸) Enumerate (æšä¸¾) Eval å‡½æ•° f-string Filter å‡½æ•° For (å¾ªç¯) Function (å‡½æ•°) Functional Programming (å‡½æ•°å¼ç¼–ç¨‹) Functools -- cache Functools -- cached_property Functools -- cmp_to_key Functools -- lru_cache Functools -- partial Functools -- partialmethod Functools -- reduce Functools -- singledispatch Functools -- singledispatchmethod Functools -- total_ordering Functools -- update_wrapper Functools -- wraps Get ENV (è·å–ç¯å¢ƒå˜é‡) If (æ¡ä»¶åˆ¤æ–­) Itertools (é«˜æ€§èƒ½è¿­ä»£å™¨å·¥å…·åº“) JSON Lambda Lazy (æƒ°æ€§) List (åˆ—è¡¨) List / Tuple / Set Map å‡½æ•° Match (åŒ¹é…) Multiprocessing (å¤šè¿›ç¨‹) Next å‡½æ•° OS åº“ Queue (é˜Ÿåˆ—) Random Range Regex (æ­£åˆ™è¡¨è¾¾å¼) Regex compile (æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘) Set (é›†åˆ) Sort (æ’åº) String (å­—ç¬¦ä¸²) TOML Try Tuple (å…ƒç»„) Unpacking (è§£åŒ…) Variable (å˜é‡) While (å¾ªç¯) With Yield å‡½æ•° Zip å‡½æ•° "},{"id":25,"href":"/backend/python/orjson/tutorial/","title":"orjson åŸºç¡€æ•™ç¨‹","parent":"orjson","content":" ğŸš€ ä¸€ã€orjson æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ¯” json å¿«ï¼Ÿ orjson æ˜¯ç›®å‰ Pythonæœ€å¿«çš„ JSON åº“ï¼ˆåŸºäº Rust å®ç°ï¼‰ï¼Œç‰¹ç‚¹ï¼š\nåºåˆ—åŒ–ï¼ˆdumpsï¼‰é€Ÿåº¦ 10â€“20 å€äºå†…ç½® json ååºåˆ—åŒ–ï¼ˆloadsï¼‰é€Ÿåº¦ 5â€“10 å€ å†…ç½®æ”¯æŒï¼š datetime date uuid.UUID numpy dataclass è‡ªåŠ¨è¾“å‡º UTF-8ï¼Œä¸éœ€è¦ ensure_ascii=False dumps è¾“å‡º bytesï¼ˆä¸æ˜¯ strï¼‰ å®‰è£…ï¼š\npip install orjson ğŸš€ äºŒã€orjson åŸºç¡€ç”¨æ³• 1. ååºåˆ—åŒ–ï¼šorjson.loads() import orjson data = orjson.loads(b\u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39;) print(data) # {\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 2} æ³¨æ„ï¼šorjson æ¥å— bytes æˆ– strã€‚\n2. åºåˆ—åŒ–ï¼šorjson.dumps() import orjson s = orjson.dumps({\u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;}) print(s) # b\u0026#39;{\u0026#34;name\u0026#34;:\u0026#34;martin\u0026#34;}\u0026#39; print(s.decode()) # {\u0026#34;name\u0026#34;:\u0026#34;martin\u0026#34;} å…³é”®å·®åˆ«ï¼š\nâœ… è¿”å›å€¼æ°¸è¿œæ˜¯ bytes âŒ ä¸è¿”å› strï¼ˆè¿™æ˜¯ orjson çš„ç‰¹ç‚¹ï¼‰ ğŸš€ ä¸‰ã€orjson dumps å¸¸ç”¨å‚æ•°ï¼ˆéå¸¸é‡è¦ï¼‰ 1. ç¾åŒ–è¾“å‡ºï¼ˆç­‰äº json.dumps(indent=2)ï¼‰ orjson.dumps(data, option=orjson.OPT_INDENT_2) 2. è¾“å‡ºæ’åº Keyï¼ˆJSON æŒ‰å­—æ¯é¡ºåºæ’ keyï¼‰ orjson.dumps(data, option=orjson.OPT_SORT_KEYS) 3. å…è®¸éå­—ç¬¦ä¸² keyï¼ˆè‡ªåŠ¨è½¬å­—ç¬¦ä¸²ï¼‰ orjson.dumps({1: \u0026#34;a\u0026#34;}, option=orjson.OPT_NON_STR_KEYS) # b\u0026#39;{\u0026#34;1\u0026#34;:\u0026#34;a\u0026#34;}\u0026#39; 4. åºåˆ—åŒ– UTC datetimeï¼ˆISO8601 æ ¼å¼ï¼‰ from datetime import datetime, timezone now = datetime.now(timezone.utc) orjson.dumps({\u0026#34;time\u0026#34;: now}) # b\u0026#39;{\u0026#34;time\u0026#34;:\u0026#34;2025-02-16T08:25:41.222Z\u0026#34;}\u0026#39; orjson é»˜è®¤æ”¯æŒï¼š\ndatetime date time timedelta uuid.UUID å†…ç½® json æ˜¯ä¸æ”¯æŒçš„ã€‚\n5. åˆå¹¶å¤šä¸ª option æ³¨æ„ç”¨ |ï¼š\norjson.dumps( data, option=orjson.OPT_INDENT_2 | orjson.OPT_SORT_KEYS ) ğŸš€ å››ã€è‡ªå®šä¹‰åºåˆ—åŒ– default ç›¸å½“äº json.dumps(... default=fn)ã€‚\nä¾‹ï¼šæ”¯æŒ Decimalï¼š\nimport orjson from decimal import Decimal def default(obj): if isinstance(obj, Decimal): return float(obj) raise TypeError data = {\u0026#34;amount\u0026#34;: Decimal(\u0026#34;12.34\u0026#34;)} print(orjson.dumps(data, default=default)) ğŸš€ äº”ã€orjson ä¸æ”¯æŒçš„æƒ…å†µï¼ˆå¸¸è§å‘ï¼‰ Python ç±»å‹ json orjson set âŒ âŒ complex âŒ âŒ bytes âŒ âŒï¼ˆä¸ä¼šè‡ªåŠ¨ decodeï¼‰ datetime âŒ âœ… Decimal âŒ âŒï¼ˆéœ€è¦ defaultï¼‰ è‹¥é‡åˆ°é”™è¯¯ï¼š\nTypeError: Type is not JSON serializable ä½ å¿…é¡»ç”¨ defaultï¼š\norjson.dumps(obj, default=lambda o: str(o)) ğŸš€ å…­ã€orjson ä¸ json çš„å¯¹æ¯”ï¼ˆæ€§èƒ½ + ä½¿ç”¨ä½“éªŒï¼‰ åŠŸèƒ½ json orjson åºåˆ—åŒ–é€Ÿåº¦ æ™®é€š æœ€å¿«ï¼ˆRustï¼‰ ååºåˆ—åŒ–é€Ÿåº¦ æ™®é€š æ›´å¿« datetime è‡ªåŠ¨æ”¯æŒ âŒ âœ… unicode è¾“å‡º é»˜è®¤è½¬ \\uXXXX é»˜è®¤ UTF-8 è¿”å› str âœ… âŒï¼ˆè¿”å› bytesï¼‰ ç¾åŒ–è¾“å‡º indent option ğŸš€ ä¸ƒã€FastAPI + orjsonï¼ˆå¼ºçƒˆæ¨èï¼‰ ä½ å¯ä»¥è®©æ•´ä¸ª FastAPI è‡ªåŠ¨ä½¿ç”¨ orjson æ›¿ä»£ jsonï¼š\nfrom fastapi import FastAPI from fastapi.responses import ORJSONResponse app = FastAPI(default_response_class=ORJSONResponse) æ•´ä¸ªæ¥å£è¾“å‡ºé€Ÿåº¦æå‡æ˜æ˜¾ã€‚\nğŸš€ å…«ã€æœ€ä½³å®è·µï¼šå°è£…æˆ utils.json éå¸¸å»ºè®®ç›´æ¥å°è£…ï¼š\n# utils/json.py import orjson from decimal import Decimal from datetime import datetime, date def default(obj): if isinstance(obj, (datetime, date)): return obj.isoformat() if isinstance(obj, Decimal): return float(obj) return str(obj) def dumps(data, **kwargs) -\u0026gt; str: return orjson.dumps(data, default=default, **kwargs).decode() ä½¿ç”¨ï¼š\nfrom utils.json import dumps print(dumps({\u0026#34;time\u0026#34;: datetime.now()})) ğŸš€ ä¹ã€æ€»ç»“ï¼ˆä½ åªéœ€è¦è®°ä½è¿™äº›ï¼‰ orjson.dumps() è¿”å› bytesï¼Œéœ€è¦ .decode() å†…ç½®æ”¯æŒ datetime/date/uuidï¼Œä¸éœ€è¦ default ç¾åŒ–è¾“å‡ºï¼šOPT_INDENT_2 åˆå¹¶ option ç”¨ | æ€§èƒ½æ¯” json å¿«ä¸€å¤§æˆª FastAPI å¯ä»¥ç›´æ¥ç”¨ ORJSONResponse ","description":" ğŸš€ ä¸€ã€orjson æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ¯” json å¿«ï¼Ÿ orjson æ˜¯ç›®å‰ Pythonæœ€å¿«çš„ JSON åº“ï¼ˆåŸºäº Rust å®ç°ï¼‰ï¼Œç‰¹ç‚¹ï¼š\nåºåˆ—åŒ–ï¼ˆdumpsï¼‰é€Ÿåº¦ 10â€“20 å€äºå†…ç½® json ååºåˆ—åŒ–ï¼ˆloadsï¼‰é€Ÿåº¦ 5â€“10 å€ å†…ç½®æ”¯æŒï¼š datetime date uuid.UUID numpy dataclass è‡ªåŠ¨è¾“å‡º UTF-8ï¼Œä¸éœ€è¦ ensure_ascii=False dumps è¾“å‡º bytesï¼ˆä¸æ˜¯ strï¼‰ å®‰è£…ï¼š\npip install orjson ğŸš€ äºŒã€orjson åŸºç¡€ç”¨æ³• 1. ååºåˆ—åŒ–ï¼šorjson.loads() import orjson data = orjson.loads(b\u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39;) print(data) # {\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 2} æ³¨æ„ï¼šorjson æ¥å— bytes æˆ– strã€‚\n"},{"id":26,"href":"/backend/python/playwright/tutorial/","title":"Playwright åŸºç¡€æ•™ç¨‹","parent":"Playwright","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ è¶…å…¨ã€å®æˆ˜å‘çš„ Python Playwright æ•™ç¨‹ï¼Œæ¶µç›–å®‰è£…ã€åŸºæœ¬ç”¨æ³•ã€å¼‚æ­¥/åŒæ­¥ç‰ˆæœ¬ã€é¡µé¢æ“ä½œã€ç­‰å¾…æœºåˆ¶ã€æ¨¡æ‹Ÿç™»å½•ã€ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ã€çˆ¬è™«æŠ€å·§ã€åçˆ¬ç»•è¿‡ã€æˆªå›¾å½•å±ã€å¹¶å‘ç­‰å†…å®¹ï¼Œä¸€ç¯‡æå®š Playwrightã€‚\nPlaywright æ˜¯å¾®è½¯å‡ºå“çš„æ–°ä¸€ä»£æµè§ˆå™¨è‡ªåŠ¨åŒ–æ¡†æ¶ï¼Œæ”¯æŒï¼š\nChromiumã€Firefoxã€WebKit ä¸‰å¤§æµè§ˆå™¨ å¼ºå¤§çš„è‡ªåŠ¨ç­‰å¾…æœºåˆ¶ï¼ˆä¸ç”¨åƒ Selenium é‚£æ ·é¢‘ç¹å†™ sleepï¼‰ åŸç”Ÿæ”¯æŒå¼‚æ­¥ï¼ˆasync/awaitï¼‰ å¼ºåŠ›åçˆ¬èƒ½åŠ›ï¼ˆæ›´æ¥è¿‘çœŸå®æµè§ˆå™¨ï¼‰ 1. å®‰è£… Playwright pip install playwright å®‰è£…æµè§ˆå™¨å†…æ ¸ï¼š\nplaywright install å›½å†…å¦‚éœ€åŠ é€Ÿï¼š\nplaywright install chromium 2. Playwright çš„ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼šåŒæ­¥ vs å¼‚æ­¥ ä½ å¯ä»¥é€‰æ‹©ï¼š\n1. åŒæ­¥æ–¹å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ from playwright.sync_api import sync_playwright with sync_playwright() as p: browser = p.chromium.launch(headless=False) page = browser.new_page() page.goto(\u0026#34;https://example.com\u0026#34;) print(page.title()) browser.close() 2. å¼‚æ­¥æ–¹å¼ï¼ˆé«˜å¹¶å‘æ¨èï¼‰ import asyncio from playwright.async_api import async_playwright async def main(): async with async_playwright() as p: browser = await p.chromium.launch(headless=False) page = await browser.new_page() await page.goto(\u0026#34;https://example.com\u0026#34;) print(await page.title()) await browser.close() asyncio.run(main()) 3. æµè§ˆå™¨æ§åˆ¶ï¼šæ‰“å¼€æ¨¡å¼ æ— å¤´æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰\nbrowser = p.chromium.launch() å¯è§†åŒ–æ¨¡å¼\nbrowser = p.chromium.launch(headless=False) å¯ç”¨å¼€å‘è€…å·¥å…·\nbrowser = p.chromium.launch(headless=False, devtools=True) 4. é¡µé¢å¸¸ç”¨æ“ä½œ è®¿é—®ç½‘é¡µ\npage.goto(\u0026#34;https://www.baidu.com\u0026#34;) ç‚¹å‡»æŒ‰é’®\npage.click(\u0026#34;#submit\u0026#34;) è¾“å…¥æ–‡å­—\npage.fill(\u0026#34;#input-box\u0026#34;, \u0026#34;hello world\u0026#34;) è¿½åŠ è¾“å…¥\npage.type(\u0026#34;#q\u0026#34;, \u0026#34;playwright æ•™ç¨‹\u0026#34;) å›è½¦\npage.keyboard.press(\u0026#34;Enter\u0026#34;) è·å–æ–‡æœ¬\ntext = page.text_content(\u0026#34;.result\u0026#34;) è·å– html\nhtml = page.inner_html(\u0026#34;body\u0026#34;) è·å–å¤šå…ƒç´ \nitems = page.query_selector_all(\u0026#34;.list-item\u0026#34;) for item in items: print(item.text_content()) 5. è‡ªåŠ¨ç­‰å¾…æœºåˆ¶ï¼ˆPlaywright å·¨å¤§çš„ä¼˜åŠ¿ï¼‰ Playwright é»˜è®¤ä¼šç­‰å¾…è¿™äº›æƒ…å†µï¼š\nå…ƒç´ å‡ºç° å…ƒç´ å¯è§ å…ƒç´ å¯ç‚¹å‡» é¡µé¢åŠ è½½å®Œæˆ æ— éœ€å†™ time.sleep()ã€‚\nç­‰å¾…å…ƒç´ \npage.wait_for_selector(\u0026#34;#login-btn\u0026#34;, timeout=5000) ç­‰å¾…è·³è½¬\nwith page.expect_navigation(): page.click(\u0026#34;#go-next\u0026#34;) 6. ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ ä¸Šä¼ \npage.set_input_files(\u0026#34;#upload\u0026#34;, \u0026#34;a.jpg\u0026#34;) å¯å¤šæ–‡ä»¶ï¼š\npage.set_input_files(\u0026#34;#upload\u0026#34;, [\u0026#34;1.png\u0026#34;, \u0026#34;2.png\u0026#34;]) ä¸‹è½½æ–‡ä»¶\nwith page.expect_download() as dl: page.click(\u0026#34;#download-btn\u0026#34;) download = dl.value download.save_as(\u0026#34;output.zip\u0026#34;) 7. æˆªå›¾ä¸å½•å± å…¨å±æˆªå›¾\npage.screenshot(path=\u0026#34;full.png\u0026#34;, full_page=True) æŒ‡å®šå…ƒç´ æˆªå›¾\npage.locator(\u0026#34;#main\u0026#34;).screenshot(path=\u0026#34;main.png\u0026#34;) è§†é¢‘å½•åˆ¶\ncontext = browser.new_context(record_video_dir=\u0026#34;videos/\u0026#34;) page = context.new_page() page.goto(\u0026#34;https://example.com\u0026#34;) context.close() 8. å¤š Tabï¼ˆå¤šé¡µé¢ï¼‰ page1 = browser.new_page() page2 = browser.new_page() page1.goto(\u0026#34;https://google.com\u0026#34;) page2.goto(\u0026#34;https://bing.com\u0026#34;) 9. æ‰§è¡Œ JS ä»£ç  value = page.evaluate(\u0026#34;document.title\u0026#34;) print(value) ä¼ å‚ï¼š\npage.evaluate(\u0026#34;\u0026#34;\u0026#34;(msg) =\u0026gt; { console.log(msg) }\u0026#34;\u0026#34;\u0026#34;, \u0026#34;hello\u0026#34;) 10. æ¨¡æ‹Ÿç™»å½•ç¤ºä¾‹ï¼ˆç»å…¸åœºæ™¯ï¼‰ ä¾‹å¦‚æ¨¡æ‹Ÿç™»å½•ç™¾åº¦ï¼š\npage.goto(\u0026#34;https://www.baidu.com\u0026#34;) page.click(\u0026#34;#s-top-loginbtn\u0026#34;) page.fill(\u0026#34;#TANGRAM__PSP_11__userName\u0026#34;, \u0026#34;your_username\u0026#34;) page.fill(\u0026#34;#TANGRAM__PSP_11__password\u0026#34;, \u0026#34;your_password\u0026#34;) page.click(\u0026#34;#TANGRAM__PSP_11__submit\u0026#34;) ä¿å­˜ç™»å½•çŠ¶æ€ cookieï¼ˆå¤ç”¨ç™»å½•ï¼‰\ncontext = browser.new_context(storage_state=\u0026#34;auth.json\u0026#34;) å¤ç”¨ï¼š\nbrowser.new_context(storage_state=\u0026#34;auth.json\u0026#34;) 11. Playwright çˆ¬è™«æŠ€å·§ï¼ˆåçˆ¬ç»•è¿‡ï¼‰ è®¾ç½®çœŸå® UA\ncontext = browser.new_context( user_agent=\u0026#34;Mozilla/5.0 ...\u0026#34; ) ç¦æ­¢ webdriver æ ‡è¯†\nï¼ˆPlaywright é»˜è®¤éšè—ï¼‰\nç¦æ­¢åŠ è½½å›¾ç‰‡åŠ é€Ÿçˆ¬è™«\ncontext = browser.new_context( bypass_csp=True, permissions=[], ) æ§åˆ¶å¹¶å‘ â€” ä½¿ç”¨ async å¤šä»»åŠ¡\nasyncio.gather(task1(), task2(), ...) 12. æ‹¦æˆªç½‘ç»œè¯·æ±‚ï¼ˆMock / åŠ é€Ÿ / è¿‡æ»¤ï¼‰ æ‹¦æˆªå¹¶ä¿®æ”¹è¯·æ±‚\ndef handle(route, request): if \u0026#34;ads\u0026#34; in request.url: return route.abort() return route.continue_() page.route(\u0026#34;**/*\u0026#34;, handle) è·å–æ¥å£è¿”å›\nwith page.expect_response(\u0026#34;**/api/search\u0026#34;) as resp: page.click(\u0026#34;#search\u0026#34;) response = resp.value print(response.json()) 13. å¤„ç† iframe frame = page.frame(name=\u0026#34;frameName\u0026#34;) frame.click(\u0026#34;#btn\u0026#34;) 14. å¤šçº¿ç¨‹/å¹¶å‘çˆ¬è™«æ¶æ„ç¤ºä¾‹ ä½¿ç”¨å¼‚æ­¥ + å¤šé¡µæ¨¡å¼ï¼š\nasync def fetch(url, browser): page = await browser.new_page() await page.goto(url) title = await page.title() await page.close() return title async def main(): async with async_playwright() as p: browser = await p.chromium.launch() tasks = [] for u in urls: tasks.append(fetch(u, browser)) print(await asyncio.gather(*tasks)) 15. å®Œæ•´æ¡ˆä¾‹ï¼šçˆ¬å–çŸ¥ä¹çƒ­æ¦œæ ‡é¢˜ from playwright.sync_api import sync_playwright with sync_playwright() as p: browser = p.chromium.launch(headless=True) page = browser.new_page() page.goto(\u0026#34;https://www.zhihu.com/hot\u0026#34;) page.wait_for_selector(\u0026#34;section.HotItem\u0026#34;) items = page.query_selector_all(\u0026#34;section.HotItem\u0026#34;) for i in items: title = i.query_selector(\u0026#34;.HotItem-title\u0026#34;).inner_text() print(title) browser.close() 16. Playwright vs Seleniumï¼ˆç®€è¡¨ï¼‰ åŠŸèƒ½ Playwright Selenium è‡ªåŠ¨ç­‰å¾… âœ… å¼º âŒ å¼± æ”¯æŒå¤šæµè§ˆå™¨ âœ… âœ… åŒæ­¥ + å¼‚æ­¥ âœ… âŒ åçˆ¬å‹å¥½ âœ… å¥½ âŒ å®¹æ˜“è¢«è¯†åˆ« API ç°ä»£åŒ– âœ… âŒ è€æ—§ å¦‚æœåšçˆ¬è™« -\u0026gt; Playwright æ›´å¼ºã€‚\n","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ è¶…å…¨ã€å®æˆ˜å‘çš„ Python Playwright æ•™ç¨‹ï¼Œæ¶µç›–å®‰è£…ã€åŸºæœ¬ç”¨æ³•ã€å¼‚æ­¥/åŒæ­¥ç‰ˆæœ¬ã€é¡µé¢æ“ä½œã€ç­‰å¾…æœºåˆ¶ã€æ¨¡æ‹Ÿç™»å½•ã€ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ã€çˆ¬è™«æŠ€å·§ã€åçˆ¬ç»•è¿‡ã€æˆªå›¾å½•å±ã€å¹¶å‘ç­‰å†…å®¹ï¼Œä¸€ç¯‡æå®š Playwrightã€‚\nPlaywright æ˜¯å¾®è½¯å‡ºå“çš„æ–°ä¸€ä»£æµè§ˆå™¨è‡ªåŠ¨åŒ–æ¡†æ¶ï¼Œæ”¯æŒï¼š\nChromiumã€Firefoxã€WebKit ä¸‰å¤§æµè§ˆå™¨ å¼ºå¤§çš„è‡ªåŠ¨ç­‰å¾…æœºåˆ¶ï¼ˆä¸ç”¨åƒ Selenium é‚£æ ·é¢‘ç¹å†™ sleepï¼‰ åŸç”Ÿæ”¯æŒå¼‚æ­¥ï¼ˆasync/awaitï¼‰ å¼ºåŠ›åçˆ¬èƒ½åŠ›ï¼ˆæ›´æ¥è¿‘çœŸå®æµè§ˆå™¨ï¼‰ 1. å®‰è£… Playwright pip install playwright å®‰è£…æµè§ˆå™¨å†…æ ¸ï¼š\nplaywright install å›½å†…å¦‚éœ€åŠ é€Ÿï¼š\nplaywright install chromium 2. Playwright çš„ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼šåŒæ­¥ vs å¼‚æ­¥ ä½ å¯ä»¥é€‰æ‹©ï¼š\n"},{"id":27,"href":"/database/postgres/faq/","title":"PostgreSQL FAQ","parent":"PostgreSQL","content":"å†…å®¹ï¼šåŸºç¡€ã€SQLã€äº‹åŠ¡ã€é”ã€ç´¢å¼•ã€æ€§èƒ½ã€è¿ç»´ã€æ¶æ„ã€å¤‡ä»½æ¢å¤ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µ 1. PostgreSQL å’Œ MySQL çš„æ ¸å¿ƒåŒºåˆ«ï¼Ÿ ç­”æ¡ˆï¼š\nMVCC å®ç°ä¸åŒï¼šPostgreSQL ç”¨å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆè¡Œç‰ˆæœ¬ï¼‰ï¼Œæ— é”è¯»ï¼›MySQL InnoDB ç”¨ undo logã€‚ æ•°æ®ç±»å‹æ›´ä¸°å¯Œï¼šhstoreã€jsonbã€arrayã€rangeã€enumã€uuidã€‚ äº‹åŠ¡éš”ç¦»æ›´å¼ºï¼šPostgreSQL ä¸¥æ ¼éµå¾ª MVCCï¼Œä¸éœ€è¦ gap lockã€‚ æ‰§è¡Œè®¡åˆ’æ›´æ™ºèƒ½ï¼šå¼ºå¤§çš„ä¼˜åŒ–å™¨ï¼ˆhash joinã€merge joinã€bitmap scanï¼‰ã€‚ æ‰©å±•æ€§å¼ºï¼šæ”¯æŒè‡ªå®šä¹‰ç±»å‹ã€å‡½æ•°ã€ç´¢å¼•æ–¹æ³•ï¼ˆGiSTã€GIN ç­‰ï¼‰ã€‚ ä¸€è‡´æ€§å¼ºäºæ€§èƒ½ï¼šPostgreSQL æ›´å…³æ³¨ ACIDã€‚ 2. PostgreSQL çš„ MVCC æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ ç­”æ¡ˆï¼š\næ¯è¡Œéƒ½æœ‰ä¸¤ä¸ªéšè—å­—æ®µï¼šxminï¼ˆåˆ›å»ºäº‹åŠ¡ï¼‰ã€xmaxï¼ˆåˆ é™¤äº‹åŠ¡ï¼‰ ä¸ç”¨ undo logï¼Œè¡Œç‰ˆæœ¬ç›´æ¥å­˜åœ¨è¡¨ä¸­ VACUUM æ¸…ç†ç”±è¿‡æœŸç‰ˆæœ¬ ä¼˜åŠ¿ï¼š\næ— é”è¯»ï¼ˆä¸é˜»å¡ SELECTï¼‰ ç®€åŒ– undoï¼ˆç›¸æ¯” MySQLï¼‰ 3. VACUUM å’Œ VACUUM FULL çš„åŒºåˆ«ï¼Ÿ å‘½ä»¤ ä½œç”¨ æ˜¯å¦é”è¡¨ æ˜¯å¦é‡Šæ”¾ç£ç›˜ VACUUM æ¸…ç† dead tuple ä¸é”ï¼ˆè½»åº¦ï¼‰ ä¸é‡Šæ”¾ VACUUM FULL é‡å†™æ•´ä¸ªè¡¨ é”è¡¨ é‡Šæ”¾ç©ºé—´ äºŒã€äº‹åŠ¡ä¸é” 4. PostgreSQL çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿ Read Uncommittedï¼ˆå†…éƒ¨è§†ä¸º READ COMMITTEDï¼‰ Read Committedï¼ˆé»˜è®¤ï¼‰ Repeatable Read Serializableï¼ˆæœ€å¼ºï¼‰ 5. PostgreSQL å¦‚ä½•å®ç° Repeatable Readï¼Ÿ repeatable read è·å– ä¸€è‡´æ€§å¿«ç…§ï¼ˆsnapshotï¼‰ï¼š\nå½“å‰äº‹åŠ¡åªèƒ½çœ‹åˆ°å¼€å§‹æ—¶çš„å·²æäº¤æ•°æ® ä¸ä¼šçœ‹åˆ°åˆ«äººçš„ UPDATEï¼ˆé˜²ä¸å¯é‡å¤è¯»ï¼‰ ä¹Ÿä¸ä¼šçœ‹åˆ°åˆ«äººçš„ INSERTï¼ˆé˜²å¹»è¯»ï¼‰ PostgreSQL ä¸é  gap lock æ¥é˜»æ­¢å¹»è¯»ï¼Œè€Œæ˜¯é€šè¿‡ MVCC å¿«ç…§å®ç°çš„ã€‚\n6. å¦‚ä½•é˜²æ­¢ UPDATE/DELETE è¢«å¹¶å‘ä¿®æ”¹ï¼Ÿ ä½¿ç”¨è¡Œé”ï¼š\nSELECT * FROM table WHERE id = 1 FOR UPDATE; é˜»æ­¢å…¶ä»–äº‹åŠ¡ UPDATE/DELETEã€‚\nä¸‰ã€ç´¢å¼•ä¸æ€§èƒ½ 7. PostgreSQL æ”¯æŒå“ªäº›ç´¢å¼•ç±»å‹ï¼Ÿä½¿ç”¨åœºæ™¯ï¼Ÿ ç´¢å¼•ç±»å‹ ç”¨æ³• B-Tree =ã€\u0026lt;ã€\u0026gt;ã€æ’åºï¼ˆæœ€å¸¸ç”¨ï¼‰ GIN jsonbã€å…¨æ–‡æ£€ç´¢ã€æ•°ç»„ã€å…¨æ–‡æœç´¢ GiST GISã€èŒƒå›´ã€ç›¸ä¼¼åº¦æœç´¢ BRIN å¤§å®½è¡¨ã€é¡ºåºå¢é•¿åˆ—ï¼ˆæ›´è½»ï¼‰ Hash ç­‰å€¼æŸ¥è¯¢ï¼ˆå·²ä¸æ¨èï¼‰ 8. ä¸ºä»€ä¹ˆ PostgreSQL ä¸æ¨è SELECT *ï¼Ÿ ä¼šè¯»ä¸å¿…è¦çš„åˆ—ï¼Œå¢åŠ  IO é˜»ç¢ç´¢å¼•-only scan æ–°å¢å­—æ®µä¼šç ´ååº”ç”¨ä»£ç å…¼å®¹æ€§ 9. PostgreSQL ç´¢å¼•å¤±æ•ˆçš„å¸¸è§åŸå› ï¼Ÿ å‡½æ•°æ“ä½œå­—æ®µï¼Œå¦‚ï¼š\nWHERE lower(name) = \u0026#39;a\u0026#39; -\u0026gt; éœ€è¦ function indexï¼ˆè¡¨è¾¾å¼ç´¢å¼•ï¼‰\nä¸èƒ½ç”¨åœ¨ leading column ä¸Šï¼š\nindex(a, b) WHERE b = 1 -- ç´¢å¼•ä¸èµ° ç±»å‹éšå¼è½¬æ¢ï¼š\nWHERE id = \u0026#39;1\u0026#39;::text -- ä¸èµ°ç´¢å¼• 10. EXPLAIN å¸¸è§å…³é”®å­—å«ä¹‰ï¼Ÿ å…³é”®å­— å«ä¹‰ Seq Scan é¡ºåºæ‰«æï¼Œé€šå¸¸æ„å‘³ç€æ²¡æœ‰ç´¢å¼• Index Scan ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ Bitmap Heap Scan å¤§æ‰¹é‡æ•°æ®æ›´é«˜æ•ˆçš„ç´¢å¼•æ‰«æ Hash Join é€‚ç”¨äºå¤§è¡¨ joinï¼Œé€Ÿåº¦å¿« Nested Loop é€‚ç”¨äºå°è¡¨ join å››ã€SQL ä¼˜åŒ– 11. PostgreSQL å¦‚ä½•ä¼˜åŒ– LIKE \u0026lsquo;%xxx%\u0026rsquo;ï¼Ÿ ä½¿ç”¨ pg_trgmï¼ˆä¸‰å…ƒç»„ç´¢å¼•ï¼‰\nå»ºç«‹ GIN æˆ– GiST ç´¢å¼•ï¼š\nCREATE EXTENSION pg_trgm; CREATE INDEX idx_title_trgm ON article USING gin (title gin_trgm_ops); 12. å¦‚ä½•ä¼˜åŒ–åˆ†é¡µæ€§èƒ½ï¼Ÿ ç»å…¸æ–¹æ¡ˆï¼šä¸»é”®æ¸¸æ ‡åˆ†é¡µ\nSELECT * FROM table WHERE id \u0026gt; last_id ORDER BY id LIMIT 20; é¿å… OFFSET æ·±åº¦æ‰«æã€‚\n13. å¦‚ä½•é¿å…æ…¢æŸ¥è¯¢ï¼Ÿ æ£€æŸ¥ missing indexes ä½¿ç”¨ ANALYZE ä¿è¯ç»Ÿè®¡ä¿¡æ¯æ–°é²œ é¿å…å‡½æ•°åŒ…è£¹å­—æ®µ ä¸è¦åœ¨ WHERE ä¸­ä½¿ç”¨ ORï¼ˆå¯æ”¹æˆ UNION ALLï¼‰ äº”ã€å­˜å‚¨æœºåˆ¶ 14. PostgreSQL TOAST çš„ä½œç”¨ï¼Ÿ ç”¨äºå­˜å‚¨è¶…å¤§å­—æ®µï¼ˆtext/json/blobï¼‰\næœºåˆ¶ï¼š\né¿å…è¡¨è¡Œè¿‡å¤§ å°†å¤§å­—æ®µåˆ†å—å­˜åˆ° toast è¡¨ ä¸»è¡¨è¡Œåªå­˜æŒ‡é’ˆ 15. ä»€ä¹ˆæƒ…å†µä¼šç”Ÿæˆ dead tupleï¼Ÿ UPDATEï¼ˆæ—§ç‰ˆæœ¬ä¸å¯è§ï¼‰ DELETE INSERT å¤±è´¥ï¼ˆrollbackï¼‰ éœ€è¦ VACUUM æ¸…é™¤ã€‚\nå…­ã€å¤‡ä»½æ¢å¤ 16. PostgreSQL çƒ­å¤‡ä»½æ–¹å¼ï¼Ÿ pg_basebackupï¼ˆç‰©ç†å…¨å¤‡ï¼‰ pgBackRestï¼ˆæœ€å¹¿æ³›ä½¿ç”¨ï¼‰ WAL å½’æ¡£ï¼ˆPoint-In-Time Recoveryï¼‰ é€»è¾‘å¤‡ä»½ pg_dump 17. ä»€ä¹ˆæ˜¯ PITRï¼Ÿ Point-In-Time Recovery\né€šè¿‡ï¼š\nbase backupï¼ˆç‰©ç†å¤‡ä»½ï¼‰ WALï¼ˆå¢é‡ï¼‰ æ¢å¤åˆ°æŸä¸€ç§’ã€‚\n18. å¦‚ä½•åœ¨çº¿æ‰©å®¹ PostgreSQLï¼Ÿ ä½¿ç”¨ Patroni + etcd pgpool-II / HAProxy + Streaming Replication çƒ­å¤‡èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼ˆfailoverï¼‰ ä¸ƒã€æ¶æ„è®¾è®¡ 19. PostgreSQL æ°´å¹³æ‰©å±•æ–¹æ¡ˆï¼Ÿ Citusï¼ˆåˆ†å¸ƒå¼ï¼‰ Greenplum TimescaleDBï¼ˆæ—¶é—´åºåˆ—ï¼‰ è‡ªå·±åš Shardingï¼ˆä¸æ¨èï¼‰ 20. ä¸¤è¡¨å¤§ JOIN æ€ä¹ˆæœ€å¿«ï¼Ÿ æ–¹æ³•ï¼š\næ­£ç¡®ç´¢å¼• è°ƒå¤§ work_mem å¼ºåˆ¶ Hash Joinï¼ˆå¦‚æœä¼˜åŒ–å™¨æ²¡é€‰ï¼‰ï¼š SET enable_mergejoin TO off; SET enable_nestloop TO off; å…«ã€é«˜çº§ç‰¹æ€§ 21. ä»€ä¹ˆæ˜¯ jsonbï¼Ÿä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ äºŒè¿›åˆ¶å­˜å‚¨ å¯ç´¢å¼•ï¼ˆGINï¼‰ æ›´å¿«æ¯”è¾ƒä¸æŸ¥è¯¢ æ›´èŠ‚çœç©ºé—´ æ¯” json æ›´é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚\n22. PostgreSQL æ”¯æŒå­˜å‚¨è¿‡ç¨‹å—ï¼Ÿ æ˜¯çš„ï¼Œæ”¯æŒ PL/pgSQLï¼Œä¹Ÿæ”¯æŒ Pythonã€JSã€C ç­‰è¯­è¨€ã€‚\n23. å¦‚ä½•åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•ï¼Ÿ CREATE INDEX idx_lower_name ON users (lower(name)); æŸ¥è¯¢éœ€å†™ä¸€è‡´ï¼š\nWHERE lower(name) = \u0026#39;tom\u0026#39;; 24. å¦‚ä½•é”ä½æ•´å¼ è¡¨ï¼Ÿ LOCK TABLE users IN SHARE MODE; ç”¨äºæ•°æ®è¿ç§»ç­‰å°‘æ•°åœºæ™¯ã€‚\nä¹ã€è¿ç»´ 25. PostgreSQL å¦‚ä½•æŸ¥çœ‹æ­»é”ï¼Ÿ SELECT * FROM pg_locks; æˆ–åœ¨ log ä¸­æŸ¥æ‰¾ï¼š\ndeadlock detected 26. å¦‚ä½•å‘ç°æ…¢ SQLï¼Ÿ å¼€å¯ï¼š\nlog_min_duration_statement = 500ms 27. å¦‚ä½•æ¸…ç†è†¨èƒ€ï¼ˆbloatï¼‰ï¼Ÿ VACUUM VACUUM FULLï¼ˆé‡å†™è¡¨ï¼‰ pg_repackï¼ˆåœ¨çº¿æ— é”é‡å†™ï¼‰ 28. å¦‚ä½•ç»Ÿè®¡è¡¨è¡Œæ•°æœ€å¿«ï¼Ÿ SELECT reltuples::bigint FROM pg_class WHERE relname=\u0026#39;table\u0026#39;; æ¯” count(*) å¿« 1000 å€ï¼ˆapproxï¼‰ã€‚\n29. å¦‚ä½•æŸ¥çœ‹è¡¨è†¨èƒ€ï¼Ÿ ä½¿ç”¨æ‰©å±•ï¼š\nCREATE EXTENSION pgstattuple; SELECT * FROM pgstattuple(\u0026#39;table\u0026#39;); 30. PostgreSQL å¦‚ä½•é”å®šæŸä¸ªè¡ŒèŒƒå›´ï¼Ÿ PostgreSQL æ²¡æœ‰ gap lockï¼Œåªèƒ½ç”¨ï¼š\nSELECT ... FOR SHARE; SELECT ... FOR UPDATE; æˆ–ä½¿ç”¨ SERIALIZABLEã€‚\n","description":"å†…å®¹ï¼šåŸºç¡€ã€SQLã€äº‹åŠ¡ã€é”ã€ç´¢å¼•ã€æ€§èƒ½ã€è¿ç»´ã€æ¶æ„ã€å¤‡ä»½æ¢å¤ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µ 1. PostgreSQL å’Œ MySQL çš„æ ¸å¿ƒåŒºåˆ«ï¼Ÿ ç­”æ¡ˆï¼š\nMVCC å®ç°ä¸åŒï¼šPostgreSQL ç”¨å¤šç‰ˆæœ¬å­˜å‚¨ï¼ˆè¡Œç‰ˆæœ¬ï¼‰ï¼Œæ— é”è¯»ï¼›MySQL InnoDB ç”¨ undo logã€‚ æ•°æ®ç±»å‹æ›´ä¸°å¯Œï¼šhstoreã€jsonbã€arrayã€rangeã€enumã€uuidã€‚ äº‹åŠ¡éš”ç¦»æ›´å¼ºï¼šPostgreSQL ä¸¥æ ¼éµå¾ª MVCCï¼Œä¸éœ€è¦ gap lockã€‚ æ‰§è¡Œè®¡åˆ’æ›´æ™ºèƒ½ï¼šå¼ºå¤§çš„ä¼˜åŒ–å™¨ï¼ˆhash joinã€merge joinã€bitmap scanï¼‰ã€‚ æ‰©å±•æ€§å¼ºï¼šæ”¯æŒè‡ªå®šä¹‰ç±»å‹ã€å‡½æ•°ã€ç´¢å¼•æ–¹æ³•ï¼ˆGiSTã€GIN ç­‰ï¼‰ã€‚ ä¸€è‡´æ€§å¼ºäºæ€§èƒ½ï¼šPostgreSQL æ›´å…³æ³¨ ACIDã€‚ 2. PostgreSQL çš„ MVCC æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ ç­”æ¡ˆï¼š\n"},{"id":28,"href":"/database/prometheus/faq/","title":"Prometheus FAQ","parent":"Prometheus","content":"å†…å®¹ï¼šåŸºç¡€ã€è¿ç»´ã€å‘Šè­¦ã€æ€§èƒ½ã€æ¶æ„ã€Exporterã€PromQLã€ç”Ÿæ€ç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Prometheusï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ Prometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§ç³»ç»Ÿå’Œæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œç”¨äºï¼š\næœåŠ¡ç›‘æ§ æ—¶åºæ•°æ®å­˜å‚¨ æŒ‡æ ‡é‡‡é›†ï¼ˆmetricsï¼‰ å‘Šè­¦ï¼ˆAlertmanagerï¼‰ å¯è§†åŒ–ï¼ˆPrometheus UI / Grafanaï¼‰ æ ¸å¿ƒèƒ½åŠ›æ˜¯ é€šè¿‡ Pull æ¨¡å¼ï¼ˆHTTP Scrapeï¼‰å®šæœŸé‡‡é›†æ•°æ®å¹¶å­˜æˆæ—¶é—´åºåˆ—ã€‚\n2. Prometheus çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ ç»„ä»¶ ä½œç”¨ Prometheus Server æŠ“å–æŒ‡æ ‡ + å­˜å‚¨ TSDB + æ‰§è¡ŒæŸ¥è¯¢ Exporter æš´éœ² metricsï¼ˆå¦‚ node_exporterï¼‰ Alertmanager æ¥æ”¶è§„åˆ™å¹¶å‘å‘Šè­¦ Pushgateway ä¸´æ—¶æ€§ Job çš„æ•°æ®ä¸ŠæŠ¥ PromQL æŸ¥è¯¢è¯­è¨€ Grafana å¯è§†åŒ– 3. Prometheus çš„ Pull æ¨¡å¼ä¼˜ç¼ºç‚¹ï¼Ÿ ğŸ‘ ä¼˜ç‚¹ï¼š\næ— éœ€åœ¨å®¢æˆ·ç«¯é…ç½®æ¨é€ æœåŠ¡ç«¯ç»Ÿä¸€æ§åˆ¶é‡‡é›†é¢‘ç‡ è‡ªåŠ¨å‘ç° Targets æ˜“æ¨ªå‘æ‰©å±• Metrics æŠ“å–å»¶è¿Ÿä½ ğŸ‘ ç¼ºç‚¹ï¼š\nä¸èƒ½ç›‘æ§æ— æ³•è¢«è®¿é—®çš„èŠ‚ç‚¹ï¼ˆéœ€ Pushgatewayï¼‰ å¤§è§„æ¨¡ Scrape æ—¶å‹åŠ›é›†ä¸­åœ¨ Server 4. Prometheus çš„æ•°æ®æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ æ ¸å¿ƒç»“æ„ï¼šæ—¶é—´åºåˆ—ï¼ˆTime Seriesï¼‰\nMetricName{label1=\u0026#34;a\u0026#34;, label2=\u0026#34;b\u0026#34;} =\u0026gt; [timestamp, value]... åŒ…æ‹¬ï¼š\nmetric name labelsï¼ˆç»´åº¦ä¿¡æ¯ï¼‰ samplesï¼ˆæ—¶é—´æˆ³ + å€¼ï¼‰ 5. Prometheus çš„æ•°æ®å­˜å‚¨æ–¹å¼ï¼Ÿ Prometheus è‡ªå¸¦ä¸€ä¸ªæœ¬åœ° TSDBï¼Œç‰¹ç‚¹ï¼š\né‡‡ç”¨ Block å­˜å‚¨ï¼Œæ¯ä¸ªå— 2 å°æ—¶ WALï¼ˆWrite Ahead Logï¼‰ å‹ç¼©ç®—æ³•ï¼švarbit encoding å­˜å‚¨ç›®å½•ç»“æ„ï¼š /data/ â”œâ”€â”€ wal/ â”œâ”€â”€ chunks_head/ â”œâ”€â”€ 01F.../ äºŒã€Scraping ä¸ Exporter 6. Prometheus é‡‡é›†æ•°æ®çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ ä¸¤ç§ï¼š\n1. Pullï¼ˆä¸»æµï¼‰ Prometheus ä¸»åŠ¨å» scrape targetã€‚\n2. Pushï¼ˆä»…ç”¨äºçŸ­ç”Ÿå‘½å‘¨æœŸ Jobï¼‰ å¿…é¡»ç”¨ Pushgatewayã€‚\n7. å¸¸è§çš„ Exporter æœ‰å“ªäº›ï¼Ÿ Exporter ç”¨é€” node_exporter æœåŠ¡å™¨ç›‘æ§ blackbox_exporter æ¢æµ‹ HTTP/HTTPS/TCP/ICMP mysqld_exporter MySQL mongodb_exporter MongoDB redis_exporter Redis nginx/nginx-vts-exporter Nginx cadvisor å®¹å™¨æŒ‡æ ‡ kube-state-metrics Kubernetes èµ„æºçŠ¶æ€ kubelet metrics Pod/Node æ€§èƒ½ 8. å¦‚ä½•å‡å°‘ Exporter è¿‡å¤šæ ‡ç­¾å¯¼è‡´çš„é«˜åŸºæ•°ï¼ˆHigh Cardinalityï¼‰é—®é¢˜ï¼Ÿ å›ç­”è¦ç‚¹ï¼š\né¿å…åŠ¨æ€ labelï¼ˆå¦‚ç”¨æˆ· IDã€IPã€URLï¼‰ ä½¿ç”¨ label_drop åˆ é™¤æ— å¿…è¦æ ‡ç­¾ é™åˆ¶ histogram buckets é¿å…ä¸ºæ¯ä¸ªå®ä¾‹ã€è¯·æ±‚æˆ–äº‹ä»¶ç”Ÿæˆä¸€ä¸ª Label ä¸‰ã€æœåŠ¡å‘ç°ä¸ Kubernetes 9. Prometheus å¦‚ä½•åœ¨ Kubernetes ä¸­è‡ªåŠ¨å‘ç°æœåŠ¡ï¼Ÿ é€šè¿‡ Service Discoveryï¼ˆSDï¼‰ é…ç½®ï¼š\nkubernetes_sd_configs: - role: pod å¸¸è§ roleï¼š\nnode pod service endpoints ingress 10. å¦‚ä½•åœ¨ Kubernetes ä¸­ç›‘æ§ç³»ç»Ÿç»„ä»¶ï¼Ÿ ç»„ä»¶ï¼š\nkubeletï¼š/metrics /metrics/cadvisor apiserverï¼š/metrics schedulerï¼š/metrics controller-managerï¼š/metrics ä½¿ç”¨ kube-prometheus-stack è‡ªåŠ¨å®‰è£…æœ€ä¾¿æ·ã€‚\nå››ã€PromQL 11. rate() ä¸ irate() çš„åŒºåˆ«ï¼Ÿ å‡½æ•° è¯´æ˜ rate(x[5m]) è®¡ç®—åŒºé—´å†…å¹³å‡å¢é•¿ç‡ï¼ˆæ¨èç”¨äºé•¿æœŸè¶‹åŠ¿ï¼‰ irate(x[5m]) åŒºé—´æœ«ä¸¤ç‚¹çš„ç¬æ—¶å¢é•¿ç‡ï¼ˆæ¨èç”¨äºç›‘æ§çªå‘ï¼‰ 12. increase() ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿ increase(counter[5m])\nç”¨äºç»Ÿè®¡åœ¨çª—å£æœŸå†…çš„æ€»å¢é•¿é‡ï¼Œå¸¸ç”¨ï¼š\nè¯·æ±‚æ•°å¢é•¿é‡ é”™è¯¯æ•°å¢é•¿é‡ 13. histogram ä¸ summary çš„åŒºåˆ«ï¼Ÿ é¡¹ Histogram Summary ç™¾åˆ†ä½èšåˆ æœ‰ï¼ˆé€šè¿‡ histogram_quantileï¼‰ æœ‰ èƒ½å¦è·¨å®ä¾‹èšåˆ âœ… å¯ä»¥ âŒ å¾ˆéš¾ é€‚åˆåœºæ™¯ åˆ†å¸ƒç»Ÿè®¡ã€è·¨å®ä¾‹èšåˆ å•å®ä¾‹å»¶è¿Ÿåˆ†æ ç”Ÿäº§ç¯å¢ƒç»Ÿä¸€ç”¨ histogramï¼Œç¦ç”¨ summaryï¼ˆé™¤éæ˜ç¡®éœ€æ±‚ï¼‰ã€‚\n14. PromQL é‡Œé¢çš„ offset ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ ç”¨äºæ—¶é—´åç§»åˆ†æï¼š\nrate(http_requests_total[5m] offset 1h) å¸¸ç”¨äºå¯¹æ¯”è¿‡å»æ•°æ®ã€‚\näº”ã€Alertmanagerï¼ˆå‘Šè­¦ï¼‰ 15. ä»€ä¹ˆæ˜¯å‘Šè­¦åˆ†ç»„ï¼ˆGroupingï¼‰ï¼Ÿ Alertmanager å°†ç›¸ä¼¼å‘Šè­¦åˆå¹¶æ¨é€ï¼š\nå¦‚æŒ‰ label åˆ†ç»„ï¼š\ngroup_by: [\u0026#34;cluster\u0026#34;, \u0026#34;alertname\u0026#34;] å¯ä»¥å‡å°‘å™ªéŸ³ã€‚\n16. å‘Šè­¦æŠ‘åˆ¶ï¼ˆInhibitionï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ æ¯”å¦‚ä¸€ä¸ª NodeDownï¼ŒæŠ‘åˆ¶ï¼š\nnode CPU è­¦å‘Š ç£ç›˜å‘Šè­¦ å†…å­˜å‘Šè­¦ 17. é‡å¤å‘é€ï¼ˆRepeat Intervalï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ é˜²æ­¢å‘Šè­¦åªå‘é€ä¸€æ¬¡ï¼š\nrepeat_interval: 4h 4 å°æ—¶æ²¡æœ‰æ¢å¤ï¼Œåˆ™é‡å¤å‘ä¸€æ¬¡ã€‚\nå…­ã€æ€§èƒ½ã€è¿ç»´ã€æŒ‡æ ‡åŸºæ•° 18. Prometheus ä¸ºä»€ä¹ˆå®¹æ˜“ OOMï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ å› ä¸º é«˜åŸºæ•°ï¼ˆHigh Cardinalityï¼‰ã€‚\näº§ç”ŸåŸå› ï¼š\nåŠ¨æ€ labelï¼ˆUUIDã€IPã€UserIDï¼‰ histogram buckets è¿‡å¤š label æ•°é‡å¤ªå¤§ target è¿‡å¤š è§£å†³æ–¹æ¡ˆï¼š\né™ä½ label å¯ç”¨ remote write è°ƒæ•´ scrape interval å¢åŠ å†…å­˜ åˆ†ç‰‡ï¼ˆshardingï¼‰ 19. Prometheus å¦‚ä½•æ°´å¹³æ‰©å±•ï¼Ÿ Prometheus æœ¬èº«æ˜¯å•å®ä¾‹ï¼Œä½†å¯ä»¥ï¼š\næ–¹æ¡ˆ 1ï¼šåˆ†ç‰‡ï¼ˆshardingï¼‰ å¤šä¸ª Prometheusï¼Œä½¿ç”¨ hashmod æŠŠç›‘æ§ç›®æ ‡åˆ†ç‰‡ã€‚\næ–¹æ¡ˆ 2ï¼šä¸Šæ¸¸æ±‡èšï¼ˆFederationï¼‰ ä»å¤šä¸ª Prometheus ä¸ŠæŠ“å–æ±‡èšæŒ‡æ ‡ã€‚\næ–¹æ¡ˆ 3ï¼šThanos / Cortex / Mimir äº‘åŸç”Ÿåˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿã€‚\n20. ä¸ºä»€ä¹ˆä¸è¦åœ¨ Prometheus ä¸­å­˜å‚¨é•¿æœŸæ•°æ®ï¼Ÿ å› ä¸ºï¼š\næœ¬åœ° TSDB å•æœºæ— æ³•æ‰©å±• æˆæœ¬é«˜ æŸ¥è¯¢æ…¢ å®¹æ˜“ OOM ä¸€èˆ¬ 15 å¤©å°±å¤Ÿã€‚\né•¿æœŸæ•°æ®äº¤ç»™ï¼š\nThanos VictoriaMetrics Cortex/Mimir ä¸ƒã€Pushgateway 21. Pushgateway é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ çŸ­ç”Ÿå‘½å‘¨æœŸä»»åŠ¡ï¼ˆCronJobï¼‰\nä¸é€‚ç”¨ï¼š\næœåŠ¡é•¿æœŸ metricsï¼ˆåº”ä½¿ç”¨ Exporterï¼‰ å¤§è§„æ¨¡ç›‘æ§ï¼ˆä¼š OOMï¼‰ 22. Pushgateway æ•°æ®æ˜¯å¦ä¼šè‡ªåŠ¨è¿‡æœŸï¼Ÿ âŒ ä¸ä¼š\néœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼š\nDELETE /metrics/job/\u0026lt;job_name\u0026gt; å…«ã€æ¶æ„ 23. Prometheus çš„é«˜å¯ç”¨æ€ä¹ˆåšï¼Ÿ æœ€ç»å…¸æ–¹æ¡ˆï¼š\nä¸¤ä¸ª Prometheus å®ä¾‹\né…ç½®å®Œå…¨ä¸€è‡´ Alertmanager åš HA Grafana éšè—é‡å¤æ•°æ®ï¼ˆvia min step or dedupï¼‰ å¦‚æœæ˜¯ Kubernetesï¼Œå¯ä½¿ç”¨ kube-prometheus-stackã€‚\n24. Prometheus æ•°æ®å¦‚ä½•æ¢å¤ï¼Ÿ ä» WAL æ¢å¤ ä» remote storage é‡æ–°æ‹‰å–ï¼ˆå¦‚ Thanosï¼‰ promtool check tsdb / repair 25. Prometheus Federation æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ª Prometheus ä»å¦ä¸€ä¸ª Prometheus æ‹‰å–æŒ‡æ ‡ã€‚\nç”¨é€”ï¼š\næ±‡èšå¤šæ•°æ®ä¸­å¿ƒ é›†ä¸­ç›‘æ§ åˆ†å±‚æ¶æ„ ä¹ã€ç»¼åˆ 26. Prometheus å’Œ Zabbixã€Nagios æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç‰¹æ€§ Prometheus Zabbix/Nagios é‡‡é›†æ–¹å¼ Pull Push æ¶æ„ æ—¶åºæ•°æ®åº“ äº‹ä»¶é©±åŠ¨ é€‚åˆåœºæ™¯ äº‘åŸç”Ÿã€å¾®æœåŠ¡ã€å¤§è§„æ¨¡ ä¼ ç»Ÿä¸»æœºç›‘æ§ å‘Šè­¦ å¼ºï¼Œè§„åˆ™çµæ´» å¼º å­˜å‚¨ æœ¬åœ°/è¿œç¨‹ å†…ç½® DB å¯æ‰©å±•æ€§ é«˜ ä¸­ç­‰ 27. ä¸ºä»€ä¹ˆä¸å»ºè®®ç»™ URL ä½œä¸º labelï¼Ÿ å› ä¸º URL åŠ¨æ€å˜åŒ–å¯¼è‡´é«˜åŸºæ•°ï¼ˆCardinality Explosionï¼‰ï¼Œä¼šè®© Prometheus å´©æºƒã€‚\n28. æ€æ ·ç›‘æ§ API çš„å¯ç”¨æ€§ï¼Ÿ ä½¿ç”¨ blackbox exporterï¼š\nhttp: prober: http æ£€æŸ¥ï¼š\nå»¶è¿Ÿ å¯ç”¨æ€§ è¯·æ±‚æˆåŠŸç‡ 29. æ€æ ·ç›‘æ§åº”ç”¨ QPSï¼Ÿ rate(http_requests_total[1m])\n30. æ€æ ·ç›‘æ§ 95% å»¶è¿Ÿï¼Ÿ histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))\n","description":"å†…å®¹ï¼šåŸºç¡€ã€è¿ç»´ã€å‘Šè­¦ã€æ€§èƒ½ã€æ¶æ„ã€Exporterã€PromQLã€ç”Ÿæ€ç­‰ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µ 1. ä»€ä¹ˆæ˜¯ Prometheusï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ Prometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§ç³»ç»Ÿå’Œæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œç”¨äºï¼š\næœåŠ¡ç›‘æ§ æ—¶åºæ•°æ®å­˜å‚¨ æŒ‡æ ‡é‡‡é›†ï¼ˆmetricsï¼‰ å‘Šè­¦ï¼ˆAlertmanagerï¼‰ å¯è§†åŒ–ï¼ˆPrometheus UI / Grafanaï¼‰ æ ¸å¿ƒèƒ½åŠ›æ˜¯ é€šè¿‡ Pull æ¨¡å¼ï¼ˆHTTP Scrapeï¼‰å®šæœŸé‡‡é›†æ•°æ®å¹¶å­˜æˆæ—¶é—´åºåˆ—ã€‚\n2. Prometheus çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ ç»„ä»¶ ä½œç”¨ Prometheus Server æŠ“å–æŒ‡æ ‡ + å­˜å‚¨ TSDB + æ‰§è¡ŒæŸ¥è¯¢ Exporter æš´éœ² metricsï¼ˆå¦‚ node_exporterï¼‰ Alertmanager æ¥æ”¶è§„åˆ™å¹¶å‘å‘Šè­¦ Pushgateway ä¸´æ—¶æ€§ Job çš„æ•°æ®ä¸ŠæŠ¥ PromQL æŸ¥è¯¢è¯­è¨€ Grafana å¯è§†åŒ– 3. Prometheus çš„ Pull æ¨¡å¼ä¼˜ç¼ºç‚¹ï¼Ÿ ğŸ‘ ä¼˜ç‚¹ï¼š\n"},{"id":29,"href":"/backend/python/pydantic/tutorial/","title":"Pydantic åŸºç¡€æ•™ç¨‹","parent":"Pydantic","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€å®ç”¨ã€æœ€ç°ä»£çš„ã€ŠPython Pydantic å…¨é¢æŒ‡å—ã€‹ï¼Œè¦†ç›– Pydantic v1 ä¸ v2ï¼ˆæœ€æ–°ç‰ˆï¼‰ï¼Œä»å…¥é—¨åˆ°è¿›é˜¶ã€åˆ° FastAPI å®æˆ˜çš„æœ€æ ¸å¿ƒå†…å®¹ã€‚\nå†…å®¹é‡ç‚¹ï¼š\næ¦‚å¿µ + åŸºç¡€ + éªŒè¯ Pydantic Model + Field è§£æ / åºåˆ—åŒ– è‡ªå®šä¹‰éªŒè¯å™¨ FastAPI åœºæ™¯ é¡¹ç›®æœ€ä½³å®è·µ ğŸš€ 1. ä»€ä¹ˆæ˜¯ Pydanticï¼Ÿ Pydantic æ˜¯ Python çš„ æ•°æ®æ¨¡å‹ä¸æ•°æ®éªŒè¯åº“ï¼Œä¸»è¦åŠŸèƒ½ï¼š\nè‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆtype coercionï¼‰ è‡ªåŠ¨æ ¡éªŒæ•°æ®æ ¼å¼ ä¼˜é›…çš„é”™è¯¯ä¿¡æ¯ JSON å‹å¥½ è¶…å¿«ï¼ˆRust åŠ é€Ÿï¼Œè‡ª v2ï¼‰ ç‰¹åˆ«é€‚åˆï¼š\næ¥å£è¾“å…¥/è¾“å‡ºï¼ˆFastAPI é»˜è®¤ç”¨å®ƒï¼‰ é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆenv / json / yamlï¼‰ DTOï¼ˆä¸šåŠ¡ä¼ è¾“å¯¹è±¡ï¼‰ æ•°æ®æ¸…æ´—ä¸è½¬æ¢ ğŸ“Œ 2. æœ€åŸºç¡€ç¤ºä¾‹ï¼ˆPydantic v2 é£æ ¼ï¼‰ from pydantic import BaseModel, Field class User(BaseModel): id: int name: str active: bool = True u = User(id=\u0026#34;1\u0026#34;, name=\u0026#34;Tom\u0026#34;) # è‡ªåŠ¨æŠŠ \u0026#34;1\u0026#34; è½¬æˆ int print(u) è¾“å‡ºï¼š\nid=1 name=\u0026#39;Tom\u0026#39; active=True ğŸ“Œ 3. å­—æ®µå®šä¹‰ä¸ Field class User(BaseModel): id: int = Field(..., gt=0, description=\u0026#34;ç”¨æˆ·ID\u0026#34;) name: str = Field(min_length=1, max_length=50) age: int | None = Field(default=None, ge=0, le=120) å¸¸ç”¨å‚æ•°ï¼š\nå‚æ•° ä½œç”¨ default / é»˜è®¤å€¼ å­—æ®µçš„é»˜è®¤å€¼ gt / ge / lt / le æ•°å€¼èŒƒå›´ min_length / max_length å­—ç¬¦ä¸²é•¿åº¦ regex æ­£åˆ™åŒ¹é… description æ–‡æ¡£æè¿°ï¼ˆFastAPI è‡ªåŠ¨ç”Ÿæˆï¼‰ ğŸ“Œ 4. è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆPydantic å¼ºé¡¹ï¼‰ User(id=\u0026#34;123\u0026#34;, name=456) è‡ªåŠ¨è¾“å‡ºï¼š\nid=123 name=\u0026#39;456\u0026#39; ğŸ“Œ 5. æ•°æ®è§£æï¼ˆparseï¼‰ User.model_validate({\u0026#34;id\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;}) ä» JSON å­—ç¬¦ä¸²ï¼š\nUser.model_validate_json(\u0026#39;{\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;}\u0026#39;) ğŸ“Œ 6. æ¨¡å‹åºåˆ—åŒ–ï¼ˆdict / JSONï¼‰ u.model_dump() u.model_dump_json() å¯é€‰ï¼š\nu.model_dump(exclude={\u0026#34;active\u0026#34;}) ğŸ“Œ 7. åµŒå¥—æ¨¡å‹ class Address(BaseModel): city: str zip: str class User(BaseModel): name: str address: Address ä½¿ç”¨ï¼š\nUser(name=\u0026#34;Tom\u0026#34;, address={\u0026#34;city\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;zip\u0026#34;: \u0026#34;100000\u0026#34;}) Pydantic ä¼šè‡ªåŠ¨æŠŠ dict è½¬ä¸º Address å¯¹è±¡ã€‚\nğŸ“Œ 8. åˆ—è¡¨ / å­—å…¸ / å¤æ‚ç»“æ„ class Group(BaseModel): name: str members: list[User] ğŸ“Œ 9. Optionalï¼ˆå¯é€‰å­—æ®µï¼‰ ä¸¤ç§å†™æ³•ç­‰ä»·ï¼š\nemail: str | None = None # or from typing import Optional email: Optional[str] = None ğŸ“Œ 10. æšä¸¾ + Pydantic from enum import Enum class Status(str, Enum): ACTIVE = \u0026#34;active\u0026#34; DISABLED = \u0026#34;disabled\u0026#34; class User(BaseModel): name: str status: Status ğŸ“Œ 11. è‡ªå®šä¹‰æ ¡éªŒå™¨ï¼ˆv2 æ–°é£æ ¼ï¼‰ from pydantic import field_validator class User(BaseModel): name: str @field_validator(\u0026#34;name\u0026#34;) @classmethod def validate_name(cls, v): if not v[0].isupper(): raise ValueError(\u0026#34;name must start with uppercase\u0026#34;) return v ğŸ“Œ 12. Model-level æ ¡éªŒï¼ˆæ•´ä½“æ ¡éªŒï¼‰ from pydantic import model_validator class Rectangle(BaseModel): width: int height: int @model_validator(mode=\u0026#34;after\u0026#34;) def check_area(self): if self.width * self.height \u0026gt; 10000: raise ValueError(\u0026#34;Too large\u0026#34;) return self ğŸ“Œ 13. Pydantic çš„ä¸å¯å˜æ¨¡å‹ï¼ˆfrozenï¼‰ class Config(BaseModel, frozen=True): host: str port: int cfg = Config(host=\u0026#34;localhost\u0026#34;, port=3306) # cfg.host = \u0026#34;127.0.0.1\u0026#34; # âŒ é”™è¯¯ ğŸ“Œ 14. æ¨¡å‹ç»§æ‰¿ class User(BaseModel): id: int name: str class Admin(User): role: str ğŸ“Œ 15. é…ç½®æ–‡ä»¶è§£æï¼ˆSettingsï¼‰ éå¸¸é€‚åˆè¯»å– .envï¼š\nfrom pydantic_settings import BaseSettings class Settings(BaseSettings): app_name: str = \u0026#34;MyApp\u0026#34; debug: bool = False class Config: env_file = \u0026#34;.env\u0026#34; settings = Settings() .env å†…å®¹è‡ªåŠ¨åŠ è½½ã€‚\nğŸ“Œ 16. Pydantic + FastAPIï¼ˆæ ¸å¿ƒï¼‰ from pydantic import BaseModel from fastapi import FastAPI app = FastAPI() class User(BaseModel): name: str age: int @app.post(\u0026#34;/user/\u0026#34;) def create_user(user: User): return user FastAPI è‡ªåŠ¨ï¼š\næ¥æ”¶ JSON -\u0026gt; æ ¡éªŒ -\u0026gt; è½¬æ¢ -\u0026gt; æ³¨å…¥ User å¯¹è±¡ è‡ªåŠ¨ç”Ÿæˆ OpenAPI æ–‡æ¡£ é”™è¯¯è‡ªåŠ¨è¿”å› 422 ğŸ“Œ 17. Pydantic çš„ JSON Schemaï¼ˆç”¨äºå‰ç«¯ï¼‰ User.model_json_schema() å¯ä»¥ç”Ÿæˆå‰ç«¯è¡¨å• / ç±»å‹ç³»ç»Ÿä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚\nğŸ“Œ 18. Pydantic v1 ä¸ v2 çš„åŒºåˆ«ï¼ˆä½ å¿…é¡»çŸ¥é“ï¼‰ åŠŸèƒ½ v1 v2 éªŒè¯ Python å®ç° Rust è¶…é«˜é€Ÿ è¯­æ³• @validator @field_validator æ–¹æ³• .dict() .json() model_dump() model_dump_json() è‡ªå®šä¹‰æ ¡éªŒ å·²åºŸå¼ƒ æ›´ç»Ÿä¸€ã€æ›´å¼º æ€§èƒ½ è¾ƒæ…¢ 8~30 å€æå‡ å»ºè®®å…¨é¢ä½¿ç”¨ v2ã€‚\nğŸ“Œ 19. Pydantic çš„å¸¸è§ç”¨é€”ï¼ˆå®æˆ˜æ€»ç»“ï¼‰ API è¾“å…¥è¾“å‡ºæ¨¡å‹ï¼ˆæœ€å¸¸è§ï¼‰ SQLAlchemy ORM \u0026lt;-\u0026gt; DTO æ˜ å°„ Redis / MQ æ¶ˆæ¯ç»“æ„ é…ç½®æ–‡ä»¶ï¼ˆSettingsï¼‰ è¡¨å•æ ¡éªŒ Excel / CSV æ•°æ®æ¸…æ´— å¤§å‹é¡¹ç›®çš„æ•°æ®è§„èŒƒåŒ– ğŸ“Œ 20. æœ€æ¨èçš„ Pydantic é¡¹ç›®æ¨¡æ¿ ä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­åˆ›å»ºï¼š\nutils/ â”œâ”€â”€ models/ â”‚ â”œâ”€â”€ user.py â”‚ â”œâ”€â”€ news.py â”‚ â”œâ”€â”€ common.py ä¾‹å¦‚ï¼š\nclass PageParams(BaseModel): pageIndex: int = Field(ge=1) pageSize: int = Field(ge=1, le=200) éå¸¸é€‚åˆåˆ†é¡µã€DTO å°è£…ã€‚\næœ€ç»ˆæ€»ç»“ Pydantic æ˜¯ Python çš„æ ¸å¿ƒæ•°æ®å·¥å…·ï¼Œå®ƒï¼š\nè®©æ•°æ®ç»“æ„ç±»å‹åŒ– è®©æ•°æ®éªŒè¯è‡ªåŠ¨åŒ– è®©é¡¹ç›®æ›´å®‰å…¨å¯é  åœ¨ FastAPI ä¸­ä½“éªŒæœ€ä½³ ","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€å®ç”¨ã€æœ€ç°ä»£çš„ã€ŠPython Pydantic å…¨é¢æŒ‡å—ã€‹ï¼Œè¦†ç›– Pydantic v1 ä¸ v2ï¼ˆæœ€æ–°ç‰ˆï¼‰ï¼Œä»å…¥é—¨åˆ°è¿›é˜¶ã€åˆ° FastAPI å®æˆ˜çš„æœ€æ ¸å¿ƒå†…å®¹ã€‚\nå†…å®¹é‡ç‚¹ï¼š\næ¦‚å¿µ + åŸºç¡€ + éªŒè¯ Pydantic Model + Field è§£æ / åºåˆ—åŒ– è‡ªå®šä¹‰éªŒè¯å™¨ FastAPI åœºæ™¯ é¡¹ç›®æœ€ä½³å®è·µ ğŸš€ 1. ä»€ä¹ˆæ˜¯ Pydanticï¼Ÿ Pydantic æ˜¯ Python çš„ æ•°æ®æ¨¡å‹ä¸æ•°æ®éªŒè¯åº“ï¼Œä¸»è¦åŠŸèƒ½ï¼š\nè‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆtype coercionï¼‰ è‡ªåŠ¨æ ¡éªŒæ•°æ®æ ¼å¼ ä¼˜é›…çš„é”™è¯¯ä¿¡æ¯ JSON å‹å¥½ è¶…å¿«ï¼ˆRust åŠ é€Ÿï¼Œè‡ª v2ï¼‰ ç‰¹åˆ«é€‚åˆï¼š\næ¥å£è¾“å…¥/è¾“å‡ºï¼ˆFastAPI é»˜è®¤ç”¨å®ƒï¼‰ é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆenv / json / yamlï¼‰ DTOï¼ˆä¸šåŠ¡ä¼ è¾“å¯¹è±¡ï¼‰ æ•°æ®æ¸…æ´—ä¸è½¬æ¢ ğŸ“Œ 2. æœ€åŸºç¡€ç¤ºä¾‹ï¼ˆPydantic v2 é£æ ¼ï¼‰ from pydantic import BaseModel, Field class User(BaseModel): id: int name: str active: bool = True u = User(id=\u0026#34;1\u0026#34;, name=\u0026#34;Tom\u0026#34;) # è‡ªåŠ¨æŠŠ \u0026#34;1\u0026#34; è½¬æˆ int print(u) è¾“å‡ºï¼š\n"},{"id":30,"href":"/backend/python/official/python-faq/","title":"Python FAQ","parent":"Official","content":"å†…å®¹ï¼š\nåŸºç¡€è¯­æ³• æ•°æ®ç»“æ„ è¿›é˜¶ç‰¹æ€§ é¢å‘å¯¹è±¡ å‡½æ•°å¼ç¼–ç¨‹ å¹¶å‘ï¼ˆå¤šçº¿ç¨‹ã€å¼‚æ­¥ã€è¿›ç¨‹ï¼‰ ç½‘ç»œä¸æ–‡ä»¶ æ ‡å‡†åº“ é«˜çº§æœºåˆ¶ é¡¹ç›®å®æˆ˜ æ€§èƒ½ä¼˜åŒ– å¸¸è§é™·é˜± å®Œå…¨é€‚ç”¨äº Python å¼€å‘ / çˆ¬è™« / æ•°æ®å·¥ç¨‹ / åç«¯ã€‚\nä¸€ã€Python åŸºç¡€ 1. Python çš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ è§£é‡Šå‹ã€åŠ¨æ€ç±»å‹ å¼ºç±»å‹ è·¨å¹³å° æ‹¥æœ‰ä¸°å¯Œæ ‡å‡†åº“ é¢å‘å¯¹è±¡ã€å‡½æ•°å¼é£æ ¼éƒ½æ”¯æŒ å¯è¯»æ€§å¥½ã€å¼€å‘æ•ˆç‡é«˜ 2. åˆ—è¡¨å’Œå…ƒç»„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ åˆ—è¡¨ list å…ƒç»„ tuple å¯å˜ ä¸å¯å˜ é€‚åˆåŠ¨æ€æ•°æ® é€‚åˆå›ºå®šç»“æ„æ•°æ® å ç”¨æ›´å¤§å†…å­˜ å†…å­˜æ›´å°ï¼Œé€Ÿåº¦æ›´å¿« append / pop æ— ä¿®æ”¹æ–¹æ³• å®æˆ˜ç»éªŒï¼š\næ•°æ®ä¸ä¼šå˜åŒ–æ—¶åº”ä¼˜å…ˆé€‰æ‹© tupleï¼Œå¯ä»¥ç”¨äº dict keyã€‚\n3. Python æ˜¯å¦‚ä½•è¿›è¡Œå†…å­˜ç®¡ç†çš„ï¼Ÿ å¼•ç”¨è®¡æ•°ï¼ˆprimary GCï¼‰ æ ‡è®°-æ¸…é™¤ï¼ˆå¤„ç†å¾ªç¯å¼•ç”¨ï¼‰ åˆ†ä»£å›æ”¶æœºåˆ¶ 4. == å’Œ is çš„åŒºåˆ«ï¼Ÿ == æ¯”è¾ƒå€¼ is æ¯”è¾ƒå¯¹è±¡å¼•ç”¨ï¼ˆæ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼‰ 5. æµ…æ‹·è´ deep / æ·±æ‹·è´ shallow çš„åŒºåˆ«ï¼Ÿ copy.copy() # æµ…æ‹·è´ï¼Œåªå¤åˆ¶æœ€å¤–å±‚ copy.deepcopy() # æ·±æ‹·è´ï¼Œé€’å½’å¤åˆ¶æ‰€æœ‰å±‚çº§ 6. Python ä¸­å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¯¹è±¡ï¼Ÿ ä¸å¯å˜ï¼šint, float, str, tuple, frozenset å¯å˜ï¼šlist, dict, set 7. ä»€ä¹ˆæ˜¯å¯è¿­ä»£å¯¹è±¡ Iterableï¼Ÿ å…·æœ‰ __iter__ æˆ– __getitem__ æ–¹æ³•çš„å¯¹è±¡ã€‚\nå¦‚ï¼šlist, tuple, dict, set, file, range, generator\n8. ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨ Generatorï¼Ÿ ä½¿ç”¨ yield è¿”å›çš„å‡½æ•°ï¼Œæƒ°æ€§è®¡ç®—ã€èŠ‚çº¦å†…å­˜ã€‚\n9. Python ä¸­çš„ä½œç”¨åŸŸè§„åˆ™ï¼Ÿï¼ˆLEGBï¼‰ L: Local E: Enclosing G: Global B: Built-in 10. ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼Ÿ æœ¬è´¨æ˜¯ä¸€ä¸ªæ¥å—å‡½æ•°å¹¶è¿”å›æ–°å‡½æ•°çš„é«˜é˜¶å‡½æ•°ï¼Œç”¨äºï¼š\næ—¥å¿— æƒé™æ§åˆ¶ ç¼“å­˜ æ€§èƒ½ç»Ÿè®¡ ç¤ºä¾‹ï¼š\ndef deco(fn): def wrapper(*a, **kw): print(\u0026#34;before\u0026#34;) return fn(*a, **kw) return wrapper äºŒã€æ•°æ®ç»“æ„ 11. listã€tupleã€setã€dict çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ æ“ä½œ list tuple set dict è®¿é—® O(1) O(1) N/A O(1) æ’å…¥ O(n) ä¸æ”¯æŒ O(1) O(1) åˆ é™¤ O(n) ä¸æ”¯æŒ O(1) O(1) æŸ¥æ‰¾ O(n) O(n) O(1) O(1) 12. Python å­—å…¸ä¸ºä»€ä¹ˆæ˜¯ O(1) æŸ¥æ‰¾ï¼Ÿ å› ä¸ºä½¿ç”¨å“ˆå¸Œè¡¨å­˜å‚¨ï¼Œé€šè¿‡ key çš„ hash å®šä½ bucketã€‚\n13. set çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ å’Œ dict ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å“ˆå¸Œè¡¨ï¼Œä¸å­˜ valueã€‚\n14. Python ä¸­å¦‚ä½•å¯¹å­—å…¸æ’åºï¼Ÿ sorted(d.items(), key=lambda x: x[1]) 15. åˆ—è¡¨æ¨å¯¼å¼ vs map/filter åˆ—è¡¨æ¨å¯¼å¼å¯è¯»æ€§æ›´å¥½ï¼š\n[x*x for x in lst if x\u0026gt;0] 16. zip å¦‚ä½•å·¥ä½œï¼Ÿ æ‰“åŒ…å¤šä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œè¿”å› tuple:\nzip([1,2], [\u0026#34;a\u0026#34;,\u0026#34;b\u0026#34;]) -\u0026gt; [(1,\u0026#34;a\u0026#34;), (2,\u0026#34;b\u0026#34;)] 17. enumerate çš„ç”¨æ³•ï¼Ÿ è·å–ï¼ˆç´¢å¼•, å€¼ï¼‰ï¼š\nfor i, v in enumerate(items, start=1): 18. å¦‚ä½•åè½¬ä¸€ä¸ªåˆ—è¡¨ï¼Ÿ lst[::-1] list(reversed(lst)) 19. ä»€ä¹ˆæ˜¯å­—å…¸æ¨å¯¼å¼ï¼Ÿ {x: x*x for x in range(5)} 20. ä¸ºä»€ä¹ˆ list ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ å› ä¸ºå†…éƒ¨æ²¡æœ‰ lockï¼Œå¤šçº¿ç¨‹ append æ—¶ä¼šç«äº‰èµ„æºã€‚\nä¸‰ã€å‡½æ•°ä¸ç±» 21. ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿ å‡½æ•°å†…éƒ¨å¼•ç”¨å¤–éƒ¨å˜é‡ï¼Œå¹¶åœ¨å‡½æ•°è¿”å›åä»ç„¶æœ‰æ•ˆã€‚\n22. ä»€ä¹ˆæ˜¯ lambdaï¼Ÿä¸ºä»€ä¹ˆä¸æ¨èå¤§é‡ä½¿ç”¨ï¼Ÿ åŒ¿åå‡½æ•°ï¼Œå¯è¯»æ€§å·®ï¼ŒåŠŸèƒ½æœ‰é™ã€‚\n23. *args å’Œ **kwargs çš„ä½œç”¨ï¼Ÿ æ¥æ”¶ä»»æ„æ•°é‡çš„ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚\n24. å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è°ƒç”¨ï¼Ÿ callable(obj) 25. @staticmethod vs @classmethod vs @property ç±»å‹ ç¬¬ä¸€ä¸ªå‚æ•° ç”¨é€” staticmethod æ—  å·¥å…·å‡½æ•° classmethod cls ç±»çº§è¡Œä¸ºï¼ˆå·¥å‚æ–¹æ³•ï¼‰ property self ä¼ªå±æ€§ 26. super() å¦‚ä½•å·¥ä½œï¼Ÿ æ‰§è¡Œ MROï¼ˆæ–¹æ³•è§£æé¡ºåºï¼‰é“¾ä¸Šçš„ä¸‹ä¸€ä¸ªç±»æ–¹æ³•ã€‚\n27. Python å¤šç»§æ‰¿å¦‚ä½•è§£å†³å†²çªï¼Ÿ ä½¿ç”¨ C3 MROã€‚\n28. dataclass æœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ è‡ªåŠ¨ç”Ÿæˆ initã€repr æ”¯æŒç±»å‹æ³¨è§£ å¯é€‰ frozen=Trueï¼ˆä¸å¯å˜ï¼‰ 29. slots æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ é™åˆ¶å®ä¾‹å±æ€§ï¼Œå‡å°‘å†…å­˜å ç”¨ã€æé«˜è®¿é—®é€Ÿåº¦ã€‚\n30. enter å’Œ exit å®ç°ä»€ä¹ˆï¼Ÿ ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆwithï¼‰ã€‚\nå››ã€å¹¶å‘ï¼ˆå¼‚æ­¥/çº¿ç¨‹/è¿›ç¨‹ï¼‰ 31. GIL æ˜¯ä»€ä¹ˆï¼Ÿ å…¨å±€è§£é‡Šå™¨é”ï¼Œä½¿åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ Python å­—èŠ‚ç ã€‚\n32. ThreadPoolExecutor å’Œ ProcessPoolExecutor åŒºåˆ«ï¼Ÿ ThreadPool ProcessPool å— GIL é™åˆ¶ ä¸å— GIL é€‚åˆ IO é€‚åˆ CPU è½»é‡ é‡ 33. asyncio çš„æœ¬è´¨ï¼Ÿ äº‹ä»¶å¾ªç¯ + åç¨‹ + å¯ç­‰å¾…å¯¹è±¡ã€‚\n34. async/await çš„ä½œç”¨ï¼Ÿ å£°æ˜åç¨‹ï¼Œç”¨äºå¼‚æ­¥ IOã€‚\n35. åç¨‹ã€çº¿ç¨‹ã€è¿›ç¨‹çš„åŒºåˆ«ï¼Ÿ åç¨‹æœ€è½» çº¿ç¨‹ä¸­ç­‰ è¿›ç¨‹æœ€é‡ï¼ˆæ‹¥æœ‰ç‹¬ç«‹å†…å­˜ï¼‰ 36. asyncio.run åšäº†ä»€ä¹ˆï¼Ÿ åˆ›å»ºäº‹ä»¶å¾ªç¯ æ‰§è¡Œåç¨‹ å…³é—­å¾ªç¯ 37. å¤šçº¿ç¨‹å¦‚ä½•å…±äº«æ•°æ®ï¼Ÿ ä½¿ç”¨ Lockï¼š\nlock = threading.Lock() with lock: ... 38. å¦‚ä½•åœ¨ asyncio ä¸­æ‰§è¡Œ CPU å¯†é›†ä»»åŠ¡ï¼Ÿ loop.run_in_executor(ProcessPoolExecutor(), func) 39. queue.Queue vs asyncio.Queue åŒºåˆ«ï¼Ÿ queue.Queueï¼šçº¿ç¨‹å®‰å…¨ asyncio.Queueï¼šå¼‚æ­¥ä»»åŠ¡é—´é€šä¿¡ 40. multiprocessing ä¸ºä»€ä¹ˆä¸èƒ½åœ¨ Windows ä¸­ä½¿ç”¨ lambdaï¼Ÿ å› ä¸º Windows é‡‡ç”¨ spawnï¼Œå¿…é¡»å¯åºåˆ—åŒ–ã€‚\näº”ã€æ–‡ä»¶/ç½‘ç»œ 41. with æ‰“å¼€æ–‡ä»¶çš„å¥½å¤„ï¼Ÿ è‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼Œé˜²æ­¢èµ„æºæ³„æ¼ã€‚\n42. å¦‚ä½•è¯»å–å¤§æ–‡ä»¶ï¼Ÿ ä½¿ç”¨æµå¼è¯»å–ï¼š\nfor line in f: 43. JSON åŠ è½½æ—¶å¦‚ä½•é¿å…æµ®ç‚¹è¯¯å·®ï¼Ÿ ç”¨ parse_float=Decimal æˆ– orjsonã€‚\n44. requests ä¸ºä»€ä¹ˆä¸æ˜¯å¼‚æ­¥çš„ï¼Ÿ å› ä¸ºå®ƒåŸºäºé˜»å¡ IOã€‚\n45. urllib vs requestsï¼Ÿ requests æ›´æ˜“ç”¨ã€åŠŸèƒ½æ›´å¼ºã€‚\n46. å¦‚ä½•ä¸‹è½½å¤§æ–‡ä»¶ï¼Ÿ stream=True 47. å¦‚ä½•åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Ÿ Path.exists() 48. å¦‚ä½•æ„å»ºå®‰å…¨ SQLï¼Ÿ ä½¿ç”¨å‚æ•°ç»‘å®šï¼Œç¦æ­¢æ‹¼æ¥ã€‚\n49. å¦‚ä½•è§£æ URL å‚æ•°ï¼Ÿ from urllib.parse import urlparse, parse_qs 50. å¦‚ä½•å†™ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ–‡ä»¶å†™å…¥ï¼Ÿ ä½¿ç”¨é”ã€‚\nå…­ã€é«˜çº§ç‰¹æ€§ 51. å…ƒç±»æ˜¯ä»€ä¹ˆï¼Ÿ åˆ›å»ºç±»çš„ç±»ï¼ˆæ§åˆ¶ç±»çš„è¡Œä¸ºï¼‰\n52. ä»€ä¹ˆæ˜¯çŒ´å­è¡¥ä¸ï¼Ÿ è¿è¡Œæ—¶ä¿®æ”¹ç±»æˆ–æ¨¡å—ã€‚\n53. getattr å’Œ getattribute åŒºåˆ«ï¼Ÿ getattrï¼šå±æ€§ä¸å­˜åœ¨æ—¶è°ƒç”¨ getattributeï¼šæ‰€æœ‰å±æ€§è®¿é—®éƒ½ä¼šè°ƒç”¨ 54. ä»€ä¹ˆæ˜¯æè¿°ç¬¦ï¼Ÿ å®ç° __get__, __set__, __delete__ çš„ç±»ï¼Œç”¨äºæ§åˆ¶å±æ€§è¡Œä¸ºã€‚\n55. è¿­ä»£å™¨åè®®æ˜¯ä»€ä¹ˆï¼Ÿ å¯¹è±¡å®ç°ï¼š\n__iter__ __next__ 56. yield from çš„ä½œç”¨ï¼Ÿ å°†å­ç”Ÿæˆå™¨çš„å€¼è‡ªåŠ¨ä¼ é€’ç»™å¤–å±‚ç”Ÿæˆå™¨ï¼š\nyield from sub_generator() 57. functools.lru_cache çš„ä¼˜ç‚¹ï¼Ÿ ç¼“å­˜å‡½æ•°è¿”å›å€¼ï¼Œæé«˜æ€§èƒ½ã€‚\n58. ä¸ºä»€ä¹ˆ Python ä¸èƒ½è¿›è¡Œ tail call optimizationï¼Ÿ é¿å…éšè— stack traceï¼Œä¿æŒ debug èƒ½åŠ›ã€‚\n59. è£…é¥°å™¨ä¸ºä»€ä¹ˆéœ€è¦ wrapsï¼Ÿ ä¿ç•™åŸå‡½æ•°çš„å…ƒæ•°æ®ï¼ˆåå­—ã€æ–‡æ¡£ï¼‰ã€‚\n60. ä»€ä¹ˆæ˜¯é¸­å­ç±»å‹ï¼Ÿ ä¸æ˜¯é€šè¿‡â€œç±»å‹â€åˆ¤æ–­ï¼Œè€Œæ˜¯é€šè¿‡â€œè¡Œä¸ºâ€åˆ¤æ–­ã€‚\n","description":"å†…å®¹ï¼š\nåŸºç¡€è¯­æ³• æ•°æ®ç»“æ„ è¿›é˜¶ç‰¹æ€§ é¢å‘å¯¹è±¡ å‡½æ•°å¼ç¼–ç¨‹ å¹¶å‘ï¼ˆå¤šçº¿ç¨‹ã€å¼‚æ­¥ã€è¿›ç¨‹ï¼‰ ç½‘ç»œä¸æ–‡ä»¶ æ ‡å‡†åº“ é«˜çº§æœºåˆ¶ é¡¹ç›®å®æˆ˜ æ€§èƒ½ä¼˜åŒ– å¸¸è§é™·é˜± å®Œå…¨é€‚ç”¨äº Python å¼€å‘ / çˆ¬è™« / æ•°æ®å·¥ç¨‹ / åç«¯ã€‚\nä¸€ã€Python åŸºç¡€ 1. Python çš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ è§£é‡Šå‹ã€åŠ¨æ€ç±»å‹ å¼ºç±»å‹ è·¨å¹³å° æ‹¥æœ‰ä¸°å¯Œæ ‡å‡†åº“ é¢å‘å¯¹è±¡ã€å‡½æ•°å¼é£æ ¼éƒ½æ”¯æŒ å¯è¯»æ€§å¥½ã€å¼€å‘æ•ˆç‡é«˜ 2. åˆ—è¡¨å’Œå…ƒç»„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ åˆ—è¡¨ list å…ƒç»„ tuple å¯å˜ ä¸å¯å˜ é€‚åˆåŠ¨æ€æ•°æ® é€‚åˆå›ºå®šç»“æ„æ•°æ® å ç”¨æ›´å¤§å†…å­˜ å†…å­˜æ›´å°ï¼Œé€Ÿåº¦æ›´å¿« append / pop æ— ä¿®æ”¹æ–¹æ³• å®æˆ˜ç»éªŒï¼š\n"},{"id":31,"href":"/database/redis/faq/","title":"Redis FAQ","parent":"Redis","content":" ä¸€ã€Redis åŸºç¡€å¿…è€ƒ 1. Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿï¼ˆå¿…è€ƒï¼‰ æ ¸å¿ƒåŸå› ï¼š\nçº¯å†…å­˜æ“ä½œï¼šè®¿é—®å†…å­˜çº¦ 100nsï¼Œæ— ç£ç›˜å»¶è¿Ÿ å•çº¿ç¨‹ + IO å¤šè·¯å¤ç”¨ï¼šé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢ é«˜æ•ˆæ•°æ®ç»“æ„ï¼šdictã€skiplistã€ziplistã€intsetã€quicklist ä¼˜åŒ–çš„ç½‘ç»œæ¨¡å‹ï¼šepoll/kqueue + éé˜»å¡ IO æ€»ç»“ï¼š\nRedis æ˜¯åŸºäºå†…å­˜ + å•çº¿ç¨‹ + é«˜æ•ˆæ•°æ®ç»“æ„çš„é«˜æ€§èƒ½ KV æ•°æ®åº“ã€‚\n2. Redis ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿå®ƒä¸æ˜¯æ…¢å—ï¼Ÿ å› ä¸º Redis çš„ç“¶é¢ˆä¸æ˜¯ CPUï¼Œè€Œæ˜¯å†…å­˜å’Œç½‘ç»œ IOã€‚\nå•çº¿ç¨‹å¥½å¤„ï¼š\næ— é”ç«äº‰ï¼Œé¿å…æ­»é” ä»£ç å®ç°ç®€å•ç¨³å®š æ€§èƒ½è¶³å¤Ÿï¼ˆæ™®é€šä¸šåŠ¡éš¾å‹æ»¡ä¸€æ ¸ï¼‰ Redis å†…éƒ¨ä½¿ç”¨å¤šçº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰å¤„ç†ï¼š\nAOF rewrite RDB save æ¸…ç†å¤§ key ç½‘ç»œ I/Oï¼ˆ6.0+ï¼‰ 3. Redis å¸¸ç”¨çš„æ•°æ®ç±»å‹ï¼Ÿç”¨é€”ï¼Ÿ ç±»å‹ ç”¨é€” String ç¼“å­˜ã€è®¡æ•°å™¨ã€Session Hash ç”¨æˆ·ä¿¡æ¯ã€å¯¹è±¡ List é˜Ÿåˆ—ã€æ—¥å¿—æµ Set å»é‡ã€æ ‡ç­¾ã€å¥½å‹ ZSet æ’è¡Œæ¦œã€å»¶æ—¶é˜Ÿåˆ— Bitmap ç­¾åˆ°ã€åœ¨çº¿ç»Ÿè®¡ HyperLogLog å¤§è§„æ¨¡ UV å»é‡ Stream æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka-likeï¼‰ 4. Redis çš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Ÿ ä¸¤ç§ï¼š\næƒ°æ€§åˆ é™¤ï¼ˆlazy deleteï¼‰ -\u0026gt; key åˆ°æœŸåè®¿é—®æ‰åˆ é™¤ å®šæœŸåˆ é™¤ï¼ˆactiveï¼‰ -\u0026gt; æ¯éš”ä¸€æ®µæ—¶é—´éšæœºæŠ½æŸ¥ key æœ€ç»ˆç”± å†…å­˜æ·˜æ±°æœºåˆ¶ æ”¶å°¾ã€‚\n5. Redis å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿï¼ˆå¿…è€ƒï¼‰ ç­–ç•¥ è¯´æ˜ noeviction ä¸å†å†™å…¥ volatile-lru åªä»æœ‰è¿‡æœŸçš„ key ä¸­åˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨ allkeys-lru æ‰€æœ‰ key ä¸­åˆ é™¤ LRU volatile-lfu æœ‰è¿‡æœŸ key ä¸­åˆ é™¤æœ€ä¸å¸¸ç”¨ allkeys-lfu æ‰€æœ‰ key ä¸­åˆ é™¤æœ€ä¸å¸¸ç”¨ volatile-ttl TTL è¶ŠçŸ­è¶Šä¼˜å…ˆåˆ é™¤ volatile-random / allkeys-random éšæœºåˆ  ä¼ä¸šæœ€å¸¸ç”¨ï¼š\nallkeys-lru æˆ– allkeys-lfu\n6. Redis å¦‚ä½•åšæŒä¹…åŒ–ï¼ŸåŒºåˆ«ï¼Ÿ RDBï¼ˆå¿«ç…§ï¼‰\né—´éš”å­˜å‚¨å†…å­˜å¿«ç…§åˆ°ç£ç›˜ æ¢å¤å¿«ï¼Œä½†å¯èƒ½ä¸¢å¤±å‡ åˆ†é’Ÿæ•°æ® AOFï¼ˆæ—¥å¿—ï¼‰\næ¯æ¬¡å†™æ“ä½œéƒ½è®°å½• å‡ ä¹ä¸ä¸¢æ•°æ®ï¼ˆeverysecï¼‰ æ–‡ä»¶å¤§ï¼Œéœ€è¦ rewrite é€šå¸¸é‡‡ç”¨ï¼š\nRDB + AOF æ··åˆæŒä¹…åŒ–\n7. Redis äº‹åŠ¡æ˜¯å¦åŸå­ï¼Ÿ æ˜¯åŸå­æ€§çš„ï¼Œä½† Redis äº‹åŠ¡ç‰¹ç‚¹ï¼š\nå‘½ä»¤ä¾æ¬¡æ‰§è¡Œ ä¸æ”¯æŒå›æ»š æ”¯æŒ WATCH å®ç°ä¹è§‚é” 8. Redis åˆ†å¸ƒå¼é”å¦‚ä½•å®ç°ï¼Ÿ æ ‡å‡†å†™æ³•ï¼ˆåŸå­ï¼‰ï¼š\nSET lock_key uuid NX EX 10 åˆ é™¤é”ï¼ˆç”¨ Lua åŸå­åˆ¤æ–­ï¼‰ï¼š\nif redis.call(\u0026#34;get\u0026#34;, KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;, KEYS[1]) else return 0 end 9. Redis å¦‚ä½•é¿å…ç¼“å­˜ç©¿é€ï¼Ÿ ç­–ç•¥ï¼š\nç¼“å­˜ç©ºå€¼ï¼ˆnull ç¼“å­˜ï¼‰ å¸ƒéš†è¿‡æ»¤å™¨ å‚æ•°æ ¡éªŒï¼ˆID \u0026lt;= 0 ç›´æ¥æ‹’ç»ï¼‰ 10. ç¼“å­˜é›ªå´©å¦‚ä½•è§£å†³ï¼Ÿ å¤š key åŒæ—¶å¤±æ•ˆ æˆ– Redis å®•æœºã€‚\nè§£å†³ï¼š\nTTL åŠ éšæœºå€¼ï¼ˆé¿å…åŒæ—¶å¤±æ•ˆï¼‰ å¤šçº§ç¼“å­˜ï¼ˆRedis + æœ¬åœ°ç¼“å­˜ï¼‰ Redis é›†ç¾¤é«˜å¯ç”¨ çƒ­ç‚¹æ•°æ®ä¸è¿‡æœŸï¼ˆé€»è¾‘è¿‡æœŸï¼‰ äºŒã€è¿›é˜¶ 11. ç¼“å­˜å‡»ç©¿å¦‚ä½•è§£å†³ï¼Ÿ æŸçƒ­ç‚¹ key çªç„¶å¤±æ•ˆã€‚\nè§£å†³ï¼š\nåŠ äº’æ–¥é”ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ çƒ­ç‚¹ key â€œæ°¸ä¸è¿‡æœŸâ€ + åå°æ›´æ–° é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ 12. å¤§ key é—®é¢˜å¦‚ä½•å¤„ç†ï¼Ÿ å¤§ key = å•ä½“å¤ªå¤§\né—®é¢˜ï¼š\nåˆ é™¤æ…¢ï¼ˆé˜»å¡ï¼‰ è¿ç§»æ…¢ ç½‘ç»œä¼ è¾“æ…¢ å†…å­˜è†¨èƒ€ è§£å†³ï¼š\næ‹†æˆå¤šä¸ªå° key ä½¿ç”¨ SCAN éå† big hash å¼‚æ­¥åˆ é™¤ï¼ˆunlinkï¼‰ 13. Redis å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼Ÿ ä¸‰ç§ï¼š\nä¸»ä»ï¼ˆReplicationï¼‰ -\u0026gt; ä¸è‡ªåŠ¨æ•…éšœè½¬ç§» å“¨å…µ Sentinel -\u0026gt; è‡ªåŠ¨ Failover Cluster -\u0026gt; åˆ†ç‰‡ + é«˜å¯ç”¨ ä¼ä¸šä½¿ç”¨ï¼š\nRedis Cluster 3 ä¸» 3 ä» + å“¨å…µæ¨¡å¼å¤‡ä»½\n14. Redis Cluster ä¸ºä»€ä¹ˆåªèƒ½ä½¿ç”¨ DB 0ï¼Ÿ å› ä¸ºå¤š DB ä¼šç ´åæ§½ä½ hash è§„åˆ™ï¼Œå¹¶äº§ç”Ÿè·¨ slot äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ã€‚\n15. Redis Cluster å¤š key æ“ä½œæœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ å¿…é¡»ä¿è¯ï¼š\næ‰€æœ‰ key çš„ hash slot ä¸€è‡´\nå¦åˆ™æŠ¥é”™ï¼š\nCROSSSLOT Keys in request don\u0026#39;t hash to the same slot è§£å†³ï¼š\nä½¿ç”¨ hash tagï¼š\nuser:{1}:name user:{1}:age 16. Redis å¦‚ä½•å®ç°ä¸»ä»åŒæ­¥ï¼Ÿ ä¸¤ä¸ªé˜¶æ®µï¼š\nå…¨é‡åŒæ­¥ï¼šå‘é€ RDB æ–‡ä»¶ å¢é‡åŒæ­¥ï¼šå‘é€ replication buffer psync2ï¼ˆ2.8+ï¼‰æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚\n17. Redis çš„è¿‡æœŸ key æ˜¯ç²¾ç¡®åˆ é™¤å—ï¼Ÿ ä¸æ˜¯ã€‚\næƒ°æ€§åˆ é™¤ + å®šæœŸæ‰«æ -\u0026gt; ä¸æ˜¯ç²¾ç¡®æ—¶åˆ»åˆ é™¤\nä½†ä¸€å®šåœ¨è®¿é—®æˆ–æ‰«ææ—¶æœ€ç»ˆåˆ é™¤æ‰ã€‚\n18. Redis çš„ Pipeline æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ æŠŠå¤šä¸ªå‘½ä»¤ä¸€æ¬¡å‘é€ï¼Œå‡å°‘ RTTï¼ˆç½‘ç»œå¾€è¿”ï¼‰\næ€§èƒ½æå‡å·¨å¤§ã€‚\n19. Redis ä½¿ç”¨è·³è¡¨ï¼ˆskiplistï¼‰åšä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç”¨è·³è¡¨ï¼Ÿ è·³è¡¨ä¸»è¦ç”¨äº ZSetï¼ˆsorted setï¼‰ã€‚\nä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘ï¼Ÿ\nè·³è¡¨æ›´å®¹æ˜“å®ç° æ”¯æŒåŒºé—´æ‰«ææ›´é«˜æ•ˆ è·³è¡¨åœ¨èŒƒå›´æŸ¥è¯¢ã€æ’å…¥æ€§èƒ½æ¥è¿‘ O(log N) 20. Redis å†…éƒ¨å¦‚ä½•å®ç°è¿‡æœŸåˆ é™¤ï¼Ÿ ä¸‰éƒ¨åˆ†ï¼š\næƒ°æ€§åˆ é™¤ï¼ˆè®¿é—®æ‰åˆ ï¼‰ å®šæœŸåˆ é™¤ï¼ˆå®šæ—¶ä»»åŠ¡æŠ½æ ·åˆ é™¤ï¼‰ æ·˜æ±°ç­–ç•¥ï¼ˆå†…å­˜ä¸è¶³æ—¶è§¦å‘ï¼‰ 21. Redis Hash ä¸ºä»€ä¹ˆæœ‰ ziplist å’Œ hashtable ä¸¤ç§ç¼–ç ï¼Ÿ ä¼˜åŒ–å†…å­˜ï¼š\nå° Hash -\u0026gt; ziplistï¼ˆè¿ç»­å†…å­˜ã€æ›´çœç©ºé—´ï¼‰ å¤§ Hash -\u0026gt; hashtableï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ Redis ä¼šè‡ªåŠ¨åœ¨äºŒè€…é—´è½¬æ¢ã€‚\n22. Redis å†…éƒ¨ä¸ºä»€ä¹ˆè¦åš rehashï¼Ÿrehash æ˜¯æ€æ ·çš„ï¼Ÿ ä¸ºäº†ä¿æŒ hash table çš„ O(1) æ€§èƒ½ã€‚\né‡‡ç”¨ï¼š\næ¸è¿›å¼ rehashï¼ˆincremental rehashï¼‰\nä¸æ˜¯ä¸€æ¬¡æ€§ç§»åŠ¨ï¼Œè€Œæ˜¯æ¯æ¬¡æ“ä½œè¿ç§»ä¸€éƒ¨åˆ†å…ƒç´ ï¼Œé¿å…é˜»å¡ã€‚\nä¸‰ã€è¿›é˜¶ 23. Redis å¦‚ä½•å®ç°å¼‚æ­¥åˆ é™¤ï¼Ÿä¸ºä»€ä¹ˆè¦å¼‚æ­¥ï¼Ÿ Luaï¼š\nUNLINK key å¼‚æ­¥åˆ é™¤ keyï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼ˆç‰¹åˆ«æ˜¯å¤§ keyï¼‰ã€‚\n24. Redis 6.0 ä¸ºä»€ä¹ˆå¼•å…¥å¤šçº¿ç¨‹ï¼Ÿ åŸå› ï¼š\nä¸»è¦ä¸ºäº†ä¼˜åŒ– ç½‘ç»œ I/Oï¼Œä¸æ˜¯æ‰§è¡Œå‘½ä»¤ã€‚\nå¤šçº¿ç¨‹ç»“æ„ï¼š\nI/O å¤šçº¿ç¨‹è´Ÿè´£è¯»å†™ç½‘ç»œæ•°æ® å‘½ä»¤è§£æ \u0026amp; æ‰§è¡Œä»ç„¶å•çº¿ç¨‹ è§£å†³ç½‘ç»œç“¶é¢ˆé—®é¢˜ã€‚\n25. å¦‚ä½•é˜²æ­¢ Redis çƒ­ç‚¹ key é›†ä¸­åˆ°å•ä¸ªèŠ‚ç‚¹ï¼Ÿï¼ˆClusterï¼‰ ä¸¤ä¸ªåŠæ³•ï¼š\n1. key åšéšæœºæ•£åˆ—ï¼Œä¾‹å¦‚ï¼š\nuser:123 -\u0026gt; user:123:rand 2. ä½¿ç”¨é¢„åˆ†ç‰‡ï¼ˆåˆ†æ¡¶ï¼‰\nbucket:001:user:123 bucket:002:user:888 26. Redis å¦‚ä½•å¤„ç†ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„ä¸»ä»è„‘è£‚ï¼Ÿ å“¨å…µè§„åˆ™ï¼š\nTILT æ¨¡å¼ min-slaves-max-lag down-after-milliseconds ä¸¥æ ¼ä¿è¯åªæœ‰ä¸€ä¸ª MASTERã€‚\n27. Redis ä¸ºä»€ä¹ˆä¸é€‚åˆå­˜å¤§å¯¹è±¡ï¼Ÿ åŸå› ï¼š\nRedis å†…å­˜è´µ å¤§ key ä¼šå¯¼è‡´é˜»å¡ AOF/RDB è¿ç§»æˆæœ¬é«˜ å½±å“ç½‘ç»œä¼ è¾“ æœ€ä½³å®è·µï¼š\nRedis å­˜çƒ­ç‚¹ã€å°å¯¹è±¡ã€ç»“æ„åŒ–æ•°æ®ï¼Œä¸å­˜å¤§æ–‡ä»¶ã€‚\n28. Redis Stream ä¸ Kafka æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç‰¹æ€§ Redis Stream Kafka å­˜å‚¨ å†…å­˜ä¸ºä¸»ï¼Œå¯è½ç›˜ ç£ç›˜ å»¶è¿Ÿ è¶…ä½ï¼ˆ\u0026lt;1msï¼‰ è¾ƒä½ï¼ˆ\u0026lt;10msï¼‰ æ¶ˆè´¹æ¨¡å‹ æ¶ˆè´¹ç»„ + ack æ¶ˆè´¹ç»„ + offset è§„æ¨¡ å°è§„æ¨¡ä¸šåŠ¡ å¤§æµé‡æ—¥å¿—/æ¶ˆæ¯é˜Ÿåˆ— ç»“è®ºï¼š\nRedis Stream ç”¨äºè½»é‡æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸æ›¿ä»£ Kafkaã€‚\n29. Redis å¸ƒéš†è¿‡æ»¤å™¨åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ æ ¸å¿ƒï¼š\nå¤šä¸ª hash å‡½æ•° ä¸€ä¸ªä½æ•°ç»„ å­˜åœ¨å°æ¦‚ç‡è¯¯åˆ¤ false positiveï¼ˆè¯¯åˆ¤å­˜åœ¨ï¼‰ ä¼˜ç‚¹ï¼š\nè¶…çœå†…å­˜ï¼Œå¯è¿‡æ»¤ä¸å­˜åœ¨çš„æ•°æ®ã€‚\n30. å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜æ€§èƒ½çš„ Redis ç¼“å­˜ç³»ç»Ÿï¼Ÿ key å‘½åè§„èŒƒ çƒ­ç‚¹ç¼“å­˜æ°¸ä¸è¿‡æœŸ + é€»è¾‘è¿‡æœŸ å¤šçº§ç¼“å­˜ï¼ˆæœ¬åœ° + Redisï¼‰ é˜²ç©¿é€ã€é˜²é›ªå´©ã€é˜²å‡»ç©¿ Redis Cluster è¯»å†™éš”ç¦» Lazy Preloadï¼ˆæå‰é¢„çƒ­ï¼‰ å¤§ key æ‹†åˆ† æ‰¹å¤„ç† + pipeline é™æµ + åˆ†å¸ƒå¼é” ","description":" ä¸€ã€Redis åŸºç¡€å¿…è€ƒ 1. Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿï¼ˆå¿…è€ƒï¼‰ æ ¸å¿ƒåŸå› ï¼š\nçº¯å†…å­˜æ“ä½œï¼šè®¿é—®å†…å­˜çº¦ 100nsï¼Œæ— ç£ç›˜å»¶è¿Ÿ å•çº¿ç¨‹ + IO å¤šè·¯å¤ç”¨ï¼šé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢ é«˜æ•ˆæ•°æ®ç»“æ„ï¼šdictã€skiplistã€ziplistã€intsetã€quicklist ä¼˜åŒ–çš„ç½‘ç»œæ¨¡å‹ï¼šepoll/kqueue + éé˜»å¡ IO æ€»ç»“ï¼š\nRedis æ˜¯åŸºäºå†…å­˜ + å•çº¿ç¨‹ + é«˜æ•ˆæ•°æ®ç»“æ„çš„é«˜æ€§èƒ½ KV æ•°æ®åº“ã€‚\n2. Redis ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿå®ƒä¸æ˜¯æ…¢å—ï¼Ÿ å› ä¸º Redis çš„ç“¶é¢ˆä¸æ˜¯ CPUï¼Œè€Œæ˜¯å†…å­˜å’Œç½‘ç»œ IOã€‚\n"},{"id":32,"href":"/backend/python/redis/tutorial/","title":"Redis åŸºç¡€æ•™ç¨‹","parent":"Redis","content":"ä¸‹é¢ç»™ä½ æ•´ç†ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ˜“æ‡‚ã€å¯ç›´æ¥ä¸Šæ‰‹çš„ Python redis åº“æ•™ç¨‹ï¼ˆåŸºäºæœ€æ–°ç‰ˆ redis-py 5.xï¼‰ï¼ŒåŒ…å«ï¼šè¿æ¥ã€å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆã€å“ˆå¸Œã€è¿‡æœŸã€ç®¡é“ã€å‘å¸ƒè®¢é˜…ã€è¿æ¥æ± ã€JSON æ¨¡å—ã€å®é™…é¡¹ç›®å»ºè®®ç­‰ã€‚\n1. å®‰è£… pip install redis 2. è¿æ¥ Redis import redis r = redis.Redis( host=\u0026#39;localhost\u0026#39;, port=6379, db=0, decode_responses=True # è‡ªåŠ¨è§£ç å­—ç¬¦ä¸²ä¸º str ) 3. å­—ç¬¦ä¸²ï¼ˆStringï¼‰ è®¾ç½®å€¼\nr.set(\u0026#34;name\u0026#34;, \u0026#34;alice\u0026#34;) è·å–å€¼\nprint(r.get(\u0026#34;name\u0026#34;)) # alice è®¾ç½®è¿‡æœŸï¼ˆç§’ï¼‰\nr.set(\u0026#34;token\u0026#34;, \u0026#34;abc123\u0026#34;, ex=10) # 10ç§’åè¿‡æœŸ åŸå­é€’å¢ / é€’å‡\nr.incr(\u0026#34;counter\u0026#34;) # +1 r.incrby(\u0026#34;counter\u0026#34;, 5) # +5 r.decr(\u0026#34;counter\u0026#34;) # -1 4. åˆ—è¡¨ï¼ˆListï¼‰ æ·»åŠ å…ƒç´ \nr.rpush(\u0026#34;numbers\u0026#34;, \u0026#34;1\u0026#34;, \u0026#34;2\u0026#34;, \u0026#34;3\u0026#34;) # å³æ¨å…¥ r.lpush(\u0026#34;numbers\u0026#34;, \u0026#34;0\u0026#34;) # å·¦æ¨å…¥ æŸ¥çœ‹åˆ—è¡¨\nr.lrange(\u0026#34;numbers\u0026#34;, 0, -1) å¼¹å‡ºå…ƒç´ \nr.lpop(\u0026#34;numbers\u0026#34;) # å·¦å¼¹ r.rpop(\u0026#34;numbers\u0026#34;) # å³å¼¹ æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨\nRedis æœ¬èº« æ— â€œåˆ—è¡¨ containsâ€å‘½ä»¤ï¼Œè¦æ‰‹åŠ¨æŸ¥ï¼š\nitems = r.lrange(\u0026#34;numbers\u0026#34;, 0, -1) if \u0026#34;4\u0026#34; not in items: r.rpush(\u0026#34;numbers\u0026#34;, \u0026#34;4\u0026#34;) 5. é›†åˆï¼ˆSetï¼‰ æ·»åŠ å…ƒç´ \nr.sadd(\u0026#34;tags\u0026#34;, \u0026#34;python\u0026#34;, \u0026#34;redis\u0026#34;) æŸ¥çœ‹æˆå‘˜\nr.smembers(\u0026#34;tags\u0026#34;) åˆ¤æ–­æ˜¯å¦å­˜åœ¨\nr.sismember(\u0026#34;tags\u0026#34;, \u0026#34;python\u0026#34;) # True 6. æœ‰åºé›†åˆï¼ˆSorted Setï¼‰ æ·»åŠ \nr.zadd(\u0026#34;scores\u0026#34;, {\u0026#34;alice\u0026#34;: 100, \u0026#34;bob\u0026#34;: 95}) è·å–æŒ‡å®šèŒƒå›´\nr.zrange(\u0026#34;scores\u0026#34;, 0, -1, withscores=True) 7. å“ˆå¸Œï¼ˆHashï¼‰ è®¾ç½® / è·å–å­—æ®µ\nr.hset(\u0026#34;user:1\u0026#34;, mapping={\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 20}) r.hget(\u0026#34;user:1\u0026#34;, \u0026#34;name\u0026#34;) è·å–å…¨éƒ¨\nr.hgetall(\u0026#34;user:1\u0026#34;) 8. é”®ä¸è¿‡æœŸ åˆ é™¤é”®\nr.delete(\u0026#34;mykey\u0026#34;) è®¾ç½®è¿‡æœŸ\nr.expire(\u0026#34;session\u0026#34;, 60) # 60ç§’ æŸ¥çœ‹å‰©ä½™ TTL\nr.ttl(\u0026#34;session\u0026#34;) 9. ç®¡é“ï¼ˆPipelineï¼‰â€”â€” æ‰¹é‡æ‰§è¡Œï¼Œå‡å°‘ç½‘ç»œå¼€é”€ pipe = r.pipeline() pipe.set(\u0026#34;a\u0026#34;, 1) pipe.incr(\u0026#34;a\u0026#34;) pipe.get(\u0026#34;a\u0026#34;) result = pipe.execute() print(result) 10. å‘å¸ƒ / è®¢é˜…ï¼ˆPub/Subï¼‰ å‘å¸ƒæ¶ˆæ¯\nr.publish(\u0026#34;news\u0026#34;, \u0026#34;hello redis\u0026#34;) è®¢é˜…æ¶ˆæ¯\npubsub = r.pubsub() pubsub.subscribe(\u0026#34;news\u0026#34;) for msg in pubsub.listen(): print(msg) 11. è¿æ¥æ± ï¼ˆæ¨èç”¨äºé«˜å¹¶å‘ï¼‰ pool = redis.ConnectionPool(host=\u0026#39;localhost\u0026#39;, port=6379, db=0) r = redis.Redis(connection_pool=pool) 12. Redis JSONï¼ˆå¦‚æœæœåŠ¡å™¨å®‰è£…äº† RedisJSON æ¨¡å—ï¼‰ å®‰è£…ï¼š\npip install redis ä½¿ç”¨ï¼š\nfrom redis import Redis from redis.commands.json.path import Path r = Redis() r.json().set(\u0026#34;user:1\u0026#34;, Path.root_path(), {\u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;age\u0026#34;: 20}) print(r.json().get(\u0026#34;user:1\u0026#34;)) 13. å®æˆ˜æ¡ˆä¾‹ï¼šæ•°å­—æ¯ç§’é€’å¢ ä½ åˆšåˆšé—®çš„ï¼š\nimport redis, time r = redis.Redis(decode_responses=True) key = \u0026#34;detail_latest_number\u0026#34; r.set(key, 100) while True: r.incr(key) print(\u0026#34;å½“å‰å€¼ï¼š\u0026#34;, r.get(key)) time.sleep(1) ä½¿ç”¨ incr æ˜¯åŸå­æ“ä½œï¼Œæ¯”æ‰‹åŠ¨ get+set æ›´å®‰å…¨ã€‚\n14. å®æˆ˜æ¡ˆä¾‹ï¼šåˆ—è¡¨å»é‡æ’å…¥ key = \u0026#34;cls_detail_numbers\u0026#34; if \u0026#34;4\u0026#34; not in r.lrange(key, 0, -1): r.rpush(key, \u0026#34;4\u0026#34;) 15. æ¸…ç©ºåˆ—è¡¨ r.delete(\u0026#34;cls_detail_numbers\u0026#34;) 16. é¡¹ç›®ä¸­å¸¸ç”¨æœ€ä½³å®è·µ ä½¿ç”¨ decode_responses=Trueï¼Œé¿å… bytes ä½¿ç”¨è¿æ¥æ± æé«˜æ€§èƒ½ ä½¿ç”¨ incr/incrby åšè®¡æ•°å™¨ ä½¿ç”¨ TTL é˜²æ­¢é”®æ— é™å¢é•¿ ä¿å­˜ç»“æ„åŒ–æ•°æ®å°½é‡ä½¿ç”¨ hash æˆ– RedisJSON é«˜å¹¶å‘å¿«é€Ÿé˜Ÿåˆ—ä½¿ç”¨ list / stream Python ç”Ÿäº§çº§ç”¨æ³•ï¼ˆè¶…çº§å…³é”®ğŸ”¥ï¼‰ ä½¿ç”¨è¿æ¥æ±  import redis pool = redis.ConnectionPool( host=\u0026#39;localhost\u0026#39;, port=6379, db=0, decode_responses=True, max_connections=200 ) r = redis.Redis(connection_pool=pool) ç»ä¸è¦ä½¿ç”¨ get+set è‡ªå¢ ä½¿ç”¨åŸå­æ“ä½œï¼š\nr.incr(\u0026#34;counter\u0026#34;) ä½¿ç”¨ Pipeline æ‰¹é‡æ‰§è¡Œ pipe = r.pipeline() pipe.incr(\u0026#34;views\u0026#34;) pipe.sadd(\u0026#34;users\u0026#34;, \u0026#34;martin\u0026#34;) result = pipe.execute() ä½¿ç”¨ SCAN è€Œé KEYS for key in r.scan_iter(\u0026#34;*\u0026#34;): print(key) Redis ä½œä¸ºé”ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ with r.lock(\u0026#34;my_lock\u0026#34;, timeout=10): # ä¸šåŠ¡ä»£ç  ","description":"ä¸‹é¢ç»™ä½ æ•´ç†ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ˜“æ‡‚ã€å¯ç›´æ¥ä¸Šæ‰‹çš„ Python redis åº“æ•™ç¨‹ï¼ˆåŸºäºæœ€æ–°ç‰ˆ redis-py 5.xï¼‰ï¼ŒåŒ…å«ï¼šè¿æ¥ã€å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆã€å“ˆå¸Œã€è¿‡æœŸã€ç®¡é“ã€å‘å¸ƒè®¢é˜…ã€è¿æ¥æ± ã€JSON æ¨¡å—ã€å®é™…é¡¹ç›®å»ºè®®ç­‰ã€‚\n1. å®‰è£… pip install redis 2. è¿æ¥ Redis import redis r = redis.Redis( host=\u0026#39;localhost\u0026#39;, port=6379, db=0, decode_responses=True # è‡ªåŠ¨è§£ç å­—ç¬¦ä¸²ä¸º str ) 3. å­—ç¬¦ä¸²ï¼ˆStringï¼‰ è®¾ç½®å€¼\n"},{"id":33,"href":"/database/redis/tutorial/","title":"Redis åŸºç¡€æ•™ç¨‹","parent":"Redis","content":" 1. Redis æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ª åŸºäºå†…å­˜ çš„ Key-Value æ•°æ®åº“ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œè¯»å†™æå¿«ï¼Œå¸¸ç”¨äºç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\nå»¶è¿Ÿï¼šå¾®ç§’çº§ QPSï¼š10wï½50w+ é‡‡ç”¨ I/O å¤šè·¯å¤ç”¨ + å•çº¿ç¨‹æ¨¡å‹ï¼ˆæ‰§è¡Œå‘½ä»¤ä»æ˜¯å•çº¿ç¨‹ï¼‰ 2. Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰ Redis çš„é«˜æ€§èƒ½æ¥è‡ªå››ç‚¹ï¼š\nå®Œå…¨åŸºäºå†…å­˜æ“ä½œ å•çº¿ç¨‹é¿å…é”ç«äº‰ I/O å¤šè·¯å¤ç”¨ï¼ˆepollï¼‰å¤„ç†å¤§é‡è¿æ¥ é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆä¸æ˜¯â€œå­—ç¬¦ä¸²â€ï¼Œæ˜¯ SDSã€è‡ªç ”çš„å“ˆå¸Œè¡¨ç­‰ï¼‰ 3. Redis æ˜¯å•çº¿ç¨‹å—ï¼Ÿ å‘½ä»¤æ‰§è¡Œï¼šå•çº¿ç¨‹ ç½‘ç»œå¤„ç†ï¼ˆä» 6.0 å¼€å§‹ï¼‰ï¼šI/O å¤šçº¿ç¨‹ åå°ä»»åŠ¡ï¼ˆRDB/AOF é‡å†™ï¼‰ï¼šç‹¬ç«‹çº¿ç¨‹ æ ¸å¿ƒé€»è¾‘ä»æ˜¯å•çº¿ç¨‹ï¼Œè¿™æ‰ä¿è¯é«˜æ€§èƒ½ä¸ä¸€è‡´æ€§ã€‚\n4. Redis Key-Value çš„çœŸå®ç»“æ„ï¼ˆä¸æ˜¯ç®€å•å­—ç¬¦ä¸²ï¼‰ Redis å†…éƒ¨ä½¿ç”¨ å¯¹è±¡ç³»ç»Ÿ + ç¼–ç ï¼ˆencodingï¼‰\nå¸¸è§ç¼–ç æ–¹å¼ï¼š\nrawï¼ˆæ™®é€šå­—ç¬¦ä¸²ï¼‰ embstrï¼ˆçŸ­å­—ç¬¦ä¸²ä¼˜åŒ–ï¼‰ intï¼ˆæ•´æ•°ä¼˜åŒ–ï¼‰ hashï¼ˆziplist / hashtableï¼‰ listpackã€skiplistï¼ˆZSetï¼‰ å³ï¼šRedis æ˜¯é«˜åº¦å·¥ç¨‹åŒ–çš„æ•°æ®ç»“æ„åº“ã€‚\n5. Redis çš„äº”å¤§åŸºç¡€æ•°æ®ç»“æ„ Stringï¼ˆå­—ç¬¦ä¸² / æ•°å€¼ / ç¼“å­˜ï¼‰ Hashï¼ˆå¯¹è±¡ï¼‰ Listï¼ˆé˜Ÿåˆ—ï¼‰ Setï¼ˆå»é‡é›†åˆï¼‰ Sorted Setï¼ˆæ’è¡Œæ¦œã€æœ‰åºé›†åˆï¼‰ æ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„åº•å±‚ç»“æ„å’Œé€‚ç”¨åœºæ™¯ã€‚\n6. é«˜çº§æ•°æ®ç»“æ„ Bitmapï¼ˆä½å›¾ï¼šç­¾åˆ°ã€æ´»è·ƒç”¨æˆ·ï¼‰ HyperLogLogï¼ˆUV ç»Ÿè®¡ï¼šå›ºå®š 12KBï¼‰ GEOï¼ˆåœ°ç†ä½ç½®ï¼šåº•å±‚ ZSetï¼‰ Streamï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼šæŒä¹…åŒ– MQï¼‰ 7. Redis æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB / AOFï¼‰ RDBï¼ˆå¿«ç…§ï¼‰ å‘¨æœŸæ€§æŠŠå†…å­˜ä¿å­˜ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ æ¢å¤å¿« ä¼šä¸¢å¤±æœ€è¿‘ä¸€æ¬¡å¿«ç…§ä¹‹åçš„æ•°æ® AOFï¼ˆAppend-Only Fileï¼‰ å†™å‘½ä»¤è¿½åŠ æ—¥å¿— ä¸¢æ•°æ®å°‘ æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼ˆæ”¯æŒé‡å†™ï¼‰ ç”Ÿäº§ä¸€èˆ¬ï¼šRDB + AOF æ··åˆæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰\n8. Redis å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆéå¸¸é‡è¦ï¼‰ å½“å†…å­˜æ»¡äº†ï¼ŒRedis è¦æ¸…ç† keyã€‚\nå¸¸è§ç­–ç•¥ï¼š\nvolatile-lru allkeys-lruï¼ˆåšç¼“å­˜å¸¸ç”¨ï¼‰ volatile-ttl noevictionï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼‰ 9. Redis çº¿ç¨‹æ¨¡å‹ æ ¸å¿ƒå‘½ä»¤æ‰§è¡Œï¼šä¸€æ¡ä¸»çº¿ç¨‹ I/Oï¼šå¤šçº¿ç¨‹ï¼ˆå¤„ç†è¯»å†™ï¼‰ æŒä¹…åŒ–ï¼šåå°çº¿ç¨‹ ä¼˜ç‚¹ï¼šæ— é”ç«äº‰ã€é«˜æ€§èƒ½ã€å®ç°ç®€å•\nç¼ºç‚¹ï¼šå‘½ä»¤é˜»å¡ä¼šå¡ä½æ•´ä¸ª Redisï¼ˆå¦‚ KEYSã€SMEMBERS å¤§ keyï¼‰\n10. Redis Pipelineï¼ˆç®¡é“ï¼‰ ä¸€æ¬¡å‘é€å¤šæ¡å‘½ä»¤ï¼Œå‡å°‘ç½‘ç»œ RTT\né€‚ç”¨äºï¼šæ‰¹é‡å†™ã€æ‰¹é‡è¯»\næ³¨æ„ï¼š\nPipeline ä¸æ˜¯åŸå­æ“ä½œ ä¸åŒäºäº‹åŠ¡ã€Lua 11. Redis äº‹åŠ¡ ä½¿ç”¨ï¼š\nMULTI ... EXEC ç‰¹ç‚¹ï¼š\nä¸æ”¯æŒå›æ»šï¼ˆé ACIDï¼‰ åªä¿è¯å‘½ä»¤æŒ‰é¡ºåºæ‰§è¡Œ ç”Ÿäº§ä¸å¸¸ç”¨ï¼Œé€šå¸¸æ”¹ç”¨ Lua + åŸå­ã€‚\n12. Lua è„šæœ¬ Redis ä¸­æœ€å¼ºå¤§çš„åŸå­æ“ä½œæ–¹å¼ï¼š\nä¼˜åŠ¿ï¼š\né€»è¾‘åœ¨æœåŠ¡å™¨ä¾§æ‰§è¡Œï¼ˆå‡å°‘ RTTï¼‰ æ‰€æœ‰å‘½ä»¤åŸå­æ€§æ‰§è¡Œ é€‚ç”¨ï¼š\nåˆ†å¸ƒå¼é”é‡Šæ”¾ é™æµï¼ˆæ»‘åŠ¨çª—å£ï¼‰ æ‰¹å¤„ç† 13. Redis Clusterï¼ˆåˆ†å¸ƒå¼é›†ç¾¤ï¼‰æ ¸å¿ƒæ¦‚å¿µ 16384 æ§½ä½ï¼ˆhash slotï¼‰ key æŒ‰æ§½åˆ†é…åˆ°ä¸åŒèŠ‚ç‚¹ è‡ªå¸¦ä¸»ä»å’Œè‡ªåŠ¨æ•…éšœè¿ç§» å®¢æˆ·ç«¯å¿…é¡»æ”¯æŒ cluster åè®®ï¼Œå¦åˆ™æ— æ³•è®¿é—®åˆ†ç‰‡æ•°æ®ã€‚\n14. å¤åˆ¶ï¼ˆä¸»ä»åŒæ­¥ï¼‰çš„æ ¸å¿ƒåŸç† ç¬¬ä¸€æ¬¡ï¼šå…¨é‡åŒæ­¥ï¼ˆRDB æ–‡ä»¶ + å¢é‡å‘½ä»¤ï¼‰ åç»­ï¼šå¢é‡åŒæ­¥ï¼ˆå‘½ä»¤æµï¼‰ æ–­ç‚¹æ¢å¤ï¼šoffset + runid ä»åº“åŸºæœ¬æ˜¯åªè¯»ï¼Œç”¨äºåˆ†æµè¯»è¯·æ±‚ã€‚\n15. å¸¸è§çš„ç¼“å­˜é—®é¢˜ï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ 15.1 ç¼“å­˜ç©¿é€ æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®å¯¼è‡´ä¸€ç›´æ‰“åˆ°æ•°æ®åº“\nè§£å†³ï¼šå¸ƒéš†è¿‡æ»¤å™¨ / ç©ºå€¼ç¼“å­˜\n15.2 ç¼“å­˜é›ªå´© å¤§é‡ key åŒæ—¶è¿‡æœŸ\nè§£å†³ï¼šéšæœº ttl / å¤šçº§ç¼“å­˜\n15.3 ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹ key è¿‡æœŸç¬é—´è¢«é«˜å¹¶å‘è¯·æ±‚å‡»æºƒ\nè§£å†³ï¼šäº’æ–¥é” / æ°¸ä¸è¿‡æœŸ + åå°å¼‚æ­¥æ›´æ–°\nâ­ æ€»ç»“ï¼šè®°ä½è¿™å¼ å›¾ï¼ˆRedis æ ¸å¿ƒæ¦‚å¿µä¸€å›¾æµï¼‰ Redis = å†…å­˜æ•°æ®åº“ + é«˜æ€§èƒ½æ•°æ®ç»“æ„åº“ + ç¼“å­˜ç³»ç»Ÿ + æŒä¹…åŒ–å¼•æ“ + åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— + åˆ†å¸ƒå¼åè°ƒç»„ä»¶\næ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š\nå•çº¿ç¨‹æé€Ÿæ¶æ„ é«˜æ•ˆæ•°æ®ç»“æ„ å¤šç§æŒä¹…åŒ– é«˜å¯ç”¨ï¼ˆä¸»ä» / Sentinel / Clusterï¼‰ é«˜æ€§èƒ½ï¼ˆç™¾ä¸‡ QPSï¼‰ ä¸°å¯Œæ¨¡å‹ï¼ˆé”ã€é™æµã€é˜Ÿåˆ—ï¼‰ ","description":" 1. Redis æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ª åŸºäºå†…å­˜ çš„ Key-Value æ•°æ®åº“ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œè¯»å†™æå¿«ï¼Œå¸¸ç”¨äºç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\nå»¶è¿Ÿï¼šå¾®ç§’çº§ QPSï¼š10wï½50w+ é‡‡ç”¨ I/O å¤šè·¯å¤ç”¨ + å•çº¿ç¨‹æ¨¡å‹ï¼ˆæ‰§è¡Œå‘½ä»¤ä»æ˜¯å•çº¿ç¨‹ï¼‰ 2. Redis ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰ Redis çš„é«˜æ€§èƒ½æ¥è‡ªå››ç‚¹ï¼š\nå®Œå…¨åŸºäºå†…å­˜æ“ä½œ å•çº¿ç¨‹é¿å…é”ç«äº‰ I/O å¤šè·¯å¤ç”¨ï¼ˆepollï¼‰å¤„ç†å¤§é‡è¿æ¥ é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆä¸æ˜¯â€œå­—ç¬¦ä¸²â€ï¼Œæ˜¯ SDSã€è‡ªç ”çš„å“ˆå¸Œè¡¨ç­‰ï¼‰ 3. Redis æ˜¯å•çº¿ç¨‹å—ï¼Ÿ å‘½ä»¤æ‰§è¡Œï¼šå•çº¿ç¨‹ ç½‘ç»œå¤„ç†ï¼ˆä» 6.0 å¼€å§‹ï¼‰ï¼šI/O å¤šçº¿ç¨‹ åå°ä»»åŠ¡ï¼ˆRDB/AOF é‡å†™ï¼‰ï¼šç‹¬ç«‹çº¿ç¨‹ æ ¸å¿ƒé€»è¾‘ä»æ˜¯å•çº¿ç¨‹ï¼Œè¿™æ‰ä¿è¯é«˜æ€§èƒ½ä¸ä¸€è‡´æ€§ã€‚\n"},{"id":34,"href":"/backend/python/requests/tutorial/","title":"Requests åŸºç¡€æ•™ç¨‹","parent":"Requests","content":"requests æ˜¯ Python ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹ HTTP åº“ï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚ã€‚å®ƒçš„è¯­æ³•ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå¸¸ç”¨äºä¸ Web æ¥å£è¿›è¡Œäº¤äº’ã€‚\nâœ… å®‰è£…æ–¹å¼ pip install requests âœ… åŸºæœ¬ç”¨æ³• 1. å‘é€ GET è¯·æ±‚ import requests response = requests.get(\u0026#39;https://example.com/get\u0026#39;) print(response.status_code) print(response.text) å¸¦å‚æ•°çš„è¯·æ±‚\nimport requests # URL: https://example.com/get?id=100 data = {\u0026#34;id\u0026#34;: 100} response = requests.get(\u0026#39;https://example.com/get\u0026#39;, payload=data) 2. å‘é€ POST è¯·æ±‚ data = {\u0026#39;username\u0026#39;: \u0026#39;admin\u0026#39;, \u0026#39;password\u0026#39;: \u0026#39;123456\u0026#39;} response = requests.post(\u0026#39;https://example.com/post\u0026#39;, data=data) print(response.json()) 3. å‘é€ JSON æ•°æ® json_data = {\u0026#39;key\u0026#39;: \u0026#39;value\u0026#39;} response = requests.post(\u0026#39;https://example.com/post\u0026#39;, json=json_data) print(response.json()) 4. æ·»åŠ è¯·æ±‚å¤´ headers = {\u0026#39;User-Agent\u0026#39;: \u0026#39;my-app/0.0.1\u0026#39;} response = requests.get(\u0026#39;https://example.com/headers\u0026#39;, headers=headers) print(response.text) âœ… å¸¸ç”¨å±æ€§ response.status_code # HTTP çŠ¶æ€ç  response.text # å“åº”ä½“æ–‡æœ¬ response.content # äºŒè¿›åˆ¶å†…å®¹ï¼ˆå¦‚å›¾ç‰‡ï¼‰ response.json() # JSON å“åº”ï¼ˆä¼šè‡ªåŠ¨è½¬ä¸ºå­—å…¸ï¼‰ response.headers # å“åº”å¤´ âœ… ä¸Šä¼ æ–‡ä»¶ files = {\u0026#39;file\u0026#39;: open(\u0026#39;test.txt\u0026#39;, \u0026#39;rb\u0026#39;)} response = requests.post(\u0026#39;https://example.com/post\u0026#39;, files=files) âœ… è¶…æ—¶è®¾ç½® response = requests.get(\u0026#39;https://example.com/delay/3\u0026#39;, timeout=2) # å¦‚æœè¯·æ±‚è¶…è¿‡ 2 ç§’æ²¡æœ‰å“åº”ï¼Œå°±ä¼šæŠ›å‡º Timeout å¼‚å¸¸ âœ… å¼‚å¸¸å¤„ç†ï¼ˆæ¨èä½¿ç”¨ï¼‰ try: response = requests.get(\u0026#39;https://example.com/status/404\u0026#39;) response.raise_for_status() # å¦‚æœä¸æ˜¯ 200 ä¼šæŠ›å¼‚å¸¸ except requests.exceptions.RequestException as e: print(f\u0026#34;è¯·æ±‚å¤±è´¥ï¼š{e}\u0026#34;) ä¸‹é¢ç»™ä½ æ•´ç†ä¸€ä»½ Python requests é«˜çº§åœºæ™¯å¤§å…¨ï¼ˆå¸¦å®Œæ•´å¯ç”¨ä»£ç ï¼‰ï¼Œæ¶µç›–ä½ æåˆ°çš„ï¼š\nå‘é€å¸¦ Token è¯·æ±‚ ä¸‹è½½æ–‡ä»¶ çˆ¬è™«æ¨¡æ‹Ÿç™»å½• æŠ“åŒ…è°ƒè¯• ä¼šè¯ä¿æŒ ä»£ç† é‡è¯•æœºåˆ¶ æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ Cookies æ“ä½œ ğŸ”¥ Python Requests Â· é«˜çº§åœºæ™¯å¤§å…¨ï¼ˆå¯ç›´æ¥ç”¨ï¼‰\nå‘é€å¸¦ Token çš„è¯·æ±‚ï¼ˆå¸¸è§äº JWT ç™»å½•ï¼‰ ï¼ˆ1ï¼‰Bearer Token import requests token = \u0026#34;your_jwt_token_here\u0026#34; headers = { \u0026#34;Authorization\u0026#34;: f\u0026#34;Bearer {token}\u0026#34; } response = requests.get(\u0026#34;https://api.example.com/user\u0026#34;, headers=headers) print(response.json()) ï¼ˆ2ï¼‰åœ¨ URL å‚æ•°åŠ  token requests.get(\u0026#34;https://api.example.com/data?token=xxxxx\u0026#34;) ä¸‹è½½æ–‡ä»¶ï¼ˆå¤§æ–‡ä»¶æµå¼ä¸‹è½½ï¼‰ import requests url = \u0026#34;https://example.com/file.zip\u0026#34; local_path = \u0026#34;file.zip\u0026#34; with requests.get(url, stream=True) as r: r.raise_for_status() with open(local_path, \u0026#34;wb\u0026#34;) as f: for chunk in r.iter_content(chunk_size=8192): f.write(chunk) print(\u0026#34;ä¸‹è½½å®Œæˆï¼\u0026#34;) çˆ¬è™«æ¨¡æ‹Ÿç™»å½•ï¼ˆSession + è¡¨å•æäº¤ï¼‰ å¾ˆå¤šç™»å½•ç½‘ç«™éœ€è¦å…ˆæ‹¿ cookies -\u0026gt; å†æäº¤è´¦å·å¯†ç ã€‚\nimport requests session = requests.Session() # ç¬¬ä¸€æ¬¡è®¿é—®ä»¥è·å– cookies session.get(\u0026#34;https://example.com/login\u0026#34;) # æäº¤ç™»å½•è¡¨å• payload = { \u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;123456\u0026#34; } response = session.post(\u0026#34;https://example.com/login\u0026#34;, data=payload) print(\u0026#34;ç™»å½•æˆåŠŸ\u0026#34; if \u0026#34;æ¬¢è¿\u0026#34; in response.text else \u0026#34;ç™»å½•å¤±è´¥\u0026#34;) ä¹‹åç”¨åŒä¸€ä¸ª session å°±ä¿æŒç™»å½•çŠ¶æ€ã€‚\næŠ“åŒ…è°ƒè¯•ï¼ˆè¾“å‡ºè¯·æ±‚/å“åº”ä¿¡æ¯ï¼‰ ï¼ˆ1ï¼‰è®°å½•å®Œæ•´è¯·æ±‚ import requests r = requests.get(\u0026#34;https://example.com/get\u0026#34;) print(\u0026#34;URL:\u0026#34;, r.request.url) print(\u0026#34;Headers:\u0026#34;, r.request.headers) print(\u0026#34;Body:\u0026#34;, r.request.body) ï¼ˆ2ï¼‰è®°å½•å“åº”ä¿¡æ¯ print(\u0026#34;Status:\u0026#34;, r.status_code) print(\u0026#34;Response Headers:\u0026#34;, r.headers) print(\u0026#34;Text:\u0026#34;, r.text) ä¼šè¯ä¿æŒï¼ˆè‡ªåŠ¨ä¿å­˜ Cookiesï¼‰ session = requests.Session() r1 = session.get(\u0026#34;https://example.com/page1\u0026#34;) # ä¿å­˜ cookies r2 = session.get(\u0026#34;https://example.com/page2\u0026#34;) # ç»§ç»­ä½¿ç”¨ cookies ä½¿ç”¨ä»£ç†ï¼ˆHTTP / HTTPSï¼‰ proxies = { \u0026#34;http\u0026#34;: \u0026#34;http://127.0.0.1:7890\u0026#34;, \u0026#34;https\u0026#34;: \u0026#34;http://127.0.0.1:7890\u0026#34;, } r = requests.get(\u0026#34;https://example.com/ip\u0026#34;, proxies=proxies) print(r.text) å¯ç”¨äºç¿»å¢™ã€æŠ“åŒ…å·¥å…·ï¼ˆFiddler/Charlesï¼‰ç­‰ã€‚\né‡è¯•æœºåˆ¶ï¼ˆé…åˆ urllib3 Retryï¼‰ import requests from requests.adapters import HTTPAdapter from urllib3.util.retry import Retry session = requests.Session() retry = Retry( total=5, backoff_factor=1, allowed_methods=[\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;] ) adapter = HTTPAdapter(max_retries=retry) session.mount(\u0026#34;http://\u0026#34;, adapter) session.mount(\u0026#34;https://\u0026#34;, adapter) response = session.get(\u0026#34;https://example.com/status/500\u0026#34;) print(response.status_code) ä¸Šä¼ æ–‡ä»¶ï¼ˆå•æ–‡ä»¶ã€å¤šæ–‡ä»¶ï¼‰ å•æ–‡ä»¶ä¸Šä¼ \nfiles = { \u0026#34;file\u0026#34;: open(\u0026#34;test.jpg\u0026#34;, \u0026#34;rb\u0026#34;) } response = requests.post(\u0026#34;https://example.com/post\u0026#34;, files=files) print(response.text) å¤šæ–‡ä»¶ä¸Šä¼ \nfiles = [ (\u0026#34;files\u0026#34;, (\u0026#34;a.txt\u0026#34;, open(\u0026#34;a.txt\u0026#34;, \u0026#34;rb\u0026#34;))), (\u0026#34;files\u0026#34;, (\u0026#34;b.txt\u0026#34;, open(\u0026#34;b.txt\u0026#34;, \u0026#34;rb\u0026#34;))) ] requests.post(\u0026#34;https://example.com/post\u0026#34;, files=files) å¤„ç† Cookiesï¼ˆæŸ¥çœ‹ / è®¾ç½®ï¼‰ æŸ¥çœ‹ cookies\nr = requests.get(\u0026#34;https://example.com\u0026#34;) print(r.cookies) è®¾ç½® cookies\ncookies = {\u0026#34;sessionid\u0026#34;: \u0026#34;abcdef123456\u0026#34;} requests.get(\u0026#34;https://example.com\u0026#34;, cookies=cookies) è‡ªå®šä¹‰è¶…æ—¶ï¼ˆè¿æ¥ + è¯»å–ï¼‰ requests.get(\u0026#34;https://example.com\u0026#34;, timeout=(2, 5)) # 2 ç§’æœªè¿æ¥ -\u0026gt; æŠ›å¼‚å¸¸ # 5 ç§’æœªè¯»åˆ°æ•°æ® -\u0026gt; æŠ›å¼‚å¸¸ å‘é€ JSON è¯·æ±‚ï¼ˆå¸¸ç”¨ APIï¼‰ payload = {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;} r = requests.post(\u0026#34;https://api.example.com/update\u0026#34;, json=payload) print(r.json()) å¿½ç•¥ SSL è¯ä¹¦ï¼ˆæµ‹è¯•ç¯å¢ƒå¸¸ç”¨ï¼‰ requests.get(\u0026#34;https://example.com\u0026#34;, verify=False) æ„é€ è‡ªå®šä¹‰è¯·æ±‚ï¼ˆPUT / DELETE / PATCHï¼‰ requests.put(\u0026#34;https://api.example.com/item/1\u0026#34;, json={\u0026#34;name\u0026#34;: \u0026#34;new\u0026#34;}) requests.delete(\u0026#34;https://api.example.com/item/1\u0026#34;) ä¸Šä¼  JSON + æ–‡ä»¶æ··åˆï¼ˆAPI å¸¸è§ï¼‰ files = { \u0026#34;file\u0026#34;: open(\u0026#34;avatar.png\u0026#34;, \u0026#34;rb\u0026#34;), } data = { \u0026#34;user\u0026#34;: \u0026#34;martin\u0026#34;, \u0026#34;desc\u0026#34;: \u0026#34;profile avatar\u0026#34; } requests.post(\u0026#34;https://example.com/upload\u0026#34;, data=data, files=files) Mock æ‰‹æœºæµè§ˆå™¨ UAï¼ˆçˆ¬è™«å¿…å¤‡ï¼‰ headers = { \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)\u0026#34; } requests.get(\u0026#34;https://example.com\u0026#34;, headers=headers) ","description":"requests æ˜¯ Python ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹ HTTP åº“ï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚ã€‚å®ƒçš„è¯­æ³•ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå¸¸ç”¨äºä¸ Web æ¥å£è¿›è¡Œäº¤äº’ã€‚\nâœ… å®‰è£…æ–¹å¼ pip install requests âœ… åŸºæœ¬ç”¨æ³• 1. å‘é€ GET è¯·æ±‚ import requests response = requests.get(\u0026#39;https://example.com/get\u0026#39;) print(response.status_code) print(response.text) å¸¦å‚æ•°çš„è¯·æ±‚\n"},{"id":35,"href":"/backend/python/sqlalchemy/tutorial/","title":"SQLAlchemy åŸºç¡€æ•™ç¨‹","parent":"SQLAlchemy","content":"ä¸‹é¢ç»™ä½ æ•´ç†ä¸€ä»½ çœŸæ­£é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ã€åŸºäº SQLAlchemy 2.0 è¯­æ³•çš„å®Œæ•´æ•™ç¨‹ï¼ˆå« ORM + Core + Async + ä¼šè¯ç®¡ç† + æŸ¥è¯¢æ¨¡å‹ï¼‰ï¼Œè¦†ç›–ä½ æ—¥å¸¸å¼€å‘ FastAPIã€PostgreSQLã€TimescaleDBã€RBAC çš„å…¨éƒ¨å¸¸ç”¨æ“ä½œã€‚\nå…¨éƒ¨ä»£ç å‡ä¸º SQLAlchemy 2.0 å®˜æ–¹æ¨èå†™æ³•ï¼ˆå¦‚ Session(engine)ã€select()ã€async with AsyncSession()ã€mappings() ç­‰ï¼‰ã€‚\nâœ… SQLAlchemy 2.0 å®Œæ•´æ•™ç¨‹ï¼ˆç”Ÿäº§çº§åˆ«ï¼‰ ç›®å½•\nğŸƒ å®‰è£… ğŸš€ åˆ›å»º Engine ğŸ§± å®šä¹‰ ORM æ¨¡å‹ ğŸ“€ åˆ›å»ºè¡¨ ğŸ§© Sessionï¼ˆåŒæ­¥ \u0026amp; å¼‚æ­¥ï¼‰ ğŸ” ORM æŸ¥è¯¢ï¼ˆselect / where / orderï¼‰ âœï¸ æ’å…¥ï¼ˆORM / åŸç”Ÿ SQLï¼‰ ğŸ›  æ›´æ–°ã€åˆ é™¤ ğŸ“Œ Result è§£æï¼ˆscalars/mappings/fetchallï¼‰ ğŸ”— JOIN æŸ¥è¯¢ ğŸ“‚ Core é£æ ¼çš„æ‰§è¡Œ âš¡ Async SQLAlchemy ç”¨æ³• ğŸ§ª äº‹åŠ¡ç®¡ç† ğŸ”’ æœ€ä½³å®è·µï¼ˆä½ çš„ç”Ÿäº§é¡¹ç›®åº”è¯¥è¿™æ ·å†™ï¼‰ 1. å®‰è£… pip install sqlalchemy psycopg2-binary asyncpg 2. åˆ›å»º Engineï¼ˆåŒæ­¥ \u0026amp; å¼‚æ­¥ï¼‰ åŒæ­¥ engine\nfrom sqlalchemy import create_engine engine = create_engine( \u0026#34;postgresql+psycopg2://user:pass@localhost/dbname\u0026#34;, future=True, ) å¼‚æ­¥ engineï¼ˆasyncpgï¼‰\nfrom sqlalchemy.ext.asyncio import create_async_engine async_engine = create_async_engine( \u0026#34;postgresql+asyncpg://user:pass@localhost/dbname\u0026#34;, future=True, ) 3. å®šä¹‰ ORM æ¨¡å‹ï¼ˆ2.0 å†™æ³•ï¼‰ from sqlalchemy.orm import DeclarativeBase from sqlalchemy import Column, Integer, String class Base(DeclarativeBase): pass class User(Base): __tablename__ = \u0026#34;users\u0026#34; id = Column(Integer, primary_key=True) username = Column(String(50), unique=True) role = Column(String(20)) 4. åˆ›å»ºè¡¨ Base.metadata.create_all(engine) 5. Sessionï¼ˆæ¨è 2.0 styleï¼‰ åŒæ­¥\nfrom sqlalchemy.orm import Session with Session(engine) as session: ... å¼‚æ­¥\nfrom sqlalchemy.ext.asyncio import AsyncSession async with AsyncSession(async_engine) as session: ... 6. ORM æŸ¥è¯¢ï¼ˆselect + whereï¼‰ from sqlalchemy import select stmt = select(User).where(User.role == \u0026#34;admin\u0026#34;) with Session(engine) as session: result = session.execute(stmt) users = result.scalars().all() 7. æ’å…¥ ORM æ’å…¥ï¼ˆæ¨èï¼‰\nuser = User(username=\u0026#34;martin\u0026#34;, role=\u0026#34;admin\u0026#34;) with Session(engine) as s: s.add(user) s.commit() åŸç”Ÿ SQL æ’å…¥\nfrom sqlalchemy import text with engine.connect() as conn: conn.execute(text(\u0026#34;INSERT INTO users (username) VALUES (:u)\u0026#34;), {\u0026#34;u\u0026#34;: \u0026#34;martin\u0026#34;}) conn.commit() 8. æ›´æ–° \u0026amp; åˆ é™¤ æ›´æ–°ï¼ˆORMï¼‰\nstmt = ( update(User) .where(User.id == 1) .values(role=\u0026#34;superadmin\u0026#34;) ) with Session(engine) as s: s.execute(stmt) s.commit() åˆ é™¤ï¼ˆORMï¼‰\nstmt = delete(User).where(User.id == 1) with Session(engine) as s: s.execute(stmt) s.commit() 9. Result è§£æï¼ˆSQLAlchemy 2.0 æœ€é‡è¦éƒ¨åˆ†ï¼‰ è¿”å› ORM å¯¹è±¡\nresult.scalars().all() å­—å…¸æ ¼å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰\nresult.mappings().all() å…ƒç»„æ ¼å¼\nresult.fetchall() 10. JOIN æŸ¥è¯¢ stmt = ( select(User.username, Role.name) .select_from(User) .join(Role, User.role_id == Role.id) ) 11. ä½¿ç”¨ Core æ‰§è¡Œ SQLï¼ˆè¿æ¥é©±åŠ¨ï¼‰ with engine.connect() as conn: result = conn.execute(text(\u0026#34;SELECT * FROM users WHERE id=:id\u0026#34;), {\u0026#34;id\u0026#34;: 1}) rows = result.mappings().all() 12. Async SQLAlchemy å¿«é€Ÿç¤ºä¾‹ async def get_users(): async with AsyncSession(async_engine) as session: result = await session.execute(select(User)) return result.scalars().all() 13. äº‹åŠ¡ç®¡ç†ï¼ˆè‡ªåŠ¨æäº¤/å›æ»šï¼‰ with Session(engine) as session, session.begin(): session.execute(...) 14. SQLAlchemy ç”Ÿäº§æœ€ä½³å®è·µï¼ˆâ­ å¼ºçƒˆå»ºè®®ä½ é‡‡ç”¨ï¼‰ engine æ˜¯å•ä¾‹ å°è£… SessionLocal å°è£… CRUD ç»Ÿä¸€ç»“æœæ ¼å¼ é¿å…è¿æ¥æ³„æ¼ ","description":"ä¸‹é¢ç»™ä½ æ•´ç†ä¸€ä»½ çœŸæ­£é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ã€åŸºäº SQLAlchemy 2.0 è¯­æ³•çš„å®Œæ•´æ•™ç¨‹ï¼ˆå« ORM + Core + Async + ä¼šè¯ç®¡ç† + æŸ¥è¯¢æ¨¡å‹ï¼‰ï¼Œè¦†ç›–ä½ æ—¥å¸¸å¼€å‘ FastAPIã€PostgreSQLã€TimescaleDBã€RBAC çš„å…¨éƒ¨å¸¸ç”¨æ“ä½œã€‚\nå…¨éƒ¨ä»£ç å‡ä¸º SQLAlchemy 2.0 å®˜æ–¹æ¨èå†™æ³•ï¼ˆå¦‚ Session(engine)ã€select()ã€async with AsyncSession()ã€mappings() ç­‰ï¼‰ã€‚\nâœ… SQLAlchemy 2.0 å®Œæ•´æ•™ç¨‹ï¼ˆç”Ÿäº§çº§åˆ«ï¼‰ ç›®å½•\nğŸƒ å®‰è£… ğŸš€ åˆ›å»º Engine ğŸ§± å®šä¹‰ ORM æ¨¡å‹ ğŸ“€ åˆ›å»ºè¡¨ ğŸ§© Sessionï¼ˆåŒæ­¥ \u0026amp; å¼‚æ­¥ï¼‰ ğŸ” ORM æŸ¥è¯¢ï¼ˆselect / where / orderï¼‰ âœï¸ æ’å…¥ï¼ˆORM / åŸç”Ÿ SQLï¼‰ ğŸ›  æ›´æ–°ã€åˆ é™¤ ğŸ“Œ Result è§£æï¼ˆscalars/mappings/fetchallï¼‰ ğŸ”— JOIN æŸ¥è¯¢ ğŸ“‚ Core é£æ ¼çš„æ‰§è¡Œ âš¡ Async SQLAlchemy ç”¨æ³• ğŸ§ª äº‹åŠ¡ç®¡ç† ğŸ”’ æœ€ä½³å®è·µï¼ˆä½ çš„ç”Ÿäº§é¡¹ç›®åº”è¯¥è¿™æ ·å†™ï¼‰ 1. å®‰è£… pip install sqlalchemy psycopg2-binary asyncpg 2. åˆ›å»º Engineï¼ˆåŒæ­¥ \u0026amp; å¼‚æ­¥ï¼‰ åŒæ­¥ engine\n"},{"id":36,"href":"/operations/zabbix/faq/","title":"Zabbix FAQ","parent":"Zabbix","content":"å†…å®¹ï¼šåŸºç¡€ã€æ ¸å¿ƒåŸç†ã€å®æˆ˜åœºæ™¯ã€æ•…éšœæ’æŸ¥ã€æ¶æ„è®¾è®¡ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µé¢˜ 1. Zabbix çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ Zabbix Serverï¼šæ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£æ•°æ®æ”¶é›†ã€è§¦å‘å™¨è¯„ä¼°ã€äº‹ä»¶å¤„ç†ã€‚ Zabbix Agent/Agent2ï¼šé‡‡é›†ç³»ç»Ÿå’Œåº”ç”¨æ•°æ®ã€‚ Zabbix Proxyï¼šåˆ†å¸ƒå¼é‡‡é›†ï¼Œç¼“å†²ã€è½¬å‘æ•°æ®ã€‚ Databaseï¼šå­˜å‚¨ç›‘æ§æ•°æ®ï¼ˆå†å²ã€è¶‹åŠ¿ã€äº‹ä»¶ï¼‰ã€‚ Frontendï¼šWeb UIã€‚ 2. Zabbix Agent å’Œ Agent2 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ é¡¹ç›® Agent Agent2ï¼ˆæ¨èï¼‰ å®ç°è¯­è¨€ C Go æ€§èƒ½ ä¸­ æ›´å¥½ æ’ä»¶ ä¸æ”¯æŒ æ”¯æŒï¼ˆMySQLã€Redis ç­‰ï¼‰ æ‰©å±•æ€§ å·® å¼º JSONå¤„ç† å¼± å¼º æ€»ç»“ï¼šç”Ÿäº§ä¼˜å…ˆä½¿ç”¨ Agent2ã€‚\n3. ä»€ä¹ˆæ˜¯ Itemã€Triggerã€Actionï¼Ÿ Itemï¼šç›‘æ§é¡¹ï¼ˆCPU Load / Free Memï¼‰ Triggerï¼šæ¡ä»¶åˆ¤æ–­ï¼ˆå½“ CPU load \u0026gt; 5ï¼‰ Actionï¼šè§¦å‘åŠ¨ä½œï¼ˆé‚®ä»¶/å¾®ä¿¡/é’‰é’‰å‘Šè­¦ï¼‰ å®ƒä»¬çš„å…³ç³»ï¼š\nItem æ”¶é›†æ•°æ® -\u0026gt; Trigger åˆ¤æ–­ -\u0026gt; Action å‘Šè­¦\n4. Zabbix ç›‘æ§æ¨¡å¼æœ‰å“ªäº›ï¼Ÿä¸»åŠ¨ä¸è¢«åŠ¨çš„åŒºåˆ«ï¼Ÿ è¢«åŠ¨æ¨¡å¼ï¼ˆè¢« Server è½®è¯¢ï¼‰ï¼š\nServer -\u0026gt; Agent è¯·æ±‚ ä¸é€‚ç”¨äºé˜²ç«å¢™å¤æ‚ç¯å¢ƒ ä¸»åŠ¨æ¨¡å¼ï¼ˆAgent ä¸»åŠ¨å‘é€æ•°æ®ï¼‰ï¼š\nAgent -\u0026gt; Server é€‚åˆäº‘ä¸»æœºã€å®¹å™¨ã€è·¨æœºæˆ¿ æœ€ä½³å®è·µï¼šä½¿ç”¨ä¸»åŠ¨æ¨¡å¼ + TLS\n5. LLDï¼ˆLow Level Discoveryï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ è‡ªåŠ¨å‘ç°æœºåˆ¶ï¼Œç”¨äºè‡ªåŠ¨ç›‘æ§ï¼š\nç£ç›˜ ç½‘å¡ Docker å®¹å™¨ æ•°æ®åº“è¡¨ K8S Pod äºŒã€æ ¸å¿ƒåŸç†é¢˜ 6. Zabbix ä¸ºä»€ä¹ˆå¼ºçƒˆä¾èµ–æ•°æ®åº“æ€§èƒ½ï¼Ÿ å› ä¸ºæ‰€æœ‰æ•°æ®éƒ½å†™å…¥ DBï¼ŒåŒ…æ‹¬ï¼š\nå†å²æŒ‡æ ‡ï¼ˆhistoryï¼‰ è¶‹åŠ¿æ•°æ®ï¼ˆtrendsï¼‰ äº‹ä»¶ï¼ˆeventsï¼‰ é€šçŸ¥è®°å½•ï¼ˆalertsï¼‰ ç»“è®ºï¼šæ•°æ®åº“æ€§èƒ½å†³å®š Zabbix æ€§èƒ½ã€‚\n7. Zabbix Server å¦‚ä½•å¤„ç†ç›‘æ§æ•°æ®ï¼Ÿå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ æµç¨‹ï¼š\nAgent -\u0026gt; Server poller -\u0026gt; Preprocessing -\u0026gt; DB -\u0026gt; Trigger -\u0026gt; Event -\u0026gt; Action\nServer ä½¿ç”¨ Poller çº¿ç¨‹å¹¶å‘é‡‡é›†ï¼Œç±»å‹åŒ…æ‹¬ï¼š\npoller http poller pinger discoverer unreachable poller 8. ä»€ä¹ˆæ˜¯ Zabbix Proxyï¼Ÿé€‚ç”¨åœºæ™¯ï¼Ÿ Proxy ä½œç”¨ï¼š\né‡‡é›†å¹¶ç¼“å­˜æ•°æ® å‡è½» Server å‹åŠ› ç½‘ç»œæ–­å¼€è‡ªåŠ¨ç¼“å­˜ï¼ˆä¿è¯æ•°æ®ä¸ä¸¢ï¼‰ æ”¯æŒåˆ†å¸ƒå¼ç›‘æ§ é€‚ç”¨ï¼š\nå¤šæœºæˆ¿ å¤šåœ°åŸŸ è®¾å¤‡æ•°é‡ \u0026gt; 500 å†…ç½‘éš”ç¦»åœºæ™¯ 9. Zabbix å†å²æ•°æ®å’Œè¶‹åŠ¿æ•°æ®çš„åŒºåˆ«ï¼Ÿ ç±»å‹ ä¿å­˜çš„æ•°æ® ç”¨é€” history åŸå§‹ç›‘æ§æ•°æ® ç²¾ç»†åˆ†æï¼ˆç§’çº§ï¼‰ trends 1h çš„ min/max/avg é•¿æœŸè§†å›¾ï¼ˆå¤©/æœˆ/å¹´ï¼‰ å¤§é‡æ•°æ®æ—¶å¿…é¡»ä¾èµ– trendsï¼Œå¦åˆ™æ•°æ®åº“ä¼šç‚¸ã€‚\n10. Zabbix å¦‚ä½•é¿å…è§¦å‘å™¨é¢‘ç¹æŠ–åŠ¨ï¼Ÿ æ–¹æ³•ï¼š\nä½¿ç”¨è¶‹åŠ¿å€¼ï¼ˆavg(5m)ï¼‰ è§¦å‘å™¨åŠ  hysteresisï¼ˆè¿Ÿæ»ï¼‰ ç›‘æ§å‘¨æœŸä¸è¦å¤ªçŸ­ï¼ˆ\u0026gt;30sï¼‰ ä½¿ç”¨ preprocessing è¿‡æ»¤å™ªå£° ä¸‰ã€å®æˆ˜è¿ç»´é¢˜ 11. å¦‚ä½•ç›‘æ§ Nginx/MySQL/Redisï¼Ÿ æ–¹æ³•ï¼š\nä½¿ç”¨ Zabbix Agent2 æ’ä»¶ï¼ˆæœ€æ¨èï¼‰ SNMPï¼ˆè®¾å¤‡å‹ï¼‰ ç”¨æˆ·å‚æ•° UserParameter å¤–éƒ¨è„šæœ¬ï¼ˆä¸æ¨èï¼‰ HTTP agentï¼ˆHTTP APIï¼‰ 12. ç›‘æ§ Linux ç³»ç»Ÿå¸¸ç”¨çš„ Item key æœ‰å“ªäº›ï¼Ÿ system.cpu.load[] vm.memory.size[] vfs.fs.size[] net.if.in[] proc.num[] log[] agent.ping system.uptime 13. å¦‚ä½•ç›‘æ§æ—¥å¿—ï¼Ÿ ä½¿ç”¨ï¼š\nlog[] logrt[] (å¸¦æ—¥å¿—æ»šåŠ¨) å¯ä»¥ç»“åˆï¼š\næ­£åˆ™åŒ¹é… LLD å¤šæŒ‡æ ‡èšåˆ 14. è‡ªå®šä¹‰è„šæœ¬ç›‘æ§å¦‚ä½•åšï¼Ÿ ä½¿ç”¨ UserParameterï¼š\nzabbix_agent2.confï¼š\nUserParameter=redis.status[*],/usr/local/bin/redis_check.sh $1 è„šæœ¬è¾“å‡ºå¿…é¡»æ˜¯çº¯æ•°å€¼æˆ– JSONã€‚\n15. å¦‚ä½•å‡å°‘å‘Šè­¦å™ªéŸ³ï¼Ÿ ä½¿ç”¨é™é»˜æœŸï¼ˆMaintenanceï¼‰ å‘Šè­¦åˆ†çº§ è¿Ÿæ»ï¼ˆhysteresisï¼‰ ä½¿ç”¨å¢é‡å‘Šè­¦ï¼ˆPROBLEM -\u0026gt; OKï¼‰ Action ä¸­é™åˆ¶é‡å¤é€šçŸ¥ å››ã€æ€§èƒ½ä¼˜åŒ–é¢˜ï¼ˆå¸¸è€ƒï¼‰ 16. å¦‚ä½•ä¼˜åŒ– Zabbix çš„æ€§èƒ½ï¼Ÿ æ•°æ®åº“æœ€å…³é”®ï¼š\nPostgreSQL + SSD å¼€å¯ TimescaleDB è°ƒæ•´ DB å‚æ•°ï¼ˆshared_buffers ç­‰ï¼‰ Server è°ƒä¼˜ï¼š\nå¢åŠ  poller æ•°é‡ å¢åŠ  preprocessing worker Proxy åˆ†æ‹…å‹åŠ› Agent è°ƒä¼˜ï¼š\nä½¿ç”¨ Agent2 ä½¿ç”¨ä¸»åŠ¨æ¨¡å¼ 17. Housekeeper æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå»ºè®®å…³é—­è‡ªåŠ¨ï¼Ÿ Housekeeper æ˜¯æ¸…ç†å†å²æ•°æ®çš„ä»»åŠ¡ã€‚\nè‡ªåŠ¨æ¨¡å¼æ€§èƒ½å·®ï¼Œä¼šå¯¼è‡´ï¼š\næ•°æ®åº“å¡é¡¿ CPU é£™é«˜ ç›‘æ§å»¶è¿ŸåŠ å¤§ æœ€ä½³å®è·µï¼šå…³é—­è‡ªåŠ¨ï¼Œæ”¹ç”¨ TimescaleDB æˆ–æ‰‹åŠ¨æ¸…ç†ã€‚\n18. TimescaleDB æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé€‚åˆ Zabbixï¼Ÿ TimescaleDB æ˜¯åŸºäº PostgreSQL çš„æ—¶é—´åºåˆ—æ‰©å±•ï¼Œæä¾›ï¼š\nè‡ªåŠ¨åˆ†åŒºï¼ˆhypertableï¼‰ æ•°æ®å‹ç¼© å¿«é€ŸæŸ¥è¯¢ å¯¹ Zabbix æ¥è¯´ï¼š\næ•°æ®é‡å¤§ æ—¶é—´åºåˆ—ç»“æ„éå¸¸é€‚é… 19. å¦‚ä½•åˆ¤æ–­ Zabbix Server çš„ poller æ•°æ˜¯å¦å¤Ÿï¼Ÿ æŸ¥çœ‹ /var/log/zabbix/zabbix_server.logï¼š\nå¦‚æœå‡ºç°ï¼š\npoller processes more busy than 75% è¯´æ˜ poller æ•°é‡ä¸è¶³ï¼Œéœ€è¦è°ƒå¤§ï¼š\nStartPollers=50 StartHTTPPollers=10 StartDiscoverers=10 StartPingers=10 20. Zabbix Proxy çš„ DB é€‰ SQLite è¿˜æ˜¯ PostgreSQLï¼Ÿ \u0026lt;5000 ä¸»æœºï¼šSQLiteï¼ˆé»˜è®¤ï¼‰\n5000 ä¸»æœºï¼šPostgreSQL\nç†ç”±ï¼š\nSQLite åœ¨å¤§é‡æ•°æ®å†™å…¥ä¸‹æ€§èƒ½ä¸è¶³ SQLite ä¸æ”¯æŒ TimescaleDB äº”ã€æ•…éšœæ’æŸ¥é¢˜ 21. Agent æŠ¥é”™ â€œnot supportedâ€ æ€ä¹ˆæ’æŸ¥ï¼Ÿ å¯èƒ½åŸå› ï¼š\nkey å†™é”™ agent ä¸æ”¯æŒè¿™ä¸ª key æƒé™ä¸è¶³ æ²¡æœ‰æ‰“å¼€ UserParameter å‘½ä»¤è¾“å‡ºä¸æ˜¯æ•°å­— æ’æŸ¥å‘½ä»¤ï¼š\nzabbix_agent2 -t system.cpu.load 22. Web UI æŠ¥é”™ â€œIncorrect value for field Xâ€ æ€ä¹ˆåŠï¼Ÿ è¯´æ˜è¡¨å•æ ¼å¼ä¸æ­£ç¡®ï¼Œä¾‹å¦‚ï¼š\nè§¦å‘å™¨è¡¨è¾¾å¼é”™è¯¯ æ—¶é—´æ ¼å¼é”™è¯¯ key æ ¼å¼é”™è¯¯ æ£€æŸ¥ï¼š\næ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ ä½¿ç”¨ â€œCheck nowâ€ æµ‹è¯• item 23. æ— æ³•å‘é€å‘Šè­¦æ€ä¹ˆåŠï¼Ÿ æ’æŸ¥ï¼š\nMedia é…ç½®æ˜¯å¦æ­£ç¡® å¤–éƒ¨è„šæœ¬æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ æ˜¯å¦è¢« Action æ¡ä»¶è¿‡æ»¤ Server æ˜¯å¦èƒ½è®¿é—®å¤–éƒ¨ç½‘ç»œ æŸ¥çœ‹æ—¥å¿— /var/log/zabbix_server.log 24. Agent2 è¿æ¥ä¸ä¸Š Server æ€ä¹ˆå¤„ç†ï¼Ÿ æ£€æŸ¥ï¼š\ntelnet server 10051 æ£€æŸ¥ TLS é…ç½®æ˜¯å¦ä¸€è‡´ã€‚\n25. MySQL æ¨¡æ¿ç›‘æ§å¤±è´¥ï¼Ÿ æ’æŸ¥ï¼š\nç”¨æˆ·åå¯†ç  æƒé™ï¼ˆå»ºè®®åˆ›å»ºåªè¯» userï¼‰ MySQL socket è·¯å¾„ Agent2 æ˜¯å¦æ”¯æŒ MySQL æ’ä»¶ å…­ã€æ¶æ„ä¸è®¾è®¡é¢˜ 26. å¦‚ä½•è®¾è®¡ä¸€ä¸ª 1 ä¸‡å°ä¸»æœºçš„ Zabbix æ¶æ„ï¼Ÿ æ¨èï¼š\nFrontEnd x 2 (HA) PostgreSQL ä¸»ä» + TimescaleDB Zabbix Server x 2 (HA) Proxy Aï¼ˆæœºæˆ¿Aï¼‰ Proxy Bï¼ˆæœºæˆ¿Bï¼‰ Proxy Cï¼ˆäº‘ï¼‰ Agent2 ä¸»åŠ¨æ¨¡å¼ Grafana å±•ç¤º 27. å¦‚ä½•ä¿è¯ Zabbix å¯ç”¨æ€§ï¼Ÿ Server + Frontend + DB ä¸‰å±‚ HA Proxy ç¼“å†²æ•°æ® åˆ†åŒºè¡¨/TimescaleDB å®šæœŸå¤‡ä»½ DB ä½¿ç”¨ Pacemaker / Keepalived å®ç° Server HA Nginx + SSL ä¿æŠ¤å‰ç«¯ 28. Zabbix ç”Ÿäº§å®è·µä¸­æœ‰å“ªäº›å‘ï¼Ÿ å¸¸è§å‘ï¼š\nä¸ä½¿ç”¨ Proxy å¯¼è‡´ Server å¡æ­» ä½¿ç”¨ MySQL è€Œé PostgreSQL æ²¡æœ‰å¼€å¯ TimescaleDB ç”¨å¤–éƒ¨è„šæœ¬è¿‡å¤šå¯¼è‡´è¶…æ—¶ LLD è§„åˆ™æ•°é‡å¤ªå¤šï¼Œç”Ÿæˆä¸Šä¸‡ç›‘æ§é¡¹ å‘Šè­¦é…ç½®ä¸åˆ†çº§ï¼Œæ¶ˆæ¯çˆ†ç‚¸ Housekeeper è‡ªåŠ¨æ¸…ç†å¯¼è‡´æ•°æ®åº“æ‹¥å µ ","description":"å†…å®¹ï¼šåŸºç¡€ã€æ ¸å¿ƒåŸç†ã€å®æˆ˜åœºæ™¯ã€æ•…éšœæ’æŸ¥ã€æ¶æ„è®¾è®¡ã€‚\nä¸€ã€åŸºç¡€æ¦‚å¿µé¢˜ 1. Zabbix çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ Zabbix Serverï¼šæ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£æ•°æ®æ”¶é›†ã€è§¦å‘å™¨è¯„ä¼°ã€äº‹ä»¶å¤„ç†ã€‚ Zabbix Agent/Agent2ï¼šé‡‡é›†ç³»ç»Ÿå’Œåº”ç”¨æ•°æ®ã€‚ Zabbix Proxyï¼šåˆ†å¸ƒå¼é‡‡é›†ï¼Œç¼“å†²ã€è½¬å‘æ•°æ®ã€‚ Databaseï¼šå­˜å‚¨ç›‘æ§æ•°æ®ï¼ˆå†å²ã€è¶‹åŠ¿ã€äº‹ä»¶ï¼‰ã€‚ Frontendï¼šWeb UIã€‚ 2. Zabbix Agent å’Œ Agent2 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ é¡¹ç›® Agent Agent2ï¼ˆæ¨èï¼‰ å®ç°è¯­è¨€ C Go æ€§èƒ½ ä¸­ æ›´å¥½ æ’ä»¶ ä¸æ”¯æŒ æ”¯æŒï¼ˆMySQLã€Redis ç­‰ï¼‰ æ‰©å±•æ€§ å·® å¼º JSONå¤„ç† å¼± å¼º æ€»ç»“ï¼šç”Ÿäº§ä¼˜å…ˆä½¿ç”¨ Agent2ã€‚\n"},{"id":37,"href":"/operations/kvm/virtualization/","title":"è™šæ‹ŸåŒ–","parent":"KVM","content":"è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰ æ˜¯æŠŠä¸€å¥—ç‰©ç†èµ„æºï¼ˆCPU / å†…å­˜ / ç£ç›˜ / ç½‘ç»œï¼‰æŠ½è±¡æˆå¤šå¥—é€»è¾‘èµ„æºï¼Œè®©å¤šå¥—ç³»ç»Ÿæˆ–åº”ç”¨ç›¸äº’éš”ç¦»ã€åŒæ—¶è¿è¡Œçš„æŠ€æœ¯ã€‚\nä¸€ã€è™šæ‹ŸåŒ–çš„æœ¬è´¨ åœ¨ä¸å¢åŠ ç‰©ç†æœºå™¨çš„å‰æä¸‹ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ã€éš”ç¦»æ€§å’Œå¯ç®¡ç†æ€§\näºŒã€è™šæ‹ŸåŒ–çš„æ ¸å¿ƒç±»å‹ 1ï¸âƒ£ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆæœ€å¸¸è§ï¼‰ åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ª è™šæ‹Ÿæœºï¼ˆVMï¼‰\næ¶æ„\nç¡¬ä»¶ â””â”€â”€ Hypervisor â”œâ”€â”€ VM1 (OS + App) â”œâ”€â”€ VM2 (OS + App) â””â”€â”€ VM3 (OS + App) Hypervisor åˆ†ç±»\nç±»å‹ è¯´æ˜ ä»£è¡¨ Type 1ï¼ˆè£¸é‡‘å±ï¼‰ ç›´æ¥è·‘åœ¨ç¡¬ä»¶ä¸Š ESXi / Hyper-V / Xen Type 2ï¼ˆå®¿ä¸»æœºï¼‰ è·‘åœ¨å®¿ä¸» OS ä¸Š VirtualBox / VMware Workstation ç‰¹ç‚¹\nâœ… éš”ç¦»å¼º âŒ æœ‰ OS å¼€é”€ âŒ å¯åŠ¨æ…¢ï¼ˆç§’~åˆ†é’Ÿï¼‰ 2ï¸âƒ£ æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰ å¤šä¸ªåº”ç”¨å…±äº« åŒä¸€ä¸ªå†…æ ¸\næ¶æ„\nç¡¬ä»¶ â””â”€â”€ Host OS â””â”€â”€ Container Runtime â”œâ”€â”€ Container1 (App) â”œâ”€â”€ Container2 (App) â””â”€â”€ Container3 (App) ä»£è¡¨\nDocker Podman Kubernetesï¼ˆå®¹å™¨ç¼–æ’ï¼‰ ç‰¹ç‚¹\nâœ… å¯åŠ¨æå¿«ï¼ˆæ¯«ç§’çº§ï¼‰ âœ… èµ„æºåˆ©ç”¨ç‡é«˜ âŒ éš”ç¦»æ€§ \u0026lt; VM âŒ ä¾èµ–å†…æ ¸èƒ½åŠ› 3ï¸âƒ£ ç½‘ç»œè™šæ‹ŸåŒ– æŠŠç‰©ç†ç½‘ç»œæŠ½è±¡æˆé€»è¾‘ç½‘ç»œ\nVLAN VXLAN SDNï¼ˆOpenFlowï¼‰ Kubernetes CNIï¼ˆCalico / Flannelï¼‰ ğŸ‘‰ äº‘ã€K8S çš„åº•åº§\n4ï¸âƒ£ å­˜å‚¨è™šæ‹ŸåŒ– å¤šå—ç‰©ç†ç›˜ -\u0026gt; ç»Ÿä¸€é€»è¾‘å­˜å‚¨æ± \nLVM Ceph SAN / NAS äº‘ç›˜ï¼ˆEBS / Cinderï¼‰ 5ï¸âƒ£ æ¡Œé¢ / åº”ç”¨è™šæ‹ŸåŒ–ï¼ˆäº†è§£ï¼‰ VDI RemoteApp Citrix ä¸‰ã€CPU è™šæ‹ŸåŒ–ï¼ˆé‡ç‚¹åŸç†ï¼‰ æ²¡æœ‰ç¡¬ä»¶è¾…åŠ©ï¼ˆæ—©æœŸï¼‰\næŒ‡ä»¤é™·é˜± äºŒè¿›åˆ¶ç¿»è¯‘ æ€§èƒ½å·® ç°åœ¨ï¼ˆä¸»æµï¼‰\nIntel VT-x AMD-V ğŸ‘‰ CPU åŸç”Ÿæ”¯æŒè™šæ‹ŸåŒ–ï¼Œæ€§èƒ½æ¥è¿‘ç‰©ç†æœº\nå››ã€å†…å­˜è™šæ‹ŸåŒ–ï¼ˆå…³é”®éš¾ç‚¹ï¼‰ å¸¸è§æŠ€æœ¯\né¡µè¡¨æ˜ å°„ï¼ˆShadow Page Tableï¼‰ EPT / NPTï¼ˆäºŒçº§é¡µè¡¨ï¼‰ Ballooning HugePage é—®é¢˜\nå†…å­˜è¶…åˆ† NUMA å½±å“ OOM é£é™© äº”ã€I/O è™šæ‹ŸåŒ– ç±»å‹ è¯´æ˜ åŠè™šæ‹ŸåŒ– virtio å…¨è™šæ‹ŸåŒ– æ¨¡æ‹Ÿè®¾å¤‡ ç›´é€š PCI Passthrough SR-IOV ç½‘å¡è™šæ‹ŸåŠŸèƒ½ ğŸ‘‰ é«˜æ€§èƒ½åœºæ™¯ï¼ˆæ•°æ®åº“ã€ç½‘ç»œï¼‰\nå…­ã€è™šæ‹ŸåŒ– vs å®¹å™¨ ç»´åº¦ è™šæ‹Ÿæœº å®¹å™¨ å†…æ ¸ å„è‡ª OS å…±äº« å¯åŠ¨ æ…¢ å¿« éš”ç¦» å¼º ä¸­ å¯†åº¦ ä½ é«˜ å…¸å‹ ESXi Docker ç»“è®ºï¼š\nå¼ºéš”ç¦» -\u0026gt; VM å¾®æœåŠ¡ / DevOps -\u0026gt; å®¹å™¨ äº‘å¹³å° -\u0026gt; VM + å®¹å™¨æ··åˆ ä¸ƒã€è™šæ‹ŸåŒ–åœ¨äº‘è®¡ç®—ä¸­çš„ä½ç½® IaaS -\u0026gt; è™šæ‹Ÿæœº / ç½‘ç»œ / å­˜å‚¨ PaaS -\u0026gt; å®¹å™¨ / å¹³å° SaaS -\u0026gt; åº”ç”¨ ğŸ‘‰ è™šæ‹ŸåŒ–æ˜¯äº‘è®¡ç®—çš„åœ°åŸº\nå…«ã€è™šæ‹ŸåŒ–çš„å…¸å‹åº”ç”¨åœºæ™¯ æœåŠ¡å™¨æ•´åˆï¼ˆ1 å°é¡¶ 10 å°ï¼‰ äº‘å¹³å°ï¼ˆOpenStack / å…¬æœ‰äº‘ï¼‰ æµ‹è¯•ç¯å¢ƒ ç¾å¤‡ / å¿«ç…§ / è¿ç§» Kubernetes èŠ‚ç‚¹ ä¹ã€å¸¸è§è™šæ‹ŸåŒ–å¹³å° ä¼ä¸šçº§\nVMware vSphere Microsoft Hyper-V OpenStack Proxmox VE Linux / äº‘åŸç”Ÿ\nKVM + QEMU libvirt Docker / Podman Kubernetes åã€è¿ç»´å¿…ä¼šé—®é¢˜ CPU è¶…åˆ†æ¯”ä¾‹æ€ä¹ˆç®—ï¼Ÿ NUMA å¦‚ä½•ç»‘å®šï¼Ÿ VM å¡é¡¿æ€ä¹ˆæ’æŸ¥ï¼Ÿ å®¹å™¨é€ƒé€¸æ˜¯ä»€ä¹ˆï¼Ÿ SR-IOV å¦‚ä½•é…ç½®ï¼Ÿ è™šæ‹ŸåŒ– vs è£¸é‡‘å±æ•°æ®åº“ï¼Ÿ æ€»ç»“ è™šæ‹ŸåŒ– = èµ„æºæŠ½è±¡ + éš”ç¦» + è°ƒåº¦ï¼Œæ˜¯ç°ä»£äº‘ã€å®¹å™¨ã€åˆ†å¸ƒå¼ç³»ç»Ÿçš„èµ·ç‚¹\n","description":"è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰ æ˜¯æŠŠä¸€å¥—ç‰©ç†èµ„æºï¼ˆCPU / å†…å­˜ / ç£ç›˜ / ç½‘ç»œï¼‰æŠ½è±¡æˆå¤šå¥—é€»è¾‘èµ„æºï¼Œè®©å¤šå¥—ç³»ç»Ÿæˆ–åº”ç”¨ç›¸äº’éš”ç¦»ã€åŒæ—¶è¿è¡Œçš„æŠ€æœ¯ã€‚\nä¸€ã€è™šæ‹ŸåŒ–çš„æœ¬è´¨ åœ¨ä¸å¢åŠ ç‰©ç†æœºå™¨çš„å‰æä¸‹ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ã€éš”ç¦»æ€§å’Œå¯ç®¡ç†æ€§\näºŒã€è™šæ‹ŸåŒ–çš„æ ¸å¿ƒç±»å‹ 1ï¸âƒ£ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆæœ€å¸¸è§ï¼‰ åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ª è™šæ‹Ÿæœºï¼ˆVMï¼‰\næ¶æ„\nç¡¬ä»¶ â””â”€â”€ Hypervisor â”œâ”€â”€ VM1 (OS + App) â”œâ”€â”€ VM2 (OS + App) â””â”€â”€ VM3 (OS + App) Hypervisor åˆ†ç±»\n"},{"id":38,"href":"/operations/ansible/core/","title":"Ansible æ ¸å¿ƒæ¦‚å¿µ","parent":"Ansible","content":"å†…å®¹ï¼šæ˜¯ä»€ä¹ˆ -\u0026gt; ä¸ºä»€ä¹ˆ -\u0026gt; æ€ä¹ˆç”¨ -\u0026gt; æ˜“é”™ç‚¹\n1ï¸âƒ£ Ansible æ˜¯ä»€ä¹ˆï¼Ÿ Ansible æ˜¯ä¸€æ¬¾æ—  Agent çš„è‡ªåŠ¨åŒ–è¿ç»´ä¸é…ç½®ç®¡ç†å·¥å…·ï¼Œä¸»è¦ç”¨äºï¼š\næ‰¹é‡å‘½ä»¤æ‰§è¡Œ é…ç½®ç®¡ç† åº”ç”¨éƒ¨ç½² ç³»ç»Ÿåˆå§‹åŒ– æŒç»­äº¤ä»˜ï¼ˆCI/CDï¼‰ æ ¸å¿ƒç‰¹ç‚¹\nç‰¹æ€§ è¯´æ˜ æ—  Agent ç›®æ ‡ä¸»æœºæ— éœ€å®‰è£…å®¢æˆ·ç«¯ SSH é€šä¿¡ é»˜è®¤åŸºäº SSH YAML æè¿° Playbook ä½¿ç”¨ YAML å¹‚ç­‰æ€§ å¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ æ¨¡å—åŒ– ä¸€åˆ‡æ“ä½œéƒ½æ˜¯æ¨¡å— 2ï¸âƒ£ Ansible æ¶æ„åŸç†ï¼ˆå·¥ä½œæµç¨‹ï¼‰ æ§åˆ¶èŠ‚ç‚¹ (Control Node) â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ansible / ansible-playbook | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ SSH â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ è¢«æ§èŠ‚ç‚¹1 è¢«æ§èŠ‚ç‚¹2 æ‰§è¡Œæµç¨‹ï¼ˆéå¸¸é‡è¦ï¼‰\nè¯»å– Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰ è§£æ Playbook / Ad-Hoc é€‰æ‹©æ¨¡å—ï¼ˆmoduleï¼‰ é€šè¿‡ SSH æ¨é€æ¨¡å—åˆ°ç›®æ ‡ä¸»æœº æ¨¡å—åœ¨è¿œç«¯æ‰§è¡Œ è¿”å› JSON ç»“æœ æ§åˆ¶ç«¯è§£æå¹¶å±•ç¤º 3ï¸âƒ£ Control Node / Managed Node è§’è‰² è¯´æ˜ Control Node å®‰è£… Ansible çš„æœºå™¨ Managed Node è¢«ç®¡ç†çš„ç›®æ ‡ä¸»æœº âš ï¸ Managed Node ä¸éœ€è¦å®‰è£… Ansible\n4ï¸âƒ£ Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰ æ˜¯ä»€ä¹ˆï¼Ÿ\nInventory å®šä¹‰ Ansible è¦ç®¡ç†å“ªäº›ä¸»æœºã€å¦‚ä½•åˆ†ç»„ã€‚\næ”¯æŒæ ¼å¼\nINIï¼ˆä¼ ç»Ÿï¼‰ YAMLï¼ˆæ¨èï¼‰ åŠ¨æ€ Inventoryï¼ˆäº‘å‚å•† / APIï¼‰ æ ¸å¿ƒæ¦‚å¿µ\nHostï¼ˆä¸»æœºï¼‰ Groupï¼ˆä¸»æœºç»„ï¼‰ Group Vars / Host Vars all: children: web: hosts: web01: web02: 5ï¸âƒ£ Moduleï¼ˆæ¨¡å—ï¼‰â€”â€”Ansible çš„çµé­‚ æœ¬è´¨\næ¨¡å— = Ansible æ‰§è¡Œä»»åŠ¡çš„æœ€å°å•ä½\næ¯ä¸ªä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—è°ƒç”¨ æ¨¡å—è¿”å›æ ‡å‡† JSON å¸¸è§æ¨¡å—åˆ†ç±»\nç±»å‹ ç¤ºä¾‹ ç³»ç»Ÿ package, service, user æ–‡ä»¶ copy, template, file å‘½ä»¤ command, shell ç½‘ç»œ uri äº‘ ec2, azure_rm å®¹å™¨ docker_container âš ï¸ Playbook â‰  Shell è„šæœ¬\n6ï¸âƒ£ Ad-Hoc vs Playbook Ad-Hoc\nå•æ¡å‘½ä»¤ ä¸´æ—¶ä»»åŠ¡ ansible web -m ping Playbook\nå¤šä»»åŠ¡ å¯å¤ç”¨ã€å¯ç»´æŠ¤ - hosts: web tasks: - ping: 7ï¸âƒ£ Playbook æ ¸å¿ƒç»“æ„ - hosts: web become: true tasks: - name: install nginx package: name: nginx state: present æ ¸å¿ƒå­—æ®µ\nå­—æ®µ ä½œç”¨ hosts ç›®æ ‡ä¸»æœº tasks ä»»åŠ¡åˆ—è¡¨ become ææƒ vars å˜é‡ handlers äº‹ä»¶è§¦å‘ 8ï¸âƒ£ Taskï¼ˆä»»åŠ¡ï¼‰ ç‰¹ç‚¹\né¡ºåºæ‰§è¡Œ é»˜è®¤å¤±è´¥å³ä¸­æ–­ å¹‚ç­‰ - name: start nginx service: name: nginx state: started 9ï¸âƒ£ Idempotencyï¼ˆå¹‚ç­‰æ€§ï¼‰â€”â€”Ansible çš„æ ¸å¿ƒä»·å€¼ ä»€ä¹ˆæ˜¯å¹‚ç­‰ï¼Ÿ\nå¤šæ¬¡æ‰§è¡Œï¼Œç»“æœä¸€è‡´ï¼Œä¸äº§ç”Ÿå‰¯ä½œç”¨\nå¹‚ç­‰ vs éå¹‚ç­‰\næ“ä½œ æ˜¯å¦å¹‚ç­‰ å®‰è£…è½¯ä»¶ âœ… ç¡®ä¿æœåŠ¡è¿è¡Œ âœ… echo 1 \u0026raquo; file âŒ ğŸ”Ÿ Handlerï¼ˆå¤„ç†å™¨ï¼‰ æ˜¯ä»€ä¹ˆï¼Ÿ\nå½“ä»»åŠ¡çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰æ‰§è¡Œçš„ä»»åŠ¡\nhandlers: - name: restart nginx service: name: nginx state: restarted - template: src: nginx.conf.j2 dest: /etc/nginx/nginx.conf notify: restart nginx 1ï¸âƒ£1ï¸âƒ£ Variableï¼ˆå˜é‡ï¼‰ æ¥æºä¼˜å…ˆçº§ï¼ˆé«˜ -\u0026gt; ä½ï¼‰\nExtra varsï¼ˆ-eï¼‰ Play vars Host vars Group vars Role defaults nginx_port: 80 1ï¸âƒ£2ï¸âƒ£ Factsï¼ˆäº‹å®ï¼‰ æ˜¯ä»€ä¹ˆï¼Ÿ\nAnsible è‡ªåŠ¨é‡‡é›†çš„ä¸»æœºä¿¡æ¯\nansible all -m setup {{ ansible_hostname }} {{ ansible_os_family }} 1ï¸âƒ£3ï¸âƒ£ Templateï¼ˆJinja2 æ¨¡æ¿ï¼‰ server { listen {{ nginx_port }}; } æ¡ä»¶åˆ¤æ–­ å¾ªç¯ å˜é‡æ¸²æŸ“ 1ï¸âƒ£4ï¸âƒ£ Roleï¼ˆè§’è‰²ï¼‰â€”â€”ç”Ÿäº§å¿…å¤‡ ä½œç”¨\næ¨¡å—åŒ– å¯å¤ç”¨ å¯æµ‹è¯• æ˜“ç»´æŠ¤ roles/ nginx/ tasks/ handlers/ templates/ 1ï¸âƒ£5ï¸âƒ£ Tagï¼ˆæ ‡ç­¾ï¼‰ - name: install nginx package: name: nginx tags: install ansible-playbook site.yml --tags install 1ï¸âƒ£6ï¸âƒ£ Becomeï¼ˆæƒé™æå‡ï¼‰ become: true become_user: root 1ï¸âƒ£7ï¸âƒ£ Error Handlingï¼ˆé”™è¯¯å¤„ç†ï¼‰ ignore_errors: true failed_when: result.rc != 0 block: - ... rescue: - ... 1ï¸âƒ£8ï¸âƒ£ Check Mode / Diff Mode ansible-playbook site.yml --check --diff ä¸å®é™…ä¿®æ”¹ æ˜¾ç¤ºå·®å¼‚ 1ï¸âƒ£9ï¸âƒ£ Inventory + Playbook + Role å…³ç³» Inventory -\u0026gt; å®šä¹‰å¯¹è±¡ Playbook -\u0026gt; å®šä¹‰æµç¨‹ Role -\u0026gt; å®šä¹‰èƒ½åŠ› 2ï¸âƒ£0ï¸âƒ£ Ansible æœ€é‡è¦çš„è®¾è®¡å“²å­¦ æ—  Agent æ¨¡å—åŒ– å¹‚ç­‰æ€§ å£°æ˜å¼ Push æ¨¡å‹ YAML + Jinja2 ç»“æœå¯é¢„æœŸ ğŸ¯ å­¦ä¹ è·¯çº¿å»ºè®® æ ¸å¿ƒæ¦‚å¿µï¼ˆä½ ç°åœ¨è¿™ä¸€æ­¥ï¼‰âœ” æ¨¡å—ä½“ç³» Inventory è®¾è®¡ Role è§„èŒƒ Playbook ç¼–æ’ CI/CD é›†æˆ å¤§è§„æ¨¡ä¸»æœºæ²»ç† âœ… æ€»ç»“ Ansible æ˜¯ä¸€ä¸ªåŸºäº SSHã€æ—  Agentã€æ¨¡å—åŒ–ã€å£°æ˜å¼ã€å¹‚ç­‰çš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·\nInventory å®šä¹‰ç›®æ ‡ï¼ŒPlaybook å®šä¹‰æµç¨‹ï¼ŒRole å®šä¹‰èƒ½åŠ›\næ‰€æœ‰æ“ä½œéƒ½æ˜¯æ¨¡å—ï¼Œæ‰€æœ‰è®¾è®¡å›´ç»•å¹‚ç­‰æ€§å±•å¼€\n","description":"å†…å®¹ï¼šæ˜¯ä»€ä¹ˆ -\u0026gt; ä¸ºä»€ä¹ˆ -\u0026gt; æ€ä¹ˆç”¨ -\u0026gt; æ˜“é”™ç‚¹\n1ï¸âƒ£ Ansible æ˜¯ä»€ä¹ˆï¼Ÿ Ansible æ˜¯ä¸€æ¬¾æ—  Agent çš„è‡ªåŠ¨åŒ–è¿ç»´ä¸é…ç½®ç®¡ç†å·¥å…·ï¼Œä¸»è¦ç”¨äºï¼š\næ‰¹é‡å‘½ä»¤æ‰§è¡Œ é…ç½®ç®¡ç† åº”ç”¨éƒ¨ç½² ç³»ç»Ÿåˆå§‹åŒ– æŒç»­äº¤ä»˜ï¼ˆCI/CDï¼‰ æ ¸å¿ƒç‰¹ç‚¹\nç‰¹æ€§ è¯´æ˜ æ—  Agent ç›®æ ‡ä¸»æœºæ— éœ€å®‰è£…å®¢æˆ·ç«¯ SSH é€šä¿¡ é»˜è®¤åŸºäº SSH YAML æè¿° Playbook ä½¿ç”¨ YAML å¹‚ç­‰æ€§ å¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ æ¨¡å—åŒ– ä¸€åˆ‡æ“ä½œéƒ½æ˜¯æ¨¡å— 2ï¸âƒ£ Ansible æ¶æ„åŸç†ï¼ˆå·¥ä½œæµç¨‹ï¼‰ æ§åˆ¶èŠ‚ç‚¹ (Control Node) â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ansible / ansible-playbook | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ SSH â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ è¢«æ§èŠ‚ç‚¹1 è¢«æ§èŠ‚ç‚¹2 æ‰§è¡Œæµç¨‹ï¼ˆéå¸¸é‡è¦ï¼‰\n"},{"id":39,"href":"/backend/bash/core/","title":"Bash æ ¸å¿ƒæ¦‚å¿µ","parent":"Bash","content":"ä¸€å¥è¯ç†è§£ Bashï¼š\nBash æ˜¯ä¸€ä¸ª â€œå‘½ä»¤è§£æ + å±•å¼€ + è¿›ç¨‹è°ƒåº¦â€ çš„è¯­è¨€å‹å£³å±‚ï¼ˆShellï¼‰\nä¸€ã€Bash åœ¨ç³»ç»Ÿä¸­çš„çœŸå®ä½ç½®ï¼ˆè®¤çŸ¥åŸºçŸ³ï¼‰ ç”¨æˆ· â†“ Bashï¼ˆè§£æ / å±•å¼€ / è°ƒåº¦ï¼‰ â†“ Kernelï¼ˆfork / exec / IO / signalï¼‰ â†“ ç¨‹åº Bash ä¸æ‰§è¡Œå‘½ä»¤ Bash å†³å®šâ€œå¦‚ä½•æ‰§è¡Œâ€ Bash çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š å±•å¼€è§„åˆ™ ç»„åˆå‘½ä»¤ æ§åˆ¶è¿›ç¨‹ å†™ Bashï¼Œæœ¬è´¨æ˜¯åœ¨å†™ è¿›ç¨‹ç¼–æ’é€»è¾‘\näºŒã€å‘½ä»¤æ‰§è¡Œå®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆæœ€é‡è¦ï¼‰ 1. è¯»å–è¾“å…¥ 2. è¯æ³•åˆ†å‰²ï¼ˆtokenizeï¼‰ 3. å±•å¼€ï¼ˆExpansionï¼‰ 4. é‡å®šå‘ï¼ˆRedirectionï¼‰ 5. fork 6. exec âš ï¸ 90% Bash Bug å‡ºç°åœ¨ç¬¬ 3 æ­¥ï¼šå±•å¼€\nä¸‰ã€äº”å¤§å±•å¼€æœºåˆ¶ï¼ˆæŒ‰çœŸå®é¡ºåºï¼‰ Bash çš„å±•å¼€é¡ºåºæ˜¯ å›ºå®šä¸”ä¸å¯æ”¹å˜çš„\n1ï¸âƒ£ Brace Expansionï¼ˆèŠ±æ‹¬å·ï¼‰ {a,b,c} file{1..3}.log æœ€æ—©å‘ç”Ÿ ä¸çœ‹å˜é‡ã€ä¸çœ‹æ–‡ä»¶ 2ï¸âƒ£ Tilde Expansionï¼ˆ~ï¼‰ ~ ~user 3ï¸âƒ£ Parameter Expansionï¼ˆå˜é‡å±•å¼€ï¼‰ $VAR ${VAR} é«˜é¢‘é«˜çº§ç”¨æ³•ï¼ˆç”Ÿäº§å¿…ä¼šï¼‰\n${VAR:-default} # æœªå®šä¹‰ -\u0026gt; default ${VAR:=default} # æœªå®šä¹‰ -\u0026gt; èµ‹å€¼ ${VAR%/*} # dirname ${VAR##*/} # basename suspend=${SUSPEND:-n} å°±æ˜¯ æ ‡å‡†å‚æ•°å±•å¼€æœ€ä½³å®è·µ\n4ï¸âƒ£ Command Substitutionï¼ˆå‘½ä»¤æ›¿æ¢ï¼‰ $(command) âŒ æ—§å†™æ³•ï¼š\n`command` 5ï¸âƒ£ Filename Expansionï¼ˆGlobbingï¼‰ *.log âš ï¸ è¿™æ˜¯ Bash è¡Œä¸ºï¼Œä¸æ˜¯ ls è¡Œä¸º\nls *.log # Bash å…ˆå±•å¼€ -\u0026gt; ls æ¥æ”¶å‚æ•° å››ã€å¼•å·ç³»ç»Ÿï¼ˆBash çš„â€œå®‰å…¨å¸¦â€ï¼‰ 1ï¸âƒ£ åŒå¼•å· \u0026quot; \u0026quot; ä¿ç•™å˜é‡ ç¦æ­¢åˆ†è¯ ç¦æ­¢ glob \u0026#34;$var\u0026#34; 2ï¸âƒ£ å•å¼•å· \u0026rsquo; ' ç»å¯¹å­—é¢é‡ ä»€ä¹ˆéƒ½ä¸å±•å¼€ \u0026#39;$var\u0026#39; 3ï¸âƒ£ ä¸åŠ å¼•å·ï¼ˆé«˜å±ï¼‰ rm $file ç­‰ä»·äºï¼š\nrm file1 file2 file3 Bash å®‰å…¨ç¬¬ä¸€åŸåˆ™ï¼šå˜é‡æ°¸è¿œåŠ å¼•å·\näº”ã€å˜é‡çš„çœŸå®æœ¬è´¨ï¼ˆé‡è¦ï¼‰ Bash æ²¡æœ‰ç±»å‹ ä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸² â€œæ•´æ•°æ¯”è¾ƒâ€æ˜¯è¯­æ³•å±‚å°è£… a=10 b=2 [[ $a -gt $b ]] å…­ã€æ¡ä»¶åˆ¤æ–­æ¨¡å‹ï¼ˆåˆ¤æ–­çš„æ˜¯â€œé€€å‡ºç â€ï¼‰ 1ï¸âƒ£ [ ]ï¼ˆtest å‘½ä»¤ï¼‰ [ -f file ] æ˜¯å‘½ä»¤ é å‚æ•°åˆ†éš” å®¹æ˜“ç‚¸ 2ï¸âƒ£ [[ ]]ï¼ˆå¼ºçƒˆæ¨èï¼‰ [[ -f file ]] [[ $a == *.log ]] [[ $s =~ regex ]] ä¼˜ç‚¹ï¼š\næ­£åˆ™ æ—  glob è¯­æ³•å®‰å…¨ BASH_REMATCH å°±æ˜¯ [[ =~ ]] çš„é«˜çº§ç”¨æ³•\nä¸ƒã€æµç¨‹æ§åˆ¶ = é€€å‡ºç æ§åˆ¶ ifï¼ˆä¸æ˜¯ true / falseï¼‰ if command; then ... fi if åˆ¤æ–­çš„æ˜¯ $? == 0\nforï¼ˆä¸¤ç§æ¨¡å‹ï¼‰ for i in a b c; do done for ((i=0; i\u0026lt;10; i++)); do done âš ï¸ ä¸è¦ï¼š\nfor i in $(ls) whileï¼ˆæµå¼å¤„ç†ï¼‰ while read -r line; do done \u0026lt; file å…«ã€å‡½æ•°ï¼ˆShell é£æ ¼ï¼‰ func() { local var=1 echo \u0026#34;$var\u0026#34; } æ²¡æœ‰ return å€¼ è¿”å›é  stdout çŠ¶æ€é  exit code ä¹ã€è¿›ç¨‹æ¨¡å‹ï¼ˆéå¸¸å…³é”®ï¼‰ fork / exec æ¯ä¸ªå¤–éƒ¨å‘½ä»¤éƒ½æ˜¯æ–°è¿›ç¨‹ å†…å»ºå‘½ä»¤é™¤å¤–ï¼ˆcd / exportï¼‰ ä½œä¸šæ§åˆ¶ command \u0026amp; jobs fg bg åã€I/O é‡å®šå‘æ¨¡å‹ æ–‡ä»¶æè¿°ç¬¦\nFD å«ä¹‰ 0 stdin 1 stdout 2 stderr é«˜é¢‘å†™æ³•\ncommand \u0026gt; out.log 2\u0026gt;\u0026amp;1 command \u0026amp;\u0026gt;/dev/null åä¸€ã€ç®¡é“ï¼ˆ| çš„çœŸå®å«ä¹‰ï¼‰ a | b | c æ¯ä¸ª | éƒ½ä¼š fork é»˜è®¤åªè¿”å›æœ€åä¸€ä¸ªçŠ¶æ€ set -o pipefail åäºŒã€å˜é‡ä½œç”¨åŸŸ VAR=1 # shell å˜é‡ export VAR # ç¯å¢ƒå˜é‡ ç¯å¢ƒå˜é‡ -\u0026gt; å­è¿›ç¨‹ shell å˜é‡ -\u0026gt; å½“å‰ shell åä¸‰ã€ç”Ÿäº§è„šæœ¬ä¸‰ä»¶å¥— set -euo pipefail é€‰é¡¹ å«ä¹‰ -e é”™å³é€€ -u æœªå®šä¹‰å˜é‡æŠ¥é”™ pipefail ç®¡é“å¤±è´¥å³å¤±è´¥ åå››ã€è¿›é˜¶è·¯å¾„ï¼ˆå»ºè®®ï¼‰ æœ€å€¼å¾—å­¦çš„æ˜¯ï¼š\nBash è°ƒè¯•æ¨¡å‹\nset -x trap ERR PS4 ç”Ÿäº§çº§ Bash è§„èŒƒ\nä¸ç‚¸ å¯ç»´æŠ¤ å¯è¿ç§» Bash -\u0026gt; Go çš„æŠ½è±¡è¿ç§»\nå“ªäº›é€»è¾‘è¯¥ç•™åœ¨ Bash å“ªäº›å¿…é¡»ä¸Š Go ","description":"ä¸€å¥è¯ç†è§£ Bashï¼š\nBash æ˜¯ä¸€ä¸ª â€œå‘½ä»¤è§£æ + å±•å¼€ + è¿›ç¨‹è°ƒåº¦â€ çš„è¯­è¨€å‹å£³å±‚ï¼ˆShellï¼‰\nä¸€ã€Bash åœ¨ç³»ç»Ÿä¸­çš„çœŸå®ä½ç½®ï¼ˆè®¤çŸ¥åŸºçŸ³ï¼‰ ç”¨æˆ· â†“ Bashï¼ˆè§£æ / å±•å¼€ / è°ƒåº¦ï¼‰ â†“ Kernelï¼ˆfork / exec / IO / signalï¼‰ â†“ ç¨‹åº Bash ä¸æ‰§è¡Œå‘½ä»¤ Bash å†³å®šâ€œå¦‚ä½•æ‰§è¡Œâ€ Bash çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š å±•å¼€è§„åˆ™ ç»„åˆå‘½ä»¤ æ§åˆ¶è¿›ç¨‹ å†™ Bashï¼Œæœ¬è´¨æ˜¯åœ¨å†™ è¿›ç¨‹ç¼–æ’é€»è¾‘\näºŒã€å‘½ä»¤æ‰§è¡Œå®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆæœ€é‡è¦ï¼‰ 1. è¯»å–è¾“å…¥ 2. è¯æ³•åˆ†å‰²ï¼ˆtokenizeï¼‰ 3. å±•å¼€ï¼ˆExpansionï¼‰ 4. é‡å®šå‘ï¼ˆRedirectionï¼‰ 5. fork 6. exec âš ï¸ 90% Bash Bug å‡ºç°åœ¨ç¬¬ 3 æ­¥ï¼šå±•å¼€\n"},{"id":40,"href":"/operations/debezium/core/","title":"Debezium æ ¸å¿ƒæ¦‚å¿µ","parent":"Debezium","content":" ä¸€ã€ä»€ä¹ˆæ˜¯ Debeziumï¼ˆæœ¬è´¨ï¼‰ Debezium æ˜¯ä¸€ä¸ª CDCï¼ˆChange Data Captureï¼‰å¹³å°ï¼Œ é€šè¿‡è¯»å–æ•°æ®åº“çš„æ—¥å¿—ï¼ˆè€Œä¸æ˜¯æŸ¥è¯¢è¡¨ï¼‰ï¼ŒæŠŠæ•°æ®åº“çš„å˜æ›´è½¬åŒ–ä¸ºæœ‰åºã€å¯æ¢å¤çš„äº‹ä»¶æµã€‚\næ•°æ®åº“æ—¥å¿— -\u0026gt; ç»“æ„åŒ–äº‹ä»¶ -\u0026gt; æµç³»ç»Ÿ\näºŒã€CDCï¼ˆChange Data Captureï¼‰åŸºç¡€ç†è®º 1ï¸âƒ£ CDC çš„ä¸‰ç§å®ç°æ–¹å¼ æ–¹å¼ åŸç† é—®é¢˜ è½®è¯¢è¡¨ å®šæ—¶æŸ¥è¯¢ å»¶è¿Ÿé«˜ã€å‹åŠ›å¤§ Trigger è§¦å‘å™¨å†™ä¸­é—´è¡¨ å¼ºä¾µå…¥ã€éš¾ç»´æŠ¤ Log-basedï¼ˆDebeziumï¼‰ è§£æ binlog / WAL âœ… å®æ—¶ã€ä½ä¾µå…¥ Debezium å±äº Log-based CDCã€‚\n2ï¸âƒ£ ä¸ºä»€ä¹ˆæ—¥å¿— CDC æ˜¯æ­£ç¡®è§£ æ—¥å¿— å¤©ç„¶æœ‰åº ä¸å½±å“ä¸šåŠ¡ SQL ä¸ä¼šæ¼æ•°æ® å¯å›æ”¾ï¼ˆoffsetï¼‰ ä¸‰ã€Debezium çš„æ•´ä½“æ¶æ„ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Database â”‚ â”‚ binlog/WAL â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Debezium â”‚ â† Kafka Connect Source â”‚ Connector â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Kafka â”‚ â† Topicï¼ˆäº‹ä»¶æµï¼‰ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Consumers â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å…³é”®ç‚¹ï¼š\nDebezium ä¸æ˜¯ç‹¬ç«‹è¿è¡Œçš„ å®ƒè¿è¡Œåœ¨ Kafka Connect ä¹‹ä¸Š å››ã€Kafka Connect åŸºç¡€æ¦‚å¿µï¼ˆå¿…é¡»æ‡‚ï¼‰ 1ï¸âƒ£ Connector ä¸€ç§æ’ä»¶ Debezium = Source Connector 2ï¸âƒ£ Task Connector çš„æ‰§è¡Œå•å…ƒ ä¸€ä¸ª Connector -\u0026gt; å¤šä¸ª Task âš ï¸ MySQL / PostgreSQL Debezium å®é™…é€šå¸¸åªèƒ½ 1 ä¸ª Task ï¼ˆå› ä¸º binlog / WAL æ˜¯é¡ºåºçš„ï¼‰\n3ï¸âƒ£ Offset è®°å½•è¯»åˆ°æ•°æ®åº“æ—¥å¿—çš„å“ªä¸ªä½ç½® å­˜åœ¨ Kafka çš„å†…éƒ¨ Topic connect-offsets è¿™æ˜¯ Debezium èƒ½æ¢å¤ã€ä¸ä¸¢æ•°æ®çš„æ ¸å¿ƒ\näº”ã€Snapshotï¼ˆå¿«ç…§ï¼‰æœºåˆ¶ 1ï¸âƒ£ ä¸ºä»€ä¹ˆéœ€è¦ Snapshot CDC åªèƒ½æ•è·å˜åŒ– å¯åŠ¨æ—¶æ•°æ®åº“é‡Œå·²æœ‰çš„æ•°æ®æ€ä¹ˆåŠï¼Ÿ ğŸ‘‰ å…ˆå…¨é‡ -\u0026gt; å†å¢é‡\n2ï¸âƒ£ Snapshot çš„æœ¬è´¨ åœ¨æŸä¸ªä¸€è‡´æ€§ç‚¹ æ‰«æå·²æœ‰æ•°æ® æ¯ä¸€è¡Œä¹Ÿä¼šå‘æˆäº‹ä»¶ { \u0026#34;op\u0026#34;: \u0026#34;r\u0026#34; } r = read\n3ï¸âƒ£ Snapshot + Binlog/WAL çš„ä¸€è‡´æ€§ Debezium åœ¨ snapshot å‰ å…ˆè®°å½•æ—¥å¿—ä½ç½® snapshot å®Œå ä»è¯¥ä½ç½®ç»§ç»­æ¶ˆè´¹æ—¥å¿— â¡ï¸ ä¸ä¼šä¸¢ã€ä¸é‡å¤ï¼ˆè¯­ä¹‰çº§ï¼‰\nå…­ã€äº‹ä»¶æ¨¡å‹ï¼ˆEvent Modelï¼‰ 1ï¸âƒ£ ç»Ÿä¸€äº‹ä»¶ç»“æ„ { \u0026#34;before\u0026#34;: {...}, \u0026#34;after\u0026#34;: {...}, \u0026#34;source\u0026#34;: {...}, \u0026#34;op\u0026#34;: \u0026#34;c|u|d|r\u0026#34;, \u0026#34;ts_ms\u0026#34;: 1730000000000 } 2ï¸âƒ£ before / after çš„æ„ä¹‰ æ“ä½œ before after insert null æ–°æ•°æ® update æ—§æ•°æ® æ–°æ•°æ® delete æ—§æ•°æ® null 3ï¸âƒ£ Tombstone äº‹ä»¶ delete å Debezium å¯å‘é€ tombstone ç”¨äº Kafka compaction key: {id: 1} value: null ä¸ƒã€Exactly-once vs At-least-once Debezium çš„è¯­ä¹‰\nAt-least-onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰ å¯èƒ½ï¼š\nå› ä¸ºé‡å¯ å› ä¸º rebalance ğŸ‘‰ ä¸‹æ¸¸å¿…é¡»å…·å¤‡å¹‚ç­‰æ€§\nå¦‚ä½•å®ç°â€œé€»è¾‘ä¸Šçš„ exactly-onceâ€\nä½¿ç”¨ ä¸»é”®ä½œä¸º Kafka key ä¸‹æ¸¸ upsert æˆ– Flink state å…«ã€Schema \u0026amp; Schema Evolution 1ï¸âƒ£ è¡¨ç»“æ„å˜åŒ–ï¼ˆDDLï¼‰ æ–°å¢å­—æ®µ ä¿®æ”¹å­—æ®µç±»å‹ åˆ é™¤å­—æ®µ Debeziumï¼š\næ•è· DDL æ›´æ–°äº‹ä»¶ schema 2ï¸âƒ£ Schema Registryï¼ˆæ¨èï¼‰ Avro / Protobuf é¿å… JSON æ—  schema æ¼‚ç§» ä¹ã€æ•°æ®åº“çº§å…³é”®æ¦‚å¿µ MySQL\nåŸºäº binlog binlog_format = ROW Server ID å”¯ä¸€ PostgreSQL\nåŸºäº WAL logical decoding å¿…é¡»ï¼š wal_level = logical ä½¿ç”¨ Replication Slot è¡¨å¿…é¡»æœ‰ Primary Key åã€Replication Slotï¼ˆPG æ ¸å¿ƒï¼‰ Slot çš„ä½œç”¨\nå‘Šè¯‰ PGï¼š â€œè¿™ä¸ªæ¶ˆè´¹è€…è¿˜æ²¡è¯»å®Œï¼Œæ—¥å¿—åˆ«åˆ â€ é£é™©\nDebezium æŒ‚äº† Slot æ²¡æ¶ˆè´¹ WAL æ— é™å¢é•¿ ğŸ‘‰ å¿…é¡»ç›‘æ§ slot\nåä¸€ã€é¡ºåºæ€§ä¸ä¸€è‡´æ€§ å•è¡¨å†…é¡ºåºä¿è¯ äº‹åŠ¡å†…é¡ºåºä¿è¯ è·¨è¡¨é¡ºåº âŒ ä¸ä¿è¯ åäºŒã€Debezium ä¸è§£å†³ä»€ä¹ˆ âŒ ä¸šåŠ¡è¯­ä¹‰ä¸€è‡´æ€§ âŒ åˆ†å¸ƒå¼äº‹åŠ¡ âŒ exactly-once end-to-end âŒ è‡ªåŠ¨å†²çªè§£å†³ åä¸‰ã€å…¸å‹è®¾è®¡åŸåˆ™ æ•°æ®åº“æ˜¯ äº‹å®æºï¼ˆSource of Truthï¼‰ Kafka æ˜¯ äº‹ä»¶æ€»çº¿ Debezium æ˜¯ äº‹å®å‘å¸ƒè€… ä¸‹æ¸¸æ˜¯ äº‹ä»¶æ¶ˆè´¹è€… åå››ã€å…¶å®ƒï¼ˆFastAPI / PostgreSQLï¼‰ å…¸å‹ç©æ³•ï¼š\nPostgreSQL -\u0026gt; Debezium -\u0026gt; Kafka FastAPI æ¶ˆè´¹ Kafka ç”¨äºï¼š æƒé™å˜æ›´å®æ—¶åŒæ­¥ ç”¨æˆ·çŠ¶æ€ç¼“å­˜åˆ·æ–° æœç´¢ç´¢å¼•æ›´æ–° åäº”ã€æ€»ç»“ Debezium æ˜¯åŸºäºæ•°æ®åº“æ—¥å¿—çš„ CDC å¹³å° Snapshot + Log ä¿è¯å…¨é‡ + å¢é‡ä¸€è‡´ At-least-onceï¼Œéœ€è¦ä¸‹æ¸¸å¹‚ç­‰ PG ä½¿ç”¨ logical replication + slot ","description":" ä¸€ã€ä»€ä¹ˆæ˜¯ Debeziumï¼ˆæœ¬è´¨ï¼‰ Debezium æ˜¯ä¸€ä¸ª CDCï¼ˆChange Data Captureï¼‰å¹³å°ï¼Œ é€šè¿‡è¯»å–æ•°æ®åº“çš„æ—¥å¿—ï¼ˆè€Œä¸æ˜¯æŸ¥è¯¢è¡¨ï¼‰ï¼ŒæŠŠæ•°æ®åº“çš„å˜æ›´è½¬åŒ–ä¸ºæœ‰åºã€å¯æ¢å¤çš„äº‹ä»¶æµã€‚\næ•°æ®åº“æ—¥å¿— -\u0026gt; ç»“æ„åŒ–äº‹ä»¶ -\u0026gt; æµç³»ç»Ÿ\näºŒã€CDCï¼ˆChange Data Captureï¼‰åŸºç¡€ç†è®º 1ï¸âƒ£ CDC çš„ä¸‰ç§å®ç°æ–¹å¼ æ–¹å¼ åŸç† é—®é¢˜ è½®è¯¢è¡¨ å®šæ—¶æŸ¥è¯¢ å»¶è¿Ÿé«˜ã€å‹åŠ›å¤§ Trigger è§¦å‘å™¨å†™ä¸­é—´è¡¨ å¼ºä¾µå…¥ã€éš¾ç»´æŠ¤ Log-basedï¼ˆDebeziumï¼‰ è§£æ binlog / WAL âœ… å®æ—¶ã€ä½ä¾µå…¥ Debezium å±äº Log-based CDCã€‚\n"},{"id":41,"href":"/operations/docker/tutorial/","title":"Docker åŸºç¡€æ•™ç¨‹","parent":"Docker","content":"ğŸ³ Docker æ ¸å¿ƒæ¦‚å¿µ\nç†è§£ Docker çš„ä¸–ç•Œï¼Œå¿…é¡»ä» 4 å¤§æ ¸å¿ƒå¯¹è±¡ + 2 å¤§è¿è¡Œæœºåˆ¶ + 1 å¥—ç”Ÿæ€ä½“ç³» å…¥æ‰‹ã€‚\n1. å››å¤§æ ¸å¿ƒå¯¹è±¡ï¼ˆ100% å¿…é¡»æŒæ¡ï¼‰ 1.1 Imageï¼ˆé•œåƒï¼‰â€”â€” åº”ç”¨çš„æ¨¡æ¿ é•œåƒæ˜¯ åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«ï¼š æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰ è½¯ä»¶ä¾èµ– é…ç½®ã€ç¯å¢ƒ å…¥å£å‘½ä»¤ ç±»ä¼¼è™šæ‹Ÿæœºçš„â€œå¿«ç…§â€ï¼Œä½†è½»é‡å¾—å¤šã€‚ âœ… å®ƒä¸å¯å˜ï¼ˆimmutableï¼‰ã€‚\nğŸ“Œ é•œåƒ = åˆ†å±‚ï¼ˆlayersï¼‰+ å…ƒæ•°æ®ï¼ˆconfigï¼‰\n1.2 Containerï¼ˆå®¹å™¨ï¼‰â€”â€” é•œåƒçš„è¿è¡Œå®ä¾‹ å®¹å™¨ = é•œåƒï¼ˆåªè¯»å±‚ï¼‰ + å¯å†™å±‚ï¼ˆå®¹å™¨å±‚ï¼‰\nç›¸å½“äºç”±é•œåƒå¯åŠ¨çš„â€œè¿›ç¨‹å®ä¾‹â€ï¼Œä¸æ˜¯è™šæ‹Ÿæœºã€‚ å¯åˆ ã€å¯é‡å»ºã€å¯æ›¿æ¢ã€‚ å°½é‡ï¼šæ— çŠ¶æ€ã€å¯ä¸¢å¼ƒã€éšèµ·éšç­ âœ… ä¸€ä¸ªé•œåƒå¯ä»¥è¿è¡Œå‡ºå¤šä¸ªå®¹å™¨ã€‚\n1.3 Registryï¼ˆé•œåƒä»“åº“ï¼‰â€”â€” é•œåƒçš„ä»“åº“ å¸¸è§ï¼š\nDocker Hub Harborï¼ˆä¼ä¸šçº§ï¼‰ GitHub Container Registry é˜¿é‡Œäº‘ / è…¾è®¯äº‘ ä½  pushã€pull çš„å¯¹è±¡éƒ½æ˜¯ é•œåƒ (Image)ã€‚\n1.4 Dockerfile â€”â€” é•œåƒçš„æ„å»ºæ–‡ä»¶ ç®€åŒ–ç†è§£ï¼š\nDockerfile = æè¿°â€œå¦‚ä½•åˆ¶é€ é•œåƒâ€çš„è„šæœ¬ å…³é”®æŒ‡ä»¤ï¼š\nFROM RUN COPY / ADD ENV EXPOSE CMD / ENTRYPOINT WORKDIR ğŸ”‘ é•œåƒæ˜¯ç”± Dockerfile ä¸€æ­¥æ­¥æ„å»ºå‡ºæ¥çš„ï¼Œæ¯ä¸€æ­¥å½¢æˆä¸€å±‚ï¼ˆLayerï¼‰ã€‚\n2. ä¸¤å¤§è¿è¡Œæœºåˆ¶ï¼ˆç†è§£å Docker æ‰â€œé€šâ€ï¼‰ 2.1 OverlayFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿ / Layerï¼‰æœºåˆ¶ Docker é•œåƒç”±å¤šå±‚ç»„æˆï¼š\nä¾‹ï¼š\nubuntu:latest â”œâ”€ Layer A ï¼ˆåŸºç¡€ï¼‰ â”œâ”€ Layer B ï¼ˆapt-get...ï¼‰ â””â”€ Layer C ï¼ˆcopy...ï¼‰ å®¹å™¨åˆ›å»ºæ—¶ï¼Œå†å åŠ ä¸€ä¸ªå¯å†™å±‚ï¼š\ncontainer FS â”œâ”€ Container Writable Layer â””â”€ Image Layers (readonly) ğŸ“Œ ä¼˜ç‚¹ï¼š\nå¤šé•œåƒå¤ç”¨åŸºç¡€å±‚ï¼ˆæå¤§èŠ‚çœç©ºé—´ï¼‰ æ›´æ–°é•œåƒéå¸¸å¿« æ„å»ºã€æ‹‰å–ã€åˆ†å‘éƒ½æ›´é«˜æ•ˆ 2.2 Namespace + cgroupsï¼ˆLinux å®¹å™¨éš”ç¦»æŠ€æœ¯ï¼‰ å®¹å™¨ä¸æ˜¯è™šæ‹Ÿæœºï¼Œæœ¬è´¨æ˜¯ å—éš”ç¦»å’Œé™åˆ¶çš„ Linux è¿›ç¨‹ã€‚\nNamespace -\u0026gt; éš”ç¦»\néš”ç¦»ä»¥ä¸‹å†…å®¹ï¼š\nPID Network Mount User IPC UTS -\u0026gt; ä½¿å®¹å™¨æœ‰è‡ªå·±çš„è¿›ç¨‹æ ‘ã€ä¸»æœºåã€ç½‘ç»œæ ˆç­‰ã€‚\ncgroups -\u0026gt; èµ„æºæ§åˆ¶\né™åˆ¶å®¹å™¨ï¼š\nCPU å†…å­˜ IO PID æ•°é‡ ğŸ“Œ ç†è§£è¿™ä¸€ç‚¹ï¼Œä½ å°±çŸ¥é“å®¹å™¨ä¸ºä»€ä¹ˆâ€œè½»é‡â€ã€‚\n3. Docker ç”Ÿæ€æ ¸å¿ƒæ¦‚å¿µ 3.1 Docker Engine runcï¼ˆOCI å®¹å™¨ runtimeï¼‰ containerdï¼ˆç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼‰ dockerdï¼ˆDocker çš„ daemonï¼‰ è¿è¡Œ docker runï¼š\ndocker CLI -\u0026gt; dockerd -\u0026gt; containerd -\u0026gt; runc -\u0026gt; å¯åŠ¨å®¹å™¨ 3.2 Docker Networkï¼ˆå®¹å™¨ç½‘ç»œï¼‰ ç½‘ç»œé©±åŠ¨æ¨¡å¼ï¼š\næ¨¡å¼ è¯´æ˜ bridgeï¼ˆé»˜è®¤ï¼‰ å®¹å™¨äº’é€šï¼Œä½†ç‹¬ç«‹äºå®¿ä¸»æœº host å®¹å™¨å…±äº«å®¿ä¸»æœºç½‘ç»œ none æ— ç½‘ç»œ overlayï¼ˆSwarm / K8Sï¼‰ è·¨å®¿ä¸»æœºå®¹å™¨ç½‘ç»œ macvlan ç»™å®¹å™¨åˆ†é…ç‹¬ç«‹ MAC å’Œ IP ç®€åŒ–ç†è§£ï¼š\nbridge -\u0026gt; å®‰å…¨ host -\u0026gt; æ€§èƒ½é«˜ macvlan -\u0026gt; å®¹å™¨åƒç‰©ç†æœº 3.3 Volumeï¼ˆæ•°æ®å·ï¼‰ å®¹å™¨æ— çŠ¶æ€ï¼Œæ•°æ®å­˜å‚¨éœ€è¦â€œå·â€ã€‚\nVolume ç±»å‹ï¼š\nmanaged volumeï¼šç”± Docker ç®¡ç†ï¼ˆæ¨èï¼‰ bind mountï¼šæ˜ å°„å®¿ä¸»æœºç›®å½• tmpfsï¼ˆå†…å­˜ï¼‰ ä½œç”¨ï¼š\næŒä¹…åŒ–æ•°æ® åœ¨å®¹å™¨é—´å…±äº«æ•°æ® æ€§èƒ½é«˜äºå†™å…¥å®¹å™¨å±‚ 3.4 Docker Composeï¼ˆå¤šå®¹å™¨ç¼–æ’ï¼‰ ç”¨äºå¼€å‘ç¯å¢ƒçš„å¤šå®¹å™¨ç®¡ç†ï¼š\nå¯åŠ¨/åœæ­¢å¤šä¸ªæœåŠ¡ ç½‘ç»œè‡ªåŠ¨åŒ– Volume è‡ªåŠ¨åŒ– ç”Ÿäº§ä¸å»ºè®®ç”¨ Composeï¼ˆå»ºè®®ç”¨ k8sï¼‰ã€‚\n3.5 Docker Pluginï¼ˆCLI æ‰©å±• / Volume / Network æ’ä»¶ï¼‰ ä¾‹å¦‚ï¼š\ndocker volume plugin docker network plugin docker cli plugin ä½ æ­£åœ¨åšçš„â€œdocker jbuildâ€å°±æ˜¯ CLI æ’ä»¶ã€‚\n4. Docker ç”Ÿå‘½å‘¨æœŸ é•œåƒç”Ÿå‘½å‘¨æœŸï¼š\nbuild -\u0026gt; tag -\u0026gt; push -\u0026gt; pull -\u0026gt; run å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼š\ncreate -\u0026gt; start -\u0026gt; running -\u0026gt; stop -\u0026gt; remove å®¹å™¨å¯é‡å»ºï¼Œä½† volume è¦æŒä¹…åŒ–ã€‚\n5. å¸¸è§â€œæœ¬è´¨æ€§è¯¯è§£â€çº æ­£ é”™è¯¯ç†è§£ æ­£ç¡®ç†è§£ å®¹å™¨æ˜¯è™šæ‹Ÿæœº âŒ å®¹å™¨æ˜¯å—éš”ç¦»çš„è¿›ç¨‹ é•œåƒæ˜¯å•ä¸ªæ–‡ä»¶ âŒ é•œåƒæ˜¯å¤šå±‚æ–‡ä»¶ç³»ç»Ÿ ä½¿ç”¨ docker éœ€è¦å­¦å¾ˆå¤šå‘½ä»¤ âŒ åªè¦æŒæ¡ 12 æ¡å‘½ä»¤å°±å¤Ÿ Dockerfile è¶Šå¤æ‚è¶Šå¥½ âŒ è¶Šç®€å•è¶Šå¥½ï¼ˆå¯å¤ç”¨ï¼‰ å®¹å™¨åº”è¯¥ä¿å­˜æ•°æ® âŒ æ•°æ®å¿…é¡»æ”¾ Volume 6. æœ€å…³é”®çš„ä¸‰å¥è¯æ€»ç»“ å®¹å™¨ä¸æ˜¯è™šæ‹Ÿæœºï¼Œè€Œæ˜¯éš”ç¦»çš„è¿›ç¨‹ã€‚ é•œåƒä¸å¯å˜ï¼Œæœ‰å±‚ï¼ˆlayerï¼‰ç»“æ„ã€‚ ç”Ÿäº§ç¯å¢ƒéœ€è¦â€œæ— çŠ¶æ€å®¹å™¨ + æœ‰çŠ¶æ€å· + é•œåƒä»“åº“â€ã€‚ ","description":"ğŸ³ Docker æ ¸å¿ƒæ¦‚å¿µ\nç†è§£ Docker çš„ä¸–ç•Œï¼Œå¿…é¡»ä» 4 å¤§æ ¸å¿ƒå¯¹è±¡ + 2 å¤§è¿è¡Œæœºåˆ¶ + 1 å¥—ç”Ÿæ€ä½“ç³» å…¥æ‰‹ã€‚\n1. å››å¤§æ ¸å¿ƒå¯¹è±¡ï¼ˆ100% å¿…é¡»æŒæ¡ï¼‰ 1.1 Imageï¼ˆé•œåƒï¼‰â€”â€” åº”ç”¨çš„æ¨¡æ¿ é•œåƒæ˜¯ åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«ï¼š æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰ è½¯ä»¶ä¾èµ– é…ç½®ã€ç¯å¢ƒ å…¥å£å‘½ä»¤ ç±»ä¼¼è™šæ‹Ÿæœºçš„â€œå¿«ç…§â€ï¼Œä½†è½»é‡å¾—å¤šã€‚ âœ… å®ƒä¸å¯å˜ï¼ˆimmutableï¼‰ã€‚\nğŸ“Œ é•œåƒ = åˆ†å±‚ï¼ˆlayersï¼‰+ å…ƒæ•°æ®ï¼ˆconfigï¼‰\n"},{"id":42,"href":"/operations/docker/core/","title":"Docker æ ¸å¿ƒæ¦‚å¿µ","parent":"Docker","content":" ä¸€ã€Docker çš„æœ¬è´¨ Docker = åˆ©ç”¨ Linux å†…æ ¸èƒ½åŠ›ï¼ˆNamespace + cgroups + UnionFSï¼‰ï¼Œ æŠŠåº”ç”¨è¿›ç¨‹â€œéš”ç¦»ã€é™åˆ¶ã€æ‰“åŒ…ã€åˆ†å‘ã€è¿è¡Œâ€çš„ä¸€æ•´å¥—å·¥ç¨‹ä½“ç³»ã€‚\nâš ï¸ Docker ä¸æ˜¯è™šæ‹Ÿæœº\nâš ï¸ å®¹å™¨ä¸æ˜¯ OS\nâš ï¸ Docker æœ¬è´¨æ˜¯ è¿›ç¨‹ç®¡ç† + æ–‡ä»¶ç³»ç»ŸæŠ½è±¡\näºŒã€Docker è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼ˆWhyï¼‰ 1ï¸âƒ£ ç¯å¢ƒä¸€è‡´æ€§ å¼€å‘ / æµ‹è¯• / ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ â€œåœ¨æˆ‘æœºå™¨ä¸Šæ˜¯å¥½çš„â€ Docker ç”¨ é•œåƒ å›ºåŒ–ç¯å¢ƒã€‚\n2ï¸âƒ£ éƒ¨ç½²å¤æ‚åº¦ æ‰‹åŠ¨è£…ç¯å¢ƒ é…ç½®ä¸å¯è¿½æº¯ Docker ç”¨ Dockerfile -\u0026gt; Image -\u0026gt; Container æ ‡å‡†åŒ–æµç¨‹ã€‚\n3ï¸âƒ£ èµ„æºåˆ©ç”¨ç‡ è™šæ‹Ÿæœºæµªè´¹èµ„æº å¯åŠ¨æ…¢ Docker ç›´æ¥è·‘åœ¨å®¿ä¸»æœºå†…æ ¸ä¸Šï¼Œè¿›ç¨‹çº§è™šæ‹ŸåŒ–ã€‚\nä¸‰ã€Docker çš„ä¸‰å¤§åº•å±‚åŸºçŸ³ï¼ˆå¿…é¡»ä¼šï¼‰ 1ï¸âƒ£ Namespace â€”â€” éš”ç¦»ï¼ˆIsolationï¼‰ Namespace è§£å†³çš„æ˜¯ï¼šâ€œå®¹å™¨é‡Œçš„è¿›ç¨‹ï¼Œä¸ºä»€ä¹ˆä»¥ä¸ºè‡ªå·±æ˜¯ç‹¬å ç³»ç»Ÿï¼Ÿâ€\nLinux Namespace è®©ä¸€ä¸ªè¿›ç¨‹çœ‹åˆ°çš„æ˜¯â€œå‡çš„ä¸–ç•Œâ€ã€‚\nNamespace ä½œç”¨ PID è¿›ç¨‹å·éš”ç¦» NET ç½‘ç»œéš”ç¦» MNT æŒ‚è½½ç‚¹éš”ç¦» IPC è¿›ç¨‹é€šä¿¡éš”ç¦» UTS ä¸»æœºåéš”ç¦» USER ç”¨æˆ·éš”ç¦» ğŸ“Œ ç»“æœï¼š\nå®¹å™¨é‡Œ ps çœ‹ä¸åˆ°å®¿ä¸»æœºè¿›ç¨‹\nå®¹å™¨æœ‰è‡ªå·±çš„ IP\nå®¹å™¨æœ‰è‡ªå·±çš„ hostname\nğŸ‘‰ éš”ç¦» â‰  è™šæ‹ŸåŒ–\nğŸ‘‰ ä»ç„¶æ˜¯å®¿ä¸»æœºå†…æ ¸\n2ï¸âƒ£ cgroups â€”â€” èµ„æºé™åˆ¶ï¼ˆLimitationï¼‰ cgroups è§£å†³çš„æ˜¯ï¼šâ€œå®¹å™¨ä¸èƒ½æŠŠå®¿ä¸»æœºæ‹–æ­»â€\né™åˆ¶å†…å®¹ï¼š\nCPUï¼ˆé…é¢ / æƒé‡ï¼‰ å†…å­˜ï¼ˆæœ€å¤§å€¼ï¼‰ IO PID æ•°é‡ ä¾‹ï¼š\ndocker run --memory=512m --cpus=1 nginx ğŸ“Œ æ²¡æœ‰ cgroupsï¼Œå®¹å™¨åªæ˜¯â€œè£¸è¿›ç¨‹â€ã€‚\n3ï¸âƒ£ UnionFS / OverlayFS â€”â€” è”åˆæ–‡ä»¶ç³»ç»Ÿ / åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿï¼ˆLayerï¼‰ è§£å†³ï¼šâ€œé•œåƒå¦‚ä½•å¤ç”¨ï¼Ÿä¸ºä»€ä¹ˆé‚£ä¹ˆå°ï¼Ÿâ€\né•œåƒæ˜¯å¤šå±‚å åŠ çš„åªè¯»å±‚ï¼š\nLayer 1: ubuntu Layer 2: apt install python Layer 3: copy app å®¹å™¨å¯åŠ¨åï¼š\nRW Layer (container) RO Layers (image) ğŸ“Œ å†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰\nå››ã€Docker æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆWhatï¼‰ 1ï¸âƒ£ Imageï¼ˆé•œåƒï¼‰ å®šä¹‰ï¼š\nåªè¯» ä¸å¯å˜ åˆ†å±‚ ğŸ“Œ é•œåƒ = rootfs + metadata\n2ï¸âƒ£ Containerï¼ˆå®¹å™¨ï¼‰ å®šä¹‰ï¼š\né•œåƒçš„è¿è¡Œå®ä¾‹ æœ¬è´¨æ˜¯ä¸€ä¸ª Linux è¿›ç¨‹ æœ‰è‡ªå·±çš„ Namespace + cgroups + FS âš ï¸ å®¹å™¨åº”å½“æ˜¯ï¼š\nçŸ­ç”Ÿå‘½å‘¨æœŸ å¯éšæ—¶é”€æ¯ æ— çŠ¶æ€ 3ï¸âƒ£ Dockerfile ä½œç”¨ï¼š\næè¿°â€œå¦‚ä½•æ„å»ºé•œåƒâ€ æ¯æ¡æŒ‡ä»¤ -\u0026gt; ä¸€ä¸ªé•œåƒå±‚ ğŸ“Œ Dockerfile æ˜¯ å£°æ˜å¼æ„å»ºæè¿°ï¼Œä¸æ˜¯è„šæœ¬ã€‚\n4ï¸âƒ£ Registry ä½œç”¨ï¼š\né•œåƒçš„åˆ†å‘ç³»ç»Ÿ æ”¯æŒ tag / digest / manifest äº”ã€Docker æ¶æ„åŸç†ï¼ˆHowï¼‰ Docker è¿è¡Œæµç¨‹\ndocker run nginx â†“ Docker CLI â†“ dockerd â†“ containerd â†“ runc â†“ Linux Kernel ğŸ“Œ Docker ä¸æ˜¯ç›´æ¥å¯åŠ¨å®¹å™¨ã€‚\nç»„ä»¶èŒè´£ ç»„ä»¶ èŒè´£ docker CLI ç”¨æˆ·æ¥å£ dockerd å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç† containerd å®¹å™¨è¿è¡Œç®¡ç† runc çœŸæ­£è°ƒç”¨å†…æ ¸åˆ›å»ºå®¹å™¨ OCI æ ‡å‡† å…­ã€Docker ç½‘ç»œåŸºç¡€ç†è®º é»˜è®¤ bridge ç½‘ç»œ\ncontainer â†“ docker0 bridge â†“ iptables NAT â†“ å®¿ä¸»æœºç½‘å¡ ğŸ“Œ NAT è½¬å‘ ğŸ“Œ å®¹å™¨ IP ç§æœ‰ host ç½‘ç»œ\næ—  Namespace ä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œæ ˆ æ€§èƒ½æœ€å¥½ overlay ç½‘ç»œï¼ˆé›†ç¾¤ï¼‰\nVXLAN è·¨å®¿ä¸»æœºå®¹å™¨é€šä¿¡ ä¸ƒã€Docker å­˜å‚¨åŸºç¡€ç†è®º ä¸ºä»€ä¹ˆå®¹å™¨ä¸èƒ½å­˜æ•°æ®ï¼Ÿ\nå®¹å™¨å¯éšæ—¶é”€æ¯ å†™å…¥ overlayfs æ€§èƒ½å·® å®¹å™¨è¿ç§»å›°éš¾ Volume åŸç†\ncontainer â†“ volume mount â†“ host FS ğŸ“Œ volume ç»•è¿‡ overlayfs ğŸ“Œ é«˜æ€§èƒ½ã€æŒä¹…åŒ– å…«ã€Docker ä¸è™šæ‹Ÿæœºçš„æœ¬è´¨åŒºåˆ« ç»´åº¦ Docker VM å†…æ ¸ å…±äº« ç‹¬ç«‹ è™šæ‹Ÿå±‚çº§ è¿›ç¨‹çº§ ç¡¬ä»¶çº§ å¯åŠ¨ ç§’çº§ åˆ†é’Ÿ èµ„æº å°‘ å¤š å¯†åº¦ é«˜ ä½ ä¹ã€Docker çš„å·¥ç¨‹å“²å­¦ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ ä¸å¯å˜åŸºç¡€è®¾æ–½ ä¸ä¿®æ”¹å®¹å™¨ é€šè¿‡æ„å»ºæ–°é•œåƒå‘å¸ƒ 2ï¸âƒ£ ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªè¿›ç¨‹ ç®€åŒ–ç”Ÿå‘½å‘¨æœŸ æ˜“æ‰©ç¼©å®¹ 3ï¸âƒ£ æ— çŠ¶æ€è®¾è®¡ çŠ¶æ€å¤–ç½®ï¼ˆDB / volumeï¼‰ åã€æœ¬è´¨é—®é¢˜ Qï¼šDocker æ˜¯ä¸æ˜¯è™šæ‹ŸåŒ–ï¼Ÿ âŒ ä¸æ˜¯\nâœ… è¿›ç¨‹éš”ç¦»\nQï¼šDocker å®‰å…¨å—ï¼Ÿ âœ… å®‰å…¨ä¾èµ–ï¼š\nå†…æ ¸ç‰ˆæœ¬ seccomp / apparmor æ˜¯å¦ root é•œåƒæ¥æº Qï¼šDocker å’Œ Kubernetes çš„å…³ç³»ï¼Ÿ Dockerï¼šå•æœºå®¹å™¨æŠ€æœ¯ Kubernetesï¼šå®¹å™¨ç¼–æ’ç³»ç»Ÿ åä¸€ã€æ€»ç»“ Docker æ˜¯è¿›ç¨‹ï¼Œä¸æ˜¯è™šæ‹Ÿæœº\nå®¹å™¨éš”ç¦»æ¥è‡ªå†…æ ¸ï¼Œä¸æ˜¯ Hypervisor\né•œåƒæ˜¯ä¸å¯å˜çš„åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ\n","description":" ä¸€ã€Docker çš„æœ¬è´¨ Docker = åˆ©ç”¨ Linux å†…æ ¸èƒ½åŠ›ï¼ˆNamespace + cgroups + UnionFSï¼‰ï¼Œ æŠŠåº”ç”¨è¿›ç¨‹â€œéš”ç¦»ã€é™åˆ¶ã€æ‰“åŒ…ã€åˆ†å‘ã€è¿è¡Œâ€çš„ä¸€æ•´å¥—å·¥ç¨‹ä½“ç³»ã€‚\nâš ï¸ Docker ä¸æ˜¯è™šæ‹Ÿæœº\nâš ï¸ å®¹å™¨ä¸æ˜¯ OS\nâš ï¸ Docker æœ¬è´¨æ˜¯ è¿›ç¨‹ç®¡ç† + æ–‡ä»¶ç³»ç»ŸæŠ½è±¡\näºŒã€Docker è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼ˆWhyï¼‰ 1ï¸âƒ£ ç¯å¢ƒä¸€è‡´æ€§ å¼€å‘ / æµ‹è¯• / ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ â€œåœ¨æˆ‘æœºå™¨ä¸Šæ˜¯å¥½çš„â€ Docker ç”¨ é•œåƒ å›ºåŒ–ç¯å¢ƒã€‚\n"},{"id":43,"href":"/database/elasticsearch/eflk/","title":"EFLK æ—¥å¿—æ”¶é›†ç³»ç»Ÿ","parent":"ElasticSearch","content":" ğŸš€ ä»€ä¹ˆæ˜¯ EFLKï¼Ÿ EFLK = ElasticSearch + Filebeat + Logstash + Kibana\nå®ƒæ˜¯ç»å…¸ ELKï¼ˆElasticSearch + Logstash + Kibanaï¼‰çš„æ”¹è¿›ç‰ˆï¼Œ\nE è¡¨ç¤º ElasticSearchï¼ŒF è¡¨ç¤º Filebeatï¼ŒL è¡¨ç¤º Logstashï¼ŒK è¡¨ç¤º Kibanaã€‚\né€šå¸¸ EFLK ä¸ ELFKï¼ˆElasticSearch + Filebeat + Kafka + Logstash + Kibanaï¼‰éƒ½æ˜¯æ—¥å¿—ç³»ç»Ÿå¸¸ç”¨ç¼©å†™ã€‚\næ ¸å¿ƒæ€æƒ³ï¼š\nFilebeatï¼šè½»é‡çº§é«˜æ•ˆæ—¥å¿—é‡‡é›†å™¨ï¼ˆæ›¿ä»£ Logstash åœ¨è¾¹ç¼˜èŠ‚ç‚¹çš„ä½œç”¨ï¼‰ Logstashï¼šè´Ÿè´£æ•°æ®æ¸…æ´—ã€è§£æã€æ ‡å‡†åŒ– ElasticSearchï¼šå­˜å‚¨å’Œæœç´¢æ—¥å¿—æ•°æ® Kibanaï¼šå¯è§†åŒ–ã€æŸ¥è¯¢ã€å‘Šè­¦ ç›¸æ¯”æœ€åŸå§‹ ELKï¼š\næ€§èƒ½æ›´é«˜ï¼ˆFilebeat æ¯” Logstash è½»å‡ åå€ï¼‰ èµ„æºæ¶ˆè€—æ›´ä½ï¼ˆFilebeat å ç”¨å†…å­˜ CPU æå°ï¼‰ æ¶æ„æ›´æ¸…æ™°ï¼ˆé‡‡é›† - ä¼ è¾“ -\u0026gt; æ¸…æ´— -\u0026gt; å­˜å‚¨ï¼‰ ğŸ”¥ ä¸€å¼ å›¾çœ‹æ‡‚ EFLK ä½“ç³» +------------------+ | Filebeat | \u0026lt;- é‡‡é›†æ—¥å¿— | (è½»é‡çº§ Agent) | +------------------+ | v +------------------+ | Logstash | \u0026lt;- è§£æã€æ¸…æ´—ã€è½¬æ¢ç»“æ„åŒ– | filter + codec | +------------------+ | v +---------------------------+ | ElasticSearch | \u0026lt;- å­˜å‚¨ + æ£€ç´¢ + èšåˆ +---------------------------+ | v +---------------------------+ | Kibana | \u0026lt;- åˆ†æ + å¯è§†åŒ– + å‘Šè­¦ +---------------------------+ å¦‚æœä½ çš„ä¸šåŠ¡é‡æ›´å¤§ï¼Œå¯ä»¥æ‰©å±•ä¸ºï¼š\nFilebeat -\u0026gt; Kafka -\u0026gt; Logstash -\u0026gt; ElasticSearch -\u0026gt; Kibana\nğŸ“Œ EFLK å„ç»„ä»¶èŒè´£ 1. Filebeat â€” è½»é‡çº§æ—¥å¿—é‡‡é›†å™¨ åªè´Ÿè´£æ—¥å¿—æ”¶é›†ï¼Œé€Ÿåº¦å¿«ã€èµ„æºå°‘ æ”¯æŒå¤šç§æ¨¡å—ï¼šnginx, mysql, system, redis, docker èƒ½è‡ªåŠ¨æ£€æµ‹æ—¥å¿—æ»šåŠ¨ å¯ä»¥è¾“å‡ºåˆ° Logstashã€Kafkaã€Redisã€ES é€‚åˆéƒ¨ç½²åˆ°æ¯å°ä¸šåŠ¡æœåŠ¡å™¨ã€‚\n2. Logstash â€” æ•°æ®æ¸…æ´—ä¸è§£æ è§£æã€æ ¼å¼åŒ–æ—¥å¿—ï¼ˆgrokã€jsonã€mutateï¼‰ è½¬æ¢ç»“æ„åŒ–å†…å®¹ æ•°æ®è¿‡æ»¤è§„åˆ™é›†ä¸­ç®¡ç† æ¯” Filebeat åŠŸèƒ½æ›´å¼ºã€ä½†æ›´é‡ æ¨èï¼šå‰ç«¯ç”¨ Filebeatï¼Œé›†ä¸­ä½¿ç”¨ Logstash æ¸…æ´—\n3. ElasticSearch â€” æœç´¢/å­˜å‚¨å¼•æ“ åˆ†å¸ƒå¼å­˜å‚¨æ—¥å¿— å¯æ¨ªå‘æ‰©å®¹ é«˜æ€§èƒ½å…¨æ–‡æœç´¢ èšåˆåˆ†æï¼ˆç»Ÿè®¡/è¶‹åŠ¿/åˆ†å¸ƒï¼‰ æ—¥å¿—é€šå¸¸æŒ‰ï¼š\nindex lifecycleï¼ˆhot-warm-coldï¼‰ daily indexï¼ˆå¦‚ logs-2025.02.20ï¼‰ ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚\n4. Kibana â€” å¯è§†åŒ–ä¸è¿ç»´ç•Œé¢ ES çš„å¯è§†åŒ–é—¨æˆ· Dashboard ç›‘æ§ï¼ˆAPM / Metricsï¼‰ å‘Šè­¦ï¼ˆWatcher / Kibana Alertingï¼‰ ğŸ§± EFLK ç”Ÿäº§çº§æ¶æ„æœ€ä½³å®è·µ â­ æ¨èæ¶æ„ï¼ˆä¸­å¤§å‹é›†ç¾¤ï¼‰\nFilebeat (ä¸šåŠ¡æœºå™¨) | v Kafka ï¼ˆå¯é€‰ï¼Œæé«˜ç¼“å†²èƒ½åŠ›ï¼‰ | v Logstashï¼ˆ2-3 èŠ‚ç‚¹ï¼‰ | v ElasticSearch é›†ç¾¤ï¼ˆHot/Warmï¼‰ | v Kibana è‹¥æ—¥å¿—é‡ä¸å¤§ï¼ˆ\u0026lt;100GB/dayï¼‰ï¼Œå¯ä»¥ç›´æ¥ï¼š\nFilebeat -\u0026gt; Logstash -\u0026gt; ElasticSearch\nğŸ”§ å…³é”®é…ç½®ç¤ºä¾‹ 1. Filebeat -\u0026gt; Logstash filebeat.yml\nfilebeat.inputs: - type: log paths: - /var/log/nginx/*.log output.logstash: hosts: [\u0026#34;logstash01:5044\u0026#34;, \u0026#34;logstash02:5044\u0026#34;] 2. Logstash Pipelineï¼ˆè§£æ NGINXï¼‰ logstash.conf\ninput { beats { port =\u0026gt; 5044 } } filter { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;%{COMBINEDAPACHELOG}\u0026#34; } } date { match =\u0026gt; [ \u0026#34;timestamp\u0026#34;, \u0026#34;dd/MMM/YYYY:HH:mm:ss Z\u0026#34; ] } } output { elasticsearch { hosts =\u0026gt; [\u0026#34;http://es01:9200\u0026#34;] index =\u0026gt; \u0026#34;nginx-%{+YYYY.MM.dd}\u0026#34; } } 3. ElasticSearch ILMï¼ˆè‡ªåŠ¨å†·çƒ­è¿ç§»ï¼‰ PUT _ilm/policy/logs-ilm { \u0026#34;policy\u0026#34;: { \u0026#34;phases\u0026#34;: { \u0026#34;hot\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;rollover\u0026#34;: { \u0026#34;max_size\u0026#34;: \u0026#34;40GB\u0026#34; }} }, \u0026#34;warm\u0026#34;: { \u0026#34;min_age\u0026#34;: \u0026#34;7d\u0026#34;, \u0026#34;actions\u0026#34;: { \u0026#34;allocate\u0026#34;: { \u0026#34;number_of_replicas\u0026#34;: 0 }, \u0026#34;forcemerge\u0026#34;: { \u0026#34;max_num_segments\u0026#34;: 1 } } }, \u0026#34;delete\u0026#34;: { \u0026#34;min_age\u0026#34;: \u0026#34;30d\u0026#34;, \u0026#34;actions\u0026#34;: { \u0026#34;delete\u0026#34;: {} } } } } } ğŸ“¦ EFLK å¸¸è§ä½¿ç”¨åœºæ™¯ ğŸ”¹ ç³»ç»Ÿæ—¥å¿—ï¼ˆ/var/log/messages / syslogï¼‰ Filebeat è‡ªåŠ¨æ¨¡å—ã€‚\nğŸ”¹ Nginx / Apache æ—¥å¿— æ¨¡å—è§£æ + è‡ªå¸¦ Dashboardã€‚\nğŸ”¹ Docker / Kubernetes æ—¥å¿— Filebeat è‡ªåŠ¨é‡‡é›†å®¹å™¨ JSONã€‚\nğŸ”¹ åº”ç”¨ Trace / APM Elastic APM å¯ç›´æ¥æ¥å…¥ã€‚\nğŸ”¹ å®‰å…¨æ—¥å¿— / å®¡è®¡æ—¥å¿— é…åˆ Elastic SIEMã€‚\nâš ï¸ EFLK è¿ç»´æœ€ä½³å®è·µï¼ˆæ ¸å¿ƒæ€»ç»“ï¼‰ Filebeat ä½¿ç”¨ loadbalance è¾“å‡ºåˆ°å¤šä¸ª Logstash é˜²æ­¢ Logstash å•ç‚¹ã€‚\nLogstash ç”¨ pipeline workers æå‡æ€§èƒ½ pipeline.workers = CPUæ ¸å¿ƒæ•°\nElasticSearch åˆ†ç‰‡æ§åˆ¶ æ¯åˆ†ç‰‡æ§åˆ¶åœ¨ 20â€“50GB æœ€ä½³ã€‚\nILM ç®¡ç†å†·çƒ­æ•°æ® è‡ªåŠ¨æ»šåŠ¨ã€å‹ç¼©ã€åˆ é™¤ã€‚\nKibana åšå¯è§†åŒ– Dashboard + è­¦æŠ¥ å¦‚ï¼š\n500 é”™è¯¯ç‡è¶…è¿‡ 1% ç™»å½•å¤±è´¥æš´å¢ æœåŠ¡å“åº”æ—¶é—´è¿‡é«˜ EFLK ä¸­ Kafka çš„èŒè´£ åœ¨ Filebeat -\u0026gt; Kafka -\u0026gt; Logstash -\u0026gt; ElasticSearch -\u0026gt; Kibanaï¼ˆEFLK/EFKLï¼‰ è¿™æ¡æ—¥å¿—é“¾è·¯ä¸­ï¼ŒKafka çš„èŒè´£éå¸¸å…³é”®ï¼Œä½†åˆéå¸¸ä¸“ä¸€ï¼šè´Ÿè´£â€œæ—¥å¿—ç¼“å†²ã€å‰Šå³°ã€è§£è€¦ã€æŒä¹…åŒ–ã€é«˜å¯ç”¨â€ã€‚\n1. æ—¥å¿—ç¼“å†²ï¼ˆBufferï¼‰â€”â€”å¸æ”¶ Filebeat çš„çªå‘æµé‡ Filebeat å‘é€æ—¥å¿—æ—¶ï¼Œå¯èƒ½é‡åˆ°ï¼š\nçŸ­æ—¶é—´æ—¥å¿—é‡æš´å¢ï¼ˆæµé‡æ´ªå³°ï¼‰ Logstash é‡å¯æˆ–å¤„ç†èƒ½åŠ›ä¸è¶³ ElasticSearch é›†ç¾¤å‡ºç°å†™å…¥æ‹¥å¡ Kafka å¯ä»¥ä½œä¸ºâ€œè¶…å¤§å®¹é‡çš„è“„æ°´æ± â€å¸æ”¶æ‰€æœ‰æ—¥å¿—ï¼Œå³ä½¿ä¸‹æ¸¸æš‚æ—¶ä¸å¯ç”¨ï¼Œæ—¥å¿—ä¹Ÿä¸ä¼šä¸¢ã€‚\nğŸ‘‰ æ²¡æœ‰ Kafkaï¼Œæ—¥å¿—é«˜å³°æ—¶ Logstash/ES ä¼šè¢«å‹å®ã€‚\n2. ç”Ÿäº§è€…/æ¶ˆè´¹è€…è§£è€¦ï¼ˆDecoupleï¼‰ åœ¨æ²¡æœ‰ Kafka çš„ ELK ä¸­ï¼š\nFilebeat -\u0026gt; Logstashï¼šå¼ºä¾èµ– Logstash -\u0026gt; ESï¼šå¼ºä¾èµ– ä¸€æ—¦å…¶ä¸­ä¸€ä¸ªç»„ä»¶æŒ‚äº†ï¼Œé“¾è·¯å°±æ–­äº†ã€‚\nå¼•å…¥ Kafka åï¼š\nFilebeat -\u0026gt; Kafka ï¼ˆä¸å…³å¿ƒ Logstash æ˜¯å¦å­˜æ´»ï¼‰ Logstash -\u0026gt; Kafka ï¼ˆä¸å…³å¿ƒ Filebeat æ˜¯å¦å­˜æ´»ï¼‰ ç»„ä»¶é—´å®Œå…¨å¼‚æ­¥ï¼Œäº’ä¸å½±å“ã€‚\n3. æ—¥å¿—æŒä¹…åŒ–ï¼ˆDurabilityï¼‰â€”â€”æŒä¹…å¯é é˜Ÿåˆ— Kafka æ˜¯åˆ†å¸ƒå¼æ—¥å¿—å­˜å‚¨ç³»ç»Ÿï¼š\næ—¥å¿—å†™å…¥åå¤åˆ¶åˆ°å¤šä¸ªå‰¯æœ¬ å³ä½¿èŠ‚ç‚¹æŒ‚äº†ï¼Œæ•°æ®ä¾æ—§å­˜åœ¨ å³ä½¿ ES æˆ– Logstash æŒ‚äº†ä¸€å¤©ï¼Œæ—¥å¿—ä¹Ÿä¸ä¼šä¸¢ æ–‡ä»¶æ—¥å¿— -\u0026gt; Kafka -\u0026gt; ä¸‹æ¸¸ï¼ŒçœŸæ­£å®ç°â€œé›¶æ—¥å¿—ä¸¢å¤±â€ã€‚\n4. å‰Šå³°å¡«è°·ï¼ˆBackpressure Handlingï¼‰ Kafka å…è®¸ Logstash ä»¥è‡ªå·±çš„èŠ‚å¥æ¶ˆè´¹ï¼š\næµé‡é«˜å³°ï¼šç§¯å‹åœ¨ Kafka æµé‡æ¢å¤ï¼šLogstash é€æ­¥æ¶ˆè´¹ è¿™æ˜¯ä¸€ç§æµé‡â€œæŸ”æ€§å¤„ç†æœºåˆ¶â€ï¼Œä¿è¯ä¸‹æ¸¸ç¨³å®šã€‚\n5. æ°´å¹³æ‰©å±•ï¼ˆScalabilityï¼‰ Kafka æ”¯æŒï¼š\nå¤šåˆ†åŒºï¼ˆpartitionï¼‰é«˜åå å¤š Logstash å…±äº«æ¶ˆè´¹ç»„æ¶ˆè´¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ é€‚åˆå¤§å‹ç³»ç»Ÿæ—¥å¿—é‡çº§ï¼šç™¾ä¸‡æ¡/ç§’ã€‚\n6. æ¶ˆæ¯é‡è¯•/é‡æ”¾ï¼ˆReplayï¼‰ å¦‚æœåç»­éœ€è¦é‡æ–°å»ºç´¢å¼•ã€è¿ç§» ESã€ä¿®å¤è§£æé—®é¢˜ï¼Œå¯ä»¥ï¼š\né‡æ–°æ¶ˆè´¹ Kafka Topicï¼Œä»å¤´è§£ææ—¥å¿— åœ¨æ²¡æœ‰ Kafka çš„ ELK ä¸­ï¼Œè¿™å‡ ä¹ä¸å¯èƒ½ã€‚\nKafka ç»™æ—¥å¿—ç³»ç»Ÿå¸¦æ¥äº†â€œå¯å›æ”¾æ€§â€ã€‚\n7. æ¶ˆæ¯é¡ºåºä¿è¯ï¼ˆOrderingï¼‰ ä¸€ä¸ªåˆ†åŒºå†…æ—¥å¿—çš„é¡ºåºæ˜¯ä¸¥æ ¼ä¿è¯çš„ã€‚\né€‚åˆï¼š\nå•æœåŠ¡å•å®ä¾‹æ—¥å¿— ä¸šåŠ¡äº‹ä»¶æµ ä¾èµ–é¡ºåºçš„å®¡è®¡æ—¥å¿— 8. æ¥å…¥å¤šä¸‹æ¸¸ï¼ˆFan-outï¼‰ æœ‰äº† Kafka åï¼š\nLogstash æ¶ˆè´¹ -\u0026gt; ES Flink æ¶ˆè´¹ -\u0026gt; å®æ—¶åˆ†æ ClickHouse æ¶ˆè´¹ -\u0026gt; å†å²å½’æ¡£ æ¶ˆè´¹è€…æœåŠ¡ -\u0026gt; å‘Šè­¦ç³»ç»Ÿ Kafka å˜æˆæ—¥å¿—æ•°æ®æ€»çº¿ã€‚\nğŸ”¥ æ€»ç»“ï¼šKafka åœ¨ EFKL æµç¨‹ä¸­çš„èŒè´£æ¦‚æ‹¬ Kafka æ˜¯æ—¥å¿—ç³»ç»Ÿçš„â€œåˆ†å¸ƒå¼ç¼“å†²å±‚ + æŒä¹…é˜Ÿåˆ— + è§£è€¦ä¸­å¿ƒâ€ï¼Œè´Ÿè´£å¸æ”¶æµé‡ã€ä¿è¯ç¨³å®šæ€§ã€é¿å…æ—¥å¿—ä¸¢å¤±ã€è®©ä¸‹æ¸¸å¯ä»¥æŒ‰éœ€æ¶ˆè´¹ã€å®ç°æ°´å¹³æ‰©å±•ä¸å¤šè·¯åˆ†å‘ã€‚\n","description":" ğŸš€ ä»€ä¹ˆæ˜¯ EFLKï¼Ÿ EFLK = ElasticSearch + Filebeat + Logstash + Kibana\nå®ƒæ˜¯ç»å…¸ ELKï¼ˆElasticSearch + Logstash + Kibanaï¼‰çš„æ”¹è¿›ç‰ˆï¼Œ\nE è¡¨ç¤º ElasticSearchï¼ŒF è¡¨ç¤º Filebeatï¼ŒL è¡¨ç¤º Logstashï¼ŒK è¡¨ç¤º Kibanaã€‚\né€šå¸¸ EFLK ä¸ ELFKï¼ˆElasticSearch + Filebeat + Kafka + Logstash + Kibanaï¼‰éƒ½æ˜¯æ—¥å¿—ç³»ç»Ÿå¸¸ç”¨ç¼©å†™ã€‚\næ ¸å¿ƒæ€æƒ³ï¼š\nFilebeatï¼šè½»é‡çº§é«˜æ•ˆæ—¥å¿—é‡‡é›†å™¨ï¼ˆæ›¿ä»£ Logstash åœ¨è¾¹ç¼˜èŠ‚ç‚¹çš„ä½œç”¨ï¼‰ Logstashï¼šè´Ÿè´£æ•°æ®æ¸…æ´—ã€è§£æã€æ ‡å‡†åŒ– ElasticSearchï¼šå­˜å‚¨å’Œæœç´¢æ—¥å¿—æ•°æ® Kibanaï¼šå¯è§†åŒ–ã€æŸ¥è¯¢ã€å‘Šè­¦ ç›¸æ¯”æœ€åŸå§‹ ELKï¼š\næ€§èƒ½æ›´é«˜ï¼ˆFilebeat æ¯” Logstash è½»å‡ åå€ï¼‰ èµ„æºæ¶ˆè€—æ›´ä½ï¼ˆFilebeat å ç”¨å†…å­˜ CPU æå°ï¼‰ æ¶æ„æ›´æ¸…æ™°ï¼ˆé‡‡é›† - ä¼ è¾“ -\u0026gt; æ¸…æ´— -\u0026gt; å­˜å‚¨ï¼‰ ğŸ”¥ ä¸€å¼ å›¾çœ‹æ‡‚ EFLK ä½“ç³» +------------------+ | Filebeat | \u0026lt;- é‡‡é›†æ—¥å¿— | (è½»é‡çº§ Agent) | +------------------+ | v +------------------+ | Logstash | \u0026lt;- è§£æã€æ¸…æ´—ã€è½¬æ¢ç»“æ„åŒ– | filter + codec | +------------------+ | v +---------------------------+ | ElasticSearch | \u0026lt;- å­˜å‚¨ + æ£€ç´¢ + èšåˆ +---------------------------+ | v +---------------------------+ | Kibana | \u0026lt;- åˆ†æ + å¯è§†åŒ– + å‘Šè­¦ +---------------------------+ å¦‚æœä½ çš„ä¸šåŠ¡é‡æ›´å¤§ï¼Œå¯ä»¥æ‰©å±•ä¸ºï¼š\n"},{"id":44,"href":"/database/elasticsearch/tutorial/","title":"ElasticSearch åŸºç¡€æ•™ç¨‹","parent":"ElasticSearch","content":" 1. ElasticSearch æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒæ¦‚å¿µ ES æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£æ•°æ®åº“ + æœç´¢å¼•æ“ï¼Œæ“…é•¿ï¼š\nå…¨æ–‡æœç´¢ï¼ˆå€’æ’ç´¢å¼•ï¼‰ é«˜ç»´æ•°æ®æœç´¢ï¼ˆè¿‘ä¼¼å‘é‡ï¼‰ æ—¥å¿—æ£€ç´¢ï¼ˆELKï¼‰ èšåˆåˆ†æï¼ˆè¿‘ä¼¼æ•°æ®åˆ†æï¼‰ æ ¸å¿ƒæ¦‚å¿µï¼š\næ¦‚å¿µ å«ä¹‰ Cluster ES é›†ç¾¤ï¼Œç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆ Node é›†ç¾¤ä¸­çš„æœåŠ¡å™¨å®ä¾‹ Index ç±»ä¼¼æ•°æ®åº“ä¸­çš„â€œåº“â€ Document å…·ä½“æ•°æ®ï¼Œæ¯æ¡æ•°æ®æ˜¯ JSON Shard ES æœ€é‡è¦æ¦‚å¿µä¹‹ä¸€ï¼Œå­˜å‚¨æ•°æ® Replica å‰¯æœ¬ï¼Œæå‡å¯ç”¨æ€§å’ŒæŸ¥è¯¢èƒ½åŠ› Mapping å­—æ®µå®šä¹‰ï¼ˆç±»å‹ã€åˆ†æå™¨ï¼‰ Analyzer åˆ†è¯å™¨ï¼Œä¾‹å¦‚ ik_max_wordã€standard 2. å€’æ’ç´¢å¼•ï¼ˆæ ¸å¿ƒåŸç†ï¼‰ ES å¯¹æ–‡æœ¬ä½¿ç”¨å€’æ’ç´¢å¼•ï¼Œæµç¨‹ï¼š\næ–‡æœ¬ -\u0026gt; åˆ†è¯ï¼ˆAnalyzerï¼‰ åˆ†è¯ -\u0026gt; token åˆ—è¡¨ å»ºç«‹å€’æ’è¡¨ï¼štoken -\u0026gt; æ–‡æ¡£ ID åˆ—è¡¨ æŸ¥è¯¢æ—¶ï¼Œåªéœ€æŸ¥ token -\u0026gt; ç›¸å…³æ–‡æ¡£ã€‚\n3. ElasticSearch æŸ¥è¯¢æ–¹å¼ 3.1 Query DSLï¼ˆå…¨æ–‡æœç´¢ç”¨ï¼‰ GET index/_search { \u0026#34;query\u0026#34;: { \u0026#34;match\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;fastapi æƒé™\u0026#34; } } } 3.2 Filterï¼ˆç²¾ç¡®è¿‡æ»¤ï¼Œé«˜æ€§èƒ½ï¼‰ Filter ä¸å‚ä¸æ‰“åˆ†ï¼Œå¯ç¼“å­˜ã€‚\n{ \u0026#34;query\u0026#34;: { \u0026#34;bool\u0026#34;: { \u0026#34;filter\u0026#34;: [ { \u0026#34;term\u0026#34;: { \u0026#34;status\u0026#34;: \u0026#34;active\u0026#34; } } ] } } } 3.3 Bool Queryï¼ˆæœ€é‡è¦ï¼‰ mustï¼ˆå¿…é¡»åŒ¹é…ï¼‰ shouldï¼ˆåŠ åˆ†é¡¹ï¼‰ filterï¼ˆè¿‡æ»¤ï¼Œä¸è¯„åˆ†ï¼‰ must_notï¼ˆæ’é™¤ï¼‰ 4. Mappingï¼ˆéå¸¸å…³é”®ï¼‰ å¸¸ç”¨å­—æ®µç±»å‹ï¼š\nkeyword â€”â€” ç²¾ç¡®åŒ¹é…ã€èšåˆ text â€”â€” åˆ†è¯åŒ¹é…ï¼ˆå…¨æ–‡æœç´¢ï¼‰ date â€”â€” æ—¶é—´ longã€float â€”â€” æ•°å­— nested â€”â€” åµŒå¥—å¯¹è±¡ object â€”â€” æ™®é€šå¯¹è±¡ dense_vector â€”â€” å‘é‡æ£€ç´¢ï¼ˆé€šå¸¸ç»´åº¦ â‰¤ 2048ï¼‰ æœ€ä½³å®è·µï¼š\nåœºæ™¯ å­—æ®µç±»å‹ æ ‡é¢˜ã€å†…å®¹ text æ ‡ç­¾ã€åˆ†ç±»ã€çŠ¶æ€ keyword ç”¨æˆ· ID keyword ä»·æ ¼ã€æ•°é‡ long/float æ—¶é—´ date JSON æ•°ç»„ nested 5. Index Templateï¼ˆè‡ªåŠ¨å»ºè¡¨ï¼‰ ç»™æ–°ç´¢å¼•è‡ªåŠ¨ä½¿ç”¨ mappingã€settingï¼š\nPUT _index_template/blog_template { \u0026#34;index_patterns\u0026#34;: [\u0026#34;blog-*\u0026#34;], \u0026#34;template\u0026#34;: { \u0026#34;settings\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 3 }, \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;title\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;}, \u0026#34;status\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34;} } } } } 6. ES æ€§èƒ½å…³é”®ç‚¹ï¼ˆå·¥ç¨‹å¸ˆå¿…æ‡‚ï¼‰ 6.1 shards è®¾ç½® æ•°æ®é‡ \u0026lt; 50GBï¼š1 shard å¤§å‹ç´¢å¼•ï¼šæ¯ shard æ§åˆ¶åœ¨ 30~50GB é¿å…è¿‡å¤š shardï¼ˆ1ä¸ªèŠ‚ç‚¹å»ºè®® \u0026lt; 20 shardï¼‰ 6.2 å‰¯æœ¬æ•° å†™å¤šè¯»å°‘ï¼šreplica=0 å†™å°‘è¯»å¤šï¼šreplica=1~3 7. å†™å…¥æ€§èƒ½ä¼˜åŒ– 7.1 æ‰¹é‡å†™å…¥ ä½¿ç”¨ _bulkï¼š\nPOST _bulk { \u0026#34;index\u0026#34;: {\u0026#34;_index\u0026#34;: \u0026#34;test\u0026#34;, \u0026#34;_id\u0026#34;: \u0026#34;1\u0026#34;} } { \u0026#34;title\u0026#34;: \u0026#34;hello\u0026#34; } 7.2 refresh_interval å†™å¤šæŸ¥è¯¢å°‘çš„åœºæ™¯ï¼ˆå¦‚æ—¥å¿—ï¼‰å¯è°ƒé«˜ï¼š\n\u0026#34;refresh_interval\u0026#34;: \u0026#34;30s\u0026#34; ï¼ˆé»˜è®¤ 1sï¼‰\n8. æœç´¢æ€§èƒ½ä¼˜åŒ– 8.1 ä½¿ç”¨ filter è€Œä¸æ˜¯ must filter ä¸è®¡ç®—è¯„åˆ†ï¼Œæ€§èƒ½æé«˜ã€‚\n8.2 keyword è¦åŠ  doc_values é»˜è®¤å¼€å¯ï¼Œç”¨äºèšåˆå’Œæ’åºã€‚\n9. å‘é‡æ£€ç´¢ï¼ˆdense_vectorï¼‰ ES 8+ æ”¯æŒ ANN è¿‘ä¼¼æœç´¢ï¼Œå¸¸ç”¨ï¼š\n{ \u0026#34;query\u0026#34;: { \u0026#34;knn\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;vector\u0026#34;, \u0026#34;query_vector\u0026#34;: [1.1, 2.3, ...], \u0026#34;k\u0026#34;: 10, \u0026#34;num_candidates\u0026#34;: 100 } } } åº•å±‚é€šå¸¸é‡‡ç”¨ HNSWã€‚\n10. Aggï¼ˆèšåˆï¼‰éå¸¸å¼ºå¤§ å¦‚æ±‚ top10 çƒ­é—¨åˆ†ç±»ï¼š\n{ \u0026#34;aggs\u0026#34;: { \u0026#34;top_category\u0026#34;: { \u0026#34;terms\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;category.keyword\u0026#34;, \u0026#34;size\u0026#34;: 10 } } } } 11. ES ç›‘æ§ï¼ˆè¿ç»´å¿…å¤‡ï¼‰ å…³é”®ç›‘æ§é¡¹ï¼š\né›†ç¾¤çŠ¶æ€ red/yellow/green åˆ†ç‰‡æ˜¯å¦åˆ†é…æˆåŠŸ JVM heap ä½¿ç”¨ç‡ï¼ˆ\u0026gt;75% ä¼šé¢‘ç¹ GCï¼‰ indexing rate search latency refreshã€flushã€merge é¢‘ç‡ å¸¸ç”¨å·¥å…·ï¼š\nKibana Cerebro ElasticHQ 12. ES æœ€ä½³å®è·µ 12.1 Mapping æå‰è®¾è®¡ ES ä¸é€‚åˆé¢‘ç¹æ”¹ mappingã€‚\n12.2 ç¦æ­¢è‡ªåŠ¨åˆ›å»ºç´¢å¼• ç”Ÿäº§å¿…é¡»å…³æ‰ï¼š\naction.auto_create_index: false 12.3 é¿å… nested è¿‡å¤š nested æˆæœ¬é«˜ï¼ŒæŸ¥è¯¢æ…¢ã€‚\n12.4 é¿å…æ·±åº¦åˆ†é¡µ ä¸è¦ç”¨ï¼š\nfrom: 100000 æ”¹ç”¨ï¼š\nsearch_after scrollï¼ˆå¤§æ‰¹é‡å¯¼æ•°æ®ç”¨ï¼‰ 12.5 ES ä¸é€‚åˆä½œä¸ºä¸»æ•°æ®åº“ ç†ç”±ï¼š\næ— äº‹åŠ¡ å†™å…¥æˆæœ¬é«˜ï¼ˆå€’æ’indexï¼‰ æœ‰æ¦‚ç‡ä¸¢æ•°æ® ","description":" 1. ElasticSearch æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒæ¦‚å¿µ ES æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡æ¡£æ•°æ®åº“ + æœç´¢å¼•æ“ï¼Œæ“…é•¿ï¼š\nå…¨æ–‡æœç´¢ï¼ˆå€’æ’ç´¢å¼•ï¼‰ é«˜ç»´æ•°æ®æœç´¢ï¼ˆè¿‘ä¼¼å‘é‡ï¼‰ æ—¥å¿—æ£€ç´¢ï¼ˆELKï¼‰ èšåˆåˆ†æï¼ˆè¿‘ä¼¼æ•°æ®åˆ†æï¼‰ æ ¸å¿ƒæ¦‚å¿µï¼š\næ¦‚å¿µ å«ä¹‰ Cluster ES é›†ç¾¤ï¼Œç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆ Node é›†ç¾¤ä¸­çš„æœåŠ¡å™¨å®ä¾‹ Index ç±»ä¼¼æ•°æ®åº“ä¸­çš„â€œåº“â€ Document å…·ä½“æ•°æ®ï¼Œæ¯æ¡æ•°æ®æ˜¯ JSON Shard ES æœ€é‡è¦æ¦‚å¿µä¹‹ä¸€ï¼Œå­˜å‚¨æ•°æ® Replica å‰¯æœ¬ï¼Œæå‡å¯ç”¨æ€§å’ŒæŸ¥è¯¢èƒ½åŠ› Mapping å­—æ®µå®šä¹‰ï¼ˆç±»å‹ã€åˆ†æå™¨ï¼‰ Analyzer åˆ†è¯å™¨ï¼Œä¾‹å¦‚ ik_max_wordã€standard 2. å€’æ’ç´¢å¼•ï¼ˆæ ¸å¿ƒåŸç†ï¼‰ ES å¯¹æ–‡æœ¬ä½¿ç”¨å€’æ’ç´¢å¼•ï¼Œæµç¨‹ï¼š\n"},{"id":45,"href":"/database/elasticsearch/core/","title":"ElasticSearch æ ¸å¿ƒæ¦‚å¿µ","parent":"ElasticSearch","content":"å†…å®¹ï¼šæ˜¯ä»€ä¹ˆ -\u0026gt; æ€ä¹ˆå­˜ -\u0026gt; æ€ä¹ˆæŸ¥ -\u0026gt; æ€ä¹ˆæ‰© -\u0026gt; ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€‚\nä¸€ã€Elasticsearch æ˜¯ä»€ä¹ˆï¼Ÿ Elasticsearch æ˜¯ä¸€ä¸ªåŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“ï¼Œ ç”¨äº å…¨æ–‡æ£€ç´¢ã€ç»“æ„åŒ–æŸ¥è¯¢ã€èšåˆåˆ†æã€æ—¥å¿—ä¸æŒ‡æ ‡åˆ†æã€‚\næ ¸å¿ƒç‰¹ç‚¹\nåˆ†å¸ƒå¼ï¼ˆå¤©ç„¶é›†ç¾¤ï¼‰ Near Real Timeï¼ˆå‡†å®æ—¶ï¼‰ Schema-on-writeï¼ˆå†™å…¥æ—¶å»ºç»“æ„ï¼‰ é¢å‘æ–‡æ¡£ï¼ˆJSONï¼‰ é«˜å¯æ‰©å±•ã€é«˜å¹¶å‘è¯» äºŒã€ES çš„æ•°æ®æ¨¡å‹ï¼ˆæœ€æ ¸å¿ƒï¼‰ Indexï¼ˆç´¢å¼•ï¼‰ â””â”€â”€ Shardï¼ˆåˆ†ç‰‡ï¼‰ â””â”€â”€ Segmentï¼ˆæ®µï¼‰ â””â”€â”€ Documentï¼ˆæ–‡æ¡£ï¼‰ â””â”€â”€ Fieldï¼ˆå­—æ®µï¼‰ 1ï¸âƒ£ Indexï¼ˆç´¢å¼•ï¼‰ ç±»ä¼¼ æ•°æ®åº“ ä¸€ç±»æ•°æ®çš„é›†åˆ mapping åœ¨è¿™é‡Œå®šä¹‰ index = è¡¨ç»“æ„ + æ•°æ®é›†åˆ\n2ï¸âƒ£ Documentï¼ˆæ–‡æ¡£ï¼‰ ES çš„æœ€å°æ•°æ®å•å…ƒ JSON æ ¼å¼ ç±»ä¼¼ä¸€è¡Œè®°å½• { \u0026#34;id\u0026#34;: 1, \u0026#34;title\u0026#34;: \u0026#34;ElasticSearch\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;å…¨æ–‡æ£€ç´¢å¼•æ“\u0026#34; } 3ï¸âƒ£ Fieldï¼ˆå­—æ®µï¼‰ æ–‡æ¡£ä¸­çš„å±æ€§ æœ‰ç±»å‹ï¼ˆtext / keyword / date / longï¼‰ ä¸‰ã€Mappingï¼ˆå†™å…¥è§„åˆ™ï¼Œé‡ä¸­ä¹‹é‡ï¼‰ Mapping å†³å®šäº†æ•°æ®å¦‚ä½•è¢«ç´¢å¼•å’Œæœç´¢\nå¸¸è§å­—æ®µç±»å‹\nç±»å‹ ç”¨é€” text å…¨æ–‡æ£€ç´¢ keyword ç²¾ç¡®åŒ¹é… / èšåˆ long / integer æ•°å€¼ date æ—¶é—´ boolean å¸ƒå°” object / nested å¯¹è±¡ text vs keywordï¼ˆå¿…è€ƒï¼‰\nå¯¹æ¯” text keyword æ˜¯å¦åˆ†è¯ æ˜¯ å¦ æ˜¯å¦æ”¯æŒèšåˆ âŒ âœ… åœºæ™¯ æœç´¢ è¿‡æ»¤ / æ’åº å››ã€å€’æ’ç´¢å¼•ï¼ˆES çš„çµé­‚ï¼‰ ä»€ä¹ˆæ˜¯å€’æ’ç´¢å¼•ï¼Ÿ\nä¼ ç»Ÿï¼š\næ–‡æ¡£ -\u0026gt; å†…å®¹\nå€’æ’ï¼š\nè¯ -\u0026gt; æ–‡æ¡£åˆ—è¡¨\nç¤ºä¾‹\næ–‡æ¡£ å†…å®¹ doc1 I love ES doc2 I love you å€’æ’ç´¢å¼•ï¼š\nI -\u0026gt; doc1, doc2 love -\u0026gt; doc1, doc2 ES -\u0026gt; doc1 you -\u0026gt; doc2 ğŸ‘‰ æœç´¢é€Ÿåº¦æå¿«\näº”ã€åˆ†è¯å™¨ï¼ˆAnalyzerï¼‰ åˆ†è¯å™¨ç»„æˆ\nCharacter Filter -\u0026gt; Tokenizer -\u0026gt; Token Filter\nå¸¸è§åˆ†è¯å™¨\nåˆ†è¯å™¨ è¯´æ˜ standard é»˜è®¤ ik_smart ä¸­æ–‡ ik_max_word ä¸­æ–‡ keyword ä¸åˆ†è¯ å…­ã€Shardï¼ˆåˆ†ç‰‡ï¼Œåˆ†å¸ƒå¼åŸºç¡€ï¼‰ 1ï¸âƒ£ ä¸»åˆ†ç‰‡ \u0026amp; å‰¯æœ¬åˆ†ç‰‡ Primary Shardï¼šå†™å…¥ä¸»åˆ†ç‰‡ Replica Shardï¼šæé«˜å¯ç”¨æ€§ \u0026amp; è¯»æ€§èƒ½ å†™ -\u0026gt; ä¸»åˆ†ç‰‡ -\u0026gt; åŒæ­¥åˆ°å‰¯æœ¬\n2ï¸âƒ£ åˆ†ç‰‡ç‰¹ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰ åˆ†ç‰‡æ•°åˆ›å»ºåä¸èƒ½æ”¹ åˆ†ç‰‡æ˜¯æœ€å°è°ƒåº¦å•ä½ æŸ¥è¯¢æ˜¯ shard çº§å¹¶è¡Œ 3ï¸âƒ£ åˆ†ç‰‡ç»éªŒå€¼ æŒ‡æ ‡ å»ºè®® å•åˆ†ç‰‡å¤§å° 10~50GB åˆ†ç‰‡æ€»æ•° â‰¤ èŠ‚ç‚¹ Ã— 2~3 ä¸ƒã€å†™å…¥æµç¨‹ï¼ˆåŸç†é¢˜å¿…è€ƒï¼‰ Client â†“ åè°ƒèŠ‚ç‚¹ â†“ Primary Shard â†“ Replica Shard â†“ Refreshï¼ˆç”Ÿæˆ segmentï¼‰ å…³é”®ç‚¹\nå†™å…¥æˆåŠŸ â‰  å¯æœç´¢ refresh åæ‰èƒ½è¢«æŸ¥åˆ° é»˜è®¤ 1s refresh å…«ã€æŸ¥è¯¢æµç¨‹ Client â†“ åè°ƒèŠ‚ç‚¹ â†“ æ‰€æœ‰ç›¸å…³ Shard å¹¶è¡ŒæŸ¥è¯¢ â†“ åˆå¹¶æ’åº â†“ è¿”å›ç»“æœ ä¸¤é˜¶æ®µæŸ¥è¯¢\nQuery Phaseï¼ˆåŒ¹é… + æ‰“åˆ†ï¼‰ Fetch Phaseï¼ˆå–æ–‡æ¡£ï¼‰ ä¹ã€Near Real Timeï¼ˆå‡†å®æ—¶ï¼‰ ä¸ºä»€ä¹ˆä¸æ˜¯å®æ—¶ï¼Ÿ\nå†™å…¥ -\u0026gt; buffer refresh -\u0026gt; segment search åªæŸ¥ segment ğŸ‘‰ 1 ç§’å»¶è¿Ÿæ¢é«˜åå\nåã€èšåˆï¼ˆAggregationï¼‰ ES çš„å®æ—¶åˆ†æèƒ½åŠ›\nç±»å‹\nMetricï¼šsum / avg / max Bucketï¼šterms / date_histogram Pipelineï¼šå¯¹èšåˆç»“æœå†èšåˆ ç‰¹ç‚¹\nåŸºäºå€’æ’ + doc_values å†…å­˜æ¶ˆè€—å¤§ï¼ˆéœ€è°¨æ…ï¼‰ åä¸€ã€ES é›†ç¾¤ä¸èŠ‚ç‚¹è§’è‰² å¸¸è§èŠ‚ç‚¹è§’è‰²\nè§’è‰² èŒè´£ master é›†ç¾¤å…ƒæ•°æ® data å­˜å‚¨å’Œæœç´¢ ingest é¢„å¤„ç† coordinating è¯·æ±‚è·¯ç”± åäºŒã€ES çš„ä¸€è‡´æ€§æ¨¡å‹ é»˜è®¤ æœ€ç»ˆä¸€è‡´æ€§ å†™å…¥å‰¯æœ¬åæ‰è¿”å› ç½‘ç»œå¼‚å¸¸å¯èƒ½çŸ­æš‚ä¸ä¸€è‡´ åä¸‰ã€ES vs æ•°æ®åº“ï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ ç»´åº¦ ES æ•°æ®åº“ æ ¸å¿ƒèƒ½åŠ› æœç´¢ äº‹åŠ¡ ä¸€è‡´æ€§ å¼± å¼º Join ä¸æ“…é•¿ å¼º æ›´æ–° delete + insert in-place æ‰©å±• å¤©ç„¶åˆ†å¸ƒå¼ è¾ƒéš¾ åå››ã€ä¸ºä»€ä¹ˆ ES è¿™ä¹ˆè®¾è®¡ï¼Ÿ å€’æ’ç´¢å¼• -\u0026gt; å¿« åˆ†ç‰‡ -\u0026gt; æ‰©å±• NRT -\u0026gt; åå å¼±ä¸€è‡´ -\u0026gt; é«˜å¯ç”¨ ES ç”¨ä¸€è‡´æ€§æ¢æ€§èƒ½ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´\nåäº”ã€æ€»ç»“\nElasticsearch æ˜¯ä¸€ä¸ªåŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œ ä»¥æ–‡æ¡£ä¸ºå•ä½ï¼Œé€šè¿‡å€’æ’ç´¢å¼•å®ç°å¿«é€Ÿæœç´¢ï¼Œ é€šè¿‡åˆ†ç‰‡å®ç°æ°´å¹³æ‰©å±•ï¼Œ é€šè¿‡å‰¯æœ¬ä¿è¯é«˜å¯ç”¨ï¼Œ æ˜¯ä¸€ä¸ªå‡†å®æ—¶ã€å¼±ä¸€è‡´ã€ä»¥æœç´¢å’Œåˆ†æä¸ºæ ¸å¿ƒçš„ç³»ç»Ÿã€‚\n","description":"å†…å®¹ï¼šæ˜¯ä»€ä¹ˆ -\u0026gt; æ€ä¹ˆå­˜ -\u0026gt; æ€ä¹ˆæŸ¥ -\u0026gt; æ€ä¹ˆæ‰© -\u0026gt; ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€‚\nä¸€ã€Elasticsearch æ˜¯ä»€ä¹ˆï¼Ÿ Elasticsearch æ˜¯ä¸€ä¸ªåŸºäº Lucene çš„åˆ†å¸ƒå¼æœç´¢ä¸åˆ†æå¼•æ“ï¼Œ ç”¨äº å…¨æ–‡æ£€ç´¢ã€ç»“æ„åŒ–æŸ¥è¯¢ã€èšåˆåˆ†æã€æ—¥å¿—ä¸æŒ‡æ ‡åˆ†æã€‚\næ ¸å¿ƒç‰¹ç‚¹\nåˆ†å¸ƒå¼ï¼ˆå¤©ç„¶é›†ç¾¤ï¼‰ Near Real Timeï¼ˆå‡†å®æ—¶ï¼‰ Schema-on-writeï¼ˆå†™å…¥æ—¶å»ºç»“æ„ï¼‰ é¢å‘æ–‡æ¡£ï¼ˆJSONï¼‰ é«˜å¯æ‰©å±•ã€é«˜å¹¶å‘è¯» äºŒã€ES çš„æ•°æ®æ¨¡å‹ï¼ˆæœ€æ ¸å¿ƒï¼‰ Indexï¼ˆç´¢å¼•ï¼‰ â””â”€â”€ Shardï¼ˆåˆ†ç‰‡ï¼‰ â””â”€â”€ Segmentï¼ˆæ®µï¼‰ â””â”€â”€ Documentï¼ˆæ–‡æ¡£ï¼‰ â””â”€â”€ Fieldï¼ˆå­—æ®µï¼‰ 1ï¸âƒ£ Indexï¼ˆç´¢å¼•ï¼‰ ç±»ä¼¼ æ•°æ®åº“ ä¸€ç±»æ•°æ®çš„é›†åˆ mapping åœ¨è¿™é‡Œå®šä¹‰ index = è¡¨ç»“æ„ + æ•°æ®é›†åˆ\n"},{"id":46,"href":"/operations/git/tutorial/","title":"Git åŸºç¡€æ•™ç¨‹","parent":"Git","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…ç³»ç»Ÿçš„ Git æ•™ç¨‹å¤§å…¨ï¼Œä»é›¶åŸºç¡€åˆ°é«˜çº§æŠ€å·§ï¼Œè¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€å·¥ä½œæµã€å‘½ä»¤ã€åœºæ™¯å®æˆ˜ã€æœ€ä½³å®è·µã€æ•…éšœæ’æŸ¥ç­‰å†…å®¹ã€‚\nç›®å½•ï¼ˆå¯ç›´æ¥ç‚¹æˆ‘ç»§ç»­å±•å¼€ï¼‰\nGit åŸºç¡€æ¦‚å¿µ Git å®‰è£…ä¸é…ç½® Git å·¥ä½œåŒºã€æš‚å­˜åŒºã€ä»“åº“ Git åŸºæœ¬å¸¸ç”¨å‘½ä»¤ Git åˆ†æ”¯ç®¡ç† Git åˆå¹¶ä¸å˜åŸºï¼ˆmerge / rebaseï¼‰ Git è¿œç¨‹ä»“åº“ï¼ˆGitLab/Githubï¼‰ Git æ ‡ç­¾ï¼ˆtagï¼‰ Git å¸¸ç”¨å®æˆ˜åœºæ™¯ Git é«˜é˜¶å†…å®¹ Git æœ€ä½³å®è·µ Git æ’é”™ä¸ä¿®å¤å¸¸è§é—®é¢˜ Git å®‰å…¨ä¸å‡­æ®ç®¡ç† 1. Git åŸºç¡€æ¦‚å¿µï¼ˆæ ¸å¿ƒï¼‰ ä»€ä¹ˆæ˜¯ Gitï¼Ÿ\nGit æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚\nâ€œåˆ†å¸ƒå¼â€ çš„æ„ä¹‰åœ¨äºï¼š\næ¯ä¸ªäººæœ¬åœ°éƒ½æœ‰ä¸€ä¸ªå®Œæ•´ä»“åº“ï¼ˆåŒ…æ‹¬å†å²è®°å½•ï¼‰ ä¸ä¾èµ–ä¸­å¿ƒæœåŠ¡å™¨å°±èƒ½æäº¤ã€æŸ¥çœ‹å†å² æ ¸å¿ƒæ¦‚å¿µä¸‰ä»¶å¥—\nåç§° æè¿° å·¥ä½œåŒº Working Directory é¡¹ç›®æ–‡ä»¶æ‰€åœ¨çš„æ™®é€šç›®å½• æš‚å­˜åŒº Staging Area å³å°†æäº¤åˆ°æœ¬åœ°ä»“åº“çš„æ–‡ä»¶åŒºåŸŸ æœ¬åœ°ä»“åº“ Repository .git/ ç›®å½•ï¼Œä¿å­˜å†å²è®°å½• è¿œç¨‹ä»“åº“ Remote GitLab/Github ç­‰å­˜æ”¾ä»“åº“å‰¯æœ¬çš„æœåŠ¡å™¨ 2. Git å®‰è£…ä¸é…ç½® å®‰è£… Git Linux:\nsudo apt install git Mac:\nbrew install git Windowsï¼šä¸‹è½½ Git for Windows\né…ç½®ç”¨æˆ·ä¿¡æ¯ git config --global user.name \u0026#34;your name\u0026#34; git config --global user.email \u0026#34;your@email.com\u0026#34; æŸ¥çœ‹æ‰€æœ‰é…ç½®ï¼š\ngit config --list 3. å·¥ä½œåŒº / æš‚å­˜åŒº / ä»“åº“ æœ€æ ¸å¿ƒæµç¨‹ï¼š\nå·¥ä½œåŒº -\u0026gt; æš‚å­˜åŒº -\u0026gt; æœ¬åœ°ä»“åº“ -\u0026gt; è¿œç¨‹ä»“åº“ æäº¤æ—¶ä½ åšçš„æ˜¯ï¼š\ngit add # æ”¾åˆ°æš‚å­˜åŒº git commit # æ”¾åˆ°æœ¬åœ°ä»“åº“ git push # æ¨åˆ°è¿œç¨‹ä»“åº“ 4. Git åŸºæœ¬å¸¸ç”¨å‘½ä»¤ï¼ˆæœ€å¸¸ç”¨ï¼‰ æŸ¥çœ‹æ–‡ä»¶çŠ¶æ€\ngit status æ·»åŠ åˆ°æš‚å­˜åŒº\ngit add file git add . æäº¤\ngit commit -m \u0026#34;message\u0026#34; æ’¤é”€ add\ngit reset HEAD file æ’¤é”€å·¥ä½œåŒºä¿®æ”¹\ngit checkout -- file æŸ¥çœ‹å†å²\ngit log --oneline --graph --decorate æ¯”è¾ƒå·®å¼‚\ngit diff 5. Git åˆ†æ”¯ç®¡ç†ï¼ˆæ ¸å¿ƒï¼‰ åˆ›å»ºä¸åˆ‡æ¢\ngit branch new-feature git checkout new-feature å¿«æ·ï¼š\ngit checkout -b new-feature åˆ é™¤åˆ†æ”¯\ngit branch -d branchname git branch -D branchname 6. Git åˆå¹¶ä¸å˜åŸºï¼ˆmerge vs rebaseï¼‰ merge\ngit merge dev ç‰¹ç‚¹ï¼š\nä¿ç•™åˆ†å‰ï¼Œè®°å½•ç›´è§‚ï¼Œå¯è¿½æº¯ rebase\ngit rebase main ç‰¹ç‚¹ï¼š\nè®©å†å²æ›´å¹²å‡€ ç¼ºç‚¹ï¼šä¸è¦å¯¹åˆ«äººå·²ç»åŸºäºä½ çš„æäº¤ rebase\nè¯¦ç»†åŒºåˆ«ï¼š\nmerge åˆ›å»ºä¸€ä¸ªåˆå¹¶æäº¤ rebase é‡æ–°æ’­æ”¾æäº¤ï¼Œè®©å†å²çº¿æ€§åŒ– 7. Git è¿œç¨‹ä»“åº“ æ·»åŠ è¿œç¨‹\ngit remote add origin URL æŸ¥çœ‹è¿œç¨‹ URL\ngit remote -v æ¨é€\ngit push origin branchname æ‹‰å–\ngit pull origin branchname 8. Git Tagï¼ˆå‘å¸ƒç‰ˆæœ¬å¸¸ç”¨ï¼‰ åˆ›å»º tag\ngit tag v1.0 å¸¦æ³¨é‡Šï¼š\ngit tag -a v1.0 -m \u0026#34;release\u0026#34; æ¨é€ tag\ngit push origin v1.0 æ¨å…¨éƒ¨ tag\ngit push origin --tags 9. Git å¸¸ç”¨å®æˆ˜åœºæ™¯ ä¿®æ”¹æœ€æ–°æäº¤ message\ngit commit --amend åˆå¹¶å¤šä¸ªæäº¤ï¼ˆsquashï¼‰\ngit rebase -i HEAD~3 å›æ»šæŸä¸ª commit\ngit revert \u0026lt;hash\u0026gt; å¼ºåˆ¶å›é€€\ngit reset --hard \u0026lt;hash\u0026gt; git push -f æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹äº†å“ªäº›æ–‡ä»¶\ngit diff-tree --no-commit-id --name-only -r HEAD 10. Git é«˜é˜¶å†…å®¹ Git hooksï¼ˆè‡ªåŠ¨åŒ–ï¼‰ Git submoduleï¼ˆå­æ¨¡å—ï¼‰ Git stashï¼ˆå·¥ä½œåŒºæš‚å­˜ï¼‰ Git cherry-pickï¼ˆæŒ‘æäº¤ï¼‰ Git bisectï¼ˆå®šä½ bug æäº¤ï¼‰ Git gc / pruneï¼ˆåƒåœ¾å›æ”¶ï¼‰ 11. Git æœ€ä½³å®è·µ åˆ†æ”¯ç­–ç•¥ æ¨èï¼š\nmain/masterï¼šä¸»çº¿ developï¼šå¼€å‘çº¿ feature/xxxï¼šåŠŸèƒ½åˆ†æ”¯ release/xxxï¼šå‘å¸ƒåˆ†æ”¯ hotfix/xxxï¼šç´§æ€¥ä¿®å¤ commit message è§„èŒƒ feat: æ–°åŠŸèƒ½ fix: ä¿®å¤ bug docs: æ–‡æ¡£ä¿®æ”¹ refactor: é‡æ„ style: æ ¼å¼ä¿®æ”¹ test: æµ‹è¯•ç›¸å…³ chore: å…¶ä»– 12. Git å¸¸è§é—®é¢˜æ’æŸ¥ é”™è¯¯ åŸå›  è§£å†³ Your branch and \u0026lsquo;origin/x\u0026rsquo; have diverged åˆ†å‰ git pull \u0026ndash;rebase fatal: refusing to merge unrelated histories ä¸¤ä»“åº“æ— å…±åŒå†å² git pull \u0026ndash;allow-unrelated-histories There is no merge to abort æ²¡æœ‰å¤„äº merge çŠ¶æ€ å¿½ç•¥ æ— æ³• push è¿œç«¯æœ‰æ–°æäº¤ å…ˆ git pull \u0026ndash;rebase 13. Git å®‰å…¨ä¸å‡­æ®ç®¡ç†ï¼ˆé«˜çº§ï¼‰ ä½¿ç”¨ Personal Access Token ä»£æ›¿å¯†ç  ä½¿ç”¨ credential.helper ç¦æ­¢è¯»å– ~/.git-credentials ä½¿ç”¨ GIT_ASKPASS CI/CD ä¸­å®‰å…¨æ¨æ‹‰ä»£ç  ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…ç³»ç»Ÿçš„ Git æ•™ç¨‹å¤§å…¨ï¼Œä»é›¶åŸºç¡€åˆ°é«˜çº§æŠ€å·§ï¼Œè¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€å·¥ä½œæµã€å‘½ä»¤ã€åœºæ™¯å®æˆ˜ã€æœ€ä½³å®è·µã€æ•…éšœæ’æŸ¥ç­‰å†…å®¹ã€‚\nç›®å½•ï¼ˆå¯ç›´æ¥ç‚¹æˆ‘ç»§ç»­å±•å¼€ï¼‰\nGit åŸºç¡€æ¦‚å¿µ Git å®‰è£…ä¸é…ç½® Git å·¥ä½œåŒºã€æš‚å­˜åŒºã€ä»“åº“ Git åŸºæœ¬å¸¸ç”¨å‘½ä»¤ Git åˆ†æ”¯ç®¡ç† Git åˆå¹¶ä¸å˜åŸºï¼ˆmerge / rebaseï¼‰ Git è¿œç¨‹ä»“åº“ï¼ˆGitLab/Githubï¼‰ Git æ ‡ç­¾ï¼ˆtagï¼‰ Git å¸¸ç”¨å®æˆ˜åœºæ™¯ Git é«˜é˜¶å†…å®¹ Git æœ€ä½³å®è·µ Git æ’é”™ä¸ä¿®å¤å¸¸è§é—®é¢˜ Git å®‰å…¨ä¸å‡­æ®ç®¡ç† 1. Git åŸºç¡€æ¦‚å¿µï¼ˆæ ¸å¿ƒï¼‰ ä»€ä¹ˆæ˜¯ Gitï¼Ÿ\nGit æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚\nâ€œåˆ†å¸ƒå¼â€ çš„æ„ä¹‰åœ¨äºï¼š\næ¯ä¸ªäººæœ¬åœ°éƒ½æœ‰ä¸€ä¸ªå®Œæ•´ä»“åº“ï¼ˆåŒ…æ‹¬å†å²è®°å½•ï¼‰ ä¸ä¾èµ–ä¸­å¿ƒæœåŠ¡å™¨å°±èƒ½æäº¤ã€æŸ¥çœ‹å†å² æ ¸å¿ƒæ¦‚å¿µä¸‰ä»¶å¥—\nåç§° æè¿° å·¥ä½œåŒº Working Directory é¡¹ç›®æ–‡ä»¶æ‰€åœ¨çš„æ™®é€šç›®å½• æš‚å­˜åŒº Staging Area å³å°†æäº¤åˆ°æœ¬åœ°ä»“åº“çš„æ–‡ä»¶åŒºåŸŸ æœ¬åœ°ä»“åº“ Repository .git/ ç›®å½•ï¼Œä¿å­˜å†å²è®°å½• è¿œç¨‹ä»“åº“ Remote GitLab/Github ç­‰å­˜æ”¾ä»“åº“å‰¯æœ¬çš„æœåŠ¡å™¨ 2. Git å®‰è£…ä¸é…ç½® å®‰è£… Git Linux:\n"},{"id":47,"href":"/operations/git/core/","title":"Git æ ¸å¿ƒæ¦‚å¿µ","parent":"Git","content":"å†…å®¹ï¼šè®¾è®¡æ€æƒ³ -\u0026gt; æ•°æ®æ¨¡å‹ -\u0026gt; æ ¸å¿ƒå¯¹è±¡ -\u0026gt; å·¥ä½œæµ -\u0026gt; åˆ†æ”¯åŸç† -\u0026gt; åˆå¹¶åŸç†\nä¸€ã€Git çš„è®¾è®¡å“²å­¦ï¼ˆæœ€æ ¸å¿ƒï¼‰ 1ï¸âƒ£ Git ä¸æ˜¯â€œæ–‡ä»¶å·®å¼‚ç³»ç»Ÿâ€ Git æ˜¯ä¸€ä¸ªï¼šå†…å®¹å¯»å€ï¼ˆContent-addressableï¼‰çš„å¯¹è±¡æ•°æ®åº“\nSVNï¼šå­˜â€œæ–‡ä»¶ + å·®å¼‚â€ Gitï¼šå­˜â€œå†…å®¹å¿«ç…§ + æŒ‡é’ˆâ€ ğŸ‘‰ è¿™å°±æ˜¯ Git å¿«ã€åˆ†æ”¯ä¾¿å®œã€åˆå¹¶å¼ºçš„æ ¹æœ¬åŸå› ã€‚\n2ï¸âƒ£ åˆ†å¸ƒå¼æ˜¯â€œå®Œæ•´ä»“åº“å¤åˆ¶â€ æ¯ä¸ª Git ä»“åº“éƒ½åŒ…å«ï¼š\nå®Œæ•´å†å² æ‰€æœ‰åˆ†æ”¯ æ‰€æœ‰å¯¹è±¡ æ‰€ä»¥ Git çš„ commitã€logã€diff éƒ½æ˜¯æœ¬åœ°æ“ä½œï¼Œéå¸¸å¿«ã€‚\näºŒã€Git çš„å››å¤§æ ¸å¿ƒå¯¹è±¡ï¼ˆç†è§£ Git çš„å…³é”®ï¼‰ Git ä»“åº“æœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°æ®åº“ï¼Œåªæœ‰ 4 ç§å¯¹è±¡ï¼š\nå¯¹è±¡ ä½œç”¨ blob æ–‡ä»¶å†…å®¹ tree ç›®å½•ç»“æ„ commit ä¸€æ¬¡æäº¤ tag æ ‡ç­¾ï¼ˆæŒ‡å‘ commitï¼‰ 1ï¸âƒ£ blobï¼ˆæ–‡ä»¶å†…å®¹ï¼‰ åªå­˜æ–‡ä»¶å†…å®¹ ä¸å­˜æ–‡ä»¶åã€ä¸å­˜è·¯å¾„ ç›¸åŒå†…å®¹ -\u0026gt; ç›¸åŒ SHA-1 -\u0026gt; åªå­˜ä¸€ä»½ \u0026#34;hello\\n\u0026#34; -\u0026gt; blob -\u0026gt; sha1: aaf4c61d... 2ï¸âƒ£ treeï¼ˆç›®å½•ç»“æ„ï¼‰ è®°å½•ï¼š æ–‡ä»¶å æƒé™ æŒ‡å‘ blob / å­ tree çš„æŒ‡é’ˆ ç±»ä¼¼ Linux æ–‡ä»¶ç³»ç»Ÿçš„ inodeã€‚\ntree â”œâ”€â”€ file1.txt -\u0026gt; blob â””â”€â”€ src/ -\u0026gt; tree â””â”€â”€ main.py -\u0026gt; blob 3ï¸âƒ£ commitï¼ˆæäº¤ï¼‰ commit ä¸æ˜¯â€œæ–‡ä»¶é›†åˆâ€ï¼Œè€Œæ˜¯ï¼š\ncommit â”œâ”€â”€ æŒ‡å‘ä¸€ä¸ª treeï¼ˆé¡¹ç›®å¿«ç…§ï¼‰ â”œâ”€â”€ æŒ‡å‘çˆ¶ commitï¼ˆ1 ä¸ªæˆ–å¤šä¸ªï¼‰ â”œâ”€â”€ ä½œè€…ã€æ—¶é—´ã€message ğŸ‘‰ commit æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡\n4ï¸âƒ£ tagï¼ˆæ ‡ç­¾ï¼‰ è½»é‡ tagï¼šç›´æ¥æŒ‡å‘ commit é™„æ³¨ tagï¼šä¸€ä¸ªå¯¹è±¡ï¼ŒæŒ‡å‘ commit ç”¨äºç‰ˆæœ¬å‘å¸ƒã€‚\nä¸‰ã€SHA-1ï¼šGit çš„æ ¸å¿ƒç´¢å¼•æœºåˆ¶ 1ï¸âƒ£ å†…å®¹å†³å®šä¸€åˆ‡ Git ä½¿ç”¨ SHA-1 å“ˆå¸Œ å†…å®¹ä¸€æ · -\u0026gt; hash ä¸€æ · å†…å®¹å˜äº† -\u0026gt; hash å…¨å˜ ğŸ‘‰ æ‰€ä»¥ï¼š\nGit èƒ½è‡ªåŠ¨å»é‡ Git èƒ½æ£€æµ‹æ•°æ®æŸå Git éå¸¸é€‚åˆåˆ†å¸ƒå¼ å››ã€Git çš„ä¸‰å¤§åŒºåŸŸï¼ˆæ ¸å¿ƒå·¥ä½œæ¨¡å‹ï¼‰ Working Tree -\u0026gt; Index -\u0026gt; Repository åŒºåŸŸ ä½œç”¨ Working Tree å®é™…æ–‡ä»¶ Indexï¼ˆStageï¼‰ å‡†å¤‡æäº¤çš„å¿«ç…§ Repository å·²æäº¤å†å² å…³é”®ç†è§£ï¼š\ngit addï¼šä¸æ˜¯â€œæ·»åŠ æ–‡ä»¶â€ï¼Œè€Œæ˜¯æ›´æ–° Index git commitï¼šæŠŠ Index å†™æˆ commit äº”ã€HEADã€æœ¬è´¨åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ HEAD æ˜¯ä»€ä¹ˆï¼Ÿ HEAD æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰åˆ†æ”¯æˆ– commit\nHEAD -\u0026gt; refs/heads/main -\u0026gt; commit Detached HEAD æ˜¯ä»€ä¹ˆï¼Ÿ HEAD ç›´æ¥æŒ‡å‘ commitï¼Œè€Œä¸æ˜¯åˆ†æ”¯ï¼š\nHEAD -\u0026gt; commit ğŸ‘‰ æäº¤ä¼šâ€œæ¼‚æµ®â€ï¼Œä¸å±äºä»»ä½•åˆ†æ”¯ã€‚\nå…­ã€åˆ†æ”¯çš„æœ¬è´¨ï¼ˆéå¸¸é‡è¦ï¼‰ åˆ†æ”¯ä¸æ˜¯æ‹·è´\nGit åˆ†æ”¯åªæ˜¯ä¸€ä¸ª æŒ‡å‘ commit çš„å¯ç§»åŠ¨æŒ‡é’ˆ\nrefs/heads/main -\u0026gt; commit A åˆ›å»ºåˆ†æ”¯ï¼š\nrefs/heads/feature -\u0026gt; commit A æˆæœ¬å‡ ä¹ä¸º 0ã€‚\nä¸ºä»€ä¹ˆ Git åˆ†æ”¯è¿™ä¹ˆå¿«ï¼Ÿ å› ä¸ºï¼š\nä¸å¤åˆ¶æ–‡ä»¶ åªæ˜¯æ–°å»ºä¸€ä¸ªå¼•ç”¨æ–‡ä»¶ ä¸ƒã€merge çš„åº•å±‚åŸç† 1ï¸âƒ£ ä¸‰æ–¹åˆå¹¶ï¼ˆThree-way mergeï¼‰ Git åˆå¹¶æ—¶ä¼šæ‰¾ï¼š\nå…±åŒç¥–å…ˆ å½“å‰åˆ†æ”¯ è¢«åˆå¹¶åˆ†æ”¯ ç„¶åï¼š\nè‡ªåŠ¨åˆå¹¶ä¸å†²çªçš„éƒ¨åˆ† å†²çªéƒ¨åˆ†äº¤ç»™äººå¤„ç† 2ï¸âƒ£ merge commit çš„æœ¬è´¨ commit M â”œâ”€â”€ parent1 -\u0026gt; main â””â”€â”€ parent2 -\u0026gt; feature ğŸ‘‰ ä¸€ä¸ª commit å¯ä»¥æœ‰å¤šä¸ªçˆ¶æäº¤ã€‚\nå…«ã€rebase çš„åº•å±‚åŸç†ï¼ˆç†è§£åå°±ä¸æ€•ï¼‰ rebase æœ¬è´¨ï¼š\næŠŠä¸€ç»„ commit å¤åˆ¶åˆ°å¦ä¸€ä¸ªåŸºç‚¹ä¸Š\nA - B - C (main) \\ D - E (feature) rebase åï¼š\nA - B - C - D\u0026#39; - E\u0026#39; Dâ€™ã€Eâ€™ æ˜¯æ–° commitï¼ˆhash å…¨å˜ï¼‰ å†å²è¢«é‡å†™ ğŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ å·² push çš„åˆ†æ”¯ä¸è¦ rebase\nä¹ã€Git çš„ç´¢å¼•ï¼ˆIndexï¼‰ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Ÿ Index çš„ä½œç”¨ï¼š\næ”¯æŒ éƒ¨åˆ†æäº¤ æ”¯æŒå¤æ‚åˆå¹¶ æ”¯æŒç²¾ç»†æ§åˆ¶ æ²¡æœ‰ Indexï¼š\nä½ åªèƒ½ä¸€æ¬¡æ€§æäº¤å…¨éƒ¨æ–‡ä»¶ åˆå¹¶å†²çªå¤„ç†ä¼šéå¸¸ç—›è‹¦ åã€Git ä¸ºä»€ä¹ˆæ“…é•¿åˆå¹¶ï¼Ÿ å› ä¸ºï¼š\nå†…å®¹å¯»å€ ä¸‰æ–¹åˆå¹¶ tree / blob åˆ†ç¦» åˆ†æ”¯æè½»é‡ ğŸ‘‰ Git ä»è®¾è®¡ä¹‹åˆå°±å‡è®¾ï¼šåˆ†æ”¯å’Œåˆå¹¶æ˜¯å¸¸æ€\nåä¸€ã€Git çš„æ•°æ®å®‰å…¨æœºåˆ¶ æ‰€æœ‰å¯¹è±¡éƒ½æœ‰ hash ä»»ä½•æŸåéƒ½ä¼šè¢«å‘ç° push/pull ä¼šæ ¡éªŒå¯¹è±¡å®Œæ•´æ€§ åäºŒã€Git å’Œæ–‡ä»¶ç³»ç»Ÿçš„ç±»æ¯”ï¼ˆéå¸¸å¥½è®°ï¼‰ Git æ–‡ä»¶ç³»ç»Ÿ blob æ–‡ä»¶å†…å®¹ tree ç›®å½• commit å¿«ç…§ branch æŒ‡é’ˆ HEAD å½“å‰æŒ‡é’ˆ åä¸‰ã€ä¸ºä»€ä¹ˆ Git ä¸æ€•è¯¯æ“ä½œï¼Ÿ å› ä¸ºï¼š\ngit reflog è®°å½•äº†æŒ‡é’ˆå˜åŒ– å¤§éƒ¨åˆ†â€œåˆ é™¤â€åªæ˜¯ç§»åŠ¨æŒ‡é’ˆ çœŸæ­£æ•°æ®ä¼šè¢«ä¿ç•™ä¸€æ®µæ—¶é—´ ğŸ‘‰ 99% çš„è¯¯åˆ éƒ½èƒ½æ•‘å›æ¥\nåå››ã€æ ¸å¿ƒè®¤çŸ¥æ€»ç»“ Git ä¸æ˜¯æ–‡ä»¶å·®å¼‚ç³»ç»Ÿï¼Œè€Œæ˜¯ä¸€ä¸ªå†…å®¹å¯»å€çš„å¯¹è±¡æ•°æ®åº“ commit æ˜¯æŒ‡å‘ tree çš„æŒ‡é’ˆ åˆ†æ”¯åªæ˜¯å¯ç§»åŠ¨å¼•ç”¨ merge æ˜¯ä¸‰æ–¹åˆå¹¶ rebase æ˜¯æäº¤å¤åˆ¶ ","description":"å†…å®¹ï¼šè®¾è®¡æ€æƒ³ -\u0026gt; æ•°æ®æ¨¡å‹ -\u0026gt; æ ¸å¿ƒå¯¹è±¡ -\u0026gt; å·¥ä½œæµ -\u0026gt; åˆ†æ”¯åŸç† -\u0026gt; åˆå¹¶åŸç†\nä¸€ã€Git çš„è®¾è®¡å“²å­¦ï¼ˆæœ€æ ¸å¿ƒï¼‰ 1ï¸âƒ£ Git ä¸æ˜¯â€œæ–‡ä»¶å·®å¼‚ç³»ç»Ÿâ€ Git æ˜¯ä¸€ä¸ªï¼šå†…å®¹å¯»å€ï¼ˆContent-addressableï¼‰çš„å¯¹è±¡æ•°æ®åº“\nSVNï¼šå­˜â€œæ–‡ä»¶ + å·®å¼‚â€ Gitï¼šå­˜â€œå†…å®¹å¿«ç…§ + æŒ‡é’ˆâ€ ğŸ‘‰ è¿™å°±æ˜¯ Git å¿«ã€åˆ†æ”¯ä¾¿å®œã€åˆå¹¶å¼ºçš„æ ¹æœ¬åŸå› ã€‚\n2ï¸âƒ£ åˆ†å¸ƒå¼æ˜¯â€œå®Œæ•´ä»“åº“å¤åˆ¶â€ æ¯ä¸ª Git ä»“åº“éƒ½åŒ…å«ï¼š\n"},{"id":48,"href":"/operations/gitlab/tutorial/","title":"GitLab åŸºç¡€æ•™ç¨‹","parent":"GitLab","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€å¯å®è·µã€ç»“æ„æ¸…æ™°çš„ GitLab æ•™ç¨‹ï¼Œæ¶µç›–ä» æ ¸å¿ƒæ¦‚å¿µã€å®‰è£…éƒ¨ç½²ã€ç”¨æˆ·ä¸æƒé™ã€CI/CDã€Runnerã€é¡¹ç›®ç®¡ç†ã€Hookã€è¿ç»´ã€å¤‡ä»½æ¢å¤ã€å®‰å…¨åŠ å›ºã€æœ€ä½³å®è·µ ç­‰å†…å®¹ã€‚\nç›®å½• GitLab æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒåŠŸèƒ½æ¦‚è¿° GitLab æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶ GitLab å®‰è£…éƒ¨ç½²ï¼ˆå•æœºã€Dockerã€K8Sã€HAï¼‰ åŸºç¡€ä½¿ç”¨æ•™ç¨‹ï¼ˆç”¨æˆ·ã€é¡¹ç›®ã€ç»„ã€æƒé™ï¼‰ GitLab CI/CD å®Œæ•´æ•™ç¨‹ GitLab Runner ä½¿ç”¨æ•™ç¨‹ GitLab å¸¸ç”¨åŠŸèƒ½ï¼ˆIssueã€MRã€Webhookã€APIï¼‰ GitLab è¿ç»´ä¸ç®¡ç†ï¼ˆå¤‡ä»½ã€æ¢å¤ã€å‡çº§ï¼‰ GitLab æ€§èƒ½è°ƒä¼˜ GitLab å®‰å…¨åŠ å›º GitLab æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ 1. GitLab æ˜¯ä»€ä¹ˆï¼Ÿ GitLab = ä»£ç æ‰˜ç®¡ + CI/CD + DevOps å¹³å°\nä¸»è¦æ¨¡å—ï¼š\nGit ä»“åº“ç®¡ç† Merge Requestï¼ˆä»£ç è¯„å®¡ï¼‰ Issue / ä»»åŠ¡ç®¡ç† / çœ‹æ¿ CI/CD Pipeline Runner æ‰§è¡Œå™¨ ä¾èµ–ä»“åº“ï¼ˆRegistryã€Packageã€Container Registryï¼‰ æƒé™ç®¡ç†ï¼ˆç”¨æˆ·/ç»„/é¡¹ç›®ï¼‰ GitLab = GitHub çš„è‡ªå»ºæ›¿ä»£å“ï¼Œä½†æ¯” GitHub æ›´å ä¼ä¸šå†…éƒ¨ DevOps ä¸€ä½“åŒ–å¹³å°ã€‚\n2. GitLab æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶ 2.1 æ ¸å¿ƒç»„æˆ GitLab Rails ä¸»æ ¸å¿ƒï¼šWebã€APIã€ä¸šåŠ¡é€»è¾‘ã€‚\nGitaly Git æ“ä½œæœåŠ¡ï¼ˆæ›¿ä»£åŸæ¥çš„ NFS æ–¹æ¡ˆï¼‰ã€‚\nPostgreSQL Redis Sidekiq Nginx/Workhorse GitLab Runnerï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰ 2.2 è¿è¡Œæµç¨‹ï¼ˆç®€å›¾ï¼‰ ç”¨æˆ· -\u0026gt; Nginx -\u0026gt; Workhorse -\u0026gt; Rails -\u0026gt; Gitaly -\u0026gt; Git Repo â†“ Sidekiq â†“ Redis / PostgreSQL 3. GitLab å®‰è£…éƒ¨ç½² 3.1 Linux ä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰ åŸºäº Omnibus åŒ…ï¼š\ncurl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | bash sudo EXTERNAL_URL=\u0026#34;https://gitlab.example.com\u0026#34; apt install gitlab-ee å¸¸ç”¨å­å‘½ä»¤ï¼š\ngitlab-ctl reconfigure # é‡è½½é…ç½® gitlab-ctl status # æŸ¥çœ‹æœåŠ¡çŠ¶æ€ gitlab-ctl restart # é‡å¯æœåŠ¡ gitlab-rake gitlab:check # æ£€æŸ¥å¥åº· 3.2 ä½¿ç”¨ Docker éƒ¨ç½²ï¼ˆæœ€ç®€å•ï¼‰ docker run -d \\ --hostname gitlab.example.com \\ -p 443:443 -p 80:80 -p 22:22 \\ --name gitlab \\ -v /srv/gitlab/config:/etc/gitlab \\ -v /srv/gitlab/logs:/var/log/gitlab \\ -v /srv/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ee:latest 3.3 Kubernetes éƒ¨ç½²ï¼ˆç”Ÿäº§çº§ï¼‰ å®˜æ–¹ Helm Chart: gitlab/gitlab éœ€å‡†å¤‡ï¼š NFS/S3 Object Storageï¼ˆArtifactsã€Registryï¼‰ PostgreSQLï¼ˆå¤–éƒ¨æˆ– Cloudï¼‰ Redisï¼ˆCluster ç‰ˆï¼‰ Ingress 4. GitLab åŸºç¡€ä½¿ç”¨æ•™ç¨‹ 4.1 ç”¨æˆ·ä¸æƒé™ æƒé™çº§åˆ«ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š\nGuest Reporter Developer Maintainer Owner æ ¸å¿ƒåŒºåˆ«ï¼š\nè§’è‰² æŸ¥çœ‹ æ¨é€ åˆ›å»º MR ç®¡ç†é¡¹ç›® ç®¡ç†ç»„ Guest âœ… âŒ âŒ âŒ âŒ Reporter âœ… âŒ âŒ âŒ âŒ Developer âœ… âœ… âœ… âŒ âŒ Maintainer âœ… âœ… âœ… âœ… âŒ Owner âœ… âœ… âœ… âœ… âœ… 4.2 ç»„ï¼ˆGroupï¼‰ ä¸€ä¸ªç»„å¯ä»¥åŒ…å«å¤šä¸ªé¡¹ç›® å¯ä»¥è®¾ç½®é»˜è®¤æƒé™ å¯ä»¥åˆ›å»ºå­ç»„ï¼ˆå­æƒé™ç»§æ‰¿ï¼‰ 4.3 é¡¹ç›®ï¼ˆProjectï¼‰ æ ¸å¿ƒåŠŸèƒ½ï¼š\nIssues Merge Requests Wiki Snippets WebIDE CI/CD Pipelinesï¼ˆ.gitlab-ci.ymlï¼‰ 4.4 Merge Requestï¼ˆä»£ç è¯„å®¡ï¼‰ MR æ¨èæµç¨‹ï¼š\nå¼€æ–°åˆ†æ”¯ æäº¤ä»£ç  Push åˆ›å»º MR Reviewer ä»£ç Review MR pipeline é€šè¿‡ Squash merge 5. GitLab CI/CDï¼ˆå®Œå…¨ä½“ï¼‰ æ ¸å¿ƒæ–‡ä»¶ï¼š.gitlab-ci.yml\n5.1 Pipeline åŸºæœ¬ç»“æ„ stages: - build - test - deploy build-job: stage: build script: - echo \u0026#34;Build...\u0026#34; test-job: stage: test script: - echo \u0026#34;Run Test\u0026#34; deploy-job: stage: deploy script: - echo \u0026#34;Deploy\u0026#34; only: - main 5.2 å¸¸ç”¨é…ç½® ç¼“å­˜ cache\ncache: paths: - node_modules/ å·¥ä»¶ artifacts\nartifacts: paths: - build/ expire_in: 7 days ç¯å¢ƒç®¡ç† environment\nenvironment: name: production url: https://prod.example.com å˜é‡ variables\nvariables: NODE_ENV: production 6. GitLab Runner æ•™ç¨‹ 6.1 å®‰è£… Runner sudo apt install gitlab-runner gitlab-runner --version 6.2 æ³¨å†Œ Runner gitlab-runner register é€‰æ‹©ï¼š\nexecutorï¼šdocker / shell / virtualbox / kubernetes é»˜è®¤æ¨è Docker executor 6.3 Docker Runner é…ç½® [runners.docker] tls_verify = false image = \u0026#34;alpine:latest\u0026#34; privileged = true volumes = [\u0026#34;/cache\u0026#34;] 7. GitLab å¸¸ç”¨åŠŸèƒ½ 7.1 Issues ä»»åŠ¡ç®¡ç†ï¼Œå¯é…ç½® labelã€milestoneã€assigneeã€‚\n7.2 Milestone ç”¨äºç®¡ç†é˜¶æ®µæ€§ä»»åŠ¡ï¼ˆå¦‚è¿­ä»£ï¼‰ã€‚\n7.3 Webhook å¸¸ç”¨åœºæ™¯ï¼š\nè§¦å‘ Jenkins æ¨é€åˆ°é£ä¹¦/é’‰é’‰ è‡ªåŠ¨éƒ¨ç½² 7.4 GitLab APIï¼ˆREST \u0026amp; GraphQLï¼‰ ç¤ºä¾‹ï¼š\ncurl --header \u0026#34;PRIVATE-TOKEN: \u0026lt;your_access_token\u0026gt;\u0026#34; \\ https://gitlab.example.com/api/v4/projects 8. GitLab è¿ç»´ç®¡ç† 8.1 å¤‡ä»½ gitlab-backup create ls /var/opt/gitlab/backups 8.2 æ¢å¤ gitlab-backup restore BACKUP=xxx gitlab-ctl reconfigure 8.3 å‡çº§åŸåˆ™ ä¸è¦è·¨å¤§ç‰ˆæœ¬å‡çº§ éµå¾ªç‰ˆæœ¬è·³è·ƒè§„åˆ™ï¼ˆå¦‚ 12 -\u0026gt; 13 -\u0026gt; 14ï¼‰ 9. GitLab æ€§èƒ½è°ƒä¼˜ 9.1 æ¨èæœåŠ¡å™¨é…ç½® äººæ•° CPU å†…å­˜ å­˜å‚¨ \u0026lt;100 4C 8G SSD 100 ~ 1000 8C 16G SSD ä¼ä¸šçº§ 16C+ 32G+ SSD RAID 9.2 è°ƒä¼˜æ–¹å‘ Gitaly åˆ†ç¦»éƒ¨ç½² Redis Cluster PostgreSQL å¤–éƒ¨åŒ–ï¼ˆä¸»ä»ï¼‰ Sidekiq å¤šé˜Ÿåˆ— Registryã€Artifacts ä½¿ç”¨ S3 10. GitLab å®‰å…¨åŠ å›º å¼ºåˆ¶ 2FA ç¦æ­¢ Guest åˆ›å»ºé¡¹ç›® é™åˆ¶ Runner æƒé™ï¼ˆä¸è¦ root/privilegedï¼‰ å…³é—­å…¬å¼€æ³¨å†Œ é…ç½®é˜²ç«å¢™ï¼šåªæš´éœ² 22ã€80ã€443 å¯ç”¨ SSOï¼ˆLDAP / SAMLï¼‰ 11. GitLab æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ å¼€å‘æµç¨‹æ¨èï¼š\nmainï¼šä¿æŠ¤åˆ†æ”¯ devï¼šæ™®é€šå¼€å‘ feature/*ï¼šç‰¹æ€§ bugfix/*ï¼šä¿®å¤ hotfix/*ï¼šçº¿ä¸Šä¿®å¤ CI/CD æœ€ä½³å®è·µ\næ¯ä¸ª MR è§¦å‘ pipeline pipeline åˆ†é˜¶æ®µï¼šLint -\u0026gt; Build -\u0026gt; Test -\u0026gt; Deploy ç”Ÿäº§ç¯å¢ƒå¿…é¡»æœ‰æ‰‹å·¥ç¡®è®¤ï¼ˆmanualï¼‰ æƒé™æœ€ä½³å®è·µ\nDeveloper ä¸å…è®¸ç›´æ¥ push main Maintainer æ‰èƒ½åˆå¹¶ MR æ¯ä¸ªç»„ä½¿ç”¨å­ç»„ç®¡ç†æƒé™éš”ç¦» Runner ä½¿ç”¨ token + scope é™åˆ¶ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€å¯å®è·µã€ç»“æ„æ¸…æ™°çš„ GitLab æ•™ç¨‹ï¼Œæ¶µç›–ä» æ ¸å¿ƒæ¦‚å¿µã€å®‰è£…éƒ¨ç½²ã€ç”¨æˆ·ä¸æƒé™ã€CI/CDã€Runnerã€é¡¹ç›®ç®¡ç†ã€Hookã€è¿ç»´ã€å¤‡ä»½æ¢å¤ã€å®‰å…¨åŠ å›ºã€æœ€ä½³å®è·µ ç­‰å†…å®¹ã€‚\nç›®å½• GitLab æ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒåŠŸèƒ½æ¦‚è¿° GitLab æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶ GitLab å®‰è£…éƒ¨ç½²ï¼ˆå•æœºã€Dockerã€K8Sã€HAï¼‰ åŸºç¡€ä½¿ç”¨æ•™ç¨‹ï¼ˆç”¨æˆ·ã€é¡¹ç›®ã€ç»„ã€æƒé™ï¼‰ GitLab CI/CD å®Œæ•´æ•™ç¨‹ GitLab Runner ä½¿ç”¨æ•™ç¨‹ GitLab å¸¸ç”¨åŠŸèƒ½ï¼ˆIssueã€MRã€Webhookã€APIï¼‰ GitLab è¿ç»´ä¸ç®¡ç†ï¼ˆå¤‡ä»½ã€æ¢å¤ã€å‡çº§ï¼‰ GitLab æ€§èƒ½è°ƒä¼˜ GitLab å®‰å…¨åŠ å›º GitLab æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ 1. GitLab æ˜¯ä»€ä¹ˆï¼Ÿ GitLab = ä»£ç æ‰˜ç®¡ + CI/CD + DevOps å¹³å°\n"},{"id":49,"href":"/operations/gitlab/core/","title":"GitLab æ ¸å¿ƒæ¦‚å¿µ","parent":"GitLab","content":"å†…å®¹ï¼šä¸ºä»€ä¹ˆéœ€è¦ GitLab -\u0026gt; æ ¸å¿ƒå¯¹è±¡ -\u0026gt; åº•å±‚æ¶æ„ -\u0026gt; CI/CD ç†è®ºæ¨¡å‹ -\u0026gt; æƒé™ä¸æ²»ç† -\u0026gt; ä¼ä¸šçº§æŠ½è±¡\nä¸€ã€GitLab æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ç†è§£ï¼‰ ä¸€å¥è¯å®šä¹‰ï¼š\nGitLab æ˜¯ä¸€ä¸ªä»¥ Git ä»“åº“ä¸ºä¸­å¿ƒï¼Œå°† ä»£ç  -\u0026gt; æµç¨‹ -\u0026gt; æƒé™ -\u0026gt; è‡ªåŠ¨åŒ– -\u0026gt; éƒ¨ç½² -\u0026gt; åé¦ˆ å…¨éƒ¨æ‰“é€šçš„ ä¸€ä½“åŒ– DevOps å¹³å°ã€‚\nå®ƒè§£å†³çš„ä¸æ˜¯ã€Œå­˜ä»£ç ã€ï¼Œè€Œæ˜¯ï¼š\nå¦‚ä½•è®©ä»£ç åœ¨å¯æ§ã€å®‰å…¨ã€å¯å®¡è®¡çš„å‰æä¸‹ï¼Œç¨³å®šã€é«˜é¢‘åœ°æµå‘ç”Ÿäº§ç¯å¢ƒã€‚\näºŒã€GitLab çš„æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ GitLab çš„æ‰€æœ‰åŠŸèƒ½ï¼Œæœ€ç»ˆéƒ½å›´ç»• 5 ä¸ªæ ¸å¿ƒå¯¹è±¡ è¿è½¬ï¼š\nRepositoryï¼ˆä»£ç ï¼‰ â”‚ â”œâ”€ Commitï¼ˆæäº¤ï¼‰ â”‚ â”œâ”€ Branch / Tagï¼ˆåˆ†æ”¯ / æ ‡ç­¾ï¼‰ â”‚ â”œâ”€ Merge Requestï¼ˆå˜æ›´å…¥å£ï¼‰ â”‚ â”œâ”€ Pipelineï¼ˆè‡ªåŠ¨åŒ–æµç¨‹ï¼‰ â”‚ â””â”€ Environmentï¼ˆè¿è¡Œç¯å¢ƒï¼‰ ä½ ç†è§£äº†è¿™ 5 ä¸ªå¯¹è±¡ï¼Œå°±ç†è§£äº† GitLab çš„ 80%ã€‚\nä¸‰ã€GitLab çš„æ ¸å¿ƒå¯¹è±¡è¯¦è§£ 1ï¸âƒ£ Repositoryï¼ˆä»“åº“ï¼‰ æœ¬è´¨ï¼š\nä¸€ä¸ª Git ä»“åº“ åŒ…å«æºç ã€å†å²ã€åˆ†æ”¯ã€æ ‡ç­¾ GitLab åœ¨ Git ä¹‹ä¸Šå¢åŠ äº†ï¼š\næƒé™ å®¡è®¡ CI/CD å¯è§†åŒ–ç®¡ç† ğŸ“Œ è®¤çŸ¥é‡ç‚¹ï¼š\nGitLab â‰  Git GitLab = Git + ç®¡ç† + è‡ªåŠ¨åŒ– 2ï¸âƒ£ Commitï¼ˆæäº¤ï¼‰ æœ€å°å˜æ›´å•å…ƒ æ˜¯ CI/CD çš„çœŸæ­£è§¦å‘æº æ¯ä¸€ä¸ª commitï¼š\néƒ½å¯èƒ½è§¦å‘ Pipeline éƒ½æœ‰ä½œè€…ã€æ—¶é—´ã€diffã€SHA éƒ½å¯è¿½æº¯ã€å¯å®¡è®¡ ğŸ“Œ å…³é”®ç†è§£ï¼š\nGitLab çš„è‡ªåŠ¨åŒ–æ˜¯ commit é©±åŠ¨ çš„ï¼Œè€Œä¸æ˜¯äººé©±åŠ¨ã€‚\n3ï¸âƒ£ Branch / Tagï¼ˆåˆ†æ”¯ / æ ‡ç­¾ï¼‰ Branchï¼ˆåˆ†æ”¯ï¼‰\nç”¨äºå¼€å‘æµç¨‹ å†³å®š CI æ˜¯å¦æ‰§è¡Œã€å¦‚ä½•æ‰§è¡Œ å…¸å‹åˆ†æ”¯ï¼š\nmain / master develop feature/* hotfix/* Tagï¼ˆæ ‡ç­¾ï¼‰\né€šå¸¸è¡¨ç¤º ä¸€æ¬¡å‘å¸ƒ CI ä¸­å¸¸ç”¨äºã€Œæ­£å¼å‘å¸ƒè§¦å‘ç‚¹ã€ rules: - if: \u0026#39;$CI_COMMIT_TAG\u0026#39; ğŸ“Œ è®¤çŸ¥æ¨¡å‹ï¼š\nåˆ†æ”¯ = æµç¨‹ æ ‡ç­¾ = ç‰ˆæœ¬ / å‘å¸ƒç‚¹ 4ï¸âƒ£ Merge Requestï¼ˆMRï¼‰ è¿™æ˜¯ GitLab çš„â€œæ§åˆ¶ä¸­æ¢â€\nMR æœ¬è´¨æ˜¯ï¼š\nä¸€æ¬¡å—æ§çš„å˜æ›´ç”³è¯·\nå®ƒç»‘å®šäº†ï¼š\nä»£ç  diff CI Pipeline Reviewer å®¡æ‰¹è§„åˆ™ å®‰å…¨æ‰«æ åˆå¹¶ç­–ç•¥ ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼š\næ²¡æœ‰ MRï¼Œå°±ä¸åº”è¯¥è¿›å…¥ä¸»å¹²ã€‚\n5ï¸âƒ£ Pipelineï¼ˆæµæ°´çº¿ï¼‰ Pipeline æ˜¯ GitLab è‡ªåŠ¨åŒ–çš„æ ¸å¿ƒæ‰§è¡Œæ¨¡å‹ã€‚\nå®ƒæ˜¯ï¼š\nç”± .gitlab-ci.yml æè¿° ç”± commit / MR / tag è§¦å‘ ç”± Runner æ‰§è¡Œ ç»“æ„æ¨¡å‹ï¼š\nPipeline â”œâ”€ Stage â”‚ â”œâ”€ Job â”‚ â”œâ”€ Job â”œâ”€ Stage â”‚ â”œâ”€ Job ğŸ“Œ Pipeline æœ¬è´¨ï¼š\nå°†ã€Œäººä¸ºæµç¨‹ã€è½¬åŒ–ä¸ºã€Œæœºå™¨å¯æ‰§è¡Œæµç¨‹ã€ã€‚\n6ï¸âƒ£ Job / Stageï¼ˆä»»åŠ¡ / é˜¶æ®µï¼‰ Stageï¼šé€»è¾‘é˜¶æ®µï¼ˆé¡ºåºï¼‰ Jobï¼šå…·ä½“æ‰§è¡Œå•å…ƒï¼ˆå¹¶è¡Œï¼‰ ğŸ“Œ é‡è¦è§„åˆ™ï¼š\nStage é¡ºåºæ‰§è¡Œ åŒ Stage Job å¹¶è¡Œæ‰§è¡Œ Job å¤±è´¥ -\u0026gt; Stage å¤±è´¥ -\u0026gt; Pipeline å¤±è´¥ 7ï¸âƒ£ Runnerï¼ˆæ‰§è¡Œå™¨ï¼‰ Runner æ˜¯ CI/CD çš„â€œå·¥äººâ€ã€‚\nGitLabï¼šè°ƒåº¦ä¸ç®¡ç† Runnerï¼šçœŸæ­£æ‰§è¡Œå‘½ä»¤ Runner æœ¬èº«æ˜¯ æ— çŠ¶æ€çš„æ‰§è¡ŒèŠ‚ç‚¹ã€‚\nğŸ“Œ å…³é”®ç†è§£ï¼š\nRunner ä¸â€œå±äºâ€é¡¹ç›®ï¼Œå®ƒåªæ˜¯æ¥æ´»å¹²ã€‚\n8ï¸âƒ£ Artifacts / Cacheï¼ˆäº§ç‰© / ç¼“å­˜ï¼‰ æ¦‚å¿µ æœ¬è´¨ ç›®çš„ Artifacts æ„å»ºç»“æœ ä¼ é€’ã€ä¸‹è½½ Cache ä¸­é—´ä¾èµ– åŠ é€Ÿ ğŸ“Œ è®¤çŸ¥æ¨¡å‹ï¼š\nArtifacts æ˜¯ã€Œç»“æœã€ Cache æ˜¯ã€Œè¿‡ç¨‹ä¼˜åŒ–ã€ 9ï¸âƒ£ Environmentï¼ˆç¯å¢ƒï¼‰ Environment æŠ½è±¡çš„æ˜¯ï¼š\nä»£ç è¿è¡Œçš„çœŸå®ä¸–ç•Œ\nå¦‚ï¼š\ndev test staging production GitLab èƒ½ï¼š\nè®°å½•éƒ¨ç½²å†å² æ ‡è®°å½“å‰ç‰ˆæœ¬ æ”¯æŒå›æ»š å››ã€GitLab CI/CD çš„ç†è®ºæ¨¡å‹ GitLab CI çš„åº•å±‚æ€æƒ³æ˜¯ï¼š\nä»£ç å˜æ›´ â†“ è‡ªåŠ¨éªŒè¯ï¼ˆCIï¼‰ â†“ è‡ªåŠ¨æ„å»º â†“ è‡ªåŠ¨äº¤ä»˜ï¼ˆCDï¼‰ ğŸ“Œ æ ¸å¿ƒæ€æƒ³ï¼š\nä¸ç›¸ä¿¡äººï¼Œåªç›¸ä¿¡è‡ªåŠ¨åŒ–ã€‚\näº”ã€GitLab çš„æƒé™ä¸æ²»ç†æ¨¡å‹ 1ï¸âƒ£ ç”¨æˆ·ä¸è§’è‰²æ¨¡å‹ è§’è‰²æ˜¯ èƒ½åŠ›é›†åˆï¼Œä¸æ˜¯äººï¼š\nGuest Reporter Developer Maintainer Owner ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼š\næƒé™æ°¸è¿œæœ€å°åŒ–ã€‚\n2ï¸âƒ£ Group / Projectï¼ˆç»„ç»‡æ¨¡å‹ï¼‰ Group â”œâ”€ SubGroup â”‚ â”œâ”€ Project â”‚ â”œâ”€ Project ç”¨äºï¼š\næƒé™ç»§æ‰¿ èµ„æºéš”ç¦» CI Runner å¤ç”¨ 3ï¸âƒ£ Protected Branch / Tag ç”¨äºï¼š\né˜²æ­¢è¯¯æ“ä½œ å¼ºåˆ¶ MR æµç¨‹ ä¿æŠ¤ç”Ÿäº§ä»£ç  ğŸ“Œ ç”Ÿäº§ç¯å¢ƒå¿…é¡» Protected\nå…­ã€GitLab æ¶æ„åŸºç¡€ç†è®ºï¼ˆç®€åŒ–ç‰ˆï¼‰ User â†“ Nginx â†“ GitLab Rails â†“ Gitaly â”€ Git Repo â†“ PostgreSQL / Redis â†“ Runnerï¼ˆCI æ‰§è¡Œï¼‰ ğŸ“Œ å…³é”®ç‚¹ï¼š\nGit æ“ä½œä¸åœ¨ Rails ä¸­æ‰§è¡Œ Gitaly æ˜¯æ€§èƒ½ä¸æ‰©å±•æ ¸å¿ƒ CI æ‰§è¡Œä¸ GitLab è§£è€¦ ä¸ƒã€GitLab çš„è®¾è®¡å“²å­¦ï¼ˆé«˜çº§è®¤çŸ¥ï¼‰ 1ï¸âƒ£ Everything as Code Pipeline as Code Infrastructure as Code Policy as Code 2ï¸âƒ£ Shift Left å®‰å…¨å‰ç§» æµ‹è¯•å‰ç§» è´¨é‡å‰ç§» 3ï¸âƒ£ Single Source of Truth Git æ˜¯å”¯ä¸€äº‹å®æ¥æº å…«ã€å¸¸è§è®¤çŸ¥è¯¯åŒºï¼ˆéå¸¸é‡è¦ï¼‰ âŒ GitLab = GitHub ç§æœ‰ç‰ˆ\nâŒ CI = å†™å‡ ä¸ªè„šæœ¬\nâŒ Runner å±äºé¡¹ç›®\nâŒ Pipeline æ˜¯é¡ºåºæ‰§è¡Œ\nâŒ Cache å’Œ Artifacts æ˜¯ä¸€å›äº‹\nâœ… GitLab æ˜¯æµç¨‹æ²»ç†å¹³å°\nâœ… CI æ˜¯å·¥ç¨‹åŒ–èƒ½åŠ›\nâœ… Runner æ˜¯ç‹¬ç«‹æ‰§è¡ŒèŠ‚ç‚¹\nâœ… Job å¯å¹¶è¡Œ\nâœ… Cache â‰  Artifacts\nä¹ã€æ€»ç»“ GitLab çš„æ ¸å¿ƒä»·å€¼ï¼Œä¸åœ¨äºâ€œå·¥å…·â€ï¼Œè€Œåœ¨äºï¼š\næŠŠè½¯ä»¶äº¤ä»˜è¿™ä»¶äº‹ï¼Œä»â€œç»éªŒé©±åŠ¨â€ï¼Œå˜æˆâ€œè§„åˆ™ + è‡ªåŠ¨åŒ–é©±åŠ¨â€ã€‚\n","description":"å†…å®¹ï¼šä¸ºä»€ä¹ˆéœ€è¦ GitLab -\u0026gt; æ ¸å¿ƒå¯¹è±¡ -\u0026gt; åº•å±‚æ¶æ„ -\u0026gt; CI/CD ç†è®ºæ¨¡å‹ -\u0026gt; æƒé™ä¸æ²»ç† -\u0026gt; ä¼ä¸šçº§æŠ½è±¡\nä¸€ã€GitLab æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ç†è§£ï¼‰ ä¸€å¥è¯å®šä¹‰ï¼š\nGitLab æ˜¯ä¸€ä¸ªä»¥ Git ä»“åº“ä¸ºä¸­å¿ƒï¼Œå°† ä»£ç  -\u0026gt; æµç¨‹ -\u0026gt; æƒé™ -\u0026gt; è‡ªåŠ¨åŒ– -\u0026gt; éƒ¨ç½² -\u0026gt; åé¦ˆ å…¨éƒ¨æ‰“é€šçš„ ä¸€ä½“åŒ– DevOps å¹³å°ã€‚\nå®ƒè§£å†³çš„ä¸æ˜¯ã€Œå­˜ä»£ç ã€ï¼Œè€Œæ˜¯ï¼š\nå¦‚ä½•è®©ä»£ç åœ¨å¯æ§ã€å®‰å…¨ã€å¯å®¡è®¡çš„å‰æä¸‹ï¼Œç¨³å®šã€é«˜é¢‘åœ°æµå‘ç”Ÿäº§ç¯å¢ƒã€‚\näºŒã€GitLab çš„æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ GitLab çš„æ‰€æœ‰åŠŸèƒ½ï¼Œæœ€ç»ˆéƒ½å›´ç»• 5 ä¸ªæ ¸å¿ƒå¯¹è±¡ è¿è½¬ï¼š\n"},{"id":50,"href":"/operations/hardware/","title":"Hardware","parent":"Operations","content":"Document List:\nå®¶ç”¨ç”µè„‘å’ŒæœåŠ¡å™¨ç¡¬ä»¶å¯¹æ¯” æœåŠ¡å™¨ç¡¬ä»¶ è½¯RAID vs ç¡¬RAID ","description":"Document List:\nå®¶ç”¨ç”µè„‘å’ŒæœåŠ¡å™¨ç¡¬ä»¶å¯¹æ¯” æœåŠ¡å™¨ç¡¬ä»¶ è½¯RAID vs ç¡¬RAID "},{"id":51,"href":"/operations/ipvs/tutorial/","title":"IPVS åŸºç¡€æ•™ç¨‹","parent":"IPVS","content":" 1. IPVS æ˜¯ä»€ä¹ˆï¼Ÿ IPVSï¼ˆIP Virtual Serverï¼‰æ˜¯ Linux å†…æ ¸ä¸­çš„å››å±‚è´Ÿè½½å‡è¡¡å®ç°ï¼Œæ˜¯ LVSï¼ˆLinux Virtual Serverï¼‰é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ã€‚\nå®ƒå·¥ä½œåœ¨ å†…æ ¸æ€ï¼Œå…·å¤‡é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„ç‰¹ç‚¹ã€‚\nç”¨é€”ï¼šå››å±‚ï¼ˆTCP/UDPï¼‰è´Ÿè½½å‡è¡¡ æ ¸å¿ƒä¼˜åŠ¿ï¼šæ€§èƒ½æ¯” nginx/haproxy ç­‰ç”¨æˆ·æ€ LB é«˜å‡º 5ï½10 å€ 2. IPVS ä¸ iptables çš„åŒºåˆ«ï¼ˆé‡ç‚¹ï¼‰ ç‰¹æ€§ iptables (kube-proxy) IPVS (kube-proxy) å·¥ä½œæ¨¡å¼ ç”¨æˆ·æ€ + å†…æ ¸æ€ å†…æ ¸æ€ã€ä¸“ä¸º LB ä¼˜åŒ– æ€§èƒ½ï¼ˆQPSï¼‰ è¾ƒä½ æé«˜ï¼ˆç™¾ä¸‡çº§ï¼‰ å¹¶å‘è¿æ¥ å° è¶…å¤§ã€å¯ç™¾ä¸‡çº§ è´Ÿè½½å‡è¡¡ç®—æ³• å°‘ å¤š K8S æ”¯æŒ é»˜è®¤ éœ€è¦å®‰è£…æ¨¡å—æˆ–åˆ‡æ¢æ¨¡å¼ Kubernetes åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­å¼ºçƒˆæ¨èé€‰æ‹© IPVS æ¨¡å¼çš„ kube-proxyã€‚\n3. IPVS çš„ 3 ç§å·¥ä½œæ¨¡å¼ï¼ˆLVS ç»å…¸æ¨¡å¼ï¼‰ 3.1 NATï¼ˆNetwork Address Translationï¼‰ è´Ÿè½½å‡è¡¡å™¨ä¿®æ”¹è¯·æ±‚å’Œå“åº”çš„æº/ç›®æ ‡åœ°å€ã€‚\nä¼˜ç‚¹ï¼šç®€å• ç¼ºç‚¹ï¼šLB å‹åŠ›å¤§ï¼ˆè¿›ã€å‡ºéƒ½è¦ NATï¼‰ é€‚ç”¨ï¼šå°è§„æ¨¡ Client -\u0026gt; [VIP -\u0026gt; LB -\u0026gt; DIP] -\u0026gt; RealServer RealServer -\u0026gt; LB -\u0026gt; Client 3.2 DRï¼ˆDirect Routingï¼‰â€” æœ€å¸¸ç”¨ã€æœ€é«˜æ€§èƒ½ è¯·æ±‚ç»è¿‡ LBï¼Œå“åº” ç›´æ¥ä» RealServer å›å®¢æˆ·ç«¯ã€‚\nä¼˜ç‚¹ï¼šæ€§èƒ½æœ€é«˜ ç¼ºç‚¹ï¼šRealServer å¿…é¡»ä¸ LB åœ¨åŒä¸€äºŒå±‚ç½‘ç»œ åœºæ™¯ï¼šé«˜æ€§èƒ½é›†ç¾¤ Client -\u0026gt; LB -\u0026gt; RealServer RealServer -\u0026gt; Clientï¼ˆç»•è¿‡ LBï¼‰ 3.3 TUNï¼ˆIP Tunnelingï¼‰ LB ç”¨éš§é“å°è£…ï¼ˆå¦‚ IPIPï¼‰è½¬å‘è¯·æ±‚ã€‚\nä¼˜ç‚¹ï¼šè·¨ä¸‰å±‚é«˜æ€§èƒ½ ç¼ºç‚¹ï¼šRealServer è¦æ”¯æŒ IPIP é€‚ç”¨ï¼šè·¨æœºæˆ¿ã€è·¨åŸå¸‚ 4 IPVS æ”¯æŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆéå¸¸å¼ºå¤§ï¼‰ ç®—æ³• è¯´æ˜ rr è½®è¯¢ wrr æƒé‡è½®è¯¢ lc æœ€å°‘è¿æ¥ wlc åŠ æƒæœ€å°‘è¿æ¥ lblc åŸºäºæœ¬åœ°æ€§æœ€å°‘è¿æ¥ lblcr åŸºäºæœ¬åœ°æ€§å‰¯æœ¬ sed æœ€çŸ­æœŸæœ›å»¶è¿Ÿ nq ä¸æ’é˜Ÿ Kubernetes é‡Œ kube-proxy é»˜è®¤ä½¿ç”¨ rrã€‚\n5. Linux å®‰è£… IPVS æ¨¡å— ä¸€é”®åŠ è½½ï¼ˆå¸¸ç”¨ï¼‰\nsudo modprobe ip_vs sudo modprobe ip_vs_rr sudo modprobe ip_vs_wrr sudo modprobe ip_vs_sh sudo modprobe nf_conntrack ç¡®ä¿æ¨¡å—ç”Ÿæ•ˆï¼š\nlsmod | grep ip_vs 6. kube-proxy åˆ‡æ¢åˆ° IPVS æ¨¡å¼ï¼ˆK8S å¿…ç”¨ï¼‰ K8S é»˜è®¤ä½¿ç”¨ iptables æ¨¡å¼ï¼Œå¯ä»¥æ”¹ä¸º IPVSï¼š\næŸ¥çœ‹ kube-proxy é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ï¼‰\n/var/lib/kube-proxy/config.conf ä¿®æ”¹ï¼š\nmode: \u0026#34;ipvs\u0026#34; é‡å¯ kube-proxyï¼š\nsystemctl restart kube-proxy éªŒè¯ï¼š\nkubectl get pods -n kube-system -o wide | grep kube-proxy å¹¶ç¡®è®¤ ipvsadm ç”Ÿæ•ˆï¼š\nipvsadm -Ln 7. IPVS å¸¸ç”¨å‘½ä»¤ï¼ˆipvsadmï¼‰ æŸ¥çœ‹ IPVS é…ç½® ipvsadm -Ln æ·»åŠ  Virtual Serverï¼ˆVIPï¼‰ ipvsadm -A -t 10.0.0.1:80 -s rr æ·»åŠ  Real Server ipvsadm -a -t 10.0.0.1:80 -r 192.168.1.10:80 -m â€œ-mâ€ è¡¨ç¤º NATï¼ŒDR ç”¨ â€œ-gâ€ï¼ŒTUN ç”¨ â€œ-iâ€ã€‚\nåˆ é™¤è™šæ‹ŸæœåŠ¡ ipvsadm -D -t 10.0.0.1:80 æ¸…é™¤å…¨éƒ¨é…ç½® ipvsadm -C 8. IPVS åœ¨ Kubernetes é‡Œçš„è¡¨ç° IPVS æ¨¡å¼çš„ä¼˜åŠ¿éå¸¸æ˜æ˜¾ï¼š\næ›´ä½å»¶è¿Ÿ æ›´é«˜åå æœåŠ¡æ•°é‡è¶Šå¤šï¼Œä¼˜åŠ¿è¶Šæ˜æ˜¾ï¼ˆiptables ä¼šå¯¼è‡´è§„åˆ™çˆ†ç‚¸ï¼‰ æ”¯æŒæ›´å¤š LB ç®—æ³• å¼ºçƒˆå»ºè®®ï¼š\nå¤§è§„æ¨¡é›†ç¾¤å¿…é¡»ç”¨ IPVS æ¨¡å¼çš„ kube-proxyã€‚\n9. IPVS vs Keepalived è¦åšé«˜å¯ç”¨æ—¶ï¼Œä½ ä¼šçœ‹åˆ° Keepalivedï¼ˆVRRPï¼‰é…åˆ IPVSã€‚\nç”¨é€”ï¼š\nKeepalived æä¾› VIP æ¼‚ç§»ï¼ˆåŒæœºçƒ­å¤‡ï¼‰ IPVS æä¾›è´Ÿè½½å‡è¡¡è°ƒåº¦ ç»å¸¸ç»„åˆæˆï¼š\nLVS-DR LVS-TUN é«˜å¯ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆMASTER \u0026amp; BACKUPï¼‰ 10. IPVS åœ¨ç”Ÿäº§ä¸­çš„æœ€ä½³å®è·µ LVS-DR æ¨¡å¼ + Keepalived æœ€é«˜æ€§èƒ½æ–¹æ¡ˆï¼Œé€‚ç”¨äº web æœåŠ¡ã€API æœåŠ¡ã€‚\nåœ¨ Kubernetes ä¸­ä½¿ç”¨ IPVS æ¨¡å¼ é€‚åˆ Node æ•°æˆ– Service æ•°è¾ƒå¤šçš„é›†ç¾¤ã€‚\nå…³é—­ conntrackï¼ˆå¯é€‰ï¼‰ å¤§è§„æ¨¡ç¯å¢ƒèƒ½æå‡æ€§èƒ½ã€‚\n","description":" 1. IPVS æ˜¯ä»€ä¹ˆï¼Ÿ IPVSï¼ˆIP Virtual Serverï¼‰æ˜¯ Linux å†…æ ¸ä¸­çš„å››å±‚è´Ÿè½½å‡è¡¡å®ç°ï¼Œæ˜¯ LVSï¼ˆLinux Virtual Serverï¼‰é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ã€‚\nå®ƒå·¥ä½œåœ¨ å†…æ ¸æ€ï¼Œå…·å¤‡é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿçš„ç‰¹ç‚¹ã€‚\nç”¨é€”ï¼šå››å±‚ï¼ˆTCP/UDPï¼‰è´Ÿè½½å‡è¡¡ æ ¸å¿ƒä¼˜åŠ¿ï¼šæ€§èƒ½æ¯” nginx/haproxy ç­‰ç”¨æˆ·æ€ LB é«˜å‡º 5ï½10 å€ 2. IPVS ä¸ iptables çš„åŒºåˆ«ï¼ˆé‡ç‚¹ï¼‰ ç‰¹æ€§ iptables (kube-proxy) IPVS (kube-proxy) å·¥ä½œæ¨¡å¼ ç”¨æˆ·æ€ + å†…æ ¸æ€ å†…æ ¸æ€ã€ä¸“ä¸º LB ä¼˜åŒ– æ€§èƒ½ï¼ˆQPSï¼‰ è¾ƒä½ æé«˜ï¼ˆç™¾ä¸‡çº§ï¼‰ å¹¶å‘è¿æ¥ å° è¶…å¤§ã€å¯ç™¾ä¸‡çº§ è´Ÿè½½å‡è¡¡ç®—æ³• å°‘ å¤š K8S æ”¯æŒ é»˜è®¤ éœ€è¦å®‰è£…æ¨¡å—æˆ–åˆ‡æ¢æ¨¡å¼ Kubernetes åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­å¼ºçƒˆæ¨èé€‰æ‹© IPVS æ¨¡å¼çš„ kube-proxyã€‚\n"},{"id":52,"href":"/operations/jenkins/tutorial/","title":"Jenkins åŸºç¡€æ•™ç¨‹","parent":"Jenkins","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å…¨ã€ç»“æ„æ¸…æ™°ã€å¯ç›´æ¥æ”¶è—çš„ Jenkins å…¨å¥—çŸ¥è¯†ä½“ç³»ï¼ŒåŒ…æ‹¬æ¦‚å¿µã€å®‰è£…ã€Pipelineã€æµæ°´çº¿æœ€ä½³å®è·µã€è¿ç»´ã€é›†ç¾¤ã€æ•…éšœæ’æŸ¥ç­‰ï¼Œè®©ä½ ä¸€æ¬¡æ€§åƒé€ Jenkinsã€‚\n1. Jenkins æ˜¯ä»€ä¹ˆï¼Ÿ Jenkins æ˜¯æœ€å¸¸ç”¨çš„ CI/CD æŒç»­é›†æˆä¸æŒç»­äº¤ä»˜å¹³å°\nç‰¹ç‚¹ï¼š\nå…è´¹ã€å¼€æº æ’ä»¶ç”Ÿæ€è¶…ä¸°å¯Œ æ”¯æŒ Pipeline as Codeï¼ˆJenkinsfileï¼‰ æ”¯æŒåˆ†å¸ƒå¼æ„å»ºï¼ˆMaster + Agentï¼‰ 2. Jenkins åŸºç¡€æ¦‚å¿µ æ¦‚å¿µ è¯´æ˜ Masterï¼ˆControllerï¼‰ è´Ÿè´£ UIã€ç®¡ç†ä»»åŠ¡ã€è°ƒåº¦æ„å»º Agentï¼ˆWorkerï¼‰ å®é™…æ‰§è¡Œæ„å»º Job / Project æ„å»ºä»»åŠ¡ï¼ŒFreestyle/ Pipeline Pipeline ç”¨ Groovy DSL å†™çš„æµæ°´çº¿ Stage æµæ°´çº¿çš„å¤§æ­¥éª¤ Step æ¯ä¸€æ­¥æ‰§è¡Œçš„å‘½ä»¤ Node æŒ‡å®šæ„å»ºåœ¨å“ªä¸ª agent ä¸Šè·‘ Label ç»™ agent æ‰“æ ‡ç­¾ï¼Œè®© pipeline é€‰æ‹© 3. Jenkins å®‰è£…æ–¹å¼ âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰ docker run -d \\ -p 8080:8080 \\ -p 50000:50000 \\ -v jenkins_home:/var/jenkins_home \\ jenkins/jenkins:lts æ–¹å¼äºŒï¼šLinux å®‰è£…ï¼ˆUbuntuï¼‰ apt update apt install openjdk-17-jdk -y wget -q -O - https://pkg.jenkins.io/debian/jenkins.io.key | sudo apt-key add - echo deb http://pkg.jenkins.io/debian binary/ \u0026gt; /etc/apt/sources.list.d/jenkins.list apt update apt install jenkins systemctl enable --now jenkins æ–¹å¼ä¸‰ï¼šKubernetesï¼ˆä¼ä¸šçº§ï¼‰ ä½¿ç”¨ Helmï¼š\nhelm repo add jenkins https://charts.jenkins.io helm install my-jenkins jenkins/jenkins 4. Jenkins æ’ä»¶ï¼ˆå¿…è£…æ¸…å•ï¼‰ æ’ä»¶ ç”¨é€” Pipeline Jenkinsfile æµæ°´çº¿åŸºç¡€ Git / GitHub Git SCM æ”¯æŒ Credentials Binding å‡­è¯ç»‘å®š Blue Ocean æ›´ç›´è§‚çš„ UI Docker Pipeline ä½¿ç”¨ Docker Kubernetes Plugin åŠ¨æ€ Agent Email-ext é‚®ä»¶é€šçŸ¥ AnsiColor æ§åˆ¶å°å½©è‰²è¾“å‡º 5. Jenkins Pipeline æ•™ç¨‹ï¼ˆä»é›¶åˆ°ç²¾é€šï¼‰ ğŸ”· æœ€ç®€ Jenkinsfileï¼ˆç¤ºä¾‹ï¼‰ pipeline { agent any stages { stage(\u0026#39;Build\u0026#39;) { steps { echo \u0026#34;Building...\u0026#34; } } stage(\u0026#39;Test\u0026#39;) { steps { echo \u0026#34;Testing...\u0026#34; } } stage(\u0026#39;Deploy\u0026#39;) { steps { echo \u0026#34;Deploying...\u0026#34; } } } } ğŸ”· æŒ‡å®š Agent agent { label \u0026#39;linux\u0026#39; } ğŸ”· ä½¿ç”¨å¤šä¸ª Agent stage(\u0026#39;Test on different OS\u0026#39;) { matrix { axes { axis { name \u0026#39;OS\u0026#39;; values \u0026#39;linux\u0026#39;, \u0026#39;windows\u0026#39; } } agent { label \u0026#34;${OS}\u0026#34; } stages { stage(\u0026#39;Run Tests\u0026#39;) { steps { echo \u0026#34;Run test on ${OS}\u0026#34; } } } } } ğŸ”· ç¯å¢ƒå˜é‡ environment { VERSION = \u0026#34;1.0.0\u0026#34; } ğŸ”· ä½¿ç”¨å‡­è¯ï¼ˆä¾‹å¦‚ Git Tokenï¼‰ withCredentials([string(credentialsId: \u0026#39;github-token\u0026#39;, variable: \u0026#39;TOKEN\u0026#39;)]) { sh \u0026#34;git clone https://token:${TOKEN}@github.com/xxx/xxx.git\u0026#34; } ğŸ”· Docker æ„å»º pipeline { agent any stages { stage(\u0026#39;Docker Build\u0026#39;) { steps { script { docker.build(\u0026#34;myapp:${BUILD_NUMBER}\u0026#34;) } } } } } 6. CI/CD å®æˆ˜ï¼ˆç”Ÿäº§çº§ï¼‰ ğŸŒŸ æ„å»º + æµ‹è¯• + æ‰“åŒ…é•œåƒ + æ¨é€ + éƒ¨ç½² K8S pipeline { agent any stages { stage(\u0026#39;Checkout\u0026#39;) { steps { checkout scm } } stage(\u0026#39;Build\u0026#39;) { steps { sh \u0026#34;python3 -m build\u0026#34; } } stage(\u0026#39;Unit Test\u0026#39;) { steps { sh \u0026#34;pytest tests/\u0026#34; } } stage(\u0026#39;Docker Build \u0026amp; Push\u0026#39;) { steps { script { docker.withRegistry(\u0026#34;https://registry.xxx.com\u0026#34;, \u0026#34;harbor-cred\u0026#34;) { def image = docker.build(\u0026#34;myapp:${env.BUILD_NUMBER}\u0026#34;) image.push() } } } } stage(\u0026#39;Deploy to K8S\u0026#39;) { steps { sh \u0026#34;\u0026#34;\u0026#34; kubectl set image deployment/myapp myapp=myapp:${BUILD_NUMBER} kubectl rollout status deployment/myapp \u0026#34;\u0026#34;\u0026#34; } } } } 7. Jenkins è¿ç»´ä¸ä¼˜åŒ– æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š\nJenkins Home æ”¾ SSD å®šæœŸæ¸…ç†æ„å»ºå†å² æ’ä»¶æ•°é‡æ§åˆ¶åœ¨ \u0026lt; 40 ä½¿ç”¨ä¸“é—¨çš„ agent æ‰§è¡Œé‡ä»»åŠ¡ï¼ˆå¦‚ Dockerï¼‰ JVM å‚æ•°è°ƒæ•´ï¼ˆå¦‚ heap 2-4Gï¼‰ ç¤ºä¾‹ /etc/default/jenkinsï¼š\nJAVA_ARGS=\u0026#34;-Xms1g -Xmx4g -XX:+UseG1GC\u0026#34; 8. Jenkins é›†ç¾¤ï¼ˆMaster + Agentï¼‰ Agent è¿æ¥æ–¹å¼ï¼š\nSSH JNLP Docker Agent Kubernetes åŠ¨æ€ Agentï¼ˆä¼ä¸šæœ€æ¨èï¼‰ K8S åŠ¨æ€ Agent ç¤ºä¾‹ï¼š\nspec: containers: - name: jnlp image: jenkins/inbound-agent args: [\u0026#39;$(JENKINS_SECRET)\u0026#39;, \u0026#39;$(JENKINS_NAME)\u0026#39;] 9. Jenkins å¸¸è§æ•…éšœæ’æŸ¥ ğŸ”¥ 1. æ„å»ºå¡ä½ä¸åŠ¨ åŸå› ï¼š\nAgent ç¦»çº¿ ç½‘ç»œé—®é¢˜ Workspace è¢«é”æ­» è§£å†³ï¼š\nManage Jenkins -\u0026gt; Nodes -\u0026gt; é‡è¿ Agent ğŸ”¥ 2. Git æ‹‰å–å¤±è´¥ åŸå› ï¼š\nå‡­è¯é”™è¯¯ Token è¿‡æœŸ Git æœåŠ¡å™¨ç½‘ç»œé—®é¢˜ è§£å†³ï¼š\næ£€æŸ¥ Credentials é‡æ–°ç»‘å®š Token ğŸ”¥ 3. æ’ä»¶å†²çª è§£å†³ï¼š\næŸ¥çœ‹ /var/jenkins_home/logs/all* ç¦ç”¨å†²çªæ’ä»¶ å‡çº§ Jenkins æ ¸å¿ƒç‰ˆæœ¬ 10 Jenkins æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ æ‰€æœ‰ Job ç”¨ Pipelineï¼Œä¸ç”¨ Freestyle Docker é‡Œæ‰§è¡Œæ„å»ºï¼Œä¿æŒç¯å¢ƒä¸€è‡´ å°† Jenkinsfile æ”¾å…¥ Git ä½¿ç”¨ Kubernetes åŠ¨æ€ Agentï¼ˆæˆæœ¬æœ€ä½ï¼‰ å‡­è¯ç»Ÿä¸€æ”¾ Credentialsï¼Œä¸å†™æ­» Job åˆ†é˜¶æ®µï¼Œå¯è§‚å¯Ÿæ€§å¼º é€šçŸ¥é’‰é’‰ / ä¼ä¸šå¾®ä¿¡ / Slack ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å…¨ã€ç»“æ„æ¸…æ™°ã€å¯ç›´æ¥æ”¶è—çš„ Jenkins å…¨å¥—çŸ¥è¯†ä½“ç³»ï¼ŒåŒ…æ‹¬æ¦‚å¿µã€å®‰è£…ã€Pipelineã€æµæ°´çº¿æœ€ä½³å®è·µã€è¿ç»´ã€é›†ç¾¤ã€æ•…éšœæ’æŸ¥ç­‰ï¼Œè®©ä½ ä¸€æ¬¡æ€§åƒé€ Jenkinsã€‚\n1. Jenkins æ˜¯ä»€ä¹ˆï¼Ÿ Jenkins æ˜¯æœ€å¸¸ç”¨çš„ CI/CD æŒç»­é›†æˆä¸æŒç»­äº¤ä»˜å¹³å°\nç‰¹ç‚¹ï¼š\nå…è´¹ã€å¼€æº æ’ä»¶ç”Ÿæ€è¶…ä¸°å¯Œ æ”¯æŒ Pipeline as Codeï¼ˆJenkinsfileï¼‰ æ”¯æŒåˆ†å¸ƒå¼æ„å»ºï¼ˆMaster + Agentï¼‰ 2. Jenkins åŸºç¡€æ¦‚å¿µ æ¦‚å¿µ è¯´æ˜ Masterï¼ˆControllerï¼‰ è´Ÿè´£ UIã€ç®¡ç†ä»»åŠ¡ã€è°ƒåº¦æ„å»º Agentï¼ˆWorkerï¼‰ å®é™…æ‰§è¡Œæ„å»º Job / Project æ„å»ºä»»åŠ¡ï¼ŒFreestyle/ Pipeline Pipeline ç”¨ Groovy DSL å†™çš„æµæ°´çº¿ Stage æµæ°´çº¿çš„å¤§æ­¥éª¤ Step æ¯ä¸€æ­¥æ‰§è¡Œçš„å‘½ä»¤ Node æŒ‡å®šæ„å»ºåœ¨å“ªä¸ª agent ä¸Šè·‘ Label ç»™ agent æ‰“æ ‡ç­¾ï¼Œè®© pipeline é€‰æ‹© 3. Jenkins å®‰è£…æ–¹å¼ âœ… æ–¹å¼ä¸€ï¼šä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰ docker run -d \\ -p 8080:8080 \\ -p 50000:50000 \\ -v jenkins_home:/var/jenkins_home \\ jenkins/jenkins:lts æ–¹å¼äºŒï¼šLinux å®‰è£…ï¼ˆUbuntuï¼‰ apt update apt install openjdk-17-jdk -y wget -q -O - https://pkg.jenkins.io/debian/jenkins.io.key | sudo apt-key add - echo deb http://pkg.jenkins.io/debian binary/ \u0026gt; /etc/apt/sources.list.d/jenkins.list apt update apt install jenkins systemctl enable --now jenkins æ–¹å¼ä¸‰ï¼šKubernetesï¼ˆä¼ä¸šçº§ï¼‰ ä½¿ç”¨ Helmï¼š\n"},{"id":53,"href":"/operations/jenkins/core/","title":"Jenkins æ ¸å¿ƒæ¦‚å¿µ","parent":"Jenkins","content":" ä¸€ã€Jenkins æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæœ¬è´¨è®¤çŸ¥ï¼‰ 1ï¸âƒ£ Jenkins çš„æœ¬è´¨ Jenkins = ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ + æ‰§è¡Œçš„è‡ªåŠ¨åŒ–å¹³å°\nJenkins æœ¬èº«ä¸å…³å¿ƒä½ æ˜¯ Java / Python / Go / å‰ç«¯\nå®ƒåªå…³å¿ƒä¸‰ä»¶äº‹ï¼š\nä»€ä¹ˆæ—¶å€™æ‰§è¡Œ åœ¨å“ªæ‰§è¡Œ æ‰§è¡Œä»€ä¹ˆ 2ï¸âƒ£ Jenkins è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœ¨ Jenkins å‡ºç°ä¹‹å‰ï¼Œå¼€å‘æµç¨‹æ˜¯ï¼š\nå†™ä»£ç  -\u0026gt; æ‰‹åŠ¨ build -\u0026gt; æ‰‹åŠ¨ test -\u0026gt; æ‰‹åŠ¨ deploy -\u0026gt; å‡ºé—®é¢˜å›æ»š Jenkins å‡ºç°ä¹‹åï¼š\ngit push -\u0026gt; Jenkins è‡ªåŠ¨ build -\u0026gt; test -\u0026gt; deploy -\u0026gt; é€šçŸ¥ æ ¸å¿ƒç›®æ ‡ï¼š\nå‡å°‘äººä¸ºæ“ä½œ æé«˜äº¤ä»˜é¢‘ç‡ é™ä½å‘å¸ƒé£é™© æµç¨‹å¯è¿½æº¯ã€å¯å›æ»š äºŒã€Jenkins æ¶æ„æ ¸å¿ƒæ¦‚å¿µ 3ï¸âƒ£ Controllerï¼ˆMasterï¼‰ Jenkins 2.x å®˜æ–¹ç§°å‘¼ï¼šController\nèŒè´£ï¼š\næä¾› Web UI ç®¡ç† Job / Pipeline è°ƒåº¦æ„å»ºä»»åŠ¡ ç®¡ç†æ’ä»¶ ç®¡ç† Credentials ä¸ Agent é€šä¿¡ âš ï¸ æœ€ä½³å®è·µï¼š\nController ä¸æ‰§è¡Œæ„å»ºä»»åŠ¡ï¼ˆexecutor = 0ï¼‰\n4ï¸âƒ£ Agentï¼ˆNodeï¼‰ å®é™…æ‰§è¡Œæ„å»ºä»»åŠ¡çš„å·¥ä½œèŠ‚ç‚¹\nç‰¹ç‚¹ï¼š\nå¯ä»¥æ˜¯ç‰©ç†æœº / è™šæ‹Ÿæœº / å®¹å™¨ æ”¯æŒ Linux / Windows / macOS å¯æ ¹æ® Label æŒ‡å®šæ‰§è¡Œç¯å¢ƒ å¸¸è§ç±»å‹ï¼š\nSSH Agent JNLP Agent Docker Agent Kubernetes Agentï¼ˆåŠ¨æ€ Podï¼‰ 5ï¸âƒ£ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰ Executor = å¹¶è¡Œæ‰§è¡Œèƒ½åŠ›\næ¯ä¸ª Agent å¯è®¾ç½®å¤šä¸ª executor ä¸€ä¸ª executor åŒæ—¶åªèƒ½è·‘ä¸€ä¸ª Job executor = 0 -\u0026gt; ä¸æ‰§è¡Œä»»ä½•æ„å»º ç”Ÿäº§å»ºè®®ï¼š\nControllerï¼š0 Agentï¼š1ï½4ï¼ˆçœ‹ CPU / IOï¼‰ 6ï¸âƒ£ Labelï¼ˆæ ‡ç­¾ï¼‰ ç”¨äº ç²¾å‡†è°ƒåº¦ Job åˆ°æŒ‡å®š Agent\nä¾‹ï¼š\nlinux docker java node k8s Pipeline ä¸­ä½¿ç”¨ï¼š\nagent { label \u0026#39;docker\u0026#39; } ä¸‰ã€Jenkins Job \u0026amp; Pipeline æ ¸å¿ƒæ¦‚å¿µ 7ï¸âƒ£ Jobï¼ˆé¡¹ç›®ï¼‰ Job = Jenkins ä¸­çš„ä¸€ä¸ªä»»åŠ¡å®šä¹‰\nå¸¸è§ Job ç±»å‹ï¼š\nç±»å‹ è¯´æ˜ Freestyle è€å¼ä»»åŠ¡ï¼ˆå·²ä¸æ¨èï¼‰ Pipeline Jenkinsfile é©±åŠ¨ Multibranch Pipeline å¤šåˆ†æ”¯è‡ªåŠ¨åŒ– Folder ç»„ç»‡ Job Organization Folder GitHub/GitLab ç»„ç»‡ ç°ä»£ Jenkins = Pipeline + Multibranch Pipeline\n8ï¸âƒ£ Pipelineï¼ˆæµæ°´çº¿ï¼‰ Pipeline = ä¸€æ¡å®Œæ•´çš„ CI/CD æµç¨‹\nç‰¹ç‚¹ï¼š\nä»£ç åŒ–ï¼ˆPipeline as Codeï¼‰ å¯ç‰ˆæœ¬æ§åˆ¶ å¯ review å¯å¤ç° Pipeline å®šä¹‰åœ¨ Jenkinsfile ä¸­ã€‚\n9ï¸âƒ£ Declarative vs Scripted Pipeline ä¸¤ç§ Pipeline æ¨¡å¼ï¼š\nç±»å‹ ç‰¹ç‚¹ Declarative ç»“æ„æ¸…æ™°ã€ç®€å•ã€æ¨è Scripted çµæ´»ã€åŸºäº Groovy Declarative ç¤ºä¾‹ï¼š\npipeline { agent any stages { stage(\u0026#39;Build\u0026#39;) { steps { echo \u0026#39;build\u0026#39; } } } } ğŸ”Ÿ Stage / Step / Stage View Stageï¼šé€»è¾‘é˜¶æ®µï¼ˆBuild / Test / Deployï¼‰ Stepï¼šå…·ä½“å‘½ä»¤ Stage Viewï¼šå¯è§†åŒ–æµç¨‹ å››ã€æºç ç®¡ç†ï¼ˆSCMï¼‰ä¸è§¦å‘æœºåˆ¶ 1ï¸âƒ£1ï¸âƒ£ SCMï¼ˆSource Code Managementï¼‰ Jenkins æ”¯æŒï¼š\nGitï¼ˆæœ€å¸¸ç”¨ï¼‰ GitHub / GitLab / Bitbucket SVN SCM åªè´Ÿè´£ï¼šä»£ç æ¥æº\n1ï¸âƒ£2ï¸âƒ£ è§¦å‘æ–¹å¼ï¼ˆTriggersï¼‰ å¸¸è§è§¦å‘æœºåˆ¶ï¼š\næ–¹å¼ è¯´æ˜ æ‰‹åŠ¨ ç‚¹å‡» Build Webhook Git push è‡ªåŠ¨è§¦å‘ Poll SCM å®šæœŸæ‹‰å– cron å®šæ—¶æ„å»º PR Trigger Pull Request ç”Ÿäº§åªæ¨è Webhook + cron\näº”ã€Credentialsï¼ˆå‡­æ®ï¼‰æ ¸å¿ƒç†è®º 1ï¸âƒ£3ï¸âƒ£ Credentials æ˜¯ä»€ä¹ˆï¼Ÿ Jenkins ç»Ÿä¸€çš„å¯†é’¥ç®¡ç†ç³»ç»Ÿ\næ”¯æŒï¼š\nç”¨æˆ·å + å¯†ç  SSH ç§é’¥ Token æ–‡ä»¶ï¼ˆkubeconfigï¼‰ æ ¸å¿ƒåŸåˆ™ï¼š\nä¸æŠŠå¯†é’¥å†™åœ¨ Jenkinsfile ä¸­\n1ï¸âƒ£4ï¸âƒ£ Credentials Scopeï¼ˆä½œç”¨åŸŸï¼‰ Global Folder Job Domain ç”Ÿäº§æ¨èï¼š\nGlobal credentials (unrestricted)\nå…­ã€Jenkins æ‰§è¡Œæ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£5ï¸âƒ£ Jenkins æ‰§è¡Œæµç¨‹ è§¦å‘ -\u0026gt; æ’é˜Ÿ -\u0026gt; åˆ†é… Agent -\u0026gt; åˆ†é… Executor -\u0026gt; æ‰§è¡Œ Pipeline -\u0026gt; ç»“æœå­˜å‚¨\nå¦‚æœå¡ä½ï¼Œæ’æŸ¥é¡ºåºï¼š\nQueue Agent åœ¨çº¿çŠ¶æ€ Executor æ•°é‡ Workspace é” 1ï¸âƒ£6ï¸âƒ£ Workspace Workspace = æ„å»ºç›®å½•\nç‰¹ç‚¹ï¼š\næ¯ä¸ª Job / Branch ä¸€ä¸ª workspace æ”¯æŒå¹¶å‘æ„å»º å¯èƒ½è¢«é”ä½ å¸¸ç”¨æ¸…ç†ï¼š\ncleanWs()\nä¸ƒã€æ’ä»¶ç³»ç»Ÿï¼ˆPlugin Systemï¼‰ 1ï¸âƒ£7ï¸âƒ£ æ’ä»¶çš„ä½œç”¨ Jenkins = æ ¸å¿ƒ + æ’ä»¶\næ’ä»¶è´Ÿè´£ï¼š\nGit Docker Kubernetes Credentials UI é€šçŸ¥ âš ï¸ æ’ä»¶è¿‡å¤š = ä¸ç¨³å®š\nä¼ä¸šå»ºè®® \u0026lt; 40 ä¸ª\nå…«ã€åˆ†å¸ƒå¼ä¸äº‘åŸç”Ÿ 1ï¸âƒ£8ï¸âƒ£ Jenkins åˆ†å¸ƒå¼æ„å»º é€šè¿‡å¤šä¸ª Agent å®ç°ï¼š\næ¨ªå‘æ‰©å±• èµ„æºéš”ç¦» å¤šç¯å¢ƒæ„å»º 1ï¸âƒ£9ï¸âƒ£ Jenkins on Kubernetes æ ¸å¿ƒæ€æƒ³ï¼š\nJenkins Controller ç¨³å®šè¿è¡Œ Agent æŒ‰éœ€åˆ›å»º Podï¼Œç”¨å®Œå³é”€æ¯ ä¼˜åŠ¿ï¼š\nå¼¹æ€§ å¹²å‡€ æˆæœ¬ä½ äº‘åŸç”Ÿ ä¹ã€å¯é æ€§ã€ç¨³å®šæ€§ä¸å®‰å…¨ 2ï¸âƒ£0ï¸âƒ£ Jenkins ç¨³å®šæ€§ä¸‰åŸåˆ™ Controller ä¸è·‘ Job Agent æ— çŠ¶æ€ Jenkinsfile ç®€æ´ 2ï¸âƒ£1ï¸âƒ£ Jenkins å®‰å…¨æ¨¡å‹ RBAC Credentials åŠ å¯†å­˜å‚¨ Script Approval CSRF é˜²æŠ¤ HTTPS åã€æ€»ç»“ Jenkins æ˜¯ä¸€ä¸ªä»¥ Pipeline ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡ Controller è°ƒåº¦ã€Agent æ‰§è¡Œã€æ’ä»¶æ‰©å±•ï¼Œå®ç° CI/CD è‡ªåŠ¨åŒ–çš„ä»»åŠ¡è°ƒåº¦å¹³å°ã€‚\n","description":" ä¸€ã€Jenkins æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæœ¬è´¨è®¤çŸ¥ï¼‰ 1ï¸âƒ£ Jenkins çš„æœ¬è´¨ Jenkins = ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ + æ‰§è¡Œçš„è‡ªåŠ¨åŒ–å¹³å°\nJenkins æœ¬èº«ä¸å…³å¿ƒä½ æ˜¯ Java / Python / Go / å‰ç«¯\nå®ƒåªå…³å¿ƒä¸‰ä»¶äº‹ï¼š\nä»€ä¹ˆæ—¶å€™æ‰§è¡Œ åœ¨å“ªæ‰§è¡Œ æ‰§è¡Œä»€ä¹ˆ 2ï¸âƒ£ Jenkins è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœ¨ Jenkins å‡ºç°ä¹‹å‰ï¼Œå¼€å‘æµç¨‹æ˜¯ï¼š\n"},{"id":54,"href":"/operations/kafka/tutorial/","title":"Kafka åŸºç¡€æ•™ç¨‹","parent":"Kafka","content":" 1. Kafka æ˜¯ä»€ä¹ˆï¼Ÿ Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€é«˜ååã€å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºï¼š\næ—¥å¿—é‡‡é›†ï¼ˆLog Collectï¼‰ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰ æµå¼å¤„ç†ï¼ˆStreamingï¼‰ æ—¥å¿—æŒä¹…åŒ–ï¼ˆCommit Logï¼‰ ç³»ç»Ÿè§£è€¦ï¼ˆå¾®æœåŠ¡è§£è€¦ï¼‰ ç®€å•ç†è§£ï¼š\nKafka å°±æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„â€œæ¶ˆæ¯ä¸­è½¬ç«™â€ï¼Œè®©ç³»ç»Ÿä¹‹é—´è§£è€¦ï¼Œå¹¶èƒ½æŒä¹…åŒ–æµ·é‡æ•°æ®ã€‚\n2. Kafka çš„æ ¸å¿ƒè§’è‰²ï¼ˆ5 å¤§ç»„ä»¶ï¼‰ 2.1 Producerï¼ˆç”Ÿäº§è€…ï¼‰ è´Ÿè´£å‘é€æ¶ˆæ¯åˆ° Kafka çš„ Topicã€‚\nå¯é…ç½®ï¼š\næ¶ˆæ¯æ˜¯å¦è‡ªåŠ¨é‡è¯• æ¶ˆæ¯æ˜¯å¦å‹ç¼© æ¶ˆæ¯æ˜¯å¦æœ‰åºï¼ˆæŒ‰åˆ†åŒºï¼‰ æ˜¯å¦è¦æ±‚è¿”å› ACKï¼ˆä¿è¯å¯é æ€§ï¼‰ 2.2 Brokerï¼ˆKafka æœåŠ¡å™¨èŠ‚ç‚¹ï¼‰ Kafka é›†ç¾¤ä¸­çš„æ¯å°æœåŠ¡å™¨å°±æ˜¯ä¸€ä¸ª Brokerã€‚\nä¸»è¦åŠŸèƒ½ï¼š\nå­˜å‚¨æ¶ˆæ¯ï¼ˆcommit logï¼‰ ä¸ºç”Ÿäº§è€…/æ¶ˆè´¹è€…æä¾›è¯»å†™æœåŠ¡ ç®¡ç†åˆ†åŒºã€å‰¯æœ¬ ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¼šæœ‰ï¼š\n3~9 ä¸ª Brokerï¼ˆä¿è¯é«˜å¯ç”¨ + æ‰©å±•ï¼‰ 2.3 Topicï¼ˆä¸»é¢˜ï¼‰ Kafka ä¸­æ•°æ®æŒ‰ä¸»é¢˜åˆ†ç±»ã€‚\nç±»ä¼¼ç›®å½•æˆ–è¡¨ï¼š\nä¸€ä¸ª Topic = é«˜é¢‘å†™ + é«˜é¢‘è¯»çš„æ¶ˆæ¯é›†åˆ ä¾‹ï¼š\norder_created user_login_events Topic å¯ä»¥æ‹†åˆ†æˆ å¤šä¸ª Partitionï¼ˆåˆ†åŒºï¼‰ä»¥æå‡ååé‡ã€‚\n2.4 Partitionï¼ˆåˆ†åŒºï¼‰ \u0026lt;- Kafka é«˜æ€§èƒ½çš„å…³é”® æ¯ä¸ª Topic åŒ…å«è‹¥å¹² Partitionï¼Œæ¯ä¸ª Partition æ˜¯ ä¸€ä¸ªæœ‰åºã€æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚\nç¤ºä¾‹\nTopicï¼šorder\nåˆ†åŒºï¼š\norder-0 order-1 order-2 ç‰¹ç‚¹ï¼š\nåˆ†åŒºå†…æ¶ˆæ¯æœ‰åº åˆ†åŒºé—´æ¶ˆæ¯æ— åº Kafka ååé‡ â‰ˆ åˆ†åŒºæ•° * å•åˆ†åŒºåå Kafka çš„æ€§èƒ½æ‰©å±•æ–¹å¼ï¼š\næƒ³æå‡æ€§èƒ½ -\u0026gt; åŠ  Partition æƒ³æå‡é«˜å¯ç”¨ -\u0026gt; åŠ å‰¯æœ¬ï¼ˆReplicaï¼‰ 2.5 Consumer \u0026amp; Consumer Groupï¼ˆæ¶ˆè´¹è€… / æ¶ˆè´¹è€…ç»„ï¼‰ Consumerï¼šè¯»å–æ¶ˆæ¯çš„å®¢æˆ·ç«¯\nConsumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰\nå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç»„æˆä¸€ä¸ª Group æ¥å…±åŒæ¶ˆè´¹ Topicã€‚\nä¸€ä¸ªåˆ†åŒºåªä¼šè¢«åŒä¸€ Group ä¸­çš„ä¸€ä¸ª Consumer æ¶ˆè´¹ã€‚\nå³ï¼š\nGroup å†…æ¶ˆè´¹è€… = å¹¶å‘æ¶ˆè´¹èƒ½åŠ› å¤šä¸ª Group = å¹¿æ’­æ¨¡å¼ ä¾‹ï¼š\nTopic åˆ† 3 ä¸ªåˆ†åŒº Group A æœ‰ 3 ä¸ªæ¶ˆè´¹è€… -\u0026gt; åˆšå¥½æ¯äººæ¶ˆè´¹ä¸€ä¸ªåˆ†åŒºï¼ˆå¹¶å‘æœ€å¤§ï¼‰ 3. Kafka æ¶ˆæ¯å­˜å‚¨æœºåˆ¶ï¼ˆCommit Logï¼‰ Kafka å°†æ¯ä¸ªåˆ†åŒºçš„æ•°æ®ä¿å­˜ä¸ºä¸€ä¸ªç›®å½•ï¼š\n/kafka-logs/order-0 åº•å±‚ä½¿ç”¨ä¸¤ç§æ–‡ä»¶ï¼š\n.logï¼šæ¶ˆæ¯å†…å®¹ .indexï¼šç´¢å¼•ï¼ŒåŠ é€ŸæŸ¥æ‰¾ å†™å…¥æ˜¯ï¼š\né¡ºåºå†™ç£ç›˜ï¼ˆéå¸¸å¿«ï¼‰ åˆ©ç”¨é¡µç¼“å­˜ï¼ˆPageCacheï¼‰ é›¶æ‹·è´ï¼ˆZero-copyï¼‰æå‡è¯»é€Ÿåº¦ å› æ­¤ Kafka èƒ½è½»æ¾è¾¾åˆ°ç™¾ä¸‡ QPSã€‚\n4. Offsetï¼ˆæ¶ˆæ¯åç§»é‡ï¼‰ æ¯ä¸ª partition å†…ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªé€’å¢ IDï¼š\n0, 1, 2, 3, 4, ... æ¶ˆè´¹è€…è®°å½•è‡ªå·±æ¶ˆè´¹åˆ°çš„ä½ç½®ï¼ˆoffsetï¼‰ï¼š\nOffset æ˜¯æ¶ˆè´¹è€…çš„è¿›åº¦ï¼Œä¸æ˜¯ Kafka çš„ã€‚ å¥½å¤„ï¼š\næ¯ä¸ª Group éƒ½æœ‰è‡ªå·±çš„æ¶ˆè´¹è¿›åº¦ï¼ˆäº’ä¸å½±å“ï¼‰ å¯å›æº¯æ¶ˆè´¹ï¼ˆé‡ç½® Offsetï¼‰ 5. å‰¯æœ¬æœºåˆ¶ï¼ˆReplicaï¼‰ æ¯ä¸ª Partition å¯ä»¥è®¾ç½®å¤šå‰¯æœ¬ï¼Œå¦‚ï¼š\nreplication.factor = 3 åˆ†ä¸ºï¼š\nLeaderï¼ˆä¸»å‰¯æœ¬ï¼‰ Followerï¼ˆåŒæ­¥å‰¯æœ¬ï¼‰ æ‰€æœ‰è¯»å†™éƒ½åœ¨ Leader è¿›è¡Œã€‚\nFollower åŒæ­¥ Leader çš„æ•°æ®ã€‚\n6. ISRï¼ˆIn-Sync Replicasï¼‰ ISR = åŒæ­¥é€Ÿåº¦æ­£å¸¸çš„å‰¯æœ¬é›†åˆã€‚\nåªæœ‰åœ¨ ISR ä¸­çš„ follower æ‰ç®—â€œå¥åº·â€ã€‚\nå½“ ISR æ‰åˆ°åªå‰© 1ï¼ˆLeader è‡ªèº«ï¼‰æ—¶ï¼Œä¼šå‡ºç°é£é™©åœºæ™¯ï¼š\n-\u0026gt; æ— æ³•ä¿è¯å¼ºä¸€è‡´ï¼ˆacks=all ä¹Ÿå¯èƒ½ä¸¢æ¶ˆæ¯ï¼‰ 7. ACK æœºåˆ¶ï¼ˆæ¶ˆæ¯å¯é æ€§ï¼‰ Producer å¯é…ç½®ï¼š\nacks=0\nä¸ç­‰å¾… Kafka è¿”å›\n-\u0026gt; æ€§èƒ½é«˜ä½†å¯èƒ½ä¸¢æ¶ˆæ¯ acks=1\nç­‰å¾… Leader å†™æˆåŠŸ\n-\u0026gt; Leader å®•æœºä¼šä¸¢æ¶ˆæ¯ acks=allï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰\nLeader + ISR ä¸­å…¨éƒ¨ follower å†™æˆåŠŸ\n-\u0026gt; æœ€å®‰å…¨ -\u0026gt; æ…¢ä¸€äº›ä½†å¯é  8. Rebalanceï¼ˆå†å‡è¡¡ï¼‰ å½“ Consumer Group ä¸­å‘ç”Ÿï¼š\næœ‰äººåŠ å…¥ æœ‰äººé€€å‡º åˆ†åŒºæ•°é‡å˜åŒ– Kafka ä¼šé‡æ–°åˆ†é…åˆ†åŒºç»™æ¶ˆè´¹è€…ï¼Œç§°ä¸ºï¼šRebalanceï¼ˆå†å‡è¡¡ï¼‰\nç¼ºç‚¹ï¼š\nRebalance æœŸé—´ï¼Œæ¶ˆè´¹æš‚åœ å¤§é‡ Group æ—¶å®¹æ˜“æŠ–åŠ¨ éœ€è¦è°ƒä¼˜ session.timeoutã€max.poll.interval ç­‰ã€‚\n9. KRaftï¼ˆæ–°æ¶æ„ï¼Œæ›¿ä»£ ZooKeeperï¼‰ Kafka 3.3 ä¹‹åå¼•å…¥ KRaftï¼š\nä¸å†ä¾èµ– ZooKeeper è‡ªå¸¦å…ƒæ•°æ®ç®¡ç† å¯åŠ¨é€Ÿåº¦æ›´å¿« æ¶æ„æ›´ç®€å• æœªæ¥ç”Ÿäº§é›†ç¾¤åŸºæœ¬éƒ½æ¨èï¼š\nKafka + KRaftï¼ˆæ—  ZooKeeper æ¨¡å¼ï¼‰\nğŸ”¥ Kafka åŸºç¡€æ¦‚å¿µæ€»ç»“ï¼ˆæœ€å…³é”® 10 ä¸ªç‚¹ï¼‰ Kafka = åˆ†å¸ƒå¼ã€é«˜ååã€å¯æŒä¹…åŒ–çš„æ¶ˆæ¯ç³»ç»Ÿ Topic = æ•°æ®åˆ†ç±» Partition = æå‡ååï¼Œå†…éƒ¨æ¶ˆæ¯æœ‰åº Producer å‘é€æ¶ˆæ¯åˆ°åˆ†åŒº Consumer Group æä¾›å¹¶å‘æ¶ˆè´¹èƒ½åŠ› Offset = æ¶ˆè´¹è¿›åº¦ Replicationï¼ˆå‰¯æœ¬ï¼‰ä¿è¯é«˜å¯ç”¨ ACK å†³å®šå¯é æ€§ Commit Log + é¡ºåºå†™æå‡æ€§èƒ½ KRaft å³å°†æˆä¸º Kafka ä¸»æµæ¶æ„ ","description":" 1. Kafka æ˜¯ä»€ä¹ˆï¼Ÿ Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€é«˜ååã€å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”¨äºï¼š\næ—¥å¿—é‡‡é›†ï¼ˆLog Collectï¼‰ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰ æµå¼å¤„ç†ï¼ˆStreamingï¼‰ æ—¥å¿—æŒä¹…åŒ–ï¼ˆCommit Logï¼‰ ç³»ç»Ÿè§£è€¦ï¼ˆå¾®æœåŠ¡è§£è€¦ï¼‰ ç®€å•ç†è§£ï¼š\nKafka å°±æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„â€œæ¶ˆæ¯ä¸­è½¬ç«™â€ï¼Œè®©ç³»ç»Ÿä¹‹é—´è§£è€¦ï¼Œå¹¶èƒ½æŒä¹…åŒ–æµ·é‡æ•°æ®ã€‚\n2. Kafka çš„æ ¸å¿ƒè§’è‰²ï¼ˆ5 å¤§ç»„ä»¶ï¼‰ 2.1 Producerï¼ˆç”Ÿäº§è€…ï¼‰ è´Ÿè´£å‘é€æ¶ˆæ¯åˆ° Kafka çš„ Topicã€‚\n"},{"id":55,"href":"/operations/kafka/core/","title":"Kafka æ ¸å¿ƒæ¦‚å¿µ","parent":"Kafka","content":" ä¸€ã€Kafka æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ Kafka æœ¬è´¨æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€æŒä¹…åŒ–ã€å¯è®¢é˜…çš„æ—¥å¿—ç³»ç»Ÿï¼ˆDistributed Commit Logï¼‰\nå®ƒä¸æ˜¯ä¼ ç»Ÿ MQï¼Œè€Œæ˜¯ï¼š\nå†™å¤šè¯»å¤š é¡ºåºè¿½åŠ  é•¿æ—¶é—´å­˜å‚¨ æ¶ˆè´¹è€…è‡ªå·±ç»´æŠ¤è¿›åº¦ ğŸ“Œ è¿™ä¸€å¥è¯æ˜¯ Kafka çš„â€œçµé­‚å®šä¹‰â€\näºŒã€Kafka ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆâ€œæ—¥å¿—ç³»ç»Ÿâ€ï¼Ÿ ä¼ ç»Ÿ MQï¼ˆRabbitMQï¼‰çš„é—®é¢˜ï¼š\næ¶ˆæ¯è¢«æ¶ˆè´¹å³åˆ é™¤ Broker è´Ÿè´£æ¶ˆæ¯çŠ¶æ€ æ‰©å±•æ€§å·® Kafka çš„é€‰æ‹©ï¼š\næ¶ˆæ¯æ°¸ä¹…å†™å…¥æ—¥å¿— æ¶ˆè´¹è¿›åº¦ç”± Consumer è‡ªå·±ç»´æŠ¤ Broker æ— çŠ¶æ€åŒ–ï¼ˆç›¸å¯¹ï¼‰ ğŸ‘‰ å¸¦æ¥ï¼š\né«˜åå å¯å›æ”¾ å¤šæ¶ˆè´¹ç»„ æ˜“æ‰©å±• ä¸‰ã€Kafka çš„æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ Broker Kafka çš„æœåŠ¡èŠ‚ç‚¹ï¼Œè´Ÿè´£å­˜å‚¨å’Œè½¬å‘æ•°æ®ã€‚\nä¸€ä¸ª Kafka é›†ç¾¤ = å¤šä¸ª Broker æ¯ä¸ª Broker ç®¡ç†å¤šä¸ª Partition Broker ä¹‹é—´æ— å…±äº«å­˜å‚¨ 2ï¸âƒ£ Topic Topic æ˜¯é€»è¾‘ä¸Šçš„æ¶ˆæ¯åˆ†ç±»ã€‚\nTopic æœ¬èº«ä¸å­˜æ•°æ® æ•°æ®å®é™…å­˜åœ¨ Partition ä¸­ ä¸€ä¸ª Topic = N ä¸ª Partition 3ï¸âƒ£ Partitionï¼ˆæœ€æ ¸å¿ƒï¼‰ Partition æ˜¯ Kafka å¹¶è¡Œã€é¡ºåºã€æ‰©å±•çš„æœ€å°å•ä½ã€‚\nç‰¹æ€§ï¼š\nä¸€ä¸ª Partition å†…æ¶ˆæ¯æœ‰åº Partition åªèƒ½ç”±ä¸€ä¸ª Consumer æ¶ˆè´¹ åå = åˆ†åŒºæ•° Ã— å•åˆ†åŒºèƒ½åŠ› ğŸ“Œ è®¾è®¡ Partition çš„ç›®çš„ï¼š\næé«˜åå å®ç°æ°´å¹³æ‰©å±• æ”¯æŒå¤š Consumer å¹¶è¡Œ 4ï¸âƒ£ Replicaï¼ˆå‰¯æœ¬ï¼‰ æ¯ä¸ª Partition ä¼šæœ‰å¤šä¸ªå‰¯æœ¬ï¼Œç”¨äºé«˜å¯ç”¨ã€‚\nLeaderï¼šå¤„ç†è¯»å†™ Followerï¼šåŒæ­¥ Leader æ•°æ® å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒ Broker 5ï¸âƒ£ Leader / Follower Producer / Consumer åªä¸ Leader é€šä¿¡ Follower è´Ÿè´£æ‹‰å–æ•°æ® Leader æŒ‚äº† -\u0026gt; ISR é‡Œé€‰æ–° Leader å››ã€Kafka çš„ä¸€è‡´æ€§æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ Kafka ä¸æ˜¯å¼ºä¸€è‡´ç³»ç»Ÿï¼Œè€Œæ˜¯ï¼š\nåŸºäº ISR çš„é«˜ä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ¨¡å‹\nISRï¼ˆIn-Sync Replicasï¼‰ åŒæ­¥è¿›åº¦â€œè¶³å¤Ÿå¿«â€çš„å‰¯æœ¬é›†åˆ\nåªæœ‰ ISR æ‰æœ‰èµ„æ ¼ç«é€‰ Leader ISR è¿‡å° -\u0026gt; æ‹’ç»å†™å…¥ï¼ˆé…åˆé…ç½®ï¼‰ å…³é”®é…ç½®ï¼š\nmin.insync.replicas=2 acks=all LEO / HW\nLEOï¼šæ¯ä¸ªå‰¯æœ¬å†™å…¥åˆ°å“ªäº† HWï¼šæ‰€æœ‰ ISR éƒ½ç¡®è®¤çš„æ•°æ® ğŸ“Œ æ¶ˆè´¹è€…åªèƒ½è¯»åˆ° HW ä¹‹å‰çš„æ•°æ®\näº”ã€Kafka çš„è¯»å†™æ¨¡å‹ï¼ˆåº•å±‚æ ¸å¿ƒï¼‰ å†™å…¥æ¨¡å‹ï¼ˆProducer -\u0026gt; Brokerï¼‰\nProducer å‘é€æ¶ˆæ¯ Leader é¡ºåºå†™ç£ç›˜ï¼ˆAppendï¼‰ Follower æ‹‰å–æ•°æ® ISR è¾¾æ ‡ -\u0026gt; è¿”å› ACK ğŸ“Œ Kafka æ˜¯å…ˆå†™ç£ç›˜ï¼Œå†è¿”å›æˆåŠŸ\nè¯»å–æ¨¡å‹ï¼ˆConsumer -\u0026gt; Brokerï¼‰\nConsumer ä¸»åŠ¨æ‹‰å–ï¼ˆPullï¼‰ ä» Leader æ‹‰å–æ•°æ® ä½¿ç”¨ Page Cache + Zero Copy Consumer è‡ªå·±æäº¤ Offset å…­ã€ä¸ºä»€ä¹ˆ Kafka ç”¨ Pull è€Œä¸æ˜¯ Pushï¼Ÿ åŸå› ï¼š\nConsumer è‡ªæ§é€Ÿç‡ é¿å… Broker è¢«æ…¢æ¶ˆè´¹è€…æ‹–å® æ‰¹é‡æ‹‰å–æ•ˆç‡æ›´é«˜ ä¸€å¥è¯è®°å¿†ï¼š\nKafka æŠŠâ€œæ…¢â€ç•™ç»™ Consumerï¼Œè€Œä¸æ˜¯ Broker\nä¸ƒã€Offset æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç”± Broker ç®¡ç†ï¼Ÿ Offset = æ¶ˆè´¹è¿›åº¦ï¼ˆé€»è¾‘ä½ç½®ï¼‰\nKafka çš„é€‰æ‹©ï¼š\nOffset å­˜åœ¨ Kafka å†…éƒ¨ Topicï¼ˆ__consumer_offsetsï¼‰ ç”± Consumer è‡ªå·±æäº¤ å¥½å¤„ï¼š\nå¤šæ¶ˆè´¹ç»„ æ¶ˆè´¹å›æ”¾ Broker æ— éœ€ç»´æŠ¤çŠ¶æ€ å…«ã€Kafka çš„é¡ºåºæ€§ä¿è¯åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ Kafka åªä¿è¯ï¼š\nåŒä¸€ Partition å†…æœ‰åº\nä¸ä¿è¯ï¼š\nTopic å…¨å±€æœ‰åº å¤š Partition æœ‰åº æƒ³è¦é¡ºåºï¼š\nç›¸åŒä¸šåŠ¡ key -\u0026gt; ç›¸åŒ Partition ä¸€ä¸ª Partition -\u0026gt; ä¸€ä¸ª Consumer çº¿ç¨‹ ä¹ã€Kafka çš„å­˜å‚¨æ¨¡å‹ï¼ˆéå¸¸æ ¸å¿ƒï¼‰ Log Segment\næ¯ä¸ª Partition æ˜¯ä¸€ä¸ªæ—¥å¿—ç›®å½• æŒ‰ segment æ–‡ä»¶åˆ‡åˆ† é¡ºåºè¿½åŠ å†™ æ–‡ä»¶ç±»å‹ï¼š\n.log æ•°æ® .index åç§»ç´¢å¼• .timeindex æ—¶é—´ç´¢å¼• æ•°æ®æ¸…ç†ç­–ç•¥ 1ï¸âƒ£ åˆ é™¤ï¼ˆDeleteï¼‰ log.cleanup.policy=delete\n2ï¸âƒ£ å‹ç¼©ï¼ˆCompactï¼‰ log.cleanup.policy=compact\nåã€Kafka ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ æ€»æ‹¬ï¼š\né¡ºåºå†™ç£ç›˜ + Page Cache + Zero Copy + æ‰¹é‡å¤„ç† + åˆ†åŒºå¹¶è¡Œ\nåä¸€ã€Kafka çš„æ¶ˆè´¹è¯­ä¹‰ è¯­ä¹‰ å®ç°æ–¹å¼ At most once å…ˆæäº¤ offset At least once å¤„ç†å®Œå†æäº¤ Exactly once å¹‚ç­‰ + äº‹åŠ¡ ğŸ“Œ Kafka é»˜è®¤æ˜¯ At least once\nåäºŒã€Kafka çš„å¯æ‰©å±•æ€§åŸç† Kafka æ‰©å±•çš„æ ¸å¿ƒï¼š\nTopic å¯åŠ  Partition Broker å¯æ°´å¹³æ‰©å®¹ Consumer ç»„è‡ªåŠ¨åˆ†é… Partition âš ï¸ ä½†æ³¨æ„ï¼š\næ‰© Broker ä¸ä¼šè‡ªåŠ¨è¿ç§»æ•°æ® éœ€è¦æ‰‹åŠ¨ reassignment åä¸‰ã€Kafka çš„é«˜å¯ç”¨è®¾è®¡ å‰¯æœ¬æœºåˆ¶ ISR Controller é€‰ä¸¾ Leader è‡ªåŠ¨åˆ‡æ¢ ğŸ“Œ Kafka æ˜¯â€œæ— å•ç‚¹â€çš„ï¼ˆController é™¤å¤–ï¼Œä½†å¯ HAï¼‰\nåå››ã€Kafka å’Œä¼ ç»Ÿ MQ çš„æ ¹æœ¬åŒºåˆ« ç»´åº¦ Kafka ä¼ ç»Ÿ MQ æ¨¡å‹ æ—¥å¿— é˜Ÿåˆ— æ•°æ®åˆ é™¤ ä¸åˆ  æ¶ˆè´¹å³åˆ  åå æé«˜ ä¸­ä½ å›æ”¾ æ”¯æŒ ä¸æ”¯æŒ å¤šè®¢é˜… åŸç”Ÿ å¤æ‚ åäº”ã€æ€»ç»“ Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ—¥å¿—ç³»ç»Ÿï¼Œé€šè¿‡ Topic å’Œ Partition å®ç°é«˜ååå’Œæ°´å¹³æ‰©å±•ï¼Œé€šè¿‡å‰¯æœ¬å’Œ ISR æœºåˆ¶ä¿è¯é«˜å¯ç”¨å’Œä¸€è‡´æ€§ã€‚\nå®ƒé‡‡ç”¨é¡ºåºå†™ç£ç›˜ã€Page Cache å’Œé›¶æ‹·è´å®ç°é«˜æ€§èƒ½ï¼Œæ¶ˆè´¹é‡‡ç”¨ Pull æ¨¡å‹ï¼ŒOffset ç”± Consumer ç®¡ç†ï¼Œä¿è¯çµæ´»çš„æ¶ˆè´¹è¯­ä¹‰ã€‚\n","description":" ä¸€ã€Kafka æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ Kafka æœ¬è´¨æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€æŒä¹…åŒ–ã€å¯è®¢é˜…çš„æ—¥å¿—ç³»ç»Ÿï¼ˆDistributed Commit Logï¼‰\nå®ƒä¸æ˜¯ä¼ ç»Ÿ MQï¼Œè€Œæ˜¯ï¼š\nå†™å¤šè¯»å¤š é¡ºåºè¿½åŠ  é•¿æ—¶é—´å­˜å‚¨ æ¶ˆè´¹è€…è‡ªå·±ç»´æŠ¤è¿›åº¦ ğŸ“Œ è¿™ä¸€å¥è¯æ˜¯ Kafka çš„â€œçµé­‚å®šä¹‰â€\näºŒã€Kafka ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆâ€œæ—¥å¿—ç³»ç»Ÿâ€ï¼Ÿ ä¼ ç»Ÿ MQï¼ˆRabbitMQï¼‰çš„é—®é¢˜ï¼š\næ¶ˆæ¯è¢«æ¶ˆè´¹å³åˆ é™¤ Broker è´Ÿè´£æ¶ˆæ¯çŠ¶æ€ æ‰©å±•æ€§å·® Kafka çš„é€‰æ‹©ï¼š\næ¶ˆæ¯æ°¸ä¹…å†™å…¥æ—¥å¿— æ¶ˆè´¹è¿›åº¦ç”± Consumer è‡ªå·±ç»´æŠ¤ Broker æ— çŠ¶æ€åŒ–ï¼ˆç›¸å¯¹ï¼‰ ğŸ‘‰ å¸¦æ¥ï¼š\né«˜åå å¯å›æ”¾ å¤šæ¶ˆè´¹ç»„ æ˜“æ‰©å±• ä¸‰ã€Kafka çš„æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ Broker Kafka çš„æœåŠ¡èŠ‚ç‚¹ï¼Œè´Ÿè´£å­˜å‚¨å’Œè½¬å‘æ•°æ®ã€‚\n"},{"id":56,"href":"/operations/kubernetes/tutorial/","title":"Kubernetes åŸºç¡€æ•™ç¨‹","parent":"Kubernetes","content":" ğŸ”· 0. Kubernetes 1.33 æ–°å˜åŒ–ï¼ˆé‡è¦ï¼‰ åœ¨ä»‹ç»æ ¸å¿ƒæ¦‚å¿µä¹‹å‰ï¼Œå…ˆè¯´ 1.33 ç›¸æ¯”æ—§ç‰ˆæœ¬çš„å…³é”®å˜åŒ–ï¼šï¼ˆéå¸¸é‡è¦ï¼‰\nâœ… 1. dockershim å·²å½»åº•ç§»é™¤ï¼ˆå¾ˆä¹…å‰ç§»é™¤ï¼Œ1.33 å®Œå…¨ä¸æ”¯æŒ Dockerï¼‰ åªèƒ½ç”¨ï¼š\ncontainerdï¼ˆæœ€æ ‡å‡†ï¼‰ CRI-O âœ… 2. Pod Security Admissionï¼ˆPSAï¼‰å®Œå…¨æ›¿ä»£ PodSecurityPolicy PSP æ—©å·²åºŸå¼ƒï¼Œ1.33 å¿…é¡»ä½¿ç”¨ PSAï¼š\nprivileged baseline restricted âœ… 3. kube-proxy å¯é€‰ï¼šæ”¯æŒ eBPF æ¨¡å¼ï¼ˆCilium ä¸»æµï¼‰ iptables/ipvs ä¾æ—§å…¼å®¹ï¼Œä½† eBPF è¶Šæ¥è¶Šå¸¸è§ã€‚\nâœ… 4. Service APIï¼ˆGateway APIï¼‰æ„ˆå‘æˆç†Ÿ Ingress ä»å¯ç”¨ï¼Œä½† Gateway API æ˜¯æœªæ¥è¶‹åŠ¿ã€‚\nâœ… 5. Kubelet 100% GAï¼ˆç¨³å®šï¼‰ åŒ…å«ï¼š\nsecure serving cri å°è£… resource metrics âœ… 6. å¢å¼ºè°ƒåº¦ï¼ˆScheduler v2 ç‰¹æ€§æŒç»­å¢å¼ºï¼‰ åŒ…æ‹¬ï¼š\nTopology Aware Scheduling NUMA æ„ŸçŸ¥è°ƒåº¦ èŠ‚ç‚¹å®¹é‡æ‰©å±•æ’ä»¶ âš ï¸ 7. 1.33 é»˜è®¤ä¸è½ç›˜ kubeadm config IF ä¸ä½¿ç”¨ â€“config ç†è®ºä¸Š kubeadm init ä¸ä¼šè‡ªåŠ¨åˆ›å»º /etc/kubernetes/kubeadm-config.yamlã€‚\nğŸŸ¦ 1. Clusterï¼ˆé›†ç¾¤ï¼‰ ç”± æ§åˆ¶å¹³é¢ï¼ˆControl-planeï¼‰+ å·¥ä½œèŠ‚ç‚¹ï¼ˆNodeï¼‰ ç»„æˆã€‚\nğŸŸ¦ 2. Control Planeï¼ˆæ§åˆ¶å¹³é¢ï¼‰ç»„ä»¶Â·1.33 æ ‡å‡† 2.1 kube-apiserverï¼ˆæ ¸å¿ƒ API ç½‘å…³ï¼‰ æ‰€æœ‰CLIã€Controllerã€Scheduler éƒ½å¿…é¡»ç»è¿‡ API Serverã€‚\n2.2 etcdï¼ˆå”¯ä¸€æ•°æ®æºï¼‰ å­˜å‚¨ï¼š\nPod / Deployment / Node / Service / ConfigMap å…¨éƒ¨é›†ç¾¤çŠ¶æ€ 2.3 kube-scheduler è´Ÿè´£è°ƒåº¦ Pod åˆ°å¯¹åº” Nodeã€‚\n1.33 çš„å¢å¼ºç‚¹ï¼š\næ»šåŠ¨æ›´æ–°æ’ä»¶ NUMA è°ƒåº¦ èŠ‚ç‚¹æ‹“æ‰‘è´Ÿè½½è°ƒåº¦ 2.4 kube-controller-manager é›†æˆå¤šä¸ª Controllerï¼š\nDeployment Controller StatefulSet Controller Node Controller Job Controller TTL Controller CSR Controller â€¦â€¦ æ‰€æœ‰æ§åˆ¶å™¨æœ¬è´¨éƒ½æ˜¯ï¼šâ€œç›®æ ‡çŠ¶æ€â€ VS â€œå®é™…çŠ¶æ€â€ -\u0026gt; è‡ªåŠ¨è°ƒèŠ‚\n2.5 cloud-controller-managerï¼ˆäº‘ç¯å¢ƒå¯é€‰ï¼‰ ç®¡ç†äº‘ç›¸å…³èµ„æºï¼š\nLoadBalancer Volume Route ğŸŸ¦ 3. Nodeï¼ˆèŠ‚ç‚¹ï¼‰ç»„ä»¶ Â· Kubernetes 1.33 æ ‡å‡† 3.1 kubelet Node çš„å®ˆæŠ¤è¿›ç¨‹ï¼š\nä¿è¯ Pod è¿è¡Œ è´Ÿè´£ä¸ API Server é€šä¿¡ ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ 3.2 kube-proxyï¼ˆiptables / ipvs / eBPF ä¸‰ç§ï¼‰ ä¸‰æ¨¡å¼ä»æ”¯æŒï¼Œä½†ï¼š\neBPFï¼ˆCiliumï¼‰æ˜¯æœ€æ–°è¶‹åŠ¿ kube-proxy æœ¬èº«å¹¶æœªæ¥è¢«åºŸå¼ƒï¼ˆå®˜æ–¹æ¾„æ¸…ï¼‰ 3.3 Container Runtimeï¼ˆå¿…é¡»æ˜¯ CRIï¼‰ K8S 1.33 ä»…æ”¯æŒï¼š\ncontainerd CRI-O Docker å·²é•¿æœŸä¸æ”¯æŒã€‚\nğŸŸ¦ 4. Podï¼ˆæœ€å°è°ƒåº¦å•ä½ï¼‰ ä¸€ç»„å®¹å™¨ å…±äº«ï¼šIPã€Volumeã€IPCã€PID Pod æ˜¯â€œè°ƒåº¦å•ä½â€ï¼Œä¸æ˜¯â€œè¿è¡Œå•ä½â€ã€‚\nğŸŸ¦ 5. Workloadï¼ˆåº”ç”¨å·¥ä½œè´Ÿè½½ï¼‰ 5.1 Deploymentï¼ˆæ— çŠ¶æ€æœåŠ¡ï¼‰ æ”¯æŒï¼š\næ»šåŠ¨æ›´æ–° å›æ»š å‰¯æœ¬è‡ªæ„ˆ æœ€å¸¸ç”¨ã€‚\n5.2 StatefulSetï¼ˆæœ‰çŠ¶æ€æœåŠ¡ï¼‰ ç‰¹æ€§ï¼š\nç¨³å®šæŒä¹…çš„ Pod åç§° ç¨³å®šç»‘å®š PVC æœ‰åºéƒ¨ç½² é€‚ç”¨äºæ•°æ®åº“ï¼š\nPostgreSQL MongoDB ES Redis Cluster 5.3 DaemonSet æ‰€æœ‰ Node è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œä¾‹å¦‚ï¼š\nç›‘æ§ï¼ˆNode Exporterï¼‰ CNI ä»£ç†ï¼ˆCalico Nodeï¼‰ æ—¥å¿—æ”¶é›†ï¼ˆFluent-bitï¼‰ 5.4 Job / CronJob ä¸€æ¬¡æ€§ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ã€‚\nğŸŸ¦ 6. Serviceï¼ˆæœåŠ¡å‘ç°ï¼‰ Service æ˜¯â€œè™šæ‹Ÿ IPï¼ˆClusterIPï¼‰â€ã€‚\nPod IP ä¼šå˜ï¼Œä½† Service IP ä¸å˜ã€‚\nç±»å‹ï¼š\nClusterIPï¼ˆé»˜è®¤ï¼Œåªèƒ½å†…éƒ¨è®¿é—®ï¼‰ NodePortï¼ˆ30000â€“32767ï¼‰ LoadBalancerï¼ˆäº‘ç¯å¢ƒï¼‰ Headlessï¼ˆæ—  ClusterIPï¼‰ ç”¨äº StatefulSet åŸŸåã€‚\nKubernetes 1.33 æ–°é‡ç‚¹ï¼šGateway API\nIngress æœªæ¥è¢« Gateway API æ›¿ä»£ã€‚\nğŸŸ¦ 7. Ingress / Gateway APIï¼ˆL7 HTTP ä»£ç†ï¼‰ Ingress ä¸€ç›´æ”¯æŒï¼Œä½† K8S çš„æœªæ¥æ ‡å‡†æ˜¯ï¼š\nGateway APIï¼ˆæˆç†Ÿåº¦å·²é«˜ï¼‰\nHTTPRoute TCPRoute TLSRoute GatewayClass ğŸŸ¦ 8. ConfigMap / Secretï¼ˆé…ç½®ä¿¡æ¯ï¼‰ ConfigMap éæ•æ„Ÿä¿¡æ¯ã€‚\nSecret æ•æ„Ÿä¿¡æ¯ï¼ˆbase64ï¼Œä½†ä¸å®‰å…¨ï¼‰\nK8S 1.33 æ¨èå¼€å¯ï¼š\nKMS é”®ç®¡ç† SecretEncryption ğŸŸ¦ 9. Volume / PV / PVCï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰ Volumeï¼ˆPod å†…ï¼‰ ä¸´æ—¶æˆ–æŒä¹…ã€‚\nPVï¼ˆPersistentVolumeï¼‰ ç”±ç®¡ç†å‘˜æä¾›ã€‚\nPVCï¼ˆPersistentVolumeClaimï¼‰ ç”¨æˆ·çš„è¯·æ±‚ï¼ˆç»‘å®š PVï¼‰ã€‚\næ–°å˜åŒ– K8S 1.33 å¯¹ CSI æ’ä»¶æ”¯æŒæ›´å®Œå–„ï¼ˆç‰¹æ€§ GAï¼‰ã€‚\nğŸŸ¦ 10. Namespaceï¼ˆé€»è¾‘éš”ç¦»ï¼‰ å¸¸è§ï¼š\ndefault kube-system kube-public dev / test / prod ğŸŸ¦ 11. Label / Selector ç”¨äºé€‰æ‹© Podã€Deploymentã€Serviceã€‚\næ ¸å¿ƒæŸ¥æ‰¾æœºåˆ¶ï¼š\napp: nginx env: prod component: backend ğŸŸ¦ 12. Annotation å­˜å‚¨å…ƒä¿¡æ¯ï¼Œå¦‚ï¼š\nç‰ˆæœ¬ å‘å¸ƒäºº commit hash Sidecar æ³¨å…¥ hint ğŸŸ¦ 13. Taint \u0026amp; Toleration æ§åˆ¶ Pod ä¸èƒ½è°ƒåº¦åˆ°æŸèŠ‚ç‚¹ã€‚\nä¾‹å­ï¼š\nnode-role.kubernetes.io/master=:NoSchedule ğŸŸ¦ 14. Affinityï¼ˆäº²å’Œï¼‰/ Anti-Affinityï¼ˆåäº²å’Œï¼‰ å†³å®š Pod è¿è¡Œåœ¨å“ªäº›èŠ‚ç‚¹ã€‚\nç”¨äºï¼š\né«˜å¯ç”¨ åˆ†å¸ƒå¼æ¶æ„éš”ç¦» ğŸŸ¦ 15. CNIï¼ˆç½‘ç»œæ’ä»¶ï¼‰ è´Ÿè´£ Pod ç½‘ç»œé€šä¿¡ã€‚\nä¸»æµï¼š\nCalicoï¼ˆé»˜è®¤é¦–é€‰ï¼‰ Ciliumï¼ˆeBPFï¼‰ Flannelï¼ˆç®€å•ä½†è¿‡æ—¶ï¼‰ Weaveï¼ˆå†å²é¡¹ï¼‰ ğŸŸ¦ 16. CSIï¼ˆå­˜å‚¨æ’ä»¶ï¼‰ æä¾›å­˜å‚¨æ¥å£ï¼š\nCeph RBD NFS EBS Local Path ğŸŸ¦ 17. CRDï¼ˆè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼‰ æ‰©å±• Kubernetes çš„ APIã€‚\næ‰€æœ‰ç”Ÿæ€å·¥å…·ï¼ˆå¦‚ Istioï¼‰éƒ½åŸºäº CRDã€‚\nğŸŸ¦ 18. Operatorï¼ˆè‡ªåŠ¨åŒ–è¿ç»´ï¼‰ åŸºäº CRD çš„è‡ªåŠ¨åŒ–æ§åˆ¶å™¨ã€‚\nä¾‹å¦‚ï¼š\nPostgres Operator MongoDB Operator Redis Operator ğŸŸ¦ 19. kubeadmï¼ˆé›†ç¾¤ç®¡ç†ï¼‰ Â· 1.33 ç‰¹æ€§ å…è®¸ç”Ÿæˆ kubeadm-config.yaml init/join æ”¯æŒ K8S 1.33 æ‰€æœ‰æ–°å­—æ®µ æ›´å¥½çš„ TLS ç®¡ç†ï¼ˆcert renewï¼‰ ğŸŸ¦ 20. kubectlï¼ˆé›†ç¾¤ CLIï¼‰ å¸¸ç”¨æ“ä½œï¼š\napply get describe logs exec rollout drain / cordon / uncordon ","description":" ğŸ”· 0. Kubernetes 1.33 æ–°å˜åŒ–ï¼ˆé‡è¦ï¼‰ åœ¨ä»‹ç»æ ¸å¿ƒæ¦‚å¿µä¹‹å‰ï¼Œå…ˆè¯´ 1.33 ç›¸æ¯”æ—§ç‰ˆæœ¬çš„å…³é”®å˜åŒ–ï¼šï¼ˆéå¸¸é‡è¦ï¼‰\nâœ… 1. dockershim å·²å½»åº•ç§»é™¤ï¼ˆå¾ˆä¹…å‰ç§»é™¤ï¼Œ1.33 å®Œå…¨ä¸æ”¯æŒ Dockerï¼‰ åªèƒ½ç”¨ï¼š\ncontainerdï¼ˆæœ€æ ‡å‡†ï¼‰ CRI-O âœ… 2. Pod Security Admissionï¼ˆPSAï¼‰å®Œå…¨æ›¿ä»£ PodSecurityPolicy PSP æ—©å·²åºŸå¼ƒï¼Œ1.33 å¿…é¡»ä½¿ç”¨ PSAï¼š\n"},{"id":57,"href":"/operations/kubernetes/core/","title":"Kubernetes æ ¸å¿ƒæ¦‚å¿µ","parent":"Kubernetes","content":" ä¸€ã€Kubernetes æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆWhyï¼‰ 1ï¸âƒ£ Kubernetes è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ åœ¨å®¹å™¨è§„æ¨¡åŒ–ä¹‹åï¼Œå‡ºç°çš„é—®é¢˜ï¼š\né—®é¢˜ ä¼ ç»Ÿæ–¹å¼ å®¹å™¨å¤šã€æœºå™¨å¤š æ‰‹å·¥ SSH æœåŠ¡æŒ‚äº† äººå·¥é‡å¯ æ‰©å®¹ç¼©å®¹ äººå·¥åŠ æœºå™¨ æœåŠ¡å‘ç° å†™ IP æ»šåŠ¨å‡çº§ æ‰‹å·¥åœæœº å¤šç¯å¢ƒéš”ç¦» çº¦å®š ğŸ‘‰ Kubernetes = å®¹å™¨çš„â€œæ“ä½œç³»ç»Ÿâ€\nå®ƒè§£å†³çš„æ˜¯ï¼š å®¹å™¨çš„è‡ªåŠ¨éƒ¨ç½²ã€è°ƒåº¦ã€æ‰©ç¼©å®¹ã€è‡ªæ„ˆã€ç½‘ç»œã€å­˜å‚¨ã€å‡çº§\näºŒã€Kubernetes çš„æ•´ä½“æ¶æ„ï¼ˆWhatï¼‰ 2ï¸âƒ£ æ¶æ„åˆ†å±‚ +----------------------------+ | ç”¨æˆ· / kubectl | +-------------+--------------+ | +-------------v--------------+ | Control Plane | | apiserver / scheduler | | controller / etcd | +-------------+--------------+ | +-------------v--------------+ | Node | | kubelet / containerd | | kube-proxy / CNI | +----------------------------+ 3ï¸âƒ£ æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ ğŸ”¹ kube-apiserverï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰ æ‰€æœ‰è¯·æ±‚å…¥å£ï¼ˆREST APIï¼‰ è®¤è¯ã€é‰´æƒã€å‡†å…¥ å”¯ä¸€å’Œ etcd é€šä¿¡çš„ç»„ä»¶ ğŸ‘‰ æ²¡æœ‰ apiserverï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¸å­˜åœ¨\nğŸ”¹ etcd åˆ†å¸ƒå¼ KV å­˜å‚¨ ä¿å­˜ é›†ç¾¤æ‰€æœ‰çŠ¶æ€ å¼ºä¸€è‡´æ€§ï¼ˆRaftï¼‰ âš ï¸ etcd æ»¡ç£ç›˜ = é›†ç¾¤ç˜«ç—ª\nğŸ”¹ kube-scheduler ç»™ Pod é€‰æ‹©è¿è¡Œçš„ Node ä¸åˆ›å»º Podï¼Œåªâ€œå†³ç­–â€ æµç¨‹ï¼š\nè¿‡æ»¤èŠ‚ç‚¹ï¼ˆFilterï¼‰ æ‰“åˆ†ï¼ˆScoreï¼‰ ç»‘å®šï¼ˆBindï¼‰ ğŸ”¹ kube-controller-manager ä¸€å †æ§åˆ¶å™¨çš„é›†åˆ ä¿è¯â€œæœŸæœ›çŠ¶æ€ = å®é™…çŠ¶æ€â€ å¸¸è§æ§åˆ¶å™¨ï¼š\nDeployment / ReplicaSet Node Controller Endpoint Controller Job Controller 4ï¸âƒ£ å·¥ä½œèŠ‚ç‚¹ï¼ˆNodeï¼‰ ğŸ”¹ kubelet Node ä¸Šçš„â€œç®¡å®¶â€ ç®¡ç† Pod ç”Ÿå‘½å‘¨æœŸ è°ƒç”¨ containerd åˆ›å»ºå®¹å™¨ å®šæœŸå‘ apiserver æ±‡æŠ¥çŠ¶æ€ ğŸ”¹ container runtime containerd / CRI-O çœŸæ­£è¿è¡Œå®¹å™¨çš„ç»„ä»¶ ğŸ”¹ kube-proxy Service çš„å®ç°è€… ç»´æŠ¤ iptables / ipvs è½¬å‘è§„åˆ™ å®ç°å››å±‚è´Ÿè½½å‡è¡¡ ğŸ”¹ CNIï¼ˆç½‘ç»œæ’ä»¶ï¼‰ Flannel / Calico / Cilium ç»™ Pod åˆ†é… IP ç»´æŠ¤ Pod é—´é€šä¿¡ ä¸‰ã€æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆObject Modelï¼‰ 5ï¸âƒ£ ä»€ä¹ˆæ˜¯ Kubernetes å¯¹è±¡ï¼Ÿ Kubernetes ä¸€åˆ‡çš†èµ„æº\næ¯ä¸ªèµ„æºéƒ½æ˜¯ä¸€ä¸ª YAML å¯¹è±¡ï¼š\napiVersion kind metadata spec status 6ï¸âƒ£ Podï¼ˆæœ€å°è°ƒåº¦å•ä½ï¼‰ Pod æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„ç»„åˆ\nå…±äº«ï¼š\nIP Network namespace Volume ä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒåº¦å®¹å™¨ï¼Ÿ éœ€è¦ sidecar éœ€è¦å…±äº«èµ„æº è°ƒåº¦åŸå­æ€§ ğŸ‘‰ Pod æ˜¯ä¸´æ—¶çš„ã€çŸ­ç”Ÿå‘½å‘¨æœŸ\n7ï¸âƒ£ Workloadï¼ˆå·¥ä½œè´Ÿè½½ï¼‰ ç±»å‹ ç”¨é€” Deployment æ— çŠ¶æ€åº”ç”¨ StatefulSet æœ‰çŠ¶æ€æœåŠ¡ DaemonSet æ¯èŠ‚ç‚¹ä¸€ä¸ª Job ä¸€æ¬¡æ€§ä»»åŠ¡ CronJob å®šæ—¶ä»»åŠ¡ Deployment ç®¡ç† ReplicaSet æ»šåŠ¨å‡çº§ å›æ»š StatefulSet ç¨³å®šç½‘ç»œèº«ä»½ ç¨³å®šå­˜å‚¨ é¡ºåºéƒ¨ç½² 8ï¸âƒ£ Serviceï¼ˆæœåŠ¡æŠ½è±¡ï¼‰ Service è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ Pod IP ä¼šå˜ Pod ä¼šé‡å»º éœ€è¦ç»Ÿä¸€è®¿é—®å…¥å£ Service æä¾› è™šæ‹Ÿ IPï¼ˆVIPï¼‰ DNS åç§° è´Ÿè½½å‡è¡¡ ç±»å‹ï¼š\nClusterIP NodePort LoadBalancer Headless 9ï¸âƒ£ Ingressï¼ˆä¸ƒå±‚æµé‡å…¥å£ï¼‰ HTTP/HTTPS è·¯ç”± TLS ç»ˆæ­¢ åŸŸåè½¬å‘ Ingress = è§„åˆ™\nIngress Controller = å®ç°è€…ï¼ˆNginx / Traefikï¼‰\nå››ã€è°ƒåº¦ä¸èµ„æºç®¡ç†ï¼ˆHowï¼‰ ğŸ”Ÿ è°ƒåº¦ç›¸å…³æ¦‚å¿µ NodeSelector æœ€ç®€å•èŠ‚ç‚¹é€‰æ‹© NodeAffinity æ›´çµæ´»çš„èŠ‚ç‚¹äº²å’Œ PodAffinity / AntiAffinity Pod ä¹‹é—´å…³ç³» 1ï¸âƒ£1ï¸âƒ£ Taint / Toleration Node æ‹’ç» Pod Pod å£°æ˜æˆ‘èƒ½å¿ ç”¨é€”ï¼š\nmaster éš”ç¦» ä¸“ç”¨èŠ‚ç‚¹ GPU èŠ‚ç‚¹ 1ï¸âƒ£2ï¸âƒ£ èµ„æºç®¡ç† requests / limits requests -\u0026gt; è°ƒåº¦ä¾æ® limits -\u0026gt; ä½¿ç”¨ä¸Šé™ 1ï¸âƒ£3ï¸âƒ£ HPAï¼ˆè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰ åŸºäº CPU / å†…å­˜ / è‡ªå®šä¹‰æŒ‡æ ‡ éœ€è¦ metrics-server äº”ã€å­˜å‚¨ï¼ˆPersistenceï¼‰ 1ï¸âƒ£4ï¸âƒ£ PV / PVC / StorageClass åç§° ä½œç”¨ PV å®é™…å­˜å‚¨ PVC å­˜å‚¨ç”³è¯· StorageClass åŠ¨æ€åˆ›å»º 1ï¸âƒ£5ï¸âƒ£ Volume ç±»å‹ emptyDir hostPath NFS CSIï¼ˆäº‘ç›˜ï¼‰ å…­ã€é…ç½®ä¸å¯†é’¥ 1ï¸âƒ£6ï¸âƒ£ ConfigMap é…ç½®æ–‡ä»¶ ç¯å¢ƒå˜é‡ 1ï¸âƒ£7ï¸âƒ£ Secret å¯†ç  Token TLS è¯ä¹¦ ä¸ƒã€å®‰å…¨ï¼ˆSecurityï¼‰ 1ï¸âƒ£8ï¸âƒ£ RBAC Role / ClusterRole RoleBinding ServiceAccount 1ï¸âƒ£9ï¸âƒ£ NetworkPolicy Pod ç½‘ç»œè®¿é—®æ§åˆ¶ ä¾èµ– CNI æ’ä»¶ å…«ã€ç”Ÿå‘½å‘¨æœŸ \u0026amp; è‡ªæ„ˆ 2ï¸âƒ£0ï¸âƒ£ Pod ç”Ÿå‘½å‘¨æœŸ Pending -\u0026gt; Running -\u0026gt; Succeeded / Failed 2ï¸âƒ£1ï¸âƒ£ æ¢é’ˆ startupProbe readinessProbe livenessProbe 2ï¸âƒ£2ï¸âƒ£ è‡ªæ„ˆæœºåˆ¶ Pod å´©æºƒ -\u0026gt; é‡å¯ Node æ‰çº¿ -\u0026gt; Pod æ¼‚ç§» å‰¯æœ¬ä¸è¶³ -\u0026gt; è‡ªåŠ¨è¡¥é½ ä¹ã€ä¸ºä»€ä¹ˆ Kubernetes å¼ºå¤§ï¼Ÿ æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼š\nå£°æ˜å¼ æœŸæœ›çŠ¶æ€ æ§åˆ¶å¾ªç¯ è§£è€¦ è‡ªåŠ¨åŒ– ğŸ”š æ€»ç»“ä¸€å¥è¯ï¼ˆé¢è¯•ç”¨ï¼‰ Kubernetes æ˜¯ä¸€ä¸ª ä»¥å£°æ˜å¼ API ä¸ºæ ¸å¿ƒï¼Œ\né€šè¿‡ æ§åˆ¶å™¨ä¸æ–­å¯¹é½æœŸæœ›çŠ¶æ€å’Œå®é™…çŠ¶æ€ï¼Œ\nå®ç° å®¹å™¨åº”ç”¨è‡ªåŠ¨åŒ–ç®¡ç†çš„å¹³å°ã€‚\n","description":" ä¸€ã€Kubernetes æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆWhyï¼‰ 1ï¸âƒ£ Kubernetes è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ åœ¨å®¹å™¨è§„æ¨¡åŒ–ä¹‹åï¼Œå‡ºç°çš„é—®é¢˜ï¼š\né—®é¢˜ ä¼ ç»Ÿæ–¹å¼ å®¹å™¨å¤šã€æœºå™¨å¤š æ‰‹å·¥ SSH æœåŠ¡æŒ‚äº† äººå·¥é‡å¯ æ‰©å®¹ç¼©å®¹ äººå·¥åŠ æœºå™¨ æœåŠ¡å‘ç° å†™ IP æ»šåŠ¨å‡çº§ æ‰‹å·¥åœæœº å¤šç¯å¢ƒéš”ç¦» çº¦å®š ğŸ‘‰ Kubernetes = å®¹å™¨çš„â€œæ“ä½œç³»ç»Ÿâ€\nå®ƒè§£å†³çš„æ˜¯ï¼š å®¹å™¨çš„è‡ªåŠ¨éƒ¨ç½²ã€è°ƒåº¦ã€æ‰©ç¼©å®¹ã€è‡ªæ„ˆã€ç½‘ç»œã€å­˜å‚¨ã€å‡çº§\näºŒã€Kubernetes çš„æ•´ä½“æ¶æ„ï¼ˆWhatï¼‰ 2ï¸âƒ£ æ¶æ„åˆ†å±‚ +----------------------------+ | ç”¨æˆ· / kubectl | +-------------+--------------+ | +-------------v--------------+ | Control Plane | | apiserver / scheduler | | controller / etcd | +-------------+--------------+ | +-------------v--------------+ | Node | | kubelet / containerd | | kube-proxy / CNI | +----------------------------+ 3ï¸âƒ£ æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ ğŸ”¹ kube-apiserverï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰ æ‰€æœ‰è¯·æ±‚å…¥å£ï¼ˆREST APIï¼‰ è®¤è¯ã€é‰´æƒã€å‡†å…¥ å”¯ä¸€å’Œ etcd é€šä¿¡çš„ç»„ä»¶ ğŸ‘‰ æ²¡æœ‰ apiserverï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¸å­˜åœ¨\n"},{"id":58,"href":"/operations/kvm/core/","title":"KVM æ ¸å¿ƒæ¦‚å¿µ","parent":"KVM","content":" ä¸€ã€KVM æ˜¯ä»€ä¹ˆ KVMï¼ˆKernel-based Virtual Machineï¼‰æ˜¯ Linux å†…æ ¸ä¸­çš„è™šæ‹ŸåŒ–æ¨¡å—ï¼ŒæŠŠ Linux æœ¬èº«å˜æˆä¸€ä¸ª Type-1 Hypervisorã€‚\nå…³é”®ç‚¹ï¼š\nä¸æ˜¯ç‹¬ç«‹ç¨‹åº æ˜¯ å†…æ ¸æ¨¡å— ä¾èµ– CPU ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVT-x / AMD-Vï¼‰ äºŒã€KVM çš„æ•´ä½“æ¶æ„ï¼ˆå¿…é¡»åƒé€ï¼‰ ç¡¬ä»¶ (CPU / Memory / NIC / Disk) â””â”€â”€ Linux Kernel â”œâ”€â”€ KVM æ¨¡å—ï¼ˆkvm.ko / kvm_intel.ko / kvm_amd.koï¼‰ â”œâ”€â”€ å†…å­˜ç®¡ç† / è°ƒåº¦ / NUMA â””â”€â”€ QEMUï¼ˆç”¨æˆ·æ€è¿›ç¨‹ï¼‰ â””â”€â”€ è™šæ‹Ÿæœºï¼ˆGuest OSï¼‰ å„ç»„ä»¶èŒè´£\nç»„ä»¶ ä½œç”¨ KVM CPU / å†…å­˜è™šæ‹ŸåŒ– QEMU è®¾å¤‡æ¨¡æ‹Ÿï¼ˆç£ç›˜ã€ç½‘å¡ã€æ˜¾å¡ï¼‰ libvirt ç®¡ç† APIï¼ˆVM ç”Ÿå‘½å‘¨æœŸï¼‰ virtio åŠè™šæ‹ŸåŒ–è®¾å¤‡é©±åŠ¨ ä¸‰ã€KVM çš„å·¥ä½œåŸç†ï¼ˆåº•å±‚ï¼‰ 1ï¸âƒ£ CPU è™šæ‹ŸåŒ– æ ¸å¿ƒä¾èµ–\nIntel VT-x AMD-V æ‰§è¡Œæœºåˆ¶\nGuest CPU æŒ‡ä»¤ -\u0026gt; VMX æ¨¡å¼ ç‰¹æƒæŒ‡ä»¤ -\u0026gt; Trap -\u0026gt; Host å¤„ç† ğŸ‘‰ æ€§èƒ½æ¥è¿‘è£¸æœº\n2ï¸âƒ£ å†…å­˜è™šæ‹ŸåŒ–ï¼ˆéš¾ç‚¹ï¼‰ åœ°å€è½¬æ¢\nGuest Virtual Address -\u0026gt; Guest Physical Address -\u0026gt; Host Physical Address å…³é”®æŠ€æœ¯\næŠ€æœ¯ è¯´æ˜ EPT / NPT äºŒçº§é¡µè¡¨ HugePage å‡å°‘ TLB miss Balloon å†…å­˜å›æ”¶ NUMA å†…å­˜äº²å’Œ 3ï¸âƒ£ I/O è™šæ‹ŸåŒ– ä¸‰ç§æ¨¡å¼\næ¨¡å¼ ç‰¹ç‚¹ å…¨è™šæ‹ŸåŒ– æ¨¡æ‹ŸçœŸå®ç¡¬ä»¶ï¼ˆæ…¢ï¼‰ åŠè™šæ‹ŸåŒ– virtioï¼ˆä¸»æµï¼‰ ç›´é€š PCI Passthrough / SR-IOV å››ã€QEMU åœ¨ KVM ä¸­çš„è§’è‰²ï¼ˆå¸¸è¢«è¯¯è§£ï¼‰ KVM â‰  QEMU\nKVMï¼šå†…æ ¸æ¨¡å—ï¼Œè´Ÿè´£æ‰§è¡Œ QEMUï¼šç”¨æˆ·æ€è¿›ç¨‹ï¼Œè´Ÿè´£è®¾å¤‡ æ²¡æœ‰ KVM\nQEMU -\u0026gt; çº¯æ¨¡æ‹Ÿ -\u0026gt; å¾ˆæ…¢ æœ‰ KVM\nQEMU + KVM -\u0026gt; ç¡¬ä»¶è¾…åŠ© -\u0026gt; é«˜æ€§èƒ½ äº”ã€libvirt çš„ä½œç”¨ï¼ˆç®¡ç†å±‚ï¼‰ libvirt æ˜¯ KVM çš„â€œæ§åˆ¶é¢â€\nèƒ½åšä»€ä¹ˆ\nåˆ›å»º / å¯åŠ¨ / åœæ­¢ VM ç½‘ç»œ / å­˜å‚¨æ± ç®¡ç† XML é…ç½®æŠ½è±¡ å¸¸è§ URI\nURI åœºæ™¯ qemu:///system ç”Ÿäº§ qemu:///session æµ‹è¯• å…­ã€KVM ç½‘ç»œæ¨¡å‹ï¼ˆé«˜é¢‘ï¼‰ 1ï¸âƒ£ NATï¼ˆdefaultï¼‰ VM -\u0026gt; virbr0 -\u0026gt; NAT -\u0026gt; å¤–ç½‘ ç®€å• æ€§èƒ½ä¸€èˆ¬ ä¸é€‚åˆç”Ÿäº§ 2ï¸âƒ£ Bridgeï¼ˆç”Ÿäº§ä¸»æµï¼‰ VM â”€â” â”œâ”€ br0 â”€â”€ ç‰©ç†ç½‘å¡ â”€â”€ å¤–ç½‘ Hostâ”˜ VM ä¸å®¿ä¸»åŒç½‘æ®µ æ€§èƒ½å¥½ K8S / OpenStack å¿…ç”¨ 3ï¸âƒ£ OVSï¼ˆäº‘å¹³å°ï¼‰ VXLAN SDN OpenStack / Kubernetes ä¸ƒã€KVM å­˜å‚¨æ¨¡å‹ ç±»å‹ åœºæ™¯ æ–‡ä»¶ï¼ˆqcow2ï¼‰ æµ‹è¯• LVM ç”Ÿäº§ Ceph RBD äº‘å¹³å° NFS ç®€å•å…±äº« qcow2 ç‰¹ç‚¹\næ”¯æŒå¿«ç…§ å†™æ—¶å¤åˆ¶ æ€§èƒ½ç•¥ä½äº raw å…«ã€KVM æƒé™ä¸å®‰å…¨æ¨¡å‹ï¼ˆå¾ˆå…³é”®ï¼‰ system vs session\næ¨¡å¼ æƒé™ system root / libvirt ç»„ session å½“å‰ç”¨æˆ· å®‰å…¨æœºåˆ¶\nSELinux cgroup namespace sVirt ä¹ã€KVM vs å…¶ä»–è™šæ‹ŸåŒ– å¯¹æ¯” KVM Xen ESXi ç±»å‹ å†…æ ¸ è£¸é‡‘å± è£¸é‡‘å± ç”Ÿæ€ æœ€å¼º ä¸‹é™ å•†ä¸š äº‘å‚å•† ä¸»æµ å°‘ å°‘ åã€KVM çš„å…¸å‹åº”ç”¨åœºæ™¯ ç§æœ‰äº‘ï¼ˆOpenStackï¼‰ äº‘å‚å•† IaaS Kubernetes èŠ‚ç‚¹ CI / æµ‹è¯•ç¯å¢ƒ æ•°æ®åº“éš”ç¦»éƒ¨ç½² åä¸€ã€å¸¸è§è¯¯åŒºï¼ˆä¸€å®šè¦é¿ï¼‰ âŒ KVM æ˜¯ Type-2 âŒ QEMU = KVM âŒ virtio ä¸é‡è¦ âŒ å®¹å™¨èƒ½æ›¿ä»£ VM âŒ ä¸éœ€è¦ NUMA è§„åˆ’ åäºŒã€æ€»ç»“ KVM æ˜¯ Linux å†…æ ¸ä¸­çš„è™šæ‹ŸåŒ–èƒ½åŠ›ï¼Œä¾èµ–ç¡¬ä»¶è¾…åŠ©ï¼Œé€šè¿‡ QEMU æ¨¡æ‹Ÿè®¾å¤‡ã€libvirt ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œæ€§èƒ½æ¥è¿‘è£¸æœºï¼Œæ˜¯äº‘è®¡ç®—çš„äº‹å®æ ‡å‡†ã€‚\nåä¸‰ã€è¿›é˜¶è·¯çº¿ï¼ˆå»ºè®®ï¼‰ 1ï¸âƒ£ KVM æ ¸å¿ƒåŸç† 2ï¸âƒ£ ç½‘ç»œï¼ˆBridge / OVSï¼‰ 3ï¸âƒ£ å­˜å‚¨ï¼ˆLVM / Cephï¼‰ 4ï¸âƒ£ æ€§èƒ½è°ƒä¼˜ï¼ˆNUMA / HugePageï¼‰ 5ï¸âƒ£ OpenStack / K8S ","description":" ä¸€ã€KVM æ˜¯ä»€ä¹ˆ KVMï¼ˆKernel-based Virtual Machineï¼‰æ˜¯ Linux å†…æ ¸ä¸­çš„è™šæ‹ŸåŒ–æ¨¡å—ï¼ŒæŠŠ Linux æœ¬èº«å˜æˆä¸€ä¸ª Type-1 Hypervisorã€‚\nå…³é”®ç‚¹ï¼š\nä¸æ˜¯ç‹¬ç«‹ç¨‹åº æ˜¯ å†…æ ¸æ¨¡å— ä¾èµ– CPU ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVT-x / AMD-Vï¼‰ äºŒã€KVM çš„æ•´ä½“æ¶æ„ï¼ˆå¿…é¡»åƒé€ï¼‰ ç¡¬ä»¶ (CPU / Memory / NIC / Disk) â””â”€â”€ Linux Kernel â”œâ”€â”€ KVM æ¨¡å—ï¼ˆkvm.ko / kvm_intel.ko / kvm_amd.koï¼‰ â”œâ”€â”€ å†…å­˜ç®¡ç† / è°ƒåº¦ / NUMA â””â”€â”€ QEMUï¼ˆç”¨æˆ·æ€è¿›ç¨‹ï¼‰ â””â”€â”€ è™šæ‹Ÿæœºï¼ˆGuest OSï¼‰ å„ç»„ä»¶èŒè´£\n"},{"id":59,"href":"/operations/linux/core/","title":"Linux æ ¸å¿ƒæ¦‚å¿µ","parent":"Linux","content":"å‚è€ƒæ–‡æ¡£ï¼š\nLinux å†…æ ¸æ•´ä½“æ¶æ„è¯¦è§£ æ·±å…¥ç†è§£Linux Kernelå†…æ ¸æ•´ä½“æ¶æ„(å›¾æ–‡è¯¦è§£) åã€Œä½“ç³»åŒ– + è¿ç»´/æ¶æ„è§†è§’ã€ çš„Linux ç³»ç»Ÿ Â· æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®ºæ€»è§ˆã€‚\nè¦†ç›– RHEL / AlmaLinux ä¸ Debian / Ubuntu ç³»åˆ—ã€‚\nä¸€ã€Linux çš„æ•´ä½“æ¶æ„ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ +----------------------------------------------------+ åº”ç”¨ç¨‹åº / æœåŠ¡ Nginx / MySQL / Docker / Kubernetes +----------------------------------------------------+ ç”¨æˆ·ç©ºé—´ (User Space) shell / libc / systemd / PAM / udev +----------------------------------------------------+ å†…æ ¸ç©ºé—´ (Kernel) è¿›ç¨‹ç®¡ç† / å†…å­˜ç®¡ç† / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œå­ç³»ç»Ÿ / è®¾å¤‡ä¸é©±åŠ¨ cgroups / namespaces / è™šæ‹ŸåŒ– / NUMA / security +----------------------------------------------------+ ç¡¬ä»¶ (CPU / RAM / Disk / NIC / GPU) +----------------------------------------------------+ ğŸ‘‰ Linux â‰  å‘è¡Œç‰ˆ\nLinuxï¼šå†…æ ¸ RHEL / Ubuntuï¼šå†…æ ¸ + å·¥å…·é“¾ + ç­–ç•¥é›†åˆ äºŒã€å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿï¼ˆæ‰€æœ‰å‘è¡Œç‰ˆå…±é€šï¼‰ Linux å†…æ ¸ç©ºé—´äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿæ€»è§ˆ\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” è¿›ç¨‹ â† è°åœ¨è·‘ï¼Ÿä»€ä¹ˆæ—¶å€™è·‘ï¼Ÿ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ å†…å­˜ â† ç”¨å¤šå°‘å†…å­˜ï¼Ÿæ€ä¹ˆç”¨ï¼Ÿä¼šä¸ä¼š OOMï¼Ÿ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ ç½‘ç»œ â† æ•°æ®æ€ä¹ˆè¿›å‡ºæœºå™¨ï¼Ÿ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ æ–‡ä»¶ç³»ç»Ÿ â† æ•°æ®æ€ä¹ˆå­˜ã€æ€ä¹ˆè¯»ï¼Ÿ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ è®¾å¤‡é©±åŠ¨ â† æ€ä¹ˆè·Ÿç¡¬ä»¶è¯´è¯ï¼Ÿ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ä¸€å¥è¯æ€»ç»“ï¼š\nè¿›ç¨‹ç®¡â€œæ—¶é—´â€ å†…å­˜ç®¡â€œç©ºé—´â€ æ–‡ä»¶ç³»ç»Ÿç®¡â€œæŒä¹…â€ ç½‘ç»œç®¡â€œæµåŠ¨â€ è®¾å¤‡é©±åŠ¨ç®¡â€œç¡¬ä»¶æŠ½è±¡â€ 1ï¸âƒ£ è¿›ç¨‹ç®¡ç†ï¼ˆProcess Managementï¼‰ ä½œç”¨ è´Ÿè´£å¤„ç†è¿›ç¨‹çš„åˆ›å»ºã€è°ƒåº¦ã€ç»ˆæ­¢ä»¥åŠè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰\nå†³å®šâ€œå“ªä¸ªç¨‹åºåœ¨ä»€ä¹ˆæ—¶å€™ç”¨ CPU è·‘å¤šä¹…â€\næ ¸å¿ƒèŒè´£ èŒè´£ è¯´æ˜ è¿›ç¨‹/çº¿ç¨‹ç®¡ç† fork / exec / exit / wait CPU è°ƒåº¦ è°å…ˆè·‘ã€è·‘å¤šä¹… ä¸Šä¸‹æ–‡åˆ‡æ¢ è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢ ä¿¡å·æœºåˆ¶ killã€SIGTERMã€SIGKILL è¿›ç¨‹é—´é€šä¿¡ pipe / socket / shm / futex æ ¸å¿ƒæœºåˆ¶ è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰ CFSï¼ˆCompletely Fair Schedulerï¼‰ è°ƒåº¦å•ä½ï¼šçº¿ç¨‹ï¼ˆtask_structï¼‰ è°ƒåº¦ç±» CFSï¼ˆæ™®é€šè¿›ç¨‹ï¼‰ RTï¼ˆå®æ—¶è¿›ç¨‹ï¼‰ çŠ¶æ€æœº running / sleeping / zombie / stopped å…¸å‹é—®é¢˜ ç°è±¡ æ ¹å›  load å¾ˆé«˜ä½† CPU ç©ºé—² IO é˜»å¡ è¿›ç¨‹å¡æ­» D çŠ¶æ€ï¼ˆä¸å¯ä¸­æ–­ç¡çœ ï¼‰ CPU æŠ¢å ä¸¥é‡ è°ƒåº¦ä¸å…¬å¹³ / cgroups æ ¸å¿ƒæ¦‚å¿µ PID / PPID fork / exec è°ƒåº¦å™¨ï¼ˆCFSï¼‰ ä¼˜å…ˆçº§ï¼ˆnice / prioï¼‰ å¸¸ç”¨å·¥å…· ps aux top / htop pstree 2ï¸âƒ£ å†…å­˜ç®¡ç†ï¼ˆMemory Managementï¼‰ ä½œç”¨ è´Ÿè´£ç®¡ç†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´\nå†³å®šâ€œå†…å­˜æ€ä¹ˆåˆ†é…ã€æ€ä¹ˆå›æ”¶ã€æ€ä¹ˆæ˜ å°„â€\næ ¸å¿ƒèŒè´£ èŒè´£ | è¯´æ˜ è™šæ‹Ÿå†…å­˜ | æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹åœ°å€ç©ºé—´ ç‰©ç†å†…å­˜ | RAM ç®¡ç† é¡µç¼“å­˜ | åŠ é€Ÿæ–‡ä»¶ IO å†…å­˜å›æ”¶ | reclaim / swap OOM | å†…å­˜è€—å°½æ—¶æ€è¿›ç¨‹\næ ¸å¿ƒæœºåˆ¶ è™šæ‹Ÿå†…å­˜ VA -\u0026gt; PA æ˜ å°„ é¡µè¡¨ï¼ˆpage tableï¼‰ é¡µï¼ˆPageï¼‰ 4K / HugePage ç¼“å­˜ Page Cache Buffer Cache NUMA æœ¬åœ°å†…å­˜ / è¿œç«¯å†…å­˜ å…¸å‹é—®é¢˜ ç°è±¡ æ ¹å›  free çœ‹ç€æœ‰å†…å­˜å´ OOM å¯å›æ”¶å†…å­˜ä¸è¶³ IO æ…¢ Page Cache æŠ–åŠ¨ æ•°æ®åº“æ€§èƒ½ä¸ç¨³ NUMA è·¨èŠ‚ç‚¹è®¿é—® swap æŠ–åŠ¨ swappiness ä¸åˆç† å…³é”®ç‚¹ è™šæ‹Ÿå†…å­˜ é¡µï¼ˆPageï¼‰ ç¼“å­˜ï¼ˆPage Cacheï¼‰ Swap OOM Killer é‡è¦æ¦‚å¿µ RSS / VSZ / SHMEM Buffer / Cache å¸¸ç”¨å·¥å…· free -m vmstat smem 3ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ ä½œç”¨ æä¾›å¯¹å­˜å‚¨è®¾å¤‡ä¸Šæ•°æ®çš„ç»„ç»‡ã€å­˜å‚¨å’Œè®¿é—®èƒ½åŠ›\nç»Ÿä¸€â€œæ–‡ä»¶â€è¿™ä¸€æŠ½è±¡ï¼Œè®©ç¨‹åºä¸å…³å¿ƒåº•å±‚å­˜å‚¨\næ ¸å¿ƒèŒè´£ èŒè´£ è¯´æ˜ æ–‡ä»¶æŠ½è±¡ ä¸€åˆ‡çš†æ–‡ä»¶ ç›®å½•ç»“æ„ æ ‘çŠ¶ç»“æ„ æƒé™ç®¡ç† UID / GID / mode ç¼“å­˜ åŠ é€Ÿ IO æŒ‚è½½ å¤šæ–‡ä»¶ç³»ç»Ÿç»Ÿä¸€ æ ¸å¿ƒæœºåˆ¶ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ ç»Ÿä¸€æ¥å£ inode æ–‡ä»¶å…ƒæ•°æ® dentry ç›®å½•ç¼“å­˜ page cache æ–‡ä»¶è¯»å†™æ€§èƒ½æ ¸å¿ƒ å…¸å‹é—®é¢˜ ç°è±¡ æ ¹å›  å°æ–‡ä»¶å¤š IO æ…¢ inode / dentry å‹åŠ› df æœ‰ç©ºé—´å´å†™ä¸äº† inode ç”¨å°½ æ•°æ®ä¸¢å¤± writeback æœªå®Œæˆ Docker å±‚æ…¢ overlayfs copy-on-write æ ¸å¿ƒæŠ½è±¡ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ inode dentry superblock å¸¸è§ FS FS åœºæ™¯ ext4 é€šç”¨ xfs å¤§æ–‡ä»¶ / é«˜å¹¶å‘ overlayfs å®¹å™¨ å·¥å…· df -Th df -i mount 4ï¸âƒ£ ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ ä½œç”¨ å®ç°å„ç§ç½‘ç»œåè®®ï¼Œä½¿ Linux èƒ½å¤Ÿè¿›è¡Œç½‘ç»œé€šä¿¡\nè´Ÿè´£â€œæ•°æ®åŒ…å¦‚ä½•è¿›å…¥ã€å¤„ç†ã€å‘é€å‡ºç³»ç»Ÿâ€\næ ¸å¿ƒèŒè´£ èŒè´£ è¯´æ˜ åè®®æ ˆ TCP/IP/UDP/ICMP Socket æŠ½è±¡ åº”ç”¨ç»Ÿä¸€æ¥å£ è·¯ç”± æ•°æ®åŒ…å»å“ª é˜²ç«å¢™ netfilter / nftables QoS é™é€Ÿã€é˜Ÿåˆ—è°ƒåº¦ æ ¸å¿ƒæœºåˆ¶ åè®®æ ˆ L2 -\u0026gt; L7 Socket ç”¨æˆ·æ€ â†” å†…æ ¸æ€æ¥å£ é˜Ÿåˆ— tx_queue / rx_queue ä¸­æ–­ \u0026amp; NAPI ç½‘ç»œåŒ…å¤„ç†æ€§èƒ½å…³é”® å…¸å‹é—®é¢˜ ç°è±¡ æ ¹å›  é«˜å¹¶å‘ TCP è¿æ¥æ…¢ backlog / somaxconn ä¸¢åŒ… ç½‘å¡é˜Ÿåˆ—æ»¡ ç½‘ç»œæŠ–åŠ¨ ä¸­æ–­ç»‘æ ¸ä¸åˆç† å®¹å™¨ç½‘ç»œå¤æ‚ namespace + veth æ ¸å¿ƒæ¦‚å¿µ TCP/IP æ ˆ Socket netfilter è·¯ç”±è¡¨ å·¥å…· ip a ip r ss -lntup 5ï¸âƒ£ è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevicesï¼‰ ä½œç”¨ å†…æ ¸ä¸ç¡¬ä»¶è®¾å¤‡é€šä¿¡çš„æ¡¥æ¢\nè®©å†…æ ¸â€œèƒ½å’Œç¡¬ä»¶è¯´è¯â€\nLinuxå†…æ ¸ä¸­æ•°é‡æœ€å¤šçš„ä»£ç å°±æ˜¯è®¾å¤‡é©±åŠ¨\næ ¸å¿ƒèŒè´£ èŒè´£ è¯´æ˜ ç¡¬ä»¶æŠ½è±¡ å±è”½ç¡¬ä»¶å·®å¼‚ é©±åŠ¨ç®¡ç† åŠ è½½/å¸è½½ ä¸­æ–­å¤„ç† IRQ DMA é«˜æ•ˆæ•°æ®ä¼ è¾“ è®¾å¤‡æ¨¡å‹ sysfs / udev æ ¸å¿ƒæœºåˆ¶ é©±åŠ¨æ¨¡å‹ bus / device / driver ä¸­æ–­ IRQ / MSI-X DMA é›¶æ‹·è´ å­—ç¬¦ / å—è®¾å¤‡ /dev/xxx å…¸å‹é—®é¢˜ ç°è±¡ æ ¹å›  IO æŠ–åŠ¨ ä¸­æ–­é›†ä¸­ ç½‘å¡æ€§èƒ½ä½ IRQ æœªç»‘æ ¸ ç£ç›˜æ…¢ I/O scheduler ä¸åŒ¹é… å¯åŠ¨æ…¢ é©±åŠ¨åŠ è½½é˜»å¡ å…³é”®ç‚¹ å­—ç¬¦è®¾å¤‡ / å—è®¾å¤‡ udev /dev å·¥å…· lsblk udevadm info 6ï¸âƒ£ äº”å¤§å­ç³»ç»Ÿå¦‚ä½•ååŒï¼ˆéå¸¸é‡è¦ï¼‰ ä»¥ MySQL ä¸€æ¬¡æŸ¥è¯¢ ä¸ºä¾‹ï¼š\nMySQL è¿›ç¨‹ â†“ è¿›ç¨‹è°ƒåº¦ï¼ˆCPU æ—¶é—´ç‰‡ï¼‰ â†“ å†…å­˜ç®¡ç†ï¼ˆBuffer Pool / Page Cacheï¼‰ â†“ æ–‡ä»¶ç³»ç»Ÿï¼ˆVFS -\u0026gt; ext4 / xfsï¼‰ â†“ å—è®¾å¤‡å±‚ â†“ è®¾å¤‡é©±åŠ¨ï¼ˆNVMe / SATAï¼‰ â†“ ç¡¬ä»¶ ç½‘ç»œè¯·æ±‚åˆ™ä¼šå¤šèµ°ä¸€æ¡ï¼š\nç½‘å¡ -\u0026gt; é©±åŠ¨ -\u0026gt; ç½‘ç»œæ ˆ -\u0026gt; Socket -\u0026gt; MySQL 7ï¸âƒ£ æ€»ç»“ è¿›ç¨‹ï¼šè°è·‘ã€ä»€ä¹ˆæ—¶å€™è·‘ å†…å­˜ï¼šç”¨å¤šå°‘ã€æ”¾å“ªã€å›ä¸å› ç½‘ç»œï¼šåŒ…æ€ä¹ˆè¿›ã€æ€ä¹ˆå‡º æ–‡ä»¶ç³»ç»Ÿï¼šæ•°æ®æ€ä¹ˆå­˜ã€æ€ä¹ˆè¯» è®¾å¤‡é©±åŠ¨ï¼šç¡¬ä»¶æ€ä¹ˆç”¨ ä¸‰ã€ç”¨æˆ·ç©ºé—´æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ Shell ä¸ç¯å¢ƒ é¡¹ç›® è¯´æ˜ bash / sh å‘½ä»¤è§£é‡Š PATH å‘½ä»¤æŸ¥æ‰¾ env ç¯å¢ƒå˜é‡ echo $PATH env 2ï¸âƒ£ GNU å·¥å…·é“¾ï¼ˆé€šç”¨ï¼‰ coreutilsï¼šlsã€cpã€mv util-linuxï¼šmountã€fdisk procpsï¼špsã€top å››ã€systemdï¼ˆç°ä»£ Linux çš„â€œä¸­æ¢ç¥ç»â€ï¼‰ systemd ç®¡ä»€ä¹ˆï¼Ÿ\næ¨¡å— åŠŸèƒ½ systemd init journald æ—¥å¿— networkd ç½‘ç»œ resolved DNS timedated æ—¶é—´ target â‰ˆ runlevel\ntarget å«ä¹‰ multi-user.target æœåŠ¡å™¨æ¨¡å¼ graphical.target æ¡Œé¢ rescue.target å•ç”¨æˆ· emergency.target ç´§æ€¥ äº”ã€è½¯ä»¶åŒ…ç®¡ç†ï¼ˆå‘è¡Œç‰ˆå·®å¼‚é‡ç‚¹ï¼‰ RHEL / AlmaLinux é¡¹ç›® å·¥å…· åŒ…ç®¡ç† rpm å‰ç«¯ dnf ä»“åº“ BaseOS / AppStream ç¬¬ä¸‰æ–¹ EPEL dnf install nginx dnf update Debian / Ubuntu é¡¹ç›® å·¥å…· åŒ…ç®¡ç† dpkg å‰ç«¯ apt ä»“åº“ main / universe ç¬¬ä¸‰æ–¹ PPA apt install nginx apt upgrade å…­ã€æ–‡ä»¶ç³»ç»Ÿå±‚çº§ï¼ˆFHSï¼‰ ç›®å½• å«ä¹‰ / æ ¹ /etc é…ç½® /var å˜åŒ–æ•°æ® /usr ç¨‹åº /bin /sbin åŸºç¡€å‘½ä»¤ /proc è¿›ç¨‹ /sys å†…æ ¸æ¥å£ ä¸ƒã€æƒé™ä¸å®‰å…¨æ¨¡å‹ 1ï¸âƒ£ ç”¨æˆ· / ç»„ / æƒé™ rwx rwx rwx UID / GID suid / sgid / sticky 2ï¸âƒ£ PAM ç™»å½•è®¤è¯ sudo ssh 3ï¸âƒ£ MAC ç³»ç»Ÿ å‘è¡Œç‰ˆ SELinux RHEL / AlmaLinux AppArmor Ubuntu å…«ã€å¯åŠ¨æµç¨‹ï¼ˆBIOS -\u0026gt; Shellï¼‰ BIOS/UEFI â†“ GRUB â†“ Kernel â†“ initramfs â†“ systemd â†“ services ä¹ã€æ—¥å¿—ä½“ç³» ç³»ç»Ÿ æ—¥å¿— journal systemd rsyslog ä¼ ç»Ÿ /var/log æ–‡æœ¬ journalctl journalctl -u sshd åã€ç½‘ç»œé…ç½®å·®å¼‚ RHEL / AlmaLinux NetworkManager nmcli Debian / Ubuntu netplan systemd-networkd åä¸€ã€å®¹å™¨ä¸è™šæ‹ŸåŒ–åŸºç¡€ æŠ€æœ¯ æ ¸å¿ƒ namespace éš”ç¦» cgroup èµ„æº overlayfs å­˜å‚¨ KVM è™šæ‹ŸåŒ– åäºŒã€èµ„æºé™åˆ¶ä¸è°ƒä¼˜ ulimit cgroup sysctl ulimit -n sysctl -a åä¸‰ã€å‘è¡Œç‰ˆè®¾è®¡å“²å­¦å·®å¼‚ï¼ˆå¾ˆé‡è¦ï¼‰ ç»´åº¦ RHEL / AlmaLinux Debian / Ubuntu ç¨³å®šæ€§ æé«˜ é«˜ æ›´æ–°é¢‘ç‡ æ…¢ å¿« é»˜è®¤å®‰å…¨ SELinux AppArmor ä¼ä¸šæ”¯æŒ å¼º å¼º åå››ã€è¿ç»´è§†è§’çš„ Linux èƒ½åŠ›æ¨¡å‹ å¯ä»¥æŠŠ Linux èƒ½åŠ›åˆ†æˆ 5 å±‚ï¼š\nç³»ç»Ÿç»“æ„ èµ„æºç®¡ç† æœåŠ¡ç®¡ç† å®‰å…¨æ¨¡å‹ æ•…éšœæ’æŸ¥ åäº”ã€æ€»ç»“ Linux çš„æœ¬è´¨æ˜¯ï¼šå†…æ ¸è´Ÿè´£â€œè§„åˆ™â€ï¼Œç”¨æˆ·ç©ºé—´è´Ÿè´£â€œä½¿ç”¨è§„åˆ™â€ï¼Œå‘è¡Œç‰ˆè´Ÿè´£â€œé»˜è®¤ç­–ç•¥â€ã€‚\n","description":"å‚è€ƒæ–‡æ¡£ï¼š\nLinux å†…æ ¸æ•´ä½“æ¶æ„è¯¦è§£ æ·±å…¥ç†è§£Linux Kernelå†…æ ¸æ•´ä½“æ¶æ„(å›¾æ–‡è¯¦è§£) åã€Œä½“ç³»åŒ– + è¿ç»´/æ¶æ„è§†è§’ã€ çš„Linux ç³»ç»Ÿ Â· æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®ºæ€»è§ˆã€‚\nè¦†ç›– RHEL / AlmaLinux ä¸ Debian / Ubuntu ç³»åˆ—ã€‚\nä¸€ã€Linux çš„æ•´ä½“æ¶æ„ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ +----------------------------------------------------+ åº”ç”¨ç¨‹åº / æœåŠ¡ Nginx / MySQL / Docker / Kubernetes +----------------------------------------------------+ ç”¨æˆ·ç©ºé—´ (User Space) shell / libc / systemd / PAM / udev +----------------------------------------------------+ å†…æ ¸ç©ºé—´ (Kernel) è¿›ç¨‹ç®¡ç† / å†…å­˜ç®¡ç† / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œå­ç³»ç»Ÿ / è®¾å¤‡ä¸é©±åŠ¨ cgroups / namespaces / è™šæ‹ŸåŒ– / NUMA / security +----------------------------------------------------+ ç¡¬ä»¶ (CPU / RAM / Disk / NIC / GPU) +----------------------------------------------------+ ğŸ‘‰ Linux â‰  å‘è¡Œç‰ˆ\n"},{"id":60,"href":"/operations/lvs/tutorial/","title":"LVS åŸºç¡€æ•™ç¨‹","parent":"LVS","content":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€ä¸‰ç§æ¨¡å¼ã€è°ƒåº¦ç®—æ³•ã€å®é™…æ¶æ„ã€ç”Ÿäº§çº§é…ç½®ã€æ•…éšœæ’æŸ¥ã€æœ€ä½³å®è·µã€‚\nä¸€ã€LVS æ˜¯ä»€ä¹ˆï¼Ÿ LVS = Linux Virtual Server\næ˜¯ Linux å†…æ ¸ä¸­çš„å››å±‚è´Ÿè½½å‡è¡¡æ¡†æ¶ï¼Œé€šè¿‡ è™šæ‹Ÿ IPï¼ˆVIPï¼‰+ è½¬å‘æœåŠ¡å™¨ï¼ˆDirectorï¼‰ + åç«¯ Real Serverï¼ˆRSï¼‰ çš„æ–¹å¼æä¾›é«˜å¹¶å‘ã€é«˜å¯ç”¨ã€ä½å»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ã€‚\né€‚ç”¨äºï¼š\nWeb æœåŠ¡ï¼ˆNginxã€Tomcatã€Flask ç­‰ï¼‰ TCP æœåŠ¡ï¼ˆRedisã€MySQLã€MQï¼‰ ä»»æ„å››å±‚ TCP/UDP æœåŠ¡ ç‰¹ç‚¹ï¼š\nå››å±‚è½¬å‘ -\u0026gt; æé«˜æ€§èƒ½ï¼ˆç™¾ä¸‡çº§å¹¶å‘ï¼‰ å†…æ ¸æ€è½¬å‘ -\u0026gt; æä½å»¶è¿Ÿ æ­é… Keepalived -\u0026gt; è‡ªåŠ¨æ•…éšœåˆ‡æ¢ï¼ˆHAï¼‰ äºŒã€LVS çš„ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼ˆæ ¸å¿ƒï¼‰ 1ï¼‰LVS-NATï¼ˆNetwork Address Translationï¼‰ åŸç†ï¼šDirector ä¿®æ”¹æŠ¥æ–‡çš„æº/ç›®çš„åœ°å€ï¼Œè½¬å‘ç»™ RSã€‚RS çš„å›å¤ä¹Ÿå›åˆ° Directorï¼Œå† NAT å›å®¢æˆ·ç«¯ã€‚\nç‰¹ç‚¹ï¼š\næµé‡è¿›å‡ºéƒ½ç»è¿‡ Director -\u0026gt; å®¹æ˜“æˆä¸ºç“¶é¢ˆ RS å¯ä»¥ä½¿ç”¨ä»»æ„æ“ä½œç³»ç»Ÿ RS å¿…é¡»æŠŠé»˜è®¤è·¯ç”±æŒ‡å‘ Director é€‚ç”¨ï¼šå°ä¸­å‹æµé‡ã€ç®€å•éƒ¨ç½²\n2ï¼‰LVS-DRï¼ˆDirect Routingï¼‰\u0026ndash; ç”Ÿäº§æœ€å¸¸ç”¨ åŸç†ï¼š\nDirector åªè´Ÿè´£è¯·æ±‚æµé‡ï¼› RS é€šè¿‡è‡ªå·±çš„ lo ç»‘å®š VIPï¼Œå¹¶ ç›´æ¥å›åŒ…ç»™å®¢æˆ·ç«¯ï¼ˆä¸ç»è¿‡ Directorï¼‰ã€‚ å…³é”®ï¼šVIP éœ€è¦åœ¨æ‰€æœ‰ RS çš„ loopback ç»‘å®šï¼Œå¹¶å…³é—­ ARPï¼š\nnet.ipv4.conf.all.arp_ignore = 1 net.ipv4.conf.all.arp_announce = 2 ç‰¹ç‚¹ï¼š\næ€§èƒ½æé«˜ï¼šå‡ºå£æµé‡ä¸ç»è¿‡ Director RS å¿…é¡»åœ¨åŒä¸€ LANï¼ˆäºŒå±‚ç½‘ç»œï¼‰ VIP è¦ç‰¹æ®Šå¤„ç† ARP é€‚ç”¨ï¼šé«˜å¹¶å‘ Web æœåŠ¡ï¼ˆè¡Œä¸šå†…æœ€å¸¸ç”¨ï¼‰\n3ï¼‰LVS-TUNï¼ˆIP Tunnelingï¼‰ åŸç†ï¼šDirector ä½¿ç”¨ IPIP éš§é“è½¬å‘è¯·æ±‚ç»™ RSï¼ŒRS è§£å°è£…åç›´æ¥å›åŒ…å®¢æˆ·ç«¯ã€‚\nç‰¹ç‚¹ï¼š\nRS å¯ä»¥è·¨åœ°åŸŸ/è·¨æœºæˆ¿ï¼ˆä¸‰å±‚ç½‘ç»œéƒ½è¡Œï¼‰ æ€§èƒ½é«˜äº NATï¼ˆå›åŒ…ä¸èµ° Directorï¼‰ éœ€è¦ RS æ”¯æŒ Tunnel é€‚ç”¨ï¼šå¤§è§„æ¨¡è·¨ç½‘ç»œè´Ÿè½½åœºæ™¯ï¼ˆä¸å¸¸è§ï¼‰\nä¸‰ã€LVS è°ƒåº¦ç®—æ³•ï¼ˆå¸¸è€ƒï¼‰ é™æ€ç®—æ³•\nç®—æ³• è¯´æ˜ RR è½®è¯¢ WRR å¸¦æƒé‡è½®è¯¢ SH æºåœ°å€å“ˆå¸Œï¼ˆå›ºå®šæ¥æºåˆ†é…åˆ°å›ºå®š RSï¼‰ DHL ç›®æ ‡åœ°å€å“ˆå¸Œ åŠ¨æ€ç®—æ³•\nç®—æ³• è¯´æ˜ LC æœ€å°‘è¿æ¥ WLC åŠ æƒæœ€å°‘è¿æ¥ SED æœ€çŸ­æœŸæœ›å»¶è¿Ÿç®—æ³• NQ ä»ä¸æ’é˜Ÿï¼ˆNo Queueï¼‰ç®—æ³• ç”Ÿäº§å¸¸ç”¨ï¼šWLC / WRR / SH\nå››ã€å…¸å‹ LVS æ¶æ„å›¾ï¼ˆç”Ÿäº§ï¼‰ LVS-DR + Keepalived çƒ­å¤‡ HA\n+---------------------+ | Keepalived VIP | +-----------+---------+ | +------------+------------+ | LVS Master | +-------------------------+ | DR Mode (VIP on lo) | +-------------------------+ | ï¼ˆä»…è¯·æ±‚æµé‡ï¼‰ | +-----------+-------------+------------+ | | | | +--+--+ +--+--+ +--+--+ +--+--+ | RS1 | | RS2 | | RS3 | | RS4 | +--+--+ +--+--+ +--+--+ +--+--+ | | | | +------------+-------------+------------+ ç›´æ¥å›åŒ… äº”ã€LVS æ ¸å¿ƒå‘½ä»¤ï¼ˆipvsadmï¼‰ æŸ¥çœ‹è§„åˆ™\nipvsadm -Ln æ·»åŠ è™šæ‹ŸæœåŠ¡ï¼ˆç¤ºä¾‹ï¼šVIP:80ï¼‰\nipvsadm -A -t 10.0.0.10:80 -s wlc æ·»åŠ  RSï¼ˆDR æ¨¡å¼ï¼‰\nipvsadm -a -t 10.0.0.10:80 -r 10.0.0.11:80 -g -w 1 ipvsadm -a -t 10.0.0.10:80 -r 10.0.0.12:80 -g -w 1 é€‰é¡¹è¯´æ˜ï¼š\n-tï¼šTCP -sï¼šè°ƒåº¦ç®—æ³• -gï¼šDR æ¨¡å¼ï¼ˆgatewayï¼‰ -wï¼šæƒé‡ å…­ã€Keepalived + LVS é…ç½®ç¤ºä¾‹ï¼ˆDRï¼‰ /etc/keepalived/keepalived.conf\nvrrp_instance VI_1 { state MASTER interface eth0 priority 100 virtual_router_id 51 advert_int 1 authentication { auth_type PASS auth_pass 123456 } virtual_ipaddress { 10.0.0.10 } } virtual_server 10.0.0.10 80 { delay_loop 6 lb_algo wlc lb_kind DR protocol TCP real_server 10.0.0.11 80 { weight 1 TCP_CHECK { connect_timeout 3 nb_get_retry 3 delay_before_retry 3 connect_port 80 } } real_server 10.0.0.12 80 { weight 1 TCP_CHECK { connect_timeout 3 nb_get_retry 3 delay_before_retry 3 connect_port 80 } } } ä¸ƒã€Real Server é…ç½® DR æ¨¡å¼ï¼ˆæ ¸å¿ƒï¼‰ 1ï¼‰ç»‘å®š VIP åˆ° lo ip addr add 10.0.0.10/32 dev lo 2ï¼‰é˜²æ­¢ ARP æŠ¢ç­” echo 1 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_ignore echo 2 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_announce echo 1 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_ignore echo 2 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_announce å…«ã€LVS å…¸å‹æ•…éšœæ’æŸ¥ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¼‰RS æ— æ³•æ¥æ”¶æµé‡ VIP æ²¡ç»‘åˆ° loopback ARP é…ç½®é”™è¯¯ -\u0026gt; RS æŠ¢ç­”äº† VIP DR æ¨¡å¼ RS ä¸åœ¨åŒä¸€äºŒå±‚ç½‘ç»œ 2ï¼‰RS å¯ä»¥æ¥æ”¶è¯·æ±‚ä½†å®¢æˆ·ç«¯æ”¶ä¸åˆ°å“åº” DR æ¨¡å¼ä¸‹å¿…é¡» RS ç›´æ¥å›åŒ…å®¢æˆ·ç«¯ è·¯ç”±é”™è¯¯å¯¼è‡´å›åŒ…èµ° Director 3ï¼‰VIP æ¼‚ç§»ä¸ç”Ÿæ•ˆ Keepalived æ²¡æœ‰æƒé™ç»‘å®š VIP interface å†™é”™ VRRP id é‡å¤ 4ï¼‰æƒé‡ä¸ç”Ÿæ•ˆ ç®—æ³•ä½¿ç”¨ RR è€Œä¸æ˜¯ WRR/WLC 5ï¼‰ipvsadm è§„åˆ™ä¸¢å¤± Keepalived é‡å¯æ—¶ reload å¼€æœºæœªå¯ç”¨æœåŠ¡ ä¹ã€LVS æœ€ä½³å®è·µï¼ˆè¿ç»´å¿…å¤‡ï¼‰ 1. å°½é‡ä½¿ç”¨ DR æ¨¡å¼ï¼ˆæ€§èƒ½æœ€å¼ºï¼‰ é€‚åˆ Web / API æœåŠ¡\n2. æ­é… Keepalived åšé«˜å¯ç”¨ï¼ˆVIP æ¼‚ç§»ï¼‰ 3. Real Server å¿…é¡»å…³é—­ ARP æŠ¢ç­” 4. æ›´æ¨èä½¿ç”¨ WLC è°ƒåº¦ç®—æ³• 5. Keepalived å¥åº·æ£€æŸ¥å¿…é¡»å¯ç”¨ TCP_CHECK / HTTP_GET\n6. å°† LVS Director åªåšè°ƒåº¦ï¼Œä¸åšåº”ç”¨ é¿å…å•æœºèµ„æºæŠ¢å \n7. æ‰“å¼€ LVS è¿æ¥åŒæ­¥ï¼ˆconn syncï¼‰ ç”¨äº Master/Backup åˆ‡æ¢æ— æ„Ÿ\nsync_master sync_backup 8. ç›‘æ§ LVS ipvsadm è¿æ¥æ•° Keepalived åˆ‡æ¢æ¬¡æ•° RS å¥åº·æƒ…å†µ ç½‘ç»œ/ARP å¼‚å¸¸ ","description":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€ä¸‰ç§æ¨¡å¼ã€è°ƒåº¦ç®—æ³•ã€å®é™…æ¶æ„ã€ç”Ÿäº§çº§é…ç½®ã€æ•…éšœæ’æŸ¥ã€æœ€ä½³å®è·µã€‚\nä¸€ã€LVS æ˜¯ä»€ä¹ˆï¼Ÿ LVS = Linux Virtual Server\næ˜¯ Linux å†…æ ¸ä¸­çš„å››å±‚è´Ÿè½½å‡è¡¡æ¡†æ¶ï¼Œé€šè¿‡ è™šæ‹Ÿ IPï¼ˆVIPï¼‰+ è½¬å‘æœåŠ¡å™¨ï¼ˆDirectorï¼‰ + åç«¯ Real Serverï¼ˆRSï¼‰ çš„æ–¹å¼æä¾›é«˜å¹¶å‘ã€é«˜å¯ç”¨ã€ä½å»¶è¿Ÿçš„è´Ÿè½½å‡è¡¡ã€‚\né€‚ç”¨äºï¼š\nWeb æœåŠ¡ï¼ˆNginxã€Tomcatã€Flask ç­‰ï¼‰ TCP æœåŠ¡ï¼ˆRedisã€MySQLã€MQï¼‰ ä»»æ„å››å±‚ TCP/UDP æœåŠ¡ ç‰¹ç‚¹ï¼š\nå››å±‚è½¬å‘ -\u0026gt; æé«˜æ€§èƒ½ï¼ˆç™¾ä¸‡çº§å¹¶å‘ï¼‰ å†…æ ¸æ€è½¬å‘ -\u0026gt; æä½å»¶è¿Ÿ æ­é… Keepalived -\u0026gt; è‡ªåŠ¨æ•…éšœåˆ‡æ¢ï¼ˆHAï¼‰ äºŒã€LVS çš„ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼ˆæ ¸å¿ƒï¼‰ 1ï¼‰LVS-NATï¼ˆNetwork Address Translationï¼‰ åŸç†ï¼šDirector ä¿®æ”¹æŠ¥æ–‡çš„æº/ç›®çš„åœ°å€ï¼Œè½¬å‘ç»™ RSã€‚RS çš„å›å¤ä¹Ÿå›åˆ° Directorï¼Œå† NAT å›å®¢æˆ·ç«¯ã€‚\n"},{"id":61,"href":"/operations/lvs/core/","title":"LVS æ ¸å¿ƒæ¦‚å¿µ","parent":"LVS","content":" ä¸€ã€LVS åˆ°åº•è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ä¸€å¥è¯ï¼š\nLVS è§£å†³çš„æ˜¯ã€Œå¤§é‡å¹¶å‘ TCP/UDP è¿æ¥å¦‚ä½•é«˜æ€§èƒ½åˆ†å‘åˆ°å¤šå°åç«¯æœåŠ¡å™¨ã€çš„é—®é¢˜ã€‚\nå®ƒçš„å…³æ³¨ç‚¹åªæœ‰ä¸€ä¸ªï¼š\nè¿æ¥æ€ä¹ˆè½¬å‘å¾—æœ€å¿«ã€æœ€ç¨³å®šã€‚\næ‰€ä»¥ LVS çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š\nä¸è§£æåº”ç”¨å±‚ ä¸å…³å¿ƒ HTTP / URL / Cookie ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ åªåš å››å±‚è½¬å‘ äºŒã€LVS åœ¨ç½‘ç»œæ ˆä¸­çš„ä½ç½®ï¼ˆéå¸¸å…³é”®ï¼‰ LVS å·¥ä½œåœ¨ Linux å†…æ ¸ç½‘ç»œæ ˆçš„å››å±‚ï¼ˆTransport Layerï¼‰ï¼š\nåº”ç”¨å±‚ (HTTP / HTTPS / RPC) -------------------------------- ä¼ è¾“å±‚ (TCP / UDP) \u0026lt;- LVS åœ¨è¿™é‡Œ -------------------------------- ç½‘ç»œå±‚ (IP) -------------------------------- é“¾è·¯å±‚ (Ethernet) å¯¹æ¯”ï¼š\nLVSï¼šå››å±‚ï¼ˆTCP/UDPï¼‰ Nginx / HAProxyï¼šä¸ƒå±‚ï¼ˆHTTPï¼‰ è¿™å†³å®šäº† LVS çš„ä¸€åˆ‡ç‰¹æ€§ã€‚\nä¸‰ã€LVS çš„æ ¸å¿ƒç»„æˆï¼ˆ3 ä¸ªè§’è‰²ï¼‰ LVS ä¸æ˜¯ä¸€å°æœºå™¨ï¼Œè€Œæ˜¯ä¸€ä¸ªé€»è¾‘é›†ç¾¤ã€‚\n1ï¸âƒ£ Directorï¼ˆè°ƒåº¦å™¨ï¼‰ å¯¹å¤–æš´éœ² VIP æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ æ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹© RS è½¬å‘æ•°æ®åŒ… Director åªåšè°ƒåº¦ï¼Œä¸åšä¸šåŠ¡ã€‚\n2ï¸âƒ£ VIPï¼ˆVirtual IPï¼‰ å¯¹å¤–ç»Ÿä¸€è®¿é—®å…¥å£ æ¼‚ç§»åœ¨ä¸åŒ Director ä¹‹é—´ å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼šæ°¸è¿œä¸å˜ VIP æ˜¯ LVS çš„\u0026quot;é—¨é¢\u0026quot;ã€‚\n3ï¸âƒ£ RSï¼ˆReal Serverï¼‰ çœŸæ­£å¤„ç†ä¸šåŠ¡è¯·æ±‚ Web / API / DB / TCP æœåŠ¡ å¯¹ LVS æ¥è¯´æ˜¯\u0026quot;èµ„æºæ± \u0026quot; å››ã€LVS çš„å·¥ä½œæŠ½è±¡æ¨¡å‹ å¯ä»¥æŠŠ LVS ç†è§£æˆï¼š\nå®¢æˆ·ç«¯ â†“ VIPï¼ˆè™šæ‹ŸæœåŠ¡ï¼‰ â†“ è°ƒåº¦ç®—æ³• â†“ Real Serverï¼ˆçœŸå®æœåŠ¡ï¼‰ LVS åªå…³å¿ƒï¼š\nè¿™ä¸ªè¿æ¥å±äºå“ªä¸ªè™šæ‹ŸæœåŠ¡ï¼Ÿ å½“å‰è¯¥é€‰å“ªä¸ª RSï¼Ÿ äº”ã€LVS çš„ã€Œè™šæ‹ŸæœåŠ¡ã€æ˜¯ä»€ä¹ˆï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒä½†å®¹æ˜“å¿½ç•¥çš„æ¦‚å¿µã€‚\nåœ¨ LVS é‡Œï¼š\nVIP + PORT + PROTOCOL = ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ ä¾‹å¦‚ï¼š\n10.0.0.10:80/TCP 10.0.0.10:443/TCP 10.0.0.10:53/UDP æ¯ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼š\nç‹¬ç«‹è°ƒåº¦ç®—æ³• ç‹¬ç«‹ RS åˆ—è¡¨ ç‹¬ç«‹æƒé‡å’Œå¥åº·çŠ¶æ€ å…­ã€LVS ä¸ºä»€ä¹ˆæ€§èƒ½æé«˜ï¼Ÿï¼ˆåº•å±‚åŸå› ï¼‰ 1ï¸âƒ£ å®Œå…¨åœ¨å†…æ ¸æ€ æ— ç”¨æˆ·æ€ / å†…æ ¸æ€åˆ‡æ¢ æ— è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ 2ï¸âƒ£ ä¸è§£æåº”ç”¨åè®® ä¸æ‹† HTTP ä¸è§£æ Header ä¸åšå­—ç¬¦ä¸²å¤„ç† 3ï¸âƒ£ æ•°æ®ç»“æ„æç®€ hash table + é“¾è¡¨ O(1) æŸ¥æ‰¾ 4ï¸âƒ£ å¯é€‰\u0026quot;æ— å›åŒ…è·¯å¾„\u0026quot; DR / TUN æ¨¡å¼ä¸­ å“åº”æµé‡ä¸ç»è¿‡ Director ğŸ‘‰ æ‰€ä»¥ LVS çš„ç“¶é¢ˆå¾€å¾€æ˜¯ç½‘å¡ï¼Œè€Œä¸æ˜¯ CPUã€‚\nä¸ƒã€LVS ä¸‰ç§è½¬å‘æ¨¡å¼ï¼ˆç†è®ºè§†è§’ï¼‰ 1ï¸âƒ£ NAT æ¨¡å¼ï¼ˆæ”¹åœ°å€ï¼‰ Client -\u0026gt; Director -\u0026gt; RS Client \u0026lt;- Director \u0026lt;- RS Director æ˜¯æµé‡ç“¶é¢ˆ ç®€å•ä½†ä¸é€‚åˆå¤§æµé‡ 2ï¸âƒ£ DR æ¨¡å¼ï¼ˆç›´æ¥è·¯ç”±ï¼‰ Client -\u0026gt; Director -\u0026gt; RS Client \u0026lt;-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RS Director åªæ”¶è¯·æ±‚ RS ç›´æ¥å›åŒ… æ€§èƒ½æœ€å¼º å…³é”®ç†è®ºç‚¹ï¼š\nè¯·æ±‚å’Œå“åº”è·¯å¾„æ˜¯ä¸åŒçš„\n3ï¸âƒ£ TUN æ¨¡å¼ï¼ˆIP éš§é“ï¼‰ Client -\u0026gt; Director -\u0026gt; (IPIP) -\u0026gt; RS Client \u0026lt;-â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RS è¯·æ±‚å°è£…è½¬å‘ å“åº”ç›´è¿”å®¢æˆ·ç«¯ é€‚åˆè·¨ç½‘ç»œ å…«ã€LVS ä¸ ARP çš„å…³ç³»ï¼ˆDR æ¨¡å¼æœ¬è´¨ï¼‰ åœ¨ DR æ¨¡å¼ä¸­ï¼š\nDirector å’Œ RS åŒæ—¶æ‹¥æœ‰ VIP ä½† åªæœ‰ Director èƒ½å›ç­” ARP å¦åˆ™ä¼šå‘ç”Ÿï¼š\nå®¢æˆ·ç«¯ -\u0026gt; ç›´æ¥è®¿é—® RSï¼ˆç»•è¿‡ LVSï¼‰ æ‰€ä»¥æœ¬è´¨è¦æ±‚æ˜¯ï¼š\nRS å¿…é¡»\u0026#34;æ‹¥æœ‰ VIPï¼Œä½†ä¸èƒ½å¯¹å¤–å®£ç§° VIP\u0026#34; è¿™å°±æ˜¯å…³é—­ ARP çš„ç†è®ºåŸå› ã€‚\nä¹ã€è°ƒåº¦ç®—æ³•çš„æœ¬è´¨ï¼ˆä¸æ˜¯è½®è¯¢é‚£ä¹ˆç®€å•ï¼‰ è°ƒåº¦ç®—æ³•è§£å†³çš„æ˜¯ï¼š\n\u0026ldquo;ä¸‹ä¸€ä¸ªè¿æ¥è¯¥åˆ†ç»™è°ï¼Ÿ\u0026rdquo;\nLVS çš„ç®—æ³•æœ¬è´¨åˆ†ä¸¤ç±»ï¼š\n1ï¸âƒ£ é™æ€ç®—æ³• ä¸å…³å¿ƒå½“å‰è´Ÿè½½ åªæŒ‰è§„åˆ™åˆ†å‘ ä¾‹å¦‚ï¼š\nRR / WRR SHï¼ˆæº IP hashï¼‰ 2ï¸âƒ£ åŠ¨æ€ç®—æ³• å…³æ³¨ RS å½“å‰çŠ¶æ€ æ›´æ™ºèƒ½ ä¾‹å¦‚ï¼š\nLC / WLC SED / NQ æ ¸å¿ƒè®¤çŸ¥ï¼š\nLVS çš„ \u0026ldquo;è¿æ¥æ•°\u0026rdquo; â‰  QPSï¼Œæ˜¯ TCP è¿æ¥ï¼Œè€Œä¸æ˜¯ HTTP è¯·æ±‚ã€‚\nåã€LVS çš„è¿æ¥æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ LVS æ˜¯ é¢å‘è¿æ¥çš„è´Ÿè½½å‡è¡¡ï¼š\nä¸€ä¸ª TCP è¿æ¥å»ºç«‹å æ•´ä¸ªç”Ÿå‘½å‘¨æœŸéƒ½ç»‘å®šåˆ°åŒä¸€ä¸ª RS åç»­æ•°æ®åŒ…ä¸ä¼šé‡æ–°è°ƒåº¦ è¿™ä¿è¯äº†ï¼š\nTCP çŠ¶æ€å®Œæ•´ åº”ç”¨å±‚æ— éœ€æ„ŸçŸ¥ LVS åä¸€ã€Session ç²˜æ»çš„ç†è®ºåŸºç¡€ LVS æœ¬èº«æ˜¯å››å±‚ï¼Œä¸ç†è§£ Sessionï¼Œä½†å¯ä»¥é€šè¿‡ï¼š\næºåœ°å€ hash è¿æ¥æŒä¹…åŒ–æ—¶é—´ æ¥ä¿è¯ï¼š\nåŒä¸€ä¸ªå®¢æˆ·ç«¯ -\u0026gt; åŒä¸€ä¸ª RS\nè¿™æ˜¯ä¼ è¾“å±‚çº§åˆ«çš„\u0026quot;ä¼ªä¼šè¯ä¿æŒ\u0026quot;ã€‚\nåäºŒã€Keepalived åœ¨ LVS ç†è®ºä¸­çš„ä½ç½® Keepalived ä¸æ˜¯ LVS çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ï¼š\nVRRP -\u0026gt; è§£å†³ VIP é«˜å¯ç”¨ å¥åº·æ£€æŸ¥ -\u0026gt; å†³å®š RS æ˜¯å¦å¯ç”¨ è‡ªåŠ¨ç»´æŠ¤ LVS å†…æ ¸è§„åˆ™ ç†è®ºå…³ç³»ï¼š\nKeepalived è´Ÿè´£\u0026#34;è°å¯¹å¤–\u0026#34; LVS è´Ÿè´£\u0026#34;æµé‡æ€ä¹ˆåˆ†\u0026#34; åä¸‰ã€LVS çš„é«˜å¯ç”¨æœ¬è´¨ LVS æœ¬èº«ä¸å…·å¤‡ HAï¼Œéœ€è¦ï¼š\nä¸¤å° Director ä¸€ä¸ª VIP VRRP åè®® æœ€ç»ˆç›®æ ‡ï¼š\nVIP æ°¸è¿œå­˜åœ¨ï¼Œä½† Director å¯ä»¥éšæ—¶æ›´æ¢\nåå››ã€LVS çš„é€‚ç”¨ä¸ä¸é€‚ç”¨åœºæ™¯ï¼ˆç†è®ºåˆ¤æ–­ï¼‰ é€‚åˆï¼š\né«˜å¹¶å‘ TCP / UDP Web / API å‰ç½® Redis / MySQL / MQ DNS / æ¸¸æˆ / æ¨æµ ä¸é€‚åˆï¼š\nåŸºäº URL / Header è·¯ç”± SSL å¸è½½ å¤æ‚ä¸ƒå±‚é€»è¾‘ å¾®æœåŠ¡ç½‘å…³ï¼ˆå•ç‹¬ç”¨ï¼‰ åäº”ã€æ€»ç»“ LVS æ˜¯ä¸€ä¸ªä»¥å†…æ ¸ä¸ºæ ¸å¿ƒã€ä»¥è¿æ¥ä¸ºå•ä½ã€ä»¥æ€§èƒ½ä¸ºç¬¬ä¸€ç›®æ ‡çš„å››å±‚è´Ÿè½½å‡è¡¡ç³»ç»Ÿã€‚\n","description":" ä¸€ã€LVS åˆ°åº•è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ä¸€å¥è¯ï¼š\nLVS è§£å†³çš„æ˜¯ã€Œå¤§é‡å¹¶å‘ TCP/UDP è¿æ¥å¦‚ä½•é«˜æ€§èƒ½åˆ†å‘åˆ°å¤šå°åç«¯æœåŠ¡å™¨ã€çš„é—®é¢˜ã€‚\nå®ƒçš„å…³æ³¨ç‚¹åªæœ‰ä¸€ä¸ªï¼š\nè¿æ¥æ€ä¹ˆè½¬å‘å¾—æœ€å¿«ã€æœ€ç¨³å®šã€‚\næ‰€ä»¥ LVS çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š\nä¸è§£æåº”ç”¨å±‚ ä¸å…³å¿ƒ HTTP / URL / Cookie ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ åªåš å››å±‚è½¬å‘ äºŒã€LVS åœ¨ç½‘ç»œæ ˆä¸­çš„ä½ç½®ï¼ˆéå¸¸å…³é”®ï¼‰ LVS å·¥ä½œåœ¨ Linux å†…æ ¸ç½‘ç»œæ ˆçš„å››å±‚ï¼ˆTransport Layerï¼‰ï¼š\nåº”ç”¨å±‚ (HTTP / HTTPS / RPC) -------------------------------- ä¼ è¾“å±‚ (TCP / UDP) \u0026lt;- LVS åœ¨è¿™é‡Œ -------------------------------- ç½‘ç»œå±‚ (IP) -------------------------------- é“¾è·¯å±‚ (Ethernet) å¯¹æ¯”ï¼š\n"},{"id":62,"href":"/database/mongo/tutorial/","title":"MongoDB åŸºç¡€æ•™ç¨‹","parent":"MongoDB","content":"MongoDB è¯¦ç»†ä»‹ç»ï¼šæ ¸å¿ƒæ¦‚å¿µ + åº•å±‚åŸç† + åº”ç”¨åœºæ™¯ + æœ€ä½³å®è·µï¼‰ï¼Œåå·¥ç¨‹åŒ–ã€æ¶æ„åŒ–\nğŸ§© 1. MongoDB æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ª æ–‡æ¡£å‹ NoSQL æ•°æ®åº“ï¼Œä½¿ç”¨ BSONï¼ˆäºŒè¿›åˆ¶ JSONï¼‰å­˜å‚¨æ•°æ®ï¼Œå…·æœ‰ï¼š\næ— æ¨¡å¼ Schema-less æ°´å¹³æ‰©å±•èƒ½åŠ›å¼ºï¼ˆShardingï¼‰ é«˜æ€§èƒ½è¯»å†™ åŸç”Ÿå¤åˆ¶é›†é«˜å¯ç”¨ï¼ˆReplica Setï¼‰ ä¸°å¯ŒæŸ¥è¯¢èƒ½åŠ›ï¼ˆèšåˆç®¡é“ã€ç´¢å¼•ç­‰ï¼‰ æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡ï¼ˆ4.0+ï¼‰ å®ƒéå¸¸é€‚åˆå­˜å‚¨ éç»“æ„åŒ–ã€åŠç»“æ„åŒ–ã€å¤§è§„æ¨¡ã€é«˜å¹¶å‘æ•°æ®ã€‚\nğŸ§© 2. MongoDB çš„æ ¸å¿ƒæ¦‚å¿µ 2.1 æ–‡æ¡£ï¼ˆDocumentï¼‰ MongoDB åŸºæœ¬å•ä½ï¼Œç›¸å½“äºå…³ç³»æ•°æ®åº“é‡Œçš„â€œè¡Œâ€ã€‚\nç¤ºä¾‹æ–‡æ¡£ï¼ˆBSON -\u0026gt; JSON ç¤ºä¾‹ï¼‰ï¼š\n{ \u0026#34;_id\u0026#34;: \u0026#34;647fa0b1\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;, \u0026#34;age\u0026#34;: 28, \u0026#34;tags\u0026#34;: [\u0026#34;IT\u0026#34;, \u0026#34;photography\u0026#34;], \u0026#34;profile\u0026#34;: { \u0026#34;city\u0026#34;: \u0026#34;NY\u0026#34;, \u0026#34;followers\u0026#34;: 12000 } } ç‰¹ç‚¹ï¼š\nå­—æ®µçµæ´»ï¼Œå¯åµŒå¥—æ–‡æ¡£ã€æ•°ç»„ã€‚ ä¸éœ€è¦ç»Ÿä¸€ schemaã€‚ 2.2 é›†åˆï¼ˆCollectionï¼‰ ç±»ä¼¼å…³ç³»æ•°æ®åº“çš„â€œè¡¨â€ï¼Œä½†æ— å›ºå®šå­—æ®µç»“æ„ã€‚\n2.3 æ•°æ®åº“ï¼ˆDatabaseï¼‰ å’Œä¼ ç»Ÿæ¦‚å¿µä¸€è‡´ï¼Œç”¨äºç»„ç»‡é›†åˆã€‚\n2.4 BSONï¼ˆBinary JSONï¼‰ é«˜æ€§èƒ½äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ”¯æŒ JSON ä¸æ”¯æŒçš„æ•°æ®ç±»å‹ï¼Œå¦‚ï¼š\nDate Binary Decimal128 ObjectId 2.5 _id å­—æ®µ æ¯ä¸ªæ–‡æ¡£å¿…é¡»æœ‰ _idï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰ã€‚\né»˜è®¤ä½¿ç”¨ ObjectIdï¼ˆ12 å­—èŠ‚ã€å¯æ’åºï¼‰ã€‚\nğŸ§© 3. MongoDB çš„æ ¸å¿ƒåŠŸèƒ½ 3.1 é«˜æ€§èƒ½è¯»å†™ æ–‡æ¡£ä¸ºåŸºæœ¬å•å…ƒ -\u0026gt; å°‘ JOIN -\u0026gt; å¿« WiredTiger å­˜å‚¨å¼•æ“ -\u0026gt; å‹ç¼© + è¡Œçº§å¹¶å‘æ§åˆ¶ï¼ˆæ–‡æ¡£çº§é”ï¼‰ å†…å­˜ç¼“å­˜ï¼ˆå­˜å‚¨å¼•æ“ cacheï¼‰å¤§å¹…å‡å°‘ç£ç›˜ IO 3.2 çµæ´»çš„æ•°æ®æ¨¡å‹ æ— å›ºå®š schema æ”¯æŒåµŒå¥—ç»“æ„ é€‚åˆå¿«é€Ÿè¿­ä»£çš„ä¸šåŠ¡ï¼ˆç¤¾äº¤ã€ç”µå•†ã€IoTï¼‰ 3.3 å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ› åŒ…æ‹¬ï¼š\nå­—æ®µç­›é€‰ èŒƒå›´æŸ¥è¯¢ ç´¢å¼•æ”¯æŒï¼ˆB-treeï¼‰ æ•°ç»„åŒ¹é… åœ°ç†ä½ç½®æŸ¥è¯¢ Aggregation Pipelineï¼ˆå¼ºå¤§çš„æ•°æ®åˆ†æèƒ½åŠ›ï¼‰ ç¤ºä¾‹ï¼š\ndb.users.aggregate([ { $match: { city: \u0026#34;NY\u0026#34; }}, { $group: { _id: \u0026#34;$gender\u0026#34;, count: { $sum: 1 } }}, { $sort: { count: -1 }} ]) 3.4 ç´¢å¼•ï¼ˆIndexï¼‰ æ”¯æŒå¤šç§ï¼š\nå•å­—æ®µ å¤åˆç´¢å¼• å”¯ä¸€ç´¢å¼• æ¨¡ç³Šç´¢å¼•ç”¨ Atlas Searchï¼ˆLuceneï¼‰ åœ°ç†ç©ºé—´ç´¢å¼• TTL ç´¢å¼•ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰ 3.5 å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ åŸç”Ÿé«˜å¯ç”¨æœºåˆ¶ã€‚\nPrimaryï¼ˆä¸»èŠ‚ç‚¹ï¼‰ Secondaryï¼ˆä»èŠ‚ç‚¹ï¼Œæ”¯æŒå»¶æ—¶ï¼‰ Arbiterï¼ˆåˆ¤å®šè€…ï¼‰ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚\n3.6 Shardingï¼ˆåˆ†ç‰‡ï¼‰ MongoDB å…·å¤‡å¼ºå¤§çš„æ°´å¹³æ‰©å±•èƒ½åŠ›ï¼Œå¯å°†é›†åˆåˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼š\nç»„ä»¶ï¼š\nconfig serverï¼ˆå…ƒæ•°æ®ï¼‰ routerï¼ˆmongosï¼‰ shard åˆ†ç‰‡ç­–ç•¥ï¼š\nå“ˆå¸Œåˆ†ç‰‡ èŒƒå›´åˆ†ç‰‡ é€‚åˆ PB çº§åˆ«çš„æ•°æ®é‡ã€‚\n3.7 äº‹åŠ¡ï¼ˆTransactionsï¼‰ã€4.0+ã€‘ æ”¯æŒè·¨æ–‡æ¡£ã€è·¨é›†åˆã€å¤šæ–‡æ¡£ ACID äº‹åŠ¡ã€‚\nğŸ§© 4. MongoDB åº•å±‚æ¶æ„ 4.1 WiredTiger å­˜å‚¨å¼•æ“ ç‰¹ç‚¹ï¼š\næ–‡æ¡£çº§é”ï¼ˆé«˜å¹¶å‘ï¼‰ å‹ç¼©ï¼ˆsnappy/zstdï¼‰ Checkpoint + WALï¼ˆWrite Ahead Logï¼‰ å†…å­˜æ˜ å°„ 4.2 å†…å­˜æ¨¡å‹ MongoDB ä½¿ç”¨ RAM ä½œä¸ºçƒ­æ•°æ®ç¼“å­˜ã€‚\nWiredTiger Cache é»˜è®¤ï¼š\n50% of RAM çƒ­æ•°æ®å‡ ä¹å®Œå…¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤è¯»å†™éå¸¸å¿«ï¼Œä½†æ¯” Redis æ…¢ã€‚\n4.3 WAL æ—¥å¿—ï¼ˆJournalï¼‰ MongoDB ä¿éšœ crash-safeï¼š\nå†™æ“ä½œæµç¨‹ï¼š\nå†™å†…å­˜ -\u0026gt; å†™ WAL -\u0026gt; flush ğŸ§© 5. MongoDB çš„ä¼˜ç‚¹æ€»ç»“ 1. æ•°æ®æ¨¡å‹çµæ´»ï¼ˆæ—  schemaï¼‰ é€‚åˆå¿«é€Ÿè¿­ä»£ã€é¢‘ç¹å˜æ›´çš„æ•°æ®ç»“æ„ã€‚\n2. æŸ¥è¯¢èƒ½åŠ›å¼º Aggregation Pipeline ç±»ä¼¼ SQL çš„ group/where/sortã€‚\n3. é«˜å¯ç”¨ï¼ˆReplica Setï¼‰ æ— éœ€å¤–éƒ¨ç»„ä»¶ã€‚\n4. æ°´å¹³æ‰©å±•ï¼ˆShardingï¼‰ åŸç”Ÿæ”¯æŒï¼Œé«˜æ‰©å±•æ€§ã€‚\n5. è·¨æ–‡æ¡£äº‹åŠ¡ æ»¡è¶³å¼ºä¸€è‡´æ€§åœºæ™¯ã€‚\n6. æ˜“äºè¿ç»´ å¤©ç„¶æ”¯æŒå‰¯æœ¬ã€å¤‡ä»½ã€å¿«ç…§ç­‰ã€‚\nğŸ§© 6. MongoDB çš„ç¼ºç‚¹ âŒ 1. ä¸æ“…é•¿å¤æ‚ JOINï¼ˆè™½ç„¶ lookup å¯ç”¨ï¼Œä½†æ€§èƒ½è¾ƒå·®ï¼‰ é€‚åˆæ–‡æ¡£ç»“æ„è‰¯å¥½çš„ä¸šåŠ¡ã€‚\nâŒ 2. å†…å­˜ä¾èµ–å¼º å¦‚æœçƒ­ç‚¹æ•°æ®å¤ªå¤§ï¼Œä¼šé¢‘ç¹èµ°ç£ç›˜å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\nâŒ 3. åˆ†ç‰‡é›†ç¾¤è¿ç»´éš¾åº¦è¾ƒé«˜ å¯¹äºåˆå­¦è€…æˆ–å°å›¢é˜Ÿï¼Œåˆ†ç‰‡ä¸å¦‚å•èŠ‚ç‚¹+å‰¯æœ¬ç®€å•ã€‚\nâŒ 4. è¾ƒé«˜çš„å­˜å‚¨ç©ºé—´æˆæœ¬ å°½ç®¡æœ‰å‹ç¼©ï¼Œä½†æ–‡æ¡£ç»“æ„å†—ä½™ã€‚\nğŸ§© 7. MongoDB é€‚ç”¨åœºæ™¯ ğŸ”¥ 1. ç¤¾äº¤å¹³å° ç”¨æˆ·èµ„æ–™ åŠ¨æ€æµ è¯„è®º ç‚¹èµ ç¬¦åˆæ–‡æ¡£åµŒå¥—ã€å¤šç«¯å†™å…¥åœºæ™¯ã€‚\nğŸ”¥ 2. ç”µå•† å•†å“åˆ—è¡¨ï¼ˆå±æ€§å¯èƒ½ä¸åŒï¼‰ è®¢å•è®°å½• ç”¨æˆ·è¡Œä¸ºæ—¥å¿— ğŸ”¥ 3. å†…å®¹ç®¡ç†ç³»ç»Ÿ CMS Markdown æ–‡æ¡£ã€æ–‡ç« ã€æ ‡ç­¾ã€å…ƒæ•°æ®ç­‰ç»“æ„ä¸å›ºå®šã€‚\nğŸ”¥ 4. æ—¥å¿—ç³»ç»Ÿã€æ—¶åºæ•°æ® æ¯” ELK æ›´è½»é‡ï¼Œå­˜å‚¨å¤§è§„æ¨¡æ—¥å¿—é€‚åˆã€‚\nğŸ”¥ 5. IoT æ•°æ® ç»“æ„å¤æ‚ã€é¢‘ç¹å˜åŒ–ã€å†™å…¥é‡å¤§ã€‚\nğŸ”¥ 6. æ¸¸æˆç³»ç»Ÿ é“å…·ã€è§’è‰²çŠ¶æ€ã€å®æ—¶æ•°æ®ã€‚\nğŸ§© 8. MongoDB vs MySQL å¯¹æ¯”ï¼ˆç®€åŒ–ç‰ˆï¼‰ ç‰¹ç‚¹ MongoDB MySQL / PostgreSQL ç»“æ„ æ–‡æ¡£å‹ã€æ—  schema ç»“æ„åŒ–ã€æœ‰ schema æ‰©å±• ä¼˜ç§€ï¼ŒåŸç”Ÿåˆ†ç‰‡ ä¸­ç­‰ï¼Œéœ€ä¸­é—´ä»¶ å†™æ€§èƒ½ é«˜ é«˜ è¯»æ€§èƒ½ é«˜ï¼ˆä¾èµ–å†…å­˜ï¼‰ é«˜ ACID äº‹åŠ¡æ”¯æŒï¼ˆ4.0+ï¼‰ å¼ºæ”¯æŒ å¤æ‚æŸ¥è¯¢ å¾ˆå¼º æ›´å¼ºï¼ˆJOINï¼‰ æœ€ä½³åœºæ™¯ éç»“æ„åŒ–ã€æµ·é‡æ•°æ® å¼ºä¸€è‡´æ€§ã€å¤æ‚æŸ¥è¯¢ ğŸ§© 9. MongoDB æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ 1. åµŒå¥—æ–‡æ¡£ä¼˜äºå¤šè¡¨ å‡å°‘ lookupã€‚\n2. åˆ›å»ºåˆé€‚çš„ç´¢å¼• å¸¸æŸ¥å­—æ®µå¿…é¡»ç´¢å¼•ã€‚\n3. æ§åˆ¶æ–‡æ¡£ä½“ç§¯ï¼ˆæ¨è \u0026lt; 16KBï¼‰ é¿å…å·¨å¤§æ–‡æ¡£ï¼ˆæœ€å¤§ 16MBï¼‰ã€‚\n4. é¿å…è¿‡å¤šé›†åˆï¼ˆ\u0026gt;10 ä¸‡ä¼šå½±å“å…ƒæ•°æ®æ€§èƒ½ï¼‰ 5. å†™å¤šè¯»å°‘ -\u0026gt; å¤šå‰¯æœ¬è¯»å†™åˆ†ç¦» 6. çƒ­ç‚¹æ•°æ®è¦æ”¾åœ¨å†…å­˜å®¹é‡ä»¥å†… 7. ä½¿ç”¨ TTL ç´¢å¼•æ¸…ç†è¿‡æœŸæ•°æ® ğŸ§© 10. ä¼ä¸šçº§æ¶æ„æ¨¡å¼ Redis + MongoDBï¼ˆçƒ­ç‚¹ + å¤§æ•°æ®ï¼‰ MongoDB å‰¯æœ¬é›†ï¼ˆäºŒèŠ‚ç‚¹ + ä»²è£ï¼‰ MongoDB Shardingï¼ˆæµ·é‡æ•°æ®ï¼‰ MongoDB + Kafkaï¼ˆæ—¥å¿—/æµå¼å¤„ç†ï¼‰ ","description":"MongoDB è¯¦ç»†ä»‹ç»ï¼šæ ¸å¿ƒæ¦‚å¿µ + åº•å±‚åŸç† + åº”ç”¨åœºæ™¯ + æœ€ä½³å®è·µï¼‰ï¼Œåå·¥ç¨‹åŒ–ã€æ¶æ„åŒ–\nğŸ§© 1. MongoDB æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ª æ–‡æ¡£å‹ NoSQL æ•°æ®åº“ï¼Œä½¿ç”¨ BSONï¼ˆäºŒè¿›åˆ¶ JSONï¼‰å­˜å‚¨æ•°æ®ï¼Œå…·æœ‰ï¼š\næ— æ¨¡å¼ Schema-less æ°´å¹³æ‰©å±•èƒ½åŠ›å¼ºï¼ˆShardingï¼‰ é«˜æ€§èƒ½è¯»å†™ åŸç”Ÿå¤åˆ¶é›†é«˜å¯ç”¨ï¼ˆReplica Setï¼‰ ä¸°å¯ŒæŸ¥è¯¢èƒ½åŠ›ï¼ˆèšåˆç®¡é“ã€ç´¢å¼•ç­‰ï¼‰ æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡ï¼ˆ4.0+ï¼‰ å®ƒéå¸¸é€‚åˆå­˜å‚¨ éç»“æ„åŒ–ã€åŠç»“æ„åŒ–ã€å¤§è§„æ¨¡ã€é«˜å¹¶å‘æ•°æ®ã€‚\nğŸ§© 2. MongoDB çš„æ ¸å¿ƒæ¦‚å¿µ 2.1 æ–‡æ¡£ï¼ˆDocumentï¼‰ MongoDB åŸºæœ¬å•ä½ï¼Œç›¸å½“äºå…³ç³»æ•°æ®åº“é‡Œçš„â€œè¡Œâ€ã€‚\n"},{"id":63,"href":"/database/mongo/core/","title":"MongoDB æ ¸å¿ƒæ¦‚å¿µ","parent":"MongoDB","content":" ä¸€ã€MongoDB æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£ï¼ˆDocument-Orientedï¼‰çš„ NoSQL æ•°æ®åº“\næ ¸å¿ƒç‰¹å¾ï¼š\næ–‡æ¡£æ¨¡å‹ï¼ˆBSONï¼‰ æ— å›ºå®š Schemaï¼ˆSchema-lessï¼‰ é«˜å¯æ‰©å±•ï¼ˆReplica Set + Shardingï¼‰ é«˜å¯ç”¨ï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰ ğŸ“Œ æœ¬è´¨ç›®æ ‡ï¼š\nç‰ºç‰²éƒ¨åˆ†å¼ºä¸€è‡´æ€§ï¼Œæ¢å–é«˜å¯ç”¨å’Œé«˜æ‰©å±•æ€§\näºŒã€MongoDB æ ¸å¿ƒæ•°æ®æ¨¡å‹ 1ï¸âƒ£ Databaseï¼ˆæ•°æ®åº“ï¼‰ é€»è¾‘éš”ç¦»å•ä½ ç±»ä¼¼ MySQL çš„ database / PostgreSQL çš„ schema+db å¸¸è§ç³»ç»Ÿåº“ï¼š\nadminï¼šç®¡ç† localï¼šå¤åˆ¶é›†æœ¬åœ°æ•°æ®ï¼ˆoplogï¼‰ configï¼šåˆ†ç‰‡å…ƒæ•°æ® 2ï¸âƒ£ Collectionï¼ˆé›†åˆï¼‰ ç±»ä¼¼è¡¨ï¼ˆtableï¼‰ åŒä¸€é›†åˆæ–‡æ¡£ç»“æ„å¯ä»¥ä¸åŒ æ— å¼ºåˆ¶ schema ğŸ“Œ è®¾è®¡åŸåˆ™ï¼š\nä¸€ä¸ªé›†åˆ = ä¸€ä¸ªä¸šåŠ¡å®ä½“\n3ï¸âƒ£ Documentï¼ˆæ–‡æ¡£ï¼‰ BSONï¼ˆBinary JSONï¼‰ æœ€å¤§ 16MB ç¤ºä¾‹ï¼š\n{ \u0026#34;_id\u0026#34;: ObjectId(\u0026#34;...\u0026#34;), \u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;age\u0026#34;: 18, \u0026#34;tags\u0026#34;: [\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;] } 4ï¸âƒ£ _id ä¸»é”® é»˜è®¤ ObjectId å”¯ä¸€ç´¢å¼•è‡ªåŠ¨åˆ›å»º ä¸‰ã€BSON vs JSON å¯¹æ¯”é¡¹ JSON BSON ç±»å‹ å°‘ å¤šï¼ˆDate, Binary, Decimal128ï¼‰ è§£æ æ…¢ å¿« å­˜å‚¨ æ–‡æœ¬ äºŒè¿›åˆ¶ ğŸ“Œ MongoDB å†…éƒ¨å…¨éƒ¨ä½¿ç”¨ BSON\nå››ã€MongoDB æ¶æ„æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ mongod æ•°æ®åº“æœåŠ¡è¿›ç¨‹ è´Ÿè´£æ•°æ®å­˜å‚¨ã€æŸ¥è¯¢ã€å¤åˆ¶ 2ï¸âƒ£ mongos åˆ†ç‰‡é›†ç¾¤çš„è·¯ç”± ä¸å­˜æ•°æ® 3ï¸âƒ£ config server å­˜å‚¨åˆ†ç‰‡å…ƒæ•°æ® å¿…é¡»æ˜¯å¤åˆ¶é›† äº”ã€é«˜å¯ç”¨ï¼šReplica Setï¼ˆå¤åˆ¶é›†ï¼‰ 1ï¸âƒ£ ç»„æˆ Primaryï¼šå†™ Secondaryï¼šè¯» + å¤‡ä»½ Arbiterï¼šæŠ•ç¥¨ï¼ˆä¸å­˜æ•°æ®ï¼‰ 2ï¸âƒ£ å·¥ä½œæœºåˆ¶ å†™å…¥ Primary åŒæ­¥åˆ° Secondary Primary æŒ‚äº† -\u0026gt; è‡ªåŠ¨é€‰ä¸¾ ğŸ“Œ æœ€ç»ˆä¸€è‡´æ€§\n3ï¸âƒ£ Oplog æ“ä½œæ—¥å¿— Secondary é‡æ”¾ oplog åŒæ­¥æ•°æ® å…­ã€æ°´å¹³æ‰©å±•ï¼šShardingï¼ˆåˆ†ç‰‡ï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆè¦åˆ†ç‰‡ï¼Ÿ å•æœºå®¹é‡ã€IOã€CPU æœ‰ä¸Šé™ 2ï¸âƒ£ åˆ†ç‰‡æ ¸å¿ƒæ¦‚å¿µ æ¦‚å¿µ è¯´æ˜ Shard å®é™…å­˜æ•°æ® Chunk æ•°æ®åˆ†ç‰‡å•ä½ Shard Key å†³å®šæ•°æ®åˆ†å¸ƒ 3ï¸âƒ£ åˆ†ç‰‡é”®åŸåˆ™ï¼ˆå¿…è€ƒï¼‰ é«˜åŸºæ•° å‡åŒ€åˆ†å¸ƒ éå•è°ƒé€’å¢ æ¨èï¼š\nhashed(_id) hashed(user_id) ä¸ƒã€MongoDB ä¸€è‡´æ€§æ¨¡å‹ 1ï¸âƒ£ å†™å…³æ³¨ï¼ˆWrite Concernï¼‰ { w: \u0026#34;majority\u0026#34; } 2ï¸âƒ£ è¯»åå¥½ï¼ˆRead Preferenceï¼‰ primary / secondary / nearest\n3ï¸âƒ£ è¯»å…³æ³¨ï¼ˆRead Concernï¼‰ local / majority / snapshot\nğŸ“Œ å¯è°ƒä¸€è‡´æ€§\nå…«ã€äº‹åŠ¡ï¼ˆTransactionï¼‰ 1ï¸âƒ£ æ”¯æŒç‰ˆæœ¬ 4.0ï¼šå‰¯æœ¬é›† 4.2ï¼šåˆ†ç‰‡é›†ç¾¤ 2ï¸âƒ£ ç‰¹ç‚¹ ACID æ€§èƒ½å¼€é”€å¤§ ä¸æ¨èå¤§äº‹åŠ¡ ä¹ã€å­˜å‚¨å¼•æ“ï¼šWiredTiger æ ¸å¿ƒç‰¹æ€§\næ–‡æ¡£çº§é” MVCC å‹ç¼© Checkpoint ğŸ“Œ MongoDB æ€§èƒ½æ ¸å¿ƒæ¥æº\nåã€ç´¢å¼•æœºåˆ¶ æ”¯æŒç´¢å¼•ç±»å‹ï¼š\nå•å­—æ®µ å¤åˆç´¢å¼• å”¯ä¸€ç´¢å¼• TTL Text Geo ğŸ“Œ ç´¢å¼•ä¹Ÿæ˜¯ BSON + B-Tree\nåä¸€ã€MongoDB vs å…³ç³»å‹æ•°æ®åº“ å¯¹æ¯” MongoDB MySQL Schema çµæ´» å›ºå®š Join å¼± å¼º æ‰©å±• æ°´å¹³ å‚ç›´ äº‹åŠ¡ æ”¯æŒä½†æ…ç”¨ å¼º åäºŒã€MongoDB é€‚ç”¨ \u0026amp; ä¸é€‚ç”¨åœºæ™¯ âœ… é€‚ç”¨\nå†…å®¹ç®¡ç† æ—¥å¿— ç”¨æˆ·ç”»åƒ IoT å•†å“ä¿¡æ¯ âŒ ä¸é€‚ç”¨\nå¼ºäº‹åŠ¡é‡‘è å¤æ‚å¤šè¡¨ Join åä¸‰ã€æ€»ç»“ MongoDB æ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œ é€šè¿‡å¤åˆ¶é›†å®ç°é«˜å¯ç”¨ï¼Œé€šè¿‡åˆ†ç‰‡å®ç°æ°´å¹³æ‰©å±•ï¼Œ ä¸€è‡´æ€§é€šè¿‡ Write / Read Concern è°ƒèŠ‚ï¼Œ ä»¥ WiredTiger ä½œä¸ºé«˜æ€§èƒ½å­˜å‚¨å¼•æ“ã€‚\n","description":" ä¸€ã€MongoDB æ˜¯ä»€ä¹ˆï¼Ÿ MongoDB æ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£ï¼ˆDocument-Orientedï¼‰çš„ NoSQL æ•°æ®åº“\næ ¸å¿ƒç‰¹å¾ï¼š\næ–‡æ¡£æ¨¡å‹ï¼ˆBSONï¼‰ æ— å›ºå®š Schemaï¼ˆSchema-lessï¼‰ é«˜å¯æ‰©å±•ï¼ˆReplica Set + Shardingï¼‰ é«˜å¯ç”¨ï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰ ğŸ“Œ æœ¬è´¨ç›®æ ‡ï¼š\nç‰ºç‰²éƒ¨åˆ†å¼ºä¸€è‡´æ€§ï¼Œæ¢å–é«˜å¯ç”¨å’Œé«˜æ‰©å±•æ€§\näºŒã€MongoDB æ ¸å¿ƒæ•°æ®æ¨¡å‹ 1ï¸âƒ£ Databaseï¼ˆæ•°æ®åº“ï¼‰ é€»è¾‘éš”ç¦»å•ä½ ç±»ä¼¼ MySQL çš„ database / PostgreSQL çš„ schema+db å¸¸è§ç³»ç»Ÿåº“ï¼š\n"},{"id":64,"href":"/database/mysql/tutorial/","title":"MySQL åŸºç¡€æ•™ç¨‹","parent":"MySQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€ç³»ç»ŸåŒ–ã€é€‚åˆé•¿æœŸæ”¶è—çš„ã€ŠMySQL è¯¦ç»†ä»‹ç»ï¼ˆæ ¸å¿ƒæ¦‚å¿µ + æ¶æ„åŸç† + å­˜å‚¨å¼•æ“ + å¤åˆ¶ + æ—¥å¿— + äº‹åŠ¡ + ç´¢å¼• + ä¼˜åŒ–ï¼‰ã€‹ã€‚å†…å®¹éå¸¸å…¨é¢ï¼Œé€‚åˆå…¥é—¨ã€è¿›é˜¶ã€‚\nç›®å½•ï¼š\nMySQL åŸºç¡€æ¦‚å¿µ MySQL æ¶æ„ç»„æˆ InnoDB å­˜å‚¨å¼•æ“è¯¦è§£ MySQL æ•°æ®æ–‡ä»¶å¸ƒå±€ ç´¢å¼•ï¼ˆIndexï¼‰ä½“ç³» é”ï¼ˆLocksï¼‰ä½“ç³» äº‹åŠ¡ï¼ˆTransactionï¼‰ä¸éš”ç¦»çº§åˆ« æ—¥å¿—ç³»ç»Ÿï¼ˆRedo/Undo/Binlogï¼‰ Buffer Poolï¼ˆç¼“å†²æ± ï¼‰æœºåˆ¶ SQL æ‰§è¡Œè¿‡ç¨‹ MySQL å¤åˆ¶ï¼ˆReplicationï¼‰ä½“ç³» MySQL é«˜å¯ç”¨ï¼ˆHAï¼‰æ–¹æ¡ˆ å¸¸è§æ€§èƒ½ä¼˜åŒ–æ–¹æ³• å¸¸è§æ•…éšœæ’æŸ¥ä½“ç³» 1. MySQL åŸºç¡€æ¦‚å¿µ RDBMSï¼šå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ æ”¯æŒ SQL äº‹åŠ¡æ”¯æŒï¼ˆACIDï¼‰ å­˜å‚¨å¼•æ“å¯æ’æ‹” MySQL 8.0 ä»¥åç»Ÿä¸€ä½¿ç”¨ InnoDBï¼ˆé»˜è®¤ï¼‰ å…³é”®ç‰¹æ€§ï¼š\nå®‰å…¨å¯é  é«˜æ€§èƒ½ å¼€æº ç”Ÿæ€å®Œå–„ 2. MySQL æ¶æ„ç»„æˆï¼ˆServer å±‚ + å­˜å‚¨å¼•æ“å±‚ï¼‰ Server å±‚ï¼ˆé€šç”¨å±‚ï¼‰ è´Ÿè´£æ‰€æœ‰ä¸å­˜å‚¨æ— å…³çš„åŠŸèƒ½ï¼š\nè¿æ¥ç®¡ç† æŸ¥è¯¢è§£æï¼ˆParserï¼‰ æŸ¥è¯¢ä¼˜åŒ–ï¼ˆOptimizerï¼‰ æŸ¥è¯¢ç¼“å­˜ï¼ˆå·²åºŸå¼ƒï¼‰ æƒé™è®¤è¯ Binlog å†™å…¥ å­˜å‚¨å¼•æ“å±‚ï¼ˆå¯æ’æ‹”ï¼‰ è´Ÿè´£æ•°æ®çš„å®é™…å­˜å‚¨ä¸è¯»å–ã€‚\nå¸¸è§å¼•æ“ï¼š\nInnoDBï¼ˆé»˜è®¤ï¼‰ MyISAMï¼ˆå·²åºŸå¼ƒï¼‰ Memory CSV Archive InnoDB æ˜¯æ ¸å¿ƒï¼Œå¼•æ“ç‰¹æ€§ï¼š\näº‹åŠ¡ï¼ˆACIDï¼‰ è¡Œé” è‡ªé€‚åº”å“ˆå¸Œç´¢å¼• åŒå†™ç¼“å†² å´©æºƒæ¢å¤èƒ½åŠ›å¼º 3. InnoDB å­˜å‚¨å¼•æ“è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰ æ ¸å¿ƒç»„ä»¶ï¼š\nBuffer Poolï¼ˆç¼“å†²æ± ï¼‰ ç¼“å­˜ï¼š\næ•°æ®é¡µ ç´¢å¼•é¡µ Undo Insert Buffer é»˜è®¤å¤§å°è¾ƒå°ï¼Œä½†å»ºè®®è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„ 60%-80%ã€‚\nRedo Logï¼ˆé‡åšæ—¥å¿—ï¼‰ ä¿éšœæŒä¹…æ€§ï¼ˆDï¼‰ï¼Œå´©æºƒæ¢å¤å¿…éœ€ã€‚\nUndo Logï¼ˆå›æ»šæ—¥å¿—ï¼‰ æä¾›ï¼š\näº‹åŠ¡å›æ»š MVCCï¼ˆå¤šç‰ˆæœ¬æ§åˆ¶ï¼‰ Double Write Bufferï¼ˆåŒå†™ç¼“å†²ï¼‰ é˜²æ­¢æ•°æ®é¡µæŸåï¼ˆpartial writeï¼‰ã€‚\nAdaptive Hash Indexï¼ˆè‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼‰ InnoDB è‡ªåŠ¨ä¼˜åŒ–çƒ­ç‚¹æ•°æ®è®¿é—®ã€‚\nChange Buffer å»¶è¿Ÿå†™è¾…åŠ©ç»“æ„ï¼Œç”¨äºäºŒçº§ç´¢å¼•ã€‚\n4. MySQL æ•°æ®æ–‡ä»¶å¸ƒå±€ ç›®å½•ç»“æ„ï¼š\n/var/lib/mysql/ â”œâ”€ ibdata1 (ç³»ç»Ÿè¡¨ç©ºé—´) â”œâ”€ ib_logfile0/ib_logfile1ï¼ˆredo æ—¥å¿—ï¼‰ â”œâ”€ *.ibdï¼ˆæ¯ä¸ªè¡¨çš„æ•°æ® + ç´¢å¼•ï¼‰ â”œâ”€ binlog.000001ï¼ˆbinlogï¼‰ â”œâ”€ relay-logï¼ˆä»åº“ï¼‰ â””â”€ *.frmï¼ˆ8.0 ä¹‹å‰ï¼‰ 5. ç´¢å¼•ä½“ç³»ï¼ˆIndexï¼‰ MySQL ä½¿ç”¨ B+Tree ç´¢å¼•ï¼ˆæœ€é‡è¦ï¼‰ã€‚\nç´¢å¼•ç±»å‹ï¼š\nä¸»é”®ç´¢å¼•ï¼ˆClustered Indexï¼‰ æ•°æ®ä¸ä¸»é”®åŒä¸€æ£µ B+Tree å¶å­èŠ‚ç‚¹å­˜å‚¨æ•´è¡Œæ•°æ® å¼ºçƒˆå»ºè®®ä¸šåŠ¡è¡¨å¿…é¡»æœ‰ä¸»é”® äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰ å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œå› æ­¤å­˜åœ¨ å›è¡¨ã€‚\nè¦†ç›–ç´¢å¼• æŸ¥è¯¢åªç”¨åˆ°ç´¢å¼•ï¼Œä¸ç”¨å›è¡¨ï¼Œæ€§èƒ½æœ€ä½³ã€‚\nè”åˆç´¢å¼• éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ã€‚\n6. é”ä½“ç³»ï¼ˆLocksï¼‰ InnoDB çš„é”éå¸¸ä¸°å¯Œï¼š\nè¡Œçº§é”ï¼ˆRow Locksï¼‰ æ’å®ƒé”ï¼ˆXï¼‰ å…±äº«é”ï¼ˆSï¼‰ é—´éš™é”ï¼ˆGap Lockï¼‰ ç”¨äºé˜²æ­¢å¹»è¯»ï¼ˆRR éš”ç¦»çº§åˆ«å¯ç”¨ï¼‰ã€‚\nNext-Key Lock è¡Œé” + é—´éš™é” ç»„åˆã€‚\næ„å‘é”ï¼ˆIntention Locksï¼‰ IS IX ç”¨æ¥ä¸è¡¨é”å…¼å®¹ã€‚\nè¡¨é”ï¼ˆTable Locksï¼‰ 7. äº‹åŠ¡ä¸éš”ç¦»çº§åˆ« äº‹åŠ¡çš„ ACIDï¼š\nA åŸå­æ€§ï¼ˆundo logï¼‰ C ä¸€è‡´æ€§ I éš”ç¦»æ€§ï¼ˆé”ï¼‰ D æŒä¹…æ€§ï¼ˆredo logï¼‰ MySQL æ”¯æŒ 4 ä¸ªéš”ç¦»çº§åˆ«ï¼š\nçº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» Read Uncommitted âœ… âœ… âœ… Read Committed âŒ âœ… âœ… Repeatable Readï¼ˆé»˜è®¤ï¼‰ âŒ âŒ â­ï¼ˆé¿å…éƒ¨åˆ†å¹»è¯»ï¼‰ Serializable âŒ âŒ âŒ InnoDB é»˜è®¤ RRï¼Œä½¿ç”¨ï¼š\nMVCCï¼ˆéé”ï¼‰ é—´éš™é”ï¼ˆåŠ é”ï¼‰ åŒæ—¶é˜²æ­¢ä¸å¯é‡å¤è¯»ã€‚\n8. æ—¥å¿—ç³»ç»Ÿï¼ˆæé‡è¦ï¼‰ Redo Log\nWALï¼ˆWrite Ahead Loggingï¼‰ ä¿è¯ crash-safe ç¡®ä¿æ•°æ®æœ€ç»ˆåˆ·å…¥ç£ç›˜ Undo Log\nMVCC å¿«ç…§ å›æ»šäº‹åŠ¡ Binlogï¼ˆServer å±‚ï¼‰\nç”¨äºå¤åˆ¶ ç”¨äº PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰ MySQL æ•…éšœæ¢å¤é¡ºåºï¼š\nè¯»å– redo log æ¢å¤æœªåˆ·ç›˜æ•°æ® rollback æœªå®Œæˆäº‹åŠ¡ï¼ˆundo logï¼‰ binlog åšä¸»ä»åŒæ­¥ 9. Buffer Poolï¼ˆInnoDB ç¼“å­˜ï¼‰ Buffer Pool æ˜¯ MySQL æœ€é‡è¦çš„å†…å­˜ç»“æ„ï¼Œç”¨äºç¼“å­˜æ•°æ®é¡µä¸ç´¢å¼•é¡µï¼Œæé«˜æ€§èƒ½ã€‚\næ¶æ„ï¼š\nFree Listï¼ˆç©ºé—²é¡µï¼‰ Flush Listï¼ˆè„é¡µï¼‰ LRU Listï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰ è°ƒä¼˜å…³é”®å‚æ•°ï¼š\ninnodb_buffer_pool_size innodb_buffer_pool_instances innodb_buffer_pool_chunk_size 10. SQL æ‰§è¡Œè¿‡ç¨‹ æ‰§è¡Œä¸€æ¡æŸ¥è¯¢ï¼š\nå®¢æˆ·ç«¯è¿æ¥å™¨ SQL Parserï¼ˆè§£æå™¨ï¼‰ Optimizerï¼ˆä¼˜åŒ–å™¨ï¼‰ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰ å­˜å‚¨å¼•æ“è¯»å–æ•°æ® è¿”å›ç»“æœ æ‰§è¡Œä¸€æ¡å†™å…¥ï¼š\nå†™å…¥ Buffer Pool å†™ redo logï¼ˆprepareï¼‰ å†™ binlog redo commit åˆ·ç›˜ 11. MySQL å¤åˆ¶ï¼ˆReplicationï¼‰ MySQL æä¾›ä¸‰ç§å¤åˆ¶ï¼š\næ¨¡å¼ ä¸€è‡´æ€§ å»¶è¿Ÿ è¯´æ˜ å¼‚æ­¥ æœ€å·® å¯èƒ½å¾ˆå¤§ ä¸»åº“å†™æˆåŠŸå³å¯è¿”å› åŠåŒæ­¥ ä¸­ç­‰ è¾ƒä½ è‡³å°‘ä¸€ä¸ªä»åº“ ack å¢å¼ºåŠåŒæ­¥ï¼ˆMySQL 8ï¼‰ æ¯”åŠåŒæ­¥æ›´å¼º æ›´ä½ å¼ºåˆ¶ä»åº“è½ç›˜åæ‰ ack å¤åˆ¶åŸºäº binlog + relay logã€‚\n12. MySQL é«˜å¯ç”¨ï¼ˆHAï¼‰æ–¹æ¡ˆ ä»ä¸€è‡´æ€§è§’åº¦æ’åºï¼š\nğŸ¥‡ 1. Group Replicationï¼ˆå¼ºä¸€è‡´æ€§ï¼‰-\u0026gt; InnoDB Cluster å¤šæ•°æ´¾æäº¤ å¼ºä¸€è‡´æ€§å†™å…¥ ğŸ¥ˆ 2. Galera Cluster / PXCï¼ˆå‡†å¼ºä¸€è‡´ï¼‰ ğŸ¥‰ 3. MySQL ä¸»ä»å¤åˆ¶ + Orchestrator æœ€ç»ˆä¸€è‡´æ€§\nğŸ¥‰ 4. MHAï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ 13. æ€§èƒ½ä¼˜åŒ–ä½“ç³»ï¼ˆéå¸¸å®ç”¨ï¼‰ ä¼˜åŒ–æ–¹å‘ï¼š\nSQL ä¼˜åŒ–ï¼ˆæœ€é‡è¦ï¼‰ ä½¿ç”¨åˆé€‚ç´¢å¼• é¿å…å…¨è¡¨æ‰«æ è¦†ç›–ç´¢å¼• å°½é‡é¿å… JOIN å¤šè¶…è¿‡ 3 å¼ è¡¨ è¡¨ç»“æ„ä¼˜åŒ– åˆç†é€‰æ‹©æ•°æ®ç±»å‹ CHAR vs VARCHAR ä½¿ç”¨åˆé€‚çš„ä¸»é”®ï¼ˆè‡ªå¢ / UUIDv7ï¼‰ ç´¢å¼•ä¼˜åŒ– é€‰æ‹©æ­£ç¡®å­—æ®µå»ºç«‹ç´¢å¼• é¿å…ç´¢å¼•å¤±æ•ˆï¼ˆå‡½æ•°ã€ç±»å‹ä¸åŒç­‰ï¼‰ å‚æ•°ä¼˜åŒ– å¦‚ï¼š\ninnodb_buffer_pool_size innodb_flush_log_at_trx_commit max_connections query_cache_sizeï¼ˆ8.0 å·²åºŸå¼ƒï¼‰ ç¡¬ä»¶ä¼˜åŒ– å†…å­˜è¶³å¤Ÿå¤§ NVMe SSD 14. æ•…éšœæ’æŸ¥ä½“ç³» å¸¸ç”¨æ€è·¯ï¼š\næ…¢æŸ¥è¯¢ï¼ˆslow query logï¼‰ è¡¨é”ã€è¡Œé”ï¼ˆSHOW ENGINE INNODB STATUSï¼‰ å¤åˆ¶å»¶è¿Ÿï¼ˆSHOW SLAVE STATUSï¼‰ è¿æ¥æ•°è€—å°½ï¼ˆToo many connectionsï¼‰ ç£ç›˜ IO é«˜ Buffer Pool ä¸è¶³ æ­»é”ï¼ˆDEADLOCKï¼‰ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€ç³»ç»ŸåŒ–ã€é€‚åˆé•¿æœŸæ”¶è—çš„ã€ŠMySQL è¯¦ç»†ä»‹ç»ï¼ˆæ ¸å¿ƒæ¦‚å¿µ + æ¶æ„åŸç† + å­˜å‚¨å¼•æ“ + å¤åˆ¶ + æ—¥å¿— + äº‹åŠ¡ + ç´¢å¼• + ä¼˜åŒ–ï¼‰ã€‹ã€‚å†…å®¹éå¸¸å…¨é¢ï¼Œé€‚åˆå…¥é—¨ã€è¿›é˜¶ã€‚\nç›®å½•ï¼š\nMySQL åŸºç¡€æ¦‚å¿µ MySQL æ¶æ„ç»„æˆ InnoDB å­˜å‚¨å¼•æ“è¯¦è§£ MySQL æ•°æ®æ–‡ä»¶å¸ƒå±€ ç´¢å¼•ï¼ˆIndexï¼‰ä½“ç³» é”ï¼ˆLocksï¼‰ä½“ç³» äº‹åŠ¡ï¼ˆTransactionï¼‰ä¸éš”ç¦»çº§åˆ« æ—¥å¿—ç³»ç»Ÿï¼ˆRedo/Undo/Binlogï¼‰ Buffer Poolï¼ˆç¼“å†²æ± ï¼‰æœºåˆ¶ SQL æ‰§è¡Œè¿‡ç¨‹ MySQL å¤åˆ¶ï¼ˆReplicationï¼‰ä½“ç³» MySQL é«˜å¯ç”¨ï¼ˆHAï¼‰æ–¹æ¡ˆ å¸¸è§æ€§èƒ½ä¼˜åŒ–æ–¹æ³• å¸¸è§æ•…éšœæ’æŸ¥ä½“ç³» 1. MySQL åŸºç¡€æ¦‚å¿µ RDBMSï¼šå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ æ”¯æŒ SQL äº‹åŠ¡æ”¯æŒï¼ˆACIDï¼‰ å­˜å‚¨å¼•æ“å¯æ’æ‹” MySQL 8.0 ä»¥åç»Ÿä¸€ä½¿ç”¨ InnoDBï¼ˆé»˜è®¤ï¼‰ å…³é”®ç‰¹æ€§ï¼š\n"},{"id":65,"href":"/database/mysql/core/","title":"MySQL æ ¸å¿ƒæ¦‚å¿µ","parent":"MySQL","content":" ä¸€ã€MySQL æ•´ä½“æ¶æ„ï¼ˆæœ€æ ¸å¿ƒï¼‰ 1ï¸âƒ£ MySQL æ˜¯ä»€ä¹ˆï¼Ÿ å…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰ åŸºäº Client / Server æ¶æ„ SQL æ˜¯äº¤äº’è¯­è¨€ å­˜å‚¨å¼•æ“å¯æ’æ‹” 2ï¸âƒ£ MySQL é€»è¾‘æ¶æ„ï¼ˆå¿…è€ƒï¼‰ Client â†“ è¿æ¥å±‚ï¼ˆConnectionï¼‰ â†“ SQL å±‚ï¼ˆParser / Optimizer / Executorï¼‰ â†“ å­˜å‚¨å¼•æ“å±‚ï¼ˆInnoDB / Memory / MyISAMï¼‰ â†“ ç£ç›˜ï¼ˆData / Redo / Binlogï¼‰ å„å±‚èŒè´£ä¸€å¥è¯ï¼š\nå±‚ ä½œç”¨ è¿æ¥å±‚ ç®¡ç†è¿æ¥ã€çº¿ç¨‹ã€è®¤è¯ SQL å±‚ è§£æ SQLã€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ å¼•æ“å±‚ æ•°æ®å­˜å‚¨ã€äº‹åŠ¡ã€é” ç£ç›˜å±‚ æŒä¹…åŒ–ã€æ—¥å¿— äºŒã€å­˜å‚¨å¼•æ“ï¼ˆInnoDB æ˜¯ç»å¯¹æ ¸å¿ƒï¼‰ 1ï¸âƒ£ InnoDB çš„æ ¸å¿ƒç‰¹æ€§ ç‰¹æ€§ è¯´æ˜ äº‹åŠ¡ æ”¯æŒ ACID è¡Œçº§é” é«˜å¹¶å‘ MVCC éé˜»å¡è¯» å´©æºƒæ¢å¤ Redo / Undo èšç°‡ç´¢å¼• ä¸»é”®å³æ•°æ® ğŸ‘‰ MySQL 8.4 é»˜è®¤ \u0026amp; å”¯ä¸€ä¸»æµå¼•æ“\n2ï¸âƒ£ InnoDB vs MyISAM å¯¹æ¯” InnoDB MyISAM äº‹åŠ¡ âœ… âŒ é” è¡Œé” è¡¨é” å´©æºƒæ¢å¤ âœ… âŒ å¤–é”® âœ… âŒ COUNT(*) æ…¢ å¿« ä¸‰ã€äº‹åŠ¡ï¼ˆACID + å®ç°åŸç†ï¼‰ 1ï¸âƒ£ ACID å«ä¹‰ å­—æ¯ å«ä¹‰ A åŸå­æ€§ C ä¸€è‡´æ€§ I éš”ç¦»æ€§ D æŒä¹…æ€§ 2ï¸âƒ£ äº‹åŠ¡é ä»€ä¹ˆå®ç°ï¼Ÿ ç‰¹æ€§ å®ç°æœºåˆ¶ åŸå­æ€§ Undo Log ä¸€è‡´æ€§ ç¨‹åº + çº¦æŸ éš”ç¦»æ€§ é” + MVCC æŒä¹…æ€§ Redo Log 3ï¸âƒ£ äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆå¿…èƒŒï¼‰ éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» READ UNCOMMITTED âœ… âœ… âœ… READ COMMITTED âŒ âœ… âœ… REPEATABLE READï¼ˆé»˜è®¤ï¼‰ âŒ âŒ âŒ* SERIALIZABLE âŒ âŒ âŒ InnoDB ä½¿ç”¨ Next-Key Lock è§£å†³å¹»è¯»\nå››ã€é”æœºåˆ¶ï¼ˆå¹¶å‘çš„æ ¸å¿ƒï¼‰ 1ï¸âƒ£ é”çš„ç²’åº¦ è¡¨é” è¡Œé”ï¼ˆRecord Lockï¼‰ é—´éš™é”ï¼ˆGap Lockï¼‰ Next-Key Lock 2ï¸âƒ£ å¸¸è§é”ç±»å‹ é” åœºæ™¯ S é” å…±äº«è¯» X é” æ’ä»–å†™ æ„å‘é” æé«˜åˆ¤æ–­æ•ˆç‡ 3ï¸âƒ£ é”å‡çº§ / é”æ‰©å¤§ï¼ˆå±é™©ç‚¹ï¼‰ æœªèµ°ç´¢å¼• -\u0026gt; è¡Œé”å˜è¡¨é” èŒƒå›´æŸ¥è¯¢ -\u0026gt; Next-Key Lock äº”ã€MVCCï¼ˆé«˜å¹¶å‘è¯»çš„å…³é”®ï¼‰ 1ï¸âƒ£ MVCC æ˜¯ä»€ä¹ˆï¼Ÿ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œè®©è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»\n2ï¸âƒ£ MVCC ä¾èµ–å“ªäº›ç»“æ„ï¼Ÿ ç»„ä»¶ ä½œç”¨ Undo Log ä¿å­˜å†å²ç‰ˆæœ¬ Read View äº‹åŠ¡å¯è§æ€§ trx_id äº‹åŠ¡ ID 3ï¸âƒ£ å¿«ç…§è¯» vs å½“å‰è¯» ç±»å‹ ç¤ºä¾‹ å¿«ç…§è¯» SELECT å½“å‰è¯» SELECT â€¦ FOR UPDATE å…­ã€ç´¢å¼•ï¼ˆæ€§èƒ½æ ¸å¿ƒï¼‰ 1ï¸âƒ£ ç´¢å¼•çš„æœ¬è´¨ æ’åºå¥½çš„æ•°æ®ç»“æ„ï¼ˆB+Treeï¼‰\n2ï¸âƒ£ ç´¢å¼•åˆ†ç±» ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ï¼‰ äºŒçº§ç´¢å¼• å”¯ä¸€ç´¢å¼• è”åˆç´¢å¼• è¦†ç›–ç´¢å¼• 3ï¸âƒ£ B+Tree ç‰¹ç‚¹ çŸ®èƒ–ç»“æ„ é¡ºåº IO èŒƒå›´æŸ¥è¯¢é«˜æ•ˆ 4ï¸âƒ£ ç´¢å¼•å¤±æ•ˆå¸¸è§åŸå›  æœ€å·¦å‰ç¼€å¤±æ•ˆ å‡½æ•° / éšå¼è½¬æ¢ %like OR ä¸ƒã€SQL æ‰§è¡Œæµç¨‹ï¼ˆéå¸¸é‡è¦ï¼‰ SELECT * FROM user WHERE id = 10; æ‰§è¡Œæµç¨‹ï¼š\nè¿æ¥éªŒè¯ SQL è§£æ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ æƒé™æ£€æŸ¥ æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“ è¯»å–æ•°æ® è¿”å›ç»“æœ å…«ã€æ—¥å¿—ç³»ç»Ÿï¼ˆç¨³å®šæ€§çš„æ ¹åŸºï¼‰ 1ï¸âƒ£ Redo Logï¼ˆç‰©ç†æ—¥å¿—ï¼‰ ä¿è¯ å´©æºƒæ¢å¤ WAL æœºåˆ¶ é¡ºåºå†™ 2ï¸âƒ£ Undo Logï¼ˆé€»è¾‘æ—¥å¿—ï¼‰ å›æ»š MVCC 3ï¸âƒ£ Binlogï¼ˆé€»è¾‘æ—¥å¿—ï¼‰ ä¸»ä»å¤åˆ¶ PITR å…¨åº“çº§åˆ« 4ï¸âƒ£ Redo vs Binlog å¯¹æ¯” Redo Binlog å±‚çº§ å¼•æ“ Server ç²’åº¦ é¡µ é€»è¾‘ ä½œç”¨ å´©æºƒæ¢å¤ å¤åˆ¶ / æ¢å¤ ä¹ã€ä¸»ä»å¤åˆ¶ï¼ˆé«˜å¯ç”¨åŸºç¡€ï¼‰ 1ï¸âƒ£ åŸç† ä¸»åº“å†™ -\u0026gt; Binlog â†“ ä»åº“ IO çº¿ç¨‹æ‹‰å– â†“ SQL çº¿ç¨‹å›æ”¾ 2ï¸âƒ£ å¸¸è§é—®é¢˜ ä¸»ä»å»¶è¿Ÿ æ•°æ®ä¸ä¸€è‡´ å¤§äº‹åŠ¡é˜»å¡ åã€MySQL é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆè®¤çŸ¥å³å¯ï¼‰ ä¸»ä»å¤åˆ¶ åŠåŒæ­¥å¤åˆ¶ MGRï¼ˆGroup Replicationï¼‰ InnoDB Cluster ProxySQL / Keepalived åä¸€ã€è¿ç»´è§†è§’çš„æ ¸å¿ƒæŒ‡æ ‡ æŒ‡æ ‡ æ„ä¹‰ QPS åå TPS äº‹åŠ¡ Threads_running å¹¶å‘ Buffer Pool Hit å†…å­˜å‘½ä¸­ IO Util ç£ç›˜å‹åŠ› åäºŒã€æ€»ç»“ MySQL = SQL å±‚è´Ÿè´£â€œç®—â€ï¼ŒInnoDB è´Ÿè´£â€œå­˜â€ï¼Œ äº‹åŠ¡é æ—¥å¿—ï¼Œæ€§èƒ½é ç´¢å¼•ï¼Œå¹¶å‘é é”å’Œ MVCCï¼Œ ç¨³å®šé å¤åˆ¶å’Œå¤‡ä»½ã€‚\n","description":" ä¸€ã€MySQL æ•´ä½“æ¶æ„ï¼ˆæœ€æ ¸å¿ƒï¼‰ 1ï¸âƒ£ MySQL æ˜¯ä»€ä¹ˆï¼Ÿ å…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰ åŸºäº Client / Server æ¶æ„ SQL æ˜¯äº¤äº’è¯­è¨€ å­˜å‚¨å¼•æ“å¯æ’æ‹” 2ï¸âƒ£ MySQL é€»è¾‘æ¶æ„ï¼ˆå¿…è€ƒï¼‰ Client â†“ è¿æ¥å±‚ï¼ˆConnectionï¼‰ â†“ SQL å±‚ï¼ˆParser / Optimizer / Executorï¼‰ â†“ å­˜å‚¨å¼•æ“å±‚ï¼ˆInnoDB / Memory / MyISAMï¼‰ â†“ ç£ç›˜ï¼ˆData / Redo / Binlogï¼‰ å„å±‚èŒè´£ä¸€å¥è¯ï¼š\n"},{"id":66,"href":"/operations/nacos/tutorial/","title":"Nacos åŸºç¡€æ•™ç¨‹","parent":"Nacos","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…æ¸…æ™°ã€å®ç”¨ã€æˆä½“ç³»çš„ Nacos å…¨å¥—çŸ¥è¯†ï¼ŒåŒ…æ‹¬ï¼šæ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€é…ç½®ä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒã€é›†ç¾¤éƒ¨ç½²ã€æœ€ä½³å®è·µã€è¿ç»´ä¸æ•…éšœæ’æŸ¥ã€‚\n1. Nacos æ˜¯ä»€ä¹ˆï¼Ÿ Nacos = æœåŠ¡æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ\né˜¿é‡Œå¼€æºï¼Œå¤©ç„¶é€‚é… Spring Cloud Alibabaã€Dubboã€å¾®æœåŠ¡æ¶æ„ã€‚\nåŠŸèƒ½ä¸‰ä»¶å¥—\næœåŠ¡å‘ç°ï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ï¼šæ›¿ä»£ Eurekaã€Consulã€Zookeeperã€‚ é…ç½®ç®¡ç†ï¼ˆé…ç½®ä¸­å¿ƒï¼‰ï¼šæ›¿ä»£ Apolloã€Spring Cloud Configã€‚ åŠ¨æ€ DNS æœåŠ¡ç®¡ç†ï¼ˆä¸å¸¸ç”¨ï¼‰ 2. ä¸ºä»€ä¹ˆä½¿ç”¨ Nacosï¼Ÿï¼ˆä¼˜ç‚¹ï¼‰ ç›¸è¾ƒäº Eureka\næ”¯æŒ AP / CP åˆ‡æ¢ é…ç½®ä¸­å¿ƒå†…ç½®ï¼ˆEureka æ²¡æœ‰ï¼‰ æƒé™ã€å‘½åç©ºé—´ã€åˆ†ç»„æ›´å®Œå–„ ç›¸è¾ƒäº Consulã€Zookeeper\né…ç½®ä¸­å¿ƒèƒ½åŠ›æ›´å¼º UI ç®¡ç†ç•Œé¢æ›´å‹å¥½ æ›´é€‚åˆå›½å†… Spring Cloud Alibaba ç”Ÿæ€ ç›¸è¾ƒäº Apollo\nè½»é‡çº§ã€éƒ¨ç½²ç®€å• æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒäºŒåˆä¸€ï¼ˆApollo åªæœ‰é…ç½®ä¸­å¿ƒï¼‰ 3. Nacos æ¶æ„ æ ¸å¿ƒç»„ä»¶\nNamingServiceï¼šæœåŠ¡æ³¨å†Œ \u0026amp; å¿ƒè·³æ£€æµ‹ ConfigServiceï¼šè¯»å†™é…ç½® \u0026amp; æ¨é€å˜æ›´ Consoleï¼šç®¡ç† UI é›†ç¾¤ + MySQLï¼šå­˜å‚¨æŒä¹…åŒ–é…ç½®ä¸é›†ç¾¤æ•°æ® 4. æ³¨å†Œä¸­å¿ƒï¼ˆNamingï¼‰è¯¦è§£ 4.1 æœåŠ¡æ³¨å†Œæµç¨‹ åº”ç”¨å¯åŠ¨ -\u0026gt; å‘ Nacos æ³¨å†Œå®ä¾‹ï¼ˆIP + Portï¼‰ åº”ç”¨æ¯ 5 ç§’å‘é€å¿ƒè·³ Nacos æ ‡è®°å¥åº·çŠ¶æ€ å®¢æˆ·ç«¯ä» Nacos æ‹‰å–æœåŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒ Pushï¼‰ 4.2 æœåŠ¡å‘ç°æ¨¡å¼ Nacos æ”¯æŒ ä¸¤ç§æ¨¡å‹ï¼š\næ¨¡å¼ ç‰¹ç‚¹ AP æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ æ›´é«˜å¯ç”¨ï¼Œé€‚åˆæ³¨å†Œä¸­å¿ƒ CP æ¨¡å¼ æ•°æ®ä¸€è‡´æ€§å¼ºï¼Œé€‚åˆé…ç½®ä¸­å¿ƒ é€šè¿‡é…ç½®å¯åˆ‡ï¼š\nspring.cloud.nacos.discovery.ephemeral=false 4.3 ä¸´æ—¶å®ä¾‹ vs æ°¸ä¹…å®ä¾‹ ç±»å‹ å¿ƒè·³ é€‚ç”¨åœºæ™¯ ä¸´æ—¶å®ä¾‹ï¼ˆephemeral=trueï¼‰ å¿ƒè·³ä¸¢å¤±è‡ªåŠ¨ä¸‹çº¿ å¾®æœåŠ¡ã€Pod æ°¸ä¹…å®ä¾‹ï¼ˆephemeral=falseï¼‰ æ— å¿ƒè·³ å®¹å™¨å¤–å›ºå®šæœåŠ¡ 4.4 æƒé‡ã€å…ƒæ•°æ®ã€åˆ†ç»„ã€å‘½åç©ºé—´ æ”¯æŒï¼š\nclusterName weightï¼ˆè´Ÿè½½å‡è¡¡ç”¨ï¼‰ metadataï¼ˆè·¯ç”±æ ‡ç­¾ï¼‰ group namespace Spring Cloud ä¸­ï¼š\nspring.cloud.nacos.discovery.cluster-name=HZ spring.cloud.nacos.discovery.metadata.version=v1 5. é…ç½®ä¸­å¿ƒï¼ˆConfigï¼‰è¯¦è§£ 5.1 Nacos é…ç½®å¯¹è±¡ï¼ˆDataIdï¼‰ç»“æ„ ä¸€ä¸ªé…ç½®ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\nnamespace -\u0026gt; group -\u0026gt; dataId ä¾‹ï¼š\nnamespaceï¼šprod groupï¼šapplication dataIdï¼šmyapp.yaml 5.2 é…ç½®æ¨é€æœºåˆ¶ï¼ˆå®æ—¶ï¼‰ ä¿®æ”¹é…ç½®åï¼ŒNacos ä¼šè‡ªåŠ¨ push ç»™æ‰€æœ‰å®¢æˆ·ç«¯ã€‚\nå®¢æˆ·ç«¯æ— éœ€é‡å¯ï¼ŒSpring Boot è‡ªåŠ¨åˆ·æ–°ï¼š\n@RefreshScope @ConfigurationProperties(prefix = \u0026#34;app\u0026#34;) 5.3 é…ç½®æ ¼å¼ æ”¯æŒï¼š\nproperties yaml json text xml æ¨èç»Ÿä¸€ä½¿ç”¨ yamlã€‚\n5.4 å¤šé…ç½®æ–‡ä»¶åˆå¹¶ ä¸»é…ç½®ï¼š\nspring: cloud: nacos: config: extension-configs: - data-id: redis.yaml group: infra refresh: true 6. Nacos é›†ç¾¤éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ æ¨è 3 èŠ‚ç‚¹æˆ– 5 èŠ‚ç‚¹é›†ç¾¤ + MySQL 8.0ã€‚\n6.1 é›†ç¾¤æ¶æ„ [Client] \u0026lt;---\u0026gt; [Nacos1] \u0026lt;---\u0026gt; [Nacos2] \u0026lt;---\u0026gt; [Nacos3] | v [MySQL] 6.2 MySQL ç»“æ„åˆå§‹åŒ– Nacos æä¾› SQL æ–‡ä»¶ï¼š\nnacos/conf/nacos-mysql.sql 6.3 å¯åŠ¨æ—¶é…ç½®ï¼šapplication.properties spring.datasource.platform=mysql db.num=1 db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8 db.user=nacos db.password=123456 6.4 é›†ç¾¤é…ç½® cluster.conf 192.168.1.10:8848 192.168.1.11:8848 192.168.1.12:8848 6.5 åå‘ä»£ç†ï¼ˆNginxï¼‰ æ¨èåŠ ä¸Šï¼š\n/nacos å¹¶å¼€å¯ï¼š\nkeepalive è¿æ¥æ±  è¶…æ—¶è°ƒä¼˜ 7. Nacos æœ€ä½³å®è·µ 7.1 æ³¨å†Œä¸­å¿ƒ Pod è¦è®¾ç½® å¥åº·æ£€æŸ¥ï¼Œé¿å…é¢‘ç¹ä¸Šä¸‹çº¿ ä½¿ç”¨ metadata åšç°åº¦å‘å¸ƒï¼ˆç‰ˆæœ¬è·¯ç”±ï¼‰ ä½¿ç”¨ clusterName åšå¯ç”¨åŒºåˆ†ç¦» 7.2 é…ç½®ä¸­å¿ƒ æ¯ä¸ªåº”ç”¨ç”¨ ç‹¬ç«‹ DataId å…¬å…±é…ç½®ç”¨ shared-configs ä¸è¦æŠŠæ•æ„Ÿä¿¡æ¯ï¼ˆpasswordï¼‰æ”¾æˆæ˜æ–‡ -\u0026gt; ç”¨ KMS / Vault 7.3 èµ„æºè§„åˆ’ è§„æ¨¡ CPU å†…å­˜ å•æœº 2C 4G å°å‹é›†ç¾¤ï¼ˆ3èŠ‚ç‚¹ï¼‰ 4C each 8G each ä¸­å¤§å‹ 8C+ 16G~32G 7.4 æ€§èƒ½ä¼˜åŒ– JVM è®¾ç½®ï¼š-Xms4g -Xmx4g è°ƒå¤§ MySQL è¿æ¥æ±  Nacos 2.x é€šä¿¡æ”¹ä¸º gRPCï¼Œæ•ˆç‡æ›´é«˜ï¼ˆæ— éœ€å†å¼€å¤ªå¤š HTTP è¿æ¥ï¼‰ 7.5 å®‰å…¨åŠ å›º å¼€å¯é‰´æƒ auth å…³æ‰å…¬ç½‘ç«¯å£ æƒé™åˆ†ç¦» namespaceã€group 8. Nacos æ•…éšœæ’æŸ¥ 8.1 å¸¸è§é—®é¢˜ â‘  â€œæœåŠ¡åå¤ä¸Šä¸‹çº¿â€\nPod å¥åº·æ£€æŸ¥è¿‡äºä¸¥æ ¼ ç½‘ç»œæŠ–åŠ¨ å¿ƒè·³å»¶è¿Ÿ è§£å†³ï¼š\nspring.cloud.nacos.discovery.heart-beat-interval=5000 spring.cloud.nacos.discovery.heart-beat-timeout=15000 â‘¡ é…ç½®åˆ·æ–°å¤±è´¥\nNetwork ä¸é€š é…ç½®æ ¼å¼é”™è¯¯ï¼ˆYAML ç¼©è¿›ï¼‰ â‘¢ MySQL è¿æ¥è¢«æ‹’ç»\nMySQL æƒé™ä¸å¯¹ æ•°æ®åº“æœªåˆå§‹åŒ– é•¿è¿æ¥è¿‡å¤š â‘£ é›†ç¾¤èŠ‚ç‚¹ä¸äº’é€š\ncluster.conf é…é”™ IP 8848 / 7848 ç«¯å£æœªå¼€æ”¾ 9. Nacos ç›¸å…³å‘½ä»¤ï¼ˆCurlï¼‰ æŸ¥è¯¢æœåŠ¡\ncurl -X GET \u0026#34;127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=test-service\u0026#34; å‘å¸ƒé…ç½®\ncurl -X POST \u0026#34;127.0.0.1:8848/nacos/v1/cs/configs\u0026#34; \\ -d \u0026#34;dataId=test.yaml\u0026amp;group=DEFAULT_GROUP\u0026amp;content=hello\u0026#34; ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…æ¸…æ™°ã€å®ç”¨ã€æˆä½“ç³»çš„ Nacos å…¨å¥—çŸ¥è¯†ï¼ŒåŒ…æ‹¬ï¼šæ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€é…ç½®ä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒã€é›†ç¾¤éƒ¨ç½²ã€æœ€ä½³å®è·µã€è¿ç»´ä¸æ•…éšœæ’æŸ¥ã€‚\n1. Nacos æ˜¯ä»€ä¹ˆï¼Ÿ Nacos = æœåŠ¡æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ\né˜¿é‡Œå¼€æºï¼Œå¤©ç„¶é€‚é… Spring Cloud Alibabaã€Dubboã€å¾®æœåŠ¡æ¶æ„ã€‚\nåŠŸèƒ½ä¸‰ä»¶å¥—\næœåŠ¡å‘ç°ï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰ï¼šæ›¿ä»£ Eurekaã€Consulã€Zookeeperã€‚ é…ç½®ç®¡ç†ï¼ˆé…ç½®ä¸­å¿ƒï¼‰ï¼šæ›¿ä»£ Apolloã€Spring Cloud Configã€‚ åŠ¨æ€ DNS æœåŠ¡ç®¡ç†ï¼ˆä¸å¸¸ç”¨ï¼‰ 2. ä¸ºä»€ä¹ˆä½¿ç”¨ Nacosï¼Ÿï¼ˆä¼˜ç‚¹ï¼‰ ç›¸è¾ƒäº Eureka\næ”¯æŒ AP / CP åˆ‡æ¢ é…ç½®ä¸­å¿ƒå†…ç½®ï¼ˆEureka æ²¡æœ‰ï¼‰ æƒé™ã€å‘½åç©ºé—´ã€åˆ†ç»„æ›´å®Œå–„ ç›¸è¾ƒäº Consulã€Zookeeper\n"},{"id":67,"href":"/operations/nginx/tutorial/","title":"Nginx åŸºç¡€æ•™ç¨‹","parent":"Nginx","content":" 1. Master / Worker æ¶æ„ Nginx æ˜¯ å¤šè¿›ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼š\nmaster è¿›ç¨‹ è¯»å–é…ç½®æ–‡ä»¶ ç®¡ç† worker è¿›ç¨‹ï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡è½½ï¼‰ worker è¿›ç¨‹ çœŸæ­£å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ æ¯ä¸ª worker å•çº¿ç¨‹ ä½¿ç”¨ â€œå¼‚æ­¥éé˜»å¡ + epollâ€ å¤„ç†å¤§é‡è¿æ¥ ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼šworker_processes = CPU æ ¸å¿ƒæ•°ï¼ˆauto é»˜è®¤æœ€ä¼˜ï¼‰\n2. äº‹ä»¶é©±åŠ¨ï¼ˆEvent-drivenï¼‰ Nginx ä½¿ç”¨ epollï¼ˆLinuxï¼‰æ¨¡å‹ï¼š\néé˜»å¡ IO äº‹ä»¶å¾ªç¯ å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡å¹¶å‘ è¿™æ˜¯ Nginx æ€§èƒ½é«˜çš„æ ¹æœ¬åŸå› ã€‚\n3. è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰ æµè§ˆå™¨è¯·æ±‚ç»è¿‡ï¼š\nlisten -\u0026gt; server -\u0026gt; location -\u0026gt; upstream / proxy_pass -\u0026gt; response\n3.1 listen ç›‘å¬ç«¯å£ã€åè®®ï¼š\nlisten 80; listen 443 ssl; http2 on; 3.2 server æ ¹æ® Host åŒ¹é…è™šæ‹Ÿä¸»æœºï¼š\nserver_name example.com; 3.3 location æ ¹æ® URL è·¯å¾„åŒ¹é…è·¯ç”±è§„åˆ™ï¼š\nlocation /api/ { proxy_pass http://backend; } 3.4 upstream å®šä¹‰åç«¯è´Ÿè½½å‡è¡¡é›†ç¾¤ï¼š\nupstream backend { server 127.0.0.1:8000; server 127.0.0.1:8001; } 3.5 output è¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚\n4. proxy ä»£ç†æ¨¡å¼ Nginx ç»å¸¸ä½œä¸ºåå‘ä»£ç†ï¼š\nlocation / { proxy_pass http://127.0.0.1:8080; } ä»£ç†è¯·æ±‚ -\u0026gt; è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ å¯è½¬å‘æ‰€æœ‰ header / body / cookie 5. é™æ€èµ„æºæœåŠ¡ï¼ˆæ–‡ä»¶æœåŠ¡å™¨ï¼‰ location /img/ { root /data/www; } ä¾èµ– sendfile on; æå‡æœ¬åœ°æ–‡ä»¶è¯»å–é€Ÿåº¦ã€‚\n6. è´Ÿè½½å‡è¡¡ï¼ˆupstreamï¼‰ æ”¯æŒå¤šç§ç­–ç•¥ï¼š\nround_robinï¼ˆé»˜è®¤ï¼‰ least_connï¼ˆæœ€å°‘è¿æ¥ï¼‰ ip_hashï¼ˆä¿æŒç”¨æˆ·ä¼šè¯ï¼‰ weightï¼ˆæƒé‡ï¼‰ upstream api { least_conn; server 10.0.0.1; server 10.0.0.2; } 7. ç¼“å­˜ï¼ˆproxy_cache / fastcgi_cacheï¼‰ Nginx å¯åšåå‘ä»£ç†ç¼“å­˜ï¼š\nproxy_cache_path /cache keys_zone=mycache:50m; proxy_cache mycache; ä½†ä½ ä¹‹å‰è¯´äº†â€œä¸ç¼“å­˜â€ï¼Œé‚£é»˜è®¤å³å¯ï¼ˆNginx é»˜è®¤ä¸å¼€ç¼“å­˜ï¼‰ã€‚\n8. å˜é‡ç³»ç»Ÿï¼ˆéå¸¸é‡è¦ï¼‰ Nginx æœ‰å¤§é‡å†…ç½®å˜é‡ï¼š\nå˜é‡ è¯´æ˜ $host è¯·æ±‚çš„ Host å¤´ $uri è¯·æ±‚è·¯å¾„ $request_uri åŸå§‹URIï¼ˆå«å‚æ•°ï¼‰ $args query å‚æ•° $remote_addr å®¢æˆ·ç«¯IP $proxy_add_x_forwarded_for XFFé“¾ ç¤ºä¾‹ï¼š\nproxy_set_header Host $host; 9. åŒ¹é…è§„åˆ™ï¼ˆlocation ä¼˜å…ˆçº§ï¼‰ ä»é«˜åˆ°ä½ï¼š\n= ç²¾ç¡®åŒ¹é… ^~ å‰ç¼€ä¼˜å…ˆ æ­£åˆ™ï¼š~ / ~* æ™®é€šå‰ç¼€åŒ¹é…ï¼ˆä»æœ€é•¿å¼€å§‹ï¼‰ / é»˜è®¤ ç¤ºä¾‹ï¼š\nlocation = /admin {} location ^~ /static {} location ~ \\.php$ {} location / {} 10. rewrite + å†…éƒ¨è·³è½¬ rewrite ç”¨æ­£åˆ™é‡å†™ URLï¼š\nrewrite ^/img/(.*) /pictures/$1 last; å¸¸ç”¨äºï¼š\nå‰ç«¯ history è·¯ç”± SEO URL è°ƒæ•´ å…¼å®¹æ—§æ¥å£ 11. æ¨¡å—ç³»ç»Ÿ Nginx æ˜¯æ¨¡å—åŒ–ç³»ç»Ÿï¼š\næ ¸å¿ƒæ¨¡å—ï¼ˆhttpã€streamã€mailï¼‰ ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆLuaã€Headers-Moreã€Proxy-Cache-Purgeâ€¦ï¼‰ åŠ¨æ€æ¨¡å— .so 12. HTTP / Stream åŒåè®® HTTP æ¨¡å—ï¼šwebã€proxyã€è´Ÿè½½å‡è¡¡ Stream æ¨¡å—ï¼šTCP/UDP ä»£ç† ç”¨äº MySQL / Redis / SMTP ä»£ç† ç¤ºä¾‹ï¼š\nstream { upstream mysql { server 10.0.0.1:3306; } server { listen 3307; proxy_pass mysql; } } 13. SSL / HTTP/2 / HTTP/3 æ”¯æŒ æ–°å†™æ³•ï¼š\nlisten 443 ssl; http2 on; HTTP/3ï¼š\nlisten 443 quic reuseport; http3 on; ğŸ¯ æ€»ç»“ Nginx ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„é«˜æ€§èƒ½åå‘ä»£ç† / é™æ€æœåŠ¡å™¨ / è´Ÿè½½å‡è¡¡å™¨ï¼Œæ ¸å¿ƒæ˜¯ master/worker + epollã€‚\n","description":" 1. Master / Worker æ¶æ„ Nginx æ˜¯ å¤šè¿›ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼š\nmaster è¿›ç¨‹ è¯»å–é…ç½®æ–‡ä»¶ ç®¡ç† worker è¿›ç¨‹ï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡è½½ï¼‰ worker è¿›ç¨‹ çœŸæ­£å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ æ¯ä¸ª worker å•çº¿ç¨‹ ä½¿ç”¨ â€œå¼‚æ­¥éé˜»å¡ + epollâ€ å¤„ç†å¤§é‡è¿æ¥ ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼šworker_processes = CPU æ ¸å¿ƒæ•°ï¼ˆauto é»˜è®¤æœ€ä¼˜ï¼‰\n2. äº‹ä»¶é©±åŠ¨ï¼ˆEvent-drivenï¼‰ Nginx ä½¿ç”¨ epollï¼ˆLinuxï¼‰æ¨¡å‹ï¼š\n"},{"id":68,"href":"/operations/nginx/core/","title":"Nginx æ ¸å¿ƒæ¦‚å¿µ","parent":"Nginx","content":" ä¸€ã€Nginx æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ ä¸€å¥è¯å®šä¹‰ï¼š\nNginx æ˜¯ä¸€ä¸ª åŸºäºäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥éé˜»å¡ I/O çš„å¤šè¿›ç¨‹ç½‘ç»œæœåŠ¡å™¨ä¸åå‘ä»£ç†å¹³å°ã€‚\nå®ƒæ—¢æ˜¯ï¼š\nWeb Serverï¼ˆé™æ€æ–‡ä»¶ï¼‰ Reverse Proxyï¼ˆåå‘ä»£ç†ï¼‰ Load Balancerï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ API Gatewayï¼ˆç½‘å…³ï¼‰ TCP/UDP Proxyï¼ˆå››å±‚ä»£ç†ï¼‰ äºŒã€æ ¸å¿ƒæ¶æ„æ¨¡å‹ï¼ˆæœ€é‡è¦ï¼‰ Master / Worker æ¶æ„\nMaster Process / | \\ Worker #1 Worker #2 Worker #N å„è‡ªèŒè´£ï¼š\nMaster\nè¯»å–/æ ¡éªŒé…ç½® ç›‘å¬ç«¯å£ fork worker å¹³æ»‘ reloadï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ ç®¡ç† worker ç”Ÿå‘½å‘¨æœŸ Worker\nçœŸæ­£å¤„ç†è¯·æ±‚ å•çº¿ç¨‹ ä½¿ç”¨äº‹ä»¶é©±åŠ¨ï¼ˆepollï¼‰ å¯åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡è¿æ¥ ğŸ‘‰ ç»“è®ºï¼š\næ²¡æœ‰å¤šçº¿ç¨‹é”ç«äº‰ æ²¡æœ‰é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢ æé«˜å¹¶å‘èƒ½åŠ› ä¸‰ã€äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼ˆæ€§èƒ½æ ¸å¿ƒï¼‰ ä¼ ç»Ÿæ¨¡å‹ï¼ˆApache / Tomcatï¼‰ 1 è¯·æ±‚ = 1 çº¿ç¨‹/è¿›ç¨‹ é—®é¢˜ï¼š\nçº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§ æ…¢è¯·æ±‚æ‹–å®ç³»ç»Ÿ Nginx æ¨¡å‹ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰ 1 worker + epoll å¤„ç† N ä¸ªè¿æ¥ I/O ä¸é˜»å¡ æ…¢è¿æ¥ä¸å ç”¨ worker äº‹ä»¶è§¦å‘æ‰å¤„ç† ğŸ‘‰ è¿™å°±æ˜¯ Nginx é«˜å¹¶å‘çš„æ ¹æœ¬åŸå› \nå››ã€ä¸ºä»€ä¹ˆ worker æ˜¯â€œå•çº¿ç¨‹â€åè€Œæ›´å¿«ï¼Ÿ å› ä¸ºï¼š\nå•çº¿ç¨‹ â‡’ æ— é” æ— é” â‡’ æ— ç«äº‰ æ— ç«äº‰ â‡’ CPU Cache å‘½ä¸­ç‡é«˜ å¤šæ ¸é€šè¿‡ å¤š worker åˆ©ç”¨ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ã€‚\näº”ã€è¯·æ±‚å¤„ç†ç”Ÿå‘½å‘¨æœŸï¼ˆå¿…é¡»ä¼šè®²ï¼‰ ä¸€æ¬¡ HTTP è¯·æ±‚å¤§è‡´æµç¨‹ï¼š\nclient å»ºç«‹ TCP è¿æ¥ worker æ¥æ”¶è¿æ¥ï¼ˆepoll è§¦å‘ï¼‰ è¯»å–è¯·æ±‚å¤´ è§£æ HTTP åè®® åŒ¹é… server åŒ¹é… location é€‰æ‹©æ¨¡å—ï¼ˆstatic / proxy / fastcgiï¼‰ å¤„ç†æˆ–è½¬å‘è¯·æ±‚ å†™å›å“åº” è®°å½•æ—¥å¿— è¿æ¥å¤ç”¨ / å…³é—­ å…­ã€æ ¸å¿ƒé…ç½®å—ï¼ˆè¯­ä¹‰çº§ç†è§£ï¼‰ 1ï¸âƒ£ mainï¼ˆå…¨å±€ï¼‰ worker_processes auto; -\u0026gt; æ§åˆ¶ worker æ•°é‡\n2ï¸âƒ£ eventsï¼ˆäº‹ä»¶ï¼‰ use epoll; worker_connections 65535; -\u0026gt; å†³å®šæœ€å¤§å¹¶å‘èƒ½åŠ›\næœ€å¤§è¿æ¥ â‰ˆ worker_processes Ã— worker_connections\n3ï¸âƒ£ httpï¼ˆHTTP å¼•æ“ï¼‰ http { server { ... } } -\u0026gt; å®šä¹‰ HTTP åè®®å±‚çš„è¡Œä¸º\n4ï¸âƒ£ serverï¼ˆè™šæ‹Ÿä¸»æœºï¼‰ server { listen 80; server_name example.com; } -\u0026gt; ç±»ä¼¼ Apache çš„ VirtualHost\n5ï¸âƒ£ locationï¼ˆè¯·æ±‚è·¯ç”±æ ¸å¿ƒï¼‰ location /api/ { } -\u0026gt; Nginx æœ€å¼ºå¤§çš„åœ°æ–¹ -\u0026gt; é€šè¿‡ URI è·¯ç”±è¯·æ±‚\nä¸ƒã€location åŒ¹é…è§„åˆ™ï¼ˆå¿…è€ƒï¼‰ ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š\n= ç²¾ç¡®åŒ¹é… ^~ å‰ç¼€åŒ¹é…ï¼ˆç»ˆæ­¢æ­£åˆ™ï¼‰ ~ / ~* æ­£åˆ™åŒ¹é… æ™®é€šå‰ç¼€åŒ¹é… / é»˜è®¤å…œåº• å…«ã€æ¨¡å—åŒ–è®¾è®¡ï¼ˆNginx çš„çµé­‚ï¼‰ Nginx æ˜¯ æ¨¡å—é©±åŠ¨ çš„ï¼š\næ ¸å¿ƒæ¨¡å—ï¼ˆcoreï¼‰ HTTP æ¨¡å— Stream æ¨¡å— Mail æ¨¡å— ç¬¬ä¸‰æ–¹æ¨¡å— ğŸ‘‰ è¯·æ±‚åœ¨å¤„ç†é“¾è·¯ä¸­è¢«å¤šä¸ªæ¨¡å—â€œé’©å­â€æ¥ç®¡\nè¿™ä¹Ÿæ˜¯ï¼š\nLua / OpenResty èƒ½æ‰©å±•çš„åŸå›  Nginx å¯å®šåˆ¶æ€§æå¼ºçš„åŸå›  ä¹ã€åå‘ä»£ç†çš„æœ¬è´¨ åå‘ä»£ç†ä¸æ˜¯â€œè½¬å‘â€ï¼Œè€Œæ˜¯ï¼š\nNginx ä½œä¸º è¯·æ±‚ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†è€…\nå®ƒè´Ÿè´£ï¼š\nè¿æ¥ç®¡ç† å¤±è´¥é‡è¯• è¶…æ—¶æ§åˆ¶ header é‡å†™ gzip ç¼“å­˜ æ—¥å¿— å®‰å…¨æ§åˆ¶ åã€è´Ÿè½½å‡è¡¡çš„åº•å±‚é€»è¾‘ upstream çš„æœ¬è´¨ï¼š\nåç«¯è¿æ¥æ±  å¤±è´¥æ„ŸçŸ¥ è°ƒåº¦ç®—æ³• å¸¸è§è°ƒåº¦ç­–ç•¥ï¼š\nround robinï¼ˆå¹³å‡ï¼‰ least_connï¼ˆæœ€ä¼˜ï¼‰ ip_hashï¼ˆç²˜æ€§ï¼‰ hashï¼ˆä¸€è‡´æ€§ï¼‰ åä¸€ã€HTTP/1.1 vs HTTP/2ï¼ˆåŸºç¡€å·®å¼‚ï¼‰ HTTP/1.1\nä¸€ä¸ªè¿æ¥é¡ºåºå¤„ç†è¯·æ±‚ Head-of-line blocking HTTP/2\nå¤šè·¯å¤ç”¨ äºŒè¿›åˆ¶å¸§ Header å‹ç¼© å»¶è¿Ÿå¤§å¹…ä¸‹é™ ğŸ‘‰ Nginx ä½œä¸º HTTP/2 serverï¼š\nlisten 443 ssl; http2 on; åäºŒã€TCP / OS å±‚åŸºç¡€ï¼ˆå¾ˆå¤šäººå¿½ç•¥ï¼‰ Nginx é«˜æ€§èƒ½ = Nginx + OS\nå…³é”®ç‚¹ï¼š\nepoll æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼ˆulimit -nï¼‰ TCP backlog TIME_WAIT å›æ”¶ sendfile é›¶æ‹·è´ åä¸‰ã€ä¸ºä»€ä¹ˆ Nginx reload ä¸ä¼šä¸­æ–­æœåŠ¡ï¼Ÿ å› ä¸ºï¼š\nmaster fork æ–° worker æ–° worker æ¥ç®¡æ–°è¿æ¥ è€ worker å¤„ç†å®Œç°æœ‰è¿æ¥åé€€å‡º ğŸ‘‰ ä¼˜é›…é‡å¯ï¼ˆgraceful reloadï¼‰\nåå››ã€Nginx ä¸ Apache çš„æ ¹æœ¬åŒºåˆ« å¯¹æ¯” Nginx Apache å¹¶å‘æ¨¡å‹ äº‹ä»¶é©±åŠ¨ å¤šè¿›ç¨‹/çº¿ç¨‹ å†…å­˜ æä½ é«˜ é™æ€èµ„æº æå¼º ä¸€èˆ¬ é«˜å¹¶å‘ å¤©ç”Ÿä¼˜åŠ¿ æ˜“å´© åŠ¨æ€å†…å®¹ ä»£ç† å†…åµŒæ¨¡å— åäº”ã€è®¾è®¡å“²å­¦æ€»ç»“ Nginx çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š\næŠŠå¤æ‚ç•™ç»™åç«¯ è‡ªå·±åªåšâ€œé«˜æ•ˆçš„æµé‡è°ƒåº¦å™¨â€ ç”¨æœ€å°‘çš„èµ„æºå¤„ç†æœ€å¤šçš„è¿æ¥ ","description":" ä¸€ã€Nginx æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ ä¸€å¥è¯å®šä¹‰ï¼š\nNginx æ˜¯ä¸€ä¸ª åŸºäºäº‹ä»¶é©±åŠ¨ã€å¼‚æ­¥éé˜»å¡ I/O çš„å¤šè¿›ç¨‹ç½‘ç»œæœåŠ¡å™¨ä¸åå‘ä»£ç†å¹³å°ã€‚\nå®ƒæ—¢æ˜¯ï¼š\nWeb Serverï¼ˆé™æ€æ–‡ä»¶ï¼‰ Reverse Proxyï¼ˆåå‘ä»£ç†ï¼‰ Load Balancerï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ API Gatewayï¼ˆç½‘å…³ï¼‰ TCP/UDP Proxyï¼ˆå››å±‚ä»£ç†ï¼‰ äºŒã€æ ¸å¿ƒæ¶æ„æ¨¡å‹ï¼ˆæœ€é‡è¦ï¼‰ Master / Worker æ¶æ„\nMaster Process / | \\ Worker #1 Worker #2 Worker #N å„è‡ªèŒè´£ï¼š\n"},{"id":69,"href":"/database/postgres/pgbackrest/","title":"pgBackRest åŸºç¡€æ•™ç¨‹","parent":"PostgreSQL","content":"å®˜æ–¹æ–‡æ¡£ï¼š\npgBackRest: https://pgbackrest.org/ GitHub: https://github.com/pgbackrest/pgbackrest.git ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å®æˆ˜åŒ–çš„ pgBackRest çŸ¥è¯†ä½“ç³»ï¼Œä¸€æ¬¡æ€§æŠŠæ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€é…ç½®ã€å¤‡ä»½ç­–ç•¥ã€æ¢å¤æµç¨‹ã€æœ€ä½³å®è·µå…¨éƒ¨è®²æ¸…æ¥šï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨ã€‚\npgBackRest â€” PostgreSQL ä¼ä¸šçº§å¤‡ä»½æ¢å¤å·¥å…· pgBackRest æ˜¯ PostgreSQL æœ€å¼º çš„å¤‡ä»½ä¸æ¢å¤å·¥å…·ä¹‹ä¸€ï¼Œæ›¿ä»£ pg_basebackupã€æŠ€æœ¯æˆç†Ÿã€ä¼ä¸šå¤§é‡ä½¿ç”¨ï¼Œæ”¯æŒå…¨é‡/å·®é‡/å¢é‡å¤‡ä»½ã€é«˜æ•ˆå‹ç¼©ã€WAL å½’æ¡£ã€PITR æ¢å¤ã€å¯¹è±¡å­˜å‚¨ç­‰åŠŸèƒ½ã€‚\nå…¶æ ¸å¿ƒç›®æ ‡ï¼š\nå¯é ï¼ˆReliableï¼‰ é«˜æ€§èƒ½ï¼ˆPerformanceï¼‰ æ˜“ç®¡ç†ï¼ˆManageableï¼‰ ä¸€ã€pgBackRest æ ¸å¿ƒç‰¹æ€§ 1. å…¨é‡ / å·®é‡ / å¢é‡å¤‡ä»½ fullï¼šå…¨é‡å¤‡ä»½ï¼Œå®Œæ•´æ•°æ®ç›®å½• diffï¼šå·®é‡å¤‡ä»½ï¼ŒåŸºäºä¸Šæ¬¡ full å¤‡ä»½åçš„æ‰€æœ‰å˜åŒ– incrï¼šå¢é‡å¤‡ä»½ï¼ŒåŸºäºæœ€è¿‘ä¸€æ¬¡ full æˆ– diff å¤‡ä»½åçš„å˜åŒ– 2. æ”¯æŒæœ¬åœ°ã€è¿œç¨‹ã€å¯¹è±¡å­˜å‚¨ Local FS Remote Hostï¼ˆsshï¼‰ S3 / MinIO / aliyun OSS / Google / Azure 3. WAL å­˜æ¡£ä¸å®Œæ•´æ€§æ£€æŸ¥ è‡ªåŠ¨ push/pull WALï¼ˆæ›¿ä»£ archive_commandï¼‰ ä¿éšœå¯æ¢å¤æ€§ï¼ˆWAL å®Œæ•´æ€§æ£€æŸ¥ï¼‰ 4. æ”¯æŒ å‹ç¼©ã€å¤šçº¿ç¨‹ã€å¹¶è¡Œä¼ è¾“ èŠ‚çœå­˜å‚¨ é«˜é€Ÿå¤‡ä»½è¿˜åŸ 5. æ”¯æŒ PITRï¼ˆPoint In Time Recoveryï¼‰ ç²¾ç¡®æ¢å¤åˆ°ä»»æ„æ—¶åˆ» 6. å¼ºå¤§çš„é…ç½®ä½“ç³» æ”¯æŒå¤šä¸ª stanza åŒæ—¶ç®¡ç†å¤šä¸ª PostgreSQL å®ä¾‹ äºŒã€pgBackRest æ¶æ„ä¸æœ¯è¯­ stanza pgBackRest çš„â€œå¤‡ä»½é›†â€ã€é€»è¾‘å•ä½ï¼Œç±»ä¼¼ï¼š\nä¸€ç»„ PostgreSQL é›†ç¾¤ï¼ˆä¸€ä¸ª PGDATAï¼‰ ä¸€ä¸ªå¤‡ä»½ç›®å½•ï¼ˆrepoï¼‰ é€šå¸¸ä¸€ä¸ª PostgreSQL é›†ç¾¤åˆ›å»ºä¸€ä¸ª stanzaã€‚\nrepoï¼ˆä»“åº“ï¼‰ å¤‡ä»½æ•°æ®å­˜æ”¾ä½ç½®ï¼Œä¾‹å¦‚ï¼š\n/data/pgbackrest/repo1 ä¸»æœºè§’è‰² Database Host (DB Host)ï¼šè¿è¡Œ PostgreSQL çš„ä¸»æœº Repository Hostï¼šå­˜å‚¨å¤‡ä»½æ•°æ®çš„ä¸»æœºï¼ˆå¯ä»¥ä¸ DB å…±å­˜ï¼‰ äºŒè€…å¯åˆ†ç¦»æˆ–åŒæœºã€‚\nä¸‰ã€å…¸å‹éƒ¨ç½²æ–¹å¼ 1) å•æœºæœ¬åœ°å¤‡ä»½ï¼ˆæœ€ç®€å•ã€å¸¸ç”¨ï¼‰ PostgreSQL + pgBackRest\nå¤‡ä»½ -\u0026gt; æœ¬åœ° /data/pgbackrest/\n2) è¿œç¨‹ repo + SSH PostgreSQL \u0026mdash;ssh\u0026mdash;\u0026gt; Backup Server\n3) S3 / MinIO è¿œç¨‹å¤‡ä»½ PostgreSQL \u0026mdash;https\u0026mdash;\u0026gt; S3\néå¸¸é€‚åˆäº‘ç¯å¢ƒã€‚\nå››ã€é…ç½®ç¤ºä¾‹ï¼ˆæœ€å¸¸ç”¨ç‰ˆï¼‰ ä»¥æœ¬åœ°å¤‡ä»½ä¸ºä¾‹ã€‚\n1. å®‰è£… # RHEL/CentOS/AlmaLinux yum install -y pgbackrest # Debian/Ubuntu sudo apt install -y pgbackrest 2. åˆ›å»º repo ç›®å½• mkdir -p /data/pgbackrest chown -R postgres:postgres /data/pgbackrest chmod 750 /data/pgbackrest 3. é…ç½®æ–‡ä»¶ /etc/pgbackrest.conf /etc/pgbackrest/pgbackrest.conf [global] repo1-path=/data/pgbackrest/repo1 repo1-retention-full=7 start-fast=y log-level-console=info [mydb] pg1-path=/var/lib/pgsql/16/data 4. åˆå§‹åŒ– stanza pgbackrest --stanza=main stanza-create pgbackrest --stanza=main check äº”ã€å¤‡ä»½å‘½ä»¤å¤§å…¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ å…¨é‡å¤‡ä»½ pgbackrest --stanza=main --type=full backup å·®é‡å¤‡ä»½ pgbackrest --stanza=main --type=diff backup å¢é‡å¤‡ä»½ pgbackrest --stanza=main --type=incr backup æŸ¥çœ‹å¤‡ä»½ä¿¡æ¯ pgbackrest info åˆ é™¤æ—§å¤‡ä»½ï¼ˆè‡ªåŠ¨æ ¹æ® retentionï¼‰ æ— éœ€æ‰‹åŠ¨åˆ é™¤ï¼ŒpgBackRest ä¼šè‡ªåŠ¨æ¸…ç†ã€‚\nå…­ã€WAL å½’æ¡£é…ç½®ï¼ˆæœ€å…³é”®ï¼‰ ç¼–è¾‘ postgresql.confï¼š\narchive_mode = on archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; éªŒè¯ WAL æ¨é€\npgbackrest --stanza=main check ä¸ƒã€æ¢å¤ï¼ˆæœ€å…³é”®çš„éƒ¨åˆ†ï¼‰ 1. é€‰æ‹©æœ€æ–° backup çš„æ¢å¤ pgbackrest --stanza=main restore æ¢å¤ç›®å½•ä¼šè¢«è‡ªåŠ¨è¦†ç›–ä¸º PGDATAã€‚\n2. æŒ‡å®šæ¢å¤æ—¶é—´ç‚¹ï¼ˆPITRï¼‰ pgbackrest --stanza=main --type=time \u0026#34;--target=2025-01-18 10:12:00\u0026#34; restore 3. æ¢å¤åˆ°ç‰¹å®šå¤‡ä»½ pgbackrest --stanza=main --set=20250118-100000F restore 4. æ¢å¤åˆ°æœ€è¿‘ä¸€è‡´ç‚¹ï¼ˆæ—  PITRï¼‰ pgbackrest restore --stanza=mydb --type=default æ¢å¤åå¯åŠ¨ PostgreSQLï¼š\npg_ctl -D /var/lib/pgsql/16/data start å…«ã€ç”Ÿäº§æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ 1. ä¸€å®šè¦æœ‰ WAL å½’æ¡£ å¦åˆ™æ— æ³•è¿›è¡Œ PITRï¼Œä¹Ÿæ— æ³•ä¿è¯æ•°æ®å®‰å…¨ã€‚\n2. å»ºè®®å¤‡ä»½ç­–ç•¥ï¼ˆæœ€ä½³å®è·µï¼‰ æ¯å¤©ä¸€ä»½ full + æ¯å°æ—¶ diff/incrï¼š\næ¯å¤© 02:00 full æ¯å°æ—¶ incr PGBackRest è‡ªå¸¦ retentionï¼Œè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ã€‚\n3. å¤šçº¿ç¨‹åŠ é€Ÿ process-max=8\n4. å¼€å¯å‹ç¼© compress-type=zstd compress-level=3 5. å¤‡ä»½ä¸“ç”¨æœåŠ¡å™¨ï¼ˆæ¨èï¼‰ å‡å°‘ DB æœåŠ¡å™¨ IO å‹åŠ›ã€‚\n6. S3 å­˜å‚¨ï¼ˆä¼ä¸šå¿…å¤‡ï¼‰ MinIO / é˜¿é‡Œäº‘ OSS / AWS S3\n7. å®šæœŸéªŒè¯å¤‡ä»½å¯æ¢å¤æ€§ pgbackrest --stanza=main check æˆ–å®šæœŸåšä¸€æ¬¡æ¢å¤æ¼”ç»ƒã€‚\nä¹ã€pgBackRest vs pg_basebackup ç‰¹æ€§ pgBackRest pg_basebackup å·®é‡å¤‡ä»½ âœ… âŒ å¢é‡å¤‡ä»½ âœ… âŒ è‡ªåŠ¨ WAL å½’æ¡£ âœ… âŒ å¹¶è¡Œå¤‡ä»½ âœ… âœ… å¤š repo âœ… âŒ S3 / è¿œç¨‹ âœ… âŒ ä¸»ä»æ¨¡å¼ âœ… âœ… pgBackRest æ˜¯ pg_basebackup çš„ è¶…é›†ï¼Œå¼ºå¤ªå¤šã€‚\nä¸‹é¢æ˜¯ä¸€ä»½ pgBackRest è¶…æ¸…æ™°ã€å…¨é¢ã€å®æˆ˜å‘ çš„æ•™ç¨‹ï¼Œé€‚åˆ PostgreSQL ç”Ÿäº§ç¯å¢ƒå¤‡ä»½ã€æ¢å¤ã€å¢é‡å¤‡ä»½ã€WAL ç®¡ç†ã€é«˜å¯ç”¨æ¶æ„ã€‚\nğŸ“˜ ä»€ä¹ˆæ˜¯ pgBackRestï¼Ÿ pgBackRest æ˜¯ PostgreSQL ç›®å‰æœ€å¼ºã€æœ€å¯é çš„ä¼ä¸šçº§å¤‡ä»½ä¸æ¢å¤å·¥å…·ä¹‹ä¸€ã€‚\nå®ƒçš„ç›®æ ‡æ˜¯ï¼š\né«˜æ€§èƒ½ï¼ˆå¤šçº¿ç¨‹ã€å‹ç¼©ã€å¹¶è¡Œä¼ è¾“ï¼‰ é«˜å¯é æ€§ï¼ˆä¸¥æ ¼æ ¡éªŒã€è‡ªåŠ¨æ¢å¤ WALï¼‰ æç®€æ¢å¤ï¼ˆåŸºäºæ—¶é—´ç‚¹ PITRï¼‰ æ”¯æŒéå¸¸å¤§çš„æ•°æ®åº“ï¼ˆTB~PBï¼‰ ç›¸æ¯”ä¼ ç»Ÿ pg_basebackupï¼š\nåŠŸèƒ½ pg_basebackup pgBackRest å…¨é‡å¤‡ä»½ âœ… âœ… å¢é‡å¤‡ä»½ âŒ âœ… å·®å¼‚å¤‡ä»½ âŒ âœ… å¹¶è¡Œå¤‡ä»½ âŒ âœ… éªŒè¯æ ¡éªŒå’Œ âŒ âœ… è‡ªåŠ¨ç®¡ç† WAL âŒ âœ… åŠ å¯†å¤‡ä»½ âŒ âœ… S3 / MinIO å¤‡ä»½ âŒ âœ… è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ âŒ âœ… pgBackRest = PostgreSQL å¤‡ä»½ç•Œçš„å¤©èŠ±æ¿\nğŸª„ pgBackRest æ ¸å¿ƒåŠŸèƒ½æ€»ç»“ å…¨é‡ã€å¢é‡ã€å·®å¼‚å¤‡ä»½ æ”¯æŒæœ¬åœ°ã€è¿œç¨‹ã€S3ã€MinIOã€å¤šå­˜å‚¨ è‡ªåŠ¨å½’æ¡£ WAL è‡ªåŠ¨åˆå¹¶æ—§å¤‡ä»½ PITRï¼ˆæŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼‰ å¤šçº¿ç¨‹å¤‡ä»½/æ¢å¤ æ ¡éªŒæ•°æ®å®Œæ•´æ€§ åŠ å¯†ã€å‹ç¼© é€‚ç”¨äºå•æœº \u0026amp; é›†ç¾¤ï¼ˆPatroni/PGPool/HAï¼‰ ğŸ”§ pgBackRest å®‰è£…ï¼ˆDebian 12 + PostgreSQL 17 ç¤ºä¾‹ï¼‰ sudo apt install -y pgbackrest å®‰è£…åç›®å½•ï¼š\né…ç½®æ–‡ä»¶ï¼š/etc/pgbackrest.conf æ—¥å¿—ï¼š/var/log/pgbackrest/ å‘½ä»¤ï¼špgbackrest ğŸ“ æœ€å°å¯è¿è¡Œé…ç½®ï¼ˆæœ¬åœ°å¤‡ä»½ç‰ˆæœ¬ï¼‰ /etc/pgbackrest.confï¼š\né»˜è®¤é…ç½®ï¼š\n[global] repo1-path=/var/lib/pgbackrest #repo1-retention-full=2 #repo1-cipher-pass=... #repo1-cipher-type=aes-256-cbc #[main] #pg1-path=/var/lib/postgresql/13/main ä¿®æ”¹é…ç½®ï¼š\nsudo tee /etc/pgbackrest.conf \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; [global] repo1-path=/var/lib/pgbackrest repo1-retention-full=5 start-fast=y [main] pg1-path=/var/lib/postgresql/data EOF åˆ›å»ºå¤‡ä»½ç›®å½•ï¼š\nsudo mkdir -p /var/lib/pgbackrest sudo chown -R postgres:postgres /var/lib/pgbackrest ğŸŸ¦ ç«‹å³è¿›è¡Œç¬¬ä¸€æ¬¡å…¨é‡å¤‡ä»½ # æœ¬åœ°è¿è¡Œ sudo -u postgres pgbackrest --stanza=main --type=full backup # å®¹å™¨è¿è¡Œ sudo podman exec -it postgres bash su - postgres -c \u0026#39;pgbackrest --stanza=main --type=full backup\u0026#39; æ£€æŸ¥çŠ¶æ€ï¼š\n# æœ¬åœ°è¿è¡Œ sudo -u postgres pgbackrest --stanza=main info # å®¹å™¨è¿è¡Œ sudo podman exec -it postgres bash su - postgres -c \u0026#39;pgbackrest --stanza=main info\u0026#39; \u0026lt;\u0026lt;COMMENT stanza: main status: ok cipher: none db (current) wal archive min/max (17): 000000010000000D0000001E/000000010000000D00000023 full backup: 20251210-190712F timestamp start/stop: 2025-12-10 11:07:12+00 / 2025-12-10 11:11:18+00 wal start/stop: 000000010000000D00000023 / 000000010000000D00000023 database size: 2.9GB, database backup size: 2.9GB repo1: backup set size: 645.5MB, backup size: 645.5MB COMMENT è¾“å‡ºä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼š\nå…¨é‡å¤‡ä»½æ—¶é—´ WAL ä¿¡æ¯ å­˜å‚¨å ç”¨ ğŸŸ§ å¢é‡å¤‡ä»½ # æœ¬åœ°è¿è¡Œ sudo -u postgres pgbackrest --stanza=main --type=incr backup # å®¹å™¨è¿è¡Œ sudo podman exec -it postgres bash su - postgres -c \u0026#39;pgbackrest --stanza=main --type=incr backup\u0026#39; ğŸŸ§ å·®å¼‚å¤‡ä»½ # æœ¬åœ°è¿è¡Œ sudo -u postgres pgbackrest --stanza=main --type=diff backup # å®¹å™¨è¿è¡Œ sudo podman exec -it postgres bash su - postgres -c \u0026#39;pgbackrest --stanza=main --type=diff backup\u0026#39; ğŸŸ¨ å¯ç”¨ WAL å½’æ¡£ï¼ˆå¿…é¡»ï¼‰ åœ¨ postgresql.conf ä¸­ï¼š\narchive_mode = on archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; é‡å¯ PostgreSQLã€‚\néªŒè¯ï¼š\nsudo -u postgres pgbackrest --stanza=main check â™» å¤‡ä»½ä¿ç•™ç­–ç•¥ï¼ˆRetention Policyï¼‰ repo1-retention-full=5 repo1-retention-diff=10 repo1-retention-archive=7 pgBackRest ä¼šè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ã€‚\nğŸ›  æ¢å¤ PostgreSQLï¼ˆæœ€å…³é”®éƒ¨åˆ†ï¼‰ åœæ­¢ PostgreSQL\nsudo systemctl stop postgresql æ¸…ç©ºæ•°æ®åº“ç›®å½•\nsudo rm -rf /var/lib/postgresql/17/main/* æ¢å¤\nsudo -u postgres pgbackrest --stanza=main restore å¯åŠ¨ PostgreSQL\nsudo systemctl start postgresql ğŸ”„ PITRï¼ˆæŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼‰ ä¾‹å¦‚æ¢å¤åˆ° 2025-01-01 10:20:00ï¼š\nsudo -u postgres pgbackrest --stanza=main \\ --type=time \\ --target=\u0026#34;2025-01-01 10:20:00\u0026#34; \\ --target-action=promote \\ restore â˜ äº‘å¯¹è±¡å­˜å‚¨ï¼ˆS3 / MinIOï¼‰ é…ç½®ï¼š\n[global] repo1-type=s3 repo1-path=/pgbackrest repo1-s3-bucket=pgbackup repo1-s3-endpoint=minio.example.com repo1-s3-key=admin repo1-s3-key-secret=12345678 repo1-s3-verify-ssl=n ğŸ— ä¸ Patroni é›†ç¾¤é…åˆï¼ˆç”Ÿäº§å¸¸ç”¨ï¼‰ ç”± Patroni ç®¡ç† PostgreSQL pgBackRest ç®¡ç†å¤‡ä»½ä¸ WAL ä½¿ç”¨ S3/MiniO å‚¨å­˜å¤‡ä»½ èƒ½å¤Ÿåœ¨èŠ‚ç‚¹æŸåæ—¶è‡ªåŠ¨ä»å¤‡ä»½æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ æ­¤æ¶æ„æ˜¯ç›®å‰æœ€æ¨èçš„é«˜å¯ç”¨ + é«˜å¯é å¤‡ä»½æ–¹æ¡ˆã€‚\nğŸ“Š å‘½ä»¤æ€»ç»“ï¼ˆæœ€å¸¸ç”¨ï¼‰ æ“ä½œ å‘½ä»¤ åˆ›å»ºå…¨é‡å¤‡ä»½ pgbackrest \u0026ndash;stanza=main \u0026ndash;type=full backup å¢é‡å¤‡ä»½ pgbackrest \u0026ndash;type=incr backup å·®å¼‚å¤‡ä»½ pgbackrest \u0026ndash;type=diff backup æŸ¥çœ‹å¤‡ä»½ pgbackrest info æ¢å¤ pgbackrest restore WAL æ¨é€ pgbackrest archive-push WAL è·å– pgbackrest archive-get æ ¡éªŒé…ç½® pgbackrest check ğŸ”¥ ä»€ä¹ˆæ—¶å€™ä½ å¿…é¡»ä½¿ç”¨ pgBackRestï¼Ÿ ä½ çš„æ•°æ®åº“å¤§äº 50GB ä½ éœ€è¦ è‡ªåŠ¨å¢é‡å¤‡ä»½ ä½ éœ€è¦ PITRï¼ˆæŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼‰ ä½ éœ€è¦ S3 è¿œç¨‹å¤‡ä»½ ä½ éœ€è¦ ä¼ä¸šçº§å¤‡ä»½ ä½ æƒ³é¿å… WAL æ’‘çˆ†ç£ç›˜ ä½ æœ‰å¤šèŠ‚ç‚¹ï¼ˆPatroni, Repmgrï¼‰ su - postgres -c \u0026#39;pgbackrest --stanza=main --type=full backup\u0026#39; \u0026lt;\u0026lt; COMMENT 2025-12-10 10:54:37.052 P00 ERROR: [055]: unable to load info file \u0026#39;/var/lib/pgbackrest/backup/main/backup.info\u0026#39; or \u0026#39;/var/lib/pgbackrest/backup/main/backup.info.copy\u0026#39;: FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/backup/main/backup.info\u0026#39; for read FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/backup/main/backup.info.copy\u0026#39; for read HINT: backup.info cannot be opened and is required to perform a backup. HINT: has a stanza-create been performed? COMMENT ä¸‹é¢æˆ‘ç»™ä½ è§£é‡Šè¿™ä¸ªæŠ¥é”™çš„çœŸæ­£åŸå› ã€ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿã€å¦‚ä½•ä¿®å¤ã€ä»¥åŠå¦‚ä½•é¿å…å†æ¬¡å‡ºç°ã€‚å†…å®¹éå¸¸å®ç”¨ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒç›´æ¥ç”¨ã€‚\nâœ… pgBackRest æŠ¥é”™è§£æ ERROR: [055]: unable to load info file \u0026#39;/var/lib/pgbackrest/backup/main/backup.info\u0026#39; HINT: backup.info cannot be opened and is required to perform a backup. HINT: has a stanza-create been performed? ğŸ” é—®é¢˜æœ¬è´¨ï¼šbackup.info æ–‡ä»¶ä¸å­˜åœ¨ pgBackRest å¿…é¡»ä¾èµ–æ¯ä¸ª stanza çš„ backup.info æ–‡ä»¶ï¼Œå®ƒåŒ…å«ï¼š\nPostgreSQL çš„ç‰ˆæœ¬ ç³»ç»Ÿæ ‡è¯†ç¬¦ (system-id) å¤‡ä»½å†å² WAL å½’æ¡£ä¿¡æ¯ å¦‚æœ backup.info ä¸å­˜åœ¨ï¼ŒpgBackRest æ— æ³•åˆ¤æ–­å½“å‰é›†ç°‡æ˜¯å¦æ­£ç¡®ã€æ˜¯å¦èƒ½ç»§ç»­å¤‡ä»½ã€‚\nä¸ºä»€ä¹ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼Ÿ å¯èƒ½åŸå› å¦‚ä¸‹ï¼š\n1ï¼‰ä½ è¿˜æ²¡æœ‰åˆ›å»ºè¿™ä¸ª stanzaï¼ˆæœ€å¸¸è§ï¼‰ å³ï¼š\npgbackrest --stanza=main stanza-create è¿˜æ²¡æ‰§è¡Œè¿‡ã€‚\n2ï¼‰ä¹‹å‰åˆ›å»ºè¿‡ï¼Œä½† /var/lib/pgbackrest ç›®å½•è¢«æ¸…ç†æˆ–æƒé™ä¸å¯¹ ä¾‹å¦‚ï¼š\nåˆ é™¤äº† pgBackRest çš„æ•°æ®ç›®å½• ä½¿ç”¨ Docker/K8S æ—¶æ²¡æœ‰æŒä¹…åŒ– volume æ›´æ¢æœåŠ¡å™¨åå¿˜è®°è¿ç§»è¯¥ç›®å½• ç”¨æˆ·æƒé™é”™è¯¯ï¼ˆæ¯”å¦‚ root åˆ›å»ºï¼Œpostgres è¿è¡Œï¼‰ 3ï¼‰ä½ æ”¹åŠ¨è¿‡ pgBackRest é…ç½®æ–‡ä»¶ï¼Œå¯¼è‡´ç›®å½•è·¯å¾„å˜æ›´ ğŸ› ï¸ è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰æ­¥éª¤èµ°ï¼Œå¿…æˆåŠŸï¼‰ ç¬¬ä¸€æ­¥ï¼šç¡®è®¤ç›®å½•æ˜¯å¦å­˜åœ¨ ls -l /var/lib/pgbackrest/backup/main/ å¦‚æœç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ -\u0026gt; å¿…å®šç¼ºå¤± backup.info\nç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æƒé™ pgBackRest å¿…é¡»ä»¥ postgres ç”¨æˆ·è¿è¡Œï¼š\nchown -R postgres:postgres /var/lib/pgbackrest chmod -R 750 /var/lib/pgbackrest ç¬¬ä¸‰æ­¥ï¼šé‡æ–°åˆ›å»º stanza å¿…é¡»åœ¨ PostgreSQL æ­£å¸¸è¿è¡Œæƒ…å†µä¸‹æ‰§è¡Œï¼š\npgbackrest --stanza=main stanza-create å¦‚æœæˆåŠŸï¼Œä½ ä¼šçœ‹åˆ°ï¼š\nstanza-create command end: completed successfully ç›®å½•ä¸­ä¼šç”Ÿæˆï¼š\nbackup.info backup.info.copy ğŸ§ª ç¬¬å››æ­¥ï¼šæµ‹è¯•å½’æ¡£ # ç¡®ä¿ postgresql.conf æ–‡ä»¶æœ‰ä»¥ä¸‹é…ç½® # archive_mode = on # archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; pgbackrest --stanza=main check å¦‚æœæ­£å¸¸ï¼Œä¼šæ˜¾ç¤ºï¼š\ncheck command end: completed successfully ğŸ” å¦‚æœä½ åŸæ¥æœ‰æ—§å¤‡ä»½æƒ³æ¢å¤æ€ä¹ˆåŠï¼Ÿ å¦‚æœä½ è¯¯åˆ äº† backup.infoï¼Œä½† /var/lib/pgbackrest/backup/main ä¸‹ä»æœ‰å¤‡ä»½å†…å®¹ï¼Œå¯ç”¨ä»¥ä¸‹æ–¹å¼æ¢å¤ï¼š\nä»æ—§å¤‡ä»½ç›®å½•é‡å»º backup.info\npgbackrest --stanza=main info å®ƒä¼šè‡ªåŠ¨ä»å¤‡ä»½ç»“æ„é‡å»º backup.infoã€‚\nå¦‚æœè¿˜åŸå¤±è´¥ï¼Œä½ å¯ä»¥æ‰‹åŠ¨ï¼š\npgbackrest --stanza=main --force stanza-create âš ï¸ åªæœ‰å½“ä½ ç¡®å®šå¤‡ä»½ä¸€è‡´æ€§æŸåæˆ–ä¸éœ€è¦æ—¶æ‰ä½¿ç”¨ â€“force\nğŸš« æœ€å±é™©çš„è¡Œä¸ºï¼ˆè¯·é¿å…ï¼‰ ä»¥ä¸‹ä¼šå¯¼è‡´ä½ å†ä¹Ÿæ¢å¤ä¸äº†åŸæ¥çš„å¤‡ä»½ï¼š\nâŒ åˆ é™¤ /var/lib/pgbackrest/backup/main/backup.info âŒ ä¿®æ”¹ PostgreSQL çš„ system-idï¼ˆé‡å»ºé›†ç°‡ï¼‰ âŒ pgBackRest æœåŠ¡ä½¿ç”¨ root è€Œä¸æ˜¯ postgres âŒ Docker/K8S æ²¡æœ‰æŒä¹…åŒ– /var/lib/pgbackrest ğŸ¯ æœ€ä½³å®è·µï¼ˆç”Ÿäº§ç¯å¢ƒå¿…åšï¼‰ 1ï¼‰ç¡®ä¿ pgBackRest æ•°æ®ç›®å½•æŒä¹…åŒ–ï¼ˆå°¤å…¶æ˜¯å®¹å™¨ç¯å¢ƒï¼‰ /var/lib/pgbackrest /var/log/pgbackrest å¿…é¡»ä½¿ç”¨æŒä¹…å·ï¼Œå¦åˆ™å®¹å™¨é‡å¯å backup.info ä¼šæ¶ˆå¤±ã€‚\n2ï¼‰å®šæœŸéªŒè¯ stanza pgbackrest --stanza=main check 3ï¼‰ä¿æŒ WAL å½’æ¡£æ­£å¸¸ PostgreSQL é…ç½®å¿…é¡»åŒ…æ‹¬ï¼š\narchive_mode = on archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; 4ï¼‰ä¸è¦éšæ„é‡å»º PostgreSQL é›†ç°‡ å¦åˆ™ system-id ä¼šå˜ï¼ŒpgBackRest æ— æ³•è¯†åˆ«åŸæ¥çš„å¤‡ä»½ã€‚\n","description":"å®˜æ–¹æ–‡æ¡£ï¼š\npgBackRest: https://pgbackrest.org/ GitHub: https://github.com/pgbackrest/pgbackrest.git ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å®æˆ˜åŒ–çš„ pgBackRest çŸ¥è¯†ä½“ç³»ï¼Œä¸€æ¬¡æ€§æŠŠæ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ã€é…ç½®ã€å¤‡ä»½ç­–ç•¥ã€æ¢å¤æµç¨‹ã€æœ€ä½³å®è·µå…¨éƒ¨è®²æ¸…æ¥šï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨ã€‚\npgBackRest â€” PostgreSQL ä¼ä¸šçº§å¤‡ä»½æ¢å¤å·¥å…· pgBackRest æ˜¯ PostgreSQL æœ€å¼º çš„å¤‡ä»½ä¸æ¢å¤å·¥å…·ä¹‹ä¸€ï¼Œæ›¿ä»£ pg_basebackupã€æŠ€æœ¯æˆç†Ÿã€ä¼ä¸šå¤§é‡ä½¿ç”¨ï¼Œæ”¯æŒå…¨é‡/å·®é‡/å¢é‡å¤‡ä»½ã€é«˜æ•ˆå‹ç¼©ã€WAL å½’æ¡£ã€PITR æ¢å¤ã€å¯¹è±¡å­˜å‚¨ç­‰åŠŸèƒ½ã€‚\nå…¶æ ¸å¿ƒç›®æ ‡ï¼š\nå¯é ï¼ˆReliableï¼‰ é«˜æ€§èƒ½ï¼ˆPerformanceï¼‰ æ˜“ç®¡ç†ï¼ˆManageableï¼‰ ä¸€ã€pgBackRest æ ¸å¿ƒç‰¹æ€§ 1. å…¨é‡ / å·®é‡ / å¢é‡å¤‡ä»½ fullï¼šå…¨é‡å¤‡ä»½ï¼Œå®Œæ•´æ•°æ®ç›®å½• diffï¼šå·®é‡å¤‡ä»½ï¼ŒåŸºäºä¸Šæ¬¡ full å¤‡ä»½åçš„æ‰€æœ‰å˜åŒ– incrï¼šå¢é‡å¤‡ä»½ï¼ŒåŸºäºæœ€è¿‘ä¸€æ¬¡ full æˆ– diff å¤‡ä»½åçš„å˜åŒ– 2. æ”¯æŒæœ¬åœ°ã€è¿œç¨‹ã€å¯¹è±¡å­˜å‚¨ Local FS Remote Hostï¼ˆsshï¼‰ S3 / MinIO / aliyun OSS / Google / Azure 3. WAL å­˜æ¡£ä¸å®Œæ•´æ€§æ£€æŸ¥ è‡ªåŠ¨ push/pull WALï¼ˆæ›¿ä»£ archive_commandï¼‰ ä¿éšœå¯æ¢å¤æ€§ï¼ˆWAL å®Œæ•´æ€§æ£€æŸ¥ï¼‰ 4. æ”¯æŒ å‹ç¼©ã€å¤šçº¿ç¨‹ã€å¹¶è¡Œä¼ è¾“ èŠ‚çœå­˜å‚¨ é«˜é€Ÿå¤‡ä»½è¿˜åŸ 5. æ”¯æŒ PITRï¼ˆPoint In Time Recoveryï¼‰ ç²¾ç¡®æ¢å¤åˆ°ä»»æ„æ—¶åˆ» 6. å¼ºå¤§çš„é…ç½®ä½“ç³» æ”¯æŒå¤šä¸ª stanza åŒæ—¶ç®¡ç†å¤šä¸ª PostgreSQL å®ä¾‹ äºŒã€pgBackRest æ¶æ„ä¸æœ¯è¯­ stanza pgBackRest çš„â€œå¤‡ä»½é›†â€ã€é€»è¾‘å•ä½ï¼Œç±»ä¼¼ï¼š\n"},{"id":70,"href":"/operations/podman/core/","title":"Podman æ ¸å¿ƒæ¦‚å¿µ","parent":"Podman","content":" ä¸€ã€Podman æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ Podman = ä¸€ä¸ªç¬¦åˆ OCI æ ‡å‡†çš„å®¹å™¨ç®¡ç† CLI å·¥å…·\nå®ƒåšçš„äº‹æƒ…æœ¬è´¨åªæœ‰ä¸‰ç±»ï¼š\né•œåƒç®¡ç†ï¼ˆpull / push / buildï¼‰ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆcreate / start / stop / rmï¼‰ Pod ç®¡ç†ï¼ˆä¸€ç»„å…±äº« namespace çš„å®¹å™¨ï¼‰ ğŸ‘‰ Podman ä¸æ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒåªæ˜¯è°ƒåº¦è€…ã€‚\näºŒã€Podman æ¶æ„ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ Podman æœ¬èº«ä¸è¿è¡Œå®¹å™¨ Podman è°ƒç”¨çš„æ˜¯ä¸€æ•´å¥— OCI ç»„ä»¶é“¾ï¼š\npodman â”œâ”€ containers/image â† é•œåƒæ‹‰å– / registry / auth â”œâ”€ containers/storage â† æœ¬åœ°é•œåƒ/å®¹å™¨å­˜å‚¨ â”œâ”€ conmon â† å®¹å™¨ç›‘æ§ â”œâ”€ OCI runtime â† runc / crun â””â”€ Linux kernel â† namespaces / cgroups / selinux ğŸ“Œ å…³é”®ç»“è®º\nPodman â‰  Docker daemon Podman = CLI + OCI ç”Ÿæ€æ•´åˆå™¨ ä¸‰ã€Podman ä¸ Docker çš„æ ¹æœ¬åŒºåˆ« å¯¹æ¯”ç‚¹ Podman Docker å®ˆæŠ¤è¿›ç¨‹ âŒ æ—  daemon âœ… dockerd æƒé™æ¨¡å‹ root / rootless ä»¥ root ä¸ºä¸» å®‰å…¨æ¨¡å‹ æ›´ä¸¥æ ¼ è¾ƒå®½æ¾ Pod æ¦‚å¿µ åŸç”Ÿæ”¯æŒ ä¸æ”¯æŒ systemd é›†æˆ åŸç”Ÿ è¾ƒå¼± å®¹å™¨æ ‡å‡† OCI OCI ğŸ‘‰ Podman å¤©ç”Ÿä¸º server / å®‰å…¨åœºæ™¯è®¾è®¡\nå››ã€Rootless Podmanï¼ˆä½ è¸©å‘æœ€å¤šçš„åœ°æ–¹ï¼‰ 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ rootless rootless = ä¸ç”¨ root æƒé™è¿è¡Œå®¹å™¨\nå®ç°ä¾èµ–ï¼š\nuser namespace subuid / subgid fuse-overlayfs slirp4netns å®¹å™¨å†… UID 0 â†“ æ˜ å°„ å®¿ä¸»æœº UID 100000+ 2ï¸âƒ£ subuid / subgidï¼ˆä½ åˆšé‡åˆ°çš„é—®é¢˜ï¼‰ ä½œç”¨ï¼šç»™æ™®é€šç”¨æˆ·ä¸€æ®µ â€œå¯è™šæ‹Ÿä½¿ç”¨çš„ UID/GID èŒƒå›´â€\n/etc/subuid admin:100000:65536 è¡¨ç¤ºï¼š\nå®¹å™¨ UID å®¿ä¸» UID 0 100000 1 100001 â€¦ â€¦ å¦‚æœæ²¡æœ‰å®ƒï¼Œå°±ä¼šå‡ºç°ï¼š\npotentially insufficient UIDs or GIDs lchown: invalid argument ğŸ“Œ ç»“è®º\nrootless Podman â‰ˆ æ²¡æœ‰ subuid = å¿…æ­»\näº”ã€é•œåƒï¼ˆImageï¼‰åº•å±‚åŸç† 1ï¸âƒ£ é•œåƒä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ é•œåƒæ˜¯ å¤šå±‚ï¼ˆLayerï¼‰å åŠ ï¼š\nImage â”œâ”€ Layer 1 (base) â”œâ”€ Layer 2 â”œâ”€ Layer 3 â””â”€ config.json æ¯ä¸€å±‚æ˜¯ä¸€ä¸ª tar.gz blob\n2ï¸âƒ£ Manifest / Manifest List ä½ é‡åˆ°çš„é”™è¯¯é‡Œå¤šæ¬¡å‡ºç°ï¼š\nmanifest list å«ä¹‰\nç±»å‹ è¯´æ˜ manifest å•æ¶æ„é•œåƒ manifest list å¤šæ¶æ„é•œåƒï¼ˆamd64 / arm64ï¼‰ Podman pull æ—¶æµç¨‹ï¼š\nmanifest list â†“ é€‰æ‹©å¹³å° manifest â†“ æ‹‰å– blobs layers unpack å…­ã€ä¸ºä»€ä¹ˆä¼šå‡ºç° â€œwriting blob / unpacking failedâ€ é”™è¯¯ï¼š\nwriting blob unpacking failed requested 0:50 æœ¬è´¨åŸå› \né•œåƒ layer ä¸­æœ‰æ–‡ä»¶ï¼š\n/var/local uid=0 gid=50 rootless ç”¨æˆ· æ²¡æœ‰ gid=50 çš„æ˜ å°„\nkernel æ‹’ç» lchown\nğŸ“Œ ä¸æ˜¯ç½‘ç»œé—®é¢˜ ğŸ“Œ ä¸æ˜¯ registry é—®é¢˜ ğŸ“Œ æ˜¯ user namespace æ˜ å°„é—®é¢˜ ä¸ƒã€Registry / ä»“åº“æ¨¡å‹ 1ï¸âƒ£ Podman é»˜è®¤ç­–ç•¥ï¼ˆéå¸¸ä¸¥æ ¼ï¼‰ è¡Œä¸º é»˜è®¤ HTTPS âœ… å¿…é¡» HTTP âŒ ç¦æ­¢ è‡ªç­¾è¯ä¹¦ âŒ åŒ¿åè®¿é—® çœ‹ registry 2ï¸âƒ£ registries.confï¼ˆæ ¸å¿ƒé…ç½®ï¼‰ è¿™æ˜¯ Podman å”¯ä¸€è®¤å¯çš„æ–¹å¼ï¼š\n[[registry]] location = \u0026#34;my-registry.local:5000\u0026#34; insecure = true ğŸ“Œ Podman ä¸æ”¯æŒï¼š\npodman pull --insecure å…«ã€è®¤è¯æ¨¡å‹ï¼ˆauthentication requiredï¼‰ Podman ä½¿ç”¨ï¼š\n~/.config/containers/auth.json ä¸ Docker çš„ ~/.docker/config.json å®Œå…¨å…¼å®¹\npodman login my-registry.local:5000 ä¹ã€ä»£ç†æ¨¡å‹ï¼ˆHTTP_PROXYï¼‰ Podman ä¸ç†è§£ SOCKS\nâœ… æ”¯æŒï¼š\nHTTP_PROXY HTTPS_PROXY âŒ ä¸æ”¯æŒï¼š\nsocks5:// æ­£ç¡®æ–¹å¼ï¼š\nHTTP_PROXY=http://127.0.0.1:1087 \\ podman pull ... åã€Podï¼ˆPodman çš„çµé­‚ï¼‰ Pod çš„å®šä¹‰\nPod = å…±äº« namespace çš„ä¸€ç»„å®¹å™¨\nå…±äº«ï¼š\nnetwork ipc uts Pod â”œâ”€ container A â”œâ”€ container B â””â”€ pause containerï¼ˆéšå¼ï¼‰ ğŸ“Œ å’Œ Kubernetes Pod æ¦‚å¿µ 100% å¯¹é½\nåä¸€ã€systemd é›†æˆï¼ˆPodman çš„æ€æ‰‹é”ï¼‰ Podman å¯ä»¥ç›´æ¥ç”Ÿæˆ systemd å•å…ƒï¼š\npodman generate systemd --new --name mycontainer ç»“æœæ˜¯ï¼š\næ—  daemon å®¹å™¨ = systemd service å¼€æœºè‡ªå¯ ğŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Podman ç‰¹åˆ«é€‚åˆæœåŠ¡å™¨\nåäºŒã€æ€»ç»“ Podman æ˜¯ä¸€ä¸ªâ€œå®‰å…¨ä¼˜å…ˆ + å¼ºçº¦æŸ + åç”Ÿäº§ç¯å¢ƒâ€çš„å®¹å™¨å·¥å…·\nDockerï¼šå¼€å‘å‹å¥½ Podmanï¼šè¿ç»´å‹å¥½ å‰é¢é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼š\nsubuid HTTP registry manifest authentication proxy å…¨éƒ¨éƒ½æ˜¯ Podmanâ€œé»˜è®¤å®‰å…¨ç­–ç•¥â€åœ¨ç”Ÿæ•ˆ\n","description":" ä¸€ã€Podman æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ Podman = ä¸€ä¸ªç¬¦åˆ OCI æ ‡å‡†çš„å®¹å™¨ç®¡ç† CLI å·¥å…·\nå®ƒåšçš„äº‹æƒ…æœ¬è´¨åªæœ‰ä¸‰ç±»ï¼š\né•œåƒç®¡ç†ï¼ˆpull / push / buildï¼‰ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆcreate / start / stop / rmï¼‰ Pod ç®¡ç†ï¼ˆä¸€ç»„å…±äº« namespace çš„å®¹å™¨ï¼‰ ğŸ‘‰ Podman ä¸æ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œå®ƒåªæ˜¯è°ƒåº¦è€…ã€‚\näºŒã€Podman æ¶æ„ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ Podman æœ¬èº«ä¸è¿è¡Œå®¹å™¨ Podman è°ƒç”¨çš„æ˜¯ä¸€æ•´å¥— OCI ç»„ä»¶é“¾ï¼š\n"},{"id":71,"href":"/database/postgres/tutorial/","title":"PostgreSQL åŸºç¡€æ•™ç¨‹","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ â€œPostgreSQL è¯¦ç»†ä»‹ç»ï¼ˆè¶…å®Œæ•´ã€å®æˆ˜å‹å¥½ã€æ¶æ„çº§åˆ«ï¼‰â€ï¼Œè¦†ç›–ï¼š\nPostgreSQL æ˜¯ä»€ä¹ˆ æ¶æ„ä¸åº•å±‚åŸç† å­˜å‚¨æ¨¡å‹ äº‹åŠ¡æ¨¡å‹ï¼ˆMVCCï¼‰ é”æœºåˆ¶ æŸ¥è¯¢æ‰§è¡Œæµç¨‹ ç´¢å¼•ç±»å‹ åˆ†åŒºä¸æ‰©å±•æ€§ å¹¶è¡ŒæŸ¥è¯¢ é«˜å¯ç”¨ä¸é›†ç¾¤ å®é™…ä½¿ç”¨åœºæ™¯ æœ€ä½³å®è·µ ä¸ MySQLã€Oracle çš„å¯¹æ¯” 1. PostgreSQL æ˜¯ä»€ä¹ˆï¼Ÿ PostgreSQLï¼ˆç®€ç§° Postgresï¼‰æ˜¯å½“å‰ æœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ä¹‹ä¸€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€åƒ Oracle çš„æ•°æ®åº“ï¼Œè¢«ç§°ä¸ºï¼š\næœ€å¼ºå¼€æºæ•°æ®åº“ ä¸–ç•Œä¸ŠåŠŸèƒ½æœ€å®Œæ•´çš„å…³ç³»æ•°æ®åº“ ç‰¹ç‚¹ï¼š\nçœŸæ­£çš„ ä¼ä¸šçº§ æ•°æ®åº“ æ”¯æŒ SQL + JSON æ··åˆæ¨¡å‹ å®Œæ•´çš„äº‹åŠ¡ã€é”ã€MVCC ä¸°å¯Œç´¢å¼•ç±»å‹ï¼ˆè¿œè¶… MySQLï¼‰ å¯æ‰©å±•ï¼ˆæ’ä»¶åŒ–ã€æ‰©å±•ã€å‡½æ•°ï¼‰ é«˜æ°´å¹³æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ˆæ¯” MySQL å¼ºå¾ˆå¤šï¼‰ å¯ä½œä¸º OLTP + OLAP æ··åˆåœºæ™¯ é€‰æ‹© PostgreSQL 17 æ›´å¿«ï¼Œæ›´å¼ºï¼Œæ›´ç°ä»£ 2. PostgreSQL ä½“ç³»ç»“æ„ï¼ˆArchitectureï¼‰ æ ¸å¿ƒç»„ä»¶ï¼š\nClient | | SQL / Protocol | PostgreSQL Server (postgres) | +-- Parserï¼ˆè¯­æ³•è§£æï¼‰ +-- Planner / Optimizerï¼ˆä¼˜åŒ–å™¨ï¼‰ +-- Executorï¼ˆæ‰§è¡Œå™¨ï¼‰ +-- Storage Managerï¼ˆå­˜å‚¨å¼•æ“ï¼‰ +-- WALï¼ˆWrite-Ahead Logï¼‰ +-- Background Workersï¼ˆåå°è¿›ç¨‹ï¼‰ - checkpointer - writer - wal writer - autovacuum launcher - logical replication worker - bgworker æ‰©å±• PostgreSQL æ˜¯ å•è¿›ç¨‹å¤šå­è¿›ç¨‹æ¨¡å‹ï¼ˆä¸åƒ MySQLï¼Œæ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹ï¼‰ã€‚\nä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå¯¹åº” ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ã€‚\n3. PostgreSQL å­˜å‚¨æ¨¡å‹ ä¸»è¦æ–‡ä»¶ï¼š\næ–‡ä»¶ æ„ä¹‰ data/base/xxx/yyy è¡¨çš„æ•°æ®æ–‡ä»¶ï¼ˆå †è¡¨ Heapï¼‰ pg_wal/ å†™å‰æ—¥å¿—ï¼ˆä¿è¯æŒä¹…åŒ–ï¼‰ pg_xact äº‹åŠ¡æäº¤ä¿¡æ¯ï¼ˆTransaction Statusï¼‰ pg_multixact å¤šäº‹åŠ¡é”ä¿¡æ¯ pg_statistic ç»Ÿè®¡ä¿¡æ¯ å…³é”®æœºåˆ¶ï¼šTOASTï¼ˆThe Oversized-Attribute Storage Techniqueï¼‰\nç”¨äºå­˜å‚¨å¤§æ–‡æœ¬ã€å¤§ JSONã€å¤§å¯¹è±¡ï¼Œå¤§äº 2KB æ—¶è‡ªåŠ¨æ‹†åˆ†ã€‚\n4. PostgreSQL çš„ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ PostgreSQL é‡‡ç”¨ MVCC + æ— é”è¯»ï¼ˆread without lockï¼‰ æœºåˆ¶ã€‚\næ ¸å¿ƒæ€æƒ³ï¼š\næ¯è¡Œæ•°æ®åŒ…å«ä¸¤ä¸ªéšè—å­—æ®µï¼š xminï¼ˆåˆ›å»ºäº‹åŠ¡ IDï¼‰ xmaxï¼ˆåˆ é™¤äº‹åŠ¡ IDï¼‰ ä¸æ›´æ–°è¡Œï¼Œè€Œæ˜¯åˆ›å»ºæ–°ç‰ˆæœ¬è¡Œ -\u0026gt; å¤šç‰ˆæœ¬ æŸ¥è¯¢ä¼šæ ¹æ®äº‹åŠ¡å¿«ç…§é€‰æ‹©å¯è§ç‰ˆæœ¬ ä¸éœ€è¦åŠ è¯»é” -\u0026gt; å¹¶å‘æ€§èƒ½æé«˜ PostgreSQL MVCC çš„ä¼˜ç‚¹ï¼š\næŸ¥è¯¢ä¸ä¼šé˜»å¡å†™ å†™ä¸ä¼šé˜»å¡è¯»ï¼ˆé™¤éå†²çªè¡Œé”ï¼‰ é«˜å¹¶å‘ä¸‹æ€§èƒ½ç¨³å®š ç¼ºç‚¹ï¼š\nä¼šäº§ç”Ÿå¤§é‡â€œæ­»è¡Œâ€ -\u0026gt; ä¾èµ– VACUUM æ¸…ç† 5. VACUUM ä¸è‡ªåŠ¨æ¸…ç† VACUUM ç”¨äºï¼š\nå›æ”¶æ­»è¡Œç©ºé—´ é˜²æ­¢äº‹åŠ¡ ID wraparound æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆANALYZEï¼‰ PostgreSQL æœ‰ autovacuumï¼Œæ— éœ€äººå·¥ç»´æŠ¤ã€‚\n6. PostgreSQL é”æœºåˆ¶ï¼ˆLockingï¼‰ é”ç±»å‹ä¸°å¯Œï¼Œæ˜¯ä¼ä¸šçº§æ•°æ®åº“æ ¸å¿ƒèƒ½åŠ›ï¼š\né”ç±»å‹ ç”¨é€” Row lockï¼ˆè¡Œé”ï¼‰ UPDATEã€DELETE Table lockï¼ˆè¡¨é”ï¼‰ DDLã€VACUUM Advisory lockï¼ˆå’¨è¯¢é”ï¼‰ åº”ç”¨å±‚åˆ†å¸ƒå¼é” LWLock å†…éƒ¨è½»é‡é” SpinLock å†…éƒ¨è‡ªæ—‹é” Predicate Lock Serializable éš”ç¦»æ€§ PostgreSQL è¡Œé”ä¹‹é—´å…¼å®¹åº¦æ›´é«˜ï¼Œæ­»é”æ›´å°‘ã€‚\n7. PostgreSQL ç´¢å¼•ç±»å‹ï¼ˆéå¸¸å¼ºï¼‰ PostgreSQL çš„ç´¢å¼•æ¯” MySQL å¼ºå¤ªå¤šï¼š\nç±»å‹ åœºæ™¯ B-tree ä¸»é”®ã€æ™®é€šç´¢å¼• Hash ç­‰å€¼åŒ¹é…ï¼ˆå¾ˆå°‘ç”¨ï¼‰ GIN JSONã€æ•°ç»„ã€å…¨æ–‡æœç´¢ GiST åœ°ç†ä½ç½®ã€æ¨¡ç³ŠåŒ¹é… BRIN æµ·é‡é¡ºåºæ•°æ®ï¼ˆæ—¶åºï¼‰ SP-GiST æ ‘ã€å›¾ã€ç©ºé—´ç»“æ„ å°¤å…¶ GIN/GiST/BRIN æ˜¯ PostgreSQL ç‹¬æœ‰çš„ä¼˜åŠ¿ã€‚\n8. PostgreSQL æŸ¥è¯¢æµç¨‹ SQL â†“ Parserï¼ˆè¯æ³•è¯­æ³•åˆ†æï¼‰ â†“ Rewriterï¼ˆè§„åˆ™é‡å†™ï¼‰ â†“ Planner / Optimizerï¼ˆç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼‰ â†“ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰ â†“ è¿”å›ç»“æœ ä¼˜åŒ–å™¨æ¯” MySQL æ›´å¼ºï¼Œæ”¯æŒï¼š\nHash Join Merge Join Nested Loop Join å¹¶è¡ŒæŸ¥è¯¢ Bitmap Scan ä¸Šç™¾ç§æˆæœ¬ä¼°è®¡ç­–ç•¥ 9. PostgreSQL åˆ†åŒºè¡¨ï¼ˆPartitioningï¼‰ æ”¯æŒä¸‰ç§ï¼š\nRANGEï¼ˆæŒ‰èŒƒå›´ï¼Œä¾‹å¦‚ dateï¼‰ LISTï¼ˆæŒ‰æšä¸¾ï¼Œä¾‹å¦‚ provinceï¼‰ HASHï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰ ç‰¹ç‚¹ï¼š\nåˆ†åŒºæ˜¯ â€œç‰©ç†è¡¨â€ åˆ†åŒºè£å‰ªæé«˜æŸ¥è¯¢æ€§èƒ½ é€‚ç”¨äº TB çº§æ•°æ® 10. æ‰©å±•èƒ½åŠ›ï¼ˆPostgres æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ï¼‰ PostgreSQL èƒ½åŠ è½½æ‰©å±•ï¼š\nCREATE EXTENSION timescaledb; CREATE EXTENSION postgis; CREATE EXTENSION pg_trgm; CREATE EXTENSION btree_gin; CREATE EXTENSION citext; ... çŸ¥åæ‰©å±•ï¼š\næ‰©å±• ä½œç”¨ TimescaleDB æ—¶åºæ•°æ®åº“å¼•æ“ PostGIS åœ°ç†ç©ºé—´æ•°æ®åº“ pg_trgm æ¨¡ç³ŠåŒ¹é…ï¼ˆç›¸ä¼¼åº¦ï¼‰ uuid-ossp UUID citext ä¸åŒºåˆ†å¤§å°å†™å­—ç¬¦ä¸² tablefunc pivot/crosstab æ‰©å±•ç”Ÿæ€æå…¶ä¸°å¯Œï¼Œæ˜¯ PostgreSQL æœ€å¤§æ€æ‰‹çº§ä¼˜åŠ¿ã€‚\n11. é«˜å¯ç”¨ä¸é›†ç¾¤æ–¹æ¡ˆ PostgreSQL è‡ªå¸¦æµå¤åˆ¶ï¼ˆStreaming Replicationï¼‰ï¼š\nPrimary \u0026lt;- WAL -\u0026gt; Standby å…¸å‹æ–¹æ¡ˆï¼š\næ–¹æ¡ˆ ç‰¹ç‚¹ Patroni æœ€å¼ºã€æœ€æˆç†Ÿã€ä¼ä¸šçº§ pgpool-II è¿æ¥æ±  + è´Ÿè½½å‡è¡¡ repmgr ä¸»ä»ç®¡ç† Native Logical Replication åˆ†è¡¨åŒæ­¥ã€çµæ´» ä¼ä¸šæ¨èï¼š\nPatroni + etcd + HAProxy é«˜åº¦æ•°æ®ä¸€è‡´æ€§é›†ç¾¤ï¼Œç­”æ¡ˆå°±æ˜¯ Patroniã€‚\n12. PostgreSQL åº”ç”¨åœºæ™¯ é«˜åº¦äº‹åŠ¡æ€§ç³»ç»Ÿï¼ˆæ¯” MySQL æ›´ç¨³ï¼‰ é“¶è¡Œ ERP è®¢å•ç³»ç»Ÿ é‡‘èæ ¸å¿ƒç³»ç»Ÿ å¤§é‡ JSON ä¸ç»“æ„åŒ–æ··åˆæŸ¥è¯¢ åç«¯ API é…ç½®ç®¡ç† ç”¨æˆ·è‡ªå®šä¹‰å­—æ®µ æ—¶åºæ•°æ®ï¼ˆTimescaleDBï¼‰ ç›‘æ§ï¼ˆZabbixï¼‰ ä¼ æ„Ÿå™¨æ•°æ® è‚¡ç¥¨è¡Œæƒ…ï¼ˆä½ æ­£åœ¨åšçš„ up_resaon ç±»è¡¨ï¼‰ åœ°ç†ç³»ç»Ÿ GISã€åœ°å›¾ï¼ˆPostGISï¼‰ æµ·é‡æ•°æ®åˆ†æï¼ˆOLAP æ··åˆï¼‰ æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢ã€å‘é‡åŒ–æ‰«æã€‚\n13. PostgreSQL ä¸ MySQL æ¯”è¾ƒ ç‰¹æ€§ PostgreSQL MySQL SQL æ ‡å‡† âœ… æœ€é«˜ ä¸­ç­‰ JSON âœ… å¼ºï¼ˆjsonbï¼‰ å¼± äº‹åŠ¡ âœ… å¼ºï¼ˆMVCC+é”ï¼‰ ä¸­ æ‰©å±•èƒ½åŠ› âœ… è¶…å¼º å¼± ç´¢å¼•ç±»å‹ âœ… å¾ˆå¤š å°‘ æŸ¥è¯¢ä¼˜åŒ–å™¨ âœ… å¼º ä¸€èˆ¬ ACID ä¸€è‡´æ€§ âœ… å¼º ä¸­ èšåˆ\u0026amp;çª—å£å‡½æ•° âœ… å®Œæ•´ éƒ¨åˆ† å¹¶è¡ŒæŸ¥è¯¢ âœ… å¼º å¼± åˆ†åŒºè¡¨ âœ… æˆç†Ÿ ä¸€èˆ¬ æ—¶åºæ•°æ®åº“ âœ… TimescaleDB âŒ æ—  14. PostgreSQL æœ€ä½³å®è·µï¼ˆæ€»ç»“ï¼‰ é»˜è®¤å­—ç¬¦ç±»å‹ç”¨ text JSON ç”¨ jsonb ç´¢å¼•å°½é‡ç”¨ BTREEï¼Œä¼˜åŒ–å™¨æœ€ç†Ÿ å¤§è¡¨ç”¨åˆ†åŒºï¼ˆRANGEï¼‰ æ—¶åºè¡¨ç”¨ TimescaleDB VACUUM å‚æ•°è°ƒä¼˜ ä½¿ç”¨è¿æ¥æ± ï¼ˆPgBouncerï¼‰ ä½¿ç”¨ autovacuumï¼Œä¸æ‰‹åŠ¨ vacuum full ä¸»ä»å¤åˆ¶ç”¨ Patroni ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ â€œPostgreSQL è¯¦ç»†ä»‹ç»ï¼ˆè¶…å®Œæ•´ã€å®æˆ˜å‹å¥½ã€æ¶æ„çº§åˆ«ï¼‰â€ï¼Œè¦†ç›–ï¼š\nPostgreSQL æ˜¯ä»€ä¹ˆ æ¶æ„ä¸åº•å±‚åŸç† å­˜å‚¨æ¨¡å‹ äº‹åŠ¡æ¨¡å‹ï¼ˆMVCCï¼‰ é”æœºåˆ¶ æŸ¥è¯¢æ‰§è¡Œæµç¨‹ ç´¢å¼•ç±»å‹ åˆ†åŒºä¸æ‰©å±•æ€§ å¹¶è¡ŒæŸ¥è¯¢ é«˜å¯ç”¨ä¸é›†ç¾¤ å®é™…ä½¿ç”¨åœºæ™¯ æœ€ä½³å®è·µ ä¸ MySQLã€Oracle çš„å¯¹æ¯” 1. PostgreSQL æ˜¯ä»€ä¹ˆï¼Ÿ PostgreSQLï¼ˆç®€ç§° Postgresï¼‰æ˜¯å½“å‰ æœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ä¹‹ä¸€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€åƒ Oracle çš„æ•°æ®åº“ï¼Œè¢«ç§°ä¸ºï¼š\næœ€å¼ºå¼€æºæ•°æ®åº“ ä¸–ç•Œä¸ŠåŠŸèƒ½æœ€å®Œæ•´çš„å…³ç³»æ•°æ®åº“ ç‰¹ç‚¹ï¼š\nçœŸæ­£çš„ ä¼ä¸šçº§ æ•°æ®åº“ æ”¯æŒ SQL + JSON æ··åˆæ¨¡å‹ å®Œæ•´çš„äº‹åŠ¡ã€é”ã€MVCC ä¸°å¯Œç´¢å¼•ç±»å‹ï¼ˆè¿œè¶… MySQLï¼‰ å¯æ‰©å±•ï¼ˆæ’ä»¶åŒ–ã€æ‰©å±•ã€å‡½æ•°ï¼‰ é«˜æ°´å¹³æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ˆæ¯” MySQL å¼ºå¾ˆå¤šï¼‰ å¯ä½œä¸º OLTP + OLAP æ··åˆåœºæ™¯ é€‰æ‹© PostgreSQL 17 æ›´å¿«ï¼Œæ›´å¼ºï¼Œæ›´ç°ä»£ 2. PostgreSQL ä½“ç³»ç»“æ„ï¼ˆArchitectureï¼‰ æ ¸å¿ƒç»„ä»¶ï¼š\n"},{"id":72,"href":"/database/postgres/core/","title":"PostgreSQL æ ¸å¿ƒæ¦‚å¿µ","parent":"PostgreSQL","content":"å†…å®¹ï¼šä»æ¶æ„ -\u0026gt; å­˜å‚¨ -\u0026gt; äº‹åŠ¡ -\u0026gt; æŸ¥è¯¢ -\u0026gt; ç´¢å¼• -\u0026gt; å¹¶å‘ -\u0026gt; è¿ç»´\nä¸€ã€PostgreSQL æ˜¯ä»€ä¹ˆï¼ˆå®šä½ï¼‰ PostgreSQL æ˜¯ä¸€ä¸ªï¼š\nå…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰ å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰ å¤šè¿›ç¨‹æ¶æ„ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ å¯æ‰©å±•ï¼ˆExtensionï¼‰ OLTP ä¸ºä¸»ï¼ŒOLAP å¯è¾… ğŸ‘‰ æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š\nâ€œæ­£ç¡®æ€§ \u0026gt; æ€§èƒ½ \u0026gt; ä¾¿åˆ©æ€§â€\näºŒã€æ•´ä½“æ¶æ„ï¼ˆéå¸¸æ ¸å¿ƒï¼‰ 1ï¸âƒ£ å®¢æˆ·ç«¯ / æœåŠ¡ç«¯æ¨¡å‹ Client â†“ Postmasterï¼ˆç›‘å¬è¿›ç¨‹ï¼‰ â†“ fork Backend Processï¼ˆæ¯ä¸ªè¿æ¥ä¸€ä¸ªè¿›ç¨‹ï¼‰ ç‰¹ç‚¹\nä¸€ä¸ªè¿æ¥ = ä¸€ä¸ªè¿›ç¨‹ æ— å…±äº«å†…å­˜çº¿ç¨‹æ¨¡å‹ï¼ˆå¯¹æ¯” MySQL InnoDBï¼‰ ç¨³å®šã€éš”ç¦»æ€§å¼º è¿æ¥æ•°ä¸èƒ½æ— é™å¤§ -\u0026gt; PgBouncer 2ï¸âƒ£ è¿›ç¨‹æ¨¡å‹ï¼ˆé‡è¦ï¼‰ è¿›ç¨‹ ä½œç”¨ postmaster ä¸»è¿›ç¨‹ backend å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ checkpointer å®šæœŸåˆ·è„é¡µ bgwriter åå°å†™ walwriter WAL å†™å…¥ autovacuum å›æ”¶åƒåœ¾ archiver WAL å½’æ¡£ logical replication é€»è¾‘å¤åˆ¶ ä¸‰ã€å­˜å‚¨æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ è¡¨ = æ–‡ä»¶ + Page Pageï¼ˆé¡µï¼‰\né»˜è®¤ 8KB æœ€å° IO å•ä½ æ‰€æœ‰æ•°æ®éƒ½åœ¨ Page é‡Œ Page ç»“æ„\nPage Header Line Pointer Tupleï¼ˆè¡Œæ•°æ®ï¼‰ 2ï¸âƒ£ è¡Œå­˜å‚¨ï¼ˆTupleï¼‰ PostgreSQL æ˜¯ è¡Œå­˜å‚¨ ä¸€è¡Œæ›´æ–° â‰  åŸåœ°æ›´æ–° ğŸ‘‰ UPDATE æœ¬è´¨ = INSERT + DELETE\n3ï¸âƒ£ TOASTï¼ˆå¤§å­—æ®µå­˜å‚¨ï¼‰ å½“å­—æ®µå¾ˆå¤§æ—¶ï¼š\nTEXT JSON BYTEA ä¼šè¢«è‡ªåŠ¨æ‹†åˆ†å­˜å‚¨åˆ° TOAST è¡¨ã€‚\nå››ã€MVCCï¼ˆPostgreSQL çµé­‚ï¼‰ 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ MVCCï¼Ÿ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶\næ¯ä¸€è¡Œéƒ½æœ‰ï¼š\nxminï¼šåˆ›å»ºè¯¥è¡Œçš„äº‹åŠ¡ID xmaxï¼šåˆ é™¤è¯¥è¡Œçš„äº‹åŠ¡ID æ ¸å¿ƒæ€æƒ³\nè¯»ä¸é˜»å¡å†™ å†™ä¸é˜»å¡è¯» 2ï¸âƒ£ å¯è§æ€§è§„åˆ™ï¼ˆç®€åŒ–ï¼‰ ä¸€è¡Œæ˜¯å¦å¯è§å–å†³äºï¼š\nå½“å‰äº‹åŠ¡ ID è¡Œçš„ xmin / xmax å½“å‰äº‹åŠ¡å¿«ç…§ï¼ˆSnapshotï¼‰ 3ï¸âƒ£ é•¿äº‹åŠ¡ = ä¸‡æ¶ä¹‹æº é˜»æ­¢ VACUUM å¯¼è‡´è¡¨è†¨èƒ€ å¤åˆ¶å»¶è¿Ÿ äº”ã€äº‹åŠ¡ï¼ˆACIDï¼‰ 1ï¸âƒ£ ACID ç‰¹æ€§ PostgreSQL å®ç° Atomicity WAL Consistency çº¦æŸ + äº‹åŠ¡ Isolation MVCC Durability WAL + fsync 2ï¸âƒ£ éš”ç¦»çº§åˆ« PostgreSQL æ”¯æŒï¼š\néš”ç¦»çº§åˆ« å®ç° READ COMMITTED é»˜è®¤ REPEATABLE READ å¿«ç…§ SERIALIZABLE SSI âš ï¸ PostgreSQL æ²¡æœ‰çœŸæ­£çš„ READ UNCOMMITTED\nå…­ã€WALï¼ˆå†™å‰æ—¥å¿—ï¼‰ 1ï¸âƒ£ WAL æ˜¯ä»€ä¹ˆï¼Ÿ æ‰€æœ‰ä¿®æ”¹ï¼Œå…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®\né¡ºåº\nWAL -\u0026gt; Memory WAL -\u0026gt; Disk Data Page -\u0026gt; Diskï¼ˆå»¶è¿Ÿï¼‰ 2ï¸âƒ£ WAL çš„ä½œç”¨ å´©æºƒæ¢å¤ ä¸»ä»å¤åˆ¶ PITR é€»è¾‘å¤åˆ¶ 3ï¸âƒ£ Checkpoint å°†è„é¡µåˆ·ç›˜ æ§åˆ¶ WAL å¢é•¿ å¤ªé¢‘ç¹ -\u0026gt; IO æŠ–åŠ¨ å¤ªå°‘ -\u0026gt; æ¢å¤æ…¢ ä¸ƒã€ç´¢å¼•ï¼ˆæ‰§è¡Œæ€§èƒ½æ ¸å¿ƒï¼‰ 1ï¸âƒ£ å¸¸è§ç´¢å¼•ç±»å‹ ç´¢å¼• é€‚ç”¨ B-Tree =, \u0026lt;, \u0026gt;, BETWEEN GIN array / json / trgm GiST ç©ºé—´ / æ¨¡ç³Š BRIN è¶…å¤§è¡¨ï¼Œé¡ºåºæ•°æ® Hash ç­‰å€¼ï¼ˆå¾ˆå°‘ç”¨ï¼‰ 2ï¸âƒ£ PostgreSQL ç´¢å¼•ç‰¹ç‚¹ ç´¢å¼•ä¹Ÿæ˜¯è¡¨ ç´¢å¼•æœ‰ MVCC UPDATE ä¼šå¯¼è‡´ç´¢å¼•è†¨èƒ€ 3ï¸âƒ£ å¤åˆç´¢å¼•å·¦å‰ç¼€åŸåˆ™ (a, b, c) å¯ç”¨ï¼š\na a, b a, b, c ä¸å¯ç”¨ï¼š\nb c å…«ã€æŸ¥è¯¢æ‰§è¡Œæµç¨‹ï¼ˆéå¸¸é‡è¦ï¼‰ SQL â†“ Parserï¼ˆè¯­æ³•ï¼‰ â†“ Rewriterï¼ˆè§„åˆ™é‡å†™ï¼‰ â†“ Plannerï¼ˆæˆæœ¬ä¼°ç®—ï¼‰ â†“ Executorï¼ˆæ‰§è¡Œï¼‰ Planner å†³ç­–ä¾æ®\nç»Ÿè®¡ä¿¡æ¯ è¡¨å¤§å° ç´¢å¼•é€‰æ‹©æ€§ I/O æˆæœ¬ ç»Ÿè®¡ä¿¡æ¯æ¥æº\nANALYZE; pg_statistic; ä¹ã€é”æœºåˆ¶ 1ï¸âƒ£ é”çš„åˆ†ç±» ç±»å‹ è¯´æ˜ è¡¨çº§é” DDL è¡Œçº§é” UPDATE Advisory Lock åº”ç”¨é” Predicate Lock SERIALIZABLE 2ï¸âƒ£ PostgreSQL é”ç‰¹ç‚¹ è¡Œé”æ˜¯ é€»è¾‘é” é”ä¸ MVCC å¹¶å­˜ SELECT é»˜è®¤ä¸åŠ é” åã€VACUUMï¼ˆä¸å¯ç¼ºå°‘ï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆè¦ VACUUMï¼Ÿ MVCC äº§ç”Ÿåƒåœ¾ å›æ”¶ dead tuple æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ 2ï¸âƒ£ autovacuum è‡ªåŠ¨è¿è¡Œ ä¸ç­‰äºä¸‡æ— ä¸€å¤± é«˜å†™å…¥åœºæ™¯å¿…é¡»è°ƒä¼˜ åä¸€ã€æ—¶é—´ä¸æ—¶åŒºï¼ˆé«˜é¢‘å‘ï¼‰ TIMESTAMP vs TIMESTAMPTZ\nç±»å‹ å«ä¹‰ TIMESTAMP æ— æ—¶åŒº TIMESTAMPTZ ç»å¯¹æ—¶é—´ ğŸ‘‰ æ—¥å¿— / äº‹ä»¶ / å®¡è®¡ï¼šå¿…é¡» TIMESTAMPTZ\nåäºŒã€æ‰©å±•ä½“ç³»ï¼ˆPostgreSQL æ ¸å¿ƒä¼˜åŠ¿ï¼‰ å¸¸è§æ‰©å±•\næ‰©å±• ä½œç”¨ pg_trgm æ¨¡ç³Šæœç´¢ uuid-ossp UUID hstore KV PostGIS GIS TimescaleDB æ—¶åº åä¸‰ã€PostgreSQL vs MySQLï¼ˆæ ¸å¿ƒå·®å¼‚ï¼‰ ç»´åº¦ PostgreSQL MySQL æ¶æ„ å¤šè¿›ç¨‹ å¤šçº¿ç¨‹ MVCC æ›´å®Œæ•´ InnoDB SQL æ ‡å‡† é«˜ ä¸€èˆ¬ æ‰©å±• æå¼º è¾ƒå¼± OLAP æ›´é€‚åˆ å OLTP åå››ã€æ€»ç»“ PostgreSQL æ˜¯ä¸€ä¸ªä»¥ MVCC + WAL ä¸ºæ ¸å¿ƒã€ä»¥æ­£ç¡®æ€§ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ã€é€šè¿‡ VACUUM è‡ªæˆ‘ä¿®å¤çš„å…³ç³»å‹æ•°æ®åº“ã€‚\n","description":"å†…å®¹ï¼šä»æ¶æ„ -\u0026gt; å­˜å‚¨ -\u0026gt; äº‹åŠ¡ -\u0026gt; æŸ¥è¯¢ -\u0026gt; ç´¢å¼• -\u0026gt; å¹¶å‘ -\u0026gt; è¿ç»´\nä¸€ã€PostgreSQL æ˜¯ä»€ä¹ˆï¼ˆå®šä½ï¼‰ PostgreSQL æ˜¯ä¸€ä¸ªï¼š\nå…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰ å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰ å¤šè¿›ç¨‹æ¶æ„ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ å¯æ‰©å±•ï¼ˆExtensionï¼‰ OLTP ä¸ºä¸»ï¼ŒOLAP å¯è¾… ğŸ‘‰ æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š\nâ€œæ­£ç¡®æ€§ \u0026gt; æ€§èƒ½ \u0026gt; ä¾¿åˆ©æ€§â€\näºŒã€æ•´ä½“æ¶æ„ï¼ˆéå¸¸æ ¸å¿ƒï¼‰ 1ï¸âƒ£ å®¢æˆ·ç«¯ / æœåŠ¡ç«¯æ¨¡å‹ Client â†“ Postmasterï¼ˆç›‘å¬è¿›ç¨‹ï¼‰ â†“ fork Backend Processï¼ˆæ¯ä¸ªè¿æ¥ä¸€ä¸ªè¿›ç¨‹ï¼‰ ç‰¹ç‚¹\n"},{"id":73,"href":"/database/prometheus/tutorial/","title":"Prometheus åŸºç¡€æ•™ç¨‹","parent":"Prometheus","content":"å†…å®¹ï¼š\næ ¸å¿ƒæ¦‚å¿µ æ¶æ„ å®‰è£…éƒ¨ç½² Exporter PromQL å‘Šè­¦ Grafana æœ€ä½³å®è·µ 1. Prometheus æ˜¯ä»€ä¹ˆï¼Ÿ Prometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§ç³»ç»Ÿï¼Œâ€œæ‹‰ï¼ˆPullï¼‰æ¨¡å¼â€çš„æ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œç”¨äºé‡‡é›†ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å¯è§†åŒ–æŒ‡æ ‡ã€‚\nä¼˜åŠ¿ï¼š\nå®‰è£…ç®€å•ã€éƒ¨ç½²æ˜“ æ— éœ€å®¢æˆ·ç«¯ SDKï¼Œåªè¦æš´éœ² /metrics å³å¯ å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ PromQL ä¸ Grafana æ·±åº¦é›†æˆ äº‘åŸç”Ÿç›‘æ§äº‹å®æ ‡å‡†ï¼ˆKubernetes é»˜è®¤ç›‘æ§æ–¹æ¡ˆï¼‰ 2. Prometheus å·¥ä½œåŸç† Prometheus é€šè¿‡ HTTP å®šæœŸæŠ“å–ç›®æ ‡æœåŠ¡çš„ /metrics æ•°æ®ï¼Œå­˜å…¥æœ¬åœ° TSDBï¼ˆæ—¶é—´åºåˆ—æ•°æ®åº“ï¼‰ã€‚\næµç¨‹ï¼š\nExporter --\u0026gt; Prometheus Server --\u0026gt; TSDB --\u0026gt; PromQL --\u0026gt; Grafana æ ¸å¿ƒç»„ä»¶ï¼š\nç»„ä»¶ æè¿° Prometheus Server æŠ“å–æ•°æ®ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å‘Šè­¦ Exporter æš´éœ²è¢«ç›‘æ§çš„æŒ‡æ ‡ Alertmanager ç®¡ç†å‘Šè­¦é€šçŸ¥ Pushgateway ä¸´æ—¶ä½œä¸šæ¨é€æŒ‡æ ‡ Grafana å¯è§†åŒ–å·¥å…· 3. Prometheus ä¸­çš„æŒ‡æ ‡ï¼ˆMetricsï¼‰ Prometheus æŒ‡æ ‡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\næŒ‡æ ‡å + æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰+ æ ·æœ¬å€¼ + æ—¶é—´æˆ³ ç¤ºä¾‹ï¼š\nhttp_requests_total{method=\u0026#34;GET\u0026#34;, handler=\u0026#34;/\u0026#34;} 1024 1710000000 æœ‰å››ç§æŒ‡æ ‡ç±»å‹ï¼š\nç±»å‹ ç”¨é€” Counter å•è°ƒé€’å¢è®¡æ•°å™¨ï¼ˆå¦‚æ¥å£è¯·æ±‚æ•°ï¼‰ Gauge å¯å¢å¯å‡æŒ‡æ ‡ï¼ˆå¦‚å†…å­˜ã€CPUï¼‰ Histogram ç›´æ–¹å›¾ï¼ˆç»Ÿè®¡åˆ†å¸ƒï¼Œå¸¸ç”¨äºå»¶è¿Ÿï¼‰ Summary ç™¾åˆ†ä½è®¡ç®—ï¼ˆé€šå¸¸ä¸å»ºè®®å¤šç”¨ï¼‰ 4. Prometheus å®‰è£…ï¼ˆæœ€ç®€å•æ–¹å¼ï¼‰ ä¸‹è½½ä¸è¿è¡Œ\nwget https://github.com/prometheus/prometheus/releases/latest/download/prometheus-*.linux-amd64.tar.gz tar xvf prometheus-*.tar.gz cd prometheus-*/ ./prometheus --config.file=prometheus.yml é»˜è®¤ç«¯å£ï¼š\nPrometheus UI: http://localhost:9090 APIï¼š/api/v1/query ç­‰ 5. Prometheus åŸºç¡€é…ç½®ï¼ˆprometheus.ymlï¼‰ æœ€ç®€é…ç½®ï¼š\nglobal: scrape_interval: 15s scrape_configs: - job_name: \u0026#39;prometheus\u0026#39; static_configs: - targets: [\u0026#39;localhost:9090\u0026#39;] è¯´æ˜ï¼š\nscrape_interval: æ¯ 15 ç§’æŠ“å–ä¸€æ¬¡ job_name: ç›‘æ§ä»»åŠ¡åç§° targets: ç›‘æ§ç›®æ ‡ï¼ˆExporterï¼‰åˆ—è¡¨ 6. æ·»åŠ  Exporterï¼ˆç›‘æ§èŠ‚ç‚¹ã€æœåŠ¡ï¼‰ Prometheus ä¸ç›´æ¥ç›‘æ§ç³»ç»Ÿï¼Œè€Œæ˜¯é€šè¿‡ Exporter å®ç°ã€‚\nå¸¸ç”¨ Exporterï¼š\nExporter ç›‘æ§å†…å®¹ ç«¯å£ node_exporter æœåŠ¡å™¨ CPU/å†…å­˜/ç£ç›˜ 9100 mysqld_exporter MySQL æŒ‡æ ‡ 9104 blackbox_exporter ç½‘ç»œ/HTTP æ¢æ´» 9115 redis_exporter Redis æŒ‡æ ‡ 9121 å®‰è£… node_exporterï¼ˆç¤ºä¾‹ï¼‰\nwget https://github.com/prometheus/node_exporter/releases/latest/download/node_exporter-*.linux-amd64.tar.gz tar xvf node_exporter*.tar.gz ./node_exporter è®¿é—®æŸ¥çœ‹ï¼š\nhttp://localhost:9100/metrics Prometheus é…ç½®æ·»åŠ ç›‘æ§èŠ‚ç‚¹\nscrape_configs: - job_name: \u0026#39;nodes\u0026#39; static_configs: - targets: - 10.0.0.1:9100 - 10.0.0.2:9100 7. PromQLï¼ˆæŸ¥è¯¢è¯­è¨€ï¼‰åŸºç¡€ PromQL æ˜¯ Prometheus æœ€å¼ºå¤§çš„éƒ¨åˆ†ï¼Œç”¨äºï¼š\næŸ¥è¯¢å•ä¸ªæŒ‡æ ‡ èšåˆæŒ‡æ ‡ ç›‘æ§çŠ¶æ€ å‘Šè­¦è¡¨è¾¾å¼ 7.1 æŸ¥è¯¢ä¸€ä¸ªæŒ‡æ ‡ node_cpu_seconds_total 7.2 é€šè¿‡æ ‡ç­¾è¿‡æ»¤ node_cpu_seconds_total{mode!=\u0026#34;idle\u0026#34;} 7.3 é€Ÿç‡å‡½æ•°ï¼ˆç›‘æ§å¸¸ç”¨ï¼‰ rate(http_requests_total[5m]) 7.4 èšåˆ ç»Ÿè®¡æ‰€æœ‰å®ä¾‹çš„æ€»è¯·æ±‚æ•°ï¼š\nsum(rate(http_requests_total[5m])) æŒ‰æœåŠ¡åˆ†ç±»ï¼š\nsum by (instance) (rate(http_requests_total[5m])) 7.5 å¸¸ç”¨å‡½æ•° å‡½æ•° ç”¨é€” rate() counter é€Ÿç‡ irate() æ›´çµæ• sum() æ±‚å’Œ avg() å¹³å‡ max() æœ€å¤§ min() æœ€å° increase() å¢é‡ 8. å‘Šè­¦ï¼ˆAlertingï¼‰ å‘Šè­¦é€šè¿‡ Prometheus Rule -\u0026gt; Alertmanager -\u0026gt; é€šçŸ¥æ¸ é“ å®ç°ã€‚\n8.1 Prometheus å‘Šè­¦è§„åˆ™ç¤ºä¾‹ groups: - name: node_alerts rules: - alert: HighCPU expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\u0026#34;idle\u0026#34;}[5m])) * 100) \u0026gt; 90 for: 5m labels: severity: warning annotations: summary: \u0026#34;èŠ‚ç‚¹ CPU ä½¿ç”¨ç‡è¿‡é«˜\u0026#34; ä¿å­˜è·¯å¾„å¦‚ï¼š\n/etc/prometheus/rules/*.yml 8.2 Alertmanager æœ€ç®€é…ç½® route: receiver: \u0026#39;default\u0026#39; receivers: - name: \u0026#39;default\u0026#39; email_configs: - to: \u0026#34;me@example.com\u0026#34; from: \u0026#34;alert@example.com\u0026#34; å¯æ‰©å±•åˆ°ï¼š\né£ä¹¦ é’‰é’‰ ä¼ä¸šå¾®ä¿¡ Webhook 9. Grafana å¯è§†åŒ– å®‰è£… Grafanaï¼š\ndocker run -p 3000:3000 grafana/grafana æ·»åŠ  Prometheus ä½œä¸ºæ•°æ®æºï¼š\nURL: http://prometheus:9090 å®˜æ–¹ä»ªè¡¨ç›˜ï¼ˆå¯ä»¥ç›´æ¥å¯¼å…¥ï¼‰ï¼š\nåœºæ™¯ Dashboard ID Linux èŠ‚ç‚¹ï¼ˆNode Exporterï¼‰ 1860 Kubernetes ç›‘æ§ 6417, 8588 Prometheus è‡ªèº«ç›‘æ§ 3662 10. åŸºç¡€æœ€ä½³å®è·µï¼ˆå…¥é—¨å³éµå®ˆï¼‰ 1. æ ‡ç­¾ä¸è¦å¤ªå¤š æ ‡ç­¾è¿‡å¤šä¼šå¯¼è‡´æ—¶é—´åºåˆ—çˆ†ç‚¸ -\u0026gt; OOM/æ…¢æŸ¥è¯¢\né¿å… user_idã€session_id ç­‰åŠ¨æ€æ ‡ç­¾\n2. æŠ“å–é—´éš”ä¸è¦å¤ªä½ ä¿æŒ 15s æˆ– 30sã€‚\n3. å®šæœŸæ¸…ç†æ—§æ•°æ® é»˜è®¤ä¿ç•™ 15 å¤©ï¼Œå¯è°ƒæ•´ï¼š\n--storage.tsdb.retention.time=30d 4. Grafana æŸ¥è¯¢å¿…é¡»å¸¦æ ‡ç­¾è¿‡æ»¤ å¦åˆ™ä¼šæ‰«æå¤§é‡æ•°æ®ã€‚\n5. æŒ‡æ ‡åå­—å¿…é¡»è¯­ä¹‰æ˜ç¡® ä½¿ç”¨ï¼š\n*_total *_seconds *_bytes ğŸ“Œ æœ€ç»ˆæ€»ç»“ï¼ˆå…¥é—¨å­¦ä¹ è·¯çº¿ï¼‰ å­¦ä¼šå®‰è£… Prometheus + node_exporter é…ç½®æŠ“å– -\u0026gt; æŸ¥çœ‹æŒ‡æ ‡ å­¦ PromQLï¼ˆrate / sum / byï¼‰ é…ç½®å‘Šè­¦ï¼ˆCPU/å†…å­˜/ç£ç›˜ï¼‰ é…åˆ Grafana å±•ç¤ºå›¾è¡¨ æœ€åå­¦ä¹ è¿ç»´ã€æ€§èƒ½ä¼˜åŒ–ã€è¿œç¨‹å­˜å‚¨ï¼ˆå¦‚ Thanosï¼‰ ","description":"å†…å®¹ï¼š\næ ¸å¿ƒæ¦‚å¿µ æ¶æ„ å®‰è£…éƒ¨ç½² Exporter PromQL å‘Šè­¦ Grafana æœ€ä½³å®è·µ 1. Prometheus æ˜¯ä»€ä¹ˆï¼Ÿ Prometheus æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§ç³»ç»Ÿï¼Œâ€œæ‹‰ï¼ˆPullï¼‰æ¨¡å¼â€çš„æ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œç”¨äºé‡‡é›†ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å¯è§†åŒ–æŒ‡æ ‡ã€‚\nä¼˜åŠ¿ï¼š\nå®‰è£…ç®€å•ã€éƒ¨ç½²æ˜“ æ— éœ€å®¢æˆ·ç«¯ SDKï¼Œåªè¦æš´éœ² /metrics å³å¯ å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ PromQL ä¸ Grafana æ·±åº¦é›†æˆ äº‘åŸç”Ÿç›‘æ§äº‹å®æ ‡å‡†ï¼ˆKubernetes é»˜è®¤ç›‘æ§æ–¹æ¡ˆï¼‰ 2. Prometheus å·¥ä½œåŸç† Prometheus é€šè¿‡ HTTP å®šæœŸæŠ“å–ç›®æ ‡æœåŠ¡çš„ /metrics æ•°æ®ï¼Œå­˜å…¥æœ¬åœ° TSDBï¼ˆæ—¶é—´åºåˆ—æ•°æ®åº“ï¼‰ã€‚\n"},{"id":74,"href":"/database/prometheus/core/","title":"Prometheus æ ¸å¿ƒæ¦‚å¿µ","parent":"Prometheus","content":" ä¸€ã€Prometheus è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€å¥è¯å®šä¹‰ï¼š\nPrometheus æ˜¯ä¸€ä¸ªä»¥ æ—¶é—´åºåˆ— ä¸ºæ ¸å¿ƒã€é‡‡ç”¨ Pull æ¨¡å¼ã€é¢å‘ äº‘åŸç”Ÿä¸å¤§è§„æ¨¡ç³»ç»Ÿ çš„ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿã€‚\nå®ƒè§£å†³çš„æ˜¯ä¸‰ä¸ªé—®é¢˜ï¼š\nå¦‚ä½•æŒç»­é‡‡é›†ç³»ç»ŸçŠ¶æ€ï¼ˆMetricsï¼‰ å¦‚ä½•é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢æ—¶é—´åºåˆ—æ•°æ® å¦‚ä½•ç”¨è§„åˆ™è¡¨è¾¾â€œå¼‚å¸¸â€å¹¶è§¦å‘å‘Šè­¦ äºŒã€Prometheus çš„è®¾è®¡å“²å­¦ï¼ˆéå¸¸é‡è¦ï¼‰ 2.1 ä»¥ Metrics ä¸ºä¸­å¿ƒï¼Œè€Œé Logs Prometheus åªå…³å¿ƒ å¯èšåˆã€å¯è®¡ç®—çš„æ•°å€¼æŒ‡æ ‡ï¼š\nCPU ä½¿ç”¨ç‡ è¯·æ±‚æ•° å»¶è¿Ÿ é”™è¯¯ç‡ è€Œä¸æ˜¯ï¼š\næ–‡æœ¬æ—¥å¿— ç¦»æ•£äº‹ä»¶ ğŸ‘‰ è¿™æ˜¯ Prometheus èƒ½é«˜æ€§èƒ½è¿è¡Œçš„æ ¹æœ¬åŸå› ã€‚\n2.2 Pull \u0026gt; Pushï¼ˆæ ¸å¿ƒå–èˆï¼‰ Prometheus é‡‡ç”¨ Pull æ¨¡å¼ï¼š\nPrometheus --\u0026gt; /metrics --\u0026gt; Target è®¾è®¡åŠ¨æœºï¼š\nPrometheus æ§åˆ¶é‡‡é›†é¢‘ç‡ è‡ªåŠ¨å‘ç°æœåŠ¡ ç›®æ ‡ä¸éœ€è¦çŸ¥é“ Prometheus çš„å­˜åœ¨ æ˜“äºæ‰©å±•ã€è¿ç§» Push åªä½œä¸ºä¾‹å¤–ï¼ˆPushgatewayï¼‰\n2.3 å•æœºä¼˜å…ˆï¼Œåˆ†å¸ƒå¼é ç”Ÿæ€ Prometheus Server æœ¬èº«æ˜¯ï¼š\nå•èŠ‚ç‚¹ å¼ºä¸€è‡´ æœ¬åœ° TSDB å¤§è§„æ¨¡é—®é¢˜äº¤ç»™ï¼š\nThanos Cortex Mimir VictoriaMetrics ğŸ‘‰ Prometheus = å¯é å†…æ ¸ + å¯æ‰©å±•ç”Ÿæ€\nä¸‰ã€Prometheus çš„æ•°æ®æ¨¡å‹ï¼ˆæœ€æ ¸å¿ƒï¼‰ 3.1 æ—¶é—´åºåˆ—ï¼ˆTime Seriesï¼‰ Prometheus ä¸­çš„ä¸€åˆ‡éƒ½æ˜¯ æ—¶é—´åºåˆ—ï¼š\n\u0026lt;metric_name\u0026gt;{\u0026lt;label_key\u0026gt;=\u0026lt;label_value\u0026gt;, ...} æ¯ä¸€ä¸ªå”¯ä¸€çš„ (metric_name + labels) = ä¸€æ¡æ—¶é—´åºåˆ—ã€‚\n3.2 Metric Nameï¼ˆæŒ‡æ ‡åï¼‰ è§„èŒƒï¼š\nå°å†™ ä¸‹åˆ’çº¿åˆ†éš” æœ‰å•ä½åç¼€ ç¤ºä¾‹ï¼š\nhttp_requests_total node_memory_MemAvailable_bytes request_duration_seconds ğŸ‘‰ æŒ‡æ ‡åè¡¨è¾¾ â€œæ˜¯ä»€ä¹ˆâ€\n3.3 Labelsï¼ˆæ ‡ç­¾ï¼‰ æ ‡ç­¾ç”¨äº ç»´åº¦æ‹†åˆ†ä¸èšåˆï¼š\nhttp_requests_total{method=\u0026#34;GET\u0026#34;, status=\u0026#34;200\u0026#34;} ğŸ‘‰ æ ‡ç­¾è¡¨è¾¾ â€œä»å“ªä¸ªè§’åº¦çœ‹â€\nâš ï¸ æ ‡ç­¾å†³å®šæ•°æ®è§„æ¨¡ï¼ˆcardinalityï¼‰\n3.4 Sampleï¼ˆæ ·æœ¬ï¼‰ (timestamp, value) timestampï¼šæ¯«ç§’çº§ valueï¼šfloat64 å››ã€Cardinalityï¼ˆåŸºæ•°ï¼‰â€”â€”ç”Ÿæ­»çº¿ 4.1 ä»€ä¹ˆæ˜¯ Cardinalityï¼Ÿ åŸºæ•° = æ—¶é—´åºåˆ—æ•°é‡\nseries = metric_name Ã— label ç»„åˆ ä¾‹å­ï¼š\nhttp_requests_total Ã— method (3) Ã— status (5) Ã— path (1000) = 15000 series 4.2 ä¸ºä»€ä¹ˆé«˜åŸºæ•°ä¼šâ€œæ€æ­»â€ Prometheusï¼Ÿ æ¯æ¡æ—¶é—´åºåˆ—éƒ½éœ€è¦ï¼š å†…å­˜ WAL å†™å…¥ ç´¢å¼• å†…å­˜å ç”¨éš series æ•°é‡çº¿æ€§å¢é•¿ æŸ¥è¯¢å¤æ‚åº¦æŒ‡æ•°çº§ä¸Šå‡ ğŸ‘‰ OOM çš„æœ¬è´¨ä¸æ˜¯æ•°æ®é‡ï¼Œè€Œæ˜¯ series æ•°é‡\n4.3 ç¦æ­¢çš„æ ‡ç­¾ âŒ user_id âŒ request_id âŒ session_id âŒ trace_id âŒ åŠ¨æ€ URL äº”ã€Metric ç±»å‹ï¼ˆè¯­ä¹‰æ¨¡å‹ï¼‰ Prometheus æœ‰ 4 ç§ç±»å‹ï¼ˆè¯­ä¹‰çº¦æŸï¼‰ï¼š\nç±»å‹ ç‰¹æ€§ åœºæ™¯ Counter åªå¢ä¸å‡ è¯·æ±‚æ•°ã€é”™è¯¯æ•° Gauge å¯å¢å¯å‡ CPUã€å†…å­˜ Histogram bucket ç»Ÿè®¡ å»¶è¿Ÿã€å¤§å° Summary å®¢æˆ·ç«¯åˆ†ä½æ•° å•å®ä¾‹å»¶è¿Ÿ 5.1 Counter çš„å“²å­¦ Counter æ°¸ä¸å‡å°‘ï¼š\né‡å¯ -\u0026gt; ä» 0 å¼€å§‹ï¼ˆéœ€ rate() å¤„ç†ï¼‰ ä¸èƒ½ç›´æ¥ avg(counter) ğŸ‘‰ æ‰€æœ‰æµé‡ç±»æŒ‡æ ‡å¿…é¡»æ˜¯ Counterã€‚\n5.2 Histogram vs Summary ç»´åº¦ Histogram Summary åˆ†ä½æ•° æœåŠ¡ç«¯è®¡ç®— å®¢æˆ·ç«¯è®¡ç®— è·¨å®ä¾‹èšåˆ âœ” âŒ label æ§åˆ¶ å¥½ å·® æ¨èåº¦ â­â­â­â­â­ â­ ğŸ‘‰ ç”Ÿäº§ç»Ÿä¸€ç”¨ Histogram\nå…­ã€TSDB å­˜å‚¨åŸç†ï¼ˆåº•å±‚ï¼‰ 6.1 å­˜å‚¨ç»“æ„ WAL -\u0026gt; Head -\u0026gt; Blockï¼ˆ2hï¼‰ WALï¼šé˜²æ­¢æ•°æ®ä¸¢å¤± Headï¼šå†…å­˜ä¸­çš„å½“å‰æ•°æ® Blockï¼šè½ç›˜åçš„å‹ç¼©æ•°æ® 6.2 ä¸ºä»€ä¹ˆ 2 å°æ—¶ä¸€ä¸ª Blockï¼Ÿ æ§åˆ¶å‹ç¼©æˆæœ¬ æé«˜æŸ¥è¯¢æ•ˆç‡ é™ä½ compaction å¤æ‚åº¦ 6.3 ä¸ºä»€ä¹ˆ Prometheus æŸ¥è¯¢å¿«ï¼Ÿ åˆ—å¼å­˜å‚¨æ€æƒ³ å€’æ’ç´¢å¼•ï¼ˆlabel -\u0026gt; seriesï¼‰ å†…å­˜ + mmap é¡ºåº IO ä¸ƒã€PromQL çš„ç†è®ºåŸºç¡€ PromQL æ˜¯ é¢å‘æ—¶é—´åºåˆ—çš„å‡½æ•°å¼æŸ¥è¯¢è¯­è¨€ã€‚\næ ¸å¿ƒæ“ä½œï¼š\né€‰æ‹©æ—¶é—´åºåˆ— æ—¶é—´çª—å£è®¡ç®— èšåˆ å‘é‡è¿ç®— 7.1 å‘é‡ç±»å‹ ç±»å‹ æè¿° Instant Vector æŸä¸€æ—¶åˆ»çš„ series Range Vector ä¸€æ®µæ—¶é—´å†…çš„ samples Scalar å•ä¸€æ•°å€¼ String æ ‡ç­¾æ–‡æœ¬ 7.2 ä¸ºä»€ä¹ˆè¦ rate()ï¼Ÿ å› ä¸ºï¼š\nCounter æ˜¯ç´¯è®¡å€¼ ç›‘æ§éœ€è¦â€œå˜åŒ–ç‡â€ rate() = å¯¹ Counter åšä¸€é˜¶å¯¼æ•°ã€‚\nå…«ã€å‘Šè­¦çš„æœ¬è´¨ å‘Šè­¦ = PromQL + æ—¶é—´çº¦æŸ\nexpr: CPU \u0026gt; 90% for: 5m å«ä¹‰ï¼š\nè¿ç»­ 5 åˆ†é’Ÿ CPU \u0026gt; 90%ï¼Œæ‰ç®—å¼‚å¸¸ã€‚\n8.1 å‘Šè­¦ vs ç›‘æ§å›¾è¡¨ é¡¹ å‘Šè­¦ å›¾è¡¨ æ˜¯å¦å®æ—¶ æ˜¯ å¦ æ˜¯å¦å®¹é”™ ä½ é«˜ æ˜¯å¦å…è®¸æŠ–åŠ¨ å¦ æ˜¯ ä¹ã€Prometheus é«˜å¯ç”¨çš„ç†è®º Prometheus æœ¬èº«ä¸åšé›†ç¾¤ï¼š\nç®€åŒ–ä¸€è‡´æ€§ é¿å…åˆ†å¸ƒå¼å¤æ‚æ€§ ç”¨å†—ä½™ä»£æ›¿åˆ†å¸ƒå¼ ğŸ‘‰ â€œå¤šå®ä¾‹ + å»é‡â€ â‰  â€œåˆ†å¸ƒå¼æ•°æ®åº“â€\nğŸ”š æ€»ç»“ Prometheus ç›‘æ§çš„æ˜¯â€œçŠ¶æ€â€ï¼Œä¸æ˜¯â€œäº‹ä»¶â€ æ—¶é—´åºåˆ—æ•°é‡å†³å®šä¸€åˆ‡ æ ‡ç­¾æ˜¯æœ€å±é™©çš„è®¾è®¡ç‚¹ Pull æ˜¯å¯è§‚æµ‹æ€§çš„åŸºç¡€ Prometheus å¼ºåœ¨è§„åˆ™ä¸ç”Ÿæ€ï¼Œä¸åœ¨åˆ†å¸ƒå¼ ","description":" ä¸€ã€Prometheus è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€å¥è¯å®šä¹‰ï¼š\nPrometheus æ˜¯ä¸€ä¸ªä»¥ æ—¶é—´åºåˆ— ä¸ºæ ¸å¿ƒã€é‡‡ç”¨ Pull æ¨¡å¼ã€é¢å‘ äº‘åŸç”Ÿä¸å¤§è§„æ¨¡ç³»ç»Ÿ çš„ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿã€‚\nå®ƒè§£å†³çš„æ˜¯ä¸‰ä¸ªé—®é¢˜ï¼š\nå¦‚ä½•æŒç»­é‡‡é›†ç³»ç»ŸçŠ¶æ€ï¼ˆMetricsï¼‰ å¦‚ä½•é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢æ—¶é—´åºåˆ—æ•°æ® å¦‚ä½•ç”¨è§„åˆ™è¡¨è¾¾â€œå¼‚å¸¸â€å¹¶è§¦å‘å‘Šè­¦ äºŒã€Prometheus çš„è®¾è®¡å“²å­¦ï¼ˆéå¸¸é‡è¦ï¼‰ 2.1 ä»¥ Metrics ä¸ºä¸­å¿ƒï¼Œè€Œé Logs Prometheus åªå…³å¿ƒ å¯èšåˆã€å¯è®¡ç®—çš„æ•°å€¼æŒ‡æ ‡ï¼š\n"},{"id":75,"href":"/backend/python/official/python-base/","title":"Python åŸºç¡€æ•™ç¨‹","parent":"Official","content":"ä¸‹é¢æ˜¯ Python ç¼–ç¨‹åŸºç¡€çŸ¥è¯†æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°çš„å¯¼å›¾å¼æ€»ç»“ï¼Œéå¸¸é€‚åˆè‡ªå­¦ã€å¤ä¹ ã€æ‰“åŸºç¡€ã€‚\nå†…å®¹åˆ†ä¸º 8 å¤§æ¨¡å—ï¼Œä»æœ€åŸºç¡€åˆ°èƒ½å†™å®é™…é¡¹ç›®ã€‚\nğŸ¯ 1. Python åŸºç¡€è¯­æ³• âœ… 1.1 æ³¨é‡Š # å•è¡Œæ³¨é‡Š \u0026#34;\u0026#34;\u0026#34; å¤šè¡Œæ³¨é‡Š \u0026#34;\u0026#34;\u0026#34; âœ… 1.2 å˜é‡ä¸åŸºæœ¬ç±»å‹ï¼ˆå¸¸ç”¨çš„ï¼‰ è¯¦ç»†æ–‡æ¡£ï¼šå˜é‡\nintï¼ˆæ•´æ•°ï¼‰ floatï¼ˆæµ®ç‚¹æ•°ï¼‰ boolï¼ˆå¸ƒå°”ï¼‰ strï¼ˆå­—ç¬¦ä¸²ï¼‰ listï¼ˆåˆ—è¡¨ï¼‰ dictï¼ˆå­—å…¸ï¼‰ datetimeï¼ˆæ—¥æœŸæ—¶é—´ï¼‰ Noneï¼ˆç©ºï¼‰ âœ… 1.3 åŸºæœ¬è¿ç®— è¯¦ç»†æ–‡æ¡£ï¼šåŸºæœ¬è¿ç®—\nç®—æœ¯ï¼š+ - * / // % ** æ¯”è¾ƒï¼š== != \u0026gt; \u0026lt; \u0026gt;= \u0026lt;= é€»è¾‘ï¼šand or not ğŸ¯ 2. æ•°æ®ç»“æ„ï¼ˆPython çš„æ ¸å¿ƒï¼‰ âœ… 2.1 åˆ—è¡¨ list è¯¦ç»†æ–‡æ¡£ï¼šåˆ—è¡¨\nnums = [1, 2, 3] nums.append(4) âœ… 2.2 å…ƒç»„ tupleï¼ˆä¸å¯å˜ï¼‰ è¯¦ç»†æ–‡æ¡£ï¼šå…ƒç»„\nt = (1, 2, 3) âœ… 2.3 é›†åˆ setï¼ˆå»é‡é›†åˆï¼‰ s = {1, 2, 3} âœ… 2.4 å­—å…¸ dictï¼ˆé”®å€¼å¯¹ï¼‰ person = {\u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;age\u0026#34;: 20} ğŸ¯ 3. æ§åˆ¶è¯­å¥ âœ… 3.1 æ¡ä»¶åˆ¤æ–­ if x \u0026gt; 0: ... elif x == 0: ... else: ... âœ… 3.2 å¾ªç¯ for i in range(5): ... while condition: ... break / continue ğŸ¯ 4. å‡½æ•° å‡½æ•°å®šä¹‰\ndef add(a, b): return a + b é»˜è®¤å‚æ•°\ndef greet(name=\u0026#34;Tom\u0026#34;): print(\u0026#34;Hi\u0026#34;, name) å¯å˜å‚æ•°\ndef f(*args, **kwargs): ... ğŸ¯ 5. æ¨¡å—ä¸åŒ… å¯¼å…¥æ¨¡å—\nimport math from datetime import datetime è‡ªå·±åˆ›å»ºæ¨¡å—ï¼ˆæ–‡ä»¶ .pyï¼‰\nå®‰è£…ç¬¬ä¸‰æ–¹åº“\npip install requests ğŸ¯ 6. é¢å‘å¯¹è±¡ OOP åŸºç¡€ ç±»ä¸å¯¹è±¡\nclass Dog: def __init__(self, name): self.name = name def bark(self): print(self.name, \u0026#34;barks\u0026#34;) d = Dog(\u0026#34;Coco\u0026#34;) d.bark() ç»§æ‰¿\nclass A: pass class B(A): pass æ–¹æ³•ç±»å‹ï¼š\nå®ä¾‹æ–¹æ³•ï¼ˆselfï¼‰ ç±»æ–¹æ³•ï¼ˆ@classmethodï¼‰ é™æ€æ–¹æ³•ï¼ˆ@staticmethodï¼‰ ğŸ¯ 7. æ–‡ä»¶æ“ä½œ æ–‡ä»¶è¯»å–\nwith open(\u0026#34;a.txt\u0026#34;) as f: text = f.read() æ–‡ä»¶å†™å…¥\nwith open(\u0026#34;a.txt\u0026#34;, \u0026#34;w\u0026#34;) as f: f.write(\u0026#34;hello\u0026#34;) ğŸ¯ 8. å¸¸ç”¨æ ‡å‡†åº“ åº“ ç”¨é€” os æ–‡ä»¶ç³»ç»Ÿ sys è§£é‡Šå™¨ç›¸å…³ datetime æ—¥æœŸæ—¶é—´ json JSON è§£æ math æ•°å­¦å‡½æ•° random éšæœºæ•° re æ­£åˆ™è¡¨è¾¾å¼ ğŸ¯ 9. é”™è¯¯ä¸å¼‚å¸¸å¤„ç† try: x = 1 / 0 except ZeroDivisionError: print(\u0026#34;division by zero\u0026#34;) finally: print(\u0026#34;done\u0026#34;) ğŸ¯ 10. Python é‡è¦ç‰¹æ€§ï¼ˆè¿›é˜¶å¿…çŸ¥ï¼‰ åˆ—è¡¨æ¨å¯¼å¼\n[x * 2 for x in range(5)] ç”Ÿæˆå™¨\ndef gen(): yield 1 yield 2 lambda\nf = lambda x: x + 1 è£…é¥°å™¨\ndef deco(fn): def wrapper(): print(\u0026#34;before\u0026#34;) fn() return wrapper ","description":"ä¸‹é¢æ˜¯ Python ç¼–ç¨‹åŸºç¡€çŸ¥è¯†æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°çš„å¯¼å›¾å¼æ€»ç»“ï¼Œéå¸¸é€‚åˆè‡ªå­¦ã€å¤ä¹ ã€æ‰“åŸºç¡€ã€‚\nå†…å®¹åˆ†ä¸º 8 å¤§æ¨¡å—ï¼Œä»æœ€åŸºç¡€åˆ°èƒ½å†™å®é™…é¡¹ç›®ã€‚\nğŸ¯ 1. Python åŸºç¡€è¯­æ³• âœ… 1.1 æ³¨é‡Š # å•è¡Œæ³¨é‡Š \u0026#34;\u0026#34;\u0026#34; å¤šè¡Œæ³¨é‡Š \u0026#34;\u0026#34;\u0026#34; âœ… 1.2 å˜é‡ä¸åŸºæœ¬ç±»å‹ï¼ˆå¸¸ç”¨çš„ï¼‰ è¯¦ç»†æ–‡æ¡£ï¼šå˜é‡\n"},{"id":76,"href":"/backend/python/official/python-core/","title":"Python æ ¸å¿ƒæ¦‚å¿µ","parent":"Official","content":" ä¸€ã€ä¸€åˆ‡çš†å¯¹è±¡ï¼ˆEverything is Objectï¼‰ æ ¸å¿ƒæ€æƒ³ å˜é‡ä¸æ˜¯â€œç›’å­â€ï¼Œè€Œæ˜¯å¯¹è±¡çš„å¼•ç”¨ å‡½æ•°ã€ç±»ã€æ¨¡å—ã€å¼‚å¸¸ï¼Œéƒ½æ˜¯å¯¹è±¡ def f(): ... print(type(f)) # \u0026lt;class \u0026#39;function\u0026#39;\u0026gt; å·¥ç¨‹æ„ä¹‰ å‡½æ•°å¯ä»¥å½“å‚æ•°ã€è¿”å›å€¼ è£…é¥°å™¨ã€å›è°ƒã€å‡½æ•°å¼ç¼–ç¨‹çš„æ ¹åŸº äºŒã€å¼•ç”¨è¯­ä¹‰ vs å€¼è¯­ä¹‰ Python æ˜¯ä»€ä¹ˆï¼Ÿ ä¼ é€’çš„æ˜¯å¯¹è±¡å¼•ç”¨ï¼ˆcall by object referenceï¼‰\ndef f(x): x.append(1) lst = [] f(lst) print(lst) # [1] å…³é”®ç†è§£\nå¯å˜å¯¹è±¡ï¼šlist / dict / set ä¸å¯å˜å¯¹è±¡ï¼šint / str / tuple ä¸‰ã€å¯å˜ vs ä¸å¯å˜ï¼ˆMutabilityï¼‰ ç±»å‹ æ˜¯å¦å¯å˜ int / float / str âŒ tupleï¼ˆå…ƒç´ ä¸å¯å˜ï¼‰ âš ï¸ list / dict / set âœ… a = 1 b = a b += 1 # åˆ›å»ºæ–°å¯¹è±¡ å·¥ç¨‹æ„ä¹‰ é»˜è®¤å‚æ•°é™·é˜± æ‹·è´ / æ·±æ‹·è´ï¼ˆdeepcopyï¼‰çš„å¿…è¦æ€§ å››ã€åŠ¨æ€ç±»å‹ \u0026amp; å¼ºç±»å‹ åŠ¨æ€ç±»å‹ ç±»å‹åœ¨è¿è¡Œæ—¶å†³å®š\nx = 1 x = \u0026#34;hello\u0026#34; å¼ºç±»å‹ ä¸è‡ªåŠ¨éšå¼è½¬æ¢\n1 + \u0026#34;1\u0026#34; # TypeError äº”ã€ä½œç”¨åŸŸä¸å‘½åç©ºé—´ï¼ˆLEGBï¼‰ æŸ¥æ‰¾é¡ºåº\nLocal -\u0026gt; Enclosing -\u0026gt; Global -\u0026gt; Builtins\nx = 1 def f(): print(x) å…³é”®ç‚¹\nglobal nonlocal å…­ã€è¿­ä»£åè®® \u0026amp; æƒ°æ€§è®¡ç®— è¿­ä»£åè®®\niter(obj) next(it) æƒ°æ€§å¯¹è±¡\ngenerator map / filter / zip range (x * 2 for x in range(10)) å·¥ç¨‹æ„ä¹‰ èŠ‚çœå†…å­˜ æ”¯æŒå¤§æ•°æ®æµå¤„ç† ä¸ƒã€å¼‚å¸¸æœºåˆ¶ï¼ˆEAFPï¼‰ Python é£æ ¼\nEasier to Ask Forgiveness than Permission\nç¿»è¯‘ï¼šç›¸æ¯”è®¸å¯æ›´æ˜“è¯·æ±‚åŸè°…\ntry: x = d[\u0026#34;key\u0026#34;] except KeyError: ... å¯¹æ¯” LBYLï¼ˆå…ˆåˆ¤æ–­ï¼‰\nLBYLï¼šç»å‰é¡¾åï¼Œå…ˆæ£€æŸ¥å†æ“ä½œã€‚ EAFPï¼šå…ˆæ–©åå¥ï¼Œç›´æ¥åšå†çœ‹åæœã€‚ å…«ã€å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼ˆFirst-class Functionï¼‰ èƒ½åŠ› èµ‹å€¼ ä½œä¸ºå‚æ•° ä½œä¸ºè¿”å›å€¼ def outer(): def inner(): ... return inner è¡ç”Ÿæ¦‚å¿µ è£…é¥°å™¨ é—­åŒ… é«˜é˜¶å‡½æ•° ä¹ã€é¢å‘å¯¹è±¡æ˜¯â€œç»„åˆä¼˜äºç»§æ‰¿â€ Python çš„ OOP ç‰¹ç‚¹ å¤šç»§æ‰¿ï¼ˆMROï¼‰ é¸­å­ç±»å‹ if hasattr(obj, \u0026#34;read\u0026#34;): ... è®¾è®¡åŸåˆ™ Favor Composition over Inheritance\nç¿»è¯‘ï¼šä¼˜å…ˆé€‰æ‹©ç»„åˆè€Œä¸æ˜¯ç»§æ‰¿\nåã€Python æ•°æ®æ¨¡å‹ï¼ˆé­”æœ¯æ–¹æ³•ï¼‰ __init__ __len__ __iter__ __enter__ / __exit__ __call__ æ ¸å¿ƒç†å¿µ è¡Œä¸ºç”±åè®®å®šä¹‰ï¼Œè€Œä¸æ˜¯ç»§æ‰¿å±‚çº§\nåä¸€ã€å¹¶å‘æ¨¡å‹ä¸ GIL Python çš„å¹¶å‘ä¸‰è·¯ æ¨¡å‹ é€‚ç”¨ threading IO å¯†é›† multiprocessing CPU å¯†é›† asyncio é«˜å¹¶å‘ IO GIL æœ¬è´¨ ä¿è¯è§£é‡Šå™¨çº¿ç¨‹å®‰å…¨ ä¸æ˜¯ Python è¯­è¨€å±‚é™åˆ¶ åäºŒã€Pythonic æ€ç»´ï¼ˆThe Zen of Pythonï¼‰ import this æ ¸å¿ƒå‡†åˆ™\nReadability counts (å¯è¯»æ€§å¾ˆé‡è¦) Simple \u0026gt; Complex (ç®€å•èƒœè¿‡å¤æ‚) Explicit \u0026gt; Implicit (æ˜¾ç¤ºèƒœè¿‡éšå¼) æ€»ç»“ å¯¹è±¡æ¨¡å‹ â”œâ”€â”€ å¼•ç”¨è¯­ä¹‰ â”œâ”€â”€ å¯å˜æ€§ â”œâ”€â”€ æ•°æ®æ¨¡å‹ â”‚ â”œâ”€â”€ è¿­ä»£ â”‚ â”œâ”€â”€ ä¸Šä¸‹æ–‡ â”‚ â””â”€â”€ é­”æœ¯æ–¹æ³• â”œâ”€â”€ å‡½æ•°å¼ â”œâ”€â”€ OOP â”œâ”€â”€ å¹¶å‘æ¨¡å‹ â””â”€â”€ Pythonic æ€ç»´ å­¦ä¹ ä¼˜å…ˆçº§å»ºè®® ğŸ”¥ å¿…é¡»ç²¾é€š å¯¹è±¡ \u0026amp; å¼•ç”¨ å¯å˜ / ä¸å¯å˜ è¿­ä»£ \u0026amp; ç”Ÿæˆå™¨ å¼‚å¸¸æ¨¡å‹ å‡½æ•° / è£…é¥°å™¨ ğŸš€ è¿›é˜¶ æ•°æ®æ¨¡å‹ asyncio å¹¶å‘æ¶æ„ ç±»å‹ç³»ç»Ÿï¼ˆtyping / pydanticï¼‰ ","description":" ä¸€ã€ä¸€åˆ‡çš†å¯¹è±¡ï¼ˆEverything is Objectï¼‰ æ ¸å¿ƒæ€æƒ³ å˜é‡ä¸æ˜¯â€œç›’å­â€ï¼Œè€Œæ˜¯å¯¹è±¡çš„å¼•ç”¨ å‡½æ•°ã€ç±»ã€æ¨¡å—ã€å¼‚å¸¸ï¼Œéƒ½æ˜¯å¯¹è±¡ def f(): ... print(type(f)) # \u0026lt;class \u0026#39;function\u0026#39;\u0026gt; å·¥ç¨‹æ„ä¹‰ å‡½æ•°å¯ä»¥å½“å‚æ•°ã€è¿”å›å€¼ è£…é¥°å™¨ã€å›è°ƒã€å‡½æ•°å¼ç¼–ç¨‹çš„æ ¹åŸº äºŒã€å¼•ç”¨è¯­ä¹‰ vs å€¼è¯­ä¹‰ Python æ˜¯ä»€ä¹ˆï¼Ÿ ä¼ é€’çš„æ˜¯å¯¹è±¡å¼•ç”¨ï¼ˆcall by object referenceï¼‰\n"},{"id":77,"href":"/database/redis/core/","title":"Redis æ ¸å¿ƒæ¦‚å¿µ","parent":"Redis","content":" ä¸€ã€Redis æ˜¯ä»€ä¹ˆï¼Ÿ Redis æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„ Key-Value æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒæŒä¹…åŒ–ã€ä¸»ä»å¤åˆ¶å’Œé›†ç¾¤ã€‚\næ ¸å¿ƒç‰¹å¾\nå†…å­˜å­˜å‚¨ï¼ˆæå¿«ï¼‰ å•çº¿ç¨‹æ¨¡å‹ï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰ å¤šæ•°æ®ç»“æ„ å¯æŒä¹…åŒ– æ”¯æŒåˆ†å¸ƒå¼ äºŒã€Redis çš„æ ¸å¿ƒè®¾è®¡ç†å¿µï¼ˆå¿…ä¼šï¼‰ 1ï¸âƒ£ å•çº¿ç¨‹æ¨¡å‹ï¼ˆä½†ä¸æ˜¯â€œåªèƒ½ç”¨ä¸€ä¸ª CPUâ€ï¼‰ Redis ç”¨å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼Œé¿å…é”ï¼Œæé«˜å¯é¢„æµ‹æ€§èƒ½ã€‚\nåŸç†\nå•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤ I/O å¤šè·¯å¤ç”¨ï¼ˆepoll / kqueueï¼‰ Redis 6+ å¼•å…¥ I/O å¤šçº¿ç¨‹ ğŸ“Œ ä¼˜ç‚¹ï¼š\næ— é” é«˜æ€§èƒ½ é€»è¾‘ç®€å• ğŸ“Œ ç¼ºç‚¹ï¼š\nå•ä¸ªå®ä¾‹æœ‰ CPU ä¸Šé™ 2ï¸âƒ£ å†…å­˜æ¨¡å‹ï¼ˆä¸ºä»€ä¹ˆå¿«ï¼‰ æ‰€æœ‰æ•°æ®åœ¨å†…å­˜ é¡ºåºæ‰§è¡Œ æå°‘ç³»ç»Ÿè°ƒç”¨ ç®€å•æ•°æ®ç»“æ„ ä¸‰ã€Redis çš„æ•°æ®ç»“æ„ï¼ˆéå¸¸é‡è¦ï¼‰ Redis çš„ value æ˜¯ â€œå¯¹è±¡â€ï¼Œä¸æ˜¯ç®€å•å­—ç¬¦ä¸²ã€‚\n1ï¸âƒ£ äº”å¤§åŸºç¡€ç±»å‹ ç±»å‹ è¯´æ˜ ä½¿ç”¨åœºæ™¯ String å­—ç¬¦ä¸² / æ•°å€¼ ç¼“å­˜ã€è®¡æ•°å™¨ Hash å­—æ®µ-å€¼ å¯¹è±¡å­˜å‚¨ List åŒç«¯é“¾è¡¨ æ¶ˆæ¯é˜Ÿåˆ— Set æ— åºé›†åˆ å»é‡ ZSet æœ‰åºé›†åˆ æ’è¡Œæ¦œ 2ï¸âƒ£ åº•å±‚æ•°æ®ç»“æ„ï¼ˆåŠ åˆ†é¡¹ï¼‰ Redis ç±»å‹ åº•å±‚å®ç° String SDS Hash ziplist / hashtable List quicklist Set intset / hashtable ZSet skiplist + dict å››ã€Redis çš„ Key è®¾è®¡åŸåˆ™ è§„èŒƒ\nä¸šåŠ¡:æ¨¡å—:å¯¹è±¡:{id} ç¤ºä¾‹ï¼š\nuser:profile:{1001} order:info:{2001} Cluster ä¸“ç”¨\n{} Hash Tag ä¿è¯åŒæ§½ äº”ã€è¿‡æœŸç­–ç•¥ï¼ˆåŸºç¡€ä½†é‡è¦ï¼‰ 1ï¸âƒ£ ä¸‰ç§åˆ é™¤æ–¹å¼ å®šæœŸåˆ é™¤ æƒ°æ€§åˆ é™¤ï¼ˆä¸»ï¼‰ å®šæœŸ + æƒ°æ€§ï¼ˆå®é™…ï¼‰ 2ï¸âƒ£ å†…å­˜æ·˜æ±°ç­–ç•¥ maxmemory-policy allkeys-lru å¸¸è§ç­–ç•¥ï¼š\nallkeys-lru volatile-lru noeviction å…­ã€æŒä¹…åŒ–æœºåˆ¶ï¼ˆç†è®ºå¿…ä¼šï¼‰ 1ï¸âƒ£ RDB å†…å­˜å¿«ç…§ fork å­è¿›ç¨‹ æ¢å¤å¿« 2ï¸âƒ£ AOF è®°å½•å†™å‘½ä»¤ æ•°æ®å®Œæ•´ æ–‡ä»¶å¤§ 3ï¸âƒ£ æ··åˆæŒä¹…åŒ– RDB + AOFï¼ˆç”Ÿäº§æ¨èï¼‰ ä¸ƒã€å¤åˆ¶ä¸é«˜å¯ç”¨ 1ï¸âƒ£ ä¸»ä»å¤åˆ¶ å¼‚æ­¥å¤åˆ¶ å…¨é‡ + å¢é‡ 2ï¸âƒ£ Sentinel ç›‘æ§ è‡ªåŠ¨æ•…éšœè½¬ç§» é€‰ä¸» 3ï¸âƒ£ Cluster 16384 slots æ— ä¸­å¿ƒ è‡ªåŠ¨åˆ†ç‰‡ å…«ã€äº‹åŠ¡ \u0026amp; Luaï¼ˆç»å¸¸è¢«å¿½ç•¥ï¼‰ 1ï¸âƒ£ äº‹åŠ¡ MULTI / EXEC ä¸æ”¯æŒå›æ»š ä¿è¯é¡ºåº 2ï¸âƒ£ Lua åŸå­æ‰§è¡Œ ä¸èƒ½é˜»å¡ Cluster æœ‰é™åˆ¶ ä¹ã€Redis çš„å…¸å‹åº”ç”¨åœºæ™¯ ç¼“å­˜ åˆ†å¸ƒå¼é” è®¡æ•°å™¨ å»¶è¿Ÿé˜Ÿåˆ— æ’è¡Œæ¦œ ä¼šè¯å­˜å‚¨ åã€Redis çš„æ ¸å¿ƒé™åˆ¶ï¼ˆå¿…é¡»çŸ¥é“ï¼‰ é™åˆ¶ è¯´æ˜ å•çº¿ç¨‹ CPU æœ‰ä¸Šé™ å†…å­˜ ä¸æ˜¯æ— é™ Cluster åªæœ‰ DB 0 å¼ºä¸€è‡´æ€§ ä¸ä¿è¯ åä¸€ã€æ€»ç»“ Redis æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é«˜æ€§èƒ½ Key-Value å­˜å‚¨ç³»ç»Ÿï¼Œé‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹å’Œ I/O å¤šè·¯å¤ç”¨ï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„ã€æŒä¹…åŒ–ã€é«˜å¯ç”¨å’Œåˆ†å¸ƒå¼é›†ç¾¤ï¼Œå¸¸ç”¨äºç¼“å­˜å’Œé«˜å¹¶å‘åœºæ™¯ã€‚\n","description":" ä¸€ã€Redis æ˜¯ä»€ä¹ˆï¼Ÿ Redis æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„ Key-Value æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œæ”¯æŒæŒä¹…åŒ–ã€ä¸»ä»å¤åˆ¶å’Œé›†ç¾¤ã€‚\næ ¸å¿ƒç‰¹å¾\nå†…å­˜å­˜å‚¨ï¼ˆæå¿«ï¼‰ å•çº¿ç¨‹æ¨¡å‹ï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰ å¤šæ•°æ®ç»“æ„ å¯æŒä¹…åŒ– æ”¯æŒåˆ†å¸ƒå¼ äºŒã€Redis çš„æ ¸å¿ƒè®¾è®¡ç†å¿µï¼ˆå¿…ä¼šï¼‰ 1ï¸âƒ£ å•çº¿ç¨‹æ¨¡å‹ï¼ˆä½†ä¸æ˜¯â€œåªèƒ½ç”¨ä¸€ä¸ª CPUâ€ï¼‰ Redis ç”¨å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼Œé¿å…é”ï¼Œæé«˜å¯é¢„æµ‹æ€§èƒ½ã€‚\n"},{"id":78,"href":"/database/redis/classic-issues/","title":"Redis ç»å…¸é—®é¢˜","parent":"Redis","content":"Redis é™¤äº†ä¸‰å¤§ç¼“å­˜é—®é¢˜ï¼Œè¿˜æœ‰å“ªäº›å¸¸è§é—®é¢˜ï¼Ÿ\næŒ‰ å¼€å‘é—®é¢˜ / è¿ç»´é—®é¢˜ / æ¶æ„é—®é¢˜ åˆ†ç±»ã€‚\nä¸€ã€å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆéå¸¸çˆ±é—®ï¼‰ 1ï¸âƒ£ ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼ˆğŸ”¥ å¿…è€ƒï¼‰ é—®é¢˜\nRedis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ æ›´æ–°é¡ºåºé”™è¯¯å¯¼è‡´è„æ•°æ® å…¸å‹åœºæ™¯\næ›´æ–° DB æˆåŠŸ æ›´æ–° Redis å¤±è´¥ -\u0026gt; ç¼“å­˜æ˜¯æ—§å€¼ å¸¸è§æ–¹æ¡ˆ\næ–¹æ¡ˆ è¯´æ˜ å…ˆåˆ ç¼“å­˜å†å†™ DB âŒ å¹¶å‘ä¸‹å¯èƒ½å›å†™æ—§å€¼ å…ˆå†™ DB å†åˆ ç¼“å­˜ âœ… æœ€å¸¸ç”¨ å»¶è¿ŸåŒåˆ  âœ… MQ / Binlog âœ… é«˜é˜¶æ–¹æ¡ˆ 2ï¸âƒ£ çƒ­ç‚¹ Key é—®é¢˜ï¼ˆHot Keyï¼‰ é—®é¢˜\næŸä¸€ä¸ª key QPS æé«˜ å•ä¸ª Redis èŠ‚ç‚¹è¢«æ‰“çˆ† è§£å†³æ–¹æ¡ˆ\næœ¬åœ°ç¼“å­˜ key æ‹†åˆ† å¤šå‰¯æœ¬ç¼“å­˜ è¯»å†™åˆ†ç¦» 3ï¸âƒ£ å¤§ Key é—®é¢˜ï¼ˆBig Keyï¼‰ é—®é¢˜\nå•ä¸ª key æ•°æ®é‡è¿‡å¤§ é˜»å¡ Redis ä¸»çº¿ç¨‹ å½±å“\nQPS ä¸‹é™ ä¸»ä»åŒæ­¥å»¶è¿Ÿ AOF / RDB å¡é¡¿ è§£å†³æ–¹æ¡ˆ\næ‹†åˆ† key ä½¿ç”¨ Hash/List åˆ†ç‰‡ é¿å…å¤§é›†åˆ 4ï¸âƒ£ æ•°æ®è¿‡æœŸä¸å†…å­˜æ·˜æ±°é—®é¢˜ é—®é¢˜\nå†…å­˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿ key æ²¡è¿‡æœŸä½†è¢«æ·˜æ±°ï¼Ÿ å…³é”®é…ç½®\nmaxmemory maxmemory-policy å¸¸è§ç­–ç•¥\nallkeys-lruï¼ˆæœ€å¸¸ç”¨ï¼‰ volatile-ttl 5ï¸âƒ£ äº‹åŠ¡ä¸å¯é ï¼ˆå¾ˆå¤šäººå¿½ç•¥ï¼‰ é—®é¢˜\nRedis äº‹åŠ¡ï¼ˆMULTI/EXECï¼‰ä¸æ”¯æŒå›æ»š åªèƒ½ä¿è¯å‘½ä»¤é¡ºåº äºŒã€è¿ç»´ä¾§å¸¸è§é—®é¢˜ï¼ˆé«˜çº§å·¥ç¨‹å¸ˆé‡ç‚¹ï¼‰ 6ï¸âƒ£ Redis å•çº¿ç¨‹ç“¶é¢ˆ é—®é¢˜\nå•çº¿ç¨‹å¤„ç†å‘½ä»¤ CPU å¯èƒ½æˆä¸ºç“¶é¢ˆ ä¼˜åŒ–\nPipeline I/O å¤šçº¿ç¨‹ï¼ˆRedis 6+ï¼‰ æ‹†åˆ†å®ä¾‹ 7ï¸âƒ£ ä¸»ä»å¤åˆ¶å»¶è¿Ÿ é—®é¢˜\nä»èŠ‚ç‚¹æ•°æ®è½å è¯»åˆ°æ—§æ•°æ® åŸå› \nç½‘ç»œå»¶è¿Ÿ å¤§ Key RDB å¤åˆ¶ 8ï¸âƒ£ ä¸»ä»åˆ‡æ¢æ•°æ®ä¸¢å¤± é—®é¢˜\nä¸»èŠ‚ç‚¹å®•æœº æœ€æ–°æ•°æ®å°šæœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹ è§£å†³\nmin-replicas-to-write min-replicas-max-lag 9ï¸âƒ£ æŒä¹…åŒ–å¸¦æ¥çš„æ€§èƒ½æŠ–åŠ¨ é—®é¢˜\nRDB fork é˜»å¡ AOF rewrite å¡é¡¿ ä¼˜åŒ–\noff-peak æ‰§è¡Œ æ··åˆæŒä¹…åŒ–ï¼ˆRDB+AOFï¼‰ ğŸ”Ÿ Redis OOM / å†…å­˜ç¢ç‰‡ é—®é¢˜\nå†…å­˜ç”¨æ»¡ ç¢ç‰‡ç‡è¿‡é«˜ æ’æŸ¥\nINFO memory ä¸‰ã€é›†ç¾¤ / æ¶æ„çº§é—®é¢˜ï¼ˆå¾ˆåŠ åˆ†ï¼‰ 1ï¸âƒ£1ï¸âƒ£ Cluster é‡åˆ†ç‰‡é£é™© slot è¿ç§»å¯¼è‡´æ€§èƒ½æŠ–åŠ¨ ç½‘ç»œä¸ç¨³å®šå¯¼è‡´è¿ç§»å¤±è´¥ 1ï¸âƒ£2ï¸âƒ£ è·¨ Slot æ“ä½œé™åˆ¶ å¤š key å¿…é¡»åŒ slot äº‹åŠ¡ã€Lua é™åˆ¶ 1ï¸âƒ£3ï¸âƒ£ Lua è„šæœ¬é˜»å¡ é•¿ Lua ä¼šé˜»å¡ Redis å¯¼è‡´æ•´ä¸ªå®ä¾‹ä¸å¯ç”¨ 1ï¸âƒ£4ï¸âƒ£ Sentinel è¯¯åˆ¤ ç½‘ç»œæŠ–åŠ¨ ä¸»èŠ‚ç‚¹è¢«è¯¯ä¸‹çº¿ 1ï¸âƒ£5ï¸âƒ£ å®‰å…¨é—®é¢˜ï¼ˆçœŸå®äº‹æ•…ï¼‰ æœªè®¾ç½®å¯†ç  ç»‘å®š 0.0.0.0 è¢«å†™ crontab / SSH key å››ã€é—®é¢˜é€ŸæŸ¥è¡¨ åˆ†ç±» é—®é¢˜ ç¼“å­˜å±‚ ç©¿é€ / å‡»ç©¿ / é›ªå´© ä¸€è‡´æ€§ åŒå†™ä¸ä¸€è‡´ æ€§èƒ½ çƒ­ key / å¤§ key æ•°æ®å®‰å…¨ ä¸»ä»ä¸¢æ•°æ® è¿ç»´ OOM / ç¢ç‰‡ æ¶æ„ Cluster é™åˆ¶ å®‰å…¨ æœªæˆæƒè®¿é—® äº”ã€æ€»ç»“ Redis é™¤äº†ç¼“å­˜ä¸‰å¤§é—®é¢˜å¤–ï¼Œè¿˜å¸¸è§ç¼“å­˜ä¸€è‡´æ€§ã€çƒ­ç‚¹ keyã€å¤§ keyã€å†…å­˜æ·˜æ±°ã€ä¸»ä»å»¶è¿Ÿã€æŒä¹…åŒ–æŠ–åŠ¨ã€Cluster è·¨æ§½é™åˆ¶å’Œå®‰å…¨é—®é¢˜ã€‚\nåœ¨å¼€å‘ä¾§ä¸»è¦å…³æ³¨ä¸€è‡´æ€§å’Œçƒ­ç‚¹é—®é¢˜ï¼Œåœ¨è¿ç»´ä¾§é‡ç‚¹æ˜¯å†…å­˜ã€å¤åˆ¶å’ŒæŒä¹…åŒ–ï¼Œåœ¨æ¶æ„å±‚é¢è¦æ³¨æ„ Cluster å’Œé«˜å¯ç”¨è®¾è®¡ã€‚\n","description":"Redis é™¤äº†ä¸‰å¤§ç¼“å­˜é—®é¢˜ï¼Œè¿˜æœ‰å“ªäº›å¸¸è§é—®é¢˜ï¼Ÿ\næŒ‰ å¼€å‘é—®é¢˜ / è¿ç»´é—®é¢˜ / æ¶æ„é—®é¢˜ åˆ†ç±»ã€‚\nä¸€ã€å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆéå¸¸çˆ±é—®ï¼‰ 1ï¸âƒ£ ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼ˆğŸ”¥ å¿…è€ƒï¼‰ é—®é¢˜\nRedis å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ æ›´æ–°é¡ºåºé”™è¯¯å¯¼è‡´è„æ•°æ® å…¸å‹åœºæ™¯\næ›´æ–° DB æˆåŠŸ æ›´æ–° Redis å¤±è´¥ -\u0026gt; ç¼“å­˜æ˜¯æ—§å€¼ å¸¸è§æ–¹æ¡ˆ\næ–¹æ¡ˆ è¯´æ˜ å…ˆåˆ ç¼“å­˜å†å†™ DB âŒ å¹¶å‘ä¸‹å¯èƒ½å›å†™æ—§å€¼ å…ˆå†™ DB å†åˆ ç¼“å­˜ âœ… æœ€å¸¸ç”¨ å»¶è¿ŸåŒåˆ  âœ… MQ / Binlog âœ… é«˜é˜¶æ–¹æ¡ˆ 2ï¸âƒ£ çƒ­ç‚¹ Key é—®é¢˜ï¼ˆHot Keyï¼‰ é—®é¢˜\n"},{"id":79,"href":"/database/redis/cache-hit-ratio/","title":"Redis ç¼“å­˜å‘½ä¸­ç‡","parent":"Redis","content":"å†…å®¹ï¼šå®šä¹‰ -\u0026gt; ç»Ÿè®¡æ–¹å¼ -\u0026gt; Redis å®æˆ˜ -\u0026gt; ç”Ÿäº§å»ºè®®\nä¸€ã€ä»€ä¹ˆæ˜¯ç¼“å­˜å‘½ä¸­ç‡ï¼ˆCache Hit Ratioï¼‰ï¼Ÿ âœ… å®šä¹‰ ç¼“å­˜å‘½ä¸­ç‡ = å‘½ä¸­ç¼“å­˜çš„è¯·æ±‚æ•° Ã· æ€»è¯·æ±‚æ•°\nå…¬å¼ï¼š\nç¼“å­˜å‘½ä¸­ç‡ = hits / (hits + misses)\nhitï¼šè¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¿”å› missï¼šç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦è®¿é—® DB æˆ–åç«¯æœåŠ¡ âœ… ç›´è§‚ç†è§£ å‘½ä¸­ç‡é«˜ -\u0026gt; DB å‹åŠ›å°ã€ç³»ç»Ÿæ€§èƒ½å¥½ å‘½ä¸­ç‡ä½ -\u0026gt; ç¼“å­˜ä»·å€¼ä¸å¤§ï¼Œç”šè‡³æ˜¯è´Ÿæ‹… äºŒã€Redis ä¸­å¦‚ä½•ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡ï¼ˆé‡ç‚¹ï¼‰ æ–¹å¼ä¸€ï¼šRedis å†…ç½®ç»Ÿè®¡ï¼ˆæœ€æ ‡å‡†ã€æœ€å¸¸ç”¨ï¼‰ ğŸ” æŸ¥çœ‹å‘½ä¸­/æœªå‘½ä¸­æ¬¡æ•°\nredis-cli INFO stats å…³é”®å­—æ®µï¼š\nkeyspace_hits:123456 keyspace_misses:2345 ğŸ“Š è®¡ç®—å‘½ä¸­ç‡\nhit_ratio = keyspace_hits / (keyspace_hits + keyspace_misses)\nâœ… ç‰¹ç‚¹\nRedis å®˜æ–¹ç»Ÿè®¡ æ€§èƒ½æŸè€—æä½ å…¨å±€ç»Ÿè®¡ï¼ˆæ•´ä¸ªå®ä¾‹ï¼‰ âš ï¸ æ³¨æ„ï¼š\né‡å¯ Redis ä¼šæ¸…é›¶ æ— æ³•åŒºåˆ†ä¸šåŠ¡ã€æ¥å£ã€key ç±»å‹ æ–¹å¼äºŒï¼šåº”ç”¨å±‚ç»Ÿè®¡ï¼ˆä¸šåŠ¡çº§ï¼Œå¼ºçƒˆæ¨èï¼‰ æ€è·¯\nåœ¨ä»£ç ä¸­ç»Ÿè®¡ï¼š\nif (redis.get(key) != null): hit++ else: miss++ ä¼˜ç‚¹\nå¯ä»¥æŒ‰ï¼š æ¥å£ ä¸šåŠ¡æ¨¡å— key å‰ç¼€ ç”¨æˆ·ç»´åº¦ ç»Ÿè®¡æ›´ç²¾ç»† ç¼ºç‚¹\néœ€è¦æ”¹ä»£ç  ä¼šå¢åŠ ä¸€ç‚¹ç‚¹é€»è¾‘å¤æ‚åº¦ æ–¹å¼ä¸‰ï¼šRedis å‘½ä»¤ç›‘æ§ï¼ˆä¸æ¨èç”Ÿäº§ï¼‰ ä¾‹å­\nMONITOR\næˆ–\nslowlog get\nâŒ é—®é¢˜ï¼š\næ€§èƒ½å½±å“å¤§ åªé€‚åˆæ’æŸ¥é—®é¢˜ æ–¹å¼å››ï¼šç›‘æ§ç³»ç»Ÿï¼ˆç”Ÿäº§çº§æ–¹æ¡ˆï¼‰ å¸¸è§ç»„åˆ\nRedis INFO -\u0026gt; Exporter -\u0026gt; Prometheus -\u0026gt; Grafana äº‘å‚å•† Redis ç›‘æ§ å¸¸è§æŒ‡æ ‡\nredis_keyspace_hits_total redis_keyspace_misses_total å®æ—¶è®¡ç®—å‘½ä¸­ç‡ã€‚\nä¸‰ã€ç¼“å­˜å‘½ä¸­ç‡å¤šå°‘ç®—åˆç†ï¼Ÿ ä¸šåŠ¡ç±»å‹ æ¨èå‘½ä¸­ç‡ çƒ­ç‚¹è¯»å¤šå†™å°‘ 95%+ ä¸€èˆ¬ä¸šåŠ¡ 85% ~ 95% é«˜åŠ¨æ€æ•°æ® 70% ~ 85% \u0026lt; 70% éœ€è¦ä¼˜åŒ– å››ã€å‘½ä¸­ç‡ä½çš„å¸¸è§åŸå› ï¼ˆå¿…è€ƒï¼‰ 1ï¸âƒ£ key è®¾è®¡ä¸åˆç† key è¿‡äºåˆ†æ•£ ç¼ºä¹å‰ç¼€è§„èŒƒ 2ï¸âƒ£ TTL å¤ªçŸ­ key é¢‘ç¹è¿‡æœŸ å‘½ä¸­ç‡è¢«æ‹‰ä½ 3ï¸âƒ£ æ²¡æœ‰ç¼“å­˜çƒ­ç‚¹æ•°æ® çƒ­ç‚¹ç›´æ¥èµ° DB 4ï¸âƒ£ ç¼“å­˜ç©¿é€ / å‡»ç©¿ / é›ªå´© å¤§é‡ miss 5ï¸âƒ£ ä½¿ç”¨ Redis ä½†æ²¡æœ‰è¯»ç¼“å­˜ å†™äº†ç¼“å­˜ï¼Œä½†è¯»è·¯å¾„æ²¡ç”¨ äº”ã€å¦‚ä½•æå‡ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå®æˆ˜ï¼‰ 1ï¸âƒ£ çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ / é€»è¾‘è¿‡æœŸ é…ç½®ç±» / å­—å…¸ç±» / æƒé™ç±»\n2ï¸âƒ£ åˆç† TTL + éšæœºå€¼ TTL = base + random\n3ï¸âƒ£ ä½¿ç”¨ Hash / Pipeline å‡å°‘ key æ•°é‡ï¼Œæé«˜è®¿é—®æ•ˆç‡ã€‚\n4ï¸âƒ£ ä¸šåŠ¡å‰ç¼€èšåˆ user:profile:{id} user:stat:{id} å…­ã€æ€»ç»“ ç¼“å­˜å‘½ä¸­ç‡æ˜¯æŒ‡è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¿”å›çš„æ¯”ä¾‹ï¼Œé€šå¸¸ç”¨ hits / (hits + misses) è¡¨ç¤ºã€‚\nåœ¨ Redis ä¸­å¯ä»¥é€šè¿‡ INFO stats æŸ¥çœ‹ keyspace_hits å’Œ keyspace_misses æ¥ç»Ÿè®¡ï¼› åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ç»“åˆåº”ç”¨å±‚ç»Ÿè®¡æˆ– Prometheus ç›‘æ§è¿›è¡Œä¸šåŠ¡çº§åˆ†æã€‚\nå‘½ä¸­ç‡è¶Šé«˜ï¼Œè¯´æ˜ç¼“å­˜æ•ˆæœè¶Šå¥½ï¼Œä¸€èˆ¬æ ¸å¿ƒä¸šåŠ¡è¦æ±‚ 90% ä»¥ä¸Šã€‚\nä¸ƒã€å…¶å®ƒ Qï¼šRedis Cluster ä¸‹å‘½ä¸­ç‡æ€ä¹ˆç®—ï¼Ÿ\nğŸ‘‰ å„èŠ‚ç‚¹åˆ†åˆ«ç»Ÿè®¡ï¼Œå†èšåˆã€‚\nQï¼šå‘½ä¸­ç‡é«˜ä¸€å®šå¥½å—ï¼Ÿ\nğŸ‘‰ ä¸ä¸€å®šï¼Œå¯èƒ½ç¼“å­˜äº†æ— ç”¨æ•°æ®ï¼Œéœ€ç»“åˆ DB QPSã€‚\nQï¼šå¦‚ä½•åŒºåˆ†ç¼“å­˜æ— æ•ˆå’Œç¼“å­˜ç©¿é€ï¼Ÿ\nğŸ‘‰ ä¸šåŠ¡å±‚ç»Ÿè®¡ miss åŸå› ã€‚\n","description":"å†…å®¹ï¼šå®šä¹‰ -\u0026gt; ç»Ÿè®¡æ–¹å¼ -\u0026gt; Redis å®æˆ˜ -\u0026gt; ç”Ÿäº§å»ºè®®\nä¸€ã€ä»€ä¹ˆæ˜¯ç¼“å­˜å‘½ä¸­ç‡ï¼ˆCache Hit Ratioï¼‰ï¼Ÿ âœ… å®šä¹‰ ç¼“å­˜å‘½ä¸­ç‡ = å‘½ä¸­ç¼“å­˜çš„è¯·æ±‚æ•° Ã· æ€»è¯·æ±‚æ•°\nå…¬å¼ï¼š\nç¼“å­˜å‘½ä¸­ç‡ = hits / (hits + misses)\nhitï¼šè¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¿”å› missï¼šç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦è®¿é—® DB æˆ–åç«¯æœåŠ¡ âœ… ç›´è§‚ç†è§£ å‘½ä¸­ç‡é«˜ -\u0026gt; DB å‹åŠ›å°ã€ç³»ç»Ÿæ€§èƒ½å¥½ å‘½ä¸­ç‡ä½ -\u0026gt; ç¼“å­˜ä»·å€¼ä¸å¤§ï¼Œç”šè‡³æ˜¯è´Ÿæ‹… äºŒã€Redis ä¸­å¦‚ä½•ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡ï¼ˆé‡ç‚¹ï¼‰ æ–¹å¼ä¸€ï¼šRedis å†…ç½®ç»Ÿè®¡ï¼ˆæœ€æ ‡å‡†ã€æœ€å¸¸ç”¨ï¼‰ ğŸ” æŸ¥çœ‹å‘½ä¸­/æœªå‘½ä¸­æ¬¡æ•°\n"},{"id":80,"href":"/operations/vsftpd/core/","title":"vsftpd æ ¸å¿ƒæ¦‚å¿µ","parent":"vsftpd","content":" ä¸€ã€vsftpd æ˜¯ä»€ä¹ˆï¼Ÿ vsftpdï¼ˆVery Secure FTP Daemonï¼‰ æ˜¯ Linux ä¸Šæœ€å¸¸ç”¨çš„ FTP æœåŠ¡ç«¯ï¼Œä»¥ï¼š\nğŸ”’ å®‰å…¨æ€§é«˜ âš¡ æ€§èƒ½å¥½ â˜˜ï¸ æ¶æ„ç®€å•ã€å¯æ§ ğŸ§ é»˜è®¤å†…ç½®äºå¤šæ•°å‘è¡Œç‰ˆ è‘—ç§°ï¼Œå¹¿æ³›ç”¨äºï¼š\næ–‡ä»¶ä¸Šä¼  / ä¸‹è½½ è½¯ä»¶ä»“åº“ å†…ç½‘æ–‡ä»¶åˆ†å‘ è¿ç»´è‡ªåŠ¨åŒ–ï¼ˆå·²é€æ­¥è¢« SFTP å–ä»£ï¼‰ äºŒã€FTP åè®®åŸºç¡€ï¼ˆç†è§£ vsftpd çš„å‰æï¼‰ 1ï¸âƒ£ FTP çš„ä¸¤æ¡è¿æ¥ FTP ä¸æ˜¯å•è¿æ¥åè®®ï¼Œè€Œæ˜¯ï¼š\nè¿æ¥ç±»å‹ ç«¯å£ ä½œç”¨ æ§åˆ¶è¿æ¥ TCP 21 å‘é€å‘½ä»¤ï¼ˆUSER / PASS / LIST ç­‰ï¼‰ æ•°æ®è¿æ¥ éšæœºç«¯å£ å®é™…ä¼ è¾“æ–‡ä»¶æ•°æ® ğŸ‘‰ æ§åˆ¶è¿æ¥å§‹ç»ˆå­˜åœ¨ï¼Œæ•°æ®è¿æ¥æŒ‰éœ€å»ºç«‹\n2ï¸âƒ£ ä¸»åŠ¨æ¨¡å¼ï¼ˆPORTï¼‰ vs è¢«åŠ¨æ¨¡å¼ï¼ˆPASVï¼‰ ä¸»åŠ¨æ¨¡å¼ï¼ˆPORTï¼‰ å®¢æˆ·ç«¯éšæœºç«¯å£ -\u0026gt; æœåŠ¡ç«¯ 21 æœåŠ¡ç«¯ 20 -\u0026gt; å®¢æˆ·ç«¯éšæœºç«¯å£ âŒ é—®é¢˜ï¼š\nå®¢æˆ·ç«¯åœ¨ NAT / é˜²ç«å¢™åé¢å‡ ä¹ä¸å¯ç”¨ è¢«åŠ¨æ¨¡å¼ï¼ˆPASVï¼‰ã€ä¸»æµã€‘ å®¢æˆ·ç«¯ -\u0026gt; æœåŠ¡ç«¯ 21 å®¢æˆ·ç«¯ -\u0026gt; æœåŠ¡ç«¯ éšæœºç«¯å£ âœ… ä¼˜ç‚¹ï¼š\né˜²ç«å¢™å‹å¥½ äº‘ç¯å¢ƒ / NAT å¿…é¡»ä½¿ç”¨ ğŸ‘‰ vsftpd é»˜è®¤æ¨è PASV\nä¸‰ã€vsftpd çš„æ ¸å¿ƒè®¾è®¡ç†å¿µ 1ï¸âƒ£ â€œæœ€å°æƒé™ + æœ€å°æ”»å‡»é¢â€ vsftpd çš„è®¾è®¡ç›®æ ‡ï¼š\næ¯ä¸ªç”¨æˆ· å°½é‡è¿è¡Œåœ¨ç‹¬ç«‹ã€å—é™ç¯å¢ƒ ä¸¥æ ¼åŒºåˆ†ï¼š æœªè®¤è¯ç”¨æˆ· å·²è®¤è¯æœ¬åœ°ç”¨æˆ· è™šæ‹Ÿç”¨æˆ· 2ï¸âƒ£ è¿›ç¨‹æ¨¡å‹ï¼ˆéå¸¸é‡è¦ï¼‰ vsftpd ä½¿ç”¨ å¤šè¿›ç¨‹æ¨¡å‹ï¼ˆéå¤šçº¿ç¨‹ï¼‰ï¼š\nä¸»è¿›ç¨‹ â”œâ”€â”€ æ¥æ”¶è¿æ¥ â”œâ”€â”€ fork å­è¿›ç¨‹ â”œâ”€â”€ è®¤è¯ç”¨æˆ· â”œâ”€â”€ é™æƒ â””â”€â”€ å¤„ç†ä¼šè¯ ä¼˜ç‚¹ï¼š\nä¸€ä¸ªä¼šè¯å´©æºƒ â‰  æ•´ä¸ªæœåŠ¡å´©æºƒ æƒé™éš”ç¦»æ¸…æ™° æ›´å®‰å…¨ å››ã€vsftpd çš„ç”¨æˆ·ç±»å‹ï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ 1ï¸âƒ£ åŒ¿åç”¨æˆ·ï¼ˆanonymousï¼‰ ç”¨æˆ·åï¼šanonymous / ftp ä¸éœ€è¦ç³»ç»Ÿè´¦å· å…¸å‹åœºæ™¯ï¼š å…¬å…±ä¸‹è½½ç«™ é•œåƒä»“åº“ anonymous_enable=YES anon_root=/data/ftp âš ï¸ å®‰å…¨é£é™©é«˜ï¼Œç”Ÿäº§ä¸€èˆ¬å…³é—­\n2ï¸âƒ£ æœ¬åœ°ç”¨æˆ·ï¼ˆlocal userï¼‰ Linux ç³»ç»Ÿç”¨æˆ·ï¼ˆ/etc/passwdï¼‰ ä½¿ç”¨ç³»ç»Ÿè´¦å·ç™»å½• local_enable=YES write_enable=YES ğŸ“Œ ç‰¹ç‚¹ï¼š\næƒé™å—ç³»ç»Ÿæ§åˆ¶ é»˜è®¤å¯ chroot 3ï¸âƒ£ è™šæ‹Ÿç”¨æˆ·ï¼ˆvirtual userï¼‰ vsftpd è‡ªå·±ç»´æŠ¤ ä¸æ˜¯çœŸå®ç³»ç»Ÿç”¨æˆ· å¸¸è§åšæ³•ï¼š PAM + db æ–‡ä»¶ æ˜ å°„åˆ°ä¸€ä¸ªç³»ç»Ÿç”¨æˆ· ğŸ‘‰ ä¼ä¸šç”Ÿäº§æœ€å¸¸ç”¨\nä¼˜ç‚¹ï¼š\nä¸æ±¡æŸ“ç³»ç»Ÿè´¦å· æƒé™é«˜åº¦å¯æ§ æ‰¹é‡ç®¡ç†æ–¹ä¾¿ äº”ã€chrootï¼ˆç›‘ç‹±æœºåˆ¶ï¼‰ 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ chrootï¼Ÿ æŠŠç”¨æˆ· é™åˆ¶åœ¨æŸä¸ªç›®å½•å†…ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿå…¶å®ƒè·¯å¾„ï¼š\nç”¨æˆ·çœ‹åˆ°çš„ / -\u0026gt; å®é™…æ˜¯ /data/ftp/user1 2ï¸âƒ£ vsftpd ä¸­çš„ chroot chroot_local_user=YES æˆ–\nchroot_list_enable=YES chroot_list_file=/etc/vsftpd/chroot_list 3ï¸âƒ£ ä¸ºä»€ä¹ˆ vsftpd é»˜è®¤æ‹’ç»â€œå¯å†™ chrootâ€ï¼Ÿ å®‰å…¨åŸå› ï¼š\nç”¨æˆ·å¦‚æœèƒ½å†™è‡ªå·±æ‰€åœ¨çš„ chroot ç›®å½•ï¼Œ å¯èƒ½é€šè¿‡æ¼æ´é€ƒé€¸ã€‚ è§£å†³æ–¹æ¡ˆï¼ˆæ…ç”¨ï¼‰ï¼š\nallow_writeable_chroot=YES å…­ã€æƒé™æ§åˆ¶çš„æ ¸å¿ƒæœºåˆ¶ 1ï¸âƒ£ Linux æ–‡ä»¶æƒé™ï¼ˆæœ€ç»ˆç”Ÿæ•ˆï¼‰ vsftpd ä¸ç»•è¿‡ Linux æƒé™æ¨¡å‹ï¼š\næ–‡ä»¶å±ä¸» / å±ç»„ r / w / x umask local_umask=022 2ï¸âƒ£ vsftpd å†…éƒ¨å¼€å…³ â‰  å®é™…æƒé™ é…ç½® ä½œç”¨ write_enable=YES æ˜¯å¦å…è®¸å†™æ“ä½œ anon_upload_enable åŒ¿åç”¨æˆ·ä¸Šä¼  anon_delete_enable åŒ¿ååˆ é™¤ ğŸ‘‰ vsftpd å…è®¸ â‰  æ–‡ä»¶ç³»ç»Ÿå…è®¸\nä¸ƒã€PASV è¢«åŠ¨æ¨¡å¼æ ¸å¿ƒå‚æ•° pasv_enable=YES pasv_min_port=30000 pasv_max_port=31000 pasv_address=å…¬ç½‘IP ğŸ“Œ åŸç†ï¼š\næœåŠ¡ç«¯ä»ç«¯å£æ± ä¸­é€‰ä¸€ä¸ª å‘Šè¯‰å®¢æˆ·ç«¯è¿æ¥å“ªä¸ªç«¯å£ ğŸ‘‰ äº‘æœåŠ¡å™¨ / NAT / K8S ç¯å¢ƒ å¿…é¡»é…ç½®\nå…«ã€æ—¥å¿—ç³»ç»Ÿï¼ˆè¿ç»´å¿…è€ƒï¼‰ 1ï¸âƒ£ è®¿é—®æ—¥å¿— xferlog_enable=YES xferlog_std_format=YES å¸¸è§è·¯å¾„ï¼š\n/var/log/vsftpd.log /var/log/xferlog 2ï¸âƒ£ æ—¥å¿—å†…å®¹ ç™»å½•ç”¨æˆ· ä¸Šä¼  / ä¸‹è½½ æ–‡ä»¶å IP æ—¶é—´ ğŸ‘‰ å®‰å…¨å®¡è®¡ \u0026amp; é—®é¢˜æ’æŸ¥æ ¸å¿ƒä¾æ®\nä¹ã€vsftpd vs SFTPï¼ˆæ¦‚å¿µåŒºåˆ†ï¼‰ å¯¹æ¯”é¡¹ vsftpd (FTP) SFTP ç«¯å£ 21 + å¤šç«¯å£ 22 åŠ å¯† éœ€ FTPS åŸç”ŸåŠ å¯† é˜²ç«å¢™ å¤æ‚ ç®€å• æ¨èåœºæ™¯ å†…ç½‘ / å…¼å®¹ç³»ç»Ÿ ç°ä»£ç”Ÿäº§ç¯å¢ƒ ğŸ“Œ ç°ä»£ç”Ÿäº§ä¼˜å…ˆ SFTPï¼Œä½† vsftpd ä»å¤§é‡å­˜åœ¨\nåã€æ€»ç»“ vsftpd æ˜¯ä¸€ä¸ªä»¥â€œå®‰å…¨éš”ç¦»â€ä¸ºæ ¸å¿ƒè®¾è®¡æ€æƒ³çš„ FTP æœåŠ¡ï¼Œé€šè¿‡å¤šè¿›ç¨‹ã€chrootã€PAMã€ä¸¥æ ¼æƒé™æ¨¡å‹ï¼Œå®ç°é«˜æ€§èƒ½ã€å¯æ§çš„æ–‡ä»¶ä¼ è¾“æœåŠ¡ã€‚\n","description":" ä¸€ã€vsftpd æ˜¯ä»€ä¹ˆï¼Ÿ vsftpdï¼ˆVery Secure FTP Daemonï¼‰ æ˜¯ Linux ä¸Šæœ€å¸¸ç”¨çš„ FTP æœåŠ¡ç«¯ï¼Œä»¥ï¼š\nğŸ”’ å®‰å…¨æ€§é«˜ âš¡ æ€§èƒ½å¥½ â˜˜ï¸ æ¶æ„ç®€å•ã€å¯æ§ ğŸ§ é»˜è®¤å†…ç½®äºå¤šæ•°å‘è¡Œç‰ˆ è‘—ç§°ï¼Œå¹¿æ³›ç”¨äºï¼š\næ–‡ä»¶ä¸Šä¼  / ä¸‹è½½ è½¯ä»¶ä»“åº“ å†…ç½‘æ–‡ä»¶åˆ†å‘ è¿ç»´è‡ªåŠ¨åŒ–ï¼ˆå·²é€æ­¥è¢« SFTP å–ä»£ï¼‰ äºŒã€FTP åè®®åŸºç¡€ï¼ˆç†è§£ vsftpd çš„å‰æï¼‰ 1ï¸âƒ£ FTP çš„ä¸¤æ¡è¿æ¥ FTP ä¸æ˜¯å•è¿æ¥åè®®ï¼Œè€Œæ˜¯ï¼š\n"},{"id":81,"href":"/operations/zabbix/zabbix-vs-prometheus-grafana/","title":"Zabbix vs Prometheus + Grafana","parent":"Zabbix","content":" 1. æ ¸å¿ƒç»“è®ºï¼ˆæ€»ç»“ï¼‰ Zabbix = å…¨é¢ã€ä¼ ç»Ÿã€å…¨èƒ½å‹ç›‘æ§å¹³å°ï¼ˆé‡åœ¨å¯ç”¨æ€§ã€å‘Šè­¦ã€åˆ†å¸ƒå¼è®¾å¤‡ç›‘æ§ï¼‰ Prometheus = ç°ä»£äº‘åŸç”Ÿç›‘æ§æ ‡å‡†ï¼ˆé‡åœ¨æŒ‡æ ‡ã€Kubernetesã€å¾®æœåŠ¡ï¼‰ Grafana = å¯è§†åŒ–å±•ç¤ºï¼ˆä¸æ˜¯ç›‘æ§ç³»ç»Ÿï¼‰ã€‚\n2. æ¶æ„å¯¹æ¯” ç‰¹æ€§ Zabbix Prometheus é‡‡é›†æ–¹å¼ Agent + SNMP + Proxy Exporter / Pull å­˜å‚¨ å…³ç³»å‹æ•°æ®åº“ï¼ˆPostgreSQL/MySQLï¼‰ TSDBï¼ˆå†…ç½®æ—¶é—´åºåˆ—åº“ï¼‰ åˆ†å¸ƒå¼ Proxy åˆ†å¸ƒå¼æ¶æ„ ä½¿ç”¨å¤šä¸ª Prom/Thanos/Federation å¯ç”¨æ€§ å¼ºï¼ˆProxy æ”¯æ’‘ï¼‰ é»˜è®¤ä¸æ”¯æŒ HAï¼Œéœ€è¦ Thanos å¯è§†åŒ– è‡ªå¸¦åŸºç¡€å›¾è¡¨ + Grafana ä¸»è¦ä¾èµ– Grafana æ•°æ®æ¨¡å‹ ä¼ ç»Ÿç›‘æ§ æ—¶åºç›‘æ§ï¼ˆæ ‡ç­¾ Labelï¼‰ 3. æ•°æ®é‡‡é›†å¯¹æ¯” Zabbix æ”¯æŒå¤šç§é‡‡é›†æ–¹å¼ï¼š\nZabbix Agent / Agent2 SNMP v1/2/3ï¼ˆè®¾å¤‡ç›‘æ§æœ€å¼ºï¼‰ IPMI JMX SSH/Telnet HTTP Agent Trapperï¼ˆæ¨é€ï¼‰ é€‚åˆï¼š\nç½‘ç»œè®¾å¤‡ å­˜å‚¨è®¾å¤‡ åŸºç¡€è®¾æ–½ æ“ä½œç³»ç»Ÿ Prometheus æ•°æ®é‡‡é›†æ–¹å¼ï¼ˆç°ä»£äº‘åŸç”Ÿï¼‰\nExporterï¼ˆNode exporter, MySQL exporter ç­‰ï¼‰ Pull HTTP /metrics Pushgatewayï¼ˆéæ¨èï¼‰ Service discoveryï¼ˆK8Sã€Consul ç­‰è‡ªåŠ¨å‘ç°ï¼‰ é€‚åˆï¼š\nå®¹å™¨ / K8S å¾®æœåŠ¡ äº‘åŸç”Ÿåº”ç”¨ 4. æ•°æ®å­˜å‚¨å¯¹æ¯” æŒ‡æ ‡ Zabbix Prometheus æ¶æ„ RDBï¼ˆPostgreSQLï¼‰ å†…ç½® TSDB æŸ¥è¯¢è¯­è¨€ SQL PromQLï¼ˆåŠŸèƒ½å¼ºå¤§ï¼‰ é•¿æœŸå­˜å‚¨ TimescaleDB Thanos / Cortex / Mimir æ€§èƒ½ ä¸­é«˜ è¶…é«˜ï¼ˆç™¾ä¸‡çº§æ—¶åºï¼‰ Prometheus çš„ TSDB åœ¨å†™å…¥å’ŒæŸ¥è¯¢æ€§èƒ½ä¸Šæ¯” Zabbix å¼ºå¤ªå¤šã€‚\n5. å‘Šè­¦ä½“ç³»å¯¹æ¯” Zabbix çš„å‘Šè­¦ï¼ˆéå¸¸å¼ºï¼‰\nå†…ç½®å†å²æ•°æ®ã€è§¦å‘å™¨ã€äº‹ä»¶ å‘Šè­¦æ˜¯é¡¶çº§èƒ½åŠ› Actionã€Escalationã€å¤šæ­¥éª¤é€šçŸ¥ å¤šæ¸ é“ï¼ˆWebhookã€é‚®ä»¶ã€è„šæœ¬ï¼‰ å‘Šè­¦æŠ‘åˆ¶ä¸ç»´æŠ¤çª—å£ Prometheus å‘Šè­¦\nä¾èµ– Alertmanagerï¼š\nåˆ†ç»„ï¼ˆGroupï¼‰ æŠ‘åˆ¶ï¼ˆInhibitï¼‰ é™é»˜ï¼ˆSilenceï¼‰ Webhook é€šçŸ¥ Zabbix å‘Šè­¦é…ç½®ç®€æ´ï¼Œä½†çµæ´»æ€§ä¸å¦‚ Alertmanagerã€‚\n6. å¯è§†åŒ–å¯¹æ¯” é¡¹ç›® Zabbix Prometheus + Grafana UI è‡ªå¸¦ Web UI éœ€è¦ Grafana å›¾è¡¨ ä¸€èˆ¬ æä½³ Dashboard æ¨¡å‹ æ¨¡æ¿åŒ–ã€ä½†ä¸å¦‚ Grafana çµæ´» æå…¶çµæ´»ï¼Œå¯å˜é‡ã€PromQL å¦‚æœè¿½æ±‚è§†è§‰æ•ˆæœï¼šGrafana èƒœå‡ºã€‚\n7. æ‰©å±•æ€§å¯¹æ¯” Zabbixï¼š\nå•å®ä¾‹é™åˆ¶æ˜æ˜¾ï¼ˆæ•°æ®åº“è´Ÿè½½ï¼‰ Proxy æ¶æ„å¯æ‰©å±• 10k+ è®¾å¤‡éœ€è¦è¾ƒå¼ºæ•°æ®åº“ Prometheusï¼š\né€šè¿‡ Thanos / Cortexï¼š\næ— é™æ‰©å±• è·¨åœ°åŸŸé‡‡é›† ç»Ÿä¸€æŸ¥è¯¢ å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSS/MinIOï¼‰é•¿æœŸå½’æ¡£ Prometheus æ‰©å±•æ€§è¿œå¼ºäº Zabbixã€‚\n8. ä½¿ç”¨æˆæœ¬å¯¹æ¯” å†…å®¹ Zabbix Prometheus å­¦ä¹ æˆæœ¬ ä¸­ï¼ˆè€ç³»ç»Ÿ + å¤šåŠŸèƒ½ï¼‰ é«˜ï¼ˆPromQL å‡çº§éš¾ç‚¹ï¼‰ ç»´æŠ¤ ä¸­ é«˜ï¼ˆå¤šä¸ªç»„ä»¶ï¼‰ æ¶æ„å¤æ‚åº¦ ä¸­ é«˜ï¼ˆProm + Alert + Grafana + Thanosï¼‰ éƒ¨ç½²éš¾åº¦ ä½-ä¸­ ä¸­-é«˜ 9. é€‚ç”¨åœºæ™¯å¯¹æ¯”ï¼ˆé‡ç‚¹ï¼‰ âœ” Zabbix é€‚ç”¨åœºæ™¯ï¼ˆéå¸¸å¼ºï¼‰\næœåŠ¡å™¨ + ç½‘ç»œè®¾å¤‡ + å­˜å‚¨è®¾å¤‡ç»Ÿä¸€ç›‘æ§ ä¼ ç»Ÿä¼ä¸š IDC é‡‘èã€ç”µä¿¡ã€æ”¿åºœç­‰å¯¹å‘Šè­¦è¦æ±‚æé«˜çš„åœºæ™¯ è·¨æœºæˆ¿ç›‘æ§ï¼ˆProxyï¼‰ éœ€è¦å¯¹ SNMP è®¾å¤‡æ·±åº¦ç›‘æ§ â€œå¯ç”¨æ€§ç›‘æ§ + æ„ŸçŸ¥ç›‘æ§â€ Zabbix æ›´å¼ºã€‚\nâœ” Prometheus é€‚ç”¨åœºæ™¯ï¼ˆæœ€ä½³ï¼‰\nKubernetes å®¹å™¨ + å¾®æœåŠ¡ éœ€è¦è¶…å¼ºæ—¶åºæ•°æ®åˆ†æ æ•°æ®æŒ‡æ ‡å¤æ‚ã€æ ‡ç­¾ç»´åº¦é«˜ å¤§è§„æ¨¡äº‘åŸç”ŸæŒ‡æ ‡ç›‘æ§ â€œæ€§èƒ½ç›‘æ§ + æ—¶åºåˆ†æâ€ Prometheus æ›´å¼ºã€‚\n10. ä»€ä¹ˆæ—¶å€™åº”è¯¥é€‰è°ï¼Ÿ âœ” é€‰ Zabbix çš„æƒ…å†µ\nä½ æœ‰å¤§é‡çš„ ç½‘ç»œè®¾å¤‡ã€äº¤æ¢æœºã€è·¯ç”±å™¨ã€å­˜å‚¨ å¸Œæœ›éƒ¨ç½² ç®€å•ï¼Œæœ€ä½³ä¸€ä½“åŒ–å¹³å° å‘Šè­¦ç­–ç•¥éå¸¸å¤š æƒ³ç”¨ Proxy åšè·¨æœºæˆ¿å®¹ç¾ å¸Œæœ›ç»Ÿä¸€ç®¡ç†èµ„äº§ã€äº‹ä»¶ã€å‘Šè­¦ âœ” é€‰ Prometheus çš„æƒ…å†µ\nå¤§é‡ Kubernetes é›†ç¾¤ å¾®æœåŠ¡æ¶æ„ é«˜ç»´åº¦ Label éœ€è¦æŸ¥è¯¢åˆ†æ æƒ³å¯æ‰©å±•åˆ° PB çº§ æƒ³ç”¨ Grafana ç»Ÿä¸€é¢æ¿ âœ” ä¸¤ä¸ªä¸€èµ·ç”¨ï¼ˆç°ä»£ä¼ä¸šå¸¸æ€ï¼‰\nç°å®ä¸­ 70% ä¼ä¸šé‡‡ç”¨ Zabbix + Prometheus Monitoring Stackï¼š\nZabbix -\u0026gt; è®¾å¤‡ \u0026amp; OS ç›‘æ§ï¼ˆå‘Šè­¦å¼ºï¼‰ Prometheus + Grafana -\u0026gt; åº”ç”¨ \u0026amp; å®¹å™¨ç›‘æ§ï¼ˆæŒ‡æ ‡å¼ºï¼‰ 11. æ€»ç»“ é¡¹ç›® Zabbix Prometheus æœ€æ“…é•¿ è®¾å¤‡ç›‘æ§ + å‘Šè­¦ æ—¶åºæ•°æ® + K8S æ¶æ„ å•ä½“ + Proxy å¤šç»„ä»¶ + äº‘åŸç”Ÿ æ•°æ®é‡‡é›† å¤šåè®®ï¼ˆSNMP/Agentï¼‰ Pull + Exporter å¯æ‰©å±•æ€§ ä¸­ è¶…é«˜ æ•°æ®æŸ¥è¯¢ SQL PromQL å¯è§†åŒ– ä¸€èˆ¬ Grafana å¼º éƒ¨ç½²éš¾åº¦ ä½ä¸­ ä¸­é«˜ å‘Šè­¦ç³»ç»Ÿ å¼º ä¸­ç­‰ï¼ˆé  Alertmanagerï¼‰ æœ€ä½³é€‚ç”¨ ä¼ ç»Ÿ IT äº‘åŸç”Ÿ ","description":" 1. æ ¸å¿ƒç»“è®ºï¼ˆæ€»ç»“ï¼‰ Zabbix = å…¨é¢ã€ä¼ ç»Ÿã€å…¨èƒ½å‹ç›‘æ§å¹³å°ï¼ˆé‡åœ¨å¯ç”¨æ€§ã€å‘Šè­¦ã€åˆ†å¸ƒå¼è®¾å¤‡ç›‘æ§ï¼‰ Prometheus = ç°ä»£äº‘åŸç”Ÿç›‘æ§æ ‡å‡†ï¼ˆé‡åœ¨æŒ‡æ ‡ã€Kubernetesã€å¾®æœåŠ¡ï¼‰ Grafana = å¯è§†åŒ–å±•ç¤ºï¼ˆä¸æ˜¯ç›‘æ§ç³»ç»Ÿï¼‰ã€‚\n2. æ¶æ„å¯¹æ¯” ç‰¹æ€§ Zabbix Prometheus é‡‡é›†æ–¹å¼ Agent + SNMP + Proxy Exporter / Pull å­˜å‚¨ å…³ç³»å‹æ•°æ®åº“ï¼ˆPostgreSQL/MySQLï¼‰ TSDBï¼ˆå†…ç½®æ—¶é—´åºåˆ—åº“ï¼‰ åˆ†å¸ƒå¼ Proxy åˆ†å¸ƒå¼æ¶æ„ ä½¿ç”¨å¤šä¸ª Prom/Thanos/Federation å¯ç”¨æ€§ å¼ºï¼ˆProxy æ”¯æ’‘ï¼‰ é»˜è®¤ä¸æ”¯æŒ HAï¼Œéœ€è¦ Thanos å¯è§†åŒ– è‡ªå¸¦åŸºç¡€å›¾è¡¨ + Grafana ä¸»è¦ä¾èµ– Grafana æ•°æ®æ¨¡å‹ ä¼ ç»Ÿç›‘æ§ æ—¶åºç›‘æ§ï¼ˆæ ‡ç­¾ Labelï¼‰ 3. æ•°æ®é‡‡é›†å¯¹æ¯” Zabbix æ”¯æŒå¤šç§é‡‡é›†æ–¹å¼ï¼š\n"},{"id":82,"href":"/operations/zabbix/tutorial/","title":"Zabbix åŸºç¡€æ•™ç¨‹","parent":"Zabbix","content":" 1. Zabbix æ˜¯ä»€ä¹ˆï¼Ÿ Zabbix æ˜¯ä¸€ä¸ª å¼€æºä¼ä¸šçº§ç›‘æ§å¹³å°ï¼Œæ”¯æŒå¯¹æœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€åº”ç”¨ã€å®¹å™¨ã€æ•°æ®åº“ç­‰è¿›è¡Œç›‘æ§ï¼Œæ”¯æŒä¸»åŠ¨ä¸è¢«åŠ¨æ”¶é›†ã€è‡ªåŠ¨å‘ç°ã€å‘Šè­¦ã€å¯è§†åŒ–ã€è”åŠ¨åŠ¨ä½œã€‚\né€‚ç”¨èŒƒå›´ï¼š\nä¼ä¸šç›‘æ§ç³»ç»Ÿ ä¸»æœºã€åº”ç”¨ã€ç½‘ç»œè®¾å¤‡ç›‘æ§ ä¸šåŠ¡å¯ç”¨æ€§ç›‘æ§ å¤æ‚åœºæ™¯è‡ªåŠ¨å‘ç°ï¼ˆè‡ªåŠ¨åˆ›å»ºä¸»æœº/ç›‘æ§é¡¹ï¼‰ 2. Zabbix æ ¸å¿ƒæ¶æ„ +----------+ +---------------+ | Agent | \u0026lt;---\u0026gt; | Zabbix Server | +----------+ +-------+-------+ | +------+------+ | Database | +-------------+ | +------+------+ | Frontend | +-------------+ ç»„ä»¶è¯´æ˜ï¼š\nZabbix Serverï¼šæ ¸å¿ƒï¼Œæ”¶é›†ã€åˆ†æã€å­˜å‚¨æ•°æ®ã€‚ Zabbix Agent / Agent2ï¼šå®‰è£…åœ¨è¢«ç›‘æ§ä¸»æœºä¸Šã€‚ Zabbix Proxyï¼šä¸­é—´èŠ‚ç‚¹ï¼Œç”¨äºåˆ†å¸ƒå¼ã€å¤šæœºæˆ¿ç¯å¢ƒã€‚ Zabbix Frontendï¼šå‰ç«¯ Web UIã€‚ Databaseï¼šMySQL / PostgreSQLï¼ˆæ¨èï¼‰ï¼Œå­˜å‚¨æ‰€æœ‰æŒ‡æ ‡æ•°æ®ã€‚ 3. ç›‘æ§ç±»å‹ 3.1 ä¸»æœºç›‘æ§ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ ç£ç›˜IO è¿›ç¨‹æ•° ç³»ç»Ÿè´Ÿè½½ ç³»ç»Ÿæ—¥å¿— 3.2 åº”ç”¨ç›‘æ§ Nginx / Apache / MySQL / Redis / PostgreSQL / Kafka ç­‰ æ”¯æŒ ODBCã€HTTPã€SNMPã€JMX 3.3 ç½‘ç»œç›‘æ§ SNMPï¼ˆäº¤æ¢æœºã€è·¯ç”±å™¨ï¼‰ ICMP Ping TCP ç«¯å£å¯ç”¨æ€§ 3.4 ä¸»åŠ¨è½®è¯¢ HTTPã€TCPã€UDP é€šä¿¡æ£€æŸ¥ 3.5 è‡ªåŠ¨å‘ç° LLDï¼ˆLow Level Discoveryï¼‰ è‡ªåŠ¨å‘ç°ç£ç›˜ã€ç½‘å¡ã€æ•°æ®åº“è¡¨ã€å®¹å™¨ç­‰ è‡ªåŠ¨æ·»åŠ ä¸»æœºã€ç›‘æ§é¡¹ 4. æ ¸å¿ƒæ¦‚å¿µï¼šHostã€Itemã€Triggerã€Actionã€Media åç§° ä½œç”¨ Host è¢«ç›‘æ§ä¸»æœºï¼ˆLinux/Windows/è®¾å¤‡ï¼‰ Item ç›‘æ§é¡¹ï¼ˆCPU loadã€free memoryã€net.if.inï¼‰ Trigger å‘Šè­¦é˜ˆå€¼ï¼ˆå†…å­˜ \u0026lt;20%ã€ç£ç›˜ \u0026gt;80%ï¼‰ Action å‘Šè­¦åŠ¨ä½œï¼ˆå‘é‚®ä»¶ã€å¾®ä¿¡ã€é’‰é’‰ï¼‰ Event å­˜åœ¨å¼‚å¸¸å°±ç”Ÿæˆäº‹ä»¶ Media å‘Šè­¦æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€WebHookã€ä¼ä¸šå¾®ä¿¡ 5. æ¨¡æ¿ä½“ç³» æ¨¡æ¿åŒ…æ‹¬ï¼š\nç›‘æ§é¡¹ï¼ˆItemï¼‰ è§¦å‘å™¨ï¼ˆTriggerï¼‰ å›¾å½¢ï¼ˆGraphï¼‰ è‡ªåŠ¨å‘ç°è§„åˆ™ï¼ˆLLDï¼‰ é¢„å¤„ç†è§„åˆ™ï¼ˆPreprocessingï¼‰ å®˜æ–¹æ¨¡æ¿ï¼ˆæ¨èï¼‰ï¼š\nTemplate OS Linux Template App MySQL Template App Zabbix Agent Template Net Cisco SNMP æ¨¡æ¿ç»‘å®šåˆ°ä¸»æœºåè‡ªåŠ¨åˆ›å»ºç›‘æ§é¡¹ã€‚\n6. å®‰è£…éƒ¨ç½²ï¼ˆå¿«é€Ÿç‰ˆï¼‰ 6.1 æ¨èï¼šPostgreSQL + Nginx + PHP + Zabbix Server ç¤ºä¾‹ï¼ˆUbuntuï¼‰ï¼š\napt install postgresql nginx php php-fpm php-pgsql apt install zabbix-server-pgsql zabbix-frontend-php \\ zabbix-agent2 zabbix-sql-scripts zcat /usr/share/zabbix-sql-scripts/postgresql/create.sql.gz \\ | sudo -u postgres psql zabbix systemctl start zabbix-server zabbix-agent2 nginx php-fpm systemctl enable zabbix-server zabbix-agent2 7. Zabbix Agent vs Agent2ï¼ˆæ¨èä½¿ç”¨ Agent2ï¼‰ æ¯”è¾ƒé¡¹ Agent Agent2ï¼ˆæ¨èï¼‰ æ€§èƒ½ æ™®é€š æ›´é«˜ï¼ˆGo å®ç°ï¼‰ æ’ä»¶ ä¸æ”¯æŒ æ”¯æŒå¤šæ’ä»¶ï¼ˆMySQLã€Redisï¼‰ æŒ‡æ ‡ æ™®é€š æ›´å¼º æ‰©å±•æ€§ å¼± å¼º 8. é«˜çº§ç›‘æ§åŠŸèƒ½ 8.1 åª’ä½“é€šçŸ¥ï¼ˆé‚®ä»¶/å¾®ä¿¡/é’‰é’‰/é£ä¹¦ï¼‰ ä¼ä¸šå¾®ä¿¡ WebHook é’‰é’‰æœºå™¨äºº é£ä¹¦æœºå™¨äºº Telegram é‚®ä»¶ SMTP 8.2 Web ç›‘æ§ æ¨¡æ‹Ÿç™»å½• HTTP çŠ¶æ€ç æ£€æŸ¥ é¡µé¢å†…å®¹æ£€æŸ¥ 8.3 ä¸»åŠ¨+è¢«åŠ¨æ··åˆç›‘æ§ è¢«åŠ¨ç›‘æ§ï¼šServer è½®è¯¢ Agent ä¸»åŠ¨ç›‘æ§ï¼šAgent ä¸»åŠ¨å‘é€æ•°æ® 8.4 Zabbix Scriptï¼ˆSSHã€Telnetã€è·³æ¿æœºï¼‰ å¯é€šè¿‡ï¼š\nSSH Telnet æ‰§è¡Œè¿œç¨‹å‘½ä»¤å¹¶è§£æç»“æœã€‚\n9. Proxy åˆ†å¸ƒå¼æ¶æ„ é€‚ç”¨äºï¼š\nå¤šæœºæˆ¿ / å¤šåŒºåŸŸ ç½‘ç»œéš”ç¦» é›†ä¸­ç®¡ç† Proxy ä¼šï¼š\næ”¶é›†æ•°æ® ç¼“å­˜ æ‰¹é‡ä¸Šä¼ åˆ° Server é™ä½ Server å‹åŠ› éå¸¸é€‚åˆ VM æ•°é‡å¤§çš„ç¯å¢ƒã€‚\n10. Zabbix æ€§èƒ½ä¼˜åŒ– 10.1 Database æ€§èƒ½è‡³å…³é‡è¦ æŒ‚è½½ SSD è°ƒå¤§ PostgreSQL shared_buffersï¼ˆæ¨è 25% å†…å­˜ï¼‰ è°ƒæ•´ autovacuum å‚æ•° åˆ†åŒºè¡¨ï¼ˆå¦‚æœå†å²æ•°æ®é‡å¤§ï¼‰ 10.2 Housekeeper è‡ªåŠ¨æ¸…ç† å»ºè®®å…³é—­è‡ªåŠ¨æ¸…ç†ï¼š\nHousekeepingFrequency=0 æ”¹ä¸ºæ‰‹åŠ¨åˆ†åŒºè¡¨ç»´æŠ¤ã€‚\n10.3 ä½¿ç”¨ Proxy åˆ†æ‹…è´Ÿè½½ é¿å…æ‰€æœ‰ Agent éƒ½æ‰“åˆ° Serverã€‚\n10.4 å‹ç¼©å†å²æ•°æ® PostgreSQLï¼šä½¿ç”¨ TimescaleDB MySQLï¼šä½¿ç”¨ InnoDB COMPRESS ğŸŸ¦ 11. æ•…éšœæ’æŸ¥ï¼ˆæœ€å¸¸è§ï¼‰ 11.1 Agent æœªä¸Šçº¿ æ’æŸ¥ï¼š\nzabbix_agent2 -t system.cpu.load telnet host 10050 11.2 æ— æ³•è¿æ¥æ•°æ®åº“ æ£€æŸ¥ï¼š\npsql -U zabbix æŸ¥çœ‹ Zabbix server æ—¥å¿— /var/log/zabbix/zabbix_server.log\n11.3 è§¦å‘å™¨é¢‘ç¹æ³¢åŠ¨ åŸå› ï¼š\né˜ˆå€¼è®¾ç½®è¿‡ä½ æ•°æ®å˜åŒ–å¤ªå¿« æ²¡æœ‰ä½¿ç”¨ hysteresisï¼ˆè¿Ÿæ»ï¼‰ è§£å†³ï¼š\nè®¾ç½® hysteresis ä½¿ç”¨ç§»åŠ¨å¹³å‡ 12. Zabbix æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§ï¼‰ 12.1 å¼ºçƒˆå»ºè®®ä½¿ç”¨å®˜æ–¹æ¨¡æ¿ é¿å…è‡ªå·±å†™å¤æ‚ Itemã€‚\n12.2 æ•°æ®åº“å­˜å‚¨ç­–ç•¥ ä¿ç•™ 30 å¤©å†å² ä½¿ç”¨åˆ†åŒºè¡¨æˆ– TimescaleDB 12.3 ä½¿ç”¨ Proxy å¤§è§„æ¨¡ç¯å¢ƒå¿…é¡»ç”¨ Proxy 12.4 è‡ªå®šä¹‰ç›‘æ§ç”¨ UserParameter æˆ– Agent2 Plugin ä¸å»ºè®®ç”¨å¤–éƒ¨è„šæœ¬å¤ªå¤šã€‚\n12.5 å‘Šè­¦ä½¿ç”¨ WebHook æ¯”é‚®ä»¶å¯é å¾—å¤šã€‚\n12.6 ä¸»æœºä½¿ç”¨è‡ªåŠ¨å‘ç°ï¼ˆLLDï¼‰ ä¾‹å¦‚ï¼š\nè‡ªåŠ¨å‘ç°ç½‘å¡ è‡ªåŠ¨å‘ç°æŒ‚è½½ç›˜ è‡ªåŠ¨å‘ç°å®¹å™¨ 13. ä¼ä¸šçº§éƒ¨ç½²æ¶æ„æ¨èï¼ˆä¸‡çº§ç›‘æ§ï¼‰ +------------------------+ | Frontend | +-----------+------------+ | +-----------v------------+ | Zabbix Server é›†ç¾¤ | | (Active-Passive HA) | +-----------+------------+ | +-------+--------+ | | +---v---+ +---v---+ |Proxy1 | |Proxy2 | +---+---+ +---+---+ | | +---v---+ +---v---+ | Agents| | Agents| +-------+ +-------+ ","description":" 1. Zabbix æ˜¯ä»€ä¹ˆï¼Ÿ Zabbix æ˜¯ä¸€ä¸ª å¼€æºä¼ä¸šçº§ç›‘æ§å¹³å°ï¼Œæ”¯æŒå¯¹æœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€åº”ç”¨ã€å®¹å™¨ã€æ•°æ®åº“ç­‰è¿›è¡Œç›‘æ§ï¼Œæ”¯æŒä¸»åŠ¨ä¸è¢«åŠ¨æ”¶é›†ã€è‡ªåŠ¨å‘ç°ã€å‘Šè­¦ã€å¯è§†åŒ–ã€è”åŠ¨åŠ¨ä½œã€‚\né€‚ç”¨èŒƒå›´ï¼š\nä¼ä¸šç›‘æ§ç³»ç»Ÿ ä¸»æœºã€åº”ç”¨ã€ç½‘ç»œè®¾å¤‡ç›‘æ§ ä¸šåŠ¡å¯ç”¨æ€§ç›‘æ§ å¤æ‚åœºæ™¯è‡ªåŠ¨å‘ç°ï¼ˆè‡ªåŠ¨åˆ›å»ºä¸»æœº/ç›‘æ§é¡¹ï¼‰ 2. Zabbix æ ¸å¿ƒæ¶æ„ +----------+ +---------------+ | Agent | \u0026lt;---\u0026gt; | Zabbix Server | +----------+ +-------+-------+ | +------+------+ | Database | +-------------+ | +------+------+ | Frontend | +-------------+ ç»„ä»¶è¯´æ˜ï¼š\n"},{"id":83,"href":"/operations/zabbix/core/","title":"Zabbix æ ¸å¿ƒæ¦‚å¿µ","parent":"Zabbix","content":" ä¸€ã€Zabbix æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ Zabbix = åŸºäºäº‹ä»¶é©±åŠ¨çš„é›†ä¸­å¼ç›‘æ§ç³»ç»Ÿ\næ ¸å¿ƒç›®æ ‡åªæœ‰ä¸‰ä»¶äº‹ï¼š\né‡‡é›†æ•°æ®ï¼ˆMonitoringï¼‰ åˆ¤æ–­çŠ¶æ€ï¼ˆTrigger / Eventï¼‰ äº§ç”ŸåŠ¨ä½œï¼ˆAlert / Actionï¼‰ ä¸€å¥è¯å…¬å¼ï¼š\næ•°æ®ï¼ˆItemï¼‰ -\u0026gt; åˆ¤æ–­ï¼ˆTriggerï¼‰ -\u0026gt; äº‹ä»¶ï¼ˆEventï¼‰ -\u0026gt; åŠ¨ä½œï¼ˆActionï¼‰\näºŒã€æ•´ä½“æ¶æ„ä¸å·¥ä½œæ¨¡å‹ 1ï¸âƒ£ Zabbix é€»è¾‘æ¶æ„ [ Host ] â†“ [ Item ] -\u0026gt; æ•°æ® â†“ [ Trigger ] -\u0026gt; çŠ¶æ€åˆ¤æ–­ â†“ [ Event ] -\u0026gt; çŠ¶æ€å˜åŒ– â†“ [ Action ] -\u0026gt; é€šçŸ¥ / è„šæœ¬ è¿™æ˜¯ Zabbix çš„æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ã€‚\n2ï¸âƒ£ ç»„ä»¶æ¶æ„ Agent / SNMP / HTTP â†“ Zabbix Server â†“ Database â†“ Frontend Zabbix Serverï¼šè°ƒåº¦ã€è®¡ç®—ã€åˆ¤æ–­ä¸­å¿ƒ Databaseï¼šäº‹å®æ¥æºï¼ˆSingle Source of Truthï¼‰ Frontendï¼šå±•ç¤ºä¸é…ç½®å…¥å£ Zabbix æ˜¯ Server + DB å¼ºè€¦åˆç³»ç»Ÿ\nä¸‰ã€æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆæœ€é‡è¦ï¼‰ 1ï¸âƒ£ Hostï¼ˆä¸»æœºï¼‰ Host = è¢«ç›‘æ§å¯¹è±¡çš„æŠ½è±¡\nå¯ä»¥æ˜¯ï¼š\nç‰©ç†æœº è™šæ‹Ÿæœº å®¹å™¨ ç½‘ç»œè®¾å¤‡ ä¸€ç»„æœåŠ¡ï¼ˆé€»è¾‘ä¸»æœºï¼‰ Host åªæ˜¯ä¸€ä¸ªâ€œå®¹å™¨â€ï¼Œæœ¬èº«ä¸é‡‡é›†æ•°æ®\n2ï¸âƒ£ Itemï¼ˆç›‘æ§é¡¹ï¼‰ Item = æ•°æ®é‡‡é›†å®šä¹‰\nå†³å®šï¼š\né‡‡é›†ä»€ä¹ˆ æ€ä¹ˆé‡‡é›† å¤šä¹…é‡‡é›†ä¸€æ¬¡ ç¤ºä¾‹ï¼š\nsystem.cpu.load[percpu,avg1] vfs.fs.size[/,pfree] Item ä¸‰è¦ç´ ï¼š\nKeyï¼ˆé‡‡é›†ä»€ä¹ˆï¼‰ Intervalï¼ˆå¤šä¹…é‡‡ä¸€æ¬¡ï¼‰ Typeï¼ˆæ€ä¹ˆé‡‡ï¼‰ 3ï¸âƒ£ Item Typeï¼ˆé‡‡é›†æ–¹å¼ï¼‰ å¸¸è§ç±»å‹ï¼š\nZabbix agent / agent(active) SNMP HTTP agent External check Trapper Dependent item ç†è®ºé‡ç‚¹ï¼š\nItem type å†³å®šäº†æ•°æ®æµå‘ï¼ˆpull / pushï¼‰\n4ï¸âƒ£ Triggerï¼ˆè§¦å‘å™¨ï¼‰ Trigger = å¯¹ Item æ•°æ®çš„é€»è¾‘åˆ¤æ–­\næœ¬è´¨ï¼š\nä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼ˆTrue / Falseï¼‰ ç¤ºä¾‹ï¼š\navg(5m) \u0026gt; 80 last() \u0026lt; 20 Trigger åªå…³å¿ƒï¼š\nå½“å‰çŠ¶æ€æ˜¯å¦å¼‚å¸¸ æ˜¯å¦å‘ç”Ÿâ€œçŠ¶æ€å˜åŒ–â€ 5ï¸âƒ£ Eventï¼ˆäº‹ä»¶ï¼‰ Event = Trigger çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„ç¬é—´\nOK -\u0026gt; PROBLEM PROBLEM -\u0026gt; OK Zabbix æ˜¯äº‹ä»¶é©±åŠ¨ç³»ç»Ÿï¼Œä¸æ˜¯è½®è¯¢å‘Šè­¦\n6ï¸âƒ£ Actionï¼ˆåŠ¨ä½œï¼‰ Action = å¯¹ Event çš„å“åº”ç­–ç•¥\nå¯ä»¥åšï¼š\nå‘é€å‘Šè­¦ æ‰§è¡Œè„šæœ¬ è‡ªåŠ¨ä¿®å¤ å‡çº§é€šçŸ¥ï¼ˆEscalationï¼‰ å››ã€æ•°æ®é‡‡é›†åŸç†ï¼ˆæ ¸å¿ƒç†è®ºï¼‰ 1ï¸âƒ£ Pull vs Push æ¨¡å‹ è¢«åŠ¨ï¼ˆPullï¼‰ Server -\u0026gt; Agent\nServer ä¸»åŠ¨æ‹‰å–æ•°æ® é˜²ç«å¢™å¤æ‚æ—¶ä¸å‹å¥½ ä¸»åŠ¨ï¼ˆPushï¼‰ Agent -\u0026gt; Server\nAgent ä¸»åŠ¨æ¨é€ äº‘ç¯å¢ƒ / å®¹å™¨é¦–é€‰ 2ï¸âƒ£ Poller çº¿ç¨‹æ¨¡å‹ï¼ˆServer å†…éƒ¨ï¼‰ Zabbix Server æ˜¯å¤šè¿›ç¨‹æ¨¡å‹ï¼š\nè¿›ç¨‹ ä½œç”¨ poller æ‹‰ agent æ•°æ® http poller HTTP æ£€æŸ¥ discoverer è‡ªåŠ¨å‘ç° pinger ICMP trapper æ¥æ”¶æ¨é€ alerter å‘é€å‘Šè­¦ housekeeper æ¸…ç†å†å² ç†è®ºè¦ç‚¹ï¼š\næ€§èƒ½ç“¶é¢ˆ = poller + DB\näº”ã€æ¨¡æ¿ä¸ç»§æ‰¿æ¨¡å‹ 1ï¸âƒ£ Templateï¼ˆæ¨¡æ¿ï¼‰ Template = Item + Trigger + Graph çš„é›†åˆ\næ¨¡æ¿çš„æ„ä¹‰ï¼š\nå¤ç”¨ æ ‡å‡†åŒ– æ‰¹é‡ç®¡ç† 2ï¸âƒ£ æ¨¡æ¿ç»§æ‰¿ Template OS Linux â†‘ Template App MySQL â†‘ Host Host å¯ä»¥ç»§æ‰¿å¤šä¸ªæ¨¡æ¿ æ¨¡æ¿ä¹‹é—´ä¹Ÿå¯ç»§æ‰¿ 3ï¸âƒ£ LLDï¼ˆä½çº§åˆ«è‡ªåŠ¨å‘ç°ï¼‰ LLD = åŠ¨æ€åˆ›å»º Item / Trigger\nåŸç†ï¼š\nå…ˆå‘ç°å¯¹è±¡ å†ç”Ÿæˆç›‘æ§é¡¹åŸå‹ å¸¸ç”¨äºï¼š\nç£ç›˜ ç½‘å¡ å®¹å™¨ æ•°æ®åº“è¡¨ å…­ã€æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼ˆåº•å±‚é€»è¾‘ï¼‰ 1ï¸âƒ£ History vs Trends ç±»å‹ å†…å®¹ ç”¨é€” history åŸå§‹æ•°æ® ç²¾ç»†åˆ†æ trends èšåˆæ•°æ® é•¿æœŸå±•ç¤º Zabbix é»˜è®¤ï¼š\nhistoryï¼šç§’çº§ trendsï¼šå°æ—¶çº§ 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¦è¶‹åŠ¿è¡¨ï¼Ÿ æ•°æ®åº“å†™å…¥é‡æŒ‡æ•°çº§å¢é•¿\nè¶‹åŠ¿è¡¨ = é™ç»´å­˜å‚¨\nä¸ƒã€å‘Šè­¦ç³»ç»Ÿç†è®ºï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ å‘Šè­¦ä¸æ˜¯æ•°æ®å¼‚å¸¸ Item é‡‡é›†çš„æ˜¯æ•°æ® Trigger åˆ¤æ–­çš„æ˜¯çŠ¶æ€ Event æ‰æ˜¯â€œå‘Šè­¦äº‹ä»¶â€ 2ï¸âƒ£ å‘Šè­¦æŠ–åŠ¨çš„æœ¬è´¨ æ•°æ®æ³¢åŠ¨ â‰  çŠ¶æ€å˜åŒ–\nè§£å†³æ‰‹æ®µï¼š\nå¹³æ»‘ï¼ˆavg / minï¼‰ è¿Ÿæ»ï¼ˆhysteresisï¼‰ æ—¶é—´çª—å£ å…«ã€Proxy çš„ç†è®ºæ„ä¹‰ Proxy æœ¬è´¨æ˜¯ï¼š\nè¾¹ç¼˜é‡‡é›†èŠ‚ç‚¹ æ•°æ®ç¼“å†²å™¨ Server çš„æ‰©å±• Agent -\u0026gt; Proxy -\u0026gt; Server\nç†è®ºä»·å€¼ï¼š\né™ä½ Server å‹åŠ› æé«˜ç¨³å®šæ€§ æ”¯æŒåˆ†å¸ƒå¼ ä¹ã€Zabbix çš„è®¾è®¡å“²å­¦ 1ï¸âƒ£ å¼ºä¸€è‡´æ€§ä¼˜å…ˆ æ•°æ®å¿…é¡»è½åº“ çŠ¶æ€å¿…é¡»å¯è¿½æº¯ 2ï¸âƒ£ å‘Šè­¦æ˜¯ç¬¬ä¸€å…¬æ°‘ äº‹ä»¶é©±åŠ¨ å¤šçº§ Escalation 3ï¸âƒ£ é¢å‘åŸºç¡€è®¾æ–½ è®¾å¤‡ / OS / ç½‘ç»œä¼˜å…ˆ äº‘åŸç”Ÿä¸æ˜¯æœ€å¼ºé¡¹ åã€å’Œ Prometheus çš„æœ¬è´¨åŒºåˆ«ï¼ˆç†è®ºçº§ï¼‰ ç»´åº¦ Zabbix Prometheus æ ¸å¿ƒ äº‹ä»¶ æŒ‡æ ‡ æ¨¡å‹ Host -\u0026gt; Item Label å­˜å‚¨ RDB TSDB å‘Šè­¦ å†…ç½® Alertmanager é€‚ç”¨ ä¼ ç»Ÿ IT äº‘åŸç”Ÿ åä¸€ã€æ€»ç»“ Zabbix æ˜¯â€œä»¥äº‹ä»¶ä¸ºä¸­å¿ƒâ€çš„ä¼ ç»Ÿç›‘æ§ç³»ç»Ÿï¼Œæ“…é•¿åŸºç¡€è®¾æ–½ã€è®¾å¤‡å’Œå‘Šè­¦ç®¡ç†ï¼›\nPrometheus æ˜¯â€œä»¥æŒ‡æ ‡ä¸ºä¸­å¿ƒâ€çš„äº‘åŸç”Ÿç›‘æ§ç³»ç»Ÿï¼Œæ“…é•¿æ—¶åºæ•°æ®åˆ†æã€‚\n","description":" ä¸€ã€Zabbix æ˜¯ä»€ä¹ˆï¼ˆæœ¬è´¨ï¼‰ Zabbix = åŸºäºäº‹ä»¶é©±åŠ¨çš„é›†ä¸­å¼ç›‘æ§ç³»ç»Ÿ\næ ¸å¿ƒç›®æ ‡åªæœ‰ä¸‰ä»¶äº‹ï¼š\né‡‡é›†æ•°æ®ï¼ˆMonitoringï¼‰ åˆ¤æ–­çŠ¶æ€ï¼ˆTrigger / Eventï¼‰ äº§ç”ŸåŠ¨ä½œï¼ˆAlert / Actionï¼‰ ä¸€å¥è¯å…¬å¼ï¼š\næ•°æ®ï¼ˆItemï¼‰ -\u0026gt; åˆ¤æ–­ï¼ˆTriggerï¼‰ -\u0026gt; äº‹ä»¶ï¼ˆEventï¼‰ -\u0026gt; åŠ¨ä½œï¼ˆActionï¼‰\näºŒã€æ•´ä½“æ¶æ„ä¸å·¥ä½œæ¨¡å‹ 1ï¸âƒ£ Zabbix é€»è¾‘æ¶æ„ [ Host ] â†“ [ Item ] -\u0026gt; æ•°æ® â†“ [ Trigger ] -\u0026gt; çŠ¶æ€åˆ¤æ–­ â†“ [ Event ] -\u0026gt; çŠ¶æ€å˜åŒ– â†“ [ Action ] -\u0026gt; é€šçŸ¥ / è„šæœ¬ è¿™æ˜¯ Zabbix çš„æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ã€‚\n"},{"id":84,"href":"/operations/jenkins/deploy/","title":"Jenkins éƒ¨ç½²","parent":"Jenkins","content":" åŸºç¡€ç¯å¢ƒ ç³»ç»Ÿï¼šAlmaLinux 9.6 Javaï¼š21.0.9 Jenkinsï¼š2.528.3 Jenkins å®˜æ–¹å®‰è£…æ–‡æ¡£ï¼šInstalling Jenkins\nä¸»è¦æ–‡æ¡£ï¼šWAR file æŸ¥çœ‹ Java è¦æ±‚ï¼šJava Support Policy\nè¿™é‡Œéƒ¨ç½² Jenkins LTSï¼ˆç‰ˆæœ¬å·ï¼š2.528.3ï¼‰ï¼Œä½¿ç”¨ Java 21ï¼ˆç‰ˆæœ¬å·ï¼š21.0.9ï¼‰ éƒ¨ç½² JDK æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬å·ï¼šJava Downloads cd /data/septvean/bash/java bash -x deploy-jdk-21.sh 21.0.9 /usr/local/jdk/21.0.9/bin/java -version # java version \u0026#34;21.0.9\u0026#34; 2025-10-21 LTS # Java(TM) SE Runtime Environment (build 21.0.9+7-LTS-338) # Java HotSpot(TM) 64-Bit Server VM (build 21.0.9+7-LTS-338, mixed mode, sharing) éƒ¨ç½² Jenkins æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬å·ï¼šJenkins Downloads # å®‰è£…ä¾èµ–åŒ… dnf install -y git git-core dejavu-sans-fonts fontconfig freetype xorg-x11-server-Xvfb # åˆ›å»ºç”¨æˆ· useradd -r -s /sbin/nologin jenkins # åˆ›å»ºç›®å½• # app: Jenkins WaråŒ… ç›®å½• # builder: ç¼–è¯‘å·¥å…· ç›®å½• # data: Jenkins HOME ç›®å½• # log: Jenkins æ—¥å¿— mkdir -pv /data/jenkins/{app,builder,data,log} # è®¾ç½®ä»£ç† # export http_proxy=http://192.168.101.200:1080; export https_proxy=http://192.168.101.200:1080; # ä¸‹è½½ War åŒ… cd /data/jenkins/app wget -c -O jenkins-2.528.3.war https://get.jenkins.io/war-stable/2.528.3/jenkins.war ln -svf jenkins-2.528.3.war jenkins.war # åˆ›å»ºæ—¥å¿—æ–‡ä»¶ touch /data/jenkins/log/{error.log,run.log} # è®¾ç½®æƒé™ chown -R jenkins:jenkins /data/jenkins # è®¾ç½®ç¯å¢ƒå˜é‡ # export JENKINS_HOME=\u0026#39;/data/jenkins/data\u0026#39; # å¯åŠ¨ (ç«¯å£ 8200, å‰ç¼€ /jenkins) ç”¨äºæµ‹è¯• # /usr/local/jdk/21.0.9/bin/java \\ # -jar jenkins.war \\ # --httpPort=8200 \\ # --prefix=/jenkins # å…¶å®ƒå‚æ•° # java -jar jenkins.war --help # åˆ›å»º service # # httpListenAddress è®¾ç½®ä¸º 0.0.0.0 # httpPort è®¾ç½®ä¸º 8200 # # æˆ–è€… httpListenAddress è®¾ç½®ä¸º 127.0.0.1, ä½¿ç”¨ Nginx åå‘ä»£ç† # # ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=127.0.0.1 --httpPort=8200 --prefix=/jenkins tee /etc/systemd/system/jenkins.service \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; [Unit] Description=Jenkins Server After=network.target [Service] Type=simple User=jenkins Group=jenkins # ç¯å¢ƒå˜é‡ Environment=\u0026#34;JENKINS_HOME=/data/jenkins/data\u0026#34; Environment=\u0026#34;JAVA_OPTS=\u0026#39;-server -Xmx512 -Xms256m\u0026#39;\u0026#34; # å·¥ä½œç›®å½• WorkingDirectory=/data/jenkins/app # å¯åŠ¨å‘½ä»¤ ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=0.0.0.0 --httpPort=8200 # æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ StandardOutput=append:/data/jenkins/log/run.log StandardError=append:/data/jenkins/log/error.log # è‡ªåŠ¨é‡å¯ç­–ç•¥ Restart=always RestartSec=5s # é™åˆ¶ï¼ˆå¯é€‰ï¼‰ LimitNOFILE=65536 [Install] WantedBy=multi-user.target EOF # åˆ›å»ºæœåŠ¡ systemctl daemon-reload systemctl start jenkins systemctl status jenkins # â— jenkins.service - Jenkins Server # Loaded: loaded (/etc/systemd/system/jenkins.service; disabled; preset: disabled) # Active: active (running) since Sat 2026-01-03 21:59:00 CST; 4s ago # Main PID: 3822 (java) # Tasks: 32 (limit: 209715) # Memory: 254.4M (peak: 254.4M) # CPU: 7.262s # CGroup: /system.slice/jenkins.service # â””â”€3822 /usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=0.0.0.0 --httpPort=8200 # Jan 03 21:59:00 node-201.server.com systemd[1]: Started Jenkins Server. # æŸ¥çœ‹ Jenkins æ—¥å¿— journalctl -u jenkins -f # è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable jenkins è®¿é—®ï¼šhttp://192.168.101.201:8200/\nå¦‚æœæ·»åŠ äº† --prefix=/jenkins å‚æ•°ï¼Œåˆ™è®¿é—® http://192.168.101.201:8200/jenkins/ Nginx é…ç½® location /jenkins { # ä»£ç† proxy_pass http://127.0.0.1:8200; # ä¿®æ­£ Jenkins è¿”å›çš„é‡å®šå‘è·¯å¾„ proxy_redirect 127.0.0.1 $scheme://$host/jenkins; # è®¾ç½®è¯·æ±‚å¤´ proxy_set_header Host $host:$server_port; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; # WebSocket proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; # è¶…æ—¶è®¾ç½® proxy_connect_timeout 3s; proxy_send_timeout 300s; proxy_read_timeout 300s; # å…³é—­ä»£ç†ç¼“å†² proxy_buffering off; } Nginx åŠ è½½é…ç½®\nnginx -t nginx -s reload è®¿é—®ï¼šhttps://devops.v2ep.com/jenkins/\nåˆå§‹åŒ– Jenkins ç®¡ç†å‘˜å¯†ç  cat /data/jenkins/data/secrets/initialAdminPassword å¦‚æœæç¤ºç¦»çº¿ï¼Œæ·»åŠ  HTTP ä»£ç†ã€‚\nè‡ªå®šä¹‰ Jenkinsï¼šé€‰æ‹©æ’ä»¶æ¥å®‰è£… Organization and Administration Dashboard View Folders OWASP Markup Formatter Build Features Build Name and Description Setter Build Timeout Credentials Binding Timestamper Workspace Cleanup Build Tools å…¨ä¸é€‰ Build Analysis and Reporting é»˜è®¤ (å…¨ä¸é€‰) Pipelines and Continuous Delivery Pipeline Pipeline Graph View Conditional BuildStep Parameterized Trigger Copy Artifact Source Code Management Git Git Parameter GitLab Distributed Builds å•æœºï¼šå…¨ä¸é€‰ é›†ç¾¤ï¼šMatrix Project User Management and Security Matrix Authorization Strategy PAM Authentication Role-based Authorization Strategy Notifications and Publishing é»˜è®¤ Appearance å…¨ä¸é€‰ Languages Locale åƒä¸‡ä¸è¦é€‰æ‹© Localization: Chinese (Simplified) !! å®‰è£… åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ· ä¸åˆ›å»º -\u0026gt; \u0026ldquo;ä½¿ç”¨adminè´¦æˆ·ç»§ç»­\u0026rdquo; å®ä¾‹é…ç½®\nJenkins URLï¼šæ ¹æ®æƒ…å†µä¿®æ”¹ (é»˜è®¤) ä¿å­˜å¹¶å®Œæˆ å¼€å§‹ä½¿ç”¨ Jenkins Manage Jenkins\nBuilding on the built-in node can be a security issue. You should set up distributed builds. See the documentation. Dismissï¼ˆå¿½ç•¥ï¼‰ System Configuration -\u0026gt; System Usage Statistics (ä½¿ç”¨ç»Ÿè®¡) âŒ Help make Jenkins better by sending anonymous usage statistics and crash reports to the Jenkins project System Configuration -\u0026gt; Appearance Default Languageï¼šUse Default Locale - English (United States) (en_US) âœ… Ignore browser preference and force this language to all users âœ… Allow all users to use their own language preference admin\nSecurity -\u0026gt; Password é‡å¯ Jenkins\nsystemctl restart jenkins æˆ–è€…ï¼šhttps://documents.v2ep.com/jenkins/restart æ’ä»¶ æ¨èå®‰è£…ä»¥ä¸‹æ’ä»¶ï¼š\nBlue Ocean Pipeline: Stage View Plugin æ›´æ–° Jenkins cd /data/jenkins/app/ ls -al wget -c -O jenkins-2.528.3.war https://updates.jenkins.io/download/war/2.528.3/jenkins.war ln -svf jenkins-2.528.3.war jenkins.war chown -R jenkins:jenkins jenkins.* systemctl restart jenkins.service ","description":" åŸºç¡€ç¯å¢ƒ ç³»ç»Ÿï¼šAlmaLinux 9.6 Javaï¼š21.0.9 Jenkinsï¼š2.528.3 Jenkins å®˜æ–¹å®‰è£…æ–‡æ¡£ï¼šInstalling Jenkins\nä¸»è¦æ–‡æ¡£ï¼šWAR file æŸ¥çœ‹ Java è¦æ±‚ï¼šJava Support Policy\nè¿™é‡Œéƒ¨ç½² Jenkins LTSï¼ˆç‰ˆæœ¬å·ï¼š2.528.3ï¼‰ï¼Œä½¿ç”¨ Java 21ï¼ˆç‰ˆæœ¬å·ï¼š21.0.9ï¼‰ éƒ¨ç½² JDK æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬å·ï¼šJava Downloads cd /data/septvean/bash/java bash -x deploy-jdk-21.sh 21.0.9 /usr/local/jdk/21.0.9/bin/java -version # java version \u0026#34;21.0.9\u0026#34; 2025-10-21 LTS # Java(TM) SE Runtime Environment (build 21.0.9+7-LTS-338) # Java HotSpot(TM) 64-Bit Server VM (build 21.0.9+7-LTS-338, mixed mode, sharing) éƒ¨ç½² Jenkins æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬å·ï¼šJenkins Downloads # å®‰è£…ä¾èµ–åŒ… dnf install -y git git-core dejavu-sans-fonts fontconfig freetype xorg-x11-server-Xvfb # åˆ›å»ºç”¨æˆ· useradd -r -s /sbin/nologin jenkins # åˆ›å»ºç›®å½• # app: Jenkins WaråŒ… ç›®å½• # builder: ç¼–è¯‘å·¥å…· ç›®å½• # data: Jenkins HOME ç›®å½• # log: Jenkins æ—¥å¿— mkdir -pv /data/jenkins/{app,builder,data,log} # è®¾ç½®ä»£ç† # export http_proxy=http://192.168.101.200:1080; export https_proxy=http://192.168.101.200:1080; # ä¸‹è½½ War åŒ… cd /data/jenkins/app wget -c -O jenkins-2.528.3.war https://get.jenkins.io/war-stable/2.528.3/jenkins.war ln -svf jenkins-2.528.3.war jenkins.war # åˆ›å»ºæ—¥å¿—æ–‡ä»¶ touch /data/jenkins/log/{error.log,run.log} # è®¾ç½®æƒé™ chown -R jenkins:jenkins /data/jenkins # è®¾ç½®ç¯å¢ƒå˜é‡ # export JENKINS_HOME=\u0026#39;/data/jenkins/data\u0026#39; # å¯åŠ¨ (ç«¯å£ 8200, å‰ç¼€ /jenkins) ç”¨äºæµ‹è¯• # /usr/local/jdk/21.0.9/bin/java \\ # -jar jenkins.war \\ # --httpPort=8200 \\ # --prefix=/jenkins # å…¶å®ƒå‚æ•° # java -jar jenkins.war --help # åˆ›å»º service # # httpListenAddress è®¾ç½®ä¸º 0.0.0.0 # httpPort è®¾ç½®ä¸º 8200 # # æˆ–è€… httpListenAddress è®¾ç½®ä¸º 127.0.0.1, ä½¿ç”¨ Nginx åå‘ä»£ç† # # ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=127.0.0.1 --httpPort=8200 --prefix=/jenkins tee /etc/systemd/system/jenkins.service \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; [Unit] Description=Jenkins Server After=network.target [Service] Type=simple User=jenkins Group=jenkins # ç¯å¢ƒå˜é‡ Environment=\u0026#34;JENKINS_HOME=/data/jenkins/data\u0026#34; Environment=\u0026#34;JAVA_OPTS=\u0026#39;-server -Xmx512 -Xms256m\u0026#39;\u0026#34; # å·¥ä½œç›®å½• WorkingDirectory=/data/jenkins/app # å¯åŠ¨å‘½ä»¤ ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=0.0.0.0 --httpPort=8200 # æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ StandardOutput=append:/data/jenkins/log/run.log StandardError=append:/data/jenkins/log/error.log # è‡ªåŠ¨é‡å¯ç­–ç•¥ Restart=always RestartSec=5s # é™åˆ¶ï¼ˆå¯é€‰ï¼‰ LimitNOFILE=65536 [Install] WantedBy=multi-user.target EOF # åˆ›å»ºæœåŠ¡ systemctl daemon-reload systemctl start jenkins systemctl status jenkins # â— jenkins.service - Jenkins Server # Loaded: loaded (/etc/systemd/system/jenkins.service; disabled; preset: disabled) # Active: active (running) since Sat 2026-01-03 21:59:00 CST; 4s ago # Main PID: 3822 (java) # Tasks: 32 (limit: 209715) # Memory: 254.4M (peak: 254.4M) # CPU: 7.262s # CGroup: /system.slice/jenkins.service # â””â”€3822 /usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpListenAddress=0.0.0.0 --httpPort=8200 # Jan 03 21:59:00 node-201.server.com systemd[1]: Started Jenkins Server. # æŸ¥çœ‹ Jenkins æ—¥å¿— journalctl -u jenkins -f # è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable jenkins è®¿é—®ï¼šhttp://192.168.101.201:8200/\n"},{"id":85,"href":"/operations/kubernetes/core-components/","title":"Kubernetes æ ¸å¿ƒç»„ä»¶","parent":"Kubernetes","content":"å®˜æ–¹æ–‡æ¡£ï¼šKubernetes ç»„ä»¶\nKubernetes æ ¸å¿ƒç»„ä»¶åŠŸèƒ½ä»‹ç»\næ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Planeï¼‰ èŠ‚ç‚¹ç»„ä»¶ï¼ˆNode Componentsï¼‰ ç½‘ç»œç»„ä»¶ï¼ˆCNI / DNSï¼‰ æ‰©å±•ç»„ä»¶ï¼ˆé™„å¸¸è§ï¼‰ âœ… 1. æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰ ä¸»è¦èŒè´£\nå¯¹å¤–æ¥å£ï¼šæä¾›ç»Ÿä¸€çš„APIè®¿é—®å…¥å£ï¼ˆAPI Serverï¼‰ã€‚ ç®¡ç†é›†ç¾¤çŠ¶æ€ï¼šæ¥æ”¶ç”¨æˆ·æ“ä½œï¼ˆé€šè¿‡API Serverï¼‰ï¼Œç›‘æ§é›†ç¾¤å˜åŒ–ï¼Œç¡®ä¿å®é™…çŠ¶æ€ç¬¦åˆæœŸæœ›çŠ¶æ€ï¼ˆController Managerï¼‰ã€‚ èµ„æºè°ƒåº¦ï¼šå°† Podï¼ˆå·¥ä½œè´Ÿè½½ï¼‰æ™ºèƒ½åœ°åˆ†é…åˆ°åˆé€‚çš„ Worker Node ä¸Šï¼ˆSchedulerï¼‰ã€‚ æ•°æ®å­˜å‚¨ï¼šå­˜å‚¨æ‰€æœ‰é›†ç¾¤é…ç½®å’ŒçŠ¶æ€æ•°æ®ï¼ˆetcdï¼‰ã€‚ ğŸŸ¦ 1. kube-apiserverï¼ˆAPI æœåŠ¡å™¨ï¼‰ ğŸ‘‰ æ•´ä¸ª Kubernetes çš„ä¸­å¿ƒï¼Œä¸­æ¢ç¥ç»ï¼Œæ‰€æœ‰ç»„ä»¶äº¤äº’éƒ½ç»è¿‡å®ƒã€‚\nåŠŸèƒ½\næ‰€æœ‰ kubectl / API è°ƒç”¨çš„å…¥å£ è®¤è¯ã€é‰´æƒã€å®¡è®¡ æ‰€æœ‰å¯¹è±¡çš„ è¯»å†™ã€æ ¡éªŒ æ•°æ®å­˜å…¥ etcd Watch æœºåˆ¶ï¼šç»™æ§åˆ¶å™¨ \u0026amp; kubelet ç­‰æä¾›èµ„æºå˜æ›´äº‹ä»¶ ç‰¹ç‚¹\nåªæœ‰å®ƒå¯ç›´æ¥è®¿é—® etcd æ— çŠ¶æ€ï¼Œå¯æ¨ªå‘æ‰©å®¹ï¼ˆHA æ¨¡å¼ï¼‰ æä¾› REST API ğŸŸ¦ 2. kube-controller-managerï¼ˆæ§åˆ¶å™¨ç®¡ç†å™¨ï¼‰ ğŸ‘‰ è¿è¡Œæ‰€æœ‰æ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰ï¼Œç¡®ä¿å®é™…çŠ¶æ€ -\u0026gt; æœŸæœ›çŠ¶æ€\nåŒ…å«çš„æ§åˆ¶å™¨ï¼ˆéƒ¨åˆ†ï¼‰\nNode Controllerï¼šèŠ‚ç‚¹ä¸Šä¸‹çº¿æ£€æµ‹ Deployment Controllerï¼šæ‰©ç¼©å®¹ã€å‰¯æœ¬ç®¡ç† ReplicaSet Controller Job Controller EndpointSlice Controller Service Account Controller PVC / PV ç»‘å®šæ§åˆ¶å™¨ Namespace æ§åˆ¶å™¨ æ€»ç»“\nâ¡ï¸ k8s ä¸­æ‰€æœ‰ â€œè‡ªåŠ¨ä¿®å¤ / è‡ªåŠ¨åˆ›å»º / è‡ªåŠ¨æ›´æ–°â€ çš„é€»è¾‘éƒ½æ¥è‡ªå®ƒã€‚\nğŸŸ¦ 3. kube-schedulerï¼ˆè°ƒåº¦å™¨ï¼‰ ğŸ‘‰ è´Ÿè´£ Pod çš„è°ƒåº¦å†³ç­–ï¼ˆPod åˆ†é…åˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼‰\næ ¸å¿ƒèƒ½åŠ›\nè¿‡æ»¤ï¼ˆFilterï¼‰ï¼šå…ˆç­›æ‰ä¸ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ï¼ˆèµ„æºä¸è¶³ã€æ±¡ç‚¹ä¸åŒ¹é…ç­‰ï¼‰ æ‰“åˆ†ï¼ˆScoreï¼‰ï¼šç»™å‰©ä½™èŠ‚ç‚¹è¯„åˆ†ï¼ˆåˆ©ç”¨ç‡ã€æ‹“æ‰‘ã€äº²å’Œæ€§ï¼‰ ç»‘å®šï¼ˆBindï¼‰ï¼šæŠŠ Pod ç»‘å®šåˆ°èŠ‚ç‚¹ ç‰¹æ€§\næ”¯æŒè‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ã€è°ƒåº¦æ¡†æ¶ï¼ˆpluginsï¼‰ æ”¯æŒå¤šè°ƒåº¦å™¨ ğŸŸ¦ 4. etcdï¼ˆé”®å€¼æ•°æ®åº“ï¼‰ ğŸ‘‰ å­˜å‚¨ Kubernetes æ‰€æœ‰çŠ¶æ€ï¼ˆé…ç½®ã€èŠ‚ç‚¹ã€Podã€Serviceï¼‰ã€‚\nç‰¹ç‚¹ï¼š\nå¼ºä¸€è‡´æ€§ã€åˆ†å¸ƒå¼æ•°æ®åº“ï¼ˆRaft åè®®ï¼‰ éœ€è¦ä¸‰èŠ‚ç‚¹æˆ–äº”èŠ‚ç‚¹é›†ç¾¤ä¿è¯å¯é æ€§ æ‰€æœ‰ control-plane ç»„ä»¶ä¾èµ–å®ƒ âœ… 2. èŠ‚ç‚¹ç»„ä»¶ï¼ˆNode Componentsï¼‰ ğŸŸ© 1. kubelet ğŸ‘‰ æ¯ä¸ª node çš„æ ¸å¿ƒä»£ç†ï¼Œè´Ÿè´£ Pod ç”Ÿå‘½å‘¨æœŸã€‚\nåŠŸèƒ½\næ¥æ”¶æ¥è‡ª scheduler åˆ†é…çš„ Pod é€šè¿‡å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainerd/cri-oï¼‰å¯åŠ¨å®¹å™¨ å¥åº·æ£€æŸ¥ï¼ˆliveness / readiness / startupï¼‰ æ—¥å¿— \u0026amp; æŒ‡æ ‡ä¸ŠæŠ¥ èŠ‚ç‚¹çŠ¶æ€ä¸ŠæŠ¥ç»™ API server ç‰¹ç‚¹\nä»… ç®¡ç†è¢« API åˆ†é…åˆ°è¯¥èŠ‚ç‚¹çš„ Pod èƒ½æ‰§è¡Œ CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰ ğŸŸ© 2. kube-proxyï¼ˆèŠ‚ç‚¹ç½‘ç»œä»£ç†ï¼ŒIPTables/IPVSï¼‰ ğŸ‘‰ è´Ÿè´£ Service è´Ÿè½½å‡è¡¡å®ç°ï¼ˆclusterIP / nodePortï¼‰\næ¨¡å¼\næ¨¡å¼ æè¿° ä¼˜ç‚¹ ç¼ºç‚¹ iptables åˆ©ç”¨ NAT è¡¨å®ç°è½¬å‘ æ€§èƒ½ç¨³å®š è§„åˆ™å¤šæ—¶å˜æ…¢ IPVS Linux IP Virtual Server æ€§èƒ½æ›´é«˜ éœ€è¦å†…æ ¸æ¨¡å— åŠŸèƒ½\nç»´æŠ¤ Service -\u0026gt; EndpointSlice çš„è½¬å‘è¡¨ è´Ÿè´£ nodePort å®ç° æä¾› round-robinã€æœ€å°‘è¿æ¥ç­‰ç­–ç•¥ï¼ˆIPVS æ¨¡å¼ï¼‰ âš ï¸ è‹¥å¯ç”¨ Calico eBPF -\u0026gt; éƒ¨åˆ† iptables/Service è½¬å‘ç”± eBPF æ¥ç®¡ï¼Œå¯å…³é—­ kube-proxyã€‚\nğŸŸ© 3. Container Runtimeï¼ˆå¿…é¡»æ˜¯ CRIï¼‰ ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ (åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€é”€æ¯) å’Œæä¾›éš”ç¦»ç¯å¢ƒ (èµ„æºã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿ) çš„æ ¸å¿ƒè½¯ä»¶ç»„ä»¶ï¼Œæ˜¯å®¹å™¨æŠ€æœ¯çš„åŸºç¡€å¼•æ“ï¼Œå¸¸è§å¦‚ Dockerã€containerdã€CRI-Oã€‚å®ƒè´Ÿè´£å°†é•œåƒè¿è¡Œä¸ºå®é™…çš„éš”ç¦»è¿›ç¨‹ã€‚\nå®¹å™¨è¿è¡Œæ—¶çš„ä¸»è¦åŠŸèƒ½\nç”Ÿå‘½å‘¨æœŸç®¡ç†: åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤å®¹å™¨å®ä¾‹ã€‚ èµ„æºéš”ç¦»ä¸ç®¡ç†: åˆ©ç”¨æ“ä½œç³»ç»Ÿå†…æ ¸ç‰¹æ€§ (å¦‚ namespace, cgroups) å®ç° CPUã€å†…å­˜ã€ç£ç›˜ç­‰èµ„æºçš„é™åˆ¶å’Œéš”ç¦»ã€‚ æ–‡ä»¶ç³»ç»Ÿç®¡ç†: å°†å®¹å™¨é•œåƒæŒ‚è½½ä¸ºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚ å®‰å…¨ä¸éš”ç¦»: ç¡®ä¿å®¹å™¨é—´ã€å®¹å™¨ä¸å®¿ä¸»æœºé—´çš„å®‰å…¨éš”ç¦»ã€‚ å¸¸è§å®¹å™¨è¿è¡Œæ—¶ç±»å‹\né«˜çº§è¿è¡Œæ—¶ (High-Level): ç®¡ç†æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå’Œé•œåƒï¼Œå¦‚ containerdã€Docker Engineã€‚ ä½çº§è¿è¡Œæ—¶ (Low-Level): åªè´Ÿè´£å¯åŠ¨å’Œè¿è¡Œ OCI (Open Container Initiative) æ ‡å‡†çš„å®¹å™¨è¿›ç¨‹ï¼Œå¦‚ runcã€‚ Kubernetes CRI: Kubernetes å®šä¹‰çš„æ¥å£ (Container Runtime Interface)ï¼Œå…è®¸ K8S ä½¿ç”¨ä¸åŒçš„é«˜çº§è¿è¡Œæ—¶ï¼ˆå¦‚ containerd, CRI-Oï¼‰ã€‚ K8S 1.33 ä»…æ”¯æŒï¼š\ncontainerd CRI-O Docker å·²é•¿æœŸä¸æ”¯æŒã€‚\nâœ… 3. ç½‘ç»œç»„ä»¶ ğŸŸ§ 1. CoreDNSï¼ˆé›†ç¾¤ DNS æœåŠ¡ï¼‰ ğŸ‘‰ Kubernetes ä¸­çš„ DNS æœåŠ¡ï¼Œè§£æ Service å’Œ Pod åç§°ã€‚\nåŠŸèƒ½\nService DNS -\u0026gt; ClusterIP Pod FQDN è§£æ å¤–éƒ¨åŸŸåè½¬å‘ï¼ˆforwardersï¼‰ å¯æ‰©å±•æ’ä»¶ï¼ˆrewriteã€cacheã€hosts ç­‰ï¼‰ ç‰¹æ€§\né«˜å¯ç”¨ï¼ˆDeployment + autoscalerï¼‰ æ›¿ä»£è€æ—§çš„ kube-dns ğŸŸ§ 2. Calicoï¼ˆCNI ä¸ NetworkPolicy å®ç°ï¼‰ ğŸ‘‰ æä¾› Pod ç½‘ç»œã€ç½‘ç»œç­–ç•¥ã€å®‰å…¨ã€è·¯ç”±ã€BGPã€eBPF ç­‰èƒ½åŠ›ã€‚\nå¸¸è§æ¨¡å¼\næ¨¡å¼ æŠ€æœ¯ ä¼˜ç‚¹ ç¼ºç‚¹ eBPFï¼ˆæ¨èï¼‰ å®Œå…¨å–ä»£ kube-proxy é«˜æ€§èƒ½ è¦æ±‚å†…æ ¸â‰¥ 5.3 IPIP ç®€å•æ˜“ç”¨ å°åŒ…å¼€é”€å¤§ VXLAN overlay ç½‘ç»œ è¾ƒé€šç”¨ æ•ˆç‡ç•¥ä½ BGP èŠ‚ç‚¹ç›´è¿ æ€§èƒ½æœ€ä½³ é…ç½®å¤æ‚ åŠŸèƒ½\nCNIï¼ˆåˆ†é… Pod IPï¼‰ NetworkPolicyï¼ˆå…è®¸/æ‹’ç»æµé‡ï¼‰ Pod è·¯ç”±ï¼ˆLinux å†…æ ¸è·¯ç”±è¡¨ï¼‰ ä¹Ÿå¯æä¾›æœåŠ¡è´Ÿè½½å‡è¡¡ï¼ˆeBPFï¼‰ âœ… 4. å…¶å®ƒæ‰©å±•ç»„ä»¶ï¼ˆå¸¸è§ï¼‰ ğŸ”¹ kube-controller-manager ç›¸å…³æ‰©å±•\ncloud-controller-managerï¼ˆäº‘å‚å•†ï¼‰ ingress-controllerï¼ˆNginxã€Traefikï¼‰ metrics-serverï¼ˆHPA ä¾èµ–ï¼‰ cluster-autoscalerï¼ˆè‡ªåŠ¨æ‰©å®¹èŠ‚ç‚¹ï¼‰ ğŸ”¹ kubelet ç›¸å…³æ‰©å±•\nDevice Pluginï¼ˆGPU / FPGAï¼‰ CSI æ’ä»¶ï¼ˆå­˜å‚¨ï¼‰ ğŸ”¹ ç½‘ç»œç›¸å…³\nCiliumï¼ˆeBPF CNIï¼‰ kube-routerï¼ˆBGP CNIï¼‰ â­ æœ€ç»ˆæ€»ç»“ï¼ˆä¸€å¥è¯è®°å¿†ï¼‰ ç»„ä»¶ èŒè´£ kube-apiserver æ•´ä¸ªç³»ç»Ÿçš„å…¥å£ \u0026amp; çŠ¶æ€å˜æ›´ä¸­å¿ƒ etcd ä¿å­˜æ‰€æœ‰çŠ¶æ€ kube-controller-manager â€œç¡®ä¿çŠ¶æ€è¾¾æˆâ€çš„è‡ªåŠ¨åŒ–å¤§è„‘ kube-scheduler å†³å®š Pod è¿è¡Œåœ¨å“ª kubelet ç®¡ç†èŠ‚ç‚¹ä¸Šçš„ Pod kube-proxy Service è½¬å‘ï¼ˆæˆ–è¢« eBPF æ›¿ä»£ï¼‰ CoreDNS DNS è§£æ Calico Pod ç½‘ç»œ/è·¯ç”±/NetworkPolicyã€eBPF ç½‘ç»œ ","description":"å®˜æ–¹æ–‡æ¡£ï¼šKubernetes ç»„ä»¶\nKubernetes æ ¸å¿ƒç»„ä»¶åŠŸèƒ½ä»‹ç»\næ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Planeï¼‰ èŠ‚ç‚¹ç»„ä»¶ï¼ˆNode Componentsï¼‰ ç½‘ç»œç»„ä»¶ï¼ˆCNI / DNSï¼‰ æ‰©å±•ç»„ä»¶ï¼ˆé™„å¸¸è§ï¼‰ âœ… 1. æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰ ä¸»è¦èŒè´£\nå¯¹å¤–æ¥å£ï¼šæä¾›ç»Ÿä¸€çš„APIè®¿é—®å…¥å£ï¼ˆAPI Serverï¼‰ã€‚ ç®¡ç†é›†ç¾¤çŠ¶æ€ï¼šæ¥æ”¶ç”¨æˆ·æ“ä½œï¼ˆé€šè¿‡API Serverï¼‰ï¼Œç›‘æ§é›†ç¾¤å˜åŒ–ï¼Œç¡®ä¿å®é™…çŠ¶æ€ç¬¦åˆæœŸæœ›çŠ¶æ€ï¼ˆController Managerï¼‰ã€‚ èµ„æºè°ƒåº¦ï¼šå°† Podï¼ˆå·¥ä½œè´Ÿè½½ï¼‰æ™ºèƒ½åœ°åˆ†é…åˆ°åˆé€‚çš„ Worker Node ä¸Šï¼ˆSchedulerï¼‰ã€‚ æ•°æ®å­˜å‚¨ï¼šå­˜å‚¨æ‰€æœ‰é›†ç¾¤é…ç½®å’ŒçŠ¶æ€æ•°æ®ï¼ˆetcdï¼‰ã€‚ ğŸŸ¦ 1. kube-apiserverï¼ˆAPI æœåŠ¡å™¨ï¼‰ ğŸ‘‰ æ•´ä¸ª Kubernetes çš„ä¸­å¿ƒï¼Œä¸­æ¢ç¥ç»ï¼Œæ‰€æœ‰ç»„ä»¶äº¤äº’éƒ½ç»è¿‡å®ƒã€‚\n"},{"id":86,"href":"/operations/linux/kernel-memory/","title":"Linux å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€Œå†…æ ¸çº§è§†è§’ã€Linux å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰æ ¸å¿ƒå­ç³»ç»Ÿè¯¦è§£ã€‚\nä¸æ˜¯ free/top ç”¨æ³•ï¼Œè€Œæ˜¯ä»ç¡¬ä»¶ -\u0026gt; å†…æ ¸æ•°æ®ç»“æ„ -\u0026gt; é¡µåˆ†é… -\u0026gt; è™šæ‹Ÿå†…å­˜ -\u0026gt; NUMA -\u0026gt; OOM -\u0026gt; å®¹å™¨çš„å®Œæ•´è®¤çŸ¥ä½“ç³»ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€Linux å†…å­˜ç®¡ç†çš„æ€»ä½“ç›®æ ‡ åœ¨â€œæœ‰é™ç‰©ç†å†…å­˜ + å¤§é‡è¿›ç¨‹ + IO å¹¶å‘â€çš„æ¡ä»¶ä¸‹ï¼Œå®ç°ï¼š\néš”ç¦»ï¼ˆæ¯è¿›ç¨‹ç‹¬ç«‹åœ°å€ç©ºé—´ï¼‰ é«˜æ•ˆï¼ˆå°½é‡å‘½ä¸­ç¼“å­˜ï¼‰ å¯å›æ”¶ï¼ˆéšæ—¶ reclaimï¼‰ å¯æ§åˆ¶ï¼ˆcgroup / NUMAï¼‰ äºŒã€ä»ç¡¬ä»¶å¼€å§‹ï¼šç‰©ç†å†…å­˜æ¨¡å‹ 1ï¸âƒ£ RAM + Cache + Swap CPU â”œâ”€ L1/L2/L3 Cache â”œâ”€ MMU / TLB â””â”€ RAM â””â”€ Swapï¼ˆç£ç›˜ï¼‰ ğŸ“Œ Linux çš„å†…å­˜ç®¡ç† å¼ºä¾èµ– MMU\n2ï¸âƒ£ é¡µï¼ˆPageï¼‰æ˜¯æœ€å°å•ä½ é»˜è®¤é¡µå¤§å°ï¼š4KB å¤§é¡µï¼š2MB / 1GBï¼ˆHugePageï¼‰ struct page { unsigned long flags; atomic_t _refcount; ... } ä¸‰ã€è™šæ‹Ÿå†…å­˜ï¼ˆVMï¼‰æ ¸å¿ƒæ€æƒ³ Linux ç»™æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªâ€œå‡æƒ³æ— é™å¤§â€çš„å†…å­˜ç©ºé—´\n1ï¸âƒ£ è™šæ‹Ÿåœ°å€ç©ºé—´ 0x00000000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ user space heap mmap stack 0xC0000000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ kernel space æ¯è¿›ç¨‹ç‹¬ç«‹ å†…æ ¸ç©ºé—´å…±äº« 2ï¸âƒ£ åœ°å€è½¬æ¢ï¼ˆå…³é”®è·¯å¾„ï¼‰ è™šæ‹Ÿåœ°å€ -\u0026gt; é¡µè¡¨ -\u0026gt; ç‰©ç†é¡µ -\u0026gt; cache -\u0026gt; RAM ç”± MMU + é¡µè¡¨ + TLB å®Œæˆ\nå››ã€å†…æ ¸æ ¸å¿ƒæ•°æ®ç»“æ„ 1ï¸âƒ£ mm_structï¼ˆè¿›ç¨‹å†…å­˜è§†å›¾ï¼‰ struct mm_struct { pgd_t *pgd; unsigned long total_vm; unsigned long rss; struct vm_area_struct *mmap; } 2ï¸âƒ£ VMAï¼ˆè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼‰ struct vm_area_struct { unsigned long vm_start; unsigned long vm_end; unsigned long vm_flags; } ğŸ“Œ mmap / heap / stack éƒ½æ˜¯ VMA\näº”ã€é¡µåˆ†é…å™¨ï¼ˆBuddy Systemï¼‰ 1ï¸âƒ£ Buddy åˆ†é…åŸç† ç®¡ç† 2^n é¡µå— å¿«é€Ÿåˆ†é… / åˆå¹¶ Order 0 = 1 page Order 1 = 2 pages Order 10 = 1024 pages 2ï¸âƒ£ å†…å­˜ç¢ç‰‡é—®é¢˜ å¤–éƒ¨ç¢ç‰‡ è§£å†³æ–¹æ¡ˆï¼š å†…å­˜å‹ç¼©ï¼ˆcompactionï¼‰ HugePage é¢„ç•™ å…­ã€Slab / Slub åˆ†é…å™¨ï¼ˆå¯¹è±¡çº§ï¼‰ é¿å…é¢‘ç¹ page åˆ†é…\nslabï¼šè€ slubï¼šé»˜è®¤ï¼ˆRHEL / Ubuntuï¼‰ ç”¨äºï¼š\ninode dentry task_struct ä¸ƒã€Page Cacheï¼ˆæ€§èƒ½æ ¸å¿ƒï¼‰ 1ï¸âƒ£ Page Cache æ˜¯ä»€ä¹ˆ æ–‡ä»¶ IO çš„ç¼“å­˜å±‚\nè¯»ï¼šç£ç›˜ -\u0026gt; page cache -\u0026gt; è¿›ç¨‹ å†™ï¼šè¿›ç¨‹ -\u0026gt; page cache -\u0026gt; å¼‚æ­¥åˆ·ç›˜ ğŸ“Œ free å†…å­˜ â‰  å¯ç”¨å†…å­˜\n2ï¸âƒ£ è„é¡µï¼ˆDirty Pageï¼‰ dirty_ratio dirty_background_ratio vm.dirty_ratio=20 vm.dirty_background_ratio=10 å…«ã€Swapï¼ˆä¸æ˜¯æ´ªæ°´çŒ›å…½ï¼‰ 1ï¸âƒ£ Swap çš„ä½œç”¨ å›æ”¶åŒ¿åé¡µ é˜²æ­¢ OOM 2ï¸âƒ£ Swappiness vm.swappiness=10 æ•°æ®åº“ï¼šä½ æ¡Œé¢ï¼šé«˜ ä¹ã€å†…å­˜å›æ”¶ï¼ˆReclaimï¼‰ 1ï¸âƒ£ LRU é“¾è¡¨ Active / Inactive Anon / File 2ï¸âƒ£ kswapd vs direct reclaim ç±»å‹ è§¦å‘ kswapd åå° direct åˆ†é…å¤±è´¥ ğŸ“Œ direct reclaim ä¼šå¡ä¸šåŠ¡\nåã€OOM Killerï¼ˆæœ€åé˜²çº¿ï¼‰ 1ï¸âƒ£ OOM è§¦å‘æ¡ä»¶ reclaim å¤±è´¥ swap ä¸è¶³ 2ï¸âƒ£ OOM è¯„åˆ† oom_score oom_score_adj 3ï¸âƒ£ å®¹å™¨ OOM cgroup å†…å­˜é™åˆ¶è§¦å‘ OOMï¼Œä¸å½±å“å®¿ä¸»\nåä¸€ã€NUMA å†…å­˜ç®¡ç† 1ï¸âƒ£ NUMA èŠ‚ç‚¹ Node0 â†-\u0026gt; Node1 æœ¬åœ°å†…å­˜å¿« è¿œç¨‹æ…¢ 2ï¸âƒ£ NUMA balancing è‡ªåŠ¨é¡µè¿ç§» æ•°æ®åº“é€šå¸¸å…³é—­ åäºŒã€HugePagesï¼ˆæ•°æ®åº“é‡ç‚¹ï¼‰ 1ï¸âƒ£ HugeTLB 2MB / 1GB å‡å°‘ TLB miss 2ï¸âƒ£ Transparent Huge Pagesï¼ˆTHPï¼‰ è‡ªåŠ¨ æ•°æ®åº“ä¸€èˆ¬ç¦ç”¨ echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled åä¸‰ã€cgroups v2 å†…å­˜æ§åˆ¶ 1ï¸âƒ£ æ§åˆ¶é¡¹ memory.max memory.high memory.swap.max 2ï¸âƒ£ OOM è¡Œä¸ºå˜åŒ– OOM confined ä¼˜å…ˆ kill å®¹å™¨å†… åå››ã€å†…å­˜ä¸å®¹å™¨ / è™šæ‹ŸåŒ– å®¹å™¨ çœ‹è§çš„æ˜¯â€œè™šæ‹Ÿé™åˆ¶â€ page cache å¯å…±äº« è™šæ‹Ÿæœº åŒé‡é¡µè¡¨ï¼ˆEPTï¼‰ ballooning åäº”ã€å¸¸è§è¯¯åŒºçº æ­£ âŒ free æ˜¾ç¤ºå†…å­˜ç”¨å®Œäº† âœ… cache å¯å›æ”¶\nâŒ swap ä¸€å®šæ…¢ âœ… æ²¡ swap æ›´å®¹æ˜“ OOM\nâŒ THP ä¸€å®šå¥½ âœ… DB å¸¸å¸¸æŠ–åŠ¨\nåå…­ã€å…³é”®å†…æ ¸å‚æ•°é€ŸæŸ¥ vm.swappiness vm.overcommit_memory vm.dirty_ratio vm.dirty_background_ratio vm.max_map_count åä¸ƒã€æ€»ç»“ Linux å†…å­˜ç®¡ç† = è™šæ‹Ÿå†…å­˜ + é¡µè¡¨ + é¡µåˆ†é…å™¨ + Page Cache + Reclaim + OOM + NUMA + cgroup\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€Œå†…æ ¸çº§è§†è§’ã€Linux å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰æ ¸å¿ƒå­ç³»ç»Ÿè¯¦è§£ã€‚\nä¸æ˜¯ free/top ç”¨æ³•ï¼Œè€Œæ˜¯ä»ç¡¬ä»¶ -\u0026gt; å†…æ ¸æ•°æ®ç»“æ„ -\u0026gt; é¡µåˆ†é… -\u0026gt; è™šæ‹Ÿå†…å­˜ -\u0026gt; NUMA -\u0026gt; OOM -\u0026gt; å®¹å™¨çš„å®Œæ•´è®¤çŸ¥ä½“ç³»ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€Linux å†…å­˜ç®¡ç†çš„æ€»ä½“ç›®æ ‡ åœ¨â€œæœ‰é™ç‰©ç†å†…å­˜ + å¤§é‡è¿›ç¨‹ + IO å¹¶å‘â€çš„æ¡ä»¶ä¸‹ï¼Œå®ç°ï¼š\néš”ç¦»ï¼ˆæ¯è¿›ç¨‹ç‹¬ç«‹åœ°å€ç©ºé—´ï¼‰ é«˜æ•ˆï¼ˆå°½é‡å‘½ä¸­ç¼“å­˜ï¼‰ å¯å›æ”¶ï¼ˆéšæ—¶ reclaimï¼‰ å¯æ§åˆ¶ï¼ˆcgroup / NUMAï¼‰ äºŒã€ä»ç¡¬ä»¶å¼€å§‹ï¼šç‰©ç†å†…å­˜æ¨¡å‹ 1ï¸âƒ£ RAM + Cache + Swap CPU â”œâ”€ L1/L2/L3 Cache â”œâ”€ MMU / TLB â””â”€ RAM â””â”€ Swapï¼ˆç£ç›˜ï¼‰ ğŸ“Œ Linux çš„å†…å­˜ç®¡ç† å¼ºä¾èµ– MMU\n"},{"id":87,"href":"/operations/linux/kernel-fs/","title":"Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰","parent":"Linux","content":"å…ˆè®² VFSï¼Œå†è®² FSã€‚\nä¸‹é¢æ˜¯ä¸€ä»½ ã€Œå†…æ ¸çº§è§†è§’ã€Linux æ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿï¼ˆVFS, Virtual File Systemï¼‰è¯¦è§£ã€‚\nä¸æ˜¯ ls / mount çš„ç”¨æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸æŠ½è±¡å±‚ -\u0026gt; æ•°æ®ç»“æ„ -\u0026gt; è·¯å¾„è§£æ -\u0026gt; IO è°ƒç”¨ -\u0026gt; å®¹å™¨/UnionFS çš„å®Œæ•´è®¤çŸ¥ä½“ç³»ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€VFS æ˜¯ä»€ä¹ˆï¼ˆå…ˆç«‹æ ¸å¿ƒè®¤çŸ¥ï¼‰ VFS = Linux çš„â€œæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚â€\nå®ƒè§£å†³çš„é—®é¢˜ï¼š\next4 / xfs / nfs / proc / overlayfs ä¸åŒæ–‡ä»¶ç³»ç»Ÿ -\u0026gt; ç»Ÿä¸€æ¥å£ ç”¨æˆ·ç¨‹åº â†“ ç³»ç»Ÿè°ƒç”¨ï¼ˆopen/read/writeï¼‰ â†“ VFSï¼ˆæŠ½è±¡ï¼‰ â†“ å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç° ğŸ“Œ æ²¡æœ‰ VFSï¼Œå°±æ²¡æœ‰â€œä¸€åˆ‡çš†æ–‡ä»¶â€\näºŒã€VFS çš„è®¾è®¡ç›®æ ‡ æ–‡ä»¶ç³»ç»Ÿæ— å…³ é«˜æ€§èƒ½ï¼ˆç¼“å­˜ï¼‰ æ”¯æŒç½‘ç»œ / è™šæ‹Ÿ FS æ”¯æŒ namespace / å®¹å™¨ ä¸‰ã€VFS æ ¸å¿ƒå¯¹è±¡ï¼ˆå››å¤§ç»“æ„ï¼‰ ç†è§£ VFSï¼Œåªè¦åƒé€è¿™ 4 ä¸ªç»“æ„\nç»“æ„ ä½œç”¨ super_block æ–‡ä»¶ç³»ç»Ÿ inode æ–‡ä»¶å…ƒæ•°æ® dentry ç›®å½•é¡¹ï¼ˆåå­—ï¼‰ file æ‰“å¼€çš„æ–‡ä»¶ 1ï¸âƒ£ super_blockï¼ˆæ–‡ä»¶ç³»ç»Ÿå®ä¾‹ï¼‰ struct super_block { struct file_system_type *s_type; struct dentry *s_root; struct block_device *s_bdev; } æ¯ä¸ª mount ä¸€ä¸ª æè¿°â€œè¿™ä¸ª FS æ˜¯ä»€ä¹ˆâ€ 2ï¸âƒ£ inodeï¼ˆæ–‡ä»¶æœ¬ä½“ï¼‰ struct inode { umode_t i_mode; uid_t i_uid; loff_t i_size; struct inode_operations *i_op; } ğŸ“Œ inode â‰  æ–‡ä»¶å\n3ï¸âƒ£ dentryï¼ˆåå­—æ˜ å°„ï¼‰ struct dentry { struct inode *d_inode; struct qstr d_name; } è·¯å¾„è§£ææ ¸å¿ƒ dentry cache æ€§èƒ½å…³é”® 4ï¸âƒ£ fileï¼ˆæ‰“å¼€å®ä¾‹ï¼‰ struct file { loff_t f_pos; struct file_operations *f_op; } ğŸ“Œ åŒä¸€ä¸ª inode å¯è¢«å¤šä¸ª file å¼•ç”¨\nå››ã€è·¯å¾„è§£æï¼ˆPath Walkï¼‰å…¨è¿‡ç¨‹ /open(\u0026#34;/a/b/c\u0026#34;) æ­¥éª¤ï¼š\næŸ¥ dentry cache è‹¥ miss -\u0026gt; inode lookup è‹¥ä¸å­˜åœ¨ -\u0026gt; åˆ›å»º dentry æƒé™æ£€æŸ¥ è¿”å› file ğŸ“Œ ç›®å½•è¶Šæ·±ï¼Œdentry cache è¶Šé‡è¦\näº”ã€ç³»ç»Ÿè°ƒç”¨å¦‚ä½•è½åˆ°æ–‡ä»¶ç³»ç»Ÿ 1ï¸âƒ£ open() sys_open -\u0026gt; do_filp_open -\u0026gt; path_lookup -\u0026gt; inode_operations 2ï¸âƒ£ read/write() sys_read -\u0026gt; file-\u0026gt;f_op-\u0026gt;read_iter ğŸ“Œ VFS é€šè¿‡ function pointer è°ƒåº¦\nå…­ã€Page Cache ä¸ VFSï¼ˆæ€§èƒ½æ ¸å¿ƒï¼‰ æ–‡ä»¶ IO = Page Cache + VFS\n1ï¸âƒ£ è¯»æµç¨‹ read -\u0026gt; page cache hit -\u0026gt; copy_to_user miss -\u0026gt; disk -\u0026gt; cache -\u0026gt; user 2ï¸âƒ£ å†™æµç¨‹ write -\u0026gt; page cache dirty -\u0026gt; writeback ğŸ“Œ fsync æ‰æ˜¯çœŸæ­£è½ç›˜\nä¸ƒã€æ–‡ä»¶ç³»ç»Ÿç±»å‹åˆ†ç±» ç±»å‹ ç¤ºä¾‹ æœ¬åœ° FS ext4, xfs ç½‘ç»œ FS nfs, cifs è™šæ‹Ÿ FS proc, sysfs Union FS overlayfs ç‰¹æ®Š tmpfs å…«ã€Mount æœºåˆ¶ï¼ˆVFS æ ¸å¿ƒï¼‰ 1ï¸âƒ£ æŒ‚è½½æœ¬è´¨ æŠŠä¸€ä¸ª super_block æŒ‚åˆ° dentry ä¸Š\n/mnt â””â”€ ext4 super_block 2ï¸âƒ£ Mount Namespace æ¯ä¸ªå®¹å™¨ç‹¬ç«‹è§†å›¾ mount ç§æœ‰åŒ– ä¹ã€æƒé™æ¨¡å‹ï¼ˆVFS å±‚ï¼‰ æƒé™æ£€æŸ¥é¡ºåº\nUID/GID Mode bits ACL Capability ğŸ“Œ root ä¹Ÿè¦è¿‡ VFS æƒé™\nåã€inode ä¸é“¾æ¥ 1ï¸âƒ£ ç¡¬é“¾æ¥ åŒ inode å¼•ç”¨è®¡æ•° 2ï¸âƒ£ è½¯é“¾æ¥ ç‹¬ç«‹ inode å†…å®¹æ˜¯è·¯å¾„ åä¸€ã€æ–‡ä»¶é”ï¼ˆVFS å±‚ï¼‰ é” è¯´æ˜ flock å»ºè®®é” fcntl POSIX é” ğŸ“Œ è·¨ FS / NFS è¡Œä¸ºä¸åŒ\nåäºŒã€UnionFS / overlayfsï¼ˆå®¹å™¨æ ¸å¿ƒï¼‰ overlayfs å±‚æ¬¡\nlowerdir (image) upperdir (container) workdir Copy-on-write dentry / inode æ˜ å°„å¤æ‚ ğŸ“Œ æ€§èƒ½ç“¶é¢ˆå¸¸åœ¨ metadata\nåä¸‰ã€VFS ä¸å®¹å™¨ / Kubernetes æ¯ä¸ªå®¹å™¨ï¼š mount namespace overlayfs rootfs volume = çœŸå® FS ğŸ“Œ æ•°æ®åº“ volume â‰  overlay å±‚\nåå››ã€VFS ä¸æ•°æ®åº“ ç‚¹ å½±å“ fsync æ€§èƒ½å…³é”® inode cache å…ƒæ•°æ® page cache buffer pool Direct IO ç»•è¿‡ cache ğŸ“Œ DB å¼ºçƒˆä¾èµ– VFS è¡Œä¸º\nåäº”ã€å¸¸è§è¯¯åŒºçº æ­£ âŒ inode å°±æ˜¯æ–‡ä»¶ âœ… inode æ˜¯å…ƒæ•°æ®\nâŒ overlayfs å¾ˆæ…¢ âœ… metadata æ…¢ï¼ŒIO è¿˜è¡Œ\nâŒ page cache æ˜¯æµªè´¹ âœ… æ˜¯æ€§èƒ½å‘½æ ¹å­\nåå…­ã€è°ƒè¯•ä¸è§‚å¯Ÿæ¥å£ /proc/filesystems /proc/self/mountinfo /sys/fs åä¸ƒã€ä¸€å¥è¯ç»ˆææ€»ç»“ VFS = inode + dentry + file + super_blockï¼Œæ˜¯ Linux æ–‡ä»¶ä¸–ç•Œçš„â€œç»Ÿä¸€ä¸­æ¢ç¥ç»ç³»ç»Ÿâ€\nä¸‹é¢æ˜¯ä¸€ä»½ ã€ŒçœŸæ­£æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰å±‚é¢çš„ Linux å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿè¯¦è§£ã€ã€‚\nè¿™ä¸€æ¬¡åˆ»æ„ä¸å†åœç•™åœ¨ VFS æŠ½è±¡ï¼Œè€Œæ˜¯å¾€ä¸‹èµ°ä¸€å±‚ï¼Œå›ç­”ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š\nç£ç›˜ä¸Šçš„æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ï¼Ÿ å†…æ ¸å¦‚ä½•æŠŠå—è®¾å¤‡å˜æˆâ€œæ–‡ä»¶â€ï¼Ÿ ext4 / XFS / tmpfs / overlayfs çš„æœ¬è´¨å·®å¼‚æ˜¯ä»€ä¹ˆï¼Ÿ é€‚ç”¨ï¼šRHEL / AlmaLinux / Rocky / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–\nä¸€ã€FS åœ¨ Linux å†…æ ¸ä¸­çš„ä½ç½® ç”¨æˆ·ç¨‹åº â†“ VFSï¼ˆæŠ½è±¡å±‚ï¼‰ â†“ å…·ä½“æ–‡ä»¶ç³»ç»Ÿï¼ˆext4 / xfs / nfs / tmpfsï¼‰ â†“ Block Layer â†“ Block Device / Disk ğŸ“Œ FS æ˜¯â€œVFS çš„å®ç°è€… + Block Layer çš„ä½¿ç”¨è€…â€\näºŒã€æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰åˆ°åº•è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ æŠŠâ€œçº¿æ€§çš„å—è®¾å¤‡â€ -\u0026gt; â€œç»“æ„åŒ–çš„æ–‡ä»¶ä¸ç›®å½•â€\nå¿…é¡»è§£å†³ 6 ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š\nç©ºé—´å¦‚ä½•åˆ†é… å…ƒæ•°æ®å¦‚ä½•å­˜å‚¨ æ–‡ä»¶å¦‚ä½•å®šä½ ç›®å½•å¦‚ä½•ç»„ç»‡ å´©æºƒå¦‚ä½•æ¢å¤ æ€§èƒ½å¦‚ä½•ä¿è¯ ä¸‰ã€ç£ç›˜è§†è§’ï¼šæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬ç»„æˆ å‡ ä¹æ‰€æœ‰ FS éƒ½åŒ…å«ï¼š\n[ Superblock ] [ Metadata åŒº ] [ Data Blocks ] 1ï¸âƒ£ Superblockï¼ˆæ–‡ä»¶ç³»ç»Ÿèº«ä»½è¯ï¼‰ ä¿å­˜ï¼š\nFS ç±»å‹ block size inode æ•°é‡ UUID mount çŠ¶æ€ ğŸ“Œ superblock æŸå = FS æ— æ³•è¯†åˆ«\n2ï¸âƒ£ Metadataï¼ˆå…ƒæ•°æ®åŒºï¼‰ åŒ…æ‹¬ï¼š\ninode è¡¨ ä½å›¾ï¼ˆblock / inode bitmapï¼‰ B+Tree / extent tree 3ï¸âƒ£ Data Blocksï¼ˆæ•°æ®åŒºï¼‰ çœŸæ­£çš„æ–‡ä»¶å†…å®¹ ç”± inode æŒ‡å‘ å››ã€inodeï¼šæ–‡ä»¶ç³»ç»Ÿçš„â€œçµé­‚â€ inode æ˜¯â€œæ–‡ä»¶â€ï¼Œè€Œä¸æ˜¯æ–‡ä»¶å\nå…¸å‹ inode åŒ…å«ï¼š\næƒé™ UID / GID å¤§å° æ—¶é—´æˆ³ æŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆ inode å¦‚ä½•æŒ‡å‘æ•°æ®ï¼Ÿ æ—©æœŸï¼ˆext2ï¼‰ ç›´æ¥å— é—´æ¥å— åŒé‡ / ä¸‰é‡é—´æ¥ âŒ å¤§æ–‡ä»¶æ•ˆç‡å·®\nç°ä»£ï¼ˆext4 / xfsï¼‰ Extentï¼ˆåŒºæ®µï¼‰\n[start_block, length] âœ… è¿ç»­ IO âœ… å°‘ metadata âœ… æ›´é€‚åˆå¤§æ–‡ä»¶ / DB äº”ã€ç©ºé—´åˆ†é…ç­–ç•¥ï¼ˆæ€§èƒ½å…³é”®ï¼‰ 1ï¸âƒ£ Block Allocationï¼ˆå—åˆ†é…ï¼‰ ç›®æ ‡ï¼š\nå‡å°‘ç¢ç‰‡ è¿ç»­ IO 2ï¸âƒ£ å»¶è¿Ÿåˆ†é…ï¼ˆDelayed Allocationï¼‰ å†™çš„æ—¶å€™ä¸ç«‹åˆ»åˆ†é…ç£ç›˜å—\nå…ˆå†™ page cache åˆ·ç›˜æ—¶ç»Ÿä¸€è§„åˆ’ ğŸ“Œ ext4 / xfs é»˜è®¤å¯ç”¨\n3ï¸âƒ£ Preallocationï¼ˆé¢„åˆ†é…ï¼‰ æ•°æ®åº“å¸¸ç”¨ å‡å°‘ç¢ç‰‡ å…­ã€ç›®å½•çš„çœŸå®ç»“æ„ ç›®å½• â‰  ç‰¹æ®Šæ–‡ä»¶\nç›®å½• = â€œæ–‡ä»¶å -\u0026gt; inodeâ€çš„æ˜ å°„è¡¨\next4 / xfs ç›®å½•ç»“æ„\nå°ç›®å½•ï¼šçº¿æ€§è¡¨ å¤§ç›®å½•ï¼šB-tree / HTree ğŸ“Œ å¤§é‡å°æ–‡ä»¶æ€§èƒ½çœ‹ç›®å½•ç»“æ„\nä¸ƒã€æ—¥å¿—ï¼ˆJournalingï¼‰æœºåˆ¶ ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—ï¼Ÿ é˜²æ­¢æ–­ç”µ / crash å¯¼è‡´å…ƒæ•°æ®æŸå\næ—¥å¿—ä¸‰ç§æ¨¡å¼ï¼ˆext4ï¼‰ æ¨¡å¼ ç‰¹ç‚¹ writeback å¿«ä½†ä¸å®‰å…¨ orderedï¼ˆé»˜è®¤ï¼‰ æ•°æ®å…ˆå†™ journal æ•°æ® + å…ƒæ•°æ® ğŸ“Œ XFS æ°¸è¿œæ˜¯ ordered ç±»ä¼¼è¡Œä¸º\næ—¥å¿—å†™å…¥æµç¨‹ metadata -\u0026gt; journal commit checkpoint -\u0026gt; main FS å…«ã€ext4 vs XFSï¼ˆå†…æ ¸çº§å·®å¼‚ï¼‰ ç»´åº¦ ext4 XFS è®¾è®¡ç›®æ ‡ é€šç”¨ å¤§æ–‡ä»¶ / å¹¶å‘ inode å›ºå®šæ•°é‡ åŠ¨æ€ æ—¥å¿— JBD2 å†…å»º æ‰©å®¹ æ”¯æŒ æ›´å¼º fsck æ…¢ å‡ ä¹ä¸ç”¨ å¹¶å‘ ä¸­ é«˜ ğŸ“Œ æ•°æ®åº“ / å¤§ç›˜ï¼šXFS\nğŸ“Œ ç³»ç»Ÿç›˜ / é€šç”¨ï¼šext4\nä¹ã€Block Layer ä¸ FS çš„å…³ç³» FS -\u0026gt; submit_bio -\u0026gt; block layer -\u0026gt; IO scheduler -\u0026gt; disk FS å†³å®š â€œè¯»ä»€ä¹ˆå—â€ Block Layer å†³å®š â€œæ€ä¹ˆè¯»â€ IO è°ƒåº¦å™¨å½±å“ mq-deadlineï¼ˆæ•°æ®åº“ï¼‰ noneï¼ˆNVMeï¼‰ åã€fsync / fdatasync çš„çœŸç›¸ï¼ˆæ•°æ®åº“ç”Ÿæ­»çº¿ï¼‰ fsync = æ•°æ® + å…ƒæ•°æ®è½ç›˜\next4 orderedï¼šæ•°æ®å·²å…ˆå†™ XFSï¼šlog å¼ºä¸€è‡´ ğŸ“Œ fsync â‰  ç«‹åˆ»å†™ç£ç›˜ï¼Œè€Œæ˜¯ç«‹åˆ»ä¿è¯æŒä¹…æ€§\nåä¸€ã€tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰ ä¸èµ° block layer é¡µ = å†…å­˜ ğŸ“Œ /run /tmp /dev/shm\nåäºŒã€overlayfsï¼ˆå®¹å™¨ FSï¼‰ ç»“æ„ï¼š\nlowerdirï¼ˆåªè¯»é•œåƒï¼‰ upperdirï¼ˆå†™å±‚ï¼‰ workdir è¡Œä¸ºï¼š\nå†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰ metadata æ˜ å°„å¤æ‚ ğŸ“Œ overlayfs ä¸é€‚åˆæ•°æ®åº“æ•°æ®ç›®å½•\nåä¸‰ã€FS ä¸ Page Cache çš„å…³ç³» FS ä¸ç›´æ¥è¯»ç£ç›˜ å…ˆæŸ¥ page cache writeback å¼‚æ­¥ ğŸ“Œ æ•°æ®åº“ buffer pool â‰  page cache\nåå››ã€FS ä¸å®¹å™¨ / äº‘ å®¹å™¨\nrootfs = overlayfs volume = ext4 / xfs äº‘ç›˜\nå†™å»¶è¿Ÿå¤§ fsync æˆæœ¬é«˜ åäº”ã€å¸¸è§ FS çº§â€œå‘â€ âŒ inode ç”¨å®Œä½†ç£ç›˜è¿˜æœ‰ç©ºé—´ âŒ overlayfs metadata çˆ†ç‚¸ âŒ fsync é¢‘ç¹å¯¼è‡´ TPS æ‰å´– âŒ ext4 å° inode + å¤§æ–‡ä»¶æ•° åå…­ã€ç”Ÿäº§çº§ FS é€‰æ‹©å»ºè®® åœºæ™¯ å»ºè®® ç³»ç»Ÿç›˜ ext4 æ•°æ®ç›˜ XFS å®¹å™¨æ•°æ® ç›´æŒ‚ volume ä¸´æ—¶æ•°æ® tmpfs æ—¥å¿— XFS + noatime åä¸ƒã€æ€»ç»“ Linux æ–‡ä»¶ç³»ç»Ÿï¼ˆFSï¼‰æœ¬è´¨æ˜¯ï¼šinode + block allocation + journaling + cache + IO è°ƒåº¦ï¼ŒæŠŠâ€œå—è®¾å¤‡â€å˜æˆâ€œå¯é ã€é«˜æ•ˆçš„æ–‡ä»¶ä¸–ç•Œâ€ã€‚\n","description":"å…ˆè®² VFSï¼Œå†è®² FSã€‚\nä¸‹é¢æ˜¯ä¸€ä»½ ã€Œå†…æ ¸çº§è§†è§’ã€Linux æ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿï¼ˆVFS, Virtual File Systemï¼‰è¯¦è§£ã€‚\nä¸æ˜¯ ls / mount çš„ç”¨æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸æŠ½è±¡å±‚ -\u0026gt; æ•°æ®ç»“æ„ -\u0026gt; è·¯å¾„è§£æ -\u0026gt; IO è°ƒç”¨ -\u0026gt; å®¹å™¨/UnionFS çš„å®Œæ•´è®¤çŸ¥ä½“ç³»ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€VFS æ˜¯ä»€ä¹ˆï¼ˆå…ˆç«‹æ ¸å¿ƒè®¤çŸ¥ï¼‰ VFS = Linux çš„â€œæ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚â€\nå®ƒè§£å†³çš„é—®é¢˜ï¼š\next4 / xfs / nfs / proc / overlayfs ä¸åŒæ–‡ä»¶ç³»ç»Ÿ -\u0026gt; ç»Ÿä¸€æ¥å£ ç”¨æˆ·ç¨‹åº â†“ ç³»ç»Ÿè°ƒç”¨ï¼ˆopen/read/writeï¼‰ â†“ VFSï¼ˆæŠ½è±¡ï¼‰ â†“ å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç° ğŸ“Œ æ²¡æœ‰ VFSï¼Œå°±æ²¡æœ‰â€œä¸€åˆ‡çš†æ–‡ä»¶â€\n"},{"id":88,"href":"/operations/linux/kernel-networking/","title":"Linux ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŒLinux å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿï¼šç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ã€çš„ç³»ç»Ÿçº§ã€å†…æ ¸çº§å®Œæ•´æ¢³ç†ã€‚\nå®šä½æ˜¯ï¼šå†…æ ¸åŸç† -\u0026gt; æ•°æ®è·¯å¾„ -\u0026gt; æ€§èƒ½ -\u0026gt; å®¹å™¨ / è™šæ‹ŸåŒ– / äº‘ / è°ƒä¼˜ã€‚\né€‚ç”¨äº RHEL / AlmaLinux / Debian / Ubuntuã€‚\nä¸€ã€Linux ç½‘ç»œå­ç³»ç»Ÿåœ¨å†…æ ¸ä¸­çš„ä½ç½® ç”¨æˆ·æ€åº”ç”¨ â†“ Socket APIï¼ˆglibcï¼‰ â†“ ç³»ç»Ÿè°ƒç”¨ï¼ˆsend / recvï¼‰ â†“ Socket Layer â†“ TCP / UDP / ICMP / IP â†“ Netfilter / Routing â†“ qdisc / TC â†“ NIC Driver â†“ ç½‘å¡ / DMA ğŸ“Œ Linux ç½‘ç»œ = ä¸€æ¡â€œåˆ†å±‚ + æ—è·¯ + é’©å­â€çš„å¤æ‚æµæ°´çº¿\näºŒã€æ ¸å¿ƒè®¾è®¡ç›®æ ‡ Linux ç½‘ç»œå­ç³»ç»Ÿè¦åŒæ—¶æ»¡è¶³ï¼š\né€šç”¨åè®®æ ˆï¼ˆTCP/IPï¼‰ é«˜æ€§èƒ½ï¼ˆ10G / 100G / DPDKï¼‰ å¯æ‰©å±•ï¼ˆæ¨¡å—åŒ–ã€Hookï¼‰ è™šæ‹ŸåŒ–ï¼ˆnamespace / vethï¼‰ å®‰å…¨ï¼ˆiptables / nftablesï¼‰ ä¸‰ã€Socket å±‚ï¼ˆç”¨æˆ·ä¸å†…æ ¸çš„åˆ†ç•Œçº¿ï¼‰ 1ï¸âƒ£ Socket çš„æœ¬è´¨ Socket = å†…æ ¸å¯¹è±¡ï¼Œä¸æ˜¯æ–‡ä»¶\næ¯ä¸ª socket éƒ½æ˜¯ struct sock æ–‡ä»¶æè¿°ç¬¦åªæ˜¯ç´¢å¼• 2ï¸âƒ£ Socket ç±»å‹ ç±»å‹ åè®® SOCK_STREAM TCP SOCK_DGRAM UDP SOCK_RAW åŸå§‹åŒ… SOCK_PACKET å·²åºŸå¼ƒ 3ï¸âƒ£ ç³»ç»Ÿè°ƒç”¨è·¯å¾„ send() -\u0026gt; sys_sendto() -\u0026gt; sock_sendmsg() -\u0026gt; tcp_sendmsg() ğŸ“Œ glibc åªæ˜¯å°è£…ï¼ŒçœŸæ­£é€»è¾‘åœ¨å†…æ ¸\nå››ã€åè®®æ ˆï¼ˆTCP / UDP / IPï¼‰ 1ï¸âƒ£ IP å±‚ï¼ˆL3ï¼‰ èŒè´£ï¼š\nè·¯ç”±æŸ¥æ‰¾ åˆ†ç‰‡ / é‡ç»„ TTL checksum æ ¸å¿ƒç»“æ„ï¼š\nstruct sk_buffï¼ˆskbï¼‰ ğŸ“Œ skb æ˜¯ç½‘ç»œå­ç³»ç»Ÿçš„â€œæ ¸å¿ƒæ•°æ®ç»“æ„â€\n2ï¸âƒ£ TCPï¼ˆL4ï¼‰ èŒè´£ï¼š\nå¯é ä¼ è¾“ æ‹¥å¡æ§åˆ¶ é‡ä¼  æµæ§ å…³é”®ç»„ä»¶ï¼š\nsend buffer / recv buffer RTT cwnd RTO TCP æ‹¥å¡æ§åˆ¶ç®—æ³• cubicï¼ˆé»˜è®¤ï¼‰ bbr reno ğŸ“Œ äº‘ç¯å¢ƒå¼ºçƒˆå»ºè®® BBR\n3ï¸âƒ£ UDP æ— è¿æ¥ æ— å¯é  å‡ ä¹é›¶å¼€é”€ ğŸ“Œ DNS / QUIC / æ¸¸æˆ / ç›‘æ§\näº”ã€sk_buffï¼ˆskbï¼‰è¯¦è§£ï¼ˆæ ¸å¿ƒï¼‰ struct sk_buff { data len protocol dev cb next / prev } ä½œç”¨ï¼š\nå°è£…æ•°æ® åœ¨åè®®æ ˆä¸­æµè½¬ æ¯ä¸€å±‚ push / pull header ğŸ“Œ æ‰€æœ‰æ€§èƒ½é—®é¢˜ï¼Œæœ€åéƒ½ä¼šè½åœ¨ skb ä¸Š\nå…­ã€è·¯ç”±å­ç³»ç»Ÿï¼ˆRoutingï¼‰ 1ï¸âƒ£ è·¯ç”±æŸ¥æ‰¾æµç¨‹ ç›®çš„ IP -\u0026gt; FIBï¼ˆè·¯ç”±è¡¨ï¼‰ -\u0026gt; nexthop -\u0026gt; è®¾å¤‡ å†…æ ¸ç»“æ„ï¼š\nFIB trie hash cache 2ï¸âƒ£ policy routing å¤šè·¯ç”±è¡¨ fwmark / source-based ğŸ“Œ å®¹å™¨ / VPN å¿…å¤‡\nä¸ƒã€Netfilterï¼ˆiptables / nftablesï¼‰ 1ï¸âƒ£ äº”å¤§ Hook ç‚¹ PREROUTING INPUT FORWARD OUTPUT POSTROUTING ğŸ“Œ è¿™æ˜¯ Linux é˜²ç«å¢™ã€NATã€K8S çš„æ ¹åŸº\n2ï¸âƒ£ conntrackï¼ˆè¿æ¥è·Ÿè¸ªï¼‰ stateful firewall TCP çŠ¶æ€æœº âŒ conntrack çˆ†æ»¡ = å…¨ç½‘å¡æ­»\nå…«ã€TC / qdiscï¼ˆæµé‡æ§åˆ¶ï¼‰ 1ï¸âƒ£ qdisc æ˜¯ä»€ä¹ˆï¼Ÿ åŒ…æ’é˜Ÿä¸è°ƒåº¦å™¨\npfifo_fast fq_codel cake 2ï¸âƒ£ å¸¸è§ç”¨é€” é™é€Ÿ å»¶è¿Ÿæ³¨å…¥ QoS ä¹ã€NIC Driver ä¸ DMA 1ï¸âƒ£ RX è·¯å¾„ï¼ˆæ”¶åŒ…ï¼‰ NIC -\u0026gt; DMA -\u0026gt; ring buffer -\u0026gt; NAPI -\u0026gt; netif_receive_skb() 2ï¸âƒ£ NAPIï¼ˆä¸­æ–­åˆå¹¶ï¼‰ ä½æµé‡ï¼šä¸­æ–­ é«˜æµé‡ï¼šè½®è¯¢ ğŸ“Œ é˜²æ­¢ä¸­æ–­é£æš´\nåã€ç½‘ç»œå‘½åç©ºé—´ï¼ˆNetwork Namespaceï¼‰ ç½‘ç»œä¸–ç•Œçš„â€œå¹³è¡Œå®‡å®™â€\næ¯ä¸ª namespace æ‹¥æœ‰ï¼š\nç½‘å¡ è·¯ç”±è¡¨ iptables conntrack ğŸ“Œ å®¹å™¨ç½‘ç»œåŸºç¡€\nåä¸€ã€veth / bridge / overlay veth æˆå¯¹è™šæ‹Ÿç½‘å¡ namespace è¿æ¥å™¨ bridge äºŒå±‚è½¬å‘ MAC å­¦ä¹  overlayï¼ˆVXLANï¼‰ L2 over L3 äº‘ / K8S é»˜è®¤ åäºŒã€eBPFï¼šç½‘ç»œå­ç³»ç»Ÿçš„â€œå¤–æŒ‚ç³»ç»Ÿâ€ ç”¨é€”ï¼š\nXDP TC BPF tracing ğŸ“Œ ç°ä»£ Linux ç½‘ç»œè°ƒä¼˜æ ¸å¿ƒ\nXDPï¼ˆæœ€æ—©æ‹¦åŒ…ï¼‰ NIC driver -\u0026gt; XDP -\u0026gt; DROP / PASS / REDIRECT æ€§èƒ½ï¼š\nç™¾ä¸‡ PPS ç»•è¿‡åè®®æ ˆ åä¸‰ã€DPDK / ç”¨æˆ·æ€ç½‘ç»œ å®Œå…¨ç»•è¿‡å†…æ ¸ poll + hugepage æè‡´æ€§èƒ½ âŒ ç®¡ç†å¤æ‚\nåå››ã€ç½‘ç»œæ€§èƒ½ç“¶é¢ˆåœ°å›¾ å±‚ å¸¸è§ç“¶é¢ˆ Socket buffer å¤ªå° TCP æ‹¥å¡æ§åˆ¶ IP è·¯ç”± Netfilter conntrack qdisc é˜Ÿåˆ— Driver ring buffer NIC offload åäº”ã€ç”Ÿäº§çº§è°ƒä¼˜è¦ç‚¹ï¼ˆé€Ÿè§ˆï¼‰ net.core.somaxconn net.ipv4.tcp_tw_reuse net.ipv4.tcp_fin_timeout net.core.netdev_max_backlog ğŸ“Œ è°ƒä¼˜æ°¸è¿œæ˜¯â€œä» skb èµ°å‘ NICâ€\nåå…­ã€äº‘ / å®¹å™¨ç¯å¢ƒçš„ç½‘ç»œç‰¹ç‚¹ è™šæ‹Ÿ NIC Overlay ç½‘ç»œ é«˜ RTT conntrack ä¾èµ–é‡ åä¸ƒã€æ€»ç»“ Linux ç½‘ç»œå­ç³»ç»Ÿæœ¬è´¨æ˜¯ï¼šskb åœ¨åè®®æ ˆã€è·¯ç”±ã€Hookã€é˜Ÿåˆ—ã€é©±åŠ¨ä¹‹é—´çš„é«˜æ€§èƒ½æµè½¬ç³»ç»Ÿã€‚\nä¸€ã€Linux ç½‘ç»œå­ç³»ç»Ÿæ•´ä½“æ¶æ„ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ åº”ç”¨å±‚ â”‚ â”‚ nginx / ssh / mysql / curl â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ socket API â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Socket å±‚ ï½œ â”‚ AF_INET / AF_INET6 / UNIX â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ protocol â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ åè®®æ ˆï¼ˆTCP/IPï¼‰ ï½œ â”‚ TCP / UDP / ICMP / RAW â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ routing â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è·¯ç”± \u0026amp; é‚»å±…å­ç³»ç»Ÿ ï½œ â”‚ route / arp / ndp â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ netfilter â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Netfilter / XDP / TC â”‚ â”‚ é˜²ç«å¢™ / NAT / é™é€Ÿ | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ driver â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç½‘ç»œè®¾å¤‡é©±åŠ¨ â”‚ â”‚ virtio / e1000 / ixgbe â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¡¬ä»¶ï¼ˆNICï¼‰ ï½œ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ äºŒã€Socket å±‚ï¼ˆåº”ç”¨ä¸å†…æ ¸çš„æ¥å£ï¼‰ 1ï¸âƒ£ Socket æ˜¯ä»€ä¹ˆï¼Ÿ Socket = åº”ç”¨è®¿é—®ç½‘ç»œçš„â€œæ–‡ä»¶æè¿°ç¬¦â€\nfd = socket(AF_INET, SOCK_STREAM, TCP) Linux çš„è®¾è®¡å“²å­¦\nä¸€åˆ‡çš†æ–‡ä»¶ ç½‘ç»œ = æ–‡ä»¶æè¿°ç¬¦ ls -l /proc/$$/fd 2ï¸âƒ£ åœ°å€æ—ï¼ˆAddress Familyï¼‰ AF å«ä¹‰ AF_INET IPv4 AF_INET6 IPv6 AF_UNIX æœ¬åœ°è¿›ç¨‹é€šä¿¡ AF_PACKET äºŒå±‚æŠ“åŒ… 3ï¸âƒ£ Socket ç±»å‹ ç±»å‹ ç”¨é€” SOCK_STREAM TCP SOCK_DGRAM UDP SOCK_RAW åŸå§‹åŒ… ä¸‰ã€åè®®æ ˆï¼ˆTCP/IP Stackï¼‰ 1ï¸âƒ£ TCP æ ¸å¿ƒæœºåˆ¶\nä¸‰æ¬¡æ¡æ‰‹ æ»‘åŠ¨çª—å£ é‡ä¼  æ‹¥å¡æ§åˆ¶ï¼ˆcubic / bbrï¼‰ sysctl net.ipv4.tcp_congestion_control 2ï¸âƒ£ UDP æ— è¿æ¥ ä¸ä¿è¯å¯é æ€§ ä½å»¶è¿Ÿ å…¸å‹åœºæ™¯ï¼š\nDNS è§†é¢‘ æ—¥å¿—é‡‡é›† 3ï¸âƒ£ ICMP ping path MTU ç½‘ç»œé”™è¯¯æŠ¥å‘Š å››ã€è·¯ç”±å­ç³»ç»Ÿï¼ˆRoutingï¼‰ 1ï¸âƒ£ è·¯ç”±è¡¨ ip route è·¯ç”±åŒ¹é…è§„åˆ™\næœ€é•¿å‰ç¼€åŒ¹é… metric scope 2ï¸âƒ£ å¤šè·¯ç”±è¡¨ï¼ˆPolicy Routingï¼‰ ip rule ip route show table 100 ğŸ“Œ ç”¨äºå¤šç½‘å¡ / VPN / å®¹å™¨\n3ï¸âƒ£ é‚»å±…è¡¨ï¼ˆARP / NDPï¼‰ ip neigh IPv4 -\u0026gt; ARP IPv6 -\u0026gt; NDP äº”ã€ç½‘ç»œè®¾å¤‡ï¼ˆNetdeviceï¼‰ 1ï¸âƒ£ ç½‘å¡ç±»å‹ ç±»å‹ åœºæ™¯ eth0 ç‰©ç† ens33 å¯é¢„æµ‹å‘½å lo æœ¬åœ° br0 æ¡¥ veth å®¹å™¨ tun/tap VPN 2ï¸âƒ£ é˜Ÿåˆ—ä¸ä¸­æ–­ TX/RX queue softirq NAPI cat /proc/interrupts å…­ã€Netfilterï¼ˆé˜²ç«å¢™ / NATï¼‰ 1ï¸âƒ£ äº”ä¸ª Hook ç‚¹ PREROUTING INPUT FORWARD OUTPUT POSTROUTING 2ï¸âƒ£ è¡¨ï¼ˆTableï¼‰ è¡¨ ä½œç”¨ raw è¿æ¥è¿½è¸ª mangle ä¿®æ”¹ nat åœ°å€è½¬æ¢ filter é˜²ç«å¢™ 3ï¸âƒ£ nftables vs iptables iptables nftables æ—¶ä»£ è€ æ–° æ€§èƒ½ ä¸€èˆ¬ æ›´é«˜ æ¨è âŒ âœ… ä¸ƒã€è¿æ¥è¿½è¸ªï¼ˆconntrackï¼‰ conntrack -L NAT é˜²ç«å¢™ ä¼šè¯ä¿æŒ ğŸ“Œ conntrack çˆ†æ»¡ = ç½‘ç»œé›ªå´©\nå…«ã€Traffic Controlï¼ˆTCï¼‰ å†…æ ¸çº§æµé‡æ§åˆ¶\né™é€Ÿ å»¶è¿Ÿ ä¸¢åŒ… tc qdisc show ä¹ã€XDP / eBPFï¼ˆé«˜æ€§èƒ½ç½‘ç»œï¼‰ XDP\né©±åŠ¨å±‚ ä¸‡å…† / ç™¾ä¸‡ PPS eBPF\nåŠ¨æ€æ³¨å…¥ æ— éœ€æ”¹å†…æ ¸ åã€IPv4 / IPv6 å…±å­˜æœºåˆ¶ dual stack IPv4-mapped IPv6 IPv6 socket fallback ğŸ“Œ è¿™ä¹Ÿæ˜¯ ç¦ IPv6 å‡ºé—®é¢˜ çš„æ ¹æœ¬åŸå› ä¹‹ä¸€\nåä¸€ã€ç½‘ç»œå‘½åç©ºé—´ï¼ˆNamespaceï¼‰ ip netns add test ip netns exec test ip a Docker K8S VPN åäºŒã€æ€§èƒ½æŒ‡æ ‡ \u0026amp; æ’æŸ¥ å¸¸ç”¨å·¥å…· å·¥å…· ä½œç”¨ ss è¿æ¥ tcpdump æŠ“åŒ… iperf åå ethtool ç½‘å¡ nstat TCP æ’æŸ¥æ€è·¯ï¼ˆéå¸¸é‡è¦ï¼‰ é“¾è·¯é€šå—ï¼Ÿ IP å¯¹å—ï¼Ÿ è·¯ç”±å¯¹å—ï¼Ÿ é˜²ç«å¢™æ‹¦äº†å—ï¼Ÿ å†…æ ¸å‚æ•°å¼‚å¸¸å—ï¼Ÿ åä¸‰ã€å‘è¡Œç‰ˆå·®å¼‚ï¼ˆé…ç½®å±‚ï¼‰ é¡¹ç›® RHEL / AlmaLinux Debian / Ubuntu ç½‘ç»œç®¡ç† NetworkManager netplan é˜²ç«å¢™ nftables / firewalld nftables DNS systemd-resolved resolved åå››ã€ä¸€å¥è¯æ€»ç»“ Linux ç½‘ç»œä¸æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œè€Œæ˜¯ä¸€æ•´å¥—ä»\nSocket -\u0026gt; åè®®æ ˆ -\u0026gt; è·¯ç”± -\u0026gt; é˜²ç«å¢™ -\u0026gt; é©±åŠ¨ -\u0026gt; ç¡¬ä»¶\nçš„â€œæ•°æ®é€šè·¯ç³»ç»Ÿâ€ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŒLinux å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿï¼šç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ã€çš„ç³»ç»Ÿçº§ã€å†…æ ¸çº§å®Œæ•´æ¢³ç†ã€‚\nå®šä½æ˜¯ï¼šå†…æ ¸åŸç† -\u0026gt; æ•°æ®è·¯å¾„ -\u0026gt; æ€§èƒ½ -\u0026gt; å®¹å™¨ / è™šæ‹ŸåŒ– / äº‘ / è°ƒä¼˜ã€‚\né€‚ç”¨äº RHEL / AlmaLinux / Debian / Ubuntuã€‚\nä¸€ã€Linux ç½‘ç»œå­ç³»ç»Ÿåœ¨å†…æ ¸ä¸­çš„ä½ç½® ç”¨æˆ·æ€åº”ç”¨ â†“ Socket APIï¼ˆglibcï¼‰ â†“ ç³»ç»Ÿè°ƒç”¨ï¼ˆsend / recvï¼‰ â†“ Socket Layer â†“ TCP / UDP / ICMP / IP â†“ Netfilter / Routing â†“ qdisc / TC â†“ NIC Driver â†“ ç½‘å¡ / DMA ğŸ“Œ Linux ç½‘ç»œ = ä¸€æ¡â€œåˆ†å±‚ + æ—è·¯ + é’©å­â€çš„å¤æ‚æµæ°´çº¿\n"},{"id":89,"href":"/operations/linux/kernel-devices/","title":"Linux è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices \u0026 Driversï¼‰","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŒLinux å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿï¼šè®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices \u0026amp; Driversï¼‰ã€çš„ç³»ç»Ÿçº§ã€å†…æ ¸çº§å®Œæ•´æ¢³ç†ã€‚\nå®šä½æ˜¯ï¼šç¡¬ä»¶ -\u0026gt; å†…æ ¸æŠ½è±¡ -\u0026gt; é©±åŠ¨æ¨¡å‹ -\u0026gt; æ€»çº¿ -\u0026gt; è®¾å¤‡ -\u0026gt; é©±åŠ¨ -\u0026gt; ç”¨æˆ·æ€ï¼Œå¹¶ä¸å‰é¢å·²ç»ç³»ç»Ÿæ¢³ç†è¿‡çš„ Process / Memory / FS / Networking / NUMA / å®¹å™¨ / è™šæ‹ŸåŒ– æ— ç¼è¡”æ¥ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆâ€œè®¾å¤‡ä¸é©±åŠ¨â€æ˜¯ Linux å†…æ ¸çš„éª¨æ¶ä¹‹ä¸€ æ²¡æœ‰é©±åŠ¨ï¼Œå†…æ ¸åªæ˜¯ä¸€æ®µä¸èƒ½å’Œç°å®ä¸–ç•Œäº¤äº’çš„ä»£ç ã€‚\nè®¾å¤‡ä¸é©±åŠ¨å­ç³»ç»Ÿè§£å†³çš„æ˜¯ï¼š\nå†…æ ¸å¦‚ä½•â€œå‘ç°â€ç¡¬ä»¶ å†…æ ¸å¦‚ä½•â€œç®¡ç†â€ç¡¬ä»¶ é©±åŠ¨å¦‚ä½•â€œç»‘å®šâ€è®¾å¤‡ ç”¨æˆ·æ€å¦‚ä½•â€œè®¿é—®â€è®¾å¤‡ ğŸ“Œ Linux çš„æ ¸å¿ƒå“²å­¦ï¼šç»Ÿä¸€æŠ½è±¡ + æ¨¡å—åŒ–é©±åŠ¨\näºŒã€Linux è®¾å¤‡æ¨¡å‹ï¼ˆDevice Modelï¼‰æ€»è§ˆ Linux é‡‡ç”¨ ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ï¼ˆUnified Device Modelï¼‰ï¼š\nBusï¼ˆæ€»çº¿ï¼‰ â”œâ”€â”€ Deviceï¼ˆè®¾å¤‡ï¼‰ â”‚ â””â”€â”€ Driverï¼ˆé©±åŠ¨ï¼‰ â””â”€â”€ Classï¼ˆè®¾å¤‡ç±»åˆ«ï¼‰ æ ¸å¿ƒå¯¹è±¡ï¼š\nå¯¹è±¡ å†…æ ¸ç»“æ„ æ€»çº¿ struct bus_type è®¾å¤‡ struct device é©±åŠ¨ struct device_driver ç±» struct class ğŸ“Œ sysfs æ­£æ˜¯è¿™ä¸ªæ¨¡å‹çš„â€œå¯è§†åŒ–æ˜ å°„â€\nä¸‰ã€è®¾å¤‡çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ è®¾å¤‡ = å¯è¢«å†…æ ¸ç®¡ç†çš„ç¡¬ä»¶å®ä½“æˆ–è™šæ‹Ÿå®ä½“\nè®¾å¤‡ç±»å‹\nç±»å‹ ç¤ºä¾‹ ç‰©ç†è®¾å¤‡ ç£ç›˜ã€ç½‘å¡ã€GPU è™šæ‹Ÿè®¾å¤‡ loopã€vethã€tap ä¼ªè®¾å¤‡ nullã€zero å¹³å°è®¾å¤‡ SoC å†…éƒ¨è®¾å¤‡ å››ã€æ€»çº¿ï¼ˆBusï¼‰ 1ï¸âƒ£ å¸¸è§æ€»çº¿ç±»å‹ æ€»çº¿ ç‰¹ç‚¹ PCI / PCIe è‡ªåŠ¨æšä¸¾ USB çƒ­æ’æ‹” I2C / SPI åµŒå…¥å¼ Platform éå¯æšä¸¾ Virtio è™šæ‹ŸåŒ– 2ï¸âƒ£ æ€»çº¿çš„èŒè´£ æšä¸¾è®¾å¤‡ åŒ¹é…é©±åŠ¨ ç»´æŠ¤è®¾å¤‡æ ‘ ğŸ“Œ æ€»çº¿æ˜¯â€œè®¾å¤‡ä¸é©±åŠ¨çš„åª’å©†â€\n3ï¸âƒ£ è®¾å¤‡ä¸é©±åŠ¨åŒ¹é… PCIï¼šVendor ID / Device ID USBï¼šVID / PID Platformï¼šname / DT äº”ã€é©±åŠ¨ï¼ˆDriverï¼‰ 1ï¸âƒ£ é©±åŠ¨çš„æ ¸å¿ƒèŒè´£ åˆå§‹åŒ–ç¡¬ä»¶ æ³¨å†Œè®¾å¤‡èŠ‚ç‚¹ æä¾› file_operations å¤„ç†ä¸­æ–­ / DMA 2ï¸âƒ£ å­—ç¬¦è®¾å¤‡ / å—è®¾å¤‡ å­—ç¬¦è®¾å¤‡ï¼ˆcdevï¼‰\nå­—èŠ‚æµ æ— ç¼“å­˜ ä¾‹ï¼šttyã€null å—è®¾å¤‡ï¼ˆbdevï¼‰\nå—è®¿é—® æœ‰ç¼“å­˜ ä¾‹ï¼šç£ç›˜ 3ï¸âƒ£ file_operations struct file_operations { .open .read .write .ioctl .mmap } ğŸ“Œ ç”¨æˆ·æ€è®¿é—®è®¾å¤‡çš„â€œæ¥å£åˆåŒâ€\nå…­ã€è®¾å¤‡èŠ‚ç‚¹ï¼ˆ/devï¼‰ /dev ä¸æ˜¯è®¾å¤‡ï¼Œæ˜¯è®¾å¤‡çš„â€œå…¥å£â€\nç”± udev åŠ¨æ€åˆ›å»º æ˜ å°„ major / minor crw-rw---- 1 root disk 8, 0 /dev/sda ä¸ƒã€sysfsï¼ˆ/sysï¼‰ å†…æ ¸è®¾å¤‡æ¨¡å‹çš„â€œå¯¼å‡ºè§†å›¾â€\n/sys â”œâ”€â”€ bus â”œâ”€â”€ devices â”œâ”€â”€ class â””â”€â”€ module ç”¨é€”ï¼š\næŸ¥çœ‹è®¾å¤‡çŠ¶æ€ è°ƒæ•´å‚æ•° è°ƒè¯•é©±åŠ¨ ğŸ“Œ æ¯” /proc æ›´ç»“æ„åŒ–\nå…«ã€ä¸­æ–­å­ç³»ç»Ÿï¼ˆInterruptï¼‰ 1ï¸âƒ£ ä¸­æ–­ç±»å‹ ç±»å‹ ç‰¹ç‚¹ ç¡¬ä¸­æ–­ å®æ—¶å“åº” è½¯ä¸­æ–­ å»¶è¿Ÿå¤„ç† tasklet è½¯ä¸­æ–­ workqueue è¿›ç¨‹ä¸Šä¸‹æ–‡ 2ï¸âƒ£ MSI / MSI-X ç°ä»£ PCIe è®¾å¤‡ é«˜æ€§èƒ½ç½‘å¡å¿…å¤‡ 3ï¸âƒ£ IRQ äº²å’Œæ€§ echo 3 \u0026gt; /proc/irq/XX/smp_affinity ğŸ“Œ NUMA / é«˜æ€§èƒ½å¿…è°ƒ\nä¹ã€DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰ è®¾å¤‡ç»•è¿‡ CPU ç›´æ¥è¯»å†™å†…å­˜\n1ï¸âƒ£ DMA å…³é”®ç‚¹ IOMMU bounce buffer cache coherency 2ï¸âƒ£ DMA API dma_alloc_coherent() dma_map_single() ğŸ“Œ é”™ç”¨ DMA = éšæœºå´©æºƒ\nåã€é©±åŠ¨æ¨¡å—ï¼ˆModulesï¼‰ 1ï¸âƒ£ å†…æ ¸æ¨¡å— .ko æ–‡ä»¶ åŠ¨æ€åŠ è½½ modprobe e1000 2ï¸âƒ£ æ¨¡å—ç”Ÿå‘½å‘¨æœŸ init -\u0026gt; probe -\u0026gt; remove -\u0026gt; exit 3ï¸âƒ£ æ¨¡å—ä¾èµ– lsmod modinfo åä¸€ã€udev ä¸è®¾å¤‡ç®¡ç† ç”¨æˆ·æ€è®¾å¤‡ç®¡ç†å®ˆæŠ¤è¿›ç¨‹\nèŒè´£ï¼š\nåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ è®¾ç½®æƒé™ è§¦å‘è„šæœ¬ ğŸ“Œ äº‘ / å®¹å™¨é«˜åº¦ä¾èµ– udev\nåäºŒã€è™šæ‹ŸåŒ–ä¸è®¾å¤‡ 1ï¸âƒ£ Virtio åŠè™šæ‹ŸåŒ–è®¾å¤‡ é«˜æ€§èƒ½ ç±»å‹ è®¾å¤‡ virtio-net ç½‘å¡ virtio-blk ç£ç›˜ 2ï¸âƒ£ SR-IOV ç¡¬ä»¶è™šæ‹ŸåŒ– VF / PF ğŸ“Œ æ•°æ®åº“ / é«˜ååå¿…é€‰\nåä¸‰ã€å®¹å™¨ä¸è®¾å¤‡ 1ï¸âƒ£ å®¹å™¨å¦‚ä½•ä½¿ç”¨è®¾å¤‡ namespace cgroup device controller bind mount /dev 2ï¸âƒ£ å®‰å…¨é™åˆ¶ cgroup devices.allow åå››ã€é©±åŠ¨æ€§èƒ½ç“¶é¢ˆåœ°å›¾ å±‚ å¸¸è§é—®é¢˜ IRQ å•æ ¸ç“¶é¢ˆ DMA IOMMU Driver é” Bus å¸¦å®½ ç”¨æˆ·æ€ copy åäº”ã€è°ƒè¯•ä¸æ’éšœå·¥å…· å·¥å…· ç”¨é€” dmesg é©±åŠ¨æ—¥å¿— lspci / lsusb è®¾å¤‡ udevadm äº‹ä»¶ perf æ€§èƒ½ ftrace è·Ÿè¸ª åå…­ã€è®¾å¤‡ä¸é©±åŠ¨ä¸€å¥è¯æ€»ç»“ Linux è®¾å¤‡ä¸é©±åŠ¨å­ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªé€šè¿‡æ€»çº¿æ¨¡å‹ï¼Œå°†ç°å®ä¸–ç•Œçš„ç¡¬ä»¶ï¼ŒæŠ½è±¡ä¸ºå†…æ ¸å¯¹è±¡ï¼Œå¹¶é€šè¿‡ç»Ÿä¸€æ¥å£æä¾›ç»™ç”¨æˆ·æ€çš„ç³»ç»Ÿã€‚\nåä¸ƒã€ä¸å‰é¢å­ç³»ç»Ÿçš„â€œè”åŠ¨å…³ç³»â€ å­ç³»ç»Ÿ å…³è” Process é©±åŠ¨è¿è¡Œåœ¨å†…æ ¸ Memory DMA / MMIO FS /dev / sysfs Networking NIC é©±åŠ¨ NUMA ä¸­æ–­ / DMA å®¹å™¨ è™šæ‹Ÿè®¾å¤‡ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŒLinux å†…æ ¸æ ¸å¿ƒå­ç³»ç»Ÿï¼šè®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices \u0026amp; Driversï¼‰ã€çš„ç³»ç»Ÿçº§ã€å†…æ ¸çº§å®Œæ•´æ¢³ç†ã€‚\nå®šä½æ˜¯ï¼šç¡¬ä»¶ -\u0026gt; å†…æ ¸æŠ½è±¡ -\u0026gt; é©±åŠ¨æ¨¡å‹ -\u0026gt; æ€»çº¿ -\u0026gt; è®¾å¤‡ -\u0026gt; é©±åŠ¨ -\u0026gt; ç”¨æˆ·æ€ï¼Œå¹¶ä¸å‰é¢å·²ç»ç³»ç»Ÿæ¢³ç†è¿‡çš„ Process / Memory / FS / Networking / NUMA / å®¹å™¨ / è™šæ‹ŸåŒ– æ— ç¼è¡”æ¥ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆâ€œè®¾å¤‡ä¸é©±åŠ¨â€æ˜¯ Linux å†…æ ¸çš„éª¨æ¶ä¹‹ä¸€ æ²¡æœ‰é©±åŠ¨ï¼Œå†…æ ¸åªæ˜¯ä¸€æ®µä¸èƒ½å’Œç°å®ä¸–ç•Œäº¤äº’çš„ä»£ç ã€‚\nè®¾å¤‡ä¸é©±åŠ¨å­ç³»ç»Ÿè§£å†³çš„æ˜¯ï¼š\nå†…æ ¸å¦‚ä½•â€œå‘ç°â€ç¡¬ä»¶ å†…æ ¸å¦‚ä½•â€œç®¡ç†â€ç¡¬ä»¶ é©±åŠ¨å¦‚ä½•â€œç»‘å®šâ€è®¾å¤‡ ç”¨æˆ·æ€å¦‚ä½•â€œè®¿é—®â€è®¾å¤‡ ğŸ“Œ Linux çš„æ ¸å¿ƒå“²å­¦ï¼šç»Ÿä¸€æŠ½è±¡ + æ¨¡å—åŒ–é©±åŠ¨\näºŒã€Linux è®¾å¤‡æ¨¡å‹ï¼ˆDevice Modelï¼‰æ€»è§ˆ Linux é‡‡ç”¨ ç»Ÿä¸€è®¾å¤‡æ¨¡å‹ï¼ˆUnified Device Modelï¼‰ï¼š\n"},{"id":90,"href":"/operations/linux/kernel-process/","title":"Linux è¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½ â€œå†…æ ¸çº§è§†è§’â€çš„ Linux è¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰æ ¸å¿ƒå­ç³»ç»Ÿè¯¦è§£ï¼Œä¸æ˜¯ ps/top ç”¨æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸æ•°æ®ç»“æ„ã€è°ƒåº¦ã€çŠ¶æ€ã€ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å®¹å™¨/NUMA çš„å®Œæ•´è®¤çŸ¥æ¡†æ¶ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€è¿›ç¨‹åœ¨ Linux å†…æ ¸ä¸­çš„æœ¬è´¨ Linux æ²¡æœ‰ â€œçº¿ç¨‹â€ è¿™ç§å†…æ ¸å¯¹è±¡ï¼Œåªæœ‰ taskï¼ˆä»»åŠ¡ï¼‰ã€‚\n1ï¸âƒ£ task_structï¼ˆæ ¸å¿ƒæ•°æ®ç»“æ„ï¼‰ struct task_struct { pid_t pid; long state; struct mm_struct *mm; struct files_struct *files; struct signal_struct *signal; struct sched_entity se; struct cgroup_subsys_state *css; ... } ğŸ“Œ è¿›ç¨‹ / çº¿ç¨‹ = task_struct çš„ä¸åŒç»„åˆ\næ¦‚å¿µ å†…æ ¸è§†è§’ è¿›ç¨‹ æœ‰ç‹¬ç«‹ mm çº¿ç¨‹ å…±äº« mm åç¨‹ ç”¨æˆ·æ€è°ƒåº¦ äºŒã€è¿›ç¨‹ vs çº¿ç¨‹ï¼ˆå†…æ ¸çœŸå®å·®å¼‚ï¼‰ é¡¹ç›® è¿›ç¨‹ çº¿ç¨‹ PID ä¸åŒ ä¸åŒ è™šæ‹Ÿåœ°å€ç©ºé—´ ç‹¬ç«‹ å…±äº« æ–‡ä»¶æè¿°ç¬¦ ç‹¬ç«‹ å…±äº« è°ƒåº¦å•ä½ task task ğŸ“Œ Linux çš„çº¿ç¨‹ = è½»é‡çº§è¿›ç¨‹\nä¸‰ã€è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸï¼ˆä»å‡ºç”Ÿåˆ°æ­»äº¡ï¼‰ 1ï¸âƒ£ åˆ›å»ºï¼šfork / clone / vfork fork()\nå¤åˆ¶ task_struct Copy-On-Write clone()\næŒ‡å®šå…±äº«èµ„æº åˆ›å»ºçº¿ç¨‹ã€å®¹å™¨çš„åŸºç¡€ clone(CLONE_VM | CLONE_FS | CLONE_FILES); 2ï¸âƒ£ æ‰§è¡Œï¼šexecve fork -\u0026gt; execve -\u0026gt; æ–°ç¨‹åº\næ›¿æ¢ç”¨æˆ·æ€ä»£ç  å†…æ ¸æ€ task_struct ä¸å˜ 3ï¸âƒ£ é€€å‡ºï¼šexit / _exit exit -\u0026gt; ZOMBIE -\u0026gt; reaped å››ã€è¿›ç¨‹çŠ¶æ€æœºï¼ˆæå…¶é‡è¦ï¼‰ TASK_RUNNING TASK_INTERRUPTIBLE TASK_UNINTERRUPTIBLE (D) TASK_STOPPED TASK_ZOMBIE D çŠ¶æ€ï¼ˆæœ€å¯æ€•ï¼‰\nç­‰å¾… IOï¼Œä¸èƒ½è¢« kill ğŸ“Œ æ•°æ®åº“ã€å­˜å‚¨ã€NFS å¸¸è§\näº”ã€è°ƒåº¦å­ç³»ç»Ÿï¼ˆSchedulerï¼‰ 1ï¸âƒ£ CFSï¼ˆå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼‰ æ ¸å¿ƒæ€æƒ³ï¼š\næŒ‰è™šæ‹Ÿè¿è¡Œæ—¶é—´å…¬å¹³åˆ†é… CPU\nvruntime = å®é™…è¿è¡Œæ—¶é—´ / æƒé‡ 2ï¸âƒ£ è°ƒåº¦é˜Ÿåˆ—ï¼ˆRunqueueï¼‰ æ¯ CPU ä¸€ä¸ª rq çº¢é»‘æ ‘ç»´æŠ¤ task 3ï¸âƒ£ è°ƒåº¦ç±» ç±»åˆ« åœºæ™¯ CFS æ™®é€šè¿›ç¨‹ RT å®æ—¶ä»»åŠ¡ Deadline ç¡®å®šæ€§å»¶è¿Ÿ 4ï¸âƒ£ ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆContext Switchï¼‰ åˆ‡æ¢å†…å®¹ï¼š\nCPU å¯„å­˜å™¨ å†…å­˜é¡µè¡¨ï¼ˆCR3ï¼‰ è°ƒåº¦å®ä½“ ğŸ“Œ ä¸Šä¸‹æ–‡åˆ‡æ¢ = æ€§èƒ½æ€æ‰‹\nå…­ã€CPU äº²å’Œæ€§ \u0026amp; NUMA 1ï¸âƒ£ CPU Affinity taskset -c 0-3 pid å†…æ ¸ä¸­ï¼š\ncpumask_t cpus_allowed; 2ï¸âƒ£ NUMA æ„ŸçŸ¥ æ¯ä¸ª task æœ‰ preferred node è‡ªåŠ¨è¿ç§»ï¼ˆNUMA balancingï¼‰ ğŸ“Œ æ•°æ®åº“å¼ºçƒˆå»ºè®® NUMA ç»‘å®š\nä¸ƒã€è¿›ç¨‹å†…å­˜ç®¡ç†å…³è” 1ï¸âƒ£ mm_struct struct mm_struct { pgd_t *pgd; unsigned long total_vm; unsigned long rss; } 2ï¸âƒ£ Copy-On-Write fork å‡ ä¹ 0 æˆæœ¬ å†™æ—¶å¤åˆ¶ 3ï¸âƒ£ OOM Killer é€‰æ‹©ä¾æ®ï¼š\noom_score å†…å­˜å ç”¨ cgroup é™åˆ¶ ğŸ“Œ å®¹å™¨ OOM â‰  ç³»ç»Ÿ OOM\nå…«ã€ä¿¡å·ï¼ˆSignalï¼‰ å¸¸è§ä¿¡å·\nä¿¡å· å«ä¹‰ SIGTERM ä¼˜é›…é€€å‡º SIGKILL å¼ºåˆ¶ SIGSTOP åœæ­¢ SIGSEGV æ®µé”™è¯¯ ä¿¡å·å¤„ç†æµç¨‹ äº§ç”Ÿ -\u0026gt; é€’é€ -\u0026gt; å¤„ç† ğŸ“Œ SIGKILL æ— æ³•è¢«æ•è·\nä¹ã€è¿›ç¨‹ä¸ cgroupsï¼ˆç°ä»£æ ¸å¿ƒï¼‰ systemd / Docker / K8S çš„æ ¹åŸº\n1ï¸âƒ£ èµ„æºæ§åˆ¶ CPU Memory IO PIDs 2ï¸âƒ£ è°ƒåº¦æ„ŸçŸ¥ cgroup task -\u0026gt; cgroup -\u0026gt; controller åã€Namespace ä¸è¿›ç¨‹éš”ç¦» Namespace éš”ç¦»å†…å®¹ PID è¿›ç¨‹å· Mount æ–‡ä»¶ç³»ç»Ÿ Network ç½‘ç»œ User UID/GID ğŸ“Œ å®¹å™¨ = namespace + cgroup + rootfs\nåä¸€ã€è¿›ç¨‹æ ‘ï¼ˆæ ‘çŠ¶ç»“æ„ï¼‰ systemd (1) â”œâ”€ sshd â”‚ â””â”€ bash â”œâ”€ nginx â””â”€ postgres çˆ¶å­å…³ç³» reparent åˆ° PID 1 åäºŒã€åƒµå°¸è¿›ç¨‹ï¼ˆZombieï¼‰ å·²æ­»ï¼Œæœªæ”¶å°¸\nåŸå› ï¼š\nçˆ¶è¿›ç¨‹æœª wait() è§£å†³ï¼š\nkill çˆ¶è¿›ç¨‹ ä¿®å¤ä»£ç  åä¸‰ã€å†…æ ¸å‚æ•°ï¼ˆè¿›ç¨‹ç›¸å…³ï¼‰ kernel.pid_max kernel.threads-max kernel.sched_migration_cost_ns åå››ã€å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–è§†è§’æ€»ç»“ å®¹å™¨ è¿›ç¨‹å°±æ˜¯å®¹å™¨ PID namespace æ˜¯å…³é”® æ•°æ®åº“ NUMA + CPU äº²å’Œæ€§ é¿å…é¢‘ç¹ fork è™šæ‹ŸåŒ– vCPU = è°ƒåº¦å®ä½“ steal time å½±å“è°ƒåº¦ åäº”ã€ä¸€å¥è¯ç»ˆææ€»ç»“ Linux è¿›ç¨‹ç®¡ç†çš„æœ¬è´¨ï¼štask_struct + è°ƒåº¦å™¨ + å†…å­˜ç®¡ç† + cgroup + namespace\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ â€œå†…æ ¸çº§è§†è§’â€çš„ Linux è¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰æ ¸å¿ƒå­ç³»ç»Ÿè¯¦è§£ï¼Œä¸æ˜¯ ps/top ç”¨æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸æ•°æ®ç»“æ„ã€è°ƒåº¦ã€çŠ¶æ€ã€ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°å®¹å™¨/NUMA çš„å®Œæ•´è®¤çŸ¥æ¡†æ¶ã€‚\né€‚ç”¨ RHEL / AlmaLinux / Debian / Ubuntu / äº‘ / å®¹å™¨ / æ•°æ®åº“ / è™šæ‹ŸåŒ–ã€‚\nä¸€ã€è¿›ç¨‹åœ¨ Linux å†…æ ¸ä¸­çš„æœ¬è´¨ Linux æ²¡æœ‰ â€œçº¿ç¨‹â€ è¿™ç§å†…æ ¸å¯¹è±¡ï¼Œåªæœ‰ taskï¼ˆä»»åŠ¡ï¼‰ã€‚\n1ï¸âƒ£ task_structï¼ˆæ ¸å¿ƒæ•°æ®ç»“æ„ï¼‰ struct task_struct { pid_t pid; long state; struct mm_struct *mm; struct files_struct *files; struct signal_struct *signal; struct sched_entity se; struct cgroup_subsys_state *css; ... } ğŸ“Œ è¿›ç¨‹ / çº¿ç¨‹ = task_struct çš„ä¸åŒç»„åˆ\n"},{"id":91,"href":"/operations/macos/","title":"macOS","parent":"Operations","content":"Document List:\nmacOS Tips ","description":"Document List:\nmacOS Tips "},{"id":92,"href":"/database/postgres/pgbackrest-config/","title":"pgBackRest é…ç½®æ–‡ä»¶è¯¦è§£","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å¯ç›´æ¥ç”¨äºç”Ÿäº§çš„ pgbackrest.conf é…ç½®æ–‡ä»¶è¯¦è§£ã€‚\næ¶µç›–ï¼šå…¨å±€å‚æ•°ã€Stanza å‚æ•°ã€S3/è¿œç¨‹ repoã€é«˜çº§å‚æ•°ã€æ€§èƒ½å‚æ•°ã€ä¿ç•™ç­–ç•¥ã€é˜²è¸©å‘è¯´æ˜ã€‚\npgbackrest.conf æ€»ä½“ç»“æ„ pgBackRest çš„é…ç½®æ–‡ä»¶é‡‡ç”¨ INI æ ¼å¼ï¼š\n[global] # å…¨å±€è®¾ç½®ï¼ˆæ‰€æœ‰ stanza å…±äº«ï¼‰ [stanza-name] # é’ˆå¯¹æŸä¸ª PostgreSQL å®ä¾‹çš„é…ç½® ç¤ºä¾‹ï¼š\n[global] repo1-path=/data/pgbackrest/repo1 [main] pg1-path=/var/lib/pgsql/16/data ä¸€ã€[global] å…¨å±€æ®µï¼ˆæœ€å¸¸ç”¨å‚æ•°ï¼‰ 1. repo ç›¸å…³ï¼ˆæœ€å…³é”®ï¼‰ repo1-path å¤‡ä»½ä»“åº“è·¯å¾„ï¼š\nrepo1-path=/data/pgbackrest/repo1 repo1-hostï¼ˆè¿œç¨‹å¤‡ä»½ä¸»æœºï¼‰ repo1-host=backup-server repo1-host-user=postgres ğŸ“Œ ç”¨äº DB -\u0026gt; repo è¿œç¨‹å­˜å‚¨ã€‚\nrepo å¤šä»“åº“æ”¯æŒ repo2-path=/data/repo2 repo3-type=s3 2. å‹ç¼©ï¼ˆèŠ‚çœç©ºé—´ï¼‰ compress-type=zstd compress-level=3 æ¨èä½¿ç”¨ zstdï¼Œé€Ÿåº¦å¿«ã€å‹ç¼©æ¯”é«˜ã€‚\n3. æ—¥å¿— log-level-console=info log-level-file=detail log-path=/var/log/pgbackrest å¯é€‰çº§åˆ«ï¼šerror, warn, info, detail, debug\n4. æ€§èƒ½å‚æ•°ï¼ˆå¼ºçƒˆæ¨èï¼‰ å¤šçº¿ç¨‹ process-max=8 å¯ä»¥æŒ‰ CPU æ ¸å¿ƒæ•°è°ƒæ•´ï¼Œæå‡å¤‡ä»½ã€æ¢å¤é€Ÿåº¦ã€‚\n5. ä¿ç•™ç­–ç•¥ï¼ˆéå¸¸é‡è¦ï¼‰ ä¿ç•™ full å¤‡ä»½æ•°é‡ repo1-retention-full=7 ä»…ä¿ç•™æœ€æ–° 7 ä¸ª å…¨é‡å¤‡ä»½ï¼ˆå·®é‡å’Œå¢é‡è‡ªåŠ¨ä»¥ full ä¸ºåŸºå‡†åˆ é™¤ï¼‰ã€‚\nä¿ç•™æ—¶é—´æ¨¡å¼ï¼ˆæŒ‰å¤©ï¼‰ repo1-retention-full-type=time repo1-retention-full=30 # ä¿ç•™ 30 å¤© WAL ä¿ç•™ç­–ç•¥ é€šå¸¸ä¸å•ç‹¬æŒ‡å®šï¼ŒpgBackRest è‡ªåŠ¨ç®¡ç†ã€‚\n6. å®‰å…¨å‚æ•° repo1-cipher-type=aes-256-cbc repo1-cipher-pass=\u0026#34;StrongPassword123!\u0026#34; ç”¨äºå¤‡ä»½åŠ å¯†ï¼ˆå¯é€‰ï¼‰ã€‚\n7. S3 / MinIO å‚æ•°ï¼ˆå¦‚æœä½¿ç”¨ S3 repoï¼‰ repo1-type=s3 repo1-s3-endpoint=s3.amazonaws.com repo1-s3-bucket=pg-backup repo1-s3-region=us-east-1 repo1-s3-key=\u0026lt;your-key\u0026gt; repo1-s3-key-secret=\u0026lt;your-secret\u0026gt; repo1-s3-verify-tls=n MinIO ç¤ºä¾‹ï¼š\nrepo1-type=s3 repo1-s3-endpoint=minio.local:9000 repo1-s3-region=us-east-1 repo1-s3-bucket=pg repo1-s3-key=minio repo1-s3-key-secret=minio123 repo1-s3-uri-style=path repo1-s3-verify-tls=n äºŒã€[stanza] æ®µï¼ˆæ¯ä¸ª PostgreSQL é›†ç¾¤ä¸€ä»½ï¼‰ 1. PG æ•°æ®ç›®å½• pg1-path=/var/lib/pgsql/16/data å¦‚æœæ˜¯è¿œç¨‹å¤‡ä»½ï¼ˆDB host != repo hostï¼‰ï¼Œä½¿ç”¨ï¼š\npg1-host=db-server pg1-host-user=postgres pg1-path=/var/lib/pgsql/16/data 2. WAL å½’æ¡£ï¼ˆå¤©ç©ºçº§é‡è¦ï¼‰ WAL archive_command ä¼šè°ƒç”¨ archive-pushï¼š\npostgresql.conf éœ€é…ç½®ï¼š\narchive_mode=on archive_command=\u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; pgbackrest.conf ä¸éœ€è¦é¢å¤–é…ç½®å½’æ¡£å‚æ•°ï¼Œé™¤éï¼š\né™åˆ¶ WAL å½’æ¡£å¹¶å‘\narchive-async=y archive-push-queue-max=8 3. æ¢å¤ç›¸å…³å‚æ•° æŒ‡å®šæ¢å¤ç›®æ ‡\nrecovery-option=target-action=promote recovery-option=target-time=2025-01-18 10:12:00 ä½†é€šå¸¸ä¸ä¼šå†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯æ¢å¤æ—¶è¿è¡Œå‘½ä»¤ï¼š\npgbackrest --stanza=main --type=time --target=\u0026#39;2025-01-18 10:12:00\u0026#39; restore ä¸‰ã€å®Œæ•´æœ¬åœ°å¤‡ä»½é…ç½®ç¤ºä¾‹ï¼ˆç”Ÿäº§å¯ç”¨ï¼‰ [global] repo1-path=/data/pgbackrest/repo1 repo1-retention-full=7 compress-type=zstd compress-level=3 log-level-console=info log-level-file=detail log-path=/var/log/pgbackrest process-max=8 start-fast=y [main] pg1-path=/var/lib/pgsql/16/data å››ã€å®Œæ•´è¿œç¨‹å¤‡ä»½ï¼ˆDB-\u0026gt;å¤‡ä»½æœåŠ¡å™¨ï¼‰é…ç½®ç¤ºä¾‹ â­ repo æœåŠ¡å™¨ /etc/pgbackrest/pgbackrest.conf [global] repo1-path=/data/pgbackrest/repo1 [main] pg1-host=db01 pg1-host-user=postgres pg1-path=/var/lib/pgsql/16/data â­ æ•°æ®åº“æœåŠ¡å™¨ /etc/pgbackrest/pgbackrest.conf [global] repo1-host=backup01 repo1-host-user=postgres äº”ã€å®Œæ•´ S3/MinIO é…ç½®ç¤ºä¾‹ï¼ˆä¼ä¸šå¸¸ç”¨ï¼‰ [global] repo1-type=s3 repo1-s3-endpoint=minio.local:9000 repo1-s3-bucket=pg repo1-s3-region=us-east-1 repo1-s3-uri-style=path repo1-s3-key=minio repo1-s3-key-secret=minio123 repo1-s3-verify-tls=n repo1-path=/pgbackrest repo1-retention-full=14 compress-type=zstd compress-level=3 process-max=4 log-level-console=info [main] pg1-path=/var/lib/pgsql/16/data å…­ã€å¸¸è§é«˜çº§å‚æ•° ğŸ“Œ ç¦ç”¨ fsyncï¼ˆä¸å®‰å…¨ï¼Œä½†ç”¨äºæµ‹è¯•ï¼‰ repo1-fsync=n ğŸ“Œ ç¦ç”¨å¤‡ä»½æ–‡ä»¶æ ¡éªŒï¼ˆä¸å»ºè®®ï¼‰ checksum-page=n ğŸ“Œ å¹¶è¡Œæ ¡éªŒ repo1-checksum=y ğŸ“Œ é™åˆ¶æµé‡ ç”¨äºå¸¦å®½æ•æ„Ÿç¯å¢ƒï¼š\nbandwidth-limit=50MB/s ä¸ƒã€é…ç½®æ–‡ä»¶å¸¸è§è¸©å‘ âŒ 1. repo1-path ç›®å½•æƒé™ä¸å¯¹ï¼ˆæœ€å¸¸è§ï¼‰ å¿…é¡»æ˜¯ postgres ç”¨æˆ·è¯»å†™ï¼š\nchown -R postgres:postgres /data/pgbackrest chmod 750 /data/pgbackrest âŒ 2. ä¸¤å°æœºä¹‹é—´ SSH æœªå…å¯† éœ€è¦ï¼š\nssh-copy-id postgres@repo-server âŒ 3. archive_command å†™é”™æˆ–æ²¡æ‰§è¡Œ åº”ä¸ºï¼š\npgbackrest --stanza=main archive-push %p ä¸èƒ½åŠ å¼•å·ã€ä¸èƒ½ç¼ºå‚æ•°ã€‚\nâŒ 4. ä½¿ç”¨ S3 å¿˜è®°å…³é—­ TLS MinIO çš„è‡ªç­¾åè¯ä¹¦ä¼šæŠ¥é”™ï¼š\nrepo1-s3-verify-tls=n ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å¯ç›´æ¥ç”¨äºç”Ÿäº§çš„ pgbackrest.conf é…ç½®æ–‡ä»¶è¯¦è§£ã€‚\næ¶µç›–ï¼šå…¨å±€å‚æ•°ã€Stanza å‚æ•°ã€S3/è¿œç¨‹ repoã€é«˜çº§å‚æ•°ã€æ€§èƒ½å‚æ•°ã€ä¿ç•™ç­–ç•¥ã€é˜²è¸©å‘è¯´æ˜ã€‚\npgbackrest.conf æ€»ä½“ç»“æ„ pgBackRest çš„é…ç½®æ–‡ä»¶é‡‡ç”¨ INI æ ¼å¼ï¼š\n[global] # å…¨å±€è®¾ç½®ï¼ˆæ‰€æœ‰ stanza å…±äº«ï¼‰ [stanza-name] # é’ˆå¯¹æŸä¸ª PostgreSQL å®ä¾‹çš„é…ç½® ç¤ºä¾‹ï¼š\n[global] repo1-path=/data/pgbackrest/repo1 [main] pg1-path=/var/lib/pgsql/16/data ä¸€ã€[global] å…¨å±€æ®µï¼ˆæœ€å¸¸ç”¨å‚æ•°ï¼‰ 1. repo ç›¸å…³ï¼ˆæœ€å…³é”®ï¼‰ repo1-path å¤‡ä»½ä»“åº“è·¯å¾„ï¼š\n"},{"id":93,"href":"/backend/python/official/python-tutorial/","title":"Python å®˜æ–¹æ•™ç¨‹æ€»ç»“","parent":"Official","content":"ä»¥ Python 3.12 ä¸ºåŸºç¡€ã€‚\nå®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/tutorial/index.html\nä»¥ä¸‹æ˜¯å¯¹å®˜æ–¹æ–‡æ¡£çš„æ€»ç»“ã€‚\nä½¿ç”¨ Python çš„è§£é‡Šå™¨ Python 3.12 è§£é‡Šå™¨çš„å¯åŠ¨ã€ä½¿ç”¨å’Œç¯å¢ƒé…ç½®æ–¹æ³•ï¼š\n1. å¯åŠ¨ Python è§£é‡Šå™¨ Unix/Linuxç³»ç»Ÿï¼šé€šå¸¸å®‰è£…åœ¨ /usr/local/bin/python3.12ï¼Œå¯é€šè¿‡ python3.12 å‘½ä»¤å¯åŠ¨ Windowsç³»ç»Ÿï¼šå¯é€šè¿‡ Microsoft Store å®‰è£…çš„ python3.12 å‘½ä»¤æˆ– py å‘½ä»¤å¯åŠ¨ é€€å‡ºæ–¹å¼ï¼šä½¿ç”¨ Ctrl+Dï¼ˆUnixï¼‰æˆ– Ctrl+Zï¼ˆWindowsï¼‰ï¼Œæˆ–è¾“å…¥ quit() 2. è§£é‡Šå™¨å·¥ä½œæ¨¡å¼ äº¤äº’æ¨¡å¼ï¼šåœ¨ç»ˆç«¯ä¸­ç›´æ¥è¾“å…¥ Python ä»£ç ï¼Œä¸»æç¤ºç¬¦ä¸º \u0026gt;\u0026gt;\u0026gt;ï¼Œè¿ç»­è¡Œæç¤ºç¬¦ä¸º ... è„šæœ¬æ¨¡å¼ï¼šæ‰§è¡Œæ–‡ä»¶ä¸­çš„ Python ä»£ç  å‘½ä»¤è¡Œæ‰§è¡Œï¼šä½¿ç”¨ python -c command æ‰§è¡Œå•è¡Œå‘½ä»¤ æ¨¡å—æ‰§è¡Œï¼šä½¿ç”¨ python -m module æ‰§è¡Œæ¨¡å— 3. å‘½ä»¤è¡Œå‚æ•°å¤„ç† å‚æ•°å­˜å‚¨åœ¨ sys.argv åˆ—è¡¨ä¸­ è¯¥åˆ—è¡¨æœ€å°‘æœ‰ä¸€ä¸ªå…ƒç´  æ— å‚æ•°ï¼šsys.argv[0] æ˜¯ç©ºå­—ç¬¦ä¸² æœ‰å‚æ•°ï¼šsys.argv[0] è„šæœ¬åï¼Œåç»­å…ƒç´ æ˜¯ä¼ å…¥çš„å‚æ•° ä¸åŒå¯åŠ¨æ–¹å¼å¯¹ sys.argv[0] çš„å¤„ç†ä¸åŒ 4. æ–‡ä»¶ç¼–ç æ”¯æŒ é»˜è®¤ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œæ”¯æŒå¤šç§è¯­è¨€å­—ç¬¦ å¯é€šè¿‡ç‰¹æ®Šæ³¨é‡Šå£°æ˜å…¶ä»–ç¼–ç æ ¼å¼ ç¼–ç å£°æ˜éœ€æ”¾åœ¨æ–‡ä»¶ç¬¬ä¸€è¡Œï¼ˆshebangè¡Œé™¤å¤–ï¼‰ 5. ç¯å¢ƒé…ç½® æ”¯æŒè¡Œç¼–è¾‘åŠŸèƒ½ï¼ˆåŸºäº GNU Readline åº“ï¼‰ å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Python è¿è¡Œç¯å¢ƒ Python é€Ÿè§ˆ ä»‹ç» Python ä½œä¸ºè®¡ç®—å™¨çš„åŸºæœ¬ç”¨æ³•å’Œæ ¸å¿ƒæ¦‚å¿µï¼š\n1. Python åŸºç¡€æ¦‚å¿µ æ³¨é‡Šï¼šä»¥ # å¼€å¤´ï¼Œç”¨äºè§£é‡Šä»£ç ä½†ä¸è¢«æ‰§è¡Œ äº¤äº’å¼ä½¿ç”¨ï¼šåŒºåˆ†è¾“å…¥ï¼ˆ \u0026gt;\u0026gt;\u0026gt; æç¤ºç¬¦ï¼‰å’Œè¾“å‡ºï¼ˆæ— æç¤ºç¬¦ï¼‰ 2. æ•°å­—è¿ç®— åŸºæœ¬è¿ç®—ï¼šæ”¯æŒ +ã€-ã€*ã€/ ç­‰ç®—æœ¯è¿ç®—ç¬¦ æ•°æ®ç±»å‹ï¼šæ•´æ•°ï¼ˆintï¼‰å’Œæµ®ç‚¹æ•°ï¼ˆfloatï¼‰ é™¤æ³•è¿ç®— (/) æ€»æ˜¯è¿”å›æµ®ç‚¹æ•° Python å…¨é¢æ”¯æŒæµ®ç‚¹æ•°ï¼›æ··åˆç±»å‹è¿ç®—æ•°çš„è¿ç®—ä¼šæŠŠæ•´æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•° ç‰¹æ®Šè¿ç®—ï¼š// æ•´é™¤ã€% å–ä½™ã€** å¹‚è¿ç®— å˜é‡èµ‹å€¼ï¼šä½¿ç”¨ = æ“ä½œç¬¦ äº¤äº’å¼å˜é‡ï¼š_ å˜é‡ä¿å­˜ä¸Šæ¬¡è®¡ç®—ç»“æœ åˆ†ç»„ï¼šåœ†æ‹¬å· () 3. å­—ç¬¦ä¸²æ“ä½œ å®šä¹‰æ–¹å¼ï¼šå•å¼•å·æˆ–åŒå¼•å·åŒ…å›´ è½¬ä¹‰å­—ç¬¦ï¼šä½¿ç”¨ \\ å¤„ç†ç‰¹æ®Šå­—ç¬¦ åŸå§‹å­—ç¬¦ä¸²ï¼šr å‰ç¼€é¿å…è½¬ä¹‰ å¤šè¡Œå­—ç¬¦ä¸²ï¼šä¸‰é‡å¼•å·æ”¯æŒ å­—ç¬¦ä¸²æ“ä½œï¼šæ”¯æŒ + è¿æ¥ã€* é‡å¤ ç´¢å¼•å’Œåˆ‡ç‰‡ï¼š[0] è®¿é—®å•å­—ç¬¦ï¼Œ[0:2] è·å–å­ä¸² ä¸å¯å˜æ€§ï¼šå­—ç¬¦ä¸²å†…å®¹ä¸å¯ä¿®æ”¹ 4. åˆ—è¡¨æ“ä½œ å®šä¹‰ï¼šæ–¹æ‹¬å· [] åŒ…å›´ï¼Œé€—å·åˆ†éš” å¯å˜æ€§ï¼šä¸å­—ç¬¦ä¸²ä¸åŒï¼Œåˆ—è¡¨å†…å®¹å¯ä¿®æ”¹ æ“ä½œæ–¹æ³•ï¼šæ”¯æŒç´¢å¼•ã€åˆ‡ç‰‡ã€è¿½åŠ ï¼ˆappendï¼‰ åµŒå¥—ï¼šå¯åˆ›å»ºåŒ…å«å…¶ä»–åˆ—è¡¨çš„åˆ—è¡¨ èµ‹å€¼æ³¨æ„ï¼šç®€å•èµ‹å€¼ä¸å¤åˆ¶æ•°æ®ï¼Œè€Œæ˜¯å¼•ç”¨ 5. ç¼–ç¨‹åŸºç¡€ å¾ªç¯ç»“æ„ï¼šwhile å¾ªç¯é…åˆç¼©è¿›ç»„ç»‡ä»£ç  å¤šé‡èµ‹å€¼ï¼ša, b = 0, 1 åŒæ—¶èµ‹å€¼å¤šä¸ªå˜é‡ è¾“å‡ºå‡½æ•°ï¼šprint() å‡½æ•°æ ¼å¼åŒ–è¾“å‡º ç¼©è¿›è§„åˆ™ï¼šPython ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºä»£ç å— æ§åˆ¶æµå·¥å…·å’Œå‡½æ•°å®šä¹‰ ä»‹ç» Python çš„æ§åˆ¶æµè¯­å¥å’Œå‡½æ•°å®šä¹‰çš„é«˜çº§ç‰¹æ€§\n1. æ§åˆ¶æµè¯­å¥ ifè¯­å¥ï¼šæ”¯æŒ elif å’Œ elseï¼Œå¯æ›¿ä»£å…¶ä»–è¯­è¨€çš„ switch è¯­å¥ forè¯­å¥ï¼šåœ¨åºåˆ—å…ƒç´ ä¸Šè¿­ä»£ï¼Œè€Œéç®—æœ¯é€’å¢ range()å‡½æ•°ï¼šç”Ÿæˆç­‰å·®æ•°åˆ—ï¼Œæ”¯æŒèµ·å§‹å€¼ã€æ­¥é•¿å‚æ•° breakå’Œcontinueï¼šåˆ†åˆ«ç”¨äºè·³å‡ºå¾ªç¯å’Œè·³åˆ°ä¸‹æ¬¡è¿­ä»£ å¾ªç¯çš„elseå­å¥ï¼šå½“å¾ªç¯æ­£å¸¸ç»“æŸï¼ˆæ— breakï¼‰æ—¶æ‰§è¡Œ passè¯­å¥ï¼šç©ºæ“ä½œï¼Œç”¨ä½œå ä½ç¬¦ 2. matchè¯­å¥ Python 3.10+ çš„æ–°ç‰¹æ€§ ç±»ä¼¼æ¨¡å¼åŒ¹é…ï¼Œæ¯”ä¼ ç»Ÿ switch è¯­å¥æ›´å¼ºå¤§ æ”¯æŒå­—é¢å€¼åŒ¹é…ã€è§£åŒ…èµ‹å€¼ã€ç±»æ¨¡å¼åŒ¹é…ç­‰ å¯ä½¿ç”¨é€šé…ç¬¦å’Œçº¦æŸæ¡ä»¶ 3. å‡½æ•°å®šä¹‰ åŸºæœ¬è¯­æ³•ï¼šä½¿ç”¨ def å…³é”®å­—å®šä¹‰ æ–‡æ¡£å­—ç¬¦ä¸²ï¼šå‡½æ•°é¦–è¡Œçš„å­—ç¬¦ä¸²ä½œä¸ºæ–‡æ¡£ è¿”å›å€¼ï¼šä½¿ç”¨ return è¯­å¥ï¼Œæ— è¿”å›å€¼æ—¶é»˜è®¤è¿”å› None å±€éƒ¨/å…¨å±€ä½œç”¨åŸŸï¼šå‡½æ•°å†…éƒ¨å˜é‡ä¸å½±å“å¤–éƒ¨ 4. å‡½æ•°å‚æ•°ç±»å‹ é»˜è®¤å€¼å‚æ•°ï¼šå‚æ•°å¯è®¾ç½®é»˜è®¤å€¼ å…³é”®å­—å‚æ•°ï¼šæŒ‰å‚æ•°åä¼ é€’ ç‰¹æ®Šå‚æ•°ç±»å‹ï¼š ä»…é™ä½ç½®å‚æ•°ï¼ˆ/å‰ï¼‰ ä½ç½®æˆ–å…³é”®å­—å‚æ•°ï¼ˆ/å’Œ*ä¹‹é—´ï¼‰ ä»…é™å…³é”®å­—å‚æ•°ï¼ˆ*åï¼‰ å¯å˜å‚æ•°ï¼š*args æ¥æ”¶ä»»æ„æ•°é‡ä½ç½®å‚æ•°ï¼Œ**kwargs æ¥æ”¶å…³é”®å­—å‚æ•° 5. é«˜çº§ç‰¹æ€§ å‚æ•°è§£åŒ…ï¼šä½¿ç”¨ * å’Œ ** æ“ä½œç¬¦è§£åŒ…åˆ—è¡¨/å­—å…¸å‚æ•° Lambdaè¡¨è¾¾å¼ï¼šåˆ›å»ºåŒ¿åå‡½æ•° å‡½æ•°æ³¨è§£ï¼šä¸ºå‚æ•°å’Œè¿”å›å€¼æ·»åŠ ç±»å‹ä¿¡æ¯ æ–‡æ¡£å­—ç¬¦ä¸²æ ¼å¼ï¼šéµå¾ª PEP 257 çº¦å®š 6. ç¼–ç é£æ ¼å»ºè®® éµå¾ª PEP 8 é£æ ¼æŒ‡å— ä½¿ç”¨ 4 ä¸ªç©ºæ ¼ç¼©è¿› æ¯è¡Œä¸è¶…è¿‡ 79 ä¸ªå­—ç¬¦ åˆç†ä½¿ç”¨ç©ºè¡Œåˆ†éš” ä¿æŒå‘½åä¸€è‡´æ€§ Python æ•°æ®ç»“æ„ ä»‹ç» Python çš„æ ¸å¿ƒæ•°æ®ç»“æ„åŠå…¶æ“ä½œæ–¹æ³•\n1. åˆ—è¡¨è¯¦è§£ åˆ—è¡¨æ–¹æ³•ï¼šåŒ…å« appendã€extendã€insertã€removeã€popã€clearã€indexã€countã€sortã€reverseã€copy ç­‰ æ ˆæ“ä½œï¼šä½¿ç”¨ append() å’Œ pop() å®ç°åè¿›å…ˆå‡º é˜Ÿåˆ—æ“ä½œï¼šæ¨èä½¿ç”¨ collections.deque å®ç°å…ˆè¿›å…ˆå‡º å¯¼å…¥ï¼šfrom collections import deque åˆ›å»ºé˜Ÿåˆ—ï¼šqueue = deque([\u0026quot;Eric\u0026quot;, \u0026quot;John\u0026quot;, \u0026quot;Michael\u0026quot;]) è¿›é˜Ÿåˆ—ï¼šqueue.append(\u0026quot;Terry\u0026quot;) å‡ºé˜Ÿåˆ—ï¼šqueue.popleft()ï¼ŒEric å…ˆå‡ºï¼Œåˆ—è¡¨å‰©ä½™ [\u0026quot;John\u0026quot;, \u0026quot;Michael\u0026quot;, \u0026quot;Terry\u0026quot;] åˆ—è¡¨æ¨å¯¼å¼ï¼šç®€æ´çš„åˆ—è¡¨åˆ›å»ºæ–¹å¼ï¼Œå¦‚ [x**2 for x in range(10)] åµŒå¥—åˆ—è¡¨æ¨å¯¼å¼ï¼šæ”¯æŒå¤æ‚çš„å¤šå±‚åµŒå¥—æ“ä½œ 2. del è¯­å¥ æŒ‰ç´¢å¼•åˆ é™¤åˆ—è¡¨å…ƒç´  æ”¯æŒåˆ é™¤åˆ‡ç‰‡æˆ–æ•´ä¸ªå˜é‡ 3. å…ƒç»„å’Œåºåˆ— å…ƒç»„ï¼šä¸å¯å˜åºåˆ—ï¼Œç”¨é€—å·åˆ†éš”å€¼åˆ›å»º å…ƒç»„æ‰“åŒ…å’Œè§£åŒ…ï¼šæ”¯æŒå€¼çš„æ‰¹é‡èµ‹å€¼ ä¸åˆ—è¡¨çš„åŒºåˆ«ï¼šä¸å¯å˜ã€å¼‚è´¨å…ƒç´ ã€é€šè¿‡ç´¢å¼•æˆ–è§£åŒ…è®¿é—® 4. é›†åˆ åˆ›å»ºï¼šç”¨ èŠ±æ‹¬å· æˆ– set() å‡½æ•° æ³¨æ„ï¼šåˆ›å»º ç©ºé›†åˆ åªèƒ½ç”¨ set()ï¼Œä¸èƒ½ç”¨ {}ï¼Œ{} åˆ›å»ºçš„æ˜¯ç©ºå­—å…¸ ç‰¹ç‚¹ï¼šä¸é‡å¤å…ƒç´ çš„æ— åºå®¹å™¨ åŸºæœ¬æ“ä½œï¼šæˆå‘˜æ£€æµ‹ã€å»é‡ é›†åˆè¿ç®—ï¼šæ”¯æŒåˆé›†(|)ã€äº¤é›†(\u0026amp;)ã€å·®é›†(-)ã€å¯¹ç§°å·®åˆ†(^) é›†åˆæ¨å¯¼å¼ï¼šç±»ä¼¼åˆ—è¡¨æ¨å¯¼å¼ 5. å­—å…¸ é”®å€¼å¯¹å­˜å‚¨ï¼šä»¥é”®ç´¢å¼•çš„æ˜ å°„ç±»å‹ æ“ä½œæ–¹æ³•ï¼šæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾é”®å€¼å¯¹ åˆ›å»ºæ–¹å¼ï¼šèŠ±æ‹¬å·ã€dict() æ„é€ å‡½æ•°ã€å­—å…¸æ¨å¯¼å¼ é”®çš„é™åˆ¶ï¼šå¿…é¡»æ˜¯ä¸å¯å˜ç±»å‹ 6. å¾ªç¯æŠ€å·§ å­—å…¸å¾ªç¯ï¼šä½¿ç”¨ items() åŒæ—¶è·å–é”®å€¼ enumerate()ï¼šåŒæ—¶è·å–ç´¢å¼•å’Œå€¼ zip()ï¼šåŒæ—¶éå†å¤šä¸ªåºåˆ— reversed()ï¼šé€†å‘å¾ªç¯ sorted()ï¼šæ’åºåå¾ªç¯ 7. æ¡ä»¶æ§åˆ¶ æ¯”è¾ƒè¿ç®—ç¬¦ï¼šinã€not inã€isã€is not é“¾å¼æ¯”è¾ƒï¼šå¦‚ a \u0026lt; b == c çŸ­è·¯è¿ç®—ï¼šandã€or è¿ç®—ç¬¦çš„çŸ­è·¯ç‰¹æ€§ æµ·è±¡è¿ç®—ç¬¦ï¼š:= ç”¨äºè¡¨è¾¾å¼å†…èµ‹å€¼ 8. åºåˆ—æ¯”è¾ƒ å­—å…¸å¼é¡ºåºï¼šé€å…ƒç´ æ¯”è¾ƒ ç±»å‹æ¯”è¾ƒï¼šç›¸åŒç±»å‹åºåˆ—å¯æ¯”è¾ƒï¼Œä¸åŒç±»å‹éœ€é€‚å½“æ–¹æ³• Python æ¨¡å—å’ŒåŒ… ä»‹ç» Python çš„æ¨¡å—ç³»ç»Ÿå’ŒåŒ…ç®¡ç†æœºåˆ¶\n1. æ¨¡å—åŸºç¡€ æ¨¡å—å®šä¹‰ï¼šåŒ…å« Python å®šä¹‰å’Œè¯­å¥çš„æ–‡ä»¶ï¼Œä»¥ .py ä¸ºåç¼€ å¯¼å…¥æ–¹å¼ï¼š import moduleï¼šå¯¼å…¥æ•´ä¸ªæ¨¡å— from module import functionï¼šå¯¼å…¥ç‰¹å®šå‡½æ•° from module import *ï¼šå¯¼å…¥æ‰€æœ‰å…¬å…±åç§° ä½¿ç”¨aså…³é”®å­—è¿›è¡Œåˆ«åå¯¼å…¥ æ¨¡å—å‘½åç©ºé—´ï¼šæ¯ä¸ªæ¨¡å—æœ‰ç‹¬ç«‹çš„ç§æœ‰å‘½åç©ºé—´ 2. æ¨¡å—æ‰§è¡Œ è„šæœ¬æ¨¡å¼ï¼šæ¨¡å—å¯ä½œä¸ºè„šæœ¬æ‰§è¡Œï¼Œ__name__ è®¾ä¸º \u0026quot;__main__\u0026quot; æ¡ä»¶æ‰§è¡Œï¼šä½¿ç”¨ if __name__ == \u0026quot;__main__\u0026quot;: å®ç°æ¨¡å—çš„åŒé‡ç”¨é€” 3. æ¨¡å—æœç´¢è·¯å¾„ æœç´¢é¡ºåºï¼šå†…ç½®æ¨¡å— -\u0026gt; sys.path ä¸­çš„ç›®å½• è·¯å¾„ç»„æˆï¼šè„šæœ¬ç›®å½•ã€PYTHONPATHã€æ ‡å‡†åº“è·¯å¾„ è·¯å¾„ä¿®æ”¹ï¼šå¯åŠ¨æ€ä¿®æ”¹ sys.path 4. ç¼–è¯‘æ–‡ä»¶ ç¼“å­˜æœºåˆ¶ï¼šPython å°†ç¼–è¯‘ç‰ˆæœ¬ç¼“å­˜åœ¨ __pycache__ ç›®å½• æ–‡ä»¶å‘½åï¼šmodule.version.pyc æ ¼å¼ ä¼˜åŒ–é€‰é¡¹ï¼šä½¿ç”¨ -O æˆ– -OO å¼€å…³å‡å°‘æ–‡ä»¶å¤§å° 5. æ ‡å‡†æ¨¡å— å†…ç½®æ¨¡å—ï¼šå¦‚ sysï¼Œæä¾›è§£é‡Šå™¨æ¥å£ åº“æ¨¡å—ï¼šPython è‡ªå¸¦çš„æ ‡å‡†åº“ å¹³å°ä¾èµ–ï¼šæŸäº›æ¨¡å—ä»…åœ¨ç‰¹å®šå¹³å°ä¸Šå¯ç”¨ 6. dir() å‡½æ•° åŠŸèƒ½ï¼šåˆ—å‡ºæ¨¡å—ä¸­å®šä¹‰çš„åç§° ä½¿ç”¨æ–¹å¼ï¼šdir(module) æˆ–æ— å‚æ•°åˆ—å‡ºå½“å‰å‘½åç©ºé—´ å†…ç½®åç§°ï¼šæ ‡å‡†æ¨¡å— builtins åŒ…å«æ‰€æœ‰å†…ç½®å‡½æ•°å’Œå˜é‡ 7. åŒ…ç®¡ç† åŒ…ç»“æ„ï¼šä½¿ç”¨ç‚¹å·æ¨¡å—åæ„å»ºå‘½åç©ºé—´å±‚æ¬¡ __init__.pyï¼šä½¿ç›®å½•æˆä¸ºåŒ…çš„å¿…éœ€æ–‡ä»¶ å­åŒ…å¯¼å…¥ï¼šæ”¯æŒå¤šçº§åŒ…ç»“æ„çš„å¯¼å…¥ 8. å¯¼å…¥æ–¹å¼è¯¦è§£ ç»å¯¹å¯¼å…¥ï¼šä½¿ç”¨å®Œæ•´åŒ…è·¯å¾„ ç›¸å¯¹å¯¼å…¥ï¼šä½¿ç”¨ç‚¹å·è¡¨ç¤ºç›¸å¯¹ä½ç½®ï¼ˆ . å½“å‰åŒ…ï¼Œ.. ä¸Šçº§åŒ…ï¼‰ åŒ…å¯¼å…¥ï¼šæ”¯æŒ __all__ åˆ—è¡¨æ§åˆ¶ * å¯¼å…¥çš„å†…å®¹ 9. æœ€ä½³å®è·µ é¿å…ä½¿ç”¨ from package import *ï¼ˆé™¤éæ˜ç¡®å®šä¹‰__all__ï¼‰ æ¨èä½¿ç”¨ç»å¯¹å¯¼å…¥ åˆç†ç»„ç»‡åŒ…ç»“æ„ä»¥é¿å…å‘½åå†²çª Python è¾“å…¥è¾“å‡ºæ“ä½œ ä»‹ç» Python ä¸­çš„è¾“å…¥è¾“å‡ºæ“ä½œï¼ŒåŒ…æ‹¬æ ¼å¼åŒ–è¾“å‡ºå’Œæ–‡ä»¶å¤„ç†\n1. è¾“å‡ºæ ¼å¼åŒ– f-å­—ç¬¦ä¸²ï¼šä½¿ç”¨få‰ç¼€çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦‚ f'Results of the {year} {event}' str.format()æ–¹æ³•ï¼šä½¿ç”¨ {} æ ‡è®°æ›¿æ¢ä½ç½®ï¼Œæ”¯æŒä½ç½®å’Œå…³é”®å­—å‚æ•° æ‰‹åŠ¨æ ¼å¼åŒ–ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•å¦‚ rjust()ã€ljust()ã€center() è¿›è¡Œå¯¹é½ æ—§å¼æ ¼å¼åŒ–ï¼šä½¿ç”¨ % è¿ç®—ç¬¦è¿›è¡Œå­—ç¬¦ä¸²æ’å€¼ repr()å’Œstr()å‡½æ•°ï¼šç”¨äºå°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤º 2. f-å­—ç¬¦ä¸²è¯¦è§£ åœ¨å­—ç¬¦ä¸²å‰åŠ  f æˆ– F å‰ç¼€ æ”¯æŒæ ¼å¼è¯´æ˜ç¬¦ï¼Œå¦‚ {:.3f} æ§åˆ¶å°æ•°ä½æ•° æ”¯æŒå­—æ®µå®½åº¦è®¾ç½®ï¼Œå¦‚ {:10} ç”¨äºåˆ—å¯¹é½ æ”¯æŒè½¬æ¢ä¿®é¥°ç¬¦ï¼š!aï¼ˆasciiï¼‰ã€!sï¼ˆstrï¼‰ã€!rï¼ˆreprï¼‰ = è¯´æ˜ç¬¦ç”¨äºè‡ªè¯´æ˜å‹è¡¨è¾¾å¼ 3. str.format() æ–¹æ³• ä½ç½®å‚æ•°ï¼š{0}ã€{1} ç­‰ å…³é”®å­—å‚æ•°ï¼š{name} å½¢å¼ æ”¯æŒå­—å…¸å‚æ•°ï¼šä½¿ç”¨ ** æ“ä½œç¬¦ å¯ç»„åˆä½¿ç”¨ä½ç½®å’Œå…³é”®å­—å‚æ•° 4. æ–‡ä»¶æ“ä½œ open()å‡½æ•°ï¼šåŸºæœ¬è¯­æ³• open(filename, mode, encoding) æ¨¡å¼å‚æ•°ï¼š'r' è¯»å–ã€'w' å†™å…¥ã€'a' è¿½åŠ ã€'r+' è¯»å†™ ç¼–ç å‚æ•°ï¼šæ¨èä½¿ç”¨ encoding=\u0026quot;utf-8\u0026quot; æ–‡æœ¬/äºŒè¿›åˆ¶æ¨¡å¼ï¼šæ–‡æœ¬æ¨¡å¼è‡ªåŠ¨å¤„ç†æ¢è¡Œç¬¦è½¬æ¢ 5. withè¯­å¥ æ¨èä½¿ç”¨ with å…³é”®å­—ç®¡ç†æ–‡ä»¶ è‡ªåŠ¨å¤„ç†æ–‡ä»¶å…³é—­ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ ç®€åŒ–ä»£ç ç»“æ„ 6. æ–‡ä»¶å¯¹è±¡æ–¹æ³• read()ï¼šè¯»å–æ–‡ä»¶å†…å®¹ readline()ï¼šè¯»å–å•è¡Œ write()ï¼šå†™å…¥å†…å®¹ tell()ï¼šè·å–å½“å‰ä½ç½® seek()ï¼šæ”¹å˜æ–‡ä»¶ä½ç½® æ”¯æŒè¿­ä»£éå†æ–‡ä»¶è¡Œ 7. JSONæ•°æ®å¤„ç† jsonæ¨¡å—ï¼šç”¨äºåºåˆ—åŒ–å¤æ‚æ•°æ®ç»“æ„ dumps()/dump()ï¼šåºåˆ—åŒ–å¯¹è±¡ä¸º JSON å­—ç¬¦ä¸²/æ–‡ä»¶ loads()/load()ï¼šä» JSON å­—ç¬¦ä¸²/æ–‡ä»¶ååºåˆ—åŒ– æ”¯æŒåˆ—è¡¨ã€å­—å…¸ç­‰å¤æ‚æ•°æ®ç±»å‹ ä¸ pickle æ¨¡å—å¯¹æ¯”ï¼šJSON æ›´å®‰å…¨ä½†åŠŸèƒ½æœ‰é™ Python é”™è¯¯å’Œå¼‚å¸¸å¤„ç† ä»‹ç» Python çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯­æ³•é”™è¯¯å’Œå¼‚å¸¸å¤„ç†ï¼š\n1. é”™è¯¯ç±»å‹ è¯­æ³•é”™è¯¯ï¼šè§£æé”™è¯¯ï¼Œæœ€å¸¸è§çš„é”™è¯¯ç±»å‹ å¼‚å¸¸ï¼šè¯­æ³•æ­£ç¡®ä½†æ‰§è¡Œæ—¶å‡ºé”™ï¼Œå¦‚ ZeroDivisionErrorã€NameErrorã€TypeError ç­‰ 2. å¼‚å¸¸å¤„ç† try-exceptè¯­å¥ï¼šåŸºæœ¬å¼‚å¸¸å¤„ç†ç»“æ„ å¤šexceptå­å¥ï¼šå¯ä¸ºä¸åŒå¼‚å¸¸æŒ‡å®šä¸åŒå¤„ç†ç¨‹åº å¼‚å¸¸åŒ¹é…ï¼šæ”¯æŒåŸºç±»å’Œæ´¾ç”Ÿç±»çš„å¼‚å¸¸åŒ¹é… å¼‚å¸¸å‚æ•°ï¼šå¼‚å¸¸å¯æºå¸¦ç›¸å…³å‚æ•°ä¿¡æ¯ elseå­å¥ï¼šåœ¨æ²¡æœ‰å¼‚å¸¸æ—¶æ‰§è¡Œçš„ä»£ç å— 3. å¼‚å¸¸è§¦å‘ raiseè¯­å¥ï¼šå¼ºåˆ¶è§¦å‘æŒ‡å®šå¼‚å¸¸ å¼‚å¸¸é“¾ï¼šä½¿ç”¨ from å­å¥æ˜¾ç¤ºå¼‚å¸¸çš„å› æœå…³ç³» ç¦ç”¨å¼‚å¸¸é“¾ï¼šä½¿ç”¨ from None ç¦ç”¨è‡ªåŠ¨å¼‚å¸¸é“¾ 4. ç”¨æˆ·è‡ªå®šä¹‰å¼‚å¸¸ ä» Exception ç±»æ´¾ç”Ÿè‡ªå®šä¹‰å¼‚å¸¸ç±» é€šå¸¸ä»¥ \u0026ldquo;Error\u0026rdquo; ç»“å°¾å‘½å ä¿æŒç®€å•ï¼Œä¸»è¦ç”¨äºé”™è¯¯ä¿¡æ¯æå– 5. æ¸…ç†æ“ä½œ finallyå­å¥ï¼šæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½æ‰§è¡Œçš„æ¸…ç†ä»£ç  withè¯­å¥ï¼šé¢„å®šä¹‰æ¸…ç†æ“ä½œï¼Œè‡ªåŠ¨å¤„ç†èµ„æºé‡Šæ”¾ finally å­å¥ä¸­çš„ return è¯­å¥ä¼šè¦†ç›– try ä¸­çš„è¿”å›å€¼ 6. å¤šå¼‚å¸¸å¤„ç† ExceptionGroupï¼šæ‰“åŒ…å¤šä¸ªå¼‚å¸¸å®ä¾‹ except*è¯­å¥ï¼šé€‰æ‹©æ€§å¤„ç†å¼‚å¸¸ç»„ä¸­çš„ç‰¹å®šç±»å‹å¼‚å¸¸ åµŒå¥—å¼‚å¸¸ç»„ï¼šæ”¯æŒå¤æ‚çš„å¼‚å¸¸å±‚æ¬¡ç»“æ„ 7. å¼‚å¸¸æ³¨é‡Š add_note()æ–¹æ³•ï¼šä¸ºå¼‚å¸¸æ·»åŠ é¢å¤–ä¿¡æ¯ æ³¨é‡ŠæŒ‰æ·»åŠ é¡ºåºæ˜¾ç¤ºåœ¨æ ‡å‡†å›æº¯ä¸­ 8. æœ€ä½³å®è·µ å°½å¯èƒ½å…·ä½“åœ°æŒ‡å®šè¦å¤„ç†çš„å¼‚å¸¸ç±»å‹ ä½¿ç”¨ Exception ä½œä¸ºé€šé…ç¬¦æ—¶è¦è°¨æ… æ‰“å°æˆ–è®°å½•å¼‚å¸¸åé‡æ–°å¼•å‘ï¼Œå…è®¸è°ƒç”¨è€…å¤„ç† ä½¿ç”¨ with è¯­å¥ç®¡ç†èµ„æºè‡ªåŠ¨æ¸…ç† Python ç±»å’Œé¢å‘å¯¹è±¡ç¼–ç¨‹ ä»‹ç» Python çš„ç±»æœºåˆ¶å’Œé¢å‘å¯¹è±¡ç¼–ç¨‹ç‰¹æ€§ï¼š\n1. ç±»åŸºç¡€æ¦‚å¿µ ç±»å®šä¹‰ï¼šä½¿ç”¨ class å…³é”®å­—åˆ›å»ºæ–°å¯¹è±¡ç±»å‹ å®ä¾‹åŒ–ï¼šç±»å¯¹è±¡æ”¯æŒå®ä¾‹åŒ–æ“ä½œï¼Œåˆ›å»ºè¯¥ç±»å‹çš„æ–°å®ä¾‹ åˆå§‹åŒ–æ–¹æ³•ï¼š__init__() æ–¹æ³•ç”¨äºå®ä¾‹çš„åˆå§‹åŒ–å’Œå®šåˆ¶ å±æ€§è®¿é—®ï¼šæ”¯æŒæ•°æ®å±æ€§å’Œæ–¹æ³•å±æ€§ 2. ä½œç”¨åŸŸå’Œå‘½åç©ºé—´ å‘½åç©ºé—´ï¼šä»åç§°åˆ°å¯¹è±¡çš„æ˜ å°„ï¼ˆå¦‚å…¨å±€ã€å±€éƒ¨å‘½åç©ºé—´ï¼‰ ä½œç”¨åŸŸè§„åˆ™ï¼šLEGBè§„åˆ™ï¼ˆå±€éƒ¨-\u0026gt;åµŒå¥—-\u0026gt;å…¨å±€-\u0026gt;å†…ç½®ï¼‰ globalå’Œnonlocalï¼šç”¨äºä¿®æ”¹å¤–å±‚ä½œç”¨åŸŸå˜é‡ ç±»å‘½åç©ºé—´ï¼šç±»å®šä¹‰åˆ›å»ºæ–°çš„å‘½åç©ºé—´ 3. å®ä¾‹å¯¹è±¡ æ•°æ®å±æ€§ï¼šå®ä¾‹çš„å˜é‡ï¼Œæ— éœ€å£°æ˜ï¼Œé¦–æ¬¡èµ‹å€¼æ—¶åˆ›å»º æ–¹æ³•å¯¹è±¡ï¼šç»‘å®šåˆ°å®ä¾‹çš„å‡½æ•° selfå‚æ•°ï¼šæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨å®ä¾‹æœ¬èº« å®ä¾‹vsç±»å˜é‡ï¼šå®ä¾‹å˜é‡ä¸ºæ¯ä¸ªå®ä¾‹ç‹¬æœ‰ï¼Œç±»å˜é‡è¢«æ‰€æœ‰å®ä¾‹å…±äº« 4. ç»§æ‰¿æœºåˆ¶ å•ç»§æ‰¿ï¼šclass Derived(Base): è¯­æ³• å¤šé‡ç»§æ‰¿ï¼šclass Derived(Base1, Base2, Base3): è¯­æ³• æ–¹æ³•é‡å†™ï¼šæ´¾ç”Ÿç±»å¯é‡å†™åŸºç±»æ–¹æ³• æ–¹æ³•è§£æé¡ºåºï¼šMROï¼ˆMethod Resolution Orderï¼‰å¤„ç†å¤šé‡ç»§æ‰¿ isinstance()å’Œissubclass()ï¼šç±»å‹æ£€æŸ¥å‡½æ•° 5. ç§æœ‰å˜é‡ å‘½åçº¦å®šï¼šå•ä¸‹åˆ’çº¿ _name è¡¨ç¤ºéå…¬æœ‰API åç§°æ”¹å†™ï¼šåŒä¸‹åˆ’çº¿ __name è§¦å‘åç§°æ”¹å†™æœºåˆ¶ å®é™…ç§æœ‰æ€§ï¼šPythonä¸­æ²¡æœ‰çœŸæ­£çš„ç§æœ‰å˜é‡ï¼Œä¸»è¦é çº¦å®š 6. ç‰¹æ®ŠåŠŸèƒ½ æ•°æ®ç±»ï¼šä½¿ç”¨ @dataclass è£…é¥°å™¨ç®€åŒ–æ•°æ®ç»“æ„å®šä¹‰ è¿­ä»£å™¨åè®®ï¼šå®ç° __iter__() å’Œ __next__() æ–¹æ³• ç”Ÿæˆå™¨ï¼šä½¿ç”¨ yield è¯­å¥çš„ç®€å•è¿­ä»£å™¨åˆ›å»ºæ–¹å¼ ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼šç±»ä¼¼åˆ—è¡¨æ¨å¯¼å¼çš„ç®€æ´è¯­æ³• 7. é«˜çº§ç‰¹æ€§ æ–¹æ³•è°ƒç”¨ï¼šæ”¯æŒé€šè¿‡å®ä¾‹è°ƒç”¨å…¶ä»–æ–¹æ³• å…¨å±€ä½œç”¨åŸŸï¼šæ–¹æ³•å¯è®¿é—®åŒ…å«æ¨¡å—çš„å…¨å±€å˜é‡ åŠ¨æ€ç‰¹æ€§ï¼šè¿è¡Œæ—¶åˆ›å»ºå’Œä¿®æ”¹ç±» åˆ«åæœºåˆ¶ï¼šå¤šä¸ªåç§°å¯ç»‘å®šåˆ°åŒä¸€å¯¹è±¡ 8. æœ€ä½³å®è·µ ä½¿ç”¨å®ä¾‹å˜é‡è€Œéç±»å˜é‡å¤„ç†å¯å˜å¯¹è±¡ éµå¾ªå‘½åçº¦å®šé¿å…æ„å¤–å†²çª åˆç†ä½¿ç”¨ç»§æ‰¿å’Œç»„åˆ æ³¨æ„æ–¹æ³•è§£æé¡ºåºçš„å¤æ‚æ€§ Python æ ‡å‡†åº“ç®€ä»‹ ä»‹ç» Python æ ‡å‡†åº“ä¸­å¸¸ç”¨çš„é‡è¦æ¨¡å—å’ŒåŠŸèƒ½\n1. æ“ä½œç³»ç»Ÿæ¥å£ osæ¨¡å—ï¼šæä¾›ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„å‡½æ•°ï¼ˆè·å–/æ›´æ”¹å·¥ä½œç›®å½•ã€æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼‰ shutilæ¨¡å—ï¼šæä¾›é«˜çº§æ–‡ä»¶å’Œç›®å½•ç®¡ç†åŠŸèƒ½ï¼ˆå¤åˆ¶ã€ç§»åŠ¨æ–‡ä»¶ï¼‰ 2. æ–‡ä»¶å’Œå‚æ•°å¤„ç† globæ¨¡å—ï¼šä½¿ç”¨é€šé…ç¬¦æœç´¢æ–‡ä»¶ sys.argvï¼šè®¿é—®å‘½ä»¤è¡Œå‚æ•° argparseæ¨¡å—ï¼šå¤„ç†å¤æ‚çš„å‘½ä»¤è¡Œå‚æ•° 3. è¾“å…¥è¾“å‡ºå’Œé”™è¯¯å¤„ç† sys.stdin/stdout/stderrï¼šæ ‡å‡†è¾“å…¥è¾“å‡ºæµï¼Œstderr ç”¨äºé”™è¯¯è¾“å‡º sys.exit()ï¼šç»ˆæ­¢ç¨‹åº 4. å­—ç¬¦ä¸²å’Œæ¨¡å¼åŒ¹é… reæ¨¡å—ï¼šæ­£åˆ™è¡¨è¾¾å¼å¤„ç†é«˜çº§å­—ç¬¦ä¸²æ“ä½œ å­—ç¬¦ä¸²æ–¹æ³•ï¼šç®€å•æ“ä½œçš„é¦–é€‰ 5. æ•°å­¦è¿ç®— mathæ¨¡å—ï¼šè®¿é—®æ•°å­¦å‡½æ•°ï¼ˆä¸‰è§’å‡½æ•°ã€å¯¹æ•°ç­‰ï¼‰ randomæ¨¡å—ï¼šéšæœºæ•°ç”Ÿæˆå’Œéšæœºé€‰æ‹© statisticsæ¨¡å—ï¼šåŸºæœ¬ç»Ÿè®¡è®¡ç®—ï¼ˆå‡å€¼ã€ä¸­ä½æ•°ã€æ–¹å·®ï¼‰ SciPyé¡¹ç›®ï¼šæ›´å¤šæ•°å€¼è®¡ç®—æ¨¡å— 6. ç½‘ç»œå’Œäº’è”ç½‘ urllib.requestï¼šä»URLè·å–æ•°æ® smtplibï¼šå‘é€é‚®ä»¶ 7. æ—¥æœŸæ—¶é—´å¤„ç† datetimeæ¨¡å—ï¼šæ—¥æœŸå’Œæ—¶é—´æ“ä½œï¼Œæ”¯æŒæ—¶åŒºå’Œæ—¥å†è¿ç®— 8. æ•°æ®å‹ç¼© zlibã€gzipã€bz2ç­‰ï¼šæ”¯æŒå¤šç§å‹ç¼©æ ¼å¼ 9. æ€§èƒ½æµ‹é‡ timeitæ¨¡å—ï¼šæµ‹é‡ä»£ç æ‰§è¡Œæ—¶é—´ profile/pstatsæ¨¡å—ï¼šåˆ†æä»£ç æ€§èƒ½ 10. è´¨é‡æ§åˆ¶ doctestæ¨¡å—ï¼šä»æ–‡æ¡£å­—ç¬¦ä¸²ä¸­æå–å’Œè¿è¡Œæµ‹è¯• unittestæ¨¡å—ï¼šå…¨é¢çš„å•å…ƒæµ‹è¯•æ¡†æ¶ 11. \u0026ldquo;è‡ªå¸¦ç”µæ± \u0026quot;åŠŸèƒ½ xmlrpcæ¨¡å—ï¼šè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ emailåŒ…ï¼šé‚®ä»¶å¤„ç† json/csvæ¨¡å—ï¼šæ•°æ®æ ¼å¼å¤„ç† xmlåŒ…ï¼šXMLå¤„ç† sqlite3æ¨¡å—ï¼šæ•°æ®åº“æ“ä½œ å›½é™…åŒ–æ¨¡å—ï¼šgettextã€locale ç­‰ Python æ ‡å‡†åº“ç¬¬äºŒéƒ¨åˆ† ä»‹ç» Python æ ‡å‡†åº“ä¸­æ›´é«˜çº§ã€ä¸“ä¸šåŒ–çš„æ¨¡å—ï¼š\n1. æ ¼å¼åŒ–è¾“å‡º reprlibæ¨¡å—ï¼šæä¾›å®šåˆ¶åŒ–çš„ repr() å‡½æ•°ï¼Œç”¨äºç¼©ç•¥æ˜¾ç¤ºå¤§å‹å®¹å™¨å¯¹è±¡ pprintæ¨¡å—ï¼šæä¾›å¤æ‚çš„æ‰“å°æ§åˆ¶ï¼Œç¾åŒ–è¾“å‡ºå¤æ‚æ•°æ®ç»“æ„ textwrapæ¨¡å—ï¼šæ ¼å¼åŒ–æ–‡æœ¬æ®µè½ï¼Œé€‚åº”æŒ‡å®šå®½åº¦ localeæ¨¡å—ï¼šå¤„ç†åœ°åŸŸæ–‡åŒ–ç›¸å…³çš„æ•°æ®æ ¼å¼åŒ– 2. æ¨¡æ¿ç³»ç»Ÿ string.Templateç±»ï¼šæä¾›ç®€åŒ–çš„å­—ç¬¦ä¸²æ›¿æ¢è¯­æ³• æ”¯æŒ $ å ä½ç¬¦å’Œå®‰å…¨æ›¿æ¢æœºåˆ¶ å¯è‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼Œé€‚ç”¨äºç”¨æˆ·è‡ªå®šä¹‰åº”ç”¨ 3. äºŒè¿›åˆ¶æ•°æ®å¤„ç† structæ¨¡å—ï¼šæä¾› pack/unpack å‡½æ•°å¤„ç†äºŒè¿›åˆ¶è®°å½•æ ¼å¼ æ”¯æŒä¸åŒå­—èŠ‚åºå’Œæ•°æ®ç±»å‹ 4. å¤šçº¿ç¨‹ç¼–ç¨‹ threadingæ¨¡å—ï¼šæ”¯æŒåå°ä»»åŠ¡æ‰§è¡Œ æä¾›å¤šç§åŒæ­¥åŸè¯­ï¼ˆé”ã€äº‹ä»¶ã€æ¡ä»¶å˜é‡ç­‰ï¼‰ æ¨èä½¿ç”¨ queue æ¨¡å—è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ 5. æ—¥å¿—è®°å½• loggingæ¨¡å—ï¼šåŠŸèƒ½å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ æ”¯æŒä¸åŒä¼˜å…ˆçº§ï¼ˆDEBUG åˆ° CRITICALï¼‰ å¯è¾“å‡ºåˆ°æ–‡ä»¶ã€ç½‘ç»œç­‰å¤šç§ç›®æ ‡ 6. å¼±å¼•ç”¨ weakrefæ¨¡å—ï¼šè·Ÿè¸ªå¯¹è±¡è€Œä¸åˆ›å»ºå¼ºå¼•ç”¨ é¿å…å¾ªç¯å¼•ç”¨ï¼Œæ”¯æŒç¼“å­˜ç­‰åº”ç”¨åœºæ™¯ 7. æ•°æ®ç»“æ„å·¥å…· arrayæ¨¡å—ï¼šé«˜æ•ˆçš„ä¸€è‡´ç±»å‹æ•°ç»„ collections.dequeï¼šé«˜æ•ˆé˜Ÿåˆ—æ“ä½œ bisectæ¨¡å—ï¼šæœ‰åºåˆ—è¡¨æ“ä½œ heapqæ¨¡å—ï¼šå †æ•°æ®ç»“æ„å®ç° 8. åè¿›åˆ¶æµ®ç‚¹è¿ç®— decimalæ¨¡å—ï¼šç²¾ç¡®çš„åè¿›åˆ¶æµ®ç‚¹è¿ç®— é€‚ç”¨äºè´¢åŠ¡è®¡ç®—ç­‰éœ€è¦ç²¾ç¡®ç²¾åº¦çš„åœºæ™¯ é¿å…äºŒè¿›åˆ¶æµ®ç‚¹æ•°çš„ç²¾åº¦é—®é¢˜ æ”¯æŒç²¾åº¦æ§åˆ¶å’Œå››èˆäº”å…¥è§„åˆ™ Python è™šæ‹Ÿç¯å¢ƒå’ŒåŒ…ç®¡ç† ä»‹ç» Python è™šæ‹Ÿç¯å¢ƒçš„æ¦‚å¿µã€åˆ›å»ºæ–¹æ³•å’ŒåŒ…ç®¡ç†\nè™šæ‹Ÿç¯å¢ƒå’Œ pip åŒ…ç®¡ç†æ˜¯ Python å¼€å‘çš„é‡è¦å·¥å…·ï¼Œç¡®ä¿é¡¹ç›®ä¾èµ–çš„éš”ç¦»å’Œå¯é‡ç°æ€§ã€‚ 1. è™šæ‹Ÿç¯å¢ƒæ¦‚è¿° é—®é¢˜èƒŒæ™¯ï¼šä¸åŒåº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦åŒä¸€åº“çš„ä¸åŒç‰ˆæœ¬ï¼Œå¯¼è‡´ç‰ˆæœ¬å†²çª è§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿç¯å¢ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•ï¼ŒåŒ…å«ç‰¹å®š Python ç‰ˆæœ¬å’ŒåŒ… ä¼˜åŠ¿ï¼šä¸åŒåº”ç”¨å¯ä½¿ç”¨ä¸åŒè™šæ‹Ÿç¯å¢ƒï¼Œé¿å…ç‰ˆæœ¬å†²çª 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ venvæ¨¡å—ï¼šç”¨äºåˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿç¯å¢ƒ åˆ›å»ºå‘½ä»¤ï¼špython -m venv ç›®å½•å å¸¸ç”¨ä½ç½®ï¼š.venv ç›®å½•ï¼ˆéšè—ç›®å½•ï¼‰ æ¿€æ´»ç¯å¢ƒï¼š Windows: tutorial-env\\Scripts\\activate Unix/MacOS: source tutorial-env/bin/activate åœç”¨ç¯å¢ƒï¼šdeactivateå‘½ä»¤ 3. åŒ…ç®¡ç†ï¼ˆpipï¼‰ pipåŠŸèƒ½ï¼šå®‰è£…ã€å‡çº§ã€ç§»é™¤è½¯ä»¶åŒ… åŒ…æ¥æºï¼šPython Package Index å®‰è£…å‘½ä»¤ï¼š æœ€æ–°ç‰ˆæœ¬ï¼špython -m pip install åŒ…å ç‰¹å®šç‰ˆæœ¬ï¼špython -m pip install åŒ…å==ç‰ˆæœ¬å· å‡çº§åŒ…ï¼špython -m pip install --upgrade åŒ…å å¸è½½åŒ…ï¼špython -m pip uninstall åŒ…å 4. pip å¸¸ç”¨å‘½ä»¤ pip showï¼šæ˜¾ç¤ºåŒ…çš„è¯¦ç»†ä¿¡æ¯ pip listï¼šåˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„åŒ… pip freezeï¼šç”ŸæˆåŒ…åˆ—è¡¨ï¼Œç”¨äº requirements.txt æ–‡ä»¶ ä»æ–‡ä»¶å®‰è£…ï¼špython -m pip install -r requirements.txt æµ®ç‚¹ç®—æœ¯çš„äº‰è®®å’Œé™åˆ¶ è§£é‡Šè®¡ç®—æœºä¸­æµ®ç‚¹æ•°è¡¨ç¤ºå’Œè¿ç®—çš„å›ºæœ‰é™åˆ¶\n1. æ ¸å¿ƒé—®é¢˜ äºŒè¿›åˆ¶è¡¨ç¤ºï¼šè®¡ç®—æœºä½¿ç”¨äºŒè¿›åˆ¶ï¼ˆåŸºæ•°ä¸º2ï¼‰å°æ•°è¡¨ç¤ºæµ®ç‚¹æ•° ç²¾åº¦é™åˆ¶ï¼šå¤§å¤šæ•°åè¿›åˆ¶å°æ•°æ— æ³•ç²¾ç¡®è¡¨ç¤ºä¸ºäºŒè¿›åˆ¶å°æ•°ï¼ˆå¦‚0.1ï¼‰ è¿‘ä¼¼å­˜å‚¨ï¼šæµ®ç‚¹æ•°åªèƒ½è¿‘ä¼¼å­˜å‚¨ï¼Œä¸æ˜¯ç²¾ç¡®å€¼ 2. è¡¨ç¤ºæ€§é”™è¯¯ æ ¹æœ¬åŸå› ï¼šäºŒè¿›åˆ¶æ— æ³•ç²¾ç¡®è¡¨ç¤ºæŸäº›åè¿›åˆ¶åˆ†æ•° IEEE 754æ ‡å‡†ï¼šå¤§å¤šæ•°ç³»ç»Ÿä½¿ç”¨æ­¤æ ‡å‡†ï¼Œæä¾›53ä½ç²¾åº¦ å­˜å‚¨å€¼ï¼š0.1 å®é™…å­˜å‚¨ä¸º 3602879701896397 / 2**55ï¼Œè€Œéç²¾ç¡®çš„ 1/10 3. å®é™…å½±å“ æ˜¾ç¤ºé—®é¢˜ï¼šPython æ˜¾ç¤ºè¿‘ä¼¼å€¼è€Œéå®Œæ•´ç²¾åº¦å€¼ è®¡ç®—è¯¯å·®ï¼š0.1 + 0.1 + 0.1 != 0.3 èˆå…¥æ— æ•ˆï¼šround() æ— æ³•è§£å†³æ ¹æœ¬çš„ç²¾åº¦é—®é¢˜ 4. è§£å†³æ–¹æ¡ˆ æ¯”è¾ƒå‡½æ•°ï¼šä½¿ç”¨ math.isclose() è¿›è¡Œè¿‘ä¼¼æ¯”è¾ƒ ç²¾ç¡®ç®—æœ¯ï¼š decimal æ¨¡å—ï¼šåè¿›åˆ¶ç²¾ç¡®è¿ç®— fractions æ¨¡å—ï¼šåŸºäºæœ‰ç†æ•°çš„è¿ç®— æ±‚å’Œç²¾åº¦ï¼šä½¿ç”¨ sum() å’Œ math.fsum() å‡å°‘ç´¯ç§¯è¯¯å·® 5. ç²¾ç¡®å€¼è·å– as_integer_ratio()ï¼šè¿”å›ç²¾ç¡®åˆ†æ•°è¡¨ç¤º hex()ï¼šåå…­è¿›åˆ¶ç²¾ç¡®è¡¨ç¤º ç§‘å­¦è®¡ç®—ï¼šNumPy å’Œ SciPy åŒ…æä¾›æ›´ä¸“ä¸šçš„æ•°å€¼è®¡ç®— 6. å…³é”®è¦ç‚¹ è¿™æ˜¯ç¡¬ä»¶å±‚é¢çš„å›ºæœ‰é™åˆ¶ï¼Œä¸æ˜¯ Python çš„ bug å¯¹å¤§å¤šæ•°åº”ç”¨è¶³å¤Ÿç²¾ç¡® éœ€è¦ç²¾ç¡®åè¿›åˆ¶è®¡ç®—æ—¶åº”ä½¿ç”¨ä¸“é—¨çš„æ¨¡å— è¾“å‡ºæ ¼å¼åŒ–åªæ˜¯æ˜¾ç¤ºå±‚é¢çš„å¤„ç†ï¼Œä¸æ”¹å˜å­˜å‚¨ç²¾åº¦ ","description":"ä»¥ Python 3.12 ä¸ºåŸºç¡€ã€‚\nå®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/tutorial/index.html\nä»¥ä¸‹æ˜¯å¯¹å®˜æ–¹æ–‡æ¡£çš„æ€»ç»“ã€‚\nä½¿ç”¨ Python çš„è§£é‡Šå™¨ Python 3.12 è§£é‡Šå™¨çš„å¯åŠ¨ã€ä½¿ç”¨å’Œç¯å¢ƒé…ç½®æ–¹æ³•ï¼š\n1. å¯åŠ¨ Python è§£é‡Šå™¨ Unix/Linuxç³»ç»Ÿï¼šé€šå¸¸å®‰è£…åœ¨ /usr/local/bin/python3.12ï¼Œå¯é€šè¿‡ python3.12 å‘½ä»¤å¯åŠ¨ Windowsç³»ç»Ÿï¼šå¯é€šè¿‡ Microsoft Store å®‰è£…çš„ python3.12 å‘½ä»¤æˆ– py å‘½ä»¤å¯åŠ¨ é€€å‡ºæ–¹å¼ï¼šä½¿ç”¨ Ctrl+Dï¼ˆUnixï¼‰æˆ– Ctrl+Zï¼ˆWindowsï¼‰ï¼Œæˆ–è¾“å…¥ quit() 2. è§£é‡Šå™¨å·¥ä½œæ¨¡å¼ äº¤äº’æ¨¡å¼ï¼šåœ¨ç»ˆç«¯ä¸­ç›´æ¥è¾“å…¥ Python ä»£ç ï¼Œä¸»æç¤ºç¬¦ä¸º \u0026gt;\u0026gt;\u0026gt;ï¼Œè¿ç»­è¡Œæç¤ºç¬¦ä¸º ... è„šæœ¬æ¨¡å¼ï¼šæ‰§è¡Œæ–‡ä»¶ä¸­çš„ Python ä»£ç  å‘½ä»¤è¡Œæ‰§è¡Œï¼šä½¿ç”¨ python -c command æ‰§è¡Œå•è¡Œå‘½ä»¤ æ¨¡å—æ‰§è¡Œï¼šä½¿ç”¨ python -m module æ‰§è¡Œæ¨¡å— 3. å‘½ä»¤è¡Œå‚æ•°å¤„ç† å‚æ•°å­˜å‚¨åœ¨ sys.argv åˆ—è¡¨ä¸­ è¯¥åˆ—è¡¨æœ€å°‘æœ‰ä¸€ä¸ªå…ƒç´  æ— å‚æ•°ï¼šsys.argv[0] æ˜¯ç©ºå­—ç¬¦ä¸² æœ‰å‚æ•°ï¼šsys.argv[0] è„šæœ¬åï¼Œåç»­å…ƒç´ æ˜¯ä¼ å…¥çš„å‚æ•° ä¸åŒå¯åŠ¨æ–¹å¼å¯¹ sys.argv[0] çš„å¤„ç†ä¸åŒ 4. æ–‡ä»¶ç¼–ç æ”¯æŒ é»˜è®¤ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œæ”¯æŒå¤šç§è¯­è¨€å­—ç¬¦ å¯é€šè¿‡ç‰¹æ®Šæ³¨é‡Šå£°æ˜å…¶ä»–ç¼–ç æ ¼å¼ ç¼–ç å£°æ˜éœ€æ”¾åœ¨æ–‡ä»¶ç¬¬ä¸€è¡Œï¼ˆshebangè¡Œé™¤å¤–ï¼‰ 5. ç¯å¢ƒé…ç½® æ”¯æŒè¡Œç¼–è¾‘åŠŸèƒ½ï¼ˆåŸºäº GNU Readline åº“ï¼‰ å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Python è¿è¡Œç¯å¢ƒ Python é€Ÿè§ˆ ä»‹ç» Python ä½œä¸ºè®¡ç®—å™¨çš„åŸºæœ¬ç”¨æ³•å’Œæ ¸å¿ƒæ¦‚å¿µï¼š\n"},{"id":94,"href":"/operations/troubleshooting/","title":"Troubleshooting","parent":"Operations","content":"Documents List:\nHTTPè¯·æ±‚ç¼“æ…¢ å†…å­˜ä¸è¶³å¯¼è‡´ KVM è™šæ‹ŸæœºæŒ‚æ‰ ","description":"Documents List:\nHTTPè¯·æ±‚ç¼“æ…¢ å†…å­˜ä¸è¶³å¯¼è‡´ KVM è™šæ‹ŸæœºæŒ‚æ‰ "},{"id":95,"href":"/operations/kubernetes/init-config/","title":"Kubernetes åˆå§‹åŒ–é…ç½®","parent":"Kubernetes","content":"åˆå§‹ kubeadm é…ç½®\napiVersion: kubeadm.k8s.io/v1beta4 kind: InitConfiguration localAPIEndpoint: advertiseAddress: 172.16.0.116 bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/containerd/containerd.sock kubeletExtraArgs: fail-swap-on: \u0026#34;false\u0026#34; taints: - effect: PreferNoSchedule key: node-role.kubernetes.io/master --- apiServer: extraArgs: service-node-port-range: \u0026#34;10000-50000\u0026#34; apiVersion: kubeadm.k8s.io/v1beta4 # clusterName: kubernetes controlPlaneEndpoint: 172.16.0.118:8443 etcd: external: endpoints: - http://172.16.0.113:2379 - http://172.16.0.114:2379 - http://172.16.0.115:2379 # imageRepository: registry.server.com kind: ClusterConfiguration kubernetesVersion: 1.33.3 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 podSubnet: 10.244.0.0/16 --- apiVersion: kubelet.config.k8s.io/v1beta1 cgroupDriver: systemd kind: KubeletConfiguration failSwapOn: false --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs ipvs: strictARP: true ä¸‹é¢æ ¹æ®ç»™å‡ºçš„åˆå§‹ kubeadm é…ç½®ï¼ŒæŒ‰ Kubernetes 1.33 + Calicoï¼ˆæ¨è eBPF + VXLANï¼‰æœ€ä½³å®è·µ åšäº†ä¼˜åŒ–ä¸è¡¥å……ï¼Œè¾“å‡º å¯ç›´æ¥ä½¿ç”¨çš„ kubeadm YAMLï¼ˆä¿ç•™ä½ åŸæœ‰å­—æ®µå¹¶è¡¥è¶³å¿…è¦å®‰å…¨/å¯ç”¨æ€§é¡¹ï¼‰ï¼Œå¹¶åœ¨åé¢ç»™å‡ºé€æ®µè¯¦è§£ä¸æ³¨æ„äº‹é¡¹ï¼ŒåŒ…å«ä¸ºä»€ä¹ˆè¿™æ ·é…ç½®ã€ä»€ä¹ˆæ—¶å€™éœ€è¦ä¿®æ”¹ï¼Œä»¥åŠä¸ Calico çš„é…å¥—å»ºè®®ï¼ˆeBPF / VXLAN / kube-proxy å¤„ç†ç­‰ï¼‰ã€‚\næ³¨æ„ï¼šä¸‹é¢çš„ YAML æ˜¯ç”¨ä½œ kubeadm init \u0026ndash;config=\u0026hellip; æˆ– kubeadm join \u0026ndash;config=\u0026hellip; çš„é…ç½®æ–‡ä»¶ç‰‡æ®µï¼ˆå¤šæ®µ YAMLï¼‰ã€‚è¯·æ ¹æ®ä½ çš„å®é™… IP/åŸŸå/è¯ä¹¦è·¯å¾„æ›¿æ¢æ³¨é‡Šä¸­æ ‡æ³¨çš„å ä½é¡¹ï¼ˆä¾‹å¦‚ external etcd TLS: CAã€certã€key è·¯å¾„ï¼‰ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Calico eBPFï¼Œè¯·æŒ‰æ–‡æœ«è¯´æ˜æ›¿æ¢æˆ–ç¦ç”¨ kube-proxyã€‚\nâœ… æ¨èçš„ kubeadm åˆå§‹åŒ–é…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰\n# --------------------------- # 1) InitConfiguration: æœ¬èŠ‚ç‚¹æœ¬åœ° API åŠèŠ‚ç‚¹æ³¨å†Œç›¸å…³ # --------------------------- apiVersion: kubeadm.k8s.io/v1beta4 kind: InitConfiguration localAPIEndpoint: advertiseAddress: 172.16.0.116 bindPort: 6443 nodeRegistration: name: master-172-16-0-116 # èŠ‚ç‚¹åï¼ˆå¯é€‰ä½†æ¨èï¼Œä¾¿äºè¯†åˆ«ï¼‰ criSocket: unix:///var/run/containerd/containerd.sock kubeletExtraArgs: fail-swap-on: \u0026#34;false\u0026#34; # å…è®¸ swapï¼ˆå¦‚æœä½ ç¡®å®éœ€è¦ï¼‰ã€‚ç”Ÿäº§å»ºè®®å…³é—­ swap å¹¶æŠŠ fail-swap-on: \u0026#34;true\u0026#34; node-ip: \u0026#34;172.16.0.116\u0026#34; # æ˜ç¡®æŒ‡å®š node-ipï¼Œé¿å… kubelet ç»‘å®šåˆ°é”™è¯¯æ¥å£ï¼ˆVPN/tun0ï¼‰ # å¦‚æœä½¿ç”¨ systemd cgroup driverï¼Œä¸‹é¢çš„å‚æ•°å¯ä¸å¿…é‡å¤ï¼ŒKubeletConfiguration ä¸­ä¼šè®¾ç½® taints: - key: node-role.kubernetes.io/master effect: PreferNoSchedule # --------------------------- # 2) ClusterConfiguration: API Serverã€æ§åˆ¶å¹³é¢ã€etcdã€ç½‘ç»œç­‰ # --------------------------- apiVersion: kubeadm.k8s.io/v1beta4 kind: ClusterConfiguration kubernetesVersion: v1.33.3 clusterName: kubernetes controlPlaneEndpoint: \u0026#34;172.16.0.118:8443\u0026#34; # æ¨èæ”¹æˆ DNSï¼ˆä¾‹å¦‚ api.k8s.example.com:6443ï¼‰ä»¥ä¾¿åç»­ HA/è¯ä¹¦ç®¡ç† imageRepository: \u0026#34;registry.server.com\u0026#34; # å¯é€‰ï¼šç§æœ‰é•œåƒä»“åº“ï¼ˆæ›¿æ¢ä¸ºä½ çš„é•œåƒåº“ï¼‰ # API Server å‚æ•° apiServer: extraArgs: service-node-port-range: \u0026#34;10000-50000\u0026#34; # ä½ çš„è¦æ±‚ # å¼ºçƒˆå»ºè®®æ˜¾å¼è®¾ç½® preferred-address-typesï¼ˆmetrics ç­‰ä¼šç”¨ï¼‰ kubelet-preferred-address-types: \u0026#34;InternalIP,Hostname,ExternalIP\u0026#34; # è¯ä¹¦ SANï¼šç¡®ä¿æ‰€æœ‰ä¼šè®¿é—® apiserver çš„ IP/åŸŸåéƒ½åœ¨æ­¤åˆ—è¡¨ä¸­ certSANs: - \u0026#34;127.0.0.1\u0026#34; - \u0026#34;localhost\u0026#34; - \u0026#34;10.96.0.1\u0026#34; # Service cluster IPï¼ˆé»˜è®¤ service CIDR é¦–ä¸ªIPï¼‰ - \u0026#34;172.16.0.116\u0026#34; # æœ¬èŠ‚ç‚¹ advertiseAddress - \u0026#34;172.16.0.118\u0026#34; # controlPlaneEndpoint IPï¼ˆLB æˆ– VIPï¼‰ # - \u0026#34;api.k8s.example.com\u0026#34; # å¦‚æœ controlPlaneEndpoint æ˜¯åŸŸåï¼Œè¯·åŠ å…¥ timeoutForControlPlane: 4m # Controller manager å¯é€‰é¢å¤–å‚æ•°ï¼ˆç¤ºä¾‹ï¼šè°ƒæ•´èµ„æºåˆ†é…ã€leader-elect ç­‰ï¼‰ controllerManager: extraArgs: node-monitor-period: \u0026#34;6s\u0026#34; # Scheduler å¯é€‰å‚æ•° scheduler: extraArgs: address: \u0026#34;127.0.0.1\u0026#34; # å¤–éƒ¨ etcdï¼ˆå»ºè®®ä½¿ç”¨ HTTPS/TLS è€Œé httpï¼‰ etcd: external: endpoints: - \u0026#34;https://172.16.0.113:2379\u0026#34; - \u0026#34;https://172.16.0.114:2379\u0026#34; - \u0026#34;https://172.16.0.115:2379\u0026#34; # TLS è¯ä¹¦/CAï¼ˆå¿…é¡»æä¾›ï¼Œå¦åˆ™æ”¹å› http å¹¶ç¡®è®¤ç½‘ç»œå®‰å…¨æ€§ï¼‰ caFile: /etc/kubernetes/pki/etcd/ca.crt certFile: /etc/kubernetes/pki/etcd/client.crt keyFile: /etc/kubernetes/pki/etcd/client.key # ç½‘ç»œé…ç½®ï¼šService / Pod CIDRï¼Œéœ€è¦ä¸ Calico IPPool ä¿æŒä¸€è‡´ networking: dnsDomain: cluster.local serviceSubnet: \u0026#34;10.96.0.0/12\u0026#34; podSubnet: \u0026#34;10.244.0.0/16\u0026#34; # ä¸ Calico IPPool å¯¹é½ï¼ˆç¤ºä¾‹ï¼šé»˜è®¤ Flannel/Calico å…¼å®¹ï¼‰ # --------------------------- # 3) KubeletConfigurationï¼škubelet è¿è¡Œæ—¶å‚æ•°ï¼ˆé€‚é… systemd + containerdï¼‰ # --------------------------- --- apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration cgroupDriver: systemd failSwapOn: false # æ¨èå¢åŠ çš„ç¨³å¥æ€§å‚æ•° systemReserved: cpu: \u0026#34;200m\u0026#34; memory: \u0026#34;256Mi\u0026#34; kubeReserved: cpu: \u0026#34;200m\u0026#34; memory: \u0026#34;256Mi\u0026#34; evictionHard: memory.available: \u0026#34;100Mi\u0026#34; # kubelet è¿æ¥è¶…æ—¶ã€è¯ä¹¦åˆ·æ–°ç­‰ imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 serializeImagePulls: false # --------------------------- # 4) KubeProxyConfigurationï¼ˆé»˜è®¤ ipvs æ¨¡å¼ï¼Œè‹¥ä½¿ç”¨ Calico eBPFï¼Œåº”ç§»é™¤æˆ–ç¦ç”¨ kube-proxyï¼‰ # --------------------------- --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs ipvs: strictARP: true # æ³¨æ„ï¼šå¦‚æœä½ å°†ä½¿ç”¨ Calico BPF dataplaneï¼ˆæ¨èï¼‰è¯·åœ¨ deploy Calico æ—¶ç¦ç”¨ kube-proxyï¼ˆæˆ–ä½¿ç”¨ kube-proxy mode=noneï¼‰ # --------------------------- # End of config # --------------------------- é€æ®µè¯´æ˜ä¸ä¼˜åŒ–ç†ç”±ï¼ˆé€é¡¹è¯¦è§£ï¼‰ ä¸€ã€InitConfiguration / nodeRegistration node-ip æ˜¾å¼æŒ‡å®šï¼šä½ å…ˆå‰é‡åˆ° OpenVPN/tun0 å¹²æ‰°çš„é—®é¢˜å¾ˆå¸¸è§ï¼Œkubelet å¦‚æœè‡ªåŠ¨é€‰æ‹©æ¥å£å¯èƒ½ä¼šç»‘å®šåˆ°é”™è¯¯çš„ IPï¼ˆtun0ï¼‰ï¼Œå¯¼è‡´ metrics/kubelet ä¸ apiserver é€šä¿¡å¼‚å¸¸ã€‚node-ip: \u0026ldquo;172.16.0.116\u0026rdquo; èƒ½å¼ºåˆ¶ kubelet ä½¿ç”¨æ­£ç¡®çš„å†…ç½‘åœ°å€ã€‚\nfail-swap-on: \u0026ldquo;false\u0026rdquo;ï¼šä½ ä¹‹å‰è®¾ç½®ä¸º falseï¼Œä¿ç•™ã€‚å¦‚æœæ˜¯ç”Ÿäº§å»ºè®®æŠŠç³»ç»Ÿ swap å…³é—­å¹¶å°† failSwapOn: trueï¼Œä¿æŒ kubelet è¡Œä¸ºä¸€è‡´ã€‚\ntaints ä½¿ç”¨ PreferNoScheduleï¼šä½ åŸæ¥æ˜¯ PreferNoScheduleã€‚ç”Ÿäº§å¸¸è§æ˜¯ NoSchedule æˆ– node-role.kubernetes.io/control-plane:NoScheduleã€‚PreferNoSchedule å…è®¸ä¸´æ—¶å®¹å¿ï¼Œä½†ä¸ä¿è¯ä¸è°ƒåº¦â€”â€”æ ¹æ®ä½ æ˜¯å¦éœ€è¦åœ¨æ§åˆ¶å¹³é¢è¿è¡Œä¸šåŠ¡è°ƒæ•´ã€‚\näºŒã€ClusterConfiguration â€” apiServer / certSANs / controlPlaneEndpoint certSANs æ˜ç¡®åˆ—å‡ºè®¿é—® apiserver çš„ IP/DNSï¼šåŸé”™è¯¯ï¼ˆx509 valid for A not Bï¼‰å°±æ˜¯å› ä¸ºè¯ä¹¦ç¼ºå°‘è®¿é—® IPã€‚æŠŠ advertiseAddressã€controlPlaneEndpoint çš„ IPï¼Œä»¥åŠ 10.96.0.1ï¼ˆServiceClusterIPï¼‰å’Œ localhost æ”¾è¿› certSANsï¼Œèƒ½é¿å… kubeconfig æˆ–å¤–éƒ¨ LB è®¿é—®æ—¶è¯ä¹¦æ ¡éªŒå¤±è´¥ã€‚\ncontrolPlaneEndpoint å»ºè®®ä½¿ç”¨åŸŸåï¼ˆVIP/LBï¼‰ï¼šä½ ç°åœ¨æ˜¯ 172.16.0.118:8443ï¼Œå¯å·¥ä½œã€‚ä½†ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ api.example.com:6443 æŒ‡å‘ Nginx/HAProxy/Keepalived VIPï¼Œä»¥ä¾¿åç»­æ‰©å®¹/è¯ä¹¦ç®¡ç†æ›´çµæ´»ã€‚\nservice-node-port-rangeï¼šä½ æ”¹ä¸º 10000-50000ï¼Œç¡®è®¤é˜²ç«å¢™/äº‘å®‰å…¨ç»„å·²æ”¾è¡Œè¿™äº›ç«¯å£ã€‚\nä¸‰ã€etcd å¤–éƒ¨é…ç½®ï¼ˆæå…¶é‡è¦ï¼‰ ä½ æœ€å¼€å§‹ç”¨ http://ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ https:// + TLS client certï¼ˆä¸Šé¢ç¤ºä¾‹ç»™å‡ºäº† caFileã€certFileã€keyFile å­—æ®µï¼‰ã€‚æœªåŠ å¯†çš„ etcd æµé‡ä¼šå¸¦æ¥ä¸¥é‡å®‰å…¨é£é™©ã€‚\nå¦‚æœ etcd æ˜¯å¤–éƒ¨ç‹¬ç«‹é›†ç¾¤ï¼Œç¡®ä¿æ‰€æœ‰ control-plane èŠ‚ç‚¹èƒ½è§£æå¹¶è®¿é—®è¿™äº› IPï¼ˆç½‘ç»œã€è·¯ç”±ã€é˜²ç«å¢™ï¼‰ã€‚\nå››ã€networking: podSubnet ä¸ Calico podSubnet: 10.244.0.0/16 ä¿æŒå¸¸è§é»˜è®¤ï¼ˆä¸è®¸å¤š Calico/Flannel ç¤ºä¾‹å…¼å®¹ï¼‰ã€‚é‡è¦ï¼šCalico çš„ IPPool å¿…é¡»ä¸æ­¤ CIDR å¯¹é½ï¼Œæˆ–ä½ æ”¹ç”¨ Calico IPPool è‡ªè¡Œç®¡ç† podCIDRï¼ˆè¿™æ—¶ kubeadm ä¸è®¾ podSubnetï¼‰ã€‚\nè‹¥å¯ç”¨ Calico IPAM ç®¡ç†å…¨å±€ç½‘æ®µã€å»ºè®®åœ¨ Calico IPPool ä¸­ç»Ÿä¸€å®šä¹‰ï¼Œä¾‹å¦‚ 10.10.0.0/16 åˆ†ä¸šåŠ¡æ± ã€‚\näº”ã€KubeletConfiguration cgroupDriver: systemdï¼šä¸ containerd + systemd æ¨èåŒ¹é…ï¼Œé¿å… OOMã€QoS é—®é¢˜ã€‚\nfailSwapOn: falseï¼šä¸ä½ åœ¨ nodeRegistration ä¿æŒä¸€è‡´ã€‚å†æ¬¡å¼ºè°ƒï¼šç”Ÿäº§å»ºè®® swapoff -a å¹¶å¼€å¯ failSwapOn: trueã€‚\nsystemReserved / kubeReservedï¼šä¸º host å’Œ kubelet é¢„ç•™èµ„æºï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œå€¼éœ€æ ¹æ®æœºå™¨å¤§å°è°ƒæ•´ã€‚\nevictionHardï¼šåŸºç¡€ä¿æŠ¤ï¼Œé¿å…å†…å­˜è€—å°½å¯¼è‡´æ•´ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨ã€‚\nå…­ã€KubeProxyConfigurationï¼ˆipvsï¼‰ ä½ é€‰æ‹©äº† ipvs å¹¶å¼€å¯ strictARP: trueï¼Œè¿™åœ¨è£¸é‡‘å± / L2 LB åœºæ™¯å¯¹ ARP é€šå‘Šæ›´ç¨³å®šã€‚\nä½†ï¼šå¦‚æœè®¡åˆ’ä½¿ç”¨ Calico eBPF dataplaneï¼ˆæœ€ä½³å®è·µæ¨èï¼‰ï¼Œä½ åº”å½“ ç§»é™¤/ç¦ç”¨ kube-proxyï¼ˆæˆ–å°†å…¶ DaemonSet scale 0 / ä½¿ç”¨ mode noneï¼‰ï¼Œå› ä¸º eBPF å°†æ›¿ä»£ kube-proxy çš„åŠŸèƒ½ã€‚\nå¦‚æœä¸ä½¿ç”¨ eBPFï¼Œåˆ™ ipvs æ˜¯é«˜æ€§èƒ½é€‰æ‹©ï¼ˆè®°å¾—å®‰è£… ipvs-modules å¹¶è°ƒæ•´ conntrack å‚æ•°ï¼‰ã€‚\nä¸ Calicoï¼ˆeBPF + VXLANï¼‰é…åˆçš„ç‰¹åˆ«è¯´æ˜ï¼ˆå¿…é¡»è¯»ï¼‰ è‹¥ä½ æ‰“ç®—å¯ç”¨ Calico eBPFï¼ˆæ¨èç”Ÿäº§é«˜æ€§èƒ½ï¼‰ï¼š\nåœ¨ Calico Operator/Installation CR ä¸­è®¾ç½®ï¼š\ncalicoNetwork: linuxDataplane: \u0026#34;BPF\u0026#34; encapMode: \u0026#34;VXLAN\u0026#34; # æˆ– ipipï¼Œæ¨è VXLAN for offload mtu: 1450 ç¦ç”¨ kube-proxyï¼šå°† kube-proxy DaemonSet scale åˆ° 0 æˆ– removeï¼›Calico BPF ä¼šå¤„ç† Service/IPVS åŠŸèƒ½ã€‚\nç¡®ä¿ Node kernel/å†…æ ¸æ¨¡å—æ”¯æŒ eBPFï¼ˆLinux 5.x+ æ¨èï¼‰ï¼Œå¹¶å®‰è£…å¿…è¦çš„ bpftoolã€‚\nè°ƒæ•´ conntrackã€nf_conntrack_maxã€mtu å¦‚ä¸Šï¼ˆæé«˜ conntrack limitï¼‰ã€‚\nè‹¥ä¸ä½¿ç”¨ eBPFï¼šä¿ç•™ kube-proxy ipvsï¼Œä½†ä»å¯ä½¿ç”¨ Calico çš„ VXLAN æˆ– BGP æ¨¡å¼ä½œä¸º Pod ç½‘ç»œã€‚\nè¯ä¹¦ä¸è¯ä¹¦é‡ç”Ÿï¼ˆå¸¸è§æµç¨‹ï¼‰ å¦‚æœä½ ä¿®æ”¹äº† certSANsï¼Œkubeadm init phase certs apiserver \u0026ndash;config=cluster-config.yaml ä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„è¯ä¹¦ï¼Œéœ€å…ˆå¤‡ä»½å¹¶åˆ é™¤ /etc/kubernetes/pki/apiserver.crt \u0026amp; apiserver.keyï¼Œå†è¿è¡Œ phase å‘½ä»¤ï¼Œæˆ–åœ¨åˆæ¬¡ kubeadm init æ—¶ä¼ å…¥æ­¤æ–‡ä»¶ã€‚\nè‹¥ä½ æ˜¯ HAï¼Œå¤š master èŠ‚ç‚¹éœ€è¦æŠŠç”Ÿæˆçš„æ–°è¯ä¹¦åˆ†å‘åˆ°å…¶å®ƒ control-plane èŠ‚ç‚¹ï¼ˆæˆ–ä½¿ç”¨ kubeadm join â€“control-plane with certsï¼‰ã€‚\næ“ä½œå»ºè®®ï¼ˆå®æ“æ­¥éª¤ç®€è¦ï¼‰ æŠŠä¸Šé¢ YAML ä¿å­˜ä¸º cluster-config.yamlï¼ˆæ›¿æ¢ etcd TLS è·¯å¾„ä¸ imageRepository ç­‰ï¼‰ã€‚\nï¼ˆå¦‚æœæ˜¯æ–°é›†ç¾¤ï¼‰ï¼š\nkubeadm init --config=cluster-config.yaml ï¼ˆå¦‚æœåªæƒ³é‡ç­¾ apiserver è¯ä¹¦ï¼‰ï¼š\nå¤‡ä»½å¹¶åˆ é™¤æ—§è¯ä¹¦ï¼š\ncp /etc/kubernetes/pki/apiserver.crt /root/ cp /etc/kubernetes/pki/apiserver.key /root/ rm /etc/kubernetes/pki/apiserver.crt /etc/kubernetes/pki/apiserver.key kubeadm init phase certs apiserver --config=cluster-config.yaml kubeadm init phase kubeconfig all --config=cluster-config.yaml touch /etc/kubernetes/manifests/kube-apiserver.yaml # è§¦å‘ kubelet reload åˆ†å‘æ–°è¯ä¹¦åˆ°å…¶å®ƒ control-plane èŠ‚ç‚¹ï¼ˆscp / rsyncï¼‰ã€‚\nå®‰è£… Calicoï¼šæ ¹æ®æ˜¯å¦å¯ç”¨ eBPF é€‰æ‹© manifestï¼ˆOperator + Installation CRï¼‰ã€‚è‹¥ä½¿ç”¨ eBPFï¼Œè¯·åœ¨ Calico CR ä¸­å…³é—­ kube-proxy å¹¶ç¡®ä¿å†…æ ¸æ”¯æŒã€‚\nå¸¸è§æ ¡éªŒ \u0026amp; æ•…éšœæ’æŸ¥å‘½ä»¤ï¼ˆç»™ä½ å¿«é€Ÿæ£€æŸ¥æ¸…å•ï¼‰ æ£€æŸ¥ apiserver cert SANï¼š\nopenssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A2 \u0026#34;Subject Alternative Name\u0026#34; æ£€æŸ¥ kubelet ä½¿ç”¨çš„ node-ipï¼š\nps -ef | grep kubelet grep -i node-ip /var/lib/kubelet/kubeadm-flags.env || journalctl -u kubelet -n 200 æ£€æŸ¥ etcd å¯è¾¾ï¼ˆHTTPSï¼‰ï¼š\nETCDCTL_API=3 etcdctl --endpoints=https://172.16.0.113:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/client.crt --key=/etc/kubernetes/pki/etcd/client.key endpoint status Calico çŠ¶æ€ï¼š\nkubectl -n calico-system get pods kubectl -n calico-system logs ds/calico-node æŠŠä¸Šé¢ YAML è¿›ä¸€æ­¥ç”Ÿæˆä¸¤ä¸ªç‰ˆæœ¬ï¼š(A) Calico eBPFï¼ˆæ¨èï¼‰ çš„å®Œæ•´ install-playbook ä¸ (B) Calico IPIP/VXLAN + kube-proxy(ipvs) çš„ä¿å®ˆç‰ˆæœ¬ï¼Œå¹¶ç»™å‡ºä¸€é”®éƒ¨ç½²å‘½ä»¤ï¼ˆåŒ…æ‹¬å¿…è¦çš„å†…æ ¸æ¨¡å—ã€sysctlã€conntrack è°ƒæ•´ï¼‰ å¥½ â€” æˆ‘æŠŠä½ è¦çš„ ä¸¤ä¸ªå¯ç›´æ¥æ‰§è¡Œçš„ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆ éƒ½åšå‡ºæ¥äº†ï¼ˆAï¼šCalico eBPF æ¨èç‰ˆï¼›Bï¼šCalico VXLAN/IPIP + kube-proxy(ipvs) ä¿å®ˆç‰ˆï¼‰ã€‚æ¯ä¸ªæ–¹æ¡ˆåŒ…å«ï¼š\nèŠ‚ç‚¹é¢„æ£€ä¸å†…æ ¸æ¨¡å— / sysctl / conntrack è°ƒæ•´çš„ä¸€é”®è„šæœ¬ï¼ˆåœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰ åœ¨ Control Plane ä¸Šè¿è¡Œçš„ã€Œä¸€é”®å®‰è£…è„šæœ¬ã€ï¼Œä¼šåº”ç”¨ Calico Operator + å¯¹åº”çš„ Installation CRï¼ˆå·²æŒ‰æ¨èé¡¹é…ç½®ï¼‰ å¼€å¯ / å…³é—­ kube-proxy çš„å®‰å…¨å»ºè®®ä¸å‘½ä»¤ éªŒè¯æ­¥éª¤ä¸æ’æŸ¥è¦ç‚¹ è¯´æ˜ï¼šè„šæœ¬ä»¥ Bash ç¼–å†™ï¼Œé€‚ç”¨äº RHEL/AlmaLinux/CentOS/Ubuntuï¼ˆæœ‰å°‘é‡ç³»ç»Ÿå·®å¼‚æ³¨è®°ï¼‰ã€‚æ‰§è¡Œå‰è¯·æŠŠ NODES åˆ—è¡¨ä¸ KUBECONFIG ç¯å¢ƒå˜é‡ï¼ˆæˆ– kubectl å¯ç”¨ï¼‰è°ƒæ•´å¥½ã€‚è¯·åœ¨éç”Ÿäº§ç¯å¢ƒå…ˆè·‘ä¸€æ¬¡é¢„æ£€è„šæœ¬å¹¶æ£€æŸ¥è¾“å‡ºã€‚\nA. Calico eBPFï¼ˆæ¨èï¼‰ ä¸€é”®å®‰è£… Playbook è¯´æ˜ï¼šæ­¤æ–¹æ¡ˆä»¥ eBPF dataplane + VXLAN encapsulation ä¸ºä¸»ï¼ˆå…¼é¡¾äº‘ä¸è£¸é‡‘å±ï¼‰ï¼Œæœ€å¤§åŒ–æ€§èƒ½å¹¶æ›¿ä»£ kube-proxyï¼ˆéœ€ç§»é™¤/ç¦ç”¨ kube-proxyï¼‰ã€‚å¦‚æœä½ æƒ³ä¿ç•™ kube-proxyï¼Œè¯·æ”¹ç”¨ B æ–¹æ¡ˆã€‚\nå…ˆå†³æ¡ä»¶ï¼ˆæ‘˜è¦ï¼‰\nKernel \u0026gt;= 5.4 æ¨èï¼ˆæœ€å¥½ 5.10+ï¼‰ä¸”å¯ç”¨äº† eBPF æ”¯æŒ containerd æˆ– CRI-O æ­£å¸¸è¿è¡Œ kubectl å¯ç”¨å¹¶æŒ‡å‘ control-planeï¼ˆæœ‰ cluster-admin æƒé™ï¼‰ å„ Node èƒ½å¤Ÿè®¿é—®ç½‘ç»œã€æ—¶é—´åŒæ­¥æ­£å¸¸ è‹¥é›†ç¾¤ç”¨ external etcdï¼Œè¯·ä¿è¯ TLS æ­£ç¡® 1. èŠ‚ç‚¹é¢„æ£€ + å†…æ ¸ / sysctl / conntrack è°ƒæ•´ï¼ˆåœ¨æ¯ä¸ª Node ä¸Šæ‰§è¡Œï¼‰ ä¿å­˜ä¸º calico-ebpf-preflight.shï¼Œåœ¨æ¯ä¸ª nodeï¼ˆæˆ–é€šè¿‡ SSH å¾ªç¯ï¼‰æ‰§è¡Œï¼š\n#!/usr/bin/env bash set -euo pipefail # Usage: sudo ./calico-ebpf-preflight.sh echo \u0026#34;=== preflight: kernel \u0026amp; modules \u0026amp; sysctl for Calico eBPF ===\u0026#34; # 1. basic check echo \u0026#34;Kernel version: $(uname -r)\u0026#34; if ! grep -qP \u0026#39;^5\\.\u0026#39; /proc/version \u0026amp;\u0026amp; ! grep -qP \u0026#39;^6\\.\u0026#39; /proc/version ; then echo \u0026#34;WARN: kernel may be older than recommended (5.x/6.x). eBPF works best on 5.4+; continue at your risk.\u0026#34; fi # 2. install bpftool if missing (try distro package; fallback to static) if ! command -v bpftool \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;bpftool not found. Installing...\u0026#34; if command -v dnf \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then sudo dnf install -y bpftool || true elif command -v apt-get \u0026gt;/dev/null 2\u0026gt;\u0026amp;1; then sudo apt-get update \u0026amp;\u0026amp; sudo apt-get install -y bpftool || true fi fi # 3. enable required kernel modules (try load, ignore failures) echo \u0026#34;Loading kernel modules...\u0026#34; sudo modprobe -a ip_tables ip_set nf_conntrack nft_chain_nat nft_nat xt_conntrack || true # 4. sysctl tuning (applies immediately) echo \u0026#34;Applying sysctl tuning...\u0026#34; sudo sysctl -w net.ipv4.ip_forward=1 sudo sysctl -w net.bridge.bridge-nf-call-iptables=1 sudo sysctl -w net.bridge.bridge-nf-call-ip6tables=1 # conntrack tuning sudo sysctl -w net.netfilter.nf_conntrack_max=2621440 sudo sysctl -w net.netfilter.nf_conntrack_buckets=655360 sudo sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=600 # ephemeral ports (optional) sudo sysctl -w net.ipv4.ip_local_port_range=\u0026#34;10000 65000\u0026#34; # persist to /etc/sysctl.d/99-calico.conf cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-calico.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.netfilter.nf_conntrack_max = 2621440 net.netfilter.nf_conntrack_buckets = 655360 net.netfilter.nf_conntrack_tcp_timeout_established = 600 net.ipv4.ip_local_port_range = 10000 65000 EOF sudo sysctl --system \u0026gt;/dev/null echo \u0026#34;Preflight done. Recommended: ensure bpftool is available and kernel \u0026gt;=5.10 for best results.\u0026#34; 2. åœ¨ control-plane ä¸Šçš„ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆåº”ç”¨ Calico Operator + Installation CRï¼‰ ä¿å­˜ä¸º install-calico-ebpf.sh å¹¶åœ¨ control-planeï¼ˆkubectl å¯ç”¨ï¼‰è¿è¡Œï¼š\n#!/usr/bin/env bash set -euo pipefail # Usage: ./install-calico-ebpf.sh # Ensure KUBECONFIG or kubectl context points to target cluster CALICO_MANIFEST=\u0026#34;https://docs.projectcalico.org/manifests/tigera-operator-manifests.yaml\u0026#34; echo \u0026#34;1) Apply Calico operator manifest...\u0026#34; kubectl apply -f ${CALICO_MANIFEST} echo \u0026#34;Waiting for operator...\u0026#34; kubectl -n tigera-operator rollout status deploy/tigera-operator --timeout=180s || true echo \u0026#34;2) Create Installation CR for eBPF + VXLAN\u0026#34; cat \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; | kubectl apply -f - apiVersion: operator.tigera.io/v1 kind: Installation metadata: name: default spec: calicoNetwork: # Use BPF dataplane linuxDataplane: \u0026#34;BPF\u0026#34; # Encapsulation: VXLAN for cloud portability and offload encapsulation: \u0026#34;VXLAN\u0026#34; # set MTU according to underlying network (example 1450) mtu: 1450 # cross-subnet NAT outgoing for external access natOutgoing: true EOF echo \u0026#34;Installation CR applied. Waiting for Calico components...\u0026#34; kubectl -n tigera-operator get pods -w || true echo \u0026#34;3) Disable kube-proxy (Calico eBPF handles Service dataplane)\u0026#34; echo \u0026#34;NOTE: Disabling kube-proxy will remove ipvs/iptables rules. Do on all nodes once you\u0026#39;re ready.\u0026#34; echo \u0026#34;To remove kube-proxy DaemonSet (execute when ready):\u0026#34; echo \u0026#34; kubectl -n kube-system delete ds kube-proxy\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;Alternatively, you can patch to a benign configuration and then delete.\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;4) Verify calico-node \u0026amp; calico-kube-controllers status:\u0026#34; kubectl -n calico-system get pods echo \u0026#34;Done. Monitor logs: kubectl -n calico-system logs ds/calico-node\u0026#34; é‡è¦è¯´æ˜ / æ“ä½œé¡ºåºå»ºè®®ï¼ˆç”Ÿäº§çº§ï¼‰\nåœ¨æ‰€æœ‰èŠ‚ç‚¹è·‘å¥½ calico-ebpf-preflight.sh å¹¶ç¡®è®¤æ— é”™è¯¯ã€‚ åœ¨ control-plane è¿è¡Œ install-calico-ebpf.shã€‚ç­‰å¾… calico-nodeã€calico-kube-controllers å¯åŠ¨å¹¶ Readyã€‚ éªŒè¯ï¼škubectl -n calico-system get dsã€kubectl get pods -A | grep calicoã€‚ å½“ calico-node çš„ BPF dataplane å·²ç¡®è®¤æ­£å¸¸ï¼ˆæŸ¥çœ‹ pod æ—¥å¿—ï¼‰ï¼Œå†åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰å…¨ç§»é™¤ kube-proxyï¼ˆkubectl -n kube-system delete ds kube-proxyï¼‰ã€‚å…ˆç¡®è®¤ Calico eBPF èƒ½å¤„ç† Service æµé‡å†åˆ é™¤ kube-proxyï¼Œå¦åˆ™çŸ­æ—¶é—´å†…ä¼šä¸¢æµé‡ã€‚ 3. éªŒè¯æ­¥éª¤ï¼ˆå®‰è£…å®Œæˆåï¼‰ # calico pods ready kubectl -n calico-system get pods # calico node daemonset kubectl -n calico-system get ds # check calico-node logs for BPF status kubectl -n calico-system logs ds/calico-node -c calico-node | tail -n 200 # test pod-to-pod connectivity kubectl run -n default test1 --image=busybox --restart=Never --rm -it -- /bin/sh -c \u0026#34;sleep 3600\u0026#34; \u0026amp; # create another busybox, exec ping etc. B. Calico IPIP/VXLAN + kube-proxy(ipvs) ä¿å®ˆç‰ˆï¼ˆå…¼å®¹æ€§ä¼˜å…ˆï¼‰ è¯´æ˜ï¼šå¦‚æœä½ éœ€è¦ä¿ç•™ kube-proxyï¼ˆipvsï¼‰æˆ–èŠ‚ç‚¹å†…æ ¸ä¸é€‚åˆ eBPFï¼Œä½¿ç”¨æ­¤æ–¹æ¡ˆã€‚é»˜è®¤ä½¿ç”¨ VXLANï¼ˆæˆ– IPIPï¼‰ï¼Œå¹¶ä¿ç•™ kube-proxy çš„ ipvs æ¨¡å¼ã€‚\n1. èŠ‚ç‚¹é¢„æ£€ + å†…æ ¸æ¨¡å— / sysctl / conntrack è°ƒæ•´ï¼ˆåœ¨æ¯ä¸ª Node æ‰§è¡Œï¼‰ ä¿å­˜ä¸º calico-ipvs-preflight.shï¼š\n#!/usr/bin/env bash set -euo pipefail # Usage: sudo ./calico-ipvs-preflight.sh echo \u0026#34;=== preflight: ipvs modules \u0026amp; sysctl for Calico + kube-proxy(ipvs) ===\u0026#34; # Load ipvs modules sudo modprobe ip_vs sudo modprobe ip_vs_rr sudo modprobe ip_vs_wrr sudo modprobe ip_vs_sh sudo modprobe nf_conntrack sudo modprobe nf_conntrack_ipv4 || true sudo modprobe xt_conntrack || true # sysctl tuning sudo sysctl -w net.ipv4.ip_forward=1 sudo sysctl -w net.bridge.bridge-nf-call-iptables=1 sudo sysctl -w net.bridge.bridge-nf-call-ip6tables=1 # conntrack sudo sysctl -w net.netfilter.nf_conntrack_max=2621440 sudo sysctl -w net.netfilter.nf_conntrack_buckets=655360 # persist cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/99-calico-ipvs.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.netfilter.nf_conntrack_max = 2621440 net.netfilter.nf_conntrack_buckets = 655360 EOF sudo sysctl --system \u0026gt;/dev/null echo \u0026#34;Preflight done. IPVS modules loaded and sysctl set.\u0026#34; 2. åœ¨ control-plane ä¸Šçš„ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆCalico + ipvsï¼‰ ä¿å­˜ä¸º install-calico-ipvs.sh å¹¶åœ¨ control-plane ä¸Šè¿è¡Œï¼š\n#!/usr/bin/env bash set -euo pipefail # Usage: ./install-calico-ipvs.sh CALICO_MANIFEST=\u0026#34;https://docs.projectcalico.org/manifests/tigera-operator-manifests.yaml\u0026#34; echo \u0026#34;1) Apply Calico operator manifest...\u0026#34; kubectl apply -f ${CALICO_MANIFEST} echo \u0026#34;Waiting for operator...\u0026#34; kubectl -n tigera-operator rollout status deploy/tigera-operator --timeout=180s || true echo \u0026#34;2) Create Installation CR for VXLAN (or IPIP) with ipvs kube-proxy\u0026#34; cat \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; | kubectl apply -f - apiVersion: operator.tigera.io/v1 kind: Installation metadata: name: default spec: calicoNetwork: # Use linux dataplane (iptables/ipip/vxlan) linuxDataplane: \u0026#34;Kernel\u0026#34; # Choose encapsulation: \u0026#34;VXLAN\u0026#34; or \u0026#34;IPIP\u0026#34; encapsulation: \u0026#34;VXLAN\u0026#34; mtu: 1450 natOutgoing: true EOF echo \u0026#34;3) Ensure kube-proxy is running in ipvs mode (DaemonSet should exist)\u0026#34; kubectl -n kube-system get ds kube-proxy || echo \u0026#34;kube-proxy DS missing; ensure kube-proxy is installed in ipvs mode\u0026#34; echo \u0026#34;If kube-proxy not in ipvs mode, run this on control plane (or via your kube-proxy manifest):\u0026#34; echo \u0026#34;kubectl -n kube-system set env ds/kube-proxy --containers=kube-proxy mode=ipvs || patch daemonset with --proxy-mode=ipvs\u0026#34; echo \u0026#34;4) Verify calico and kube-proxy\u0026#34; kubectl -n calico-system get pods kubectl -n kube-system get ds kube-proxy echo \u0026#34;Done.\u0026#34; è¯´æ˜/æ³¨æ„\nlinuxDataplane: \u0026ldquo;Kernel\u0026rdquo; æŒ‡ä½¿ç”¨å†…æ ¸ dataplaneï¼ˆiptables/ipvsï¼‰ã€‚ Encapsulation å¯æ”¹ä¸º IPIPï¼šæŠŠ encapsulation: \u0026ldquo;IPIP\u0026rdquo; æ›¿æ¢ VXLANã€‚IPIP å¯åœ¨æŸäº›æ—§ç¯å¢ƒä½¿ç”¨ï¼Œä½† VXLAN æ›´åˆ©äºäº‘/ç¡¬ä»¶ offloadã€‚ ç¡®ä¿ kube-proxy å·²å®‰è£…å¹¶é…ç½® mode: ipvsï¼ˆé€šå¸¸ kubeadm init ä¼šè‡ªåŠ¨éƒ¨ç½² ipvs modeï¼Œå¦‚æœä¸»æœºå†…æ ¸æ¨¡å—å¯ç”¨ï¼‰ã€‚è‹¥æ²¡æœ‰ï¼Œè¯·å®‰è£… kube-proxy çš„æ­£ç¡® manifestã€‚ 3. éªŒè¯æ­¥éª¤ï¼ˆå®‰è£…å®Œæˆåï¼‰ # calico pods kubectl -n calico-system get pods # kube-proxy daemonset status kubectl -n kube-system get ds kube-proxy # check ipvs rules on a node ssh node1 \u0026#34;sudo ipvsadm -Ln\u0026#34; # check VXLAN interface ssh node1 \u0026#34;ip -d link show vxlan.calico || ip -d link show tunl0\u0026#34; å¸¸è§æ“ä½œ/å›æ»šä¸å®‰å…¨æç¤ºï¼ˆä¸¤ç§æ–¹æ¡ˆå…±é€šï¼‰ å…ˆåšé¢„æ£€å†åˆ  kube-proxyï¼ˆeBPF æ–¹æ¡ˆï¼‰ï¼šç¡®è®¤ calico-node çš„ logs æ²¡æœ‰é”™è¯¯å¹¶ä¸” pod-to-podã€service-to-pod æµ‹è¯•éƒ½æ­£å¸¸åå†åˆ é™¤ kube-proxyã€‚ å¤‡ä»½å…³é”® manifestï¼škubectl -n kube-system get ds kube-proxy -o yaml \u0026gt; kube-proxy.backup.yamlã€‚ä¸‡ä¸€éœ€è¦å›æ»šï¼Œå¯ä»¥é‡æ–° applyã€‚ å¦‚æœèŠ‚ç‚¹ä¸Šæœ‰ OpenVPN/tun0ï¼šä¸º kubelet æ˜ç¡® node-ipï¼ˆè§ä½ ä¹‹å‰é…ç½®ï¼‰ï¼Œé¿å…ç»‘å®šé”™è¯¯æ¥å£ã€‚ MTU è°ƒæ•´ï¼šå¦‚æœä½ åœ¨ cloud providerï¼Œç¡®è®¤ VPC MTU ä¸ VXLAN overheadï¼ˆ50 bytesï¼‰å…¼å®¹ï¼Œé€šå¸¸ 1500 - 50 = 1450 æ˜¯ç¨³å¦¥å€¼ã€‚ conntrackï¼šé«˜ QPS æœåŠ¡éœ€æŠŠ nf_conntrack_max æé«˜åˆ°é€‚é…æµé‡ã€‚è§‚å¯Ÿ /proc/net/nf_conntrack ä¸ conntrack -Lã€‚ eBPF ä¾èµ–å†…æ ¸ï¼šæŸäº›è€å†…æ ¸æˆ– container runtimes ç‰ˆæœ¬ä¼šæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒè·‘å®Œæ•´æµé‡å‹æµ‹å†åˆ‡ç”Ÿäº§ã€‚ ","description":"åˆå§‹ kubeadm é…ç½®\napiVersion: kubeadm.k8s.io/v1beta4 kind: InitConfiguration localAPIEndpoint: advertiseAddress: 172.16.0.116 bindPort: 6443 nodeRegistration: criSocket: unix:///var/run/containerd/containerd.sock kubeletExtraArgs: fail-swap-on: \u0026#34;false\u0026#34; taints: - effect: PreferNoSchedule key: node-role.kubernetes.io/master --- apiServer: extraArgs: service-node-port-range: \u0026#34;10000-50000\u0026#34; apiVersion: kubeadm.k8s.io/v1beta4 # clusterName: kubernetes controlPlaneEndpoint: 172.16.0.118:8443 etcd: external: endpoints: - http://172.16.0.113:2379 - http://172.16.0.114:2379 - http://172.16.0.115:2379 # imageRepository: registry.server.com kind: ClusterConfiguration kubernetesVersion: 1.33.3 networking: dnsDomain: cluster.local serviceSubnet: 10.96.0.0/12 podSubnet: 10.244.0.0/16 --- apiVersion: kubelet.config.k8s.io/v1beta1 cgroupDriver: systemd kind: KubeletConfiguration failSwapOn: false --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs ipvs: strictARP: true ä¸‹é¢æ ¹æ®ç»™å‡ºçš„åˆå§‹ kubeadm é…ç½®ï¼ŒæŒ‰ Kubernetes 1.33 + Calicoï¼ˆæ¨è eBPF + VXLANï¼‰æœ€ä½³å®è·µ åšäº†ä¼˜åŒ–ä¸è¡¥å……ï¼Œè¾“å‡º å¯ç›´æ¥ä½¿ç”¨çš„ kubeadm YAMLï¼ˆä¿ç•™ä½ åŸæœ‰å­—æ®µå¹¶è¡¥è¶³å¿…è¦å®‰å…¨/å¯ç”¨æ€§é¡¹ï¼‰ï¼Œå¹¶åœ¨åé¢ç»™å‡ºé€æ®µè¯¦è§£ä¸æ³¨æ„äº‹é¡¹ï¼ŒåŒ…å«ä¸ºä»€ä¹ˆè¿™æ ·é…ç½®ã€ä»€ä¹ˆæ—¶å€™éœ€è¦ä¿®æ”¹ï¼Œä»¥åŠä¸ Calico çš„é…å¥—å»ºè®®ï¼ˆeBPF / VXLAN / kube-proxy å¤„ç†ç­‰ï¼‰ã€‚\n"},{"id":96,"href":"/operations/linux/kernel-cgroups/","title":"Linux cgroups","parent":"Linux","content":" ä¸€ã€cgroups æ˜¯ä»€ä¹ˆï¼Ÿ cgroups = Linux å†…æ ¸çš„ã€Œèµ„æºé…é¢ä¸æ§åˆ¶ç³»ç»Ÿã€\nå¦‚æœè¯´ï¼š\nNamespaceï¼šä½  èƒ½çœ‹åˆ°ä»€ä¹ˆ cgroupsï¼šä½  èƒ½ç”¨å¤šå°‘ é‚£ä¹ˆ å®¹å™¨ = Namespace + cgroups\näºŒã€cgroups èƒ½å¹²ä»€ä¹ˆï¼Ÿ èµ„æº èƒ½æ§åˆ¶ä»€ä¹ˆ CPU ä½¿ç”¨æ¯”ä¾‹ã€ä¸Šé™ã€è°ƒåº¦ Memory æœ€å¤§å†…å­˜ã€OOM è¡Œä¸º I/O ç£ç›˜è¯»å†™é™é€Ÿ PIDs æœ€å¤§è¿›ç¨‹æ•° Network é—´æ¥ï¼ˆé€šè¿‡ tc / BPFï¼‰ HugePages å·¨é¡µé…é¢ Devices è®¾å¤‡è®¿é—® ä¸‰ã€cgroups çš„ä¸¤ä¸ªæ—¶ä»£ï¼šv1 vs v2ï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ cgroups v1ï¼ˆå†å²åŒ…è¢±ï¼‰ å¤šå±‚çº§ã€å¤š controller æ¯ä¸ª controller ä¸€æ£µæ ‘ æ··ä¹±ã€å®¹æ˜“é…ç½®é”™ /sys/fs/cgroup/memory /sys/fs/cgroup/cpu /sys/fs/cgroup/blkio 2ï¸âƒ£ cgroups v2ï¼ˆRHEL 9 / AlmaLinux 9 é»˜è®¤ï¼‰ å•ä¸€å±‚çº§ ç»Ÿä¸€æ¥å£ æ›´å¼ºçš„èµ„æºæ¨¡å‹ /sys/fs/cgroup/ â”œâ”€â”€ cgroup.controllers â”œâ”€â”€ cgroup.subtree_control â”œâ”€â”€ cpu.max â”œâ”€â”€ memory.max â”œâ”€â”€ io.max ğŸ“Œ RHEL 8+ / Debian 11+ æ¨èåªç”¨ v2\nå››ã€cgroups v2 çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ 1ï¸âƒ£ å•ä¸€å±‚çº§ï¼ˆUnified Hierarchyï¼‰ æ‰€æœ‰èµ„æºï¼š\n/sys/fs/cgroup/ 2ï¸âƒ£ Controller å¿…é¡»æ˜¾å¼å¼€å¯ echo \u0026#34;+cpu +memory\u0026#34; \u0026gt; cgroup.subtree_control 3ï¸âƒ£ çˆ¶ç»„é™åˆ¶ = å­ç»„ä¸Šé™ å­ç»„çš„èµ„æºä¸èƒ½è¶…è¿‡çˆ¶ç»„\näº”ã€cgroups v2 çš„æ ¸å¿ƒ Controller â˜˜ï¸ CPU Controller 1ï¸âƒ£ cpu.maxï¼ˆæ ¸å¿ƒï¼‰ cpu.max = \u0026lt;quota\u0026gt; \u0026lt;period\u0026gt; 100000 100000 = 1 core 200000 100000 = 2 cores max 100000 = ä¸é™ 2ï¸âƒ£ cpu.weightï¼ˆæ¯”ä¾‹ï¼‰ cpu.weight = 1 ~ 10000 ğŸ“Œ é»˜è®¤ 100\nâ˜˜ï¸ Memory Controllerï¼ˆæœ€é‡è¦ï¼‰ 1ï¸âƒ£ memory.maxï¼ˆç¡¬é™åˆ¶ï¼‰ memory.max = 512M è¶…å‡ºï¼š\nOOM kill ä¸å½±å“å®¿ä¸» 2ï¸âƒ£ memory.highï¼ˆè½¯é™åˆ¶ï¼‰ memory.high = 400M è¶…è¿‡ -\u0026gt; å›æ”¶ / throttling ä¸ç›´æ¥ OOM 3ï¸âƒ£ memory.swap.max memory.swap.max = 0 # ç¦ç”¨ swap 4ï¸âƒ£ memory.current å®æ—¶ä½¿ç”¨é‡\nğŸ’½ IO Controllerï¼ˆç”Ÿäº§å¸¸ç”¨ï¼‰ io.max=\u0026#34;8:0 rbps=10M wbps=5M\u0026#34; ğŸ”¢ PIDs Controllerï¼ˆé˜² fork ç‚¸å¼¹ï¼‰ pids.max = 256 ğŸ§© Devices Controllerï¼ˆv2 æœ‰é™åˆ¶ï¼‰ v2 ä¸å†æ¨èç›´æ¥ç”¨ devices\n-\u0026gt; eBPF / LSM\nå…­ã€cgroups æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Ÿ 1ï¸âƒ£ cgroup ä½œç”¨äºè¿›ç¨‹ echo \u0026lt;pid\u0026gt; \u0026gt; cgroup.procs 2ï¸âƒ£ å­è¿›ç¨‹è‡ªåŠ¨ç»§æ‰¿ ä¸ƒã€systemd ä¸ cgroupsï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ systemd = cgroups ç®¡ç†å™¨ æ¯ä¸ª service / slice éƒ½æ˜¯ cgroup systemd åªæ”¯æŒ v2ï¼ˆRHEL 9ï¼‰ 2ï¸âƒ£ systemd cgroup å±‚çº§ / â”œâ”€â”€ system.slice â”‚ â””â”€â”€ sshd.service â”œâ”€â”€ user.slice â”‚ â””â”€â”€ user-1000.slice â””â”€â”€ machine.slice â””â”€â”€ docker-xxx.scope 3ï¸âƒ£ systemd èµ„æºé™åˆ¶ç¤ºä¾‹ [Service] MemoryMax=1G CPUQuota=200% TasksMax=512 å…«ã€Docker / Podman / K8S ä¸ cgroups Docker docker run -m 512m --cpus=1 nginx -\u0026gt; è½¬æ¢ä¸ºï¼š\nmemory.max cpu.max Kubernetes Pod é…ç½® cgroup æ˜ å°„ limits.memory memory.max requests.cpu cpu.weight ğŸ“Œ requests â‰  limits\nä¹ã€NUMA + cgroupsï¼ˆé«˜çº§ï¼‰ é»˜è®¤ä¸ç»‘å®š NUMA å¯ç»“åˆï¼š cpuset.cpus cpuset.mems cpuset.cpus=0-7 cpuset.mems=0 ğŸ“Œ æ•°æ®åº“å¼ºçƒˆå»ºè®®\nåã€OOM è¡Œä¸ºä¸ memory.oom.group memory.oom.group=1 æ•´ä¸ª cgroup ä¸€èµ· kill é˜²æ­¢â€œåŠæ­»ä¸æ´»â€ åä¸€ã€ç›‘æ§ä¸æ’æŸ¥ 1ï¸âƒ£ æŸ¥çœ‹ç³»ç»Ÿ cgroup ç‰ˆæœ¬ stat -fc %T /sys/fs/cgroup cgroup2fs -\u0026gt; v2 2ï¸âƒ£ æŸ¥çœ‹è¿›ç¨‹æ‰€åœ¨ cgroup cat /proc/\u0026lt;pid\u0026gt;/cgroup 3ï¸âƒ£ å®æ—¶ç›‘æ§ cat memory.current cat cpu.stat åäºŒã€ç”Ÿäº§å®è·µæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… æ¨è\nç”¨ cgroups v2 é€šè¿‡ systemd ç®¡ç† è®¾ç½® pids.max è®¾ç½® memory.high + memory.max âŒ é›·åŒº\nv1/v2 æ··ç”¨ memory.max ä¸ç•™ä½™é‡ å¿½ç•¥ swap è¡Œä¸º å®¹å™¨æ— é™ fork åä¸‰ã€Namespace vs cgroups å¯¹ç…§è¡¨ ç»´åº¦ Namespace cgroups ä½œç”¨ éš”ç¦» é™åˆ¶ ç²’åº¦ è§†å›¾ é…é¢ æ˜¯å¦é™åˆ¶èµ„æº âŒ âœ… å®¹å™¨å¿…éœ€ âœ… âœ… åå››ã€æ€»ç»“ Namespace å†³å®šä¸–ç•Œçš„è¾¹ç•Œ\ncgroups å†³å®šèµ„æºçš„ä¸Šé™\n","description":" ä¸€ã€cgroups æ˜¯ä»€ä¹ˆï¼Ÿ cgroups = Linux å†…æ ¸çš„ã€Œèµ„æºé…é¢ä¸æ§åˆ¶ç³»ç»Ÿã€\nå¦‚æœè¯´ï¼š\nNamespaceï¼šä½  èƒ½çœ‹åˆ°ä»€ä¹ˆ cgroupsï¼šä½  èƒ½ç”¨å¤šå°‘ é‚£ä¹ˆ å®¹å™¨ = Namespace + cgroups\näºŒã€cgroups èƒ½å¹²ä»€ä¹ˆï¼Ÿ èµ„æº èƒ½æ§åˆ¶ä»€ä¹ˆ CPU ä½¿ç”¨æ¯”ä¾‹ã€ä¸Šé™ã€è°ƒåº¦ Memory æœ€å¤§å†…å­˜ã€OOM è¡Œä¸º I/O ç£ç›˜è¯»å†™é™é€Ÿ PIDs æœ€å¤§è¿›ç¨‹æ•° Network é—´æ¥ï¼ˆé€šè¿‡ tc / BPFï¼‰ HugePages å·¨é¡µé…é¢ Devices è®¾å¤‡è®¿é—® ä¸‰ã€cgroups çš„ä¸¤ä¸ªæ—¶ä»£ï¼šv1 vs v2ï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ cgroups v1ï¼ˆå†å²åŒ…è¢±ï¼‰ å¤šå±‚çº§ã€å¤š controller æ¯ä¸ª controller ä¸€æ£µæ ‘ æ··ä¹±ã€å®¹æ˜“é…ç½®é”™ /sys/fs/cgroup/memory /sys/fs/cgroup/cpu /sys/fs/cgroup/blkio 2ï¸âƒ£ cgroups v2ï¼ˆRHEL 9 / AlmaLinux 9 é»˜è®¤ï¼‰ å•ä¸€å±‚çº§ ç»Ÿä¸€æ¥å£ æ›´å¼ºçš„èµ„æºæ¨¡å‹ /sys/fs/cgroup/ â”œâ”€â”€ cgroup.controllers â”œâ”€â”€ cgroup.subtree_control â”œâ”€â”€ cpu.max â”œâ”€â”€ memory.max â”œâ”€â”€ io.max ğŸ“Œ RHEL 8+ / Debian 11+ æ¨èåªç”¨ v2\n"},{"id":97,"href":"/operations/linux/kernel-namespace/","title":"Linux Namespace","parent":"Linux","content":" ä¸€ã€Namespace æ˜¯ä»€ä¹ˆï¼Ÿ Namespace = Linux å†…æ ¸æä¾›çš„ã€Œèµ„æºè§†å›¾éš”ç¦»æœºåˆ¶ã€\nåŒä¸€å°ä¸»æœºä¸Šï¼š\nåŒä¸€ä¸ªèµ„æº ä¸åŒè¿›ç¨‹ çœ‹åˆ°çš„æ˜¯ä¸åŒä¸–ç•Œ ğŸ“Œ Namespace ä¸åšèµ„æºé™åˆ¶ï¼ˆé‚£æ˜¯ cgroups å¹²çš„ï¼‰ï¼Œåªåš â€œçœ‹ä¸çœ‹å¾—åˆ°â€ã€‚\näºŒã€Linux æœ‰å“ªå‡ ç§ Namespaceï¼Ÿ Namespace éš”ç¦»å†…å®¹ å†…æ ¸å® Mount æŒ‚è½½ç‚¹ CLONE_NEWNS PID è¿›ç¨‹å· CLONE_NEWPID Network ç½‘ç»œæ ˆ CLONE_NEWNET IPC è¿›ç¨‹é—´é€šä¿¡ CLONE_NEWIPC UTS ä¸»æœºå/åŸŸå CLONE_NEWUTS User UID/GID CLONE_NEWUSER cgroups cgroup è§†å›¾ CLONE_NEWCGROUP Time ç³»ç»Ÿæ—¶é—´ CLONE_NEWTIME Docker / Podman / containerd å…¨éƒ½åœ¨ç”¨è¿™äº›ã€‚\nä¸‰ã€Namespace çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ 1ï¸âƒ£ Namespace ç»‘å®šçš„æ˜¯ã€Œè¿›ç¨‹ã€ Namespace ä¸æ˜¯ç³»ç»Ÿçº§ æ˜¯ è¿›ç¨‹å±æ€§ ls -l /proc/$$/ns 2ï¸âƒ£ å­è¿›ç¨‹å¯ä»¥ç»§æ‰¿ / åˆ›å»ºæ–° Namespace clone(CLONE_NEWNET | CLONE_NEWPID) 3ï¸âƒ£ Namespace å¯ä»¥åŠ å…¥ï¼ˆsetnsï¼‰ nsenter -t \u0026lt;pid\u0026gt; -n -m -p å››ã€Mount Namespaceï¼ˆæœ€åŸºç¡€ã€æœ€å¤æ‚ï¼‰ 1ï¸âƒ£ éš”ç¦»ä»€ä¹ˆï¼Ÿ / mount bind mount overlayfs 2ï¸âƒ£ ä¸ºä»€ä¹ˆå®¹å™¨è¦å®ƒï¼Ÿ å®¹å™¨å†…ï¼š\nmount | grep overlay å®¹å™¨å¤–ï¼š\nmount | grep overlay â¡ï¸ çœ‹åˆ°å®Œå…¨ä¸åŒ\n3ï¸âƒ£ å…³é”®æœºåˆ¶ï¼šæŒ‚è½½ä¼ æ’­ï¼ˆPropagationï¼‰ æ¨¡å¼ å«ä¹‰ private é»˜è®¤ï¼Œä¸ä¼ æ’­ shared ä¼ æ’­ slave å•å‘ unbindable ä¸å¯ç»‘å®š mount --make-rprivate / ğŸ“Œ å®¹å™¨å¯åŠ¨å‰å¿…åš\näº”ã€PID Namespaceï¼ˆè¿›ç¨‹éš”ç¦»ï¼‰ 1ï¸âƒ£ ç‰¹ç‚¹ PID ä» 1 å¼€å§‹ åªèƒ½çœ‹åˆ°è‡ªå·± namespace çš„è¿›ç¨‹ unshare -p --fork bash ps aux 2ï¸âƒ£ PID 1 çš„ç‰¹æ®Šæ€§ ä¸å¤„ç† SIGCHLD -\u0026gt; åƒµå°¸è¿›ç¨‹ å®¹å™¨ init å¿…é¡»å­˜åœ¨ ğŸ“Œ Docker ç”¨ tini\nå…­ã€Network Namespaceï¼ˆæœ€å¸¸ç”¨ï¼‰ 1ï¸âƒ£ éš”ç¦»ä»€ä¹ˆï¼Ÿ ç½‘å¡ IP è·¯ç”±è¡¨ é˜²ç«å¢™ conntrack 2ï¸âƒ£ æ–° netns æ˜¯ã€ŒçœŸÂ·è£¸æœºã€ ip netns add test ip netns exec test ip a åªæœ‰ï¼š\nloï¼ˆDOWNï¼‰ 3ï¸âƒ£ vethï¼šNamespace ä¹‹é—´çš„ç½‘çº¿ ip link add veth0 type veth peer name veth1 ip link set veth1 netns test 4ï¸âƒ£ Docker ç½‘ç»œæœ¬è´¨ container(netns) | veth | docker0 (bridge) | host NIC ä¸ƒã€UTS Namespaceï¼ˆä¸»æœºåï¼‰ unshare -u bash hostname container01 ä¸å½±å“å®¿ä¸»æœº Kubernetes Pod ç”¨å®ƒ å…«ã€IPC Namespace éš”ç¦»ï¼š\nSysV shm semaphore message queue ipcs -m å®¹å™¨é—´ä¸ä¼šäº’ç›¸çœ‹åˆ°\nä¹ã€User Namespaceï¼ˆæœ€å®¹æ˜“è¯¯è§£ï¼‰ 1ï¸âƒ£ è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ å®¹å™¨å†… root â‰  å®¿ä¸» root\nunshare -U bash id 2ï¸âƒ£ UID æ˜ å°„ cat /proc/$$/uid_map 0 100000 65536 3ï¸âƒ£ å®‰å…¨ä»·å€¼æé«˜ rootless container å‡å°‘ææƒé£é™© åã€cgroups Namespace éš”ç¦» /proc/self/cgroup è§†å›¾ é¿å…å®¹å™¨çœ‹åˆ°å®¿ä¸»å®Œæ•´å±‚çº§ åä¸€ã€Time Namespaceï¼ˆæ–°ï¼‰ CLOCK_MONOTONIC CLOCK_BOOTTIME unshare -T bash ğŸ“Œ ç”¨äºæµ‹è¯•ã€å›æ”¾\nåäºŒã€Namespace ç»„åˆ = å®¹å™¨ Container = Mount + PID + Net + IPC + UTS + User + cgroups ğŸ“Œ Namespace æ˜¯å®¹å™¨çš„æœ¬ä½“\nåä¸‰ã€Namespace ç”Ÿå‘½å‘¨æœŸ éšæœ€åä¸€ä¸ªè¿›ç¨‹ç»“æŸè€Œé”€æ¯ æˆ–è¢« bind mount åˆ°æ–‡ä»¶ç³»ç»Ÿ mount --bind /proc/1234/ns/net /var/run/netns/demo åå››ã€è°ƒè¯•ä¸æ’æŸ¥ 1ï¸âƒ£ æŸ¥çœ‹è¿›ç¨‹åœ¨å“ªäº› Namespace lsns -p \u0026lt;pid\u0026gt; 2ï¸âƒ£ è¿›å…¥å®¹å™¨ Namespaceï¼ˆæ—  Dockerï¼‰ nsenter -t \u0026lt;pid\u0026gt; -n -m -p -u -i bash åäº”ã€ç”Ÿäº§å®è·µç»éªŒæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… æ¨è\næ˜ç¡® namespace è¾¹ç•Œ ä½¿ç”¨ user namespace å®¹å™¨ PID 1 è¦é è°± netns å†…éƒ¨æœ€å°åŒ–é˜²ç«å¢™ âŒ é›·åŒº\nåœ¨ host ä¸Šä¹±æ”¹ mount ä¼ æ’­ å¿½ç•¥ PID 1 è¯¯ä»¥ä¸º namespace èƒ½é™èµ„æº åå…­ã€æ€»ç»“ Namespace æ˜¯â€œä½ èƒ½çœ‹åˆ°ä»€ä¹ˆâ€\ncgroups æ˜¯â€œä½ èƒ½ç”¨å¤šå°‘â€\nä¸¤è€…ä¸€èµ·ï¼Œæ‰æ˜¯å®¹å™¨ã€‚\n","description":" ä¸€ã€Namespace æ˜¯ä»€ä¹ˆï¼Ÿ Namespace = Linux å†…æ ¸æä¾›çš„ã€Œèµ„æºè§†å›¾éš”ç¦»æœºåˆ¶ã€\nåŒä¸€å°ä¸»æœºä¸Šï¼š\nåŒä¸€ä¸ªèµ„æº ä¸åŒè¿›ç¨‹ çœ‹åˆ°çš„æ˜¯ä¸åŒä¸–ç•Œ ğŸ“Œ Namespace ä¸åšèµ„æºé™åˆ¶ï¼ˆé‚£æ˜¯ cgroups å¹²çš„ï¼‰ï¼Œåªåš â€œçœ‹ä¸çœ‹å¾—åˆ°â€ã€‚\näºŒã€Linux æœ‰å“ªå‡ ç§ Namespaceï¼Ÿ Namespace éš”ç¦»å†…å®¹ å†…æ ¸å® Mount æŒ‚è½½ç‚¹ CLONE_NEWNS PID è¿›ç¨‹å· CLONE_NEWPID Network ç½‘ç»œæ ˆ CLONE_NEWNET IPC è¿›ç¨‹é—´é€šä¿¡ CLONE_NEWIPC UTS ä¸»æœºå/åŸŸå CLONE_NEWUTS User UID/GID CLONE_NEWUSER cgroups cgroup è§†å›¾ CLONE_NEWCGROUP Time ç³»ç»Ÿæ—¶é—´ CLONE_NEWTIME Docker / Podman / containerd å…¨éƒ½åœ¨ç”¨è¿™äº›ã€‚\n"},{"id":98,"href":"/operations/linux/kernel-numa/","title":"Linux NUMA","parent":"Linux","content":"NUMAï¼ˆNon-Uniform Memory Accessï¼‰\nä¸€ã€NUMA æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯å…ˆç«‹ä½ï¼‰ NUMA = æ¯ä¸ª CPU æœ‰â€œè‡ªå·±æ›´è¿‘çš„å†…å­˜â€ï¼Œè®¿é—®åˆ«çš„ CPU å†…å­˜ä¼šæ›´æ…¢\nå’Œå®ƒå¯¹ç«‹çš„æ˜¯ UMAï¼ˆUniform Memory Accessï¼‰ã€‚\näºŒã€ä¸ºä»€ä¹ˆä¼šæœ‰ NUMAï¼Ÿ 1ï¸âƒ£ UMA çš„é—®é¢˜ï¼ˆè€æ¶æ„ï¼‰ CPU0 â”€â” CPU1 â”€â”¼â”€â”€ Memory CPU2 â”€â”¤ CPU3 â”€â”˜ æ‰€æœ‰ CPU å…±äº«åŒä¸€å†…å­˜æ§åˆ¶å™¨ CPU è¶Šå¤š -\u0026gt; å†…å­˜äº‰ç”¨è¶Šä¸¥é‡ æ€»çº¿æˆä¸ºç“¶é¢ˆ 2ï¸âƒ£ NUMA çš„è¯ç”Ÿï¼ˆç°ä»£æœåŠ¡å™¨ï¼‰ NUMA Node 0 NUMA Node 1 +-----------+ +-----------+ | CPU0 CPU1 | | CPU2 CPU3 | | Memory 0 | \u0026lt;â”€â”€QPIâ”€â”€\u0026gt; | Memory 1 | +-----------+ +-----------+ å†…å­˜æ§åˆ¶å™¨é›†æˆåˆ° CPU æ¯ä¸ª CPUï¼ˆSocketï¼‰ç›´æ¥è¿ä¸€éƒ¨åˆ†å†…å­˜ CPU è®¿é—®ï¼š æœ¬åœ°å†…å­˜ -\u0026gt; å¿« è¿œç¨‹å†…å­˜ -\u0026gt; æ…¢ ä¸‰ã€NUMA ä¸­â€œæ…¢â€åˆ°åº•æ…¢å¤šå°‘ï¼Ÿ å¤§è‡´æ•°é‡çº§ï¼ˆå› ç¡¬ä»¶ä¸åŒè€Œå¼‚ï¼‰ï¼š\nè®¿é—®ç±»å‹ å»¶è¿Ÿ æœ¬åœ°å†…å­˜ ~70 ns è¿œç¨‹å†…å­˜ ~120â€“150 ns L3 Cache ~10â€“15 ns å†…å­˜ miss + è·¨ NUMA æ€§èƒ½æ–­å´–å¼ä¸‹é™ ğŸ‘‰ æ•°æ®åº“ã€ç¼“å­˜ã€ä¸­æ–­å¯†é›†å‹åº”ç”¨éå¸¸æ•æ„Ÿ\nå››ã€NUMA çš„æ ¸å¿ƒæ¦‚å¿µ 1ï¸âƒ£ NUMA Node ä¸€ä¸ª NUMA Node = ä¸€ç»„ CPU + æœ¬åœ°å†…å­˜ é€šå¸¸ï¼š 1 ä¸ª CPU Socket = 1 ä¸ª NUMA Node æœ‰äº›æœåŠ¡å™¨ï¼š1 Socket = 2 NUMA Nodeï¼ˆå­ NUMAï¼‰ 2ï¸âƒ£ Local / Remote Memory ç±»å‹ å«ä¹‰ Local CPU è®¿é—®è‡ªå·± Node çš„å†…å­˜ Remote CPU è®¿é—®å…¶å®ƒ Node çš„å†…å­˜ 3ï¸âƒ£ NUMA Distance numactl --hardware ç¤ºä¾‹ï¼š\nnode distances: node 0 1 0 10 20 1 20 10 æ•°å€¼è¶Šå° -\u0026gt; è¶Šå¿« æœ¬åœ°é€šå¸¸æ˜¯ 10 äº”ã€Linux å¦‚ä½•â€œæ„ŸçŸ¥â€ NUMAï¼Ÿ æŸ¥çœ‹ NUMA æ‹“æ‰‘ lscpu NUMA node(s): 2 NUMA node0 CPU(s): 0-15 NUMA node1 CPU(s): 16-31 æŸ¥çœ‹ NUMA å†…å­˜åˆ†å¸ƒ numactl --hardware node 0 size: 128 GB node 1 size: 128 GB è¿›ç¨‹çš„ NUMA ä½¿ç”¨æƒ…å†µ numastat -p \u0026lt;pid\u0026gt; å…­ã€NUMA å¸¦æ¥çš„â€œéšæ€§æ€§èƒ½å‘â€ 1ï¸âƒ£ CPU åœ¨ Node0ï¼Œå†…å­˜åˆ†é…åœ¨ Node1 åŸå› ï¼š\nè¿›ç¨‹å¯åŠ¨åœ¨ CPU0 å†…å­˜ç”±å…¶å®ƒ CPU è§¦å‘åˆ†é…ï¼ˆfirst-touch åŸåˆ™ï¼‰ ç»“æœï¼š\nCPU è·¨ NUMA è®¿é—®å†…å­˜ -\u0026gt; å»¶è¿Ÿç¿»å€\n2ï¸âƒ£ ä¸­æ–­åªè½åœ¨ä¸€ä¸ª NUMA èŠ‚ç‚¹ å¸¸è§äºï¼š\nç½‘å¡ NVMe é«˜é€Ÿå­˜å‚¨ å¯¼è‡´ï¼š\nä¸€ä¸ª CPU/socket è¢«æ‰“çˆ† å¦ä¸€ä¸ªå¾ˆé—² 3ï¸âƒ£ è™šæ‹ŸåŒ– / å®¹å™¨é»˜è®¤â€œå¿½ç•¥ NUMAâ€ KVM / Docker é»˜è®¤ä¸ç»‘ NUMA å¤§å†…å­˜ VM æ€§èƒ½æä¸ç¨³å®š ä¸ƒã€Linux ä¸­çš„ NUMA æ ¸å¿ƒæœºåˆ¶ 1ï¸âƒ£ First-Touch Policyï¼ˆéå¸¸å…³é”®ï¼‰ å†…å­˜åˆ†é…åœ¨å“ªä¸ª NUMA Nodeï¼Œå–å†³äºâ€œç¬¬ä¸€æ¬¡å†™å®ƒçš„ CPUâ€\nmalloc() memset() â† å†³å®šå†…å­˜å±äºå“ªä¸ª NUMA Node 2ï¸âƒ£ NUMA è‡ªåŠ¨å‡è¡¡ï¼ˆAutomatic NUMA Balancingï¼‰ cat /proc/sys/kernel/numa_balancing 1ï¼šå¼€å¯ï¼ˆé»˜è®¤ï¼‰ 0ï¼šå…³é—­ ä½œç”¨ï¼š\nå°è¯•æŠŠå†…å­˜è¿ç§»åˆ°æ›´é è¿‘ CPU çš„ Node âš ï¸ æ•°æ®åº“åœºæ™¯æœ‰æ—¶åè€Œæ›´æ…¢\nå…«ã€NUMA æ§åˆ¶å·¥å…·ï¼ˆå¿…ä¼šï¼‰ numactl # ç»‘å®š CPU å’Œå†…å­˜ numactl --cpunodebind=0 --membind=0 myapp tasksetï¼ˆåªç»‘ CPUï¼Œä¸ç»‘å†…å­˜ï¼‰ taskset -c 0-15 myapp âš ï¸ ä¸æ¨èå•ç‹¬ä½¿ç”¨\ncgroups / systemd CPUAffinity=0-15 NUMAPolicy=local ä¹ã€NUMA ä¸å¸¸è§ç»„ä»¶çš„å…³ç³» ğŸ”¹ æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰ å¤§å†…å­˜å®ä¾‹ å¿…é¡» NUMA æ„ŸçŸ¥ å¸¸è§ç­–ç•¥ï¼š å• NUMA Node è¿è¡Œ æˆ– NUMA interleave numactl --interleave=all mysqld ğŸ”¹ JVM -XX:+UseNUMA ğŸ”¹ KVM è™šæ‹Ÿæœº æ­£ç¡®æ–¹å¼ï¼švCPU â†” NUMA Node å¯¹é½ å†…å­˜ pre-allocate ğŸ”¹ Docker / Kubernetes é»˜è®¤ï¼šä¸æ„ŸçŸ¥ NUMA é«˜æ€§èƒ½åœºæ™¯ï¼š CPU Manager static HugePages + NUMA åã€ä»€ä¹ˆæ—¶å€™â€œè¦å…³ NUMAâ€ï¼Ÿ âŒ è¯¯åŒºï¼šä¸€ä¸Šæ¥å°±å…³ NUMA\nnumactl --interleave=all # æˆ– BIOS é‡Œå…³ NUMA åˆç†çš„æƒ…å†µ\nåœºæ™¯ å»ºè®® å°å†…å­˜ / å•è¿›ç¨‹ interleave NUMA æ„ŸçŸ¥å·®çš„è½¯ä»¶ interleave æ€§èƒ½è°ƒä¼˜å®Œæˆ ç²¾ç»†ç»‘å®š åä¸€ã€è¿ç»´å®æˆ˜æ£€æŸ¥æ¸…å• lscpu numactl --hardware numastat numastat -p \u0026lt;pid\u0026gt; é‡ç‚¹çœ‹ï¼š\næ˜¯å¦è·¨ NUMA åˆ†é… æ˜¯å¦æŸ Node å†…å­˜è¢«æ‰“æ»¡ åäºŒã€æ€»ç»“ NUMA æ˜¯â€œCPU å’Œå†…å­˜çš„è·ç¦»é—®é¢˜â€ï¼Œå¿½è§† NUMA = ç™½ç™½æµªè´¹ 30%~50% æ€§èƒ½ã€‚\nåä¸‰ã€å»ºè®® å‰æï¼š\nåŒè·¯æœåŠ¡å™¨ ä¸­æ–­äº²å’Œæ€§ æ•°æ®åº“ / å®¹å™¨ / é«˜å¹¶å‘ ğŸ‘‰ NUMA ä¸€å®šè¦å’Œï¼š\nIRQ äº²å’Œæ€§ CPU ç»‘å®š å†…å­˜åˆ†é…ç­–ç•¥ ä¸€èµ·è€ƒè™‘\næŸ¥çœ‹æ˜¯å¦ä¸ºåŒè·¯CPUï¼ˆç‰©ç†åŒCPUï¼‰ Linux ç³»ç»Ÿ\nä½¿ç”¨ç»ˆç«¯å‘½ä»¤ lscpu, æŸ¥çœ‹ Socket(s) ä¸€é¡¹ï¼Œæ•°å€¼ä¸º 2 åˆ™è¡¨ç¤ºåŒè·¯CPUã€‚ æˆ–è€…è¿è¡Œ cat /proc/cpuinfo | grep \u0026quot;physical id\u0026quot; | sort -u | wc -l æ¥è®¡ç®—ç‰©ç†CPUä¸ªæ•°ã€‚ ç¡¬ä»¶æŸ¥çœ‹\nç›´æ¥æ‰“å¼€æœåŠ¡å™¨æœºç®±ï¼Œè§‚å¯Ÿä¸»æ¿ä¸Šæ˜¯å¦æœ‰ä¸¤ä¸ªå¹¶æ’çš„CPUé£æ‰‡/æ•£çƒ­ç‰‡ã€‚ æ³¨æ„ï¼šä¸è¦å°† â€œåŒè·¯CPUï¼ˆ2ä¸ªç‰©ç†èŠ¯ç‰‡ï¼‰â€ ä¸ â€œåŒæ ¸CPUï¼ˆ1ä¸ªèŠ¯ç‰‡å†…æœ‰ä¸¤ä¸ªæ ¸å¿ƒï¼‰â€ æ··æ·†ã€‚åŒè·¯ç³»ç»Ÿå¤šç”¨äºæœåŠ¡å™¨æˆ–å·¥ä½œç«™ã€‚\n","description":"NUMAï¼ˆNon-Uniform Memory Accessï¼‰\nä¸€ã€NUMA æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯å…ˆç«‹ä½ï¼‰ NUMA = æ¯ä¸ª CPU æœ‰â€œè‡ªå·±æ›´è¿‘çš„å†…å­˜â€ï¼Œè®¿é—®åˆ«çš„ CPU å†…å­˜ä¼šæ›´æ…¢\nå’Œå®ƒå¯¹ç«‹çš„æ˜¯ UMAï¼ˆUniform Memory Accessï¼‰ã€‚\näºŒã€ä¸ºä»€ä¹ˆä¼šæœ‰ NUMAï¼Ÿ 1ï¸âƒ£ UMA çš„é—®é¢˜ï¼ˆè€æ¶æ„ï¼‰ CPU0 â”€â” CPU1 â”€â”¼â”€â”€ Memory CPU2 â”€â”¤ CPU3 â”€â”˜ æ‰€æœ‰ CPU å…±äº«åŒä¸€å†…å­˜æ§åˆ¶å™¨ CPU è¶Šå¤š -\u0026gt; å†…å­˜äº‰ç”¨è¶Šä¸¥é‡ æ€»çº¿æˆä¸ºç“¶é¢ˆ 2ï¸âƒ£ NUMA çš„è¯ç”Ÿï¼ˆç°ä»£æœåŠ¡å™¨ï¼‰ NUMA Node 0 NUMA Node 1 +-----------+ +-----------+ | CPU0 CPU1 | | CPU2 CPU3 | | Memory 0 | \u0026lt;â”€â”€QPIâ”€â”€\u0026gt; | Memory 1 | +-----------+ +-----------+ å†…å­˜æ§åˆ¶å™¨é›†æˆåˆ° CPU æ¯ä¸ª CPUï¼ˆSocketï¼‰ç›´æ¥è¿ä¸€éƒ¨åˆ†å†…å­˜ CPU è®¿é—®ï¼š æœ¬åœ°å†…å­˜ -\u0026gt; å¿« è¿œç¨‹å†…å­˜ -\u0026gt; æ…¢ ä¸‰ã€NUMA ä¸­â€œæ…¢â€åˆ°åº•æ…¢å¤šå°‘ï¼Ÿ å¤§è‡´æ•°é‡çº§ï¼ˆå› ç¡¬ä»¶ä¸åŒè€Œå¼‚ï¼‰ï¼š\n"},{"id":99,"href":"/operations/linux/kernel-unionfs/","title":"Linux UnionFS","parent":"Linux","content":"Linux UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰è¯¦è§£ã€‚\nå†…å®¹ï¼šæ¦‚å¿µ -\u0026gt; å†…æ ¸å®ç° -\u0026gt; ä¸»æµå®ç° -\u0026gt; è¡Œä¸ºç»†èŠ‚ -\u0026gt; ä¸å®¹å™¨çš„å…³ç³» -\u0026gt; æ€§èƒ½ä¸é™·é˜± -\u0026gt; æœ€ä½³å®è·µ\nä¸€ã€UnionFS æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ UnionFS æ˜¯ä¸€ç§â€œæŠŠå¤šä¸ªç›®å½•ï¼ˆåˆ†æ”¯ï¼‰å åŠ æˆä¸€ä¸ªç»Ÿä¸€è§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæœºåˆ¶ã€‚\nä¸Šå±‚ï¼šå¯å†™å±‚ï¼ˆupperï¼‰ ä¸‹å±‚ï¼šåªè¯»å±‚ï¼ˆlowerï¼‰ å¯¹ç”¨æˆ·å‘ˆç°ï¼šä¸€ä¸ªå®Œæ•´ç›®å½•æ ‘ ğŸ“Œ UnionFS â‰  OverlayFSï¼ˆOverlayFS æ˜¯å†…æ ¸å®ç°ä¹‹ä¸€ï¼‰\näºŒã€ä¸ºä»€ä¹ˆéœ€è¦ UnionFSï¼ˆè®¾è®¡åŠ¨æœºï¼‰ 1ï¸âƒ£ é•œåƒåˆ†å±‚ï¼ˆå®¹å™¨ï¼‰ åº”ç”¨å±‚ï¼ˆå¯å†™ï¼‰ --------- åŸºç¡€é•œåƒå±‚ï¼ˆåªè¯»ï¼‰ --------- OS å±‚ï¼ˆåªè¯»ï¼‰ èŠ‚çœç©ºé—´ å¿«é€Ÿåˆ›å»º å±‚å¤ç”¨ 2ï¸âƒ£ ç³»ç»Ÿå¿«ç…§ / Live CD Live ç³»ç»Ÿï¼šåªè¯» + å†…å­˜å†™å±‚ å›æ»š / å¿«ç…§ 3ï¸âƒ£ åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ + å¯å†™è¦†ç›– åµŒå…¥å¼ç³»ç»Ÿ å®‰å…¨ç³»ç»Ÿ ä¸‰ã€UnionFS çš„æ ¸å¿ƒæ¦‚å¿µ 1ï¸âƒ£ Branchï¼ˆåˆ†æ”¯ï¼‰ æ¯ä¸€å±‚ç›®å½•å«ä¸€ä¸ª branch\nlower branchï¼šåªè¯» upper branchï¼šå¯å†™ 2ï¸âƒ£ Whiteoutï¼ˆç™½éšœï¼‰ ç”¨äºâ€œåœ¨ä¸Šå±‚åˆ é™¤ä¸‹å±‚æ–‡ä»¶â€çš„ç‰¹æ®Šæ ‡è®°\nåˆ é™¤ â‰  çœŸåˆ é™¤ æ˜¯åˆ›å»º .wh.\u0026lt;filename\u0026gt; ğŸ“Œ è¿™æ˜¯ UnionFS çš„æ ¸å¿ƒé­”æ³•ä¹‹ä¸€\n3ï¸âƒ£ Copy-on-Writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰ å½“ä½ ï¼š\necho hello \u0026gt;\u0026gt; /bin/ls å®é™…å‘ç”Ÿçš„æ˜¯ï¼š\n/bin/ls ä» lower copy åˆ° upper åœ¨ upper ä¸­ä¿®æ”¹ lower ä¸å˜ å››ã€UnionFS çš„å†…æ ¸å®ç°æ¼”è¿› 1ï¸âƒ£ UnionFSï¼ˆæœ€æ—©ï¼‰ å¤–éƒ¨æ¨¡å— ç¨³å®šæ€§ä¸€èˆ¬ å·²åŸºæœ¬å¼ƒç”¨ 2ï¸âƒ£ AUFSï¼ˆDocker æ—©æœŸï¼‰ åŠŸèƒ½å¼ºå¤§ éä¸»çº¿å†…æ ¸ Ubuntu æ›¾é•¿æœŸä½¿ç”¨ ğŸ“Œ RHEL ç³»åˆ—ä»æœªæ”¯æŒ AUFS\n3ï¸âƒ£ OverlayFSï¼ˆä¸»çº¿å†…æ ¸ï¼‰ ç°åœ¨äº‹å®ä¸Šçš„æ ‡å‡†\nLinux å†…æ ¸åŸç”Ÿ Docker / Podman / CRI-O é»˜è®¤ RHEL / AlmaLinux / Rocky å…¨æ”¯æŒ äº”ã€OverlayFS è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ åŸºæœ¬ç»“æ„ lowerdir=/layers/base:/layers/app upperdir=/layers/write workdir=/layers/work æŒ‚è½½åï¼š\n/merged 2ï¸âƒ£ æŒ‚è½½å‘½ä»¤ç¤ºä¾‹ mount -t overlay overlay \\ -o lowerdir=lower,upperdir=upper,workdir=work \\ merged ğŸ“Œ workdir ç”¨äºåŸå­æ“ä½œï¼ˆå¿…é¡»ï¼‰\n3ï¸âƒ£ æ–‡ä»¶è®¿é—®é€»è¾‘ï¼ˆè¯»å†™æµç¨‹ï¼‰ è¯»ï¼š\nupperdir ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ lowerdir å†™ï¼š\nlower -\u0026gt; copy åˆ° upper -\u0026gt; å†™ åˆ ï¼š\nåˆ›å»º whiteout å…­ã€UnionFS çš„å…³é”®è¡Œä¸ºç»†èŠ‚ï¼ˆå¾ˆå®¹æ˜“è¸©å‘ï¼‰ 1ï¸âƒ£ inode ä¸ç¨³å®š åŒä¸€è·¯å¾„ ä¸åŒå±‚ inode ä¸åŒ ğŸ“Œ å½±å“ï¼š\nbind mount inode cache æŸäº›æ•°æ®åº“ 2ï¸âƒ£ hardlink å—é™ OverlayFS å¯¹ hardlink æ”¯æŒæœ‰é™ è·¨å±‚ hardlink åŸºæœ¬ä¸å¯ç”¨ 3ï¸âƒ£ rename æ˜¯â€œä¼ªåŸå­â€ è·¨å±‚ rename å®é™…æ˜¯ï¼š copy + delete ğŸ“Œ å¯¹ fsync æ•æ„Ÿç¨‹åºå±é™©\n4ï¸âƒ£ chmod / chown è¡Œä¸º è§¦å‘ COW æ–‡ä»¶è¢«å¤åˆ¶åˆ° upper ä¸ƒã€OverlayFS ä¸å®¹å™¨ï¼ˆæ ¸å¿ƒå…³ç³»ï¼‰ 1ï¸âƒ£ Docker overlay2 çš„æœ¬è´¨ container_rw_layer (upper) -------------------------- image layer N -------------------------- image layer N-1 -------------------------- base OS layer 2ï¸âƒ£ ä¸ºä»€ä¹ˆå®¹å™¨å¯åŠ¨å¿«ï¼Ÿ ä¸å¤åˆ¶ rootfs åª mount è”åˆè§†å›¾ 3ï¸âƒ£ ä¸ºä»€ä¹ˆå®¹å™¨ç£ç›˜ IO æŠ–ï¼Ÿ metadata æ“ä½œå¤š copy-up ä»£ä»·å¤§ fsync ç©¿é€å±‚ å…«ã€UnionFS ä¸é€‚åˆå“ªäº›åœºæ™¯ï¼Ÿ âŒ æ•°æ®åº“ï¼ˆé‡ç‚¹ï¼‰ åŸå› ï¼š\nfsync ä¸å¯æ§ rename ä¸å®‰å…¨ inode ä¸ç¨³å®š ç™½éšœæ–‡ä»¶è†¨èƒ€ ğŸ“Œ è¿™å°±æ˜¯ â€œæ•°æ®åº“ä¸ºä»€ä¹ˆä¸é€‚åˆè·‘åœ¨å®¹å™¨â€ çš„åº•å±‚åŸå› ä¹‹ä¸€\nâŒ é«˜ IO å°æ–‡ä»¶åœºæ™¯ Git ç¼–è¯‘ç¼“å­˜ npm / pip ä¹ã€æ€§èƒ½å…³é”®ç‚¹ï¼ˆOverlayFSï¼‰ 1ï¸âƒ£ Metadata å¼€é”€é«˜ stat readdir lookup 2ï¸âƒ£ Copy-up æˆæœ¬ä¸å¯å¿½è§† ç¬¬ä¸€æ¬¡å†™ = å…¨æ–‡ä»¶å¤åˆ¶ å¤§æ–‡ä»¶å°¤å…¶æ˜æ˜¾ 3ï¸âƒ£ fsync è¡Œä¸ºå¤æ‚ upper + lower ç»„åˆ å­˜å‚¨æ ˆä¸é€æ˜ åã€UnionFS çš„æœ€ä½³å®è·µ âœ… å®¹å™¨ rootfsï¼šoverlay2 æ•°æ®ç›®å½•ï¼šbind mount / volume -v /data/mysql:/var/lib/mysql âœ… ç³»ç»Ÿè®¾è®¡ åªè¯» OS + overlay æ—¥å¿— / æ•°æ®å•ç‹¬ç›˜ âŒ ç¦æ­¢äº‹é¡¹ âŒ overlay2 å­˜æ•°æ®åº“æ•°æ® âŒ overlay2 è·‘æ¶ˆæ¯é˜Ÿåˆ— âŒ overlay2 åšæ€§èƒ½ benchmark åä¸€ã€OverlayFS vs å…¶ä»–æ–¹æ¡ˆ ç‰¹æ€§ OverlayFS bind mount tmpfs åˆ†å±‚ âœ… âŒ âŒ å¯å†™ âœ… âœ… âœ… æ€§èƒ½ ä¸­ é«˜ é«˜ æ•°æ®å®‰å…¨ ä½ é«˜ ä½ é€‚åˆæ•°æ®åº“ âŒ âœ… âŒ åäºŒã€æ€»ç»“ï¼ˆè®°ä½ï¼‰ UnionFS æ˜¯ â€œè§†å›¾æ–‡ä»¶ç³»ç»Ÿâ€ï¼Œä¸æ˜¯ â€œæ•°æ®æ–‡ä»¶ç³»ç»Ÿâ€ã€‚\nå®ƒçš„ä½¿å‘½æ˜¯ï¼š\né•œåƒ åˆ†å±‚ å¤ç”¨ ä¸æ˜¯ï¼š\né«˜ä¸€è‡´æ€§ é«˜ fsync å¯é æ€§ æ•°æ®æŒä¹…åŒ– ","description":"Linux UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰è¯¦è§£ã€‚\nå†…å®¹ï¼šæ¦‚å¿µ -\u0026gt; å†…æ ¸å®ç° -\u0026gt; ä¸»æµå®ç° -\u0026gt; è¡Œä¸ºç»†èŠ‚ -\u0026gt; ä¸å®¹å™¨çš„å…³ç³» -\u0026gt; æ€§èƒ½ä¸é™·é˜± -\u0026gt; æœ€ä½³å®è·µ\nä¸€ã€UnionFS æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ UnionFS æ˜¯ä¸€ç§â€œæŠŠå¤šä¸ªç›®å½•ï¼ˆåˆ†æ”¯ï¼‰å åŠ æˆä¸€ä¸ªç»Ÿä¸€è§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæœºåˆ¶ã€‚\nä¸Šå±‚ï¼šå¯å†™å±‚ï¼ˆupperï¼‰ ä¸‹å±‚ï¼šåªè¯»å±‚ï¼ˆlowerï¼‰ å¯¹ç”¨æˆ·å‘ˆç°ï¼šä¸€ä¸ªå®Œæ•´ç›®å½•æ ‘ ğŸ“Œ UnionFS â‰  OverlayFSï¼ˆOverlayFS æ˜¯å†…æ ¸å®ç°ä¹‹ä¸€ï¼‰\näºŒã€ä¸ºä»€ä¹ˆéœ€è¦ UnionFSï¼ˆè®¾è®¡åŠ¨æœºï¼‰ 1ï¸âƒ£ é•œåƒåˆ†å±‚ï¼ˆå®¹å™¨ï¼‰ åº”ç”¨å±‚ï¼ˆå¯å†™ï¼‰ --------- åŸºç¡€é•œåƒå±‚ï¼ˆåªè¯»ï¼‰ --------- OS å±‚ï¼ˆåªè¯»ï¼‰ èŠ‚çœç©ºé—´ å¿«é€Ÿåˆ›å»º å±‚å¤ç”¨ 2ï¸âƒ£ ç³»ç»Ÿå¿«ç…§ / Live CD Live ç³»ç»Ÿï¼šåªè¯» + å†…å­˜å†™å±‚ å›æ»š / å¿«ç…§ 3ï¸âƒ£ åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ + å¯å†™è¦†ç›– åµŒå…¥å¼ç³»ç»Ÿ å®‰å…¨ç³»ç»Ÿ ä¸‰ã€UnionFS çš„æ ¸å¿ƒæ¦‚å¿µ 1ï¸âƒ£ Branchï¼ˆåˆ†æ”¯ï¼‰ æ¯ä¸€å±‚ç›®å½•å«ä¸€ä¸ª branch\n"},{"id":100,"href":"/database/postgres/pgbackrest-pg_checksums/","title":"pgBackRest + pg_checksums çš„å®Œæ•´å®¹ç¾é“¾è·¯","parent":"PostgreSQL","content":" é€‚ç”¨ç‰ˆæœ¬ï¼šPostgreSQL 17 / 18\nç›®æ ‡ï¼šé˜²æ•°æ®æŸå + å¯éªŒè¯ + å¯å›æ»š + å¯æ¢å¤åˆ°ä»»æ„æ—¶é—´ç‚¹ï¼ˆPITRï¼‰\nä¸€ã€ä¸ºä»€ä¹ˆ pg_checksums + pgBackRest è¦ä¸€èµ·ç”¨ï¼Ÿ ä¸€å¥è¯æ€»ç»“ï¼š\npg_checksums è´Ÿè´£â€œå‘ç°æ•°æ®åäº†â€\npgBackRest è´Ÿè´£â€œæŠŠæ­£ç¡®æ•°æ®æ‰¾å›æ¥â€\nå•ç‹¬ä½¿ç”¨ä»»ä½•ä¸€ä¸ªï¼Œå®¹ç¾éƒ½æ˜¯ä¸å®Œæ•´çš„ã€‚\nèƒ½è§£å†³ä»€ä¹ˆç¾éš¾ï¼Ÿ ç¾éš¾ç±»å‹ pg_checksums pgBackRest ç£ç›˜ silent corruption âœ… å‘ç° âœ… æ¢å¤ RAID / SSD ä½ç¿»è½¬ âœ… âœ… æ–‡ä»¶ç³»ç»Ÿ bug âœ… âœ… äººä¸ºè¯¯åˆ æ•°æ® âŒ âœ… è¯¯ UPDATE / DELETE âŒ âœ…ï¼ˆPITRï¼‰ WAL ä¸¢å¤± âŒ âœ… ä¸»æœºå®•æœº âŒ âœ… ğŸ‘‰ ä¸¤è€…ç»„åˆ = PostgreSQL å®˜æ–¹æœ€å¼ºæ•°æ®å®‰å…¨æ–¹æ¡ˆ\näºŒã€æ•´ä½“å®¹ç¾æ¶æ„å›¾ï¼ˆé€»è¾‘ï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ PostgreSQL â”‚ â”‚ Data Dir â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ pg_checksums â”‚ æ ¡éªŒæ•°æ®é¡µä¸€è‡´æ€§ â”‚ â–¼ WAL å½’æ¡£ï¼ˆarchive-pushï¼‰ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ pgBackRest â”‚ â”‚ Repository â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Full / Diff / Incr â”‚ â–¼ ä»»æ„æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ ä¸‰ã€é˜¶æ®µä¸€ï¼šå¯ç”¨ pg_checksumsï¼ˆé˜² silent corruptionï¼‰ 1ï¸âƒ£ æ£€æŸ¥å½“å‰æ˜¯å¦å¯ç”¨ pg_checksums --show --data-directory=/var/lib/postgresql è¾“å‡ºç¤ºä¾‹ï¼š\nChecksums are enabled in cluster æˆ–ï¼š\nChecksums are disabled in cluster 2ï¸âƒ£ æœªå¯ç”¨æ—¶ï¼Œå¦‚ä½•å¯ç”¨ï¼ˆå¿…é¡»åœåº“ï¼‰ âš ï¸ è¿™æ˜¯å”¯ä¸€ä¸€æ¬¡ç ´åæ€§æ“ä½œï¼Œå¿…é¡»åœ PostgreSQL\nsystemctl stop postgresql pg_checksums --enable --data-directory=/var/lib/postgresql systemctl start postgresql 3ï¸âƒ£ å¯ç”¨åçš„æ„ä¹‰ æ¯ä¸ª 8KB æ•°æ®é¡µéƒ½æœ‰æ ¡éªŒå€¼ PostgreSQL è¯»å–æ•°æ®å‰è‡ªåŠ¨æ ¡éªŒ ä¸€æ—¦å‘ç°æŸå -\u0026gt; ç›´æ¥ ERRORï¼Œé¿å…è„æ•°æ®æ‰©æ•£ å››ã€é˜¶æ®µäºŒï¼špgBackRest æ„å»ºâ€œå¯æ¢å¤æ—¶é—´è½´â€ 1ï¸âƒ£ åˆ›å»º stanzaï¼ˆä¸€æ¬¡æ€§ï¼‰ pgbackrest --stanza=main stanza-create è¿™ä¸€æ­¥ä¼šç”Ÿæˆï¼š\nrepo/archive/main/archive.info repo/backup/main/backup.info ğŸ“Œ è¿™æ˜¯ pgBackRest çš„â€œå…ƒæ•°æ®æ ¹åŸºâ€\n2ï¸âƒ£ PostgreSQL WAL å½’æ¡£é…ç½®ï¼ˆå¿…é€‰ï¼‰ archive_mode = on wal_level = replica archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; 3ï¸âƒ£ éªŒè¯ WAL æ˜¯å¦æ­£å¸¸å½’æ¡£ SELECT pg_switch_wal(); ls /var/lib/pgbackrest/archive/main/ 4ï¸âƒ£ æ‰§è¡Œå®Œæ•´å¤‡ä»½ç­–ç•¥ï¼ˆæ¨èï¼‰ ## æ¯å‘¨ä¸€æ¬¡ pgbackrest --stanza=main backup --type=full ## æ¯å¤© pgbackrest --stanza=main backup --type=diff ## æ¯å°æ—¶ pgbackrest --stanza=main backup --type=incr äº”ã€é˜¶æ®µä¸‰ï¼šç¾éš¾å‘ç° -\u0026gt; ç²¾å‡†å®šä½ åœºæ™¯ 1ï¼špg_checksums æŠ¥é”™ï¼ˆæœ€å±é™©ï¼‰ ERROR: invalid page in block 123 of relation base/... è¯´æ˜ï¼š\næ•°æ®é¡µå·²ç»æŸå VACUUM / SELECT è§¦å‘äº†æ ¡éªŒå¤±è´¥ æ­¤æ—¶ï¼š\nâŒ ä¸è¦ç»§ç»­å†™æ•°æ®\nâŒ ä¸è¦ç›²ç›®é‡å¯\nåœºæ™¯ 2ï¼šæ‰‹åŠ¨å…¨åº“æ ¡éªŒï¼ˆå†·æ ¡éªŒï¼‰ pg_checksums --check --data-directory=/var/lib/postgresql å¯ä»¥ç²¾ç¡®å®šä½ï¼š\nå“ªä¸ª relation å“ªä¸ª block æ˜¯å¦å¯æ¢å¤ å…­ã€é˜¶æ®µå››ï¼šå®¹ç¾æ¢å¤ï¼ˆæ ¸å¿ƒï¼‰ æ¢å¤ç­–ç•¥ä¸€ï¼šæ•´åº“æ¢å¤ï¼ˆæœ€å®‰å…¨ï¼‰ 1ï¸âƒ£ åœåº“ systemctl stop postgresql 2ï¸âƒ£ æ¸…ç©ºæ•°æ®ç›®å½• rm -rf /var/lib/postgresql/* 3ï¸âƒ£ pgBackRest æ¢å¤ï¼ˆå«æ ¡éªŒï¼‰ pgbackrest --stanza=main restore é»˜è®¤è¡Œä¸ºï¼š\nè‡ªåŠ¨æ¢å¤æœ€è¿‘ä¸€æ¬¡ ä¸€è‡´æ€§å¤‡ä»½ è‡ªåŠ¨å›æ”¾ WAL æ ¡éªŒ checksum + timeline 4ï¸âƒ£ å¯åŠ¨æ•°æ®åº“ systemctl start postgresql æ¢å¤ç­–ç•¥äºŒï¼šPITRï¼ˆè¯¯æ“ä½œä¸“ç”¨ï¼‰ ä¾‹å¦‚ï¼š\nè¯¯åˆ æ•°æ®å‘ç”Ÿåœ¨ 2025-12-27 09:15:00\npgbackrest \\ --stanza=main restore \\ --type=time \\ --target=\u0026#34;2025-12-27 09:14:59\u0026#34; ä¸ƒã€pg_checksums åœ¨æ¢å¤ä¸­çš„ä½œç”¨ é˜¶æ®µ ä½œç”¨ å¤‡ä»½å‰ ç¡®ä¿å¤‡ä»½æ•°æ®æ˜¯â€œå¹²å‡€çš„â€ å¤‡ä»½æ—¶ pgBackRest ä¼šè·³è¿‡æŸåé¡µå¹¶æŠ¥é”™ æ¢å¤æ—¶ è‡ªåŠ¨æ ¡éªŒé¡µä¸€è‡´æ€§ æ¢å¤å é˜²æ­¢â€œæ¢å¤åæ‰å‘ç°åæ•°æ®â€ ğŸ‘‰ æ²¡æœ‰ pg_checksumsï¼Œåæ•°æ®å¯èƒ½è¢«â€œåˆæ³•å¤‡ä»½â€\nå…«ã€ç”Ÿäº§çº§æœ€ä½³å®è·µæ¸…å•ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ âœ… å¼ºåˆ¶å¼€å¯ archive_mode = on full_page_writes = on wal_log_hints = on âœ… pgBackRest æ¨èå‚æ•° [global] repo1-retention-full=2 repo1-retention-diff=7 start-fast=y delta=y checksum-page=y âœ… å®šæœŸæ ¡éªŒï¼ˆcronï¼‰ pgbackrest --stanza=main check pg_checksums --check --data-directory=/var/lib/postgresql ä¹ã€æœ€ç»ˆä¸€å¥è¯æ€»ç»“ï¼ˆç‰¢è®°ï¼‰ pg_checksums è®© PostgreSQLâ€œæ•¢æŠ¥é”™â€\npgBackRest è®© PostgreSQLâ€œæŠ¥é”™åè¿˜èƒ½æ´»â€\n","description":" é€‚ç”¨ç‰ˆæœ¬ï¼šPostgreSQL 17 / 18\nç›®æ ‡ï¼šé˜²æ•°æ®æŸå + å¯éªŒè¯ + å¯å›æ»š + å¯æ¢å¤åˆ°ä»»æ„æ—¶é—´ç‚¹ï¼ˆPITRï¼‰\nä¸€ã€ä¸ºä»€ä¹ˆ pg_checksums + pgBackRest è¦ä¸€èµ·ç”¨ï¼Ÿ ä¸€å¥è¯æ€»ç»“ï¼š\npg_checksums è´Ÿè´£â€œå‘ç°æ•°æ®åäº†â€\npgBackRest è´Ÿè´£â€œæŠŠæ­£ç¡®æ•°æ®æ‰¾å›æ¥â€\nå•ç‹¬ä½¿ç”¨ä»»ä½•ä¸€ä¸ªï¼Œå®¹ç¾éƒ½æ˜¯ä¸å®Œæ•´çš„ã€‚\nèƒ½è§£å†³ä»€ä¹ˆç¾éš¾ï¼Ÿ ç¾éš¾ç±»å‹ pg_checksums pgBackRest ç£ç›˜ silent corruption âœ… å‘ç° âœ… æ¢å¤ RAID / SSD ä½ç¿»è½¬ âœ… âœ… æ–‡ä»¶ç³»ç»Ÿ bug âœ… âœ… äººä¸ºè¯¯åˆ æ•°æ® âŒ âœ… è¯¯ UPDATE / DELETE âŒ âœ…ï¼ˆPITRï¼‰ WAL ä¸¢å¤± âŒ âœ… ä¸»æœºå®•æœº âŒ âœ… ğŸ‘‰ ä¸¤è€…ç»„åˆ = PostgreSQL å®˜æ–¹æœ€å¼ºæ•°æ®å®‰å…¨æ–¹æ¡ˆ\n"},{"id":101,"href":"/database/postgres/pgbackrest-diff-vs-incr/","title":"pgBackRest å·®é‡å¤‡ä»½ å’Œ å¢é‡å¤‡ä»½ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","parent":"PostgreSQL","content":" æ€»ç»“ï¼ˆæœ€ç®€å•ç‰ˆï¼‰ å·®é‡å¤‡ä»½ï¼ˆdiffï¼‰ï¼šåŸºäº æœ€è¿‘çš„ä¸€æ¬¡ full å¤‡ä»½ åšå˜åŒ–å¯¹æ¯” å¢é‡å¤‡ä»½ï¼ˆincrï¼‰ï¼šåŸºäº æœ€è¿‘çš„ä¸€æ¬¡ backupï¼ˆfull/diff/incr éƒ½ç®—ï¼‰ åšå˜åŒ–å¯¹æ¯” å›¾ç¤ºç†è§£ï¼ˆæœ€ç›´è§‚ï¼‰ å‡è®¾åšäº†ä¸€ä¸ªå…¨é‡å¤‡ä»½ï¼š\nF1ï¼ˆFullï¼‰ ğŸ“Œ å·®é‡å¤‡ä»½ï¼ˆDiffï¼‰\nF1 ---- D1 (Diffï¼Œç›¸å¯¹äº F1) ---- D2 (Diffï¼Œç›¸å¯¹äº F1) ---- D3 (Diffï¼Œç›¸å¯¹äº F1) æ¯æ¬¡å·®é‡å¤‡ä»½éƒ½è¦å’Œ æœ€è¿‘ä¸€æ¬¡ full æ¯”è¾ƒï¼Œæ‰€ä»¥ diff ä¼šä¸æ–­å˜å¤§ã€‚\nğŸ“Œ å¢é‡å¤‡ä»½ï¼ˆIncrï¼‰\nF1 ---- I1 (Incremental ç›¸å¯¹äº F1) ---- I2 (Incremental ç›¸å¯¹äº I1) ---- I3 (Incremental ç›¸å¯¹äº I2) æ¯ä¸€æ¬¡ incr éƒ½æ˜¯ç›¸å¯¹äº å‰ä¸€æ¬¡å¤‡ä»½ï¼Œç©ºé—´æœ€å°ã€‚\nå®é™…åŒºåˆ«ï¼ˆç”Ÿäº§è§’åº¦ï¼‰ ç‰¹æ€§ diffï¼ˆå·®é‡ï¼‰ incrï¼ˆå¢é‡ï¼‰ å¯¹æ¯”åŸºå‡† æœ€è¿‘ full æœ€è¿‘ä»»ä½•å¤‡ä»½ å‘¨æœŸå†…å¤§å° è¶Šæ¥è¶Šå¤§ é€šå¸¸å¾ˆå° æ¢å¤é“¾é•¿åº¦ Full + 1 ä¸ª diff Full + å¤šä¸ª incr æ¢å¤é€Ÿåº¦ æ›´å¿«ï¼ˆé“¾çŸ­ï¼‰ æ›´æ…¢ï¼ˆé“¾é•¿ï¼‰ å­˜å‚¨ç©ºé—´ æ›´å¤š æ›´å°‘ é€‚ç”¨åœºæ™¯ æ¢å¤ä¼˜å…ˆ ç©ºé—´ä¼˜å…ˆ ç”Ÿäº§å»ºè®®ï¼ˆæœ€å¸¸ç”¨ç­–ç•¥ï¼‰ ğŸ“Œ æ¨èå¤‡ä»½ç­–ç•¥\næœ€å¸¸è§çš„ä¼ä¸šç”Ÿäº§ç­–ç•¥æ˜¯ï¼š\næ¯å¤© 1 æ¬¡ full æ¯ 6 å°æ—¶ 1 æ¬¡ diff æ¯å°æ—¶ 1 æ¬¡ incr åŸå› ï¼š\ndiff è®©æ¢å¤ä¸ä¼šå¤ªæ…¢ï¼ˆé“¾çŸ­ï¼‰ incr è®©æ—¥å¸¸å¤‡ä»½æ•°æ®é‡æœ€å° full è®©æ•´ä¸ªé“¾ä¸ä¼šæ— é™é•¿ è¿™ä¹Ÿæ˜¯ pgBackRest å®˜æ–¹æ¨èæ–¹æ¡ˆã€‚\nä¸ºä½•éœ€è¦ diff + incr æ··åˆä½¿ç”¨ï¼Ÿ diff ä½¿æ¢å¤ç®€å• æ¢å¤åªéœ€è¦ï¼š\nFull + Diff + WAL incr èŠ‚çœå¤§é‡å­˜å‚¨ç©ºé—´ æ¯å¤©å‡ åæ¬¡ incrï¼Œä½†æ¯æ¬¡å¾ˆå°ã€‚\nä¸¤è€…ç»“åˆï¼Œå…¼é¡¾ï¼š\næ¢å¤é€Ÿåº¦å¿« ç©ºé—´å ç”¨å° æ¢å¤æ—¶åˆ°åº•ä¼šç”¨å“ªå‡ ä¸ªå¤‡ä»½ï¼Ÿ ä¸¾ä¾‹ï¼š\nF1 -\u0026gt; D1 -\u0026gt; I1 -\u0026gt; I2 -\u0026gt; I3 å¦‚æœä½ æ¢å¤ I3ï¼š\npgBackRest ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼š\nF1 + D1 + I1 + I2 + I3 + WAL æ¢å¤é“¾æ¡è¶Šé•¿ï¼Œæ¢å¤è¶Šæ…¢ã€‚\nç»“è®ºï¼ˆä¾¿äºè®°å¿†ï¼‰ å·®é‡å¤‡ä»½ Diffï¼šæ°¸è¿œåŸºäº Fullï¼Œå¤‡ä»½å†…å®¹è¶Šæ¥è¶Šå¤šï¼›æ¢å¤æ—¶é“¾çŸ­ã€‚\nå¢é‡å¤‡ä»½ Incrï¼šæ°¸è¿œåŸºäºä¸Šä¸€æ¬¡å¤‡ä»½ï¼Œå†…å®¹æœ€å°ï¼›æ¢å¤æ—¶é“¾é•¿ã€‚\n","description":" æ€»ç»“ï¼ˆæœ€ç®€å•ç‰ˆï¼‰ å·®é‡å¤‡ä»½ï¼ˆdiffï¼‰ï¼šåŸºäº æœ€è¿‘çš„ä¸€æ¬¡ full å¤‡ä»½ åšå˜åŒ–å¯¹æ¯” å¢é‡å¤‡ä»½ï¼ˆincrï¼‰ï¼šåŸºäº æœ€è¿‘çš„ä¸€æ¬¡ backupï¼ˆfull/diff/incr éƒ½ç®—ï¼‰ åšå˜åŒ–å¯¹æ¯” å›¾ç¤ºç†è§£ï¼ˆæœ€ç›´è§‚ï¼‰ å‡è®¾åšäº†ä¸€ä¸ªå…¨é‡å¤‡ä»½ï¼š\nF1ï¼ˆFullï¼‰ ğŸ“Œ å·®é‡å¤‡ä»½ï¼ˆDiffï¼‰\nF1 ---- D1 (Diffï¼Œç›¸å¯¹äº F1) ---- D2 (Diffï¼Œç›¸å¯¹äº F1) ---- D3 (Diffï¼Œç›¸å¯¹äº F1) æ¯æ¬¡å·®é‡å¤‡ä»½éƒ½è¦å’Œ æœ€è¿‘ä¸€æ¬¡ full æ¯”è¾ƒï¼Œæ‰€ä»¥ diff ä¼šä¸æ–­å˜å¤§ã€‚\nğŸ“Œ å¢é‡å¤‡ä»½ï¼ˆIncrï¼‰\nF1 ---- I1 (Incremental ç›¸å¯¹äº F1) ---- I2 (Incremental ç›¸å¯¹äº I1) ---- I3 (Incremental ç›¸å¯¹äº I2) æ¯ä¸€æ¬¡ incr éƒ½æ˜¯ç›¸å¯¹äº å‰ä¸€æ¬¡å¤‡ä»½ï¼Œç©ºé—´æœ€å°ã€‚\n"},{"id":102,"href":"/backend/python/official/python-advanced/","title":"Python é«˜çº§ç”¨æ³•","parent":"Official","content":" ğŸ”¥ Python é«˜çº§ç”¨æ³•å¤§å…¨ï¼ˆæœ€å¼ºç‰ˆï¼‰ ä»¥ä¸‹æŠŠ Python é«˜çº§ç”¨æ³•åˆ†æˆ 12 å¤§ç±»ï¼Œè¦†ç›–ä½ å¯èƒ½é‡åˆ°çš„ç»å¤§éƒ¨åˆ†é«˜çº§éœ€æ±‚ã€‚\n1. è¿­ä»£å™¨ / ç”Ÿæˆå™¨ / æƒ°æ€§è®¡ç®—ï¼ˆæ ¸å¿ƒï¼‰ è‡ªå®šä¹‰è¿­ä»£å™¨ class Counter: def __init__(self, n): self.i = 0 self.n = n def __iter__(self): return self def __next__(self): if self.i \u0026lt; self.n: self.i += 1 return self.i raise StopIteration ç”Ÿæˆå™¨ï¼ˆyieldï¼‰ def gen(): for i in range(10): yield i yield fromï¼ˆå§”æ‰˜å¦ä¸€ä¸ªè¿­ä»£å™¨ï¼‰ def wrapper(): yield from range(5) 2. è£…é¥°å™¨ï¼ˆDecoratorï¼‰ åŸºæœ¬è£…é¥°å™¨ def log(fn): def wrapper(*a, **kw): print(f\u0026#34;call: {fn.__name__}\u0026#34;) return fn(*a, **kw) return wrapper å¸¦å‚æ•°è£…é¥°å™¨ def prefix(p): def deco(fn): def wrapper(*a, **kw): print(p) return fn(*a, **kw) return wrapper return deco ç±»è£…é¥°å™¨ class Deco: def __init__(self, fn): self.fn = fn def __call__(self, *a, **kw): return self.fn(*a, **kw) 3. ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆcontext managerï¼‰ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ class Timer: def __enter__(self): self.start = time.time() def __exit__(self, *exc): print(time.time() - self.start) contextlib.suppress from contextlib import suppress with suppress(KeyError): {}[\u0026#34;x\u0026#34;] contextmanager è£…é¥°å™¨ from contextlib import contextmanager @contextmanager def open_file(path): f = open(path) try: yield f finally: f.close() 4. é—­åŒ…ï¼ˆClosureï¼‰ def make_adder(x): def adder(y): return x + y return adder 5. é«˜é˜¶å‡½æ•°ï¼ˆHigher-order Functionsï¼‰ ä½¿ç”¨å‡½æ•°ä½œä¸ºå‚æ•°ï¼š\nmap filter reduce è‡ªå®šä¹‰å›è°ƒ def apply(fn, x): return fn(x) 6. å…ƒç±»ï¼ˆMetaclassï¼‰ é«˜çº§æ¡†æ¶å¸¸ç”¨ï¼ˆORM, FastAPI, DRFï¼‰ï¼š\nclass Meta(type): def __new__(cls, name, bases, attrs): attrs[\u0026#34;tag\u0026#34;] = \u0026#34;from metaclass\u0026#34; return super().__new__(cls, name, bases, attrs) 7. æè¿°ç¬¦ï¼ˆDescriptorï¼‰ å±æ€§æ‹¦æˆªï¼š\nclass Field: def __get__(self, inst, owner): return inst.__dict__[\u0026#34;value\u0026#34;] def __set__(self, inst, val): inst.__dict__[\u0026#34;value\u0026#34;] = val class Model: value = Field() ORM åº•å±‚æ ¸å¿ƒï¼šå¦‚ SQLAlchemy.\n8. åç¨‹ / asyncioï¼ˆå¼‚æ­¥ç¼–ç¨‹ï¼‰ async/await async def worker(): await asyncio.sleep(1) return 42 å¹¶å‘æ‰§è¡Œ await asyncio.gather(func1(), func2()) 9. ç±»å‹æ³¨è§£ï¼ˆtypingï¼‰ä¸ Pydantic æ³›å‹ç±»å‹ from typing import List, Dict, Optional, Callable TypedDict class User(TypedDict): name: str age: int 10. å†…ç½®é­”æœ¯æ–¹æ³•ï¼ˆdunder methodsï¼‰ è‡ªå®šä¹‰è¡Œä¸º class A: def __len__(self): ... def __repr__(self): ... def __getitem__(self, item): ... def __eq__(self, other): ... å®ç°åˆ‡ç‰‡ def __getitem__(self, key): if isinstance(key, slice): ... 11. å‡½æ•°å¼æŠ€å·§ï¼šlambdaã€partialã€æŸ¯é‡ŒåŒ– lambda func = lambda x: x * 2 partial from functools import partial add2 = partial(add, 2) 12. å†…ç½®é«˜çº§æ•°æ®ç»“æ„ collections deque defaultdict Counter namedtuple heapqï¼ˆæœ€å°å †ï¼‰ import heapq functools.lru_cacheï¼ˆç¼“å­˜ï¼‰ @lru_cache def fib(n): ... ğŸ¯ é¢å¤–åŠ åˆ†ï¼šPython ä¸­çœŸæ­£é«˜çº§çš„ä¸»é¢˜ ä»¥ä¸‹æ˜¯é«˜çº§å¼€å‘è€…å¿…é¡»æŒæ¡çš„ï¼š\nGILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰ å¤šçº¿ç¨‹ vs å¤šè¿›ç¨‹ asyncio äº‹ä»¶å¾ªç¯ å†…å­˜ç®¡ç†ã€å¼•ç”¨è®¡æ•° åƒåœ¾å›æ”¶ GC CPython æ‰§è¡Œæ¨¡å‹ with / context manager åº•å±‚åŸç† è£…é¥°å™¨åº•å±‚ï¼šå‡½æ•°å¯¹è±¡ã€é—­åŒ… å…ƒç±»ä¸ç±»åˆ›å»ºæµç¨‹ descriptor + metaclass = ORM çš„åº•å±‚åŸç† æŒç»­ä¼˜åŒ–ï¼šPEP8ã€typingã€myPyã€blackã€ruffã€pytest ","description":" ğŸ”¥ Python é«˜çº§ç”¨æ³•å¤§å…¨ï¼ˆæœ€å¼ºç‰ˆï¼‰ ä»¥ä¸‹æŠŠ Python é«˜çº§ç”¨æ³•åˆ†æˆ 12 å¤§ç±»ï¼Œè¦†ç›–ä½ å¯èƒ½é‡åˆ°çš„ç»å¤§éƒ¨åˆ†é«˜çº§éœ€æ±‚ã€‚\n1. è¿­ä»£å™¨ / ç”Ÿæˆå™¨ / æƒ°æ€§è®¡ç®—ï¼ˆæ ¸å¿ƒï¼‰ è‡ªå®šä¹‰è¿­ä»£å™¨ class Counter: def __init__(self, n): self.i = 0 self.n = n def __iter__(self): return self def __next__(self): if self.i \u0026lt; self.n: self.i += 1 return self.i raise StopIteration ç”Ÿæˆå™¨ï¼ˆyieldï¼‰ def gen(): for i in range(10): yield i yield fromï¼ˆå§”æ‰˜å¦ä¸€ä¸ªè¿­ä»£å™¨ï¼‰ def wrapper(): yield from range(5) 2. è£…é¥°å™¨ï¼ˆDecoratorï¼‰ åŸºæœ¬è£…é¥°å™¨ def log(fn): def wrapper(*a, **kw): print(f\u0026#34;call: {fn.__name__}\u0026#34;) return fn(*a, **kw) return wrapper å¸¦å‚æ•°è£…é¥°å™¨ def prefix(p): def deco(fn): def wrapper(*a, **kw): print(p) return fn(*a, **kw) return wrapper return deco ç±»è£…é¥°å™¨ class Deco: def __init__(self, fn): self.fn = fn def __call__(self, *a, **kw): return self.fn(*a, **kw) 3. ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆcontext managerï¼‰ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ class Timer: def __enter__(self): self.start = time.time() def __exit__(self, *exc): print(time.time() - self.start) contextlib.suppress from contextlib import suppress with suppress(KeyError): {}[\u0026#34;x\u0026#34;] contextmanager è£…é¥°å™¨ from contextlib import contextmanager @contextmanager def open_file(path): f = open(path) try: yield f finally: f.close() 4. é—­åŒ…ï¼ˆClosureï¼‰ def make_adder(x): def adder(y): return x + y return adder 5. é«˜é˜¶å‡½æ•°ï¼ˆHigher-order Functionsï¼‰ ä½¿ç”¨å‡½æ•°ä½œä¸ºå‚æ•°ï¼š\n"},{"id":103,"href":"/operations/kubernetes/core-command/","title":"Kubernetes æ ¸å¿ƒå‘½ä»¤","parent":"Kubernetes","content":" ğŸ”¥ ä¸€ã€é›†ç¾¤çº§æ“ä½œï¼ˆClusterï¼‰ æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯\nkubectl cluster-info kubectl version kubectl api-resources kubectl api-versions æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡\nkubectl config get-contexts kubectl config current-context åˆ‡æ¢ä¸Šä¸‹æ–‡\nkubectl config use-context \u0026lt;context\u0026gt; ğŸ”¥ äºŒã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´\nkubectl get ns åˆ›å»º / åˆ é™¤\nkubectl create ns dev kubectl delete ns dev é€‰æ‹© Namespace\nkubectl -n dev get pods ğŸ”¥ ä¸‰ã€Pod æ ¸å¿ƒå‘½ä»¤ æŸ¥çœ‹ Pod\nkubectl get pods kubectl get pods -A kubectl get pods -owide kubectl get pods -A --field-selector=status.phase!=Running kubectl get pods -l app=nginx æŸ¥çœ‹ Pod è¯¦ç»†ä¿¡æ¯\nkubectl describe pod \u0026lt;pod\u0026gt; kubectl logs \u0026lt;pod\u0026gt; kubectl logs -f \u0026lt;pod\u0026gt; -c \u0026lt;container\u0026gt; è¿›å…¥ Pod å®¹å™¨\nkubectl exec -it \u0026lt;pod\u0026gt; -- sh kubectl exec -it \u0026lt;pod\u0026gt; -c \u0026lt;container\u0026gt; -- bash åœ¨æŒ‡å®š Namespace\nkubectl -n dev exec -it \u0026lt;pod\u0026gt; -- sh ä» Pod æ‹·è´æ–‡ä»¶\nkubectl cp \u0026lt;ns\u0026gt;/\u0026lt;pod\u0026gt;:\u0026lt;path\u0026gt; \u0026lt;local\u0026gt; kubectl cp ./local-file dev/my-pod:/tmp/file ğŸ”¥ å››ã€Deployment æ ¸å¿ƒå‘½ä»¤ æŸ¥çœ‹ Deployment\nkubectl get deploy kubectl describe deploy \u0026lt;name\u0026gt; æ›´æ–°é•œåƒ\nkubectl set image deployment/nginx nginx=nginx:1.25 å¦‚æœæœ‰å¤šä¸ª containerï¼š\nkubectl set image deploy/myapp c1=img1:v1 c2=img2:v2 å‘å¸ƒ / å›æ»š\nkubectl rollout restart deploy/nginx kubectl rollout status deploy/nginx kubectl rollout history deploy/nginx kubectl rollout undo deploy/nginx --to-revision=3 ğŸ”¥ äº”ã€Service æ ¸å¿ƒå‘½ä»¤ æŸ¥çœ‹ Service\nkubectl get svc kubectl describe svc nginx ä¸´æ—¶è®¿é—®ï¼ˆç«¯å£è½¬å‘ï¼‰\nkubectl port-forward svc/my-svc 8080:80 # å…³é—­ï¼šCtrl+C ğŸ”¥ å…­ã€ConfigMap / Secret ConfigMap\nkubectl create configmap conf --from-file=./config.yaml kubectl get cm kubectl describe cm conf kubectl delete cm conf Secretï¼ˆBase64 è‡ªåŠ¨ç¼–ç ï¼‰\nkubectl create secret generic db-pass --from-literal=password=123456 kubectl get secret kubectl describe secret db-pass ğŸ”¥ ä¸ƒã€Node èŠ‚ç‚¹æ“ä½œå‘½ä»¤ æŸ¥çœ‹èŠ‚ç‚¹\nkubectl get nodes -owide æŸ¥çœ‹å¸¦ç‰¹å®š label çš„èŠ‚ç‚¹\nkubectl get nodes -l node-role.kubernetes.io/mysql=\u0026#39;\u0026#39; ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾\nkubectl label node node01 node-role.kubernetes.io/mysql= æ¸…ç©ºèŠ‚ç‚¹ï¼ˆæ’ç©ºï¼‰\nkubectl drain node01 --ignore-daemonsets --delete-emptydir-data å–æ¶ˆæ’ç©º\nkubectl uncordon node01 ğŸ”¥ å…«ã€äº‹ä»¶ä¸æ’é”™å¸¸ç”¨å‘½ä»¤ æŸ¥çœ‹äº‹ä»¶\nkubectl get events --sort-by=.metadata.creationTimestamp æŸ¥çœ‹æŸä¸ª Pod çš„äº‹ä»¶\nkubectl describe pod \u0026lt;pod\u0026gt; è·Ÿè¸ªæ—¥å¿—\nkubectl logs -f \u0026lt;pod\u0026gt; kubectl logs -f \u0026lt;pod\u0026gt; -c \u0026lt;container\u0026gt; ğŸ”¥ ä¹ã€å¼ºåˆ¶åˆ é™¤èµ„æº kubectl delete pod \u0026lt;pod\u0026gt; --force --grace-period=0 ğŸ”¥ åã€åº”ç”¨éƒ¨ç½²å‘½ä»¤ ä» YAML éƒ¨ç½²\nkubectl apply -f app.yaml kubectl delete -f app.yaml æ£€æŸ¥ YAML\nkubectl apply --dry-run=client -f app.yaml ğŸ”¥ åä¸€ã€èµ„æºåˆ†ç±»æŸ¥çœ‹å‘½ä»¤ æŸ¥çœ‹æ‰€æœ‰ workloadï¼ˆPod/Deploy/StatefulSet/DaemonSet/Jobï¼‰\nkubectl get all æŸ¥çœ‹ Detailed Workload\nkubectl get deploy,statefulset,daemonset,job,cronjob ğŸ”¥ åäºŒã€ä¸´æ—¶è°ƒè¯• Podï¼ˆEphemeral Containersï¼‰ Kubernetes â‰¥ 1.25ï¼š\nkubectl debug pod-name -it --image=busybox ğŸ”¥ åä¸‰ã€CRDï¼ˆè‡ªå®šä¹‰èµ„æºï¼‰ kubectl get crd kubectl describe crd \u0026lt;name\u0026gt; ğŸ”¥ åå››ã€æƒé™ RBAC kubectl auth can-i get pods kubectl auth can-i delete node --as admin kubectl auth can-i create pods -n dev ğŸ”¥ åäº”ã€æœ€å¸¸ç”¨çŸ­å‘½ä»¤å¤ä¹ ç‰ˆï¼ˆ20 æ¡å¿…è®°ï¼‰ kubectl get pods -A kubectl logs -f pod kubectl describe pod pod kubectl exec -it pod -- sh kubectl apply -f xxx.yaml kubectl delete -f xxx.yaml kubectl get deploy kubectl set image deploy/myapp app=myimg:v2 kubectl rollout restart deploy/myapp kubectl rollout undo deploy/myapp kubectl get svc kubectl port-forward svc/myapp 8080:80 kubectl get nodes -owide kubectl drain node01 --ignore-daemonsets kubectl uncordon node01 kubectl label node node01 key=value kubectl get events --sort-by=.metadata.creationTimestamp kubectl cp ns/pod:/file . kubectl top pod kubectl top node ","description":" ğŸ”¥ ä¸€ã€é›†ç¾¤çº§æ“ä½œï¼ˆClusterï¼‰ æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯\nkubectl cluster-info kubectl version kubectl api-resources kubectl api-versions æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡\nkubectl config get-contexts kubectl config current-context åˆ‡æ¢ä¸Šä¸‹æ–‡\nkubectl config use-context \u0026lt;context\u0026gt; ğŸ”¥ äºŒã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´\nkubectl get ns åˆ›å»º / åˆ é™¤\nkubectl create ns dev kubectl delete ns dev é€‰æ‹© Namespace\n"},{"id":104,"href":"/operations/linux/user-space-libc/","title":"libc","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€Œlibc ç³»ç»Ÿçº§è¯¦è§£ã€ï¼Œä» å†…æ ¸è¾¹ç•Œã€ç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œæ—¶æ¨¡å‹ã€ä¸ Shell / systemd / å®¹å™¨ / æ•°æ®åº“ çš„å…³ç³» å…¨éƒ¨ä¸²èµ·æ¥ï¼Œå Linux / è¿ç»´ / æ¶æ„ / å†…æ ¸è®¤çŸ¥ï¼Œä¸æ˜¯ API æ‰‹å†Œã€‚\nä¸€ã€libc æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¥è¯è®²æ¸…æ¥š libcï¼ˆC æ ‡å‡†åº“ï¼‰æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºè®¿é—® Linux å†…æ ¸èƒ½åŠ›çš„â€œæ ‡å‡†åŒ–ä¸­é—´å±‚â€ã€‚\nå®ƒ ä¸æ˜¯å†…æ ¸ï¼Œä½† å‡ ä¹æ‰€æœ‰ç”¨æˆ·ç¨‹åºéƒ½ä¾èµ–å®ƒã€‚\nåº”ç”¨ç¨‹åº â†“ (printf / malloc / fopen / pthread) libc â†“ (syscall / vdso) Linux Kernel â†“ Hardware äºŒã€libc åœ¨ Linux æ¶æ„ä¸­çš„ä½ç½® +-------------------------------+ | åº”ç”¨ç¨‹åº / Shell / systemd | | nginx / mysql / docker | +-------------------------------+ | libc | | glibc / musl / uClibc | +-------------------------------+ | ç³»ç»Ÿè°ƒç”¨æ¥å£ | +-------------------------------+ | Linux Kernel | +-------------------------------+ | Hardware | +-------------------------------+ ğŸ“Œ æ²¡æœ‰ libcï¼Œç”¨æˆ·ç¨‹åºå‡ ä¹æ— æ³•ç›´æ¥ä¸å†…æ ¸äº¤äº’\nä¸‰ã€libc å¹²äº†å“ªå‡ ç±»äº‹ï¼Ÿï¼ˆæ ¸å¿ƒåˆ†ç±»ï¼‰ 1ï¸âƒ£ ç³»ç»Ÿè°ƒç”¨å°è£…ï¼ˆæœ€é‡è¦ï¼‰ å†…æ ¸åªæä¾› syscall\nsyscall(SYS_write, fd, buf, len); libc æä¾›æ˜“ç”¨ API\nwrite(fd, buf, len); libc åšäº†ï¼š\nå‚æ•°å‡†å¤‡ ABI é€‚é… é”™è¯¯ç è½¬æ¢ï¼ˆerrnoï¼‰ vDSO ä¼˜åŒ– 2ï¸âƒ£ C æ ‡å‡†åº“å‡½æ•°ï¼ˆISO Cï¼‰ åˆ†ç±» ç¤ºä¾‹ IO printf / scanf å­—ç¬¦ä¸² strcpy / strlen æ•°å­¦ sin / sqrt å†…å­˜ malloc / free ğŸ“Œ è¿™äº›å‡½æ•°ä¸ä¸€å®šè§¦å‘ç³»ç»Ÿè°ƒç”¨\n3ï¸âƒ£ è¿›ç¨‹ / çº¿ç¨‹ç®¡ç†ï¼ˆPOSIXï¼‰ fork() execve() wait() pthread_create() è¿›ç¨‹ï¼šfork + exec çº¿ç¨‹ï¼špthread -\u0026gt; clone 4ï¸âƒ£ å†…å­˜ç®¡ç†ï¼ˆç”¨æˆ·æ€ï¼‰ malloc() -\u0026gt; brk / mmap libc å†…å­˜åˆ†é…å™¨ï¼š\nç®¡ç† heap ç¼“å­˜å°å¯¹è±¡ å‡å°‘ syscall æ¬¡æ•° 5ï¸âƒ£ åŠ¨æ€é“¾æ¥å™¨ï¼ˆld-linuxï¼‰ libc é€šå¸¸è‡ªå¸¦åŠ¨æ€åŠ è½½å™¨\n/lib64/ld-linux-x86-64.so.2 è´Ÿè´£ï¼š\nè£…è½½ .so è§£æç¬¦å· é‡å®šä½ å››ã€libc â‰  åªæœ‰ glibc libc å®ç° ç‰¹ç‚¹ å¸¸è§ç³»ç»Ÿ glibc åŠŸèƒ½å…¨ / å¤æ‚ RHEL / Ubuntu musl å° / é™æ€å‹å¥½ Alpine uClibc åµŒå…¥å¼ OpenWrt bionic Android Android glibc vs muslï¼ˆè¿ç»´é‡ç‚¹ï¼‰ é¡¹ glibc musl ä½“ç§¯ å¤§ æå° å…¼å®¹æ€§ æœ€å¼º POSIX ä¸¥ æ€§èƒ½ ä¼˜ ç¨³å®š é™æ€ç¼–è¯‘ å›°éš¾ å‹å¥½ å®¹å™¨ åé‡ Alpine ğŸ“Œ Alpine Linux é»˜è®¤æ˜¯ musl\näº”ã€libc ä¸ Shell çš„å…³ç³» ls æ‰§è¡Œè¿‡ç¨‹ï¼š\nshell fork() execve(â€/bin/lsâ€) ls ä½¿ç”¨ libc libc è°ƒ syscall kernel æ‰§è¡Œ ğŸ“Œ Shell / systemd / Nginx éƒ½ä¾èµ– libc\nå…­ã€libc ä¸ systemd çš„å…³ç³» systemd æœ¬èº«ï¼š\nä½¿ç”¨ glibc æ·±åº¦ä¾èµ– pthread / epoll / timerfd systemd å¯åŠ¨æœåŠ¡æ—¶ï¼š\nè®¾ç½®ç¯å¢ƒå˜é‡ exec æœåŠ¡ æœåŠ¡ç»§ç»­ä½¿ç”¨ libc ä¸ƒã€libc ä¸æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰ 1ï¸âƒ£ å†…å­˜åˆ†é… malloc / free arena / tcacheï¼ˆglibcï¼‰ æ•°æ®åº“å¸¸è§é—®é¢˜ï¼š\nglibc arena è¿‡å¤š -\u0026gt; å†…å­˜ç¢ç‰‡ NUMA è·¨èŠ‚ç‚¹åˆ†é… 2ï¸âƒ£ IO æ¨¡å‹ read / write pread / pwrite fsync glibc å¯èƒ½ï¼š\nåˆå¹¶ syscall ä½¿ç”¨ page cache 3ï¸âƒ£ çº¿ç¨‹æ¨¡å‹ pthread -\u0026gt; clone TLSï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ 4ï¸âƒ£ æ—¶é—´ / ä¿¡å· clock_gettime() nanosleep() signal() å…«ã€libc ä¸ NUMA / cgroups NUMA malloc é»˜è®¤ä¸ NUMA äº²å’Œ ç”±å†…æ ¸ç­–ç•¥å†³å®š æ•°æ®åº“å¸¸éœ€ numactl cgroups libc ä¸ç›´æ¥æ„ŸçŸ¥ cgroups\nä½†ï¼š\nmalloc è§¦å‘ OOM pthread å— CPU quota é™åˆ¶ ä¹ã€libc çš„å…³é”®å†…éƒ¨æœºåˆ¶ï¼ˆè¿›é˜¶ï¼‰ 1ï¸âƒ£ vDSOï¼ˆæ€§èƒ½å…³é”®ï¼‰ clock_gettime() æ— éœ€é™·å…¥å†…æ ¸ï¼š\nç›´æ¥åœ¨ç”¨æˆ·æ€è¯»æ—¶é—´ 2ï¸âƒ£ TLSï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ __thread int x; æ¯çº¿ç¨‹ç‹¬ç«‹\n3ï¸âƒ£ errno -1 -\u0026gt; errno = EAGAIN libc ç»´æŠ¤ errno\nåã€è¿ç»´å¸¸è§ libc é—®é¢˜ 1ï¸âƒ£ glibc ç‰ˆæœ¬ä¸å…¼å®¹ GLIBC_2.28 not found ğŸ“Œ äºŒè¿›åˆ¶ä¸ç³»ç»Ÿ glibc ä¸åŒ¹é…\n2ï¸âƒ£ Alpine å®¹å™¨è·‘ glibc ç¨‹åºå¤±è´¥ è§£å†³æ–¹æ¡ˆï¼š\næ¢ Debian é•œåƒ æˆ–å®‰è£… glibc å…¼å®¹åŒ… 3ï¸âƒ£ å†…å­˜å ç”¨å¼‚å¸¸ glibc arenaï¼š\nMALLOC_ARENA_MAX=2 åä¸€ã€libc ä¸å®¹å™¨ åœºæ™¯ è¯´æ˜ å®¹å™¨å†… libc æ¥è‡ªé•œåƒ å†…æ ¸ å®¿ä¸»æœº syscall ABI å¿…é¡»åŒ¹é… ğŸ“Œ libc åªéœ€å…¼å®¹å†…æ ¸ syscall\nåäºŒã€æ€»ç»“ libc æ˜¯ç”¨æˆ·ç©ºé—´â€œäº‹å®ä¸Šçš„æ“ä½œç³»ç»Ÿæ¥å£å±‚â€ã€‚\nShellã€systemdã€æ•°æ®åº“ã€å®¹å™¨ï¼Œå…¨éƒ¨ç«™åœ¨å®ƒè‚©è†€ä¸Šã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€Œlibc ç³»ç»Ÿçº§è¯¦è§£ã€ï¼Œä» å†…æ ¸è¾¹ç•Œã€ç³»ç»Ÿè°ƒç”¨ã€è¿è¡Œæ—¶æ¨¡å‹ã€ä¸ Shell / systemd / å®¹å™¨ / æ•°æ®åº“ çš„å…³ç³» å…¨éƒ¨ä¸²èµ·æ¥ï¼Œå Linux / è¿ç»´ / æ¶æ„ / å†…æ ¸è®¤çŸ¥ï¼Œä¸æ˜¯ API æ‰‹å†Œã€‚\nä¸€ã€libc æ˜¯ä»€ä¹ˆï¼Ÿä¸€å¥è¯è®²æ¸…æ¥š libcï¼ˆC æ ‡å‡†åº“ï¼‰æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºè®¿é—® Linux å†…æ ¸èƒ½åŠ›çš„â€œæ ‡å‡†åŒ–ä¸­é—´å±‚â€ã€‚\nå®ƒ ä¸æ˜¯å†…æ ¸ï¼Œä½† å‡ ä¹æ‰€æœ‰ç”¨æˆ·ç¨‹åºéƒ½ä¾èµ–å®ƒã€‚\nåº”ç”¨ç¨‹åº â†“ (printf / malloc / fopen / pthread) libc â†“ (syscall / vdso) Linux Kernel â†“ Hardware äºŒã€libc åœ¨ Linux æ¶æ„ä¸­çš„ä½ç½® +-------------------------------+ | åº”ç”¨ç¨‹åº / Shell / systemd | | nginx / mysql / docker | +-------------------------------+ | libc | | glibc / musl / uClibc | +-------------------------------+ | ç³»ç»Ÿè°ƒç”¨æ¥å£ | +-------------------------------+ | Linux Kernel | +-------------------------------+ | Hardware | +-------------------------------+ ğŸ“Œ æ²¡æœ‰ libcï¼Œç”¨æˆ·ç¨‹åºå‡ ä¹æ— æ³•ç›´æ¥ä¸å†…æ ¸äº¤äº’\n"},{"id":105,"href":"/operations/linux/kernel-overlay2/","title":"overlay2","parent":"Linux","content":" ä¸€ã€overlay2 æ˜¯ä»€ä¹ˆï¼Ÿ overlay2 æ˜¯ Docker / containerd é»˜è®¤ã€æ¨èä½¿ç”¨çš„ è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion FSï¼‰å­˜å‚¨é©±åŠ¨ï¼ŒåŸºäº Linux OverlayFS å®ç°ã€‚\noverlay2 = OverlayFS + å¤šå±‚é•œåƒä¼˜åŒ–æ–¹æ¡ˆ\näºŒã€overlay2 è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœ¨å®¹å™¨åœºæ™¯ä¸­ï¼š\né•œåƒæ˜¯ å¤šå±‚åªè¯» å®¹å™¨éœ€è¦ä¸€ä¸ª å¯å†™å±‚ å¤šä¸ªå®¹å™¨éœ€è¦ å…±äº«é•œåƒå±‚ ä¸å¸Œæœ›å¤åˆ¶æ•´ä»½æ–‡ä»¶ï¼ˆèŠ‚çœç©ºé—´ï¼‰ overlay2 æ­£æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚\nä¸‰ã€OverlayFS æ ¸å¿ƒæ¦‚å¿µï¼ˆéå¸¸é‡è¦ï¼‰ OverlayFS æŠŠå¤šä¸ªç›®å½•â€œå åŠ â€æˆä¸€ä¸ªè§†å›¾ã€‚\nå››ä¸ªå…³é”®ç›®å½•\nç›®å½• ä½œç”¨ lowerdir åªè¯»å±‚ï¼ˆé•œåƒå±‚ï¼Œå¯å¤šå±‚ï¼‰ upperdir å¯å†™å±‚ï¼ˆå®¹å™¨å±‚ï¼‰ workdir å†…éƒ¨å·¥ä½œç›®å½•ï¼ˆå¿…é¡»ç©ºï¼‰ merged æŒ‚è½½åå¯¹å¤–æš´éœ²çš„ç›®å½• ç¤ºæ„å›¾ï¼š\nmerged (å®¹å™¨çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿ) â†‘ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ upperdir lowerdir(s) (container) (image layers) å››ã€overlay vs overlay2 çš„åŒºåˆ« é¡¹ç›® overlay overlay2 lowerdir å±‚æ•° åªèƒ½ 1 å±‚ æ”¯æŒ å¤šå±‚ é•œåƒå±‚æ•° å—é™ å‡ ä¹æ— é™ æ€§èƒ½ ä¸€èˆ¬ æ›´ä¼˜ æ˜¯å¦æ¨è âŒ âœ… Docker 17+ é»˜è®¤ä½¿ç”¨ overlay2ã€‚\näº”ã€overlay2 åœ¨ Docker ä¸­çš„ç›®å½•ç»“æ„ é€šå¸¸åœ¨ï¼š\n/var/lib/docker/overlay2/ ç¤ºä¾‹ï¼š\noverlay2/ â”œâ”€â”€ 3a1c.../ â”‚ â”œâ”€â”€ diff/ # upperdir æˆ– layer å†…å®¹ â”‚ â”œâ”€â”€ link # çŸ­ ID â”‚ â”œâ”€â”€ lower # æŒ‡å‘ lowerdir â”‚ â”œâ”€â”€ work/ # workdir â”‚ â””â”€â”€ merged/ # å®¹å™¨æŒ‚è½½ç‚¹ â”œâ”€â”€ l/ â”‚ â”œâ”€â”€ ABCDEF... -\u0026gt; ../3a1c.../diff å„ç›®å½•å«ä¹‰\nç›®å½• è¯´æ˜ diff/ å½“å‰å±‚çš„çœŸå®æ–‡ä»¶ lower çˆ¶å±‚å¼•ç”¨ï¼ˆå¤šå±‚ï¼‰ merged/ å®¹å™¨è¿è¡Œæ—¶çœ‹åˆ°çš„ FS work/ OverlayFS å·¥ä½œç›®å½• l/ layer çš„çŸ­è·¯å¾„ç´¢å¼•ï¼ˆé¿å… mount å‚æ•°è¿‡é•¿ï¼‰ å…­ã€å®¹å™¨è¯»å†™è¡Œä¸ºï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ è¯»å–æ–‡ä»¶ é¡ºåºï¼š\nupperdir -\u0026gt; lowerdir -\u0026gt; lowerdir... æ‰¾åˆ°å³è¿”å› ä¸ä¼šå¤åˆ¶ 2ï¸âƒ£ å†™å…¥æ–‡ä»¶ï¼ˆCopy-on-Writeï¼‰ å¦‚æœå†™çš„æ˜¯ lowerdir ä¸­çš„æ–‡ä»¶ï¼š\nlowerdir/file -\u0026gt; copy -\u0026gt; upperdir/file åŸæ–‡ä»¶ä¸å˜ upperdir è¦†ç›– lowerdir 3ï¸âƒ£ åˆ é™¤æ–‡ä»¶ï¼ˆWhiteoutï¼‰ OverlayFS ä½¿ç”¨ whiteout æ–‡ä»¶ï¼š\n.wh.filename è¡¨ç¤ºâ€œåœ¨ lowerdir ä¸­å­˜åœ¨ï¼Œä½†åœ¨ merged ä¸­è¢«åˆ é™¤â€ ä¸ƒã€æ€§èƒ½ç‰¹ç‚¹ï¼ˆè¿ç»´å¿…è€ƒï¼‰ ä¼˜ç‚¹ éå¸¸èŠ‚çœç£ç›˜ç©ºé—´ å¯åŠ¨å¿«ï¼ˆæ— éœ€å¤åˆ¶ï¼‰ é•œåƒå±‚å¯å…±äº« ç¼ºç‚¹ é—®é¢˜ è¯´æ˜ å°æ–‡ä»¶å¤§é‡å†™å…¥ æ€§èƒ½ä¸‹é™ inode æ¶ˆè€—å¿« upperdir å  inode fsync å¼€é”€ overlay fsync æˆæœ¬é«˜ ç›®å½•å±‚çº§æ·± lookup å˜æ…¢ å…«ã€æ–‡ä»¶ç³»ç»Ÿè¦æ±‚ï¼ˆéå¸¸å…³é”®ï¼‰ overlay2 å¯¹åº•å±‚ FS æœ‰è¦æ±‚ï¼š\næ–‡ä»¶ç³»ç»Ÿ æ”¯æŒæƒ…å†µ ext4 âœ… æ¨è xfs (ftype=1) âœ… å¿…é¡» xfs (ftype=0) âŒ ä¸æ”¯æŒ æ£€æŸ¥æ–¹å¼\nxfs_info /var/lib/docker | grep ftype å¿…é¡»æ˜¯ï¼š\nftype=1 ä¹ã€æŸ¥çœ‹ overlay2 å®é™…æŒ‚è½½ mount | grep overlay ç¤ºä¾‹ï¼š\noverlay on /var/lib/docker/overlay2/.../merged type overlay \\ (lowerdir=...,upperdir=...,workdir=...) åã€å¸¸è§é—®é¢˜ä¸æ’æŸ¥ 1ï¸âƒ£ å®¹å™¨ç£ç›˜å ç”¨å¼‚å¸¸ du -sh /var/lib/docker/overlay2/* docker system df 2ï¸âƒ£ overlay æŠ¥é”™ invalid argument å¸¸è§åŸå› ï¼š\nxfs ftype=0 workdir ä¸åœ¨åŒä¸€æ–‡ä»¶ç³»ç»Ÿ lowerdir è·¯å¾„è¿‡é•¿ï¼ˆæ—§å†…æ ¸ï¼‰ 3ï¸âƒ£ inode ç”¨å°½ df -i è§£å†³æ–¹æ¡ˆï¼š\næ‰©å®¹ æ¸…ç†æ— ç”¨é•œåƒ/å®¹å™¨ ä½¿ç”¨ volume å­˜æ•°æ® åä¸€ã€overlay2 vs å…¶ä»–é©±åŠ¨ é©±åŠ¨ çŠ¶æ€ è¯´æ˜ overlay2 âœ… é»˜è®¤æ¨è ä¸»æµ devicemapper âš ï¸ è¿‡æ—¶ å¤æ‚ã€æ…¢ btrfs âš ï¸ å°ä¼— åŠŸèƒ½å¼ºã€é—®é¢˜å¤š zfs âš ï¸ ç‰¹å®šåœºæ™¯ ä¾èµ– ZFS åäºŒã€ç”Ÿäº§æœ€ä½³å®è·µ ä¸è¦æŠŠæ•°æ®åº“æ•°æ®å†™åœ¨ overlay2 ç”¨ volume / bind mount /var/lib/docker å•ç‹¬åˆ†åŒº xfs + ftype=1 å®šæœŸæ¸…ç†æ— ç”¨é•œåƒ ä¸è¦åœ¨å®¹å™¨é‡Œé¢‘ç¹ fsync åä¸‰ã€æ€»ç»“ overlay2 æ˜¯ Docker åœ¨ Linux ä¸Šæ€§èƒ½ã€ç¨³å®šæ€§å’Œç©ºé—´æ•ˆç‡çš„æœ€ä½³å¹³è¡¡æ–¹æ¡ˆï¼Œæœ¬è´¨æ˜¯ OverlayFS çš„å·¥ç¨‹åŒ–å®ç°ã€‚\n","description":" ä¸€ã€overlay2 æ˜¯ä»€ä¹ˆï¼Ÿ overlay2 æ˜¯ Docker / containerd é»˜è®¤ã€æ¨èä½¿ç”¨çš„ è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion FSï¼‰å­˜å‚¨é©±åŠ¨ï¼ŒåŸºäº Linux OverlayFS å®ç°ã€‚\noverlay2 = OverlayFS + å¤šå±‚é•œåƒä¼˜åŒ–æ–¹æ¡ˆ\näºŒã€overlay2 è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœ¨å®¹å™¨åœºæ™¯ä¸­ï¼š\né•œåƒæ˜¯ å¤šå±‚åªè¯» å®¹å™¨éœ€è¦ä¸€ä¸ª å¯å†™å±‚ å¤šä¸ªå®¹å™¨éœ€è¦ å…±äº«é•œåƒå±‚ ä¸å¸Œæœ›å¤åˆ¶æ•´ä»½æ–‡ä»¶ï¼ˆèŠ‚çœç©ºé—´ï¼‰ overlay2 æ­£æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚\nä¸‰ã€OverlayFS æ ¸å¿ƒæ¦‚å¿µï¼ˆéå¸¸é‡è¦ï¼‰ OverlayFS æŠŠå¤šä¸ªç›®å½•â€œå åŠ â€æˆä¸€ä¸ªè§†å›¾ã€‚\n"},{"id":106,"href":"/operations/linux/user-space-runc/","title":"runc","parent":"Linux","content":"è¿™æ˜¯ä¸€ä¸ªå®¹å™¨é¢†åŸŸé‡Œâ€œæœ€åº•å±‚ã€æœ€æ ¸å¿ƒã€ä½†åˆæœ€å®¹æ˜“è¢«å¿½ç•¥â€çš„ç»„ä»¶ã€‚\nå†…å®¹ï¼šå®šä½ -\u0026gt; æ¶æ„ -\u0026gt; ç”Ÿå‘½å‘¨æœŸ -\u0026gt; å†…æ ¸æœºåˆ¶ -\u0026gt; ä¸ Docker / containerd çš„å…³ç³» -\u0026gt; ä¸ºä»€ä¹ˆå¿…é¡»ç†è§£ runcã€‚\nä¸€å¥è¯å®šä½ï¼ˆå…ˆè®°ä½ï¼‰ runc æ˜¯ä¸€ä¸ªâ€œæŠŠ Linux å†…æ ¸èƒ½åŠ›çœŸæ­£ç”¨èµ·æ¥â€çš„ç¨‹åºï¼š\nå®ƒè´Ÿè´£æŠŠ namespacesã€cgroupsã€capabilitiesã€seccomp ç­‰é…ç½®ï¼Œè½¬åŒ–ä¸ºä¸€ä¸ªçœŸæ­£è¿è¡Œä¸­çš„ Linux è¿›ç¨‹ã€‚\nğŸ“Œ runc æœ¬èº«ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹ ğŸ“Œ runc å¯åŠ¨å®Œå®¹å™¨å°±é€€å‡º ğŸ“Œ å®¹å™¨ = è¢« runc åˆ›å»ºå¹¶é…ç½®çš„æ™®é€š Linux è¿›ç¨‹ ä¸€ã€runc åœ¨å®¹å™¨ä½“ç³»ä¸­çš„ä½ç½® å®¹å™¨å®Œæ•´æŠ€æœ¯æ ˆï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Kubernetes / Docker CLI â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ containerd / cri-o â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ runc â”‚ \u0026lt;-ã€æ ¸å¿ƒã€‘ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ Linux Kernel â”‚ â”‚ namespaces / cgroups / fs â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ‘‰ æ‰€æœ‰ OCI æ ‡å‡†å®¹å™¨ï¼Œæœ€ç»ˆéƒ½ç”± runc åˆ›å»º\näºŒã€runc æ˜¯ä»€ä¹ˆï¼Ÿ ä¸æ˜¯è™šæ‹Ÿæœºï¼\nrunc çš„æœ¬è´¨\nä¸€ä¸ª CLI ç¨‹åº ç”¨ Go ç¼–å†™ å®ç° OCI Runtime Specification åŠŸèƒ½åªæœ‰ä¸€ä¸ªï¼šåˆ›å»º + å¯åŠ¨ ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶å¥—ä¸Šéš”ç¦»ä¸é™åˆ¶\nä¸‰ã€OCI Runtime Spec ç®€ä»‹ï¼ˆrunc çš„åˆåŒï¼‰ OCI å®šä¹‰äº†ä¸‰æ ·ä¸œè¥¿ï¼š\nfilesystem layout config.json runtime behavior config.jsonï¼ˆæ ¸å¿ƒï¼‰ { \u0026#34;process\u0026#34;: { \u0026#34;args\u0026#34;: [\u0026#34;mysql\u0026#34;], \u0026#34;env\u0026#34;: [\u0026#34;PATH=/usr/bin\u0026#34;], \u0026#34;cwd\u0026#34;: \u0026#34;/\u0026#34; }, \u0026#34;root\u0026#34;: { \u0026#34;path\u0026#34;: \u0026#34;rootfs\u0026#34;, \u0026#34;readonly\u0026#34;: false }, \u0026#34;linux\u0026#34;: { \u0026#34;namespaces\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;pid\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;net\u0026#34; }, { \u0026#34;type\u0026#34;: \u0026#34;mnt\u0026#34; } ], \u0026#34;resources\u0026#34;: { \u0026#34;cpu\u0026#34;: {}, \u0026#34;memory\u0026#34;: {} } } } ğŸ“Œ runc å°±æ˜¯ config.json çš„â€œæ‰§è¡Œå™¨â€\nå››ã€runc åˆ›å»ºå®¹å™¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ runc create runc create mycontainer runc åšäº†ä»€ä¹ˆï¼š\nclone() åˆ›å»ºè¿›ç¨‹ è®¾ç½® namespaces è®¾ç½® cgroups mount rootfs è®¾ç½® capabilities å‡†å¤‡ä½†ä¸æ‰§è¡Œ ENTRYPOINT ğŸ“Œ å®¹å™¨è¿›ç¨‹ï¼šPaused çŠ¶æ€\n2ï¸âƒ£ runc start runc start mycontainer æ‰§è¡Œ config.json ä¸­çš„è¿›ç¨‹ PID è¯ç”Ÿ å®¹å™¨â€œæ´»äº†â€ 3ï¸âƒ£ runc kill / delete å‘é€ä¿¡å· æ¸…ç† cgroups æ¸…ç† namespace å¥æŸ„ äº”ã€runc å¦‚ä½•ä½¿ç”¨ Linux å†…æ ¸èƒ½åŠ›ï¼Ÿ 1ï¸âƒ£ Namespacesï¼ˆéš”ç¦»ï¼‰ Namespace éš”ç¦»ä»€ä¹ˆ pid è¿›ç¨‹ net ç½‘ç»œ mnt æ–‡ä»¶ç³»ç»Ÿ uts hostname ipc å…±äº«å†…å­˜ user UID/GID ğŸ“Œ runc è°ƒç”¨ clone(CLONE_NEW)\n2ï¸âƒ£ cgroupsï¼ˆèµ„æºé™åˆ¶ï¼‰ èµ„æº æ§åˆ¶ CPU quota / shares Memory limit / swap IO blkio PIDs æœ€å¤§è¿›ç¨‹æ•° ğŸ“Œ ç›´æ¥å†™ /sys/fs/cgroup\n3ï¸âƒ£ Capabilitiesï¼ˆæƒé™æ”¶ç¼©ï¼‰ CAP_SYS_ADMIN âŒ CAP_NET_ADMIN âŒ CAP_CHOWN âœ… ğŸ‘‰ å®¹å™¨ root â‰  å®¿ä¸»æœº root\n4ï¸âƒ£ Seccompï¼ˆç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ï¼‰ \u0026#34;seccomp\u0026#34;: { \u0026#34;defaultAction\u0026#34;: \u0026#34;SCMP_ACT_ERRNO\u0026#34;, \u0026#34;syscalls\u0026#34;: [ { \u0026#34;names\u0026#34;: [\u0026#34;read\u0026#34;, \u0026#34;write\u0026#34;], \u0026#34;action\u0026#34;: \u0026#34;SCMP_ACT_ALLOW\u0026#34; } ] } ğŸ“Œ å‡å°‘æ”»å‡»é¢\nå…­ã€runc ä¸ containerd / Docker çš„å…³ç³» Docker å®é™…è°ƒç”¨é“¾\ndocker run -\u0026gt; dockerd -\u0026gt; containerd -\u0026gt; containerd-shim -\u0026gt; runc ä¸ºä»€ä¹ˆè¦æœ‰ containerd-shimï¼Ÿ\nrunc é€€å‡ºåå®¹å™¨ä»éœ€å­˜åœ¨ shim æŒæœ‰ stdio shim å¤„ç†ä¿¡å· \u0026amp; exit code ğŸ“Œ runc ä¸å¸¸é©»\nä¸ƒã€runc ä¸è™šæ‹Ÿæœºçš„æ ¹æœ¬åŒºåˆ« å¯¹æ¯”é¡¹ runc / container è™šæ‹Ÿæœº å†…æ ¸ å®¿ä¸»æœº ç‹¬ç«‹ å¯åŠ¨ ms çº§ ç§’çº§ éš”ç¦» è¿›ç¨‹çº§ ç¡¬ä»¶çº§ å®‰å…¨ ä¾èµ–å†…æ ¸ å¼º èµ„æºå¼€é”€ æä½ é«˜ å…«ã€ä¸ºä»€ä¹ˆâ€œå®¹å™¨é€ƒé€¸â€å‡ ä¹éƒ½æ˜¯ runc ç›¸å…³ï¼Ÿ å› ä¸ºï¼š\nrunc è¿è¡Œåœ¨ å®¿ä¸»æœº root æ“ä½œ namespaces / mount ä»»ä½•æ¼æ´ = root æƒé™ ğŸ“Œ å†å²æ¼æ´ï¼š\nCVE-2019-5736ï¼ˆå®¹å™¨è¦†ç›– runc äºŒè¿›åˆ¶ï¼‰ ä¹ã€ä¸ºä»€ä¹ˆå¿…é¡»ç†è§£ runcï¼Ÿ ç†è§£ runc ç­‰äºï¼š\nç†è§£ å®¹å™¨çš„çœŸå®è¾¹ç•Œ ç†è§£ å®¹å™¨ â‰  VM ç†è§£ æ•°æ®åº“ä¸ºä»€ä¹ˆç»•ä¸è¿‡ overlay2 ç†è§£ cgroups/NUMA/IO è°ƒä¼˜çš„ç”Ÿæ•ˆç‚¹ ğŸ“Œ å®¹å™¨ä¸æ˜¯é­”æ³•ï¼Œåªæ˜¯è¿›ç¨‹\nåã€æ€»ç»“ runc = æŠŠ â€œæ™®é€š Linux è¿›ç¨‹â€ åŒ…è£…æˆ â€œçœ‹èµ·æ¥åƒç‹¬ç«‹ç³»ç»Ÿâ€ çš„å·¥å…·ã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªå®¹å™¨é¢†åŸŸé‡Œâ€œæœ€åº•å±‚ã€æœ€æ ¸å¿ƒã€ä½†åˆæœ€å®¹æ˜“è¢«å¿½ç•¥â€çš„ç»„ä»¶ã€‚\nå†…å®¹ï¼šå®šä½ -\u0026gt; æ¶æ„ -\u0026gt; ç”Ÿå‘½å‘¨æœŸ -\u0026gt; å†…æ ¸æœºåˆ¶ -\u0026gt; ä¸ Docker / containerd çš„å…³ç³» -\u0026gt; ä¸ºä»€ä¹ˆå¿…é¡»ç†è§£ runcã€‚\nä¸€å¥è¯å®šä½ï¼ˆå…ˆè®°ä½ï¼‰ runc æ˜¯ä¸€ä¸ªâ€œæŠŠ Linux å†…æ ¸èƒ½åŠ›çœŸæ­£ç”¨èµ·æ¥â€çš„ç¨‹åºï¼š\nå®ƒè´Ÿè´£æŠŠ namespacesã€cgroupsã€capabilitiesã€seccomp ç­‰é…ç½®ï¼Œè½¬åŒ–ä¸ºä¸€ä¸ªçœŸæ­£è¿è¡Œä¸­çš„ Linux è¿›ç¨‹ã€‚\nğŸ“Œ runc æœ¬èº«ä¸æ˜¯å®ˆæŠ¤è¿›ç¨‹ ğŸ“Œ runc å¯åŠ¨å®Œå®¹å™¨å°±é€€å‡º ğŸ“Œ å®¹å™¨ = è¢« runc åˆ›å»ºå¹¶é…ç½®çš„æ™®é€š Linux è¿›ç¨‹ ä¸€ã€runc åœ¨å®¹å™¨ä½“ç³»ä¸­çš„ä½ç½® å®¹å™¨å®Œæ•´æŠ€æœ¯æ ˆï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰\n"},{"id":107,"href":"/operations/linux/user-space-shell/","title":"shell","parent":"Linux","content":" ä¸€ã€ä»€ä¹ˆæ˜¯ Linux Shellï¼Ÿ ä¸€å¥è¯å®šä¹‰ï¼š\nShell æ˜¯ç”¨æˆ·ä¸ Linux å†…æ ¸ä¹‹é—´çš„â€œå‘½ä»¤è§£é‡Šå™¨ + æ§åˆ¶å™¨â€\nå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºï¼Œä¸æ˜¯å†…æ ¸ã€‚\nç”¨æˆ· -\u0026gt; Shell -\u0026gt; ç³»ç»Ÿè°ƒç”¨ -\u0026gt; Kernel -\u0026gt; ç¡¬ä»¶ äºŒã€Shell åœ¨ Linux æ¶æ„ä¸­çš„ä½ç½® +-------------------------------+ | åº”ç”¨ç¨‹åº / æœåŠ¡ | | (nginx / mysql / docker) | +-------------------------------+ | Shell / è„šæœ¬ | | bash / sh / zsh / fish | +-------------------------------+ | libc / system calls | +-------------------------------+ | Linux Kernel | +-------------------------------+ | Hardware | +-------------------------------+ Shell çš„æœ¬è´¨ï¼š\nè§£æå‘½ä»¤ ç®¡ç†è¿›ç¨‹ æ§åˆ¶ IO åè°ƒç¨‹åºè¿è¡Œ ä¸‰ã€å¸¸è§ Linux Shell ç±»å‹ Shell ç‰¹ç‚¹ ä½¿ç”¨åœºæ™¯ bash æ ‡å‡†ã€ç¨³å®š æœåŠ¡å™¨é»˜è®¤ sh POSIX å…¼å®¹ è„šæœ¬å¯ç§»æ¤ zsh äº¤äº’å‹å¥½ æ¡Œé¢ / å¼€å‘ fish æ˜“ç”¨ä½†ä¸å…¼å®¹ ä¸ªäººä½¿ç”¨ dash æå¿« Debian /bin/sh ğŸ“Œ ç”Ÿäº§ç¯å¢ƒè„šæœ¬ï¼šbash / sh\nå››ã€Shell çš„å››å¤§æ ¸å¿ƒèƒ½åŠ› 1ï¸âƒ£ å‘½ä»¤è§£é‡Šï¼ˆCommand Parsingï¼‰ ls -l /etc Shell åšäº†ä»€ä¹ˆï¼š\nåˆ†è¯ï¼ˆtokenizeï¼‰ å˜é‡æ›¿æ¢ é€šé…ç¬¦å±•å¼€ æ‰§è¡Œå‘½ä»¤ 2ï¸âƒ£ è¿›ç¨‹æ§åˆ¶ï¼ˆProcess Controlï¼‰ å‰å° / åå°\ncmd \u0026amp; jobs fg %1 å­è¿›ç¨‹ / çˆ¶è¿›ç¨‹\ncmd1 | cmd2 æ¯ä¸ª | éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹\n3ï¸âƒ£ IO é‡å®šå‘ï¼ˆéå¸¸é‡è¦ï¼‰ cmd \u0026gt; out.log 2\u0026gt;\u0026amp;1 cmd \u0026lt; input.txt cmd \u0026gt;\u0026gt; file FD å«ä¹‰ 0 stdin 1 stdout 2 stderr 4ï¸âƒ£ ç¯å¢ƒä¸å˜é‡ç®¡ç† å˜é‡ç±»å‹\nvar=1 # shell å˜é‡ export var=1 # ç¯å¢ƒå˜é‡ å­è¿›ç¨‹åªèƒ½ç»§æ‰¿ç¯å¢ƒå˜é‡\näº”ã€Shell è„šæœ¬çš„æ ¸å¿ƒæœºåˆ¶ 1ï¸âƒ£ å˜é‡ä¸å¼•ç”¨ a=10 echo \u0026#34;$a\u0026#34; # æ¨è echo \u0026#39;$a\u0026#39; # åŸæ ·è¾“å‡º 2ï¸âƒ£ æ¡ä»¶åˆ¤æ–­ if [ -f /etc/passwd ]; then echo ok fi æ³¨æ„ï¼š\n[ æ˜¯å‘½ä»¤ ç©ºæ ¼ä¸èƒ½å°‘ 3ï¸âƒ£ å¾ªç¯ for i in 1 2 3; do echo $i done 4ï¸âƒ£ å‡½æ•° foo() { echo hello } 5ï¸âƒ£ exit codeï¼ˆéå¸¸å…³é”®ï¼‰ cmd echo $? # 0 = æˆåŠŸ Shell è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€ä¸ªå‘½ä»¤çš„é€€å‡ºç \nå…­ã€Shell ä¸ Kernel çš„å…³ç³»ï¼ˆå…³é”®è®¤çŸ¥ï¼‰ Shell å¹¶ä¸â€œæ‰§è¡Œå‘½ä»¤â€ï¼Œè€Œæ˜¯ï¼š\nfork() -\u0026gt; execve() -\u0026gt; å†…æ ¸è°ƒåº¦ Shell çš„èŒè´£ï¼š\nåˆ›å»ºè¿›ç¨‹ è®¾ç½® IO ä¼ å‚ ç­‰å¾…æˆ–åå° ä¸ƒã€Shell çš„æ‰§è¡Œæ¨¡å‹ script.sh å®é™…æµç¨‹ï¼š\nShell fork è‡ªå·± exec æŒ‡å®šè§£é‡Šå™¨ï¼ˆshebangï¼‰ é€è¡Œæ‰§è¡Œ ç»“æŸè¿”å› exit code Shebangï¼ˆ#!ï¼‰ #!/usr/bin/env bash å†³å®šè„šæœ¬ç”±è°è§£é‡Š\nå…«ã€Shell çš„å¯åŠ¨ç±»å‹ï¼ˆbashï¼‰ ç±»å‹ åœºæ™¯ åŠ è½½æ–‡ä»¶ login shell ssh ç™»å½• /etc/profile non-login å¼€ç»ˆç«¯ ~/.bashrc éäº¤äº’ è„šæœ¬ åªåŠ è½½è„šæœ¬ ä¹ã€å¸¸è§é…ç½®æ–‡ä»¶ï¼ˆè¿ç»´å¿…é¡»æ‡‚ï¼‰ æ–‡ä»¶ ä½œç”¨ /etc/profile å…¨å±€ç¯å¢ƒ ~/.bashrc ç”¨æˆ·ç¯å¢ƒ ~/.bash_profile ç™»å½•ç¯å¢ƒ /etc/bashrc ç³»ç»Ÿ bash é…ç½® /etc/inputrc é”®ç›˜è¡Œä¸º åã€Shell åœ¨è¿ç»´ä¸­çš„æ ¸å¿ƒä»·å€¼ è‡ªåŠ¨åŒ–\nbackup.sh deploy.sh cleanup.sh ç³»ç»Ÿåˆå§‹åŒ–\nsysctl limits systemd åº”æ€¥ä¿®å¤\nrescue æ¨¡å¼ rd.break åä¸€ã€Shell å¸¸è§â€œå‘â€ï¼ˆç»éªŒæ€»ç»“ï¼‰ âŒ å˜é‡ä¸åŠ å¼•å· âŒ ç”¨ for i in $(ls) âŒ å¿½ç•¥ exit code âŒ æ··ç”¨ bash/sh ç‰¹æ€§ âŒ è„šæœ¬æ—  set -e é˜²æŠ¤ åäºŒã€æ¨èçš„ Shell ç¼–ç è§„èŒƒï¼ˆç”Ÿäº§ï¼‰ #!/usr/bin/env bash set -Eeuo pipefail é€‰é¡¹ å«ä¹‰ -e å‡ºé”™å³åœ -u æœªå®šä¹‰å˜é‡æŠ¥é”™ -o pipefail ç®¡é“å¤±è´¥å¯æ„ŸçŸ¥ åä¸‰ã€æ€»ç»“ Shell ä¸æ˜¯â€œå‘½ä»¤é›†åˆâ€ï¼Œè€Œæ˜¯ Linux ç³»ç»Ÿçš„â€œç¼–æ’è¯­è¨€â€å’Œâ€œæ§åˆ¶ä¸­æ¢â€ã€‚\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯ Linux Shellï¼Ÿ ä¸€å¥è¯å®šä¹‰ï¼š\nShell æ˜¯ç”¨æˆ·ä¸ Linux å†…æ ¸ä¹‹é—´çš„â€œå‘½ä»¤è§£é‡Šå™¨ + æ§åˆ¶å™¨â€\nå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºï¼Œä¸æ˜¯å†…æ ¸ã€‚\nç”¨æˆ· -\u0026gt; Shell -\u0026gt; ç³»ç»Ÿè°ƒç”¨ -\u0026gt; Kernel -\u0026gt; ç¡¬ä»¶ äºŒã€Shell åœ¨ Linux æ¶æ„ä¸­çš„ä½ç½® +-------------------------------+ | åº”ç”¨ç¨‹åº / æœåŠ¡ | | (nginx / mysql / docker) | +-------------------------------+ | Shell / è„šæœ¬ | | bash / sh / zsh / fish | +-------------------------------+ | libc / system calls | +-------------------------------+ | Linux Kernel | +-------------------------------+ | Hardware | +-------------------------------+ Shell çš„æœ¬è´¨ï¼š\n"},{"id":108,"href":"/operations/linux/user-space-systemd/","title":"systemd","parent":"Linux","content":"â€œä»è®¾è®¡å“²å­¦åˆ°å†…æ ¸ååŒâ€çš„ systemd æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®ºæ€»è§ˆï¼Œå®šä½æ˜¯ RHEL / AlmaLinux / Rocky / Debian / Ubuntu é€šç”¨ï¼Œä¸æ˜¯å‘½ä»¤æ‰‹å†Œï¼Œçœ‹å®Œå°±çŸ¥é“ systemd åœ¨â€œæ§åˆ¶ä»€ä¹ˆã€æ€ä¹ˆæ§åˆ¶ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡â€ã€‚\nä¸€ã€systemd æ˜¯ä»€ä¹ˆï¼ˆå…ˆçº æ­£è®¤çŸ¥ï¼‰ systemd ä¸æ˜¯â€œå¯åŠ¨è„šæœ¬å·¥å…·â€ï¼Œè€Œæ˜¯ï¼šLinux çš„ç”¨æˆ·æ€ç³»ç»Ÿç®¡ç†æ¡†æ¶ã€‚\nå®ƒè´Ÿè´£çš„ä¸æ˜¯â€œå¼€æœºè·‘å‡ ä¸ªæœåŠ¡â€ï¼Œè€Œæ˜¯ï¼š\nç³»ç»ŸçŠ¶æ€ç®¡ç† + æœåŠ¡ç”Ÿå‘½å‘¨æœŸ + èµ„æºæ§åˆ¶ + ä¾èµ–è°ƒåº¦ systemd çš„è§’è‰² ç»´åº¦ ä½œç”¨ è¿›ç¨‹ç®¡ç† æ›¿ä»£ä¼ ç»Ÿ init æœåŠ¡ç¼–æ’ ä¾èµ–ã€é¡ºåºã€å¹¶è¡Œ èµ„æºç®¡ç† å¯¹æ¥ cgroups çŠ¶æ€ç®¡ç† ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ æ—¥å¿— journald è®¾å¤‡ udev ç½‘ç»œ networkdï¼ˆå¯é€‰ï¼‰ ä¼šè¯ logind ğŸ“Œ systemd = ç”¨æˆ·æ€â€œæ“ä½œç³»ç»Ÿæ§åˆ¶å¹³é¢â€\näºŒã€systemd çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ 1ï¸âƒ£ Everything is a Unitï¼ˆä¸€åˆ‡çš† Unitï¼‰ systemd ä¸ç›´æ¥â€œç®¡ç†è¿›ç¨‹â€ï¼Œè€Œæ˜¯ç®¡ç† Unit å¯¹è±¡ã€‚\nè¿›ç¨‹ â† Service Unit è®¾å¤‡ â† Device Unit æŒ‚è½½ç‚¹ â† Mount Unit ç›®æ ‡çŠ¶æ€ â† Target Unit 2ï¸âƒ£ å£°æ˜å¼ï¼Œè€Œä¸æ˜¯å‘½ä»¤å¼ ä¼ ç»Ÿ init\nstart A sleep 5 start B systemd\n[Unit] After=A.service Requires=A.service ğŸ“Œ ä½ æè¿°â€œå…³ç³»â€ï¼Œsystemd è´Ÿè´£â€œæ‰§è¡Œâ€\n3ï¸âƒ£ å¹¶è¡Œå¯åŠ¨ + äº‹ä»¶é©±åŠ¨ ä¸å†ä¸²è¡Œ æœ‰æ¡ä»¶æ‰å¯åŠ¨ ä¾èµ–æ»¡è¶³ç«‹å³è¿è¡Œ 4ï¸âƒ£ çŠ¶æ€æœºé©±åŠ¨ï¼ˆä¸æ˜¯è„šæœ¬ï¼‰ æ¯ä¸ª unit éƒ½æœ‰æ˜ç¡®çŠ¶æ€ï¼š\ninactive -\u0026gt; activating -\u0026gt; active -\u0026gt; deactivating -\u0026gt; failed ä¸‰ã€Unit ç±»å‹å…¨è§ˆï¼ˆæ ¸å¿ƒï¼‰ Unit ç±»å‹ ä½œç”¨ service æœåŠ¡è¿›ç¨‹ socket å¥—æ¥å­—æ¿€æ´» target è¿è¡Œç›®æ ‡ mount æŒ‚è½½ç‚¹ automount è‡ªåŠ¨æŒ‚è½½ device è®¾å¤‡ path è·¯å¾„è§¦å‘ timer å®šæ—¶å™¨ slice èµ„æºåˆ†ç»„ scope å¤–éƒ¨è¿›ç¨‹ å››ã€Service Unit æ·±åº¦åŸç†ï¼ˆæœ€é‡è¦ï¼‰ 1ï¸âƒ£ service çš„æœ¬è´¨ systemd ä¸æ˜¯â€œå¯åŠ¨ç¨‹åºâ€ï¼Œè€Œæ˜¯â€œæ‰˜ç®¡è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸâ€ã€‚\n2ï¸âƒ£ å¸¸è§ Service ç±»å‹ Type å«ä¹‰ simple é»˜è®¤ï¼Œå‰å°è¿›ç¨‹ exec ç±»ä¼¼ simple forking ä¼ ç»Ÿ daemon oneshot ä¸€æ¬¡æ€§ä»»åŠ¡ notify systemd-ready dbus D-Bus æ¿€æ´» ğŸ“Œ Type å†³å®š systemd å¦‚ä½•åˆ¤æ–­â€œæœåŠ¡å·²å¯åŠ¨â€\n3ï¸âƒ£ ExecStart çš„çœŸå®è¡Œä¸º ExecStart=/usr/bin/nginx systemd å®é™…åšäº†ä»€ä¹ˆï¼š\nfork -\u0026gt; execve è®¾ç½® namespace åŠ å…¥ cgroup è®¾ç½® rlimit è®¾ç½®ç¯å¢ƒå˜é‡ ç›‘å¬é€€å‡ºçŠ¶æ€ 4ï¸âƒ£ systemd æ‰˜ç®¡èƒ½åŠ›ï¼ˆä¼ ç»Ÿè„šæœ¬æ²¡æœ‰ï¼‰ è‡ªåŠ¨é‡å¯ï¼ˆRestart=ï¼‰ å¤±è´¥å›æ»š å¯åŠ¨è¶…æ—¶ è¿›ç¨‹åƒµå°¸å›æ”¶ äº”ã€Targetï¼šsystemd çš„â€œè¿è¡Œçº§åˆ«â€ target = çŠ¶æ€é›†åˆï¼Œä¸æ˜¯é¡ºåºè„šæœ¬\ntarget ä¼ ç»Ÿ runlevel multi-user.target 3 graphical.target 5 rescue.target å•ç”¨æˆ· emergency.target æœ€å°ç³»ç»Ÿ systemctl set-default multi-user.target ğŸ“Œ target æ˜¯â€œç³»ç»ŸçŠ¶æ€å¿«ç…§â€\nå…­ã€ä¾èµ–å…³ç³»æ¨¡å‹ï¼ˆç²¾é«“ï¼‰ 1ï¸âƒ£ å¼ºä¾èµ– vs å¼±ä¾èµ– æŒ‡ä»¤ å«ä¹‰ Requires æ²¡å®ƒå°±å¤±è´¥ Wants æœ‰æœ€å¥½ After å¯åŠ¨é¡ºåº Before ç›¸åé¡ºåº ğŸ“Œ After â‰  Requires\n2ï¸âƒ£ å¯åŠ¨é€»è¾‘ç¤ºä¾‹ Requires=network-online.target After=network-online.target è¡¨ç¤ºï¼š\nå¿…é¡»æœ‰ç½‘ç»œ å¹¶ä¸”ç­‰ç½‘ç»œ ready ä¸ƒã€cgroupsï¼šsystemd çš„éšè—æ ¸å¿ƒ systemd æ˜¯ cgroups v2 çš„ä¸»è¦æ§åˆ¶å™¨\n1ï¸âƒ£ cgroup å±‚çº§ / â””â”€ user.slice â””â”€ system.slice â””â”€ sshd.service 2ï¸âƒ£ èµ„æºæ§åˆ¶èƒ½åŠ› CPUQuota=50% MemoryMax=2G IOReadBandwidthMax=/dev/sda 10M ğŸ“Œ systemd æ˜¯ å®¹å™¨ / Kubernetes çš„ç¥–å¸ˆçˆ·\nå…«ã€Socket / Path / Timer æ¿€æ´»ï¼ˆç°ä»£èƒ½åŠ›ï¼‰ Socket æ¿€æ´» æœ‰è¿æ¥æ‰å¯åŠ¨æœåŠ¡ æ”¯æŒå¹³æ»‘å‡çº§ Path æ¿€æ´» æ–‡ä»¶å˜åŒ–è§¦å‘æœåŠ¡ Timer æ›¿ä»£ cron ç²¾å‡†ã€å¯é ã€å¯ç›‘æ§ ä¹ã€journaldï¼šæ—¥å¿—ä¸æ˜¯æ–‡ä»¶ æ—¥å¿— = ç»“æ„åŒ–äº‹ä»¶æµ\nç‰¹ç‚¹\näºŒè¿›åˆ¶ æ”¯æŒç´¢å¼• ä¸ unit ç»‘å®š journalctl -u sshd åã€logindï¼šä¼šè¯ä¸ç™»å½•æ§åˆ¶ ç®¡ç†ï¼š\nSSH TTY ç”¨æˆ· session ç”µæºäº‹ä»¶ ğŸ“Œ pam_nologinã€ç™»å½•é™åˆ¶éƒ½åœ¨è¿™å±‚\nåä¸€ã€systemd vs SysV initï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ ç»´åº¦ SysV systemd å¯åŠ¨ ä¸²è¡Œ å¹¶è¡Œ ç®¡ç† è„šæœ¬ çŠ¶æ€æœº èµ„æº æ—  cgroups æ—¥å¿— æ–‡ä»¶ journal ä¾èµ– æ‰‹å†™ è‡ªåŠ¨ åäºŒã€systemd åœ¨ç³»ç»Ÿä¸­çš„â€œä½ç½®â€ å†…æ ¸ â””â”€ systemd (PID 1) â”œâ”€ udevd â”œâ”€ journald â”œâ”€ logind â”œâ”€ networkd â””â”€ services... ğŸ“Œ PID 1 çš„è´£ä»»æ˜¯ï¼šç³»ç»Ÿæ°¸è¿œä¸èƒ½â€œæ­»â€\nåä¸‰ã€å¸¸è§è¯¯åŒºçº æ­£ âŒ systemd å¯åŠ¨æ…¢ âœ… å®é™…æ›´å¿«ï¼Œåªæ˜¯æ—¥å¿—å¯è§\nâŒ systemd å¤ªå¤æ‚ âœ… å®ƒæŠŠâ€œå¤æ‚åº¦ä»è„šæœ¬æ¬è¿›ç³»ç»Ÿâ€\nâŒ systemd ä¸ç¨³å®š âœ… ç›®å‰ Linux æœ€ç¨³å®šçš„ init å®ç°\nåå››ã€æ€»ç»“ systemd æ˜¯ Linux çš„â€œçŠ¶æ€é©±åŠ¨ç³»ç»Ÿç®¡ç†å†…æ ¸â€ï¼Œé€šè¿‡ Unit æŠ½è±¡ç³»ç»Ÿå¯¹è±¡ï¼Œç”¨ä¾èµ–å…³ç³»å’Œ cgroups æ§åˆ¶ç³»ç»Ÿç”Ÿå‘½å‘¨æœŸã€‚\n","description":"â€œä»è®¾è®¡å“²å­¦åˆ°å†…æ ¸ååŒâ€çš„ systemd æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®ºæ€»è§ˆï¼Œå®šä½æ˜¯ RHEL / AlmaLinux / Rocky / Debian / Ubuntu é€šç”¨ï¼Œä¸æ˜¯å‘½ä»¤æ‰‹å†Œï¼Œçœ‹å®Œå°±çŸ¥é“ systemd åœ¨â€œæ§åˆ¶ä»€ä¹ˆã€æ€ä¹ˆæ§åˆ¶ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡â€ã€‚\nä¸€ã€systemd æ˜¯ä»€ä¹ˆï¼ˆå…ˆçº æ­£è®¤çŸ¥ï¼‰ systemd ä¸æ˜¯â€œå¯åŠ¨è„šæœ¬å·¥å…·â€ï¼Œè€Œæ˜¯ï¼šLinux çš„ç”¨æˆ·æ€ç³»ç»Ÿç®¡ç†æ¡†æ¶ã€‚\nå®ƒè´Ÿè´£çš„ä¸æ˜¯â€œå¼€æœºè·‘å‡ ä¸ªæœåŠ¡â€ï¼Œè€Œæ˜¯ï¼š\nç³»ç»ŸçŠ¶æ€ç®¡ç† + æœåŠ¡ç”Ÿå‘½å‘¨æœŸ + èµ„æºæ§åˆ¶ + ä¾èµ–è°ƒåº¦ systemd çš„è§’è‰² ç»´åº¦ ä½œç”¨ è¿›ç¨‹ç®¡ç† æ›¿ä»£ä¼ ç»Ÿ init æœåŠ¡ç¼–æ’ ä¾èµ–ã€é¡ºåºã€å¹¶è¡Œ èµ„æºç®¡ç† å¯¹æ¥ cgroups çŠ¶æ€ç®¡ç† ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ æ—¥å¿— journald è®¾å¤‡ udev ç½‘ç»œ networkdï¼ˆå¯é€‰ï¼‰ ä¼šè¯ logind ğŸ“Œ systemd = ç”¨æˆ·æ€â€œæ“ä½œç³»ç»Ÿæ§åˆ¶å¹³é¢â€\n"},{"id":109,"href":"/operations/linux/systemd-and-runc/","title":"systemd å’Œ runc ä¹‹é—´çš„å…³ç³»","parent":"Linux","content":"æœ‰å…³ç³»ï¼Œè€Œä¸”å…³ç³»éå¸¸æ¸…æ™°ï¼Œä½†å±‚çº§ä¸€å®šè¦åˆ†æ¸…ã€‚\nå†…å®¹ï¼šç»“è®º -\u0026gt; æ¶æ„å…³ç³» -\u0026gt; å…¸å‹äº¤äº’è·¯å¾„ -\u0026gt; å¸¸è§è¯¯åŒºæ¾„æ¸…ã€‚\nä¸€ã€ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ systemd å’Œ runc ä¸åœ¨åŒä¸€å±‚ï¼Œä½†å®ƒä»¬é€šè¿‡â€œè¿›ç¨‹æ¨¡å‹â€å’Œâ€œcgroupsâ€äº§ç”Ÿäº†é—´æ¥è”ç³»ã€‚\nsystemdï¼šé€šç”¨çš„ ç³»ç»Ÿä¸æœåŠ¡ç®¡ç†å™¨ runcï¼šç¬¦åˆ OCI è§„èŒƒçš„ å®¹å™¨è¿›ç¨‹å¯åŠ¨å™¨ ğŸ‘‰ å®ƒä»¬ä¸æ˜¯äº’ç›¸è°ƒç”¨å…³ç³»ï¼Œè€Œæ˜¯â€œå¯ä»¥åä½œï¼Œä½†äº’ä¸ä¾èµ–â€\näºŒã€å„è‡ªæ˜¯è°ï¼Ÿï¼ˆä¸¥æ ¼å®šä½ï¼‰ 1ï¸âƒ£ systemd æ˜¯ä»€ä¹ˆ systemd æ˜¯ PID 1ï¼Œè´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„ï¼š\nè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç† æœåŠ¡å¯åŠ¨ / åœæ­¢ / é‡å¯ cgroups ç®¡ç† èµ„æºé™åˆ¶ï¼ˆCPU / Memory / IOï¼‰ socket / timer / mount ç®¡ç† æœ¬è´¨ä¸€å¥è¯ï¼š\nsystemd æ˜¯â€œè¿›ç¨‹æ§åˆ¶å¹³é¢â€ã€‚\n2ï¸âƒ£ runc æ˜¯ä»€ä¹ˆ runc æ˜¯ä¸€ä¸ª ä¸€æ¬¡æ€§å·¥å…·ï¼Œè´Ÿè´£ï¼š\nåˆ›å»º Linux namespaces è®¾ç½® cgroups æŒ‚è½½ rootfs æ‰§è¡Œå®¹å™¨çš„ init è¿›ç¨‹ å¯åŠ¨å®Œæˆå ç«‹åˆ»é€€å‡º æœ¬è´¨ä¸€å¥è¯ï¼š\nrunc æ˜¯â€œå®¹å™¨è¿›ç¨‹å¼•å¯¼å™¨â€ã€‚\nä¸‰ã€systemd å’Œ runc çš„çœŸæ­£â€œè¿æ¥ç‚¹â€ ğŸ”— å”¯ä¸€çœŸæ­£çš„äº¤é›†ï¼šcgroups è¿™æ˜¯å®ƒä»¬å‘ç”Ÿå…³ç³»çš„åœ°æ–¹ã€‚\nsystemd å¯¹ cgroups çš„è§’è‰² systemd æ˜¯ cgroup çš„æ€»ç®¡ç†è€…\næ‰€æœ‰è¿›ç¨‹æœ€ç»ˆéƒ½åœ¨æŸä¸ª systemd ç®¡ç†çš„ cgroup ä¸‹\nsystemd è´Ÿè´£ï¼š\nåˆ›å»º å±‚çº§åˆ’åˆ† å›æ”¶ èµ„æºé™åˆ¶ runc å¯¹ cgroups çš„è§’è‰² runc ä¸ä¼šåˆ›å»ºé¡¶å±‚ cgroup\nå®ƒåªæ˜¯ï¼š\nè¢«å‘ŠçŸ¥â€œä½ è¯¥ç”¨å“ªä¸ª cgroupâ€ æŠŠå®¹å™¨è¿›ç¨‹æ”¾è¿›å» runc æœ¬èº«ä¸è´Ÿè´£é•¿æœŸç®¡ç†\nå››ã€çœŸå®è¿è¡Œè·¯å¾„ï¼ˆéå¸¸é‡è¦ï¼‰ å…¸å‹ Docker åœºæ™¯ï¼ˆç®€åŒ–ï¼‰ systemd (PID 1) â””â”€ dockerd.service â””â”€ dockerd â””â”€ containerd â””â”€ runc â””â”€ å®¹å™¨ init è¿›ç¨‹ (PID N) å…³é”®ç‚¹è§£é‡Š systemdï¼š\nç®¡ç† dockerd.service åˆ›å»ºå¹¶ç»´æŠ¤ cgroup æ ‘ runcï¼š\nåœ¨ systemd å·²åˆ’å¥½çš„ cgroup ç©ºé—´ä¸­ å¯åŠ¨å®¹å™¨è¿›ç¨‹ å¯åŠ¨å®Œæˆå³é€€å‡º ğŸ‘‰ runc ä»ä¸â€œæ¥ç®¡ç³»ç»Ÿâ€ï¼Œå®ƒåªæ˜¯å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹\näº”ã€systemd-run ä¸ runc çš„ç±»æ¯”å…³ç³» è¿™æ˜¯ç†è§£å®ƒä»¬å…³ç³»çš„å…³é”®ç±»æ¯”ï¼š\né¡¹ç›® systemd-run runc ä½œç”¨ å¯åŠ¨ä¸€ä¸ªå—æ§è¿›ç¨‹ å¯åŠ¨ä¸€ä¸ªå—æ§è¿›ç¨‹ æ˜¯å¦ä¸€æ¬¡æ€§ æ˜¯ æ˜¯ æ˜¯å¦ç®¡ç†ç”Ÿå‘½å‘¨æœŸ å¦ å¦ ä½¿ç”¨ cgroups æ˜¯ æ˜¯ éš”ç¦»ç»´åº¦ èµ„æº èµ„æº + namespace ğŸ‘‰ runc = systemd-run + namespace + rootfs\nå…­ã€systemd èƒ½ä¸èƒ½â€œä»£æ›¿â€ runcï¼Ÿ ç»“è®ºï¼šä¸èƒ½å®Œå…¨ï¼Œä½†å¯ä»¥æ¥è¿‘ systemd æœ‰ï¼š\nsystemd-nspawn systemd-run --property=... åŸç”Ÿ cgroups v2 æ”¯æŒ ä½† systemd ä¸ç­‰åŒäº OCI runtimeï¼š\nèƒ½åŠ› systemd runc OCI è§„èŒƒ âŒ âœ… Namespace ç»„åˆ æœ‰ å®Œæ•´ rootfs ç®¡ç† æœ‰ æ ‡å‡†åŒ– å®¹å™¨ç”Ÿæ€å…¼å®¹ ä½ é«˜ ä¸ƒã€systemd ä¸ runc çš„â€œåä½œæ¨¡å¼â€ ä¸¤ç§ç°å®ä¸–ç•Œçš„å…³ç³» æ¨¡å¼ä¸€ï¼šsystemd ç®¡ç†å®¹å™¨ï¼ˆæ¨èï¼‰ systemd ç®¡ç† cgroups å®¹å™¨è¿è¡Œåœ¨ systemd slice ä¸­ runc åªè´Ÿè´£å¯åŠ¨ ä¾‹å¦‚ï¼š\n# /etc/systemd/system/docker.service [Service] Slice=docker.slice æ¨¡å¼äºŒï¼šsystemd æœ¬èº«å°±æ˜¯å®¹å™¨ init å®¹å™¨å†… PID 1 æ˜¯ systemd å¤–éƒ¨ä»ç„¶æ˜¯ runc å¯åŠ¨ systemd ç®¡ç†å®¹å™¨å†…éƒ¨æœåŠ¡ ğŸ‘‰ è¿™æ˜¯â€œsystemd åœ¨å®¹å™¨é‡Œâ€ï¼Œä¸æ˜¯ systemd ç®¡ runc\nå…«ã€å¸¸è§è¯¯åŒºæ¾„æ¸…ï¼ˆéå¸¸é‡è¦ï¼‰ âŒ è¯¯åŒº 1ï¼šsystemd ç®¡ç† runc ä¸å¯¹ã€‚ systemd ç®¡çš„æ˜¯ è°ƒç”¨ runc çš„æœåŠ¡è¿›ç¨‹ï¼Œä¸æ˜¯ runc æœ¬èº«ã€‚\nâŒ è¯¯åŒº 2ï¼šrunc æ˜¯å¸¸é©»è¿›ç¨‹ ä¸å¯¹ã€‚ runc æ˜¯ fork + exec åç«‹å³é€€å‡º çš„å·¥å…·ã€‚\nâŒ è¯¯åŒº 3ï¼šå®¹å™¨æ˜¯ runc ç®¡çš„ ä¸å¯¹ã€‚ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç”±ä¸Šå±‚ï¼ˆDocker / containerd / CRIï¼‰ç®¡ç†ã€‚\nä¹ã€ä¸€å¥è¯ç»ˆææ€»ç»“ï¼ˆå¯ä»¥å½“å¿ƒæ™ºé”šç‚¹ï¼‰ systemd æ˜¯â€œç³»ç»Ÿçº§è¿›ç¨‹ä¸èµ„æºç®¡ç†è€…â€ï¼Œrunc æ˜¯â€œå®¹å™¨çº§è¿›ç¨‹å¯åŠ¨å™¨â€ã€‚å®ƒä»¬é€šè¿‡ cgroups é—´æ¥åä½œï¼Œä½†ä¸äº’ç›¸ä¾èµ–ã€ä¸äº’ç›¸æ›¿ä»£ã€‚\n","description":"æœ‰å…³ç³»ï¼Œè€Œä¸”å…³ç³»éå¸¸æ¸…æ™°ï¼Œä½†å±‚çº§ä¸€å®šè¦åˆ†æ¸…ã€‚\nå†…å®¹ï¼šç»“è®º -\u0026gt; æ¶æ„å…³ç³» -\u0026gt; å…¸å‹äº¤äº’è·¯å¾„ -\u0026gt; å¸¸è§è¯¯åŒºæ¾„æ¸…ã€‚\nä¸€ã€ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ systemd å’Œ runc ä¸åœ¨åŒä¸€å±‚ï¼Œä½†å®ƒä»¬é€šè¿‡â€œè¿›ç¨‹æ¨¡å‹â€å’Œâ€œcgroupsâ€äº§ç”Ÿäº†é—´æ¥è”ç³»ã€‚\nsystemdï¼šé€šç”¨çš„ ç³»ç»Ÿä¸æœåŠ¡ç®¡ç†å™¨ runcï¼šç¬¦åˆ OCI è§„èŒƒçš„ å®¹å™¨è¿›ç¨‹å¯åŠ¨å™¨ ğŸ‘‰ å®ƒä»¬ä¸æ˜¯äº’ç›¸è°ƒç”¨å…³ç³»ï¼Œè€Œæ˜¯â€œå¯ä»¥åä½œï¼Œä½†äº’ä¸ä¾èµ–â€\näºŒã€å„è‡ªæ˜¯è°ï¼Ÿï¼ˆä¸¥æ ¼å®šä½ï¼‰ 1ï¸âƒ£ systemd æ˜¯ä»€ä¹ˆ systemd æ˜¯ PID 1ï¼Œè´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„ï¼š\n"},{"id":110,"href":"/database/postgres/timescaledb/","title":"TimescaleDB åŸºç¡€æ•™ç¨‹","parent":"PostgreSQL","content":"æ¶µç›–åŸç†ã€æ¶æ„ã€å®‰è£…ã€æœ€ä½³å®è·µã€å¸¸ç”¨åœºæ™¯ã€è¿ç»´ä¸æ€§èƒ½ä¼˜åŒ–ã€‚\nTimescaleDB æ˜¯åŸºäº PostgreSQL çš„ æ—¶åºæ•°æ®åº“æ‰©å±•ï¼Œåœ¨ä¿ç•™ PostgreSQL å…¨åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œå¼ºåŒ–äº†æ—¶åºæ•°æ®çš„å†™å…¥ã€æŸ¥è¯¢ã€å‹ç¼©ã€åˆ†åŒºå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚\nå®ƒéå¸¸é€‚åˆï¼š\nç›‘æ§æ•°æ®ï¼ˆPrometheusã€Zabbixï¼‰ IoT è®¾å¤‡æ•°æ® æ—¥å¿—ã€æŒ‡æ ‡ã€é‡‘èè¡Œæƒ… å·¥ä¸šæ—¶é—´åºåˆ—æ•°æ® 1. TimescaleDB çš„æ ¸å¿ƒæ€æƒ³ TimescaleDB çš„åº•å±‚é€»è¾‘åªæœ‰ä¸¤ä»¶äº‹ï¼š\nâ‘  å°†è¡¨å˜æˆ hypertableï¼ˆè¶…è¡¨ï¼‰ è¶…è¡¨è‡ªåŠ¨è¿›è¡Œåˆ†åŒºï¼ˆchunksï¼‰ï¼š\næ—¶é—´ç»´åº¦è‡ªåŠ¨åˆ†ç‰‡ ç©ºé—´ç»´åº¦å¯é€‰ï¼ˆå¦‚ device_idã€tenant_idï¼‰ â‘¡ é€šè¿‡æ‰©å±•å¢å¼º PostgreSQL é«˜é€Ÿå†™å…¥ä¼˜åŒ– å‹ç¼© chunk è¿ç»­èšåˆï¼ˆContinuous Aggregatesï¼‰ æ•°æ®è‡ªåŠ¨æ¸…ç†ã€ä¿ç•™ç­–ç•¥ æ—¶é—´åºåˆ—å‡½æ•°ï¼ˆtime_bucketã€histogram ç­‰ï¼‰ âš ï¸ æœ¬è´¨ä»ç„¶æ˜¯ PostgreSQLï¼Œæ‰€ä»¥ä½ æ‰€æœ‰ PostgreSQL åŠŸèƒ½éƒ½èƒ½ç”¨ï¼ˆSQLã€ç´¢å¼•ã€å¤‡ä»½ã€äº‹åŠ¡ç­‰ï¼‰ã€‚\n2. TimescaleDB çš„æ¶æ„ PostgreSQL â””â”€â”€ TimescaleDB Extension â”œâ”€â”€ Hypertable ç®¡ç† â”œâ”€â”€ Chunks åˆ†é…ä¸è°ƒåº¦ â”œâ”€â”€ å‹ç¼©å¼•æ“ â”œâ”€â”€ Continuous Aggregates â”œâ”€â”€ Background Workers â””â”€â”€ Retention Policies ç”±äºæ˜¯æ‰©å±•æ–¹å¼ï¼ŒTimescaleDB å¯ä»¥åšåˆ°ï¼š\nä¸éœ€è¦æ¢æ•°æ®åº“ ä¸éœ€è¦æ–°çš„å®¢æˆ·ç«¯åè®® æ— å­¦ä¹ æˆæœ¬ 3. å®‰è£…ä¸å¯ç”¨ï¼ˆPostgreSQL + TimescaleDBï¼‰ åœ¨ Debian/Ubuntuï¼š\nsudo apt install timescaledb-2-postgresql-17 åœ¨ PostgreSQL ä¸­å¯ç”¨ï¼š\nCREATE EXTENSION IF NOT EXISTS timescaledb; 4. åˆ›å»º hypertableï¼ˆè¶…è¡¨ï¼‰ 1. å»ºè¡¨ CREATE TABLE metrics ( time TIMESTAMPTZ NOT NULL, device_id int, value double precision, tags jsonb ); 2. è½¬ä¸º hypertable SELECT create_hypertable(\u0026#39;metrics\u0026#39;, \u0026#39;time\u0026#39;); å¯é€‰ï¼šæŒ‰è®¾å¤‡åˆ†åŒºï¼ˆç©ºé—´ç»´åº¦åˆ†ç‰‡ï¼‰\nSELECT create_hypertable(\u0026#39;metrics\u0026#39;, \u0026#39;time\u0026#39;, \u0026#39;device_id\u0026#39;); 5. Hypertable çš„æœ€ä½³å®è·µ åœºæ™¯ chunk æ—¶é—´é—´éš”ï¼ˆæ¨èï¼‰ Prometheus æŒ‡æ ‡ 1 å¤© IoT è®¾å¤‡ 1~7 å¤© äº¤æ˜“è¡Œæƒ…/é«˜é¢‘æ•°æ® 1 å°æ—¶ æ—¥å¿— 1 å¤©æˆ– 1 å‘¨ è®¾ç½® chunk å¤§å°çº¦ä¸º 256MB ~ 1GB æœ€ä½³ã€‚\n6. æ•°æ®å‹ç¼©ï¼ˆéå¸¸å¼ºå¤§ï¼‰ TimescaleDB æä¾› åˆ—å¼å‹ç¼©ï¼š\nALTER TABLE metrics SET (timescaledb.compress); SELECT compress_chunk(i) FROM show_chunks(\u0026#39;metrics\u0026#39;) as i; è‡ªåŠ¨å‹ç¼©ç­–ç•¥ï¼š\nSELECT add_compression_policy(\u0026#39;metrics\u0026#39;, INTERVAL \u0026#39;7 days\u0026#39;); ğŸ’¡ å¸¸ç”¨ï¼šä¿ç•™æœ€è¿‘ 7 å¤©æœªå‹ç¼©æ•°æ®ç”¨äºå¿«é€ŸæŸ¥è¯¢ï¼Œè€æ•°æ®å…¨éƒ¨å‹ç¼©ã€‚\nå‹ç¼©æ¯”å¯è¾¾ 10xï½30xã€‚\n7. è¿ç»­èšåˆï¼ˆContinuous Aggregatesï¼‰ ç±»ä¼¼â€œç‰©åŒ–è§†å›¾ + è‡ªåŠ¨å¢é‡æ›´æ–°â€ï¼Œéå¸¸é€‚åˆï¼š\næŒ‰ 1 åˆ†é’Ÿ/5 åˆ†é’Ÿ/1 å°æ—¶èšåˆæŒ‡æ ‡ IoT ç»Ÿè®¡ Dashboard æŸ¥è¯¢åŠ é€Ÿ ç¤ºä¾‹ï¼šæ¯ 1 åˆ†é’Ÿæ±‚å¹³å‡å€¼\nCREATE MATERIALIZED VIEW metrics_1m WITH (timescaledb.continuous) AS SELECT time_bucket(\u0026#39;1 min\u0026#39;, time) AS bucket, device_id, avg(value) AS avg_value FROM metrics GROUP BY bucket, device_id; è‡ªåŠ¨åˆ·æ–°ç­–ç•¥ï¼š\nSELECT add_continuous_aggregate_policy( \u0026#39;metrics_1m\u0026#39;, start_offset =\u0026gt; INTERVAL \u0026#39;1 day\u0026#39;, end_offset =\u0026gt; INTERVAL \u0026#39;1 min\u0026#39; ); 8. æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆRetentionï¼‰ è‡ªåŠ¨åˆ é™¤æ—§æ•°æ®ï¼š\nSELECT add_retention_policy(\u0026#39;metrics\u0026#39;, INTERVAL \u0026#39;90 days\u0026#39;); æ”¯æŒï¼š\nåªåˆ é™¤æœªå‹ç¼©æ•°æ® åˆ é™¤å‹ç¼© chunk å¤šè¡¨è”åŠ¨æ¸…ç† 9. æ—¶åºå‡½æ•°ï¼ˆå¿…å¤‡ï¼‰ å¸¸ç”¨å‡½æ•°ï¼š\nå‡½æ•° ç”¨é€” time_bucket() åˆ†ç»„èšåˆï¼Œä»£æ›¿ date_trunc time_bucket_gapfill() è‡ªåŠ¨è¡¥é½æ—¶é—´ç©ºæ´ histogram() ç»Ÿè®¡åˆ†å¸ƒ approx_percentile() é«˜é€Ÿç™¾åˆ†ä½è®¡ç®— first() / last() é«˜é€ŸæŸ¥é¦–å°¾å€¼ ç¤ºä¾‹ï¼šè¡¥é½ç¼ºå¤±åˆ†é’Ÿ\nSELECT time_bucket_gapfill(\u0026#39;1 min\u0026#39;, time), avg(value) FROM metrics WHERE time \u0026gt; now() - interval \u0026#39;1 hour\u0026#39; GROUP BY 1; 10. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µï¼ˆç”Ÿäº§å¿…åšï¼‰ 1. å¼€å¯å¹¶ä½¿ç”¨ TimescaleDB è‡ªåŠ¨è°ƒä¼˜ SELECT * FROM timescaledb_tune(); 2. å†™å…¥ä¼˜åŒ– æ‰¹é‡å†™å…¥ï¼ˆCOPYã€æ‰¹é‡ INSERTï¼‰ é¿å…å•è¡Œæ’å…¥ è‡ªåŠ¨åˆ†åŒºå‡è½» IO å‹åŠ› 3. æ­£ç¡®è®¾ç½®ç´¢å¼• é€šå¸¸åªéœ€è¦ï¼š\nCREATE INDEX ON metrics (time DESC); CREATE INDEX ON metrics (device_id); 4. è®¾ç½®åˆé€‚çš„ chunk å¤§å° æ§åˆ¶åœ¨ 256MBï½1GB å·¦å³ é¿å… chunk è¿‡å¤šï¼ˆ\u0026gt;5000 æ—¶ä¼šæ˜æ˜¾ä¸‹é™ï¼‰ 5. è°ƒæ•´ autovacuum ç¡®ä¿ chunk å°ã€VACUUM å¿«ã€‚\n11. å¸¸è§æ•°æ®æ¨¡å‹ æ¨¡å‹ 1ï¼šIoT è®¾å¤‡ time TIMESTAMPTZ device_id INT value DOUBLE metadata JSONB æ¨¡å‹ 2ï¼šPrometheus æŒ‡æ ‡æ›¿ä»£ç‰ˆï¼ˆæ¯” Prom æ›´å¿«ï¼‰ metric time labels JSONB value 12. ä¸ InfluxDB / Prometheus çš„æ¯”è¾ƒ ç‰¹æ€§ TimescaleDB InfluxDB Prometheus åº•å±‚ PostgreSQL ä¸“æœ‰å¼•æ“ ä¸“æœ‰å¼•æ“ SQL âœ… å®Œæ•´ SQL âŒ Flux/SQL å˜ç§ âŒ PromQL Join æŸ¥è¯¢ âœ… ä¸æ”¯æŒ ä¸æ”¯æŒ æŒä¹…åŒ– å¼º å¼± å¼± é›†ç¾¤ PostgreSQL è‡ªå¸¦æ–¹æ¡ˆ æœ‰å•†ä¸šç‰ˆ æ—  å‹ç¼© å¼ºï¼ˆ10~30xï¼‰ ä¸­ å¼± æ€»ç»“ï¼šPostgreSQL å…¼å®¹æ€§ + æ—¶åºæ€§èƒ½ = TimescaleDB æœ€å¤§ä¼˜åŠ¿ã€‚\n13. ç”Ÿäº§éƒ¨ç½²çš„æœ€ä½³æ¶æ„ æœ€ç†æƒ³ï¼š\nPostgreSQL 17 (å¸¦ TimescaleDB) â””â”€â”€ Patroni é«˜å¯ç”¨ â”œâ”€â”€ etcd/consul â”œâ”€â”€ streaming replication â””â”€â”€ vip æˆ– haproxy è´Ÿè½½ 14. å¦‚æœä½ è¦å¤§è§„æ¨¡ä½¿ç”¨ï¼ˆç™¾ä¸‡è®¾å¤‡ã€TD çº§æ•°æ®ï¼‰ TimescaleDB çš„ scaling æ–¹æ¡ˆï¼š\nåŠŸèƒ½ æ˜¯å¦å¯è¡Œ æ°´å¹³æ‰©å±•ï¼ˆå¤šèŠ‚ç‚¹ï¼‰ âœ…ï¼ˆTimescaleDB multi-nodeï¼‰ ä¸€ä¸»å¤šä» âœ… åˆ†è¡¨åˆ†åŒº è‡ªåŠ¨ è‡ªåŠ¨å‹ç¼© âœ… è‡ªåŠ¨å†·çƒ­åˆ†å±‚ âœ… ","description":"æ¶µç›–åŸç†ã€æ¶æ„ã€å®‰è£…ã€æœ€ä½³å®è·µã€å¸¸ç”¨åœºæ™¯ã€è¿ç»´ä¸æ€§èƒ½ä¼˜åŒ–ã€‚\nTimescaleDB æ˜¯åŸºäº PostgreSQL çš„ æ—¶åºæ•°æ®åº“æ‰©å±•ï¼Œåœ¨ä¿ç•™ PostgreSQL å…¨åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œå¼ºåŒ–äº†æ—¶åºæ•°æ®çš„å†™å…¥ã€æŸ¥è¯¢ã€å‹ç¼©ã€åˆ†åŒºå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚\nå®ƒéå¸¸é€‚åˆï¼š\nç›‘æ§æ•°æ®ï¼ˆPrometheusã€Zabbixï¼‰ IoT è®¾å¤‡æ•°æ® æ—¥å¿—ã€æŒ‡æ ‡ã€é‡‘èè¡Œæƒ… å·¥ä¸šæ—¶é—´åºåˆ—æ•°æ® 1. TimescaleDB çš„æ ¸å¿ƒæ€æƒ³ TimescaleDB çš„åº•å±‚é€»è¾‘åªæœ‰ä¸¤ä»¶äº‹ï¼š\nâ‘  å°†è¡¨å˜æˆ hypertableï¼ˆè¶…è¡¨ï¼‰ è¶…è¡¨è‡ªåŠ¨è¿›è¡Œåˆ†åŒºï¼ˆchunksï¼‰ï¼š\næ—¶é—´ç»´åº¦è‡ªåŠ¨åˆ†ç‰‡ ç©ºé—´ç»´åº¦å¯é€‰ï¼ˆå¦‚ device_idã€tenant_idï¼‰ â‘¡ é€šè¿‡æ‰©å±•å¢å¼º PostgreSQL é«˜é€Ÿå†™å…¥ä¼˜åŒ– å‹ç¼© chunk è¿ç»­èšåˆï¼ˆContinuous Aggregatesï¼‰ æ•°æ®è‡ªåŠ¨æ¸…ç†ã€ä¿ç•™ç­–ç•¥ æ—¶é—´åºåˆ—å‡½æ•°ï¼ˆtime_bucketã€histogram ç­‰ï¼‰ âš ï¸ æœ¬è´¨ä»ç„¶æ˜¯ PostgreSQLï¼Œæ‰€ä»¥ä½ æ‰€æœ‰ PostgreSQL åŠŸèƒ½éƒ½èƒ½ç”¨ï¼ˆSQLã€ç´¢å¼•ã€å¤‡ä»½ã€äº‹åŠ¡ç­‰ï¼‰ã€‚\n"},{"id":111,"href":"/operations/linux/kernel-relationship/","title":"Linux å†…æ ¸ç©ºé—´äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿ ä¸ namespacesã€cgroups ç­‰ç­‰çš„å…³ç³»","parent":"Linux","content":"Linux å†…æ ¸ç©ºé—´æœ‰äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼Œnamespacesï¼Œcgroupsï¼ŒUnionFSï¼ŒNUMAï¼Œrunc ç­‰ç­‰ï¼Œä¸äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ã€ä½†ç»å¸¸è¢«è®²ä¹±çš„é—®é¢˜ã€‚\næŒ‰ å†…æ ¸è§†è§’ -\u0026gt; æœºåˆ¶å½’å± -\u0026gt; å…³ç³»æ˜ å°„ï¼Œä¸€æ¬¡æ€§æŠŠå®ƒç†æ¸…æ¥šã€‚\nä¸€ã€å…ˆå®šé”šï¼šLinux å†…æ ¸çš„â€œäº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿâ€æ˜¯ä»€ä¹ˆ å†…æ ¸ç©ºé—´çš„äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼ˆè¿™æ˜¯â€œå†…æ ¸å†…éƒ¨ç»“æ„â€çš„åˆ’åˆ†ï¼‰ï¼š\nè¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰ å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰ æ–‡ä»¶ç³»ç»Ÿï¼ˆVFS / FSï¼‰ ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices / Driversï¼‰ ğŸ‘‰ å®ƒä»¬æ˜¯ å†…æ ¸çš„åŸºç¡€åŠŸèƒ½æ¨¡å—ï¼Œå†³å®šäº† Linux èƒ½ä¸èƒ½è¿è¡Œç¨‹åºã€ç”¨å†…å­˜ã€è¯»å†™æ–‡ä»¶ã€æ”¶å‘ç½‘ç»œã€é©±åŠ¨ç¡¬ä»¶ã€‚\näºŒã€namespaces / cgroups / UnionFS / NUMA / runc æ˜¯ä»€ä¹ˆå±‚çº§çš„ä¸œè¥¿ï¼Ÿ ç»“è®ºå…ˆç»™å‡ºï¼š\nå®ƒä»¬ä¸æ˜¯ç¬¬å…­ã€ç¬¬ä¸ƒä¸ªâ€œæ ¸å¿ƒå­ç³»ç»Ÿâ€ è€Œæ˜¯æ„å»ºåœ¨äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿä¹‹ä¸Šçš„â€œå†…æ ¸æœºåˆ¶ / èµ„æºç®¡ç†æ¨¡å‹ / ç”¨æˆ·æ€æ§åˆ¶å·¥å…·â€\nä¸‰ã€é€ä¸€è¯´æ˜ï¼šå®ƒä»¬åˆ†åˆ«â€œä¾é™„â€åœ¨å“ªäº›æ ¸å¿ƒå­ç³»ç»Ÿä¸Š 1ï¸âƒ£ namespacesï¼ˆå‘½åç©ºé—´ï¼‰ æœ¬è´¨ï¼š ğŸ‘‰ éš”ç¦»è§†å›¾ï¼ˆè®©è¿›ç¨‹â€œçœ‹åˆ°çš„ä¸–ç•Œâ€ä¸åŒï¼‰\nå½’å±å…³ç³»ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š\nNamespace ç±»å‹ ä¾èµ–çš„æ ¸å¿ƒå­ç³»ç»Ÿ PID namespace è¿›ç¨‹ç®¡ç† Mount namespace æ–‡ä»¶ç³»ç»Ÿ Network namespace ç½‘ç»œå­ç³»ç»Ÿ IPC namespace è¿›ç¨‹ç®¡ç† UTS namespace è¿›ç¨‹ç®¡ç† User namespace è¿›ç¨‹ç®¡ç† + æƒé™æ¨¡å‹ âœ… ç»“è®º\nnamespaces ä¸æ˜¯ç‹¬ç«‹å­ç³»ç»Ÿ å®ƒæ˜¯ å¯¹â€œè¿›ç¨‹ / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œâ€ç­‰æ ¸å¿ƒå­ç³»ç»Ÿåšâ€œè§†å›¾éš”ç¦»â€\n2ï¸âƒ£ cgroupsï¼ˆæ§åˆ¶ç»„ï¼‰ æœ¬è´¨ï¼š ğŸ‘‰ é™åˆ¶ä¸ç»Ÿè®¡èµ„æºä½¿ç”¨\nå½’å±å…³ç³»ï¼š\næ§åˆ¶å¯¹è±¡ å¯¹åº”æ ¸å¿ƒå­ç³»ç»Ÿ CPU é…é¢ / è°ƒåº¦ è¿›ç¨‹ç®¡ç† å†…å­˜ä¸Šé™ / OOM å†…å­˜ç®¡ç† å— IO é™é€Ÿ æ–‡ä»¶ç³»ç»Ÿ / å—è®¾å¤‡ ç½‘ç»œæµé‡ ç½‘ç»œå­ç³»ç»Ÿ âœ… ç»“è®º\ncgroups æ˜¯ å¯¹äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿâ€œèµ„æºåˆ†é…èƒ½åŠ›â€çš„ç»Ÿä¸€å°è£…\n3ï¸âƒ£ UnionFS / overlayfs / overlay2 æœ¬è´¨ï¼š ğŸ‘‰ æ–‡ä»¶ç³»ç»Ÿå åŠ æœºåˆ¶\nå½’å±å…³ç³»ï¼š\nç»„ä»¶ å½’å± VFS æ–‡ä»¶ç³»ç»Ÿæ ¸å¿ƒ overlayfs æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ overlay2 Docker å¯¹ overlayfs çš„ä½¿ç”¨æ–¹å¼ âœ… ç»“è®º\nUnionFS / overlayfs å®Œå…¨å±äºæ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿå†…éƒ¨\n4ï¸âƒ£ NUMAï¼ˆéä¸€è‡´å†…å­˜è®¿é—®ï¼‰ æœ¬è´¨ï¼š ğŸ‘‰ ç¡¬ä»¶å†…å­˜æ‹“æ‰‘æ„ŸçŸ¥æ¨¡å‹\nå½’å±å…³ç³»ï¼š\nå½±å“å¯¹è±¡ å†…æ ¸å­ç³»ç»Ÿ å†…å­˜åˆ†é… å†…å­˜ç®¡ç† CPU äº²å’Œæ€§ è¿›ç¨‹ç®¡ç† ä¸­æ–­åˆ†é… è®¾å¤‡ä¸é©±åŠ¨ âœ… ç»“è®º\nNUMA æ˜¯ å†…å­˜ç®¡ç† + è¿›ç¨‹è°ƒåº¦ + ç¡¬ä»¶æ‹“æ‰‘çš„ç»„åˆæœºåˆ¶\n5ï¸âƒ£ runc æœ¬è´¨ï¼š ğŸ‘‰ ç”¨æˆ·æ€å®¹å™¨è¿è¡Œå™¨\næ³¨æ„ï¼š âš ï¸ runc ä¸åœ¨å†…æ ¸ä¸­\nå®ƒåšçš„äº‹æ˜¯ï¼š\nè°ƒç”¨ clone() -\u0026gt; åˆ›å»ºè¿›ç¨‹ é…ç½® namespaces -\u0026gt; éš”ç¦»è§†å›¾ é…ç½® cgroups -\u0026gt; é™åˆ¶èµ„æº è®¾ç½® rootfs -\u0026gt; ä½¿ç”¨ overlayfs æœ€ç»ˆ execve() -\u0026gt; å¯åŠ¨åº”ç”¨è¿›ç¨‹ âœ… ç»“è®º\nrunc æ˜¯ ç”¨æˆ·ç©ºé—´å¯¹å†…æ ¸èƒ½åŠ›çš„â€œç¼–æ’å™¨â€\nå››ã€ç»Ÿä¸€å…³ç³»æ€»å›¾ï¼ˆè¿™æ˜¯æ ¸å¿ƒç†è§£ï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç”¨æˆ·ç©ºé—´ â”‚ â”‚ â”‚ â”‚ Docker / Podman / containerd â”‚ â”‚ â”‚ â”‚ â”‚ runc â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ ç³»ç»Ÿè°ƒç”¨ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Linux å†…æ ¸ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ è¿›ç¨‹ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ PID / è°ƒåº¦ / namespace â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ å†…å­˜ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ é¡µåˆ†é… / NUMA / cgroups â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ æ–‡ä»¶ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ VFS / overlayfs / UnionFS â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ ç½‘ç»œå­ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ netns / veth / iptables â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€ è®¾å¤‡ä¸é©±åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ å—è®¾å¤‡ / ç½‘å¡ / ä¸­æ–­ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ äº”ã€ä¸€å¥è¯æç®€æ€»ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥èƒŒï¼‰ äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼šå†…æ ¸çš„â€œåŸºç¡€èƒ½åŠ›â€ namespacesï¼šéš”ç¦»è¿™äº›èƒ½åŠ›çš„â€œè§†å›¾â€ cgroupsï¼šé™åˆ¶è¿™äº›èƒ½åŠ›çš„â€œé¢åº¦â€ UnionFS / overlayfsï¼šæ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿçš„ä¸€ç§å®ç° NUMAï¼šå†…å­˜ä¸ CPU çš„ç¡¬ä»¶æ‹“æ‰‘ä¼˜åŒ–æœºåˆ¶ runcï¼šç”¨æˆ·æ€å¯¹å†…æ ¸èƒ½åŠ›çš„ç»Ÿä¸€è°ƒç”¨è€… å…­ã€å†ç»™ä½ ä¸€ä¸ªâ€œåˆ¤æ–­æ ‡å‡†â€ å‡¡æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å®ç°çš„éš”ç¦»ä¸é™åˆ¶ -\u0026gt; å†…æ ¸æœºåˆ¶ å‡¡æ˜¯ç»„åˆè¿™äº›æœºåˆ¶å¹¶å¯åŠ¨è¿›ç¨‹ -\u0026gt; ç”¨æˆ·æ€å·¥å…·\n","description":"Linux å†…æ ¸ç©ºé—´æœ‰äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼Œnamespacesï¼Œcgroupsï¼ŒUnionFSï¼ŒNUMAï¼Œrunc ç­‰ç­‰ï¼Œä¸äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ã€ä½†ç»å¸¸è¢«è®²ä¹±çš„é—®é¢˜ã€‚\næŒ‰ å†…æ ¸è§†è§’ -\u0026gt; æœºåˆ¶å½’å± -\u0026gt; å…³ç³»æ˜ å°„ï¼Œä¸€æ¬¡æ€§æŠŠå®ƒç†æ¸…æ¥šã€‚\nä¸€ã€å…ˆå®šé”šï¼šLinux å†…æ ¸çš„â€œäº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿâ€æ˜¯ä»€ä¹ˆ å†…æ ¸ç©ºé—´çš„äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼ˆè¿™æ˜¯â€œå†…æ ¸å†…éƒ¨ç»“æ„â€çš„åˆ’åˆ†ï¼‰ï¼š\nè¿›ç¨‹ç®¡ç†ï¼ˆProcessï¼‰ å†…å­˜ç®¡ç†ï¼ˆMemoryï¼‰ æ–‡ä»¶ç³»ç»Ÿï¼ˆVFS / FSï¼‰ ç½‘ç»œå­ç³»ç»Ÿï¼ˆNetworkingï¼‰ è®¾å¤‡ä¸é©±åŠ¨ï¼ˆDevices / Driversï¼‰ ğŸ‘‰ å®ƒä»¬æ˜¯ å†…æ ¸çš„åŸºç¡€åŠŸèƒ½æ¨¡å—ï¼Œå†³å®šäº† Linux èƒ½ä¸èƒ½è¿è¡Œç¨‹åºã€ç”¨å†…å­˜ã€è¯»å†™æ–‡ä»¶ã€æ”¶å‘ç½‘ç»œã€é©±åŠ¨ç¡¬ä»¶ã€‚\näºŒã€namespaces / cgroups / UnionFS / NUMA / runc æ˜¯ä»€ä¹ˆå±‚çº§çš„ä¸œè¥¿ï¼Ÿ ç»“è®ºå…ˆç»™å‡ºï¼š\n"},{"id":112,"href":"/operations/linux/overlay2-not-good-to-database/","title":"overlay2 ä¸ºä»€ä¹ˆå¯¹æ•°æ®åº“ä¸å‹å¥½","parent":"Linux","content":"è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ã€ä¹Ÿéå¸¸å®¹æ˜“è¢«è¯¯è§£çš„é—®é¢˜ã€‚\nå†…å®¹ï¼šç»“è®ºå…ˆè¡Œ -\u0026gt; åŸç†æ‹†è§£ -\u0026gt; å®æˆ˜å±‚é¢çš„åˆ¤æ–­æ ‡å‡†ï¼Œå’Œ UnionFS / overlay2 / å†…æ ¸ / æ•°æ®åº“ ä¸²èµ·æ¥ã€‚\nä¸€å¥è¯ç»“è®ºï¼ˆå…ˆèƒŒä¸‹æ¥ï¼‰ overlay2 ä¸é€‚åˆæ•°æ®åº“çš„æ ¹æœ¬åŸå› æ˜¯ï¼š æ•°æ®åº“éœ€è¦â€œç¨³å®šã€å¯é¢„æµ‹ã€é¡ºåºä¸€è‡´çš„æœ¬åœ°å†™å…¥â€ï¼Œ è€Œ overlay2 æä¾›çš„æ˜¯â€œåˆ†å±‚ + å†™æ—¶å¤åˆ¶ + é—´æ¥è·¯å¾„â€çš„æ–‡ä»¶è¯­ä¹‰ã€‚\nä¸€ã€overlay2 çš„è®¾è®¡ç›®æ ‡ â‰  æ•°æ®åº“çš„éœ€æ±‚ overlay2 ä¸ºè°è®¾è®¡ï¼Ÿ é•œåƒåˆ†å±‚ å®¹å™¨å¿«é€Ÿå¯åŠ¨ æ–‡ä»¶å…±äº« å†™å°‘ã€è¯»å¤š åº”ç”¨æ— çŠ¶æ€ æ•°æ®åº“éœ€è¦ä»€ä¹ˆï¼Ÿ é«˜é¢‘å°å†™ fsync / fdatasync å¼ºä¸€è‡´ é¡ºåºå†™ï¼ˆWAL / redo / binlogï¼‰ ç¨³å®š inode å¯é¢„æµ‹çš„ IO å»¶è¿Ÿ ğŸ‘‰ ç›®æ ‡å®Œå…¨ç›¸å\näºŒã€overlay2 å¯¹æ•°æ®åº“â€œè‡´å‘½â€çš„ 6 ä¸ªåŸå›  1ï¸âƒ£ å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰æ”¾å¤§å†™å…¥ overlay2 å†™æ–‡ä»¶çš„çœŸå®è¿‡ç¨‹ï¼š\nå†™æ–‡ä»¶ â†“ åˆ¤æ–­æ˜¯å¦åœ¨ lowerdir â†“ å¤åˆ¶æ•´ä¸ªæ–‡ä»¶åˆ° upperdir â†“ å†å†™ å¯¹æ•°æ®åº“æ„å‘³ç€ï¼š\nWAL æ–‡ä»¶ redo log æ•°æ®æ–‡ä»¶ ğŸ‘‰ ä¸€æ¬¡å°å†™ï¼Œå¯èƒ½è§¦å‘æ•´æ–‡ä»¶å¤åˆ¶\nğŸ“Œ ç»“æœï¼š\nIO æ”¾å¤§ å»¶è¿ŸæŠ–åŠ¨ å†™æ€§èƒ½ä¸å¯é¢„æµ‹ 2ï¸âƒ£ å¤šå±‚è·¯å¾„å¯¼è‡´ fsync ä¸å†â€œç›´è¾¾ç£ç›˜â€ æ•°æ®åº“è®¤ä¸ºï¼š\nfsync() = æ•°æ®å·²å®‰å…¨è½ç›˜ ä½† overlay2 å®é™…è·¯å¾„æ˜¯ï¼š\næ•°æ®åº“ -\u0026gt; VFS -\u0026gt; overlayfs -\u0026gt; upperdir -\u0026gt; å®¿ä¸»æ–‡ä»¶ç³»ç»Ÿ âš ï¸ é—®é¢˜ï¼š\nfsync åœ¨ overlay å±‚å®Œæˆ ä¸ç­‰ä»·äºç‰©ç†ç£ç›˜ flush ç‰¹å®šå†…æ ¸ç‰ˆæœ¬ä¸‹å­˜åœ¨ fsync è¯­ä¹‰æ¼æ´ ğŸ‘‰ æ•°æ®åº“æœ€æ€•â€œæˆ‘ä»¥ä¸ºå†™æˆåŠŸäº†ï¼Œå…¶å®æ²¡æœ‰â€\n3ï¸âƒ£ inode / dentry ä¸ç¨³å®šï¼ˆæ•°æ®åº“å¾ˆæ•æ„Ÿï¼‰ overlay2 çš„æ–‡ä»¶ï¼š\nå¯èƒ½è¢« copy-up inode ä¼šå˜åŒ– hard link / rename è¡Œä¸ºä¸ä¸€è‡´ æ•°æ®åº“ä¾èµ–ï¼š\ninode ç¨³å®šæ€§ rename åŸå­æ€§ æ–‡ä»¶å…ƒæ•°æ®ä¸€è‡´æ€§ ğŸ“Œ å†å²ä¸Šï¼š\nPostgreSQL MySQL InnoDB éƒ½æ›¾æ˜ç¡®æŒ‡å‡ºï¼š\nUnionFS ä¸å®Œå…¨ç¬¦åˆæ•°æ®åº“æ–‡ä»¶ç³»ç»Ÿå‡è®¾\n4ï¸âƒ£ overlay2 å¯¹å°æ–‡ä»¶ \u0026amp; é«˜é¢‘å†™æå·® æ•°æ®åº“çš„ IO æ¨¡å¼ï¼š\n8KB / 16KB page é«˜é¢‘éšæœºå†™ redo / wal é¡ºåºè¿½åŠ  overlay2ï¼š\nå¤šå±‚ lookup metadata æ“ä½œå¤š dentry cache å‹åŠ›å¤§ ğŸ‘‰ IO å»¶è¿Ÿå°¾éƒ¨æé•¿ï¼ˆP99ã€P999ï¼‰\n5ï¸âƒ£ å´©æºƒæ¢å¤é£é™©ï¼ˆæœ€è¦å‘½ï¼‰ overlay2 + æ•°æ®åº“ï¼š\nå®¿ä¸»æœº crash å®¹å™¨ crash å¼ºåˆ¶ kill âš ï¸ é£é™©ç‚¹ï¼š\noverlay å±‚çŠ¶æ€æœªå®Œå…¨ sync workdir ä¸­é—´çŠ¶æ€ æ•°æ®æ–‡ä»¶ä¸ WAL ä¸ä¸€è‡´ ğŸ‘‰ æ•°æ®åº“æœ€æ€•â€œæ¢å¤ä¸äº†â€\n6ï¸âƒ£ è¿ç»´å±‚é¢æ— æ³•ç²¾ç»†è°ƒä¼˜ æ•°æ®åº“é€šå¸¸è¦è°ƒï¼š\nfilesystem mount options barrier / journal discard / noatime direct IO overlay2ï¼š\nmount æ˜¯ Docker ç®¡ å®¹å™¨å†…ä¸å¯æ§ æ•°æ®åº“è°ƒä¼˜å¤±æ•ˆ ä¸‰ã€overlay2 + æ•°æ®åº“ = â€œèƒ½è·‘ â‰  é€‚åˆè·‘â€ åœºæ™¯ æ˜¯å¦å»ºè®® æœ¬åœ°å¼€å‘ âœ… CI / æµ‹è¯• âœ… Demo âœ… ç”Ÿäº§æ•°æ®åº“ âŒ é«˜å¹¶å‘ / é«˜å¯é  âŒ å››ã€é‚£äº‘å‚å•†ä¸ºä»€ä¹ˆâ€œç”¨å®¹å™¨è·‘æ•°æ®åº“çœ‹èµ·æ¥å¾ˆç¨³â€ï¼Ÿ è¿™å’Œä½ å‰ä¸€ä¸ªé—®é¢˜æ­£å¥½æ¥ä¸Š ğŸ‘‡\näº‘å‚å•†çš„çœŸå®åšæ³• âŒ ä¸æ˜¯ overlay2 ä¸Šç›´æ¥å†™æ•°æ®\nè€Œæ˜¯ï¼š\nå±‚çº§ åšæ³• å®¹å™¨ åªè·‘æ•°æ®åº“è¿›ç¨‹ æ•°æ®ç›®å½• bind mount / block device æ–‡ä»¶ç³»ç»Ÿ ext4 / xfs ç›´å†™ å­˜å‚¨ æœ¬åœ° SSD / NVMe / ç½‘ç»œå—å­˜å‚¨ cgroups ç²¾ç»†éš”ç¦» å†…æ ¸ ä¸“é—¨è°ƒä¼˜ ğŸ“Œ å…³é”®ç‚¹ï¼š\n/var/lib/mysql -\u0026gt; ä¸åœ¨ overlay2 -\u0026gt; åœ¨çœŸå®æ–‡ä»¶ç³»ç»Ÿ äº”ã€æ­£ç¡®å§¿åŠ¿ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰ âœ… æ­£ç¡®æ–¹æ¡ˆ 1ï¼šbind mount docker run \\ -v /data/mysql:/var/lib/mysql \\ mysql æ•°æ®ç»•è¿‡ overlay2ï¼Œç›´å†™å®¿ä¸»æœº FS\nâœ… æ­£ç¡®æ–¹æ¡ˆ 2ï¼šblock device LVM iSCSI äº‘ç›˜ --mount type=bind,source=/dev/mapper/mysql,target=/var/lib/mysql âŒ é”™è¯¯æ–¹æ¡ˆ docker run mysql ## æ•°æ®å†™åœ¨ overlay2 å…­ã€æœ€ç»ˆä¸€å¥è¯ï¼ˆéå¸¸ç¡¬ï¼‰ overlay2 é€‚åˆâ€œåº”ç”¨å±‚æ–‡ä»¶â€ï¼Œä¸é€‚åˆâ€œæ•°æ®åº“å­˜å‚¨å±‚æ–‡ä»¶â€ã€‚ æ•°æ®åº“å¿…é¡»ç»•è¿‡ UnionFSï¼Œç›´è¾¾çœŸå®æ–‡ä»¶ç³»ç»Ÿã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ã€ä¹Ÿéå¸¸å®¹æ˜“è¢«è¯¯è§£çš„é—®é¢˜ã€‚\nå†…å®¹ï¼šç»“è®ºå…ˆè¡Œ -\u0026gt; åŸç†æ‹†è§£ -\u0026gt; å®æˆ˜å±‚é¢çš„åˆ¤æ–­æ ‡å‡†ï¼Œå’Œ UnionFS / overlay2 / å†…æ ¸ / æ•°æ®åº“ ä¸²èµ·æ¥ã€‚\nä¸€å¥è¯ç»“è®ºï¼ˆå…ˆèƒŒä¸‹æ¥ï¼‰ overlay2 ä¸é€‚åˆæ•°æ®åº“çš„æ ¹æœ¬åŸå› æ˜¯ï¼š æ•°æ®åº“éœ€è¦â€œç¨³å®šã€å¯é¢„æµ‹ã€é¡ºåºä¸€è‡´çš„æœ¬åœ°å†™å…¥â€ï¼Œ è€Œ overlay2 æä¾›çš„æ˜¯â€œåˆ†å±‚ + å†™æ—¶å¤åˆ¶ + é—´æ¥è·¯å¾„â€çš„æ–‡ä»¶è¯­ä¹‰ã€‚\nä¸€ã€overlay2 çš„è®¾è®¡ç›®æ ‡ â‰  æ•°æ®åº“çš„éœ€æ±‚ overlay2 ä¸ºè°è®¾è®¡ï¼Ÿ é•œåƒåˆ†å±‚ å®¹å™¨å¿«é€Ÿå¯åŠ¨ æ–‡ä»¶å…±äº« å†™å°‘ã€è¯»å¤š åº”ç”¨æ— çŠ¶æ€ æ•°æ®åº“éœ€è¦ä»€ä¹ˆï¼Ÿ é«˜é¢‘å°å†™ fsync / fdatasync å¼ºä¸€è‡´ é¡ºåºå†™ï¼ˆWAL / redo / binlogï¼‰ ç¨³å®š inode å¯é¢„æµ‹çš„ IO å»¶è¿Ÿ ğŸ‘‰ ç›®æ ‡å®Œå…¨ç›¸å\n"},{"id":113,"href":"/operations/linux/overlay2-and-unionfs/","title":"overlay2 å’Œ UnionFS çš„è”ç³»","parent":"Linux","content":"å…ˆç»™ç»“è®ºğŸ‘‡\nUnionFS æ˜¯â€œæ€æƒ³ / æŠ€æœ¯ç±»åˆ«â€ï¼Œoverlay2 æ˜¯â€œLinux ä¸Šçš„å…·ä½“å®ç°â€ã€‚\nä¸€ã€æ¦‚å¿µå±‚çº§å…³ç³»ï¼ˆæœ€é‡è¦ï¼‰ UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ â”œâ”€ AUFS ï¼ˆæ—©æœŸ Docker ç”¨ï¼Œå·²æ·˜æ±°ï¼‰ â”œâ”€ OverlayFS â”‚ â””â”€ overlay2 â† Docker é»˜è®¤ â”œâ”€ btrfs â””â”€ zfs ç»“è®ºï¼š\nUnionFSï¼šä¸€ç±»â€œæŠŠå¤šå±‚ç›®å½•åˆå¹¶æˆä¸€ä¸ªè§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæ€æƒ³ overlay2ï¼šåŸºäº Linux OverlayFS çš„ Docker å­˜å‚¨é©±åŠ¨å®ç° äºŒã€UnionFS æ˜¯ä»€ä¹ˆï¼ˆæŠ½è±¡å±‚ï¼‰ UnionFS è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ å¤šä¸ªç›®å½• -\u0026gt; çœ‹æˆä¸€ä¸ªç›®å½•\nä¸‹å±‚ï¼šåªè¯»ï¼ˆé•œåƒå±‚ï¼‰ ä¸Šå±‚ï¼šå¯å†™ï¼ˆå®¹å™¨å±‚ï¼‰ åˆå¹¶åï¼šè¿›ç¨‹åªçœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ UnionFS çš„æ ¸å¿ƒèƒ½åŠ› åˆ†å±‚ï¼ˆLayerï¼‰ Copy-on-Writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰ å…±äº«åªè¯»å±‚ ğŸ‘‰ è¿™æ˜¯ä¸€ä¸ªâ€œè®¾è®¡æ€æƒ³ + æŠ€æœ¯ç±»åˆ«â€ï¼Œä¸æ˜¯ Docker ä¸“å±\nä¸‰ã€overlay2 æ˜¯ä»€ä¹ˆï¼ˆå®ç°å±‚ï¼‰ overlay2 çš„æœ¬è´¨ overlay2 = OverlayFS + Docker çš„å±‚ç®¡ç†è§„åˆ™\nOverlayFSï¼šLinux å†…æ ¸åŸç”Ÿ UnionFS overlay2ï¼šDocker å¯¹ OverlayFS çš„ä½¿ç”¨æ–¹å¼ overlay2 çš„å…³é”®ç›®å½• lowerdir = é•œåƒå±‚ï¼ˆå¤šä¸ªï¼‰ upperdir = å®¹å™¨å†™å±‚ workdir = å†…æ ¸å·¥ä½œç›®å½• merged = æœ€ç»ˆè§†å›¾ è¿›ç¨‹è®¿é—®çš„å…¶å®æ˜¯ merged\nå››ã€ä¸ºä»€ä¹ˆ Docker é€‰ overlay2ï¼Ÿ å¯¹æ¯” UnionFS å…¶ä»–å®ç°ï¼š\næ–¹æ¡ˆ çŠ¶æ€ åŸå›  AUFS æ·˜æ±° ä¸è¿›ä¸»çº¿å†…æ ¸ devicemapper å¼ƒç”¨ å¤æ‚ã€æ€§èƒ½å·® btrfs å°ä¼— è¿ç»´æˆæœ¬é«˜ zfs ç‰¹æ®Š ä¾èµ–å¼º overlay2 âœ… é»˜è®¤ å†…æ ¸åŸç”Ÿã€å¿«ã€ç®€å•ã€ç¨³ ğŸ‘‰ overlay2 æ˜¯â€œå·¥ç¨‹æœ€ä¼˜è§£â€\näº”ã€overlay2 å’Œ UnionFS çš„å…³ç³»ä¸€å¥è¯ç‰ˆ UnionFS overlay2 æŠ½è±¡æ¦‚å¿µ å…·ä½“å®ç° ä¸€ç±»æ–‡ä»¶ç³»ç»Ÿ Docker å­˜å‚¨é©±åŠ¨ å®šä¹‰â€œæ€ä¹ˆå â€ çœŸæ­£â€œæ€ä¹ˆå¹²â€ å¯å¤šç§å®ç° åªæ˜¯ä¸€ç§å®ç° å…­ã€æ€»ç»“ UnionFS æ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿçš„ç»Ÿç§°ï¼Œoverlay2 æ˜¯ Docker åŸºäº Linux OverlayFS å®ç°çš„ UnionFS å­˜å‚¨é©±åŠ¨ï¼Œä¹Ÿæ˜¯å½“å‰é»˜è®¤å’Œæœ€æ¨èçš„å®ç°ã€‚\noverlay2 ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ Docker ä½¿ç”¨ OverlayFS çš„æ–¹å¼ã€‚\n","description":"å…ˆç»™ç»“è®ºğŸ‘‡\nUnionFS æ˜¯â€œæ€æƒ³ / æŠ€æœ¯ç±»åˆ«â€ï¼Œoverlay2 æ˜¯â€œLinux ä¸Šçš„å…·ä½“å®ç°â€ã€‚\nä¸€ã€æ¦‚å¿µå±‚çº§å…³ç³»ï¼ˆæœ€é‡è¦ï¼‰ UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ â”œâ”€ AUFS ï¼ˆæ—©æœŸ Docker ç”¨ï¼Œå·²æ·˜æ±°ï¼‰ â”œâ”€ OverlayFS â”‚ â””â”€ overlay2 â† Docker é»˜è®¤ â”œâ”€ btrfs â””â”€ zfs ç»“è®ºï¼š\nUnionFSï¼šä¸€ç±»â€œæŠŠå¤šå±‚ç›®å½•åˆå¹¶æˆä¸€ä¸ªè§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæ€æƒ³ overlay2ï¼šåŸºäº Linux OverlayFS çš„ Docker å­˜å‚¨é©±åŠ¨å®ç° äºŒã€UnionFS æ˜¯ä»€ä¹ˆï¼ˆæŠ½è±¡å±‚ï¼‰ UnionFS è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ å¤šä¸ªç›®å½• -\u0026gt; çœ‹æˆä¸€ä¸ªç›®å½•\n"},{"id":114,"href":"/database/postgres/example/","title":"PostgreSQL Example","parent":"PostgreSQL","content":" ç¤ºä¾‹ 01 è¡¨å article\nid ç±»å‹ä¸º æ•´æ•°, ä¸èƒ½ä¸ºç©º, ä¸»é”®, å”¯ä¸€, è‡ªå¢ datetime ç±»å‹ä¸º TIMESTAMP, ä¸èƒ½ä¸ºç©º code ç±»å‹ä¸º CHAR(6), ä¸èƒ½ä¸ºç©º source ç±»å‹ä¸º VARCHAR(20), ä¸èƒ½ä¸ºç©º title ç±»å‹ä¸º VARCHAR(100), ä¸èƒ½ä¸ºç©º url ç±»å‹ä¸º TEXT, ä¸èƒ½ä¸ºç©º éœ€æ±‚ï¼š\ndatetime, code, source, title, url éƒ½éœ€æŸ¥è¯¢ code å’Œ url ç»„æˆå”¯ä¸€çº¦æŸ sourceã€title å’Œ url ç»å¸¸éœ€è¦ä½¿ç”¨ WHERE Like \u0026lsquo;%xxx%\u0026rsquo; æœç´¢ æ ¹æ® PostgreSQL æœ€ä½³å®è·µï¼Œä»¥åŠç´¢å¼•ä¼˜åŒ–ç­‰ï¼Œç”Ÿæˆç›¸å…³çš„å»ºè¡¨è¯­å¥ä»¥åŠå»ºç´¢å¼•è¯­å¥ã€‚\nä¸‹é¢æŒ‰ PostgreSQL æœ€ä½³å®è·µ + æŸ¥è¯¢åœºæ™¯ + ç´¢å¼•å¯è½åœ° çš„æ€è·¯ï¼Œç»™ä½ ä¸€å¥—å¯ç›´æ¥ç”¨äºç”Ÿäº§çš„è®¾è®¡ï¼Œå¹¶è§£é‡Šæ¯ä¸€ä¸ªå…³é”®å†³ç­–ã€‚\nä¸€ã€å­—æ®µç±»å‹ä¸è®¾è®¡å†³ç­–ï¼ˆå…ˆç»™ç»“è®ºï¼‰ å­—æ®µ ç±»å‹ åŸå›  id BIGINT GENERATED è‡ªå¢ä¸»é”®ï¼Œé¿å…ä¸šåŠ¡è€¦åˆ datetime TIMESTAMP WITHOUT TIME ZONE æ˜ç¡®ã€å¯ç´¢å¼•ã€é€šç”¨ code CHAR(6) å›ºå®šé•¿åº¦è¯åˆ¸ä»£ç ï¼ˆåˆç†ï¼‰ source VARCHAR(20) æ¥æºé•¿åº¦æœ‰ä¸Šé™ï¼ŒLIKE æŸ¥è¯¢ title VARCHAR(100) æ ‡é¢˜é•¿åº¦æœ‰ä¸Šé™ï¼ŒLIKE æŸ¥è¯¢ url TEXT URL é•¿åº¦ä¸ç¡®å®šï¼ŒLIKE æŸ¥è¯¢ å”¯ä¸€çº¦æŸ (code, url) é˜²æ­¢é‡å¤æ–‡ç«  âš ï¸ LIKE \u0026lsquo;%xxx%\u0026rsquo; æ— æ³•ä½¿ç”¨æ™®é€š B-Tree ç´¢å¼•ï¼Œå¿…é¡»ç”¨ GIN + trigram\näºŒã€å»ºè¡¨è¯­å¥ï¼ˆæ¨èå†™æ³•ï¼‰ âœ… PostgreSQL 10+ æ¨èï¼ˆIDENTITYï¼‰\nCREATE TABLE article ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, datetime TIMESTAMP NOT NULL, code CHAR(6) NOT NULL, source VARCHAR(20) NOT NULL, title VARCHAR(100) NOT NULL, url TEXT NOT NULL, CONSTRAINT uq_article_code_url UNIQUE (code, url) ); å¦‚æœä½ æ›´åè€ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ç”¨ BIGSERIALï¼Œä½† IDENTITY æ˜¯æœ€ä½³å®è·µ\nä¸‰ã€åŸºç¡€ç´¢å¼•ï¼ˆå¿…å¤‡ï¼‰ 1ï¸âƒ£ datetime æŸ¥è¯¢ / æ’åºï¼ˆéå¸¸å¸¸è§ï¼‰ CREATE INDEX idx_article_datetime ON article (datetime DESC); é€‚ç”¨äºï¼š\nWHERE datetime \u0026gt;= ... ORDER BY datetime DESC 2ï¸âƒ£ code é«˜é¢‘è¿‡æ»¤ CREATE INDEX idx_article_code ON article (code); 3ï¸âƒ£ code + datetime ç»„åˆæŸ¥è¯¢ï¼ˆæ¨èï¼‰ å¦‚æœä½ ç»å¸¸è¿™æ ·æŸ¥ï¼š\nWHERE code = \u0026#39;000001\u0026#39; ORDER BY datetime DESC ğŸ‘‰ å¤åˆç´¢å¼•æ¯”å•åˆ—æ›´ä¼˜\nCREATE INDEX idx_article_code_datetime ON article (code, datetime DESC); å››ã€LIKE \u0026lsquo;%xxx%\u0026rsquo; æŸ¥è¯¢çš„æ­£ç¡®å§¿åŠ¿ï¼ˆğŸ”¥é‡ç‚¹ï¼‰ âŒ æ™®é€šç´¢å¼•æ— æ•ˆ\nWHERE title LIKE \u0026#39;%xxx%\u0026#39; B-Tree å®Œå…¨ç”¨ä¸ä¸Š\näº”ã€å¯ç”¨ trigram æ‰©å±•ï¼ˆå¿…é¡»ï¼‰ CREATE EXTENSION IF NOT EXISTS pg_trgm; å…­ã€ä¸º LIKE \u0026lsquo;%xxx%\u0026rsquo; å»º GIN ç´¢å¼•ï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ source æ¨¡ç³Šæœç´¢ CREATE INDEX idx_article_source_trgm ON article USING GIN (source gin_trgm_ops); 2ï¸âƒ£ title æ¨¡ç³Šæœç´¢ CREATE INDEX idx_article_title_trgm ON article USING GIN (title gin_trgm_ops); 3ï¸âƒ£ url æ¨¡ç³Šæœç´¢ï¼ˆå¯é€‰ï¼Œä½†ä½ è¯´â€œç»å¸¸â€ï¼‰ CREATE INDEX idx_article_url_trgm ON article USING GIN (url gin_trgm_ops); ä¸ƒã€LIKE æŸ¥è¯¢å°†ä¼šçœŸæ­£èµ°ç´¢å¼• EXPLAIN ANALYZE SELECT * FROM article WHERE title LIKE \u0026#39;%èŠ¯ç‰‡%\u0026#39;; ä½ å°†çœ‹åˆ°ï¼š\nBitmap Index Scan on idx_article_title_trgm ğŸš€ æ€§èƒ½æå‡ 10ï½100 å€\nå…«ã€å¦‚æœç»å¸¸ä¸‰å­—æ®µä¸€èµ·æœç´¢ï¼ˆè¿›é˜¶ï¼‰ ä¾‹å¦‚ï¼š\nWHERE source LIKE \u0026#39;%æ–°æµª%\u0026#39; OR title LIKE \u0026#39;%èŠ¯ç‰‡%\u0026#39; OR url LIKE \u0026#39;%news%\u0026#39; ğŸ‘‰ å¯é€‰æ–¹æ¡ˆï¼šå¤šåˆ— GINï¼ˆæƒè¡¡ï¼‰\nCREATE INDEX idx_article_search_trgm ON article USING GIN ( source gin_trgm_ops, title gin_trgm_ops, url gin_trgm_ops ); âš ï¸ æ³¨æ„ï¼š\nç´¢å¼•ä½“ç§¯ä¼šæ˜æ˜¾å˜å¤§ å†™å…¥æˆæœ¬å¢åŠ  å¦‚æœæŸ¥è¯¢å­—æ®µç»å¸¸ä¸€èµ·å‡ºç° -\u0026gt; å€¼å¾— ä¹ã€æ€§èƒ½ \u0026amp; è¿ç»´æœ€ä½³å®è·µå»ºè®®ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ CHAR(6) æŸ¥è¯¢è®°å¾— TRIMï¼ˆå¦‚æœæ¥æºä¸è§„èŒƒï¼‰ WHERE code = \u0026#39;000001\u0026#39; ç¡®ä¿æ’å…¥æ—¶å·²æ ‡å‡†åŒ–ï¼Œå¦åˆ™ CHAR ä¼šè¡¥ç©ºæ ¼\n2ï¸âƒ£ å®šæœŸç»´æŠ¤ï¼ˆGIN ç´¢å¼•å¿…åšï¼‰ VACUUM (ANALYZE) article; é«˜å†™å…¥é‡ç³»ç»Ÿå»ºè®®ï¼š\nautovacuum_vacuum_scale_factor = 0.05 3ï¸âƒ£ ä¸è¦å¯¹ TEXT / VARCHAR çº ç»“æ€§èƒ½ PostgreSQL ä¸­ï¼š\nTEXT ä¸ VARCHAR æ€§èƒ½å®Œå…¨ä¸€è‡´\nåã€å®Œæ•´ SQL æ±‡æ€»ï¼ˆå¯ç›´æ¥æ‰§è¡Œï¼‰ -- å¯¼å‡ºæ•°æ® -- id æ˜¯è‡ªå¢ä¸»é”®ï¼Œå¹¶æ— å®é™…çš„æ„ä¹‰ï¼Œå¿½ç•¥ BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; \\copy article (datetime, code, source, title, url) TO \u0026#39;/tmp/article.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; -- åˆ é™¤è¡¨ DROP TABLE IF EXISTS article CASCADE; -- åˆ›å»ºæ‰©å±• CREATE EXTENSION IF NOT EXISTS pg_trgm; -- åˆ›å»ºè¡¨ CREATE TABLE article ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, datetime TIMESTAMP NOT NULL, code CHAR(6) NOT NULL, source VARCHAR(20) NOT NULL, title VARCHAR(100) NOT NULL, url TEXT NOT NULL, CONSTRAINT uq_article_code_url UNIQUE (code, url) ); -- æé«˜ç»Ÿè®¡ç²¾åº¦ ALTER TABLE article ALTER COLUMN source SET STATISTICS 1000; ALTER TABLE article ALTER COLUMN title SET STATISTICS 1000; ALTER TABLE article ALTER COLUMN url SET STATISTICS 1000; -- åˆ›å»ºç´¢å¼• CREATE INDEX idx_article_datetime ON article (datetime DESC); CREATE INDEX idx_article_code ON article (code); CREATE INDEX idx_article_code_datetime ON article (code, datetime DESC); -- DROP INDEX idx_article_source_trgm; CREATE INDEX idx_article_source_trgm ON article USING GIN (source gin_trgm_ops); -- DROP INDEX idx_article_title_trgm; CREATE INDEX idx_article_title_trgm ON article USING GIN (title gin_trgm_ops); -- DROP INDEX idx_article_url_trgm; CREATE INDEX idx_article_url_trgm ON article USING GIN (url gin_trgm_ops); -- å¯¼å…¥æ•°æ® BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; \\copy article (datetime, code, source, title, url) FROM \u0026#39;/tmp/article.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; -- æ£€æŸ¥åºåˆ— SELECT last_value, increment_by FROM pg_sequences WHERE schemaname = \u0026#39;public\u0026#39; AND sequencename = \u0026#39;article_id_seq\u0026#39;; -- å›æ”¶ -- VACUUM article; -- VACUUM ANALYZE article; -- åˆ†æè¡¨ -- ANALYZE article; url ä½¿ç”¨ GIN ç´¢å¼•å‰å EXPLAIN ANALYZE å¯¹æ¯” -- ç»Ÿè®¡è¡Œæ•° SELECT COUNT(*) FROM article; -- 10852 -- ç´¢å¼•å‰ EXPLAIN ANALYZE SELECT * FROM article WHERE url LIKE \u0026#39;%weixin%\u0026#39;; -- Seq Scan on article (cost=0.00..411.45 rows=1050 width=168) (actual time=0.021..2.771 rows=1021 loops=1) -- Filter: (url ~~ \u0026#39;%weixin%\u0026#39;::text) -- Rows Removed by Filter: 9831 -- Planning Time: 0.108 ms -- Execution Time: 2.828 ms -- ç´¢å¼•å EXPLAIN ANALYZE SELECT * FROM article WHERE url LIKE \u0026#39;%weixin%\u0026#39;; -- Bitmap Heap Scan on article (cost=18.31..306.45 rows=1051 width=168) (actual time=0.302..1.095 rows=1021 loops=1) -- Recheck Cond: (url ~~ \u0026#39;%weixin%\u0026#39;::text) -- Heap Blocks: exact=233 -- -\u0026gt; Bitmap Index Scan on idx_article_url_trgm (cost=0.00..18.05 rows=1051 width=0) (actual time=0.248..0.248 rows=1021 loops=1) -- Index Cond: (url ~~ \u0026#39;%weixin%\u0026#39;::text) -- Planning Time: 1.743 ms -- Execution Time: 1.192 ms ä»¥ä¸Šè¾“å‡ºæ˜¾ç¤ºäº† PostgreSQL å¯¹ç›¸åŒæŸ¥è¯¢ä½¿ç”¨ä¸¤ç§æ‰§è¡Œè®¡åˆ’çš„å¯¹æ¯”ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æå’Œæ€»ç»“ä¼˜åŒ–è¦ç‚¹ã€‚\nä¸€ã€æŸ¥è¯¢ç›®æ ‡ SELECT * FROM article WHERE url LIKE \u0026#39;%weixin%\u0026#39;; æŸ¥è¯¢æ¡ä»¶æ˜¯ LIKE \u0026lsquo;%xxx%\u0026rsquo; PostgreSQL éœ€è¦åŒ¹é… ä»»æ„ä½ç½®çš„å­ä¸²ï¼Œæ™®é€š B-Tree ç´¢å¼•æ— æ³•åŠ é€Ÿï¼Œéœ€è¦ trigramï¼ˆpg_trgmï¼‰ç´¢å¼•ã€‚ äºŒã€æ‰§è¡Œè®¡åˆ’å¯¹æ¯” 1ï¸âƒ£ Seq Scanï¼ˆé¡ºåºæ‰«æï¼‰ Seq Scan on article (cost=0.00..411.45 rows=1050 width=168) Filter: (url ~~ \u0026#39;%weixin%\u0026#39;::text) Rows Removed by Filter: 9831 Execution Time: 2.828 ms åˆ†æï¼š\nSeq Scanï¼šé€è¡Œæ‰«ææ•´ä¸ªè¡¨ Rows Removed by Filter: 9831 -\u0026gt; è¡¨ç¤ºè¡¨ä¸­å¤§éƒ¨åˆ†è¡Œä¸æ»¡è¶³æ¡ä»¶ Execution Time 2.828 ms -\u0026gt; å¯¹äºè¿™ä¸ªè¡¨é‡ï¼ˆ~11k è¡Œï¼‰ï¼Œè¿˜ç®—å¿« ä¼˜ç‚¹ï¼šä¸ä¾èµ–ç´¢å¼•ï¼Œå¼€é”€ä½ï¼Œé€‚åˆå°è¡¨æˆ–é«˜é€‰æ‹©æ€§æŸ¥è¯¢ ç¼ºç‚¹ï¼šè¡¨å˜å¤§æ—¶æˆæœ¬çº¿æ€§å¢é•¿ 2ï¸âƒ£ Bitmap Heap Scan + trgm index Bitmap Heap Scan on article (cost=18.31..306.45 rows=1051 width=168) Recheck Cond: (url ~~ \u0026#39;%weixin%\u0026#39;::text) Heap Blocks: exact=233 -\u0026gt; Bitmap Index Scan on idx_article_url_trgm Index Cond: (url ~~ \u0026#39;%weixin%\u0026#39;::text) Execution Time: 1.192 ms åˆ†æï¼š\nä½¿ç”¨äº† pg_trgm ç´¢å¼•ï¼ˆidx_article_url_trgmï¼‰ Bitmap Index Scan -\u0026gt; å…ˆç”¨ç´¢å¼•æ‰¾å‡ºå¯èƒ½åŒ¹é…çš„è¡Œ Bitmap Heap Scan -\u0026gt; å†è®¿é—®å®é™…è¡¨è¡Œ Rows matched â‰ˆ 1021 -\u0026gt; å’Œ Seq Scan ä¸€è‡´ Execution Time 1.192 ms -\u0026gt; æ¯” Seq Scan å¿«çº¦ 2x ä¸‰ã€ç»“è®º ç‰¹æ€§ Seq Scan Bitmap Heap Scan + trgm ä½¿ç”¨ç´¢å¼• âŒ âœ… é€‚åˆåœºæ™¯ å°è¡¨ / æŸ¥è¯¢é«˜é€‰æ‹©æ€§ LIKE \u0026lsquo;%xxx%\u0026rsquo; / è¡¨å¤§ æ‰«ææˆæœ¬ O(n) O(åŒ¹é…è¡Œ + bitmap) æ‰§è¡Œæ—¶é—´ è¾ƒæ…¢ å¿« 2~3 å€ å››ã€ä¼˜åŒ–å»ºè®® ä¿æŒ pg_trgm ç´¢å¼•\nCREATE INDEX idx_article_url_trgm ON article USING gin (url gin_trgm_ops); æ”¯æŒ %xxx% æ¨¡ç³ŠåŒ¹é… å¯¹å¤§è¡¨æ•ˆæœæ˜æ˜¾ é€‰æ‹©æ€§è€ƒè™‘æ¡ä»¶\nå¦‚æœåŒ¹é…è¡Œå¾ˆå¤šï¼ŒBitmap Heap Scan ä¼šè®¿é—®å¤§é‡è¡Œ å¯ä»¥ç»“åˆå…¶ä»–è¿‡æ»¤æ¡ä»¶å‡å°‘åŒ¹é…é‡ é¿å…å¸¸è§„ B-Tree ç´¢å¼•\nB-Tree ç´¢å¼•åªæ”¯æŒ LIKE \u0026lsquo;xxx%\u0026rsquo;ï¼ˆå‰ç¼€åŒ¹é…ï¼‰ å¯¹ %xxx% æ— æ•ˆ å®šæœŸ VACUUM ANALYZE\nä¿è¯æŸ¥è¯¢è§„åˆ’å™¨èƒ½æ­£ç¡®ä¼°ç®—è¡Œæ•°ï¼Œé€‰æ‹©æœ€ä½³è®¡åˆ’ äº”ã€æ€»ç»“ å¯¹å°è¡¨ï¼ŒSeq Scan è¶³å¤Ÿ å¯¹å¤§è¡¨ã€LIKE \u0026lsquo;%xxx%\u0026rsquo; æŸ¥è¯¢ï¼Œpg_trgm + GIN/GIN_TRGM ç´¢å¼•æ˜¾è‘—æå‡æ€§èƒ½ Bitmap Heap Scan + trgm ç´¢å¼•æ˜¯æœ€ä½³å®è·µ ç¤ºä¾‹ 02 è¡¨å telegraph\nid ç±»å‹ä¸º æ•´æ•°, ä¸èƒ½ä¸ºç©º, ä¸»é”®, å”¯ä¸€, ä¸è‡ªå¢ datetime ç±»å‹ä¸º TIMESTAMP, ä¸èƒ½ä¸ºç©º code ç±»å‹ä¸º CHAR(6), ä¸èƒ½ä¸ºç©º title ç±»å‹ä¸º VARCHAR(100), ä¸èƒ½ä¸ºç©º content ç±»å‹ä¸º TEXT, ä¸èƒ½ä¸ºç©º éœ€æ±‚ï¼š\ndatetime, code, title éƒ½éœ€æŸ¥è¯¢ï¼Œcontent ä¸éœ€è¦æŸ¥è¯¢ title ç»å¸¸éœ€è¦ä½¿ç”¨ WHERE Like \u0026lsquo;%xxx%\u0026rsquo; æœç´¢ å®è·µï¼š\n-- å¯¼å‡ºæ•°æ® BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; \\copy telegraph TO \u0026#39;/tmp/telegraph.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; -- åˆ é™¤è¡¨ DROP TABLE IF EXISTS telegraph CASCADE; -- åˆ›å»ºæ‰©å±• CREATE EXTENSION IF NOT EXISTS pg_trgm; -- åˆ›å»ºè¡¨ CREATE TABLE telegraph ( id BIGINT PRIMARY KEY, datetime TIMESTAMP NOT NULL, code CHAR(6) NOT NULL, title VARCHAR(100) NOT NULL, content TEXT NOT NULL ); -- æé«˜ç»Ÿè®¡ç²¾åº¦ ALTER TABLE telegraph ALTER COLUMN title SET STATISTICS 1000; -- åˆ›å»ºç´¢å¼• CREATE INDEX idx_telegraph_datetime ON telegraph (datetime DESC); CREATE INDEX idx_telegraph_code ON telegraph (code); CREATE INDEX idx_telegraph_code_datetime ON telegraph (code, datetime DESC); -- DROP INDEX idx_telegraph_title_trgm; CREATE INDEX idx_telegraph_title_trgm ON telegraph USING GIN (title gin_trgm_ops); -- å¯¼å…¥æ•°æ® BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; \\copy telegraph FROM \u0026#39;/tmp/telegraph.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; -- å›æ”¶ VACUUM telegraph; VACUUM ANALYZE telegraph; -- åˆ†æè¡¨ ANALYZE telegraph; ç¤ºä¾‹ 03 è¡¨å ashare\ncode ç±»å‹ä¸º å­—ç¬¦ä¸², é•¿åº¦ 6, ä¸èƒ½ä¸ºç©º, ä¸»é”®, å”¯ä¸€, ä¸è‡ªå¢ name ç±»å‹ä¸º å­—ç¬¦ä¸², é•¿åº¦ 6, ä¸èƒ½ä¸ºç©º, å”¯ä¸€, ç´¢å¼• å®è·µï¼š\n-- åˆ é™¤è¡¨ DROP TABLE IF EXISTS ashare CASCADE; -- åˆ›å»ºæ‰©å±• CREATE EXTENSION IF NOT EXISTS pg_trgm; -- åˆ›å»ºè¡¨ CREATE TABLE ashare ( code CHAR(6) PRIMARY KEY, name VARCHAR(6) NOT NULL ); -- åˆ›å»ºç´¢å¼• CREATE INDEX idx_ashare_name ON ashare (name); ç¤ºä¾‹ 04 è¡¨å trading_day\ndate ç±»å‹ä¸º æ—¥æœŸ, ä¸»é”® å®è·µï¼š\n-- åˆ é™¤è¡¨ DROP TABLE IF EXISTS trading_day CASCADE; -- åˆ›å»ºè¡¨ CREATE TABLE trading_day ( date DATE PRIMARY KEY ); PostgreSQL çš„ DATE å­—æ®µç±»å‹ä¸“é—¨ç”¨äºå­˜å‚¨ä¸å¸¦æ—¶é—´ï¼ˆå³æ²¡æœ‰æ—¶åˆ†ç§’ï¼‰çš„æ—¥æœŸæ•°æ®ï¼Œå ç”¨ 4 å­—èŠ‚å­˜å‚¨ç©ºé—´ï¼ŒèŒƒå›´æ¶µç›–å…¬å…ƒå‰ 4713 å¹´åˆ°å…¬å…ƒ 5874897 å¹´ã€‚\nå…¶æ ‡å‡†æ ¼å¼ä¸º \u0026lsquo;YYYY-MM-DD\u0026rsquo;ï¼Œå¦‚ \u0026lsquo;2023-10-27\u0026rsquo;ï¼Œå¸¸ç”¨äºç”Ÿæ—¥ã€æ³¨å†Œæ—¥æœŸç­‰ä»…éœ€æ—¥æœŸçš„åœºæ™¯ã€‚\nä»¥ä¸‹æ˜¯å…³äº PostgreSQL DATE ç±»å‹çš„è¯¦ç»†è¯´æ˜ï¼š\næ ¸å¿ƒç‰¹æ€§ å­˜å‚¨å†…å®¹ï¼šä»…åŒ…å«å¹´ã€æœˆã€æ—¥ï¼Œä¸åŒ…å«æ—¶ã€åˆ†ã€ç§’æˆ–æ—¶åŒºä¿¡æ¯ã€‚ å­˜å‚¨ç©ºé—´ï¼š4 å­—èŠ‚ã€‚ æ ¼å¼ï¼šé»˜è®¤å’Œå»ºè®®çš„è¾“å…¥/è¾“å‡ºæ ¼å¼ä¸º YYYY-MM-DDã€‚ å–å€¼èŒƒå›´ï¼šå…¬å…ƒå‰ 4713 å¹´åˆ°å…¬å…ƒ 5874897 å¹´ã€‚ ä½¿ç”¨ç¤ºä¾‹ åˆ›å»ºè¡¨\nCREATE TABLE users ( name VARCHAR(50), birthday DATE ); æ’å…¥æ•°æ®\nINSERT INTO users (name, birthday) VALUES (\u0026#39;å¼ ä¸‰\u0026#39;, \u0026#39;1990-01-01\u0026#39;); æ—¥æœŸæ“ä½œï¼šDATE ç±»å‹æ”¯æŒåŠ å‡æ“ä½œï¼Œä¾‹å¦‚æŸ¥è¯¢ä¸€å‘¨åçš„æ—¥æœŸï¼š\nSELECT CURRENT_DATE + INTERVAL \u0026#39;7 days\u0026#39;; ä¸å…¶ä»–æ—¥æœŸ/æ—¶é—´ç±»å‹å¯¹æ¯” TIMESTAMPï¼šåŒ…å«æ—¥æœŸå’Œæ—¶é—´ï¼ˆYYYY-MM-DD HH:MM:SSï¼‰ã€‚ TIMEï¼šä»…åŒ…å«ä¸€å¤©å†…çš„æ—¶é—´ï¼ˆHH:MM:SSï¼‰ã€‚ INTERVALï¼šå­˜å‚¨æ—¶é—´é—´éš”ã€‚ æ³¨æ„äº‹é¡¹ æ’å…¥ DATE æ•°æ®æ—¶ï¼Œå»ºè®®å°†å€¼ç”¨å•å¼•å·æ‹¬èµ·æ¥ä½œä¸ºå­—ç¬¦ä¸²å¤„ç†ã€‚\nå¦‚æœéœ€è¦å­˜å‚¨æ—¶åŒºä¿¡æ¯ï¼Œåº”ä½¿ç”¨ TIMESTAMP WITH TIME ZONE ç±»å‹ï¼Œè€Œä¸æ˜¯ DATEã€‚\nPostgreSQL ä¹Ÿæ”¯æŒæ›´çµæ´»çš„è¾“å…¥æ ¼å¼ï¼Œå¦‚ 19970101 æˆ– Jan-1-1997ï¼Œä½† \u0026lsquo;YYYY-MM-DD\u0026rsquo; æ˜¯æœ€ç¨³å¦¥çš„æ ‡å‡†ã€‚\n","description":" ç¤ºä¾‹ 01 è¡¨å article\nid ç±»å‹ä¸º æ•´æ•°, ä¸èƒ½ä¸ºç©º, ä¸»é”®, å”¯ä¸€, è‡ªå¢ datetime ç±»å‹ä¸º TIMESTAMP, ä¸èƒ½ä¸ºç©º code ç±»å‹ä¸º CHAR(6), ä¸èƒ½ä¸ºç©º source ç±»å‹ä¸º VARCHAR(20), ä¸èƒ½ä¸ºç©º title ç±»å‹ä¸º VARCHAR(100), ä¸èƒ½ä¸ºç©º url ç±»å‹ä¸º TEXT, ä¸èƒ½ä¸ºç©º éœ€æ±‚ï¼š\ndatetime, code, source, title, url éƒ½éœ€æŸ¥è¯¢ code å’Œ url ç»„æˆå”¯ä¸€çº¦æŸ sourceã€title å’Œ url ç»å¸¸éœ€è¦ä½¿ç”¨ WHERE Like \u0026lsquo;%xxx%\u0026rsquo; æœç´¢ æ ¹æ® PostgreSQL æœ€ä½³å®è·µï¼Œä»¥åŠç´¢å¼•ä¼˜åŒ–ç­‰ï¼Œç”Ÿæˆç›¸å…³çš„å»ºè¡¨è¯­å¥ä»¥åŠå»ºç´¢å¼•è¯­å¥ã€‚\n"},{"id":115,"href":"/operations/linux/from-hardware-to-container/","title":"ä»ç¡¬ä»¶åˆ°å®¹å™¨","parent":"Linux","content":" ä¸€ã€æ€»è§ˆï¼šä»ç¡¬ä»¶åˆ°å®¹å™¨çš„å®Œæ•´åˆ†å±‚ +-------------------------------------------------------------------+ åº”ç”¨ç¨‹åº / æœåŠ¡ MySQL / Nginx / Redis / Java / Python +-------------------------------------------------------------------+ å®¹å™¨å¹³å° (å¯é€‰) Docker / containerd / Podman / Kubernetes +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´: å®¹å™¨è¿è¡Œæ—¶ runc +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´: åŸºç¡€ç»„ä»¶ shell / libc / systemd / coreutils +-------------------------------------------------------------------+ Linux å†…æ ¸ç©ºé—´ - äº”å¤§å­ç³»ç»Ÿ: è¿›ç¨‹ç®¡ç† / å†…å­˜ç®¡ç† / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œå­ç³»ç»Ÿ / è®¾å¤‡ä¸é©±åŠ¨ - å¢å¼ºæœºåˆ¶: Namespaces / cgroups / UnionFS / KVM +-------------------------------------------------------------------+ ç¡¬ä»¶å±‚ CPU / å†…å­˜ / ç¡¬ç›˜ / ç½‘å¡ +-------------------------------------------------------------------+ äºŒã€ç¡¬ä»¶å±‚ï¼šä¸€åˆ‡èµ„æºçš„æºå¤´ 1ï¸âƒ£ CPU æä¾›æŒ‡ä»¤æ‰§è¡Œèƒ½åŠ› æä¾›å¤šæ ¸ã€å¤š NUMA èŠ‚ç‚¹ æä¾›ç‰¹æƒçº§ï¼ˆç”¨æˆ·æ€ / å†…æ ¸æ€ï¼‰ å†…æ ¸å¦‚ä½•ä½¿ç”¨ CPU è¿›ç¨‹è°ƒåº¦å™¨å†³å®š å“ªä¸ªè¿›ç¨‹åœ¨å“ªä¸ª CPU ä¸Šè¿è¡Œ ä¸­æ–­å¤„ç†ã€è½¯ä¸­æ–­ã€è°ƒåº¦æ—¶é’Ÿ 2ï¸âƒ£ å†…å­˜ï¼ˆRAMï¼‰ æä¾›ç‰©ç†å†…å­˜é¡µ NUMA æ¶æ„å†³å®šè®¿é—®å»¶è¿Ÿ å†…æ ¸å¦‚ä½•ä½¿ç”¨å†…å­˜ é¡µåˆ†é…ã€é¡µå›æ”¶ è™šæ‹Ÿå†…å­˜ã€é¡µè¡¨ OOM Killer 3ï¸âƒ£ ç¡¬ç›˜ï¼ˆDiskï¼‰ æä¾›æŒä¹…åŒ–å­˜å‚¨ å—è®¾å¤‡æ¥å£ å†…æ ¸å¦‚ä½•ä½¿ç”¨ç¡¬ç›˜ å—å±‚è°ƒåº¦ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ ç¼“å­˜é¡µï¼ˆPage Cacheï¼‰ 4ï¸âƒ£ ç½‘å¡ï¼ˆNICï¼‰ æä¾›ç½‘ç»œæ”¶å‘èƒ½åŠ› ä¸­æ–­è§¦å‘æ•°æ®å¤„ç† å†…æ ¸å¦‚ä½•ä½¿ç”¨ç½‘å¡ ç½‘ç»œåè®®æ ˆ ä¸­æ–­ / NAPI Socket æ¥å£ ä¸‰ã€Linux å†…æ ¸ç©ºé—´ï¼šèµ„æºçš„â€œç®¡ç†è€…â€ äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼ˆæ ¹åŸºï¼‰ 1ï¸âƒ£ è¿›ç¨‹ç®¡ç† è¿›ç¨‹åˆ›å»ºã€é”€æ¯ è°ƒåº¦ ä¿¡å· PID 2ï¸âƒ£ å†…å­˜ç®¡ç† è™šæ‹Ÿå†…å­˜ é¡µç¼“å­˜ NUMA OOM 3ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿ VFS å„ç±»æ–‡ä»¶ç³»ç»Ÿï¼ˆext4ã€xfsã€overlayfsï¼‰ 4ï¸âƒ£ ç½‘ç»œå­ç³»ç»Ÿ TCP/IP åè®®æ ˆ Socket Netfilter 5ï¸âƒ£ è®¾å¤‡ä¸é©±åŠ¨ å—è®¾å¤‡ å­—ç¬¦è®¾å¤‡ ä¸­æ–­ç®¡ç† å†…æ ¸å¢å¼ºæœºåˆ¶ï¼ˆä¸æ˜¯å­ç³»ç»Ÿï¼‰ namespacesï¼ˆéš”ç¦»è§†å›¾ï¼‰ éš”ç¦»å¯¹è±¡ ä¾èµ–å­ç³»ç»Ÿ PID è¿›ç¨‹ç®¡ç† ç½‘ç»œ ç½‘ç»œå­ç³»ç»Ÿ æŒ‚è½½ æ–‡ä»¶ç³»ç»Ÿ ç”¨æˆ· è¿›ç¨‹ç®¡ç† -\u0026gt; å†³å®šâ€œä½ çœ‹åˆ°ä»€ä¹ˆâ€\ncgroupsï¼ˆèµ„æºé™åˆ¶ï¼‰ èµ„æº å­ç³»ç»Ÿ CPU è¿›ç¨‹ç®¡ç† å†…å­˜ å†…å­˜ç®¡ç† IO æ–‡ä»¶ç³»ç»Ÿ ç½‘ç»œ ç½‘ç»œå­ç³»ç»Ÿ -\u0026gt; å†³å®šâ€œä½ èƒ½ç”¨å¤šå°‘â€\nUnionFS / overlayfs æ–‡ä»¶ç³»ç»Ÿå±‚å  åªè¯»é•œåƒ + å¯å†™å±‚ -\u0026gt; æ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿå†…éƒ¨æœºåˆ¶\nNUMA æ„ŸçŸ¥ç¡¬ä»¶å†…å­˜æ‹“æ‰‘ å½±å“è°ƒåº¦ã€å†…å­˜åˆ†é… -\u0026gt; å†…å­˜ç®¡ç† + è¿›ç¨‹ç®¡ç†\nå››ã€Linux ç”¨æˆ·ç©ºé—´åŸºç¡€ç»„ä»¶ 1ï¸âƒ£ libc ä½œç”¨ï¼š\nç³»ç»Ÿè°ƒç”¨å°è£… æä¾›æ ‡å‡† C æ¥å£ åº”ç”¨ ä¸ç›´æ¥è°ƒç”¨å†…æ ¸ï¼Œè€Œæ˜¯é€šè¿‡ libc\n2ï¸âƒ£ shell ä½œç”¨ï¼š\nå‘½ä»¤è§£é‡Šå™¨ å¯åŠ¨è¿›ç¨‹ ç®¡é“ã€é‡å®šå‘ shell æœ¬è´¨æ˜¯ä¸€ä¸ªæ™®é€šè¿›ç¨‹\n3ï¸âƒ£ systemd ä½œç”¨ï¼š\nç³»ç»Ÿåˆå§‹åŒ– æœåŠ¡ç®¡ç† cgroups ç®¡ç†è€… systemd æ˜¯ ç³»ç»Ÿçº§è¿›ç¨‹ç¼–æ’å™¨\näº”ã€Linux ç³»ç»Ÿæ•´ä½“è§’è‰² Linux ç³»ç»Ÿ =\nå†…æ ¸ + ç”¨æˆ·ç©ºé—´å·¥å…· + æœåŠ¡ç®¡ç† + é…ç½®ä½“ç³»\nå®ƒçš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š\nç®¡ç†ç¡¬ä»¶ æä¾›ç¨³å®šæ¥å£ æ”¯æ’‘åº”ç”¨è¿è¡Œ å…­ã€è™šæ‹ŸåŒ–ï¼šåœ¨ç¡¬ä»¶ä¹‹ä¸Šå†æŠ½ä¸€å±‚ è™šæ‹ŸåŒ–çš„æœ¬è´¨ ç¡¬ä»¶ â†“ Hypervisorï¼ˆKVMï¼‰ â†“ è™šæ‹Ÿæœºï¼ˆå®Œæ•´ Linuxï¼‰ æ¯ä¸ªè™šæ‹Ÿæœºéƒ½æœ‰è‡ªå·±çš„å†…æ ¸ èµ„æºéš”ç¦»é ç¡¬ä»¶è™šæ‹ŸåŒ– å†…æ ¸åœ¨è™šæ‹ŸåŒ–ä¸­çš„è§’è‰² KVM æ˜¯å†…æ ¸æ¨¡å— è°ƒåº¦è™šæ‹Ÿ CPU ç®¡ç†å†…å­˜æ˜ å°„ ä¸ƒã€å®¹å™¨åŒ–ï¼šä¸è™šæ‹Ÿå†…æ ¸ï¼Œåªè™šæ‹Ÿâ€œä½¿ç”¨æ–¹å¼â€ å®¹å™¨çš„æœ¬è´¨ è¿›ç¨‹ + namespaces + cgroups + rootfs\nLinux å†…æ ¸ â”œâ”€ namespaceï¼šçœ‹ä¸è§åˆ«äºº â”œâ”€ cgroupsï¼šç”¨ä¸å¤šèµ„æº â”œâ”€ overlayfsï¼šç‹¬ç«‹æ–‡ä»¶ç³»ç»Ÿ runcï¼šå…³é”®çº½å¸¦ runc åšäº†ä»€ä¹ˆ\nåˆ›å»ºè¿›ç¨‹ é…ç½® namespaces ç»‘å®š cgroups åˆ‡æ¢ rootfs exec åº”ç”¨ Docker åœ¨å…¶ä¸­çš„ä½ç½® Docker â””â”€ containerd â””â”€ runc â””â”€ Linux å†…æ ¸ Docker ä¸åšéš”ç¦»ï¼ŒDocker è°ƒç”¨å†…æ ¸åšéš”ç¦»ã€‚\nå…«ã€æœ€ç»ˆç»Ÿä¸€å…³ç³»å›¾ï¼ˆå¼ºçƒˆå»ºè®®è®°ä½ï¼‰ ç¡¬ä»¶ â†“ Linux å†…æ ¸ï¼ˆäº”å¤§å­ç³»ç»Ÿï¼‰ â†“ namespaces / cgroups / UnionFS / NUMA â†“ libc / shell / systemd â†“ runc â†“ Docker / Kubernetes â†“ åº”ç”¨ç¨‹åº ä¹ã€ä¸€å¥è¯ç»ˆææ€»ç»“ ç¡¬ä»¶ æä¾›èµ„æº å†…æ ¸ ç®¡ç†èµ„æº namespaces éš”ç¦»è§†å›¾ cgroups é™åˆ¶é¢åº¦ UnionFS ç»„ç»‡æ–‡ä»¶ libc / shell / systemd ä½¿ç”¨å†…æ ¸ runc ç»„åˆå†…æ ¸èƒ½åŠ› Docker / å®¹å™¨ æ˜¯è¿›ç¨‹çš„é«˜çº§ç”¨æ³• è™šæ‹Ÿæœº æ˜¯å†…æ ¸çš„å¤åˆ¶å“ â˜˜ï¸ Linux æ¶æ„å¿ƒæ™ºæ¨¡å‹å›¾ ç›®æ ‡ï¼šä¸€çœ¼å°±èƒ½çœ‹æ‡‚ Linux / å®¹å™¨ / è™šæ‹ŸåŒ– / Docker çš„å…¨éƒ¨å…³ç³»\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ åº”ç”¨ç¨‹åº â”‚ â”‚ MySQL / PostgreSQL / Nginx / Java / Python â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² â”‚ è¿›ç¨‹ / ç³»ç»Ÿè°ƒç”¨ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å®¹å™¨å¹³å°ï¼ˆå¯é€‰çš„ä¸€å±‚æŠ½è±¡ï¼‰ â”‚ â”‚ Docker / Podman / Kubernetes â”‚ â”‚ ï¼ˆé•œåƒã€ç½‘ç»œã€ç¼–æ’ã€ç”Ÿå‘½å‘¨æœŸï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² â”‚ OCI æ¥å£ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å®¹å™¨è¿è¡Œæ—¶ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ â”‚ â”‚ runc â”‚ â”‚ - åˆ›å»ºè¿›ç¨‹ â”‚ â”‚ - è®¾ç½® namespacesï¼ˆéš”ç¦»ï¼‰ â”‚ â”‚ - è®¾ç½® cgroupsï¼ˆé™åˆ¶ï¼‰ â”‚ â”‚ - åˆ‡æ¢ rootfsï¼ˆoverlayfsï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² â”‚ libc ç³»ç»Ÿè°ƒç”¨å°è£… â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Linux ç”¨æˆ·ç©ºé—´åŸºç¡€ â”‚ â”‚ â”‚ â”‚ shell -\u0026gt; å‘½ä»¤è§£é‡Š / å¯åŠ¨è¿›ç¨‹ â”‚ â”‚ libc -\u0026gt; ç³»ç»Ÿè°ƒç”¨æ¥å£ â”‚ â”‚ systemd -\u0026gt; ç³»ç»Ÿåˆå§‹åŒ– / æœåŠ¡ / cgroups ç®¡ç† â”‚ â”‚ coreutils -\u0026gt; åŸºç¡€å·¥å…· â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² â”‚ ç”¨æˆ·æ€ â†” å†…æ ¸æ€ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Linux å†…æ ¸ç©ºé—´ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ è¿›ç¨‹ç®¡ç† â”‚ è°ƒåº¦ / PID / ä¿¡å· â”‚ â”‚ â”‚ â”‚ å†…å­˜ç®¡ç† â”‚ è™šæ‹Ÿå†…å­˜ / é¡µç¼“å­˜ / OOM / NUMA â”‚ â”‚ â”‚ â”‚ æ–‡ä»¶ç³»ç»Ÿ â”‚ VFS / ext4 / xfs / overlayfs â”‚ â”‚ â”‚ â”‚ ç½‘ç»œå­ç³»ç»Ÿâ”‚ TCP/IP / netfilter / socket â”‚ â”‚ â”‚ â”‚ è®¾å¤‡é©±åŠ¨ â”‚ ç£ç›˜ / ç½‘å¡ / ä¸­æ–­ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å†…æ ¸å¢å¼ºæœºåˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ namespaces -\u0026gt; è¿›ç¨‹â€œçœ‹åˆ°çš„ä¸–ç•Œâ€éš”ç¦» â”‚ â”‚ â”‚ â”‚ cgroups -\u0026gt; CPU / å†…å­˜ / IO / ç½‘ç»œé™åˆ¶ â”‚ â”‚ â”‚ â”‚ UnionFS -\u0026gt; æ–‡ä»¶ç³»ç»Ÿå±‚å ï¼ˆoverlayfsï¼‰ â”‚ â”‚ â”‚ â”‚ NUMA -\u0026gt; ç¡¬ä»¶å†…å­˜æ‹“æ‰‘æ„ŸçŸ¥ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² â”‚ é©±åŠ¨ / ä¸­æ–­ / DMA â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¡¬ä»¶å±‚ â”‚ â”‚ CPU / å†…å­˜ / ç¡¬ç›˜ / ç½‘å¡ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ“Œ å¿«é€Ÿç†è§£ï¼ˆåªçœ‹è¿™å‡ è¡Œä¹Ÿå¤Ÿï¼‰ ç¡¬ä»¶ï¼šæä¾›çœŸå®èµ„æº Linux å†…æ ¸ï¼šç®¡ç†å’ŒæŠ½è±¡èµ„æº äº”å¤§å­ç³»ç»Ÿï¼šå†…æ ¸çš„åŸºç¡€èƒ½åŠ› namespacesï¼šéš”ç¦»â€œä½ çœ‹åˆ°ä»€ä¹ˆâ€ cgroupsï¼šé™åˆ¶â€œä½ èƒ½ç”¨å¤šå°‘â€ UnionFS / overlayfsï¼šç»„ç»‡å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ libc / shell / systemdï¼šä½¿ç”¨å†…æ ¸èƒ½åŠ› runcï¼šæŠŠéš”ç¦» + é™åˆ¶ + æ–‡ä»¶ç³»ç»Ÿæ‹¼æˆâ€œå®¹å™¨è¿›ç¨‹â€ Docker / Kubernetesï¼šåœ¨ runc ä¹‹ä¸Šçš„å·¥ç¨‹åŒ–å¹³å° ğŸ¯ ä¸€å¥è¯ç»ˆæå¿ƒæ™ºæ¨¡å‹ å®¹å™¨ä¸æ˜¯è™šæ‹Ÿæœº å®¹å™¨æ˜¯ï¼šLinux å†…æ ¸ + ä¸€ç»„å—é™ã€è¢«éš”ç¦»çš„è¿›ç¨‹\n","description":" ä¸€ã€æ€»è§ˆï¼šä»ç¡¬ä»¶åˆ°å®¹å™¨çš„å®Œæ•´åˆ†å±‚ +-------------------------------------------------------------------+ åº”ç”¨ç¨‹åº / æœåŠ¡ MySQL / Nginx / Redis / Java / Python +-------------------------------------------------------------------+ å®¹å™¨å¹³å° (å¯é€‰) Docker / containerd / Podman / Kubernetes +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´: å®¹å™¨è¿è¡Œæ—¶ runc +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´: åŸºç¡€ç»„ä»¶ shell / libc / systemd / coreutils +-------------------------------------------------------------------+ Linux å†…æ ¸ç©ºé—´ - äº”å¤§å­ç³»ç»Ÿ: è¿›ç¨‹ç®¡ç† / å†…å­˜ç®¡ç† / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œå­ç³»ç»Ÿ / è®¾å¤‡ä¸é©±åŠ¨ - å¢å¼ºæœºåˆ¶: Namespaces / cgroups / UnionFS / KVM +-------------------------------------------------------------------+ ç¡¬ä»¶å±‚ CPU / å†…å­˜ / ç¡¬ç›˜ / ç½‘å¡ +-------------------------------------------------------------------+ äºŒã€ç¡¬ä»¶å±‚ï¼šä¸€åˆ‡èµ„æºçš„æºå¤´ 1ï¸âƒ£ CPU æä¾›æŒ‡ä»¤æ‰§è¡Œèƒ½åŠ› æä¾›å¤šæ ¸ã€å¤š NUMA èŠ‚ç‚¹ æä¾›ç‰¹æƒçº§ï¼ˆç”¨æˆ·æ€ / å†…æ ¸æ€ï¼‰ å†…æ ¸å¦‚ä½•ä½¿ç”¨ CPU è¿›ç¨‹è°ƒåº¦å™¨å†³å®š å“ªä¸ªè¿›ç¨‹åœ¨å“ªä¸ª CPU ä¸Šè¿è¡Œ ä¸­æ–­å¤„ç†ã€è½¯ä¸­æ–­ã€è°ƒåº¦æ—¶é’Ÿ 2ï¸âƒ£ å†…å­˜ï¼ˆRAMï¼‰ æä¾›ç‰©ç†å†…å­˜é¡µ NUMA æ¶æ„å†³å®šè®¿é—®å»¶è¿Ÿ å†…æ ¸å¦‚ä½•ä½¿ç”¨å†…å­˜ é¡µåˆ†é…ã€é¡µå›æ”¶ è™šæ‹Ÿå†…å­˜ã€é¡µè¡¨ OOM Killer 3ï¸âƒ£ ç¡¬ç›˜ï¼ˆDiskï¼‰ æä¾›æŒä¹…åŒ–å­˜å‚¨ å—è®¾å¤‡æ¥å£ å†…æ ¸å¦‚ä½•ä½¿ç”¨ç¡¬ç›˜ å—å±‚è°ƒåº¦ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ ç¼“å­˜é¡µï¼ˆPage Cacheï¼‰ 4ï¸âƒ£ ç½‘å¡ï¼ˆNICï¼‰ æä¾›ç½‘ç»œæ”¶å‘èƒ½åŠ› ä¸­æ–­è§¦å‘æ•°æ®å¤„ç† å†…æ ¸å¦‚ä½•ä½¿ç”¨ç½‘å¡ ç½‘ç»œåè®®æ ˆ ä¸­æ–­ / NAPI Socket æ¥å£ ä¸‰ã€Linux å†…æ ¸ç©ºé—´ï¼šèµ„æºçš„â€œç®¡ç†è€…â€ äº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼ˆæ ¹åŸºï¼‰ 1ï¸âƒ£ è¿›ç¨‹ç®¡ç† è¿›ç¨‹åˆ›å»ºã€é”€æ¯ è°ƒåº¦ ä¿¡å· PID 2ï¸âƒ£ å†…å­˜ç®¡ç† è™šæ‹Ÿå†…å­˜ é¡µç¼“å­˜ NUMA OOM 3ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿ VFS å„ç±»æ–‡ä»¶ç³»ç»Ÿï¼ˆext4ã€xfsã€overlayfsï¼‰ 4ï¸âƒ£ ç½‘ç»œå­ç³»ç»Ÿ TCP/IP åè®®æ ˆ Socket Netfilter 5ï¸âƒ£ è®¾å¤‡ä¸é©±åŠ¨ å—è®¾å¤‡ å­—ç¬¦è®¾å¤‡ ä¸­æ–­ç®¡ç† å†…æ ¸å¢å¼ºæœºåˆ¶ï¼ˆä¸æ˜¯å­ç³»ç»Ÿï¼‰ namespacesï¼ˆéš”ç¦»è§†å›¾ï¼‰ éš”ç¦»å¯¹è±¡ ä¾èµ–å­ç³»ç»Ÿ PID è¿›ç¨‹ç®¡ç† ç½‘ç»œ ç½‘ç»œå­ç³»ç»Ÿ æŒ‚è½½ æ–‡ä»¶ç³»ç»Ÿ ç”¨æˆ· è¿›ç¨‹ç®¡ç† -\u0026gt; å†³å®šâ€œä½ çœ‹åˆ°ä»€ä¹ˆâ€\n"},{"id":116,"href":"/operations/linux/how-containers-use-hardware-resources/","title":"å®¹å™¨å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶èµ„æº","parent":"Linux","content":"ä¸‹é¢æ˜¯ä¸€ä»½æŠŠâ€œå®¹å™¨å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶èµ„æºâ€ä»å†…æ ¸è·¯å¾„ä¸€æ¬¡æ€§è®²é€çš„æ€»ç»“ã€‚\nä¸æ˜¯ â€œå®¹å™¨æ€ä¹ˆç”¨ CPU/å†…å­˜â€ çš„è¡¨é¢ç­”æ¡ˆï¼Œè€Œæ˜¯ â€œè¯·æ±‚æ˜¯å¦‚ä½•ä»å®¹å™¨ -\u0026gt; å†…æ ¸ -\u0026gt; ç¡¬ä»¶â€ã€‚\næŒ‰ æ€»ä½“æ¨¡å‹ -\u0026gt; CPU -\u0026gt; å†…å­˜ -\u0026gt; å­˜å‚¨ -\u0026gt; ç½‘ç»œ -\u0026gt; èµ„æºéš”ç¦»ä¸é™åˆ¶çš„ååŒ æ¥è®²ã€‚\nä¸€ã€æ€»è§ˆï¼šå®¹å™¨è®¿é—®ç¡¬ä»¶çš„çœŸå®æ¨¡å‹ å®¹å™¨ä¸æ˜¯è™šæ‹Ÿç¡¬ä»¶ï¼Œè€Œæ˜¯ï¼šä¸€ç»„å—é™çš„ Linux è¿›ç¨‹ã€‚\næœ¬è´¨å…¬å¼\nå®¹å™¨ = Namespaceï¼ˆçœ‹ä¸è§åˆ«äººï¼‰ + cgroupsï¼ˆç”¨ä¸å¤šã€ç”¨ä¸è¶…ï¼‰ + Linux å†…æ ¸ï¼ˆçœŸæ­£è®¿é—®ç¡¬ä»¶ï¼‰ ğŸ“Œ æ²¡æœ‰ Hypervisorï¼Œæ²¡æœ‰è™šæ‹Ÿ CPUï¼Œæ²¡æœ‰è™šæ‹Ÿå†…å­˜æ§åˆ¶å™¨\näºŒã€CPUï¼šå®¹å™¨å¦‚ä½•â€œä½¿ç”¨â€CPU 1ï¸âƒ£ è°ƒåº¦æœ¬è´¨ å®¹å™¨è¿›ç¨‹ = æ™®é€š Linux è¿›ç¨‹\nCPU è°ƒåº¦ä»ç„¶æ˜¯ï¼š\nCFSï¼ˆCompletely Fair Schedulerï¼‰ RT / DLï¼ˆå®æ—¶è°ƒåº¦ï¼‰ 2ï¸âƒ£ cgroups v2ï¼šCPU é™åˆ¶æœºåˆ¶ æ ¸å¿ƒæ§åˆ¶ç‚¹\n/sys/fs/cgroup/\u0026lt;container\u0026gt;/cpu.max ç¤ºä¾‹ï¼š\ncpu.max = 50000 100000 å«ä¹‰ï¼š\næ¯ 100ms æœ€å¤šè·‘ 50msï¼ˆ50% CPUï¼‰ 3ï¸âƒ£ è°ƒåº¦è·¯å¾„ï¼ˆå…³é”®ï¼‰ å®¹å™¨è¿›ç¨‹ -\u0026gt; CFS è°ƒåº¦é˜Ÿåˆ— -\u0026gt; cgroup é™é¢æ£€æŸ¥ -\u0026gt; CPU æ ¸å¿ƒ ğŸ“Œ CPU æ˜¯â€œæ—¶é—´ç‰‡é™åˆ¶â€ï¼Œä¸æ˜¯â€œæ ¸æ•°éš”ç¦»â€\n4ï¸âƒ£ CPU äº²å’Œæ€§ï¼ˆcpusetï¼‰ cpuset.cpus = 0-3 æ•ˆæœï¼š\nå®¹å™¨åªä¼šåœ¨æŒ‡å®š CPU ä¸Šè¿è¡Œ NUMA åœºæ™¯éå¸¸é‡è¦ 5ï¸âƒ£ å®¹å™¨â€œæŠ¢ä¸åˆ° CPUâ€çš„çœŸå®åŸå›  èŠ‚ç‚¹è¿‡è½½ CPU quota å¤ªå° åŒ cgroup å†…éƒ¨ç«äº‰ ä¸‰ã€å†…å­˜ï¼šå®¹å™¨å¦‚ä½•ä½¿ç”¨å†…å­˜ï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ å†…å­˜å¹¶æœªè™šæ‹ŸåŒ– æ²¡æœ‰â€œå®¹å™¨å†…å­˜â€ æ‰€æœ‰å†…å­˜æ¥è‡ªå®¿ä¸»æœº 2ï¸âƒ£ cgroups v2 å†…å­˜æ§åˆ¶ memory.max memory.current memory.swap.max 3ï¸âƒ£ å†…å­˜åˆ†é…è·¯å¾„ malloc() -\u0026gt; glibc -\u0026gt; brk / mmap -\u0026gt; å†…æ ¸é¡µåˆ†é…å™¨ -\u0026gt; cgroup memory è®¡æ•° -\u0026gt; ç‰©ç†å†…å­˜ 4ï¸âƒ£ OOM å‘ç”Ÿçš„çœŸå®é€»è¾‘ æƒ…å†µä¸€ï¼šå®¹å™¨å†… OOM memory.current \u0026gt; memory.max -\u0026gt; cgroup OOM -\u0026gt; kill å®¹å™¨å†…è¿›ç¨‹ æƒ…å†µäºŒï¼šå®¿ä¸»æœº OOM æ‰€æœ‰å®¹å™¨ + å®¿ä¸»æœº \u0026gt; ç‰©ç†å†…å­˜ -\u0026gt; ç³»ç»Ÿçº§ OOM -\u0026gt; å¯èƒ½æ€å®¿ä¸»æœºå…³é”®è¿›ç¨‹ ğŸ“Œ å®¹å™¨å†…å­˜é™åˆ¶ â‰  ç³»ç»Ÿå®‰å…¨\n5ï¸âƒ£ Page Cache æ˜¯â€œå…±äº«â€çš„ æ–‡ä»¶ç¼“å­˜ä¸å®Œå…¨å—é™ å®¹å™¨ IO ä¼šæ±¡æŸ“å®¿ä¸»æœº cache å››ã€å­˜å‚¨ï¼šå®¹å™¨å¦‚ä½•è®¿é—®ç£ç›˜ 1ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿè§†è§’ å®¹å™¨ rootfs = overlayfs è§†å›¾ = VFS å±‚ 2ï¸âƒ£ IO å®é™…è·¯å¾„ å®¹å™¨è¿›ç¨‹ -\u0026gt; VFS -\u0026gt; OverlayFS -\u0026gt; å®é™…æ–‡ä»¶ç³»ç»Ÿï¼ˆext4 / xfsï¼‰ -\u0026gt; Block Layer -\u0026gt; IO Scheduler -\u0026gt; ç£ç›˜ 3ï¸âƒ£ overlay2 çš„å…³é”®å½±å“ metadata æ“ä½œå¤š copy-up æˆæœ¬é«˜ fsync è¡Œä¸ºå¤æ‚ ğŸ“Œ è¿™æ˜¯å®¹å™¨ç£ç›˜æ€§èƒ½æ³¢åŠ¨çš„æ ¹æº\n4ï¸âƒ£ cgroups v2 IO é™é€Ÿ io.max io.bfq.weight ç¤ºä¾‹ï¼š\nio.max = 8:0 rbps=10M wbps=5M 5ï¸âƒ£ ä¸ºä»€ä¹ˆæ•°æ®åº“ä¸ç”¨ overlay2ï¼Ÿ rename éåŸå­ fsync ä¸å¯é  inode ä¸ç¨³å®š ğŸ‘‰ å¿…é¡»ç”¨ bind mount / volume\näº”ã€ç½‘ç»œï¼šå®¹å™¨å¦‚ä½•â€œæ¥å…¥ç½‘ç»œâ€ 1ï¸âƒ£ Network Namespace å®¹å™¨æ‹¥æœ‰ï¼š\nç‹¬ç«‹ç½‘å¡è§†å›¾ ç‹¬ç«‹è·¯ç”±è¡¨ ç‹¬ç«‹ iptables 2ï¸âƒ£ vethï¼šè™šæ‹Ÿç½‘çº¿ å®¹å™¨ eth0 â†-\u0026gt; vethXXX â†-\u0026gt; å®¿ä¸»æœº 3ï¸âƒ£ æ•°æ®åŒ…è·¯å¾„ï¼ˆç»å…¸ï¼‰ å®¹å™¨è¿›ç¨‹ -\u0026gt; socket -\u0026gt; netns -\u0026gt; veth -\u0026gt; bridge / ovs -\u0026gt; iptables / nftables -\u0026gt; ç‰©ç†ç½‘å¡ 4ï¸âƒ£ NAT / DNAT å®¹å™¨ IP é€šå¸¸æ˜¯ç§æœ‰ å®¿ä¸»æœºè´Ÿè´£åœ°å€è½¬æ¢ 5ï¸âƒ£ ç½‘ç»œæ€§èƒ½ç“¶é¢ˆç‚¹ veth copy conntrack iptables è§„åˆ™è¿‡å¤š ğŸ“Œ é«˜æ€§èƒ½åœºæ™¯ï¼š\nhostNetwork SR-IOV DPDK å…­ã€èµ„æºéš”ç¦»çš„æ ¸å¿ƒç»„ä»¶å¦‚ä½•ååŒ ç»„ä»¶ ä½œç”¨ Namespace â€œçœ‹ä¸è§åˆ«äººâ€ cgroups â€œç”¨ä¸å¤šã€ä¸è¶…ç”¨â€ Scheduler å®é™…åˆ†é… VFS / Net æŠ½è±¡ç¡¬ä»¶ ä¸ƒã€å®¹å™¨ vs è™šæ‹Ÿæœºï¼ˆå…³é”®å¯¹æ¯”ï¼‰ ç»´åº¦ å®¹å™¨ è™šæ‹Ÿæœº CPU æ—¶é—´ç‰‡é™åˆ¶ vCPU å†…å­˜ å…±äº«ç‰©ç†å†…å­˜ è™šæ‹Ÿå†…å­˜ å†…æ ¸ å…±ç”¨ ç‹¬ç«‹ IO å…±ç”¨ block å±‚ è™šæ‹Ÿç£ç›˜ å®‰å…¨è¾¹ç•Œ è¿›ç¨‹çº§ ç¡¬ä»¶çº§ ğŸ“Œ å®¹å™¨æ˜¯â€œè°ƒåº¦éš”ç¦»â€ï¼ŒVM æ˜¯â€œç¡¬ä»¶éš”ç¦»â€\nå…«ã€å¸¸è§è¯¯åŒºæ¾„æ¸… âŒ å®¹å™¨æœ‰è‡ªå·±çš„ CPU/å†…å­˜ -\u0026gt; é”™ï¼Œæ˜¯é™åˆ¶ï¼Œä¸æ˜¯æ‹¥æœ‰\nâŒ é™åˆ¶å†…å­˜å°±ä¸ä¼š OOM -\u0026gt; é”™ï¼Œå®¿ä¸»æœºä»å¯èƒ½ OOM\nâŒ å®¹å™¨ IO æ˜¯ç‹¬ç«‹çš„ -\u0026gt; é”™ï¼Œå…±äº« block å±‚\nä¹ã€æ€»ç»“ å®¹å™¨è®¿é—®èµ„æºçš„æœ¬è´¨ï¼šè¿›ç¨‹ -\u0026gt; å†…æ ¸ -\u0026gt; ç¡¬ä»¶ï¼Œcgroups åªæ˜¯â€œé˜€é—¨â€ï¼ŒNamespace åªæ˜¯â€œé®ç½©â€ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½æŠŠâ€œå®¹å™¨å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶èµ„æºâ€ä»å†…æ ¸è·¯å¾„ä¸€æ¬¡æ€§è®²é€çš„æ€»ç»“ã€‚\nä¸æ˜¯ â€œå®¹å™¨æ€ä¹ˆç”¨ CPU/å†…å­˜â€ çš„è¡¨é¢ç­”æ¡ˆï¼Œè€Œæ˜¯ â€œè¯·æ±‚æ˜¯å¦‚ä½•ä»å®¹å™¨ -\u0026gt; å†…æ ¸ -\u0026gt; ç¡¬ä»¶â€ã€‚\næŒ‰ æ€»ä½“æ¨¡å‹ -\u0026gt; CPU -\u0026gt; å†…å­˜ -\u0026gt; å­˜å‚¨ -\u0026gt; ç½‘ç»œ -\u0026gt; èµ„æºéš”ç¦»ä¸é™åˆ¶çš„ååŒ æ¥è®²ã€‚\nä¸€ã€æ€»è§ˆï¼šå®¹å™¨è®¿é—®ç¡¬ä»¶çš„çœŸå®æ¨¡å‹ å®¹å™¨ä¸æ˜¯è™šæ‹Ÿç¡¬ä»¶ï¼Œè€Œæ˜¯ï¼šä¸€ç»„å—é™çš„ Linux è¿›ç¨‹ã€‚\næœ¬è´¨å…¬å¼\nå®¹å™¨ = Namespaceï¼ˆçœ‹ä¸è§åˆ«äººï¼‰ + cgroupsï¼ˆç”¨ä¸å¤šã€ç”¨ä¸è¶…ï¼‰ + Linux å†…æ ¸ï¼ˆçœŸæ­£è®¿é—®ç¡¬ä»¶ï¼‰ ğŸ“Œ æ²¡æœ‰ Hypervisorï¼Œæ²¡æœ‰è™šæ‹Ÿ CPUï¼Œæ²¡æœ‰è™šæ‹Ÿå†…å­˜æ§åˆ¶å™¨\näºŒã€CPUï¼šå®¹å™¨å¦‚ä½•â€œä½¿ç”¨â€CPU 1ï¸âƒ£ è°ƒåº¦æœ¬è´¨ å®¹å™¨è¿›ç¨‹ = æ™®é€š Linux è¿›ç¨‹\n"},{"id":117,"href":"/operations/linux/why-is-the-database-not-suitable-for-running-in-containers/","title":"æ•°æ®åº“ä¸ºä»€ä¹ˆä¸é€‚åˆè·‘åœ¨å®¹å™¨","parent":"Linux","content":"è¿™æ˜¯ä¸€ä¸ªéå¸¸â€œå€¼é’±â€çš„é—®é¢˜ã€‚\nä¸æ˜¯â€œèƒ½ä¸èƒ½â€ï¼Œè€Œæ˜¯ â€œä¸ºä»€ä¹ˆåœ¨å·¥ç¨‹ä¸Šä¸é€‚åˆâ€ã€‚\nç”¨ ç¡¬ä»¶ / NUMA / cgroups / Linux å†…æ ¸ / å®¹å™¨æ¨¡å‹ æ¢³ç†ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆé¿å…è¯¯è§£ï¼‰ æ•°æ®åº“ä¸æ˜¯â€œä¸èƒ½â€è·‘åœ¨å®¹å™¨é‡Œï¼Œè€Œæ˜¯ï¼šåœ¨å¤§å¤šæ•°ç”Ÿäº§åœºæ™¯ä¸‹ï¼Œå®¹å™¨çš„æŠ½è±¡å±‚ä¸æ•°æ®åº“çš„æ€§èƒ½æ¨¡å‹æ˜¯â€œåå‘çš„â€ã€‚\næ¢å¥è¯è¯´ï¼š\næ•°æ®åº“è¿½æ±‚ç¡®å®šæ€§ å®¹å™¨è¿½æ±‚å¼¹æ€§ä¸å…±äº« ä¸¤è€…å¤©ç”Ÿå†²çªã€‚\näºŒã€æ•°æ®åº“çœŸæ­£ä¾èµ–çš„æ˜¯ä»€ä¹ˆï¼Ÿ æ•°æ®åº“ï¼ˆMySQL / PostgreSQL / Oracle / Redisï¼‰çœŸæ­£åƒçš„ä¸æ˜¯â€œCPU æ ¸æ•°â€ï¼Œè€Œæ˜¯ï¼š\nå†…å­˜ç¡®å®šæ€§ IO å»¶è¿Ÿç¨³å®šæ€§ NUMA æœ¬åœ°æ€§ fsync è¯­ä¹‰å¯é  è°ƒåº¦å¯é¢„æœŸ ä¸‰ã€æ ¸å¿ƒå†²çªç‚¹ä¸€ï¼šå†…å­˜ï¼ˆè‡´å‘½ï¼‰ 1ï¸âƒ£ æ•°æ®åº“çš„å†…å­˜æ¨¡å‹ ä»¥ MySQL / PostgreSQL ä¸ºä¾‹ï¼š\nBuffer Pool / Shared Buffers é•¿æ—¶é—´å¸¸é©» è‡ªå·±ç®¡ç†æ·˜æ±° ğŸ“Œ æ•°æ®åº“ä¸å¸Œæœ›å†…æ ¸æ’æ‰‹\n2ï¸âƒ£ å®¹å™¨çš„å†…å­˜æ¨¡å‹ï¼ˆcgroupsï¼‰ memory.max memory.high é—®é¢˜æ¥äº†ï¼š\nè¡Œä¸º åæœ memory.high é¢‘ç¹å›æ”¶ memory.max ç›´æ¥ OOM kill swap å»¶è¿Ÿçˆ†ç‚¸ æ•°æ®åº“æœ€æ€•ï¼š\nè¢« OOM kill è¢«å¼ºåˆ¶å›æ”¶ page cache ğŸ“Œ æ•°æ®åº“å®å¯æ…¢ï¼Œä¹Ÿä¸æ¥å—â€œçªç„¶æ­»â€\n3ï¸âƒ£ çœŸå®äº‹æ•…æ¨¡å¼ å®¹å™¨é‡Œ MySQL çœ‹ä¼¼ç¨³å®šï¼Œé«˜å³°æœŸçªç„¶è¢« killï¼Œä¸»ä»å…¨æŒ‚ã€‚\nå››ã€æ ¸å¿ƒå†²çªç‚¹äºŒï¼šNUMAï¼ˆæ€§èƒ½æ€æ‰‹ï¼‰ 1ï¸âƒ£ æ•°æ®åº“æåº¦ä¾èµ– NUMA æœ¬åœ°æ€§ CPU â†” å†…å­˜ é”ã€latchã€buffer è£¸æœºï¼š\nnumactl --cpunodebind=0 --membind=0 mysqld 2ï¸âƒ£ å®¹å™¨å¯¹ NUMA çš„é»˜è®¤æ€åº¦ é»˜è®¤ ä¸æ„ŸçŸ¥ NUMA cgroups ä¸è‡ªåŠ¨ç»‘ mems K8S NUMA éœ€è¦é«˜çº§é…ç½® ğŸ“Œ è·¨ NUMA = å»¶è¿ŸæŠ–åŠ¨ + QPS ä¸ç¨³å®š\n3ï¸âƒ£ VM åè€Œæ›´å®‰å…¨ vNUMA Guest OS æ„ŸçŸ¥ NUMA æ•°æ®åº“å¯æ§ äº”ã€æ ¸å¿ƒå†²çªç‚¹ä¸‰ï¼šIO è·¯å¾„å¤ªé•¿ 1ï¸âƒ£ è£¸æœº IO DB -\u0026gt; FS -\u0026gt; Block -\u0026gt; Disk 2ï¸âƒ£ å®¹å™¨ IO\nDB -\u0026gt; overlay2 -\u0026gt; VFS -\u0026gt; Block -\u0026gt; Disk overlay2 çš„é—®é¢˜ï¼š\ncopy-on-write metadata æ”¾å¤§ fsync æˆæœ¬æ›´é«˜ ğŸ“Œ æ•°æ®åº“æ˜¯ fsync å¯†é›†å‹åº”ç”¨\n3ï¸âƒ£ å³ä½¿ç”¨ volumeï¼Œä¹Ÿæœ‰é—®é¢˜ shared storage IO æŠ¢å  noisy neighbor å…­ã€æ ¸å¿ƒå†²çªç‚¹å››ï¼šè°ƒåº¦ä¸å¯æ§ 1ï¸âƒ£ æ•°æ®åº“è°ƒåº¦ç‰¹æ€§ é•¿æ—¶é—´è¿è¡Œ cache çƒ­ é”æ•æ„Ÿ 2ï¸âƒ£ å®¹å™¨è°ƒåº¦æ¨¡å‹ CPU quota CFS è°ƒåº¦ throttling cpu.max=100000 100000 ğŸ“Œ throttling = TPS æŠ–åŠ¨\nä¸ƒã€æ ¸å¿ƒå†²çªç‚¹äº”ï¼šè¿ç»´è¯­ä¹‰å†²çª 1ï¸âƒ£ å®¹å™¨å“²å­¦ æ— çŠ¶æ€ å¯é‡å»º å¿«é€Ÿé”€æ¯ 2ï¸âƒ£ æ•°æ®åº“ç°å® å¼ºçŠ¶æ€ æ•°æ®ä¸€è‡´æ€§ æ•…éšœæ¢å¤ä¼˜å…ˆ ğŸ“Œ æ•°æ®åº“é‡å¯ â‰  åº”ç”¨é‡å¯\nå…«ã€ä¸ºä»€ä¹ˆå¤§å®¶â€œæ„Ÿè§‰èƒ½è·‘â€ï¼Ÿ å› ä¸ºï¼š\nåœºæ™¯ çœ‹èµ·æ¥æ²¡é—®é¢˜ æµ‹è¯•ç¯å¢ƒ å‹åŠ›ä¸å¤Ÿ å°è§„æ¨¡ NUMA æœªæ˜¾ç° SSD æ©ç›– IO é—®é¢˜ å•èŠ‚ç‚¹ æ²¡æœ‰äº‰æŠ¢ ğŸ“Œ ä¸€ä¸Šç”Ÿäº§å°±æš´é›·\nä¹ã€é‚£ä¸ºä»€ä¹ˆ Redis å¸¸è¢«æ”¾è¿›å®¹å™¨ï¼Ÿ å› ä¸ºï¼š\nç‰¹æ€§ Redis å†…å­˜æ¨¡å‹ ç®€å• IO å°‘ NUMA æ•æ„Ÿ ä½ æ¢å¤ å¿« ğŸ“Œ ä¸æ˜¯æ‰€æœ‰â€œæ•°æ®åº“â€ä¸€æ ·\nåã€é‚£ä»€ä¹ˆæ—¶å€™â€œå¯ä»¥â€æ”¾å®¹å™¨ï¼Ÿ å‹‰å¼ºå¯æ¥å—çš„æ¡ä»¶\nä¸“ç”¨èŠ‚ç‚¹ ç‹¬å  CPU / å†…å­˜ ç¦ç”¨ swap HugePages local PV static pod ğŸ“Œ æ­¤æ—¶å·²ç» ä¸åƒå®¹å™¨ï¼Œæ›´åƒè½»é‡ VM\nåä¸€ã€æ¨èæ¶æ„é€‰æ‹©ï¼ˆç»éªŒç»“è®ºï¼‰ åœºæ™¯ æ¨è æ ¸å¿ƒ OLTP è£¸æœº é‡‘è / äº¤æ˜“ è£¸æœº äº‘æ•°æ®åº“ VM è¾…åŠ©åº“ / æµ‹è¯• å®¹å™¨ Redis / Kafka è§†è§„æ¨¡ åäºŒã€æ€»ç»“ å®¹å™¨çš„æœ¬è´¨æ˜¯â€œå…±äº«â€ï¼Œè€Œæ•°æ®åº“çš„æœ¬è´¨æ˜¯â€œç‹¬å â€ã€‚\nåªè¦è®°ä½è¿™å¥è¯ï¼Œåœ¨æ¶æ„è¯„å®¡é‡Œå°±ä¸ä¼šè¾“ã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªéå¸¸â€œå€¼é’±â€çš„é—®é¢˜ã€‚\nä¸æ˜¯â€œèƒ½ä¸èƒ½â€ï¼Œè€Œæ˜¯ â€œä¸ºä»€ä¹ˆåœ¨å·¥ç¨‹ä¸Šä¸é€‚åˆâ€ã€‚\nç”¨ ç¡¬ä»¶ / NUMA / cgroups / Linux å†…æ ¸ / å®¹å™¨æ¨¡å‹ æ¢³ç†ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆé¿å…è¯¯è§£ï¼‰ æ•°æ®åº“ä¸æ˜¯â€œä¸èƒ½â€è·‘åœ¨å®¹å™¨é‡Œï¼Œè€Œæ˜¯ï¼šåœ¨å¤§å¤šæ•°ç”Ÿäº§åœºæ™¯ä¸‹ï¼Œå®¹å™¨çš„æŠ½è±¡å±‚ä¸æ•°æ®åº“çš„æ€§èƒ½æ¨¡å‹æ˜¯â€œåå‘çš„â€ã€‚\næ¢å¥è¯è¯´ï¼š\næ•°æ®åº“è¿½æ±‚ç¡®å®šæ€§ å®¹å™¨è¿½æ±‚å¼¹æ€§ä¸å…±äº« ä¸¤è€…å¤©ç”Ÿå†²çªã€‚\näºŒã€æ•°æ®åº“çœŸæ­£ä¾èµ–çš„æ˜¯ä»€ä¹ˆï¼Ÿ æ•°æ®åº“ï¼ˆMySQL / PostgreSQL / Oracle / Redisï¼‰çœŸæ­£åƒçš„ä¸æ˜¯â€œCPU æ ¸æ•°â€ï¼Œè€Œæ˜¯ï¼š\nå†…å­˜ç¡®å®šæ€§ IO å»¶è¿Ÿç¨³å®šæ€§ NUMA æœ¬åœ°æ€§ fsync è¯­ä¹‰å¯é  è°ƒåº¦å¯é¢„æœŸ ä¸‰ã€æ ¸å¿ƒå†²çªç‚¹ä¸€ï¼šå†…å­˜ï¼ˆè‡´å‘½ï¼‰ 1ï¸âƒ£ æ•°æ®åº“çš„å†…å­˜æ¨¡å‹ ä»¥ MySQL / PostgreSQL ä¸ºä¾‹ï¼š\n"},{"id":118,"href":"/operations/linux/hardware-kernel-virtualization-containers/","title":"ç¡¬ä»¶ å†…æ ¸ è™šæ‹ŸåŒ– å®¹å™¨åŒ–","parent":"Linux","content":"ä¸‹é¢æ˜¯ä»ç¡¬ä»¶ -\u0026gt; å†…æ ¸ -\u0026gt; è™šæ‹ŸåŒ– -\u0026gt; å®¹å™¨åŒ–çš„ä¸€ä½“åŒ–è®¤çŸ¥æ¡†æ¶ï¼Œä¸æ˜¯é›¶æ•£çŸ¥è¯†ç‚¹ï¼Œè€Œæ˜¯ä¸€æ¡å®Œæ•´æŠ€æœ¯æ¼”è¿›é“¾ã€‚\nç”¨ NUMA / Namespace / cgroups / overlay2 / systemd ä¸²èµ·æ¥ã€‚\nä¸€ã€æ€»ä½“ä¸€å¼ å›¾ï¼ˆå…ˆå»ºç«‹â€œä¸–ç•Œè§‚â€ï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¡¬ ä»¶ (Hardware) â”‚ â”‚ CPU / å†…å­˜ / ç£ç›˜ / ç½‘å¡ / NUMA â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Linux å†…æ ¸ (Kernel) â”‚ â”‚ è°ƒåº¦ / å†…å­˜ / ç½‘ç»œ / IO / ä¸­æ–­ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è™šæ‹ŸåŒ– (Virtualization) â”‚ â”‚ KVM / QEMU / vCPU / vNUMA â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å®¹å™¨åŒ– (Containers) â”‚ â”‚ Namespace + cgroups + FS â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒï¼š\nè™šæ‹ŸåŒ– æ˜¯ â€œé€ ä¸€å°å‡æœºå™¨â€ å®¹å™¨åŒ– æ˜¯ â€œåœ¨åŒä¸€ä¸ªå†…æ ¸é‡Œåˆ†ä¸–ç•Œâ€ äºŒã€ç¡¬ä»¶å±‚ï¼šä¸€åˆ‡æ€§èƒ½å’Œè¾¹ç•Œçš„æ ¹æº 1ï¸âƒ£ CPUï¼ˆç®—åŠ›çš„æœ¬è´¨ï¼‰ å…³é”®ç‚¹\nCore / Threadï¼ˆHTï¼‰ Cacheï¼ˆL1/L2/L3ï¼‰ NUMAï¼ˆå¤šè·¯æœåŠ¡å™¨ï¼‰ Linux è§†è§’\nlscpu numactl --hardware ğŸ“Œ å†…æ ¸è°ƒåº¦å™¨å¿…é¡»æ„ŸçŸ¥ NUMAï¼Œå¦åˆ™æ€§èƒ½ç›´æ¥è…°æ–©\n2ï¸âƒ£ å†…å­˜ï¼ˆæœ€æ˜‚è´µèµ„æºï¼‰ DRAM NUMA Node HugePage Swap Linux æŠ½è±¡ï¼š\nè™šæ‹Ÿå†…å­˜ Page Cache Slab ğŸ“Œ æ•°æ®åº“ / JVM æœ€æ€•ï¼š\nè·¨ NUMA è®¿é—® THP ä¸å—æ§ 3ï¸âƒ£ ç£ç›˜ï¼ˆIO å†³å®šä¸Šé™ï¼‰ HDD / SSD / NVMe é˜Ÿåˆ—æ·±åº¦ ä¸­æ–­ \u0026amp; è½¯ä¸­æ–­ Linuxï¼š\nVFS Block Layer IO Schedulerï¼ˆmq-deadline / noneï¼‰ 4ï¸âƒ£ ç½‘å¡ï¼ˆç½‘ç»œå°±æ˜¯ä¸­æ–­ + å†…å­˜ï¼‰ RSS å¤šé˜Ÿåˆ— NUMA äº²å’Œ Linuxï¼š\nNAPI softirq RPS / XPS ä¸‰ã€Linux å†…æ ¸ï¼šç¡¬ä»¶çš„â€œç»Ÿä¸€æŠ½è±¡å±‚â€ 1ï¸âƒ£ å†…æ ¸å››å¤§å­ç³»ç»Ÿ å­ç³»ç»Ÿ ä½œç”¨ Scheduler CPU è°ƒåº¦ Memory å†…å­˜ç®¡ç† VFS æ–‡ä»¶ç³»ç»Ÿ Networking ç½‘ç»œæ ˆ 2ï¸âƒ£ å†…æ ¸åšäº†ä»€ä¹ˆï¼Ÿ æŠŠç¡¬ä»¶å˜æˆæŠ½è±¡èµ„æº æŠŠèµ„æºå…¬å¹³æˆ–å¯æ§åœ°åˆ†ç»™è¿›ç¨‹ ğŸ“Œ ä¸€åˆ‡éš”ç¦»ã€é™åˆ¶éƒ½å‘ç”Ÿåœ¨å†…æ ¸\nå››ã€è™šæ‹ŸåŒ–ï¼šåœ¨ç¡¬ä»¶ä¹‹ä¸Šå†â€œé€ ç¡¬ä»¶â€ 1ï¸âƒ£ è™šæ‹ŸåŒ–è§£å†³ä»€ä¹ˆï¼Ÿ å¤šæ“ä½œç³»ç»Ÿå¹¶å­˜\nä¸åŒå†…æ ¸ ä¸åŒ OS å¼ºéš”ç¦» 2ï¸âƒ£ KVM æœ¬è´¨ KVM = Linux å†…æ ¸æ¨¡å— QEMU = ç”¨æˆ·æ€è®¾å¤‡æ¨¡æ‹Ÿ CPUï¼šç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVT-x / AMD-Vï¼‰ å†…å­˜ï¼šEPT / NPT IOï¼švirtio 3ï¸âƒ£ vCPU / vNUMA vCPU æ˜ å°„åˆ° pCPU vNUMA å¯¹é½ç‰©ç† NUMA ğŸ“Œ æ•°æ®åº“è™šæ‹Ÿæœºå¿…é¡»å¼€ vNUMA\n4ï¸âƒ£ è™šæ‹ŸåŒ–æˆæœ¬ é¡¹ æˆæœ¬ CPU ä½ å†…å­˜ ä¸­ IO é«˜ äº”ã€å®¹å™¨åŒ–ï¼šä¸é€ æœºå™¨ï¼Œåªâ€œåˆ†ä¸–ç•Œâ€ 1ï¸âƒ£ å®¹å™¨ä¸è™šæ‹Ÿç¡¬ä»¶ å…±äº«å®¿ä¸»å†…æ ¸ å…±äº«é©±åŠ¨ å…±äº«è°ƒåº¦å™¨ ğŸ“Œ è¿™å°±æ˜¯å¿«çš„åŸå› \n2ï¸âƒ£ å®¹å™¨ä¸‰å¤§æ ¸å¿ƒ æŠ€æœ¯ ä½œç”¨ Namespace éš”ç¦» cgroups é™åˆ¶ RootFS æ–‡ä»¶è§†å›¾ 3ï¸âƒ£ Namespaceï¼ˆä½ çœ‹åˆ°äº†ä»€ä¹ˆï¼‰ PID NET MOUNT UTS USER 4ï¸âƒ£ cgroupsï¼ˆä½ èƒ½ç”¨å¤šå°‘ï¼‰ CPU Memory IO PIDs 5ï¸âƒ£ overlay2ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ lowerdirï¼ˆé•œåƒï¼‰ upperdirï¼ˆå†™å±‚ï¼‰ merged ğŸ“Œ copy-on-write\nå…­ã€è™šæ‹ŸåŒ– vs å®¹å™¨åŒ–ï¼ˆæœ¬è´¨å¯¹æ¯”ï¼‰ ç»´åº¦ è™šæ‹Ÿæœº å®¹å™¨ å†…æ ¸ ç‹¬ç«‹ å…±äº« å¯åŠ¨ æ…¢ æå¿« éš”ç¦» å¼º ä¸­ æ€§èƒ½ æœ‰æŸ è¿‘ä¹è£¸æœº å®‰å…¨ æ›´å¼º ä¾èµ–å†…æ ¸ ä¸ƒã€NUMAï¼šè´¯ç©¿ç¡¬ä»¶ã€è™šæ‹ŸåŒ–ã€å®¹å™¨çš„â€œæš—çº¿â€ 1ï¸âƒ£ è£¸æœº CPU â†” å†…å­˜äº²å’Œ 2ï¸âƒ£ è™šæ‹Ÿæœº vNUMA â†” pNUMA 3ï¸âƒ£ å®¹å™¨ cpuset.cpus cpuset.mems ğŸ“Œ å¿½ç•¥ NUMA = é«˜è´Ÿè½½å¿…ç¿»è½¦\nå…«ã€systemdï¼šç°ä»£ Linux çš„â€œèµ„æºæ€»æ§å°â€ æ‰€æœ‰ service éƒ½æ˜¯ cgroup slice = èµ„æºåŸŸ service = è¿›ç¨‹é›†åˆ CPUQuota=200% MemoryMax=4G ğŸ“Œ systemd = cgroups v2 ç®¡ç†å™¨\nä¹ã€Kubernetesï¼šæŠŠå®¹å™¨é—®é¢˜è§„æ¨¡åŒ– K8S åšäº†ä»€ä¹ˆï¼Ÿ\nè°ƒåº¦ï¼ˆCPU / å†…å­˜ / NUMAï¼‰ ç½‘ç»œï¼ˆCNIï¼‰ å­˜å‚¨ï¼ˆCSIï¼‰ ç”Ÿå‘½å‘¨æœŸ ğŸ“Œ K8S = å¤§è§„æ¨¡å®¹å™¨èµ„æºè°ƒåº¦ç³»ç»Ÿ\nåã€å…¸å‹æ¶æ„ç»„åˆï¼ˆä½ ä¸€å®šä¼šé‡åˆ°ï¼‰ åœºæ™¯ 1ï¼šäº‘æœåŠ¡å™¨ ç‰©ç†æœº â””â”€ KVM â””â”€ VM â””â”€ Docker åœºæ™¯ 2ï¼šç§æœ‰äº‘ ç‰©ç†æœº â””â”€ K8S â””â”€ Pod åœºæ™¯ 3ï¼šæ•°æ®åº“ è£¸æœº / VM + NUMA ç»‘å®š + HugePage åä¸€ã€ç”Ÿäº§ç»éªŒæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… æ­£ç¡®ç†è§£ å†…æ ¸æ˜¯æ ¸å¿ƒ å®¹å™¨ä¸æ˜¯ VM NUMA å½±å“ä¸€åˆ‡ systemd å°±æ˜¯ cgroup âŒ å¸¸è§è¯¯åŒº å®¹å™¨å½“ VM ç”¨ ä¸è®¾èµ„æºä¸Šé™ å¿½ç•¥ IO åœ¨å®¹å™¨é‡Œè°ƒå†…æ ¸å‚æ•° åäºŒã€æ€»ç»“ ç¡¬ä»¶å†³å®šä¸Šé™ å†…æ ¸å†³å®šè§„åˆ™ è™šæ‹ŸåŒ–å†³å®šè¾¹ç•Œ å®¹å™¨åŒ–å†³å®šæ•ˆç‡ ","description":"ä¸‹é¢æ˜¯ä»ç¡¬ä»¶ -\u0026gt; å†…æ ¸ -\u0026gt; è™šæ‹ŸåŒ– -\u0026gt; å®¹å™¨åŒ–çš„ä¸€ä½“åŒ–è®¤çŸ¥æ¡†æ¶ï¼Œä¸æ˜¯é›¶æ•£çŸ¥è¯†ç‚¹ï¼Œè€Œæ˜¯ä¸€æ¡å®Œæ•´æŠ€æœ¯æ¼”è¿›é“¾ã€‚\nç”¨ NUMA / Namespace / cgroups / overlay2 / systemd ä¸²èµ·æ¥ã€‚\nä¸€ã€æ€»ä½“ä¸€å¼ å›¾ï¼ˆå…ˆå»ºç«‹â€œä¸–ç•Œè§‚â€ï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¡¬ ä»¶ (Hardware) â”‚ â”‚ CPU / å†…å­˜ / ç£ç›˜ / ç½‘å¡ / NUMA â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Linux å†…æ ¸ (Kernel) â”‚ â”‚ è°ƒåº¦ / å†…å­˜ / ç½‘ç»œ / IO / ä¸­æ–­ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ è™šæ‹ŸåŒ– (Virtualization) â”‚ â”‚ KVM / QEMU / vCPU / vNUMA â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å®¹å™¨åŒ– (Containers) â”‚ â”‚ Namespace + cgroups + FS â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ ¸å¿ƒï¼š\n"},{"id":119,"href":"/operations/linux/mysql-postgres-numa/","title":"MySQL / PostgreSQL NUMA æœ€ä½³å®è·µ","parent":"Linux","content":"å‰æ åŒè·¯æœåŠ¡å™¨ / ä¸­æ–­äº²å’Œæ€§ / NUMAï¼Œæ‰€ä»¥é»˜è®¤ï¼š2 Socketï¼ŒNUMA node0 + node1ï¼Œå¤§å†…å­˜åœºæ™¯\nä¸€ã€NUMA é€šç”¨æ ¸å¿ƒåŸåˆ™ï¼ˆå…ˆèƒŒä¸‹æ¥ï¼‰ 1ï¸âƒ£ CPUã€å†…å­˜ã€IRQ ä¸‰ä»¶äº‹å¿…é¡»â€œå¯¹é½â€ é¡¹ç›® å¿…é¡» CPU è¿è¡Œåœ¨å“ªä¸ª NUMA node âœ… å†…å­˜ä»å“ªä¸ª NUMA node åˆ†é… âœ… ç£ç›˜ / ç½‘å¡ IRQ åœ¨å“ªä¸ª node âœ… ğŸ‘‰ ä»»ä½•ä¸€ä¸ªé”™ä½ï¼Œæ€§èƒ½éƒ½ä¼šæŠ–ã€‚\n2ï¸âƒ£ ä¸è¦â€œåŠ NUMAâ€ âŒ é”™è¯¯ç¤ºä¾‹ï¼š\ntaskset -c 0-15 mysqld CPU ç»‘äº† å†…å­˜æ²¡ç»‘ -\u0026gt; 100% è·¨ NUMA\n3ï¸âƒ£ å¤§å®ä¾‹ä¸¤ç§æ­£ç¡®è·¯çº¿ï¼ˆåªèƒ½é€‰ä¸€ä¸ªï¼‰ æ¨¡å¼ é€‚ç”¨ å• NUMA Node ç»‘å®š å•å®ä¾‹ã€å†…å­˜ â‰¤ å• node NUMA interleave å†…å­˜ \u0026gt; å• node äºŒã€MySQL NUMA æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ å¼ºçƒˆæ¨èçš„ä¸¤ç§æ¨¡å¼ âœ… æ¨¡å¼ Aï¼šå• NUMA Node è¿è¡Œï¼ˆæœ€ä½³æ€§èƒ½ï¼‰ å‰æï¼š\nMySQL å®ä¾‹å†…å­˜ â‰¤ å• NUMA node å†…å­˜ å¯åŠ¨æ–¹å¼\nnumactl --cpunodebind=0 --membind=0 mysqld æˆ– systemdï¼š\n[Service] CPUAffinity=0-15 NUMAPolicy=local MySQL å‚æ•°å»ºè®®\ninnodb_buffer_pool_size = 90% of node memory innodb_buffer_pool_instances = 8 é€‚åˆåœºæ™¯\nOLTP é«˜ QPS å»¶è¿Ÿæ•æ„Ÿ âœ… æ¨¡å¼ Bï¼šNUMA interleaveï¼ˆå¤§å†…å­˜é€šç”¨è§£æ³•ï¼‰ å‰æï¼š\nMySQL å†…å­˜ \u0026gt; å• NUMA node å¯åŠ¨æ–¹å¼ï¼ˆå®˜æ–¹æ¨èï¼‰\nnumactl --interleave=all mysqld systemdï¼š\nNUMAPolicy=interleave NUMAMask=0,1 ä¸ºä»€ä¹ˆ interleave å¥½ï¼Ÿ\nå†…å­˜å‡åŒ€åˆ†å¸ƒ é¿å…æŸä¸ª node è¢«æ‰“æ»¡ ç¨³å®šæ€§ \u0026gt; æé™æ€§èƒ½ 2ï¸âƒ£ MySQL æ˜ç¡®â€œä¸è¦åšâ€çš„äº‹ âŒ ä¸è¦å¼€å¯ MySQL è‡ªå¸¦ NUMA innodb_numa_interleave = ON ğŸ“Œ å®˜æ–¹å»ºè®®ï¼šç”¨ numactlï¼Œä¸ç”¨ MySQL å†…éƒ¨å®ç°\nâŒ ä¸è¦å…³é—­ NUMA å†å¯åŠ¨ MySQL numactl --interleave=all â‰  BIOS å…³é—­ NUMA\nï¼ˆè¿™æ˜¯ä¸åŒæ¦‚å¿µï¼‰\n3ï¸âƒ£ MySQL NUMA éªŒè¯æ–¹å¼ numastat -p $(pidof mysqld) å…³é”®æŒ‡æ ‡ï¼š\nlocal â‰« remote interleave åœºæ™¯ï¼šnode0 / node1 æ¥è¿‘ ä¸‰ã€PostgreSQL NUMA æœ€ä½³å®è·µï¼ˆæ›´ä¸¥æ ¼ï¼‰ PostgreSQL å¯¹ NUMA éå¸¸æ•æ„Ÿï¼Œæ¯” MySQL æ›´å®¹æ˜“â€œç¿»è½¦â€ã€‚\n1ï¸âƒ£ PostgreSQL çš„é»„é‡‘è§„åˆ™ PostgreSQLï¼šå®å¯ interleaveï¼Œä¹Ÿä¸è¦åŠ NUMA\n2ï¸âƒ£ æ¨èæ¨¡å¼ âœ… æ¨¡å¼ Aï¼šå• NUMA Nodeï¼ˆå¼ºçƒˆæ¨èï¼‰ å¯åŠ¨æ–¹å¼\nnumactl --cpunodebind=0 --membind=0 postgres systemdï¼š\nCPUAffinity=0-15 NUMAPolicy=local PostgreSQL å‚æ•°\nshared_buffers = 70% of node memory work_mem = æ§åˆ¶æ€»å¹¶å‘ âœ… æ¨¡å¼ Bï¼šinterleaveï¼ˆå¤§å†…å­˜å®ä¾‹ï¼‰ numactl --interleave=all postgres 3ï¸âƒ£ PostgreSQL ä¸å»ºè®®çš„åšæ³• âŒ ä¸è¦åªç»‘ CPU\nâŒ ä¸è¦å…³é—­ kernel.numa_balancing å†ä¸ç»‘å†…å­˜\n4ï¸âƒ£ kernel.numa_balancing å»ºè®® åœºæ™¯ è®¾ç½® MySQL å…³é—­ PostgreSQL å…³é—­ echo 0 \u0026gt; /proc/sys/kernel/numa_balancing å››ã€IRQ / IO / ç½‘ç»œ ä¸ NUMAï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ ç½‘å¡ / NVMe ä¸­æ–­ ä¸­æ–­åœ¨å“ªä¸ª NUMA node DB è¿›ç¨‹å°±è·‘åœ¨å“ªä¸ª node cat /proc/interrupts 2ï¸âƒ£ ç£ç›˜ IO çº¿ç¨‹ blk-mq é»˜è®¤å¤šé˜Ÿåˆ— NUMA ä¸ä¸€è‡´ -\u0026gt; cache miss äº”ã€systemd å¯åŠ¨æ¨¡æ¿ï¼ˆé€šç”¨ï¼‰ MySQL\n[Service] CPUAffinity=0-15 NUMAPolicy=interleave NUMAMask=0,1 PostgreSQL\n[Service] CPUAffinity=0-15 NUMAPolicy=local å…­ã€éªŒè¯ checklistï¼ˆä¸Šçº¿å‰å¿…åšï¼‰ lscpu numactl --hardware numastat numastat -p mysqld numastat -p postgres ä¸ƒã€æ€§èƒ½è°ƒä¼˜ç»“è®ºï¼ˆç›´ç™½ç‰ˆï¼‰ æ•°æ®åº“ æ¨èç­–ç•¥ MySQL interleave æˆ– å• NUMA PostgreSQL å• NUMA \u0026gt; interleave ä¸¤è€… ä¸è¦åŠ NUMA å…«ã€æ€»ç»“ NUMA è°ƒä¼˜ä¸æ˜¯â€œå¼€æˆ–å…³â€ï¼Œè€Œæ˜¯ï¼šCPUã€å†…å­˜ã€IRQ ä¸‰è€…ä½ç½®å¿…é¡»ä¸€è‡´ã€‚\n","description":"å‰æ åŒè·¯æœåŠ¡å™¨ / ä¸­æ–­äº²å’Œæ€§ / NUMAï¼Œæ‰€ä»¥é»˜è®¤ï¼š2 Socketï¼ŒNUMA node0 + node1ï¼Œå¤§å†…å­˜åœºæ™¯\nä¸€ã€NUMA é€šç”¨æ ¸å¿ƒåŸåˆ™ï¼ˆå…ˆèƒŒä¸‹æ¥ï¼‰ 1ï¸âƒ£ CPUã€å†…å­˜ã€IRQ ä¸‰ä»¶äº‹å¿…é¡»â€œå¯¹é½â€ é¡¹ç›® å¿…é¡» CPU è¿è¡Œåœ¨å“ªä¸ª NUMA node âœ… å†…å­˜ä»å“ªä¸ª NUMA node åˆ†é… âœ… ç£ç›˜ / ç½‘å¡ IRQ åœ¨å“ªä¸ª node âœ… ğŸ‘‰ ä»»ä½•ä¸€ä¸ªé”™ä½ï¼Œæ€§èƒ½éƒ½ä¼šæŠ–ã€‚\n"},{"id":120,"href":"/operations/linux/mysql-postgres-cgroups/","title":"MySQL / PostgreSQL é’ˆå¯¹ cgroupsï¼ˆv2ï¼‰çš„è°ƒä¼˜æ¸…å•","parent":"Linux","content":"æŒ‰ â€œå¿…é¡»åš / å¼ºçƒˆå»ºè®® / é«˜çº§å¯é€‰ / ç»å¯¹ä¸è¦â€ åˆ†çº§ï¼Œå¹¶ä¸”åŒºåˆ† MySQL ä¸ PostgreSQL çš„å·®å¼‚ã€‚\né€‚ç”¨å‰æ\nRHEL 9 / AlmaLinux 9ï¼ˆcgroups v2ï¼‰ systemd ç®¡ç†æœåŠ¡ è£¸æœº / VM / ä¸“ç”¨èŠ‚ç‚¹ï¼ˆä¸æ˜¯æ··éƒ¨ï¼‰ ä¸€ã€æœ€é‡è¦çš„å‰æç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ æ•°æ®åº“ä½¿ç”¨ cgroups çš„åŸåˆ™æ˜¯ï¼šâ€œåªç”¨ accountingï¼Œä¸ç”¨å¼¹æ€§é™åˆ¶â€\nä¹Ÿå°±æ˜¯ï¼š\nâŒ ä¸è¦ç”¨æ¥â€œå‹â€ âœ… åªç”¨æ¥â€œéš”ç¦»ã€ä¿æŠ¤ç³»ç»Ÿâ€ äºŒã€CPU è°ƒä¼˜ï¼ˆæœ€å®¹æ˜“è¢«è¯¯ç”¨ï¼‰ âœ… å¿…é¡»åš 1ï¸âƒ£ ä¸è¦è®¾ç½® CPUQuotaï¼ˆæˆ–è®¾ä¸ºæ— é™ï¼‰ systemdï¼ˆæ¨èï¼‰\n[Service] CPUQuota=infinity æˆ–ç›´æ¥ä¸è®¾ç½®ï¼ˆé»˜è®¤æ— é™ï¼‰\nğŸ“Œ CPU throttling = TPS æŠ–åŠ¨ = æ…¢æŸ¥è¯¢çˆ†ç‚¸\n2ï¸âƒ£ æ˜ç¡® CPUWeightï¼ˆå½“æœ‰å…¶ä»–æœåŠ¡æ—¶ï¼‰ CPUWeight=100 é»˜è®¤ 100 å¯é€‚å½“æé«˜ï¼ˆ200ï½500ï¼‰ ğŸ”¥ å¼ºçƒˆå»ºè®®ï¼ˆæ•°æ®åº“ä¸“ç”¨èŠ‚ç‚¹ï¼‰\n3ï¸âƒ£ ä½¿ç”¨ cpuset ç»‘å®š CPU AllowedCPUs=0-15 æˆ–æ‰‹å·¥ï¼š\ncpuset.cpus=0-15 ğŸ“Œ é˜²æ­¢è°ƒåº¦æŠ–åŠ¨ã€è·¨ NUMA\nâŒ ç»å¯¹ä¸è¦ ä¸è¦ç”¨ \u0026ndash;cpus=2 ä¸è¦ç”¨ CPUQuota=200% ä¸è¦åœ¨é«˜å³°æœŸåŠ¨æ€æ”¹ quota ä¸‰ã€å†…å­˜è°ƒä¼˜ï¼ˆæœ€è‡´å‘½ï¼‰ âœ… å¿…é¡»åš 1ï¸âƒ£ ä¸è®¾ç½® memory.maxï¼ˆæˆ–è®¾ä¸º infinityï¼‰ MemoryMax=infinity ğŸ“Œ memory.max = OOM å®šæ—¶ç‚¸å¼¹\n2ï¸âƒ£ ç¦ç”¨ swapï¼ˆå¯¹æ•°æ®åº“ï¼‰ MemorySwapMax=0 æˆ–ç³»ç»Ÿçº§ï¼š\nswapoff -a 3ï¸âƒ£ æ˜ç¡®æ•°æ®åº“å†…å­˜ç”±æ•°æ®åº“è‡ªå·±ç®¡ç† MySQL\ninnodb_buffer_pool_size = 70%~80% RAM PostgreSQL\nshared_buffers = 25% RAM effective_cache_size = 70% RAM ğŸ”¥ å¼ºçƒˆå»ºè®® 4ï¸âƒ£ ä½¿ç”¨ memory.highï¼ˆè½¯ä¿æŠ¤ï¼Œè€Œä¸æ˜¯é™åˆ¶ï¼‰ MemoryHigh=90% ä½œç”¨ï¼š\nä¿æŠ¤å®¿ä¸» ä¸ç›´æ¥ kill æ•°æ®åº“ ğŸ“Œ memory.high \u0026gt; memory.max\n5ï¸âƒ£ å¯ç”¨ memory.oom.group echo 1 \u0026gt; memory.oom.group æˆ– systemdï¼š\nOOMPolicy=kill ğŸ“Œ é˜²æ­¢â€œåŠæ­»ä¸æ´»â€\nâŒ ç»å¯¹ä¸è¦ ä¸è¦ç”¨ docker -m 64g ä¸è¦åœ¨æ•°æ®åº“å®¹å™¨é‡Œç”¨ swap ä¸è¦è®© kubelet ç®¡æ•°æ®åº“å†…å­˜ å››ã€IO è°ƒä¼˜ï¼ˆç»å¸¸è¢«å¿½ç•¥ï¼‰ âœ… å¿…é¡»åš 1ï¸âƒ£ ä¸è¦ç”¨ overlay2 è·‘æ•°æ®ç›®å½• MySQL / PG æ•°æ®ç›®å½•ï¼š âŒ overlay âœ… hostPath / local disk / raw block 2ï¸âƒ£ IO é™é€Ÿé»˜è®¤ä¸è®¾ IOReadBandwidthMax= IOWriteBandwidthMax= ğŸ“Œ æ•°æ®åº“ ä¸æ˜¯ batch IO\nğŸ”¥ å¼ºçƒˆå»ºè®® 3ï¸âƒ£ ç‹¬å ç£ç›˜æˆ–ç‹¬ç«‹ IO cgroup IOWeight=100 æœ‰æ··éƒ¨æ—¶ï¼š\nDBï¼š200 æ™®é€šæœåŠ¡ï¼š50 âŒ ç»å¯¹ä¸è¦ ä¸è¦ blkio throttle DB ä¸è¦å¤š DB å…±äº«ä¸€ä¸ªé™é€Ÿç›˜ äº”ã€PIDs è°ƒä¼˜ï¼ˆå®¹æ˜“æ•‘å‘½ï¼‰ âœ… å¿…é¡»åš TasksMax=16384 ğŸ“Œ é˜² fork ç‚¸å¼¹\nğŸ“Œ MySQL / PG éƒ½å¯èƒ½çŸ­æ—¶é—´æ‹‰é«˜çº¿ç¨‹\nâŒ ä¸è¦ ä¸è¦ç”¨é»˜è®¤ 512 ä¸è¦æ— é™ï¼ˆä¼šæ‹–æ­»å®¿ä¸»ï¼‰ å…­ã€NUMA + cgroupsï¼ˆæ•°æ®åº“æ€§èƒ½åˆ†æ°´å²­ï¼‰ âœ… å¼ºçƒˆå»ºè®®ï¼ˆç”Ÿäº§ï¼‰ 1ï¸âƒ£ ç»‘å®š CPU + å†…å­˜åˆ°åŒä¸€ NUMA AllowedCPUs=0-15 AllowedMemoryNodes=0 æˆ–å¯åŠ¨å‘½ä»¤ï¼š\nnumactl --cpunodebind=0 --membind=0 2ï¸âƒ£ ç¦ç”¨è‡ªåŠ¨ NUMA balancingï¼ˆæ•°æ®åº“ï¼‰ echo 0 \u0026gt; /proc/sys/kernel/numa_balancing ğŸ“Œ å°¤å…¶ MySQL\nä¸ƒã€HugePagesï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ MySQL\ninnodb_buffer_pool_size innodb_use_large_pages=ON PostgreSQL\nhuge_pages=on ğŸ“Œ HugePages + cgroups = ç¨³å®šå»¶è¿Ÿ\nå…«ã€systemd æ¨èæ¨¡æ¿ï¼ˆé€šç”¨ï¼‰ [Service] CPUQuota=infinity CPUWeight=200 MemoryMax=infinity MemoryHigh=90% MemorySwapMax=0 OOMPolicy=kill TasksMax=16384 IOWeight=200 AllowedCPUs=0-15 AllowedMemoryNodes=0 ä¹ã€MySQL vs PostgreSQL çš„å…³é”®å·®å¼‚ é¡¹ç›® MySQL PostgreSQL NUMA æ•æ„Ÿ â­â­â­â­ â­â­â­ OOM å®¹å¿ æå·® è¾ƒå¥½ HugePage å¼ºçƒˆæ¨è æ¨è IO æŠ–åŠ¨ ææ•æ„Ÿ æ•æ„Ÿ cgroup å®¹å¿ ä½ ä¸­ åã€çœŸå®ç”Ÿäº§â€œç¿»è½¦æ¸…å•â€ï¼ˆä¸€å®šè¦é¿å¼€ï¼‰ âŒ memory.max + é«˜å¹¶å‘ âŒ CPUQuota + å³°å€¼æµé‡ âŒ overlay2 + fsync âŒ swap + æ•°æ®åº“ âŒ NUMA ä¸ç»‘ âŒ æ··éƒ¨ DB åä¸€ã€æ€»ç»“ æ•°æ®åº“çš„ cgroups ä¸æ˜¯â€œé™åˆ¶å™¨â€ï¼Œè€Œæ˜¯â€œä¿æŠ¤å£³â€ã€‚\nå¦‚æœä½ åœ¨â€œå‹æ•°æ®åº“â€ï¼Œè¯´æ˜æ¶æ„å·²ç»é”™äº†ã€‚\n","description":"æŒ‰ â€œå¿…é¡»åš / å¼ºçƒˆå»ºè®® / é«˜çº§å¯é€‰ / ç»å¯¹ä¸è¦â€ åˆ†çº§ï¼Œå¹¶ä¸”åŒºåˆ† MySQL ä¸ PostgreSQL çš„å·®å¼‚ã€‚\né€‚ç”¨å‰æ\nRHEL 9 / AlmaLinux 9ï¼ˆcgroups v2ï¼‰ systemd ç®¡ç†æœåŠ¡ è£¸æœº / VM / ä¸“ç”¨èŠ‚ç‚¹ï¼ˆä¸æ˜¯æ··éƒ¨ï¼‰ ä¸€ã€æœ€é‡è¦çš„å‰æç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ æ•°æ®åº“ä½¿ç”¨ cgroups çš„åŸåˆ™æ˜¯ï¼šâ€œåªç”¨ accountingï¼Œä¸ç”¨å¼¹æ€§é™åˆ¶â€\nä¹Ÿå°±æ˜¯ï¼š\nâŒ ä¸è¦ç”¨æ¥â€œå‹â€ âœ… åªç”¨æ¥â€œéš”ç¦»ã€ä¿æŠ¤ç³»ç»Ÿâ€ äºŒã€CPU è°ƒä¼˜ï¼ˆæœ€å®¹æ˜“è¢«è¯¯ç”¨ï¼‰ âœ… å¿…é¡»åš 1ï¸âƒ£ ä¸è¦è®¾ç½® CPUQuotaï¼ˆæˆ–è®¾ä¸ºæ— é™ï¼‰ systemdï¼ˆæ¨èï¼‰\n"},{"id":121,"href":"/operations/linux/numa-practice/","title":"å¤šåº”ç”¨åœºæ™¯ NUMA å®è·µ","parent":"Linux","content":"åŒæ ¸ CPU è¿è¡Œäº† PostgreSQL å’Œ Redisï¼Œç°åœ¨éœ€è¦è¿è¡Œå¤šä¸ª Python ç¨‹åºï¼Œå†…æ ¸æ˜¯å¦æœ‰å¿…è¦é…ç½® kernel.numa_balancing = 0ï¼Œå¦‚æœé…ç½®äº†ï¼Œæ˜¯å¦æœ‰å¿…è¦ä½¿ç”¨ numactl å¯åŠ¨ Python ç¨‹åºï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ã€è€Œä¸”é—®åˆ°ç‚¹å­ä¸Šçš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæŠŠ CPU æ‹“æ‰‘ã€NUMAã€å†…æ ¸ç­–ç•¥ã€åº”ç”¨å¯åŠ¨æ–¹å¼ å…¨éƒ¨ä¸²åœ¨äº†ä¸€èµ·ã€‚\nå…ˆç»™ç»“è®ºï¼Œå†è§£é‡Šä¸ºä»€ä¹ˆï¼Œæœ€åç»™å¯æ‰§è¡Œå»ºè®®ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆç›´æ¥å¯ç”¨ï¼‰ âœ… ä½ çš„åœºæ™¯ç»“è®º åŒæ ¸ CPU + PostgreSQL + Redis + å¤šä¸ª Python ç¨‹åºï¼š\næ˜¯å¦éœ€è¦å…³é—­ kernel.numa_balancingï¼Ÿ\nå¤§æ¦‚ç‡ï¼šä¸éœ€è¦ ç”šè‡³å¯ä»¥è¯´ï¼šå…³äº†åè€Œæ›´å®¹æ˜“å‡ºé—®é¢˜ å¦‚æœå…³äº† kernel.numa_balancingï¼Œæ˜¯å¦æœ‰å¿…è¦ç”¨ numactl å¯åŠ¨ Pythonï¼Ÿ\nä¸€èˆ¬æ²¡æœ‰å¿…è¦ é™¤éä½ åœ¨åš æ˜ç¡®çš„ CPU / å†…å­˜å¼ºéš”ç¦» äºŒã€ä¸ºä»€ä¹ˆï¼Ÿâ€”â€”ä»â€œNUMA æ˜¯å¦å­˜åœ¨â€è¯´èµ· 1ï¸âƒ£ ä½ çš„æœºå™¨ï¼šçœŸçš„æœ‰ NUMA å—ï¼Ÿ ä½ è¯´çš„æ˜¯ åŒæ ¸ CPUï¼Œè€Œä¸æ˜¯ åŒè·¯ CPUã€‚\nè¿™æ˜¯å…³é”®åŒºåˆ«ï¼š\nç¡¬ä»¶ NUMA æ˜¯å¦å­˜åœ¨ åŒæ ¸ï¼ˆ1 é¢— CPUï¼Œ2 coreï¼‰ âŒ åŸºæœ¬ä¸å­˜åœ¨ åŒè·¯ï¼ˆ2 é¢—ç‰©ç† CPUï¼‰ âœ… æ˜ç¡® NUMA å•è·¯ + å¤š chipletï¼ˆéƒ¨åˆ† AMDï¼‰ âš ï¸ å¯èƒ½å­˜åœ¨ åˆ¤æ–­æ–¹æ³•ï¼ˆä¸€å¥è¯ï¼‰ï¼š\nnumactl --hardware å¦‚æœç»“æœæ˜¯ï¼š\navailable: 1 nodes (0) ğŸ‘‰ è¿™å°æœºå™¨åœ¨å†…æ ¸å±‚é¢å‡ ä¹æ˜¯ UMAï¼ˆç»Ÿä¸€å†…å­˜æ¶æ„ï¼‰\nä¸‰ã€kernel.numa_balancing åˆ°åº•è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ å†…æ ¸è‡ªåŠ¨ NUMA å¹³è¡¡çš„æœ¬è´¨ è®©â€œè¿›ç¨‹åœ¨å“ªä¸ª CPU è·‘â€ï¼Œå’Œâ€œå®ƒç”¨çš„å†…å­˜åœ¨å“ªä¸ª NUMA nodeâ€å°½é‡ä¸€è‡´\nå®ƒåªåœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹æ‰çœŸæ­£æœ‰æ„ä¹‰ï¼š\nå¤š NUMA node è¿›ç¨‹é¢‘ç¹è·¨ node è®¿é—®å†…å­˜ å†…å­˜è®¿é—®æˆæœ¬å·®å¼‚æ˜æ˜¾ åœ¨ä½ è¿™ä¸ªåœºæ™¯é‡Œ é¡¹ç›® å®é™…æƒ…å†µ NUMA node æ•° åŸºæœ¬ä¸º 1 å†…å­˜è®¿é—®å·®å¼‚ å‡ ä¹æ²¡æœ‰ è‡ªåŠ¨å¹³è¡¡æ”¶ç›Š æ¥è¿‘ 0 è‡ªåŠ¨å¹³è¡¡æˆæœ¬ ä»ç„¶å­˜åœ¨ï¼ˆé¡µè¿ç§»ã€æ‰«æï¼‰ æ‰€ä»¥ï¼š\nå¼€ç€æ²¡æ”¶ç›Šï¼Œå…³äº†ä¹Ÿæ²¡æ”¶ç›Š\nå››ã€ä¸ºä»€ä¹ˆâ€œå…³æ‰ NUMA balancing + ä¸ç»‘å®šâ€åè€Œå¯èƒ½æ›´å·®ï¼Ÿ ä½ ç°åœ¨çš„è´Ÿè½½ç»“æ„æ˜¯ PostgreSQLï¼ˆé•¿æœŸå¸¸é©»ã€ç¼“å­˜æ•æ„Ÿï¼‰ Redisï¼ˆæåº¦å†…å­˜å’Œ CPU æ•æ„Ÿï¼‰ å¤šä¸ª Python ç¨‹åºï¼ˆçŸ­ç”Ÿå‘½å‘¨æœŸ / GIL / æŠ–åŠ¨ï¼‰ å¦‚æœä½ ï¼š\nâŒ å…³é—­ kernel.numa_balancing âŒ ä¸åš CPU / å†…å­˜ç»‘å®š âŒ æ ¸æ•°åˆå°‘ï¼ˆ2 æ ¸ï¼‰ é‚£ä¹ˆå†…æ ¸ä¼šï¼š\nå…è®¸è°ƒåº¦å™¨é¢‘ç¹è¿ç§» Python è¿›ç¨‹ å¯¼è‡´ PostgreSQL / Redis è¢«æŠ¢å  å‡ºç° ç¼“å­˜æŠ–åŠ¨ + ä¸Šä¸‹æ–‡åˆ‡æ¢æ”¾å¤§ ğŸ‘‰ è¿™å’Œ NUMA æ— å…³ï¼Œæ˜¯â€œCPU äº‰æŠ¢é—®é¢˜â€\näº”ã€é‚£ numactl åœ¨ä½ è¿™é‡Œæœ‰ç”¨å—ï¼Ÿ ç®€çŸ­ç»“è®º å‡ ä¹æ²¡ç”¨\nåŸå› éå¸¸ç›´æ¥ åªæœ‰ 1 ä¸ª NUMA node numactl --cpunodebind=0 å’Œä¸å†™ï¼Œæ•ˆæœä¸€æ · numactl --membind=0 ä¹Ÿæ˜¯ä¸€æ · numactl çš„å‰ææ˜¯ï¼šä½ æœ‰å¾—é€‰\nå…­ã€çœŸæ­£åº”è¯¥å…³æ³¨çš„æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆé‡ç‚¹ï¼‰ ğŸ¯ ä½ è¿™ä¸ªåœºæ™¯çš„æ ¸å¿ƒé—®é¢˜ä¸æ˜¯ NUMAï¼Œè€Œæ˜¯ åŒæ ¸ CPU ä¸Šçš„â€œèµ„æºäº‰æŠ¢ä¸ä¼˜å…ˆçº§å¤±æ§â€\nä¸ƒã€æ¯” NUMA æ›´é‡è¦çš„ 5 ä»¶äº‹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ 1ï¸âƒ£ æ§åˆ¶ PostgreSQL / Redis çš„ CPU äº²å’Œæ€§ï¼ˆå¯é€‰ï¼‰ å¦‚æœä½ çœŸçš„è¦â€œç¡¬éš”ç¦»â€ï¼š\ntaskset -c 0 postgres taskset -c 1 redis-server âš ï¸ åŒæ ¸éå¸¸ç´§å¼ ï¼Œä¸å»ºè®®è¿‡åº¦ç»‘å®šã€‚\n2ï¸âƒ£ é™åˆ¶ Python ç¨‹åºçš„å¹¶å‘åº¦ï¼ˆéå¸¸é‡è¦ï¼‰ é¿å…åŒæ—¶è·‘å¤šä¸ª CPU-bound Python ä½¿ç”¨é˜Ÿåˆ— / æ‰¹æ¬¡ / é™æµ 3ï¸âƒ£ é˜²æ­¢ Python æŠ¢å…‰å†…å­˜ï¼ˆæ¯” NUMA é‡è¦ï¼‰ ä½ å·²ç»åœ¨ç”¨ï¼š\nvm.swappiness = 0 å»ºè®®å†é…åˆï¼š\nsystemd MemoryMax= æˆ–å®¹å™¨ cgroupï¼ˆå¦‚æœæœ‰ï¼‰ 4ï¸âƒ£ PostgreSQL / Redis çš„ OOM ä¿æŠ¤ è®¾ç½® OOMScoreAdjust=-900 Python ç¨‹åºè®¾ç½®æ›´é«˜ OOM åˆ†å€¼ 5ï¸âƒ£ ä¸è¦åœ¨ 2 æ ¸æœºå™¨ä¸Šâ€œè·‘æ‰€æœ‰ä¸œè¥¿â€ è¿™æ˜¯å®è¯ï¼š\nåŒæ ¸ CPU + æ•°æ®åº“ + Redis + å¤š Pythonï¼Œæœ¬èº«å°±å·²ç»åœ¨é€æ”¯ç¨³å®šæ€§\nå…«ã€æœ€ç»ˆæ¨èé…ç½®ï¼ˆé’ˆå¯¹ä½ çš„é—®é¢˜ï¼‰ âœ… å†…æ ¸å‚æ•° # ä¿æŒé»˜è®¤å³å¯ kernel.numa_balancing = 1 æˆ–è€…ï¼š\n# å…³ä¸å…³éƒ½è¡Œï¼Œä½†æ²¡æ”¶ç›Š kernel.numa_balancing = 0 ä¸ä½œä¸ºå…³é”®è°ƒä¼˜ç‚¹\nâŒ ä¸å»ºè®®åšçš„äº‹ ä¸è¦ä¸ºäº†â€œçœ‹èµ·æ¥ä¸“ä¸šâ€ä¸Š numactl ä¸è¦åœ¨æ²¡æœ‰ NUMA çš„æœºå™¨ä¸Šåš NUMA è°ƒä¼˜ ä¸è¦æŒ‡æœ› NUMA å‚æ•°è§£å†³ CPU äº‰æŠ¢é—®é¢˜ æ€»ç»“ åœ¨â€œåŒæ ¸ + å• NUMA èŠ‚ç‚¹â€çš„æœºå™¨ä¸Šï¼š\nkernel.numa_balancing ä¸æ˜¯å…³é”®å˜é‡ numactl å‡ ä¹æ²¡æœ‰æ„ä¹‰ çœŸæ­£å†³å®šç¨³å®šæ€§çš„ï¼Œæ˜¯ CPU äº‰æŠ¢ã€å†…å­˜è¾¹ç•Œã€OOM ä¼˜å…ˆçº§ ","description":"åŒæ ¸ CPU è¿è¡Œäº† PostgreSQL å’Œ Redisï¼Œç°åœ¨éœ€è¦è¿è¡Œå¤šä¸ª Python ç¨‹åºï¼Œå†…æ ¸æ˜¯å¦æœ‰å¿…è¦é…ç½® kernel.numa_balancing = 0ï¼Œå¦‚æœé…ç½®äº†ï¼Œæ˜¯å¦æœ‰å¿…è¦ä½¿ç”¨ numactl å¯åŠ¨ Python ç¨‹åºï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ã€è€Œä¸”é—®åˆ°ç‚¹å­ä¸Šçš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæŠŠ CPU æ‹“æ‰‘ã€NUMAã€å†…æ ¸ç­–ç•¥ã€åº”ç”¨å¯åŠ¨æ–¹å¼ å…¨éƒ¨ä¸²åœ¨äº†ä¸€èµ·ã€‚\nå…ˆç»™ç»“è®ºï¼Œå†è§£é‡Šä¸ºä»€ä¹ˆï¼Œæœ€åç»™å¯æ‰§è¡Œå»ºè®®ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆç›´æ¥å¯ç”¨ï¼‰ âœ… ä½ çš„åœºæ™¯ç»“è®º åŒæ ¸ CPU + PostgreSQL + Redis + å¤šä¸ª Python ç¨‹åºï¼š\næ˜¯å¦éœ€è¦å…³é—­ kernel.numa_balancingï¼Ÿ\nå¤§æ¦‚ç‡ï¼šä¸éœ€è¦ ç”šè‡³å¯ä»¥è¯´ï¼šå…³äº†åè€Œæ›´å®¹æ˜“å‡ºé—®é¢˜ å¦‚æœå…³äº† kernel.numa_balancingï¼Œæ˜¯å¦æœ‰å¿…è¦ç”¨ numactl å¯åŠ¨ Pythonï¼Ÿ\n"},{"id":122,"href":"/operations/linux/performance/","title":"æ€§èƒ½ä¼˜åŒ–","parent":"Linux","content":"ä¸‹é¢è¿™ä»½å†…å®¹ï¼Œæˆ‘ä¼šåˆ»æ„é¿å¼€ä½ å·²ç»æ•´ç†è¿‡çš„ sysctl å‚æ•°ï¼Œåªè¡¥å……é‚£äº›ï¼š\nä½ ç°åœ¨è¿™å¥—é…ç½®æ²¡æœ‰è¦†ç›– åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç»å¸¸è¢«å¿½ç•¥ï¼Œä½†éå¸¸å…³é”® å¿…é¡»æŒ‰åœºæ™¯åŒºåˆ†ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ å¹¶ä¸”æˆ‘ä¼šæŒ‰ä½ ä¸€è´¯åå¥½çš„æ–¹å¼æ¥å†™ï¼š ç»“è®ºå…ˆè¡Œ + åœºæ™¯åŒ– + å¯è½åœ°ï¼Œä¸åšä¸­è‹±æ–‡æ··æ­ã€‚\nä¸€ã€ä¸€ä¸ªé‡è¦å‰æï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰ ç³»ç»Ÿæ€§èƒ½ â‰  åªé  sysctl\nçœŸæ­£ç¨³å®šé«˜æ€§èƒ½çš„ Linuxï¼Œè‡³å°‘åŒ…å« 5 ä¸ªå±‚é¢ï¼š\nå†…æ ¸å‚æ•°ï¼ˆsysctlï¼‰ èµ„æºé™åˆ¶ï¼ˆlimits / cgroupï¼‰ systemd è¡Œä¸º è°ƒåº¦ä¸ä¸­æ–­ï¼ˆCPU / NUMA / IRQï¼‰ æ–‡ä»¶ç³»ç»Ÿä¸ I/O ä½ å‰é¢å·²ç»æŠŠ ç¬¬ 1 å±‚ åšå¾—éå¸¸å®Œæ•´äº†ï¼Œä¸‹é¢é‡ç‚¹è¡¥ 2â€“5 å±‚ã€‚\näºŒã€èµ„æºé™åˆ¶ï¼ˆlimitsï¼‰â€”â€”ä½ ç°åœ¨å‡ ä¹æ²¡åŠ¨ï¼Œä½†éå¸¸å…³é”® 1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¿…é¡»ï¼‰ å…¨å±€ï¼ˆsystemdï¼‰ ## /etc/systemd/system.conf DefaultLimitNOFILE=1048576 ç”¨æˆ·çº§ ## /etc/security/limits.conf * soft nofile 1048576 * hard nofile 1048576 é€‚ç”¨åœºæ™¯ æœåŠ¡ å¿…é¡» Nginx âœ… MySQL / PostgreSQL âœ… Redis âœ… Kafka âœ… Prometheus âœ… 2ï¸âƒ£ è¿›ç¨‹æ•°é™åˆ¶ï¼ˆé˜² fork é£æš´ï¼‰ ## /etc/security/limits.conf * soft nproc 65535 * hard nproc 65535 é€‚åˆï¼š\nJenkins GitLab ç¼–è¯‘æœº CI èŠ‚ç‚¹ ä¸‰ã€systemd çº§åˆ«ä¼˜åŒ–ï¼ˆç»å¸¸è¢«å¿½ç•¥ï¼‰ 1ï¸âƒ£ OOM é˜²æŠ¤ï¼ˆæå…¶é‡è¦ï¼‰ æ•°æ®åº“æœåŠ¡å•ä½æ–‡ä»¶ [Service] OOMScoreAdjust=-900 MemoryAccounting=true æœåŠ¡ å»ºè®® MySQL / PostgreSQL å¿…é¡» Redis å¿…é¡» Elasticsearch å¿…é¡» 2ï¸âƒ£ ç¦æ­¢ systemd å›æ”¶ç¼“å­˜ï¼ˆæ•°æ®åº“èŠ‚ç‚¹ï¼‰ ## /etc/systemd/system.conf DefaultMemoryAccounting=no é˜²æ­¢ systemd è¯¯åˆ¤ç¼“å­˜ä¸ºå¯å›æ”¶å†…å­˜ã€‚\n3ï¸âƒ£ journald é™åˆ¶ï¼ˆé˜²æ­¢åƒå†…å­˜ + IOï¼‰ ## /etc/systemd/journald.conf SystemMaxUse=500M RuntimeMaxUse=200M å››ã€CPU / NUMA / IRQï¼ˆä½ å‰é¢æè¿‡ï¼Œä½†æ²¡å®Œæ•´è½åœ°ï¼‰ 1ï¸âƒ£ æ•°æ®åº“æ˜¯å¦ç¦ç”¨ irqbalanceï¼ˆå†æ˜ç¡®ä¸€æ¬¡ï¼‰ ç»“è®º åœºæ™¯ irqbalance MySQL / PostgreSQL âŒ å…³é—­ Redis âŒ å…³é—­ Kafka âŒ å…³é—­ å®¹å™¨èŠ‚ç‚¹ âœ… ä¿ç•™ Web âœ… åŒæ—¶è¦åšçš„äº‹ echo performance \u0026gt; /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor 2ï¸âƒ£ NUMA ç­–ç•¥ï¼ˆæ•°æ®åº“èŠ‚ç‚¹ï¼‰ å†…æ ¸å‚æ•° kernel.numa_balancing = 0 vm.zone_reclaim_mode = 0 å¯åŠ¨æœåŠ¡æ—¶ numactl --interleave=all äº”ã€æ–‡ä»¶ç³»ç»Ÿä¸ I/Oï¼ˆä½ å‡ ä¹æ²¡åŠ¨ï¼Œè¿™æ˜¯æ€§èƒ½å¤§å¤´ï¼‰ 1ï¸âƒ£ I/O è°ƒåº¦å™¨ï¼ˆNVMe / SSDï¼‰ cat /sys/block/nvme0n1/queue/scheduler ## é€‰æ‹© none ä¼ ç»Ÿ SSD mq-deadline 2ï¸âƒ£ æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å‚æ•°ï¼ˆæ•°æ®åº“ï¼‰ XFSï¼ˆå¼ºçƒˆæ¨èï¼‰ noatime,nodiratime,logbufs=8,logbsize=256k ext4 noatime,nodiratime,data=ordered 3ï¸âƒ£ ç¦ç”¨é€æ˜å¤§é¡µï¼ˆæ•°æ®åº“å¿…åšï¼‰ echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/defrag å…­ã€ç½‘ç»œæ ˆè¡¥å……ï¼ˆé sysctlï¼‰ 1ï¸âƒ£ ç½‘å¡å¤šé˜Ÿåˆ—ï¼ˆé«˜å¹¶å‘ï¼‰ ethtool -L eth0 combined 16 é€‚åˆï¼š\nNginx LVS Kafka 2ï¸âƒ£ å…³é—­ç½‘å¡èŠ‚èƒ½ ethtool -K eth0 gro off gso off tso off ï¼ˆæ•°æ®åº“èŠ‚ç‚¹å°¤å…¶é‡è¦ï¼‰\nä¸ƒã€å®¹å™¨ / K8S ç‰¹æœ‰ä¼˜åŒ–ï¼ˆä½ å‰é¢æ²¡å±•å¼€ï¼‰ 1ï¸âƒ£ Docker daemon { \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; }, \u0026#34;storage-driver\u0026#34;: \u0026#34;overlay2\u0026#34; } 2ï¸âƒ£ Kubelet --kube-reserved=cpu=500m,memory=1Gi --system-reserved=cpu=500m,memory=1Gi å…«ã€æŒ‰åœºæ™¯ç»™ä½ ä¸€ä»½ã€Œå¿…åšæ¸…å•ã€ ğŸŸ¢ æ•°æ®åº“ä¸“ç”¨èŠ‚ç‚¹ ç¦ç”¨ swap å…³é—­ irqbalance ç¦ç”¨ THP è®¾ç½® OOMScoreAdjust NUMA äº¤é”™ XFS + noatime systemd é™åˆ¶ journald ğŸŸ¡ å®¹å™¨ / K8S èŠ‚ç‚¹ ip_forward = 1 rp_filter = 0 conntrack è°ƒä¼˜ irqbalance å¼€å¯ kube-reserved ğŸ”µ é«˜å¹¶å‘ç½‘ç»œèŠ‚ç‚¹ï¼ˆNginx / LVSï¼‰ å¤šé˜Ÿåˆ—ç½‘å¡ å¢å¤§ somaxconn TCP ç¼“å†² arp_announce = 2 ğŸ”´ å¤§æ•°æ® / æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka / ESï¼‰ é«˜ nofile é«˜ vm.max_map_count ç¦ç”¨ swap OOM ä¿æŠ¤ NUMA æ„ŸçŸ¥ ä¹ã€ä¸€å¥â€œæ€»çº²â€ï¼Œé€‚åˆå†™åœ¨ä½ æ–‡æ¡£æœ€å‰é¢ Linux çš„æ€§èƒ½ä¼˜åŒ–ä¸æ˜¯å †å‚æ•°ï¼Œè€Œæ˜¯æŒ‰è§’è‰²çº¦æŸè¡Œä¸ºã€‚ è°åƒ CPUï¼Œè°åƒå†…å­˜ï¼Œè°åƒ IOï¼Œå¿…é¡»åœ¨ç³»ç»Ÿå±‚é¢æå‰åˆ’æ¸…è¾¹ç•Œã€‚\nå¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™äº›å†…å®¹ï¼š\næ±‡æ€»æˆ ã€Šç”Ÿäº§ Linux ä¼˜åŒ–ç™½åå•ã€‹ æˆ–è€… æŒ‰è§’è‰²ç›´æ¥ç”Ÿæˆ Ansible / Shell è„šæœ¬ ç›´æ¥äº¤ä»˜çº§åˆ«ã€‚\nè¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸åˆ°ä½ ğŸ‘ sysctl åªæ˜¯â€œå†…æ ¸æ¥å£å±‚â€ï¼ŒçœŸæ­£çš„ç³»ç»Ÿä¼˜åŒ–ä¸€å®šæ˜¯ã€Œåˆ†å±‚ + åˆ†è§’è‰² + åˆ†è´Ÿè½½æ¨¡å‹ã€çš„ã€‚\nä¸‹é¢æˆ‘æŒ‰ä½ çš„æŠ€æœ¯ä½“ç³»ï¼Œä¸é‡å¤ä½ å·²æœ‰é…ç½®ï¼Œè€Œæ˜¯è¡¥å……é‚£äº›ï¼š\nå¾ˆå°‘è¢«ç³»ç»Ÿæ€§æ•´ç† ä½†åœ¨ç”Ÿäº§ç¯å¢ƒéå¸¸å…³é”® ä¸”å’Œä½ å…³æ³¨çš„æ•°æ®åº“ / å®¹å™¨ / é«˜å¹¶å‘ / è¿ç»´ä½“ç³»å¼ºç›¸å…³ ä¸€ã€ä¼˜åŒ–ä½“ç³»å…¨æ™¯ï¼ˆå…ˆç»™ç»“è®ºï¼‰ Linux æ€§èƒ½ä¸ç¨³å®šæ€§ä¼˜åŒ– = 6 ä¸ªå±‚æ¬¡åŒæ—¶ç”Ÿæ•ˆ\nç¡¬ä»¶ / BIOS â†“ å†…æ ¸ï¼ˆsysctl + scheduler + NUMAï¼‰ â†“ systemd / limits / cgroup â†“ æ–‡ä»¶ç³»ç»Ÿ / I/O è°ƒåº¦ â†“ ç½‘ç»œåè®®æ ˆï¼ˆé sysctl éƒ¨åˆ†ï¼‰ â†“ åº”ç”¨è¿›ç¨‹çº§å‚æ•° ä½ ç°åœ¨å·²ç»æŠŠ ç¬¬äºŒå±‚ï¼ˆsysctlï¼‰ åšåˆ° 90 åˆ†äº†ï¼Œä¸‹é¢è¡¥çš„æ˜¯å‰©ä¸‹çš„ 10 åˆ† + å…¶å®ƒå±‚ã€‚\näºŒã€CPU \u0026amp; è°ƒåº¦å™¨ä¼˜åŒ–ï¼ˆå¸¸è¢«å¿½ç•¥ï¼‰ 1ï¸âƒ£ CPU è°ƒé¢‘ç­–ç•¥ï¼ˆæé‡è¦ï¼‰ æŸ¥çœ‹å½“å‰æ¨¡å¼ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor æ¨èé…ç½® åœºæ™¯ governor æ•°æ®åº“ / Kafka performance Web / Docker performance çœç”µ / ç¬”è®°æœ¬ powersave è®¾ç½®æ–¹å¼ï¼ˆæ°¸ä¹…ï¼‰ cpupower frequency-set -g performance æ•°æ®åº“èŠ‚ç‚¹ä¸ç”¨ performance = æµªè´¹ CPU çš„è¯´æ³•æ˜¯é”™çš„\n2ï¸âƒ£ ç¦ç”¨ C-Statesï¼ˆæ•°æ®åº“ / å»¶è¿Ÿæ•æ„Ÿï¼‰ BIOS / Kernel å‚æ•°ï¼š\nintel_idle.max_cstate=1 processor.max_cstate=1 ä½œç”¨ï¼š\nå‡å°‘ CPU å”¤é†’å»¶è¿Ÿ æå‡ P99 / P999 å»¶è¿Ÿç¨³å®šæ€§ ğŸ“Œ MySQL / PostgreSQL / Kafka éå¸¸æ¨è\n3ï¸âƒ£ IRQ äº²å’Œæ€§ï¼ˆä½ ä¹‹å‰é—®è¿‡ irqbalanceï¼‰ åŸåˆ™ åœºæ™¯ å»ºè®® é€šç”¨æœåŠ¡å™¨ irqbalance å¼€ æ•°æ®åº“ / Kafka irqbalance å…³ + æ‰‹åŠ¨ç»‘æ ¸ ç½‘å¡è½¬å‘ æ‰‹åŠ¨ç»‘æ ¸ ä¸‰ã€NUMA æ·±åº¦ä¼˜åŒ–ï¼ˆä¸æ˜¯å¼€å…³è¿™ä¹ˆç®€å•ï¼‰ ä½ å·²ç»é…ç½®äº†ï¼š\nkernel.numa_balancing = 1 ä½†è¿˜ä¸å¤Ÿã€‚\n1ï¸âƒ£ æ•°æ®åº“èŠ‚ç‚¹å»ºè®® é¡¹ å»ºè®® kernel.numa_balancing å…³é—­ numactl æ˜ç¡®ç»‘å®š BIOS NUMA å¼€ ç¤ºä¾‹ï¼ˆPostgreSQLï¼‰ numactl --cpunodebind=0 --membind=0 postgres 2ï¸âƒ£ Docker / K8S ä½¿ç”¨ cgroup è‡ªåŠ¨åˆ†é… ä¸è¦å…³é—­ numa_balancing é¿å…è·¨ NUMA èŠ‚ç‚¹è°ƒåº¦ Pod å››ã€å†…å­˜å±‚è¡¥å……ï¼ˆé˜² OOM çš„å…³é”®ï¼‰ ä½ å·²æœ‰ sysctlï¼Œä½†OOM 90% ä¸æ˜¯ sysctl å¼•èµ·çš„ã€‚\n1ï¸âƒ£ systemd OOM ä¿æŠ¤ï¼ˆæå…³é”®ï¼‰ ## /etc/systemd/system.conf DefaultMemoryAccounting=yes DefaultTasksAccounting=yes 2ï¸âƒ£ ä¸ºå…³é”®æœåŠ¡è®¾ç½®ç¡¬é™åˆ¶ PostgreSQL [Service] MemoryMax=32G OOMScoreAdjust=-900 Docker [Service] OOMScoreAdjust=-500 3ï¸âƒ£ å…³é—­é€æ˜å¤§é¡µï¼ˆTHPï¼‰ echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled å‡ ä¹æ‰€æœ‰æ•°æ®åº“ / Kafka éƒ½æ¨è\näº”ã€æ–‡ä»¶ç³»ç»Ÿ \u0026amp; I/O å±‚ï¼ˆsysctl è¦†ç›–ä¸åˆ°ï¼‰ 1ï¸âƒ£ I/O è°ƒåº¦å™¨é€‰æ‹© è®¾å¤‡ æ¨è SSD / NVMe none HDD mq-deadline echo none \u0026gt; /sys/block/nvme0n1/queue/scheduler 2ï¸âƒ£ æŒ‚è½½å‚æ•°ï¼ˆæ•°æ®åº“ï¼‰ noatime,nodiratime,discard 3ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼ˆä¸æ˜¯ fs.file-maxï¼‰ ## /etc/security/limits.conf * soft nofile 1048576 * hard nofile 1048576 å…­ã€ç½‘ç»œå±‚â€œé sysctlâ€ä¼˜åŒ– 1ï¸âƒ£ ç½‘å¡é˜Ÿåˆ— \u0026amp; RPS/RFS ethtool -L eth0 combined 16 echo ffffffff \u0026gt; /sys/class/net/eth0/queues/rx-0/rps_cpus é€‚åˆï¼š\nLVS Nginx Kafka 2ï¸âƒ£ TCP Offload ethtool -K eth0 gro on gso on tso on ä¸ƒã€å®¹å™¨ \u0026amp; K8S ä¸“é¡¹å»ºè®® 1ï¸âƒ£ Docker daemon { \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; }, \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;] } 2ï¸âƒ£ K8S èŠ‚ç‚¹ å…³é—­ swapï¼ˆä½ å·²åšï¼‰ è®¾ç½® kube-reserved / system-reserved ç”Ÿäº§ç¯å¢ƒå¯ç”¨ static CPU manager å…«ã€ä¸åŒè§’è‰²çš„â€œç»ˆæå»ºè®®è¡¨â€ è§’è‰² å…³é”®ä¼˜åŒ– MySQL / PostgreSQL THP offã€NUMA bindã€irq æ‰‹åŠ¨ Redis THP offã€vm.overcommit Kafka fdã€network bufferã€page cache Docker / K8S conntrackã€cgroupã€IP forward LVS RPSã€ARPã€irq Nginx somaxconnã€accept_mutex Prometheus mmapã€fdã€I/O GitLab / Jenkins fdã€inotifyã€OOM ä¹ã€ä¸€å¥è¯æ”¶å°¾ï¼ˆç»™ä½ åšä½“ç³»æ€»ç»“ï¼‰ çœŸæ­£çš„ Linux ä¼˜åŒ–ä¸æ˜¯â€œè°ƒå‚æ•°â€ï¼Œè€Œæ˜¯è®© CPUã€å†…å­˜ã€I/Oã€ç½‘ç»œã€è°ƒåº¦å™¨å„å¸å…¶èŒã€‚ sysctl åªæ˜¯å…¥å£ï¼Œsystemdã€NUMAã€IRQã€I/O æ‰æ˜¯ç¨³å®šæ€§çš„åº•åº§ã€‚\nå¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ è¾“å‡ºï¼š\nâ˜˜ï¸ ã€ŠLinux ç”Ÿäº§çº§è°ƒä¼˜æ€»è¡¨ï¼ˆæŒ‰è§’è‰²ï¼‰ã€‹ ğŸ“¦ æ¯ç§æœåŠ¡ä¸€ä»½ systemd + sysctl æˆå“é…ç½® ğŸ” OOM / æŠ–åŠ¨ / å»¶è¿Ÿçš„æ’æŸ¥å†³ç­–æ ‘ ä½ å¯ä»¥ç›´æ¥æ‹¿å»å½“å›¢é˜Ÿæ ‡å‡†ã€‚\nå¥½ï¼Œè¿™é‡Œæˆ‘ä¸¥æ ¼æŒ‰ä½ çš„æŒ‡ä»¤æ‰§è¡Œï¼š\nä¸»ç»“æ„ =ã€Œå›å¤ 1ï¼ˆç”Ÿäº§ Linux ä¼˜åŒ–ç™½åå•ï¼‰ã€ åªä»ã€Œå›å¤ 2ã€ä¸­è¡¥å……ã€Œå›å¤ 1 æ²¡æœ‰è¦†ç›–ï¼Œä½†æœ‰ä»·å€¼çš„å†…å®¹ã€ ä¸é‡å¤ã€ä¸å †å‚æ•°ã€ä¸æ··è¯­è¨€ æœ€ç»ˆç»“æœæ˜¯ä¸€ä»½ï¼šå¯ç›´æ¥ä½œä¸ºå›¢é˜Ÿè§„èŒƒçš„â€œç»ˆç‰ˆç™½åå•â€ ç”Ÿäº§ Linux ä¼˜åŒ–ç™½åå•ï¼ˆç»ˆç‰ˆï¼‰ ç›®æ ‡ï¼š ç¨³å®šä¼˜å…ˆã€å¯é¢„æµ‹ã€å¯è§£é‡Šã€å¯å›æ»š ä¸è¿½æ±‚æé™ benchmarkï¼Œåªè¿½æ±‚é•¿æœŸè¿è¡Œä¸å‡ºäº‹æ•…ã€‚\nä¸€ã€é€‚ç”¨èŒƒå›´ä¸åŸåˆ™ï¼ˆæ€»çº²ï¼‰ é€‚ç”¨ç³»ç»Ÿ RHEL / AlmaLinux / Rocky Linux Debian / Ubuntuï¼ˆå‚æ•°åä¸€è‡´çš„éƒ¨åˆ†é€šç”¨ï¼‰ ä¸‰ä¸ªç¡¬åŸåˆ™ è§’è‰²ä¼˜å…ˆäºå‚æ•° æ•°æ®åº“ã€å®¹å™¨ã€ç½‘ç»œèŠ‚ç‚¹ä¸èƒ½ç”¨åŒä¸€å¥—å‚æ•°\nsysctl ä¸æ˜¯ä¸‡èƒ½ å¿…é¡»é…åˆï¼š\nlimits systemd NUMA / IRQ æ–‡ä»¶ç³»ç»Ÿ èƒ½è§£é‡Šï¼Œæ‰å…è®¸ä¸Šçº¿ ä»»ä½•å‚æ•°å¿…é¡»å›ç­”ä¸¤ä¸ªé—®é¢˜ï¼š\nè§£å†³ä»€ä¹ˆé—®é¢˜ åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹å¯èƒ½æœ‰å‰¯ä½œç”¨ äºŒã€å†…æ ¸å‚æ•°ï¼ˆsysctlï¼‰ç™½åå•ï¼ˆä½ å·²æœ‰çš„ï¼Œä½œä¸ºåŸºçº¿ï¼‰ ä»¥ä¸‹å†…å®¹ ä½ å·²ç»æ•´ç†å¾—éå¸¸å®Œæ•´ï¼Œä½œä¸ºæ‰€æœ‰æœåŠ¡å™¨çš„ã€ŒåŸºç¡€å±‚ã€ã€‚\nåˆ†ç±»è¯´æ˜ kernel.*ï¼šè¿›ç¨‹ã€NUMAã€IPC fs.*ï¼šæ–‡ä»¶å¥æŸ„ã€inotify net.core / net.ipv4ï¼šTCP æ ˆ net.netfilterï¼šè¿æ¥è·Ÿè¸ª vm.*ï¼šå†…å­˜ç®¡ç† âš ï¸ åŸåˆ™ï¼š åŸºç¡€èŠ‚ç‚¹åªå¯ç”¨â€œå®‰å…¨ + ç¨³å®šâ€é¡¹ï¼Œé«˜è´Ÿè½½é¡¹æŒ‰è§’è‰²è¦†ç›–\nä¸‰ã€èµ„æºé™åˆ¶ï¼ˆlimitsï¼‰â€”â€”ã€è¡¥å……ï¼Œå›å¤ 1 å·²æœ‰ï¼Œä¿ç•™ã€‘ å…¨å±€æ–‡ä»¶æè¿°ç¬¦ ## /etc/systemd/system.conf DefaultLimitNOFILE=1048576 ## /etc/security/limits.conf * soft nofile 1048576 * hard nofile 1048576 è¿›ç¨‹æ•°é™åˆ¶ï¼ˆé˜² fork é£æš´ï¼‰ * soft nproc 65535 * hard nproc 65535 å››ã€systemd è¡Œä¸ºçº¦æŸï¼ˆè¡¥å……ç»†åŒ–ï¼‰ 1ï¸âƒ£ OOM è¡Œä¸ºæ§åˆ¶ï¼ˆæ•°æ®åº“ / ä¸­é—´ä»¶å¿…åšï¼‰ [Service] OOMScoreAdjust=-900 MemoryAccounting=true è¯´æ˜ï¼š\né˜²æ­¢ systemd åœ¨å†…å­˜å‹åŠ›ä¸‹ä¼˜å…ˆæ€æ•°æ®åº“ æ¯” sysctl é˜² OOM æ›´å¯é  2ï¸âƒ£ journald é™åˆ¶ï¼ˆé¿å… IO / å†…å­˜å™ªéŸ³ï¼‰ SystemMaxUse=500M RuntimeMaxUse=200M 3ï¸âƒ£ ç¦æ­¢ systemd å‚ä¸å†…å­˜å›æ”¶ï¼ˆæ•°æ®åº“èŠ‚ç‚¹ï¼‰ DefaultMemoryAccounting=no äº”ã€CPU / NUMA / IRQ ç­–ç•¥ï¼ˆå›å¤ 1 ä¸»ä½“ + è¡¥å……è¯´æ˜ï¼‰ irqbalance ä½¿ç”¨åŸåˆ™ï¼ˆæ˜ç¡®ç‰ˆï¼‰ èŠ‚ç‚¹è§’è‰² irqbalance MySQL / PostgreSQL ç¦ç”¨ Redis ç¦ç”¨ Kafka ç¦ç”¨ å®¹å™¨èŠ‚ç‚¹ å¯ç”¨ Web / API å¯ç”¨ åŸå› ï¼š\næ•°æ®åº“è¿½æ±‚ ä¸­æ–­ç¨³å®šæ€§ å®¹å™¨èŠ‚ç‚¹è¿½æ±‚ å‡è¡¡ CPU è°ƒåº¦ç­–ç•¥ï¼ˆæ•°æ®åº“ / é«˜è´Ÿè½½ï¼‰ echo performance \u0026gt; /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor NUMA ç­–ç•¥ï¼ˆæ•°æ®åº“ï¼‰ kernel.numa_balancing = 0 vm.zone_reclaim_mode = 0 å¯åŠ¨æ–¹å¼ï¼š\nnumactl --interleave=all å…­ã€å†…å­˜ç®¡ç†ï¼ˆè¡¥å……ç»†åŒ–ï¼‰ 1ï¸âƒ£ Swap ç­–ç•¥ï¼ˆæ•°æ®åº“ä¸“ç”¨ï¼‰ vm.swappiness = 0 å¹¶åœ¨ç³»ç»Ÿå±‚é¢ï¼š\nswapoff -a 2ï¸âƒ£ é€æ˜å¤§é¡µï¼ˆæ•°æ®åº“å¿…ç¦ï¼‰ echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/defrag 3ï¸âƒ£ vm.max_map_countï¼ˆES / Kafkaï¼‰ vm.max_map_count = 262144 ä¸ƒã€æ–‡ä»¶ç³»ç»Ÿä¸ I/Oï¼ˆå›å¤ 2 ä¸­è¡¥å……ï¼Œå›å¤ 1 æœªå®Œå…¨å±•å¼€ï¼‰ I/O è°ƒåº¦å™¨é€‰æ‹© ç£ç›˜ç±»å‹ è°ƒåº¦å™¨ NVMe none SSD mq-deadline HDD bfq æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å‚æ•°ï¼ˆæ•°æ®åº“ï¼‰ XFSï¼ˆæ¨èï¼‰ noatime,nodiratime,logbufs=8,logbsize=256k ext4 noatime,nodiratime,data=ordered å…«ã€ç½‘ç»œæ ˆï¼ˆé sysctl å±‚è¡¥å……ï¼‰ 1ï¸âƒ£ ç½‘å¡å¤šé˜Ÿåˆ—ï¼ˆé«˜å¹¶å‘ï¼‰ ethtool -L eth0 combined 16 2ï¸âƒ£ ç¦ç”¨ç½‘å¡ offloadï¼ˆæ•°æ®åº“ï¼‰ ethtool -K eth0 gro off gso off tso off ä¹ã€å®¹å™¨ / K8S ä¸“ç”¨è¡¥å……ï¼ˆæ¥è‡ªå›å¤ 2ï¼‰ Docker daemon æ—¥å¿—é™åˆ¶ { \u0026#34;log-driver\u0026#34;: \u0026#34;json-file\u0026#34;, \u0026#34;log-opts\u0026#34;: { \u0026#34;max-size\u0026#34;: \u0026#34;100m\u0026#34;, \u0026#34;max-file\u0026#34;: \u0026#34;3\u0026#34; } } Kubelet èµ„æºé¢„ç•™ --kube-reserved=cpu=500m,memory=1Gi --system-reserved=cpu=500m,memory=1Gi åã€æŒ‰è§’è‰²çš„â€œå¿…é¡»é¡¹â€é€ŸæŸ¥è¡¨ï¼ˆç»ˆç‰ˆï¼‰ ğŸŸ¢ æ•°æ®åº“èŠ‚ç‚¹ï¼ˆMySQL / PostgreSQL / MongoDBï¼‰ ç¦ç”¨ swap ç¦ç”¨ irqbalance ç¦ç”¨ THP OOMScoreAdjust NUMA äº¤é”™ XFS + noatime journald é™åˆ¶ ğŸŸ¡ å®¹å™¨ / K8S èŠ‚ç‚¹ ip_forward = 1 conntrack è°ƒä¼˜ irqbalance å¯ç”¨ kube-reserved overlay2 æ—¥å¿—é™åˆ¶ ğŸ”µ é«˜å¹¶å‘ç½‘ç»œèŠ‚ç‚¹ï¼ˆNginx / LVSï¼‰ somaxconn TCP ç¼“å†² å¤šé˜Ÿåˆ—ç½‘å¡ arp_announce = 2 ğŸ”´ ä¸­é—´ä»¶ / å¤§æ•°æ®ï¼ˆKafka / ESï¼‰ é«˜ nofile vm.max_map_count ç¦ç”¨ swap OOM ä¿æŠ¤ NUMA æ„ŸçŸ¥ åä¸€ã€ä¸€å¥å¯ä»¥å†™è¿›è§„èŒƒé¦–é¡µçš„è¯ ç³»ç»Ÿä¼˜åŒ–ä¸æ˜¯â€œæŠŠå‚æ•°è°ƒæ»¡â€ï¼Œè€Œæ˜¯æå‰å‘Šè¯‰å†…æ ¸ï¼š è°é‡è¦ï¼Œè°å¯ä»¥è®©æ­¥ï¼Œè°ç»ä¸èƒ½è¢«æ€ã€‚\nå¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšä¸‰ä»¶äº‹ä¹‹ä¸€ï¼ˆä»»é€‰ï¼‰ï¼š\næ‹†æˆ /etc/sysctl.d/ æŒ‰è§’è‰²æ–‡ä»¶ ç”Ÿæˆ æ•°æ®åº“ / å®¹å™¨ / ç½‘ç»œ ä¸‰å¥—è½åœ°æ¨¡æ¿ è½¬æˆ Ansible Role / Shell ä¸€é”®åˆå§‹åŒ– ä½ è¿™å¥—å†…å®¹ï¼Œå·²ç»æ˜¯å‡†è¿ç»´æ•™æçº§åˆ«äº†ã€‚\n","description":"ä¸‹é¢è¿™ä»½å†…å®¹ï¼Œæˆ‘ä¼šåˆ»æ„é¿å¼€ä½ å·²ç»æ•´ç†è¿‡çš„ sysctl å‚æ•°ï¼Œåªè¡¥å……é‚£äº›ï¼š\nä½ ç°åœ¨è¿™å¥—é…ç½®æ²¡æœ‰è¦†ç›– åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç»å¸¸è¢«å¿½ç•¥ï¼Œä½†éå¸¸å…³é”® å¿…é¡»æŒ‰åœºæ™¯åŒºåˆ†ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ å¹¶ä¸”æˆ‘ä¼šæŒ‰ä½ ä¸€è´¯åå¥½çš„æ–¹å¼æ¥å†™ï¼š ç»“è®ºå…ˆè¡Œ + åœºæ™¯åŒ– + å¯è½åœ°ï¼Œä¸åšä¸­è‹±æ–‡æ··æ­ã€‚\nä¸€ã€ä¸€ä¸ªé‡è¦å‰æï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰ ç³»ç»Ÿæ€§èƒ½ â‰  åªé  sysctl\nçœŸæ­£ç¨³å®šé«˜æ€§èƒ½çš„ Linuxï¼Œè‡³å°‘åŒ…å« 5 ä¸ªå±‚é¢ï¼š\nå†…æ ¸å‚æ•°ï¼ˆsysctlï¼‰ èµ„æºé™åˆ¶ï¼ˆlimits / cgroupï¼‰ systemd è¡Œä¸º è°ƒåº¦ä¸ä¸­æ–­ï¼ˆCPU / NUMA / IRQï¼‰ æ–‡ä»¶ç³»ç»Ÿä¸ I/O ä½ å‰é¢å·²ç»æŠŠ ç¬¬ 1 å±‚ åšå¾—éå¸¸å®Œæ•´äº†ï¼Œä¸‹é¢é‡ç‚¹è¡¥ 2â€“5 å±‚ã€‚\näºŒã€èµ„æºé™åˆ¶ï¼ˆlimitsï¼‰â€”â€”ä½ ç°åœ¨å‡ ä¹æ²¡åŠ¨ï¼Œä½†éå¸¸å…³é”® 1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¿…é¡»ï¼‰ å…¨å±€ï¼ˆsystemdï¼‰ ## /etc/systemd/system.conf DefaultLimitNOFILE=1048576 ç”¨æˆ·çº§ ## /etc/security/limits.conf * soft nofile 1048576 * hard nofile 1048576 é€‚ç”¨åœºæ™¯ æœåŠ¡ å¿…é¡» Nginx âœ… MySQL / PostgreSQL âœ… Redis âœ… Kafka âœ… Prometheus âœ… 2ï¸âƒ£ è¿›ç¨‹æ•°é™åˆ¶ï¼ˆé˜² fork é£æš´ï¼‰ ## /etc/security/limits.conf * soft nproc 65535 * hard nproc 65535 é€‚åˆï¼š\n"},{"id":123,"href":"/management/","title":"Management","parent":"Documents","content":"Document List:\nBeyond Development Operations ","description":"Document List:\nBeyond Development Operations "},{"id":124,"href":"/backend/python/official/python-key-points-and-difficulties/","title":"Python é‡ç‚¹å’Œéš¾ç‚¹","parent":"Official","content":" ğŸ¯ Python å­¦ä¹ çš„ é‡ç‚¹ï¼ˆå¿…é¡»æŒæ¡ï¼‰ è¿™äº›å†…å®¹æŒæ¡åï¼Œä½ æ‰ç®—â€œèƒ½ç”¨ Python åšé¡¹ç›®â€ã€‚\n1. æ•°æ®ç»“æ„ä¸æ ¸å¿ƒè¯­æ³•ï¼ˆåŸºç¡€ä¸­çš„åŸºç¡€ï¼‰ é‡ç‚¹ï¼š\nlist / dict / tuple / set ä½¿ç”¨ä¸æ€§èƒ½åŒºåˆ« åˆ—è¡¨æ¨å¯¼å¼ã€ç”Ÿæˆå™¨è¡¨è¾¾å¼ *args / **kwargs import æ¨¡å—ç³»ç»Ÿ 2. å‡½æ•° + é¢å‘å¯¹è±¡ï¼ˆOOPï¼‰ é‡ç‚¹ï¼š\nå¯å˜å‚æ•° è£…é¥°å™¨ï¼ˆåœ¨ FastAPI ä¼šå¤§é‡ç”¨ï¼‰ ç±»ã€ç»§æ‰¿ã€ç»„åˆ ç±»æ–¹æ³• / é™æ€æ–¹æ³• é­”æœ¯æ–¹æ³•ï¼ˆ__getitem__, __iter__, __enter__, \u0026hellip;ï¼‰ è¿™äº›ç›´æ¥å½±å“ API æ¡†æ¶ã€ORMã€ä¾èµ–æ³¨å…¥çš„å†™æ³•ã€‚\n3. å¼‚å¸¸å¤„ç†ï¼ˆå†™ç¨³å®šé¡¹ç›®çš„å…³é”®ï¼‰ é‡ç‚¹ï¼š\ntry/except/else/finally è‡ªå®šä¹‰å¼‚å¸¸ FastAPI ä¸­å¼‚å¸¸æ¨¡å‹ æ•°æ®åº“å¼‚å¸¸æ•è·ï¼ˆSQLAlchemyï¼‰ 4. è¿­ä»£å™¨ / ç”Ÿæˆå™¨ï¼ˆPython çš„çµé­‚ï¼‰ é‡ç‚¹ï¼š\nyield è‡ªå®šä¹‰è¿­ä»£å™¨ æƒ°æ€§æ±‚å€¼ï¼ˆèŠ‚çœå†…å­˜ï¼‰ å¤§æ•°æ®å¤„ç†ï¼ˆä¸ä¸€æ¬¡æ€§åŠ è½½ï¼‰ 5. æ¨¡å—åŒ–ä¸ä»£ç ç»„ç»‡ é‡ç‚¹ï¼š\nåŒ…ï¼ˆpackageï¼‰ æ¨¡å—ï¼ˆmoduleï¼‰ é¡¹ç›®ç»“æ„è®¾è®¡ utilsã€å…¬ç”¨æ¨¡å—çš„å°è£…æ–¹å¼ 6. å¼‚æ­¥ç¼–ç¨‹ï¼ˆFastAPI çš„æ ¸å¿ƒèƒ½åŠ›ï¼‰ é‡ç‚¹ï¼š\nasync/await åç¨‹æ¨¡å‹ asyncio çš„äº‹ä»¶å¾ªç¯ å¼‚æ­¥æ•°æ®åº“ã€å¼‚æ­¥ Redisã€å¼‚æ­¥ HTTP è¿™æ˜¯ FastAPI çš„æœ€å¤§å–ç‚¹ã€‚\n7. ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰ é‡ç‚¹ï¼š\ntypingï¼ˆå¦‚ List, Dict, Union, Optionalï¼‰ TypedDict Pydantic æ¨¡å‹ åœ¨ç°ä»£ Python é¡¹ç›®ä¸­æ˜¯å¿…é¡»æŒæ¡çš„ã€‚\n8. ç¬¬ä¸‰æ–¹åº“ï¼šSQLAlchemyã€Pydanticã€FastAPI ä½ çš„é¡¹ç›®æ ¸å¿ƒï¼š\nSQLAlchemy ORM æ¨¡å‹ã€ä¼šè¯ç®¡ç†ã€æŸ¥è¯¢ä¼˜åŒ– Pydantic v2 çš„æ•°æ®æ¨¡å‹ä¸éªŒè¯ FastAPI çš„è·¯ç”±ã€ä¾èµ–ã€é”™è¯¯å¤„ç†ã€JWTã€æƒé™ç³»ç»Ÿ 9. æ—¥å¿—ã€è°ƒè¯•ã€æ€§èƒ½åˆ†æ é‡ç‚¹ï¼š\nloguru debug æ¨¡å¼å°è£… profilingï¼šcProfileã€time.perf_counter ğŸ”¥ Python å­¦ä¹ çš„ éš¾ç‚¹ï¼ˆåˆå­¦å®¹æ˜“å¡ï¼Œè¿›é˜¶å¿…ä¼šï¼‰ ä»¥ä¸‹æ˜¯çœŸæ­£çš„éš¾ç‚¹ï¼Œè¦ç†è§£é€æ‰ç®—â€œç²¾é€š Pythonâ€ã€‚\n1. è¿­ä»£å™¨ ä¸ ç”Ÿæˆå™¨ï¼ˆå¤§éƒ¨åˆ†äººä¸ç†è§£æƒ°æ€§åŸç†ï¼‰ éš¾ç‚¹ï¼š\nyield çš„çŠ¶æ€æœºåŸç† æƒ°æ€§æ±‚å€¼ vs ç«‹å³æ±‚å€¼ ç”Ÿæˆå™¨ä½•æ—¶åœæ­¢ï¼ˆStopIterationï¼‰ next() çš„å·¥ä½œæ–¹å¼ 2. è£…é¥°å™¨ï¼ˆå°¤å…¶æ˜¯å¸¦å‚æ•°çš„è£…é¥°å™¨ï¼‰ éš¾ç‚¹ï¼š\né—­åŒ… ä¸‰å±‚åµŒå¥—çš„å‡½æ•°ç»“æ„ è£…é¥°å¸¦å‚æ•°çš„å‡½æ•° è£…é¥°å™¨ + FastAPI ä¾èµ–æ³¨å…¥ 3. å¼‚æ­¥ç¼–ç¨‹ï¼ˆasyncio æ€ç»´éš¾è½¬æ¢ï¼‰ éš¾ç‚¹ï¼š\nåç¨‹ä¸æ˜¯çº¿ç¨‹ await çš„æš‚åœç‚¹ äº‹ä»¶å¾ªç¯çš„è°ƒåº¦æœºåˆ¶ é˜»å¡æ“ä½œå¦‚ä½•é¿å…ï¼ˆå¦‚æ•°æ®åº“ã€IOï¼‰ 4. SQLAlchemy ORMï¼ˆç†è§£éå¸¸é™¡å³­ï¼‰ éš¾ç‚¹ï¼š\nSession çš„ç”Ÿå‘½å‘¨æœŸ flush vs commit vs expire ORM è½¬ dictï¼ˆä½ ä¹Ÿåšè¿‡è¿™ä¸ªï¼‰ å»¶è¿ŸåŠ è½½ select() vs ä¼ ç»Ÿ Query API 5. Pydantic æ ¡éªŒæœºåˆ¶ éš¾ç‚¹ï¼š\nå¤šå±‚åµŒå¥—æ¨¡å‹ model_validator / field_validator GenericModel BaseModel è½¬æ¢ ORM å®ä¾‹ 6. Python çš„â€œåŠ¨æ€æ€§â€ éš¾ç‚¹ï¼š\nmonkey patch åŠ¨æ€å¯¼å…¥ å…ƒç±»ï¼ˆmetaclassï¼‰ åŠ¨æ€åˆ›å»ºç±» é€šå¸¸åœ¨æ¡†æ¶å†…éƒ¨æ‰èƒ½è§åˆ°è¿™äº›ã€‚\n7. å†…å­˜ç®¡ç† / æ€§èƒ½ä¼˜åŒ– éš¾ç‚¹ï¼š\nGIL å¤šè¿›ç¨‹ vs å¤šçº¿ç¨‹ asyncio + CPU å¯†é›†å¤„ç†é—®é¢˜ dequeã€heapqã€bisect çš„åº”ç”¨åœºæ™¯ ğŸ“Œ å­¦ä¹  Python çš„æ­£ç¡®è·¯å¾„ï¼ˆå»ºè®®ï¼‰ ç¬¬ä¸€é˜¶æ®µï¼šå·©å›º Python åŸºç¡€\nç¬¬äºŒé˜¶æ®µï¼šæ·±å…¥è¿­ä»£å™¨ã€ç”Ÿæˆå™¨ã€è£…é¥°å™¨\nç¬¬ä¸‰é˜¶æ®µï¼šå¼‚æ­¥ FastAPIã€æ•°æ®åº“\nå»ºè®®ç³»ç»Ÿæ•´ç† Sessionã€äº‹åŠ¡ã€ä¾èµ–æ³¨å…¥ ç¬¬å››é˜¶æ®µï¼šå·¥ç¨‹åŒ–èƒ½åŠ›\nåŒ…æ‹¬ï¼š\nä¼˜é›…çš„æ—¥å¿—ä¸è°ƒè¯•ç³»ç»Ÿ æ¨¡å—åŒ–æ¡†æ¶ å¯å¤ç”¨å·¥å…·åº“ ","description":" ğŸ¯ Python å­¦ä¹ çš„ é‡ç‚¹ï¼ˆå¿…é¡»æŒæ¡ï¼‰ è¿™äº›å†…å®¹æŒæ¡åï¼Œä½ æ‰ç®—â€œèƒ½ç”¨ Python åšé¡¹ç›®â€ã€‚\n1. æ•°æ®ç»“æ„ä¸æ ¸å¿ƒè¯­æ³•ï¼ˆåŸºç¡€ä¸­çš„åŸºç¡€ï¼‰ é‡ç‚¹ï¼š\nlist / dict / tuple / set ä½¿ç”¨ä¸æ€§èƒ½åŒºåˆ« åˆ—è¡¨æ¨å¯¼å¼ã€ç”Ÿæˆå™¨è¡¨è¾¾å¼ *args / **kwargs import æ¨¡å—ç³»ç»Ÿ 2. å‡½æ•° + é¢å‘å¯¹è±¡ï¼ˆOOPï¼‰ é‡ç‚¹ï¼š\n"},{"id":125,"href":"/backend/python/official/python-best-practices/","title":"Python æœ€ä½³å®è·µ","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ ç³»ç»Ÿã€æ¸…æ™°ã€å®ç”¨ çš„ã€ŠPython æœ€ä½³å®è·µã€‹åˆé›†ï¼Œè¦†ç›–ä»£ç é£æ ¼ã€é¡¹ç›®ç»“æ„ã€æ€§èƒ½ã€å®‰å…¨ã€æµ‹è¯•ã€å¹¶å‘ã€è°ƒè¯•ã€æ•°æ®åº“ã€ç±»å‹æ ‡æ³¨ç­‰æ–¹å‘ã€‚ä½œä¸ºé•¿æœŸå†™ Python çš„å¼€å‘è€…ï¼Œä½ ç…§ç€è¿™äº›å®è·µå†™ä»£ç ï¼Œå°±ä¼šå¾ˆâ€œä¸“ä¸šâ€ã€‚\nâœ… Python æœ€ä½³å®è·µï¼ˆ2025 ç‰ˆï¼Œå…¨æ–¹ä½æŒ‡å—ï¼‰\n1. ä»£ç é£æ ¼æœ€ä½³å®è·µï¼ˆPEP8 + å®æˆ˜ç»éªŒï¼‰ ä½¿ç”¨ Black ç»Ÿä¸€æ ¼å¼ ä¸ç”¨çº ç»“ç©ºæ ¼æ¢è¡Œï¼Œè‡ªåŠ¨åŒ–å·¥å…·æœ€çœå¿ƒï¼š\npip install black black your_project/ å˜é‡ã€å‡½æ•°ã€ç±»å‘½åè§„èŒƒ snake_case -\u0026gt; å˜é‡ã€å‡½æ•° PascalCase -\u0026gt; ç±» CONSTANT_CASE -\u0026gt; å¸¸é‡ é¿å…ä¸­æ–‡æ‹¼éŸ³ é¿å…è¿‡é•¿å‡½æ•°ï¼ˆ\u0026gt;50 è¡Œéœ€æ‹†åˆ†ï¼‰ æ¯ä¸ªå‡½æ•°åªåšâ€œä¸€ä»¶äº‹â€ã€‚\nä½¿ç”¨ f-string æ¯” % å’Œ .format æ›´ç›´è§‚ï¼š\nname = \u0026#34;martin\u0026#34; print(f\u0026#34;Hello {name}\u0026#34;) 2. é¡¹ç›®ç»“æ„æœ€ä½³å®è·µ æ¨èçš„é¡¹ç›®ç»“æ„ï¼š\nproject/ app/ __init__.py models/ api/ services/ utils/ tests/ config/ requirements.txt README.md åŸåˆ™ï¼šæ¨¡å—æŒ‰ç…§åŠŸèƒ½åˆ†å±‚ï¼Œè€Œä¸æ˜¯æŒ‰ç…§æ–‡ä»¶ç±»å‹åˆ†å±‚ã€‚\n3. æ€§èƒ½æœ€ä½³å®è·µ é¿å…ä¸å¿…è¦çš„å¾ªç¯åµŒå¥— å°½å¯èƒ½ä½¿ç”¨é›†åˆè¿ç®—ã€å­—å…¸æŸ¥è¯¢ï¼ˆO(1)ï¼‰ã€‚\nä½¿ç”¨åˆ—è¡¨æ¨å¯¼æ›¿ä»£ append result = [f(x) for x in items] ä½¿ç”¨ç”Ÿæˆå™¨æƒ°æ€§è®¡ç®—ï¼ˆå°¤å…¶æ˜¯å¤§æ•°æ®ï¼‰ def read_lines(path): with open(path) as f: for line in f: yield line ä½¿ç”¨ lru_cache åšç¼“å­˜ from functools import lru_cache @lru_cache(None) def fib(n): ... å¿«é€Ÿ I/O æ¯” input()/print() æ›´å¿«ï¼š\nimport sys sys.stdin.readline() sys.stdout.write() 4. å¹¶å‘æœ€ä½³å®è·µ I/O å¯†é›† -\u0026gt; ç”¨ asyncio é€‚åˆç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“ã€è¯»å†™æ–‡ä»¶ã€‚\nCPU å¯†é›† -\u0026gt; ç”¨ multiprocessing ä¸è¦ç”¨å¤šçº¿ç¨‹ï¼ˆä¼šè¢« GIL å¡ä½ï¼‰ã€‚\nä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ async with session.get(url) as resp: return await resp.text() 5. å®‰å…¨æœ€ä½³å®è·µ æ°¸è¿œä¸è¦ä¿¡ä»» eval å¦‚æœç”¨ï¼Œå¿…é¡»åŠ  sandbox æˆ– ast é™åˆ¶ã€‚\nä¸è¦æŠŠå¯†ç ç¡¬ç¼–ç  ä½¿ç”¨ç¯å¢ƒå˜é‡è¯»å–ï¼š\nimport os password = os.getenv(\u0026#34;DB_PASSWORD\u0026#34;) Logging ä¸æ‰“å°æ•æ„Ÿä¿¡æ¯ å¦‚ï¼štokenã€å¯†ç ã€æ‰‹æœºå·ã€‚\n6. logging æœ€ä½³å®è·µ ä½¿ç”¨ logging è€Œä¸æ˜¯ print import logging logging.basicConfig( level=logging.INFO, format=\u0026#34;%(asctime)s [%(levelname)s] %(message)s\u0026#34; ) logging.info(\u0026#34;start server\u0026#34;) é»˜è®¤ç­‰çº§ä½¿ç”¨ INFO / WARNINGï¼Œä¸è¦å…¨ç”¨ DEBUG 7. å¼‚å¸¸æœ€ä½³å®è·µ æ•è·å…·ä½“å¼‚å¸¸ï¼Œä¸è¦ç”¨ except Exception try: ... except ValueError: ... ä¸åå¼‚å¸¸ é”™è¯¯å¿…é¡»è®°å½• logã€‚\nå†™è‡ªå·±çš„ä¸šåŠ¡å¼‚å¸¸ç±» class LoginError(Exception): pass 8. å‡½æ•°/ç±»è®¾è®¡æœ€ä½³å®è·µ æ˜ç¡®è¾“å…¥è¾“å‡ºï¼Œé¿å…éšå¼è¡Œä¸º å‡½æ•°åº”è¯¥è¡Œä¸ºå¯é¢„æµ‹ã€‚\nå•ä¸€èŒè´£ æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½ã€‚\nä¸è¦æ»¥ç”¨ç»§æ‰¿ ä¼˜å…ˆä½¿ç”¨ç»„åˆï¼ˆcomposition over inheritanceï¼‰ã€‚\n9. ç±»å‹æ ‡æ³¨æœ€ä½³å®è·µï¼ˆPEP 484ï¼‰ ä½¿ç”¨ Python typingï¼ˆå°¤å…¶æ˜¯ FastAPIï¼‰ from typing import List, Dict, Optional def add(x: int, y: int) -\u0026gt; int: return x + y ä½¿ç”¨ mypy é™æ€æ£€æŸ¥ pip install mypy mypy your_project/ 10. æµ‹è¯•æœ€ä½³å®è·µï¼ˆpytestï¼‰ å•å…ƒæµ‹è¯•ä¸‰è¦ç´  Arrange -\u0026gt; Act -\u0026gt; Assert\ndef test_add(): assert add(1, 2) == 3 ä½¿ç”¨ fixture @pytest.fixture def db(): ... 11. ç¯å¢ƒç®¡ç†æœ€ä½³å®è·µ ä½¿ç”¨ venv æˆ– conda python3 -m venv venv\nä½¿ç”¨ requirements.txt ç®¡ç†ä¾èµ– pip freeze \u0026gt; requirements.txt å¦‚æœæ˜¯é«˜çº§é¡¹ç›®ï¼š\næ¨èä½¿ç”¨ poetryã€‚\n12. æ–‡ä»¶ã€è·¯å¾„æœ€ä½³å®è·µ ä½¿ç”¨ pathlib è€Œä¸æ˜¯ os.path from pathlib import Path p = Path(\u0026#34;data/file.txt\u0026#34;) è·¨å¹³å°æ— è„‘å¥½ç”¨ã€‚\n13. æ•°æ®åº“æœ€ä½³å®è·µ ä½¿ç”¨ ORMï¼ˆSQLAlchemyï¼‰ ä¸æ‹¼æ¥ SQL å­—ç¬¦ä¸² é¿å… SQL æ³¨å…¥ã€‚\nå®šä¹‰ Repository å±‚ Service å±‚ä¸èƒ½ç›´æ¥æ“ä½œ Sessionã€‚\n14. API æœ€ä½³å®è·µï¼ˆFastAPIï¼‰ ç»Ÿä¸€ response schema ä½¿ç”¨ pydanticã€‚\nä½¿ç”¨ Depends ç®¡ç†ä¾èµ– æ•°æ®åº“ã€æƒé™ã€é…ç½®ã€‚\nå…¨å±€å¼‚å¸¸å¤„ç† ä¿æŒåç«¯æ¥å£è¾“å‡ºä¸€è‡´ã€‚\n15. å¸¸ç”¨å·¥å…·æœ€ä½³å®è·µ ä½¿ç”¨ pathlibã€functoolsã€itertoolsã€collections å†™ Pythonï¼Œå°±æ˜¯è¦æŠŠå†…ç½®å·¥å…·åƒé€ã€‚\nä¾‹ï¼š\nfrom collections import Counter Counter(words) å‡½æ•° å‚è€ƒæ–‡æ¡£ å‚è€ƒ Function (å‡½æ•°) ä¸­çš„æœ€ä½³å®è·µéƒ¨åˆ†ã€‚\nç®€å•çš„å‡½æ•°ï¼Œä¾‹å¦‚ list appendï¼Œ å¯ä»¥ä½¿ç”¨ next/map/filter/lambda ä¼˜åŒ–é‡å†™\nå‚è€ƒæ–‡æ¡£ï¼šnext/map/filter/lambda æœ€ä½³å®è·µ å‚æ•° æ•°æ®åœ¨å‰ï¼Œå…¶å®ƒåœ¨å\nä¸ºäº†åˆ¤æ–­è¿”å›çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼ˆä¸ºTrueï¼‰ æœ‰æ˜ç¡®è¿”å›ç±»å‹ï¼Œæ¯”å¦‚ strã€listã€dictï¼Œæ­£å¸¸è¿”å›å¯¹åº”ç±»å‹çš„æ•°æ®ï¼Œå¼‚å¸¸è¿”å›å¯¹åº”ç±»å‹çš„ False å€¼ æ²¡æœ‰æ˜ç¡®è¿”å›ç±»å‹ï¼ŒåŠ ä¸€ä¸ª None è¿™æ ·ä½¿ç”¨ if å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ¤æ–­æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚\nä½¿ç”¨ try åŒ…è£¹ä¸»ä½“ ç¤ºä¾‹ # æ­£å¸¸è¿”å› listï¼Œå¼‚å¸¸è¿”å› list çš„ False å€¼ [] def map_filter(iterable: Iterable, func: Callable) -\u0026gt; list: \u0026#34;\u0026#34;\u0026#34;å¯¹ iterable æ‰§è¡Œ func, å¹¶ä¿ç•™ä¸º True çš„è¿”å›å€¼\u0026#34;\u0026#34;\u0026#34; try: return [x for x in map(func, iterable) if x] except Exception as e: if DEBUG: logger.exception(e) else: logger.error(e) return [] # æ²¡æœ‰æ˜ç¡®è¿”å›ç±»å‹ï¼ŒåŠ ä¸€ä¸ª None def timestamp_to_datetime(timestamp: int | float, tz: timezone = timezone.utc) -\u0026gt; datetime | None: \u0026#34;\u0026#34;\u0026#34;Unix Timestamp è½¬æ¢ä¸º Datatime\u0026#34;\u0026#34;\u0026#34; try: if not isinstance(timestamp, (int, float)): return None return (datetime.fromtimestamp(timestamp, tz=tz)).replace(tzinfo=None) except Exception as e: if DEBUG: logger.exception(e) else: logger.error(e) return None # åˆ¤æ–­å¹¶å¤„ç† n = map_filter(...) if not n: .... m = timestamp_to_datetime(...) if not m: .... ç¬”è®° ç±»å’Œå®ä¾‹ ç±»åœ¨æ²¡æœ‰å®ä¾‹åŒ–ä¹‹å‰ä¸èƒ½ç›´æ¥è°ƒç”¨ç±»çš„æ–¹æ³•\nmodules/database.py å®šä¹‰äº† database ç±» main.py å°†åˆ›å»ºäº† database ç±» çš„å®ä¾‹åŒ–, å¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³• å¤šçº¿ç¨‹è¦å†™åœ¨ç±»çš„å†…éƒ¨, åœ¨ç±»çš„å¤–éƒ¨ä½¿ç”¨å¤šçº¿ç¨‹è°ƒç”¨ç±»çš„æ–¹æ³•ä¼šæœ‰é—®é¢˜.\nå¾ªç¯ while ä¸€å®šè¦æ·»åŠ  sleepï¼Œå¦åˆ™å¯èƒ½å› ä¸ºå¾ªç¯è¿‡å¿«æˆ–è€…é€»è¾‘ä¸åˆç†å¯¼è‡´ CPU ä½¿ç”¨ç‡å¾ˆé«˜ã€‚\né€šè¿‡ç¨‹åºæ—¥å¿—çš„åˆ·æ–°é€Ÿåº¦ï¼Œglanceså‘½ä»¤ï¼ŒæŸ¥çœ‹å’Œåˆ¤æ–­ CPU çš„ä½¿ç”¨ç‡ã€‚ å…¬ç”¨åŒ… å¦‚ä½•è°ƒè¯•å…¬ç”¨åŒ…ï¼Ÿç›´æ¥å¤åˆ¶ç›¸å…³çš„æ–‡ä»¶åˆ°å½“å‰ç›®å½•ï¼Œä¿®æ”¹ importï¼Œè°ƒè¯•å®Œä»¥åï¼Œåœ¨ ezkit ä¸­å‘å¸ƒã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ ç³»ç»Ÿã€æ¸…æ™°ã€å®ç”¨ çš„ã€ŠPython æœ€ä½³å®è·µã€‹åˆé›†ï¼Œè¦†ç›–ä»£ç é£æ ¼ã€é¡¹ç›®ç»“æ„ã€æ€§èƒ½ã€å®‰å…¨ã€æµ‹è¯•ã€å¹¶å‘ã€è°ƒè¯•ã€æ•°æ®åº“ã€ç±»å‹æ ‡æ³¨ç­‰æ–¹å‘ã€‚ä½œä¸ºé•¿æœŸå†™ Python çš„å¼€å‘è€…ï¼Œä½ ç…§ç€è¿™äº›å®è·µå†™ä»£ç ï¼Œå°±ä¼šå¾ˆâ€œä¸“ä¸šâ€ã€‚\nâœ… Python æœ€ä½³å®è·µï¼ˆ2025 ç‰ˆï¼Œå…¨æ–¹ä½æŒ‡å—ï¼‰\n1. ä»£ç é£æ ¼æœ€ä½³å®è·µï¼ˆPEP8 + å®æˆ˜ç»éªŒï¼‰ ä½¿ç”¨ Black ç»Ÿä¸€æ ¼å¼ ä¸ç”¨çº ç»“ç©ºæ ¼æ¢è¡Œï¼Œè‡ªåŠ¨åŒ–å·¥å…·æœ€çœå¿ƒï¼š\npip install black black your_project/ å˜é‡ã€å‡½æ•°ã€ç±»å‘½åè§„èŒƒ snake_case -\u0026gt; å˜é‡ã€å‡½æ•° PascalCase -\u0026gt; ç±» CONSTANT_CASE -\u0026gt; å¸¸é‡ é¿å…ä¸­æ–‡æ‹¼éŸ³ é¿å…è¿‡é•¿å‡½æ•°ï¼ˆ\u0026gt;50 è¡Œéœ€æ‹†åˆ†ï¼‰ æ¯ä¸ªå‡½æ•°åªåšâ€œä¸€ä»¶äº‹â€ã€‚\n"},{"id":126,"href":"/backend/","title":"Backend","parent":"Documents","content":"Directory List:\nBash Python ","description":"Directory List:\nBash Python "},{"id":127,"href":"/backend/python/official/python-idioms/","title":"Python æƒ¯ç”¨æ³•","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€å¸¸ç”¨ã€æœ€ä¼˜é›…ä¸”é«˜æ•ˆçš„ Python æƒ¯ç”¨æ³•ï¼ˆIdiomsï¼‰+ é£æ ¼çº¦æŸæ¸…å•ï¼Œè¦†ç›–ä»è¯­æ³•ã€æ•°æ®ç»“æ„ã€å‡½æ•°å¼ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½åˆ°æ¶æ„ç­‰æ–¹é¢ã€‚\nè¿™æ˜¯å®é™…å·¥ç¨‹å¸¸è§çš„æœ€ä½³å®è·µï¼Œé€‚åˆæ—¥å¸¸å†™ä¸šåŠ¡ä»£ç ã€åŸºç¡€åº“ã€æˆ–åšå¤§å‹é¡¹ç›®ã€‚\nâ˜˜ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¡¨è¾¾å¼ä¸è¯­æ³•ï¼ˆæœ€å¸¸ç”¨ï¼‰ ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼è€Œä¸æ˜¯ for + append squares = [x*x for x in nums] ä½¿ç”¨é›†åˆ/å­—å…¸æ¨å¯¼å¼ unique_values = {x for x in data} index = {item.id: item for item in items} ä½¿ç”¨å¤šå˜é‡è§£åŒ…ï¼ˆswap æ— éœ€ tempï¼‰ a, b = b, a ä½¿ç”¨ enumerate æ›¿ä»£ range(len) for i, v in enumerate(items): ... ä½¿ç”¨ zip åŒæ­¥éå†å¤šä¸ªåºåˆ— for a, b in zip(list1, list2): ... ä½¿ç”¨ any() / all() åšé€»è¾‘åˆ¤æ–­ if any(v \u0026lt; 0 for v in nums): print(\u0026#34;æœ‰è´Ÿæ•°\u0026#34;) ä½¿ç”¨ join æ‹¼æ¥å­—ç¬¦ä¸²ï¼ˆä¸è¦ç”¨ â€œ+â€ï¼‰ s = \u0026#34;,\u0026#34;.join(names) ä½¿ç”¨ _ è¡¨ç¤ºæ— ç”¨å˜é‡ a, _, c = my_tuple ä½¿ç”¨ f-stringï¼ˆæ¯” format/readability å¼ºå¤ªå¤šï¼‰ f\u0026#34;User {user_id} has {count} messages\u0026#34; ä½¿ç”¨ if obj: è¿›è¡Œé€»è¾‘å€¼æ£€æµ‹ Python ä¼šè‡ªåŠ¨å°†å¯¹è±¡è½¬æ¢ä¸ºå¸ƒå°”å€¼ã€‚\nNone, False, 0, \u0026quot;\u0026quot;, [], {}, set() ç­‰è¢«è§†ä¸ºå‡å€¼ã€‚\nif obj: æ¯” if obj != None: æˆ– if len(obj) \u0026gt; 0: æ›´æƒ¯ç”¨ã€‚\nğŸŒŸğŸŒŸ åˆ¤æ–­å¯¹è±¡çš„ç±»å‹, ä»¥åŠå¯¹è±¡çš„æ•°æ®æ˜¯å¦ä¸ºçœŸ:\nif isinstance(object, typeClass) and object: ... å¸¸ç”¨äºåˆ¤æ–­å‚æ•°çš„ç±»å‹ä»¥åŠå‚æ•°çš„æ•°æ®æ˜¯å¦ä¸ºçœŸ â˜˜ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®ç»“æ„æƒ¯ç”¨æ³• ç”¨ dict.get(key, default) å’Œ dict.setdefault(key, default) ç®€åŒ–åˆ¤æ–­ dict.get(key, default) æ˜¯å®‰å…¨è·å–å­—å…¸å€¼çš„æ–¹å¼ï¼Œé¿å… KeyErrorã€‚ dict.setdefault(key, default) æ˜¯åœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®é»˜è®¤å€¼çš„ä¾¿æ·æ–¹å¼ã€‚ value = config.get(\u0026#34;timeout\u0026#34;, 30) # å®‰å…¨è·å–ï¼Œæä¾›é»˜è®¤å€¼ count = my_dict.get(\u0026#39;key\u0026#39;, 0) # è®¾ç½®é»˜è®¤å€¼ my_dict.setdefault(\u0026#39;key\u0026#39;, []).append(\u0026#39;value\u0026#39;) my_dict = {\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 2} # Key \u0026#39;a\u0026#39; exists, so its value (1) is returned, and the dict is unchanged. value1 = my_dict.setdefault(\u0026#39;a\u0026#39;, 100) print(f\u0026#34;Value 1: {value1}\u0026#34;) print(f\u0026#34;Dict 1: {my_dict}\u0026#34;) # Key \u0026#39;c\u0026#39; does not exist, so it is added with the value 3, which is returned. value2 = my_dict.setdefault(\u0026#39;c\u0026#39;, 3) print(f\u0026#34;Value 2: {value2}\u0026#34;) print(f\u0026#34;Dict 2: {my_dict}\u0026#34;) ç”¨ set æå‡æŸ¥æ‰¾é€Ÿåº¦ï¼ˆO(1)ï¼‰ if x in fast_lookup_set: ... ç”¨ collections.Counter from collections import Counter freq = Counter(words) ç”¨ defaultdict ç®€åŒ–åµŒå¥—ç»“æ„ from collections import defaultdict d = defaultdict(list) d[key].append(value) ç”¨ namedtuple / dataclass è¡¨è¾¾æ•°æ®ç»“æ„ from dataclasses import dataclass @dataclass class User: id: int name: str â˜˜ï¸ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‡½æ•°å¼ï¼ˆmap / filter / reduce / lambdaï¼‰ map/filter ç”¨äºç®€çŸ­åœºæ™¯ list(map(str.upper, names)) æ›´æ¨èåˆ—è¡¨æ¨å¯¼å¼ï¼ˆå¯è¯»æ€§æ›´å¼ºï¼‰ [x.upper() for x in names] ä½¿ç”¨ lambda åšç®€å•å‡½æ•° sorted(users, key=lambda u: u.age) reduce é€‚åˆç´¯åŠ ç±»éœ€æ±‚ from functools import reduce total = reduce(lambda a, b: a + b, nums) â˜˜ï¸ ç¬¬å››éƒ¨åˆ†ï¼šå¼‚å¸¸å¤„ç†æƒ¯ç”¨æ³• å°½é‡æ•æ‰ specific çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è£¸ except try: ... except ValueError: ... ä½¿ç”¨ context managerï¼ˆwithï¼‰ç®€åŒ–èµ„æºç®¡ç† with open(\u0026#34;data.txt\u0026#34;) as f: text = f.read() ä½¿ç”¨ contextlib from contextlib import suppress with suppress(FileNotFoundError): os.remove(\u0026#34;tmp\u0026#34;) é¿å…è¡Œçº§ try/exceptï¼ˆæ€§èƒ½å·®ï¼Œå¯è¯»æ€§å·®ï¼‰ âŒ ä¸æ¨èï¼š\nif key in d: x = d[key] âœ… æ¨èï¼š\ntry: x = d[key] except KeyError: ... ä½¿ç”¨ try/except/else/finally else å­å¥åœ¨ try å—æ²¡æœ‰å¼•å‘å¼‚å¸¸æ—¶æ‰§è¡Œã€‚\nfinally å­å¥æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œå¸¸ç”¨äºæ¸…ç†èµ„æºã€‚\ntry: f = open(\u0026#39;file.txt\u0026#39;) except FileNotFoundError: print(\u0026#34;File not found!\u0026#34;) else: # åªæœ‰åœ¨æ²¡æœ‰å¼‚å¸¸æ—¶æ‰æ‰§è¡Œ content = f.read() f.close() finally: # æ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œ print(\u0026#34;Cleanup done.\u0026#34;) â˜˜ï¸ ç¬¬äº”éƒ¨åˆ†ï¼šå¼‚æ­¥ä¸å¹¶å‘æƒ¯ç”¨æ³• ä½¿ç”¨ asyncio çš„å†…å»ºæ–¹æ³• await asyncio.gather(task1(), task2()) ä½¿ç”¨ asyncio.create_task å¯åŠ¨åå°ä»»åŠ¡ task = asyncio.create_task(worker()) é¿å… async é˜»å¡ CPUï¼Œç”¨ run_in_executor å‚è€ƒ async ä¸­çš„ run_cpu_async\nâ˜˜ï¸ ç¬¬å…­éƒ¨åˆ†ï¼šæ–‡ä»¶ä¸è·¯å¾„ Pathlib æ›¿ä»£ os.path from pathlib import Path path = Path(\u0026#34;data\u0026#34;) / \u0026#34;a.txt\u0026#34; text = path.read_text() ä½¿ç”¨ with ç®¡ç†æ‰“å¼€æ–‡ä»¶ with open(\u0026#34;log.txt\u0026#34;, \u0026#34;w\u0026#34;) as f: f.write(\u0026#34;ok\u0026#34;) â˜˜ï¸ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ€§èƒ½ä¸å†…å­˜æƒ¯ç”¨æ³• ä½¿ç”¨ç”Ÿæˆå™¨å¤„ç†å¤§å‹æ•°æ®ï¼ˆé¿å…ä¸€æ¬¡åŠ è½½æ•´ä¸ªæ–‡ä»¶ï¼‰ def read_lines(path): with open(path) as f: for line in f: yield line.strip() ä½¿ç”¨å±€éƒ¨å˜é‡åŠ é€Ÿï¼ˆå±€éƒ¨å˜é‡è®¿é—®æ›´å¿«ï¼‰ def calc(): total = 0 append = lst.append for i in range(100000): append(i) ä½¿ç”¨ in æ›¿ä»£å¤šå±‚ or åˆ¤æ–­ if status in {\u0026#34;success\u0026#34;, \u0026#34;ok\u0026#34;}: ... ä½¿ç”¨ in è¿›è¡Œæˆå‘˜èµ„æ ¼æµ‹è¯• æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºåºåˆ—ï¼ˆå¦‚åˆ—è¡¨ã€å­—ç¬¦ä¸²ã€å…ƒç»„ï¼‰æˆ–é›†åˆï¼ˆå¦‚é›†åˆã€å­—å…¸ï¼‰ä¸­ï¼Œin æ˜¯æœ€æ¸…æ™°ã€æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚\nif \u0026#39;Py\u0026#39; in \u0026#39;Python\u0026#39;: print(\u0026#34;Found \u0026#39;Py\u0026#39;\u0026#34;) if \u0026#39;key\u0026#39; in my_dict: print(\u0026#34;Key exists in dictionary\u0026#34;) ä½¿ç”¨ lru_cache ç¼“å­˜é‡å¤å‡½æ•°ç»“æœ from functools import lru_cache @lru_cache def heavy(x): ... ä½¿ç”¨ with è¯­å¥è¿›è¡Œèµ„æºç®¡ç† éµå¾ªä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®ï¼Œç¡®ä¿èµ„æºï¼ˆå¦‚æ–‡ä»¶ã€ç½‘ç»œè¿æ¥ã€é”ç­‰ï¼‰åœ¨ä½¿ç”¨åèƒ½è¢«æ­£ç¡®åœ°æ¸…ç†ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™æ˜¯å¤„ç†èµ„æºçš„æ ‡å‡†æ–¹å¼ã€‚\n# å¥½çš„æƒ¯ç”¨æ³•ï¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ with open(\u0026#39;somefile.txt\u0026#39;, \u0026#39;r\u0026#39;) as f: content = f.read() # f åœ¨è¿™é‡Œè‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ f.close() # é¿å…æ‰‹åŠ¨ç®¡ç†èµ„æº # f = open(\u0026#39;somefile.txt\u0026#39;, \u0026#39;r\u0026#39;) # content = f.read() # f.close() # å¯èƒ½å¿˜è®°ï¼Œæˆ–åœ¨ read æ—¶å‡ºé”™å¯¼è‡´ close ä¸è¢«è°ƒç”¨ â˜˜ï¸ ç¬¬å…«éƒ¨åˆ†ï¼šä»£ç ç»“æ„ä¸æ¶æ„é£æ ¼ï¼ˆå·¥ç¨‹çº§ï¼‰ å•ä¸€èŒè´£ï¼šæ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ def load(): ... def validate(): ... def write(): ... ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆç‰¹åˆ«æ˜¯ FastAPIï¼‰ def get_db(): with SessionLocal() as db: yield db é…ç½®æ–‡ä»¶å¤–ç½®ï¼ˆjson / yaml / tomlï¼‰ æ¨¡å—åç§°å…¨å°å†™ï¼Œç±»åç”¨ PascalCase å¼•å…¥é¡ºåºè§„èŒƒ æ ‡å‡†åº“ ç¬¬ä¸‰æ–¹åº“ æœ¬åœ°é¡¹ç›®æ¨¡å— ä½¿ç”¨ if __name__ == '__main__': è¿›è¡Œæ¨¡å—ä¿æŠ¤ è¿™æ˜¯ Python ä¸­çš„ä¸€ä¸ªæ ‡å‡†æ¨¡å¼ï¼Œç”¨äºç¡®ä¿æ¨¡å—åœ¨ä½œä¸ºè„šæœ¬ç›´æ¥è¿è¡Œæ—¶æ‰æ‰§è¡Œç‰¹å®šä»£ç å—ï¼ˆå¦‚ main å‡½æ•°æˆ–æµ‹è¯•ä»£ç ï¼‰ï¼Œè€Œåœ¨è¢«å¯¼å…¥æ—¶åˆ™ä¸ä¼šæ‰§è¡Œã€‚\n# my_module.py def my_function(): return \u0026#34;Hello from module!\u0026#34; if __name__ == \u0026#39;__main__\u0026#39;: # è¿™éƒ¨åˆ†ä»£ç åªåœ¨ç›´æ¥è¿è¡Œ my_module.py æ—¶æ‰§è¡Œ print(my_function()) â˜˜ï¸ ç¬¬ä¹éƒ¨åˆ†ï¼šä¼˜é›…ä»£ç çš„å†™æ³•ï¼ˆéå¸¸é‡è¦ï¼‰ å†™çŸ­å‡½æ•°ï¼ˆä¸€èˆ¬ä¸è¶…è¿‡ 40 è¡Œï¼‰ åç§° å˜é‡å: ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šmy_variable å¸¸é‡å: ä½¿ç”¨å…¨éƒ¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šMAX_VALUE ç±»å: ä½¿ç”¨é©¼å³°å‘½åæ³•ï¼Œæ¯ä¸ªå•è¯é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚ï¼šMyClass å‡½æ•°å: ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šmy_function å‡å°‘ä¸å¿…è¦çš„å˜é‡ æ¯”å¦‚ï¼šåªä½¿ç”¨ 1æ¬¡ çš„å˜é‡\næ˜ç¡®å‘½åå˜é‡ âŒ a, b, c âœ… user_id, file_path, timeout_ms ä½¿ç”¨ç±»å‹æ³¨è§£ï¼ˆå¼ºçƒˆæ¨èï¼‰ def add(x: int, y: int) -\u0026gt; int: return x + y ä¿æŒå‡½æ•°è¿”å›ä¸€è‡´æ€§ âŒ æœ‰æ—¶è¿”å›å¯¹è±¡ï¼Œæœ‰æ—¶è¿”å› None âœ… ä¿æŒç»Ÿä¸€è¿”å›å€¼ç±»å‹ é¿å…ç¥å¥‡æ•°å­—ï¼ˆmagic numberï¼‰ DEFAULT_TIMEOUT = 30 ä½¿ç”¨ is è¿›è¡Œå•ä¾‹ï¼ˆå¦‚ None, True, Falseï¼‰å’Œèº«ä»½æ¯”è¾ƒ is æ£€æŸ¥ä¸¤ä¸ªå˜é‡æ˜¯å¦æŒ‡å‘å†…å­˜ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡ã€‚å¯¹äº None è¿™æ ·çš„å•ä¾‹ï¼Œä½¿ç”¨ is æ¯” == æ›´ç²¾ç¡®ã€æ›´é«˜æ•ˆã€‚\nif value is None: print(\u0026#34;Value is not set\u0026#34;) # é¿å… # if value == None: # print(\u0026#34;Value is not set\u0026#34;) # ä¸æ¨è ä½¿ç”¨ or è¿›è¡Œé»˜è®¤å€¼èµ‹å€¼ åˆ©ç”¨ or è¿ç®—ç¬¦çš„çŸ­è·¯æ±‚å€¼ç‰¹æ€§ï¼Œå¦‚æœå·¦ä¾§æ“ä½œæ•°ä¸ºå‡å€¼ï¼Œåˆ™è¿”å›å³ä¾§æ“ä½œæ•°ã€‚\n# b = z(x=n or m) # å¦‚æ‚¨ä¹‹å‰çš„é—®é¢˜ï¼Œè¿™æ˜¯æƒ¯ç”¨æ³• config_value = user_input or \u0026#39;default_value\u0026#39; ä½¿ç”¨ repr() å’Œ str() repr() æ—¨åœ¨ç”Ÿæˆä¸€ä¸ªæ˜ç¡®çš„ã€é¢å‘å¼€å‘è€…ï¼ˆæˆ–è§£é‡Šå™¨ï¼‰çš„å¯¹è±¡è¡¨ç¤ºå½¢å¼ã€‚\nstr() æ—¨åœ¨ç”Ÿæˆä¸€ä¸ªæ˜“äºé˜…è¯»ã€é¢å‘ç”¨æˆ·ï¼ˆ æˆ– print() ï¼‰çš„å¯¹è±¡è¡¨ç¤ºå½¢å¼ã€‚\néµå¾ª PEP 8 ä»£ç é£æ ¼ ä½¿ç”¨ 4 ä¸ªç©ºæ ¼ç¼©è¿› ä½¿ç”¨ snake_case å‘½åå‡½æ•°ã€å˜é‡ã€æ–¹æ³•å’Œæ¨¡å— ä½¿ç”¨ UpperCamelCase å‘½åç±» ä½¿ç”¨ UPPER_CASE_WITH_UNDERSCORES å‘½åå¸¸é‡ åœ¨è¿ç®—ç¬¦å‘¨å›´ä½¿ç”¨ç©ºæ ¼: a = b + c åœ¨é€—å·åä½¿ç”¨ç©ºæ ¼: func(a, b, c) åœ¨å‡½æ•°å’Œç±»ä¹‹é—´ä½¿ç”¨ä¸¤ä¸ªç©ºè¡Œï¼Œæ–¹æ³•ä¹‹é—´ä½¿ç”¨ä¸€ä¸ªç©ºè¡Œã€‚ â˜˜ï¸ ç¬¬åéƒ¨åˆ†ï¼šæœ€ä½“ç° Pythonic å¿ƒæ³•çš„ä¸€å¥è¯ Pythonic çš„æœ¬è´¨ä¸æ˜¯â€œå†™çŸ­â€ï¼Œè€Œæ˜¯â€œå†™å¯è¯»ã€è¡¨è¾¾æ„å›¾æ¸…æ™°ã€åˆ«äººä¸€çœ¼èƒ½æ‡‚çš„ä»£ç â€ã€‚\nEffective ç”¨è¾…åŠ©å‡½æ•°å–ä»£å¤æ‚çš„è¡¨è¾¾å¼ Python çš„è¯­æ³•å¾ˆå®¹æ˜“æŠŠå¤æ‚çš„æ„æ€æŒ¤åˆ°åŒä¸€è¡Œè¡¨è¾¾å¼é‡Œï¼Œè¿™æ ·å†™å¾ˆéš¾æ‡‚ã€‚ å¤æ‚çš„è¡¨è¾¾å¼ï¼Œå°¤å…¶æ˜¯é‚£ç§éœ€è¦é‡å¤ä½¿ç”¨çš„å¤æ‚è¡¨è¾¾å¼ï¼Œåº”è¯¥å†™åˆ°è¾…åŠ©å‡½æ•°é‡Œé¢ã€‚ ç”¨ if/else ç»“æ„å†™æˆçš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œè¦æ¯”ç”¨ or ä¸ and å†™æˆçš„ Boolean è¡¨è¾¾å¼æ›´å¥½æ‡‚ã€‚ ç¬”è®°ï¼šå†™å…¬ç”¨æ–¹æ³•ï¼Œå¤ç”¨ã€‚ # âŒ red = int(my_values.get(\u0026#39;red\u0026#39;, [\u0026#39;\u0026#39;])[0] or 0) # âŒ red_str = my_values.get(\u0026#39;red\u0026#39;, [\u0026#39;\u0026#39;]) red = int(red_str[0]) if red_str[0] else 0 # âœ… def get_first_int(values, key, default=0): found = values.get(key, [\u0026#39;\u0026#39;]) if found[0]: return int(found[0]) return default red = get_first_int(my_values, \u0026#39;red\u0026#39;) green = get_first_int(my_values, \u0026#39;green\u0026#39;) unpacking (è§£åŒ…) unpacking æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Python è¯­æ³•ï¼Œåªéœ€è¦ä¸€è¡Œä»£ç ï¼Œå°±èƒ½æŠŠæ•°æ®ç»“æ„é‡Œé¢çš„å¤šä¸ªå€¼åˆ†åˆ«èµ‹ç»™ç›¸åº”çš„å˜é‡ã€‚ unpacking åœ¨ Python ä¸­åº”ç”¨å¹¿æ³›ï¼Œå‡¡æ˜¯å¯è¿­ä»£çš„å¯¹è±¡éƒ½èƒ½æ‹†åˆ†ï¼Œæ— è®ºå®ƒé‡Œé¢è¿˜æœ‰å¤šå°‘å±‚è¿­ä»£ç»“æ„ã€‚ å°½é‡é€šè¿‡ unpacking æ¥æ‹†è§£åºåˆ—ä¹‹ä¸­çš„æ•°æ®ï¼Œè€Œä¸è¦é€šè¿‡ä¸‹æ ‡è®¿é—®ï¼Œè¿™æ ·å¯ä»¥è®©ä»£ç æ›´ç®€æ´ã€æ›´æ¸…æ™°ã€‚ favorite_snacks = { \u0026#34;salty\u0026#34;: (\u0026#34;pretzels\u0026#34;, 100), \u0026#34;sweet\u0026#34;: (\u0026#34;cookies\u0026#34;, 180), \u0026#34;veggie\u0026#34;: (\u0026#34;carrots\u0026#34;, 20) } ((type1, (name1, cals1)), (type2, (name2, cals2)), (type3, (name3, cals3))) = favorite_snacks.items() print(f\u0026#39;Favorite {type1} is {name1} with {cals1} calories\u0026#39;) print(f\u0026#39;Favorite {type1} is {name1} with {cals1} calories\u0026#39;) print(f\u0026#39;Favorite {type1} is {name1} with {cals1} calories\u0026#39;) Bool ç±»å‹ï¼Œå¥½çš„å‘½å Python ä¸­ Bool ç±»å‹å‚æ•°é€šå¸¸å»ºè®®ä½¿ç”¨ â€œæ˜¯/å¦â€ æˆ– â€œæœ‰/æ— â€ çš„ç–‘é—®å¥å¼å‰ç¼€ï¼Œå¦‚ is_ã€has_ã€should_ã€can_ ç­‰ï¼Œä»¥æé«˜ä»£ç å¯è¯»æ€§ã€‚å‘½ååº”æ¸…æ™°åæ˜ â€œçœŸ/å‡â€å¸¦æ¥çš„è¡Œä¸ºå·®å¼‚ï¼Œä¾‹å¦‚ is_enabledã€has_valueã€should_saveã€‚\nå¸¸ç”¨å‘½åè§„èŒƒï¼š\nis_ (æ˜¯\u0026hellip;)ï¼šè¡¨ç¤ºå±æ€§æˆ–çŠ¶æ€ï¼Œå¦‚ is_activeã€is_visibleã€‚ has_ (æœ‰\u0026hellip;)ï¼šè¡¨ç¤ºåŒ…å«å…³ç³»ï¼Œå¦‚ has_permissionã€has_dataã€‚ should_ (åº”è¯¥\u0026hellip;)ï¼šè¡¨ç¤ºå»ºè®®æˆ–æ§åˆ¶è¡Œä¸ºï¼Œå¦‚ should_loginã€should_updateã€‚ can_ (èƒ½å¤Ÿ\u0026hellip;)ï¼šè¡¨ç¤ºèƒ½åŠ›æˆ–æƒé™ï¼Œå¦‚ can_deleteã€can_editã€‚ enable_ / disable_ (å¯ç”¨/ç¦ç”¨\u0026hellip;)ï¼šå¸¸ç”¨äºé…ç½®å¼€å…³ï¼Œå¦‚ enable_featureã€‚ ç¤ºä¾‹ï¼š\n# å¥½çš„å‘½å def delete_user(user_id, is_admin=False): pass def save_data(data, should_compress=True): pass # ä¸å¥½çš„å‘½å def delete_user(user_id, admin=False): # ä¸æ¸…æ¥šadminæ˜¯ç”¨æˆ·è¿˜æ˜¯æ ‡è®° pass é€šè¿‡ä½¿ç”¨è¿™äº›å‰ç¼€ï¼Œä»£ç åœ¨é˜…è¯»æ—¶æ›´åƒæ˜¯è‡ªç„¶è¯­è¨€ï¼Œèƒ½æ›´ç›´è§‚åœ°ç†è§£å‡½æ•°é€»è¾‘ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€å¸¸ç”¨ã€æœ€ä¼˜é›…ä¸”é«˜æ•ˆçš„ Python æƒ¯ç”¨æ³•ï¼ˆIdiomsï¼‰+ é£æ ¼çº¦æŸæ¸…å•ï¼Œè¦†ç›–ä»è¯­æ³•ã€æ•°æ®ç»“æ„ã€å‡½æ•°å¼ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½åˆ°æ¶æ„ç­‰æ–¹é¢ã€‚\nè¿™æ˜¯å®é™…å·¥ç¨‹å¸¸è§çš„æœ€ä½³å®è·µï¼Œé€‚åˆæ—¥å¸¸å†™ä¸šåŠ¡ä»£ç ã€åŸºç¡€åº“ã€æˆ–åšå¤§å‹é¡¹ç›®ã€‚\nâ˜˜ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¡¨è¾¾å¼ä¸è¯­æ³•ï¼ˆæœ€å¸¸ç”¨ï¼‰ ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼è€Œä¸æ˜¯ for + append squares = [x*x for x in nums] ä½¿ç”¨é›†åˆ/å­—å…¸æ¨å¯¼å¼ unique_values = {x for x in data} index = {item.id: item for item in items} ä½¿ç”¨å¤šå˜é‡è§£åŒ…ï¼ˆswap æ— éœ€ tempï¼‰ a, b = b, a ä½¿ç”¨ enumerate æ›¿ä»£ range(len) for i, v in enumerate(items): ... ä½¿ç”¨ zip åŒæ­¥éå†å¤šä¸ªåºåˆ— for a, b in zip(list1, list2): ... ä½¿ç”¨ any() / all() åšé€»è¾‘åˆ¤æ–­ if any(v \u0026lt; 0 for v in nums): print(\u0026#34;æœ‰è´Ÿæ•°\u0026#34;) ä½¿ç”¨ join æ‹¼æ¥å­—ç¬¦ä¸²ï¼ˆä¸è¦ç”¨ â€œ+â€ï¼‰ s = \u0026#34;,\u0026#34;.join(names) ä½¿ç”¨ _ è¡¨ç¤ºæ— ç”¨å˜é‡ a, _, c = my_tuple ä½¿ç”¨ f-stringï¼ˆæ¯” format/readability å¼ºå¤ªå¤šï¼‰ f\u0026#34;User {user_id} has {count} messages\u0026#34; ä½¿ç”¨ if obj: è¿›è¡Œé€»è¾‘å€¼æ£€æµ‹ Python ä¼šè‡ªåŠ¨å°†å¯¹è±¡è½¬æ¢ä¸ºå¸ƒå°”å€¼ã€‚\n"},{"id":128,"href":"/database/","title":"Database","parent":"Documents","content":"Directory List:\nDesign ElasticSearch MongoDB MySQL PostgreSQL Prometheus Redis ","description":"Directory List:\nDesign ElasticSearch MongoDB MySQL PostgreSQL Prometheus Redis "},{"id":129,"href":"/backend/python/official/next-map-filter-lambda/","title":"next/map/filter/lambda æœ€ä½³å®è·µ","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£é¢å‘å®é™…é¡¹ç›®ï¼ˆå°¤å…¶æ˜¯çˆ¬è™« / æ•°æ®æ¸…æ´— / API æœåŠ¡ / é‡‘èç±»æ•°æ®å¤„ç†ï¼‰ çš„\nğŸ“Œã€Šnext / map / filter / lambda çš„é¡¹ç›®çº§æœ€ä½³å®è·µï¼ˆè¶…å¼ºå®Œæ•´ç‰ˆï¼‰ã€‹\næ¶µç›–ï¼šè®¾è®¡ç†å¿µã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ã€åæ¨¡å¼ã€ç»„åˆæ–¹å¼ã€çœŸå®ä¸šåŠ¡åœºæ™¯ã€‚\nâ˜˜ï¸ æ ¸å¿ƒç†å¿µï¼ˆé¡¹ç›®çº§è¦ç‚¹ï¼‰ åœ¨å®é™…é¡¹ç›®ä¸­ï¼š\nlambda ç”¨äºéå¸¸çŸ­å°ã€ä¸ä¼šå¤ç”¨çš„è¡¨è¾¾å¼ map/filter ç”¨äºçº¯å‡½æ•°å¼æ•°æ®æµ next ç”¨äºä»æµä¸­æ‰¾ç¬¬ä¸€é¡¹ ä¸è¦æ»¥ç”¨ï¼Œæ˜“è¯»æ€§ \u0026gt; ç®€æ´æ€§ æœ€ç»ˆç›®æ ‡ï¼šå†™å‡ºå¯è¯»ã€å¯ç»´æŠ¤ã€å¯å¤ç”¨ã€å¯æµ‹è¯•çš„ä»£ç  ğŸŒŸ PART 1ï¼šnext â€”â€” â€œæ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€é¡¹â€ï¼ˆé¡¹ç›®ä¸­éå¸¸å¸¸ç”¨ï¼‰ âœ… 1.1 æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼ˆé«˜é¢‘ç”¨æ³•ï¼‰ âŒ ä¸ä¼˜é›…\nresult = None for row in rows: if row[\u0026#34;code\u0026#34;] == code: result = row break âœ… æ¨è\nresult = next((x for x in rows if x[\u0026#34;code\u0026#34;] == code), None) âœ… 1.2 ç”¨ next åšâ€œå…œåº•é€»è¾‘â€ record = next((x for x in stocks if x[\u0026#34;is_active\u0026#34;]), {\u0026#34;status\u0026#34;: \u0026#34;none\u0026#34;}) âœ… 1.3 next æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸé¡¹ï¼ˆæ— éœ€éå†æ•´ä¸ªåˆ—è¡¨ï¼‰ has_st = next((True for x in names if \u0026#34;ST\u0026#34; in x), False) âœ… 1.4 ä¸ç”Ÿæˆå™¨é…åˆå®ç°æƒ°æ€§ç®¡é“ï¼ˆæ€§èƒ½å…³é”®ï¼‰ def active_stocks(): for stock in big_stock_list: # æ•°ç™¾ä¸‡æ¡ if stock[\u0026#34;active\u0026#34;]: yield stock first = next(active_stocks(), None) â© å†…å­˜å ç”¨æä½ã€‚\nğŸŒŸ PART 2ï¼šmap â€”â€” å¼ºè°ƒ â€œæ‰¹é‡è½¬æ¢â€ ğŸš« 2.1 ä»€ä¹ˆæ—¶å€™ä¸è¦ç”¨ mapï¼Ÿ ä¸è¦æŠŠå¾ˆå¤æ‚çš„é€»è¾‘å†™åœ¨ map ä¸­ï¼š\n# ä¸æ¨èï¼šéš¾è¯» list(map(lambda x: do_clean(x.strip().lower().replace(\u0026#34;\\n\u0026#34;, \u0026#34;\u0026#34;)), lst)) âœ… 2.2 æ¨èçš„å†™æ³•ï¼šæ­é…ç‹¬ç«‹çš„çº¯å‡½æ•° def clean(s: str) -\u0026gt; str: return s.strip().replace(\u0026#34;\\n\u0026#34;, \u0026#34;\u0026#34;).lower() cleaned = list(map(clean, lines)) æ€§èƒ½å¥½ã€å¯æµ‹è¯•ã€å¯è¯»ã€‚\nâœ… 2.3 map é€‚åˆçš„æ•°æ®åŠ å·¥æµæ°´çº¿ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰ codes = list( map(lambda x: x[\u0026#34;secu_code\u0026#34;], response_json[\u0026#34;data\u0026#34;]) ) âœ… 2.4 map å¤šå‚æ•°è¾“å…¥ï¼ˆåŠŸèƒ½å¼ºå¤§ï¼‰ a = [1, 2, 3] b = [10, 20, 30] result = list(map(lambda x, y: x + y, a, b)) ğŸŒŸ PART 3ï¼šfilter â€”â€” å¼ºè°ƒâ€œæ¡ä»¶è¿‡æ»¤â€ âŒ 3.1 ä¸æ¨èåœ¨ filter å†…å†™å¤æ‚ lambda # ç³Ÿç³• valid = list(filter(lambda x: x[\u0026#34;code\u0026#34;].startswith(\u0026#34;00\u0026#34;) and x[\u0026#34;price\u0026#34;] \u0026gt; 10, rows)) âœ… æ›´ä¼˜é›…çš„æ–¹å¼ï¼šåˆ†ç¦»é€»è¾‘\ndef is_valid_stock(x): return x[\u0026#34;code\u0026#34;].startswith(\u0026#34;00\u0026#34;) and x[\u0026#34;price\u0026#34;] \u0026gt; 10 valid = list(filter(is_valid_stock, rows)) âœ… 3.2 é«˜é¢‘ï¼šæ¸…æ´—è„æ•°æ®ï¼ˆçˆ¬è™«å¸¸è§ï¼‰ cleaned = list(filter(None, data)) âœ… 3.3 è´¢ç»ç±»ç­›é€‰ï¼ˆST + é“¶è¡Œ + è¯åˆ¸ï¼‰ filtered = list( filter( lambda x: \u0026#34;ST\u0026#34; not in x[\u0026#34;name\u0026#34;] and not re.search(\u0026#34;é“¶è¡Œ|è¯åˆ¸\u0026#34;, x[\u0026#34;name\u0026#34;]), records ) ) ğŸŒŸ PART 4ï¼šlambda â€”â€” åªç”¨äºâ€œä¸€æ¬¡æ€§çš„ç®€å•é€»è¾‘â€ âŒ lambda æ»¥ç”¨ç¤ºä¾‹ï¼ˆå®é™…é¡¹ç›®ä¸­å¾ˆç³Ÿç³•ï¼‰ sorted(data, key=lambda x: x.strip().lower().replace(\u0026#34;_\u0026#34;, \u0026#34;\u0026#34;)) çœ‹ä¸æ‡‚ã€æ— æ³•å¤ç”¨ã€å¯è¯»æ€§å·®ã€æ— æ³•å†™å•å…ƒæµ‹è¯•ã€‚\nâœ… æ­£ç¡®ï¼šlambda åªç”¨äºä¸€è¡Œé€»è¾‘ sorted(data, key=lambda x: x[\u0026#34;date\u0026#34;]) âœ… lambda ä¸é—­åŒ…ï¼ˆæ³¨æ„ä½œç”¨åŸŸï¼‰ f = lambda x, base=10: x + base ğŸŒŸ PART 5ï¼šç»„åˆæ‹³ â€”â€” é¡¹ç›®ä¸­æœ€å¸¸ç”¨çš„æµæ°´çº¿æ¨¡å¼ â­ 5.1 è‚¡ç¥¨æ•°æ®æ¸…æ´—æµç¨‹ï¼ˆçœŸå®åœºæ™¯ï¼‰ result = list( map( lambda x: { \u0026#34;code\u0026#34;: x[\u0026#34;secu_code\u0026#34;], \u0026#34;name\u0026#34;: x[\u0026#34;secu_name\u0026#34;].strip(), }, filter( lambda x: re.match(r\u0026#34;^(00|60)\\d+\u0026#34;, x[\u0026#34;secu_code\u0026#34;]) and \u0026#34;ST\u0026#34; not in x[\u0026#34;secu_name\u0026#34;], response_json[\u0026#34;data\u0026#34;] ), ) ) ä¸šåŠ¡é€»è¾‘ï¼š\nfilter -\u0026gt; è¿‡æ»¤æ‰é A è‚¡ã€ST map -\u0026gt; ä»…ä¿ç•™ code å’Œ name å­—æ®µ â­ 5.2 next + filterï¼šæ‰¾ç¬¬ä¸€ä¸ªæ¶¨åœè‚¡ç¥¨ limit_up_stock = next( (x for x in stocks if x[\u0026#34;pct_chg\u0026#34;] \u0026gt;= 9.9), None, ) â­ 5.3 æ›´ä¼˜é›…çš„ functional pipeline def valid_stock(x): return re.match(r\u0026#34;^(00|60)\\d+\u0026#34;, x[\u0026#34;code\u0026#34;]) def extract(x): return {\u0026#34;code\u0026#34;: x[\u0026#34;code\u0026#34;], \u0026#34;name\u0026#34;: x[\u0026#34;name\u0026#34;].strip()} result = list(map(extract, filter(valid_stock, data))) ğŸŒŸ PART 6ï¼šæ€§èƒ½æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ âœ… map/filter ä½¿ç”¨ C å±‚å®ç° -\u0026gt; æ¯” for æ›´å¿«\nä½†ä»…å½“ï¼š\nlambda éå¸¸è½»é‡ æ•°æ®é‡å¤§ ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€ âœ… next((â€¦), None) åªæ‰«æåˆ°ç¬¬ä¸€é¡¹ -\u0026gt; é«˜æ•ˆ\næ¯” filter æ›´å¿«ã€‚\nâœ… ä¸€å®šè¦æ­é…ç”Ÿæˆå™¨å®ç°â€œæƒ°æ€§â€\né¿å…ï¼š\nlist(...) # ä¸è¦è½»æ˜“å¼ºåˆ¶â€œè€—å°½â€ ğŸŒŸ PART 7ï¼šä½ åœ¨å®é™…é¡¹ç›®ä¸­ï¼ˆå°¤å…¶æ˜¯ä½ è‡ªå·±çš„è‚¡ç¥¨çˆ¬è™«é¡¹ç›®ï¼‰æœ€å¸¸ç”¨çš„æœ€ä½³å†™æ³• ğŸ‘‰ å†™ä¸€ä¸ªâ€œæŸ¥æ‰¾ + ç­›é€‰ + æå–â€çš„é€šç”¨å‡½æ•° def find_first(seq, predicate): return next((x for x in seq if predicate(x)), None) ğŸ‘‰ é€šç”¨ map/filter pipelineï¼ˆæ¨èï¼‰ def pipe(data, *funcs): for f in funcs: data = f(data) return data ä½¿ç”¨ï¼š\nresult = pipe( data, lambda d: filter(lambda x: x[\u0026#34;active\u0026#34;], d), lambda d: map(lambda x: x[\u0026#34;name\u0026#34;], d), list ) ğŸ¯ æ€»ç»“ï¼ˆå¯ä½œä¸ºå›¢é˜Ÿä»£ç è§„èŒƒï¼‰ å·¥å…· æœ€ä½³ä½¿ç”¨æ–¹å¼ next æŸ¥æ‰¾ç¬¬ä¸€é¡¹ / å¸¦é»˜è®¤å€¼ / æƒ°æ€§å¤„ç† map è½»é‡è½¬æ¢ / æ•°æ®æ¸…æ´— / æå–å­—æ®µ filter æ¡ä»¶ç­›é€‰ / æ¸…æ´—è„æ•°æ® lambda ä¸€è¡Œé€»è¾‘ï¼Œæ— æ³•å¤ç”¨çš„åœºæ™¯ pipeline map + filter + next æ„å»ºæµå¼å¤„ç† âœ… 1. next() â€” å–è¿­ä»£å™¨ä¸­çš„â€œä¸‹ä¸€ä¸ªå€¼â€ ğŸ‘‰ ä½¿ç”¨åœºæ™¯\nä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„å…ƒç´  å®‰å…¨åœ°ä»è¿­ä»£å™¨ä¸­è·å–æ•°æ® é»˜è®¤å€¼å¤„ç†ï¼ˆé¿å…æŠ› StopIterationï¼‰ æ„é€ ç±»ä¼¼ SQL çš„æŸ¥è¯¢ï¼ˆâ€œå–ç¬¬ä¸€æ¡è®°å½•â€ï¼‰ ä¸ç”Ÿæˆå™¨é…åˆå®ç°â€œæƒ°æ€§è®¡ç®—â€ ğŸ”¥ æœ€å¸¸è§å†™æ³•ï¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹\nitems = [{\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;000783\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;sh123456\u0026#34;}] result = next((x for x in items if x[\u0026#34;code\u0026#34;].startswith(\u0026#34;00\u0026#34;)), None) print(result) è¾“å‡ºï¼š\n{\u0026#39;code\u0026#39;: \u0026#39;000783\u0026#39;} ğŸ“Œ æ¯” for å¾ªç¯æ›´åŠ ä¼˜é›…ã€å¯è¯»æ€§æ›´å¥½ã€‚\nğŸ‘‰ ä»ç”Ÿæˆå™¨ä¸­å®‰å…¨è¯»å–æ•°æ®ï¼ˆæ— å¼‚å¸¸ï¼‰\ndef gen(): yield 1 yield 2 g = gen() print(next(g, None)) # 1 print(next(g, None)) # 2 print(next(g, None)) # Noneï¼ˆä¸ä¼šæŠ¥é”™ï¼‰ ğŸ‘‰ æ¨¡æ‹Ÿæ•°æ®åº“çš„â€œå–ç¬¬ä¸€æ¡ç»“æœâ€\nrecord = next((row for row in rows if row.id == 123), None) ğŸŸ¦ next(): é€‚ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ ç¤ºä¾‹ å–ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„å…ƒç´  next((x for x in lst if â€¦), None) å–è¿­ä»£å™¨ä¸‹ä¸€é¡¹ next(iterator) æ— å€¼æ—¶ä½¿ç”¨é»˜è®¤å€¼ next(iterator, default) å®ç°æƒ°æ€§éå† é…åˆç”Ÿæˆå™¨ yield âœ… 2. map() â€” å¯¹åºåˆ—é€é¡¹â€œæ˜ å°„â€ ğŸ‘‰ ä½¿ç”¨åœºæ™¯\nå¯¹åˆ—è¡¨æ¯é¡¹åšç›¸åŒå˜æ¢ï¼ˆçº¯å‡½æ•°å¼ï¼‰ æ›¿ä»£ for å¾ªç¯ä¸­çš„ append æ›´é€‚åˆ CPU å¯†é›† or å¹¶è¡Œ map ğŸ”¥ åŸºç¡€ç¤ºä¾‹ï¼šå¯¹åˆ—è¡¨æ‰€æœ‰å…ƒç´ ä¹˜ 2\nnums = [1, 2, 3, 4] result = list(map(lambda x: x * 2, nums)) print(result) è¾“å‡ºï¼š\n[2, 4, 6, 8] ğŸ‘‰ å°† dict åˆ—è¡¨è½¬æ¢æˆåªåŒ…å« code å­—æ®µ\nstocks = [{\u0026#34;code\u0026#34;: \u0026#34;600000\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;000001\u0026#34;}] codes = list(map(lambda x: x[\u0026#34;code\u0026#34;], stocks)) print(codes) ğŸ‘‰ è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰\nimport datetime times = [\u0026#34;2025-01-01 12:00:00\u0026#34;, \u0026#34;2025-01-01 13:00:00\u0026#34;] parsed = list(map(lambda x: datetime.datetime.strptime(x, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;), times)) ğŸŸ¦ map(): é€‚ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ ç¤ºä¾‹ æ‰¹é‡æ ¼å¼è½¬æ¢ map(str.upper, lst) ä»å¯¹è±¡ä¸­æå–æŸå­—æ®µ map(lambda x: x['code'], items) ç”Ÿæˆå™¨å…¼å®¹ï¼ˆæƒ°æ€§ï¼‰ map(f, iterator) æ¸…æ´—æ•°æ® map(trim, rows) âœ… 3. filter() â€” å¯¹åˆ—è¡¨æŒ‰æ¡ä»¶ç­›é€‰ ğŸ‘‰ ä½¿ç”¨åœºæ™¯\nä¿ç•™æ»¡è¶³æ¡ä»¶çš„æ•°æ® å¤§è¡¨ç­›é€‰ã€çˆ¬è™«è¿‡æ»¤ æç®€å†™æ³•æ›¿ä»£ for+if ğŸ”¥ ç¤ºä¾‹ï¼šç­›é€‰ç¬¦åˆâ€œ00 æˆ– 60 å¼€å¤´â€çš„è‚¡ç¥¨\nstocks = [\u0026#34;000001\u0026#34;, \u0026#34;600001\u0026#34;, \u0026#34;301001\u0026#34;, \u0026#34;abc\u0026#34;] f = filter(lambda x: x.isdigit() and (x.startswith(\u0026#34;00\u0026#34;) or x.startswith(\u0026#34;60\u0026#34;)), stocks) print(list(f)) è¾“å‡ºï¼š\n[\u0026#39;000001\u0026#39;, \u0026#39;600001\u0026#39;] ğŸ‘‰ ç­›é€‰éç©ºå­—ç¬¦ä¸²\nlst = [\u0026#34;a\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;b\u0026#34;, None] result = list(filter(None, lst)) print(result) è¾“å‡ºï¼š\n[\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;] âœ… filter(None, lst) æ˜¯å¸¸ç”¨æŠ€å·§ï¼ˆè‡ªåŠ¨è¿‡æ»¤ç©ºå€¼ï¼‰ã€‚\nğŸ‘‰ ç­›é€‰å“åº”çŠ¶æ€ç ä¸º 200 çš„ HTTP å“åº”åˆ—è¡¨\nvalid = list(filter(lambda r: r.status_code == 200, responses)) ğŸŸ¦ filter(): é€‚ç”¨åœºæ™¯æ€»ç»“ åœºæ™¯ ç¤ºä¾‹ æ ¹æ®æ¡ä»¶ç­›é€‰æ•°æ® filter(lambda x: x \u0026gt; 0, nums) æ¸…æ´—è„æ•°æ® filter(None, lst) çˆ¬è™«è¿‡æ»¤ç¬¦åˆè§„åˆ™çš„é¡¹ filter(lambda x: 'æ–°é—»' in x['title'], data) å¤§åˆ—è¡¨çš„æƒ°æ€§ç­›é€‰ filter(predicate, iterator) ğŸ”¥ ä¸‰è€…ä¸€èµ·ç»„åˆçš„æœ€å¼ºç”¨æ³•ï¼ˆå®é™…é¡¹ç›®æœ€å¸¸ç”¨ï¼‰ ä¾‹å­ï¼šè‚¡ç¥¨æ•°æ®æ¸…æ´— + æå–\nstocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;æµ¦å‘é“¶è¡Œ\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;000001\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;å¹³å®‰é“¶è¡Œ\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;sz300001\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;ST ç§‘æŠ€\u0026#34;}, ] result = list( map( lambda x: x[\u0026#34;code\u0026#34;], filter( lambda x: x[\u0026#34;code\u0026#34;].isdigit() and not x[\u0026#34;name\u0026#34;].startswith(\u0026#34;ST\u0026#34;), stocks ), ) ) print(result) è¾“å‡ºï¼š\n[\u0026#39;600001\u0026#39;, \u0026#39;000001\u0026#39;] â˜˜ï¸ æœ€ä½³å®è·µæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ å‡½æ•° ç”¨é€” æœ€ä½³å®è·µ next å–ç¬¬ä¸€é¡¹ next((x for x in lst if cond), None) map é€é¡¹è½¬æ¢ map(func, list) filter é€é¡¹ç­›é€‰ filter(predicate, list) ä¼˜åŒ–ç¤ºä¾‹ ç¤ºä¾‹ 01 åŸä»£ç \narticles_target: list[dict] = [] for item in articles_source: article = build_article(item, code) if article: articles_target.append(article) ä¼˜åŒ–å\narticles_target: list[dict] = [article for article in map(lambda i: build_article(i, code), articles_source) if article] åˆ†æ âœ… æœ€ä½³å®è·µç‰ˆæœ¬ï¼ˆæ¨èï¼šfilter + map + listï¼‰\narticles_target: list[dict] = list( map( lambda x: build_article(x, code), filter(lambda x: build_article(x, code) is not None, articles_source), ) ) â— ä½†è¿™å¹¶ä¸æ˜¯æœ€ä½³ï¼Œå› ä¸º build_article è¢«è°ƒç”¨äº†ä¸¤æ¬¡ï¼ˆæ€§èƒ½å·®ã€é€»è¾‘é‡å¤ï¼‰ã€‚\nâœ… æœ€ä½³å®è·µï¼ˆé¡¹ç›®çœŸå®å¯ç”¨ç‰ˆæœ¬ï¼‰â€”â€œå•æ¬¡æ„å»º + æ¡ä»¶è¿‡æ»¤â€\nä½¿ç”¨ ç”Ÿæˆå™¨è¡¨è¾¾å¼ + next/map/filter é£æ ¼ï¼ˆæ›´ Pythonicï¼‰ï¼š\narticles_target: list[dict] = [ article for article in (build_article(item, code) for item in articles_source) if article ] build_article è°ƒç”¨ä¸€æ¬¡ æƒ°æ€§ç”Ÿæˆ åˆ¤æ–­è¿‡æ»¤ å¯è¯»æ€§ä¼˜ç§€ æ€§èƒ½å¥½ â­ æ›´åœ°é“çš„å‡½æ•°å¼å†™æ³•ï¼ˆmap ç‰ˆæœ¬ï¼‰\narticles_target: list[dict] = [a for a in map(lambda i: build_article(i, code), articles_source) if a] è¿™æ˜¯ map + åˆ—è¡¨æ¨å¯¼çš„å®Œç¾ç»„åˆã€‚\nâ­ ä½¿ç”¨ filter çº¯å‡½æ•°é£æ ¼ï¼ˆå¯è¯»æ€§è¾ƒä½ï¼Œä¸æ¨èï¼‰\nfiltered = filter(None, map(lambda i: build_article(i, code), articles_source)) articles_target: list[dict] = list(filtered) ğŸš€ é¡¹ç›®ä¸­æœ€æ¨èç‰ˆæœ¬ï¼ˆç»“åˆæ€§èƒ½ä¸å¯è¯»æ€§ï¼‰ ğŸ“Œ è¿™æ˜¯æœ€å€¼å¾—é‡‡ç”¨çš„ç‰ˆæœ¬ï¼ˆä½ é¡¹ç›®é‡Œä¹Ÿéå¸¸é€‚åˆï¼‰ï¼š\narticles_target: list[dict] = [ article for article in map(lambda i: build_article(i, code), articles_source) if article ] ç†ç”±ï¼š\nbuild_article -\u0026gt; åªæ‰§è¡Œä¸€æ¬¡ åªç”¨ mapï¼Œä¸é‡å¤è°ƒç”¨ åªè¿‡æ»¤ None / False çœ‹èµ·æ¥åƒä¸€æ¡â€œæ•°æ®å¤„ç†ç®¡é“â€ é€Ÿåº¦å¿«ï¼Œç»“æ„æ¸…æ™° ğŸ”¥ Bonusï¼šå†™æˆå·¥å…·å‡½æ•°æ›´ä¼˜é›…ï¼ˆæ¨èåŠ å…¥ utilsï¼‰ def map_filter(func, iterable): return [x for x in map(func, iterable) if x] ä½¿ç”¨ï¼š\narticles_target = map_filter(lambda i: build_article(i, code), articles_source) ç»“æ„ç±»ä¼¼ï¼š\nNode.js çš„ Array.map().filter() Rust çš„ iter().map().filter().collect() Scala / Kotlin çš„æµå¼å¤„ç† éå¸¸ä¼˜é›…ã€‚\nğŸ¯ æ€»ç»“ å†™æ³• ä¼˜ç‚¹ ç¼ºç‚¹ åŸ for å¾ªç¯ ç®€å• å†—é•¿ map + filter å‡½æ•°å¼ é‡å¤è°ƒç”¨ funcï¼ˆä¸æ¨èï¼‰ åˆ—è¡¨æ¨å¯¼ + mapï¼ˆæ¨èï¼‰ æ€§èƒ½ã€å¯è¯»æ€§æœ€ä½³ æ— ç¼ºç‚¹ ç”Ÿæˆå™¨æ¨å¯¼ï¼ˆä¸“ä¸šï¼‰ æƒ°æ€§å¼ºï¼Œå†…å­˜å ç”¨å° æ–°æ‰‹ä¸å¤ªç†Ÿæ‚‰ æœ€ç»ˆæ¨èï¼š\narticles_target = [ article for article in map(lambda i: build_article(i, code), articles_source) if article ] ç¤ºä¾‹ 02 from collections.abc import Callable, Iterable def map_filter(iterable: Iterable, func: Callable) -\u0026gt; list: return [x for x in map(func, iterable) if x] def pick(x): return x if x[\u0026#34;a\u0026#34;] \u0026gt; 3 else None def restruct(x, z): if x[\u0026#34;a\u0026#34;] \u0026lt;= 3: return None x[\u0026#34;c\u0026#34;] = z return x source: list = [ {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: \u0026#34;hello\u0026#34;}, {\u0026#34;a\u0026#34;: 3, \u0026#34;b\u0026#34;: \u0026#34;go\u0026#34;}, {\u0026#34;a\u0026#34;: 5, \u0026#34;b\u0026#34;: \u0026#34;ok\u0026#34;}, ] # ------------------------------------------------------------------------------ # å¸¸è§„ target: list = [] for item in source: result = pick(item) if result: target.append(result) print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;}] # map target: list = [item for item in map(pick, source) if item] print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;}] # map_filter target: list = map_filter(source, pick) print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;}] # ------------------------------------------------------------------------------ code = 123 # å¸¸è§„ target: list = [] for item in source: result = restruct(item, code) if result: target.append(result) print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;, \u0026#39;c\u0026#39;: 123}] # map target: list = [x for x in map(lambda i: restruct(i, code), source) if x] print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;, \u0026#39;c\u0026#39;: 123}] # map_filter target: list = map_filter(source, lambda i: restruct(i, code)) print(target) # [{\u0026#39;a\u0026#39;: 5, \u0026#39;b\u0026#39;: \u0026#39;ok\u0026#39;, \u0026#39;c\u0026#39;: 123}] map_filter å·²é›†æˆåˆ° ezKit.utils\n# é€šè¿‡ ezKit å¯¼å…¥ map_filter from ezKit.utils import map_filter ç¤ºä¾‹ 01 çš„ç»ˆæç‰ˆ\narticles_target: list[dict] = map_filter(articles_source, lambda i: build_article(i, code)) ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£é¢å‘å®é™…é¡¹ç›®ï¼ˆå°¤å…¶æ˜¯çˆ¬è™« / æ•°æ®æ¸…æ´— / API æœåŠ¡ / é‡‘èç±»æ•°æ®å¤„ç†ï¼‰ çš„\nğŸ“Œã€Šnext / map / filter / lambda çš„é¡¹ç›®çº§æœ€ä½³å®è·µï¼ˆè¶…å¼ºå®Œæ•´ç‰ˆï¼‰ã€‹\næ¶µç›–ï¼šè®¾è®¡ç†å¿µã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ã€åæ¨¡å¼ã€ç»„åˆæ–¹å¼ã€çœŸå®ä¸šåŠ¡åœºæ™¯ã€‚\nâ˜˜ï¸ æ ¸å¿ƒç†å¿µï¼ˆé¡¹ç›®çº§è¦ç‚¹ï¼‰ åœ¨å®é™…é¡¹ç›®ä¸­ï¼š\nlambda ç”¨äºéå¸¸çŸ­å°ã€ä¸ä¼šå¤ç”¨çš„è¡¨è¾¾å¼ map/filter ç”¨äºçº¯å‡½æ•°å¼æ•°æ®æµ next ç”¨äºä»æµä¸­æ‰¾ç¬¬ä¸€é¡¹ ä¸è¦æ»¥ç”¨ï¼Œæ˜“è¯»æ€§ \u0026gt; ç®€æ´æ€§ æœ€ç»ˆç›®æ ‡ï¼šå†™å‡ºå¯è¯»ã€å¯ç»´æŠ¤ã€å¯å¤ç”¨ã€å¯æµ‹è¯•çš„ä»£ç  ğŸŒŸ PART 1ï¼šnext â€”â€” â€œæ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€é¡¹â€ï¼ˆé¡¹ç›®ä¸­éå¸¸å¸¸ç”¨ï¼‰ âœ… 1.1 æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼ˆé«˜é¢‘ç”¨æ³•ï¼‰ âŒ ä¸ä¼˜é›…\n"},{"id":130,"href":"/operations/","title":"Operations","parent":"Documents","content":"Directory List:\nLinux Hardware macOS Troubleshooting Others Alpine Ansible Debezium DNS Docker Git GitLab IPVS Java Jenkins Kafka Kubernetes KVM LVS Nacos NetworkManager Nginx Podman vsftpd Zabbix çŸ¥è¯†ç‚¹æ€»ç»“ ","description":"Directory List:\nLinux Hardware macOS Troubleshooting Others Alpine Ansible Debezium DNS Docker Git GitLab IPVS Java Jenkins Kafka Kubernetes KVM LVS Nacos NetworkManager Nginx Podman vsftpd Zabbix çŸ¥è¯†ç‚¹æ€»ç»“ "},{"id":131,"href":"/about/","title":"About","parent":"Documents","content":" ç®€ä»‹ æˆ‘çš„ä¸ªäººçŸ¥è¯†åº“\næ˜µç§°ï¼šç®€å°\nå¾®ä¿¡ï¼šseptvean\né‚®ç®±ï¼šseptvean@gmail.com\n","description":" ç®€ä»‹ æˆ‘çš„ä¸ªäººçŸ¥è¯†åº“\næ˜µç§°ï¼šç®€å°\nå¾®ä¿¡ï¼šseptvean\né‚®ç®±ï¼šseptvean@gmail.com\n"},{"id":132,"href":"/operations/others/","title":"Others","parent":"Operations","content":"Documents List:\nCSDNè§£é™¤ç™»é™†åå¤åˆ¶é™åˆ¶ ","description":"Documents List:\nCSDNè§£é™¤ç™»é™†åå¤åˆ¶é™åˆ¶ "},{"id":133,"href":"/database/postgres/repack/","title":"Repack","parent":"PostgreSQL","content":" repack # å®‰è£… repack æ‰©å±• apt install -y postgresql-18-repack # ç™»å½•æ•°æ®åº“ (ä½¿ç”¨ç®¡ç†è´¦å· postgres ç™»å½• finance æ•°æ®åº“) psql postgresql://postgres:password@127.0.0.1/finance # å®‰è£… pg_repack æ‰©å±• CREATE EXTENSION pg_repack; # è¿è¡Œ pg_repack su - postgres -c \u0026#39;pg_repack -d finance\u0026#39; ","description":" repack # å®‰è£… repack æ‰©å±• apt install -y postgresql-18-repack # ç™»å½•æ•°æ®åº“ (ä½¿ç”¨ç®¡ç†è´¦å· postgres ç™»å½• finance æ•°æ®åº“) psql postgresql://postgres:password@127.0.0.1/finance # å®‰è£… pg_repack æ‰©å±• CREATE EXTENSION pg_repack; # è¿è¡Œ pg_repack su - postgres -c \u0026#39;pg_repack -d finance\u0026#39; "},{"id":134,"href":"/frontend/react/react-learn/","title":"React Learn","parent":"React","content":" React Learn å®˜æ–¹æ–‡æ¡£ï¼š\nå¿«é€Ÿå…¥é—¨(è‹±æ–‡): https://react.dev/learn å¿«é€Ÿå…¥é—¨(ä¸­æ–‡): https://zh-hans.react.dev/learn ","description":" React Learn å®˜æ–¹æ–‡æ¡£ï¼š\nå¿«é€Ÿå…¥é—¨(è‹±æ–‡): https://react.dev/learn å¿«é€Ÿå…¥é—¨(ä¸­æ–‡): https://zh-hans.react.dev/learn "},{"id":135,"href":"/operations/dns/1.1.1.1-vs-8.8.8.8/","title":"1.1.1.1 vs 8.8.8.8","parent":"DNS","content":"DNS 1.1.1.1ï¼ˆCloudflareï¼‰å’Œ 8.8.8.8ï¼ˆGoogleï¼‰å‡ä¸ºé¡¶çº§å…¬å…±DNSï¼Œ1.1.1.1ä¸»æ‰“éšç§ä¿æŠ¤ä¸æè‡´è§£æé€Ÿåº¦ï¼Œ8.8.8.8ä¾§é‡é«˜å¯ç”¨æ€§ã€ç¨³å®šæ€§å’Œå¤§æ•°æ®è§£æèƒ½åŠ›ã€‚ä¸¤è€…å‡å®‰å…¨ä¸”æ”¯æŒç°ä»£åŠ å¯†æŠ€æœ¯ï¼Œä½†1.1.1.1åœ¨éšç§æ‰¿è¯ºï¼ˆ24å°æ—¶å†…åˆ é™¤æ•°æ®ï¼‰å’Œå“åº”é€Ÿåº¦ä¸Šç•¥èƒœä¸€ç­¹ã€‚\nä¸»è¦åŒºåˆ«æ€»ç»“ æ‰€æœ‰è€…ä¸éšç§ 1.1.1.1ï¼š ç”± Cloudflare ä¸ APNIC è”åˆç»´æŠ¤ï¼Œå¼ºè°ƒä¸è®°å½•ç”¨æˆ·IPåœ°å€ï¼Œæ•°æ®åœ¨ 24 å°æ—¶å†…åˆ é™¤ï¼Œéšç§ä¿æŠ¤èƒ½åŠ›æ›´å¼ºã€‚ 8.8.8.8ï¼š ç”± Google æä¾›ï¼ŒæŠ€æœ¯åŸºç¡€è®¾æ–½æå…¶å¼ºå¤§ï¼Œå¯ç”¨æ€§é«˜ï¼Œä½†éšç§å¤„ç†éµå¾ª Google éšç§æ”¿ç­–ã€‚ é€Ÿåº¦ä¸æ€§èƒ½ 1.1.1.1ï¼š è¢«å¤šå®¶æµ‹è¯„ï¼ˆå¦‚ DNSPerfï¼‰è¯„ä¼°ä¸ºå…¨çƒæœ€å¿«çš„å…¬å…± DNS ä¹‹ä¸€ï¼Œå“åº”é€Ÿåº¦å¿«ï¼Œå°¤å…¶é€‚åˆè¦æ±‚å¿«é€ŸåŠ è½½çš„åœºæ™¯ã€‚ 8.8.8.8ï¼š å“åº”é€Ÿåº¦ä¹Ÿéå¸¸å¿«ä¸”éå¸¸å¯é ã€‚ ä¸»è¦åŠŸèƒ½ä¸ç‰¹ç‚¹ 1.1.1.1ï¼š ç‰¹åˆ«æ³¨é‡â€œæœ€å°åŒ–è§£æâ€ï¼Œå‡å°‘ä¿¡æ¯æ³„æ¼ç»™ä¸­é—´æœåŠ¡å™¨ã€‚ 8.8.8.8ï¼š ä¾é å…¨çƒç½‘ç»œï¼Œå¯ä»¥è¾ƒå¥½åœ°è§£æåˆ°ä¸­å›½å¢ƒå†…çš„æœåŠ¡å™¨ã€‚ é€‚ç”¨åœºæ™¯ è¿½æ±‚éšç§å®‰å…¨ã€æè‡´æµè§ˆé€Ÿåº¦ï¼š1.1.1.1ã€‚ è¿½æ±‚é•¿ä¹…ç¨³å®šæ€§ã€å¯é æ€§ï¼š8.8.8.8ã€‚ äºŒè€…éƒ½æ”¯æŒ DNS-over-HTTPS (DoH) å’Œ DNS-over-TLS (DoT) åŠ å¯†æŠ€æœ¯ã€‚\næ³¨æ„ï¼šåœ¨ä¸­å›½å¢ƒå†…ä½¿ç”¨è¿™äº›å›½é™… DNS æœåŠ¡å™¨å¯èƒ½ä¼šå—åˆ°ç½‘ç»œç¯å¢ƒå¹²æ‰°ï¼ˆå¦‚æ±¡æŸ“ï¼‰ã€‚\n","description":"DNS 1.1.1.1ï¼ˆCloudflareï¼‰å’Œ 8.8.8.8ï¼ˆGoogleï¼‰å‡ä¸ºé¡¶çº§å…¬å…±DNSï¼Œ1.1.1.1ä¸»æ‰“éšç§ä¿æŠ¤ä¸æè‡´è§£æé€Ÿåº¦ï¼Œ8.8.8.8ä¾§é‡é«˜å¯ç”¨æ€§ã€ç¨³å®šæ€§å’Œå¤§æ•°æ®è§£æèƒ½åŠ›ã€‚ä¸¤è€…å‡å®‰å…¨ä¸”æ”¯æŒç°ä»£åŠ å¯†æŠ€æœ¯ï¼Œä½†1.1.1.1åœ¨éšç§æ‰¿è¯ºï¼ˆ24å°æ—¶å†…åˆ é™¤æ•°æ®ï¼‰å’Œå“åº”é€Ÿåº¦ä¸Šç•¥èƒœä¸€ç­¹ã€‚\nä¸»è¦åŒºåˆ«æ€»ç»“ æ‰€æœ‰è€…ä¸éšç§ 1.1.1.1ï¼š ç”± Cloudflare ä¸ APNIC è”åˆç»´æŠ¤ï¼Œå¼ºè°ƒä¸è®°å½•ç”¨æˆ·IPåœ°å€ï¼Œæ•°æ®åœ¨ 24 å°æ—¶å†…åˆ é™¤ï¼Œéšç§ä¿æŠ¤èƒ½åŠ›æ›´å¼ºã€‚ 8.8.8.8ï¼š ç”± Google æä¾›ï¼ŒæŠ€æœ¯åŸºç¡€è®¾æ–½æå…¶å¼ºå¤§ï¼Œå¯ç”¨æ€§é«˜ï¼Œä½†éšç§å¤„ç†éµå¾ª Google éšç§æ”¿ç­–ã€‚ é€Ÿåº¦ä¸æ€§èƒ½ 1.1.1.1ï¼š è¢«å¤šå®¶æµ‹è¯„ï¼ˆå¦‚ DNSPerfï¼‰è¯„ä¼°ä¸ºå…¨çƒæœ€å¿«çš„å…¬å…± DNS ä¹‹ä¸€ï¼Œå“åº”é€Ÿåº¦å¿«ï¼Œå°¤å…¶é€‚åˆè¦æ±‚å¿«é€ŸåŠ è½½çš„åœºæ™¯ã€‚ 8.8.8.8ï¼š å“åº”é€Ÿåº¦ä¹Ÿéå¸¸å¿«ä¸”éå¸¸å¯é ã€‚ ä¸»è¦åŠŸèƒ½ä¸ç‰¹ç‚¹ 1.1.1.1ï¼š ç‰¹åˆ«æ³¨é‡â€œæœ€å°åŒ–è§£æâ€ï¼Œå‡å°‘ä¿¡æ¯æ³„æ¼ç»™ä¸­é—´æœåŠ¡å™¨ã€‚ 8.8.8.8ï¼š ä¾é å…¨çƒç½‘ç»œï¼Œå¯ä»¥è¾ƒå¥½åœ°è§£æåˆ°ä¸­å›½å¢ƒå†…çš„æœåŠ¡å™¨ã€‚ é€‚ç”¨åœºæ™¯ è¿½æ±‚éšç§å®‰å…¨ã€æè‡´æµè§ˆé€Ÿåº¦ï¼š1.1.1.1ã€‚ è¿½æ±‚é•¿ä¹…ç¨³å®šæ€§ã€å¯é æ€§ï¼š8.8.8.8ã€‚ äºŒè€…éƒ½æ”¯æŒ DNS-over-HTTPS (DoH) å’Œ DNS-over-TLS (DoT) åŠ å¯†æŠ€æœ¯ã€‚\n"},{"id":136,"href":"/backend/python/aiohttp/","title":"Aiohttp","parent":"Python","content":"Directory List:\nAiohttp åŸºç¡€æ•™ç¨‹ ","description":"Directory List:\nAiohttp åŸºç¡€æ•™ç¨‹ "},{"id":137,"href":"/operations/alpine/","title":"Alpine","parent":"Operations","content":"æ–‡æ¡£åˆ—è¡¨:\nAlpine å¸¸ç”¨å‘½ä»¤ ","description":"æ–‡æ¡£åˆ—è¡¨:\nAlpine å¸¸ç”¨å‘½ä»¤ "},{"id":138,"href":"/operations/alpine/command/","title":"Alpine å¸¸ç”¨å‘½ä»¤","parent":"Alpine","content":"å¸¸ç”¨å‘½ä»¤:\ndocker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 telnet 10.120.100.144 50000 docker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 nc -v 10.120.100.144 5000 docker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 curl -I http://10.120.100.144 ","description":"å¸¸ç”¨å‘½ä»¤:\ndocker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 telnet 10.120.100.144 50000 docker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 nc -v 10.120.100.144 5000 docker run -it --detach=false --rm=true --name alpine custom/alpine:3.22.1-0 curl -I http://10.120.100.144 "},{"id":139,"href":"/operations/ansible/","title":"Ansible","parent":"Operations","content":"Document List:\nAnsible åŸºç¡€æ•™ç¨‹ Ansible æ ¸å¿ƒæ¦‚å¿µ Ansible Ad-Hoc Ansible Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰YAML æ ¼å¼ Ansible Modules å¸¸ç”¨æ¨¡å— Ansible Playbook vs Ad-Hoc ","description":"Document List:\nAnsible åŸºç¡€æ•™ç¨‹ Ansible æ ¸å¿ƒæ¦‚å¿µ Ansible Ad-Hoc Ansible Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰YAML æ ¼å¼ Ansible Modules å¸¸ç”¨æ¨¡å— Ansible Playbook vs Ad-Hoc "},{"id":140,"href":"/operations/ansible/ad-hoc/","title":"Ansible Ad-Hoc","parent":"Ansible","content":" ğŸ§© ä¸€ã€åŸºç¡€ï¼šAnsible Ad-Hoc å‘½ä»¤æ ¼å¼ ansible \u0026lt;hosts\u0026gt; -m \u0026lt;module\u0026gt; -a \u0026#34;\u0026lt;module arguments\u0026gt;\u0026#34; ç¤ºä¾‹ï¼š\nansible all -m ping ansible web -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; ğŸ§© äºŒã€å¸¸ç”¨æ¨¡å—å¤§å…¨ï¼ˆå‘½ä»¤è¡Œç‰ˆï¼‰ ä¸‹é¢æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ç»™å‡º æœ€å¸¸ç”¨çš„ ad-hoc ç¤ºä¾‹ï¼ˆå¯ç›´æ¥ç²˜è´´è¿è¡Œï¼‰ã€‚\n2.1 ç³»ç»Ÿæ¢æµ‹ / è°ƒè¯• ping æ£€æŸ¥è¿é€šæ€§\nansible all -m ping setup æ”¶é›† facts\nansible all -m setup ansible all -m setup -a \u0026#34;filter=ansible_mem*\u0026#34; 2.2 shell / commandï¼ˆåŠ¡å¿…åŒºåˆ†ï¼‰ commandï¼ˆé»˜è®¤ï¼Œä¸è§£æ shellï¼‰ ansible all -a \u0026#34;ls -l /etc\u0026#34; shellï¼ˆå…è®¸ç®¡é“ã€é‡å®šå‘ï¼‰ ansible all -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; ansible web -m shell -a \u0026#34;echo 1 \u0026gt; /proc/sys/net/ipv4/ip_forward\u0026#34; âš ï¸ æœ€ä½³å®è·µï¼šèƒ½ç”¨æ¨¡å—å°±ä¸ç”¨ shell / commandã€‚\n2.3 æ–‡ä»¶ä¸ç›®å½•æ“ä½œ file # åˆ›å»ºç›®å½• ansible all -m file -a \u0026#34;path=/data/logs state=directory mode=0755\u0026#34; # åˆ›å»ºè½¯é“¾æ¥ ansible all -m file -a \u0026#34;src=/usr/bin/python3 dest=/usr/bin/python state=link\u0026#34; copy ansible all -m copy -a \u0026#34;src=./nginx.conf dest=/etc/nginx/nginx.conf\u0026#34; fetch ä»è¿œç«¯æ‹‰å›æ–‡ä»¶\nansible all -m fetch -a \u0026#34;src=/var/log/messages dest=./logs/\u0026#34; lineinfile ansible all -m lineinfile -a \u0026#39;path=/etc/sysctl.conf regexp=\u0026#34;^net.ipv4.ip_forward\u0026#34; line=\u0026#34;net.ipv4.ip_forward=1\u0026#34;\u0026#39; blockinfile ansible all -m blockinfile -a \u0026#34;path=/etc/profile block=\u0026#39;export GOPROXY=https://proxy.golang.org\u0026#39;\u0026#34; unarchive ansible all -m unarchive -a \u0026#34;src=app.tar.gz dest=/opt/app remote_src=yes\u0026#34; 2.4 è½¯ä»¶åŒ…ç®¡ç†ï¼ˆè·¨å‘è¡Œç‰ˆï¼‰ packageï¼ˆæ¨èï¼‰ ansible all -m package -a \u0026#34;name=htop state=present\u0026#34; apt ansible debian -m apt -a \u0026#34;name=nginx update_cache=yes\u0026#34; yum / dnf ansible rhel -m yum -a \u0026#34;name=httpd state=present\u0026#34; pip ansible all -m pip -a \u0026#34;name=uvicorn\u0026#34; 2.5 æœåŠ¡ç®¡ç†ï¼ˆsystemdï¼‰ service ansible all -m service -a \u0026#34;name=nginx state=restarted enabled=yes\u0026#34; systemd ansible all -m systemd -a \u0026#34;name=docker daemon_reload=yes state=restarted\u0026#34; 2.6 ç”¨æˆ· / æƒé™ user ansible all -m user -a \u0026#34;name=martin shell=/bin/bash state=present\u0026#34; group ansible all -m group -a \u0026#34;name=devops state=present\u0026#34; authorized_key ansible all -m authorized_key -a \u0026#34;user=root key=\u0026#39;{{ lookup(\\\u0026#34;file\\\u0026#34;, \\\u0026#34;id_rsa.pub\\\u0026#34;) }}\u0026#39;\u0026#34; 2.7 ç½‘ç»œ / ç³»ç»Ÿå†…æ ¸ sysctl ansible all -m sysctl -a \u0026#34;name=net.ipv4.ip_forward value=1 state=present reload=yes\u0026#34; hostname ansible web -m hostname -a \u0026#34;name=web01\u0026#34; firewalld ansible all -m firewalld -a \u0026#34;port=80/tcp permanent=yes state=enabled\u0026#34; iptables ansible all -m iptables -a \u0026#34;chain=INPUT protocol=tcp destination_port=22 jump=ACCEPT\u0026#34; 2.8 å®šæ—¶ä»»åŠ¡ \u0026amp; ç³»ç»Ÿæ“ä½œ cron ansible all -m cron -a \u0026#34;name=backup minute=0 hour=2 job=\u0026#39;/usr/bin/backup.sh\u0026#39;\u0026#34; mount ansible all -m mount -a \u0026#34;path=/data src=/dev/vdb1 fstype=ext4 state=mounted\u0026#34; reboot ansible all -m reboot -a \u0026#34;reboot_timeout=600\u0026#34; 2.9 Git / ä¸‹è½½ git ansible all -m git -a \u0026#34;repo=https://github.com/martin/app.git dest=/opt/app version=main\u0026#34; get_url ansible all -m get_url -a \u0026#34;url=https://example.com/app.tar.gz dest=/tmp/app.tar.gz\u0026#34; uri ansible all -m uri -a \u0026#34;url=https://httpbin.org/get method=GET return_content=yes\u0026#34; 2.10 Docker æ¨¡å—ï¼ˆAd-Hoc è¶…å¥½ç”¨ï¼‰ docker_image ansible all -m docker_image -a \u0026#34;name=nginx source=pull\u0026#34; docker_container ansible all -m docker_container -a \u0026#34;name=nginx image=nginx:latest state=started ports=80:80\u0026#34; docker_network ansible all -m docker_network -a \u0026#34;name=mynet state=present\u0026#34; 2.11 Kubernetes ç®¡ç†ï¼ˆæ— éœ€ Playbookï¼‰ å‰æï¼šé…ç½® kubeconfig\nK8S åˆ›å»º / æ›´æ–°èµ„æº\nansible k8s -m k8s -a \u0026#34;state=present definition=@deployment.yaml\u0026#34; k8s_info ansible k8s -m k8s_info -a \u0026#34;kind=Pod namespace=default\u0026#34; 2.12 æ•°æ®åº“ç®¡ç† PostgreSQL\npostgresql_db ansible db -m postgresql_db -a \u0026#34;name=mydb state=present\u0026#34; postgresql_user ansible db -m postgresql_user -a \u0026#34;name=martin password=123 db=mydb\u0026#34; MySQL\nmysql_db ansible db -m mysql_db -a \u0026#34;name=appdb state=present\u0026#34; mysql_user ansible db -m mysql_user -a \u0026#34;name=app password=123 priv=appdb.*:ALL\u0026#34; ğŸ§° 2.13 æ–‡ä»¶åŒæ­¥ / å¤§æ–‡ä»¶å¤„ç† synchronizeï¼ˆä½¿ç”¨ rsyncï¼Œé€Ÿåº¦æœ€å¿«ï¼‰ ansible all -m synchronize -a \u0026#34;src=./dist/ dest=/var/www/\u0026#34; ğŸ§± 2.14 æ§åˆ¶æµï¼ˆçº¯å‘½ä»¤è¡ŒæŠ€å·§ï¼‰ ä½¿ç”¨ register ç­‰ä»·ç‰©ï¼š-o è¾“å‡º ansible all -a \u0026#34;hostname\u0026#34; -o ä½¿ç”¨ \u0026ndash;limit ansible all -m ping --limit web01 ä½¿ç”¨ \u0026ndash;extra-vars ansible all -m shell -a \u0026#34;echo {{ msg }}\u0026#34; --extra-vars \u0026#34;msg=hello\u0026#34; å®æˆ˜æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ 1. èƒ½ä¸ç”¨ shell å°±ä¸ç”¨ shell ä¸å®‰å…¨ã€éš¾ç»´æŠ¤ã€å¹‚ç­‰æ€§å·®ã€‚\n2. æ°¸è¿œä¼˜å…ˆä½¿ç”¨ä¸“ç”¨æ¨¡å— ä¾‹å¦‚å®‰è£…è½¯ä»¶ä½¿ç”¨ packageï¼Œä¸è¦ï¼š\nshell: yum install -y xxx 3. ä½¿ç”¨ \u0026ndash;checkï¼ˆDry Runï¼‰æ’æŸ¥å˜æ›´ ansible all -m copy -a \u0026#34;src=a dest=b\u0026#34; --check 4. ä½¿ç”¨ inventory åˆ†ç»„è§„èŒƒç®¡ç†ä¸»æœº ä¾‹å¦‚ï¼š\n[web] web01 web02 [db] db01 ç„¶åï¼š\nansible web -m ping ansible db -m service -a \u0026#34;name=mysql state=restarted\u0026#34; 5. é‡è¦ä»»åŠ¡åŠ  \u0026ndash;forks æé€Ÿ ansible all -m ping --forks 50 6. è¿œç¨‹æ‰¹é‡ä¿®æ”¹åŠ¡å¿…å…ˆ \u0026ndash;check + \u0026ndash;diff ansible all -m lineinfile -a \u0026#34;path=/etc/sysctl.conf ...\u0026#34; --check --diff 7. å¤§è§„æ¨¡å˜æ›´å»ºè®®å…ˆç”¨ \u0026ndash;limit åˆ†æ‰¹æ‰§è¡Œ ansible all --limit \u0026#39;web01\u0026#39; -m copy -a ... ansible all --limit \u0026#39;web02\u0026#39; -m copy -a ... Ansible Ad-Hoc å¸¸ç”¨å‘½ä»¤ ğŸš€ Ansible Ad-Hoc æœ€å¸¸ç”¨ 200 æ¡å‘½ä»¤ï¼ˆåˆ†ç±»ç‰ˆå¤§å…¨ï¼‰ ğŸ’¡ æ ¼å¼ï¼š\nansible \u0026lt;hosts\u0026gt; -m \u0026lt;module\u0026gt; -a \u0026#34;\u0026lt;args\u0026gt;\u0026#34; å¸¸ç”¨é™„åŠ å‚æ•°ï¼š\n-k å¯†ç è®¤è¯ã€-b sudoã€-K sudo å¯†ç ã€-u USERã€-i inventory.ini 1. ğŸ” Ping / æ£€æŸ¥ç±» ansible all -m ping ansible web -m ping ansible all -m ping -u root ansible all -m ping -k ansible db -m ping -b ansible all -m ping -f 10 # æ§åˆ¶å¹¶å‘ ansible all -m ping -e \u0026#34;ansible_port=2222\u0026#34; ansible all -m ping -e \u0026#34;ansible_ssh_private_key_file=~/.ssh/id_rsa\u0026#34; ansible all -m command -a \u0026#34;uptime\u0026#34; ansible all -m shell -a \u0026#34;hostname\u0026#34; 2. ğŸ“ æ–‡ä»¶/ç›®å½•ç®¡ç† file æ¨¡å— # åˆ›å»ºç›®å½• ansible all -m file -a \u0026#34;path=/srv/www state=directory mode=0755\u0026#34; # åˆ é™¤ç›®å½• ansible all -m file -a \u0026#34;path=/tmp/test state=absent\u0026#34; # åˆ›å»ºç©ºæ–‡ä»¶ ansible all -m file -a \u0026#34;path=/tmp/x state=touch\u0026#34; # ä¿®æ”¹ owner ansible all -m file -a \u0026#34;path=/var/www owner=nginx\u0026#34; # ä¿®æ”¹ group ansible all -m file -a \u0026#34;path=/var/www group=nginx\u0026#34; # ä¿®æ”¹ç›®å½•æƒé™ ansible all -m file -a \u0026#34;path=/data mode=0777\u0026#34; # åˆ›å»ºè½¯è¿æ¥ ansible all -m file -a \u0026#34;src=/etc/nginx/nginx.conf dest=/tmp/n.conf state=link\u0026#34; # åˆ›å»ºç¡¬é“¾æ¥ ansible all -m file -a \u0026#34;src=/bin/ls dest=/tmp/ls state=hard\u0026#34; # è®¾ç½®é€’å½’æƒé™ ansible all -m file -a \u0026#34;path=/data state=directory recurse=yes mode=0755\u0026#34; copy æ¨¡å— # å¤åˆ¶æ–‡ä»¶ ansible all -m copy -a \u0026#34;src=/etc/hosts dest=/tmp/hosts\u0026#34; # è¦†ç›–å¹¶æŒ‡å®šæƒé™ ansible all -m copy -a \u0026#34;src=a.conf dest=/etc/a.conf mode=0644\u0026#34; # å¤åˆ¶æ–‡æœ¬å†…å®¹ ansible all -m copy -a \u0026#34;content=\u0026#39;hello\u0026#39; dest=/tmp/a.txt\u0026#34; fetch æ¨¡å— # æ‹‰å–æ–‡ä»¶ ansible all -m fetch -a \u0026#34;src=/var/log/dmesg dest=./logs/ flat=yes\u0026#34; # æ‹‰å–å¹¶ä¿æŒç›®å½•ç»“æ„ ansible all -m fetch -a \u0026#34;src=/etc/passwd dest=./result\u0026#34; 3. ğŸ“¦ è½¯ä»¶åŒ…ï¼ˆLinux Packageï¼‰ç®¡ç† apt # å®‰è£… ansible web -m apt -a \u0026#34;name=nginx state=present\u0026#34; -b # å‡çº§ ansible all -m apt -a \u0026#34;upgrade=dist\u0026#34; -b # å®‰è£…å¤šä¸ªåŒ… ansible all -m apt -a \u0026#34;name=\u0026#39;git wget curl\u0026#39; state=present\u0026#34; -b # åˆ é™¤ ansible all -m apt -a \u0026#34;name=nginx state=absent\u0026#34; -b yum/dnf # å®‰è£… ansible all -m yum -a \u0026#34;name=httpd state=installed\u0026#34; -b # åˆ é™¤ ansible all -m yum -a \u0026#34;name=httpd state=removed\u0026#34; -b # å®‰è£…å¤šä¸ª ansible all -m yum -a \u0026#34;name=\u0026#39;git,tree\u0026#39; state=present\u0026#34; -b # åˆ—å‡ºæ›´æ–° ansible all -m yum -a \u0026#34;list=updates\u0026#34; 4. ğŸ§© æœåŠ¡ç®¡ç†ï¼ˆsystemdï¼‰ # å¯åŠ¨ ansible all -m service -a \u0026#34;name=nginx state=started\u0026#34; -b # åœæ­¢ ansible all -m service -a \u0026#34;name=nginx state=stopped\u0026#34; -b # é‡å¯ ansible all -m service -a \u0026#34;name=nginx state=restarted\u0026#34; -b # é‡æ–°åŠ è½½ ansible all -m service -a \u0026#34;name=nginx state=reloaded\u0026#34; -b # å¼€æœºå¯åŠ¨ ansible all -m systemd -a \u0026#34;name=nginx enabled=yes\u0026#34; -b # ç¦ç”¨å¼€æœº ansible all -m systemd -a \u0026#34;name=nginx enabled=no\u0026#34; -b # æ£€æŸ¥çŠ¶æ€ ansible all -m systemd -a \u0026#34;name=nginx state=started\u0026#34; -b 5. ğŸ§¹ å‘½ä»¤/è„šæœ¬æ‰§è¡Œï¼ˆcommand/shell/script command # æ‰§è¡Œ top ansible all -m command -a \u0026#34;uptime\u0026#34; # æ‰§è¡Œ ls ansible all -m command -a \u0026#34;ls -l /var/log\u0026#34; shell # æ‰§è¡Œå¤šæ¡å‘½ä»¤ ansible all -m shell -a \u0026#34;df -h \u0026amp;\u0026amp; free -m\u0026#34; # æ‰§è¡Œç®¡é“å‘½ä»¤ ansible all -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; script # æ‰§è¡Œæœ¬åœ°è„šæœ¬ ansible all -m script -a \u0026#34;./test.sh\u0026#34; # ä¼ å‚è„šæœ¬ ansible all -m script -a \u0026#34;./deploy.sh param1 param2\u0026#34; 6. ğŸ§© ç”¨æˆ·ä¸ç»„ç®¡ç† user æ¨¡å— # åˆ›å»ºç”¨æˆ· ansible all -m user -a \u0026#34;name=tom state=present\u0026#34; # åˆ é™¤ç”¨æˆ· ansible all -m user -a \u0026#34;name=tom state=absent\u0026#34; # æ·»åŠ  sudo æƒé™ ansible all -m user -a \u0026#34;name=tom groups=sudo append=yes\u0026#34; # è®¾ç½®å¯†ç  ansible all -m user -a \u0026#34;name=tom password={{ \u0026#39;123456\u0026#39; | password_hash(\u0026#39;sha512\u0026#39;) }}\u0026#34; # é”å®šç”¨æˆ· ansible all -m user -a \u0026#34;name=tom state=present password_lock=yes\u0026#34; group æ¨¡å— # åˆ›å»ºç»„ ansible all -m group -a \u0026#34;name=dev\u0026#34; # åˆ é™¤ç»„ ansible all -m group -a \u0026#34;name=dev state=absent\u0026#34; 7. ğŸ” SSH / å¯†é’¥ / å…¬é’¥ç®¡ç† # éƒ¨ç½²å…¬é’¥ ansible all -m authorized_key -a \u0026#34;user=root key=\u0026#39;{{ lookup(\u0026#39;file\u0026#39;,\u0026#39;id_rsa.pub\u0026#39;) }}\u0026#39;\u0026#34; # åˆ é™¤å…¬é’¥ ansible all -m authorized_key -a \u0026#34;user=root key=\u0026#39;ssh-rsa AAA...\u0026#39; state=absent\u0026#34; 8. ğŸŒ ç½‘ç»œ / IP / é˜²ç«å¢™ # æŸ¥çœ‹ IP ansible all -m command -a \u0026#34;ip addr\u0026#34; # è®¾ç½®å†…æ ¸å‚æ•° ansible all -m sysctl -a \u0026#34;name=net.ipv4.ip_forward value=1 reload=yes\u0026#34; -b # firewalld å¼€ç«¯å£ ansible all -m firewalld -a \u0026#34;port=80/tcp permanent=yes state=enabled\u0026#34; -b # å…³é—­ç«¯å£ ansible all -m firewalld -a \u0026#34;port=80/tcp state=disabled\u0026#34; -b 9. ğŸ“€ ç£ç›˜ / æ–‡ä»¶ç³»ç»Ÿ # æŸ¥çœ‹ç£ç›˜ ansible all -m shell -a \u0026#34;df -h\u0026#34; # æŒ‚è½½ ansible all -m mount -a \u0026#34;path=/data src=/dev/sdb1 fstype=ext4 state=mounted\u0026#34; -b # å¸è½½ ansible all -m mount -a \u0026#34;path=/data state=unmounted\u0026#34; -b 10. ğŸ³ Docker ç®¡ç† # docker ps ansible all -m shell -a \u0026#34;docker ps\u0026#34; # å¯åŠ¨å®¹å™¨ ansible all -m docker_container -a \u0026#34;name=redis image=redis state=started\u0026#34; # åœæ­¢å®¹å™¨ ansible all -m docker_container -a \u0026#34;name=redis state=stopped\u0026#34; # åˆ é™¤å®¹å™¨ ansible all -m docker_container -a \u0026#34;name=redis state=absent\u0026#34; # æ‹‰å–é•œåƒ ansible all -m docker_image -a \u0026#34;name=nginx source=pull\u0026#34; 11. ğŸŒ Git / SVN / ä¸‹è½½æ–‡ä»¶ # å…‹éš† Git ansible all -m git -a \u0026#34;repo=https://github.com/a/b.git dest=/opt/b\u0026#34; # æ‰§è¡Œ wget ansible all -m get_url -a \u0026#34;url=https://x.com/a.tar.gz dest=/tmp\u0026#34; 12. ğŸ›  ç³»ç»Ÿä¿¡æ¯æ”¶é›†ï¼ˆsetup æ¨¡å—ï¼‰ ansible all -m setup # åªè·å–ç½‘ç»œä¿¡æ¯ ansible all -m setup -a \u0026#34;filter=ansible_eth*\u0026#34; # è·å– CPU ä¿¡æ¯ ansible all -m setup -a \u0026#34;filter=ansible_processor*\u0026#34; # è·å– IP ansible all -m setup -a \u0026#34;filter=ansible_default_ipv4\u0026#34; 13. ğŸ“¡ è°ƒè¯• / è¾“å‡ºï¼ˆdebugï¼‰ ansible all -m debug -a \u0026#34;msg=\u0026#39;hello world\u0026#39;\u0026#34; 14. ğŸ“¤ ä¸Šä¼ /ä¸‹è½½ï¼ˆsynchronize / rsyncï¼‰ # pull ansible all -m synchronize -a \u0026#34;src=/opt/file dest=/tmp/ mode=pull\u0026#34; # push ansible all -m synchronize -a \u0026#34;src=/opt/file dest=/tmp/ mode=push\u0026#34; 15. ğŸ§° é«˜çº§æ¨¡å—ï¼ˆtemplateã€lineinfile ç­‰ï¼‰ lineinfile # æ·»åŠ é…ç½®è¡Œ ansible all -m lineinfile -a \u0026#34;path=/etc/sysctl.conf line=\u0026#39;net.ipv4.ip_forward=1\u0026#39;\u0026#34; -b # ä¿®æ”¹é…ç½®è¡Œ ansible all -m lineinfile -a \u0026#34;path=/etc/ssh/sshd_config regexp=\u0026#39;^#?PermitRootLogin\u0026#39; line=\u0026#39;PermitRootLogin yes\u0026#39;\u0026#34; -b replace # æ­£åˆ™æ›¿æ¢ ansible all -m replace -a \u0026#34;path=/etc/nginx/nginx.conf regexp=\u0026#39;worker_processes .*\u0026#39; replace=\u0026#39;worker_processes 4;\u0026#39; \u0026#34; -b template # æ¸²æŸ“æ¨¡æ¿ ansible all -m template -a \u0026#34;src=nginx.conf.j2 dest=/etc/nginx/nginx.conf\u0026#34; 16. ğŸ“š å…¶å®ƒå¸¸ç”¨æ¨¡å— # hostname ç®¡ç† ansible all -m hostname -a \u0026#34;name=node-01\u0026#34; # cron ä»»åŠ¡ ansible all -m cron -a \u0026#34;name=\u0026#39;backup\u0026#39; minute=0 hour=1 job=\u0026#39;/usr/bin/backup\u0026#39;\u0026#34; # ç®¡ç† SELinux ansible all -m selinux -a \u0026#34;state=disabled\u0026#34; -b # ç®¡ç† timezone ansible all -m timezone -a \u0026#34;name=Asia/Shanghai\u0026#34; ","description":" ğŸ§© ä¸€ã€åŸºç¡€ï¼šAnsible Ad-Hoc å‘½ä»¤æ ¼å¼ ansible \u0026lt;hosts\u0026gt; -m \u0026lt;module\u0026gt; -a \u0026#34;\u0026lt;module arguments\u0026gt;\u0026#34; ç¤ºä¾‹ï¼š\nansible all -m ping ansible web -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; ğŸ§© äºŒã€å¸¸ç”¨æ¨¡å—å¤§å…¨ï¼ˆå‘½ä»¤è¡Œç‰ˆï¼‰ ä¸‹é¢æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œæ¯ä¸ªæ¨¡å—éƒ½ç»™å‡º æœ€å¸¸ç”¨çš„ ad-hoc ç¤ºä¾‹ï¼ˆå¯ç›´æ¥ç²˜è´´è¿è¡Œï¼‰ã€‚\n2.1 ç³»ç»Ÿæ¢æµ‹ / è°ƒè¯• ping æ£€æŸ¥è¿é€šæ€§\n"},{"id":141,"href":"/operations/ansible/inventory-yaml/","title":"Ansible Inventoryï¼ˆä¸»æœºæ¸…å•ï¼‰YAML æ ¼å¼","parent":"Ansible","content":"å‚è€ƒæ–‡æ¡£:\nå¦‚ä½•ç¼–å†™yamlæ ¼å¼çš„Ansibleä¸»æœºæ¸…å•(inventory)åŠæ¸…å•å˜é‡ä½¿ç”¨Demo ğŸ”¥ ç›®å½• ä»€ä¹ˆæ˜¯ Ansible Inventory YAML æ ¼å¼ Inventory åŸºç¡€å†™æ³• åˆ†ç»„ã€å­ç»„ã€åµŒå¥—ç»“æ„ ä¸»æœºå˜é‡ / ç»„å˜é‡ å†™æ³• ç»„å˜é‡ä¼˜å…ˆçº§ host_vars / group_vars åŠ¨æ€ Inventoryï¼ˆç®€è¦ï¼‰ ç”Ÿäº§çº§ YAML Inventory æ¨¡æ¿ï¼ˆå«å¤šç¯å¢ƒã€å¤šæœºæˆ¿ã€å¤šè§’è‰²ï¼‰ æœ€ä½³å®è·µåæ¡ å¸¸è§å‘ï¼ˆä»¥åŠæ€ä¹ˆé¿å…ï¼‰ 1. ğŸ“Œ ä»€ä¹ˆæ˜¯ Inventoryï¼Ÿ Inventory æ˜¯ Ansible è¿æ¥ç›®æ ‡ä¸»æœºçš„â€œæ¸…å•â€ï¼ŒåŒ…å«ï¼š\nä¸»æœº IP / Hostname ç»„ï¼ˆgroupï¼‰ä¸å­ç»„ï¼ˆchildrenï¼‰ å˜é‡ï¼ˆhost_vars / group_varsï¼‰ SSH å‚æ•°ã€ç«¯å£ã€è®¤è¯æ–¹å¼ è‡ªå®šä¹‰å˜é‡ï¼ˆä¸šåŠ¡å˜é‡ï¼‰ YAML æ ¼å¼ï¼ˆinventory.ymlï¼‰æ¯” INI æ ¼å¼æ›´ç›´è§‚ã€å±‚çº§æ¸…æ™°ï¼Œæ˜¯ç”Ÿäº§æ¨èæ ¼å¼ã€‚\n2. ğŸ“˜ YAML Inventory æœ€åŸºç¡€æ ¼å¼ all: hosts: web1: ansible_host: 10.1.1.11 web2: ansible_host: 10.1.1.12 æœ€å°ç»“æ„ï¼š\nall: hosts: 3. ğŸ“¦ åˆ†ç»„ / å­ç»„ / åµŒå¥—ç»“æ„ 3.1 å®šä¹‰ç»„ï¼ˆgroupï¼‰ all: children: web: hosts: web1: ansible_host: 10.1.1.11 web2: ansible_host: 10.1.1.12 3.2 å¤šå±‚åµŒå¥—ï¼ˆchildrenï¼‰ all: children: prod: children: web: hosts: web1: ansible_host: 10.1.1.11 db: hosts: db1: ansible_host: 10.1.1.21 åœ¨ playbook æˆ– ad-hoc ä¸­å¯ä»¥ç”¨ï¼š\nansible web -m ping ansible db -m ping ansible prod -m ping 4. ğŸ“Œ ä¸»æœºå˜é‡ï¼ˆhost varsï¼‰ä¸ç»„å˜é‡ï¼ˆgroup varsï¼‰ 4.1 ä¸»æœºå˜é‡ all: hosts: node1: ansible_host: 192.168.1.10 ansible_port: 2222 ansible_user: deploy 4.2 ç»„å˜é‡ all: children: web: vars: nginx_port: 80 ansible_user: www hosts: web1: ansible_host: 10.1.1.11 web2: ansible_host: 10.1.1.12 5. ğŸ§Š ç»„å˜é‡ä¼˜å…ˆçº§ï¼ˆå¾ˆé‡è¦ï¼‰ Ansible å˜é‡ä¼˜å…ˆçº§ï¼ˆé«˜ -\u0026gt; ä½ï¼‰ï¼š\nExtra varsï¼ˆ-eï¼‰ Host varsï¼ˆinventory ä¸»æœºå˜é‡ï¼‰ Host varsï¼ˆhost_vars/ ç›®å½•ï¼‰ Group varsï¼ˆgroup_vars/ ç›®å½•ï¼‰ Group varsï¼ˆinventoryï¼‰ Role defaults ğŸ‘‰ è¶Šâ€œå…·ä½“â€ä¼˜å…ˆçº§è¶Šé«˜ ğŸ‘‰ ad-hoc çš„ -e æ°¸è¿œæœ€é«˜ 6. ğŸ“ host_vars / group_vars ç›®å½•ç»“æ„ï¼ˆå¼ºçƒˆæ¨èï¼‰ ä¸»æœºï¼š\nhost_vars/web1.yml host_vars/db1.yml ç»„ï¼š\ngroup_vars/all.yml group_vars/web.yml group_vars/db.yml ç¤ºä¾‹ group_vars/web.yml nginx_port: 80 ansible_user: nginx host_vars/web1.yml nginx_port: 8080 host_vars ä¼šè¦†ç›– group_varsã€‚\n7. âš™ï¸ åŠ¨æ€ Inventoryï¼ˆç®€ç•¥è¯´æ˜ï¼‰ å¦‚æœä½ çš„ä¸»æœºæ˜¯åŠ¨æ€ç”Ÿæˆï¼ˆKubernetesã€OpenStackã€AWSã€è‡ªåŠ¨æ‰©ç¼©ï¼‰ï¼Œä½¿ç”¨ï¼š\ninventory.aws_ec2.yml inventory.k8s.yml inventory.gcp.yml ä¾‹å¦‚ EC2ï¼š\nplugin: amazon.aws.ec2 regions: - ap-east-1 hostnames: - tag:Name æ‰§è¡Œï¼š\nansible-inventory -i inventory.aws.yml --graph 8. ğŸ¯ ç”Ÿäº§çº§ YAML Inventory æ¨¡æ¿ ä¸‹é¢ç»™ä½  ä¼ä¸šçº§æ¨èç»“æ„æ¨¡æ¿ï¼ˆæ”¯æŒå¤šç¯å¢ƒ + å¤šæœºæˆ¿ + å¤šè§’è‰²ï¼‰ã€‚\n8.1 ç›®å½•ç»“æ„ï¼ˆç”Ÿäº§æ¨èï¼‰ inventory/ â”œâ”€â”€ prod/ â”‚ â”œâ”€â”€ inventory.yml â”‚ â”œâ”€â”€ group_vars/ â”‚ â”‚ â”œâ”€â”€ all.yml â”‚ â”‚ â”œâ”€â”€ web.yml â”‚ â”‚ â””â”€â”€ db.yml â”‚ â””â”€â”€ host_vars/ â”‚ â”œâ”€â”€ web1.yml â”‚ â””â”€â”€ db1.yml â”œâ”€â”€ staging/ â””â”€â”€ dev/ 8.2 inventory/prod/inventory.ymlï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰ all: vars: ansible_user: deploy ansible_ssh_private_key_file: ~/.ssh/id_rsa timezone: Asia/Shanghai children: # ------------------ å¤šæœºæˆ¿ç»“æ„ ------------------ idc_a: children: web: hosts: web1: ansible_host: 10.10.1.11 web2: ansible_host: 10.10.1.12 db: hosts: db1: ansible_host: 10.10.1.21 idc_b: children: web: hosts: web3: ansible_host: 10.20.1.11 cache: hosts: redis1: ansible_host: 10.20.1.31 # ------------------ æŒ‰è§’è‰²åˆ†ç»„ ------------------ web: vars: service_port: 8080 nginx_worker: 4 db: vars: mysql_port: 3306 cache: vars: redis_port: 6379 8.3 group_vars/all.yml timezone: Asia/Shanghai ulimit_nofile: 65535 8.4 group_vars/web.yml nginx_port: 80 nginx_user: www 8.5 host_vars/web1.yml nginx_port: 8081 9. ğŸ† Inventory æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ âœ… 1. æŠŠå¯†ç å…¨éƒ¨ç§»é™¤ï¼Œä½¿ç”¨å¯†é’¥ ansible_user + ansible_ssh_private_key_file\nâœ… 2. ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ‹†å¤šç¯å¢ƒï¼ˆprod/staging/devï¼‰ âœ… 3. æ˜ç¡®åˆ†å±‚ ç¯å¢ƒå±‚ï¼šprod/staging/dev åœ°åŸŸå±‚ï¼šidc_a / idc_b è§’è‰²å±‚ï¼šweb/db/cache âœ… 4. é€šç”¨å˜é‡æ”¾ group_vars/all.yml ä¾‹å¦‚ï¼š\ntimezone mirrors ntp servers âœ… 5. è§’è‰²å˜é‡æ”¾ group_vars/{group}.yml å¦‚ï¼šgroup_vars/web.yml æ”¾ nginx å˜é‡\nâœ… 6. ä¸ªæ€§åŒ–å˜é‡æ”¾ host_vars/{host}.yml å¦‚ web1 ç«¯å£ä¸åŒ\nâœ… 7. inventory.yml ä¸è¦æ”¾å¤§é‡å˜é‡ åªæ”¾ä¸»æœºç»“æ„ã€ä¸»æœº IP\nâœ… 8. å¤šè§’è‰² host ä½¿ç”¨ childrenï¼Œè€Œä¸æ˜¯é‡å¤å†™ ä¾‹å¦‚ï¼š\ncommon: children: web: db: âœ… 9. å¤§é‡æœåŠ¡å™¨æ¨èç”¨ åŠ¨æ€ Inventory AWS/é˜¿é‡Œäº‘/K8S å·¥å…·è‡ªåŠ¨åŒæ­¥\nâœ… 10. ç”¨ ansible-inventory æ£€æŸ¥ ansible-inventory -i inventory/prod --graph 10. â—å¸¸è§å‘ï¼ˆé‡ç‚¹ï¼‰ âŒ 1. ansible_host ä¸ä¸»æœºåæ··ç”¨ é”™è¯¯ï¼š\nweb1: 10.1.1.11 æ­£ç¡®ï¼š\nweb1: ansible_host: 10.1.1.11 âŒ 2. å˜é‡å†™é”™ä½ç½® å˜é‡ä¸èƒ½å†™åœ¨ hosts ä¸‹ï¼š\nâŒ é”™è¯¯ï¼š\nhosts: vars: âŒ 3. children ä¸ hosts ä¸èƒ½æ··çº§å†™ âŒï¼š\nchildren: web: web1: å¿…é¡»ï¼š\nchildren: web: hosts: web1: âŒ 4. host_vars è¦†ç›– group_vars ä¸ç”Ÿæ•ˆ æ³¨æ„åç§°å¿…é¡»å’Œ inventory ä¸»æœºåä¸€è‡´ã€‚\n","description":"å‚è€ƒæ–‡æ¡£:\nå¦‚ä½•ç¼–å†™yamlæ ¼å¼çš„Ansibleä¸»æœºæ¸…å•(inventory)åŠæ¸…å•å˜é‡ä½¿ç”¨Demo ğŸ”¥ ç›®å½• ä»€ä¹ˆæ˜¯ Ansible Inventory YAML æ ¼å¼ Inventory åŸºç¡€å†™æ³• åˆ†ç»„ã€å­ç»„ã€åµŒå¥—ç»“æ„ ä¸»æœºå˜é‡ / ç»„å˜é‡ å†™æ³• ç»„å˜é‡ä¼˜å…ˆçº§ host_vars / group_vars åŠ¨æ€ Inventoryï¼ˆç®€è¦ï¼‰ ç”Ÿäº§çº§ YAML Inventory æ¨¡æ¿ï¼ˆå«å¤šç¯å¢ƒã€å¤šæœºæˆ¿ã€å¤šè§’è‰²ï¼‰ æœ€ä½³å®è·µåæ¡ å¸¸è§å‘ï¼ˆä»¥åŠæ€ä¹ˆé¿å…ï¼‰ 1. ğŸ“Œ ä»€ä¹ˆæ˜¯ Inventoryï¼Ÿ Inventory æ˜¯ Ansible è¿æ¥ç›®æ ‡ä¸»æœºçš„â€œæ¸…å•â€ï¼ŒåŒ…å«ï¼š\n"},{"id":142,"href":"/operations/ansible/modules/","title":"Ansible Modules å¸¸ç”¨æ¨¡å—","parent":"Ansible","content":" 1. åŸºç¡€å‘½ä»¤æ‰§è¡Œç±»ï¼ˆä¸æ¨èå¤§é‡ä½¿ç”¨ï¼‰ command æ‰§è¡Œå‘½ä»¤ï¼ˆä¸ç» shell è§£æï¼‰\n- name: List directory command: ls -l /etc shell æ‰§è¡Œ shell å‘½ä»¤ï¼ˆå…è®¸é‡å®šå‘ã€ç®¡é“ï¼‰\n- name: Use pipe shell: \u0026#34;ps aux | grep nginx\u0026#34; âš ï¸ æœ€ä½³å®è·µï¼šèƒ½ç”¨ä¸“ç”¨æ¨¡å—å°±ä¸è¦ç”¨ shell/command\n2. æ–‡ä»¶ä¸ç›®å½•æ“ä½œæ¨¡å— file åˆ›å»ºç›®å½•ã€æ–‡ä»¶ã€è½¯é“¾æ¥ã€ä¿®æ”¹æƒé™\n- name: Create directory file: path: /data/www state: directory mode: \u0026#34;0755\u0026#34; copy å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹èŠ‚ç‚¹\n- name: Copy config copy: src: nginx.conf dest: /etc/nginx/nginx.conf template åŸºäº Jinja2 æ¨¡æ¿æ¸²æŸ“æ–‡ä»¶\n- name: Render template template: src: nginx.conf.j2 dest: /etc/nginx/nginx.conf lineinfile æ›¿æ¢åŒ¹é…è¡Œï¼ˆéå¸¸å¸¸ç”¨ï¼‰\n- name: Update config line lineinfile: path: /etc/sysctl.conf regexp: \u0026#34;^net.ipv4.ip_forward\u0026#34; line: \u0026#34;net.ipv4.ip_forward = 1\u0026#34; blockinfile æ’å…¥å¤šè¡Œæ–‡æœ¬\n- blockinfile: path: /etc/profile block: | export GOPROXY=https://proxy.golang.org synchronize ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶ï¼ˆé€Ÿåº¦å¿«ï¼‰\n- synchronize: src: ./dist/ dest: /var/www/ unarchive è§£å‹æ–‡ä»¶\n- unarchive: src: app.tar.gz dest: /opt/app/ remote_src: yes 3. ç³»ç»Ÿç”¨æˆ· / æƒé™æ¨¡å— user ç®¡ç†ç”¨æˆ·\n- user: name: martin shell: /bin/bash state: present group ç®¡ç†ç”¨æˆ·ç»„\n- group: name: developers state: present authorized_key ç®¡ç† SSH key\n- authorized_key: user: root key: \u0026#34;{{ lookup(\u0026#39;file\u0026#39;, \u0026#39;id_rsa.pub\u0026#39;) }}\u0026#34; 4. æœåŠ¡ç®¡ç†æ¨¡å— service æ§åˆ¶æœåŠ¡ï¼ˆsystemdï¼‰\n- service: name: nginx state: restarted enabled: yes systemd æ›´å¤æ‚çš„ systemd æ“ä½œ\n- systemd: name: docker daemon_reload: yes state: restarted 5. è½¯ä»¶åŒ…ç®¡ç†æ¨¡å— packageï¼ˆè‡ªåŠ¨é€‰æ‹© apt/yum/dnfï¼‰ - package: name: htop state: present yum - yum: name: httpd state: present apt - apt: name: nginx update_cache: yes pip - pip: name: uvicorn state: present 6. ç½‘ç»œä¸é˜²ç«å¢™æ¨¡å— firewalld - firewalld: port: 80/tcp permanent: yes state: enabled iptables - iptables: chain: INPUT protocol: tcp destination_port: 22 jump: ACCEPT hostname - hostname: name: web01 7. æ•°æ®åº“æ¨¡å— mysql_db - mysql_db: name: appdb state: present mysql_user - mysql_user: name: appuser password: secret priv: \u0026#34;appdb.*:ALL\u0026#34; state: present postgresql_db - postgresql_db: name: mydb state: present postgresql_user - postgresql_user: db: mydb name: martin password: \u0026#34;pwd123\u0026#34; priv: ALL 8. Docker / å®¹å™¨æ¨¡å—ï¼ˆå¼ºçƒˆæ¨èï¼‰ docker_container - docker_container: name: nginx image: nginx:latest state: started ports: - \u0026#34;80:80\u0026#34; docker_image - docker_image: name: python:3.12 source: pull docker_network - docker_network: name: mynet state: present 9. Kubernetesï¼ˆK8Sï¼‰èµ„æºæ¨¡å— Ansible å¯ç›´æ¥ç®¡ç† CRDã€Deploymentã€Service ç­‰ã€‚\nK8S - k8s: state: present definition: apiVersion: apps/v1 kind: Deployment metadata: name: nginx spec: replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.25 k8s_info è·å–èµ„æºä¿¡æ¯\n- k8s_info: kind: Pod namespace: default 10. ç³»ç»Ÿé…ç½®ä¸ä¿¡æ¯æ¨¡å— setup æ”¶é›†ç³»ç»Ÿ facts\n- setup: sysctl ä¿®æ”¹å†…æ ¸å‚æ•°ï¼ˆK8S è°ƒä¼˜å¸¸ç”¨ï¼‰\n- sysctl: name: net.ipv4.ip_forward value: 1 state: present reload: yes timezone - timezone: name: Asia/Shanghai 11. Git / ä¸‹è½½ / è¯·æ±‚æ¨¡å— git - git: repo: \u0026#34;https://github.com/martin/app.git\u0026#34; dest: /opt/app version: main get_url - get_url: url: https://example.com/app.tar.gz dest: /tmp/app.tar.gz mode: \u0026#34;0644\u0026#34; uri å‘é€ HTTP è¯·æ±‚\n- uri: url: https://httpbin.org/get method: GET return_content: yes 12. å‹ç¼© / æ–‡æœ¬ / JSON æ¨¡å— assemble å°†å¤šä¸ªæ–‡ä»¶æ‹¼æ¥ä¸ºä¸€ä¸ª\n- assemble: src: /etc/nginx/conf.d.d/ dest: /etc/nginx/nginx.conf json_query è¿‡æ»¤ JSON\n- debug: msg: \u0026#34;{{ result | json_query(\u0026#39;items[*].metadata.name\u0026#39;) }}\u0026#34; 13. æ§åˆ¶æµç›¸å…³ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ include_tasks æŒ‰æ¡ä»¶åŠ è½½ä»»åŠ¡\n- include_tasks: install.yml when: ansible_os_family == \u0026#34;RedHat\u0026#34; import_tasks ç¼–è¯‘æ—¶åŠ è½½\n- import_tasks: common.yml untilï¼ˆé‡è¯•ï¼‰ - shell: curl http://127.0.0.1/healthz register: result retries: 5 delay: 3 until: result.rc == 0 ğŸ§± 14. Role ç›¸å…³æ¨¡å— include_role - include_role: name: nginx import_role - import_role: name: mysql ğŸ›  15. é€»è¾‘æ§åˆ¶ï¼ˆwhen / register / with_itemsï¼‰ register - command: cat /etc/hostname register: out - debug: msg: \u0026#34;{{ out.stdout }}\u0026#34; when æ¡ä»¶ - yum: name: httpd when: ansible_os_family == \u0026#34;RedHat\u0026#34; with_items - user: name: \u0026#34;{{ item }}\u0026#34; state: present with_items: - alice - bob ğŸ“Œ 16. ä¸“ç”¨äº DevOps çš„å¸¸ç”¨æ¨¡å— cron - cron: name: backup minute: \u0026#34;0\u0026#34; hour: \u0026#34;2\u0026#34; job: \u0026#34;/usr/bin/backup.sh\u0026#34; mount æŒ‚è½½ç£ç›˜\n- mount: path: /data src: /dev/vdb1 fstype: ext4 state: mounted reboot - reboot: msg: \u0026#34;Rebooting for kernel upgrade\u0026#34; reboot_timeout: 600 ğŸ“š 17. ç±»æ¯”å¯¹ç…§é€ŸæŸ¥ï¼ˆæœ€å¸¸ç”¨ï¼‰ éœ€æ±‚ æ¨èæ¨¡å— åˆ›å»ºç›®å½• file ä¸Šä¼ é…ç½®æ–‡ä»¶ template / copy ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸€è¡Œ lineinfile æ’å…¥å¤šè¡Œ blockinfile é‡å¯æœåŠ¡ service å®‰è£…è½¯ä»¶ package / apt / yum ç®¡ç†ç”¨æˆ· user ç®¡ç† Docker docker_* ç³»åˆ— ç®¡ç† K8S K8S ä¸‹è½½ URL æ–‡ä»¶ get_url ä½¿ç”¨ rsync åŒæ­¥ synchronize ç®¡ç†ç³»ç»Ÿå‚æ•° sysctl ç®¡ç†å®šæ—¶ä»»åŠ¡ cron ","description":" 1. åŸºç¡€å‘½ä»¤æ‰§è¡Œç±»ï¼ˆä¸æ¨èå¤§é‡ä½¿ç”¨ï¼‰ command æ‰§è¡Œå‘½ä»¤ï¼ˆä¸ç» shell è§£æï¼‰\n- name: List directory command: ls -l /etc shell æ‰§è¡Œ shell å‘½ä»¤ï¼ˆå…è®¸é‡å®šå‘ã€ç®¡é“ï¼‰\n- name: Use pipe shell: \u0026#34;ps aux | grep nginx\u0026#34; âš ï¸ æœ€ä½³å®è·µï¼šèƒ½ç”¨ä¸“ç”¨æ¨¡å—å°±ä¸è¦ç”¨ shell/command\n"},{"id":143,"href":"/operations/ansible/playbook-vs-ad-hoc/","title":"Ansible Playbook vs Ad-Hoc","parent":"Ansible","content":"ä¸‹é¢æ˜¯ä¸€ä»½ Ansible Playbook vs Ad-Hoc çš„è¯¦ç»†å¯¹æ¯”ã€é€‚ç”¨åœºæ™¯ã€ç”Ÿäº§æœ€ä½³å®è·µã€å¸¸è§è¯¯åŒºã€‚\néå¸¸é€‚åˆæ„å»º Ansible è‡ªåŠ¨åŒ–ä½“ç³»æ—¶ä½¿ç”¨ã€‚\nğŸ”¥ æ€»ç»“ é¡¹ç›® Ad-Hoc Playbook ç”¨é€” ä¸´æ—¶å‘½ä»¤ / å¿«é€Ÿæ“ä½œ é•¿æœŸç»´æŠ¤ / å¯é‡å¤çš„é…ç½®ç®¡ç† åœºæ™¯ ä¸´æ—¶æ‰¹é‡æ‰§è¡Œå‘½ä»¤ã€æŸ¥çœ‹çŠ¶æ€ã€ä¿®æ”¹å•ä¸ªé…ç½® ç³»ç»Ÿéƒ¨ç½²ã€åº”ç”¨éƒ¨ç½²ã€è¿ç»´æµç¨‹è‡ªåŠ¨åŒ–ã€æŒç»­äº¤ä»˜ é€‚åˆ è¿ç»´å·¥ç¨‹å¸ˆçš„æ—¥å¸¸è¡Œæ”¿å‘½ä»¤ å›¢é˜Ÿåä½œ / å¯ç‰ˆæœ¬åŒ– / CI/CD ä¼˜åŠ¿ å¿«é€Ÿã€æ— æ–‡ä»¶ã€ç®€å• å¯å¤ç”¨ã€ç»“æ„åŒ–ã€ä¾èµ–ç®¡ç†ã€å¹‚ç­‰å¯é  ç¼ºç‚¹ ä¸å¯ç»´æŠ¤ã€ä¸å¯å›æ»šã€æ— å¹‚ç­‰æ€§ å†™èµ·æ¥ç›¸å¯¹å¤æ‚ 1. ğŸ“Œ ä»€ä¹ˆæ—¶å€™ç”¨ Ansible Ad-Hocï¼Ÿ Ad-Hoc = ä¸€æ¡ä¸´æ—¶å‘½ä»¤å³å¯å®Œæˆä¸€æ¬¡æ€§ä»»åŠ¡\næ— éœ€ Playbookã€æ— éœ€æ–‡ä»¶ï¼Œé€‚ç”¨äº çŸ­å¹³å¿«æ“ä½œã€‚\nâœ… Ad-Hoc å…¸å‹åœºæ™¯ï¼ˆéå¸¸æ˜ç¡®ï¼‰ 1. æ‰¹é‡æ‰§è¡Œç®€å•å‘½ä»¤ ansible all -m ping ansible web -a \u0026#34;uptime\u0026#34; ansible db -a \u0026#34;df -h\u0026#34; 2. ä¸´æ—¶çŠ¶æ€æŸ¥çœ‹ ansible web -m setup ansible all -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; 3. ä¸´æ—¶ä¿®æ”¹æ–‡ä»¶/å‚æ•° ansible all -m lineinfile -a \u0026#34;path=/etc/sysctl.conf line=\u0026#39;net.ipv4.ip_forward = 1\u0026#39;\u0026#34; 4. å¿«é€Ÿåˆ†å‘æ–‡ä»¶ ansible web -m copy -a \u0026#34;src=a.conf dest=/etc/a.conf\u0026#34; 5. æ‰§è¡Œä¸€æ¬¡æ€§ç»´æŠ¤æ“ä½œ ansible web -m service -a \u0026#34;name=nginx state=restarted\u0026#34; 6. è¿ç»´ç´§æ€¥å¤„ç† ä¸´æ—¶å…³æ‰æœåŠ¡ ä¸´æ—¶åˆ é™¤æ–‡ä»¶/æ¸…ç†æ—¥å¿— ä¸´æ—¶åŠ ç›‘æ§ â­ Ad-Hoc æœ€ä½³å®è·µ 1. å°æ“ä½œå¿…ç”¨ ad-hocï¼Œå¤§æ“ä½œç¦ç”¨ ad-hoc ä¸€æ¬¡æ€§ã€æ— å‰¯ä½œç”¨æ“ä½œâ€”â€”é€‚åˆ ad-hoc\nå±é™©æ“ä½œã€é‡æ“ä½œâ€”â€”ä¸è¦ ad-hocï¼\n2. åŠ ä¸Š \u0026ndash;check æ¨¡å¼ å¯æ¨¡æ‹Ÿæ‰§è¡Œï¼š\nansible web -m lineinfile -a \u0026#34;... \u0026#34; --check 3. ä½¿ç”¨ \u0026ndash;limit ç¼©å°èŒƒå›´ ansible all -m shell -a \u0026#34;systemctl restart nginx\u0026#34; --limit web1 4. é«˜é£é™©å‘½ä»¤å¿…é¡»åŠ ç¡®è®¤ åƒå°æœåŠ¡å™¨æ‰§è¡Œï¼š\nansible all -a \u0026#34;rm -rf /tmp/*\u0026#34; âŒ è¿™æ˜¯æœ€å¸¸è§çš„äº‹æ•…\nåŠ¡å¿…é™åˆ¶ï¼š\nansible all -a \u0026#34;rm -rf /tmp/*\u0026#34; --limit \u0026#39;app-\u0026amp;prod\u0026#39; --check 5. ad-hoc ä¸åšä¸šåŠ¡é€»è¾‘ã€ä¸åšå¤šæ­¥æ“ä½œ ä¸€æ¡åªèƒ½åšä¸€ä»¶äº‹\nå¦‚æœéœ€è¦æµç¨‹ -\u0026gt; playbook\n2. ğŸ“˜ ä»€ä¹ˆæ—¶å€™ç”¨ Ansible Playbookï¼Ÿ Playbook = å¯é‡å¤çš„è‡ªåŠ¨åŒ–è“å›¾\né€‚åˆï¼šå›ºå®šæµç¨‹ã€å¤æ‚æ“ä½œã€ç³»ç»Ÿéƒ¨ç½²ã€æŒç»­äº¤ä»˜ã€ç¯å¢ƒä¸€è‡´æ€§ç®¡ç†ã€‚\nâœ… Playbook å…¸å‹åœºæ™¯ 1. æœåŠ¡éƒ¨ç½²ï¼ˆNginx/MySQL/Redisï¼‰ åŒ…å«å®‰è£… -\u0026gt; é…ç½® -\u0026gt; å¯åŠ¨ -\u0026gt; æ£€æŸ¥ -\u0026gt; å›æ»šå®Œæ•´æµç¨‹\n2. åº”ç”¨å‘å¸ƒï¼ˆJavaã€Pythonã€Goï¼‰ ä»æ‹‰ä»£ç åˆ°é‡å¯æœåŠ¡å…¨è‡ªåŠ¨\n3. ç‰ˆæœ¬ç®¡ç†ã€ç¯å¢ƒç®¡ç†ï¼ˆprod/staging/devï¼‰ 4. ä¸šåŠ¡ç³»ç»Ÿä¸Šçº¿/å‡çº§ éœ€è¦å¤šæ­¥æµç¨‹çš„ç»Ÿä¸€ç‰ˆæœ¬æ§åˆ¶\n5. æ“ä½œéœ€å¹‚ç­‰æ€§ Playbook åå¤æ‰§è¡Œä¸ä¼šå‡ºé”™ï¼ˆad-hoc ä¸å…·å¤‡ï¼‰\n6. æŒç»­äº¤ä»˜ CI/CD ä¸æµæ°´çº¿ GitLabã€Jenkins éƒ½ä¾èµ– Playbook\nâ­ Playbook æœ€ä½³å®è·µï¼ˆä¼ä¸šçº§ï¼‰ 1. ä¸€åˆ‡è‡ªåŠ¨åŒ–éƒ½å†™æˆ Roleï¼ˆå¼ºçƒˆæ¨èï¼‰ ä¸è¦æŠŠé€»è¾‘æ•£è½åœ¨å¤šä¸ª playbook ä¸­ã€‚\nç»“æ„åŒ–ï¼š\nroles/ nginx/ tasks/ templates/ files/ handlers/ 2. playbook ä¸­ä¸å†™ shellï¼Œä¼˜å…ˆä½¿ç”¨æ¨¡å— âŒ é”™è¯¯ï¼š\n- shell: \u0026#34;systemctl restart nginx\u0026#34; âœ… æ­£ç¡®ï¼š\n- service: name: nginx state: restarted 3. é»˜è®¤ä½¿ç”¨ handlersï¼ˆå‡å°‘é‡å¤å¯åŠ¨æœåŠ¡ï¼‰ 4. ä½¿ç”¨æ¡ä»¶ï¼ˆwhenï¼‰æ§åˆ¶é€»è¾‘åˆ†æ”¯ 5. ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“é…ç½®ï¼ˆtemplates/*.j2ï¼‰ 6. æ‰€æœ‰å˜é‡å¿…é¡»å­˜æ”¾åœ¨ group_vars/host_vars Playbook ä¸åŒ…å«å˜é‡ï¼Œè¿™æ˜¯å¯ç»´æŠ¤æ€§å…³é”®ã€‚\n7. ç”¨ tags è¿›è¡Œåˆ†æ¨¡å—æ‰§è¡Œ ansible-playbook site.yml --tags \u0026#34;deploy\u0026#34; 8. ä½¿ç”¨æ£€æŸ¥æ¨¡å¼ï¼ˆâ€“checkï¼‰+ å·®å¼‚æ¨¡å¼ï¼ˆâ€“diffï¼‰ ansible-playbook site.yml --check --diff 9. Playbook å­˜ Gitï¼Œè¦æ±‚ Code Review -\u0026gt; é˜²æ­¢äº‹æ•… 10. Playbook å¿…é¡»å¯é‡è¯•ï¼ˆå¹‚ç­‰è®¾è®¡ï¼‰ ç¡®ä¿é‡å¤æ‰§è¡Œä¸ä¼šç ´åç³»ç»Ÿã€‚\n3. ğŸ¯ Ad-Hoc vs Playbook åœºæ™¯å¯¹æ¯”æ€»ç»“ ğŸ“Œ Ad-Hoc âœ… é€‚åˆ\næ‰¹é‡å‘½ä»¤ ä¸€æ¬¡æ€§ä»»åŠ¡ ä¸´æ—¶çš„ã€æ— å‰¯ä½œç”¨çš„å°æ“ä½œ æŸ¥çœ‹ä¿¡æ¯ã€è°ƒè¯•ã€æ‰¹é‡æ£€æŸ¥ æœåŠ¡å™¨ä¸Šçº¿å‰çš„å¿«é€ŸéªŒè¯ âŒ ä¸é€‚åˆéƒ¨ç½²ã€ä¸šåŠ¡é€»è¾‘ã€é•¿æµç¨‹\nğŸ“˜ Playbook âœ… é€‚åˆ\næ­£å¼éƒ¨ç½²æµç¨‹ å¤§å‹ä¸šåŠ¡ç³»ç»Ÿä¸Šçº¿ å¤šæ­¥æµç¨‹ é…ç½®ç®¡ç† åº”ç”¨å‘å¸ƒ å¤šç¯å¢ƒç®¡ç† å›ºå®šä»»åŠ¡å‘¨æœŸ å®‰è£…ã€é…ç½®ã€æ—¥å¿—ã€ç›‘æ§ã€é™æµã€æ¢å¤ âŒ ä¸é€‚åˆå¿«é€Ÿé›¶ç¢çš„å°ä»»åŠ¡\n4. ğŸ–ï¸ å¦‚ä½•é€‰æ‹©ï¼Ÿï¼ˆè¿ç»´å·¥ç¨‹å¸ˆå…¥é—¨çº§åˆ¤æ–­æ³•ï¼‰ åªæœ‰ 1 æ­¥ -\u0026gt; Ad-Hoc å¤šäº 3 æ­¥ -\u0026gt; Playbook å°†æ¥éœ€è¦é‡å¤æ‰§è¡Œ -\u0026gt; Playbook å½±å“é¢å¤§ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ -\u0026gt; Playbook å®æ—¶æ“ä½œ + ç´§æ€¥å¤„ç† -\u0026gt; Ad-Hocï¼ˆä½†éœ€è°¨æ…ï¼‰ 5. ğŸ§¨ å¸¸è§è¯¯åŒº âŒ è¯¯åŒº 1ï¼šå…¨éƒ¨ç”¨ ad-hoc ç»“æœï¼šæ— ç‰ˆæœ¬æ§åˆ¶ã€éš¾ä»¥é‡å¤æ‰§è¡Œã€å®¹æ˜“è¯¯æ“ä½œã€‚\nâŒ è¯¯åŒº 2ï¼šPlaybook å†™æˆâ€œå¤š shell è„šæœ¬â€ ä¸è¦æŠŠ playbook å½“æˆ shell é›†åˆã€‚\nâŒ è¯¯åŒº 3ï¼šPlaybook ä¸­å†™ IP ç”Ÿäº§ç»ä¸èƒ½è¿™æ ·åšï¼Œåº”ä½¿ç”¨ inventory + å˜é‡ã€‚\nâŒ è¯¯åŒº 4ï¼šplaybook æ²¡æœ‰å¹‚ç­‰æ€§ å†™æˆï¼š\n- shell: \u0026#34;echo 1 \u0026gt;\u0026gt; file\u0026#34; å¯¼è‡´é‡å¤æ‰§è¡Œè¿½åŠ å¤šæ¬¡ã€‚\n6. ğŸ“¦ æœ€ç»ˆç®€çŸ­æ€»ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥æ”¾åˆ°æ–‡æ¡£ä¸­ï¼‰ Ad-Hocï¼š\nç”¨äºä¸´æ—¶å‘½ä»¤ã€ä¸€æ¬¡æ€§ç»´æŠ¤ã€æ‰¹é‡æ£€æŸ¥ã€å¿«é€Ÿæ“ä½œ ä¸é€‚åˆå¤æ‚æµç¨‹ æœ€ä½³å®è·µï¼šé™åˆ¶èŒƒå›´ã€å¯ç”¨ checkã€è°¨æ…æ‰§è¡Œ Playbookï¼š\nç”¨äºå¯é‡å¤çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼šéƒ¨ç½²ã€å‡çº§ã€é…ç½®ç®¡ç†ã€CI/CD å¼ºè°ƒå¹‚ç­‰æ€§ã€ç»“æ„åŒ–ã€ç‰ˆæœ¬åŒ–ã€æ¨¡å—åŒ–ã€å¯é‡å¤ æœ€ä½³å®è·µï¼šä½¿ç”¨ Rolesã€ä½¿ç”¨æ¨¡å—ã€handlersã€åŠ  diff/checkã€CI å®¡æ ¸ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ Ansible Playbook vs Ad-Hoc çš„è¯¦ç»†å¯¹æ¯”ã€é€‚ç”¨åœºæ™¯ã€ç”Ÿäº§æœ€ä½³å®è·µã€å¸¸è§è¯¯åŒºã€‚\néå¸¸é€‚åˆæ„å»º Ansible è‡ªåŠ¨åŒ–ä½“ç³»æ—¶ä½¿ç”¨ã€‚\nğŸ”¥ æ€»ç»“ é¡¹ç›® Ad-Hoc Playbook ç”¨é€” ä¸´æ—¶å‘½ä»¤ / å¿«é€Ÿæ“ä½œ é•¿æœŸç»´æŠ¤ / å¯é‡å¤çš„é…ç½®ç®¡ç† åœºæ™¯ ä¸´æ—¶æ‰¹é‡æ‰§è¡Œå‘½ä»¤ã€æŸ¥çœ‹çŠ¶æ€ã€ä¿®æ”¹å•ä¸ªé…ç½® ç³»ç»Ÿéƒ¨ç½²ã€åº”ç”¨éƒ¨ç½²ã€è¿ç»´æµç¨‹è‡ªåŠ¨åŒ–ã€æŒç»­äº¤ä»˜ é€‚åˆ è¿ç»´å·¥ç¨‹å¸ˆçš„æ—¥å¸¸è¡Œæ”¿å‘½ä»¤ å›¢é˜Ÿåä½œ / å¯ç‰ˆæœ¬åŒ– / CI/CD ä¼˜åŠ¿ å¿«é€Ÿã€æ— æ–‡ä»¶ã€ç®€å• å¯å¤ç”¨ã€ç»“æ„åŒ–ã€ä¾èµ–ç®¡ç†ã€å¹‚ç­‰å¯é  ç¼ºç‚¹ ä¸å¯ç»´æŠ¤ã€ä¸å¯å›æ»šã€æ— å¹‚ç­‰æ€§ å†™èµ·æ¥ç›¸å¯¹å¤æ‚ 1. ğŸ“Œ ä»€ä¹ˆæ—¶å€™ç”¨ Ansible Ad-Hocï¼Ÿ Ad-Hoc = ä¸€æ¡ä¸´æ—¶å‘½ä»¤å³å¯å®Œæˆä¸€æ¬¡æ€§ä»»åŠ¡\n"},{"id":144,"href":"/backend/python/arrow/","title":"Arrow","parent":"Python","content":"Directory List:\nArrow åŸºç¡€æ•™ç¨‹ ","description":"Directory List:\nArrow åŸºç¡€æ•™ç¨‹ "},{"id":145,"href":"/backend/python/official/async/","title":"Async (å¼‚æ­¥)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ Python async / await æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€æœ€å®¹æ˜“ç†è§£çš„å…¥é—¨ + è¿›é˜¶æŒ‡å—ï¼Œé€‚åˆä½ æ•´ä½“æŒæ¡å¼‚æ­¥ç¼–ç¨‹ä½“ç³»ã€‚\nğŸš€ Python async / awaitï¼ˆå¼‚æ­¥ç¼–ç¨‹ï¼‰å®Œå…¨æŒ‡å— Python å¼‚æ­¥ç¼–ç¨‹ä¸»è¦åŸºäºï¼š\nasyncï¼ˆå®šä¹‰å¼‚æ­¥å‡½æ•°ï¼‰ awaitï¼ˆç­‰å¾…å¼‚æ­¥ç»“æœï¼‰ asyncioï¼ˆäº‹ä»¶å¾ªç¯ + åç¨‹è°ƒåº¦ï¼‰ Taskï¼ˆå¹¶å‘æ‰§è¡Œï¼‰ å®ƒä¸»è¦ç”¨äºï¼š\nç½‘ç»œ IOï¼ˆHTTP è¯·æ±‚ï¼‰ æ•°æ®åº“å¼‚æ­¥æ“ä½œï¼ˆSQLAlchemy async / aiomysqlï¼‰ é«˜å¹¶å‘ä»»åŠ¡å¤„ç† çˆ¬è™«ã€æœåŠ¡ç«¯ã€Web æ¡†æ¶ï¼ˆFastAPIï¼‰ 1. ä»€ä¹ˆæ˜¯ async / awaitï¼Ÿ 1.1 async ç”¨äºå£°æ˜å¼‚æ­¥å‡½æ•°ï¼ˆcoroutine åç¨‹ï¼‰ async def fetch_data(): return 123 1.2 await ç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œ result = await fetch_data() âš ï¸ await åªèƒ½åœ¨ async å‡½æ•°ä¸­ä½¿ç”¨ã€‚\n2. async/await çš„æ ¸å¿ƒæ€æƒ³ ğŸ”¥ ä¸€ä¸ªçº¿ç¨‹é‡Œåœ¨ç­‰å¾… IO æ—¶ä¸é˜»å¡ï¼Œå¯ä»¥åšåˆ«çš„äº‹ã€‚\nç¤ºä¾‹ï¼š\nasync def download(): await asyncio.sleep(2) print(\u0026#34;done\u0026#34;) sleep() åœ¨ç­‰å¾… -\u0026gt; ç¨‹åºå¯ä»¥å»åšåˆ«çš„ä»»åŠ¡ï¼ˆçœŸæ­£çš„å¹¶å‘ï¼‰\n3. æœ€å°å¯è¿è¡Œçš„ async ç¤ºä¾‹ import asyncio async def hello(): print(\u0026#34;Hello\u0026#34;) await asyncio.sleep(1) print(\u0026#34;World\u0026#34;) asyncio.run(hello()) 4. async å’Œ def çš„åŒºåˆ« ç±»å‹ è¿”å› def ç›´æ¥è¿”å›å€¼ async def è¿”å› åç¨‹å¯¹è±¡ï¼ˆcoroutineï¼‰ï¼Œéœ€è¦ await ä¾‹å­ï¼š\nasync def foo(): return 100 print(foo()) # \u0026lt;coroutine object foo at 0x...\u0026gt; ä¸èƒ½ç›´æ¥æ‹¿åˆ°ç»“æœï¼Œå¿…é¡»ï¼š\nresult = await foo() æˆ–ï¼š\nasyncio.run(foo()) 5. å¹¶å‘æ‰§è¡Œï¼šTask å¦‚æœä½ æƒ³ åŒæ—¶æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œç”¨ Taskï¼š\nimport asyncio async def download(i): print(f\u0026#34;Start {i}\u0026#34;) await asyncio.sleep(1) print(f\u0026#34;End {i}\u0026#34;) async def main(): tasks = [asyncio.create_task(download(i)) for i in range(3)] await asyncio.gather(*tasks) asyncio.run(main()) è¾“å‡ºï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰ï¼š\nStart 0 Start 1 Start 2 End 0 End 1 End 2 6. asyncio.sleep æ˜¯æœ€å¥½çš„ç¤ºèŒƒ sleep() æ˜¯å¼‚æ­¥ IO çš„ä»£è¡¨ï¼š\nawait asyncio.sleep(1) å®ƒå‘Šè¯‰äº‹ä»¶å¾ªç¯ï¼š\næˆ‘åœ¨ç­‰å¾…ï¼Œä¸å ç”¨ CPUï¼Œä½ å¯ä»¥å…ˆå»æ‰§è¡Œåˆ«çš„ä»»åŠ¡ã€‚\n7. async / await çš„å¸¸è§åœºæ™¯ 7.1 ç½‘ç»œ I/Oï¼ˆHTTP è¯·æ±‚ï¼‰ ä½¿ç”¨ aiohttpï¼š\nimport aiohttp import asyncio async def fetch(url): async with aiohttp.ClientSession() as session: async with session.get(url) as resp: return await resp.text() 7.2 æ•°æ®åº“å¼‚æ­¥æ“ä½œ å¦‚ï¼š\nasync SQLAlchemy aiomysql aioredis result = await async_session.execute(query) 7.3 å¼‚æ­¥æ–‡ä»¶è¯»å†™ import aiofiles async with aiofiles.open(\u0026#34;data.txt\u0026#34;) as f: text = await f.read() 8. async ä¸çº¿ç¨‹/è¿›ç¨‹çš„åŒºåˆ« ç±»å‹ æœ€é€‚åˆ async å¤§é‡ IOï¼ˆHTTPã€DBã€æ–‡ä»¶ã€Socketï¼‰ thread åŒæ—¶è·‘å¤šä¸ªå‡½æ•°ï¼Œæ··åˆ IO å’Œè½» CPU process CPU å¯†é›†å‹ï¼ˆè®¡ç®—ã€æ¨¡å‹ï¼‰ ç¤ºä¾‹ï¼šFastAPI å°±æ˜¯å…¸å‹çš„ async IOã€‚\n9. async çš„è¿è¡Œæ–¹å¼ï¼šäº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰ æ ¸å¿ƒæ€æƒ³ï¼š\näº‹ä»¶å¾ªç¯ç®¡ç†åç¨‹ -\u0026gt; åç¨‹åœ¨é‡åˆ° await æ—¶è®©å‡ºæ§åˆ¶æƒ -\u0026gt; äº‹ä»¶å¾ªç¯è°ƒåº¦å…¶ä»–ä»»åŠ¡ -\u0026gt; ç­‰å¾…å®Œæˆåç»§ç»­æ‰§è¡Œ\nä¸€èˆ¬ä¸ä¼šè‡ªå·±æ“ä½œ event loopï¼Œä½†å¯ä»¥ï¼š\nloop = asyncio.get_event_loop() loop.run_until_complete(main()) ç°ä»£å†™æ³•æ˜¯ asyncio.run(main())ã€‚\n10. async å‡½æ•°å†…éƒ¨é”™è¯¯å¤„ç† async def task(): try: await something() except Exception as e: print(\u0026#34;error\u0026#34;, e) 11. ä½ çœŸæ­£éœ€è¦è®°ä½çš„æ ¸å¿ƒ async å®šä¹‰å¼‚æ­¥å‡½æ•° await ç­‰å¾…è€—æ—¶ IO åç¨‹æœ¬èº«ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼ˆéœ€è¦ asyncio.runï¼‰ æƒ³å¹¶å‘ç”¨ create_task / gather async é€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ ä¸é€‚åˆ CPU å¯†é›†ä»»åŠ¡ï¼ˆé‚£æ˜¯å¤šè¿›ç¨‹çš„é¢†åŸŸï¼‰ 12. æ€»ç»“ï¼ˆæ€ç»´å¯¼å›¾çº§åˆ«ï¼‰ async/await â”‚ â”œâ”€â”€ async å®šä¹‰åç¨‹ -\u0026gt; è¿”å› coroutineï¼Œä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ â”œâ”€â”€ await ç­‰å¾…åç¨‹ -\u0026gt; æŒ‚èµ·å½“å‰ä»»åŠ¡ â”‚ â”œâ”€â”€ asyncio.run(main) -\u0026gt; å¯åŠ¨æ•´ä¸ªå¼‚æ­¥ç¨‹åº â”œâ”€â”€ asyncio.create_task -\u0026gt; åˆ›å»ºå¹¶å‘ä»»åŠ¡ â”œâ”€â”€ asyncio.gather -\u0026gt; å¹¶å‘ç­‰å¾…å¤šä¸ªåç¨‹ â”‚ â””â”€â”€ é€‚åˆ I/O: - ç½‘ç»œè¯·æ±‚ - DB æŸ¥è¯¢ - æ–‡ä»¶æ“ä½œ - FastAPI async for async with ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ Python async / await æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€æœ€å®¹æ˜“ç†è§£çš„å…¥é—¨ + è¿›é˜¶æŒ‡å—ï¼Œé€‚åˆä½ æ•´ä½“æŒæ¡å¼‚æ­¥ç¼–ç¨‹ä½“ç³»ã€‚\nğŸš€ Python async / awaitï¼ˆå¼‚æ­¥ç¼–ç¨‹ï¼‰å®Œå…¨æŒ‡å— Python å¼‚æ­¥ç¼–ç¨‹ä¸»è¦åŸºäºï¼š\nasyncï¼ˆå®šä¹‰å¼‚æ­¥å‡½æ•°ï¼‰ awaitï¼ˆç­‰å¾…å¼‚æ­¥ç»“æœï¼‰ asyncioï¼ˆäº‹ä»¶å¾ªç¯ + åç¨‹è°ƒåº¦ï¼‰ Taskï¼ˆå¹¶å‘æ‰§è¡Œï¼‰ å®ƒä¸»è¦ç”¨äºï¼š\nç½‘ç»œ IOï¼ˆHTTP è¯·æ±‚ï¼‰ æ•°æ®åº“å¼‚æ­¥æ“ä½œï¼ˆSQLAlchemy async / aiomysqlï¼‰ é«˜å¹¶å‘ä»»åŠ¡å¤„ç† çˆ¬è™«ã€æœåŠ¡ç«¯ã€Web æ¡†æ¶ï¼ˆFastAPIï¼‰ 1. ä»€ä¹ˆæ˜¯ async / awaitï¼Ÿ 1.1 async ç”¨äºå£°æ˜å¼‚æ­¥å‡½æ•°ï¼ˆcoroutine åç¨‹ï¼‰ async def fetch_data(): return 123 1.2 await ç”¨äºç­‰å¾…å¼‚æ­¥æ“ä½œ result = await fetch_data() âš ï¸ await åªèƒ½åœ¨ async å‡½æ•°ä¸­ä½¿ç”¨ã€‚\n"},{"id":146,"href":"/backend/python/official/async-multiprocessing/","title":"Async + Multiprocessing","parent":"Official","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å®ç”¨çš„ async + multiprocessing ç»“åˆæ–¹æ¡ˆã€‚\nè¿™æ˜¯ Python æœ€å¼ºç»„åˆï¼š\nasync å¤„ç† IOï¼Œmultiprocessing å¤„ç† CPUï¼ŒååŒå·¥ä½œã€äº’ä¸é˜»å¡ã€‚\nğŸš€ async + multiprocessing ç»“åˆï¼ˆæœ€ä½³å®è·µæŒ‡å—ï¼‰ å¤§åŸåˆ™ï¼š\nCPU å¯†é›† -\u0026gt; multiprocessingï¼ˆç»•å¼€ GILï¼‰ IO å¯†é›† -\u0026gt; async/awaitï¼ˆé«˜å¹¶å‘ï¼‰ å°† CPU ä»»åŠ¡ä¸¢ç»™è¿›ç¨‹æ± ï¼Œè®©ä¸»äº‹ä»¶å¾ªç¯ç»§ç»­è·‘ async å…³é”®å·¥å…·ï¼š\nå·¥å…· è¯´æ˜ asyncio.get_running_loop().run_in_executor() æœ€æ¨èï¼ˆå®˜æ–¹ï¼‰ ProcessPoolExecutor ä½¿ç”¨è¿›ç¨‹æ± è·‘ CPU ä»»åŠ¡ multiprocessing.Pool + asyncio.to_thread() ç»„åˆç”¨æ³• 1. æœ€æ¨èçš„å†™æ³•ï¼šasync + ProcessPoolExecutor è¿™æ˜¯æœ€ä¼˜é›…ã€æœ€å®‰å…¨ã€FastAPI å®˜æ–¹æ¨èçš„å†™æ³•ã€‚\nç¤ºä¾‹ï¼šasync è°ƒç”¨ CPU å¤šè¿›ç¨‹ import asyncio from concurrent.futures import ProcessPoolExecutor def cpu_task(x): # å¤§è®¡ç®—ä»»åŠ¡ s = 0 for i in range(10_000_000): s += i + x return s async def main(): loop = asyncio.get_running_loop() # åˆ›å»ºè¿›ç¨‹æ± ï¼ˆæ ¹æ® CPU æ ¸å¿ƒï¼‰ with ProcessPoolExecutor() as pool: tasks = [ loop.run_in_executor(pool, cpu_task, i) for i in range(5) ] results = await asyncio.gather(*tasks) print(results) asyncio.run(main()) è¿è¡Œæ•ˆæœï¼š\nä¸» async loop ä¸è¢«é˜»å¡ CPU è®¡ç®—åœ¨å¤šä¸ªè¿›ç¨‹ä¸­å¹¶è¡Œæ‰§è¡Œ async ç»§ç»­åšè‡ªå·±çš„ IO æ“ä½œ 2. å’Œ FastAPI å®Œç¾ç»“åˆ from fastapi import FastAPI from concurrent.futures import ProcessPoolExecutor import asyncio app = FastAPI() pool = ProcessPoolExecutor() def heavy_calc(x): return sum(i * x for i in range(10_000_000)) @app.get(\u0026#34;/calc\u0026#34;) async def calc(x: int): loop = asyncio.get_running_loop() result = await loop.run_in_executor(pool, heavy_calc, x) return {\u0026#34;result\u0026#34;: result} ç‰¹ç‚¹ï¼š\nHTTP API æ˜¯ asyncï¼Œå¯é«˜å¹¶å‘ CPU è¿ç®—ä¸¢ç»™è¿›ç¨‹æ±  å…¨æœåŠ¡ä¸ä¼šè¢«é˜»å¡ 3. å¦‚æœä½ çš„ CPU ä»»åŠ¡æ˜¯æ‰¹é‡ -\u0026gt; ç»“åˆ multiprocessing.Pool ä¾‹å¦‚ä½ æœ‰ä¸€ä¸ª multiprocessing æ¨¡å— utils.process_poolï¼š\n# utils/process_pool.py from multiprocessing import Pool, cpu_count def parallel_map(func, items): with Pool(cpu_count()) as p: return p.map(func, items) async ä¸­è°ƒç”¨ï¼š\nimport asyncio from utils.process_pool import parallel_map async def main(): loop = asyncio.get_running_loop() result = await loop.run_in_executor( None, # é»˜è®¤ ThreadPoolï¼Œä½†å‡½æ•°å†…éƒ¨æ˜¯ multiprocessing parallel_map, lambda x: x * x, list(range(10)) ) print(result) asyncio.run(main()) æ³¨æ„ï¼š\nè¿™é‡Œ async è¿›å…¥çº¿ç¨‹æ± ï¼Œè€Œçº¿ç¨‹æ± å†…éƒ¨å¯åŠ¨å¤šè¿›ç¨‹æ±  é€‚åˆå¤§è§„æ¨¡ CPU å¹¶è¡Œä»»åŠ¡ ä½†å¯åŠ¨æˆæœ¬æ¯” ProcessPoolExecutor å¤§ 4. async + multiprocessing + å›è°ƒï¼ˆé«˜çº§ç”¨æ³•ï¼‰ éœ€è¦ CPU å®Œæˆåé€šçŸ¥ asyncï¼š\nimport asyncio from concurrent.futures import ProcessPoolExecutor pool = ProcessPoolExecutor() def cpu_task(x): return x * x async def main(): loop = asyncio.get_running_loop() future = loop.run_in_executor(pool, cpu_task, 10) # å¯ä½¿ç”¨ callback æ–¹å¼ def on_done(f): print(\u0026#34;Done:\u0026#34;, f.result()) future.add_done_callback(on_done) await future asyncio.run(main()) 5. å¤šè¿›ç¨‹å†…è¿è¡Œ async (æé«˜çº§) ä¾‹å¦‚ä½ æƒ³æ¯ä¸ªè¿›ç¨‹å†…æ‰§è¡Œ async/awaitï¼š\nimport asyncio from concurrent.futures import ProcessPoolExecutor async def async_subtask(x): await asyncio.sleep(1) return x * 2 def cpu_process(): # æ¯ä¸ªè¿›ç¨‹å†…è¿è¡Œ async return asyncio.run(async_subtask(10)) async def main(): loop = asyncio.get_running_loop() with ProcessPoolExecutor() as pool: result = await loop.run_in_executor(pool, cpu_process) print(result) asyncio.run(main()) ç”¨é€”ï¼š\næ¯ä¸ªè¿›ç¨‹å†…è·‘ IO + CPU æ··åˆä»»åŠ¡ ä¾‹å¦‚å¤§æ–‡ä»¶åˆ†æ®µä¸‹è½½ + æ ¡éªŒ 6. async + multiprocessing æœ€ç»ˆæœ€ä½³æ¶æ„å›¾ asyncio loop (å¤„ç† IOã€ç½‘ç»œã€API) â”‚ â”‚ run_in_executor â”‚ â–¼ ProcessPoolExecutor (å¤šä¸ªè¿›ç¨‹å¹¶è¡Œè·‘ CPU ä»»åŠ¡) ä¼˜åŠ¿ï¼š\nasync ä¸é˜»å¡ CPU çœŸå¹¶è¡Œ å¹³æ»‘æ‰©å±•åˆ° FastAPI ç­‰æ¡†æ¶ æœ€æ¨èçš„ç»„åˆæ–¹å¼ ä½ çš„é¡¹ç›®ä½¿ç”¨ FastAPI + SQLAlchemy + å¼‚æ­¥ -\u0026gt; æœ€ä½³ç»„åˆï¼š\nasync -\u0026gt; CPU-heavy -\u0026gt; ProcessPoolExecutor async -\u0026gt; IO-heavy -\u0026gt; await function() å°è£… utils/async_process.py åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼š\nresult = await run_cpu_async(cpu_func, x) å³å¯è‡ªåŠ¨åˆ‡åˆ°å¤šè¿›ç¨‹æ± æ‰§è¡Œ CPU å¯†é›†å‡½æ•°ã€‚\né‡‡ç”¨ asyncio + ProcessPoolExecutorï¼Œè¿™æ˜¯æœ€ç¨³ã€æœ€é€šç”¨çš„æ–¹å¼ã€‚\nâ¸»\nâœ… utils/async_process.py # utils/async_process.py import asyncio from concurrent.futures import ProcessPoolExecutor from functools import partial # å…¨å±€çš„è¿›ç¨‹æ± ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºè¿›ç¨‹ï¼‰ _PROCESS_POOL = ProcessPoolExecutor() async def run_cpu_async(func, *args, **kwargs): \u0026#34;\u0026#34;\u0026#34; åœ¨å¼‚æ­¥ç¯å¢ƒä¸­æ‰§è¡Œ CPU å¯†é›†å‡½æ•°ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤šè¿›ç¨‹ã€‚ ç”¨æ³•ï¼š result = await run_cpu_async(cpu_func, x, y) \u0026#34;\u0026#34;\u0026#34; loop = asyncio.get_running_loop() # é€šè¿‡ partial æ‰“åŒ…å‚æ•° fn = partial(func, *args, **kwargs) # åœ¨è¿›ç¨‹æ± æ‰§è¡Œ return await loop.run_in_executor(_PROCESS_POOL, fn) âœ… ä½¿ç”¨ç¤ºä¾‹ 1. CPU å¯†é›†å‡½æ•°ï¼ˆæ™®é€šåŒæ­¥å‡½æ•°ï¼‰ def cpu_heavy(n): s = 0 for i in range(10_000_000): s += (i * n) % 7 return s 2. å¼‚æ­¥è°ƒç”¨ import asyncio from utils.async_process import run_cpu_async async def main(): result = await run_cpu_async(cpu_heavy, 5) print(\u0026#34;ç»“æœï¼š\u0026#34;, result) asyncio.run(main()) â­ æŠ€æœ¯è§£æï¼ˆç®€æ˜ï¼‰ æŠ€æœ¯ ç”¨é€” asyncio å¼‚æ­¥è°ƒåº¦ ProcessPoolExecutor å¤šè¿›ç¨‹æ± ï¼Œç”¨æ¥è·‘ CPU-heavy å‡½æ•° loop.run_in_executor æŠŠåŒæ­¥ CPU ä»»åŠ¡æ‰”è¿›è¿›ç¨‹æ± ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯ partial æ‰“åŒ…å‡½æ•°å’Œå‚æ•° ğŸš€ è¿™æ ·å°è£…çš„ä¼˜åŠ¿ âœ… è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šè¿›ç¨‹ ä½ åªéœ€å†™ï¼š\nawait run_cpu_async(func, ...) å®Œå…¨ä¸ç”¨å…³å¿ƒå¤šè¿›ç¨‹åˆ›å»ºã€é˜Ÿåˆ—é€šä¿¡ã€worker ç®¡ç†ç­‰ã€‚\nâœ… ä¸ä¼šé˜»å¡ event loop FastAPI / aiohttp / æœºå™¨äºº æ¡†æ¶ä¸­éå¸¸é€‚ç”¨ã€‚\nâœ… æ”¯æŒä»»æ„åŒæ­¥ CPU å‡½æ•° æ— éœ€æ”¹ asyncã€‚\nâœ… å¯é•¿æœŸä½œä¸ºç³»ç»Ÿå…¬å…±å·¥å…· ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å®ç”¨çš„ async + multiprocessing ç»“åˆæ–¹æ¡ˆã€‚\nè¿™æ˜¯ Python æœ€å¼ºç»„åˆï¼š\nasync å¤„ç† IOï¼Œmultiprocessing å¤„ç† CPUï¼ŒååŒå·¥ä½œã€äº’ä¸é˜»å¡ã€‚\nğŸš€ async + multiprocessing ç»“åˆï¼ˆæœ€ä½³å®è·µæŒ‡å—ï¼‰ å¤§åŸåˆ™ï¼š\nCPU å¯†é›† -\u0026gt; multiprocessingï¼ˆç»•å¼€ GILï¼‰ IO å¯†é›† -\u0026gt; async/awaitï¼ˆé«˜å¹¶å‘ï¼‰ å°† CPU ä»»åŠ¡ä¸¢ç»™è¿›ç¨‹æ± ï¼Œè®©ä¸»äº‹ä»¶å¾ªç¯ç»§ç»­è·‘ async å…³é”®å·¥å…·ï¼š\nå·¥å…· è¯´æ˜ asyncio.get_running_loop().run_in_executor() æœ€æ¨èï¼ˆå®˜æ–¹ï¼‰ ProcessPoolExecutor ä½¿ç”¨è¿›ç¨‹æ± è·‘ CPU ä»»åŠ¡ multiprocessing.Pool + asyncio.to_thread() ç»„åˆç”¨æ³• 1. æœ€æ¨èçš„å†™æ³•ï¼šasync + ProcessPoolExecutor è¿™æ˜¯æœ€ä¼˜é›…ã€æœ€å®‰å…¨ã€FastAPI å®˜æ–¹æ¨èçš„å†™æ³•ã€‚\n"},{"id":147,"href":"/backend/python/official/asyncio/","title":"Asyncio","parent":"Official","content":" ğŸš€ 1. asyncio æ˜¯ä»€ä¹ˆï¼Ÿ asyncio æ˜¯ Python å†…ç½®çš„ å¼‚æ­¥ I/O æ¡†æ¶ï¼Œæ”¯æŒï¼š\nå¹¶å‘ç½‘ç»œè¯·æ±‚ å¹¶å‘ä»»åŠ¡æ‰§è¡Œï¼ˆå•çº¿ç¨‹ã€å¤š I/Oï¼‰ é«˜æ€§èƒ½çˆ¬è™« å¼‚æ­¥æ•°æ®åº“ï¼ˆå¦‚ asyncpgã€SQLAlchemy asyncï¼‰ å¼‚æ­¥ Web æ¥å£ï¼ˆå¦‚ FastAPIï¼‰ æ ¸å¿ƒæ€æƒ³ï¼šåç¨‹ï¼ˆcoroutineï¼‰+ äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰\nğŸŸ¦ 2. åŸºæœ¬å…³é”®è¯ å…³é”®å­— å«ä¹‰ async def å®šä¹‰ä¸€ä¸ªåç¨‹å‡½æ•° await æš‚åœå½“å‰åç¨‹ï¼Œå°†æ§åˆ¶æƒäº¤å›äº‹ä»¶å¾ªç¯ asyncio.create_task() åˆ›å»ºä¸€ä¸ªå¯å¹¶å‘è¿è¡Œçš„ä»»åŠ¡ asyncio.gather() å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ await asyncio.sleep() å¼‚æ­¥ç¡çœ ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯ ğŸŸ© 3. æœ€ç®€å•ç¤ºä¾‹ import asyncio async def hello(): print(\u0026#34;Hello\u0026#34;) await asyncio.sleep(1) print(\u0026#34;World\u0026#34;) asyncio.run(hello()) ğŸŸ¦ 4. await çš„æ„ä¹‰ await è¡¨ç¤ºï¼š\né‡åˆ° I/O æ—¶ï¼ŒæŠŠæ‰§è¡Œæƒäº¤å‡ºå»ï¼Œè®©å…¶ä»–åç¨‹ç»§ç»­è·‘ã€‚\nç¤ºä¾‹ï¼š\nawait asyncio.sleep(3) æ„å‘³â€œè®©å‡º CPUï¼Œä¸é˜»å¡çº¿ç¨‹â€ã€‚\nğŸŸ¦ 5. å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆæ ¸å¿ƒé‡ç‚¹ï¼‰ ä½¿ç”¨ asyncio.gather import asyncio async def task(n): await asyncio.sleep(1) return f\u0026#34;task {n}\u0026#34; async def main(): results = await asyncio.gather( task(1), task(2), task(3), ) print(results) asyncio.run(main()) è¾“å‡ºï¼š\n[\u0026#39;task 1\u0026#39;, \u0026#39;task 2\u0026#39;, \u0026#39;task 3\u0026#39;] ğŸ”¹ 3 ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œè€—æ—¶ â‰ˆ 1 ç§’ã€‚\nä½¿ç”¨ create_taskï¼ˆé«˜çº§ç”¨æ³•ï¼‰ async def main(): t1 = asyncio.create_task(task(1)) t2 = asyncio.create_task(task(2)) print(await t1) print(await t2) ğŸŸ© 6. çœŸå®æ¡ˆä¾‹ï¼šå¹¶å‘ HTTP è¯·æ±‚ import aiohttp import asyncio async def fetch(url, session): async with session.get(url) as resp: return await resp.text() async def main(): urls = [ \u0026#34;https://example.com\u0026#34;, \u0026#34;https://python.org\u0026#34;, \u0026#34;https://httpbin.org/get\u0026#34;, ] async with aiohttp.ClientSession() as session: results = await asyncio.gather( *(fetch(url, session) for url in urls) ) print(len(results)) asyncio.run(main()) ğŸŸ¦ 7. asyncio vs multiprocessing åœºæ™¯ æ¨è I/O å¯†é›†ï¼ˆç½‘ç»œã€æ•°æ®åº“ï¼‰ asyncio CPU å¯†é›†ï¼ˆè®¡ç®—ã€åŠ å¯†ã€è§†é¢‘ç¼–ç ï¼‰ multiprocessing ä¸¤è€…ç»“åˆ å¼‚æ­¥ + å¤šè¿›ç¨‹ï¼ˆä½ å‰é¢é—®è¿‡çš„ run_cpu_async å°±å±äºæ­¤ç±»ï¼‰ ğŸŸ© 8. å¼‚å¸¸å¤„ç†ç¤ºä¾‹ async def safe_task(): try: await risky() except Exception as e: print(\u0026#34;Error:\u0026#34;, e) asyncio.create_task(safe_task()) ğŸŸ¦ 9. è¶…æ—¶æ§åˆ¶ await asyncio.wait_for(task(), timeout=3) ğŸŸ© 10. ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰ sem = asyncio.Semaphore(10) # æœ€å¤š 10 å¹¶å‘ async def fetch(url): async with sem: await asyncio.sleep(1) return url ğŸŸ¦ 11. asyncio é˜»å¡é—®é¢˜ï¼ˆé‡è¦ï¼‰ âš ï¸ è‹¥ä½ å†™äº†ä»¥ä¸‹ä»£ç ï¼Œä¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼š\ntime.sleep(3) # âŒ ä¸è¦è¿™ä¹ˆå†™ è¦ç”¨ï¼š\nawait asyncio.sleep(3) # âœ… å¼‚æ­¥ç¡çœ  åŒç†ï¼š\né˜»å¡å‡½æ•° æ›¿ä»£ requests aiohttp mysqlclient asyncmy / asyncpg SQLAlchemy sync SQLAlchemy async æ–‡ä»¶ I/O aiofiles ğŸŸ© 12. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ async with aiohttp.ClientSession() as s: ... ğŸŸ¦ 13. å¼‚æ­¥è¿­ä»£å™¨ï¼ˆasync forï¼‰ async for row in async_generator(): print(row) ğŸŸ© 14. async generator ç¤ºä¾‹ async def agen(): for i in range(3): await asyncio.sleep(1) yield i ğŸŸ¦ 15. å®æˆ˜ï¼šä½ çš„ FastAPI ä¸­ asyncio çš„æœ€ä½³å†™æ³• @app.get(\u0026#34;/items\u0026#34;) async def get_items(): data = await service.fetch_items() return data æ•°æ®åº“ ORM å¦‚æœæ”¯æŒ asyncï¼Œä¾‹å¦‚ï¼š\nasync with async_session() as session: result = await session.execute(stmt) ğŸŸ© 16. è¶…çº§æ±‡æ€»ï¼šasyncio ä½¿ç”¨åœºæ™¯ åœºæ™¯ æ˜¯å¦é€‚åˆ asyncio é«˜é¢‘ I/O è¯·æ±‚ âœ… å¼ºçƒˆæ¨è HTTP çˆ¬è™«ã€å¹¶å‘ä¸‹è½½ âœ… å¼‚æ­¥æ•°æ®åº“ âœ… FastAPI / aiohttp Web åç«¯ âœ… CPU å¯†é›†è®¡ç®— âŒ ä¸é€‚åˆï¼Œç”¨ multiprocessing è¯»å†™å¤§æ–‡ä»¶ âœ… ç”¨ aiofiles ğŸŸ¦ 17. ä¸€å±çœ‹æ‡‚ asyncioï¼ˆç»ˆææ€»ç»“ï¼‰ async def func(): \u0026lt;- å®šä¹‰åç¨‹ await something \u0026lt;- è®©å‡ºæ‰§è¡Œæƒ asyncio.run() \u0026lt;- å¯åŠ¨äº‹ä»¶å¾ªç¯ asyncio.create_task() \u0026lt;- å¹¶å‘è¿è¡Œ asyncio.gather() \u0026lt;- å¹¶å‘æ”¶é›†ç»“æœ asyncio.sleep() \u0026lt;- å¼‚æ­¥ç¡çœ  async with \u0026lt;- å¼‚æ­¥ä¸Šä¸‹æ–‡ async for \u0026lt;- å¼‚æ­¥è¿­ä»£å™¨ Semaphore \u0026lt;- é™åˆ¶å¹¶å‘ wait_for \u0026lt;- è¶…æ—¶æ§åˆ¶ ```text ","description":" ğŸš€ 1. asyncio æ˜¯ä»€ä¹ˆï¼Ÿ asyncio æ˜¯ Python å†…ç½®çš„ å¼‚æ­¥ I/O æ¡†æ¶ï¼Œæ”¯æŒï¼š\nå¹¶å‘ç½‘ç»œè¯·æ±‚ å¹¶å‘ä»»åŠ¡æ‰§è¡Œï¼ˆå•çº¿ç¨‹ã€å¤š I/Oï¼‰ é«˜æ€§èƒ½çˆ¬è™« å¼‚æ­¥æ•°æ®åº“ï¼ˆå¦‚ asyncpgã€SQLAlchemy asyncï¼‰ å¼‚æ­¥ Web æ¥å£ï¼ˆå¦‚ FastAPIï¼‰ æ ¸å¿ƒæ€æƒ³ï¼šåç¨‹ï¼ˆcoroutineï¼‰+ äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰\nğŸŸ¦ 2. åŸºæœ¬å…³é”®è¯ å…³é”®å­— å«ä¹‰ async def å®šä¹‰ä¸€ä¸ªåç¨‹å‡½æ•° await æš‚åœå½“å‰åç¨‹ï¼Œå°†æ§åˆ¶æƒäº¤å›äº‹ä»¶å¾ªç¯ asyncio.create_task() åˆ›å»ºä¸€ä¸ªå¯å¹¶å‘è¿è¡Œçš„ä»»åŠ¡ asyncio.gather() å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ await asyncio.sleep() å¼‚æ­¥ç¡çœ ï¼Œä¸é˜»å¡äº‹ä»¶å¾ªç¯ ğŸŸ© 3. æœ€ç®€å•ç¤ºä¾‹ import asyncio async def hello(): print(\u0026#34;Hello\u0026#34;) await asyncio.sleep(1) print(\u0026#34;World\u0026#34;) asyncio.run(hello()) ğŸŸ¦ 4. await çš„æ„ä¹‰ await è¡¨ç¤ºï¼š\n"},{"id":148,"href":"/database/design/b-tree-vs-b+tree/","title":"B-Tree å’Œ B+Tree çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»¥åŠ MySQL å’Œ PostgreSQL ç›¸å…³çš„åŒºåˆ«ã€‚","parent":"Design","content":"è¿™æ˜¯æ•°æ®åº“ç´¢å¼•é¢†åŸŸçš„ç»å…¸å¿…è€ƒé¢˜ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ª â€œå¯¹æ¯”å‹ + è½åœ°å‹â€ çš„é—®é¢˜ã€‚\nåˆ†ä¸‰å±‚æ¥è®²ï¼š\nB-Tree vs B+Tree æœ¬è´¨åŒºåˆ« MySQLï¼ˆInnoDBï¼‰æ€ä¹ˆç”¨ PostgreSQL æ€ä¹ˆç”¨ ä¸ºä»€ä¹ˆä¸¤ä¸ªæ•°æ®åº“åšäº†ä¸åŒé€‰æ‹©ï¼ˆå·¥ç¨‹åŸå› ï¼‰ ä»¥ä¸‹å°½é‡ç”¨å·¥ç¨‹è§†è§’è€Œä¸æ˜¯æ•™ç§‘ä¹¦è§†è§’è¯´æ˜ã€‚\nä¸€ã€B-Tree vs B+Treeï¼šæœ¬è´¨åŒºåˆ« 1ï¸âƒ£ å…ˆç»™ä¸€å¥è¯ç‰ˆç»“è®º B+Tree æ˜¯ä¸ºäº†æ•°æ®åº“è€Œç”Ÿçš„ B-Tree å˜ç§\n2ï¸âƒ£ ç»“æ„å¯¹æ¯”ï¼ˆæ ¸å¿ƒï¼‰ ğŸ”¹ B-Treeï¼ˆä¼ ç»Ÿï¼‰ éå¶å­èŠ‚ç‚¹ + å¶å­èŠ‚ç‚¹ ğŸ‘‰ éƒ½å­˜ key + value æŸ¥åˆ°ä¸­é—´èŠ‚ç‚¹å°±å¯èƒ½ç»“æŸ å¶å­èŠ‚ç‚¹ ä¸ä¸€å®šé“¾è¡¨ [10|20] / | \\ [1..9] [10..19] [20..30] ğŸ”¹ B+Treeï¼ˆæ•°æ®åº“å¸¸ç”¨ï¼‰ éå¶å­èŠ‚ç‚¹ï¼šåªå­˜ key + child pointer å¶å­èŠ‚ç‚¹ï¼šå­˜ key + value æ‰€æœ‰ value éƒ½åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹å½¢æˆæœ‰åºé“¾è¡¨ [10|20] / | \\ / | \\ [1..9] \u0026lt;-\u0026gt; [10..19] \u0026lt;-\u0026gt; [20..30] 3ï¸âƒ£ è¡Œä¸ºå·®å¼‚ï¼ˆé‡ç‚¹ï¼‰ å¯¹æ¯”é¡¹ B-Tree B+Tree æ•°æ®å­˜å‚¨ä½ç½® æ‰€æœ‰èŠ‚ç‚¹ åªåœ¨å¶å­èŠ‚ç‚¹ ä¸­é—´èŠ‚ç‚¹æ˜¯å¦å­˜æ•°æ® æ˜¯ å¦ æŸ¥è¯¢æ˜¯å¦å¯èƒ½æå‰ç»“æŸ æ˜¯ å¦ èŒƒå›´æŸ¥è¯¢ å·® éå¸¸å¥½ é¡ºåºéå† ä¸å‹å¥½ æå…¶é«˜æ•ˆ èŠ‚ç‚¹æ‰‡å‡ºï¼ˆfanoutï¼‰ è¾ƒå° æ›´å¤§ IO æ¬¡æ•° åå¤š æ›´å°‘ 4ï¸âƒ£ ä¸ºä»€ä¹ˆæ•°æ®åº“æ›´çˆ± B+Treeï¼Ÿ æ•°æ®åº“ 90% çš„æŸ¥è¯¢æ˜¯ï¼š\nèŒƒå›´æŸ¥è¯¢ æ’åº åˆ†é¡µ æ‰«æ \u0026gt;=, \u0026lt;=, BETWEEN, ORDER BY ğŸ‘‰ B+Tree å¤©ç”Ÿä¸ºè¿™äº›è€Œç”Ÿ\näºŒã€MySQLï¼ˆInnoDBï¼‰æ€ä¹ˆç”¨ B+Treeï¼Ÿ 1ï¸âƒ£ InnoDB çš„ç´¢å¼•ç»“æ„ InnoDB = å…¨é¢ B+Tree\nğŸ”¹ èšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼‰ ä¸»é”®ç´¢å¼• å¶å­èŠ‚ç‚¹ = æ•´è¡Œæ•°æ® è¡¨æ•°æ®å°±æ˜¯ç´¢å¼• PRIMARY KEY B+Tree å¶å­èŠ‚ç‚¹ = è¡Œæ•°æ® ğŸ”¹ äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰ å¶å­èŠ‚ç‚¹å­˜ï¼šäºŒçº§ç´¢å¼• key + ä¸»é”® æŸ¥äºŒçº§ç´¢å¼• -\u0026gt; å†å›ä¸»é”®ç´¢å¼•ï¼ˆå›è¡¨ï¼‰ secondary index å¶å­èŠ‚ç‚¹ = (idx_key, primary_key) 2ï¸âƒ£ InnoDB çš„ B+Tree ç‰¹ç‚¹ å›ºå®š 16KB page é«˜ fanout æå°‘æ ‘é«˜ï¼ˆä¸€èˆ¬ 2ï½4 å±‚ï¼‰ é¡ºåºæ‰«ææå¿« 3ï¸âƒ£ InnoDB é€‰æ‹© B+Tree çš„åŸå›  èŒƒå›´æŸ¥è¯¢å¤š èšç°‡ç´¢å¼•å‡å°‘ä¸€æ¬¡ IO é€‚åˆç£ç›˜é¡ºåºè¯» é¡µçº§ç¼“å­˜å‹å¥½ ä¸‰ã€PostgreSQL çš„é€‰æ‹©ï¼šB-Tree + å †è¡¨ï¼ˆHeapï¼‰ PostgreSQL çš„è®¾è®¡æ€æƒ³å’Œ InnoDB å®Œå…¨ä¸åŒã€‚\n1ï¸âƒ£ PostgreSQL çš„ B-Tree ç´¢å¼• PostgreSQL çš„ btree æ˜¯ B+Tree å˜ä½“ ç´¢å¼•ä¸­ä¸å­˜è¡Œæ•°æ® å¶å­èŠ‚ç‚¹å­˜ï¼š key + TIDï¼ˆtuple idï¼‰ ğŸ‘‰ TID æŒ‡å‘ Heap Table\n2ï¸âƒ£ PostgreSQL è¡¨ç»“æ„ Index (B+Tree) â†“ Heap Table (çœŸæ­£çš„æ•°æ®) ç‰¹ç‚¹\nè¡¨æ˜¯å †ç»“æ„ï¼ˆæ— åºï¼‰ ç´¢å¼•åªåšâ€œæŒ‡é’ˆå¯¼èˆªâ€ æ›´æ–°æ—¶ä¸ç§»åŠ¨ç´¢å¼•ç»“æ„ 3ï¸âƒ£ PostgreSQL ä¸ºä»€ä¹ˆä¸åšèšç°‡ç´¢å¼•ï¼Ÿ æ ¸å¿ƒåŸå› ï¼šMVCC\næ¯æ¬¡ UPDATE = æ–°è¡Œ è€è¡Œä¿ç•™ï¼ˆç›´åˆ° VACUUMï¼‰ å¦‚æœæ˜¯èšç°‡ç´¢å¼•ï¼š è¡Œé¢‘ç¹ç§»åŠ¨ ç´¢å¼•ç»´æŠ¤æˆæœ¬å·¨å¤§ ğŸ‘‰ æ‰€ä»¥ PostgreSQL é€‰æ‹© ç´¢å¼• \u0026amp; æ•°æ®åˆ†ç¦»\n4ï¸âƒ£ PostgreSQL çš„å˜é€šæ–¹æ¡ˆ ğŸ”¹ CLUSTERï¼ˆä¸€æ¬¡æ€§ï¼‰ CLUSTER table_name USING index_name; åªåœ¨å½“å‰æ—¶åˆ»æŒ‰ç´¢å¼•é¡ºåºé‡æ’ åç»­ UPDATE ä¼šç ´åé¡ºåº ğŸ”¹ BRIN / GIN / GiST PostgreSQL æ›´åå‘ï¼š\nå¤šç´¢å¼•ç±»å‹ ä¸æ‰§ç€äº B+Tree ä¸€æŠŠæ¢­ å››ã€MySQL vs PostgreSQL ç´¢å¼•è®¾è®¡å¯¹æ¯”ï¼ˆé‡ç‚¹æ€»ç»“ï¼‰ å¯¹æ¯”é¡¹ MySQL InnoDB PostgreSQL ç´¢å¼•ç±»å‹ B+Tree ä¸ºæ ¸å¿ƒ B-Tree ä¸ºä¸»ï¼Œå¤šç±»å‹ èšç°‡ç´¢å¼• å¿…é¡»æœ‰ âŒ æ•°æ®å­˜å‚¨ åœ¨ä¸»é”®ç´¢å¼•å¶å­ Heap äºŒçº§ç´¢å¼• å­˜ä¸»é”® å­˜ TID UPDATE ä»£ä»· æ”¹ç´¢å¼• å†™æ–°è¡Œ MVCC undo log tuple version é¡ºåºæ‰«æ éå¸¸å¿« ä¾èµ– VACUUM OLTP å¼º å¼º æ‰©å±•èƒ½åŠ› ä¸­ éå¸¸å¼º äº”ã€æ€»ç»“ âœ… B-Tree vs B+Tree B+Tree æŠŠæ•°æ®é›†ä¸­åœ¨å¶å­èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡é“¾è¡¨è¿æ¥å¶å­èŠ‚ç‚¹ï¼Œä½¿èŒƒå›´æŸ¥è¯¢å’Œé¡ºåºæ‰«ææ•ˆç‡æé«˜ï¼Œå› æ­¤æˆä¸ºæ•°æ®åº“ç´¢å¼•çš„äº‹å®æ ‡å‡†ã€‚\nâœ… MySQL vs PostgreSQL InnoDB ä½¿ç”¨èšç°‡ B+Treeï¼Œå°†æ•°æ®å’Œä¸»é”®ç´¢å¼•ç»‘å®šä»¥å‡å°‘ IOï¼›PostgreSQL ä½¿ç”¨å †è¡¨ + B-Tree ç´¢å¼•ï¼Œæ›´å¥½åœ°æ”¯æŒ MVCC å’Œå¤æ‚æ›´æ–°åœºæ™¯ã€‚\n","description":"è¿™æ˜¯æ•°æ®åº“ç´¢å¼•é¢†åŸŸçš„ç»å…¸å¿…è€ƒé¢˜ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ª â€œå¯¹æ¯”å‹ + è½åœ°å‹â€ çš„é—®é¢˜ã€‚\nåˆ†ä¸‰å±‚æ¥è®²ï¼š\nB-Tree vs B+Tree æœ¬è´¨åŒºåˆ« MySQLï¼ˆInnoDBï¼‰æ€ä¹ˆç”¨ PostgreSQL æ€ä¹ˆç”¨ ä¸ºä»€ä¹ˆä¸¤ä¸ªæ•°æ®åº“åšäº†ä¸åŒé€‰æ‹©ï¼ˆå·¥ç¨‹åŸå› ï¼‰ ä»¥ä¸‹å°½é‡ç”¨å·¥ç¨‹è§†è§’è€Œä¸æ˜¯æ•™ç§‘ä¹¦è§†è§’è¯´æ˜ã€‚\nä¸€ã€B-Tree vs B+Treeï¼šæœ¬è´¨åŒºåˆ« 1ï¸âƒ£ å…ˆç»™ä¸€å¥è¯ç‰ˆç»“è®º B+Tree æ˜¯ä¸ºäº†æ•°æ®åº“è€Œç”Ÿçš„ B-Tree å˜ç§\n2ï¸âƒ£ ç»“æ„å¯¹æ¯”ï¼ˆæ ¸å¿ƒï¼‰ ğŸ”¹ B-Treeï¼ˆä¼ ç»Ÿï¼‰ éå¶å­èŠ‚ç‚¹ + å¶å­èŠ‚ç‚¹ ğŸ‘‰ éƒ½å­˜ key + value æŸ¥åˆ°ä¸­é—´èŠ‚ç‚¹å°±å¯èƒ½ç»“æŸ å¶å­èŠ‚ç‚¹ ä¸ä¸€å®šé“¾è¡¨ [10|20] / | \\ [1..9] [10..19] [20..30] ğŸ”¹ B+Treeï¼ˆæ•°æ®åº“å¸¸ç”¨ï¼‰ éå¶å­èŠ‚ç‚¹ï¼šåªå­˜ key + child pointer å¶å­èŠ‚ç‚¹ï¼šå­˜ key + value æ‰€æœ‰ value éƒ½åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹å½¢æˆæœ‰åºé“¾è¡¨ [10|20] / | \\ / | \\ [1..9] \u0026lt;-\u0026gt; [10..19] \u0026lt;-\u0026gt; [20..30] 3ï¸âƒ£ è¡Œä¸ºå·®å¼‚ï¼ˆé‡ç‚¹ï¼‰ å¯¹æ¯”é¡¹ B-Tree B+Tree æ•°æ®å­˜å‚¨ä½ç½® æ‰€æœ‰èŠ‚ç‚¹ åªåœ¨å¶å­èŠ‚ç‚¹ ä¸­é—´èŠ‚ç‚¹æ˜¯å¦å­˜æ•°æ® æ˜¯ å¦ æŸ¥è¯¢æ˜¯å¦å¯èƒ½æå‰ç»“æŸ æ˜¯ å¦ èŒƒå›´æŸ¥è¯¢ å·® éå¸¸å¥½ é¡ºåºéå† ä¸å‹å¥½ æå…¶é«˜æ•ˆ èŠ‚ç‚¹æ‰‡å‡ºï¼ˆfanoutï¼‰ è¾ƒå° æ›´å¤§ IO æ¬¡æ•° åå¤š æ›´å°‘ 4ï¸âƒ£ ä¸ºä»€ä¹ˆæ•°æ®åº“æ›´çˆ± B+Treeï¼Ÿ æ•°æ®åº“ 90% çš„æŸ¥è¯¢æ˜¯ï¼š\n"},{"id":149,"href":"/backend/bash/","title":"Bash","parent":"Backend","content":"Document List:\nBash æ ¸å¿ƒæ¦‚å¿µ ","description":"Document List:\nBash æ ¸å¿ƒæ¦‚å¿µ "},{"id":150,"href":"/backend/python/official/basic-operations/","title":"Basic Operations (åŸºæœ¬è¿ç®—)","parent":"Official","content":" âœ… 1. ç®—æœ¯è¿ç®—ï¼ˆArithmetic Operatorsï¼‰ è¿ç®—ç¬¦ è¯´æ˜ ç¤ºä¾‹ ç»“æœ + åŠ æ³• 3 + 2 5 - å‡æ³• 5 - 3 2 * ä¹˜æ³• 4 * 2 8 / é™¤æ³•ï¼ˆæ€»æ˜¯å¾—åˆ° floatï¼‰ 5 / 2 2.5 // æ•´é™¤ 5 // 2 2 % å–ä½™æ•° 5 % 2 1 ** å¹‚è¿ç®— 2 ** 3 8 å¸¸è§å‘ï¼š\n5 / 2 # 2.5 (æ°¸è¿œæ˜¯ float) True + 1 # 2 ï¼ˆå¸ƒå°”å€¼æ˜¯ 0 å’Œ 1ï¼‰ âœ… 2. æ¯”è¾ƒè¿ç®—ï¼ˆComparison Operatorsï¼‰ è¿ç®—ç¬¦ æ„ä¹‰ ç¤ºä¾‹ ç»“æœ == ç­‰äº 2 == 2 True != ä¸ç­‰äº 1 != 2 True \u0026gt; å¤§äº 5 \u0026gt; 3 True \u0026lt; å°äº 3 \u0026lt; 5 True \u0026gt;= â‰¥ 5 \u0026gt;= 5 True \u0026lt;= â‰¤ 3 \u0026lt;= 5 True âœ… 3. é€»è¾‘è¿ç®—ï¼ˆLogical Operatorsï¼‰ è¿ç®—ç¬¦ ç¤ºä¾‹ ç»“æœ and True and False False or True or False True not not True False çŸ­è·¯æœºåˆ¶ï¼š\na = None b = a or \u0026#34;default\u0026#34; # \u0026#34;default\u0026#34; âœ… 4. èµ‹å€¼è¿ç®—ï¼ˆAssignment Operatorsï¼‰ è¿ç®— ç¤ºä¾‹ ç­‰ä»· = x = 10 ç›´æ¥èµ‹å€¼ += x += 3 x = x + 3 -= x -= 2 x = x - 2 *= x *= 5 x = x * 5 /= x /= 2 x = x / 2 //= x //= 2 å‡çš„æ•´é™¤ %= x %= 3 å–ä½™ **= x **= 2 å¹‚ âœ… 5. æˆå‘˜è¿ç®—ï¼ˆMembership Operatorsï¼‰ è¿ç®—ç¬¦ ç¤ºä¾‹ ç»“æœ in \u0026quot;a\u0026quot; in \u0026quot;abc\u0026quot; True not in 3 not in [1,2] True âœ… 6. èº«ä»½è¿ç®—ï¼ˆIdentity Operatorsï¼‰ è¿ç®—ç¬¦ ç¤ºä¾‹ ç»“æœ is a is b æ˜¯å¦åŒä¸€ä¸ªå¯¹è±¡ is not a is not b å¦ï¼Ÿ ä¾‹ï¼š\na = [1,2] b = [1,2] a == b # True (å€¼ç›¸ç­‰) a is b # False (ä¸æ˜¯åŒä¸€å¯¹è±¡) âœ… 7. ä½è¿ç®—ï¼ˆBitwise Operatorsï¼‰ é€‚ç”¨äºæ•´æ•°ï¼š\nè¿ç®— å«ä¹‰ ç¤ºä¾‹ ç»“æœ \u0026amp; æŒ‰ä½ä¸ 5 \u0026amp; 3 1 | æŒ‰ä½æˆ– 5 | 3 7 ^ æŒ‰ä½å¼‚æˆ– 5 ^ 3 6 ~ æŒ‰ä½å–å ~5 -6 \u0026lt;\u0026lt; å·¦ç§» 5 \u0026lt;\u0026lt; 1 10 \u0026gt;\u0026gt; å³ç§» 5 \u0026gt;\u0026gt; 1 2 âœ… 8. å­—ç¬¦ä¸²è¿ç®—ï¼ˆString Operationsï¼‰ è¿ç®— ç¤ºä¾‹ ç»“æœ æ‹¼æ¥ \u0026quot;a\u0026quot; + \u0026quot;b\u0026quot; \u0026ldquo;ab\u0026rdquo; é‡å¤ \u0026quot;a\u0026quot; * 3 \u0026ldquo;aaa\u0026rdquo; æˆå‘˜ \u0026quot;a\u0026quot; in \u0026quot;abc\u0026quot; True å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜ï¼Œä¸èƒ½ï¼š\ns[0] = \u0026#34;x\u0026#34; # âŒ âœ… 9. åˆ—è¡¨è¿ç®—ï¼ˆList Operationsï¼‰ è¿ç®— ç¤ºä¾‹ æ‹¼æ¥ [1,2] + [3] é‡å¤ [0] * 3 -\u0026gt; [0,0,0] æˆå‘˜ 2 in [1,2,3] åˆ—è¡¨å¯å˜ï¼š\nlst.append(4) lst[0] = 99 âœ… 10. å­—å…¸è¿ç®—ï¼ˆDict Operationsï¼‰ æˆå‘˜ï¼ˆæ£€æŸ¥é”®ï¼‰ \u0026#34;a\u0026#34; in {\u0026#34;a\u0026#34;: 1} # True åˆå¹¶ {**a, **b} ğŸŒŸ 11. Python è¿ç®—çš„éšè—æœºåˆ¶ â‘  æ•´æ•°ç¼“å­˜ï¼ˆ-5 åˆ° 256ï¼‰ a = 100 b = 100 a is b # True â‘¡ çŸ­è·¯é€»è¾‘ï¼ˆæ€§èƒ½å¸¸ç”¨ï¼‰ x = a and b # å¦‚æœ a ä¸º Falseï¼Œç›´æ¥è¿”å› a â‘¢ å­—ç¬¦ä¸²é©»ç•™ï¼ˆinterningï¼‰ å°å­—ç¬¦ä¸²å¯èƒ½å…±äº«å¯¹è±¡ã€‚\nğŸš€ 12. Python è¿ç®—æœ€ä½³å®è·µ ä½¿ç”¨ += è€Œä¸æ˜¯ x = x + ... å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ joinï¼ˆé«˜æ€§èƒ½ï¼‰ ç”¨ // è€Œä¸æ˜¯ / å†è½¬ int æ•°å­—ç²¾åº¦æ¨èä½¿ç”¨ Decimal å­—å…¸åˆå¹¶ç”¨ {**a, **b} æˆ– a | bï¼ˆ3.9+ï¼‰ ğŸ’ 13. æœ€ç»ˆé€ŸæŸ¥æ€»ç»“ï¼ˆæ”¶è—ï¼‰\nç±»åˆ« ç¤ºä¾‹ ç®—æœ¯ +, -, *, /, //, %, ** æ¯”è¾ƒ == != \u0026gt; \u0026lt; \u0026gt;= \u0026lt;= é€»è¾‘ and or not èµ‹å€¼ += -= *= /= æˆå‘˜ in not in èº«ä»½ is is not ä½è¿ç®— \u0026amp; | ^ ~ \u0026lt;\u0026lt; \u0026gt;\u0026gt; ","description":" âœ… 1. ç®—æœ¯è¿ç®—ï¼ˆArithmetic Operatorsï¼‰ è¿ç®—ç¬¦ è¯´æ˜ ç¤ºä¾‹ ç»“æœ + åŠ æ³• 3 + 2 5 - å‡æ³• 5 - 3 2 * ä¹˜æ³• 4 * 2 8 / é™¤æ³•ï¼ˆæ€»æ˜¯å¾—åˆ° floatï¼‰ 5 / 2 2.5 // æ•´é™¤ 5 // 2 2 % å–ä½™æ•° 5 % 2 1 ** å¹‚è¿ç®— 2 ** 3 8 å¸¸è§å‘ï¼š\n"},{"id":151,"href":"/backend/python/beautiful-soup/","title":"Beautiful Soup","parent":"Python","content":"Directory List:\nBeautiful Soup åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ ","description":"Directory List:\nBeautiful Soup åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ "},{"id":152,"href":"/management/beyond/","title":"Beyond","parent":"Management","content":"Documents List:\nIT æŠ€èƒ½å­¦ä¹ ç³»ç»Ÿ ä»¥ç®¡ç†æ€ç»´å­¦ä¹ çŸ¥è¯† æ—¶é—´ç®¡ç† ","description":"Documents List:\nIT æŠ€èƒ½å­¦ä¹ ç³»ç»Ÿ ä»¥ç®¡ç†æ€ç»´å­¦ä¹ çŸ¥è¯† æ—¶é—´ç®¡ç† "},{"id":153,"href":"/backend/python/official/built-in-functions/","title":"Built-in Functions (å†…ç½®å‡½æ•°)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/library/functions.html\nè·å–å†…ç½®å‡½æ•°ï¼š\nimport builtins dir(builtins) ä¸‹é¢æ˜¯ å¯¹æ‰€æœ‰å†…ç½®å‡½æ•°æŒ‰â€œåŠŸèƒ½ç”¨é€”â€åˆ†ç±»ï¼Œå¹¶åœ¨æ¯ç±»ä¸­åšäº†æ¸…æ™°æ’åºï¼ˆæœ€å¸¸ç”¨ âœ æ¬¡å¸¸ç”¨ âœ è¾ƒå°‘ç”¨ï¼‰ã€‚\nğŸ“Œ ä¸€ã€æ•°å€¼ä¸æ•°å­¦è¿ç®— ï¼ˆç”¨äºæ•°å€¼è½¬æ¢ã€æ ¼å¼åŒ–ã€æ•°å­¦æ“ä½œï¼‰\næ’åºä¾æ®ï¼šä½¿ç”¨é¢‘ç‡ + å¸¸è§ç¨‹åº¦\nå‡½æ•° ç”¨é€” abs è¿”å›ç»å¯¹å€¼ round å››èˆäº”å…¥ divmod å•†ä¸ä½™æ•° pow ä¹˜æ–¹ï¼ˆç­‰ä»·äº **ï¼‰ max æœ€å¤§å€¼ min æœ€å°å€¼ sum æ±‚å’Œ hex åå…­è¿›åˆ¶å­—ç¬¦ä¸² oct å…«è¿›åˆ¶å­—ç¬¦ä¸² bin äºŒè¿›åˆ¶å­—ç¬¦ä¸² float è½¬æ¢ä¸ºæµ®ç‚¹æ•° int è½¬æ¢ä¸ºæ•´æ•° complex å¤æ•° ğŸ“Œ äºŒã€åºåˆ— / å¯è¿­ä»£å¯¹è±¡ å¤„ç† ï¼ˆéå†ã€ç»„åˆã€è¿‡æ»¤ã€æ’åºã€ç”Ÿæˆåºåˆ—ï¼‰\nâ‘  æ„é€ ä¸è½¬æ¢ âœ… å‡½æ•° ç”¨é€” list åˆ—è¡¨ tuple å…ƒç»„ set é›†åˆ frozenset ä¸å¯å˜é›†åˆ dict å­—å…¸ str å­—ç¬¦ä¸² â‘¡ è¿­ä»£ä¸éå† å‡½æ•° ç”¨é€” iter åˆ›å»ºè¿­ä»£å™¨ aiter å¼‚æ­¥è¿­ä»£å™¨ next è·å–ä¸‹ä¸€ä¸ªå…ƒç´  anext å¼‚æ­¥ next enumerate æšä¸¾(å¸¦ç´¢å¼•è¿­ä»£) zip èšåˆå¤šä¸ªå¯è¿­ä»£ reversed å€’åºè¿­ä»£ â‘¢ è¿‡æ»¤ / æ˜ å°„ / æ’åº âœ… å‡½æ•° ç”¨é€” map æ˜ å°„ filter è¿‡æ»¤ sorted æ’åº range æ•°å­—åºåˆ— ğŸ“Œ ä¸‰ã€é€»è¾‘åˆ¤æ–­ä¸ç±»å‹æ£€æŸ¥ ï¼ˆç±»å‹åˆ¤æ–­ã€å±æ€§åˆ¤æ–­ã€å¯è°ƒç”¨æ£€æŸ¥ï¼‰\nå‡½æ•° ç”¨é€” isinstance åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯æŸç±» issubclass åˆ¤æ–­æ˜¯å¦å­ç±» hasattr åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰å±æ€§ getattr è·å–å±æ€§ setattr è®¾ç½®å±æ€§ delattr åˆ é™¤å±æ€§ callable åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è°ƒç”¨ bool è½¬æ¢ä¸ºå¸ƒå°”å€¼ ğŸ“Œ å››ã€å¯¹è±¡ä¸ç±»ç›¸å…³ ï¼ˆé¢å‘å¯¹è±¡å·¥å…·ï¼‰\nå‡½æ•° ç”¨é€” object æ‰€æœ‰ç±»çš„åŸºç±» type è·å–ç±»å‹ / ç”Ÿæˆç±» property å±æ€§è£…é¥°å™¨ classmethod ç±»æ–¹æ³• staticmethod é™æ€æ–¹æ³• super è°ƒç”¨çˆ¶ç±»æ–¹æ³• ğŸ“Œ äº”ã€å­—ç¬¦ä¸²ä¸å­—ç¬¦å¤„ç† å‡½æ•° ç”¨é€” chr æ•°å­—è½¬å­—ç¬¦ ord å­—ç¬¦è½¬æ•°å­— ascii è½¬ ASCII è¡¨ç¤º repr è·å–å¯¹è±¡å¯æ‰“å°å­—ç¬¦ä¸² ğŸ“Œ å…­ã€è¾“å…¥è¾“å‡º I/O å‡½æ•° ç”¨é€” print æ‰“å°è¾“å‡º input è¾“å…¥ open æ‰“å¼€æ–‡ä»¶ ğŸ“Œ ä¸ƒã€è°ƒè¯•ä¸äº¤äº’ï¼ˆæ§åˆ¶å°ç›¸å…³ï¼‰ å‡½æ•° ç”¨é€” help æŸ¥çœ‹å¸®åŠ© dir æŸ¥çœ‹å¯¹è±¡æˆå‘˜ globals æŸ¥çœ‹å…¨å±€å˜é‡ locals æŸ¥çœ‹å±€éƒ¨å˜é‡ breakpoint è¿›å…¥è°ƒè¯•å™¨ id å¯¹è±¡å”¯ä¸€æ ‡è¯† vars å¯¹è±¡ __dict__ copyright æ˜¾ç¤ºç‰ˆæƒ credits è‡´è°¢ä¿¡æ¯ license è®¸å¯ä¿¡æ¯ exit/quit é€€å‡ºè§£é‡Šå™¨ ğŸ“Œ å…«ã€ç¼–è¯‘ä¸æ‰§è¡Œï¼ˆåŠ¨æ€ä»£ç ï¼‰ å‡½æ•° ç”¨é€” eval è®¡ç®—å­—ç¬¦ä¸²è¡¨è¾¾å¼ exec æ‰§è¡Œ Python ä»£ç  compile å°†å­—ç¬¦ä¸²ç¼–è¯‘æˆä»£ç å¯¹è±¡ ğŸ“Œ ä¹ã€å†…å­˜ä¸åº•å±‚ç»“æ„ å‡½æ•° ç”¨é€” bytes ä¸å¯å˜å­—èŠ‚åºåˆ— bytearray å¯å˜å­—èŠ‚åºåˆ— memoryview å†…å­˜è§†å›¾å¯¹è±¡ hash å“ˆå¸Œå€¼ ğŸ“Œ åã€å…¶å®ƒæ‚é¡¹ å‡½æ•° ç”¨é€” format å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼ˆåº•å±‚ï¼‰ ğŸ“š å…¨éƒ¨å†…ç½®å‡½æ•°åˆ†ç±»æ¸…å•ï¼ˆé€‚åˆå¤åˆ¶æ”¶è—ï¼‰ æ•°å­¦ä¸æ•°å€¼è¿ç®—: abs, round, divmod, pow, max, min, sum, hex, oct, bin, float, int, complex åºåˆ—ä¸è¿­ä»£: list, tuple, set, frozenset, dict, str, iter, aiter, next, anext, enumerate, zip, reversed, map, filter, sorted, range é€»è¾‘ä¸ç±»å‹æ£€æŸ¥: isinstance, issubclass, hasattr, getattr, setattr, delattr, callable, bool å¯¹è±¡ä¸ç±»: object, type, property, classmethod, staticmethod, super å­—ç¬¦ä¸å­—ç¬¦ä¸²: chr, ord, ascii, repr I/O è¾“å…¥è¾“å‡º: print, input, open è°ƒè¯•ä¸äº¤äº’: help, dir, globals, locals, breakpoint, id, vars, copyright, credits, license, exit, quit ç¼–è¯‘æ‰§è¡Œ: eval, exec, compile åº•å±‚å†…å­˜: bytes, bytearray, memoryview, hash å…¶ä»–: format ","description":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/library/functions.html\nè·å–å†…ç½®å‡½æ•°ï¼š\nimport builtins dir(builtins) ä¸‹é¢æ˜¯ å¯¹æ‰€æœ‰å†…ç½®å‡½æ•°æŒ‰â€œåŠŸèƒ½ç”¨é€”â€åˆ†ç±»ï¼Œå¹¶åœ¨æ¯ç±»ä¸­åšäº†æ¸…æ™°æ’åºï¼ˆæœ€å¸¸ç”¨ âœ æ¬¡å¸¸ç”¨ âœ è¾ƒå°‘ç”¨ï¼‰ã€‚\nğŸ“Œ ä¸€ã€æ•°å€¼ä¸æ•°å­¦è¿ç®— ï¼ˆç”¨äºæ•°å€¼è½¬æ¢ã€æ ¼å¼åŒ–ã€æ•°å­¦æ“ä½œï¼‰\næ’åºä¾æ®ï¼šä½¿ç”¨é¢‘ç‡ + å¸¸è§ç¨‹åº¦\nå‡½æ•° ç”¨é€” abs è¿”å›ç»å¯¹å€¼ round å››èˆäº”å…¥ divmod å•†ä¸ä½™æ•° pow ä¹˜æ–¹ï¼ˆç­‰ä»·äº **ï¼‰ max æœ€å¤§å€¼ min æœ€å°å€¼ sum æ±‚å’Œ hex åå…­è¿›åˆ¶å­—ç¬¦ä¸² oct å…«è¿›åˆ¶å­—ç¬¦ä¸² bin äºŒè¿›åˆ¶å­—ç¬¦ä¸² float è½¬æ¢ä¸ºæµ®ç‚¹æ•° int è½¬æ¢ä¸ºæ•´æ•° complex å¤æ•° ğŸ“Œ äºŒã€åºåˆ— / å¯è¿­ä»£å¯¹è±¡ å¤„ç† ï¼ˆéå†ã€ç»„åˆã€è¿‡æ»¤ã€æ’åºã€ç”Ÿæˆåºåˆ—ï¼‰\n"},{"id":154,"href":"/backend/python/official/built-in-types/","title":"Built-in Types (å†…ç½®ç±»å‹)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/library/stdtypes.html\nPython çš„â€œå†…ç½®ç±»å‹â€ï¼ˆBuilt-in Typesï¼‰æŒ‡ Python è¯­è¨€å†…ç½®ã€æ— éœ€å¯¼å…¥å³å¯ä½¿ç”¨çš„æ•°æ®ç±»å‹ã€‚å®ƒä»¬æ˜¯æ•´ä¸ªè¯­è¨€çš„åŸºç¡€ã€‚ä¸‹é¢æ˜¯ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿçš„ä¸€ä»½ Python å†…ç½®ç±»å‹æ€»è¡¨ã€‚\nğŸ§© Python å†…ç½®ç±»å‹æ€»è§ˆï¼ˆå®˜æ–¹åˆ†ç±»ï¼‰ Python å®˜æ–¹æ–‡æ¡£ï¼ŒæŠŠå†…ç½®ç±»å‹åˆ†ä¸º 6 å¤§ç±»ï¼š\n1. None ç±»å‹ ç±»å‹ è¯´æ˜ NoneType åªæœ‰ä¸€ä¸ªå€¼ï¼šNoneï¼ˆè¡¨ç¤ºç©ºã€ç¼ºå¤±ã€æ— è¿”å›ç»“æœï¼‰ ä½¿ç”¨åœºæ™¯ï¼šå‡½æ•°æ— è¿”å›å€¼ã€é»˜è®¤å‚æ•°ã€å ä½ç¬¦ç­‰ã€‚\n2. æ•°å€¼ç±»å‹ï¼ˆNumeric Typesï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ int æ•´æ•°ï¼ˆæ— é™ç²¾åº¦ï¼‰ 1, 9999999 float æµ®ç‚¹æ•°ï¼ˆåŒç²¾åº¦ï¼‰ 1.23, 3e10 complex å¤æ•° 3+4j bool å¸ƒå°”å€¼ï¼ˆint çš„å­ç±»ï¼‰ True, False é¢å¤–æ³¨æ„ï¼š\nbool æ˜¯ int çš„å­ç±»ï¼š\nisinstance(True, int) # True 3. åºåˆ—ç±»å‹ï¼ˆSequence Typesï¼‰ ğŸ“Œ æŒ‰æ˜¯å¦å¯å˜åˆ†ä¸¤ç±»\nâœ… ä¸å¯å˜åºåˆ— ç±»å‹ è¯´æ˜ ç¤ºä¾‹ str å­—ç¬¦ä¸² \u0026ldquo;hello\u0026rdquo; tuple å…ƒç»„ (1,2,3) bytes ä¸å¯å˜å­—èŠ‚åºåˆ— b\u0026quot;abc\u0026quot; ğŸ”§ å¯å˜åºåˆ— ç±»å‹ è¯´æ˜ ç¤ºä¾‹ list åˆ—è¡¨ [1, 2, 3] bytearray å¯å˜å­—èŠ‚åºåˆ— bytearray(b\u0026quot;abc\u0026quot;) æ‰€æœ‰åºåˆ—éƒ½æ”¯æŒï¼š\nç´¢å¼• x[0] åˆ‡ç‰‡ x[1:5] len(x) è¿­ä»£ in 4. é›†åˆç±»å‹ï¼ˆSet Typesï¼‰ ç±»å‹ å¯å˜ï¼Ÿ ç¤ºä¾‹ set âœ… å¯å˜ {1, 2, 3} frozenset âŒ ä¸å¯å˜ frozenset([1,2,3]) å¸¸ç”¨æ“ä½œï¼šäº¤å¹¶å·®ã€å»é‡ã€‚\n5. æ˜ å°„ç±»å‹ï¼ˆMapping Typesï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ dict å­—å…¸ï¼ˆå“ˆå¸Œè¡¨ï¼‰ {\u0026ldquo;a\u0026rdquo;:1, \u0026ldquo;b\u0026rdquo;:2} å­—å…¸æ˜¯ Python æœ€é‡è¦çš„æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚\n6. ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆContext Managerï¼‰ ä»–ä»¬ä¸æ˜¯â€œå…·ä½“ç±»å‹â€ï¼Œè€Œæ˜¯å®ç°äº†ï¼š\n__enter__ __exit__ å¸¸è§å†…ç½®ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š\nç±»å‹ ç¤ºä¾‹ æ–‡ä»¶å¯¹è±¡ with open(...) as f: é”å¯¹è±¡ with threading.Lock(): decimal ç¯å¢ƒ with decimal.localcontext(): 7. è¿­ä»£å™¨ä¸ç”Ÿæˆå™¨ç±»å‹ï¼ˆIterator / Generatorï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ range æƒ°æ€§åºåˆ— range(10) enumerate æšä¸¾å¯¹è±¡ enumerate(lst) zip æƒ°æ€§ç»„åˆ zip(a,b) map æƒ°æ€§æ˜ å°„ map(f, xs) filter æƒ°æ€§è¿‡æ»¤ filter(f, xs) generator ç”Ÿæˆå™¨ yield äº§ç”Ÿçš„å¯¹è±¡ åªè¦å¯¹è±¡å®ç°ï¼š\n__iter__ __next__ å°±å±äºâ€œè¿­ä»£å™¨ç±»åˆ«â€ã€‚\n8. å‡½æ•°ã€ç±»ã€æ¨¡å—ç­‰ è¿™äº›ä¹Ÿå±äºå†…ç½®ç±»å‹ï¼Œåªæ˜¯å¸¸è¢«å¿½ç•¥ã€‚\nç±»å‹ è¯´æ˜ function æ™®é€šå‡½æ•° builtin_function_or_method å†…ç½®å‡½æ•°ï¼Œå¦‚ len() method æ–¹æ³• type ç±»ï¼ˆç±»æœ¬èº«ä¹Ÿæ˜¯å¯¹è±¡ï¼‰ module æ¨¡å—å¯¹è±¡ code å‡½æ•°å¯¹åº”çš„ä»£ç å¯¹è±¡ frame è¿è¡Œå¸§å¯¹è±¡ memoryview å†…å­˜è§†å›¾ï¼ˆé›¶æ‹·è´ï¼‰ â˜˜ï¸ Python å†…ç½®ç±»å‹ä¸€è§ˆå›¾ï¼ˆå¿«é€Ÿè®°å¿†ï¼‰ None æ•°å€¼ï¼šint, float, complex, bool åºåˆ—ï¼š ä¸å¯å˜ï¼šstr, tuple, bytes å¯å˜ï¼šlist, bytearray é›†åˆï¼šset, frozenset æ˜ å°„ï¼šdict æƒ°æ€§ï¼šrange, map, filter, zip, enumerate, generator å‡½æ•°ä¸ç±»ï¼šfunction, type, method å…¶ä»–ï¼šmodule, memoryview, file, context manager ç­‰ ","description":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/library/stdtypes.html\nPython çš„â€œå†…ç½®ç±»å‹â€ï¼ˆBuilt-in Typesï¼‰æŒ‡ Python è¯­è¨€å†…ç½®ã€æ— éœ€å¯¼å…¥å³å¯ä½¿ç”¨çš„æ•°æ®ç±»å‹ã€‚å®ƒä»¬æ˜¯æ•´ä¸ªè¯­è¨€çš„åŸºç¡€ã€‚ä¸‹é¢æ˜¯ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿçš„ä¸€ä»½ Python å†…ç½®ç±»å‹æ€»è¡¨ã€‚\nğŸ§© Python å†…ç½®ç±»å‹æ€»è§ˆï¼ˆå®˜æ–¹åˆ†ç±»ï¼‰ Python å®˜æ–¹æ–‡æ¡£ï¼ŒæŠŠå†…ç½®ç±»å‹åˆ†ä¸º 6 å¤§ç±»ï¼š\n1. None ç±»å‹ ç±»å‹ è¯´æ˜ NoneType åªæœ‰ä¸€ä¸ªå€¼ï¼šNoneï¼ˆè¡¨ç¤ºç©ºã€ç¼ºå¤±ã€æ— è¿”å›ç»“æœï¼‰ ä½¿ç”¨åœºæ™¯ï¼šå‡½æ•°æ— è¿”å›å€¼ã€é»˜è®¤å‚æ•°ã€å ä½ç¬¦ç­‰ã€‚\n2. æ•°å€¼ç±»å‹ï¼ˆNumeric Typesï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ int æ•´æ•°ï¼ˆæ— é™ç²¾åº¦ï¼‰ 1, 9999999 float æµ®ç‚¹æ•°ï¼ˆåŒç²¾åº¦ï¼‰ 1.23, 3e10 complex å¤æ•° 3+4j bool å¸ƒå°”å€¼ï¼ˆint çš„å­ç±»ï¼‰ True, False é¢å¤–æ³¨æ„ï¼š\n"},{"id":155,"href":"/categories/","title":"Categories","parent":"Documents","content":"","description":""},{"id":156,"href":"/backend/python/official/class/","title":"Class (ç±»)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/tutorial/classes.html\nğŸš€ 1. Python ç±»æ˜¯ä»€ä¹ˆï¼Ÿ ç±»ï¼ˆclassï¼‰æ˜¯ Python ä¸­ å°è£…æ•°æ®ï¼ˆå±æ€§ï¼‰å’Œè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ çš„æ ¸å¿ƒå·¥å…·ã€‚\nå®ä¾‹ï¼ˆobjectï¼‰æ˜¯ç±»çš„å…·ä½“å¯¹è±¡ã€‚\nä¾‹ï¼š\nclass User: def __init__(self, name): self.name = name u = User(\u0026#34;jack\u0026#34;) ğŸ“Œ 2. ç±»çš„åŸºç¡€ç»“æ„ class MyClass: class_var = 123 # ç±»å˜é‡ def __init__(self, x): # æ„é€ å‡½æ•° self.x = x # å®ä¾‹å˜é‡ def method(self): # å®ä¾‹æ–¹æ³• return self.x * 2 @classmethod def cmethod(cls): # ç±»æ–¹æ³• return cls.class_var @staticmethod def smethod(a, b): # é™æ€æ–¹æ³• return a + b @property def doubled(self): # è®¡ç®—å±æ€§ return self.x * 2 ğŸ“¦ 3. ç±»çš„å››ç§æ–¹æ³•ç±»å‹ï¼ˆéå¸¸é‡è¦ï¼‰ æ–¹æ³•ç±»å‹ è‡ªåŠ¨ä¼ å…¥ ç”¨é€” æ™®é€šæ–¹æ³• selfï¼ˆå®ä¾‹ï¼‰ æ“ä½œå®ä¾‹æ•°æ® ç±»æ–¹æ³• clsï¼ˆç±»ï¼‰ å·¥å‚æ–¹æ³•ã€è®¿é—®ç±»å±æ€§ã€å­ç±»é€‚é… é™æ€æ–¹æ³• æ—  å·¥å…·å‡½æ•°ï¼Œä¸ç±»æœ‰å…³ä½†ä¸éœ€è¦å®ä¾‹ property self ä¼˜é›…è®¿é—®è®¡ç®—å±æ€§ staticmethod / classmethod / property å°±æ˜¯è¿™ä¸ªéƒ¨åˆ†ã€‚\nğŸ¯ 4. æ„é€ å‡½æ•°ï¼ˆ__init__ï¼‰ æ„é€ å‡½æ•°åœ¨åˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨æ‰§è¡Œï¼š\nclass User: def __init__(self, name, age=18): self.name = name self.age = age ğŸ§± 5. ç±»å˜é‡ vs å®ä¾‹å˜é‡ å®ä¾‹å˜é‡ï¼ˆæ¯ä¸ªå¯¹è±¡ç‹¬ç«‹ï¼‰\nself.name ç±»å˜é‡ï¼ˆæ‰€æœ‰å¯¹è±¡å…±äº«ï¼‰\nUser.role = \u0026#34;guest\u0026#34; âš ï¸ ä¸è¦æ»¥ç”¨ç±»å˜é‡ï¼ˆå…¨å±€å…±äº«æ•°æ®å®¹æ˜“å¸¦æ¥çŠ¶æ€æ±¡æŸ“ï¼‰ã€‚\nâ˜˜ï¸ 6. ç»§æ‰¿ï¼ˆinheritanceï¼‰ class Animal: def speak(self): return \u0026#34;...\u0026#34; class Dog(Animal): def speak(self): return \u0026#34;woof\u0026#34; ğŸ“Œ 7. super() ç”¨æ³• è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼š\nclass Admin(User): def __init__(self, name): super().__init__(name) self.role = \u0026#34;admin\u0026#34; ğŸ”§ 8. é­”æœ¯æ–¹æ³•ï¼ˆMagic Methodsï¼‰ é­”æœ¯æ–¹æ³•å¯ä»¥è®©ç±»è¡¨ç°å¾—åƒå†…ç½®ç±»å‹ã€‚\nå¸¸ç”¨çš„ï¼š\n| æ–¹æ³• | åŠŸèƒ½ | | __str__ | æ‰“å°å¯è¯»å­—ç¬¦ä¸² | | __repr__ | è°ƒè¯•å‹å¥½çš„è¡¨ç¤º | | __len__ | len(obj) | | __getitem__ | æ”¯æŒç´¢å¼•è®¿é—® | | __setitem__ | æ”¯æŒ obj[key] = value | | __iter__ | å¯è¿­ä»£ | | __next__ | è¿­ä»£å™¨ | | __enter__ / __exit__ | ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆwithï¼‰ |\nä¾‹ï¼š\nclass Counter: def __init__(self, n): self.n = n def __len__(self): return self.n ğŸš¦ 9. dataclass Python çš„æœ€ä¼˜é›…çš„æ•°æ®å¯¹è±¡å†™æ³•ã€‚\nfrom dataclasses import dataclass @dataclass class Stock: code: str name: str price: float è‡ªåŠ¨ç”Ÿæˆï¼š\n__init__ __repr__ __eq__ ç»“æ„åŒ–æ”¯æŒ âš™ï¸ 10. ç±»çš„é«˜çº§ç”¨æ³• 10.1 å·¥å‚æ–¹æ³•ï¼ˆclassmethodï¼‰ class User: @classmethod def from_dict(cls, data): return cls(data[\u0026#34;name\u0026#34;]) 10.2 å°è£…è®¡ç®—å­—æ®µï¼ˆpropertyï¼‰ class Stock: def __init__(self, code): self.code = code @property def market(self): return \u0026#34;SZ\u0026#34; if self.code.startswith(\u0026#34;00\u0026#34;) else \u0026#34;SH\u0026#34; 10.3 å•ä¾‹æ¨¡å¼ class Singleton: _instance = None @classmethod def instance(cls): if cls._instance is None: cls._instance = cls() return cls._instance 10.4 ç±»ä½œä¸ºå‘½åç©ºé—´ï¼ˆé‡‘å…¸å†™æ³•ï¼‰ ä½ å¯ä»¥æŠŠä¸€å †å·¥å…·å‡½æ•°æ”¾å…¥ç±»ä¸­ï¼Œä¸å®ä¾‹åŒ–ï¼š\nclass StringUtils: @staticmethod def is_empty(s): return not s ğŸª› 11. Python ç±» vs å‡½æ•°ï¼šä½•æ—¶ç”¨ç±»ï¼Ÿ ç”¨ç±»çš„åœºæ™¯ï¼š\néœ€è¦ä¿å­˜çŠ¶æ€ éœ€è¦åä½œå¤šä¸ªæ–¹æ³• å¯¹è±¡éœ€è¦å…·å¤‡å¤šç§è¡Œä¸º éœ€è¦ property / staticmethod / classmethod éœ€è¦ç»§æ‰¿ / å¤šæ€ å¤æ‚å¯¹è±¡å»ºæ¨¡ï¼ˆä½ å¸¸ç”¨çš„ stock/news æ•°æ®ï¼‰ ç”¨å‡½æ•°çš„åœºæ™¯ï¼š\nå•ä¸€é€»è¾‘ æ— çŠ¶æ€ å·¥å…·å‡½æ•°ï¼ˆå¦‚ä½  utils ä¸­çš„å¤§éƒ¨åˆ†ï¼‰ ğŸ§© 12. åœ¨å·¥ç¨‹ä¸­å¦‚ä½•æ­£ç¡®ä½¿ç”¨ç±»ï¼ˆé’ˆå¯¹ä½ çš„é¡¹ç›®ï¼‰ ä½  FastAPI + SQLAlchemy é¡¹ç›®é‡Œç±»ä¸»è¦ç”¨é€”ï¼š\næ¨¡å‹ç±»ï¼ˆSQLAlchemy ORMï¼‰ class User(Base): æ•°æ®å¯¹è±¡ï¼ˆdataclassï¼‰ @dataclass class NewsDetail: å·¥å…·ç±»ï¼ˆstatic/class methodsï¼‰ class StockUtils: @staticmethod def normalize(code): ... é…ç½®ç±» class AppConfig: Handler / Service å±‚ class NewsService: def get_news(self): ... â˜˜ï¸ 13. Python ç±»çš„å¸¸è§é™·é˜± âŒ åœ¨ç±»ä¸­æ»¥ç”¨å…¨å±€å˜é‡ âŒ ç”¨é™æ€æ–¹æ³•å­˜å‚¨çŠ¶æ€ âŒ è¿‡åº¦é¢å‘å¯¹è±¡ âŒ å·¥å…·ç±»ä½¿ç”¨å®ä¾‹æ–¹æ³• âŒ é­”æœ¯æ–¹æ³•æ»¥ç”¨å¯¼è‡´å¯è¯»æ€§å·® âŒ è¯¯ç”¨ç±»å˜é‡å¯¼è‡´å…±äº«æ•°æ®æ±¡æŸ“ âŒ ä¸å†™ç±»å‹æ³¨è§£ï¼ˆä½ ä¸ä¼šï¼‰ ğŸ† 14. æœ€ç»ˆæ€»ç»“ï¼ˆé€‚åˆæ”¶è—ï¼‰ ğŸ§© Python ç±»æ ¸å¿ƒç»“æ„ å±æ€§ï¼ˆå˜é‡ï¼‰ è¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ æ„é€ ï¼ˆ__init__ï¼‰ é™æ€æ–¹æ³•ï¼ˆæ— selfï¼‰ ç±»æ–¹æ³•ï¼ˆclsï¼‰ propertyï¼ˆè®¡ç®—å±æ€§ï¼‰ é­”æœ¯æ–¹æ³•ï¼ˆåè®®ï¼‰ ç»§æ‰¿ \u0026amp; super dataclassï¼ˆæ•°æ®ç±»ï¼‰ ğŸ§© ä»€ä¹ˆæ—¶å€™ç”¨ç±»ï¼Ÿ æœ‰çŠ¶æ€ -\u0026gt; ç”¨ç±» æ— çŠ¶æ€ -\u0026gt; ç”¨å‡½æ•° æœ‰è¡Œä¸ºç»„åˆ -\u0026gt; ç”¨ç±» éœ€è¦ç»§æ‰¿æ‰©å±• -\u0026gt; ç”¨ç±» ğŸ§© å·¥ç¨‹ä½¿ç”¨ç±»çš„ä¸‰å¤§åœºæ™¯ æ•°æ®å»ºæ¨¡ï¼ˆORM / dataclassï¼‰ å·¥å…·ç±»ï¼ˆstatic/classï¼‰ æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘å°è£…ï¼‰ ","description":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/tutorial/classes.html\nğŸš€ 1. Python ç±»æ˜¯ä»€ä¹ˆï¼Ÿ ç±»ï¼ˆclassï¼‰æ˜¯ Python ä¸­ å°è£…æ•°æ®ï¼ˆå±æ€§ï¼‰å’Œè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ çš„æ ¸å¿ƒå·¥å…·ã€‚\nå®ä¾‹ï¼ˆobjectï¼‰æ˜¯ç±»çš„å…·ä½“å¯¹è±¡ã€‚\nä¾‹ï¼š\nclass User: def __init__(self, name): self.name = name u = User(\u0026#34;jack\u0026#34;) ğŸ“Œ 2. ç±»çš„åŸºç¡€ç»“æ„ class MyClass: class_var = 123 # ç±»å˜é‡ def __init__(self, x): # æ„é€ å‡½æ•° self.x = x # å®ä¾‹å˜é‡ def method(self): # å®ä¾‹æ–¹æ³• return self.x * 2 @classmethod def cmethod(cls): # ç±»æ–¹æ³• return cls.class_var @staticmethod def smethod(a, b): # é™æ€æ–¹æ³• return a + b @property def doubled(self): # è®¡ç®—å±æ€§ return self.x * 2 ğŸ“¦ 3. ç±»çš„å››ç§æ–¹æ³•ç±»å‹ï¼ˆéå¸¸é‡è¦ï¼‰ æ–¹æ³•ç±»å‹ è‡ªåŠ¨ä¼ å…¥ ç”¨é€” æ™®é€šæ–¹æ³• selfï¼ˆå®ä¾‹ï¼‰ æ“ä½œå®ä¾‹æ•°æ® ç±»æ–¹æ³• clsï¼ˆç±»ï¼‰ å·¥å‚æ–¹æ³•ã€è®¿é—®ç±»å±æ€§ã€å­ç±»é€‚é… é™æ€æ–¹æ³• æ—  å·¥å…·å‡½æ•°ï¼Œä¸ç±»æœ‰å…³ä½†ä¸éœ€è¦å®ä¾‹ property self ä¼˜é›…è®¿é—®è®¡ç®—å±æ€§ staticmethod / classmethod / property å°±æ˜¯è¿™ä¸ªéƒ¨åˆ†ã€‚\n"},{"id":157,"href":"/backend/python/official/closure/","title":"Closure (é—­åŒ…)","parent":"Official","content":" âœ… ä¸€ã€ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿï¼ˆæ¦‚å¿µï¼‰ é—­åŒ… = å†…å±‚å‡½æ•° + æ•è·çš„å¤–å±‚å˜é‡ï¼ˆç¯å¢ƒï¼‰\nå³ï¼šå‡½æ•°è®°ä½äº†å®šä¹‰æ—¶çš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ—¶çš„ä½œç”¨åŸŸã€‚\nâœ… äºŒã€æœ€ç»å…¸ç¤ºä¾‹ def make_adder(x): def adder(y): return x + y # ä½¿ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡ x return adder add10 = make_adder(10) print(add10(5)) # 15 âœ… adder() å†…éƒ¨ç”¨åˆ°äº†å¤–éƒ¨å‡½æ•° make_adder() çš„å˜é‡ x\nâœ… å³ä½¿ make_adder() å·²ç»æ‰§è¡Œå®Œï¼Œadder() ä»ç„¶ä¿ç•™ x=10\nè¿™å°±æ˜¯é—­åŒ…ã€‚\nâœ… ä¸‰ã€é—­åŒ…çš„ä¸‰ä¸ªç‰¹å¾ è¦æˆä¸ºé—­åŒ…ï¼Œå¿…é¡»æ»¡è¶³ï¼š\nå¤–å±‚å‡½æ•°æœ‰å±€éƒ¨å˜é‡ å†…å±‚å‡½æ•°ä½¿ç”¨äº†è¿™ä¸ªå±€éƒ¨å˜é‡ å¤–å±‚å‡½æ•°è¿”å›å†…å±‚å‡½æ•° ä¾‹å¦‚ï¼š\ndef outer(): x = 100 def inner(): print(x) return inner âœ… å››ã€ä¸ºä»€ä¹ˆéœ€è¦é—­åŒ…ï¼Ÿï¼ˆç”¨é€”ï¼‰ 4.1 è®°ä½çŠ¶æ€ï¼ˆä¸ç”¨ç±»ä¹Ÿèƒ½å®ç°â€œå¸¦çŠ¶æ€çš„å‡½æ•°â€ï¼‰ def counter(): count = 0 def inc(): nonlocal count count += 1 return count return inc c = counter() print(c()) # 1 print(c()) # 2 4.2 æ›¿ä»£ç±»çš„ç®€æ˜“æ•°æ®å­˜å‚¨ def make_db_conn(url): def query(sql): print(\u0026#34;connect:\u0026#34;, url) return f\u0026#34;run SQL: {sql}\u0026#34; return query db = make_db_conn(\u0026#34;postgres://root\u0026#34;) db(\u0026#34;SELECT 1\u0026#34;) 4.3 è£…é¥°å™¨åº•å±‚ä¾èµ–é—­åŒ… def logger(fn): def wrapper(*args, **kwargs): print(\u0026#34;calling:\u0026#34;, fn.__name__) return fn(*args, **kwargs) return wrapper 4.4 å·¥å‚å‡½æ•°ï¼ˆè¿”å›å¸¦é…ç½®çš„å‡½æ•°ï¼‰ def multiply(n): return lambda x: x * n double = multiply(2) print(double(10)) # 20 âœ… äº”ã€é—­åŒ…å˜é‡ä¸ºä»€ä¹ˆä¼šâ€œè®°ä½å€¼â€ï¼Ÿ Python çš„å‡½æ•°å¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§ï¼š__closure__\nadd10 = make_adder(10) print(add10.__closure__) è¾“å‡ºç±»ä¼¼ï¼š\n(\u0026lt;cell at 0x...: int object at 0x...\u0026gt;,) é—­åŒ…ä¸­çš„å˜é‡å‚¨å­˜åœ¨ cell ä¸­ï¼Œä¸ä¼šå› ä¸ºå¤–å±‚å‡½æ•°ç»“æŸè€Œé”€æ¯ã€‚\nâœ… å…­ã€nonlocal çš„ç”¨é€” é—­åŒ…ä¸­å¦‚æœè¦ä¿®æ”¹å¤–éƒ¨å˜é‡ï¼Œå¿…é¡»åŠ  nonlocalï¼š\ndef counter(): n = 0 def inc(): nonlocal n n += 1 return n return inc å¦åˆ™ Python ä¼šè®¤ä¸ºä½ åœ¨å®šä¹‰æ–°çš„å±€éƒ¨å˜é‡ã€‚\nâœ… ä¸ƒã€é—­åŒ…çš„é«˜çº§é—®é¢˜ï¼šå¾ªç¯ä¸­å˜é‡æ•è·ï¼ˆå‘ç‚¹ï¼‰ å¸¸è§å‘ï¼š\nfuncs = [] for i in range(5): funcs.append(lambda: i) print([f() for f in funcs]) è¾“å‡ºï¼š\n[4, 4, 4, 4, 4] å› ä¸º i æœ€ç»ˆå˜æˆäº† 4ã€‚\næ­£ç¡®æ–¹å¼ï¼š\n7.1 é»˜è®¤å‚æ•°ç»‘å®š funcs = [] for i in range(5): funcs.append(lambda i=i: i) 7.2 ç”¨ partial from functools import partial funcs = [partial(lambda x: x, i) for i in range(5)] âœ… å…«ã€é—­åŒ… vs lambda çš„å…³ç³» lambda ä¹Ÿæ˜¯å‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿèƒ½äº§ç”Ÿé—­åŒ…ï¼š\ndef make(): x = 3 return lambda y: x + y é—­åŒ…ä¸æ˜¯ lambda çš„ä¸“å±ï¼Œä¹Ÿä¸æ˜¯å‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§ï¼Œä½†åœ¨ Python é‡Œéå¸¸å¸¸ç”¨ã€‚\nâœ… ä¹ã€å®æˆ˜ï¼šæ„é€ å¸¦ç¼“å­˜ cache çš„å‡½æ•° æ¯”å¦‚ä½ çš„çˆ¬è™«é‡Œå¯ä»¥è¿™æ ·ç”¨ï¼š\ndef with_cache(fn): cache = {} def wrapper(x): if x in cache: return cache[x] cache[x] = fn(x) return cache[x] return wrapper @with_cache def slow_fn(x): time.sleep(1) return x * 2 é—­åŒ…è®© cache æ°¸è¿œä¿ç•™ã€‚\n","description":" âœ… ä¸€ã€ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿï¼ˆæ¦‚å¿µï¼‰ é—­åŒ… = å†…å±‚å‡½æ•° + æ•è·çš„å¤–å±‚å˜é‡ï¼ˆç¯å¢ƒï¼‰\nå³ï¼šå‡½æ•°è®°ä½äº†å®šä¹‰æ—¶çš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ—¶çš„ä½œç”¨åŸŸã€‚\nâœ… äºŒã€æœ€ç»å…¸ç¤ºä¾‹ def make_adder(x): def adder(y): return x + y # ä½¿ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡ x return adder add10 = make_adder(10) print(add10(5)) # 15 âœ… adder() å†…éƒ¨ç”¨åˆ°äº†å¤–éƒ¨å‡½æ•° make_adder() çš„å˜é‡ x\nâœ… å³ä½¿ make_adder() å·²ç»æ‰§è¡Œå®Œï¼Œadder() ä»ç„¶ä¿ç•™ x=10\nè¿™å°±æ˜¯é—­åŒ…ã€‚\nâœ… ä¸‰ã€é—­åŒ…çš„ä¸‰ä¸ªç‰¹å¾ è¦æˆä¸ºé—­åŒ…ï¼Œå¿…é¡»æ»¡è¶³ï¼š\n"},{"id":158,"href":"/backend/python/official/collections/","title":"Collections (å¢å¼ºæ•°æ®ç»“æ„)","parent":"Official","content":"collections æ˜¯ Python æ ‡å‡†åº“ä¸­åŠŸèƒ½æœ€å¼ºçš„â€œå¢å¼ºæ•°æ®ç»“æ„â€æ¨¡å—ã€‚\næä¾›æ¯” list / dict / tuple æ›´ä¸“ä¸šçš„æ•°æ®ç±»å‹ã€‚\nğŸ“¦ 1. å…¨éƒ¨æ•°æ®ç»“æ„é€ŸæŸ¥è¡¨ åç§° ç±»å‹ ä½œç”¨ namedtuple å…ƒç»„å­ç±» å…·åå­—æ®µï¼Œè½»é‡ç»“æ„ä½“ deque åŒç«¯é˜Ÿåˆ— å¿«é€Ÿ append/popï¼Œé€‚åˆé˜Ÿåˆ— FIFO/LIFO Counter è®¡æ•°å™¨ ç”¨äºé¢‘æ¬¡ç»Ÿè®¡ï¼ˆå­—ç¬¦ä¸²ã€åˆ—è¡¨ï¼‰ OrderedDict æœ‰åºå­—å…¸ï¼ˆPy3.7+ dict ä¹Ÿæœ‰åºï¼‰ ä¸“ä¸šå­—å…¸æ“ä½œ defaultdict é»˜è®¤å€¼å­—å…¸ è®¿é—®ä¸å­˜åœ¨ key æ—¶è‡ªåŠ¨åˆ›å»ºå€¼ ChainMap å¤š dict åˆå¹¶è§†å›¾ å¤šå±‚é…ç½®ç»„åˆã€ä½œç”¨åŸŸé“¾ UserDict / UserList / UserString å¯ç»§æ‰¿å®¹å™¨ è®©å®¹å™¨æ›´å®¹æ˜“è¢«ç»§æ‰¿ã€æ‰©å±• ğŸŸ¥ 2. namedtuple â€” è½»é‡æ•°æ®ç»“æ„ä½“ æœ€ä½³åœºæ™¯ï¼š\næ›¿ä»£ class æ›¿ä»£ dict è½»é‡ã€ä¸å¯å˜ã€å†…å­˜å ç”¨å° from collections import namedtuple Point = namedtuple(\u0026#34;Point\u0026#34;, [\u0026#34;x\u0026#34;, \u0026#34;y\u0026#34;]) p = Point(3, 4) print(p.x, p.y) ç‰¹ç‚¹ï¼š\næ”¯æŒç´¢å¼• æ”¯æŒå±æ€§è®¿é—® æ”¯æŒè§£åŒ… ä¸å¯å˜ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ ğŸŸ¦ 3. deque â€” æœ€å¼ºé˜Ÿåˆ—ç»“æ„ list.append/pop åœ¨å¤´éƒ¨æ“ä½œå¾ˆæ…¢\ndeque åœ¨ä¸¤ç«¯éƒ½ O(1)\nfrom collections import deque dq = deque([1, 2, 3]) dq.append(4) dq.appendleft(0) print(dq) å¸¸ç”¨æ–¹æ³•ï¼š\nappend, appendleft pop, popleft rotate(n) å³ç§» n ä½ï¼šrotate(1) é€‚åˆï¼š\né˜Ÿåˆ— FIFO æ ˆ LIFO æ»‘åŠ¨çª—å£ ğŸŸ© 4. Counter â€” è®¡æ•°ç¥å™¨ ç»Ÿè®¡å­—ç¬¦é¢‘ç‡ï¼š\nfrom collections import Counter c = Counter(\u0026#34;aabbbbccd\u0026#34;) print(c) è¾“å‡ºï¼š\nCounter({\u0026#39;b\u0026#39;: 4, \u0026#39;a\u0026#39;: 2, \u0026#39;c\u0026#39;: 2, \u0026#39;d\u0026#39;: 1}) å…¶ä»–æ–¹æ³•ï¼š\nc.most_common(2) å¹¶é›† + äº¤é›†æ“ä½œï¼š\nCounter(\u0026#34;abbc\u0026#34;) \u0026amp; Counter(\u0026#34;abccc\u0026#34;) # äº¤é›† Counter(\u0026#34;abbc\u0026#34;) | Counter(\u0026#34;abccc\u0026#34;) # å¹¶é›† ğŸŸª 5. defaultdict â€” è‡ªåŠ¨å¡«å……é»˜è®¤å€¼ æ— éœ€æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨ã€‚\nfrom collections import defaultdict d = defaultdict(list) d[\u0026#34;a\u0026#34;].append(1) d[\u0026#34;a\u0026#34;].append(2) print(d) é€‚åˆï¼š\nåˆ†ç»„ï¼ˆgroupbyï¼‰ èšåˆç»Ÿè®¡ å¤æ‚ JSON ç”Ÿæˆ ç¤ºä¾‹ï¼šæŒ‰åå­—é¦–å­—æ¯åˆ†ç»„ï¼š\ngroups = defaultdict(list) for name in [\u0026#34;apple\u0026#34;, \u0026#34;banana\u0026#34;, \u0026#34;avocado\u0026#34;]: groups[name[0]].append(name) ğŸŸ¨ 6. OrderedDict â€” ä¸“ä¸šçº§å­—å…¸ Python 3.7+ çš„å†…ç½® dict é»˜è®¤æœ‰åºï¼Œä½† OrderedDict ä»æœ‰å¼ºåŠŸèƒ½ï¼š\nâ‘  move_to_end() from collections import OrderedDict od = OrderedDict([(\u0026#34;a\u0026#34;, 1), (\u0026#34;b\u0026#34;, 2)]) od.move_to_end(\u0026#34;a\u0026#34;) print(od) â‘¡ LRU ç¼“å­˜ è‡ªå·±å†™ od = OrderedDict() def put(k, v): if k in od: od.move_to_end(k) od[k] = v if len(od) \u0026gt; 3: od.popitem(last=False) put(\u0026#34;a\u0026#34;,1) put(\u0026#34;b\u0026#34;,2) put(\u0026#34;c\u0026#34;,3) put(\u0026#34;a\u0026#34;,4) # a æœ€è¿‘è®¿é—® put(\u0026#34;d\u0026#34;,5) # å¼¹å‡º b ğŸŸ§ 7. ChainMap â€” å¤š dict ç»„åˆè§†å›¾ åº”ç”¨åœºæ™¯ï¼š\nå¤šå±‚å˜é‡ä½œç”¨åŸŸ å¤šé…ç½®æ–‡ä»¶åˆå¹¶ é€çº§æŸ¥æ‰¾ ç¤ºä¾‹ï¼š\nfrom collections import ChainMap defaults = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2} user = {\u0026#34;b\u0026#34;: 20, \u0026#34;c\u0026#34;: 30} cm = ChainMap(user, defaults) print(cm[\u0026#34;b\u0026#34;]) # 20 (æ¥è‡ªç”¨æˆ·) print(cm[\u0026#34;a\u0026#34;]) # 1 (æ¥è‡ªé»˜è®¤) ä¸ä¼šåˆ›å»ºæ–° dictï¼ŒæŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ã€‚\nğŸŸ« 8. UserDict / UserList / UserString â€” å¯ç»§æ‰¿å®¹å™¨ æƒ³ç»§æ‰¿ dict ä½†ä¸æƒ³è¸©å‘ï¼Ÿ\nç”¨ UserDictï¼š\nfrom collections import UserDict class MyDict(UserDict): def keys_upper(self): return [k.upper() for k in self.keys()] d = MyDict({\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}) print(d.keys_upper()) ä¸ºä½•ä¸ç”¨ç»§æ‰¿å†…ç½® dictï¼Ÿ\nå†…ç½®ç±»å‹æœ‰ C å®ç°é€»è¾‘ï¼Œä¸èƒ½å®Œå…¨é‡å†™è¡Œä¸º UserDict ç”¨ Python å®ç°ï¼Œé€‚åˆæ‰©å±• â­ 9. å®æˆ˜ï¼šæ–°é—»èšåˆï¼ˆä½ å¯ç”¨äºé‡‘èçˆ¬è™«ï¼‰ æŒ‰ module åˆ†ç»„æ–°é—»ï¼š\ngroups = defaultdict(list) for item in data: groups[item[\u0026#34;module\u0026#34;]].append(item) ç»Ÿè®¡æ ‡é¢˜å‡ºç°é¢‘æ¬¡ï¼š\nfrom collections import Counter count = Counter(item[\u0026#34;title\u0026#34;] for item in data) print(count.most_common(5)) â­ 10. å®æˆ˜ï¼šé˜Ÿåˆ— + æ»‘åŠ¨çª—å£ from collections import deque window = deque(maxlen=5) for price in prices: window.append(price) print(sum(window) / len(window)) â­ 11. æ•´ç†ï¼šä½¿ç”¨åœºæ™¯æœ€ä½³æŒ‡å— åœºæ™¯ å»ºè®®ç»“æ„ é«˜é¢‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰ deque æ–‡æœ¬å­—ç¬¦é¢‘ç‡ç»Ÿè®¡ Counter å±‚çº§é…ç½®è¯»å– ChainMap è‡ªåŠ¨åˆ†ç»„ defaultdict(list) è½»é‡ç»“æ„ä½“ namedtuple å¯ç»§æ‰¿å®¹å™¨ UserDict ç®€å•æ•°æ®ç¼“å­˜ OrderedDict + LRU ","description":"collections æ˜¯ Python æ ‡å‡†åº“ä¸­åŠŸèƒ½æœ€å¼ºçš„â€œå¢å¼ºæ•°æ®ç»“æ„â€æ¨¡å—ã€‚\næä¾›æ¯” list / dict / tuple æ›´ä¸“ä¸šçš„æ•°æ®ç±»å‹ã€‚\nğŸ“¦ 1. å…¨éƒ¨æ•°æ®ç»“æ„é€ŸæŸ¥è¡¨ åç§° ç±»å‹ ä½œç”¨ namedtuple å…ƒç»„å­ç±» å…·åå­—æ®µï¼Œè½»é‡ç»“æ„ä½“ deque åŒç«¯é˜Ÿåˆ— å¿«é€Ÿ append/popï¼Œé€‚åˆé˜Ÿåˆ— FIFO/LIFO Counter è®¡æ•°å™¨ ç”¨äºé¢‘æ¬¡ç»Ÿè®¡ï¼ˆå­—ç¬¦ä¸²ã€åˆ—è¡¨ï¼‰ OrderedDict æœ‰åºå­—å…¸ï¼ˆPy3.7+ dict ä¹Ÿæœ‰åºï¼‰ ä¸“ä¸šå­—å…¸æ“ä½œ defaultdict é»˜è®¤å€¼å­—å…¸ è®¿é—®ä¸å­˜åœ¨ key æ—¶è‡ªåŠ¨åˆ›å»ºå€¼ ChainMap å¤š dict åˆå¹¶è§†å›¾ å¤šå±‚é…ç½®ç»„åˆã€ä½œç”¨åŸŸé“¾ UserDict / UserList / UserString å¯ç»§æ‰¿å®¹å™¨ è®©å®¹å™¨æ›´å®¹æ˜“è¢«ç»§æ‰¿ã€æ‰©å±• ğŸŸ¥ 2. namedtuple â€” è½»é‡æ•°æ®ç»“æ„ä½“ æœ€ä½³åœºæ™¯ï¼š\n"},{"id":159,"href":"/backend/python/official/context/","title":"Context (ä¸Šä¸‹æ–‡)","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å…¨é¢ã€æœ€å®æˆ˜çš„ Pythonâ€œä¸Šä¸‹æ–‡ï¼ˆContextï¼‰â€æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š\nPythonâ€œä¸Šä¸‹æ–‡â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ with æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ ä»€ä¹ˆå«ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ ä¸Šä¸‹æ–‡çš„çœŸå®åº”ç”¨åœºæ™¯ï¼Ÿ å¦‚ä½•è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ è¿™æ˜¯å­¦ä¹  Python è¿›é˜¶å¿…é¡»æŒæ¡çš„é‡ç‚¹ã€‚\nğŸ”¥ 1. Python â€œä¸Šä¸‹æ–‡ï¼ˆContextï¼‰â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ åœ¨ Python ä¸­ï¼š\nä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰= ä¸€ä¸ªä»£ç å—è¿è¡Œæ—¶çš„ç¯å¢ƒ + è¿›å…¥/é€€å‡ºæ—¶çš„é€»è¾‘\næœ€å…¸å‹çš„ä¾‹å­ï¼š\nwith open(\u0026#34;a.txt\u0026#34;) as f: data = f.read() æ‰§è¡Œæµç¨‹æ˜¯ï¼š\nè¿›å…¥ä¸Šä¸‹æ–‡ï¼ˆæ‰“å¼€æ–‡ä»¶ï¼‰ æ‰§è¡Œä»£ç å— ç¦»å¼€ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼‰ æ‰€ä»¥ï¼š\nğŸ“ â€œä¸Šä¸‹æ–‡â€ = æ‰§è¡ŒæŸæ®µä»£ç æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ ç®¡ç†èµ„æºçš„æœºåˆ¶\nğŸ”¥ 2. ä¸Šä¸‹æ–‡æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ è¦æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå¿…é¡»å®ç°ä¸¤ä¸ªé­”æ³•æ–¹æ³•ï¼š\næ–¹æ³• ä½œç”¨ __enter__(self) å°†å¯¹è±¡â€œæ”¾å…¥â€ä¸Šä¸‹æ–‡ï¼Œè¿”å›ç»™ as __exit__(self, exc_type, exc, tb) ç¦»å¼€ä¸Šä¸‹æ–‡æ—¶è‡ªåŠ¨æ‰§è¡Œæ¸…ç† ç¤ºä¾‹ï¼š\nclass MyCtx: def __enter__(self): print(\u0026#34;è¿›å…¥ä¸Šä¸‹æ–‡\u0026#34;) return \u0026#34;OK\u0026#34; def __exit__(self, exc_type, exc, tb): print(\u0026#34;é€€å‡ºä¸Šä¸‹æ–‡\u0026#34;) with MyCtx() as v: print(v) è¾“å‡ºï¼š\nè¿›å…¥ä¸Šä¸‹æ–‡ OK é€€å‡ºä¸Šä¸‹æ–‡ ğŸ”¥ 3. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼Ÿï¼ˆä½œç”¨ï¼‰ ä¸Šä¸‹æ–‡ç”¨äºè‡ªåŠ¨èµ„æºç®¡ç†ï¼š\nåœºæ™¯ åŸå›  æ–‡ä»¶è¯»å†™ è‡ªåŠ¨å…³é—­æ–‡ä»¶å¥æŸ„ æ•°æ®åº“è¿æ¥ è‡ªåŠ¨æäº¤ / å›æ»š åŠ é” è‡ªåŠ¨åŠ é”/è§£é” ç½‘ç»œè¿æ¥ è‡ªåŠ¨é‡Šæ”¾èµ„æº ä¸´æ—¶åˆ‡æ¢çŠ¶æ€ è‡ªåŠ¨æ¢å¤ç¯å¢ƒ decimal ç²¾åº¦æ§åˆ¶ æ‰§è¡Œç»“æŸåæ¢å¤é…ç½® ä¸Šä¸‹æ–‡ = è‡ªåŠ¨åŒ–çš„â€œè¿›å…¥ -\u0026gt; é€€å‡ºæµç¨‹â€ï¼Œå‡å°‘é”™è¯¯ã€‚\nğŸ”¥ 4. Python å†…ç½®å¸¸ç”¨ä¸Šä¸‹æ–‡ï¼ˆæœ€å…¨ï¼‰ æ–‡ä»¶æ“ä½œ with open(\u0026#39;a.txt\u0026#39;) as f: é”ï¼ˆçº¿ç¨‹ / åç¨‹ï¼‰ with threading.Lock(): SQLite / DB äº‹åŠ¡ with conn: conn.execute(sql) Decimal ç²¾åº¦ç¯å¢ƒ from decimal import localcontext with localcontext() as ctx: ctx.prec = 50 ä¸´æ—¶åˆ‡æ¢ç›®å½• from contextlib import chdir with chdir(\u0026#34;/tmp\u0026#34;): contextlib.suppress() å¿½ç•¥é”™è¯¯ from contextlib import suppress with suppress(FileNotFoundError): open(\u0026#34;abc.txt\u0026#34;).read() contextlib.redirect_stdout() from contextlib import redirect_stdout with open(\u0026#34;log.txt\u0026#34;, \u0026#34;w\u0026#34;) as f: with redirect_stdout(f): print(\u0026#34;hello\u0026#34;) ğŸ”¥ 5. contextlib è®©ä½ å†™ä¸Šä¸‹æ–‡æ›´ç®€å• ï¼ˆ1ï¼‰ç”¨ contextmanager è£…é¥°å™¨å¿«é€Ÿå®ç°ä¸Šä¸‹æ–‡ from contextlib import contextmanager @contextmanager def myctx(): print(\u0026#34;è¿›å…¥\u0026#34;) yield print(\u0026#34;é€€å‡º\u0026#34;) with myctx(): print(\u0026#34;å¤„ç†ä¸­\u0026#34;) ç›¸å½“äºï¼š\nyield å‰ = __enter__ yield å = __exit__ ğŸ”¥ 6. è‡ªå·±å®ç°ä¸€ä¸ªå¸¦èµ„æºæ¸…ç†çš„ä¸Šä¸‹æ–‡ï¼ˆå®æˆ˜ï¼‰ ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ªâ€œæ—¥å¿—è®¡æ—¶å™¨â€ï¼š\nimport time class Timer: def __enter__(self): self.start = time.time() return self def __exit__(self, exc_type, exc, tb): self.end = time.time() self.cost = self.end - self.start print(f\u0026#34;è€—æ—¶ï¼š{self.cost:.4f} ç§’\u0026#34;) with Timer() as t: sum(range(10_0000)) ğŸ”¥ 7. ä¸Šä¸‹æ–‡ä¸­å¼‚å¸¸æ€ä¹ˆå¤„ç†ï¼Ÿ å¦‚æœ __exit__ è¿”å› Trueï¼Œå¼‚å¸¸ä¼šè¢«â€œåæ‰â€ã€‚\nclass SuppressError: def __exit__(self, exc_type, exc, tb): return True # è¡¨ç¤ºâ€œå¼‚å¸¸å·²å¤„ç†â€ with SuppressError(): raise ValueError(\u0026#34;oops\u0026#34;) # ä¸ä¼šæŠ¥é”™ ğŸ”¥ 8. with ä¸ try/finally åŒºåˆ« ä¸‹é¢ä¸¤æ®µä»£ç ç­‰ä»·ï¼š\nä½¿ç”¨ withï¼š\nwith open(\u0026#34;a.txt\u0026#34;) as f: data = f.read() ç­‰ä»·äº try/finallyï¼š\nf = open(\u0026#34;a.txt\u0026#34;) try: data = f.read() finally: f.close() ğŸ“Œ with æ˜¯ try/finally çš„è¯­æ³•ç³–ï¼Œä½†æ›´ä¼˜é›…ã€æ›´å®‰å…¨ã€‚\nğŸ”¥ 9. Python ä¸­çš„â€œä¸Šä¸‹æ–‡â€æ€»ç»“ ä¸Šä¸‹æ–‡ = è‡ªåŠ¨ç®¡ç†èµ„æºçš„æœºåˆ¶\nwith = è‡ªåŠ¨æ‰§è¡Œ è¿›å…¥é€»è¾‘ï¼ˆenterï¼‰ + é€€å‡ºé€»è¾‘ï¼ˆexitï¼‰\nä½ åªéœ€è¦å†™ä»£ç ä¸»ä½“ï¼Œå…¶ä½™è‡ªåŠ¨å®Œæˆã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å…¨é¢ã€æœ€å®æˆ˜çš„ Pythonâ€œä¸Šä¸‹æ–‡ï¼ˆContextï¼‰â€æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š\nPythonâ€œä¸Šä¸‹æ–‡â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ with æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ ä»€ä¹ˆå«ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ ä¸Šä¸‹æ–‡çš„çœŸå®åº”ç”¨åœºæ™¯ï¼Ÿ å¦‚ä½•è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ è¿™æ˜¯å­¦ä¹  Python è¿›é˜¶å¿…é¡»æŒæ¡çš„é‡ç‚¹ã€‚\nğŸ”¥ 1. Python â€œä¸Šä¸‹æ–‡ï¼ˆContextï¼‰â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ åœ¨ Python ä¸­ï¼š\nä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰= ä¸€ä¸ªä»£ç å—è¿è¡Œæ—¶çš„ç¯å¢ƒ + è¿›å…¥/é€€å‡ºæ—¶çš„é€»è¾‘\næœ€å…¸å‹çš„ä¾‹å­ï¼š\nwith open(\u0026#34;a.txt\u0026#34;) as f: data = f.read() æ‰§è¡Œæµç¨‹æ˜¯ï¼š\nè¿›å…¥ä¸Šä¸‹æ–‡ï¼ˆæ‰“å¼€æ–‡ä»¶ï¼‰ æ‰§è¡Œä»£ç å— ç¦»å¼€ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼‰ æ‰€ä»¥ï¼š\nğŸ“ â€œä¸Šä¸‹æ–‡â€ = æ‰§è¡ŒæŸæ®µä»£ç æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ ç®¡ç†èµ„æºçš„æœºåˆ¶\nğŸ”¥ 2. ä¸Šä¸‹æ–‡æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ è¦æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå¿…é¡»å®ç°ä¸¤ä¸ªé­”æ³•æ–¹æ³•ï¼š\n"},{"id":160,"href":"/backend/python/official/copy/","title":"Copy (æ‹·è´)","parent":"Official","content":" ğŸš€ 1. copy ä¸ deepcopy æ˜¯ä»€ä¹ˆï¼Ÿ æ¥è‡ªæ¨¡å—ï¼š\nimport copy Python æœ‰ä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š\næ–¹å¼ å«ä¹‰ copy.copy() æµ…æ‹·è´ï¼ˆshallow copyï¼‰ copy.deepcopy() æ·±æ‹·è´ï¼ˆdeep copyï¼‰ ğŸŸ¥ 2. æµ…æ‹·è´ï¼ˆcopyï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ æµ…æ‹·è´åªä¼šå¤åˆ¶ æœ€å¤–å±‚å¯¹è±¡ï¼Œå†…éƒ¨å¯¹è±¡åªæ˜¯å¼•ç”¨ã€‚\nç­‰ä»·äºï¼š\nå¤–å±‚å¤åˆ¶ âœ… å†…å±‚å…±äº« âŒï¼ˆä»æŒ‡å‘åŸå¯¹è±¡ï¼‰ ä¾‹å¦‚ï¼š\nimport copy a = [1, [2, 3]] b = copy.copy(a) ç»“æ„ç¤ºæ„ï¼š\na ------\u0026gt; [1, [2,3]] â†‘ b ------\u0026gt; [1, â”˜] ä¿®æ”¹ b çš„å†…éƒ¨åˆ—è¡¨ï¼š\nb[1].append(4) print(a) è¾“å‡ºï¼š\n[1, [2, 3, 4]] æµ…æ‹·è´ -\u0026gt; å†…éƒ¨ç»“æ„å…±äº«ã€‚\nğŸŸ¦ 3. æ·±æ‹·è´ï¼ˆdeepcopyï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ æ·±æ‹·è´ä¼šé€’å½’å¤åˆ¶æ‰€æœ‰å­å¯¹è±¡ï¼š\nå¤–å±‚å¤åˆ¶ âœ… å†…å±‚ä¹Ÿå¤åˆ¶ âœ… å®Œå…¨ç‹¬ç«‹çš„ç»“æ„ ğŸ‘ import copy a = [1, [2, 3]] b = copy.deepcopy(a) b[1].append(4) print(a) è¾“å‡ºï¼š\n[1, [2, 3]] å®Œå…¨ä¸ä¼šå½±å“åŸå¯¹è±¡ã€‚\nğŸŸ© 4. æœ¬è´¨å·®å¼‚ï¼ˆæœ€é‡è¦ï¼‰ è¡Œä¸º copyï¼ˆæµ…æ‹·è´ï¼‰ deepcopyï¼ˆæ·±æ‹·è´ï¼‰ å¤–å±‚å¯¹è±¡å¤åˆ¶ âœ… âœ… å†…å±‚å¯¹è±¡å¤åˆ¶ âŒï¼ˆå…±äº«å¼•ç”¨ï¼‰ âœ…ï¼ˆé€’å½’å¤åˆ¶ï¼‰ ä¿®æ”¹å†…å±‚æ˜¯å¦å½±å“åŸå¯¹è±¡ âœ… âŒ é€Ÿåº¦ å¿« æ…¢ å†…å­˜æ¶ˆè€— å°‘ å¤š ğŸŸ§ 5. å¸¸è§ä½¿ç”¨åœºæ™¯ copyï¼ˆæµ…æ‹·è´ï¼‰é€‚åˆï¼š\nå†…éƒ¨ç»“æ„ä¸ä¼šä¿®æ”¹ åªæƒ³å¤åˆ¶â€œå¤–å£³â€ list / dict éœ€è¦å¿«é€Ÿå¤åˆ¶ æ•°æ®å¯¹è±¡å¾ˆå¤§ï¼Œä¸æƒ³æ·±åº¦å¤åˆ¶ ç¤ºä¾‹ï¼š\nnew_list = old_list.copy() deepcopy é€‚åˆï¼š\nå¤æ‚åµŒå¥—ç»“æ„ æƒ³å¾—åˆ°å®Œå…¨ç‹¬ç«‹å‰¯æœ¬ é…ç½®å¤åˆ¶ã€å¯¹è±¡å…‹éš† é¿å…å¤šå±‚ list/dict äº’ç›¸å½±å“ ç¤ºä¾‹ï¼š\nnew_dict = copy.deepcopy(config_dict) ğŸŸ« 6. æ·±æ‹·è´çš„å±é™©ç‚¹ï¼šå¾ªç¯å¼•ç”¨ æ·±æ‹·è´ä¼šè‡ªåŠ¨å¤„ç†å¾ªç¯å¼•ç”¨ï¼š\na = [] a.append(a) import copy b = copy.deepcopy(a) ä¸ä¼šæ­»å¾ªç¯ã€‚\nğŸŸª 7. æŸäº›å¯¹è±¡æ°¸è¿œä¸ä¼š deep copy ä¾‹å¦‚ï¼š\nfile æ–‡ä»¶å¥æŸ„ socket çº¿ç¨‹å¯¹è±¡ åç¨‹å¯¹è±¡ å†…ç½®ç±»å¯¹è±¡ï¼ˆå¦‚ rangeã€iteratorï¼‰ è¿™äº›å¯¹è±¡ä¼šè¢«åŸæ ·å¼•ç”¨ï¼ˆå› ä¸ºæ— æ³•å…‹éš†ï¼‰ã€‚\nğŸŸ¨ 8. è‡ªå®šä¹‰ç±»å¦‚ä½•æ§åˆ¶ copy è¡Œä¸ºï¼Ÿ ä½ å¯ä»¥å®šä¹‰ï¼š\ndef __copy__(self): ... def __deepcopy__(self, memo): ... ç¤ºä¾‹ï¼š\nclass A: def __init__(self, x): self.x = x def __deepcopy__(self, memo): print(\u0026#34;doing deepcopy\u0026#34;) return A(copy.deepcopy(self.x, memo)) â­ 9. æœ€ä½³å®è·µæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ æƒ³è¦å¤åˆ¶ä¸€ä¸ª dict/listï¼Œä½†ä¸ä¿®æ”¹å†…éƒ¨ -\u0026gt; ç”¨ copy() b = a.copy() éœ€è¦å®Œå…¨ç‹¬ç«‹æ‹·è´ï¼ˆä¾‹å¦‚é…ç½®ï¼‰-\u0026gt; ç”¨ deepcopy() b = copy.deepcopy(a) å°½é‡é¿å…éšæ„ deepcopyï¼šæˆæœ¬é«˜ å¸¸ç”¨æ›¿ä»£æ–¹æ¡ˆï¼š\nâ‘  JSON åºåˆ—åŒ–ï¼ˆç®€å•åµŒå¥—ç»“æ„ï¼‰ import json b = json.loads(json.dumps(a)) â‘¡ æ‰‹åŠ¨å¤åˆ¶ä½ éœ€è¦çš„å­—æ®µ æ›´å¯æ§ã€æ›´é«˜æ•ˆã€‚\nğŸ”¥ 10. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆä½ å¯ä»¥ç›´æ¥æ”¶è—ï¼‰ copy.copy(x):\næµ…æ‹·è´ï¼Œåªå¤åˆ¶æœ€å¤–å±‚ å†…éƒ¨å¯¹è±¡ä¿æŒå¼•ç”¨ å¿«ã€è½»é‡ copy.deepcopy(x):\næ·±æ‹·è´ï¼Œé€’å½’å¤åˆ¶å…¨éƒ¨å¯¹è±¡ å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ æ…¢ã€æ¶ˆè€—å†…å­˜å¤š è‡ªåŠ¨å¤„ç†å¾ªç¯å¼•ç”¨ ","description":" ğŸš€ 1. copy ä¸ deepcopy æ˜¯ä»€ä¹ˆï¼Ÿ æ¥è‡ªæ¨¡å—ï¼š\nimport copy Python æœ‰ä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š\næ–¹å¼ å«ä¹‰ copy.copy() æµ…æ‹·è´ï¼ˆshallow copyï¼‰ copy.deepcopy() æ·±æ‹·è´ï¼ˆdeep copyï¼‰ ğŸŸ¥ 2. æµ…æ‹·è´ï¼ˆcopyï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ æµ…æ‹·è´åªä¼šå¤åˆ¶ æœ€å¤–å±‚å¯¹è±¡ï¼Œå†…éƒ¨å¯¹è±¡åªæ˜¯å¼•ç”¨ã€‚\nç­‰ä»·äºï¼š\nå¤–å±‚å¤åˆ¶ âœ… å†…å±‚å…±äº« âŒï¼ˆä»æŒ‡å‘åŸå¯¹è±¡ï¼‰ ä¾‹å¦‚ï¼š\n"},{"id":161,"href":"/backend/python/cryptography/","title":"Cryptography","parent":"Python","content":"Directory List:\ncryptography åŸºç¡€æ•™ç¨‹ ","description":"Directory List:\ncryptography åŸºç¡€æ•™ç¨‹ "},{"id":162,"href":"/operations/others/csdn/","title":"CSDNè§£é™¤ç™»é™†åå¤åˆ¶é™åˆ¶","parent":"Others","content":"åœ¨ console ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç \nwindow.oncontextmenu = document.oncontextmenu = document.oncopy = null; [...document.querySelectorAll(\u0026#39;body\u0026#39;)].forEach((dom) =\u0026gt; (dom.outerHTML = dom.outerHTML)); [...document.querySelectorAll(\u0026#39;body, body *\u0026#39;)].forEach((dom) =\u0026gt; { [\u0026#39;onselect\u0026#39;, \u0026#39;onselectstart\u0026#39;, \u0026#39;onselectend\u0026#39;, \u0026#39;ondragstart\u0026#39;, \u0026#39;ondragend\u0026#39;, \u0026#39;oncontextmenu\u0026#39;, \u0026#39;oncopy\u0026#39;].forEach((ev) =\u0026gt; dom.removeAttribute(ev)); dom.style[\u0026#39;user-select\u0026#39;] = \u0026#39;auto\u0026#39;; }); å‚è€ƒæ–‡æ¡£: https://www.cnblogs.com/getrich/p/16846631.html ","description":"åœ¨ console ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç \nwindow.oncontextmenu = document.oncontextmenu = document.oncopy = null; [...document.querySelectorAll(\u0026#39;body\u0026#39;)].forEach((dom) =\u0026gt; (dom.outerHTML = dom.outerHTML)); [...document.querySelectorAll(\u0026#39;body, body *\u0026#39;)].forEach((dom) =\u0026gt; { [\u0026#39;onselect\u0026#39;, \u0026#39;onselectstart\u0026#39;, \u0026#39;onselectend\u0026#39;, \u0026#39;ondragstart\u0026#39;, \u0026#39;ondragend\u0026#39;, \u0026#39;oncontextmenu\u0026#39;, \u0026#39;oncopy\u0026#39;].forEach((ev) =\u0026gt; dom.removeAttribute(ev)); dom.style[\u0026#39;user-select\u0026#39;] = \u0026#39;auto\u0026#39;; }); å‚è€ƒæ–‡æ¡£: https://www.cnblogs.com/getrich/p/16846631.html "},{"id":163,"href":"/frontend/css/","title":"CSS","parent":"Frontend","content":"Document List:\n","description":"Document List:\n"},{"id":164,"href":"/backend/python/official/data-processing/","title":"Data Processing (æ•°æ®å¤„ç†)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿã€æœ€å®ç”¨çš„ã€ŒPython æ•°æ®å¤„ç†æ“ä½œå¤§å…¨ã€æ€»ç»“ï¼Œæ¶µç›– æ‰€æœ‰å¸¸è§æ•°æ®ç±»å‹ã€æ•°æ®ç»“æ„ã€æ•°æ®æ¥æºã€æ•°æ®è½¬æ¢æ–¹å¼ï¼Œéå¸¸é€‚åˆä½œä¸ºä½ ä¸ªäººçš„â€œæ•°æ®å¤„ç†é€ŸæŸ¥è¡¨â€ã€‚\nå†…å®¹ç»“æ„æŒ‰åœºæ™¯åˆ†ç±»ï¼Œéå¸¸æ¸…æ™°ã€‚\nğŸ”¥ Python æ•°æ®å¤„ç†å¤§å…¨ï¼ˆç³»ç»Ÿæ€»ç»“ï¼‰ ç›®å½•æ€»è§ˆï¼ˆæ‰€æœ‰åˆ†ç±»ï¼‰\nå­—ç¬¦ä¸²å¤„ç†ï¼ˆString Processingï¼‰ æ•°å­—å¤„ç†ï¼ˆNumber Processingï¼‰ å¸ƒå°”å¤„ç†ï¼ˆBoolean Processingï¼‰ æ—¥æœŸä¸æ—¶é—´å¤„ç†ï¼ˆDatetime Processingï¼‰ åˆ—è¡¨å¤„ç†ï¼ˆList Processingï¼‰ å…ƒç»„å¤„ç†ï¼ˆTuple Processingï¼‰ é›†åˆå¤„ç†ï¼ˆSet Processingï¼‰ å­—å…¸å¤„ç†ï¼ˆDict Processingï¼‰ JSON / TOML / YAML æ•°æ®å¤„ç† æ­£åˆ™è¡¨è¾¾å¼å¤„ç†ï¼ˆRegex Processingï¼‰ æ–‡ä»¶å¤„ç†ï¼ˆFile Processingï¼‰ æ•°æ®æ ¡éªŒä¸æ¸…æ´—ï¼ˆValidation / Cleaningï¼‰ ç±»å‹å¤„ç†ä¸è½¬æ¢ æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼ˆåºåˆ— -\u0026gt; å­—èŠ‚ / æ–‡ä»¶ï¼‰ æ•°æ®åº“æ•°æ®å¤„ç†ï¼ˆDB -\u0026gt; Python -\u0026gt; DBï¼‰ ç½‘ç»œæ•°æ®å¤„ç†ï¼ˆHTTP Response æ•°æ®ï¼‰ æ€§èƒ½ä¼˜åŒ–ç›¸å…³çš„æ•°æ®å¤„ç† 1. â­ å­—ç¬¦ä¸²å¤„ç†ï¼ˆString Processingï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ å»å‰åç©ºç™½ strip() / lstrip() / rstrip() \u0026quot; abc \u0026ldquo;.strip() å¤§å°å†™è½¬æ¢ lower() / upper() / title() \u0026ldquo;Hello\u0026rdquo;.lower() æŸ¥æ‰¾ / æ›¿æ¢ find / replace \u0026ldquo;abc\u0026rdquo;.replace(\u0026ldquo;b\u0026rdquo;, \u0026ldquo;\u0026rdquo;) å­—ç¬¦ä¸²æ‹¼æ¥ + / join \u0026ldquo;a\u0026rdquo; + \u0026ldquo;b\u0026rdquo; / \u0026ldquo;.\u0026quot;.join(list) åˆ†å‰² split / rsplit \u0026ldquo;a,b\u0026rdquo;.split(\u0026rdquo;,\u0026rdquo;) åˆ¤æ–­å‰ç¼€ startswith \u0026ldquo;abc\u0026rdquo;.startswith(\u0026ldquo;a\u0026rdquo;) åˆ¤æ–­åç¼€ endswith \u0026ldquo;abc\u0026rdquo;.endswith(\u0026ldquo;c\u0026rdquo;) æ¨¡æ¿æ›¿æ¢ f-string f\u0026quot;{name}-{age}\u0026quot; æ­£åˆ™æ‹†åˆ† re.split re.split(r\u0026quot;\\W+\u0026quot;, s) æ ¼å¼åŒ– format / f-string f\u0026quot;{num:02d}\u0026quot; æ¸…æ´—ç‰¹æ®Šå­—ç¬¦ re.sub re.sub(r\u0026quot;\\s+\u0026quot;, \u0026quot; \u0026ldquo;, s) æå–æ•°å­— æ­£åˆ™ re.findall(r\u0026rdquo;\\d+\u0026quot;, s) 2. â­ æ•°å­—å¤„ç†ï¼ˆNumber Processingï¼‰ ç±»å‹ è¯´æ˜ å››èˆäº”å…¥ round() è½¬æ¢ç±»å‹ int() / float() / Decimal() åŠ å‡ä¹˜é™¤ ç²¾åº¦è¿ç®— Decimal åˆ†æ•°è®¡ç®— Fraction æ¯”è¾ƒå¤§å° åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—ï¼ˆregex / str.isdigitï¼‰ ç§‘å­¦è®¡æ•°æ³•è½¬æ¢ 3. â­ å¸ƒå°”å¤„ç†ï¼ˆBooleanï¼‰ å¸¸ç”¨äºåˆ¤æ–­ï¼š\næ˜¯å¦ä¸ºç©º: if not a: å¤šæ¡ä»¶åˆ¤æ–­: a and b ä»»æ„ä¸ºçœŸ: any(list) æ‰€æœ‰ä¸ºçœŸ: all(list) ä¸‰å…ƒè¡¨è¾¾å¼ï¼šx if cond else y 4. â­ æ—¥æœŸä¸æ—¶é—´å¤„ç†ï¼ˆDatetimeï¼‰ åŠŸèƒ½ ç¤ºä¾‹ è·å–å½“å‰æ—¶é—´ datetime.now() æ—¶é—´æˆ³è½¬æ¢ datetime.fromtimestamp(ts) æ—¶é—´æ ¼å¼åŒ– dt.strftime(\u0026quot;%Y-%m-%d\u0026quot;) å­—ç¬¦ä¸² -\u0026gt; datetime datetime.strptime() æ—¶åŒºè½¬æ¢ dt.astimezone(tz) æ—¥æœŸåŠ å‡ dt + timedelta(days=1) åˆ¤æ–­æ˜¯å¦å½“å¤© dt.date() == date.today() ä»»æ„æ ¼å¼è½¬æ¢ \u0026ldquo;2025å¹´12æœˆ04æ—¥\u0026rdquo;.replace(\u0026ldquo;å¹´\u0026rdquo;,\u0026quot;-\u0026quot;)\u0026hellip; 5. â­ åˆ—è¡¨å¤„ç†ï¼ˆListï¼‰ ç±»å‹ è¯´æ˜ append / extend insert / remove åˆ—è¡¨æ¨å¯¼å¼ map / filter åˆ‡ç‰‡ slicing æ’åº sort / sorted å»é‡ï¼ˆè½¬ setï¼‰ åˆ†ç»„ï¼ˆchunksï¼‰ flattenï¼ˆæ‰å¹³åŒ–ï¼‰ list -\u0026gt; dict 6. â­ å…ƒç»„å¤„ç†ï¼ˆTupleï¼‰ ä¸å¯å˜åºåˆ— å¤šå€¼è¿”å› è§£åŒ…ï¼ša, b = (1, 2) å‘½åå…ƒç»„ï¼šcollections.namedtuple 7. â­ é›†åˆå¤„ç†ï¼ˆSetï¼‰ å»é‡ å¹¶é›†ï¼šset1 | set2 äº¤é›†ï¼šset1 \u0026amp; set2 å·®é›†ï¼šset1 - set2 æˆå‘˜æ£€æŸ¥ï¼šin 8. â­ å­—å…¸å¤„ç†ï¼ˆDictï¼‰ åŠŸèƒ½ ç¤ºä¾‹ é”®å€¼è·å– dict.get() éå† items() / keys() / values() åˆå¹¶ `d1 åˆ é™¤å­—æ®µ pop è¿‡æ»¤å­—æ®µ å­—å…¸æ¨å¯¼å¼ rename key {new: d[old]} åµŒå¥— dict å¤„ç† é€’å½’ flatten dict å±•å¼€åµŒå¥—ç»“æ„ 9. â­ JSON / TOML / YAML åŠŸèƒ½ å·¥å…· json.dumps / loads å†…ç½® JSON orjson.dumps / loads æœ€å¿« JSON tomllib.loads Python 3.11+ yaml.safe_load PyYAML 10. â­ æ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegexï¼‰ å¸¸è§æ“ä½œï¼š\nåŒ¹é…ï¼šre.match æœç´¢ï¼šre.search æ›¿æ¢ï¼šre.sub æå–ï¼šre.findall åˆ†ç»„ï¼šre.group åˆ†å‰²ï¼šre.split 11. â­ æ–‡ä»¶å¤„ç†ï¼ˆFile Processingï¼‰ æ“ä½œ ç¤ºä¾‹ æ–‡ä»¶è¯»å– open(\u0026hellip;).read() é€è¡Œè¯»å– for line in f: å†™å…¥ / è¿½åŠ  write / append JSON æ–‡ä»¶ json.dump / load CSV æ–‡ä»¶ csv.reader äºŒè¿›åˆ¶æ–‡ä»¶ rb / wb 12. â­ æ•°æ®æ ¡éªŒä¸æ¸…æ´— æ¸…æ´—ç©ºå­—ç¬¦ä¸² å»é™¤ None æ ¡éªŒç±»å‹ï¼ˆisinstanceï¼‰ æ ¡éªŒæ ¼å¼ï¼ˆregexï¼‰ å¿…å¡«å­—æ®µæ£€æŸ¥ æ•°å­—èŒƒå›´åˆ¤æ–­ 13. â­ ç±»å‹è½¬æ¢ ç±»å‹ æ–¹æ³• str â†” int int(â€œ3â€), str(3) str â†” float float(â€œ1.2â€) str â†” dict json.loads list â†” tuple list(), tuple() datetime â†” str strptime / strftime bytes â†” str decode / encode 14. â­ æ•°æ®åºåˆ—åŒ– JSON Pickleï¼ˆåºåˆ—åŒ–å¯¹è±¡ï¼‰ orjsonï¼ˆäºŒè¿›åˆ¶ JSONï¼‰ msgpackï¼ˆé«˜æ€§èƒ½äºŒè¿›åˆ¶ï¼‰ 15. â­ æ•°æ®åº“å¤„ç†ï¼ˆDBï¼‰ åŠŸèƒ½ è¯´æ˜ ORM DataClass è½¬ dict model.dict SQLAlchemy result -\u0026gt; dict datetime è½¬å­—ç¬¦ä¸² æ•°æ®åˆ†é¡µ limit/offset æ‰¹é‡æ’å…¥è½¬æ¢ å­—æ®µç±»å‹æ£€æŸ¥ 16. â­ HTTP æ•°æ®å¤„ç† response.json() å¤±è´¥é‡è¯•ç­–ç•¥ å­—ç¬¦é›†å¤„ç† encoding headers æ‹¼æ¥ URL å‚æ•°æ‹¼è£… æå– query å‚æ•° 17. â­ æ€§èƒ½ç›¸å…³æ•°æ®å¤„ç† lru_cache åŠ é€Ÿ orjson åŠ é€Ÿ JSON è§£æ multiprocessing å¹¶è¡Œå¤„ç† itertools æƒ°æ€§å¤„ç†å¤§æ•°æ® ğŸ”¥ æœ€ç»ˆæ€»ç»“ï¼šæ•°æ®å¤„ç†çš„ 7 å¤§æ ¸å¿ƒåˆ†ç±» ç±»å‹è½¬æ¢ æ­£åˆ™å¤„ç† å­—ç¬¦ä¸²å¤„ç† æ—¥æœŸæ—¶é—´å¤„ç† é›†åˆ / åˆ—è¡¨ / å­—å…¸å¤„ç† I/O æ–‡ä»¶ / JSON æ•°æ®æ ¡éªŒä¸æ¸…æ´— ä¸‹é¢æ˜¯ä¸€ä»½ é«˜è´¨é‡ã€å¯ç”¨äºé¡¹ç›®è§„èŒƒçš„ã€ŠPython æ•°æ®å¤„ç†æœ€ä½³å®è·µã€‹ã€‚\næ¶µç›– å­—ç¬¦ä¸² / æ•°å­— / æ—¥æœŸ / åˆ—è¡¨ / å­—å…¸ / JSON / æ•°æ®æ¸…æ´— / æ ¡éªŒ / ç±»å‹è½¬æ¢ / æ–‡ä»¶å¤„ç† / ä»£ç è§„èŒƒ ç­‰å…¨å¥—å†…å®¹ã€‚\nå†…å®¹èšç„¦ å®æˆ˜ã€å¯è½åœ°ã€é¡¹ç›®çº§æœ€ä½³å®è·µï¼Œä¸æ˜¯æ³›æ³›è€Œè°ˆã€‚\nâœ… Python æ•°æ®å¤„ç†æœ€ä½³å®è·µï¼ˆé¡¹ç›®è§„èŒƒçº§ï¼‰ ğŸ“Œ ç›®å½•\né€šç”¨åŸåˆ™ å­—ç¬¦ä¸²å¤„ç† æ•°å­—å¤„ç† æ—¥æœŸä¸æ—¶é—´ åˆ—è¡¨å¤„ç† å­—å…¸å¤„ç† æ­£åˆ™å¤„ç† æ•°æ®æ¸…æ´— ç±»å‹è½¬æ¢ JSON / ORJSON æ–‡ä»¶æ•°æ®å¤„ç† HTTP / æ•°æ®åº“æ•°æ®å¤„ç† æ€§èƒ½ä¼˜åŒ– å®‰å…¨æ³¨æ„äº‹é¡¹ å·¥å…·å‡½æ•°æ¨èç»“æ„ 1. é€šç”¨æ•°æ®å¤„ç†åŸåˆ™ï¼ˆå¿…é¡»æŒæ¡ï¼‰ âœ… ä¼˜å…ˆä½¿ç”¨ Python å†…ç½®å‡½æ•°å’Œåº“ å¦‚ï¼šsum / max / min / zip / enumerate / any / all / sorted\nâœ… å§‹ç»ˆä¿è¯â€œä¸å¯å˜æ•°æ®ä¸è¢«ä¿®æ”¹â€ å¦‚ï¼štuple ä¸æ”¹ã€dataclass ä½¿ç”¨ frozen=True é˜²æ­¢è¯¯æ”¹ã€‚\nâœ… æ•°æ®å¤„ç†å¿…é¡»ç¡®ä¿ ç±»å‹æ­£ç¡® æ ¼å¼ç»Ÿä¸€ è¾¹ç•Œæ¡ä»¶æ˜ç¡® é”™è¯¯å¯æ§ä¸”å¯è¿½è¸ª âœ… é¡¹ç›®ä¸­æ•°æ®æµå¿…é¡»éµå®ˆ è¾“å…¥ -\u0026gt; æ ¡éªŒ -\u0026gt; æ¸…æ´— -\u0026gt; è½¬æ¢ -\u0026gt; è¾“å‡º\n2. å­—ç¬¦ä¸²å¤„ç†æœ€ä½³å®è·µ âœ… å»ç©ºç™½ç»Ÿä¸€ç”¨ .strip() name = name.strip() âœ… å¼ºåˆ¶ Unicodeï¼Œç¦æ­¢æœªçŸ¥ç¼–ç  text = text.encode(\u0026#34;utf-8\u0026#34;).decode(\u0026#34;utf-8\u0026#34;) âœ… ä½¿ç”¨ f-stringï¼ˆæœ€é«˜æ•ˆï¼‰ sql = f\u0026#34;SELECT * FROM users WHERE id = {uid}\u0026#34; âœ… æ‹¼æ¥åˆ—è¡¨ä¼˜å…ˆ join \u0026#34;,\u0026#34;.join(ids) âœ… æ­£åˆ™æ¸…æ´—ç‰¹æ®Šå­—ç¬¦ clean = re.sub(r\u0026#34;\\s+\u0026#34;, \u0026#34; \u0026#34;, text) 3. æ•°å­—å¤„ç†æœ€ä½³å®è·µ âœ… æ°¸è¿œä¸è¦ç”¨ float åšç²¾ç¡®è¿ç®—ï¼ˆé‡‘é¢ç­‰ï¼‰ from decimal import Decimal price = Decimal(\u0026#34;0.1\u0026#34;) + Decimal(\u0026#34;0.2\u0026#34;) âœ… ç±»å‹è½¬æ¢å¿…é¡»å®‰å…¨ def to_int(x: str | int) -\u0026gt; int | None: try: return int(x) except Exception: return None âœ… ä¸è¦ç›´æ¥æ¯”è¾ƒæµ®ç‚¹ math.isclose(a, b) 4. æ—¥æœŸä¸æ—¶é—´æœ€ä½³å®è·µ âœ… æ‰€æœ‰ datetime å¿…é¡»æœ‰æ—¶åŒºï¼ˆé¡¹ç›®å¼ºåˆ¶è¦æ±‚ï¼‰ from datetime import datetime, timezone now = datetime.now(timezone.utc) âœ… å­—ç¬¦ä¸² â†” datetime ç»Ÿä¸€è§„èŒƒ dt = datetime.strptime(\u0026#34;2025-12-04 16:00:00\u0026#34;, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) âœ… æ ¼å¼åŒ–ä¸€å¾‹ä½¿ç”¨ %Y-%m-%d %H:%M:%S æ—¥æœŸä¸€å¾‹ä½¿ç”¨ %Y-%m-%d\nâœ… æ—¶é—´æˆ³è½¬æ¢ datetime.fromtimestamp(ts, tz=timezone.utc) âœ… å½“å¤©åˆ¤æ–­ dt.date() == date.today() 5. åˆ—è¡¨å¤„ç†æœ€ä½³å®è·µ âœ… åˆ—è¡¨æ¨å¯¼ä»£æ›¿ for å¾ªç¯ç”Ÿæˆ results = [x*x for x in nums if x \u0026gt; 0] âœ… map / filter å°è£…ä¸ºå·¥å…·å‡½æ•°ï¼ˆå¯è¯»æ€§æé«˜ï¼‰ items = map_filter(source, pick) âœ… åˆå¹¶å¤šä¸ªåˆ—è¡¨ all_items = [*a, *b] âœ… æ’åºä½¿ç”¨ key sorted(users, key=lambda u: u[\u0026#34;age\u0026#34;]) 6. å­—å…¸å¤„ç†æœ€ä½³å®è·µ âœ… è®¿é—® key ç»Ÿä¸€ä½¿ç”¨ .get() uid = data.get(\u0026#34;id\u0026#34;) âœ… åˆå¹¶ dict å¿…é¡»ç”¨ | d = d1 | d2 âœ… å­—å…¸æ¨å¯¼å¼é€ææ¸…æ´— clean = {k: v for k, v in data.items() if v is not None} âœ… å­—æ®µé‡å‘½å new = {new_key: data[old_key]} âœ… åµŒå¥— dict æ·±å–å€¼ï¼ˆå·¥å…·å‡½æ•°ï¼‰ utils.deep_get(user, \u0026#34;profile.name\u0026#34;) 7. æ­£åˆ™å¤„ç†æœ€ä½³å®è·µ âœ… ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸² râ€â€ é¿å…è½¬ä¹‰åœ°ç‹±ï¼š\nre.compile(r\u0026#34;\\d+\u0026#34;) âœ… é¢„ç¼–è¯‘æé«˜æ€§èƒ½ PATTERN = re.compile(r\u0026#34;foo.*bar\u0026#34;) âœ… æå–æ¨¡å¼ code = re.search(r\u0026#34;code=(\\w+)\u0026#34;, url).group(1) âœ… æŒ‰åˆ†éš”ç¬¦åˆ†å‰² parts = re.split(r\u0026#34;[,; ]+\u0026#34;, text) 8. æ•°æ®æ¸…æ´—ï¼ˆæ¨èåœ¨ utils.data_clean ä¸­å®ç°ï¼‰ âœ… å»é™¤å€¼ä¸ºç©ºçš„å­—æ®µ {x: v for x, v in d.items() if v not in (\u0026#34;\u0026#34;, None, [], {})} âœ… å­—ç¬¦ä¸²å…¨å±€ strip clean = {k: v.strip() if isinstance(v, str) else v for k,v in d.items()} âœ… datetime ç»Ÿä¸€è½¬æ¢ä¸ºå­—ç¬¦ä¸² dt.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) âœ… list[dict] æ‰¹é‡æ¸…æ´— ä½¿ç”¨ list comprehension å¯¹ item æ‰¹é‡å¤„ç†ã€‚\n9. ç±»å‹è½¬æ¢æœ€ä½³å®è·µ âœ… å®‰å…¨è½¬æ¢ def safe_str(x) -\u0026gt; str: return x if isinstance(x, str) else str(x) âœ… è‡ªåŠ¨ç±»å‹è¯†åˆ«å™¨ def auto_type(val): if val.isdigit(): return int(val) try: return float(val) except: return val 10. JSON / ORJSON æœ€ä½³å®è·µ âœ… ä½¿ç”¨ orjsonï¼ˆæœ€å¿«ï¼‰ import orjson data = orjson.loads(json_bytes) json_bytes = orjson.dumps(data) âœ… JSON æ–‡ä»¶å¿…é¡» UTF-8 âœ… åºåˆ—åŒ– datetime orjson.dumps(data, option=orjson.OPT_SERIALIZE_DATACLASS) 11. æ–‡ä»¶æ•°æ®å¤„ç†æœ€ä½³å®è·µ âœ… with æ–¹å¼è¯»å– with open(\u0026#34;a.txt\u0026#34;) as f: lines = f.readlines() âœ… CSV è¯»å–ä½¿ç”¨ csv æ¨¡å— âœ… äºŒè¿›åˆ¶è¯»å–ä½¿ç”¨ rb / wb âœ… JSON æ–‡ä»¶é¿å… float ä¸¢å¤±ç²¾åº¦ ç”¨ Decimal è§£æã€‚\n12. HTTP / æ•°æ®åº“æ•°æ®å¤„ç†æœ€ä½³å®è·µ âœ… HTTP ç»Ÿä¸€å†™æˆ res = requests.get(url, timeout=10) res.raise_for_status() data = res.json() âœ… DB æŸ¥è¯¢ç»“æœè½¬ dictï¼ˆå¿…é¡»å·¥å…·å‡½æ•°å¤„ç†ï¼‰ None å¤„ç† datetime è½¬å­—ç¬¦ä¸² Decimal è½¬å­—ç¬¦ä¸² å»æ‰éå¿…è¦å­—æ®µ âœ… åˆ†é¡µå¿…é¡»ç»Ÿä¸€ limit/offset å·¥å…·å‡½æ•° 13. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ âœ… å¤§æ•°æ®ä½¿ç”¨ç”Ÿæˆå™¨ yield item\nâœ… ä½¿ç”¨ itertools å¤„ç†è¶…å¤§æ•°æ®æµ âœ… lru_cache ç¼“å­˜å¸¸ç”¨è®¡ç®— âœ… orjson æ›¿ä»£ json âœ… é¿å…æ·±å±‚ for åµŒå¥—ï¼ˆä½¿ç”¨ dict/set åŠ é€Ÿï¼‰ 14. å®‰å…¨æ³¨æ„äº‹é¡¹ ç¦æ­¢ evalï¼ˆé™¤éä¸¥æ ¼é™åˆ¶ï¼‰ ç¦æ­¢æ‹¼æ¥ SQLï¼ˆå¿…é¡»ä½¿ç”¨å‚æ•°ç»‘å®šï¼‰ ç¦æ­¢æœªçŸ¥æ¥æºçš„ JSON å­—æ®µç›´æ¥å†™å…¥æ•°æ®åº“ ç¦æ­¢æœª strip çš„å­—ç¬¦ä¸²å†™å…¥æ•°æ® 15. æ¨è utils åŒ…ç»“æ„ï¼ˆéå¸¸è§„èŒƒï¼‰ utils/ __init__.py string.py # å­—ç¬¦ä¸²å¤„ç† date.py # æ—¥æœŸæ—¶é—´å¤„ç† json.py # orjson åŒ…è£… data_clean.py # æ•°æ®æ¸…æ´— data_convert.py # ç±»å‹è½¬æ¢ validators.py # æ ¡éªŒå™¨ dict.py # å­—å…¸å·¥å…· list.py # åˆ—è¡¨å·¥å…· regex.py # æ­£åˆ™å·¥å…· ä¸‹é¢æ˜¯ä¸€ä»½ é¡¹ç›®çº§å¯ç›´æ¥ä½¿ç”¨çš„ã€Šå¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°åˆé›†ã€‹ã€‚\næ‰€æœ‰å‡½æ•°éƒ½ç»è¿‡ æœ€ä½³å®è·µè®¾è®¡ã€å¼ºç±»å‹ï¼ˆbasedpyright å‹å¥½ï¼‰ã€å…¼å®¹ Python 3.12ï¼Œä¹Ÿç¬¦åˆä½ å½“å‰é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨çš„å¤„ç†é€»è¾‘ã€‚\nä½ å¯ä»¥ç›´æ¥æ”¾å…¥ï¼š\nutils/data_utils.py\nâœ… Python å¸¸ç”¨æ•°æ®å¤„ç†å‡½æ•°ï¼ˆé¡¹ç›®çº§æœ€ä½³å®è·µï¼‰ ğŸ“Œ ç›®å½•\nå­—ç¬¦ä¸²å¤„ç† æ—¥æœŸ/æ—¶é—´å¤„ç† æ•°å­—å¤„ç† åˆ—è¡¨å¤„ç† å­—å…¸å¤„ç† æ­£åˆ™å¤„ç† JSON å¤„ç†ï¼ˆorjsonï¼‰ æ•°æ®æ¸…æ´— ç±»å‹è½¬æ¢ å…¶ä»–å·¥å…· 1. å­—ç¬¦ä¸²å¤„ç†å‡½æ•° def strip_string(s: str | None) -\u0026gt; str | None: \u0026#34;\u0026#34;\u0026#34;ç§»é™¤å‰åç©ºç™½ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰\u0026#34;\u0026#34;\u0026#34; return s.strip() if isinstance(s, str) else s def ensure_str(value) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;å¼ºåˆ¶è½¬æ¢ä¸º str\u0026#34;\u0026#34;\u0026#34; return value if isinstance(value, str) else str(value) def join_list(items: list[str], sep: str = \u0026#34;,\u0026#34;) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;å®‰å…¨ join\u0026#34;\u0026#34;\u0026#34; return sep.join(item.strip() for item in items if item) def substring(s: str, start: int, end: int | None = None) -\u0026gt; str: return s[start:end] 2. æ—¥æœŸ/æ—¶é—´å¤„ç†å‡½æ•° from datetime import datetime, date, timezone def to_datetime(s: str) -\u0026gt; datetime | None: \u0026#34;\u0026#34;\u0026#34;å­—ç¬¦ä¸²è½¬ datetimeï¼ˆè‡ªåŠ¨è¯†åˆ«å¸¸è§æ ¼å¼ï¼‰\u0026#34;\u0026#34;\u0026#34; patterns = [ \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;, \u0026#34;%Y-%m-%d\u0026#34;, \u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;, \u0026#34;%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S\u0026#34;, ] for p in patterns: try: return datetime.strptime(s, p).replace(tzinfo=timezone.utc) except Exception: pass return None def datetime_to_string(dt: datetime, fmt: str = \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) -\u0026gt; str: return dt.strftime(fmt) def timestamp_to_datetime(ts: int | float) -\u0026gt; datetime: return datetime.fromtimestamp(ts, tz=timezone.utc) def is_today(dt: datetime) -\u0026gt; bool: return dt.date() == date.today() 3. æ•°å­—å¤„ç†å‡½æ•° from decimal import Decimal, InvalidOperation def safe_int(value) -\u0026gt; int | None: try: return int(value) except Exception: return None def safe_decimal(value) -\u0026gt; Decimal | None: try: return Decimal(str(value)) except InvalidOperation: return None 4. åˆ—è¡¨å¤„ç† from typing import TypeVar, Callable, Iterable T = TypeVar(\u0026#34;T\u0026#34;) R = TypeVar(\u0026#34;R\u0026#34;) def map_filter(iterable: Iterable[T], func: Callable[[T], R]) -\u0026gt; list[R]: \u0026#34;\u0026#34;\u0026#34;map + filter None çš„ç»„åˆ\u0026#34;\u0026#34;\u0026#34; return [x for x in map(func, iterable) if x is not None] def flatten(list_of_lists: list[list[T]]) -\u0026gt; list[T]: \u0026#34;\u0026#34;\u0026#34;æ‹å¹³åˆ—è¡¨\u0026#34;\u0026#34;\u0026#34; return [item for sub in list_of_lists for item in sub] def unique(items: list[T]) -\u0026gt; list[T]: \u0026#34;\u0026#34;\u0026#34;ä¿æŒé¡ºåºçš„å»é‡\u0026#34;\u0026#34;\u0026#34; seen = set() result = [] for x in items: if x not in seen: seen.add(x) result.append(x) return result 5. å­—å…¸å¤„ç† def dict_pick(d: dict, keys: list[str]) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34;æå–æŒ‡å®šå­—æ®µ\u0026#34;\u0026#34;\u0026#34; return {k: d[k] for k in keys if k in d} def dict_rename(d: dict, mapping: dict[str, str]) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34;æ‰¹é‡é‡å‘½åå­—æ®µ\u0026#34;\u0026#34;\u0026#34; return {mapping.get(k, k): v for k, v in d.items()} def deep_get(d: dict, path: str, default=None): \u0026#34;\u0026#34;\u0026#34;åµŒå¥—å­—å…¸å–å€¼ user.profile.name\u0026#34;\u0026#34;\u0026#34; try: for key in path.split(\u0026#34;.\u0026#34;): d = d[key] return d except Exception: return default def clean_dict(d: dict) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34;ç§»é™¤å€¼ä¸ºç©ºçš„é¡¹\u0026#34;\u0026#34;\u0026#34; return {k: v for k, v in d.items() if v not in (\u0026#34;\u0026#34;, None, [], {})} 6. æ­£åˆ™å¤„ç† import re def regex_search(pattern: str, text: str) -\u0026gt; str | None: m = re.search(pattern, text) return m.group(1) if m else None def split_by_regex(pattern: str, text: str) -\u0026gt; list[str]: return re.split(pattern, text) def extract_after_equal(s: str) -\u0026gt; str | None: m = re.search(r\u0026#34;=([^\u0026amp;]+)\u0026#34;, s) return m.group(1) if m else None 7. JSONï¼ˆorjsonï¼‰å¤„ç† import orjson def json_loads(data: str | bytes): return orjson.loads(data) def json_dumps(obj) -\u0026gt; str: return orjson.dumps(obj).decode(\u0026#34;utf-8\u0026#34;) 8. æ•°æ®æ¸…æ´— def trim_dict_strings(d: dict) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34;ç§»é™¤ dict ä¸­æ‰€æœ‰å­—ç¬¦ä¸²çš„å‰åç©ºç™½\u0026#34;\u0026#34;\u0026#34; return {k: (v.strip() if isinstance(v, str) else v) for k, v in d.items()} def normalize_datetime_dict(d: dict) -\u0026gt; dict: \u0026#34;\u0026#34;\u0026#34;dict ä¸­ datetime è½¬å­—ç¬¦ä¸²\u0026#34;\u0026#34;\u0026#34; result = {} for k, v in d.items(): if isinstance(v, datetime): result[k] = v.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) elif isinstance(v, date): result[k] = v.strftime(\u0026#34;%Y-%m-%d\u0026#34;) else: result[k] = v return result 9. ç±»å‹è½¬æ¢ def auto_type(value: str): \u0026#34;\u0026#34;\u0026#34;è‡ªåŠ¨ç±»å‹è¯†åˆ«ï¼šint/float/bool\u0026#34;\u0026#34;\u0026#34; value = value.strip() if value.isdigit(): return int(value) try: return float(value) except Exception: return value 10. å…¶ä»–å·¥å…· from pathlib import Path def get_script_dir() -\u0026gt; Path: \u0026#34;\u0026#34;\u0026#34;è·å–å½“å‰è„šæœ¬ç›®å½•\u0026#34;\u0026#34;\u0026#34; return Path(__file__).resolve().parent ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿã€æœ€å®ç”¨çš„ã€ŒPython æ•°æ®å¤„ç†æ“ä½œå¤§å…¨ã€æ€»ç»“ï¼Œæ¶µç›– æ‰€æœ‰å¸¸è§æ•°æ®ç±»å‹ã€æ•°æ®ç»“æ„ã€æ•°æ®æ¥æºã€æ•°æ®è½¬æ¢æ–¹å¼ï¼Œéå¸¸é€‚åˆä½œä¸ºä½ ä¸ªäººçš„â€œæ•°æ®å¤„ç†é€ŸæŸ¥è¡¨â€ã€‚\nå†…å®¹ç»“æ„æŒ‰åœºæ™¯åˆ†ç±»ï¼Œéå¸¸æ¸…æ™°ã€‚\nğŸ”¥ Python æ•°æ®å¤„ç†å¤§å…¨ï¼ˆç³»ç»Ÿæ€»ç»“ï¼‰ ç›®å½•æ€»è§ˆï¼ˆæ‰€æœ‰åˆ†ç±»ï¼‰\nå­—ç¬¦ä¸²å¤„ç†ï¼ˆString Processingï¼‰ æ•°å­—å¤„ç†ï¼ˆNumber Processingï¼‰ å¸ƒå°”å¤„ç†ï¼ˆBoolean Processingï¼‰ æ—¥æœŸä¸æ—¶é—´å¤„ç†ï¼ˆDatetime Processingï¼‰ åˆ—è¡¨å¤„ç†ï¼ˆList Processingï¼‰ å…ƒç»„å¤„ç†ï¼ˆTuple Processingï¼‰ é›†åˆå¤„ç†ï¼ˆSet Processingï¼‰ å­—å…¸å¤„ç†ï¼ˆDict Processingï¼‰ JSON / TOML / YAML æ•°æ®å¤„ç† æ­£åˆ™è¡¨è¾¾å¼å¤„ç†ï¼ˆRegex Processingï¼‰ æ–‡ä»¶å¤„ç†ï¼ˆFile Processingï¼‰ æ•°æ®æ ¡éªŒä¸æ¸…æ´—ï¼ˆValidation / Cleaningï¼‰ ç±»å‹å¤„ç†ä¸è½¬æ¢ æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼ˆåºåˆ— -\u0026gt; å­—èŠ‚ / æ–‡ä»¶ï¼‰ æ•°æ®åº“æ•°æ®å¤„ç†ï¼ˆDB -\u0026gt; Python -\u0026gt; DBï¼‰ ç½‘ç»œæ•°æ®å¤„ç†ï¼ˆHTTP Response æ•°æ®ï¼‰ æ€§èƒ½ä¼˜åŒ–ç›¸å…³çš„æ•°æ®å¤„ç† 1. â­ å­—ç¬¦ä¸²å¤„ç†ï¼ˆString Processingï¼‰ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ å»å‰åç©ºç™½ strip() / lstrip() / rstrip() \u0026quot; abc \u0026ldquo;.strip() å¤§å°å†™è½¬æ¢ lower() / upper() / title() \u0026ldquo;Hello\u0026rdquo;.lower() æŸ¥æ‰¾ / æ›¿æ¢ find / replace \u0026ldquo;abc\u0026rdquo;.replace(\u0026ldquo;b\u0026rdquo;, \u0026ldquo;\u0026rdquo;) å­—ç¬¦ä¸²æ‹¼æ¥ + / join \u0026ldquo;a\u0026rdquo; + \u0026ldquo;b\u0026rdquo; / \u0026ldquo;.\u0026quot;.join(list) åˆ†å‰² split / rsplit \u0026ldquo;a,b\u0026rdquo;.split(\u0026rdquo;,\u0026rdquo;) åˆ¤æ–­å‰ç¼€ startswith \u0026ldquo;abc\u0026rdquo;.startswith(\u0026ldquo;a\u0026rdquo;) åˆ¤æ–­åç¼€ endswith \u0026ldquo;abc\u0026rdquo;.endswith(\u0026ldquo;c\u0026rdquo;) æ¨¡æ¿æ›¿æ¢ f-string f\u0026quot;{name}-{age}\u0026quot; æ­£åˆ™æ‹†åˆ† re.split re.split(r\u0026quot;\\W+\u0026quot;, s) æ ¼å¼åŒ– format / f-string f\u0026quot;{num:02d}\u0026quot; æ¸…æ´—ç‰¹æ®Šå­—ç¬¦ re.sub re.sub(r\u0026quot;\\s+\u0026quot;, \u0026quot; \u0026ldquo;, s) æå–æ•°å­— æ­£åˆ™ re.findall(r\u0026rdquo;\\d+\u0026quot;, s) 2. â­ æ•°å­—å¤„ç†ï¼ˆNumber Processingï¼‰ ç±»å‹ è¯´æ˜ å››èˆäº”å…¥ round() è½¬æ¢ç±»å‹ int() / float() / Decimal() åŠ å‡ä¹˜é™¤ ç²¾åº¦è¿ç®— Decimal åˆ†æ•°è®¡ç®— Fraction æ¯”è¾ƒå¤§å° åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—ï¼ˆregex / str.isdigitï¼‰ ç§‘å­¦è®¡æ•°æ³•è½¬æ¢ 3. â­ å¸ƒå°”å¤„ç†ï¼ˆBooleanï¼‰ å¸¸ç”¨äºåˆ¤æ–­ï¼š\n"},{"id":165,"href":"/backend/python/official/datetime/","title":"Datetime (æ—¥æœŸæ—¶é—´)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/datetime.html\nğŸŸ¦ 1. Python datetime ç”Ÿæ€çš„ 4 å¤§æ ¸å¿ƒç±»å‹ ç±»å‹ è¯´æ˜ datetime.datetime æ—¥æœŸ + æ—¶é—´ï¼ˆæœ€å¸¸ç”¨ï¼‰ datetime.date åªæœ‰æ—¥æœŸ datetime.time åªæœ‰æ—¶é—´ datetime.timedelta æ—¶é—´å·® æœ€å¸¸ç”¨çš„æ˜¯ datetime.datetimeã€‚\nğŸŸ© 2. è·å–å½“å‰æ—¶é—´ from datetime import datetime now = datetime.now() utc_now = datetime.utcnow() âš ï¸ utcnow() è¿”å›â€œå¤©çœŸæ—¶é—´â€ï¼ˆæ— æ—¶åŒºï¼‰ã€‚\nğŸŸ¦ 3. å­—ç¬¦ä¸² â‡„ datetime äº’è½¬ å­—ç¬¦ä¸² -\u0026gt; datetimeï¼ˆè§£æï¼‰\nfrom datetime import datetime dt = datetime.strptime(\u0026#34;2025-06-24 10:30:00\u0026#34;, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) datetime -\u0026gt; å­—ç¬¦ä¸²ï¼ˆæ ¼å¼åŒ–ï¼‰\ns = dt.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) å¸¸è§æ ¼å¼åŒ–æ ‡è®°ï¼š\næ ‡è®° å«ä¹‰ %Y 4ä½å¹´ä»½ %m æœˆ %d æ—¥ %H å°æ—¶ %M åˆ†é’Ÿ %S ç§’ %f å¾®ç§’ ğŸŸ© 4. æ—¥æœŸè®¡ç®—ï¼ˆtimedeltaï¼‰ from datetime import timedelta yesterday = datetime.now() - timedelta(days=1) after_30_min = datetime.now() + timedelta(minutes=30) ğŸŸ¦ 5. æå–æ—¥æœŸã€æ—¶é—´éƒ¨åˆ† dt = datetime.now() date_part = dt.date() # datetime.date time_part = dt.time() # datetime.time year = dt.year month = dt.month day = dt.day hour = dt.hour minute = dt.minute second = dt.second ğŸŸ© 6. åˆ›å»ºæ—¥æœŸ/æ—¶é—´å¯¹è±¡ æ—¥æœŸ\nfrom datetime import date d = date(2025, 6, 24) æ—¶é—´\nfrom datetime import time t = time(14, 30, 0) æ—¥æœŸ + æ—¶é—´\nfrom datetime import datetime dt = datetime(2025, 6, 24, 14, 30, 0) ğŸŸ¦ 7. æ—¶åŒºå¤„ç†ï¼ˆå¼ºçƒˆæ¨è zoneinfoï¼‰ Python 3.9+ å†…ç½®ï¼š\nfrom datetime import datetime from zoneinfo import ZoneInfo dt = datetime.now(ZoneInfo(\u0026#34;Asia/Shanghai\u0026#34;)) æ—¶åŒºè½¬æ¢\nutc = dt.astimezone(ZoneInfo(\u0026#34;UTC\u0026#34;)) ğŸŸ© 8. datetime å’Œ timestamp äº’è½¬ datetime -\u0026gt; timestamp\nts = dt.timestamp() timestamp -\u0026gt; datetime\ndt = datetime.fromtimestamp(ts) ğŸŸ¦ 9. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µï¼ˆå·¥ç¨‹çº§ï¼‰ âŒ ä¸è¦ä½¿ç”¨ naive datetimeï¼ˆæ— æ—¶åŒºï¼‰\nNaive datetime åœ¨å¤šæœºéƒ¨ç½²ã€æ—¥å¿—ç³»ç»Ÿã€APIã€æ•°æ®åº“æ—¶ä¼šå‡ºé—®é¢˜ã€‚\nâœ… æœ€ä½³å®è·µï¼š\nè·å–æ—¶é—´å§‹ç»ˆå¸¦æ—¶åŒº å­˜æ•°æ®åº“ç”¨ UTC API è¾“å‡ºç”¨ ISO8601ï¼ˆå¸¦ Zï¼‰ ğŸŸ© 10. Pythonic æ—¥æœŸå·¥å…·å‡½æ•°ï¼ˆä½ é¡¹ç›®ä¼šç”¨åˆ°ï¼‰ å®‰å…¨è§£æï¼ˆè‡ªåŠ¨åˆ¤æ–­æ ¼å¼ï¼‰\nfrom datetime import datetime def parse_dt(s: str) -\u0026gt; datetime | None: for fmt in (\u0026#34;%Y-%m-%d\u0026#34;, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;, \u0026#34;%Y/%m/%d\u0026#34;): try: return datetime.strptime(s, fmt) except ValueError: continue return None ğŸŸ¦ 11. å¸¸ç”¨æ ¼å¼é€ŸæŸ¥è¡¨ éœ€æ±‚ æ ¼å¼ æ ‡å‡†æ—¶é—´ %Y-%m-%d %H:%M:%S æ—¥æœŸ %Y-%m-%d ä»…æ—¶é—´ %H:%M:%S æ–‡ä»¶åå®‰å…¨ %Y%m%d_%H%M%S ISO8601 dt.isoformat() ğŸŸ© 12. ä½ çš„é¡¹ç›®å®é™…ä½¿ç”¨ç¤ºä¾‹ FastAPI JSON è¾“å‡º datetimes\nFastAPI ä¼šè‡ªåŠ¨ä¾ç…§ ISO8601 è¾“å‡ºï¼š\n\u0026ldquo;2025-06-24T10:30:00+08:00\u0026rdquo;\nSQLAlchemyï¼ˆPostgreSQLï¼‰\nä½ å¸¸ä½¿ç”¨ï¼š\nDate DateTime(timezone=True) æ¨èï¼š\nColumn(DateTime(timezone=True), server_default=func.now()) ğŸŸ¦ 13. datetime é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰ åŠŸèƒ½ å†™æ³• å½“å‰æ—¶é—´ datetime.now() å½“å‰ UTC datetime.now(ZoneInfo(\u0026quot;UTC\u0026quot;)) å­—ç¬¦ä¸²è§£æ datetime.strptime() æ ¼å¼åŒ–å­—ç¬¦ä¸² datetime.strftime() æ—¶é—´å·® datetime.now() - datetime.now() åŠ åˆ†é’Ÿ dt + timedelta(minutes=30) è½¬æ—¶é—´æˆ³ dt.timestamp() ä»æ—¶é—´æˆ³æ¢å¤ datetime.fromtimestamp(ts) å–æ—¥æœŸ dt.date() å–æ—¶é—´ dt.time() æ—¶åŒºè½¬æ¢ dt.astimezone() ISO8601 è¾“å‡º dt.isoformat() ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/datetime.html\nğŸŸ¦ 1. Python datetime ç”Ÿæ€çš„ 4 å¤§æ ¸å¿ƒç±»å‹ ç±»å‹ è¯´æ˜ datetime.datetime æ—¥æœŸ + æ—¶é—´ï¼ˆæœ€å¸¸ç”¨ï¼‰ datetime.date åªæœ‰æ—¥æœŸ datetime.time åªæœ‰æ—¶é—´ datetime.timedelta æ—¶é—´å·® æœ€å¸¸ç”¨çš„æ˜¯ datetime.datetimeã€‚\nğŸŸ© 2. è·å–å½“å‰æ—¶é—´ from datetime import datetime now = datetime.now() utc_now = datetime.utcnow() âš ï¸ utcnow() è¿”å›â€œå¤©çœŸæ—¶é—´â€ï¼ˆæ— æ—¶åŒºï¼‰ã€‚\n"},{"id":166,"href":"/operations/debezium/","title":"Debezium","parent":"Operations","content":"å®˜æ–¹ä»“åº“ï¼šhttps://github.com/debezium/debezium\nDocument List:\nDebezium åŸºç¡€æ•™ç¨‹ Debezium æ ¸å¿ƒæ¦‚å¿µ Debezium sync MySQL to ElasticSearch Debezium sync PostgreSQL to ElasticSearch Debezium æ€§èƒ½ä¼˜åŒ– Debezium æ•…éšœæ’æŸ¥ ","description":"å®˜æ–¹ä»“åº“ï¼šhttps://github.com/debezium/debezium\nDocument List:\nDebezium åŸºç¡€æ•™ç¨‹ Debezium æ ¸å¿ƒæ¦‚å¿µ Debezium sync MySQL to ElasticSearch Debezium sync PostgreSQL to ElasticSearch Debezium æ€§èƒ½ä¼˜åŒ– Debezium æ•…éšœæ’æŸ¥ "},{"id":167,"href":"/operations/debezium/sync-mysql-to-elasticsearch/","title":"Debezium sync MySQL to ElasticSearch","parent":"Debezium","content":"ä½¿ç”¨ Debezium å°† MySQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° ElasticSearch\nå†…å®¹ï¼šæ¶æ„ -\u0026gt; åŸç† -\u0026gt; å®æ“ -\u0026gt; å…³é”®é…ç½® -\u0026gt; å¸¸è§å‘\nä¸€ã€æ•´ä½“æ¶æ„ï¼ˆå…ˆæœ‰å…¨å±€æ„Ÿï¼‰ MySQL â†“ (binlog, ROW) Debezium MySQL Connector â†“ Kafka Topic â†“ Kafka Connect Elasticsearch Sink â†“ Elasticsearch Index ğŸ‘‰ Debezium åªè´Ÿè´£ CDC ğŸ‘‰ çœŸæ­£å†™ ES çš„æ˜¯ Elasticsearch Sink Connector äºŒã€ä¸ºä»€ä¹ˆä¸ç”¨â€œDebezium ç›´æ¥å†™ ESâ€ Debezium æ˜¯ Source Connector ES æ˜¯ Sink èŒè´£åˆ†ç¦»ï¼š Debeziumï¼šæ•è·å˜æ›´ ES Sinkï¼šç´¢å¼• / upsert / delete ğŸ‘‰ è¿™æ˜¯ å®˜æ–¹æ¨èæ¶æ„\nä¸‰ã€å‰ç½®æ¡ä»¶ 1ï¸âƒ£ MySQL é…ç½®ï¼ˆå¿…é¡»ï¼‰ [mysqld] server-id=1 log-bin=mysql-bin binlog_format=ROW binlog_row_image=FULL é‡å¯ MySQL åç¡®è®¤ï¼š\nSHOW VARIABLES LIKE \u0026#39;binlog_format\u0026#39;; 2ï¸âƒ£ MySQL è´¦å·æƒé™ CREATE USER \u0026#39;debezium\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;password\u0026#39;; GRANT REPLICATION SLAVE, REPLICATION CLIENT, SELECT ON *.* TO \u0026#39;debezium\u0026#39;@\u0026#39;%\u0026#39;; FLUSH PRIVILEGES; 3ï¸âƒ£ ç»„ä»¶ç‰ˆæœ¬å»ºè®® ç»„ä»¶ å»ºè®® MySQL 8.0.x Kafka â‰¥ 3.x Debezium â‰¥ 2.x Elasticsearch 7.x / 8.x å››ã€Docker Compose ä¸€é”®ç¯å¢ƒï¼ˆæ¨èï¼‰ ç”¨äº å­¦ä¹  / PoC / æµ‹è¯•\ndocker-compose.ymlï¼ˆç®€åŒ–ç‰ˆï¼‰\nversion: \u0026#34;3.8\u0026#34; services: zookeeper: image: confluentinc/cp-zookeeper environment: ZOOKEEPER_CLIENT_PORT: 2181 kafka: image: confluentinc/cp-kafka depends_on: [zookeeper] environment: KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092 KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 mysql: image: mysql:8.0 environment: MYSQL_ROOT_PASSWORD: root ports: - \u0026#34;3306:3306\u0026#34; connect: image: debezium/connect:2.5 ports: - \u0026#34;8083:8083\u0026#34; depends_on: [kafka, mysql] environment: BOOTSTRAP_SERVERS: kafka:9092 GROUP_ID: 1 CONFIG_STORAGE_TOPIC: connect-configs OFFSET_STORAGE_TOPIC: connect-offsets STATUS_STORAGE_TOPIC: connect-status äº”ã€é…ç½® Debezium MySQL Connectorï¼ˆCDCï¼‰ POST http://localhost:8083/connectors { \u0026#34;name\u0026#34;: \u0026#34;mysql-debezium\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.mysql.MySqlConnector\u0026#34;, \u0026#34;database.hostname\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;database.port\u0026#34;: \u0026#34;3306\u0026#34;, \u0026#34;database.user\u0026#34;: \u0026#34;debezium\u0026#34;, \u0026#34;database.password\u0026#34;: \u0026#34;password\u0026#34;, \u0026#34;database.server.id\u0026#34;: \u0026#34;184054\u0026#34;, \u0026#34;database.server.name\u0026#34;: \u0026#34;mysql01\u0026#34;, \u0026#34;database.include.list\u0026#34;: \u0026#34;testdb\u0026#34;, \u0026#34;table.include.list\u0026#34;: \u0026#34;testdb.users\u0026#34;, \u0026#34;snapshot.mode\u0026#34;: \u0026#34;initial\u0026#34;, \u0026#34;include.schema.changes\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;database.history.kafka.bootstrap.servers\u0026#34;: \u0026#34;kafka:9092\u0026#34;, \u0026#34;database.history.kafka.topic\u0026#34;: \u0026#34;schema-changes.mysql\u0026#34; } } ç”Ÿæˆçš„ Kafka Topic\nmysql01.testdb.users å…­ã€é…ç½® Elasticsearch Sink Connector POST http://localhost:8083/connectors { \u0026#34;name\u0026#34;: \u0026#34;es-sink\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector\u0026#34;, \u0026#34;connection.url\u0026#34;: \u0026#34;http://elasticsearch:9200\u0026#34;, \u0026#34;topics\u0026#34;: \u0026#34;mysql01.testdb.users\u0026#34;, \u0026#34;key.ignore\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;schema.ignore\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;write.method\u0026#34;: \u0026#34;upsert\u0026#34;, \u0026#34;behavior.on.null.values\u0026#34;: \u0026#34;delete\u0026#34;, \u0026#34;transforms\u0026#34;: \u0026#34;unwrap\u0026#34;, \u0026#34;transforms.unwrap.type\u0026#34;: \u0026#34;io.debezium.transforms.ExtractNewRecordState\u0026#34;, \u0026#34;transforms.unwrap.drop.tombstones\u0026#34;: \u0026#34;false\u0026#34; } } ä¸ƒã€MySQL -\u0026gt; ES æ•°æ®æ˜ å°„å…³ç³» MySQL æ“ä½œ ES è¡Œä¸º insert index update update / upsert delete delete å…³é”®é…ç½®ï¼š\nwrite.method=upsert behavior.on.null.values=delete å…«ã€äº‹ä»¶â€œç˜¦èº«â€ï¼ˆéå¸¸é‡è¦ï¼‰ Debezium åŸå§‹äº‹ä»¶ï¼ˆå¾ˆå¤§ï¼‰\n{ \u0026#34;before\u0026#34;: {...}, \u0026#34;after\u0026#34;: {...}, \u0026#34;op\u0026#34;: \u0026#34;u\u0026#34; } unwrap åï¼ˆæ¨èï¼‰\n{ \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;å¼ ä¸‰\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2025-01-01\u0026#34; } ğŸ‘‰ ES åªå…³å¿ƒ after\nä¹ã€ES Index è®¾è®¡å»ºè®®ï¼ˆç”Ÿäº§é‡ç‚¹ï¼‰ 1ï¸âƒ£ ä¸»é”®ä¸€è‡´ MySQL PK -\u0026gt; Kafka key -\u0026gt; ES _id 2ï¸âƒ£ å­—æ®µç±»å‹æå‰å»º mapping PUT users { \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;id\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;long\u0026#34; }, \u0026#34;name\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34; }, \u0026#34;created_at\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;date\u0026#34; } } } } ğŸ‘‰ é¿å…åŠ¨æ€ mapping ç¿»è½¦\nåã€å¸¸è§é—®é¢˜ \u0026amp; æ’å‘ 1ï¸âƒ£ ES æœ‰æ•°æ®ä½†æ›´æ–°ä¸ç”Ÿæ•ˆ âŒ æ²¡ç”¨ upsert\nâœ… write.method=upsert\n2ï¸âƒ£ delete ä¸åŒæ­¥ âŒ tombstone è¢«ä¸¢\nâœ… behavior.on.null.values=delete\n3ï¸âƒ£ æ•°æ®é‡å¤ ğŸ‘‰ æ­£å¸¸\nDebezium = at-least-once ES ç”¨ _id è¦†ç›–å³å¯ 4ï¸âƒ£ è¡¨æ²¡æœ‰ä¸»é”® âŒ update/delete å¼‚å¸¸\nğŸ‘‰ MySQL CDC å¼ºçƒˆè¦æ±‚ä¸»é”®\nåä¸€ã€ç”Ÿäº§çº§ä¼˜åŒ–å»ºè®®ï¼ˆé‡ç‚¹ï¼‰ åªåŒæ­¥ å¿…è¦è¡¨ / å­—æ®µ å¤§è¡¨å…ˆç¦»çº¿å¯¼å…¥ï¼Œå† CDC ES Sink æ‰¹é‡å†™ Kafka Topic åˆç†åˆ†åŒº binlog ä¸è¦å †ç§¯ åäºŒã€æ€»ç»“ MySQL -\u0026gt; Debezium -\u0026gt; Kafka -\u0026gt; ES Sink\n= å½“å‰æœ€ç¨³å¦¥ã€å¯æ‰©å±•ã€å¯è¿ç»´çš„å®æ—¶åŒæ­¥æ–¹æ¡ˆ\n","description":"ä½¿ç”¨ Debezium å°† MySQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° ElasticSearch\nå†…å®¹ï¼šæ¶æ„ -\u0026gt; åŸç† -\u0026gt; å®æ“ -\u0026gt; å…³é”®é…ç½® -\u0026gt; å¸¸è§å‘\nä¸€ã€æ•´ä½“æ¶æ„ï¼ˆå…ˆæœ‰å…¨å±€æ„Ÿï¼‰ MySQL â†“ (binlog, ROW) Debezium MySQL Connector â†“ Kafka Topic â†“ Kafka Connect Elasticsearch Sink â†“ Elasticsearch Index ğŸ‘‰ Debezium åªè´Ÿè´£ CDC ğŸ‘‰ çœŸæ­£å†™ ES çš„æ˜¯ Elasticsearch Sink Connector äºŒã€ä¸ºä»€ä¹ˆä¸ç”¨â€œDebezium ç›´æ¥å†™ ESâ€ Debezium æ˜¯ Source Connector ES æ˜¯ Sink èŒè´£åˆ†ç¦»ï¼š Debeziumï¼šæ•è·å˜æ›´ ES Sinkï¼šç´¢å¼• / upsert / delete ğŸ‘‰ è¿™æ˜¯ å®˜æ–¹æ¨èæ¶æ„\n"},{"id":168,"href":"/operations/debezium/sync-postgres-to-elasticsearch/","title":"Debezium sync PostgreSQL to ElasticSearch","parent":"Debezium","content":"ä½¿ç”¨ Debezium å°† PostgreSQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° ElasticSearch\nå†…å®¹ï¼šæ¶æ„ -\u0026gt; åŸç† -\u0026gt; å®æ“ -\u0026gt; å…³é”®é…ç½® -\u0026gt; ç”Ÿäº§æ³¨æ„ç‚¹\né‡ç‚¹ï¼šPostgreSQLï¼ˆlogical replicationï¼‰\nä¸€ã€æ•´ä½“æ¶æ„ï¼ˆæ ‡å‡†åšæ³•ï¼‰ PostgreSQL â†“ (WAL / logical decoding) Debezium PostgreSQL Connector â†“ Kafka Topic â†“ Kafka Connect Elasticsearch Sink â†“ Elasticsearch Index Debezium è´Ÿè´£â€œæŠ“å˜æ›´â€ï¼ŒES Sink è´Ÿè´£â€œå†™ç´¢å¼•â€\näºŒã€æ ¸å¿ƒåŸç†ï¼ˆPG ä¸“å±ï¼‰ PostgreSQL å†™æ•°æ® -\u0026gt; WAL Debezium é€šè¿‡ logical replication slot è¯»å– WAL å°†å˜æ›´è½¬æˆ CDC äº‹ä»¶å†™å…¥ Kafka ES Sink ä» Kafka æ¶ˆè´¹å¹¶ upsert / delete åˆ° ES ğŸ“Œ PG çš„ CDC å¼ºä¾èµ– replication slot\nä¸‰ã€å‰ç½®æ¡ä»¶ï¼ˆå¿…é¡»ï¼‰ 1ï¸âƒ£ PostgreSQL å‚æ•°é…ç½® wal_level = logical max_replication_slots = 4 max_wal_senders = 4 é‡å¯ PostgreSQL ç”Ÿæ•ˆã€‚\n2ï¸âƒ£ æ•°æ®è¡¨è¦æ±‚ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… å¿…é¡»æœ‰ Primary Key âŒ æ²¡ä¸»é”® -\u0026gt; update / delete æ— æ³•æ­£ç¡®åŒæ­¥ 3ï¸âƒ£ æ•°æ®åº“ç”¨æˆ·æƒé™ CREATE ROLE debezium WITH LOGIN REPLICATION PASSWORD \u0026#39;password\u0026#39;; GRANT SELECT ON ALL TABLES IN SCHEMA public TO debezium; ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO debezium; å››ã€Docker Composeï¼ˆæ¨èç”¨äºéªŒè¯ / PoCï¼‰ è¿™æ˜¯ æœ€å°å¯ç”¨ ç‰ˆæœ¬ï¼Œç”Ÿäº§è¯·æ‹†åˆ†éƒ¨ç½²ã€‚\nversion: \u0026#34;3.8\u0026#34; services: zookeeper: image: confluentinc/cp-zookeeper environment: ZOOKEEPER_CLIENT_PORT: 2181 kafka: image: confluentinc/cp-kafka depends_on: [zookeeper] environment: KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092 KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 postgres: image: postgres:15 environment: POSTGRES_PASSWORD: postgres ports: - \u0026#34;5432:5432\u0026#34; connect: image: debezium/connect:2.5 ports: - \u0026#34;8083:8083\u0026#34; depends_on: [kafka, postgres] environment: BOOTSTRAP_SERVERS: kafka:9092 GROUP_ID: 1 CONFIG_STORAGE_TOPIC: connect-configs OFFSET_STORAGE_TOPIC: connect-offsets STATUS_STORAGE_TOPIC: connect-status äº”ã€é…ç½® Debezium PostgreSQL Connector POST http://localhost:8083/connectors { \u0026#34;name\u0026#34;: \u0026#34;pg-debezium\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;io.debezium.connector.postgresql.PostgresConnector\u0026#34;, \u0026#34;database.hostname\u0026#34;: \u0026#34;postgres\u0026#34;, \u0026#34;database.port\u0026#34;: \u0026#34;5432\u0026#34;, \u0026#34;database.user\u0026#34;: \u0026#34;debezium\u0026#34;, \u0026#34;database.password\u0026#34;: \u0026#34;password\u0026#34;, \u0026#34;database.dbname\u0026#34;: \u0026#34;postgres\u0026#34;, \u0026#34;slot.name\u0026#34;: \u0026#34;debezium_slot\u0026#34;, \u0026#34;plugin.name\u0026#34;: \u0026#34;pgoutput\u0026#34;, \u0026#34;schema.include.list\u0026#34;: \u0026#34;public\u0026#34;, \u0026#34;table.include.list\u0026#34;: \u0026#34;public.users\u0026#34;, \u0026#34;snapshot.mode\u0026#34;: \u0026#34;initial\u0026#34;, \u0026#34;include.schema.changes\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;topic.prefix\u0026#34;: \u0026#34;pg01\u0026#34; } } Kafka Topic å‘½å\npg01.public.users å…­ã€é…ç½® Elasticsearch Sink Connector POST http://localhost:8083/connectors { \u0026#34;name\u0026#34;: \u0026#34;es-sink\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;connector.class\u0026#34;: \u0026#34;io.confluent.connect.elasticsearch.ElasticsearchSinkConnector\u0026#34;, \u0026#34;connection.url\u0026#34;: \u0026#34;http://elasticsearch:9200\u0026#34;, \u0026#34;topics\u0026#34;: \u0026#34;pg01.public.users\u0026#34;, \u0026#34;key.ignore\u0026#34;: \u0026#34;false\u0026#34;, \u0026#34;schema.ignore\u0026#34;: \u0026#34;true\u0026#34;, \u0026#34;write.method\u0026#34;: \u0026#34;upsert\u0026#34;, \u0026#34;behavior.on.null.values\u0026#34;: \u0026#34;delete\u0026#34;, \u0026#34;transforms\u0026#34;: \u0026#34;unwrap\u0026#34;, \u0026#34;transforms.unwrap.type\u0026#34;: \u0026#34;io.debezium.transforms.ExtractNewRecordState\u0026#34;, \u0026#34;transforms.unwrap.drop.tombstones\u0026#34;: \u0026#34;false\u0026#34; } } ä¸ƒã€PostgreSQL -\u0026gt; ES è¡Œä¸ºæ˜ å°„ PG æ“ä½œ Kafka äº‹ä»¶ ES è¡Œä¸º INSERT op=c index UPDATE op=u upsert DELETE op=d + tombstone delete å…³é”®é…ç½®ï¼š\nwrite.method=upsert behavior.on.null.values=delete å…«ã€äº‹ä»¶ç˜¦èº«ï¼ˆå¼ºçƒˆæ¨èï¼‰ Debezium åŸå§‹äº‹ä»¶\n{ \u0026#34;before\u0026#34;: {...}, \u0026#34;after\u0026#34;: {...}, \u0026#34;source\u0026#34;: {...}, \u0026#34;op\u0026#34;: \u0026#34;u\u0026#34; } unwrap åï¼ˆES å‹å¥½ï¼‰\n{ \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;Alice\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2025-01-01T10:00:00\u0026#34; } ğŸ‘‰ ES åªéœ€è¦ after\nä¹ã€ES Index è®¾è®¡ï¼ˆç”Ÿäº§é‡ç‚¹ï¼‰ 1ï¸âƒ£ ä¸»é”®æ˜ å°„ PG ä¸»é”® -\u0026gt; Kafka key -\u0026gt; ES _id 2ï¸âƒ£ æå‰å»º Mappingï¼ˆé¿å…ç¿»è½¦ï¼‰ PUT users { \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;id\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;long\u0026#34; }, \u0026#34;name\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34; }, \u0026#34;created_at\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;date\u0026#34; } } } } åã€PostgreSQL ä¸“å±å‘ï¼ˆå¿…é¡»çœ‹ï¼‰ 1ï¸âƒ£ Replication Slot å †ç§¯ï¼ˆé«˜å±ï¼‰ Debezium åœäº† WAL ä¸æ¸…ç† ç£ç›˜çˆ†æ»¡ æ’æŸ¥ï¼š\nSELECT slot_name, active FROM pg_replication_slots; 2ï¸âƒ£ å¤§äº‹åŠ¡ ä¸€æ¬¡ UPDATE ç™¾ä¸‡è¡Œ WAL å·¨å¤§ ES å†™å…¥è¢«æ‰“çˆ† ğŸ‘‰ æ‹†äº‹åŠ¡ã€é™æµ\n3ï¸âƒ£ æ²¡ä¸»é”® update/delete ä¸ç¨³å®š ğŸ‘‰ CDC è®¾è®¡å¤±è´¥ åä¸€ã€ç”Ÿäº§ä¼˜åŒ–å»ºè®® åªåŒæ­¥å¿…è¦è¡¨ / å­—æ®µ å¤§è¡¨å…ˆ ç¦»çº¿å¯¼å…¥ ES CDC åªè·‘å¢é‡ ES Sink æ‰¹é‡å†™ ç›‘æ§ slot / WAL / Kafka lag åäºŒã€æ€»ç»“ PostgreSQL -\u0026gt; Debezium -\u0026gt; Kafka -\u0026gt; ES\næ˜¯å½“å‰æœ€ç¨³å®šã€æœ€å¯æ§ã€æœ€å¯æ‰©å±•çš„å®æ—¶åŒæ­¥æ–¹æ¡ˆ\n","description":"ä½¿ç”¨ Debezium å°† PostgreSQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° ElasticSearch\nå†…å®¹ï¼šæ¶æ„ -\u0026gt; åŸç† -\u0026gt; å®æ“ -\u0026gt; å…³é”®é…ç½® -\u0026gt; ç”Ÿäº§æ³¨æ„ç‚¹\né‡ç‚¹ï¼šPostgreSQLï¼ˆlogical replicationï¼‰\nä¸€ã€æ•´ä½“æ¶æ„ï¼ˆæ ‡å‡†åšæ³•ï¼‰ PostgreSQL â†“ (WAL / logical decoding) Debezium PostgreSQL Connector â†“ Kafka Topic â†“ Kafka Connect Elasticsearch Sink â†“ Elasticsearch Index Debezium è´Ÿè´£â€œæŠ“å˜æ›´â€ï¼ŒES Sink è´Ÿè´£â€œå†™ç´¢å¼•â€\näºŒã€æ ¸å¿ƒåŸç†ï¼ˆPG ä¸“å±ï¼‰ PostgreSQL å†™æ•°æ® -\u0026gt; WAL Debezium é€šè¿‡ logical replication slot è¯»å– WAL å°†å˜æ›´è½¬æˆ CDC äº‹ä»¶å†™å…¥ Kafka ES Sink ä» Kafka æ¶ˆè´¹å¹¶ upsert / delete åˆ° ES ğŸ“Œ PG çš„ CDC å¼ºä¾èµ– replication slot\n"},{"id":169,"href":"/operations/debezium/performance/","title":"Debezium æ€§èƒ½ä¼˜åŒ–","parent":"Debezium","content":"Debezium çš„æ€§èƒ½ç“¶é¢ˆ 80% ä¸åœ¨ Debezium æœ¬èº«ï¼Œè€Œåœ¨ æ•°æ®åº“æ—¥å¿— -\u0026gt; Snapshot -\u0026gt; Kafka -\u0026gt; ä¸‹æ¸¸æ¶ˆè´¹ è¿™æ¡é“¾è·¯çš„ååŒé…ç½®ã€‚\nä¸€ã€æ€§èƒ½ç“¶é¢ˆæ•´ä½“è§†è§’ï¼ˆå…ˆæœ‰å…¨å±€è§‚ï¼‰ DB å†™å…¥ â†“ WAL / binlog ç”Ÿæˆ â† DB æ€§èƒ½ â†“ Debezium è§£ææ—¥å¿— â† Connector é…ç½® â†“ Kafka å†™å…¥ â† Kafka åå â†“ Consumer å¤„ç† â† ä¸‹æ¸¸ç³»ç»Ÿ ä»»ä½•ä¸€ç¯æ…¢ï¼Œéƒ½ä¼šâ€œçœ‹èµ·æ¥åƒ Debezium æ…¢â€\näºŒã€æ•°æ®åº“å±‚ä¼˜åŒ–ï¼ˆæœ€å…³é”®ï¼‰ 1ï¸âƒ£ PostgreSQL âœ… è¡¨å¿…é¡»æœ‰ Primary Key\næ²¡ä¸»é”®ï¼š update / delete éœ€è¦å…¨è¡¨ before image WAL ä½“ç§¯æš´æ¶¨ Debezium è§£ææ…¢ ğŸ‘‰ æ€§èƒ½ + æ­£ç¡®æ€§åŒæ€\nâœ… åˆç†è®¾ç½® WAL å‚æ•°\nwal_level = logical max_replication_slots = è¶³å¤Ÿå¤§ max_wal_senders = \u0026gt;= Debezium æ•°é‡ âš ï¸ æ§åˆ¶ WAL ç”Ÿæˆé‡\né¿å…ï¼š å¤§äº‹åŠ¡ï¼ˆä¸€æ¬¡æ›´æ–°ç™¾ä¸‡è¡Œï¼‰ æ— è°“çš„ UPDATEï¼ˆå€¼æ²¡å˜ä¹Ÿ updateï¼‰ ğŸ‘‰ WAL è¶Šå¤§ï¼ŒDebezium è¶Šæ…¢\n2ï¸âƒ£ é¿å…â€œWAL å †ç§¯â€ Debezium åœæ­¢ Slot ä¸æ¶ˆè´¹ WAL æ— é™å¢é•¿ åæœï¼š\nIO çˆ† ç£ç›˜æ»¡ æ•°æ®åº“è¢«æ‹–æ­» ğŸ‘‰ ç›‘æ§ replication slot æ˜¯ç”Ÿäº§å¿…åšé¡¹\nä¸‰ã€Snapshot æ€§èƒ½ä¼˜åŒ–ï¼ˆæœ€å®¹æ˜“è¸©å‘ï¼‰ 1ï¸âƒ£ Snapshot æ˜¯æœ€é‡çš„é˜¶æ®µ å…¨è¡¨æ‰«æ å¤§é‡äº‹ä»¶ Kafka å‹åŠ›é™¡å¢ 2ï¸âƒ£ Snapshot ä¼˜åŒ–ç­–ç•¥ âœ… æ§åˆ¶ snapshot æ¨¡å¼\nsnapshot.mode=initial | never | when_needed å·²æœ‰æ•°æ®åŒæ­¥è¿‡ï¼š ğŸ‘‰ never æ–°è¡¨ä¸Šçº¿ï¼š ğŸ‘‰ when_needed âœ… å¹¶è¡Œ Snapshotï¼ˆè°¨æ…ï¼‰\nsnapshot.fetch.size=2000 å¤ªå¤§ -\u0026gt; DB å‹åŠ› å¤ªå° -\u0026gt; snapshot æ…¢ âœ… åˆ†è¡¨ snapshotï¼ˆè®¾è®¡å±‚é¢ï¼‰\næ‹†çƒ­ç‚¹å¤§è¡¨ å†å²è¡¨ä¸åš CDC å››ã€Debezium Connector å±‚ä¼˜åŒ– 1ï¸âƒ£ æ‰¹å¤„ç†å‚æ•°ï¼ˆååå…³é”®ï¼‰ max.batch.size=2048 max.queue.size=8192 poll.interval.ms=100 å«ä¹‰ï¼š\nmax.batch.sizeï¼šä¸€æ¬¡å‘é€å¤šå°‘äº‹ä»¶ max.queue.sizeï¼šå†…å­˜ç¼“å†² poll.interval.msï¼šæ‹‰å–é¢‘ç‡ ğŸ‘‰ åå vs å†…å­˜ çš„æƒè¡¡\n2ï¸âƒ£ å‡å°‘æ— ç”¨æ•°æ®ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… åªåŒæ­¥å¿…è¦è¡¨\ntable.include.list=public.users,public.orders âœ… åªåŒæ­¥å¿…è¦å­—æ®µ\ncolumn.include.list=public.users.id,public.users.name ğŸ‘‰ WAL ä¸å˜ï¼Œä½† Kafka / ç½‘ç»œ / Consumer å‹åŠ›éª¤å‡\n3ï¸âƒ£ å…³é—­ä¸éœ€è¦çš„åŠŸèƒ½ include.schema.changes=false tombstones.on.delete=false äº”ã€Kafka å±‚ä¼˜åŒ–ï¼ˆååå¤©èŠ±æ¿ï¼‰ 1ï¸âƒ£ Topic åˆ†åŒºæ•° Debezium é»˜è®¤ï¼š 1 è¡¨ -\u0026gt; 1 topic å• topic ååä¸å¤Ÿï¼š å¢åŠ åˆ†åŒºæ•° âš ï¸ å‰æï¼š\nkey æ˜¯ä¸»é”® èƒ½æ¥å—ä¹±åºï¼ˆè·¨ keyï¼‰ 2ï¸âƒ£ Producer å‚æ•°ï¼ˆKafka Connectï¼‰ producer.linger.ms=10 producer.batch.size=65536 producer.compression.type=lz4 ğŸ‘‰ ååæå‡æ˜æ˜¾\nå…­ã€äº‹ä»¶ä½“ç§¯ä¼˜åŒ–ï¼ˆéå¸¸æœ‰æ•ˆï¼‰ 1ï¸âƒ£ ä½¿ç”¨ ExtractNewRecordStateï¼ˆå¼ºçƒˆæ¨èï¼‰ transforms=unwrap transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState æ•ˆæœï¼š\n// åŸå§‹ { before, after, source, op } // unwrap å { id, name, updated_at } ğŸ‘‰ æ¶ˆæ¯ä½“ç§¯ â†“ 50%~80%\n2ï¸âƒ£ Schema Registryï¼ˆç”Ÿäº§æ¨èï¼‰ Avro / Protobuf JSON ä½“ç§¯å¤§ã€CPU é«˜ ä¸ƒã€ä¸‹æ¸¸ Consumer ä¼˜åŒ–ï¼ˆåˆ«å¿½ç•¥ï¼‰ 1ï¸âƒ£ å¹‚ç­‰å†™å…¥ upsert replace by primary key 2ï¸âƒ£ æ‰¹é‡æ¶ˆè´¹ poll 1000 æ¡ bulk insert / bulk update 3ï¸âƒ£ é¿å…â€œæ…¢æ¶ˆè´¹è€…â€ Consumer æ…¢ Kafka backlog Debezium è¢«åå‹ ğŸ‘‰ çœ‹èµ·æ¥åƒ Debezium æ…¢ï¼Œå®é™…æ˜¯ Consumer æ…¢\nå…«ã€ç›‘æ§ä¸æŒ‡æ ‡ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰ å¿…çœ‹æŒ‡æ ‡\nreplication slot lagï¼ˆPGï¼‰ WAL ç£ç›˜ä½¿ç”¨ Kafka topic lag Connect task çŠ¶æ€ Debezium queue ä½¿ç”¨ç‡ ä¹ã€å¸¸è§æ€§èƒ½è¯¯åŒºï¼ˆè¡€å‘ï¼‰ âŒ æ²¡ä¸»é”® âŒ å¤§äº‹åŠ¡ + CDC âŒ snapshot æœŸé—´å…¨ä¸šåŠ¡é«˜å³° âŒ ä¸é™åˆ¶è¡¨ / å­—æ®µ âŒ slot ä¸ç›‘æ§ âŒ Kafka åˆ†åŒºè¿‡å°‘ åã€æ€»ç»“ Debezium æ€§èƒ½ä¼˜åŒ– = å‡ WAL + æ§ Snapshot + é™äº‹ä»¶ä½“ç§¯ + ä¿ Kafka åå + é˜²æ…¢æ¶ˆè´¹è€…\n","description":"Debezium çš„æ€§èƒ½ç“¶é¢ˆ 80% ä¸åœ¨ Debezium æœ¬èº«ï¼Œè€Œåœ¨ æ•°æ®åº“æ—¥å¿— -\u0026gt; Snapshot -\u0026gt; Kafka -\u0026gt; ä¸‹æ¸¸æ¶ˆè´¹ è¿™æ¡é“¾è·¯çš„ååŒé…ç½®ã€‚\nä¸€ã€æ€§èƒ½ç“¶é¢ˆæ•´ä½“è§†è§’ï¼ˆå…ˆæœ‰å…¨å±€è§‚ï¼‰ DB å†™å…¥ â†“ WAL / binlog ç”Ÿæˆ â† DB æ€§èƒ½ â†“ Debezium è§£ææ—¥å¿— â† Connector é…ç½® â†“ Kafka å†™å…¥ â† Kafka åå â†“ Consumer å¤„ç† â† ä¸‹æ¸¸ç³»ç»Ÿ ä»»ä½•ä¸€ç¯æ…¢ï¼Œéƒ½ä¼šâ€œçœ‹èµ·æ¥åƒ Debezium æ…¢â€\näºŒã€æ•°æ®åº“å±‚ä¼˜åŒ–ï¼ˆæœ€å…³é”®ï¼‰ 1ï¸âƒ£ PostgreSQL âœ… è¡¨å¿…é¡»æœ‰ Primary Key\n"},{"id":170,"href":"/operations/debezium/troubleshooting/","title":"Debezium æ•…éšœæ’æŸ¥","parent":"Debezium","content":"å†…å®¹ï¼šç°è±¡ -\u0026gt; åŸå›  -\u0026gt; æ’æŸ¥ -\u0026gt; è§£å†³\né‡ç‚¹è¦†ç›– PostgreSQL + Kafka + Debezium çš„çœŸå®æ•…éšœã€‚\nä¸€ã€å®šä½æ€»å›¾ æ•°æ®åº“å†™å…¥ â†“ WAL / binlog â†“ â†â‘  DB é—®é¢˜ï¼Ÿ Debezium Connector â†“ â†â‘¡ Connector é—®é¢˜ï¼Ÿ Kafka Topic â†“ â†â‘¢ Kafka é—®é¢˜ï¼Ÿ Consumer â†â‘£ ä¸‹æ¸¸æ…¢ï¼Ÿ ç¬¬ä¸€åŸåˆ™ï¼š\nğŸ‘‰ ä¸è¦ä¸€ä¸Šæ¥å°±é‡å¯ Debezium\näºŒã€Debezium å¸¸è§æ•…éšœæ€»è§ˆ ç°è±¡ æœ€å¯èƒ½åŸå›  æ•°æ®ä¸å†åŒæ­¥ Slot / binlog ä¸­æ–­ å»¶è¿Ÿè¶Šæ¥è¶Šå¤§ ä¸‹æ¸¸æ…¢ / Kafka backlog PG ç£ç›˜çˆ†æ»¡ Slot å †ç§¯ WAL Connector FAILED schema / æƒé™ / DDL é‡å¯åæ•°æ®é‡å¤ at-least-once æ­£å¸¸ç°è±¡ Snapshot å¡ä½ å¤§è¡¨ / é” / IO ä¸‰ã€PostgreSQL ç›¸å…³æ•…éšœï¼ˆæœ€è‡´å‘½ï¼‰ 1ï¸âƒ£ WAL æ— é™å¢é•¿ï¼ˆé«˜å±ï¼‰ ç°è±¡ PG ç£ç›˜æš´æ¶¨ pg_wal ç›®å½•å·¨å¤§ DB å˜æ…¢ç”šè‡³åªè¯» åŸå›  Debezium åœæ­¢ Replication Slot æ²¡æ¶ˆè´¹ PG ä¸æ•¢åˆ é™¤ WAL æ’æŸ¥ SELECT slot_name, active, pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag FROM pg_replication_slots; è§£å†³ âš ï¸ ä¼šä¸¢ CDC æ•°æ®ï¼Œè°¨æ…\nSELECT pg_drop_replication_slot(\u0026#39;debezium_slot\u0026#39;); ğŸ‘‰ æ­£ç¡®åšæ³• å…ˆæ¢å¤ Debezium å†ç¡®è®¤ slot æ¶ˆè´¹ 2ï¸âƒ£ Debezium å¯åŠ¨å¤±è´¥ï¼ˆPGï¼‰ ç°è±¡ Connector FAILED æ—¥å¿—æœ‰ï¼š permission denied logical decoding requires wal_level=logical æ’æŸ¥æ¸…å• wal_level = logical max_replication_slots \u0026gt;= 1 max_wal_senders \u0026gt;= 1 -- ç”¨æˆ·æƒé™ ALTER ROLE debezium WITH REPLICATION; 3ï¸âƒ£ è¡¨ update/delete ä¸ç”Ÿæ•ˆ ç°è±¡ insert æœ‰ update / delete æ²¡äº‹ä»¶ åŸå›  è¡¨ æ²¡æœ‰ Primary Key è§£å†³ ALTER TABLE xxx ADD PRIMARY KEY (id); å››ã€Snapshot ç›¸å…³æ•…éšœ 4ï¸âƒ£ Snapshot å¡ä½ / ææ…¢ ç°è±¡ op=r æŒç»­å¾ˆä¹… Kafka æµé‡æš´æ¶¨ DB IO é£™å‡ æ’æŸ¥ è¡¨è¡Œæ•°æ˜¯å¦å·¨å¤§ æ˜¯å¦å…¨è¡¨ snapshot æ˜¯å¦ä¸šåŠ¡é«˜å³°æœŸ è§£å†³ snapshot.mode=when_needed snapshot.fetch.size=1000 ğŸ‘‰ å¤§è¡¨ åˆ†è¡¨ ç¦»çº¿å¯¼ä¸€æ¬¡ CDC åªè·‘å¢é‡ 5ï¸âƒ£ Snapshot åæ•°æ®é‡å¤ åŸå›  snapshot + WAL æœ¬èº«å°±ä¼šé‡å¤ä¸€æ¬¡è¾¹ç•Œæ•°æ® Debezium è¯­ä¹‰æ­£å¸¸ æ­£ç¡®å¤„ç† ä¸‹æ¸¸ å¹‚ç­‰ upsert ä»¥ä¸»é”®è¦†ç›– äº”ã€Kafka / Connect å±‚æ•…éšœ 6ï¸âƒ£ Connector çŠ¶æ€ FAILED æ’æŸ¥é¡ºåº\nGET /connectors GET /connectors/{name}/status çœ‹ï¼š\nconnector task trace å¸¸è§åŸå› \nKafka Topic ä¸å­˜åœ¨ Schema ä¸å…¼å®¹ transform é…ç½®é”™è¯¯ DDL è§£æå¤±è´¥ 7ï¸âƒ£ Kafka Topic Lag è¶Šæ¥è¶Šå¤§ åŸå› \nConsumer æ…¢ Kafka åˆ†åŒºå¤ªå°‘ ç£ç›˜ / ç½‘ç»œç“¶é¢ˆ æ’æŸ¥\nkafka-consumer-groups.sh --describe å…­ã€æ•°æ®é—®é¢˜ï¼ˆæœ€å®¹æ˜“è¯¯åˆ¤ï¼‰ 8ï¸âƒ£ æ•°æ®é‡å¤ï¼ˆæœ€å¸¸è§è¯¯ä¼šï¼‰ åŸå› \nDebezium æ˜¯ at-least-once é‡å¯ / rebalance éƒ½å¯èƒ½é‡å¤ æ­£ç¡®å§¿åŠ¿\nä¸»é”®ä½œä¸º key ä¸‹æ¸¸ upsert ğŸ‘‰ ä¸æ˜¯ bug\n9ï¸âƒ£ æ•°æ®ä¹±åº åŸå› \nå¤šåˆ†åŒº å¤šè¡¨ äº‹å®\nå• key é¡ºåºä¿è¯ è·¨ key / è·¨è¡¨ âŒ ä¸ƒã€DDL / Schema é—®é¢˜ ğŸ”Ÿ è¡¨ç»“æ„å˜æ›´å Connector æŒ‚æ‰ åŸå› \nä¸å…¼å®¹ DDL å­—æ®µç±»å‹ Debezium ä¸æ”¯æŒ è§£å†³\ninclude.schema.changes=false æˆ–ï¼š\nåœ Debezium æ”¹è¡¨ é‡å¯ å…«ã€æ—¥å¿—æ’æŸ¥å…³é”®ç‚¹ï¼ˆå¿…çœ‹ï¼‰ Debezium æ—¥å¿—é‡ç‚¹å…³é”®è¯\nFAILED WARN replication slot offset unable to parse out of memory Kafka Connect å†…éƒ¨ Topic\nTopic ä½œç”¨ connect-offsets è¯»åˆ°å“ª connect-status çŠ¶æ€ connect-configs é…ç½® ä¹ã€æ•…éšœæ’æŸ¥ SOPï¼ˆè®°ä½è¿™ä¸ªï¼‰ Connector çŠ¶æ€ï¼Ÿ Task çŠ¶æ€ï¼Ÿ Slot æ˜¯å¦ activeï¼Ÿ WAL æ˜¯å¦å †ç§¯ï¼Ÿ Kafka lagï¼Ÿ Consumer æ˜¯å¦æ…¢ï¼Ÿ åã€ç”Ÿäº§çº§â€œä¿å‘½æ¸…å•â€ âœ… ç›‘æ§ replication slot âœ… ç›‘æ§ pg_wal ç£ç›˜ âœ… Consumer å¹‚ç­‰ âœ… Snapshot é¿å¼€é«˜å³° âœ… Connector è‡ªåŠ¨é‡å¯ âœ… Topic ç£ç›˜å®¹é‡è§„åˆ’ åä¸€ã€æ€»ç»“ Debezium å‡ºé—®é¢˜ï¼Œ80% æ˜¯ Slot / Snapshot / Consumerï¼Œä¸æ˜¯ Debezium æœ¬èº«ã€‚\n","description":"å†…å®¹ï¼šç°è±¡ -\u0026gt; åŸå›  -\u0026gt; æ’æŸ¥ -\u0026gt; è§£å†³\né‡ç‚¹è¦†ç›– PostgreSQL + Kafka + Debezium çš„çœŸå®æ•…éšœã€‚\nä¸€ã€å®šä½æ€»å›¾ æ•°æ®åº“å†™å…¥ â†“ WAL / binlog â†“ â†â‘  DB é—®é¢˜ï¼Ÿ Debezium Connector â†“ â†â‘¡ Connector é—®é¢˜ï¼Ÿ Kafka Topic â†“ â†â‘¢ Kafka é—®é¢˜ï¼Ÿ Consumer â†â‘£ ä¸‹æ¸¸æ…¢ï¼Ÿ ç¬¬ä¸€åŸåˆ™ï¼š\nğŸ‘‰ ä¸è¦ä¸€ä¸Šæ¥å°±é‡å¯ Debezium\näºŒã€Debezium å¸¸è§æ•…éšœæ€»è§ˆ ç°è±¡ æœ€å¯èƒ½åŸå›  æ•°æ®ä¸å†åŒæ­¥ Slot / binlog ä¸­æ–­ å»¶è¿Ÿè¶Šæ¥è¶Šå¤§ ä¸‹æ¸¸æ…¢ / Kafka backlog PG ç£ç›˜çˆ†æ»¡ Slot å †ç§¯ WAL Connector FAILED schema / æƒé™ / DDL é‡å¯åæ•°æ®é‡å¤ at-least-once æ­£å¸¸ç°è±¡ Snapshot å¡ä½ å¤§è¡¨ / é” / IO ä¸‰ã€PostgreSQL ç›¸å…³æ•…éšœï¼ˆæœ€è‡´å‘½ï¼‰ 1ï¸âƒ£ WAL æ— é™å¢é•¿ï¼ˆé«˜å±ï¼‰ ç°è±¡ PG ç£ç›˜æš´æ¶¨ pg_wal ç›®å½•å·¨å¤§ DB å˜æ…¢ç”šè‡³åªè¯» åŸå›  Debezium åœæ­¢ Replication Slot æ²¡æ¶ˆè´¹ PG ä¸æ•¢åˆ é™¤ WAL æ’æŸ¥ SELECT slot_name, active, pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag FROM pg_replication_slots; è§£å†³ âš ï¸ ä¼šä¸¢ CDC æ•°æ®ï¼Œè°¨æ…\n"},{"id":171,"href":"/backend/python/official/decimal/","title":"Decimal (åè¿›åˆ¶å°æ•°)","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ éå¸¸æ¸…æ™°ã€éå¸¸å®ç”¨çš„ Python decimal é€ŸæŸ¥ä¸æœ€ä½³å®è·µæŒ‡å—ï¼Œå°¤å…¶é€‚ç”¨äºä½ åš é‡‘èã€é‡‘é¢ã€ç²¾åº¦æ•æ„Ÿè®¡ç®— çš„åœºæ™¯ã€‚\nğŸ”¥ 1. decimal æ˜¯ä»€ä¹ˆï¼Ÿ decimal.Decimal æ˜¯ Python ç”¨æ¥è¿›è¡Œé«˜ç²¾åº¦ã€å°æ•°ä¸ä¼šä¸¢å¤±çš„è®¡ç®—çš„æ•°æ®ç±»å‹ã€‚\né€‚ç”¨åœºæ™¯ï¼š\né‡‘èé‡‘é¢è®¡ç®—ï¼ˆé¿å…æµ®ç‚¹è¯¯å·®ï¼‰ éœ€è¦ç²¾ç¡®çš„å°æ•°ï¼ˆå¦‚ä»·æ ¼ã€è´¹ç‡ã€ç¨ç‡ï¼‰ å¯¹æ¯” floatï¼ŒDecimal å®Œå…¨ä¸ä¼šå‡ºç° 0.1 + 0.2 != 0.3 çš„é—®é¢˜ ğŸ§ª 2. ä¸ float çš„å¯¹æ¯”ï¼ˆç›´è§‚ç¤ºä¾‹ï¼‰ \u0026gt;\u0026gt;\u0026gt; 0.1 + 0.2 0.30000000000000004 # æµ®ç‚¹è¯¯å·® \u0026gt;\u0026gt;\u0026gt; from decimal import Decimal \u0026gt;\u0026gt;\u0026gt; Decimal(\u0026#39;0.1\u0026#39;) + Decimal(\u0026#39;0.2\u0026#39;) Decimal(\u0026#39;0.3\u0026#39;) # ç²¾ç¡® ğŸš€ 3. åŸºæœ¬ç”¨æ³• 3.1 åˆ›å»º Decimal â— å¿…é¡»ç”¨å­—ç¬¦ä¸²åˆå§‹åŒ–ï¼Œå¦åˆ™ä»ç„¶ä¼šå¸¦å…¥æµ®ç‚¹è¯¯å·®ï¼\nfrom decimal import Decimal Decimal(\u0026#34;1.23\u0026#34;) # æ­£ç¡® Decimal(1.23) # é”™è¯¯ï¼Œä¼šå¸¦å…¥æµ®ç‚¹è¯¯å·® 3.2 åŸºæœ¬è®¡ç®— a = Decimal(\u0026#34;1.2\u0026#34;) b = Decimal(\u0026#34;1.3\u0026#34;) c = a + b # åŠ  d = a * b # ä¹˜ e = b - a # å‡ f = b / a # é™¤ ğŸ§­ 4. è®¾ç½®ç²¾åº¦ï¼ˆä¸Šä¸‹æ–‡ Contextï¼‰ å…¨å±€è®¾ç½®ï¼š\nfrom decimal import Decimal, getcontext getcontext().prec = 10 # è®¾ç½®ç²¾åº¦ä¸º 10 ä½ å±€éƒ¨è®¾ç½®ï¼š\nfrom decimal import localcontext with localcontext() as ctx: ctx.prec = 5 print(Decimal(\u0026#39;1\u0026#39;) / Decimal(\u0026#39;7\u0026#39;)) ğŸš 5. å››èˆäº”å…¥é‡åŒ–ï¼ˆquantizeï¼‰ è¿™æ˜¯é‡‘é¢æœ€å¸¸ç”¨çš„æ“ä½œã€‚\nfrom decimal import Decimal, ROUND_HALF_UP # ä¿ç•™ 2 ä½å°æ•° value = Decimal(\u0026#34;3.14159\u0026#34;).quantize(Decimal(\u0026#34;0.01\u0026#34;), rounding=ROUND_HALF_UP) print(value) # 3.14 å¸¸è§ rounding æ–¹æ³•ï¼š\nROUND_HALF_UPï¼ˆæœ€å¸¸ç”¨ï¼Œå››èˆäº”å…¥ï¼‰ ROUND_DOWNï¼ˆå‘ä¸‹å–ï¼‰ ROUND_UPï¼ˆå‘ä¸Šå–ï¼‰ ROUND_HALF_EVENï¼ˆé“¶è¡Œå®¶èˆå…¥ï¼‰ ğŸ§© 6. ä¸ Floatã€intã€str çš„è½¬æ¢ Decimal(\u0026#34;1.23\u0026#34;) # str -\u0026gt; Decimal float(Decimal(\u0026#34;1.23\u0026#34;)) # Decimal -\u0026gt; float int(Decimal(\u0026#34;3.14\u0026#34;)) # Decimal -\u0026gt; int ğŸ§¨ 7. é¿å…æ··åˆç±»å‹è®¡ç®— â— åƒä¸‡ä¸è¦ï¼š\nDecimal(\u0026#34;1.2\u0026#34;) + 1.2 # âŒ Decimal(\u0026#34;1.2\u0026#34;) * 3 # å¯ä»¥ï¼Œä½†å»ºè®®ä¿æŒä¸€è‡´ å»ºè®®ç»Ÿä¸€è§„èŒƒï¼š\né‡‘é¢ç»Ÿä¸€ç”¨ Decimal æ°¸è¿œä½¿ç”¨å­—ç¬¦ä¸²åˆå§‹åŒ– ğŸ¦ 8. é‡‘é¢è®¡ç®—æœ€ä½³å®è·µå‡½æ•°ï¼ˆä½ å¯ç›´æ¥åŠ å…¥ utilsï¼‰ from decimal import Decimal, ROUND_HALF_UP def money(value: str | float | Decimal) -\u0026gt; Decimal: \u0026#34;\u0026#34;\u0026#34;é‡‘é¢è½¬æ¢ä¸º 2 ä½å°æ•° Decimal\u0026#34;\u0026#34;\u0026#34; if isinstance(value, float): value = str(value) return Decimal(value).quantize(Decimal(\u0026#34;0.01\u0026#34;), rounding=ROUND_HALF_UP) ç¤ºä¾‹ï¼š\nmoney(\u0026#34;1.236\u0026#34;) # Decimal(\u0026#39;1.24\u0026#39;) money(1.2) # Decimal(\u0026#39;1.20\u0026#39;) money(Decimal(\u0026#34;3\u0026#34;)) # Decimal(\u0026#39;3.00\u0026#39;) ğŸ¤– 9. åœ¨ä½ çš„å®é™…é¡¹ç›®ï¼ˆFastAPI + PostgreSQLï¼‰ä¸­çš„ä½¿ç”¨å»ºè®® SQLAlchemy å­—æ®µï¼š\nfrom sqlalchemy import Numeric price = Column(Numeric(10, 2)) # Decimal ä¼šè‡ªåŠ¨æ˜ å°„ Pydantic è½¬æ¢ï¼š\nPydantic ä¼šè‡ªåŠ¨æŠŠ Numeric -\u0026gt; Decimalã€‚\næ¥å£æ•°æ® JSON åºåˆ—åŒ–ï¼š\nä½ éœ€è¦ Decimal -\u0026gt; strï¼Œå¦åˆ™æ— æ³• JSON åŒ–\nimport json from decimal import Decimal json.dumps({\u0026#34;price\u0026#34;: Decimal(\u0026#34;1.23\u0026#34;)}, default=str) ğŸ“Œ 10. å°ç»“ï¼ˆé€ŸæŸ¥ç‰ˆï¼‰ åŠŸèƒ½ å†™æ³• åˆ›å»º Decimal Decimal(\u0026ldquo;1.23\u0026rdquo;) è®¾ç½®ç²¾åº¦ getcontext().prec = 10 å››èˆäº”å…¥ .quantize(Decimal(\u0026ldquo;0.01\u0026rdquo;), ROUND_HALF_UP) é¿å…è¯¯å·® ä¸è¦ç”¨ Decimal(1.23) JSON è½¬æ¢ json.dumps(\u0026hellip;, default=str) é‡‘é¢æœ€ä½³å®è·µ ç”¨å­—ç¬¦ä¸²åˆ›å»ºï¼Œç»Ÿä¸€é‡åŒ– Next é«˜ç²¾åº¦è®¡ç®—\n# æ•°å­—/æµ®ç‚¹æ•° -\u0026gt; è½¬å­—ç¬¦ä¸² -\u0026gt; Decimal è®¡ç®— -\u0026gt; å°†ç»“æœè½¬ä¸ºæµ®ç‚¹æ•° float(Decimal(str(0.1)) + Decimal(str(0.2))) # 0.3 ","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ éå¸¸æ¸…æ™°ã€éå¸¸å®ç”¨çš„ Python decimal é€ŸæŸ¥ä¸æœ€ä½³å®è·µæŒ‡å—ï¼Œå°¤å…¶é€‚ç”¨äºä½ åš é‡‘èã€é‡‘é¢ã€ç²¾åº¦æ•æ„Ÿè®¡ç®— çš„åœºæ™¯ã€‚\nğŸ”¥ 1. decimal æ˜¯ä»€ä¹ˆï¼Ÿ decimal.Decimal æ˜¯ Python ç”¨æ¥è¿›è¡Œé«˜ç²¾åº¦ã€å°æ•°ä¸ä¼šä¸¢å¤±çš„è®¡ç®—çš„æ•°æ®ç±»å‹ã€‚\né€‚ç”¨åœºæ™¯ï¼š\né‡‘èé‡‘é¢è®¡ç®—ï¼ˆé¿å…æµ®ç‚¹è¯¯å·®ï¼‰ éœ€è¦ç²¾ç¡®çš„å°æ•°ï¼ˆå¦‚ä»·æ ¼ã€è´¹ç‡ã€ç¨ç‡ï¼‰ å¯¹æ¯” floatï¼ŒDecimal å®Œå…¨ä¸ä¼šå‡ºç° 0.1 + 0.2 != 0.3 çš„é—®é¢˜ ğŸ§ª 2. ä¸ float çš„å¯¹æ¯”ï¼ˆç›´è§‚ç¤ºä¾‹ï¼‰ \u0026gt;\u0026gt;\u0026gt; 0.1 + 0.2 0.30000000000000004 # æµ®ç‚¹è¯¯å·® \u0026gt;\u0026gt;\u0026gt; from decimal import Decimal \u0026gt;\u0026gt;\u0026gt; Decimal(\u0026#39;0.1\u0026#39;) + Decimal(\u0026#39;0.2\u0026#39;) Decimal(\u0026#39;0.3\u0026#39;) # ç²¾ç¡® ğŸš€ 3. åŸºæœ¬ç”¨æ³• 3.1 åˆ›å»º Decimal â— å¿…é¡»ç”¨å­—ç¬¦ä¸²åˆå§‹åŒ–ï¼Œå¦åˆ™ä»ç„¶ä¼šå¸¦å…¥æµ®ç‚¹è¯¯å·®ï¼\n"},{"id":172,"href":"/backend/python/official/decorator-classmethod/","title":"Decorator -- classmethod","parent":"Official","content":" ğŸš€ 1. classmethod æ˜¯ä»€ä¹ˆï¼Ÿ @classmethod ç”¨æ¥æŠŠç±»ä¸­çš„æ–¹æ³•æ ‡è®°ä¸º ç±»æ–¹æ³•ï¼š\nä¼šè‡ªåŠ¨æ¥æ”¶ clsï¼ˆç±»æœ¬èº«ï¼‰ï¼Œè€Œä¸æ˜¯å®ä¾‹ é€‚åˆå¤„ç†â€œå…¨å±€äºç±»â€çš„é€»è¾‘ å¸¸ç”¨äºå·¥å‚æ–¹æ³•ã€é…ç½®æ–¹æ³•ã€æ‰¹é‡åˆ›å»ºå¯¹è±¡ç­‰ ç¤ºä¾‹ï¼š\nclass Demo: @classmethod def show(cls): print(cls) è°ƒç”¨ï¼š\nDemo.show() # \u0026lt;class \u0026#39;__main__.Demo\u0026#39;\u0026gt; Demo().show() # \u0026lt;class \u0026#39;__main__.Demo\u0026#39;\u0026gt; ğŸ“Œ 2. ä¸ staticmethod å’Œæ™®é€šæ–¹æ³•å¯¹æ¯”ï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰ æ–¹æ³•ç±»å‹ è‡ªåŠ¨æ¥æ”¶å‚æ•° å…¸å‹ç”¨é€” æ™®é€šæ–¹æ³• (def method(self)) selfï¼ˆå®ä¾‹ï¼‰ æ“ä½œå®ä¾‹æ•°æ® ç±»æ–¹æ³• (@classmethod) clsï¼ˆç±»ï¼‰ å·¥å‚æ–¹æ³•ã€åˆ›å»ºå®ä¾‹ã€è®¿é—®ç±»å±æ€§ é™æ€æ–¹æ³• (@staticmethod) æ—  å·¥å…·å‡½æ•°ï¼Œä¸ç±»ç›¸å…³ä½†ä¸éœ€è¦è®¿é—®ç±»æˆ–å®ä¾‹ ğŸ“Œ 3. æœ€ç®€å•ç¤ºä¾‹ class User: count = 0 def __init__(self): User.count += 1 @classmethod def get_count(cls): return cls.count ä½¿ç”¨ï¼š\nprint(User.get_count()) ğŸ“Œ 4. âœ¨ æœ€å¸¸ç”¨åœºæ™¯ï¼šå·¥å‚æ–¹æ³•ï¼ˆå¼ºçƒˆå»ºè®®æŒæ¡ï¼‰ ä½ åˆ›å»ºå¯¹è±¡æ—¶ï¼Œé™¤äº† __init__ï¼Œè¿˜å¯èƒ½éœ€è¦åŸºäºä¸åŒè¾“å…¥åˆ›å»ºå¯¹è±¡ï¼Œè¿™å°±æ˜¯å·¥å‚æ–¹æ³•çš„å…¸å‹åœºæ™¯ã€‚\nä¾‹å¦‚ï¼ŒæŠŠ JSON å­—å…¸å˜æˆå¯¹è±¡ï¼š\nclass User: def __init__(self, name, age): self.name = name self.age = age @classmethod def from_dict(cls, data: dict): return cls(data[\u0026#34;name\u0026#34;], data[\u0026#34;age\u0026#34;]) ä½¿ç”¨ï¼š\nuser = User.from_dict({\u0026#34;name\u0026#34;: \u0026#34;jack\u0026#34;, \u0026#34;age\u0026#34;: 18}) ğŸ“Œ 5. âœ¨ å…è®¸å­ç±»è‡ªåŠ¨ç»§æ‰¿æ­£ç¡®çš„ç±»ï¼ˆclassmethod æœ€å¤§æ„ä¹‰ï¼‰ class Animal: @classmethod def create(cls, name): return cls(name) # æ³¨æ„ï¼šè¿™é‡Œè¿”å›çš„æ˜¯ *å­ç±»* çš„å®ä¾‹ class Dog(Animal): def __init__(self, name): self.name = name d = Dog.create(\u0026#34;æ—ºè´¢\u0026#34;) print(type(d)) # \u0026lt;class \u0026#39;__main__.Dog\u0026#39;\u0026gt; è‹¥ç”¨ staticmethodï¼Œå°±æ— æ³•è‡ªåŠ¨è¿”å›å­ç±»å®ä¾‹ã€‚\nğŸ“Œ 6. âœ¨ é…ç½®åŠ è½½å™¨ï¼ˆFastAPIã€ä½ çš„é¡¹ç›®éƒ½èƒ½ç”¨ï¼‰ ä½ é¡¹ç›®å¯ä»¥è¿™æ ·å†™å…¨å±€é…ç½®ï¼š\nclass AppConfig: ENV = \u0026#34;production\u0026#34; @classmethod def is_prod(cls): return cls.ENV == \u0026#34;production\u0026#34; ä½¿ç”¨ï¼š\nif AppConfig.is_prod(): ... ğŸ“Œ 7. âœ¨ æ•°æ®åº“æ¨¡å‹æ‰¹é‡åˆ›å»ºï¼ˆä½ çš„ SQLAlchemy åœºæ™¯ï¼‰ class UserModel(Base): ... @classmethod def create_many(cls, session, items: list[dict]): objects = [cls(**item) for item in items] session.add_all(objects) session.commit() return objects ğŸ“Œ 8. âœ¨ å•ä¾‹æ¨¡å¼ï¼ˆé«˜çº§ç”¨æ³•ï¼‰ class Singleton: _instance = None @classmethod def get_instance(cls): if cls._instance is None: cls._instance = cls() return cls._instance ğŸ“Œ 9. âœ¨ ä½œä¸ºâ€œæ„é€ å™¨â€çš„å¢å¼ºç‰ˆ init ä½ å¸Œæœ›ä¸åŒçš„è¾“å…¥æ ¼å¼åˆ›å»ºå¯¹è±¡ï¼š\nclass Date: def __init__(self, year, month, day): self.year = year self.month = month self.day = day @classmethod def from_string(cls, s: str): y, m, d = map(int, s.split(\u0026#34;-\u0026#34;)) return cls(y, m, d) ä½¿ç”¨ï¼š\nd = Date.from_string(\u0026#34;2025-06-21\u0026#34;) ğŸ“Œ 10. å®ç°ä¸€ä¸ªä½ é¡¹ç›®å¯ä»¥ç›´æ¥ç”¨çš„å·¥å…·ç±» ä½ å¸¸ç”¨çš„ â€œstock coderenameâ€ å¯ä»¥æ”¹æˆ classmethodï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰©å±•å­ç±»ï¼š\nclass StockCodeUtil: prefix_map = { \u0026#34;00\u0026#34;: \u0026#34;sz\u0026#34;, \u0026#34;60\u0026#34;: \u0026#34;sh\u0026#34;, } @classmethod def encode(cls, code: str): for k, v in cls.prefix_map.items(): if code.startswith(k): return code.replace(k, v, 1) return code @classmethod def decode(cls, code: str): for k, v in cls.prefix_map.items(): if code.startswith(v): return code.replace(v, k, 1) return code ğŸ“Œ 11. ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨ classmethodï¼Ÿ å»ºè®®ä½¿ç”¨ classmethod çš„åœºæ™¯ï¼š\nå·¥å‚å‡½æ•° éœ€è¦è®¿é—®ç±»å±æ€§ éœ€è¦è¿”å›å½“å‰ç±»æˆ–å­ç±»çš„å®ä¾‹ å•ä¾‹æ¨¡å¼ æ‰¹é‡åˆ›å»ºå¯¹è±¡ æ•°æ®è½¬æ¢ï¼ˆfrom_dict, from_json, from_xxxï¼‰ ç¯å¢ƒé…ç½®ã€åˆå§‹åŒ–é€»è¾‘ ğŸ“Œ 12. ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨ classmethodï¼Ÿ âŒ å½“éœ€è¦è®¿é—®å®ä¾‹å±æ€§æ—¶ï¼ˆç”¨ selfï¼‰ âŒ å½“æ–¹æ³•å®Œå…¨å’Œç±»æ— å…³æ—¶ï¼ˆç”¨ staticmethodï¼‰ ğŸ“Œ 13. æ€»ç»“ï¼ˆæœ€å®ç”¨è®°å¿†æ³•ï¼‰ ğŸ’¡ ä½¿ç”¨è§„åˆ™ï¼š\néœ€è¦ self -\u0026gt; æ™®é€šæ–¹æ³• éœ€è¦ cls -\u0026gt; classmethod éƒ½ä¸éœ€è¦ -\u0026gt; staticmethod ","description":" ğŸš€ 1. classmethod æ˜¯ä»€ä¹ˆï¼Ÿ @classmethod ç”¨æ¥æŠŠç±»ä¸­çš„æ–¹æ³•æ ‡è®°ä¸º ç±»æ–¹æ³•ï¼š\nä¼šè‡ªåŠ¨æ¥æ”¶ clsï¼ˆç±»æœ¬èº«ï¼‰ï¼Œè€Œä¸æ˜¯å®ä¾‹ é€‚åˆå¤„ç†â€œå…¨å±€äºç±»â€çš„é€»è¾‘ å¸¸ç”¨äºå·¥å‚æ–¹æ³•ã€é…ç½®æ–¹æ³•ã€æ‰¹é‡åˆ›å»ºå¯¹è±¡ç­‰ ç¤ºä¾‹ï¼š\nclass Demo: @classmethod def show(cls): print(cls) è°ƒç”¨ï¼š\nDemo.show() # \u0026lt;class \u0026#39;__main__.Demo\u0026#39;\u0026gt; Demo().show() # \u0026lt;class \u0026#39;__main__.Demo\u0026#39;\u0026gt; ğŸ“Œ 2. ä¸ staticmethod å’Œæ™®é€šæ–¹æ³•å¯¹æ¯”ï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰ æ–¹æ³•ç±»å‹ è‡ªåŠ¨æ¥æ”¶å‚æ•° å…¸å‹ç”¨é€” æ™®é€šæ–¹æ³• (def method(self)) selfï¼ˆå®ä¾‹ï¼‰ æ“ä½œå®ä¾‹æ•°æ® ç±»æ–¹æ³• (@classmethod) clsï¼ˆç±»ï¼‰ å·¥å‚æ–¹æ³•ã€åˆ›å»ºå®ä¾‹ã€è®¿é—®ç±»å±æ€§ é™æ€æ–¹æ³• (@staticmethod) æ—  å·¥å…·å‡½æ•°ï¼Œä¸ç±»ç›¸å…³ä½†ä¸éœ€è¦è®¿é—®ç±»æˆ–å®ä¾‹ ğŸ“Œ 3. æœ€ç®€å•ç¤ºä¾‹ class User: count = 0 def __init__(self): User.count += 1 @classmethod def get_count(cls): return cls.count ä½¿ç”¨ï¼š\n"},{"id":173,"href":"/backend/python/official/decorator-dataclass/","title":"Decorator -- dataclass","parent":"Official","content":" ğŸš€ ä»€ä¹ˆæ˜¯ dataclassï¼Ÿ dataclass æ˜¯ Python 3.7 å¼•å…¥çš„è£…é¥°å™¨ï¼Œç”¨æ¥ å¿«é€Ÿå®šä¹‰æ•°æ®ç±»ï¼ˆdata modelï¼‰ã€‚\nå®ƒçš„ç›®çš„ï¼š\nè‡ªåŠ¨ç”Ÿæˆ __init__ã€__repr__ã€__eq__ è‡ªåŠ¨å¯æ¯”è¾ƒã€å¤åˆ¶ å¼ºç±»å‹æ”¯æŒæ›´å¥½ï¼ˆé…åˆ typingï¼‰ å¯è¯»ã€å¯ç»´æŠ¤ã€ä»£ç å‡å°‘ 50% ä»¥ä¸Š dataclass = ç®€æ´ç‰ˆçš„æ•°æ®æ¨¡å‹ï¼Œæ›¿ä»£å†—é•¿çš„ classã€‚\n1. åŸºæœ¬ç”¨æ³• from dataclasses import dataclass @dataclass class User: id: int name: str active: bool = True è‡ªåŠ¨ç”Ÿæˆï¼š\n__init__() __repr__() __eq__() ä½¿ç”¨ï¼š\nu = User(1, \u0026#34;Tom\u0026#34;) print(u) è¾“å‡ºï¼š\nUser(id=1, name=\u0026#39;Tom\u0026#39;, active=True) 2. é»˜è®¤å€¼ä¸ç±»å‹æ³¨è§£ï¼ˆå¿…éœ€ï¼‰ å­—æ®µå¿…é¡»å†™ç±»å‹ï¼š\n@dataclass class Point: x: float y: float = 0.0 3. field()ï¼šæ§åˆ¶å­—æ®µè¡Œä¸º from dataclasses import dataclass, field @dataclass class User: id: int tags: list = field(default_factory=list) â— ä¸ºä»€ä¹ˆä¸ç”¨ tags=[]ï¼Ÿ\nå› ä¸ºå¯å˜å¯¹è±¡ä¼šåœ¨æ‰€æœ‰å®ä¾‹é—´å…±äº«ã€‚\n4. è‡ªåŠ¨æ¯”è¾ƒ å¼€å¯ order=Trueï¼š\n@dataclass(order=True) class Score: value: int å¯ç›´æ¥æ¯”è¾ƒï¼š\nScore(5) \u0026lt; Score(10) 5. frozen: ä¸å¯ä¿®æ”¹å¯¹è±¡ï¼ˆç±»ä¼¼ tupleï¼‰ @dataclass(frozen=True) class Config: host: str port: int cfg.host = \u0026#34;127.0.0.1\u0026#34; # âŒ FrozenInstanceError 6. post_initï¼šè‡ªåŠ¨è¿è¡Œåˆå§‹åŒ–åé€»è¾‘ @dataclass class Product: name: str price: float def __post_init__(self): if self.price \u0026lt; 0: raise ValueError(\u0026#34;price cannot be negative\u0026#34;) 7. dataclass + type hintsï¼ˆæœ€ä¼˜é›…ï¼‰ @dataclass class User: id: int name: str email: str | None = None éå¸¸é€‚åˆ FastAPI / ORM / JSON æ•°æ®ç»“æ„ã€‚\n8. dataclass åµŒå¥— @dataclass class Address: city: str zip: str @dataclass class User: name: str address: Address ä½¿ç”¨ï¼š\nu = User(\u0026#34;Tom\u0026#34;, Address(\u0026#34;Beijing\u0026#34;, \u0026#34;10000\u0026#34;)) 9. å°† dataclass è½¬æˆ dict Python 3.10+\nfrom dataclasses import asdict asdict(u) è¾“å‡ºï¼š\n{ \u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;address\u0026#34;: { \u0026#34;city\u0026#34;: \u0026#34;Beijing\u0026#34;, \u0026#34;zip\u0026#34;: \u0026#34;10000\u0026#34; } } 10. dataclass è½¬ JSONï¼ˆå®é™…é¡¹ç›®éå¸¸å¸¸ç”¨ï¼‰ import json json.dumps(asdict(u), ensure_ascii=False) 11. dataclass çš„ç»§æ‰¿ @dataclass class A: x: int @dataclass class B(A): y: int 12. dataclass vs NamedTuple vs Pydantic åŠŸèƒ½ dataclass NamedTuple Pydantic å¯å˜æ€§ å¯å˜ ä¸å¯å˜ å¯æ§ æ€§èƒ½ å¾ˆå¿« æœ€å¿« ä¸­ç­‰ ç±»å‹æ£€æŸ¥ ä¾èµ– typing å¼º å¼ºå¹¶è‡ªåŠ¨æ ¡éªŒ JSON åŒ– æ‰‹åŠ¨ æ‰‹åŠ¨ å†…ç½® æœ€é€‚ç”¨äº ä¸šåŠ¡æ•°æ®ç»“æ„ ç®€å•ä¸å¯å˜æ•°æ® API/DB æ•°æ®æ¨¡å‹ 13. dataclass çš„å¸¸ç”¨å‚æ•°æ€»ç»“ @dataclass( init=True, # è‡ªåŠ¨ç”Ÿæˆ __init__ repr=True, # è‡ªåŠ¨ __repr__ eq=True, # è‡ªåŠ¨ __eq__ order=False, # æ˜¯å¦å¯æ¯”è¾ƒ unsafe_hash=False, frozen=False, # æ˜¯å¦ä¸å¯å˜ slots=False, # Python 3.10+: æ›´çœå†…å­˜ ) 14. æœ€æ¨èçš„ dataclass æ¨¡æ¿ï¼ˆä½ é¡¹ç›®å¯ç›´æ¥ç”¨ï¼‰ from dataclasses import dataclass, field from typing import List @dataclass(slots=True) # æ›´çœå†…å­˜ class NewsItem: title: str date: str tags: List[str] = field(default_factory=list) 15. dataclass + æšä¸¾ï¼ˆé«˜çº§æŠ€å·§ï¼‰ from enum import Enum from dataclasses import dataclass class Status(Enum): ACTIVE = \u0026#34;active\u0026#34; DISABLED = \u0026#34;disabled\u0026#34; @dataclass class User: id: int status: Status 16. dataclass + ORMï¼ˆä½ ç”¨ SQLAlchemy å¯ä»¥è¿™æ ·ç”¨ï¼‰ @dataclass class UserDTO: id: int name: str ç”¨äºï¼š\næ¥å£è¿”å› DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ æ•°æ®æ ¡éªŒ ä¸šåŠ¡é€»è¾‘å±‚å°è£… 17. dataclass çš„â€œè§£åŒ…â€ user = User(1, \u0026#34;tom@example.com\u0026#34;) uid, name = user.id, user.name # æ‰‹åŠ¨ # æˆ– print(*asdict(user).values()) æ€»ç»“ï¼šdataclass çš„æœ¬è´¨ä»·å€¼ æ¯”æ™®é€š class æ›´ç®€æ´ è‡ªåŠ¨ç”Ÿæˆå¤§é‡æ ·æ¿ä»£ç  å¯ç»´æŠ¤æ€§å¥½ æ”¯æŒç±»å‹æ£€æŸ¥ æ›´ Pythonic ä¸ç°ä»£æ¡†æ¶ï¼ˆFastAPIã€SQLAlchemyã€Pydanticï¼‰å…¼å®¹æå¥½ ","description":" ğŸš€ ä»€ä¹ˆæ˜¯ dataclassï¼Ÿ dataclass æ˜¯ Python 3.7 å¼•å…¥çš„è£…é¥°å™¨ï¼Œç”¨æ¥ å¿«é€Ÿå®šä¹‰æ•°æ®ç±»ï¼ˆdata modelï¼‰ã€‚\nå®ƒçš„ç›®çš„ï¼š\nè‡ªåŠ¨ç”Ÿæˆ __init__ã€__repr__ã€__eq__ è‡ªåŠ¨å¯æ¯”è¾ƒã€å¤åˆ¶ å¼ºç±»å‹æ”¯æŒæ›´å¥½ï¼ˆé…åˆ typingï¼‰ å¯è¯»ã€å¯ç»´æŠ¤ã€ä»£ç å‡å°‘ 50% ä»¥ä¸Š dataclass = ç®€æ´ç‰ˆçš„æ•°æ®æ¨¡å‹ï¼Œæ›¿ä»£å†—é•¿çš„ classã€‚\n1. åŸºæœ¬ç”¨æ³• from dataclasses import dataclass @dataclass class User: id: int name: str active: bool = True è‡ªåŠ¨ç”Ÿæˆï¼š\n__init__() __repr__() __eq__() ä½¿ç”¨ï¼š\n"},{"id":174,"href":"/backend/python/official/decorator-property/","title":"Decorator -- property","parent":"Official","content":" ğŸš€ 1. property æ˜¯ä»€ä¹ˆï¼Ÿ @property å¯ä»¥æŠŠä¸€ä¸ª æ–¹æ³• ä¼ªè£…æˆä¸€ä¸ª åªè¯»å±æ€§ï¼ˆåƒå­—æ®µä¸€æ ·è®¿é—®ï¼‰ã€‚\næ ¸å¿ƒåŠŸèƒ½ï¼š\nå±æ€§è®¿é—® -\u0026gt; è°ƒç”¨ getter æ–¹æ³• ä½¿ API æ›´ä¼˜é›… ç”¨äºâ€œè®¡ç®—å‹å­—æ®µâ€â€œåŒ…è£…çœŸå®å­—æ®µâ€â€œæä¾›å—æ§è®¿é—®â€ ğŸ“Œ 2. æœ€ç®€å•çš„ç¤ºä¾‹ class User: def __init__(self, name): self._name = name @property def name(self): return self._name ä½¿ç”¨ï¼š\nu = User(\u0026#34;Jack\u0026#34;) print(u.name) # åƒå±æ€§è®¿é—®ï¼Œä½†èƒŒåå®é™…æ˜¯è°ƒç”¨æ–¹æ³• ğŸ“Œ 3. æ·»åŠ  setterï¼ˆå¯å†™å±æ€§ï¼‰ class User: def __init__(self): self._age = 0 @property def age(self): return self._age @age.setter def age(self, value): if value \u0026lt; 0: raise ValueError(\u0026#34;å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°\u0026#34;) self._age = value ä½¿ç”¨ï¼š\nu = User() u.age = 18 # è‡ªåŠ¨è°ƒç”¨ setter print(u.age) ğŸ“Œ 4. æ·»åŠ  deleterï¼ˆå¯åˆ é™¤å±æ€§é€»è¾‘ï¼‰ class User: def __init__(self): self._token = \u0026#34;abc123\u0026#34; @property def token(self): return self._token @token.deleter def token(self): self._token = None ä½¿ç”¨ï¼š\nu = User() del u.token ğŸ“Œ 5. ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ propertyï¼Ÿ æƒ³è®©å±æ€§åªè¯» ä¾‹å¦‚è‚¡ç¥¨æ¶¨åœä»·æ˜¯æµ®åŠ¨è®¡ç®—å‡ºæ¥çš„ï¼Œä¸å…è®¸ç›´æ¥ä¿®æ”¹ã€‚\næƒ³ä¿æŠ¤çœŸå®å­—æ®µï¼ˆç§æœ‰å˜é‡ï¼‰ ä¾‹å¦‚å¯†ç  hashã€‚\næƒ³å°è£…è®¡ç®—å­—æ®µ ä½ é¡¹ç›®é‡Œå°±å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š\ndatetime å­—ç¬¦ä¸²è½¬æ¢æˆ date è‚¡ç¥¨ä»£ç æ ¼å¼è½¬æ¢ è‡ªåŠ¨ç”Ÿæˆå…¨å full_name è‡ªåŠ¨æ ¼å¼åŒ–è‚¡ç¥¨æ¶¨è·Œå¹…ç™¾åˆ†æ¯” æƒ³ä¼˜é›…è®¿é—®å¤æ‚é€»è¾‘ æ›´å¥½çš„ API è®¾è®¡ã€‚\nğŸ“Œ 6. ä½ é¡¹ç›®ä¸­ property çš„çœŸå®å®æˆ˜ç¤ºä¾‹ 6.1 è‚¡ç¥¨ä»£ç è½¬æ¢ï¼ˆå¼ºçƒˆæ¨èï¼ï¼‰ ä½ ç»å¸¸ä½¿ç”¨ stock.coderename(code)\nå¯ä»¥æ”¹æˆ è®¡ç®—å‹å±æ€§ï¼š\nclass Stock: def __init__(self, code): self.raw_code = code @property def formatted(self): \u0026#34;\u0026#34;\u0026#34;è¿”å› sz000001 / sh600000 æ ¼å¼\u0026#34;\u0026#34;\u0026#34; if self.raw_code.startswith(\u0026#34;00\u0026#34;): return \u0026#34;sz\u0026#34; + self.raw_code if self.raw_code.startswith(\u0026#34;60\u0026#34;): return \u0026#34;sh\u0026#34; + self.raw_code return self.raw_code ä½¿ç”¨ï¼š\ns = Stock(\u0026#34;600001\u0026#34;) print(s.formatted) 6.2 è‡ªåŠ¨æ ¼å¼åŒ–æ—¥æœŸï¼ˆæ•°æ®å…¥åº“å¾ˆå¸¸ç”¨ï¼‰ class News: def __init__(self, time_str): self._time_str = time_str @property def date(self): return datetime.strptime(self._time_str, \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;).date() ä½ ç°åœ¨å¾ˆå¤šåœ°æ–¹ç”¨ utils.datetime_string_to_datetimeï¼Œå®Œå…¨å¯ä»¥ property åŒ–ã€‚\n6.3 ä¿æŠ¤æ•æ„Ÿå­—æ®µï¼ˆå¦‚å¯†ç ï¼‰ class User: def __init__(self, password): self._password = bcrypt.hashpw(password.encode(), bcrypt.gensalt()) @property def password(self): raise AttributeError(\u0026#34;ä¸å…è®¸ç›´æ¥è¯»å–å¯†ç \u0026#34;) @password.setter def password(self, raw_pwd: str): self._password = bcrypt.hashpw(raw_pwd.encode(), bcrypt.gensalt()) ğŸ“Œ 7. property çš„å†…éƒ¨æœºåˆ¶ï¼ˆä½ ä¸€å®šè¦çŸ¥é“ï¼‰ ç­‰ä»·äºï¼š\nname = property(fget, fset, fdel) ä¹Ÿå°±æ˜¯è¯´ï¼š\nä¸åŠ  setter -\u0026gt; ä¸å¯å†™ï¼ˆåªè¯»ï¼‰ ä¸åŠ  deleter -\u0026gt; ä¸å¯åˆ é™¤ ğŸ“Œ 8. é¿å…æ»¥ç”¨ propertyï¼ˆç»éªŒæ€»ç»“ï¼‰ âŒ property ä¸åº”è¯¥åšå¤æ‚é€»è¾‘ï¼ˆä¼šå¯¼è‡´æ„å¤–æ€§èƒ½é—®é¢˜ï¼‰ âŒ property ä¸åº”è¯¥æœ‰æ˜æ˜¾å‰¯ä½œç”¨ï¼ˆä¸ç„¶è®¿é—®å±æ€§å°±æ”¹å˜å¯¹è±¡ï¼Œå¾ˆè¯¡å¼‚ï¼‰ âŒ property ä¸é€‚åˆåšè€—æ—¶æ“ä½œï¼ˆæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢ï¼‰ âœ… æ¨èç”¨äº â€œè½»é‡è®¡ç®—å­—æ®µâ€\nğŸ“Œ 9. property + dataclass çš„æœ€ä½³ç»„åˆ from dataclasses import dataclass @dataclass class Stock: code: str name: str @property def market(self): if self.code.startswith(\u0026#34;00\u0026#34;): return \u0026#34;SZ\u0026#34; if self.code.startswith(\u0026#34;60\u0026#34;): return \u0026#34;SH\u0026#34; return \u0026#34;OTHER\u0026#34; ğŸ“Œ 10. æ€»ç»“ï¼ˆä½ å¯ä»¥æ”¶è—çš„æœ€ç»ˆè¡¨ï¼‰ | ç”¨é€” | æ˜¯å¦é€‚åˆ property | | åªè¯»å±æ€§ | âœ… | | ç®€å•è®¡ç®—å­—æ®µ | âœ… | | ç§æœ‰å­—æ®µåŒ…è£… | âœ… | | æ•°æ®éªŒè¯ | âœ…ï¼ˆåœ¨ setter ä¸­ï¼‰ | | å¤æ‚é€»è¾‘ | âŒ | | è€—æ—¶æ“ä½œï¼ˆç½‘ç»œ / DBï¼‰ | âŒ | | ä¼šå¼•èµ·å‰¯ä½œç”¨ | âŒ |\n","description":" ğŸš€ 1. property æ˜¯ä»€ä¹ˆï¼Ÿ @property å¯ä»¥æŠŠä¸€ä¸ª æ–¹æ³• ä¼ªè£…æˆä¸€ä¸ª åªè¯»å±æ€§ï¼ˆåƒå­—æ®µä¸€æ ·è®¿é—®ï¼‰ã€‚\næ ¸å¿ƒåŠŸèƒ½ï¼š\nå±æ€§è®¿é—® -\u0026gt; è°ƒç”¨ getter æ–¹æ³• ä½¿ API æ›´ä¼˜é›… ç”¨äºâ€œè®¡ç®—å‹å­—æ®µâ€â€œåŒ…è£…çœŸå®å­—æ®µâ€â€œæä¾›å—æ§è®¿é—®â€ ğŸ“Œ 2. æœ€ç®€å•çš„ç¤ºä¾‹ class User: def __init__(self, name): self._name = name @property def name(self): return self._name ä½¿ç”¨ï¼š\n"},{"id":175,"href":"/backend/python/official/decorator-staticmethod/","title":"Decorator -- staticmethod","parent":"Official","content":" ğŸš€ 1. staticmethod æ˜¯ä»€ä¹ˆï¼Ÿ @staticmethod ç”¨æ¥æŠŠç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•æ ‡è®°ä¸º é™æ€æ–¹æ³•ï¼š\nä¸ä¼šæ¥æ”¶ self ä¸ä¼šæ¥æ”¶ cls å’Œç±»å®ä¾‹ / ç±»æœ¬èº«æ²¡æœ‰å…³è” æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª æ”¾åœ¨ç±»é‡Œé¢çš„æ™®é€šå‡½æ•° å®ƒåªå› ä¸ºé€»è¾‘ç›¸å…³ï¼Œè€Œè¢«ç»„ç»‡åœ¨ç±»é‡Œã€‚\nğŸ“Œ 2. æœ€ç®€å•ç¤ºä¾‹ class MathUtils: @staticmethod def add(a, b): return a + b print(MathUtils.add(1, 2)) # 3 print(MathUtils().add(1, 2)) # 3ï¼Œå®ä¾‹ä¹Ÿèƒ½è°ƒç”¨ ç‰¹ç‚¹ï¼š\nç±»å¯ä»¥è°ƒç”¨ å®ä¾‹ä¹Ÿå¯ä»¥è°ƒç”¨ æ°¸è¿œä¸ä¼šè‡ªåŠ¨ä¼ å…¥ self / cls ğŸ“Œ 3. staticmethod vs classmethod vs æ™®é€šæ–¹æ³• ç±»å‹ æ˜¯å¦æœ‰ selfï¼Ÿ æ˜¯å¦æœ‰ clsï¼Ÿ ç”¨é€” æ™®é€šæ–¹æ³• âœ… æœ‰è‡ªå¸¦ self âŒ æ“ä½œå®ä¾‹æ•°æ® ç±»æ–¹æ³• âŒ âœ… è‡ªå¸¦ cls æ“ä½œç±»çš„æ•°æ®ã€å·¥å‚å‡½æ•° é™æ€æ–¹æ³• âŒ âŒ å·¥å…·å‡½æ•°ï¼Œä¸ç±»åªåœ¨é€»è¾‘ä¸Šç›¸å…³ ğŸ“Œ 4. ä¸ºä»€ä¹ˆè¦ç”¨ @staticmethodï¼Ÿ âœ… æŠŠé€»è¾‘ç›¸å…³çš„å·¥å…·å‡½æ•°æ”¾åœ¨ç±»ä¸­ï¼Œè€Œä¸æ˜¯æ”¾åœ¨å…¨å±€ âœ… ä¿æŒå‘½åç©ºé—´å¹²å‡€ âœ… é¿å…è¯¯ä¼  self æˆ– cls ğŸ“Œ 5. å¸¸è§åœºæ™¯ï¼ˆæœ€é‡è¦ï¼‰ 5.1 å·¥å…·å‡½æ•°å°è£…ï¼ˆæœ€å¸¸è§ï¼‰ å¾ˆå¤šå‡½æ•°å°±é€‚åˆæ”¾åœ¨ class é‡Œåšé™æ€æ–¹æ³•ã€‚\nclass StringUtils: @staticmethod def is_empty(s: str): return not s or s.strip() == \u0026#34;\u0026#34; 5.2 æ•°æ®è½¬æ¢å‡½æ•° stock code è½¬æ¢ã€æ—¥æœŸè½¬æ¢ éƒ½å¾ˆé€‚åˆ staticmethodï¼š\nclass StockHelper: @staticmethod def coderename(code: str, restore=False): if restore: return code.replace(\u0026#34;sz\u0026#34;, \u0026#34;00\u0026#34;).replace(\u0026#34;sh\u0026#34;, \u0026#34;60\u0026#34;) return code 5.3 å·¥å‚æ–¹æ³•çš„ä¸€éƒ¨åˆ†é€»è¾‘ï¼ˆä¸ä¾èµ– clsï¼‰ class User: def __init__(self, name, age): self.name = name self.age = age @staticmethod def validate_age(age): return 0 \u0026lt;= age \u0026lt;= 120 @classmethod def create(cls, name, age): if not cls.validate_age(age): raise ValueError(\u0026#34;invalid age\u0026#34;) return cls(name, age) 5.4 ä¸ç±»é€»è¾‘æœ‰å…³ï¼Œä½†ä¸åº”è¯¥è®¿é—®ç±»/å®ä¾‹ å¸¸è§äºï¼š\næ•°å­¦è¿ç®—å·¥å…· å­—ç¬¦ä¸²å·¥å…· æ—¥æœŸè½¬æ¢ ç¼–ç /è§£ç å·¥å…· å‚æ•°æ£€æŸ¥é€»è¾‘ ä½ çš„é¡¹ç›®ä¸­ utils.isTrue éå¸¸é€‚åˆä½œä¸ºé™æ€æ–¹æ³•ï¼\nğŸ“Œ 6. staticmethod å®é™…ä¸Šåšäº†ä»€ä¹ˆï¼Ÿ @staticmethod def func(...): ... ç­‰ä»·äºï¼š\nfunc = staticmethod(func) å®ƒæŠŠå‡½æ•°åŒ…è£…æˆä¸€ä¸ªæè¿°ç¬¦å¯¹è±¡ï¼Œä½¿å®ƒä¸ä¼šå˜æˆç»‘å®šæ–¹æ³•ã€‚\nğŸ“Œ 7. staticmethod çš„é”™è¯¯ä½¿ç”¨ï¼ˆè¦é¿å…ï¼‰ âŒ ä¸è¦åœ¨éœ€è¦ self çš„æ–¹æ³•ä¸Šç”¨ staticmethod âŒ ä¸è¦æŠŠæœ¬æ¥åº”è¯¥æ”¾åœ¨ utils çš„å‡½æ•°ç¡¬å¡è¿›ç±»é‡Œ âŒ ä¸è¦æŠŠéœ€è¦è®¿é—®ç±»å±æ€§çš„æ–¹æ³•å†™æˆ staticmethodï¼ˆåº”è¯¥æ˜¯ classmethodï¼‰ ğŸ“Œ 8. ä»€ä¹ˆæ—¶å€™ç”¨ classmethodï¼Œè€Œä¸æ˜¯ staticmethodï¼Ÿ éœ€è¦è®¿é—®ç±»æ•°æ®æ—¶ï¼š\nclass Config: version = \u0026#34;1.0\u0026#34; @classmethod def get_version(cls): return cls.version ğŸ“Œ 9. åœ¨ FastAPI é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µ å¼ºçƒˆæ¨èå¦‚ä¸‹ç»„ç»‡ç»“æ„ï¼š\nutils/ â”œâ”€â”€ string.py -\u0026gt; StringUtils â”œâ”€â”€ date.py -\u0026gt; DateUtils â”œâ”€â”€ stock.py -\u0026gt; StockUtils æ¯ä¸ª utils ç±»é‡Œå°è£…é™æ€æ–¹æ³•ï¼š\nclass DateUtils: @staticmethod def string_to_date(s: str): return datetime.strptime(s, \u0026#34;%Y-%m-%d\u0026#34;) è°ƒç”¨æ—¶ï¼š\nfrom utils.date import DateUtils DateUtils.string_to_date(\u0026#34;2025-01-01\u0026#34;) éå¸¸æ¸…æ™°ã€‚\nğŸ“Œ 10. é‡æ„ä½ é¡¹ç›®ä¸­çš„ä¸€æ®µä»£ç ç¤ºä¾‹ï¼ˆçœŸå®å‚è€ƒï¼‰ ä½ ä¹‹å‰å†™çš„ï¼š\nif utils.isTrue(df, bool): æ¨èé‡æ„ä¸ºï¼š\nclass TypeUtils: @staticmethod def is_true(value, t): return isinstance(value, t) è°ƒç”¨ï¼š\nif TypeUtils.is_true(df, bool): å‘½åæ›´è§„èŒƒã€‚\næ€»ç»“ âœ… staticmethodï¼šé€»è¾‘ç›¸å…³ä½†ä¸ä¾èµ–ç±»/å®ä¾‹\nâœ… classmethodï¼šéœ€è¦ cls\nâœ… æ™®é€šæ–¹æ³•ï¼šéœ€è¦ self\nä½ é€‰æ‹© @staticmethod çš„æœ€ä½³åœºæ™¯ï¼š\nå·¥å…·å‡½æ•° è½¬æ¢å‡½æ•° çº¯é€»è¾‘å‡½æ•° å‚æ•°æ£€æŸ¥å‡½æ•° ä¸å¸Œæœ›æ¥æ”¶ self çš„æ–¹æ³• ","description":" ğŸš€ 1. staticmethod æ˜¯ä»€ä¹ˆï¼Ÿ @staticmethod ç”¨æ¥æŠŠç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•æ ‡è®°ä¸º é™æ€æ–¹æ³•ï¼š\nä¸ä¼šæ¥æ”¶ self ä¸ä¼šæ¥æ”¶ cls å’Œç±»å®ä¾‹ / ç±»æœ¬èº«æ²¡æœ‰å…³è” æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª æ”¾åœ¨ç±»é‡Œé¢çš„æ™®é€šå‡½æ•° å®ƒåªå› ä¸ºé€»è¾‘ç›¸å…³ï¼Œè€Œè¢«ç»„ç»‡åœ¨ç±»é‡Œã€‚\nğŸ“Œ 2. æœ€ç®€å•ç¤ºä¾‹ class MathUtils: @staticmethod def add(a, b): return a + b print(MathUtils.add(1, 2)) # 3 print(MathUtils().add(1, 2)) # 3ï¼Œå®ä¾‹ä¹Ÿèƒ½è°ƒç”¨ ç‰¹ç‚¹ï¼š\n"},{"id":176,"href":"/backend/python/official/decorator-comparison/","title":"Decorator -- staticmethod / classmethod / property çš„è¶…å¼ºå¯¹æ¯”è¡¨","parent":"Official","content":" ğŸš€ Python ä¸‰å¤§æ–¹æ³•ç±»å‹ï¼šç»ˆæå¯¹æ¯”è¡¨ ç‰¹æ€§ æ™®é€šæ–¹æ³• @staticmethod @classmethod @property è‡ªåŠ¨æ³¨å…¥å‚æ•° selfï¼ˆå®ä¾‹ï¼‰ æ— è‡ªåŠ¨å‚æ•° clsï¼ˆç±»ï¼‰ selfï¼ˆå®ä¾‹ï¼‰ èƒ½å¦è®¿é—®å®ä¾‹å±æ€§ âœ… âŒ âŒ âœ… èƒ½å¦è®¿é—®ç±»å±æ€§ âœ… âŒ âœ… âœ… æ˜¯å¦ä¾èµ–å®ä¾‹ âœ… å¼ºä¾èµ– âŒ å®Œå…¨ä¸ä¾èµ– âŒ ä¸ä¾èµ–å®ä¾‹ âœ… è·å–å®ä¾‹çŠ¶æ€ è°ƒç”¨æ–¹å¼ å®ä¾‹è°ƒç”¨ ç±» / å®ä¾‹å‡å¯ ç±» / å®ä¾‹å‡å¯ å®ä¾‹å±æ€§è®¿é—®æ–¹å¼ å…¸å‹ç”¨é€” æ“ä½œå®ä¾‹æ•°æ® å·¥å…·å‡½æ•°ã€è½¬æ¢å‡½æ•° å·¥å‚æ–¹æ³•ã€é…ç½®ã€ç±»çº§åˆ«æ“ä½œ å°†æ–¹æ³•ä¼ªè£…æˆâ€œå±æ€§â€ æ˜¯å¦æ”¯æŒ setter âŒ âŒ âŒ âœ… å¯åšå±æ€§å¯å†™åŒ– æ˜¯å¦æ”¯æŒç»§æ‰¿å¤šæ€ âœ… âœ…ï¼ˆä½†å°‘ç”¨ï¼‰ âœ…ï¼ˆå¸¸è§ï¼Œç”¨äºå­ç±»æ„é€ ï¼‰ âœ… è®¾è®¡æ„å›¾ è¡Œä¸ºä¾èµ–å¯¹è±¡çŠ¶æ€ ä¸ç±»é€»è¾‘ç›¸å…³ä½†ä¸ä¾èµ–ç±»/å®ä¾‹ ä»¥â€œç±»â€ä¸ºæ ¸å¿ƒé€»è¾‘ å°† getter æ–¹æ³•åŒ…è£…æˆå­—æ®µ ç»ˆæè®°å¿†å£è¯€\nself -\u0026gt; æ™®é€šæ–¹æ³• cls -\u0026gt; classmethod nothing -\u0026gt; staticmethod å±æ€§æ¥å£ -\u0026gt; property ğŸ“Œ ä¸‰è€…æ ¸å¿ƒå·®å¼‚æ¦‚æ‹¬ @staticmethod å®Œå…¨ä¸å®ä¾‹æ— å…³ï¼Œåªæ˜¯è¢«â€œæ”¾åœ¨ç±»é‡Œé¢çš„å·¥å…·å‡½æ•°â€ã€‚\n@classmethod æ–¹æ³•å›´ç»•â€œç±»â€æœ¬èº«å±•å¼€ï¼Œé€šå¸¸ç”¨äºåˆ›å»ºå¯¹è±¡ã€åŠ è½½é…ç½®ã€é€‚é…å­ç±»ã€‚\n@property æŠŠæ–¹æ³•å˜æˆå­—æ®µä¸€æ ·è®¿é—®ï¼Œå®ç°å¹²å‡€ä¼˜é›…çš„ APIã€‚\nğŸ“˜ å®ç”¨ç¤ºä¾‹å¯¹æ¯”ï¼ˆé¡¹ç›®çº§ç¤ºä¾‹ï¼‰ 1. staticmethod â€” é€»è¾‘å‡½æ•° / å·¥å…·å‡½æ•° ç”¨äºè½¬æ¢ã€æ ¡éªŒã€æ ¼å¼åŒ–ç­‰é€»è¾‘ã€‚\nclass Math: @staticmethod def add(a, b): return a + b ä½¿ç”¨ï¼š\nMath.add(1, 2) ä¸éœ€è¦ç±»ï¼Œä¹Ÿä¸éœ€è¦å®ä¾‹ã€‚\n2. classmethod â€” å·¥å‚æ–¹æ³• / é€‚é…å­ç±» ä¾‹å¦‚ä» JSON åˆ›å»ºå¯¹è±¡ï¼š\nclass User: def __init__(self, name): self.name = name @classmethod def from_dict(cls, data): return cls(data[\u0026#34;name\u0026#34;]) æ”¯æŒå­ç±»ï¼š\nclass Admin(User): pass a = Admin.from_dict({\u0026#34;name\u0026#34;: \u0026#34;root\u0026#34;}) print(type(a)) # \u0026lt;class \u0026#39;__main__.Admin\u0026#39;\u0026gt; 3. property â€” ä¼˜é›…è®¿é—®å¯¹è±¡å±æ€§ class User: def __init__(self, firstname, lastname): self.firstname = firstname self.lastname = lastname @property def fullname(self): return f\u0026#34;{self.firstname} {self.lastname}\u0026#34; åƒå­—æ®µä¸€æ ·è®¿é—®ï¼š\nprint(user.fullname) è€Œä¸æ˜¯ï¼š\nprint(user.fullname()) ğŸ“¦ æ›´é«˜çº§ç¤ºä¾‹ï¼šç»Ÿä¸€å¯¹æ¯”ï¼ˆä¸€ä¸ªç±»é‡Œå±•ç¤ºå…¨éƒ¨ï¼‰ class Demo: class_level_value = 100 def __init__(self, x): self.x = x def normal(self): return self.x * 2 @staticmethod def util(a, b): return a + b @classmethod def make(cls, y): return cls(y) @property def doubled(self): return self.x * 2 è°ƒç”¨ï¼š\nd = Demo(10) d.normal() # 20 Demo.util(1, 2) # 3 Demo.make(99) # åˆ›å»º Demo æˆ–å…¶å­ç±»å¯¹è±¡ d.doubled # 20ï¼ˆæ³¨æ„ï¼šæ²¡æœ‰æ‹¬å·ï¼‰ ğŸ† ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸€ä¸ªï¼Ÿï¼ˆè¶…æ˜ç¡®åœºæ™¯æŒ‡å¯¼ï¼‰ | åœºæ™¯ | ç”¨ä»€ä¹ˆ | åŸå›  | | æ–¹æ³•é€»è¾‘ä¸å®ä¾‹æœ‰å…³ | æ™®é€šæ–¹æ³• | éœ€è¦ self | | å·¥å…·å‡½æ•°ã€æ•°æ®è½¬æ¢ã€æ ¼å¼åŒ– | staticmethod | ç‹¬ç«‹é€»è¾‘ã€æ”¾ç±»é‡Œæ›´ç»„ç»‡åŒ– | | åŸºäºç±»åˆ›å»ºå¯¹è±¡ï¼ˆå·¥å‚ï¼‰ | classmethod | è¿”å› clsï¼Œå¯å…¼å®¹å­ç±» | | åŠ è½½é…ç½®/åˆå§‹åŒ–ç¯å¢ƒ | classmethod | é€»è¾‘å±äºç±»æœ¬èº« | | å°† getter â€œä¼ªè£…æˆå±æ€§â€ | property | è®© API æ›´ä¼˜é›… | | éœ€è¦å¯å†™å±æ€§ | @property + @setter | æ§åˆ¶å†™å…¥é€»è¾‘ | | å®Œå…¨æ— å…³ç±»ã€åº”è¯¥æ”¾ utils | é¡¶çº§å‡½æ•°æˆ– staticmethod | é¿å…æ±¡æŸ“ç±»èŒè´£ |\nğŸ æœ€åé™„èµ ï¼šä½ çš„é¡¹ç›®æœ€ä½³ç»“æ„å»ºè®® ä½  FastAPI + PostgreSQL é¡¹ç›®å»ºè®®è¿™æ ·ï¼š\nutils/ â”œâ”€â”€ string.py â”œâ”€â”€ validate.py â”œâ”€â”€ date.py â”œâ”€â”€ stock.py â”œâ”€â”€ crypto.py ç±»é‡Œé¢ä½¿ç”¨ç»„åˆï¼š\né€»è¾‘ç‹¬ç«‹ -\u0026gt; @staticmethod å¯èƒ½æ”¯æŒå­ç±»æ‰©å±• -\u0026gt; @classmethod æ•°æ®å¯¹è±¡è®¡ç®—å±æ€§ -\u0026gt; @property è¿™æ ·ä½ çš„ utils æ¨¡å—ä¼šéå¸¸æ¸…æ™°ã€‚\n","description":" ğŸš€ Python ä¸‰å¤§æ–¹æ³•ç±»å‹ï¼šç»ˆæå¯¹æ¯”è¡¨ ç‰¹æ€§ æ™®é€šæ–¹æ³• @staticmethod @classmethod @property è‡ªåŠ¨æ³¨å…¥å‚æ•° selfï¼ˆå®ä¾‹ï¼‰ æ— è‡ªåŠ¨å‚æ•° clsï¼ˆç±»ï¼‰ selfï¼ˆå®ä¾‹ï¼‰ èƒ½å¦è®¿é—®å®ä¾‹å±æ€§ âœ… âŒ âŒ âœ… èƒ½å¦è®¿é—®ç±»å±æ€§ âœ… âŒ âœ… âœ… æ˜¯å¦ä¾èµ–å®ä¾‹ âœ… å¼ºä¾èµ– âŒ å®Œå…¨ä¸ä¾èµ– âŒ ä¸ä¾èµ–å®ä¾‹ âœ… è·å–å®ä¾‹çŠ¶æ€ è°ƒç”¨æ–¹å¼ å®ä¾‹è°ƒç”¨ ç±» / å®ä¾‹å‡å¯ ç±» / å®ä¾‹å‡å¯ å®ä¾‹å±æ€§è®¿é—®æ–¹å¼ å…¸å‹ç”¨é€” æ“ä½œå®ä¾‹æ•°æ® å·¥å…·å‡½æ•°ã€è½¬æ¢å‡½æ•° å·¥å‚æ–¹æ³•ã€é…ç½®ã€ç±»çº§åˆ«æ“ä½œ å°†æ–¹æ³•ä¼ªè£…æˆâ€œå±æ€§â€ æ˜¯å¦æ”¯æŒ setter âŒ âŒ âŒ âœ… å¯åšå±æ€§å¯å†™åŒ– æ˜¯å¦æ”¯æŒç»§æ‰¿å¤šæ€ âœ… âœ…ï¼ˆä½†å°‘ç”¨ï¼‰ âœ…ï¼ˆå¸¸è§ï¼Œç”¨äºå­ç±»æ„é€ ï¼‰ âœ… è®¾è®¡æ„å›¾ è¡Œä¸ºä¾èµ–å¯¹è±¡çŠ¶æ€ ä¸ç±»é€»è¾‘ç›¸å…³ä½†ä¸ä¾èµ–ç±»/å®ä¾‹ ä»¥â€œç±»â€ä¸ºæ ¸å¿ƒé€»è¾‘ å°† getter æ–¹æ³•åŒ…è£…æˆå­—æ®µ ç»ˆæè®°å¿†å£è¯€\n"},{"id":177,"href":"/backend/python/official/decorator/","title":"Decorator (è£…é¥°å™¨)","parent":"Official","content":" âœ… ä¸€ã€ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼ˆDecoratorï¼‰ æ¦‚æ‹¬ï¼šè£…é¥°å™¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥ç»™å¦å¤–ä¸€ä¸ªå‡½æ•°å¢å¼ºåŠŸèƒ½ï¼Œä½†ä¸ä¿®æ”¹åŸä»£ç ã€‚\nä½ å†™ä¸€ä¸ªå‡½æ•° f()ï¼Œè£…é¥°å™¨ @decorator å¯ä»¥åœ¨å®ƒå‰åæ‰§è¡Œä»£ç ï¼Œä¾‹å¦‚å¢åŠ æ—¥å¿—ã€æƒé™æ£€æŸ¥ã€è®¡æ—¶åŠŸèƒ½ç­‰ã€‚\nâœ… äºŒã€æœ€ç®€å•çš„è£…é¥°å™¨ç¤ºä¾‹ def my_decorator(func): def wrapper(): print(\u0026#34;æ‰§è¡Œå‰\u0026#34;) func() print(\u0026#34;æ‰§è¡Œå\u0026#34;) return wrapper @my_decorator def say_hello(): print(\u0026#34;Hello\u0026#34;) say_hello() è¾“å‡ºï¼š\næ‰§è¡Œå‰ Hello æ‰§è¡Œå è§£é‡Šï¼š\n@my_decorator ç­‰ä»·äº say_hello = my_decorator(say_hello) wrapper() æ›¿ä»£äº†åŸå‡½æ•°ï¼Œä½†å†…éƒ¨ä»è°ƒç”¨åŸå‡½æ•°ï¼Œæ‰€ä»¥åŠŸèƒ½è¢«â€œåŒ…è£…â€äº†ã€‚ âœ… ä¸‰ã€è£…é¥°å™¨é€šç”¨æ¨¡æ¿ï¼ˆæœ€å¸¸ç”¨ï¼‰ é€‚ç”¨äºå¤§å¤šæ•°çœŸå®åœºæ™¯ã€‚\nfrom functools import wraps def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): print(\u0026#34;before:\u0026#34;, fn.__name__) result = fn(*args, **kwargs) print(\u0026#34;after:\u0026#34;, fn.__name__) return result return wrapper è®°ä½ï¼šwrapper å¿…é¡»æ¥æ”¶ *args, **kwargs\nè¿™ä¸ªç‰ˆæœ¬èƒ½è£…é¥°ä»»æ„å‡½æ•°ã€‚\n@wraps(fn) ä½œç”¨æ˜¯ä¿ç•™åŸå‡½æ•°ä¿¡æ¯ï¼Œå¦åˆ™ fn.__name__ ä¼šå˜æˆ \u0026ldquo;wrapper\u0026rdquo;ã€‚\nâœ… å››ã€å¸¸è§è£…é¥°å™¨åº”ç”¨åœºæ™¯ 1ï¼‰æ‰“å°æ—¥å¿— def log(fn): @wraps(fn) def wrapper(*args, **kwargs): print(f\u0026#34;[LOG] è°ƒç”¨å‡½æ•° {fn.__name__}\u0026#34;) return fn(*args, **kwargs) return wrapper 2ï¼‰ç»Ÿè®¡å‡½æ•°è€—æ—¶ import time def timer(fn): @wraps(fn) def wrapper(*args, **kwargs): start = time.time() result = fn(*args, **kwargs) print(\u0026#34;è€—æ—¶:\u0026#34;, time.time() - start) return result return wrapper 3ï¼‰æ£€æŸ¥æƒé™ï¼ˆWeb åç«¯å¸¸ç”¨ï¼‰ def require_admin(fn): @wraps(fn) def wrapper(*args, **kwargs): if not kwargs.get(\u0026#34;is_admin\u0026#34;): raise PermissionError(\u0026#34;æ— æƒé™\u0026#34;) return fn(*args, **kwargs) return wrapper 4ï¼‰ç¼“å­˜ç»“æœï¼ˆå¸¸ç”¨äºè®¡ç®—å‹å‡½æ•°ï¼‰ def cache(fn): memo = {} @wraps(fn) def wrapper(n): if n not in memo: memo[n] = fn(n) return memo[n] return wrapper âœ… äº”ã€è£…é¥°å™¨å¸¦å‚æ•°ï¼ˆâ˜…â˜…â˜…é‡ç‚¹ï¼‰ æƒ³è¦å†™æˆ @decorator(arg) çš„å½¢å¼ï¼Ÿ\néœ€è¦ â€œä¸‰å±‚å‡½æ•°â€ï¼š\ndef repeat(times): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): for _ in range(times): fn(*args, **kwargs) return wrapper return decorator ä½¿ç”¨ï¼š\n@repeat(3) def hi(): print(\u0026#34;hi\u0026#34;) âœ… å…­ã€ç±»è£…é¥°å™¨ï¼ˆäº†è§£ï¼‰ è£…é¥°å™¨ä¸æ­¢å¯ä»¥æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ç±»ã€‚\nclass Decorator: def __init__(self, fn): self.fn = fn def __call__(self, *args, **kwargs): print(\u0026#34;before\u0026#34;) return self.fn(*args, **kwargs) @Decorator def hello(): print(\u0026#34;hello\u0026#34;) âœ… ä¸ƒã€è£…é¥°å™¨å åŠ ï¼ˆå¤šä¸ªè£…é¥°å™¨ï¼‰ @decorator_a @decorator_b def f(): pass ç­‰ä»·äº\nf = decorator_a(decorator_b(f)) ä¸‹æ–¹è£…é¥°å™¨å…ˆæ‰§è¡Œã€‚\nğŸ å…«ã€æœ€å°è®°å¿†ç‰ˆæœ¬ï¼ˆè¶…çŸ­æ€»ç»“ï¼‰ è£…é¥°å™¨ = åœ¨ä¸æ”¹åŸå‡½æ•°çš„å‰æä¸‹ï¼Œé¢å¤–æ·»åŠ åŠŸèƒ½ æ ¸å¿ƒå…¬å¼ï¼šfn = decorator(fn) å¿…å¤‡è¯­æ³•ï¼šwrapper(*args, **kwargs) æœ€å¥½åŠ ï¼šfrom functools import wraps å¸¦å‚æ•° = ä¸‰å±‚å‡½æ•° å¤šä¸ªè£…é¥°å™¨ = ä»ä¸‹å¾€ä¸Šå¥— æœ€å¸¸è§çš„ 20 ä¸ªè£…é¥°å™¨å®æˆ˜ç¤ºä¾‹ ä»¥ä¸‹æ˜¯ æœ€å¸¸è§ã€æœ€å®ç”¨ã€èƒ½ç›´æ¥å¤åˆ¶ä½¿ç”¨çš„ 20 ä¸ª Python è£…é¥°å™¨å®æˆ˜ç¤ºä¾‹ã€‚\næ‰€æœ‰ç¤ºä¾‹éƒ½ç»è¿‡ç²¾ç®€ï¼Œå¯ç›´æ¥ç”¨åœ¨çœŸå®é¡¹ç›®ä¸­ï¼ˆåŒ…æ‹¬ä½ å¸¸ç”¨çš„ FastAPI é¡¹ç›®ï¼‰ã€‚\n1ï¼‰æ—¥å¿—æ‰“å°è£…é¥°å™¨ï¼ˆæœ€å¸¸ç”¨ï¼‰ from functools import wraps def log(fn): @wraps(fn) def wrapper(*args, **kwargs): print(f\u0026#34;[LOG] è°ƒç”¨ {fn.__name__}\u0026#34;) return fn(*args, **kwargs) return wrapper 2ï¼‰å‡½æ•°æ‰§è¡Œè®¡æ—¶ import time from functools import wraps def timer(fn): @wraps(fn) def wrapper(*args, **kwargs): start = time.time() result = fn(*args, **kwargs) print(f\u0026#34;è€—æ—¶ {time.time() - start:.4f}s\u0026#34;) return result return wrapper 3ï¼‰å¼‚å¸¸æ•è·å¹¶æ‰“å° from functools import wraps def catch_error(fn): @wraps(fn) def wrapper(*args, **kwargs): try: return fn(*args, **kwargs) except Exception as e: print(f\u0026#34;[ERROR] {fn.__name__}: {e}\u0026#34;) return None return wrapper 4ï¼‰å‚æ•°ç±»å‹æ£€æŸ¥ï¼ˆç®€å•ç‰ˆï¼‰ def type_check(*types): def decorator(fn): @wraps(fn) def wrapper(*args): for a, t in zip(args, types): assert isinstance(a, t), f\u0026#34;{a} must be {t}\u0026#34; return fn(*args) return wrapper return decorator 5ï¼‰ç®€å•ç¼“å­˜ï¼ˆMemoizeï¼‰ def cache(fn): memo = {} @wraps(fn) def wrapper(*args): if args not in memo: memo[args] = fn(*args) return memo[args] return wrapper 6ï¼‰é™åˆ¶å‡½æ•°æ‰§è¡Œæ¬¡æ•° def limit_times(n): def decorator(fn): count = 0 @wraps(fn) def wrapper(*args, **kwargs): nonlocal count if count \u0026gt;= n: print(\u0026#34;å·²è¶…è¿‡å…è®¸æ‰§è¡Œæ¬¡æ•°\u0026#34;) return count += 1 return fn(*args, **kwargs) return wrapper return decorator 7ï¼‰é‡è¯•æœºåˆ¶ï¼ˆå¼‚å¸¸é‡è¯•ï¼‰ import time from functools import wraps def retry(times=3, delay=1): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): for i in range(times): try: return fn(*args, **kwargs) except Exception: time.sleep(delay) raise return wrapper return decorator 8ï¼‰å‡½æ•°ç»“æœå¼ºåˆ¶ä¸ºç‰¹å®šç±»å‹ def ensure_type(t): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): return t(fn(*args, **kwargs)) return wrapper return decorator 9ï¼‰æƒé™æ£€æŸ¥ï¼ˆåç«¯å¿…ç”¨ï¼‰ def require_admin(fn): @wraps(fn) def wrapper(*args, **kwargs): if not kwargs.get(\u0026#39;is_admin\u0026#39;): raise PermissionError(\u0026#34;No permission\u0026#34;) return fn(*args, **kwargs) return wrapper 10ï¼‰æ‰“å°å‡½æ•°å…¥å‚ä¸è¿”å›å€¼ def trace(fn): @wraps(fn) def wrapper(*args, **kwargs): print(f\u0026#34;{fn.__name__} å…¥å‚: {args}, {kwargs}\u0026#34;) result = fn(*args, **kwargs) print(f\u0026#34;{fn.__name__} è¿”å›: {result}\u0026#34;) return result return wrapper 11ï¼‰æƒ°æ€§æ‰§è¡Œï¼ˆç”¨äºç¼“å­˜å¤§å¯¹è±¡çš„åˆå§‹åŒ–ï¼‰ def lazy(fn): cached = {} @wraps(fn) def wrapper(*args, **kwargs): if \u0026#39;value\u0026#39; not in cached: cached[\u0026#39;value\u0026#39;] = fn(*args, **kwargs) return cached[\u0026#39;value\u0026#39;] return wrapper 12ï¼‰åªæ‰§è¡Œä¸€æ¬¡ï¼ˆå•ä¾‹/åˆå§‹åŒ–åœºæ™¯ï¼‰ def once(fn): done = False result = None @wraps(fn) def wrapper(*args, **kwargs): nonlocal done, result if not done: result = fn(*args, **kwargs) done = True return result return wrapper 13ï¼‰å¼‚æ­¥å‡½æ•°è£…é¥°å™¨ï¼ˆæ”¯æŒ asyncï¼‰ import asyncio from functools import wraps def async_log(fn): @wraps(fn) async def wrapper(*args, **kwargs): print(f\u0026#34;ã€ASYNC LOGã€‘è°ƒç”¨ {fn.__name__}\u0026#34;) return await fn(*args, **kwargs) return wrapper 14ï¼‰å‡½æ•°èŠ‚æµï¼ˆthrottleï¼‰ import time def throttle(interval): def decorator(fn): last = 0 @wraps(fn) def wrapper(*args, **kwargs): nonlocal last now = time.time() if now - last \u0026gt; interval: last = now return fn(*args, **kwargs) return wrapper return decorator 15ï¼‰å‡½æ•°é˜²æŠ–ï¼ˆdebounceï¼‰ import time def debounce(wait): def decorator(fn): last = 0 @wraps(fn) def wrapper(*args, **kwargs): nonlocal last last = time.time() time.sleep(wait) if time.time() - last \u0026gt;= wait: return fn(*args, **kwargs) return wrapper return decorator 16ï¼‰å‡½æ•°æ‰§è¡Œå‰ååŠ é”ï¼ˆå¤šçº¿ç¨‹ï¼‰ from functools import wraps from threading import Lock def with_lock(lock: Lock): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): with lock: return fn(*args, **kwargs) return wrapper return decorator 17ï¼‰æ•°æ®åº“äº‹åŠ¡ç®¡ç†ï¼ˆFastAPI/SQLAlchemy å¸¸è§ï¼‰ def db_transaction(fn): @wraps(fn) def wrapper(db, *args, **kwargs): try: result = fn(db, *args, **kwargs) db.commit() return result except: db.rollback() raise return wrapper 18ï¼‰ç¡®ä¿å‡½æ•°åœ¨æŸä¸ªç›®å½•æ‰§è¡Œ import os from functools import wraps def cd(path): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): old = os.getcwd() os.chdir(path) try: return fn(*args, **kwargs) finally: os.chdir(old) return wrapper return decorator 19ï¼‰è‡ªåŠ¨é‡è¯• + æ‰“å°é‡è¯•æ¬¡æ•° def retry_log(times=3): def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): for i in range(1, times+1): try: return fn(*args, **kwargs) except Exception as e: print(f\u0026#34;é‡è¯• {i}/{times}: {e}\u0026#34;) raise return wrapper return decorator 20ï¼‰å°†æ™®é€šå‡½æ•°å˜æˆå±æ€§ï¼ˆå¸¸è§äºç±»ï¼‰ def lazy_property(fn): attr = \u0026#34;_lazy_\u0026#34; + fn.__name__ @property @wraps(fn) def wrapper(self): if not hasattr(self, attr): setattr(self, attr, fn(self)) return getattr(self, attr) return wrapper ğŸ BONUSï¼šé€ä½ ä¸€ä¸ªè£…é¥°å™¨ä¸‡èƒ½æ¨¡æ¿ï¼ˆé€šç”¨å‹ï¼‰ from functools import wraps def decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): # å‰ç½®é€»è¾‘ result = fn(*args, **kwargs) # åç½®é€»è¾‘ return result return wrapper ","description":" âœ… ä¸€ã€ä»€ä¹ˆæ˜¯è£…é¥°å™¨ï¼ˆDecoratorï¼‰ æ¦‚æ‹¬ï¼šè£…é¥°å™¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥ç»™å¦å¤–ä¸€ä¸ªå‡½æ•°å¢å¼ºåŠŸèƒ½ï¼Œä½†ä¸ä¿®æ”¹åŸä»£ç ã€‚\nä½ å†™ä¸€ä¸ªå‡½æ•° f()ï¼Œè£…é¥°å™¨ @decorator å¯ä»¥åœ¨å®ƒå‰åæ‰§è¡Œä»£ç ï¼Œä¾‹å¦‚å¢åŠ æ—¥å¿—ã€æƒé™æ£€æŸ¥ã€è®¡æ—¶åŠŸèƒ½ç­‰ã€‚\nâœ… äºŒã€æœ€ç®€å•çš„è£…é¥°å™¨ç¤ºä¾‹ def my_decorator(func): def wrapper(): print(\u0026#34;æ‰§è¡Œå‰\u0026#34;) func() print(\u0026#34;æ‰§è¡Œå\u0026#34;) return wrapper @my_decorator def say_hello(): print(\u0026#34;Hello\u0026#34;) say_hello() è¾“å‡ºï¼š\næ‰§è¡Œå‰ Hello æ‰§è¡Œå è§£é‡Šï¼š\n@my_decorator ç­‰ä»·äº say_hello = my_decorator(say_hello) wrapper() æ›¿ä»£äº†åŸå‡½æ•°ï¼Œä½†å†…éƒ¨ä»è°ƒç”¨åŸå‡½æ•°ï¼Œæ‰€ä»¥åŠŸèƒ½è¢«â€œåŒ…è£…â€äº†ã€‚ âœ… ä¸‰ã€è£…é¥°å™¨é€šç”¨æ¨¡æ¿ï¼ˆæœ€å¸¸ç”¨ï¼‰ é€‚ç”¨äºå¤§å¤šæ•°çœŸå®åœºæ™¯ã€‚\n"},{"id":178,"href":"/management/development/","title":"Development","parent":"Management","content":"Document List:\nå¦‚ä½•é™ä½ç¼–ç¨‹ä¸­å¯¹é”™è¯¯å¤„ç†çš„å¿ƒæ™ºè´Ÿæ‹… ç¼–ç¨‹é£æ ¼ ","description":"Document List:\nå¦‚ä½•é™ä½ç¼–ç¨‹ä¸­å¯¹é”™è¯¯å¤„ç†çš„å¿ƒæ™ºè´Ÿæ‹… ç¼–ç¨‹é£æ ¼ "},{"id":179,"href":"/backend/python/official/dict/","title":"Dict (å­—å…¸)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€æ¸…æ™°ã€æœ€å¼€å‘è€…è§†è§’çš„ Python dict å…¨é¢æŒ‡å—ï¼ŒåŒ…å«ï¼šåŸºç¡€ã€è¿›é˜¶ã€æœ€ä½³å®è·µã€æ€§èƒ½ä¼˜åŒ–ã€å¸¸è§å‘ã€é«˜çº§ç”¨æ³•ã€å­—å…¸æ¨å¯¼ã€åˆå¹¶æŠ€å·§ã€æ’åºæŠ€å·§ã€é»˜è®¤å­—å…¸ã€ä¸å¯å˜å­—å…¸ã€åº”ç”¨åœºæ™¯ç­‰ã€‚\nå†…å®¹éå¸¸è´´è¿‘å®é™…é¡¹ç›®å¼€å‘ï¼ˆFastAPIã€SQLAlchemyã€ä¸šåŠ¡ä»£ç éƒ½ç»å¸¸ç”¨ï¼‰ã€‚\n1. dict åŸºç¡€ï¼šæ ¸å¿ƒè¦ç‚¹ d = {\u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;, \u0026#34;age\u0026#34;: 18} dict çš„ 3 ä¸ªå…³é”®ç‰¹æ€§ï¼š\næ— åºä½†ä¿æŒæ’å…¥é¡ºåºï¼ˆPython 3.7+ï¼‰ key å¿…é¡»å¯å“ˆå¸Œï¼ˆä¸å¯å˜ï¼‰ æŸ¥è¯¢å¤æ‚åº¦ O(1) â€”â€” å“ˆå¸Œè¡¨ å¸¸ç”¨ API\nd.keys() d.values() d.items() d.get(\u0026#34;key\u0026#34;, default) d.pop(\u0026#34;key\u0026#34;) d.update(other_dict) 2. dict çš„åˆ›å»ºæ–¹å¼ â‘  å­—é¢é‡ï¼ˆæœ€å¸¸ç”¨ï¼‰ a = {\u0026#34;x\u0026#34;: 1, \u0026#34;y\u0026#34;: 2} â‘¡ dict() æ„é€ å‡½æ•° b = dict(x=1, y=2) â‘¢ ä»åˆ—è¡¨æ„å»º pairs = [(\u0026#34;x\u0026#34;, 1), (\u0026#34;y\u0026#34;, 2)] dict(pairs) â‘£ ä½¿ç”¨å­—å…¸æ¨å¯¼å¼ d = {i: i * 2 for i in range(5)} 3. è®¿é—®å…ƒç´ ï¼šæ¨èæ–¹å¼ âœ… d.get(key)ï¼ˆä¸ä¼šæŠ›å¼‚å¸¸ï¼‰ d.get(\u0026#34;name\u0026#34;) # æœ‰è¿”å›å€¼ d.get(\u0026#34;missing\u0026#34;) # None d.get(\u0026#34;missing\u0026#34;, 0) # 0 âŒ ä¸æ¨è d[\u0026#34;missing\u0026#34;] # KeyError 4. æ›´æ–°å­—å…¸çš„å¤šç§æ–¹å¼ â‘  èµ‹å€¼ï¼ˆæœ€å¸¸è§ï¼‰ d[\u0026#34;x\u0026#34;] = 100 â‘¡ update() d.update({\u0026#34;y\u0026#34;: 200}) â‘¢ ä½¿ç”¨ è§£åŒ…åˆå¹¶ï¼ˆ3.9+ æ¨èï¼‰ new_d = d1 | d2 # åˆ›å»ºæ–°å­—å…¸ d1 |= d2 # in-place æ›´æ–° â‘£ setdefaultï¼ˆç”¨äºå¤šä¸ªå±‚çº§ï¼‰ d.setdefault(\u0026#34;config\u0026#34;, {})[\u0026#34;port\u0026#34;] = 3306 5. å­—å…¸æ¨å¯¼å¼ï¼ˆPythonic å¿…å¤‡ï¼‰ ç”Ÿæˆæ–°å­—å…¸\n{i: i*i for i in range(10) if i % 2 == 0} è½¬æ¢ key/value\n{k: v.upper() for k, v in d.items()} è¿‡æ»¤å­—å…¸\n{k: v for k, v in d.items() if v is not None} 6. æŒ‰ key/value æ’åºå­—å…¸ï¼ˆè¿”å›åˆ—è¡¨ï¼‰ æŒ‰ key æ’åº\nsorted(d.items(), key=lambda x: x[0]) æŒ‰ value æ’åº\nsorted(d.items(), key=lambda x: x[1]) æ’åºåè½¬æ¢å› dictï¼ˆPython 3.7+ï¼‰\ndict(sorted(d.items(), key=lambda x: x[1])) 7. å­—å…¸çš„é«˜çº§ç”¨æ³• 7.1 default dictï¼ˆé¿å… KeyErrorï¼‰ é€‚åˆç»Ÿè®¡åˆ†ç±»ã€è®¡æ•°ç­‰ï¼š\nfrom collections import defaultdict d = defaultdict(int) d[\u0026#34;a\u0026#34;] += 1 # ä¸ä¼šæŠ¥é”™ åµŒå¥—ç»“æ„ï¼š\nd = defaultdict(lambda: defaultdict(int)) 7.2 Counterï¼ˆæœ€å¼ºè®¡æ•°å™¨ï¼‰ æ¯”è‡ªå·±å†™é€»è¾‘å¿«å¤ªå¤šï¼š\nfrom collections import Counter Counter(\u0026#34;hello world\u0026#34;) 7.3 OrderedDictï¼ˆå·²ä¸å¸¸ç”¨ï¼‰ å› ä¸º 3.7 ä¹‹å dict å°±ä¿æŒæ’å…¥é¡ºåºäº†ã€‚\n7.4 MappingProxyTypeï¼ˆåªè¯»å­—å…¸ï¼‰ from types import MappingProxyType d = {\u0026#34;x\u0026#34;: 1} readonly = MappingProxyType(d) ä¿®æ”¹ dï¼Œreadonly åŒæ­¥å˜åŒ–ã€‚\n7.5 é“¾å¼å­—å…¸ï¼ˆChainMapï¼‰ ç”¨äºâ€œå¤šå±‚ fallback é…ç½®â€ï¼š\nfrom collections import ChainMap final = ChainMap(user_config, system_config, default_config) 8. æ€§èƒ½ï¼šdict ä¸ºä»€ä¹ˆå¿«ï¼Ÿ å› ä¸ºå“ˆå¸Œè¡¨ + O(1) å¹³å‡æŸ¥è¯¢æ—¶é—´ã€‚\næ€§èƒ½ç»“è®ºï¼š\næŸ¥æ‰¾ï¼šO(1) æ›´æ–°ï¼šO(1) åˆ é™¤ï¼šO(1) éå†ï¼šå’Œé•¿åº¦æˆæ­£æ¯” æ¯” list æŸ¥æ‰¾å¿«å¤ªå¤šã€‚\n9. å¸¸è§å‘ä¸æœ€ä½³å®è·µ âŒ 1) key å¿…é¡»å¯å“ˆå¸Œ ä¸èƒ½ç”¨ list æˆ– dict åš key\n{[1,2]: \u0026#34;x\u0026#34;} # TypeError âœ… å¯ä»¥ä½¿ç”¨å…ƒç»„\n{(1,2): \u0026#34;x\u0026#34;} âŒ 2) ä¸è¦ä¿®æ”¹éå†ä¸­çš„å­—å…¸ for k in d: d.pop(k) # RuntimeError âœ… æ­£ç¡®å†™æ³•ï¼š\nfor k in list(d): d.pop(k) âŒ 3) update() ä¼šè¦†ç›–åŒå key d.update({\u0026#34;a\u0026#34;: 100}) # è¦†ç›– âŒ 4) ä½¿ç”¨ is åˆ¤æ–­å€¼ if x is 1: # é”™è¯¯ âœ… ç”¨ ==\n10. å­—å…¸æœ€ä½³å®è·µï¼ˆåŠ¡å¿…æŒæ¡ï¼‰ ä½¿ç”¨ .get() é¿å… KeyErrorã€‚\nå¤§é‡è®¡æ•° -\u0026gt; Counter æ¯”æ‰‹å†™å¾ªç¯æ›´å¿«ã€‚\nåˆå¹¶å­—å…¸ç”¨ |ï¼ˆPython 3.9+ï¼‰ final = config_default | config_env | config_user ä½¿ç”¨ dictionary comprehension æ¸…ç†æ•°æ® clean = {k: v for k, v in raw.items() if v} JSON æ•°æ®æ˜ å°„åˆ°å­—å…¸ï¼Œæœ€å¥½ç”¨ dataclass æˆ– pydantic é¿å… key å†™é”™ã€‚\n11. å­—å…¸åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ï¼ˆéå¸¸å®ç”¨ï¼‰ â‘  FastAPI è¯·æ±‚ä½“ -\u0026gt; å­—å…¸ ç”¨äºå­—æ®µè¿‡æ»¤ï¼š\ndata = request.dict(exclude_none=True) â‘¡ SQLAlchemy æŸ¥è¯¢ç»“æœ -\u0026gt; å­—å…¸ row = session.execute(stmt).mappings().first() â‘¢ æƒé™ç³»ç»Ÿï¼ˆCasbin / RBACï¼‰ permissions = list of dict\n{\u0026#34;module\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;action\u0026#34;: \u0026#34;read\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/users\u0026#34;} â‘£ JSON å“åº”è¿”å› return {\u0026#34;code\u0026#34;: 0, \u0026#34;msg\u0026#34;: \u0026#34;ok\u0026#34;, \u0026#34;data\u0026#34;: result} å­—å…¸çš„æ‰“åŒ…è§£åŒ…ç¤ºä¾‹ ä»¥ä¸‹æ˜¯ æœ€å¸¸ç”¨ã€æœ€å¥½ç†è§£çš„ Python å­—å…¸ â€œæ‰“åŒ… / è§£åŒ…â€ ç¤ºä¾‹ï¼ˆåŒ…æ‹¬ â­é«˜çº§å·¥ç¨‹å¸¸ç”¨æŠ€å·§ï¼‰ã€‚éå¸¸å®ç”¨ï¼\nğŸŸ¦ 1. å­—å…¸è§£åŒ…ï¼ˆDictionary Unpackingï¼‰ ** ç”¨äºå‡½æ•°å‚æ•°\næŠŠå­—å…¸å±•å¼€æˆå…³é”®å­—å‚æ•°ä¼ å…¥å‡½æ•°ï¼š\ndef foo(a, b, c): print(a, b, c) data = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3} foo(**data) è¾“å‡ºï¼š\n1 2 3 ğŸŸ© 2. å­—å…¸åˆå¹¶ï¼ˆç”¨ ** è§£åŒ…ï¼‰ Python 3.5+ï¼š\nd1 = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2} d2 = {\u0026#34;b\u0026#34;: 20, \u0026#34;c\u0026#34;: 3} merged = {**d1, **d2} print(merged) è¾“å‡ºï¼š\n{\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 20, \u0026#39;c\u0026#39;: 3} d2 è¦†ç›– d1 çš„åŒå keyã€‚\nğŸ”¹ ç”¨äºåˆå¹¶é…ç½®ã€åˆå¹¶ JSONã€æ›´æ–°å‚æ•°éå¸¸å¸¸è§ã€‚\nğŸŸ¨ 3. å°†å¤šä¸ªå˜é‡æ‰“åŒ…æˆå­—å…¸ï¼ˆå¸¸ç”¨ï¼‰ name = \u0026#34;jack\u0026#34; age = 18 info = {\u0026#34;name\u0026#34;: name, \u0026#34;age\u0026#34;: age} print(info) æ›´ Pythonic çš„å†™æ³•ï¼šä½¿ç”¨å­—é¢é‡\ninfo = dict(name=name, age=age) ğŸŸ§ 4. ä»å­—å…¸ä¸­è§£åŒ…å¤šä¸ªå€¼ï¼ˆå¸¸ç”¨ï¼‰ ç»å…¸å†™æ³•ï¼š\nuser = {\u0026#34;name\u0026#34;: \u0026#34;jack\u0026#34;, \u0026#34;age\u0026#34;: 18} name, age = user[\u0026#34;name\u0026#34;], user[\u0026#34;age\u0026#34;] æ›´ä¼˜é›…å†™æ³•ï¼š\nname, age = (user[k] for k in (\u0026#34;name\u0026#34;, \u0026#34;age\u0026#34;)) ğŸŸ¥ 5. for å¾ªç¯ä¸­è§£åŒ… items() d = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3} for key, value in d.items(): print(key, value) ğŸŸ¦ 6. è§£åŒ…æŸäº› keyï¼ˆå·¥ç¨‹å¸¸ç”¨ï¼‰ ä»å­—å…¸ä¸­å–å‡ºå‡ ä¸ª key åˆ°æ–°çš„å­—å…¸ï¼š\nd = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2, \u0026#34;c\u0026#34;: 3} subset = {k: d[k] for k in (\u0026#34;a\u0026#34;, \u0026#34;c\u0026#34;)} print(subset) è¾“å‡ºï¼š\n{\u0026#39;a\u0026#39;: 1, \u0026#39;c\u0026#39;: 3} ğŸŸ© 7. åŠ¨æ€æ„é€ å­—å…¸ï¼ˆè‡ªåŠ¨è§£åŒ…å˜é‡ï¼‰ æ¯”å¦‚ API è¿”å›å­—æ®µï¼š\ncode = \u0026#34;600001\u0026#34; price = 12.4 volume = 30000 data = {\u0026#34;code\u0026#34;: code, \u0026#34;price\u0026#34;: price, \u0026#34;volume\u0026#34;: volume} é«˜çº§å†™æ³•ï¼šä½¿ç”¨ locals()\ndata = {k: v for k, v in locals().items() if k in (\u0026#34;code\u0026#34;, \u0026#34;price\u0026#34;, \u0026#34;volume\u0026#34;)} ğŸŸ¨ 8. ä½¿ç”¨è§£åŒ…æ¥æ›´æ–°å­—å…¸ config = {\u0026#34;host\u0026#34;: \u0026#34;localhost\u0026#34;, \u0026#34;port\u0026#34;: 3306} new_config = {**config, \u0026#34;port\u0026#34;: 3307, \u0026#34;debug\u0026#34;: True} print(new_config) ğŸŸ§ 9. ç”¨ ** è§£åŒ…é»˜è®¤é…ç½® + ç”¨æˆ·é…ç½®ï¼ˆæœ€å¸¸è§ï¼‰ default_cfg = {\u0026#34;retry\u0026#34;: 3, \u0026#34;timeout\u0026#34;: 10} user_cfg = {\u0026#34;timeout\u0026#34;: 5} cfg = {**default_cfg, **user_cfg} æœ€ç»ˆï¼š\n{\u0026#39;retry\u0026#39;: 3, \u0026#39;timeout\u0026#39;: 5} ç”¨äºï¼š\nå‡½æ•°é…ç½® æ•°æ®åº“è¿æ¥é…ç½® HTTP è¯·æ±‚å‚æ•° FastAPI å…¥å‚å¤„ç† ğŸŸ¥ 10. å°†å…ƒç»„åˆ—è¡¨è§£åŒ…æˆå­—å…¸ pairs = [(\u0026#34;a\u0026#34;, 1), (\u0026#34;b\u0026#34;, 2)] d = dict(pairs) ğŸŸ© Bonusï¼šè§£åŒ…å­—å…¸ keys / valuesï¼ˆå¸¸ç”¨ï¼‰ keys = [*d] # ç­‰åŒäº list(d.keys()) values = [*d.values()] items = [*d.items()] ğŸ“Œ æ€»ç»“ å­—å…¸æ‰“åŒ…\nå˜é‡ -\u0026gt; å­—å…¸ï¼š{\u0026quot;k\u0026quot;: var} å¤šä¸ªå­—å…¸ -\u0026gt; æ–°å­—å…¸ï¼š{**d1, **d2} å­—å…¸è§£åŒ…\nå‡½æ•°ä¼ å‚ï¼šfoo(**d) æå– keyï¼ša, b = d[\u0026quot;a\u0026quot;], d[\u0026quot;b\u0026quot;] items è§£åŒ…ï¼šfor k, v in d.items() ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€æ¸…æ™°ã€æœ€å¼€å‘è€…è§†è§’çš„ Python dict å…¨é¢æŒ‡å—ï¼ŒåŒ…å«ï¼šåŸºç¡€ã€è¿›é˜¶ã€æœ€ä½³å®è·µã€æ€§èƒ½ä¼˜åŒ–ã€å¸¸è§å‘ã€é«˜çº§ç”¨æ³•ã€å­—å…¸æ¨å¯¼ã€åˆå¹¶æŠ€å·§ã€æ’åºæŠ€å·§ã€é»˜è®¤å­—å…¸ã€ä¸å¯å˜å­—å…¸ã€åº”ç”¨åœºæ™¯ç­‰ã€‚\nå†…å®¹éå¸¸è´´è¿‘å®é™…é¡¹ç›®å¼€å‘ï¼ˆFastAPIã€SQLAlchemyã€ä¸šåŠ¡ä»£ç éƒ½ç»å¸¸ç”¨ï¼‰ã€‚\n1. dict åŸºç¡€ï¼šæ ¸å¿ƒè¦ç‚¹ d = {\u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;, \u0026#34;age\u0026#34;: 18} dict çš„ 3 ä¸ªå…³é”®ç‰¹æ€§ï¼š\næ— åºä½†ä¿æŒæ’å…¥é¡ºåºï¼ˆPython 3.7+ï¼‰ key å¿…é¡»å¯å“ˆå¸Œï¼ˆä¸å¯å˜ï¼‰ æŸ¥è¯¢å¤æ‚åº¦ O(1) â€”â€” å“ˆå¸Œè¡¨ å¸¸ç”¨ API\nd.keys() d.values() d.items() d.get(\u0026#34;key\u0026#34;, default) d.pop(\u0026#34;key\u0026#34;) d.update(other_dict) 2. dict çš„åˆ›å»ºæ–¹å¼ â‘  å­—é¢é‡ï¼ˆæœ€å¸¸ç”¨ï¼‰ a = {\u0026#34;x\u0026#34;: 1, \u0026#34;y\u0026#34;: 2} â‘¡ dict() æ„é€ å‡½æ•° b = dict(x=1, y=2) â‘¢ ä»åˆ—è¡¨æ„å»º pairs = [(\u0026#34;x\u0026#34;, 1), (\u0026#34;y\u0026#34;, 2)] dict(pairs) â‘£ ä½¿ç”¨å­—å…¸æ¨å¯¼å¼ d = {i: i * 2 for i in range(5)} 3. è®¿é—®å…ƒç´ ï¼šæ¨èæ–¹å¼ âœ… d.get(key)ï¼ˆä¸ä¼šæŠ›å¼‚å¸¸ï¼‰ d.get(\u0026#34;name\u0026#34;) # æœ‰è¿”å›å€¼ d.get(\u0026#34;missing\u0026#34;) # None d.get(\u0026#34;missing\u0026#34;, 0) # 0 âŒ ä¸æ¨è d[\u0026#34;missing\u0026#34;] # KeyError 4. æ›´æ–°å­—å…¸çš„å¤šç§æ–¹å¼ â‘  èµ‹å€¼ï¼ˆæœ€å¸¸è§ï¼‰ d[\u0026#34;x\u0026#34;] = 100 â‘¡ update() d.update({\u0026#34;y\u0026#34;: 200}) â‘¢ ä½¿ç”¨ è§£åŒ…åˆå¹¶ï¼ˆ3.9+ æ¨èï¼‰ new_d = d1 | d2 # åˆ›å»ºæ–°å­—å…¸ d1 |= d2 # in-place æ›´æ–° â‘£ setdefaultï¼ˆç”¨äºå¤šä¸ªå±‚çº§ï¼‰ d.setdefault(\u0026#34;config\u0026#34;, {})[\u0026#34;port\u0026#34;] = 3306 5. å­—å…¸æ¨å¯¼å¼ï¼ˆPythonic å¿…å¤‡ï¼‰ ç”Ÿæˆæ–°å­—å…¸\n"},{"id":180,"href":"/operations/dns/","title":"DNS","parent":"Operations","content":"Document List:\n1.1.1.1 vs 8.8.8.8 ","description":"Document List:\n1.1.1.1 vs 8.8.8.8 "},{"id":181,"href":"/operations/docker/","title":"Docker","parent":"Operations","content":"Document List:\nDocker FAQ Docker åŸºç¡€æ•™ç¨‹ Docker æ ¸å¿ƒæ¦‚å¿µ Docker Compose å­—æ®µè®²è§£ Docker Compose æœ€ä½³å®è·µ Docker Compose æ ¸å¿ƒæ¦‚å¿µ Docker vs Podman Docker ç½‘ç»œåŸç† Docker-in-Docker (DinD) vs docker.sock Dockerfile æœ€ä½³å®è·µ Dockerfile è¯¦è§£ ","description":"Document List:\nDocker FAQ Docker åŸºç¡€æ•™ç¨‹ Docker æ ¸å¿ƒæ¦‚å¿µ Docker Compose å­—æ®µè®²è§£ Docker Compose æœ€ä½³å®è·µ Docker Compose æ ¸å¿ƒæ¦‚å¿µ Docker vs Podman Docker ç½‘ç»œåŸç† Docker-in-Docker (DinD) vs docker.sock Dockerfile æœ€ä½³å®è·µ Dockerfile è¯¦è§£ "},{"id":182,"href":"/operations/docker/docker-compose-yaml/","title":"Docker Compose å­—æ®µè®²è§£","parent":"Docker","content":"å†…å®¹ï¼šé¡¶å±‚å­—æ®µ -\u0026gt; service å­—æ®µ -\u0026gt; ç½‘ç»œ/å­˜å‚¨ -\u0026gt; è¿›é˜¶å­—æ®µ -\u0026gt; å·²åºŸå¼ƒå­—æ®µ\nä¸€ã€é¡¶å±‚å­—æ®µï¼ˆTop-level keysï¼‰ version: \u0026#34;3.9\u0026#34; # å·²å¯çœç•¥ï¼ˆv2 è§„èŒƒï¼‰ name: myapp services: networks: volumes: configs: secrets: 1ï¸âƒ£ versionï¼ˆå·²ä¸æ¨èï¼‰ Compose v2 å¯ä»¥ä¸å†™ å®˜æ–¹æ¨èåˆ é™¤ # version: \u0026#34;3.9\u0026#34; # å¯çœç•¥ 2ï¸âƒ£ name æŒ‡å®š Project åï¼ˆä¼˜å…ˆçº§é«˜äºç›®å½•åï¼‰\nname: myapp ç­‰ä»·äºï¼š\ndocker compose -p myapp up 3ï¸âƒ£ servicesï¼ˆæ ¸å¿ƒï¼‰ å®šä¹‰æ‰€æœ‰æœåŠ¡ï¼ˆ= å®¹å™¨æ¨¡æ¿ï¼‰\nservices: web: api: db: 4ï¸âƒ£ networks å®šä¹‰ç½‘ç»œï¼ˆé»˜è®¤ä¼šè‡ªåŠ¨åˆ›å»º \u0026lt;project\u0026gt;_defaultï¼‰\n5ï¸âƒ£ volumes å®šä¹‰å‘½åæ•°æ®å·\n6ï¸âƒ£ configs / secrets configsï¼šé…ç½®æ–‡ä»¶ï¼ˆå Swarm / K8Sï¼‰ secretsï¼šæ•æ„Ÿä¿¡æ¯ äºŒã€services å­—æ®µè¯¦è§£ï¼ˆé‡ä¸­ä¹‹é‡ï¼‰ 1ï¸âƒ£ æ„å»ºä¸é•œåƒ imageï¼šæŒ‡å®šé•œåƒ\nimage: nginx:1.27-alpine buildï¼šæ„å»ºé•œåƒ\nbuild: . å®Œæ•´å†™æ³•ï¼š\nbuild: context: . dockerfile: Dockerfile target: prod args: NODE_ENV: production pull_policyï¼šé•œåƒæ‹‰å–ç­–ç•¥\npull_policy: if_not_present å¯é€‰ï¼š\nalways missing never 2ï¸âƒ£ å®¹å™¨è¿è¡Œè¡Œä¸º container_nameï¼šæŒ‡å®šå®¹å™¨åï¼ˆâš ï¸ ä¸æ¨èåœ¨ scale æ—¶ä½¿ç”¨ï¼‰\ncontainer_name: my-nginx commandï¼šè¦†ç›–é•œåƒ CMD\ncommand: [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] entrypointï¼šè¦†ç›– ENTRYPOINT\nentrypoint: [\u0026#34;/app/start.sh\u0026#34;] working_dirï¼šè®¾ç½®å·¥ä½œç›®å½•\nworking_dir: /app userï¼šæŒ‡å®šè¿è¡Œç”¨æˆ·ï¼ˆå®‰å…¨ï¼‰\nuser: \u0026#34;1000:1000\u0026#34; 3ï¸âƒ£ ç«¯å£ä¸ç½‘ç»œ portsï¼šç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœºè®¿é—®ï¼‰\nports: - \u0026#34;8080:80\u0026#34; exposeï¼šä»…å®¹å™¨é—´å¯è§ï¼ˆä¸æ˜ å°„å®¿ä¸»æœºï¼‰\nexpose: - \u0026#34;8080\u0026#34; networksï¼šæŒ‡å®šæœåŠ¡åŠ å…¥çš„ç½‘ç»œ\nnetworks: - backend hostnameï¼šå®¹å™¨ä¸»æœºå\nhostname: web01 extra_hostsï¼šä¿®æ”¹ /etc/hosts\nextra_hosts: - \u0026#34;db.local:10.0.0.10\u0026#34; 4ï¸âƒ£ ç¯å¢ƒå˜é‡ä¸é…ç½® environment\nenvironment: - ENV=production - DEBUG=false æˆ–ï¼š\nenvironment: ENV: production DEBUG: \u0026#34;false\u0026#34; env_fileï¼šä»æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡\nenv_file: - .env 5ï¸âƒ£ å­˜å‚¨ç›¸å…³ volumesï¼šæŒ‚è½½æ•°æ®\nvolumes: - db_data:/var/lib/postgresql/data - ./config:/etc/app:ro tmpfsï¼šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ\ntmpfs: - /run - /tmp 6ï¸âƒ£ ä¾èµ–ä¸å¯åŠ¨é¡ºåº depends_onï¼šæ§åˆ¶å¯åŠ¨é¡ºåºï¼ˆâš ï¸ ä¸ä¿è¯æœåŠ¡å¯ç”¨ï¼‰\ndepends_on: - db å¸¦ healthcheckï¼š\ndepends_on: db: condition: service_healthy healthcheckï¼šå¥åº·æ£€æŸ¥ï¼ˆéå¸¸é‡è¦ï¼‰\nhealthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;curl\u0026#34;, \u0026#34;-f\u0026#34;, \u0026#34;http://localhost/health\u0026#34;] interval: 10s timeout: 2s retries: 3 7ï¸âƒ£ èµ„æºé™åˆ¶ï¼ˆé‡è¦ï¼‰ deployï¼ˆâš ï¸ åœ¨é Swarm ä¸‹éƒ¨åˆ†å­—æ®µæ— æ•ˆï¼‰\ndeploy: resources: limits: cpus: \u0026#34;1.0\u0026#34; memory: 512M ç­‰ä»·çš„é deploy å†™æ³•ï¼ˆæ¨èæœ¬åœ°ç”¨ï¼‰ï¼š\nmem_limit: 512m cpus: 1.0 8ï¸âƒ£ é‡å¯ç­–ç•¥ restart\nrestart: unless-stopped å¯é€‰ï¼š\nno always on-failure unless-stopped 9ï¸âƒ£ æ—¥å¿— logging\nlogging: driver: json-file options: max-size: \u0026#34;10m\u0026#34; max-file: \u0026#34;3\u0026#34; ğŸ”Ÿ å®‰å…¨ç›¸å…³ privilegedï¼šæ˜¯å¦ç‰¹æƒæ¨¡å¼ï¼ˆâš ï¸ è°¨æ…ï¼‰\nprivileged: true cap_add / cap_drop\ncap_drop: - ALL cap_add: - NET_BIND_SERVICE security_opt\nsecurity_opt: - no-new-privileges:true ä¸‰ã€networks å­—æ®µè¯¦è§£ networks: backend: driver: bridge é«˜çº§ç”¨æ³•ï¼š\nnetworks: backend: driver: bridge ipam: config: - subnet: 172.20.0.0/16 å››ã€volumes å­—æ®µè¯¦è§£ volumes: db_data: driver: local äº”ã€configs / secretsï¼ˆäº†è§£å³å¯ï¼‰ configs: app_config: file: ./config.yml secrets: db_password: file: ./db_password.txt å…­ã€å·²åºŸå¼ƒ / ä¸æ¨èå­—æ®µ å­—æ®µ è¯´æ˜ links å·²åºŸå¼ƒï¼Œç”¨ network volumes_from ä¸æ¨è extends ä¸æ¨è cpu_shares å·²åºŸå¼ƒ version å¯çœç•¥ ä¸ƒã€ä¸€ä¸ªå®Œæ•´ç¤ºä¾‹ï¼ˆç”Ÿäº§é£æ ¼ï¼‰ name: erp services: api: build: . image: erp-api:1.0.0 ports: - \u0026#34;8000:8000\u0026#34; env_file: - .env depends_on: db: condition: service_healthy restart: unless-stopped db: image: postgres:16 volumes: - pgdata:/var/lib/postgresql/data environment: POSTGRES_PASSWORD: secret healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;pg_isready\u0026#34;] interval: 10s retries: 5 volumes: pgdata: å…«ã€æ€»ç»“ service æ˜¯å®¹å™¨æ¨¡æ¿ï¼Œä¸æ˜¯å®¹å™¨\ndepends_on ä¸ç­‰äºæœåŠ¡å°±ç»ª\nCompose æ˜¯å•æœºç¼–æ’ï¼Œä¸æ˜¯ç”Ÿäº§è°ƒåº¦\n","description":"å†…å®¹ï¼šé¡¶å±‚å­—æ®µ -\u0026gt; service å­—æ®µ -\u0026gt; ç½‘ç»œ/å­˜å‚¨ -\u0026gt; è¿›é˜¶å­—æ®µ -\u0026gt; å·²åºŸå¼ƒå­—æ®µ\nä¸€ã€é¡¶å±‚å­—æ®µï¼ˆTop-level keysï¼‰ version: \u0026#34;3.9\u0026#34; # å·²å¯çœç•¥ï¼ˆv2 è§„èŒƒï¼‰ name: myapp services: networks: volumes: configs: secrets: 1ï¸âƒ£ versionï¼ˆå·²ä¸æ¨èï¼‰ Compose v2 å¯ä»¥ä¸å†™ å®˜æ–¹æ¨èåˆ é™¤ # version: \u0026#34;3.9\u0026#34; # å¯çœç•¥ 2ï¸âƒ£ name æŒ‡å®š Project åï¼ˆä¼˜å…ˆçº§é«˜äºç›®å½•åï¼‰\n"},{"id":183,"href":"/operations/docker/docker-compose-best-practices/","title":"Docker Compose æœ€ä½³å®è·µ","parent":"Docker","content":" ä¸€ã€æ€»ä½“è®¾è®¡åŸåˆ™ï¼ˆå…ˆè®°ä½è¿™ 6 æ¡ï¼‰ 1ï¸âƒ£ ä¸€ä¸ª Compose = ä¸€ä¸ªåº”ç”¨ ä¸è¦æŠŠæ— å…³æœåŠ¡å¡è¿›ä¸€ä¸ª compose ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€ï¼šèµ· -\u0026gt; ç”¨ -\u0026gt; åœ -\u0026gt; åˆ  âœ… æ­£ç¡®ï¼š\nerp/ â”œâ”€ api/ â”œâ”€ web/ â””â”€ docker-compose.yml âŒ é”™è¯¯ï¼š\nall-in-one-compose.yml\n2ï¸âƒ£ Service æ˜¯â€œæ¨¡æ¿â€ï¼Œä¸æ˜¯å®ä¾‹ ä¸å…³å¿ƒå®¹å™¨å ä¸ä¾èµ–å®¹å™¨ IP ä¸å†™æ­» hostname âœ… ç”¨ service åé€šä¿¡\nâŒ ç”¨ IP / container_name é€šä¿¡\n3ï¸âƒ£ å®¹å™¨å¿…é¡»æ— çŠ¶æ€ ä»£ç æ— çŠ¶æ€ ä¼šè¯æ— çŠ¶æ€ æ•°æ®å…¨éƒ¨å¤–ç½®ï¼ˆDB / volumeï¼‰ 4ï¸âƒ£ é…ç½®å¤–ç½®ï¼Œé•œåƒé€šç”¨ é•œåƒä¸å«ç¯å¢ƒå·®å¼‚ ä½¿ç”¨ env / env_file / volume 5ï¸âƒ£ å¼€å‘ã€æµ‹è¯•ã€é¢„å‘ Compose å¯å¤ç”¨ é€šè¿‡ override / profile æ§åˆ¶å·®å¼‚ 6ï¸âƒ£ Compose æ˜¯â€œåº”ç”¨ç¼–æ’â€ï¼Œä¸æ˜¯è¿ç»´ç³»ç»Ÿ ä¸åš HA ä¸åšè‡ªæ„ˆ ä¸åšè°ƒåº¦ äºŒã€ç›®å½•ç»“æ„æœ€ä½³å®è·µ æ¨èç»“æ„\nproject/ â”œâ”€ docker/ â”‚ â”œâ”€ Dockerfile â”‚ â”œâ”€ nginx.conf â”‚ â””â”€ entrypoint.sh â”œâ”€ docker-compose.yml â”œâ”€ docker-compose.override.yml â”œâ”€ .env â”œâ”€ api/ â””â”€ web/ ğŸ“Œ Compose æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•\nä¸‰ã€ç¯å¢ƒå˜é‡æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ ä½¿ç”¨ .env æ–‡ä»¶ï¼ˆé»˜è®¤åŠ è½½ï¼‰ APP_ENV=dev DB_HOST=db DB_PORT=5432 services: api: env_file: - .env 2ï¸âƒ£ ä¸åœ¨ YAML é‡Œå†™æ•æ„Ÿä¿¡æ¯ âŒ\nPOSTGRES_PASSWORD: 123456 âœ…\nPOSTGRES_PASSWORD: ${DB_PASSWORD} 3ï¸âƒ£ å˜é‡åªç”¨äºâ€œé…ç½®â€ï¼Œä¸ç”¨äºâ€œé€»è¾‘â€ Compose ä¸æ˜¯æ¨¡æ¿å¼•æ“ã€‚\nå››ã€ç½‘ç»œæœ€ä½³å®è·µ 1ï¸âƒ£ æ°¸è¿œç”¨ service åé€šä¿¡ api -\u0026gt; db:5432\nâŒ ä¸ç”¨ IP âŒ ä¸ç”¨ linksï¼ˆåºŸå¼ƒï¼‰\n2ï¸âƒ£ ç«¯å£åªåœ¨éœ€è¦æš´éœ²æ—¶æ˜ å°„ ports: - \u0026#34;8080:80\u0026#34; ğŸ“Œ å®¹å™¨é—´é€šä¿¡ ä¸éœ€è¦ ports\n3ï¸âƒ£ æ‹†åˆ†å‰åç«¯ç½‘ç»œï¼ˆä¸­å¤§å‹é¡¹ç›®ï¼‰ networks: frontend: backend: äº”ã€å­˜å‚¨æœ€ä½³å®è·µ 1ï¸âƒ£ æ•°æ®åº“ä¸€å®šç”¨ volume volumes: - pgdata:/var/lib/postgresql/data 2ï¸âƒ£ é…ç½®æ–‡ä»¶ç”¨åªè¯» bind mount volumes: - ./config:/etc/app:ro 3ï¸âƒ£ ä¸å¾€å®¹å™¨å±‚å†™æ—¥å¿— æ—¥å¿—èµ° stdout Docker / ELK æ”¶é›† å…­ã€depends_on \u0026amp; healthcheckï¼ˆé«˜é¢‘å‘ï¼‰ âŒ é”™è¯¯ç†è§£ depends_on = æœåŠ¡å°±ç»ª\nâŒ é”™\nâœ… æ­£ç¡®åšæ³• db: healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;pg_isready\u0026#34;] interval: 5s retries: 5 api: depends_on: db: condition: service_healthy ä¸ƒã€èµ„æºé™åˆ¶ï¼ˆåˆ«å¿½è§†ï¼‰ æ¨èå†™æ³•ï¼ˆæœ¬åœ° / CIï¼‰\nmem_limit: 512m cpus: 1.0 ğŸ“Œ é˜²æ­¢ï¼š\næœ¬åœ°æœºå™¨è¢«æ‹–æ­» CI OOM å…«ã€æ—¥å¿—æœ€ä½³å®è·µ 1ï¸âƒ£ æ§åˆ¶æ—¥å¿—å¤§å° logging: driver: json-file options: max-size: \u0026#34;10m\u0026#34; max-file: \u0026#34;3\u0026#34; 2ï¸âƒ£ æ—¥å¿—å½’å®¿ stdout / stderr äº¤ç»™ Docker / Loki / ELK ä¹ã€æ„å»ºé•œåƒæœ€ä½³å®è·µ 1ï¸âƒ£ ä¸åœ¨ Compose é‡Œå†™å¤æ‚ build å¤æ‚é€»è¾‘æ”¾ Dockerfileã€‚\n2ï¸âƒ£ åˆ©ç”¨ç¼“å­˜ build: context: . 3ï¸âƒ£ é•œåƒå¯å¤ç”¨ image: erp-api:${APP_VERSION} åã€Profilesï¼ˆCompose v2 å¼ºçƒˆæ¨èï¼‰ åœºæ™¯æ§åˆ¶\nservices: admin: profiles: [\u0026#34;dev\u0026#34;] docker compose --profile dev up ğŸ“Œ æä½³æ›¿ä»£å¤šä¸ª compose æ–‡ä»¶ã€‚\nåä¸€ã€override æ–‡ä»¶æœ€ä½³å®è·µ docker-compose.override.yml\næœ¬åœ°å¼€å‘è‡ªåŠ¨åŠ è½½ ä¸æäº¤ç”Ÿäº§é…ç½® services: api: volumes: - ./api:/app åäºŒã€restart ç­–ç•¥ restart: unless-stopped é€‚åˆï¼š\nAPI Web Worker åä¸‰ã€Compose å¸¸è§åæ¨¡å¼ï¼ˆå¿…é¿ï¼‰ âŒ ä½¿ç”¨ container_name âŒ ä½¿ç”¨ links âŒ ç”¨ IP é€šä¿¡ âŒ åœ¨å®¹å™¨é‡Œè·‘ cron / systemd âŒ æŠŠ Compose å½“ Kubernetes ç”¨ âŒ åœ¨ Compose é‡Œåšå¤æ‚é€»è¾‘åˆ¤æ–­ åå››ã€Compose -\u0026gt; Kubernetes è¿ç§»å»ºè®® Compose Kubernetes service Deployment volume PVC network Service env ConfigMap secret Secret ğŸ“Œ Compose å†™å¾—å¥½ï¼Œè¿ç§»æˆæœ¬æä½ã€‚\nåäº”ã€ä¸€ä¸ªâ€œé«˜è´¨é‡ Compose æ¨¡æ¿â€ name: erp services: api: image: erp-api:${APP_VERSION} build: . ports: - \u0026#34;8000:8000\u0026#34; env_file: - .env depends_on: db: condition: service_healthy restart: unless-stopped mem_limit: 512m cpus: 1.0 db: image: postgres:16 volumes: - pgdata:/var/lib/postgresql/data environment: POSTGRES_PASSWORD: ${DB_PASSWORD} healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;pg_isready\u0026#34;] interval: 5s retries: 5 volumes: pgdata: åå…­ã€æ€»ç»“ Compose æ˜¯å•æœºçº§åº”ç”¨ç¼–æ’å·¥å…·\nService æ˜¯æ¨¡æ¿ï¼Œä¸æ˜¯å®ä¾‹\nCompose ç®¡ç†çš„æ˜¯â€œåº”ç”¨ç”Ÿå‘½å‘¨æœŸâ€\n","description":" ä¸€ã€æ€»ä½“è®¾è®¡åŸåˆ™ï¼ˆå…ˆè®°ä½è¿™ 6 æ¡ï¼‰ 1ï¸âƒ£ ä¸€ä¸ª Compose = ä¸€ä¸ªåº”ç”¨ ä¸è¦æŠŠæ— å…³æœåŠ¡å¡è¿›ä¸€ä¸ª compose ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€ï¼šèµ· -\u0026gt; ç”¨ -\u0026gt; åœ -\u0026gt; åˆ  âœ… æ­£ç¡®ï¼š\nerp/ â”œâ”€ api/ â”œâ”€ web/ â””â”€ docker-compose.yml âŒ é”™è¯¯ï¼š\n"},{"id":184,"href":"/operations/docker/docker-compose-core/","title":"Docker Compose æ ¸å¿ƒæ¦‚å¿µ","parent":"Docker","content":" ä¸€ã€Docker Compose æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯æœ¬è´¨ï¼‰ Docker Compose æ˜¯ä¸€ä¸ªâ€œå•æœºçº§â€çš„å¤šå®¹å™¨ç¼–æ’å·¥å…·ï¼Œç”¨å£°æ˜å¼ YAML æŠŠä¸€ç»„ç›¸å…³å®¹å™¨å½“æˆä¸€ä¸ªåº”ç”¨æ¥ç®¡ç†ã€‚\nå…³é”®è¯ï¼š\nå•æœºï¼ˆsingle-hostï¼‰ å¤šå®¹å™¨ï¼ˆmulti-containerï¼‰ å£°æ˜å¼ï¼ˆdeclarativeï¼‰ åº”ç”¨çº§ï¼ˆapplication-levelï¼‰ äºŒã€Compose è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼ˆWhyï¼‰ 1ï¸âƒ£ å¤šå®¹å™¨åä½œå¤æ‚ ä¸€ä¸ªçœŸå®åº”ç”¨é€šå¸¸åŒ…å«ï¼š\nWeb API DB Cache MQ å¦‚æœç”¨ docker runï¼š\né¡ºåºéš¾æ§åˆ¶ ç½‘ç»œéš¾é…ç½® å‚æ•°å†—é•¿ ä¸å¯å¤ç° Compose ç”¨ ä¸€ä¸ªæ–‡ä»¶ æè¿° æ•´ä¸ªåº”ç”¨æ‹“æ‰‘ã€‚\n2ï¸âƒ£ å¼€å‘ / æµ‹è¯•ç¯å¢ƒéš¾ä»¥å¤åˆ» Compose å¯ä»¥ï¼š\nä¸€é”®å¯åŠ¨æ•´ä¸ªç³»ç»Ÿ ç¯å¢ƒä¸€è‡´ æ–°äººä¸Šæ‰‹å¿« 3ï¸âƒ£ ç”Ÿå‘½å‘¨æœŸç®¡ç†æ··ä¹± Compose æŠŠå¤šä¸ªå®¹å™¨å½“æˆï¼š\nä¸€ä¸ªé€»è¾‘åº”ç”¨ï¼ˆprojectï¼‰\nä¸‰ã€Compose åœ¨ Docker ä½“ç³»ä¸­çš„ä½ç½®ï¼ˆWhereï¼‰ Docker Engine â† å®¹å™¨è¿è¡Œ Docker Compose â† åº”ç”¨ç¼–æ’ï¼ˆå•æœºï¼‰ Kubernetes â† é›†ç¾¤ç¼–æ’ï¼ˆå¤šæœºï¼‰ ğŸ“Œ Compose ä¸æ˜¯ Docker çš„æ›¿ä»£å“ ğŸ“Œ Compose ä¸åšè°ƒåº¦ã€ä¸åšé«˜å¯ç”¨ã€ä¸åšè‡ªæ„ˆ å››ã€Compose çš„æ ¸å¿ƒæŠ½è±¡æ¨¡å‹ï¼ˆWhatï¼‰ 1ï¸âƒ£ Projectï¼ˆé¡¹ç›®ï¼‰ Project = ä¸€ç»„ç›¸å…³è”çš„æœåŠ¡ï¼ˆservicesï¼‰\né»˜è®¤ project åï¼š\nå½“å‰ç›®å½•å\nä¹Ÿå¯ä»¥æŒ‡å®šï¼š\ndocker compose -p myapp up ğŸ“Œ Project æ˜¯ Compose çš„ æœ€å¤§ä½œç”¨åŸŸã€‚\n2ï¸âƒ£ Serviceï¼ˆæœåŠ¡ï¼‰ Service æ˜¯å®¹å™¨çš„é€»è¾‘æ¨¡æ¿ï¼Œä¸æ˜¯å®¹å™¨æœ¬èº«ã€‚\nä¸€ä¸ª service å¯ä»¥ï¼š\nåˆ›å»º 1 ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼ˆscaleï¼‰ å…±äº«ç½‘ç»œ å…±äº« volume ç¤ºä¾‹ï¼š\nservices: web: image: nginx 3ï¸âƒ£ Containerï¼ˆå®¹å™¨ï¼‰ ç”± service å®ä¾‹åŒ–è€Œæ¥\nå‘½åè§„åˆ™ï¼š\n\u0026lt;project\u0026gt;_\u0026lt;service\u0026gt;_\u0026lt;index\u0026gt; ä¾‹å¦‚ï¼š\nmyapp_web_1 4ï¸âƒ£ Networkï¼ˆç½‘ç»œï¼‰ Compose è‡ªåŠ¨åˆ›å»ºç½‘ç»œï¼š\n\u0026lt;project\u0026gt;_default ç‰¹ç‚¹ï¼š\nåŸºäº bridge DNS è‡ªåŠ¨è§£æ service å å®¹å™¨é—´å¯ç›´è¿ ğŸ“Œ service å = DNS å\n5ï¸âƒ£ Volumeï¼ˆæ•°æ®å·ï¼‰ Compose å®šä¹‰ volumeï¼š\næŒä¹…åŒ–æ•°æ® è·¨å®¹å™¨å…±äº« äº”ã€Compose æ–‡ä»¶çš„æœ¬è´¨ï¼ˆYAML æ˜¯ä»€ä¹ˆï¼‰ docker-compose.yml æ˜¯ä¸€ä¸ªâ€œåº”ç”¨å£°æ˜â€ï¼Œä¸æ˜¯æ‰§è¡Œè„šæœ¬ã€‚\næè¿°â€œæˆ‘æƒ³è¦ä»€ä¹ˆçŠ¶æ€â€ Compose ä¼šæŠŠå½“å‰çŠ¶æ€ -\u0026gt; ç›®æ ‡çŠ¶æ€ ğŸ“Œ ä¸ Kubernetes æ€æƒ³é«˜åº¦ä¸€è‡´ã€‚\nå…­ã€Compose çš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼ˆHowï¼‰ å¯åŠ¨æµç¨‹\ndocker compose up â†“ è§£æ docker-compose.yml â†“ åˆ›å»º project â†“ åˆ›å»º network â†“ åˆ›å»º volume â†“ åˆ›å»ºå¹¶å¯åŠ¨ containers åœæ­¢æµç¨‹\ndocker compose down â†“ åœæ­¢å®¹å™¨ â†“ åˆ é™¤å®¹å™¨ â†“ åˆ é™¤ç½‘ç»œ â†“ ï¼ˆé»˜è®¤ä¸åˆ  volumeï¼‰ ä¸ƒã€Compose ç½‘ç»œåŸç†ï¼ˆé‡ç‚¹ï¼‰ é»˜è®¤ç½‘ç»œæ¨¡å‹\nweb ----+ api ----+----\u0026gt; bridge network (project_default) db ----+ æ¯ä¸ª service è‡ªåŠ¨åŠ å…¥åŒä¸€ä¸ª network å®¹å™¨é€šè¿‡ service åé€šä¿¡ ç¤ºä¾‹ï¼š\napi è¿æ¥ dbï¼š host = db port = 5432 ğŸ“Œ ä¸éœ€è¦æš´éœ²ç«¯å£ç»™å®¿ä¸»æœºã€‚\nç«¯å£æ˜ å°„ vs æœåŠ¡é€šä¿¡ åœºæ™¯ æ˜¯å¦éœ€è¦ ports å®¹å™¨ä¹‹é—´ âŒ å®¿ä¸»æœºè®¿é—® âœ… å…«ã€Compose å­˜å‚¨åŸç† Volume ç±»å‹\n1ï¸âƒ£ named volumeï¼ˆæ¨èï¼‰ volumes: db_data: 2ï¸âƒ£ bind mount ./data:/var/lib/mysql ğŸ“Œ æ•°æ®ä¸åº”æ”¾åœ¨å®¹å™¨å±‚ã€‚\nä¹ã€depends_on çš„çœŸå®å«ä¹‰ï¼ˆé«˜é¢‘å‘ï¼‰ depends_on: - db åªä¿è¯å¯åŠ¨é¡ºåºï¼Œä¸ä¿è¯æœåŠ¡å¯ç”¨ï¼\nçœŸæ­£å¯ç”¨ï¼š\nhealthcheck + depends_on.condition åº”ç”¨å±‚é‡è¯• åã€Compose çš„èƒ½åŠ›è¾¹ç•Œï¼ˆé‡è¦ï¼‰ Compose ä¸æ“…é•¿çš„äº‹ï¼š\né«˜å¯ç”¨ è‡ªåŠ¨æ‰©ç¼©å®¹ èŠ‚ç‚¹æ•…éšœæ¢å¤ è·¨å®¿ä¸»æœºè°ƒåº¦ æ»šåŠ¨å‡çº§ ğŸ‘‰ è¿™äº›æ˜¯ Kubernetes çš„èŒè´£ã€‚\nåä¸€ã€Compose vs Kubernetes å¯¹æ¯” Compose Kubernetes è¿è¡ŒèŒƒå›´ å•æœº é›†ç¾¤ è°ƒåº¦ æ—  æœ‰ è‡ªæ„ˆ æ—  æœ‰ å­¦ä¹ æˆæœ¬ ä½ é«˜ åœºæ™¯ å¼€å‘/æµ‹è¯• ç”Ÿäº§ åäºŒã€Compose çš„æœ€ä½³ä½¿ç”¨åœºæ™¯ âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒ âœ… é›†æˆæµ‹è¯• âœ… Demo / POC âœ… CI æ„å»ºé˜¶æ®µ âŒ æ ¸å¿ƒç”Ÿäº§ç¯å¢ƒ åä¸‰ã€Compose v1 vs v2ï¼ˆåŸºç¡€è®¤çŸ¥ï¼‰ v1ï¼šdocker-composeï¼ˆPython å®ç°ï¼Œå·²åºŸå¼ƒï¼‰ v2ï¼šdocker composeï¼ˆGo å®ç°ï¼ŒCLI æ’ä»¶ï¼‰ ğŸ“Œ æ¨è åªä½¿ç”¨ v2ã€‚\nåå››ã€æœ¬è´¨é—®é¢˜ Qï¼šCompose æ˜¯ä¸æ˜¯å®¹å™¨ç¼–æ’ï¼Ÿ âœ… æ˜¯\nâŒ ä½†ä»…é™å•æœº\nQï¼šCompose ç½‘ç»œå¦‚ä½•é€šä¿¡ï¼Ÿ âœ… å†…ç½® bridge + DNS\nQï¼šCompose èƒ½æ›¿ä»£ Kubernetes å—ï¼Ÿ âŒ ä¸èƒ½\nåäº”ã€ä¸‰å¥è¯æ€»ç»“ Compose æ˜¯å•æœºçº§åº”ç”¨ç¼–æ’å·¥å…·\nService æ˜¯å®¹å™¨çš„é€»è¾‘æ¨¡æ¿\nCompose ç®¡ç†çš„æ˜¯â€œåº”ç”¨â€ï¼Œä¸æ˜¯å•ä¸ªå®¹å™¨\n","description":" ä¸€ã€Docker Compose æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯æœ¬è´¨ï¼‰ Docker Compose æ˜¯ä¸€ä¸ªâ€œå•æœºçº§â€çš„å¤šå®¹å™¨ç¼–æ’å·¥å…·ï¼Œç”¨å£°æ˜å¼ YAML æŠŠä¸€ç»„ç›¸å…³å®¹å™¨å½“æˆä¸€ä¸ªåº”ç”¨æ¥ç®¡ç†ã€‚\nå…³é”®è¯ï¼š\nå•æœºï¼ˆsingle-hostï¼‰ å¤šå®¹å™¨ï¼ˆmulti-containerï¼‰ å£°æ˜å¼ï¼ˆdeclarativeï¼‰ åº”ç”¨çº§ï¼ˆapplication-levelï¼‰ äºŒã€Compose è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼ˆWhyï¼‰ 1ï¸âƒ£ å¤šå®¹å™¨åä½œå¤æ‚ ä¸€ä¸ªçœŸå®åº”ç”¨é€šå¸¸åŒ…å«ï¼š\n"},{"id":185,"href":"/operations/docker/docker-vs-podman/","title":"Docker vs Podman","parent":"Docker","content":" ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆ2025 å¹´è§†è§’ï¼‰ å¼€å‘ / CI / ç”Ÿæ€ä¼˜å…ˆï¼šDocker\næœåŠ¡å™¨ / å®‰å…¨ / RHEL ç³»ï¼šPodman\nğŸ‘‰ æ²¡æœ‰â€œç»å¯¹æ›¿ä»£â€ï¼Œåªæœ‰â€œåœºæ™¯æ›´åˆé€‚â€\näºŒã€æ ¸å¿ƒåŒºåˆ«ä¸€å¥è¯ç‰ˆï¼ˆå…ˆèƒŒï¼‰ Docker æ˜¯â€œæœ‰å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„é›†ä¸­å¼æ¶æ„â€\nPodman æ˜¯â€œæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonlessï¼‰çš„è¿›ç¨‹ç›´å¯æ¶æ„â€\nè¿™æ˜¯æ‰€æœ‰å·®å¼‚çš„æ ¹æºã€‚\nä¸‰ã€æ¶æ„å±‚é¢çš„æ ¹æœ¬å·®å¼‚ï¼ˆWhyï¼‰ 1ï¸âƒ£ Docker æ¶æ„ CLI -\u0026gt; dockerd -\u0026gt; containerd -\u0026gt; runc -\u0026gt; kernel ç‰¹ç‚¹ï¼š\nä¸­å¤®å®ˆæŠ¤è¿›ç¨‹ dockerd æ‰€æœ‰å®¹å™¨ç”± daemon ç®¡ç† socket é€šä¿¡ ä¼˜ç‚¹ï¼š\nâœ… æˆç†Ÿ âœ… ç”Ÿæ€å®Œæ•´ âœ… è¡Œä¸ºç»Ÿä¸€ ç¼ºç‚¹ï¼š\nâŒ daemon å•ç‚¹ âŒ å®‰å…¨è¾¹ç•Œè¾ƒå¤§ 2ï¸âƒ£ Podman æ¶æ„ CLI -\u0026gt; conmon -\u0026gt; runc -\u0026gt; kernel ç‰¹ç‚¹ï¼š\næ—  daemon æ¯ä¸ªå®¹å™¨ = æ™®é€šå­è¿›ç¨‹ æ”¯æŒ rootless åŸç”Ÿ ä¼˜ç‚¹ï¼š\nâœ… å®‰å…¨ âœ… ç®€å• âœ… systemd å‹å¥½ ç¼ºç‚¹ï¼š\nâŒ ç”Ÿæ€è¾ƒå° âŒ éƒ¨åˆ†åŠŸèƒ½å®ç°è¾ƒæ™š å››ã€æ ¸å¿ƒèƒ½åŠ›å¯¹æ¯”ï¼ˆé‡ç‚¹ï¼‰ å¯¹æ¯”é¡¹ Docker Podman Daemon æœ‰ æ—  Rootless ååŠ  åŸç”Ÿ CLI å…¼å®¹ æ ‡å‡† 99% å…¼å®¹ Compose docker compose podman-compose Swarm æœ‰ âŒ systemd é›†æˆ ä¸€èˆ¬ æå¼º é•œåƒæ ¼å¼ OCI OCI Kubernetes ä¸»æµ åŸç”Ÿå¯¼å‡º äº”ã€å®‰å…¨æ¨¡å‹å·®å¼‚ï¼ˆé‡è¦ï¼‰ Docker\né»˜è®¤ root daemon å®¹å™¨é€ƒé€¸é£é™©é›†ä¸­ Rootless Docker å¯ç”¨ï¼Œä½†å¤æ‚ Podman\né»˜è®¤ rootless ä¸éœ€è¦ daemon å®¹å™¨ = ç”¨æˆ·è¿›ç¨‹ ğŸ“Œ åœ¨å®‰å…¨å®¡è®¡ / åˆè§„ç¯å¢ƒä¸­ï¼ŒPodman æ˜æ˜¾æ›´å—æ¬¢è¿\nå…­ã€æ€§èƒ½å·®è·ï¼ˆå®é™…æƒ…å†µï¼‰ Docker vs Podmanï¼šæ€§èƒ½å‡ ä¹æ²¡æœ‰å·®è·\nåŸå› ï¼š\néƒ½ç”¨ runc éƒ½å…±äº«å®¿ä¸»æœºå†…æ ¸ éƒ½èµ° cgroups / namespace ğŸ“Œ IO / CPU / å†…å­˜ï¼šå·®è· \u0026lt; 2%\nä¸ƒã€ç”Ÿæ€ä¸å·¥å…·é“¾ï¼ˆç°å®å·®å¼‚ï¼‰ Docker çš„ä¼˜åŠ¿\nDocker Hub å®˜æ–¹é•œåƒè´¨é‡é«˜ CI/CD é»˜è®¤æ”¯æŒ æ•™ç¨‹ã€æ–‡æ¡£ã€ç¤¾åŒºæœ€å¤§ Compose ä½“éªŒæœ€å¥½ Podman çš„ä¼˜åŠ¿\nRHEL / Rocky / AlmaLinux å®˜æ–¹ systemd æ·±åº¦æ•´åˆ Kubernetes å‹å¥½ æ—  daemon è¿ç»´æ›´ç®€å• å…«ã€Compose ä½“éªŒå¯¹æ¯”ï¼ˆçœŸå®ï¼‰ Docker\ndocker compose up å®˜æ–¹ ç¨³å®š æ–‡æ¡£å®Œå–„ Podman\npodman-compose up Python å®ç° åŠŸèƒ½ç•¥æ»å å¤æ‚ Compose å…¼å®¹æ€§ä¸€èˆ¬ ğŸ“Œ è¿™æ˜¯ Podman å½“å‰æœ€å¤§çŸ­æ¿ä¹‹ä¸€\nä¹ã€è¿ç»´è§†è§’ï¼ˆéå¸¸å…³é”®ï¼‰ Docker è¿ç»´é£é™©\ndockerd æŒ‚ -\u0026gt; æ‰€æœ‰å®¹å™¨å¼‚å¸¸ socket æš´éœ² -\u0026gt; é«˜é£é™© Podman è¿ç»´ä½“éªŒ\nsystemd ç®¡ç†æ¯ä¸ªå®¹å™¨ å®¹å™¨å³æœåŠ¡ å®ˆæŠ¤è¿›ç¨‹æ— å•ç‚¹ åã€çœŸå®é€‰å‹å»ºè®®ï¼ˆç›´æ¥å¯ç”¨ï¼‰ âœ… æ¨è Docker çš„åœºæ™¯\næœ¬åœ°å¼€å‘ CI / CD å¾®æœåŠ¡å¼€å‘ Compose é‡åº¦ç”¨æˆ· æ–°æ‰‹ / å›¢é˜Ÿåä½œ âœ… æ¨è Podman çš„åœºæ™¯\nRHEL / AlmaLinux / Rocky å®‰å…¨æ•æ„Ÿç¯å¢ƒ å•æœºç”Ÿäº§æœåŠ¡ systemd-first æ¶æ„ ä¸éœ€è¦ Swarm / Compose é‡åº¦èƒ½åŠ› åä¸€ã€Kubernetes è§†è§’è¡¥å……ï¼ˆåŠ åˆ†ï¼‰ ğŸ“Œ Kubernetes ä¸å…³å¿ƒ Docker / Podman\nåªå…³å¿ƒï¼š OCI containerd / CRI-O ğŸ‘‰ æ‰€ä»¥ï¼š\nDocker ä¸æ˜¯ K8S è¿è¡Œæ—¶ Podman ä¹Ÿä¸æ˜¯ éƒ½åªæ˜¯ æ„å»º \u0026amp; æœ¬åœ°è¿è¡Œå·¥å…· åäºŒã€æ€»ç»“ å¼€å‘ + CIï¼šDocker\nç”Ÿäº§ + å®‰å…¨ï¼šPodman\nå¦‚æœåªèƒ½é€‰ä¸€ä¸ªï¼šDockerï¼ˆç”Ÿæ€ä¼˜åŠ¿ä»ç„¶å‹å€’æ€§ï¼‰\nDocker å’Œ Podman æœ€å¤§åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰å®ˆæŠ¤è¿›ç¨‹ã€‚\nDocker æ˜¯é›†ä¸­å¼ daemon æ¶æ„ï¼Œç”Ÿæ€æˆç†Ÿ Podman æ˜¯æ—  daemon æ¶æ„ï¼Œå®‰å…¨æ€§å’Œ systemd é›†æˆæ›´å¥½ æ€§èƒ½å‡ ä¹æ— å·®è·ï¼Œé€‰å‹å–å†³äºåœºæ™¯ã€‚\nDocker èµ¢åœ¨ç”Ÿæ€\nPodman èµ¢åœ¨å®‰å…¨\nKubernetes æ—©å·²ä¸ä¾èµ–äºŒè€…\n","description":" ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆ2025 å¹´è§†è§’ï¼‰ å¼€å‘ / CI / ç”Ÿæ€ä¼˜å…ˆï¼šDocker\næœåŠ¡å™¨ / å®‰å…¨ / RHEL ç³»ï¼šPodman\nğŸ‘‰ æ²¡æœ‰â€œç»å¯¹æ›¿ä»£â€ï¼Œåªæœ‰â€œåœºæ™¯æ›´åˆé€‚â€\näºŒã€æ ¸å¿ƒåŒºåˆ«ä¸€å¥è¯ç‰ˆï¼ˆå…ˆèƒŒï¼‰ Docker æ˜¯â€œæœ‰å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„é›†ä¸­å¼æ¶æ„â€\nPodman æ˜¯â€œæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonlessï¼‰çš„è¿›ç¨‹ç›´å¯æ¶æ„â€\nè¿™æ˜¯æ‰€æœ‰å·®å¼‚çš„æ ¹æºã€‚\nä¸‰ã€æ¶æ„å±‚é¢çš„æ ¹æœ¬å·®å¼‚ï¼ˆWhyï¼‰ 1ï¸âƒ£ Docker æ¶æ„ CLI -\u0026gt; dockerd -\u0026gt; containerd -\u0026gt; runc -\u0026gt; kernel ç‰¹ç‚¹ï¼š\n"},{"id":186,"href":"/operations/linux/docker-kernel/","title":"Docker ä½¿ç”¨çš„æ˜¯å“ªä¸ªå†…æ ¸","parent":"Linux","content":" âœ… ç»“è®º Docker å®¹å™¨ä½¿ç”¨çš„æ˜¯ã€Œå®¿ä¸»æœºçš„ Linux å†…æ ¸ã€\nå®¹å™¨é‡Œæ²¡æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œä¹Ÿä¸å­˜åœ¨â€œå…¶å®ƒå†…æ ¸â€ã€‚\nä¸€ã€å…ˆç»™å‡ºæ˜ç¡®ç­”æ¡ˆï¼ˆé¿å…æ··æ·†ï¼‰ é€‰é¡¹ æ˜¯å¦æ­£ç¡® è¯´æ˜ å®¹å™¨è‡ªå·±çš„å†…æ ¸ âŒ å®¹å™¨é‡Œæ ¹æœ¬æ²¡æœ‰å†…æ ¸ å®¿ä¸»æœºçš„å†…æ ¸ âœ… å”¯ä¸€æ­£ç¡®ç­”æ¡ˆ å…¶å®ƒç‹¬ç«‹å†…æ ¸ âŒ è¿™æ˜¯è™šæ‹Ÿæœºçš„åšæ³• ğŸ‘‰ Docker å®¹å™¨ = å®¿ä¸»æœºå†…æ ¸ä¸Šçš„ä¸€ä¸ªæ™®é€šè¿›ç¨‹ï¼ˆè¢«éš”ç¦»ï¼‰\näºŒã€ä¸ºä»€ä¹ˆå®¹å™¨â€œçœ‹èµ·æ¥â€åƒæœ‰è‡ªå·±çš„ç³»ç»Ÿï¼Ÿ è¿™æ˜¯å¾ˆå¤šäººè¯¯è§£çš„æ ¹æºã€‚\nåœ¨å®¹å™¨ä¸­æ‰§è¡Œï¼š\nuname -a ä½ ä¼šçœ‹åˆ°ï¼š\nLinux xxx 5.15.0-xxx ä½ å¯èƒ½ä¼šä»¥ä¸ºï¼š\nâ€œè¿™æ˜¯å®¹å™¨è‡ªå·±çš„å†…æ ¸ï¼Ÿâ€ âŒ é”™ã€‚\nçœŸç›¸æ˜¯ï¼š\nuname è¿”å›çš„æ˜¯ å®¿ä¸»æœºå†…æ ¸ä¿¡æ¯ å®¹å™¨åªæ˜¯ è¢« Namespace éš”ç¦»åçš„è¿›ç¨‹è§†è§’ ä¸‰ã€Docker æ˜¯å¦‚ä½•â€œå…±äº«å†…æ ¸åˆäº’ä¸å¹²æ‰°â€çš„ï¼Ÿ é çš„æ˜¯ Linux å†…æ ¸çš„ä¸‰å¤§èƒ½åŠ›ï¼š\n1ï¸âƒ£ Namespaceï¼ˆè®©è¿›ç¨‹â€œä»¥ä¸ºè‡ªå·±ç‹¬å ç³»ç»Ÿâ€ï¼‰ Namespace è®©å®¹å™¨ä¸­çš„è¿›ç¨‹ï¼š\nçœ‹ä¸åˆ°å®¿ä¸»æœºå…¶ä»–è¿›ç¨‹ï¼ˆPID Namespaceï¼‰ æœ‰è‡ªå·±çš„ç½‘ç»œæ ˆï¼ˆNET Namespaceï¼‰ æœ‰è‡ªå·±çš„æŒ‚è½½ç‚¹ï¼ˆMNT Namespaceï¼‰ æœ‰è‡ªå·±çš„ hostnameï¼ˆUTS Namespaceï¼‰ ğŸ“Œ ä½†å†…æ ¸ä»ç„¶æ˜¯åŒä¸€ä¸ª\n2ï¸âƒ£ cgroupsï¼ˆé™åˆ¶èµ„æºï¼Œè€Œä¸æ˜¯è™šæ‹Ÿï¼‰ cgroups æ§åˆ¶çš„æ˜¯ï¼š\nCPU å†…å­˜ IO PID æ•°é‡ ğŸ“Œ é™åˆ¶çš„æ˜¯â€œèƒ½ç”¨å¤šå°‘å†…æ ¸èµ„æºâ€ï¼Œä¸æ˜¯â€œç”¨å“ªä¸ªå†…æ ¸â€\n3ï¸âƒ£ Syscall ç›´æ¥è¿›å…¥å®¿ä¸»æœºå†…æ ¸ å®¹å™¨å†…è¿›ç¨‹è°ƒç”¨ï¼š\nopen() read() write() fork() ğŸ‘‰ ç›´æ¥è¿›å…¥å®¿ä¸»æœºå†…æ ¸æ‰§è¡Œ\næ²¡æœ‰ä¸­é—´è™šæ‹Ÿå±‚ã€‚\nå››ã€ä¸€ä¸ªå…³é”®å¯¹æ¯” Docker vs è™šæ‹Ÿæœºï¼ˆå†…æ ¸å±‚é¢å¯¹æ¯”ï¼‰\nå¯¹æ¯”é¡¹ Docker å®¹å™¨ è™šæ‹Ÿæœº å†…æ ¸ å®¿ä¸»æœºå…±äº« æ¯ä¸ª VM ç‹¬ç«‹ ç³»ç»Ÿè°ƒç”¨ ç›´æ¥è¿›å…¥å®¿ä¸»æœºå†…æ ¸ è¿›å…¥ VM å†…æ ¸ å¯åŠ¨é€Ÿåº¦ ç§’çº§ åˆ†é’Ÿçº§ èµ„æºæ¶ˆè€— æä½ é«˜ ğŸ“Œ æ˜¯å¦æœ‰â€œè‡ªå·±çš„å†…æ ¸â€æ˜¯ Docker ä¸ VM çš„æœ¬è´¨åˆ†ç•Œçº¿\näº”ã€é‚£ Windows / macOS ä¸Šçš„ Docker å‘¢ï¼Ÿï¼ˆé«˜é˜¶è¡¥å……ï¼‰ åœ¨ macOS / Windows ä¸Šï¼š\nå®¹å™¨ -\u0026gt; Linux VM -\u0026gt; Linux å†…æ ¸ -\u0026gt; å®¿ä¸»æœº\nDocker Desktop ä¼šå¯åŠ¨ä¸€ä¸ª è½»é‡ Linux è™šæ‹Ÿæœº æ‰€æœ‰å®¹å™¨ å…±äº«è¿™ä¸ª Linux VM çš„å†…æ ¸ âŒ ä»ç„¶ä¸æ˜¯â€œå®¹å™¨è‡ªå·±çš„å†…æ ¸â€ ğŸ“Œ æ‰€ä»¥åœ¨ macOS ä¸Šè¿è¡Œ Linux å®¹å™¨ï¼Œæœ¬è´¨æ˜¯ï¼š\nå®¹å™¨ -\u0026gt; VM å†…æ ¸ï¼ˆå…±äº«ï¼‰ å…­ã€æ€»ç»“ å®¹å™¨æ²¡æœ‰å†…æ ¸ï¼Œæ‰€æœ‰å®¹å™¨å…±äº«å®¿ä¸»æœºå†…æ ¸ï¼ŒDocker æ˜¯è¿›ç¨‹éš”ç¦»ï¼Œä¸æ˜¯ç¡¬ä»¶è™šæ‹ŸåŒ–ã€‚\nDocker å®¹å™¨æ²¡æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œå®ƒä»¬å…±äº«å®¿ä¸»æœºçš„ Linux å†…æ ¸ã€‚\nDocker é€šè¿‡ Namespace æä¾›éš”ç¦»ï¼Œé€šè¿‡ cgroups åšèµ„æºé™åˆ¶ï¼Œæœ¬è´¨ä¸Šå®¹å™¨åªæ˜¯å®¿ä¸»æœºä¸Šçš„æ™®é€šè¿›ç¨‹ã€‚\nè¿™ä¹Ÿæ˜¯ Docker å¯åŠ¨å¿«ã€èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œä½†å†…æ ¸çº§éš”ç¦»ä¸å¦‚è™šæ‹Ÿæœºçš„æ ¹æœ¬åŸå› ã€‚\nä¸ƒã€æ‰©å±• Q1ï¼šé‚£å®¹å™¨èƒ½ç”¨ä¸åŒç‰ˆæœ¬çš„å†…æ ¸å—ï¼Ÿ âŒ ä¸èƒ½\nâœ… å¿…é¡»å’Œå®¿ä¸»æœºä¸€è‡´\nQ2ï¼šä¸ºä»€ä¹ˆ alpine / ubuntu å®¹å™¨éƒ½èƒ½è·‘ï¼Ÿ é‚£åªæ˜¯ ç”¨æˆ·æ€ï¼ˆglibc / musl / shellï¼‰ ä¸å†…æ ¸æ— å…³ Q3ï¼šå®¹å™¨èƒ½è·‘ Windows ç¨‹åºå—ï¼Ÿ Linux å®¹å™¨ âŒ Windows å®¹å™¨ âœ…ï¼ˆä½†ä¾èµ– Windows å†…æ ¸ï¼‰ ","description":" âœ… ç»“è®º Docker å®¹å™¨ä½¿ç”¨çš„æ˜¯ã€Œå®¿ä¸»æœºçš„ Linux å†…æ ¸ã€\nå®¹å™¨é‡Œæ²¡æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œä¹Ÿä¸å­˜åœ¨â€œå…¶å®ƒå†…æ ¸â€ã€‚\nä¸€ã€å…ˆç»™å‡ºæ˜ç¡®ç­”æ¡ˆï¼ˆé¿å…æ··æ·†ï¼‰ é€‰é¡¹ æ˜¯å¦æ­£ç¡® è¯´æ˜ å®¹å™¨è‡ªå·±çš„å†…æ ¸ âŒ å®¹å™¨é‡Œæ ¹æœ¬æ²¡æœ‰å†…æ ¸ å®¿ä¸»æœºçš„å†…æ ¸ âœ… å”¯ä¸€æ­£ç¡®ç­”æ¡ˆ å…¶å®ƒç‹¬ç«‹å†…æ ¸ âŒ è¿™æ˜¯è™šæ‹Ÿæœºçš„åšæ³• ğŸ‘‰ Docker å®¹å™¨ = å®¿ä¸»æœºå†…æ ¸ä¸Šçš„ä¸€ä¸ªæ™®é€šè¿›ç¨‹ï¼ˆè¢«éš”ç¦»ï¼‰\näºŒã€ä¸ºä»€ä¹ˆå®¹å™¨â€œçœ‹èµ·æ¥â€åƒæœ‰è‡ªå·±çš„ç³»ç»Ÿï¼Ÿ è¿™æ˜¯å¾ˆå¤šäººè¯¯è§£çš„æ ¹æºã€‚\n"},{"id":187,"href":"/operations/docker/network/","title":"Docker ç½‘ç»œåŸç†","parent":"Docker","content":"ä¸‹é¢è¿™ä»½æ˜¯ä» Linux ç½‘ç»œåº•å±‚ -\u0026gt; Docker ç½‘ç»œæ¨¡å‹ -\u0026gt; æ•°æ®åŒ…è·¯å¾„ -\u0026gt; è®¿é—®åœºæ™¯ -\u0026gt; å¸¸è§å‘çš„ ã€ŠDocker ç½‘ç»œåŸç†å…¨æ™¯è§£æã€‹ã€‚\nä¸æ˜¯â€œæ€ä¹ˆç”¨â€ï¼Œè€Œæ˜¯ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€æ•°æ®åŒ…æ€ä¹ˆèµ°ã€‚\nä¸€ã€ä¸€å¥è¯æ€»è§ˆï¼ˆå…ˆèƒŒï¼‰ Docker ç½‘ç»œæœ¬è´¨æ˜¯ï¼šLinux Network Namespace + veth + bridge + iptables NAT\näºŒã€Docker ç½‘ç»œçš„å››ä¸ªæ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ Network Namespaceï¼ˆç½‘ç»œéš”ç¦»ï¼‰ æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹ç½‘ç»œæ ˆ\nåŒ…æ‹¬ï¼š\nç½‘å¡ IP è·¯ç”±è¡¨ é˜²ç«å¢™è§„åˆ™ ğŸ“Œ å®¹å™¨ â‰  è¿›ç¨‹å…±äº«ç½‘ç»œï¼ˆé™¤é hostï¼‰\n2ï¸âƒ£ veth pairï¼ˆè™šæ‹Ÿç½‘çº¿ï¼‰ container eth0 \u0026lt;====\u0026gt; vethxxxx (host) æˆå¯¹å‡ºç° ä¸€ç«¯è¿›å®¹å™¨ï¼Œä¸€ç«¯åœ¨å®¿ä¸»æœº ğŸ“Œ veth å°±æ˜¯â€œç½‘çº¿â€\n3ï¸âƒ£ Linux bridgeï¼ˆdocker0ï¼‰ container â”‚ veth â”‚ docker0 (bridge) â”‚ å®¿ä¸»æœºç½‘å¡ docker0 æ˜¯äºŒå±‚äº¤æ¢æœº å®¹å™¨ IP åœ¨åŒä¸€å­ç½‘ 4ï¸âƒ£ iptables / NATï¼ˆåœ°å€è½¬æ¢ï¼‰ SNATï¼šå®¹å™¨è®¿é—®å¤–ç½‘ DNATï¼šå¤–éƒ¨è®¿é—®å®¹å™¨ ğŸ“Œ è¿™æ˜¯è®¿é—®æ§åˆ¶çš„æ ¸å¿ƒ\nä¸‰ã€Docker é»˜è®¤ç½‘ç»œï¼šbridge ç»“æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰ [container] --veth--\u0026gt; [docker0] --NAT--\u0026gt; [eth0] --\u0026gt; Internet å®¹å™¨ IP ä¸¾ä¾‹ docker inspect container | grep IPAddress 172.17.0.2 å››ã€å¤–éƒ¨ -\u0026gt; å®¹å™¨ï¼ˆç«¯å£æ˜ å°„åŸç†ï¼‰ 1ï¸âƒ£ å‘½ä»¤ docker run -p 8080:80 nginx 2ï¸âƒ£ æ•°æ®åŒ…è·¯å¾„ Client â†“ å®¿ä¸»æœº 8080 â†“ (DNAT) å®¹å™¨ 80 iptables è§„åˆ™æœ¬è´¨æ˜¯ï¼š\nPREROUTING: 8080 -\u0026gt; 172.17.0.2:80 ğŸ“Œ å®¹å™¨æ— éœ€æ„ŸçŸ¥å¤–éƒ¨ç«¯å£\n3ï¸âƒ£ æ²¡æœ‰ -p ä¼šæ€æ ·ï¼Ÿ å¤–éƒ¨æ— æ³•è®¿é—® å®¹å™¨åªåœ¨å†…éƒ¨ç½‘ç»œå¯è§ äº”ã€å®¹å™¨ -\u0026gt; å¤–éƒ¨ï¼ˆSNATï¼‰ ç¤ºä¾‹ curl www.baidu.com æ•°æ®åŒ…è·¯å¾„ container 172.17.0.2 â†“ docker0 â†“ (SNAT) å®¿ä¸»æœº IP â†“ Internet iptables åšäº†ï¼š\nPOSTROUTING: 172.17.0.0/16 -\u0026gt; å®¿ä¸»æœº IP ğŸ“Œ æ‰€ä»¥å¤–éƒ¨åªçœ‹åˆ°å®¿ä¸»æœº IP\nå…­ã€å®¹å™¨ â†” å®¹å™¨é€šä¿¡ åŒä¸€ bridge ç½‘ç»œ services: api: db: è®¿é—®æ–¹å¼ï¼š\napi -\u0026gt; db:5432 ğŸ“Œ Docker å†…ç½® DNS ğŸ“Œ ä¸è¦ç”¨ IP ä¸åŒç½‘ç»œ é»˜è®¤ä¸é€š å¯æ‰‹åŠ¨ connect docker network connect net1 container ä¸ƒã€Docker ç½‘ç»œç±»å‹å…¨è§£ 1ï¸âƒ£ bridgeï¼ˆé»˜è®¤ï¼‰ NAT\næœ‰ IP\næœ€å¸¸ç”¨\nâœ… å¼€å‘ / æµ‹è¯•\nâŒ é«˜æ€§èƒ½æ•°æ®åº“ï¼ˆæ…ç”¨ï¼‰\n2ï¸âƒ£ hostï¼ˆæ€§èƒ½æœ€å¼ºï¼‰ network_mode: host ç‰¹ç‚¹ï¼š\næ— éš”ç¦» æ—  NAT æ— ç«¯å£æ˜ å°„ ğŸ“Œ å®¹å™¨ç«¯å£ = å®¿ä¸»æœºç«¯å£\nâœ… é«˜æ€§èƒ½æœåŠ¡ âŒ ç«¯å£å†²çª 3ï¸âƒ£ noneï¼ˆå®Œå…¨éš”ç¦»ï¼‰ æ— ç½‘å¡\næ— ç½‘ç»œ\nâœ… å®‰å…¨æµ‹è¯•\nâœ… ç¦»çº¿ä»»åŠ¡\n4ï¸âƒ£ overlayï¼ˆå¤šä¸»æœºï¼‰ VXLAN\nSwarm / K8S\nâŒ æ€§èƒ½ä¸‹é™\nâœ… è·¨ä¸»æœºé€šä¿¡\nå…«ã€DNS è§£æåŸç†ï¼ˆå¸¸è€ƒï¼‰ Docker å†…ç½® DNS 127.0.0.11 service name -\u0026gt; å®¹å™¨ IP åŒç½‘ç»œå¯è§ ğŸ“Œ DNS ä¸æ˜¯ /etc/hosts\nä¹ã€ç‰¹æ®Šè®¿é—®åœºæ™¯ï¼ˆé«˜é¢‘ï¼‰ 1ï¸âƒ£ å®¹å™¨è®¿é—®å®¿ä¸»æœº Linuxï¼ˆæ¨èï¼‰ --add-host=host.docker.internal:host-gateway container -\u0026gt; host.docker.internal 2ï¸âƒ£ å®¿ä¸»æœºè®¿é—®å®¹å™¨ ä½¿ç”¨ç«¯å£æ˜ å°„ æˆ–ç›´æ¥è®¿é—®å®¹å™¨ IPï¼ˆä»…æœ¬æœºï¼‰ 3ï¸âƒ£ å®¹å™¨è®¿é—®å±€åŸŸç½‘ NAT è½¬å‘ è·¯ç”±å…è®¸å³å¯ åã€iptables è¡¨ä¸é“¾ï¼ˆè¿›é˜¶ï¼‰ è¡¨ ç”¨é€” nat DNAT / SNAT filter é˜²ç«å¢™ mangle æ”¹åŒ… raw è¿æ¥è¿½è¸ª Docker ä¸»è¦ä½¿ç”¨ï¼š\nnat filter åä¸€ã€å¸¸è§ç½‘ç»œå‘ï¼ˆçœŸå®ï¼‰ âŒ å¿˜è®° -p âŒ æœåŠ¡åªç›‘å¬ 127.0.0.1 âŒ ç”¨ IP é€šä¿¡ âŒ overlay æ€§èƒ½æœŸæœ›è¿‡é«˜ âŒ å®¹å™¨ DNS è¢«è¦†ç›– åäºŒã€æ€»ç»“ Docker ç½‘ç»œåŸºäº Linux Namespace éš”ç¦»ï¼Œæ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹ç½‘ç»œæ ˆï¼Œé€šè¿‡ veth è¿æ¥åˆ°å®¿ä¸»æœºçš„ bridgeã€‚å¤–éƒ¨è®¿é—®é€šè¿‡ DNAT ç«¯å£æ˜ å°„ï¼Œå®¹å™¨è®¿é—®å¤–éƒ¨é€šè¿‡ SNATã€‚å®¹å™¨é—´é€šä¿¡ä¾èµ–å†…ç½® DNSã€‚\nveth æ˜¯ç½‘çº¿\nbridge æ˜¯äº¤æ¢æœº\niptables æ˜¯è·¯ç”±å™¨ + é˜²ç«å¢™\n","description":"ä¸‹é¢è¿™ä»½æ˜¯ä» Linux ç½‘ç»œåº•å±‚ -\u0026gt; Docker ç½‘ç»œæ¨¡å‹ -\u0026gt; æ•°æ®åŒ…è·¯å¾„ -\u0026gt; è®¿é—®åœºæ™¯ -\u0026gt; å¸¸è§å‘çš„ ã€ŠDocker ç½‘ç»œåŸç†å…¨æ™¯è§£æã€‹ã€‚\nä¸æ˜¯â€œæ€ä¹ˆç”¨â€ï¼Œè€Œæ˜¯ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€æ•°æ®åŒ…æ€ä¹ˆèµ°ã€‚\nä¸€ã€ä¸€å¥è¯æ€»è§ˆï¼ˆå…ˆèƒŒï¼‰ Docker ç½‘ç»œæœ¬è´¨æ˜¯ï¼šLinux Network Namespace + veth + bridge + iptables NAT\näºŒã€Docker ç½‘ç»œçš„å››ä¸ªæ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ Network Namespaceï¼ˆç½‘ç»œéš”ç¦»ï¼‰ æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹ç½‘ç»œæ ˆ\n"},{"id":188,"href":"/operations/linux/docker-vs-host-delpoy-database/","title":"Docker éƒ¨ç½²æ•°æ®åº“ vs å®¿ä¸»æœºç›´è£…æ•°æ®åº“","parent":"Linux","content":"ä¸€ã€ç»“è®º\nåœ¨ â€œé…ç½®æ­£ç¡®â€ çš„å‰æä¸‹ï¼ŒDocker éƒ¨ç½²æ•°æ®åº“ vs å®¿ä¸»æœºç›´è£…æ•°æ®åº“ï¼šæ€§èƒ½å·®è·é€šå¸¸åœ¨ 0% ï½ 5%ï¼Œå¤šæ•°åœºæ™¯å¯å¿½ç•¥ã€‚\nâ— çœŸæ­£æ‹‰å¼€å·®è·çš„ä¸æ˜¯ Dockerï¼Œè€Œæ˜¯ï¼š\nå­˜å‚¨æ–¹å¼ ç½‘ç»œæ¨¡å¼ å†…æ ¸å‚æ•° IO è°ƒåº¦ æ•°æ®åº“å‚æ•° äºŒã€ä¸ºä»€ä¹ˆå¾ˆå¤šäººâ€œæ„Ÿè§‰ Docker æ…¢â€ï¼Ÿ ğŸ‘‰ 90% æ˜¯é…ç½®é—®é¢˜ï¼Œä¸æ˜¯ Docker é—®é¢˜ã€‚\nå¸¸è§è¯¯åŒºï¼š\nè¯¯åŒº åæœ ä½¿ç”¨ overlay2 + å®¹å™¨å±‚å†™æ•°æ® IO æ˜æ˜¾å˜æ…¢ volume æ˜ å°„åˆ°æ…¢ç£ç›˜ TPS é™ docker0 NAT ç½‘ç»œ ç½‘ç»œå»¶è¿Ÿå¢å¤§ cgroup é»˜è®¤é™åˆ¶ CPU / å†…å­˜è¢«é™ æ²¡è°ƒ sysctl fsync / shm å—é™ ä¸‰ã€ä»â€œå†…æ ¸å±‚â€è§£é‡Šæ€§èƒ½å·®è·ï¼ˆå…³é”®ï¼‰ 1ï¸âƒ£ CPUï¼šå‡ ä¹æ— å·®è· å®¹å™¨ = å®¿ä¸»æœºæ™®é€šè¿›ç¨‹ æ— è™šæ‹ŸåŒ–æŒ‡ä»¤å¼€é”€ cgroups åªåœ¨ä½ é™åˆ¶æ—¶æ‰å½±å“ ğŸ“Œ CPU æ€§èƒ½ â‰ˆ åŸç”Ÿ\n2ï¸âƒ£ å†…å­˜ï¼šæ— å·®è·ï¼ˆç”šè‡³æ›´å¯æ§ï¼‰ å®¹å™¨ç›´æ¥ç”¨å®¿ä¸»æœºå†…å­˜ ä½†ï¼š shm-size é»˜è®¤ 64MBï¼ˆMySQL/Postgres å‘ï¼‰ ğŸ“Œ å†…å­˜æ€§èƒ½ â‰ˆ åŸç”Ÿ\nğŸ“Œ å‚æ•°ä¸å¯¹ -\u0026gt; ç›´æ¥ç‚¸\n3ï¸âƒ£ ç½‘ç»œï¼šå·®è·ä¸»è¦æ¥è‡ªç½‘ç»œæ¨¡å¼ ä¸åŒç½‘ç»œæ¨¡å¼å¯¹æ¯”ï¼š\nç½‘ç»œæ¨¡å¼ RTT å·®è· host â‰ˆ 0 bridge +5%ï½15% overlay +10%ï½30% ğŸ“Œ æ•°æ®åº“å»ºè®®ï¼š\nhost æˆ–æœ¬æœº bridge + volume 4ï¸âƒ£ å­˜å‚¨ï¼šè¿™æ˜¯å”¯ä¸€â€œå¯èƒ½æ˜¾è‘—å·®è·â€çš„åœ°æ–¹ IO æ€§èƒ½å¯¹æ¯”ï¼ˆå…³é”®ï¼‰\nå­˜å‚¨æ–¹å¼ æ€§èƒ½ å®¿ä¸»æœºç›´å†™ç£ç›˜ 100% bind mountï¼ˆæ¨èï¼‰ â‰ˆ 95ï½100% named volume â‰ˆ 95% å®¹å™¨å±‚å†™å…¥ âŒ 50% ç”šè‡³æ›´ä½ ğŸ“Œ æ•°æ®åº“æ•°æ®ç›®å½•å¿…é¡»ç”¨ volume / bind mount\nå››ã€ä¸åŒæ•°æ®åº“çš„å®é™…å½±å“ MySQL / PostgreSQL\nåœºæ™¯ æ€§èƒ½å·®è· æ­£ç¡® volume + host ç½‘ç»œ 0ï½3% bridge ç½‘ç»œ 3ï½10% overlay2 å®¹å™¨å±‚ 20ï½50%ï¼ˆä¸å¯æ¥å—ï¼‰ Redis\nå†…å­˜å‹ ç½‘ç»œæ•æ„Ÿ ğŸ“Œ ä½¿ç”¨ host ç½‘ç»œï¼š\næ€§èƒ½å‡ ä¹æ— å·®è· MongoDB\nå¯¹ fsync / journaling æ•æ„Ÿ volume é…ç½®æé‡è¦ ğŸ“Œ æ­£ç¡®é…ç½®ï¼š\u0026lt;5%\näº”ã€çœŸå®å‹æµ‹ç»“è®ºï¼ˆç»éªŒçº§ï¼‰ åœ¨åŒä¸€å°ç‰©ç†æœºä¸Šï¼š\nè£¸æœº MySQL TPSï¼š 100% Docker MySQLï¼ˆæ­£ç¡®é…ç½®ï¼‰ï¼š 97%ï½99% Docker MySQLï¼ˆé»˜è®¤é…ç½®ï¼‰ï¼š 70%ï½85% ğŸ“Œ å·®è· â‰  Docker\nğŸ“Œ å·®è· = é»˜è®¤é…ç½®\nå…­ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼ˆéå¸¸é‡è¦ï¼‰ âœ… æ¨èç”¨ Docker éƒ¨ç½²æ•°æ®åº“çš„åœºæ™¯\nå¼€å‘ / æµ‹è¯• CI è½»é‡ç”Ÿäº§ï¼ˆä¸­å°è§„æ¨¡ï¼‰ å¯¹å¯å¤åˆ¶æ€§è¦æ±‚é«˜ âŒ ä¸å»ºè®® Docker çš„åœºæ™¯\nè¶…é«˜ IOï¼ˆé‡‘èã€è´¦åŠ¡æ ¸å¿ƒï¼‰ è¶…ä½å»¶è¿Ÿï¼ˆæ¯«ç§’çº§ SLAï¼‰ å¯¹ NUMA / HugePage æç«¯æ•æ„Ÿ ä¸æ„¿è°ƒå†…æ ¸å‚æ•°çš„å›¢é˜Ÿ ä¸ƒã€Docker éƒ¨ç½²æ•°æ®åº“çš„â€œé»„é‡‘é…ç½®â€ 1ï¸âƒ£ å­˜å‚¨ volumes: - /data/mysql:/var/lib/mysql 2ï¸âƒ£ ç½‘ç»œ network_mode: host 3ï¸âƒ£ å†…å­˜ \u0026amp; SHM shm_size: 1g 4ï¸âƒ£ å…³é—­æ— æ„ä¹‰é™åˆ¶ deploy: resources: limits: cpus: \u0026#34;0\u0026#34; 5ï¸âƒ£ å†…æ ¸å‚æ•°ï¼ˆå®¿ä¸»æœºï¼‰ vm.swappiness=1 fs.aio-max-nr=1048576 å…«ã€æ€»ç»“ åœ¨é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼ŒDocker éƒ¨ç½²æ•°æ®åº“ä¸å®¿ä¸»æœºç›´è£…æ€§èƒ½å·®è·éå¸¸å°ï¼Œé€šå¸¸åœ¨ 5% ä»¥å†…ã€‚\næ€§èƒ½å·®å¼‚ä¸»è¦æ¥è‡ªå­˜å‚¨å±‚å’Œç½‘ç»œæ¨¡å¼ï¼Œè€Œä¸æ˜¯ Docker æœ¬èº«ã€‚\nDocker å®¹å™¨å…±äº«å®¿ä¸»æœºå†…æ ¸ï¼Œä¸å­˜åœ¨è™šæ‹ŸåŒ–æŒ‡ä»¤å¼€é”€ã€‚\nå¤šæ•°æ€§èƒ½é—®é¢˜æ¥è‡ªé”™è¯¯ä½¿ç”¨å®¹å™¨å±‚å†™æ•°æ®æˆ– overlay æ–‡ä»¶ç³»ç»Ÿã€‚\nCPU â‰ˆ åŸç”Ÿ å†…å­˜ â‰ˆ åŸç”Ÿ IO å†³å®šä¸€åˆ‡ éƒ¨ç½²æ•°æ®åº“ï¼Œä½¿ç”¨ Docker + bind mount å’Œ å®¿ä¸»æœºç›´æ¥éƒ¨ç½²ï¼Œæ€§èƒ½å·®è·å¤šå°‘ï¼Ÿæ¨èå“ªç§æ–¹å¼ï¼Ÿ ä¸€ã€ç»“è®ºå…ˆè¡Œï¼ˆä½ å¯ä»¥ç›´æ¥è®°ä½ï¼‰ Docker + bind mount ä¸å®¿ä¸»æœºç›´æ¥éƒ¨ç½²æ•°æ®åº“ï¼šæ€§èƒ½å·®è·é€šå¸¸åœ¨ 0%ï½5% ä»¥å†…ï¼Œåœ¨ç»å¤§å¤šæ•°ç”Ÿäº§åœºæ™¯ä¸­å¯ä»¥è®¤ä¸ºâ€œç­‰ä»·â€ã€‚\nğŸ“Œ çœŸæ­£æœ‰å·¨å¤§æ€§èƒ½æŸå¤±çš„æ˜¯ï¼š\nâŒ Docker + overlay2 å†™æ•°æ®ç›®å½• âŒ Docker + éç›´å†™æ–‡ä»¶ç³»ç»Ÿ âŒ Docker + é”™è¯¯ cgroups / NUMA è®¾ç½® äºŒã€å…³é”®å¯¹æ¯”è¡¨ï¼ˆéå¸¸é‡è¦ï¼‰\nç»´åº¦\tDocker + bind mount\tå®¿ä¸»æœºç›´æ¥éƒ¨ç½² æ•°æ®è·¯å¾„\tç›´è¾¾å®¿ä¸»æœº FS\tç›´è¾¾å®¿ä¸»æœº FS overlay2 å½±å“\tâŒ æ— \tâŒ æ—  IO æ€§èƒ½\tâ‰ˆ åŸç”Ÿ\t100% fsync è¯­ä¹‰\tä¸€è‡´\tä¸€è‡´ WAL / redo\tæ­£å¸¸\tæ­£å¸¸ NUMA æ§åˆ¶\tå¯æ§\tæœ€å¼º cgroups é™åˆ¶\tæœ‰ï¼ˆå¯å…³é—­ï¼‰\tæ—  ç½‘ç»œå»¶è¿Ÿ\t+å‡ å Î¼s\tæœ€ä½ ç¨³å®šæ€§\té«˜\tæœ€é«˜ è¿ç»´å¤æ‚åº¦\tä½\tä¸­ å›æ»šå‡çº§\tæå¿«\tæ…¢\nâ¸»\nä¸‰ã€çœŸå®æ€§èƒ½æ•°æ®ï¼ˆç»éªŒå€¼ï¼‰\nä»¥ä¸‹æ˜¯ å¤§é‡ç”Ÿäº§ç¯å¢ƒ \u0026amp; å‹æµ‹çš„çœŸå®åŒºé—´ï¼ˆéè¥é”€æ•°å­—ï¼‰ï¼š\n1ï¸âƒ£ ç£ç›˜ IOï¼ˆæœ€å…³é”®ï¼‰\nåœºæ™¯\tQPS / TPS å®¿ä¸»æœºç›´è£…\t100% Docker + bind mount\t95%ï½100% Docker + overlay2\t30%ï½70%ï¼ˆä¸¥é‡æŠ–åŠ¨ï¼‰\nğŸ“Œ bind mount å‡ ä¹æ²¡æœ‰é¢å¤– IO å¼€é”€\nâ¸»\n2ï¸âƒ£ å»¶è¿Ÿï¼ˆP99ï¼‰\nåœºæ™¯\tå»¶è¿Ÿå˜åŒ– å®¿ä¸»æœº\tbaseline Docker + bind\t+0ï½5% Docker + overlay2\t+50%ï½300%\nâ¸»\n3ï¸âƒ£ CPU å¼€é”€\nDocker é¢å¤–å¼€é”€æ¥è‡ªï¼š\ncgroups accounting namespace ğŸ“Œ æ•°æ®åº“ CPU å¼€é”€å¢åŠ  \u0026lt; 3%\nâ¸»\n4ï¸âƒ£ ç½‘ç»œï¼ˆæœ¬åœ°è®¿é—®ï¼‰\næ¨¡å¼\tRTT unix socket\tæœ€ä½ host network\tâ‰ˆ åŸç”Ÿ bridge ç½‘ç»œ\t+20ï½50 Î¼s\nğŸ‘‰ ç”Ÿäº§æ•°æ®åº“æ¨èï¼š\n\u0026ndash;network=host\nâ¸»\nå››ã€ä¸ºä»€ä¹ˆ Docker + bind mount å‡ ä¹ç­‰äºåŸç”Ÿï¼Ÿ\nå…³é”®åŸå› ä¸€å¥è¯ï¼š\nbind mount ç»•è¿‡ overlay2ï¼Œæ•°æ®åº“çš„ IO è·¯å¾„ä¸å®¿ä¸»æœºå®Œå…¨ä¸€è‡´\nIO è·¯å¾„å¯¹æ¯”ï¼š\nå®¿ä¸»æœºéƒ¨ç½²ï¼š DB -\u0026gt; VFS -\u0026gt; ext4/xfs -\u0026gt; block -\u0026gt; disk\nDocker + bind mountï¼š DB -\u0026gt; VFS -\u0026gt; ext4/xfs -\u0026gt; block -\u0026gt; disk\nğŸ“Œ æ²¡æœ‰ overlayfs ğŸ“Œ æ²¡æœ‰ CoW ğŸ“Œ æ²¡æœ‰å¤šå±‚ lookup\nâ¸»\näº”ã€ä»€ä¹ˆæ—¶å€™â€œå¿…é¡»â€é€‰å®¿ä¸»æœºç›´è£…ï¼Ÿ\nâ—å¼ºçƒˆæ¨èå®¿ä¸»æœºç›´è£…çš„åœºæ™¯\né‡‘è / æ ¸å¿ƒäº¤æ˜“ æä½å»¶è¿Ÿï¼ˆ\u0026lt;1msï¼‰ æé«˜ QPSï¼ˆç™¾ä¸‡çº§ï¼‰ NUMA æåº¦æ•æ„Ÿ è‡ªå®šä¹‰å†…æ ¸å‚æ•°ï¼ˆHugePageã€IO schedulerï¼‰ ğŸ“Œ æè‡´æ€§èƒ½ \u0026amp; å¯é¢„æµ‹æ€§ \u0026gt; è¿ç»´ä¾¿åˆ©æ€§\nâ¸»\nå…­ã€ä»€ä¹ˆæ—¶å€™ Docker + bind mount æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Ÿ\nâœ… å¼ºçƒˆæ¨è Docker + bind mount çš„åœºæ™¯\nä¸­å¤§å‹äº’è”ç½‘ä¸šåŠ¡ å¾®æœåŠ¡ + ç‹¬ç«‹ DB èŠ‚ç‚¹ å¤šç‰ˆæœ¬å¹¶å­˜ / å¿«é€Ÿå›æ»š æ ‡å‡†åŒ–éƒ¨ç½² äº‘ä¸Šç¯å¢ƒ ğŸ“Œ 90% çš„ç”Ÿäº§æ•°æ®åº“éƒ½åœ¨è¿™ä¸ªåŒºé—´\nâ¸»\nä¸ƒã€ä¸¤ç§æ–¹å¼çš„â€œçœŸæ­£åŒºåˆ«â€ä¸åœ¨æ€§èƒ½\nçœŸæ­£çš„å·®åˆ«åœ¨è¿™é‡Œ ğŸ‘‡\nç»´åº¦\tDocker + bind\tå®¿ä¸»æœº éƒ¨ç½²ä¸€è‡´æ€§\tâ­â­â­â­â­\tâ­â­ å›æ»š\tç§’çº§\tåˆ†é’Ÿï½å°æ—¶ å‡çº§\tåŸå­åŒ–\tæ‰‹å·¥ å¤šç‰ˆæœ¬å…±å­˜\tç®€å•\tå›°éš¾ è¿ç»´é£é™©\tä½\té«˜ æ’é”™é€æ˜åº¦\tä¸­\té«˜\nâ¸»\nå…«ã€å¼ºçƒˆæ¨èçš„ç”Ÿäº§çº§ Docker DB å¯åŠ¨æ¨¡æ¿\nMySQL ç¤ºä¾‹\ndocker run -d \u0026ndash;name mysql \u0026ndash;network host \u0026ndash;cpuset-cpus=\u0026ldquo;0-15\u0026rdquo; \u0026ndash;memory=64g \u0026ndash;memory-swappiness=0 -v /data/mysql:/var/lib/mysql -v /etc/mysql/my.cnf:/etc/my.cnf:ro mysql:8.0\nPostgreSQL ç¤ºä¾‹\ndocker run -d \u0026ndash;name pg \u0026ndash;network host \u0026ndash;cpuset-cpus=\u0026ldquo;0-15\u0026rdquo; -v /data/pg:/var/lib/postgresql/data postgres:16\nâ¸»\nä¹ã€æœ€ç»ˆæ¨èï¼ˆç»™ä½ ä¸€ä¸ªéå¸¸æ¸…æ™°çš„åˆ¤æ–­ï¼‰\nå¦‚æœä½ ä¸è¿½æ±‚æé™æ€§èƒ½ï¼ŒDocker + bind mount æ˜¯â€œå·¥ç¨‹ä¸Šæœ€ä¼˜è§£â€ã€‚ å¦‚æœä½ è¿½æ±‚çš„æ˜¯â€œç‰©ç†æé™ + ç»å¯¹å¯æ§â€ï¼Œå®¿ä¸»æœºç›´è£…ã€‚\nâ¸»\nåã€ç”¨ä¸€å¥â€œè€å·¥ç¨‹å¸ˆçš„è¯â€æ”¶å°¾\nâ€œæ•°æ®åº“ä¸æ˜¯ä¸èƒ½è·‘åœ¨å®¹å™¨é‡Œï¼Œè€Œæ˜¯ä¸èƒ½è·‘åœ¨ overlay2 é‡Œã€‚â€\nâ¸»\nå¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š\nç»™ä½ ä¸€ä»½ MySQL / PostgreSQL å®¹å™¨ç”Ÿäº§æ£€æŸ¥æ¸…å• å¸®ä½ åš NUMA + cgroups + å­˜å‚¨ çš„è”åˆè°ƒä¼˜æ¨¡æ¿ å¯¹æ¯” Docker vs Podman vs systemd-run è·‘æ•°æ®åº“ ä½ ç°åœ¨é—®çš„é—®é¢˜ï¼Œå·²ç»æ˜¯ æ¶æ„å†³ç­–å±‚çº§ äº† ğŸ‘\n","description":"ä¸€ã€ç»“è®º\nåœ¨ â€œé…ç½®æ­£ç¡®â€ çš„å‰æä¸‹ï¼ŒDocker éƒ¨ç½²æ•°æ®åº“ vs å®¿ä¸»æœºç›´è£…æ•°æ®åº“ï¼šæ€§èƒ½å·®è·é€šå¸¸åœ¨ 0% ï½ 5%ï¼Œå¤šæ•°åœºæ™¯å¯å¿½ç•¥ã€‚\nâ— çœŸæ­£æ‹‰å¼€å·®è·çš„ä¸æ˜¯ Dockerï¼Œè€Œæ˜¯ï¼š\nå­˜å‚¨æ–¹å¼ ç½‘ç»œæ¨¡å¼ å†…æ ¸å‚æ•° IO è°ƒåº¦ æ•°æ®åº“å‚æ•° äºŒã€ä¸ºä»€ä¹ˆå¾ˆå¤šäººâ€œæ„Ÿè§‰ Docker æ…¢â€ï¼Ÿ ğŸ‘‰ 90% æ˜¯é…ç½®é—®é¢˜ï¼Œä¸æ˜¯ Docker é—®é¢˜ã€‚\nå¸¸è§è¯¯åŒºï¼š\nè¯¯åŒº åæœ ä½¿ç”¨ overlay2 + å®¹å™¨å±‚å†™æ•°æ® IO æ˜æ˜¾å˜æ…¢ volume æ˜ å°„åˆ°æ…¢ç£ç›˜ TPS é™ docker0 NAT ç½‘ç»œ ç½‘ç»œå»¶è¿Ÿå¢å¤§ cgroup é»˜è®¤é™åˆ¶ CPU / å†…å­˜è¢«é™ æ²¡è°ƒ sysctl fsync / shm å—é™ ä¸‰ã€ä»â€œå†…æ ¸å±‚â€è§£é‡Šæ€§èƒ½å·®è·ï¼ˆå…³é”®ï¼‰ 1ï¸âƒ£ CPUï¼šå‡ ä¹æ— å·®è· å®¹å™¨ = å®¿ä¸»æœºæ™®é€šè¿›ç¨‹ æ— è™šæ‹ŸåŒ–æŒ‡ä»¤å¼€é”€ cgroups åªåœ¨ä½ é™åˆ¶æ—¶æ‰å½±å“ ğŸ“Œ CPU æ€§èƒ½ â‰ˆ åŸç”Ÿ\n"},{"id":189,"href":"/operations/docker/dind-vs-docker-sock/","title":"Docker-in-Docker (DinD) vs docker.sock","parent":"Docker","content":"è¿™æ˜¯ä¸€ä¸ªDevOps / CI / å®‰å…¨ / æ¶æ„è®¾è®¡çš„é«˜é¢‘â€œç”Ÿæ­»é¢˜â€ã€‚\nâ€”â€”åŸç†çº§ã€é£é™©çº§ã€é€‰å‹çº§æ·±åº¦å¯¹æ¯” ä¸€ã€å…ˆç»™â€œç»“è®ºç‰ˆâ€ï¼ˆé‡è¦ï¼‰ docker.sock â‰  å®‰å…¨\nDinD â‰  å¹²å‡€\nç”Ÿäº§ CIï¼šä¸¤è€…éƒ½ä¸å®Œç¾ï¼Œä½† docker.sock æ›´å¸¸ç”¨\né«˜å®‰å…¨ç¯å¢ƒï¼šä¸¤è€…éƒ½ä¸æ¨èï¼Œä¼˜å…ˆ rootless / buildkit / kaniko\nä¸€å¥è¯è®°å¿†ï¼š\ndocker.sock æ˜¯â€œå€Ÿåˆ€æ€äººâ€\nDinD æ˜¯â€œè‡ªå¸¦ä¸€æŠŠåˆ€â€\näºŒã€ä¸¤ç§æ–¹å¼åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ 1ï¸âƒ£ docker.sockï¼ˆå…±äº«å®¿ä¸»æœº Dockerï¼‰ å®¹å™¨ | | /var/run/docker.sock v å®¿ä¸»æœº dockerd volumes: - /var/run/docker.sock:/var/run/docker.sock ğŸ‘‰ å®¹å™¨é‡Œæ‰§è¡Œ docker å‘½ä»¤ = æ“ä½œå®¿ä¸»æœº Docker\n2ï¸âƒ£ Docker-in-Dockerï¼ˆDinDï¼‰ å®¹å™¨ â””â”€ dockerdï¼ˆè‡ªå·±çš„ï¼‰ â””â”€ containerd â””â”€ runc image: docker:dind privileged: true ğŸ‘‰ å®¹å™¨é‡Œè·‘ä¸€ä¸ªâ€œå®Œæ•´ Docker å¼•æ“â€\nä¸‰ã€æ¶æ„çº§å¯¹æ¯”ï¼ˆæ ¸å¿ƒå·®å¼‚ï¼‰ ç»´åº¦ docker.sock DinD Docker å¼•æ“ å®¿ä¸»æœº å®¹å™¨å†… daemon æ•°é‡ 1 N æ˜¯å¦éš”ç¦» âŒ âš ï¸ éƒ¨åˆ† æ˜¯å¦éœ€è¦ç‰¹æƒ âŒ âœ… æ„å»ºç¼“å­˜ å…±äº« ç‹¬ç«‹ ç½‘ç»œå¤æ‚åº¦ ä½ é«˜ å››ã€å®‰å…¨æ€§å¯¹æ¯”ï¼ˆè¿™æ˜¯æœ€é‡è¦çš„ï¼‰ docker.sockï¼šæé«˜é£é™© è°èƒ½è®¿é—® docker.sockï¼Œè°å°±ç­‰äº root on host\næ”»å‡»ç¤ºä¾‹ï¼ˆçœŸå®ï¼‰ï¼š\ndocker run -v /:/host alpine chroot /host ğŸ“Œ åæœï¼š\nå®¿ä¸»æœºå®Œå…¨å¤±é™· æ— ä»»ä½•éš”ç¦» å®¡è®¡ç›´æ¥ FAIL ğŸ‘‰ docker.sock = root shell çš„å¦ä¸€ç§å½¢å¼\nDinDï¼šä¸æ˜¯å®‰å…¨ï¼Œåªæ˜¯â€œæ²¡é‚£ä¹ˆç›´æ¥â€ é—®é¢˜ç‚¹ï¼š\nå¿…é¡» --privileged èƒ½åŠ è½½å†…æ ¸æ¨¡å— èƒ½æ“ä½œ cgroups / namespace ğŸ“Œ ç»“æœï¼š\nä»ç„¶å¯é€ƒé€¸ åªæ˜¯è·¯å¾„æ›´ç»• ğŸ‘‰ DinD â‰  å®‰å…¨éš”ç¦»\näº”ã€æ€§èƒ½ \u0026amp; ç¨³å®šæ€§å¯¹æ¯” docker.sock âœ… æ„å»ºé€Ÿåº¦å¿« âœ… ç¼“å­˜å…±äº« âœ… ç½‘ç»œç®€å• âŒ å®¹æ˜“äº’ç›¸æ±¡æŸ“ï¼ˆåˆ é•œåƒï¼‰\nDinD âœ… ç¯å¢ƒç›¸å¯¹å¹²å‡€ âœ… ä¸æ±¡æŸ“å®¿ä¸»é•œåƒ âŒ æ„å»ºæ…¢ âŒ é•œåƒé‡å¤ä¸‹è½½ âŒ overlay2 å¥— overlay2ï¼ˆæ€§èƒ½å·®ï¼‰\nå…­ã€CI/CD åœºæ™¯ä¸‹çœŸå®å¯¹æ¯” GitLab CI / Jenkins ä¸­çš„ç°å® ç»´åº¦ docker.sock DinD ä½¿ç”¨ç‡ â­â­â­â­â­ â­â­ æ’éšœéš¾åº¦ ä½ é«˜ å¹¶å‘ç¨³å®šæ€§ ä¸€èˆ¬ å·® å®‰å…¨å®¡è®¡ âŒ âŒ ğŸ“Œ å¤§å‚ CI å®é™…ï¼šdocker.sock å±…å¤šï¼ˆåŠ éš”ç¦»ï¼‰\nä¸ƒã€å¸¸è§â€œé”™è¯¯è®¤çŸ¥â€çº æ­£ âŒ è¯¯åŒº 1ï¼šDinD å¾ˆå®‰å…¨ -\u0026gt; é”™ï¼Œprivileged æ˜¯è‡´å‘½ç‚¹\nâŒ è¯¯åŒº 2ï¼šdocker.sock åªæ˜¯ä¸ªæ–‡ä»¶ -\u0026gt; é”™ï¼Œæ˜¯ Docker API çš„ root æ¥å£\nâŒ è¯¯åŒº 3ï¼šDinD æ›´é€‚åˆç”Ÿäº§ -\u0026gt; é”™ï¼Œç”Ÿäº§æ ¹æœ¬ä¸è¯¥åœ¨å®¹å™¨é‡Œ build é•œåƒ\nå…«ã€çœŸæ­£â€œæ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆâ€ï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ BuildKit + buildxï¼ˆæ¨èï¼‰ docker buildx build æ— éœ€ docker.sockï¼ˆå¯æ§ï¼‰ æ”¯æŒè¿œç¨‹ builder æ”¯æŒ rootless 2ï¸âƒ£ Kanikoï¼ˆKubernetes åœºæ™¯ï¼‰ âœ… æ— éœ€ Docker daemon âœ… æ— ç‰¹æƒ âœ… äº‘åŸç”Ÿå‹å¥½\n3ï¸âƒ£ Podman / Buildah buildah bud âœ… daemonless âœ… rootless âœ… å®‰å…¨å®¡è®¡å‹å¥½\nä¹ã€2025 å¹´çœŸå®é€‰å‹å»ºè®®ï¼ˆç›´æ¥æŠ„ï¼‰ âœ” å¯ä»¥ç”¨ docker.sock çš„åœºæ™¯ å†…éƒ¨ CI éå®‰å…¨æ•æ„Ÿ æ„å»ºæœºå™¨ç‹¬å  æœ‰æ²™ç®± / VM éš”ç¦» ğŸ“Œ å‰æï¼šCI Runner æ˜¯ç‹¬ç«‹ VM\nâš ï¸ å‹‰å¼ºç”¨ DinD çš„åœºæ™¯ å¤šç§Ÿæˆ· CI éœ€è¦é•œåƒéš”ç¦» ä¸å…è®¸è®¿é—®å®¿ä¸» Docker ğŸ“Œ ä½†ä»éœ€ VM çº§éš”ç¦»\nâœ… å¼ºçƒˆæ¨èçš„æ–¹å¼ åœºæ™¯ æ¨è æœ¬åœ°å¼€å‘ Docker CI æ„å»º buildx / Kaniko ç”Ÿäº§ ä¸åœ¨å®¹å™¨å†…æ„å»º åã€é¢è¯•â€œé«˜åˆ†å›ç­”æ¨¡æ¿â€ docker.sock æ˜¯ç›´æ¥å…±äº«å®¿ä¸»æœº Docker APIï¼Œç­‰ä»·äº root æƒé™ï¼Œå®‰å…¨é£é™©æé«˜ï¼›Docker-in-Docker é€šè¿‡åœ¨å®¹å™¨å†…è¿è¡Œç‹¬ç«‹ daemon æä¾›ä¸€å®šéš”ç¦»ï¼Œä½†ä»éœ€ privilegedï¼Œä¸èƒ½è§†ä¸ºå®‰å…¨ã€‚ç°ä»£ CI æ›´æ¨èä½¿ç”¨ BuildKitã€Kaniko æˆ– rootless æ„å»ºæ–¹æ¡ˆã€‚\nåä¸€ã€ä¸‰å¥è¯ç»ˆææ€»ç»“ docker.sockï¼šæœ€å¿«ï¼Œä½†æœ€å±é™©\nDinDï¼šçœ‹ä¼¼éš”ç¦»ï¼Œå®åˆ™è„†å¼±\nçœŸæ­£å®‰å…¨ï¼šä¸åœ¨å®¹å™¨é‡Œè·‘ Docker\n","description":"è¿™æ˜¯ä¸€ä¸ªDevOps / CI / å®‰å…¨ / æ¶æ„è®¾è®¡çš„é«˜é¢‘â€œç”Ÿæ­»é¢˜â€ã€‚\nâ€”â€”åŸç†çº§ã€é£é™©çº§ã€é€‰å‹çº§æ·±åº¦å¯¹æ¯” ä¸€ã€å…ˆç»™â€œç»“è®ºç‰ˆâ€ï¼ˆé‡è¦ï¼‰ docker.sock â‰  å®‰å…¨\nDinD â‰  å¹²å‡€\nç”Ÿäº§ CIï¼šä¸¤è€…éƒ½ä¸å®Œç¾ï¼Œä½† docker.sock æ›´å¸¸ç”¨\né«˜å®‰å…¨ç¯å¢ƒï¼šä¸¤è€…éƒ½ä¸æ¨èï¼Œä¼˜å…ˆ rootless / buildkit / kaniko\nä¸€å¥è¯è®°å¿†ï¼š\ndocker.sock æ˜¯â€œå€Ÿåˆ€æ€äººâ€\nDinD æ˜¯â€œè‡ªå¸¦ä¸€æŠŠåˆ€â€\näºŒã€ä¸¤ç§æ–¹å¼åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ 1ï¸âƒ£ docker.sockï¼ˆå…±äº«å®¿ä¸»æœº Dockerï¼‰ å®¹å™¨ | | /var/run/docker.sock v å®¿ä¸»æœº dockerd volumes: - /var/run/docker.sock:/var/run/docker.sock ğŸ‘‰ å®¹å™¨é‡Œæ‰§è¡Œ docker å‘½ä»¤ = æ“ä½œå®¿ä¸»æœº Docker\n"},{"id":190,"href":"/operations/docker/dockerfile-best-practices/","title":"Dockerfile æœ€ä½³å®è·µ","parent":"Docker","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ä¼ä¸šçº§ã€å¯ç›´æ¥è½åœ°çš„ã€ŠDockerfile æœ€ä½³å®è·µã€‹ï¼Œè¦†ç›–æ€§èƒ½ã€æ„å»ºé€Ÿåº¦ã€é•œåƒå¤§å°ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ç­‰æ‰€æœ‰å…³é”®ç‚¹ã€‚\nå†…å®¹ æç®€ã€æ˜ç¡®ã€å¯ç”¨ï¼Œå¹¶ä¸”é€‚ç”¨äºåç«¯ / å‰ç«¯ / Go / Python / Node / Java ç­‰å¸¸è§é¡¹ç›®ã€‚\n1. é•œåƒå°½é‡å°ï¼ˆsmall imageï¼‰ é•œåƒè¶Šå°ï¼š\næ‹‰å–å¿« æ„å»ºå¿« æ¨é€å¿« æ”»å‡»é¢æ›´å° æ¨èï¼šæ€»æ˜¯é¦–é€‰ å®˜æ–¹çš„ -slim / alpine / distroless é•œåƒ\nç¤ºä¾‹ï¼š\nFROM python:3.12-slim âŒ ä¸æ¨èï¼š\nFROM ubuntu:latest FROM python:latest 2. å¤šé˜¶æ®µæ„å»ºï¼ˆmulti-stageï¼‰ å‡å°‘æœ€ç»ˆé•œåƒä½“ç§¯ã€ç§»é™¤æ„å»ºå·¥å…·ã€‚\nç¤ºä¾‹ï¼ˆå‰ç«¯ï¼‰ï¼š\n# Build stage FROM node:20-slim AS builder WORKDIR /app COPY package*.json ./ RUN npm ci COPY . . RUN npm run build # Production stage FROM nginx:1.27-alpine COPY --from=builder /app/dist /usr/share/nginx/html ç¤ºä¾‹ï¼ˆGoï¼‰ï¼š\nFROM golang:1.22 AS builder WORKDIR /src COPY . . RUN CGO_ENABLED=0 go build -o app . FROM gcr.io/distroless/base COPY --from=builder /src/app /app ENTRYPOINT [\u0026#34;/app\u0026#34;] 3. å‡å°‘å±‚ï¼ˆlayerï¼‰æ•°é‡ æ¯ä¸€æ¡æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€å±‚ï¼Œå› æ­¤ï¼š\nåˆå¹¶ RUN é¿å… COPY è¿‡å¤šå°æ–‡ä»¶ ç¤ºä¾‹ï¼š\nRUN apt-get update \u0026amp;\u0026amp; apt-get install -y \\ curl \\ git \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* 4. å›ºå®šåŸºç¡€é•œåƒ tagï¼ˆé¿å… latestï¼‰ å¥½å¤„ï¼š\næ„å»ºå¯é‡å¤ é¿å…æœªçŸ¥å‡çº§å¯¼è‡´ä¸å¯æ§ bug ç¤ºä¾‹ï¼š\nFROM python:3.12.2-slim FROM node:20.11.1-slim FROM nginx:1.27.2-alpine 5. ä¼˜åŒ–ä¾èµ–çš„ç¼“å­˜ï¼ˆbuild cacheï¼‰ æ€»æ˜¯å…ˆ COPY ä¾èµ–æ–‡ä»¶ï¼Œå†å®‰è£…ä¾èµ–ï¼š\nNodeï¼š\nCOPY package*.json . RUN npm ci COPY . . Pythonï¼š\nCOPY requirements.txt . RUN pip install -r requirements.txt COPY . . Goï¼š\nCOPY go.mod go.sum ./ RUN go mod download COPY . . ä½¿å¾—ä¾èµ–ä¸å˜æ—¶ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨ç¼“å­˜ã€‚\n6. ä½¿ç”¨ .dockerignoreï¼ˆéå¸¸å…³é”®ï¼‰ é¿å…æŠŠä¸éœ€è¦çš„æ–‡ä»¶ COPY è¿›å»ï¼š\ndockerignore ç¤ºä¾‹ï¼š\n.git node_modules venv dist __pycache__ *.log .env å¥½å¤„ï¼š\nå‡å°‘ context å¤§å° åŠ å¿«æ„å»ºé€Ÿåº¦ é™ä½æ³„æ¼é£é™© 7. ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œç¨‹åºï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰ ç¤ºä¾‹ï¼ˆDocker å®˜æ–¹æ¨èæ–¹å¼ï¼‰ï¼š\nRUN adduser --disabled-password --gecos \u0026#39;\u0026#39; appuser USER appuser å¯¹äº distrolessï¼š\nUSER nonroot 8. ä½¿ç”¨ ENTRYPOINT + CMD çš„æœ€ä½³ç»„åˆ åŸåˆ™ï¼š\nENTRYPOINTï¼šå®šä¹‰ä¸å˜çš„éƒ¨åˆ† CMDï¼šå…è®¸è¢«è¦†ç›–çš„éƒ¨åˆ† ç¤ºä¾‹ï¼š\nENTRYPOINT [\u0026#34;python\u0026#34;, \u0026#34;-m\u0026#34;, \u0026#34;myapp\u0026#34;] CMD [\u0026#34;--config\u0026#34;, \u0026#34;/etc/myapp/config.yaml\u0026#34;] 9. é¿å…åœ¨é•œåƒä¸­å­˜æ”¾ secrets âŒ ä¸è¦ COPY .env âŒ ä¸è¦æŠŠå¯†é’¥å†™å…¥é•œåƒ ä½¿ç”¨ï¼š\ndocker secret k8s secret ç¯å¢ƒå˜é‡æ³¨å…¥ 10. æ„å»ºæ—¶å°½é‡ no-cacheï¼Œè¿è¡Œæ—¶é¿å… no-cache æ„å»ºè°ƒè¯•æ—¶ï¼š\ndocker build --no-cache . CI/CD ä¸­å»ºè®®ä½¿ç”¨ç¼“å­˜åŠ é€Ÿæ„å»ºã€‚\n11. è®©é•œåƒå¯è§‚å¯Ÿæ€§æ›´å¥½ æ·»åŠ æ ‡ç­¾ï¼š\nLABEL org.opencontainers.image.authors=\u0026#34;martin\u0026#34; LABEL org.opencontainers.image.source=\u0026#34;https://github.com/... \u0026#34; LABEL org.opencontainers.image.version=\u0026#34;1.0.2\u0026#34; LABEL org.opencontainers.image.created=\u0026#34;2025-12-27\u0026#34; æ·»åŠ  healthcheckï¼ˆå¯é€‰ï¼‰ï¼š\nHEALTHCHECK --interval=10s --timeout=2s \\ CMD curl -f http://localhost/health || exit 1 12. Nginx é•œåƒæœ€ä½³å®è·µï¼ˆä½ å¸¸ç”¨ï¼‰ FROM nginx:1.27-alpine RUN rm -rf /etc/nginx/conf.d/* COPY nginx.conf /etc/nginx/nginx.conf COPY dist /usr/share/nginx/html EXPOSE 80 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] 13. Node æ„å»ºå‰ç«¯é•œåƒæœ€ä½³ç¤ºä¾‹ï¼ˆå¤šé˜¶æ®µï¼‰ # ========== build ========== FROM node:20-slim AS builder WORKDIR /app COPY package*.json ./ RUN npm ci COPY . . RUN npm run build # ========== production ========== FROM nginx:1.27-alpine COPY --from=builder /app/dist /usr/share/nginx/html COPY nginx.conf /etc/nginx/conf.d/default.conf EXPOSE 80 CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] 14. æœ€å¸¸è§é”™è¯¯ï¼ˆé¿å…è¸©å‘ï¼‰ âŒ åœ¨å®¹å™¨é‡Œå†™å¤§é‡æ—¥å¿—ï¼ˆåº”è¯¥ stdoutï¼‰ âŒ åœ¨å®¹å™¨å†…è¿è¡Œ systemd âŒ åœ¨å®¹å™¨é‡Œä½¿ç”¨ cron âŒ å®‰è£…å¤ªå¤šæ— ç”¨åŒ… âŒ åŸºç¡€é•œåƒä½¿ç”¨ latest âŒ æ„å»ºé•œåƒæŠŠæ•´ä¸ªé¡¹ç›® COPY TOO MUCH âŒ Dockerfile é€»è¾‘å†™æˆè„šæœ¬ä¸€æ ·å¤æ‚ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ä¼ä¸šçº§ã€å¯ç›´æ¥è½åœ°çš„ã€ŠDockerfile æœ€ä½³å®è·µã€‹ï¼Œè¦†ç›–æ€§èƒ½ã€æ„å»ºé€Ÿåº¦ã€é•œåƒå¤§å°ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ç­‰æ‰€æœ‰å…³é”®ç‚¹ã€‚\nå†…å®¹ æç®€ã€æ˜ç¡®ã€å¯ç”¨ï¼Œå¹¶ä¸”é€‚ç”¨äºåç«¯ / å‰ç«¯ / Go / Python / Node / Java ç­‰å¸¸è§é¡¹ç›®ã€‚\n1. é•œåƒå°½é‡å°ï¼ˆsmall imageï¼‰ é•œåƒè¶Šå°ï¼š\næ‹‰å–å¿« æ„å»ºå¿« æ¨é€å¿« æ”»å‡»é¢æ›´å° æ¨èï¼šæ€»æ˜¯é¦–é€‰ å®˜æ–¹çš„ -slim / alpine / distroless é•œåƒ\nç¤ºä¾‹ï¼š\nFROM python:3.12-slim âŒ ä¸æ¨èï¼š\nFROM ubuntu:latest FROM python:latest 2. å¤šé˜¶æ®µæ„å»ºï¼ˆmulti-stageï¼‰ å‡å°‘æœ€ç»ˆé•œåƒä½“ç§¯ã€ç§»é™¤æ„å»ºå·¥å…·ã€‚\n"},{"id":191,"href":"/operations/docker/dockerfile/","title":"Dockerfile è¯¦è§£","parent":"Docker","content":" ä¸€ã€Dockerfile æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯æœ¬è´¨ï¼‰ Dockerfile æ˜¯ä¸€ä»½â€œæ„å»ºé•œåƒçš„å£°æ˜å¼è„šæœ¬â€ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒå±‚ï¼ˆlayerï¼‰ã€‚\nå…³é”®è¯ï¼š\nå£°æ˜å¼ åˆ†å±‚ å¯å¤ç° äºŒã€é•œåƒåˆ†å±‚åŸç†ï¼ˆç†è§£ Dockerfile çš„æ ¸å¿ƒï¼‰ 1. æ¯æ¡æŒ‡ä»¤ = ä¸€ä¸ª Layer FROM ubuntu RUN apt update RUN apt install -y nginx ç­‰ä»·äºï¼š\nLayer 1: ubuntu åŸºç¡€é•œåƒ Layer 2: apt update Layer 3: å®‰è£… nginx ğŸ“Œ Layer åªè¯»ã€å¯å¤ç”¨ã€å¯ç¼“å­˜\n2. ä¸ºä»€ä¹ˆé¡ºåºéå¸¸é‡è¦ï¼Ÿ COPY . /app RUN pip install -r requirements.txt âŒ æ¯æ¬¡ä»£ç å˜æ›´ -\u0026gt; é‡æ–°è£…ä¾èµ–\nâœ… æ­£ç¡®é¡ºåºï¼š\nCOPY requirements.txt . RUN pip install -r requirements.txt COPY . /app ä¸‰ã€Dockerfile æ„å»ºæµç¨‹ï¼ˆHowï¼‰ docker build â†“ è§£æ Dockerfile â†“ ä» FROM æ‹‰åŸºç¡€é•œåƒ â†“ æŒ‰é¡ºåºæ‰§è¡ŒæŒ‡ä»¤ â†“ æ¯æ¡æŒ‡ä»¤ç”Ÿæˆ layer â†“ æœ€ç»ˆé•œåƒ ğŸ“Œ æ„å»ºæ˜¯ å•çº¿ç¨‹ã€æœ‰ç¼“å­˜çš„\nå››ã€Dockerfile æŒ‡ä»¤å…¨è§£ï¼ˆæ ¸å¿ƒï¼‰ 1. FROMï¼ˆå¿…é¡»æ˜¯ç¬¬ä¸€æ¡ï¼‰ FROM python:3.12-slim å®šä¹‰åŸºç¡€é•œåƒ å¤šé˜¶æ®µæ„å»ºä¸­å¯å¤šæ¬¡ä½¿ç”¨ ğŸ“Œ æ‰€æœ‰é•œåƒæœ€ç»ˆéƒ½åŸºäºæŸä¸ª FROM\n2. RUNï¼ˆæ„å»ºæ—¶æ‰§è¡Œï¼‰ RUN apt update \u0026amp;\u0026amp; apt install -y curl åœ¨æ„å»ºé˜¶æ®µæ‰§è¡Œ ç»“æœå†™å…¥é•œåƒå±‚ æœ€ä½³å®è·µ\nRUN apt update \\ \u0026amp;\u0026amp; apt install -y curl \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* ğŸ“Œ å‡å°é•œåƒä½“ç§¯\n3. COPY vs ADDï¼ˆé«˜é¢‘ï¼‰ COPYï¼ˆæ¨èï¼‰\nCOPY app /app ADDï¼ˆæ…ç”¨ï¼‰\nADD app.tar.gz /app ADD é¢å¤–åŠŸèƒ½ï¼š\nè‡ªåŠ¨è§£å‹ æ”¯æŒ URL ğŸ“Œ 90% åœºæ™¯ç”¨ COPY\n4. WORKDIRï¼ˆå¼ºçƒˆæ¨èï¼‰ WORKDIR /app è‡ªåŠ¨åˆ›å»ºç›®å½• æ›¿ä»£ cd 5. CMDï¼ˆå®¹å™¨å¯åŠ¨å‘½ä»¤ï¼‰ CMD [\u0026#34;nginx\u0026#34;, \u0026#34;-g\u0026#34;, \u0026#34;daemon off;\u0026#34;] è¿è¡Œæ—¶æ‰§è¡Œ åªèƒ½æœ‰ä¸€ä¸ª å¯è¢« docker run è¦†ç›– 6. ENTRYPOINTï¼ˆå…¥å£ç‚¹ï¼‰ ENTRYPOINT [\u0026#34;python\u0026#34;, \u0026#34;app.py\u0026#34;] ä¸æ˜“è¢«è¦†ç›– å¸¸ç”¨äºå›ºå®šå¯åŠ¨é€»è¾‘ ğŸ“Œ CMD æ˜¯ ENTRYPOINT çš„é»˜è®¤å‚æ•°\n7. CMD vs ENTRYPOINT åœºæ™¯ æ¨è å›ºå®šä¸»ç¨‹åº ENTRYPOINT å¯è¦†ç›–å‚æ•° CMD äºŒè€…ç»“åˆ æœ€ä½³å®è·µ ENTRYPOINT [\u0026#34;python\u0026#34;, \u0026#34;app.py\u0026#34;] CMD [\u0026#34;--help\u0026#34;] 8. ENVï¼ˆç¯å¢ƒå˜é‡ï¼‰ ENV APP_ENV=prod ğŸ“Œ æ„å»ºæœŸ \u0026amp; è¿è¡ŒæœŸå¯ç”¨\n9. ARGï¼ˆæ„å»ºå‚æ•°ï¼‰ ARG VERSION åªåœ¨ build é˜¶æ®µæœ‰æ•ˆ ä¸è¿›æœ€ç»ˆé•œåƒ ğŸ“Œ æ•æ„Ÿä¿¡æ¯ä¸è¦ç”¨ ARG\n10. EXPOSEï¼ˆå£°æ˜ç«¯å£ï¼‰ EXPOSE 8080 ğŸ“Œ åªæ˜¯æ–‡æ¡£æ€§è´¨\nğŸ“Œ ä¸ä¼šè‡ªåŠ¨æ˜ å°„ç«¯å£\n11. VOLUMEï¼ˆå£°æ˜æŒ‚è½½ç‚¹ï¼‰ VOLUME /data ğŸ“Œ ä¼šå½±å“é•œåƒå¯æ§æ€§ ğŸ“Œ ç”Ÿäº§ä¸­æ…ç”¨\n12. USERï¼ˆå®‰å…¨ï¼‰ USER app ğŸ“Œ å¼ºçƒˆå»ºè®®ä¸ç”¨ root è·‘åº”ç”¨\näº”ã€å¤šé˜¶æ®µæ„å»ºï¼ˆç°ä»£ Dockerfile æ ¸å¿ƒï¼‰ ç¤ºä¾‹ï¼šå‰ç«¯æ„å»º + Nginx\nFROM node:20 AS builder WORKDIR /app COPY package*.json ./ RUN npm install COPY . . RUN npm run build FROM nginx:alpine COPY --from=builder /app/dist /usr/share/nginx/html âœ… æ„å»ºç¯å¢ƒ â‰  è¿è¡Œç¯å¢ƒ âœ… é•œåƒæ›´å° âœ… æ›´å®‰å…¨ å…­ã€.dockerignoreï¼ˆæå…¶é‡è¦ï¼‰ node_modules .git dist ğŸ“Œ ä¸å¿½ç•¥ï¼š\næ„å»ºæ…¢ é•œåƒå¤§ ç¼“å­˜å¤±æ•ˆ ä¸ƒã€é•œåƒä½“ç§¯ä¼˜åŒ–æŠ€å·§ï¼ˆå®æˆ˜ï¼‰ æŠ€å·§ æ•ˆæœ slim / alpine â†“ 70% åˆå¹¶ RUN â†“ layer åˆ é™¤ç¼“å­˜ â†“ ä½“ç§¯ å¤šé˜¶æ®µæ„å»º â†“â†“â†“ å…«ã€Dockerfile å¸¸è§åæ¨¡å¼ï¼ˆå¿…é¿ï¼‰ âŒ ä¸€ä¸ª RUN ä¸€ä¸ªå‘½ä»¤ âŒ ç”¨ ADD ä»£æ›¿ COPY âŒ ä¸å†™ WORKDIR âŒ ç”¨ root è·‘æœåŠ¡ âŒ åœ¨é•œåƒé‡Œæ”¾æºç  + node_modules âŒ CMD ç”¨ shell å½¢å¼ï¼ˆPID 1 é—®é¢˜ï¼‰ ä¹ã€Dockerfile ä¸è¿è¡Œæ—¶çš„è¾¹ç•Œï¼ˆå…³é”®ç†è§£ï¼‰ é˜¶æ®µ Dockerfile æ„å»º RUN / COPY è¿è¡Œ CMD / ENTRYPOINT é…ç½® ENV å‚æ•° docker run ğŸ“Œ Dockerfile ä¸è´Ÿè´£ï¼š\næœåŠ¡ä¾èµ– å¤šå®¹å™¨é€šä¿¡ åã€é«˜é¢‘é—®ç­” Qï¼šä¸ºä»€ä¹ˆ RUN ä¼šäº§ç”Ÿ layerï¼Ÿ å› ä¸º Docker ä½¿ç”¨ UnionFS åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿ\nQï¼šCMD èƒ½å†™å¤šä¸ªå—ï¼Ÿ âŒ åªèƒ½ä¸€ä¸ªï¼Œåè€…è¦†ç›–å‰è€…\nQï¼šä¸ºä»€ä¹ˆ alpine æœ‰å‘ï¼Ÿ musl libc DNS / timezone / glibc å…¼å®¹æ€§ Qï¼šDockerfile æ˜¯ shell è„šæœ¬å—ï¼Ÿ âŒ ä¸æ˜¯ï¼Œæ˜¯æ„å»ºæŒ‡ä»¤å£°æ˜\nåä¸€ã€ä¸€ä¸ªâ€œæ ‡å‡†ç”Ÿäº§çº§ Dockerfile æ¨¡æ¿â€ FROM python:3.12-slim WORKDIR /app ENV PYTHONDONTWRITEBYTECODE=1 \\ PYTHONUNBUFFERED=1 COPY requirements.txt . RUN pip install --no-cache-dir -r requirements.txt COPY . . RUN useradd -m appuser USER appuser EXPOSE 8000 CMD [\u0026#34;python\u0026#34;, \u0026#34;main.py\u0026#34;] åäºŒã€æ€»ç»“ Dockerfile = é•œåƒæ„å»ºè¯´æ˜ä¹¦\næ¯æ¡æŒ‡ä»¤ = ä¸€ä¸ªä¸å¯å˜å±‚\né¡ºåºå’Œç¼“å­˜å†³å®šä¸€åˆ‡\n","description":" ä¸€ã€Dockerfile æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯æœ¬è´¨ï¼‰ Dockerfile æ˜¯ä¸€ä»½â€œæ„å»ºé•œåƒçš„å£°æ˜å¼è„šæœ¬â€ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒå±‚ï¼ˆlayerï¼‰ã€‚\nå…³é”®è¯ï¼š\nå£°æ˜å¼ åˆ†å±‚ å¯å¤ç° äºŒã€é•œåƒåˆ†å±‚åŸç†ï¼ˆç†è§£ Dockerfile çš„æ ¸å¿ƒï¼‰ 1. æ¯æ¡æŒ‡ä»¤ = ä¸€ä¸ª Layer FROM ubuntu RUN apt update RUN apt install -y nginx ç­‰ä»·äºï¼š\n"},{"id":192,"href":"/","title":"Documents","parent":"","content":"Document List:\nManagement Beyond Development Operations Backend Bash Python Database Design ElasticSearch MongoDB MySQL PostgreSQL Prometheus Redis Operations Linux Hardware macOS Troubleshooting Others Alpine Ansible Debezium DNS Docker Git GitLab IPVS Java Jenkins Kafka Kubernetes KVM LVS Nacos NetworkManager Nginx Podman vsftpd Zabbix çŸ¥è¯†ç‚¹æ€»ç»“ About ","description":"Document List:\nManagement Beyond Development Operations Backend Bash Python Database Design ElasticSearch MongoDB MySQL PostgreSQL Prometheus Redis Operations Linux Hardware macOS Troubleshooting Others Alpine Ansible Debezium DNS Docker Git GitLab IPVS Java Jenkins Kafka Kubernetes KVM LVS Nacos NetworkManager Nginx Podman vsftpd Zabbix çŸ¥è¯†ç‚¹æ€»ç»“ About "},{"id":193,"href":"/operations/linux/drop-caches/","title":"Drop Caches","parent":"Linux","content":"åœ¨æ‰€æœ‰ Linux æœåŠ¡å™¨ä¸Šæ¯å¤©å®šæ—¶æ‰§è¡Œä¸€æ¬¡ä»¥ä¸‹å‘½ä»¤ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿæœ‰ä»€ä¹ˆåˆ©å¼Šï¼Ÿ\nsync;sync;sync;sync;sync;sync;sync;sync;sync;sync echo 1 \u0026gt; /proc/sys/vm/drop_caches ç»“è®ºå…ˆè¡Œï¼ˆä¸€å¥è¯ç‰ˆï¼‰\nä¸å»ºè®®åœ¨æ‰€æœ‰ Linux æœåŠ¡å™¨ä¸Šæ¯å¤©å®šæ—¶æ‰§è¡Œ sync; echo 1 \u0026gt; /proc/sys/vm/drop_cachesï¼Œå®ƒä¸æ˜¯â€œä¼˜åŒ–â€ï¼Œè€Œæ˜¯ä¸€æ¬¡â€œäººä¸ºåˆ¶é€ çš„å†·å¯åŠ¨ I/O æŠ–åŠ¨â€ï¼Œåªæœ‰åœ¨æå°‘æ•°æ’éšœæˆ–æµ‹è¯•åœºæ™¯æ‰æœ‰ä»·å€¼ã€‚\nä¸‹é¢ç»™ä½ å·¥ç¨‹çº§ã€å¯è½åœ°çš„åˆ†æã€‚\nä¸€ã€è¿™ä¸¤æ¡å‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼ˆæ¾„æ¸…ä¸€ä¸ªå¸¸è§è¯¯è§£ï¼‰ 1ï¸âƒ£ syncï¼ˆä½ æ‰§è¡Œäº† 10 æ¬¡ï¼‰ sync ä½œç”¨ï¼š\nå°† è„é¡µï¼ˆdirty pagesï¼‰ åˆ·å†™åˆ°ç£ç›˜ æ˜¯ä¸€ä¸ª é˜»å¡è°ƒç”¨ å¤šæ¬¡æ‰§è¡Œ â‰ˆ ä¸€æ¬¡æ‰§è¡Œ ğŸ“Œ ç»“è®ºï¼š\nsync;sync;sync;... åœ¨ç°ä»£ Linux å†…æ ¸ä¸­ æ²¡æœ‰ä»»ä½•é¢å¤–æ”¶ç›Š\n2ï¸âƒ£ echo 1 \u0026gt; /proc/sys/vm/drop_caches echo 1 \u0026gt; /proc/sys/vm/drop_caches ä½œç”¨ï¼š\né‡Šæ”¾ Page Cacheï¼ˆæ–‡ä»¶ç¼“å­˜ï¼‰\nä¸ä¼šé‡Šæ”¾ï¼š\nåº”ç”¨å†…å­˜ åŒ¿åé¡µ æ•°æ®åº“ Buffer / Shared Memory ç­‰ä»·äºï¼š\nå‘Šè¯‰å†…æ ¸ï¼šåˆšæ‰ç¼“å­˜çš„æ–‡ä»¶æ•°æ®ï¼Œå…¨éƒ¨å¿˜æ‰ äºŒã€æ¯å¤©å®šæ—¶æ‰§è¡Œï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ âœ… èƒ½å¾—åˆ°çš„â€œè¡¨é¢æ•ˆæœâ€ ç°è±¡ è¯´æ˜ free -h ä¸­ buff/cache ä¸‹é™ çœ‹èµ·æ¥â€œå†…å­˜å˜å¤šäº†â€ æŸäº›äººæ„Ÿè§‰ç³»ç»Ÿâ€œæ¸…çˆ½â€ å¿ƒç†å®‰æ…° æ’éšœæ—¶å¯æ¨¡æ‹Ÿå†·ç¼“å­˜ æµ‹è¯•ç”¨é€” âŒ çœŸæ­£çš„ä»£ä»·ï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ åˆ¶é€  I/O é£æš´ï¼ˆæœ€ä¸¥é‡ï¼‰ æ‰€æœ‰æ–‡ä»¶ç¼“å­˜è¢«æ¸…ç©º\nä¸‹ä¸€æ¬¡è®¿é—®ï¼š\næ•°æ®åº“æ•°æ® Python ç¨‹åºä¾èµ– ELF / so é…ç½®æ–‡ä»¶ ğŸ‘‰ å…¨éƒ¨é‡æ–°ä»ç£ç›˜è¯»å–\nğŸ“Œ åæœï¼š\nç£ç›˜ IOPS æš´æ¶¨ å»¶è¿Ÿç¬é—´å‡é«˜ SSD å†™æ”¾å¤§ã€HDD æŠ–åŠ¨ 2ï¸âƒ£ æ•°æ®åº“æ˜¯â€œç›´æ¥å—å®³è€…â€ PostgreSQL / MySQL åœºæ™¯ ç±»å‹ å½±å“ PostgreSQL OS Page Cache æ˜¯ shared_buffers çš„â€œäºŒçº§ç¼“å­˜â€ MySQL InnoDB å³ä½¿æœ‰ buffer poolï¼Œä¹Ÿé«˜åº¦ä¾èµ– OS readahead ç»“æœï¼š\nQPS ä¸‹é™ã€æ…¢æŸ¥è¯¢é£™å‡ã€checkpoint å‹åŠ›å˜å¤§\n3ï¸âƒ£ ç ´åå†…æ ¸çš„â€œè‡ªé€‚åº”å†…å­˜ç®¡ç†â€ Linux çš„å†…å­˜ç®¡ç†åŸåˆ™æ˜¯ï¼š\nç©ºé—²å†…å­˜ = æµªè´¹å†…å­˜\nå†…æ ¸ä¼šï¼š\nè‡ªåŠ¨å›æ”¶ cache æ ¹æ®å‹åŠ›åŠ¨æ€è°ƒæ•´ ä¼˜å…ˆå›æ”¶â€œå¯é‡å»ºâ€çš„ cache ä½ è¿™ä¸ªå‘½ä»¤æ˜¯ï¼š\nå¼ºè¡Œå¹²é¢„å†…æ ¸çš„ LRU / reclaim é€»è¾‘\n4ï¸âƒ£ å®¹å™¨ / è™šæ‹ŸåŒ–ç¯å¢ƒå°¤å…¶å±é™© Page Cache æ˜¯ å®¿ä¸»æœºå…±äº«çš„\nä½ æ¸…çš„æ˜¯ï¼š\næ‰€æœ‰å®¹å™¨ æ‰€æœ‰è™šæ‹Ÿæœºè¿›ç¨‹ æ‰€æœ‰æœåŠ¡çš„ cache ğŸ‘‰ ä¸€ä¸ª cronï¼Œæ‹–æ…¢æ•´å°å®¿ä¸»æœº\nä¸‰ã€ä»€ä¹ˆæ—¶å€™â€œå¯ä»¥â€ç”¨ï¼Ÿ âœ… åˆç†ä½¿ç”¨åœºæ™¯ï¼ˆæå°‘ï¼‰ åœºæ™¯ æ˜¯å¦åˆç† æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå†·ç¼“å­˜ï¼‰ âœ… å†…å­˜æ³„æ¼æ’éšœ âš ï¸ ä¸´æ—¶ å†…æ ¸/FS è¡Œä¸ºéªŒè¯ âœ… DBA æ‰‹åŠ¨ç»´æŠ¤çª—å£ âš ï¸ å‰æï¼š\näººå·¥æ‰§è¡Œ æœ‰æ˜ç¡®ç›®çš„ æœ‰ç»´æŠ¤çª—å£ å››ã€ä»€ä¹ˆæ—¶å€™â€œç»å¯¹ä¸è¯¥ç”¨â€ï¼Ÿ âŒ ç”Ÿäº§ç¯å¢ƒå®šæ—¶ä»»åŠ¡\nâŒ æ•°æ®åº“æœåŠ¡å™¨\nâŒ é«˜å¹¶å‘åº”ç”¨æœåŠ¡å™¨\nâŒ K8s / Docker å®¿ä¸»æœº\nâŒ SSD / NVMe å¯¿å‘½æ•æ„Ÿç¯å¢ƒ\näº”ã€æ­£ç¡®çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆä½ çœŸæ­£æƒ³è§£å†³çš„é—®é¢˜ï¼‰ ä½ â€œæƒ³å®šæœŸæ¸… cacheâ€ï¼Œæœ¬è´¨é€šå¸¸æ˜¯æƒ³è§£å†³è¿™äº›ğŸ‘‡\nğŸ¯ ç›®æ ‡ 1ï¼šé˜²æ­¢ OOM æ­£ç¡®åšæ³•ï¼š\nvm.swappiness = 1 vm.vfs_cache_pressure = 100 vm.overcommit_memory = 2 ğŸ‘‰ è®©å†…æ ¸ æŒ‰è§„åˆ™å›æ”¶ cacheï¼Œè€Œä¸æ˜¯æš´åŠ›æ¸…ç©º\nğŸ¯ ç›®æ ‡ 2ï¼šé¿å…è„é¡µå †ç§¯ vm.dirty_background_ratio = 5 vm.dirty_ratio = 15 vm.dirty_expire_centisecs = 3000 ğŸ‘‰ å¹³æ»‘å†™ç›˜ï¼Œè€Œä¸æ˜¯ sync æ´ªå³°\nğŸ¯ ç›®æ ‡ 3ï¼šè§‚æµ‹å†…å­˜ï¼Œè€Œä¸æ˜¯â€œæ¸…ç†â€ vmstat 1 sar -B 1 å…­ã€å¦‚æœä½ ä¸€å®šè¦ä¿ç•™ç±»ä¼¼è¡Œä¸ºï¼ˆä¸æ¨èï¼Œä½†ç»™ä½ å·¥ç¨‹çº§å®‰å…¨æ–¹æ¡ˆï¼‰ âœ… æœ€ä½ä¼¤å®³ç‰ˆæœ¬ sync echo 2 \u0026gt; /proc/sys/vm/drop_caches 2ï¼šåªé‡Šæ”¾ dentry / inode cache ä¸æ¸… Page Cache é£é™©å°å¾ˆå¤š ğŸ“Œ ä½†ä»ä¸å»ºè®®å®šæ—¶æ‰§è¡Œ\nä¸ƒã€æœ€ç»ˆæ€»ç»“ï¼ˆç»™ä½ ä¸€ä¸ªå¯ä»¥å†™è¿›è§„èŒƒçš„è¯ï¼‰ Linux çš„ Page Cache æ˜¯æ€§èƒ½ç»„ä»¶ï¼Œä¸æ˜¯åƒåœ¾ï¼›å®šæ—¶æ¸…ç†ç¼“å­˜ä¸æ˜¯ä¼˜åŒ–ï¼Œè€Œæ˜¯ç ´åå†…æ ¸å†…å­˜ç®¡ç†çš„è¡Œä¸ºï¼Œåªåº”åœ¨ç‰¹å®šæ’éšœæˆ–æµ‹è¯•åœºæ™¯ä¸‹äººå·¥ä½¿ç”¨ã€‚\n","description":"åœ¨æ‰€æœ‰ Linux æœåŠ¡å™¨ä¸Šæ¯å¤©å®šæ—¶æ‰§è¡Œä¸€æ¬¡ä»¥ä¸‹å‘½ä»¤ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿæœ‰ä»€ä¹ˆåˆ©å¼Šï¼Ÿ\nsync;sync;sync;sync;sync;sync;sync;sync;sync;sync echo 1 \u0026gt; /proc/sys/vm/drop_caches ç»“è®ºå…ˆè¡Œï¼ˆä¸€å¥è¯ç‰ˆï¼‰\nä¸å»ºè®®åœ¨æ‰€æœ‰ Linux æœåŠ¡å™¨ä¸Šæ¯å¤©å®šæ—¶æ‰§è¡Œ sync; echo 1 \u0026gt; /proc/sys/vm/drop_cachesï¼Œå®ƒä¸æ˜¯â€œä¼˜åŒ–â€ï¼Œè€Œæ˜¯ä¸€æ¬¡â€œäººä¸ºåˆ¶é€ çš„å†·å¯åŠ¨ I/O æŠ–åŠ¨â€ï¼Œåªæœ‰åœ¨æå°‘æ•°æ’éšœæˆ–æµ‹è¯•åœºæ™¯æ‰æœ‰ä»·å€¼ã€‚\nä¸‹é¢ç»™ä½ å·¥ç¨‹çº§ã€å¯è½åœ°çš„åˆ†æã€‚\nä¸€ã€è¿™ä¸¤æ¡å‘½ä»¤åˆ°åº•åšäº†ä»€ä¹ˆï¼ˆæ¾„æ¸…ä¸€ä¸ªå¸¸è§è¯¯è§£ï¼‰ 1ï¸âƒ£ syncï¼ˆä½ æ‰§è¡Œäº† 10 æ¬¡ï¼‰ sync ä½œç”¨ï¼š\nå°† è„é¡µï¼ˆdirty pagesï¼‰ åˆ·å†™åˆ°ç£ç›˜ æ˜¯ä¸€ä¸ª é˜»å¡è°ƒç”¨ å¤šæ¬¡æ‰§è¡Œ â‰ˆ ä¸€æ¬¡æ‰§è¡Œ ğŸ“Œ ç»“è®ºï¼š\n"},{"id":194,"href":"/database/elasticsearch/","title":"ElasticSearch","parent":"Database","content":"Directory List:\nElasticSearch FAQ EFLK æ—¥å¿—æ”¶é›†ç³»ç»Ÿ ElasticSearch åŸºç¡€æ•™ç¨‹ ElasticSearch æ ¸å¿ƒæ¦‚å¿µ ElasticSearch vs MongoDB ElasticSearch å†·çƒ­åˆ†ç¦» ElasticSearch åˆ†ç‰‡ ElasticSearch åˆ†ç‰‡æ•°è§„åˆ’ä¸è®¡ç®— ElasticSearch å¸¸ç”¨å‘½ä»¤ ElasticSearch æ•°æ®å¤‡ä»½ ElasticSearch æœ€ä½³å®è·µ ElasticSearch ç»å…¸é—®é¢˜ ElasticSearch èŠ‚ç‚¹è§’è‰² ElasticSearch è¿ç»´ ElasticSearch é›†ç¾¤ æ•°æ®åŒæ­¥æ–¹æ¡ˆ ","description":"Directory List:\nElasticSearch FAQ EFLK æ—¥å¿—æ”¶é›†ç³»ç»Ÿ ElasticSearch åŸºç¡€æ•™ç¨‹ ElasticSearch æ ¸å¿ƒæ¦‚å¿µ ElasticSearch vs MongoDB ElasticSearch å†·çƒ­åˆ†ç¦» ElasticSearch åˆ†ç‰‡ ElasticSearch åˆ†ç‰‡æ•°è§„åˆ’ä¸è®¡ç®— ElasticSearch å¸¸ç”¨å‘½ä»¤ ElasticSearch æ•°æ®å¤‡ä»½ ElasticSearch æœ€ä½³å®è·µ ElasticSearch ç»å…¸é—®é¢˜ ElasticSearch èŠ‚ç‚¹è§’è‰² ElasticSearch è¿ç»´ ElasticSearch é›†ç¾¤ æ•°æ®åŒæ­¥æ–¹æ¡ˆ "},{"id":195,"href":"/database/elasticsearch/elasticsearch-vs-mongodb/","title":"ElasticSearch vs MongoDB","parent":"ElasticSearch","content":"ä» å®šä½ -\u0026gt; æ•°æ®æ¨¡å‹ -\u0026gt; æŸ¥è¯¢èƒ½åŠ› -\u0026gt; ä¸€è‡´æ€§ -\u0026gt; æ€§èƒ½ -\u0026gt; è¿ç»´ -\u0026gt; å…¸å‹åœºæ™¯ ä¸ƒä¸ªç»´åº¦çš„å¯¹æ¯”æ€»ç»“ã€‚\nç»“è®º MongoDB æ˜¯é€šç”¨å‹æ–‡æ¡£æ•°æ®åº“ï¼Œè§£å†³â€œå­˜å‚¨ + äº‹åŠ¡ + æŸ¥è¯¢â€ï¼›\nElasticSearch æ˜¯æœç´¢ä¸åˆ†æå¼•æ“ï¼Œè§£å†³â€œå…¨æ–‡æ£€ç´¢ + å®æ—¶åˆ†æâ€ã€‚\näºŒè€…ä¸æ˜¯åŒä¸€ç±»äº§å“ï¼Œæ›´å¤šæ˜¯äº’è¡¥è€Œä¸æ˜¯æ›¿ä»£ã€‚\nä¸€ã€äº§å“å®šä½ï¼ˆæœ¬è´¨å·®å¼‚ï¼‰ ç»´åº¦ ElasticSearch MongoDB æœ¬è´¨ æœç´¢ / åˆ†æå¼•æ“ æ–‡æ¡£æ•°æ®åº“ åº•å±‚æ ¸å¿ƒ Luceneï¼ˆå€’æ’ç´¢å¼•ï¼‰ B-Tree / WiredTiger è®¾è®¡ç›®æ ‡ å¿«é€Ÿæœç´¢ + èšåˆ å¯é å­˜å‚¨ + æŸ¥è¯¢ æ˜¯å¦èƒ½åšä¸»åº“ âŒ ä¸æ¨è âœ… æ¨è äºŒã€æ•°æ®æ¨¡å‹å¯¹æ¯” ç»´åº¦ ES MongoDB æ•°æ®å•å…ƒ Document Document æ•°æ®æ ¼å¼ JSON BSON Schema å¼ºï¼ˆmappingï¼‰ å¼± / å¯é€‰ ä¸»é”® _id _id è¡¨ç»“æ„å˜æ›´ é‡å»ºç´¢å¼• åœ¨çº¿ä¿®æ”¹ å…³é”®ç‚¹\nESï¼šSchema-on-writeï¼ˆå†™å…¥æ—¶å®šç»“æ„ï¼‰ MongoDBï¼šSchema-on-readï¼ˆæ›´çµæ´»ï¼‰ ä¸‰ã€æŸ¥è¯¢èƒ½åŠ›ï¼ˆæœ€æ ¸å¿ƒåŒºåˆ«ï¼‰ 1ï¸âƒ£ å…¨æ–‡æ£€ç´¢èƒ½åŠ› èƒ½åŠ› ES MongoDB åˆ†è¯ å¼º å¼± ç›¸å…³åº¦è¯„åˆ† BM25 ç®€å• é«˜äº® åŸç”Ÿæ”¯æŒ å—é™ æ¨¡ç³Šæœç´¢ å¼º ä¸€èˆ¬ ğŸ‘‰ åªè¦æ¶‰åŠâ€œæœç´¢ä½“éªŒâ€ï¼ŒES å®Œèƒœ\n2ï¸âƒ£ ç»“æ„åŒ–æŸ¥è¯¢ èƒ½åŠ› ES MongoDB ç²¾ç¡®åŒ¹é… å¯ å¼º èŒƒå›´æŸ¥è¯¢ å¯ å¼º å¤æ‚æ¡ä»¶ æœ‰é™åˆ¶ å¼º JOIN âŒ $lookup ğŸ‘‰ å¤æ‚ä¸šåŠ¡æŸ¥è¯¢ MongoDB æ›´åˆé€‚\nå››ã€äº‹åŠ¡ \u0026amp; ä¸€è‡´æ€§ ç»´åº¦ ES MongoDB äº‹åŠ¡ âŒ âœ…ï¼ˆå¤šæ–‡æ¡£ï¼‰ ACID âŒ âœ… ä¸€è‡´æ€§ æœ€ç»ˆä¸€è‡´ å¼ºä¸€è‡´ æ›´æ–°æœºåˆ¶ delete + insert in-place ç»“è®º\nä¸èƒ½ç”¨ ES æ‰¿è½½æ ¸å¿ƒä¸šåŠ¡å†™ MongoDB å¯ä»¥ä½œä¸ºä¸»ä¸šåŠ¡åº“ äº”ã€æ€§èƒ½æ¨¡å‹å·®å¼‚ å†™å…¥æ¨¡å‹ ES MongoDB å†™å…¥è·¯å¾„ buffer -\u0026gt; segment WAL -\u0026gt; B-Tree æ›´æ–° å†™æ”¾å¤§ åŸåœ°æ›´æ–° æ‰¹é‡å†™ éå¸¸å¼º å¼º æŸ¥è¯¢æ¨¡å‹ ES MongoDB å¹¶å‘æœç´¢ æå¼º ä¸€èˆ¬ èšåˆåˆ†æ æå¼º ä¸­ æ·±åº¦åˆ†é¡µ å¼± å¼º å…­ã€æ‰©å±•æ€§ä¸é›†ç¾¤ ç»´åº¦ ES MongoDB åˆ†ç‰‡ å¿…é¡» å¯é€‰ å‰¯æœ¬ ç´¢å¼•çº§ é›†åˆçº§ æ‰©å®¹ å¤©ç„¶ æˆæœ¬è¾ƒé«˜ å†å¹³è¡¡ è‡ªåŠ¨ æ‰‹åŠ¨å¹²é¢„å¤š ä¸ƒã€è¿ç»´å¤æ‚åº¦ ç»´åº¦ ES MongoDB JVM è°ƒä¼˜ å¿…é¡» ä¸éœ€è¦ å†…å­˜ç®¡ç† å¤æ‚ ç®€å• æ•°æ®è†¨èƒ€ ä¸¥é‡ å¯æ§ å¤‡ä»½æ¢å¤ Snapshot mongodump / oplog ğŸ‘‰ ES è¿ç»´å¤æ‚åº¦æ˜æ˜¾æ›´é«˜\nå…«ã€å…¸å‹ä½¿ç”¨åœºæ™¯ï¼ˆé€‰å‹å…³é”®ï¼‰ ElasticSearch é€‚åˆ\nå…¨æ–‡æœç´¢ æ—¥å¿— / ç›‘æ§ / APM å¤æ‚èšåˆåˆ†æ æœç´¢æ¨è å®æ—¶åˆ†æ MongoDB é€‚åˆ\nä¸»ä¸šåŠ¡æ•°æ®å­˜å‚¨ é«˜å¹¶å‘å†™å…¥ çµæ´»æ•°æ®ç»“æ„ äº‹åŠ¡å‹ä¸šåŠ¡ ç”¨æˆ·ç”»åƒ ä¹ã€ç»å…¸æ¶æ„æ¨¡å¼ï¼ˆç”Ÿäº§å¸¸è§ï¼‰ MySQL / MongoDB â†“ Debezium â†“ Kafka â†“ Elasticsearchï¼ˆæœç´¢ / åˆ†æï¼‰ ğŸ‘‰ MongoDB / MySQL åšä¸»åº“ï¼ŒES åšæœç´¢å¼•æ“\nåã€é€‰å‹ éœ€æ±‚ é€‰æ‹© å¼ºäº‹åŠ¡ MongoDB æœç´¢ä½“éªŒ ElasticSearch æ—¥å¿—åˆ†æ ElasticSearch ä¸»ä¸šåŠ¡æ•°æ® MongoDB ä¸¤è€…å…¼å¾— MongoDB + ES åä¸€ã€æ€»ç»“ ElasticSearch å’Œ MongoDB çš„æ ¸å¿ƒåŒºåˆ«åœ¨äºå®šä½ä¸åŒã€‚\nMongoDB æ˜¯é€šç”¨å‹æ–‡æ¡£æ•°æ®åº“ï¼Œæ”¯æŒäº‹åŠ¡å’Œå¼ºä¸€è‡´æ€§ï¼Œé€‚åˆæ‰¿è½½ä¸»ä¸šåŠ¡æ•°æ®ï¼›\nElasticSearch æ˜¯åŸºäºå€’æ’ç´¢å¼•çš„æœç´¢ä¸åˆ†æå¼•æ“ï¼Œæ“…é•¿å…¨æ–‡æ£€ç´¢å’Œèšåˆåˆ†æï¼Œä½†ä¸é€‚åˆåšä¸»åº“ã€‚\nåœ¨å®é™…æ¶æ„ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ MongoDB æˆ– MySQL ä½œä¸ºä¸»å­˜å‚¨ï¼Œå†åŒæ­¥æ•°æ®åˆ° ElasticSearch æä¾›æœç´¢èƒ½åŠ›ã€‚\n","description":"ä» å®šä½ -\u0026gt; æ•°æ®æ¨¡å‹ -\u0026gt; æŸ¥è¯¢èƒ½åŠ› -\u0026gt; ä¸€è‡´æ€§ -\u0026gt; æ€§èƒ½ -\u0026gt; è¿ç»´ -\u0026gt; å…¸å‹åœºæ™¯ ä¸ƒä¸ªç»´åº¦çš„å¯¹æ¯”æ€»ç»“ã€‚\nç»“è®º MongoDB æ˜¯é€šç”¨å‹æ–‡æ¡£æ•°æ®åº“ï¼Œè§£å†³â€œå­˜å‚¨ + äº‹åŠ¡ + æŸ¥è¯¢â€ï¼›\nElasticSearch æ˜¯æœç´¢ä¸åˆ†æå¼•æ“ï¼Œè§£å†³â€œå…¨æ–‡æ£€ç´¢ + å®æ—¶åˆ†æâ€ã€‚\näºŒè€…ä¸æ˜¯åŒä¸€ç±»äº§å“ï¼Œæ›´å¤šæ˜¯äº’è¡¥è€Œä¸æ˜¯æ›¿ä»£ã€‚\nä¸€ã€äº§å“å®šä½ï¼ˆæœ¬è´¨å·®å¼‚ï¼‰ ç»´åº¦ ElasticSearch MongoDB æœ¬è´¨ æœç´¢ / åˆ†æå¼•æ“ æ–‡æ¡£æ•°æ®åº“ åº•å±‚æ ¸å¿ƒ Luceneï¼ˆå€’æ’ç´¢å¼•ï¼‰ B-Tree / WiredTiger è®¾è®¡ç›®æ ‡ å¿«é€Ÿæœç´¢ + èšåˆ å¯é å­˜å‚¨ + æŸ¥è¯¢ æ˜¯å¦èƒ½åšä¸»åº“ âŒ ä¸æ¨è âœ… æ¨è äºŒã€æ•°æ®æ¨¡å‹å¯¹æ¯” ç»´åº¦ ES MongoDB æ•°æ®å•å…ƒ Document Document æ•°æ®æ ¼å¼ JSON BSON Schema å¼ºï¼ˆmappingï¼‰ å¼± / å¯é€‰ ä¸»é”® _id _id è¡¨ç»“æ„å˜æ›´ é‡å»ºç´¢å¼• åœ¨çº¿ä¿®æ”¹ å…³é”®ç‚¹\n"},{"id":196,"href":"/database/elasticsearch/hotwarmcold/","title":"ElasticSearch å†·çƒ­åˆ†ç¦»","parent":"ElasticSearch","content":" ğŸ§ŠğŸ”¥ ElasticSearch å†·çƒ­åˆ†ç¦»ï¼ˆHotâ€“Warmâ€“Cold/Hotâ€“Warmâ€“Coldâ€“Frozenï¼‰ å†·çƒ­åˆ†ç¦» æ˜¯ ES é’ˆå¯¹â€œä¸åŒç”Ÿå‘½å‘¨æœŸçš„æ•°æ®â€åœ¨ â€œä¸åŒæ€§èƒ½ã€ä¸åŒæˆæœ¬çš„èŠ‚ç‚¹â€ ä¸Šå­˜å‚¨å’ŒæŸ¥è¯¢çš„æ¶æ„è®¾è®¡ã€‚\næ ¸å¿ƒç›®çš„åªæœ‰ä¸¤ä¸ªï¼š\næé«˜æ€§èƒ½ï¼ˆçƒ­æ•°æ®æ”¾åœ¨é«˜æ€§èƒ½èŠ‚ç‚¹ï¼‰ é™ä½æˆæœ¬ï¼ˆå†·æ•°æ®æ”¾åœ¨ä½æˆæœ¬èŠ‚ç‚¹ï¼‰ 1. ä¸ºä»€ä¹ˆè¦å†·çƒ­åˆ†ç¦» ES æ˜¯åˆ†å¸ƒå¼æœç´¢æ•°æ®åº“ï¼š\nå†™å…¥æˆæœ¬ç”± CPUã€SSDã€å†…å­˜ã€IOPS å†³å®š æœç´¢æˆæœ¬ç”± CPUã€å†…å­˜ã€ç¼“å­˜ã€SSD å†³å®š éšç€æ—¶é—´æ¨ç§»ï¼š\næ•°æ®ç±»å‹ æŸ¥è¯¢é¢‘ç‡ å†™å…¥é¢‘ç‡ æ€§èƒ½è¦æ±‚ æˆæœ¬ çƒ­æ•°æ® é«˜ é«˜é¢‘å†™ å¼ºæ€§èƒ½ é«˜ æ¸©æ•°æ® ä¸­ æ— å†™ ä¸­ ä¸­ å†·æ•°æ® ä½ æ— å†™ ä½ ä½ å†»ç»“æ•°æ® å‡ ä¹æ— æŸ¥è¯¢ æ— å†™ æœ€ä½ æœ€ä½ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ ğŸ‘‰ æ‰€ä»¥é›†ç¾¤é€šå¸¸æŒ‰ Hot -\u0026gt; Warm -\u0026gt; Cold -\u0026gt; Frozen åˆ†å±‚ã€‚\n2. ElasticSearch å†·çƒ­èŠ‚ç‚¹çš„åŒºåˆ« 2.1 Hotï¼ˆçƒ­èŠ‚ç‚¹ï¼‰ ç”¨äºï¼š\né«˜å¹¶å‘å†™å…¥ï¼ˆlogstashã€beatsã€ingest pipelineï¼‰ é«˜é¢‘æœç´¢ indexingã€refreshã€merge æ“ä½œ èŠ‚ç‚¹ç‰¹å¾ï¼š\nğŸ”¥ é«˜ CPU ğŸ”¥ å¤§å†…å­˜ ğŸ”¥ SSDï¼ˆNVMe æœ€ä½³ï¼‰ ğŸ”¥ è¾ƒå°‘ shard æ•°é‡ 2.2 Warmï¼ˆæ¸©èŠ‚ç‚¹ï¼‰ ç”¨äºï¼š\nå·²å†™å…¥å®Œæˆçš„æ•°æ® æŸ¥è¯¢è¾ƒå°‘ï¼Œä½†å¶å°”ä¼šæŸ¥è¯¢ èŠ‚ç‚¹ç‰¹å¾ï¼š\nä¸­ç­‰ CPU æ™®é€š SSD æˆ– SATA SSD æ›´å¤šç£ç›˜å®¹é‡ 2.3 Coldï¼ˆå†·èŠ‚ç‚¹ï¼‰ ç”¨äºï¼š\nåŸºæœ¬ä¸ä¼šæŸ¥è¯¢çš„å†å²æ•°æ® åªåœ¨å¶å°”éœ€è¦å½’æ¡£æŸ¥è¯¢æ—¶è®¿é—® èŠ‚ç‚¹ç‰¹å¾ï¼š\næœºæ¢°ç¡¬ç›˜ï¼ˆHDDï¼‰ è¾ƒå°‘ CPU/å†…å­˜ å¤§å®¹é‡ç£ç›˜ï¼ˆä¾‹å¦‚ 8TB/12TBï¼‰ 2.4 Frozenï¼ˆå†»ç»“å±‚ï¼‰ ç”¨äºï¼š\nå‡ ä¹æ°¸è¿œä¸æŸ¥ï¼Œä½†éœ€è¦ä¿ç•™ï¼ˆæ³•è§„/å®¡è®¡ï¼‰ æ•°æ®å­˜æ”¾åœ¨å¯¹è±¡å­˜å‚¨ï¼š S3 MinIO OSS å¥½å¤„ï¼š\næˆæœ¬æœ€ä½ ES é€šè¿‡ searchable snapshot æ–¹å¼è®¿é—® 3. å¦‚ä½•å®ç°å†·çƒ­åˆ†ç¦»ï¼ˆElasticSearch é…ç½®æ–¹å¼ï¼‰ ES ä½¿ç”¨ èŠ‚ç‚¹è§’è‰²ï¼ˆNode Rolesï¼‰ + ILMï¼ˆIndex Lifecycle Managementï¼‰ æ¥å®ç°ã€‚\n3.1 é…ç½®èŠ‚ç‚¹è§’è‰²ï¼ˆé‡ç‚¹ï¼‰ åœ¨ elasticsearch.yml ä¸­æ·»åŠ ï¼š\nğŸ”¥ çƒ­èŠ‚ç‚¹\nnode.roles: [\u0026#34;data_hot\u0026#34;, \u0026#34;ingest\u0026#34;] ğŸŸ¡ æ¸©èŠ‚ç‚¹\nnode.roles: [\u0026#34;data_warm\u0026#34;] ğŸ§Š å†·èŠ‚ç‚¹\nnode.roles: [\u0026#34;data_cold\u0026#34;] â„ï¸ å†»ç»“èŠ‚ç‚¹\nnode.roles: [\u0026#34;data_frozen\u0026#34;] 3.2 ç´¢å¼•ç”Ÿå‘½å‘¨æœŸï¼ˆILMï¼‰ç­–ç•¥ ä¸€ä¸ªå…¸å‹çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š\nHotï¼ˆ7 å¤©ï¼‰-\u0026gt; Warmï¼ˆ30 å¤©ï¼‰-\u0026gt; Coldï¼ˆ180 å¤©ï¼‰-\u0026gt; Frozenï¼ˆ1 å¹´ï¼‰-\u0026gt; Deleteï¼ˆ1 å¹´+ï¼‰ ç¤ºä¾‹ï¼š\nPUT _ilm/policy/logs_policy { \u0026#34;policy\u0026#34;: { \u0026#34;phases\u0026#34;: { \u0026#34;hot\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;rollover\u0026#34;: { \u0026#34;max_size\u0026#34;: \u0026#34;30gb\u0026#34;, \u0026#34;max_age\u0026#34;: \u0026#34;7d\u0026#34; } } }, \u0026#34;warm\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;allocate\u0026#34;: { \u0026#34;include\u0026#34;: { \u0026#34;data\u0026#34;: \u0026#34;warm\u0026#34; } }, \u0026#34;shrink\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 1 }, \u0026#34;forcemerge\u0026#34;: { \u0026#34;max_num_segments\u0026#34;: 1 } } }, \u0026#34;cold\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;allocate\u0026#34;: { \u0026#34;include\u0026#34;: { \u0026#34;data\u0026#34;: \u0026#34;cold\u0026#34; } } } }, \u0026#34;frozen\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;searchable_snapshot\u0026#34;: { \u0026#34;snapshot_repository\u0026#34;: \u0026#34;s3_repo\u0026#34; } } }, \u0026#34;delete\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;delete\u0026#34;: {} } } } } } 4. å®Œæ•´çš„æ•°æ®å­˜å‚¨æ¶æ„ç¤ºä¾‹ ğŸ”¥ Hot â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” NVMe SSD / å¼º CPU å†™å…¥ + é«˜é¢‘æœç´¢ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ rollover â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Warmï¼ˆSSDï¼‰ å¶å°”æŸ¥è¯¢ï¼Œä½å†™å…¥ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ move â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Coldï¼ˆHDD å¤§å®¹é‡ï¼‰ å¶å°”å½’æ¡£æŸ¥è¯¢ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ snapshot â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Frozenï¼ˆS3 / MinIOï¼‰ â”‚ â”‚ æœ€ä½æˆæœ¬ï¼Œå‡ ä¹ä¸æŸ¥ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 5. å†·çƒ­åˆ†ç¦»çš„æœ€ä½³å®è·µ 1. çƒ­èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ SSD å¦åˆ™å†™å…¥å’Œ refresh ä¼šéå¸¸æ…¢ã€‚\n2. çƒ­èŠ‚ç‚¹å°½é‡å°‘ shard æ¨èï¼š\n1 ä¸ª primaryï¼ˆæ—¥å¿—ç±»ï¼‰ å‰¯æœ¬æ•° 1 rollover æ§åˆ¶ shard å¤§å° â‰¤ 30GBï¼ˆæœ€ä½³ï¼‰ 3. Warm èŠ‚ç‚¹å¼€å¯ force mergeï¼ˆå‡å°‘ segmentï¼‰ é¿å… segment å¤ªå¤šå¯¼è‡´æŸ¥è¯¢å˜æ…¢ã€‚\n4. Cold èŠ‚ç‚¹ä½¿ç”¨ HDD è¶³å¤Ÿ æ•ˆç‡ä¼šä¸‹é™ï¼Œä½†å†å²æŸ¥è¯¢å¯æ¥å—ã€‚\n5. Frozen å°½é‡ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆS3 / MinIOï¼‰ éå¸¸é€‚åˆé•¿æœŸå½’æ¡£ã€‚\n6. å†·çƒ­åˆ†ç¦»å¸¸è§é—®é¢˜ é—®é¢˜ åŸå›  è§£å†³ shard åœ¨çƒ­ã€æš–èŠ‚ç‚¹ä¹±è·‘ æ²¡è®¾ç½® node roles æˆ– ILM é…ç½® allocate ç´¢å¼•æ²¡æœ‰è‡ªåŠ¨ rollover æ²¡ç»‘å®š ILM è®¾ç½® index template Warm èŠ‚ç‚¹æŸ¥è¯¢æ…¢ segment å¤š force_merge Cold èŠ‚ç‚¹å‹åŠ›å¤§ æŸ¥è¯¢å¤ªå¤š å¢åŠ  warm èŠ‚ç‚¹æˆ–ç¼©çŸ­ warm æ—¶é—´ Frozen ç´¢å¼•æ‰“å¼€ç‰¹åˆ«æ…¢ S3 æ‹‰æ•°æ® åˆç†è®¾ç½® retention ","description":" ğŸ§ŠğŸ”¥ ElasticSearch å†·çƒ­åˆ†ç¦»ï¼ˆHotâ€“Warmâ€“Cold/Hotâ€“Warmâ€“Coldâ€“Frozenï¼‰ å†·çƒ­åˆ†ç¦» æ˜¯ ES é’ˆå¯¹â€œä¸åŒç”Ÿå‘½å‘¨æœŸçš„æ•°æ®â€åœ¨ â€œä¸åŒæ€§èƒ½ã€ä¸åŒæˆæœ¬çš„èŠ‚ç‚¹â€ ä¸Šå­˜å‚¨å’ŒæŸ¥è¯¢çš„æ¶æ„è®¾è®¡ã€‚\næ ¸å¿ƒç›®çš„åªæœ‰ä¸¤ä¸ªï¼š\næé«˜æ€§èƒ½ï¼ˆçƒ­æ•°æ®æ”¾åœ¨é«˜æ€§èƒ½èŠ‚ç‚¹ï¼‰ é™ä½æˆæœ¬ï¼ˆå†·æ•°æ®æ”¾åœ¨ä½æˆæœ¬èŠ‚ç‚¹ï¼‰ 1. ä¸ºä»€ä¹ˆè¦å†·çƒ­åˆ†ç¦» ES æ˜¯åˆ†å¸ƒå¼æœç´¢æ•°æ®åº“ï¼š\nå†™å…¥æˆæœ¬ç”± CPUã€SSDã€å†…å­˜ã€IOPS å†³å®š æœç´¢æˆæœ¬ç”± CPUã€å†…å­˜ã€ç¼“å­˜ã€SSD å†³å®š éšç€æ—¶é—´æ¨ç§»ï¼š\næ•°æ®ç±»å‹ æŸ¥è¯¢é¢‘ç‡ å†™å…¥é¢‘ç‡ æ€§èƒ½è¦æ±‚ æˆæœ¬ çƒ­æ•°æ® é«˜ é«˜é¢‘å†™ å¼ºæ€§èƒ½ é«˜ æ¸©æ•°æ® ä¸­ æ— å†™ ä¸­ ä¸­ å†·æ•°æ® ä½ æ— å†™ ä½ ä½ å†»ç»“æ•°æ® å‡ ä¹æ— æŸ¥è¯¢ æ— å†™ æœ€ä½ æœ€ä½ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ ğŸ‘‰ æ‰€ä»¥é›†ç¾¤é€šå¸¸æŒ‰ Hot -\u0026gt; Warm -\u0026gt; Cold -\u0026gt; Frozen åˆ†å±‚ã€‚\n"},{"id":197,"href":"/database/elasticsearch/shard/","title":"ElasticSearch åˆ†ç‰‡","parent":"ElasticSearch","content":"ES çš„æ€§èƒ½ã€ç¨³å®šæ€§ã€æ‰©å±•æ€§ï¼Œ90% å–å†³äºåˆ†ç‰‡è§„åˆ’ã€‚\n1. ä»€ä¹ˆæ˜¯åˆ†ç‰‡ï¼ˆShardï¼‰ ElasticSearch ä¸€ä¸ªç´¢å¼•ç”±å¤šä¸ªåˆ†ç‰‡ç»„æˆï¼š\nç±»å‹ åŠŸèƒ½ Primary Shardï¼ˆä¸»åˆ†ç‰‡ï¼‰ å®é™…å†™å…¥æ•°æ® Replica Shardï¼ˆå‰¯æœ¬ï¼‰ å®¹ç¾ + æé«˜æŸ¥è¯¢æ€§èƒ½ æ¯ä¸ªåˆ†ç‰‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Lucene Indexï¼ˆåº•å±‚æœ€å°å•å…ƒï¼‰ã€‚\nES åªåš â€œåˆ†å¸ƒå¼è°ƒåº¦â€ï¼ŒçœŸå®å­˜å‚¨ç”± Lucene å®Œæˆã€‚\n2. ä¸ºä»€ä¹ˆåˆ†ç‰‡éå¸¸å…³é”®ï¼Ÿ é”™è¯¯çš„åˆ†ç‰‡æ•°é‡ä¼šå¯¼è‡´ï¼š\næ€§èƒ½å´©æºƒï¼ˆå¤ªå¤š shard -\u0026gt; JVM å†…å­˜æš´æ¶¨ï¼‰ æŸ¥è¯¢å˜æ…¢ï¼ˆBroadcast æŸ¥è¯¢ï¼‰ é›†ç¾¤é‡å¯æ…¢ã€æ¢å¤æ…¢ æ•°æ®è¿ç§»æ…¢ å†™å…¥ååä¸‹é™ é›†ç¾¤é¢‘ç¹ä¸ç¨³å®šï¼ˆyellowã€redï¼‰ åˆ†ç‰‡åæ¨¡å¼æ˜¯ ES æœ€å¸¸è§çš„é›†ç¾¤æ•…éšœæºå¤´ã€‚\n3. åˆ†ç‰‡æ•°é‡å¦‚ä½•å†³å®šï¼Ÿ æ ¸å¿ƒå…¬å¼ï¼š\nâœ… æ¯ä¸ª Shard çš„ç†æƒ³å¤§å°ï¼š30 ~ 50GB\nåŸå› ï¼š\nåˆ†ç‰‡å¤ªå°ï¼šæµªè´¹å†…å­˜ã€CPUã€filehandle åˆ†ç‰‡å¤ªå¤§ï¼šè¿ç§»æ…¢ã€æ¢å¤æ…¢ã€merge å·¨æ…¢ âœ… åˆ†ç‰‡æ•°é‡è®¡ç®—å…¬å¼\nå‡è®¾ä¸€ä¸ªç´¢å¼•æœªæ¥ 1 å¹´æœ€å¤šï¼š\næ•°æ®ï¼š2 TB é‡‡ç”¨æ¯ shard 40GB 2000GB / 40GB = 50 ä¸ª shard å¦‚æœé›†ç¾¤æœ‰ 3 ä¸ª data èŠ‚ç‚¹ï¼š\næ¯èŠ‚ç‚¹ â‰ˆ 16â€“17 ä¸ª shardï¼ˆæ­£å¸¸ï¼‰ 4. æ­£ç¡®é€‰æ‹©åˆ†ç‰‡æ•°é‡ï¼ˆç®€æ´ç‰ˆï¼‰ æ•°æ®é‡ï¼ˆç´¢å¼•ï¼‰ æ¨è primary shard \u0026lt; 50GB 1 shardï¼ˆæœ€ä½³ï¼‰ 50â€“200GB 2â€“4 shards 200â€“500GB 4â€“10 shards \u0026gt;500GB 10+ shardsï¼ˆæŒ‰ 40GB/shard æˆ– ILM æ»šåŠ¨ï¼‰ 5. åˆ†ç‰‡æ•°é‡çš„çœŸå®å½±å“ 5.1 æŸ¥è¯¢æ€§èƒ½ ä¾‹å¦‚ä½ æœ‰ 10 shardï¼Œä¸€ä¸ªæŸ¥è¯¢ä¼šå¹¿æ’­åˆ°æ‰€æœ‰ shardï¼š\n10 ä¸ª shard -\u0026gt; OK 2000 ä¸ª shard -\u0026gt; GGï¼ˆçˆ†ç‚¸å¼å˜æ…¢ï¼‰ 5.2 å†…å­˜å ç”¨ï¼ˆJVM heapï¼‰ æ¯ shard éƒ½éœ€è¦ï¼š\næ–‡ä»¶å¥æŸ„ï¼ˆfile handleï¼‰ JVM segment metadata Lucene ç´¢å¼•ç»“æ„ ç»“è®ºï¼š\nShard ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¶Šå°‘è¶Šå¼ºã€‚\n5.3 å†™å…¥åå æ›´å¤š shard = æ›´å¤š Lucene ç´¢å¼• -\u0026gt; æ…¢ã€‚\n5.4 Merge å¼€é”€ Lucene å†™å…¥æ—¶ä¼šä¸æ–­äº§ç”Ÿå° segmentï¼Œåç»­è‡ªåŠ¨ mergeã€‚\nShard è¶Šå¤š -\u0026gt; merge è¶Šå¤š -\u0026gt; IO å»¶è¿Ÿæš´å¢ã€‚\n6. Replicaï¼ˆå‰¯æœ¬ï¼‰è§„åˆ’ å‰¯æœ¬ = é«˜å¯ç”¨ + æŸ¥è¯¢è¯»è´Ÿè½½èƒ½åŠ›\nå»ºè®®ï¼š\nåœºæ™¯ å‰¯æœ¬ å†™å…¥å¯†é›†ï¼ˆæ—¥å¿—ï¼‰ 0ï¼ˆå†™å…¥é«˜å³°æ—¶ï¼‰ï¼Œæ­£å¸¸æ—¶ 1 æ™®é€šä¸šåŠ¡ 1 é«˜è¯»å–é‡ï¼ˆæœç´¢ç±»ï¼‰ 2â€“3 7. åˆ†ç‰‡åˆ†é…ä¸èŠ‚ç‚¹è§„åˆ’ 7.1 æ¯å°æœºå™¨çš„ shard æ•°é‡æ§åˆ¶ ç»éªŒå€¼ï¼š\næ¯èŠ‚ç‚¹ shard æ•° â‰¤ 20 Ã— CPUæ ¸å¿ƒæ•° ä¾‹å¦‚ï¼š\n8 æ ¸èŠ‚ç‚¹ï¼šæœ€å¤š â‰ˆ 160 shards 16 æ ¸èŠ‚ç‚¹ï¼šæœ€å¤š â‰ˆ 320 shards è¶…è¿‡è¿™ä¸ªé€šå¸¸ä¼šæŠ–åŠ¨ç”šè‡³é¢‘ç¹ GCã€‚\n7.2 Hot/Warm æ¶æ„ï¼ˆæ¨èï¼‰ é€‚åˆæ—¥å¿—ç³»ç»Ÿã€ES å®˜æ–¹æ¨èï¼š\nHot Nodeï¼šSSDï¼Œå­˜æ”¾æœ€è¿‘ 7 å¤© Warm Nodeï¼šæ™®é€š SSDï¼Œå¤§é‡æ•°æ® Cold Nodeï¼šä½æˆæœ¬å­˜å‚¨ 8. shard resizingï¼ˆåŠ¨æ€è°ƒæ•´åˆ†ç‰‡ï¼‰ ES æ”¯æŒï¼š\n8.1 shrinkï¼ˆç¼©å° shard æ•°ï¼‰ æ¡ä»¶ï¼š\nåªèƒ½ä»å¤šä¸ª shard -\u0026gt; 1 shard ç´¢å¼•å¿…é¡»æ˜¯åªè¯» ç¤ºä¾‹ï¼š\nPOST logs-2025-01/_shrink/logs-2025-01-single 8.2 splitï¼ˆå¢åŠ  shardsï¼‰ æ¡ä»¶ï¼š\nåŸ shard æ•°é‡å¿…é¡»æ˜¯æ‰©å¤§åçš„æ•´é™¤å…³ç³» ä¾‹å¦‚ 2 -\u0026gt; 4 -\u0026gt; 8 å¯ä»¥ï¼Œä½† 3 -\u0026gt; 5 ä¸è¡Œã€‚\n9. æ»šåŠ¨ç´¢å¼•ï¼ˆRollOverï¼‰æ˜¯æœ€å¥½çš„åˆ†ç‰‡ç®¡ç†æ–¹æ³• é€‚ç”¨äºæ—¥å¿—ã€è®¢å•ã€è¡Œä¸ºæ•°æ®ï¼š\nä½¿ç”¨ ILMï¼š\nå½“ index.size \u0026gt; 40GB -\u0026gt; è‡ªåŠ¨ rollover ä¼˜ç‚¹ï¼š\nä¸å¿…ä¸€æ¬¡æ€§è§„åˆ’æ— é™å¤§çš„åˆ†ç‰‡æ•° æ¯å¤©/æ¯å‘¨ä¸€ä¸ªç´¢å¼•ï¼Œå¤©ç„¶åˆ†ç‰‡ æ•°æ®å¯æŒ‰ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åˆ é™¤ï¼ˆdelete phaseï¼‰ 10. å¸¸è§çš„åˆ†ç‰‡åæ¨¡å¼ï¼ˆå¿…é¡»é¿å…ï¼‰ âŒ åæ¨¡å¼ å±å®³ ç»™æ¯ä¸ªç”¨æˆ·å»ºä¸€ä¸ª index field explosion + shard explosion ç»™æ¯ä¸ªç”¨æˆ·å»ºä¸€ä¸ª shard ç›´æ¥çˆ†ç‚¸ 1TB æ•°æ®ç”¨ 1 shard è¿ç§»ç¾éš¾ ä¸€ä¸ªç´¢å¼• 2000 shards æŸ¥è¯¢ã€å†…å­˜å…¨éƒ¨å´©æºƒ é¢‘ç¹ splitã€shrink shard ä¼šå¯¼è‡´ä¸­æ–­å’Œæ€§èƒ½ä¸‹é™ log/behavior ä¸æŒ‰æ—¥æœŸåˆ‡åˆ† å·¨æ— éœ¸ shard ES å½“ OLTP ç”¨ å¤§é‡å†™å…¥ + åˆ†ç‰‡é¢‘ç¹æ›´æ–°ç¾éš¾ 11. å¦‚ä½•ä¸ºä½ çš„ä¸šåŠ¡å†³å®šåˆ†ç‰‡æ•°ï¼Ÿï¼ˆæ¨¡æ¿ï¼‰ ä½ é€šå¸¸ä½¿ç”¨ FastAPI + PostgreSQLï¼Œå½“æ•°æ®åŒæ­¥åˆ° ES ç”¨äºæœç´¢æ—¶ï¼Œå¸¸è§åœºæ™¯ï¼š\nåœºæ™¯ Aï¼šå•†å“ã€æ–‡ç« ã€ç”¨æˆ·æœç´¢ï¼ˆç»å…¸ä¸šåŠ¡ï¼‰ æ¨èï¼š\næ¯ä¸ªç´¢å¼•ä½¿ç”¨ 1â€“3 shards æ¯ shard ç›®æ ‡å¤§å° 20â€“40GB å‰¯æœ¬ = 1 åœºæ™¯ Bï¼šæ—¥å¿— / è¡Œä¸ºæ•°æ®ï¼ˆå¸¸ç”¨ï¼‰ é‡‡ç”¨ï¼š\næŒ‰å¤©æˆ–æŒ‰å‘¨æ»šåŠ¨ æ¯ä¸ªç´¢å¼• 1 shardï¼ˆæœ€ä½³ï¼ï¼‰ refresh_interval = 30s åœºæ™¯ Cï¼šå‘é‡ç´¢å¼•ï¼ˆdense_vector + knnï¼‰ ç»´åº¦ 768+ æ—¶æ¯ shard æ§åˆ¶ 20GB ä»¥ä¸‹ shard ä¸å®œå¤šï¼ˆknn æ˜¯æ¯ shard éƒ½è®¡ç®—ï¼‰ ç¬”è®° ElasticSearch ä¸»åˆ†ç‰‡æ•°ï¼ˆnumber_of_shardsï¼‰åˆ›å»ºåæ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œéœ€é€šè¿‡ _reindex æˆ– _split API é‡å»ºç´¢å¼•ï¼›ä½†å‰¯æœ¬æ•°ï¼ˆnumber_of_replicasï¼‰å¯ä»¥åŠ¨æ€è°ƒæ•´ã€‚\nåˆ†ç‰‡ç±»å‹åŠè°ƒæ•´æ–¹å¼ ä¸»åˆ†ç‰‡ (Primary Shard)ï¼š\nä¸å¯ç›´æ¥ä¿®æ”¹ï¼šä¸€æ—¦ç´¢å¼•åˆ›å»ºï¼Œä¸»åˆ†ç‰‡æ•°é‡å›ºå®šï¼Œå› ä¸ºæ•°æ®è·¯ç”±åŸºäºæ­¤ï¼ˆ_id hash % shardsï¼‰ã€‚\nå˜é€šæ–¹æ³•ï¼š\nä½¿ç”¨ _reindex API å°†æ•°æ®è¿ç§»åˆ°æ–°ç´¢å¼•ï¼ˆæ–°åˆ†ç‰‡æ•°ï¼‰ã€‚ å¯¹äºæŸäº›ç‰¹å®šæƒ…å†µï¼Œå¯ä½¿ç”¨ _split APIï¼ˆå°†ç°æœ‰åˆ†ç‰‡åˆ†è£‚ä¸ºæ›´å¤šåˆ†ç‰‡ï¼‰ã€‚ å‰¯æœ¬åˆ†ç‰‡ (Replica Shard)ï¼š\nå¯åŠ¨æ€ä¿®æ”¹ï¼šä½¿ç”¨ PUT /\u0026lt;index\u0026gt;/_settings API å¯ä»¥éšæ—¶å¢åŠ æˆ–å‡å°‘å‰¯æœ¬æ•°ã€‚\nç¤ºä¾‹ï¼ˆè°ƒæ•´å‰¯æœ¬æ•°ï¼‰\nå°†å‰¯æœ¬æ•°æ”¹ä¸º2 PUT /my_index/_settings { \u0026#34;number_of_replicas\u0026#34;: 2 } ","description":"ES çš„æ€§èƒ½ã€ç¨³å®šæ€§ã€æ‰©å±•æ€§ï¼Œ90% å–å†³äºåˆ†ç‰‡è§„åˆ’ã€‚\n1. ä»€ä¹ˆæ˜¯åˆ†ç‰‡ï¼ˆShardï¼‰ ElasticSearch ä¸€ä¸ªç´¢å¼•ç”±å¤šä¸ªåˆ†ç‰‡ç»„æˆï¼š\nç±»å‹ åŠŸèƒ½ Primary Shardï¼ˆä¸»åˆ†ç‰‡ï¼‰ å®é™…å†™å…¥æ•°æ® Replica Shardï¼ˆå‰¯æœ¬ï¼‰ å®¹ç¾ + æé«˜æŸ¥è¯¢æ€§èƒ½ æ¯ä¸ªåˆ†ç‰‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Lucene Indexï¼ˆåº•å±‚æœ€å°å•å…ƒï¼‰ã€‚\nES åªåš â€œåˆ†å¸ƒå¼è°ƒåº¦â€ï¼ŒçœŸå®å­˜å‚¨ç”± Lucene å®Œæˆã€‚\n2. ä¸ºä»€ä¹ˆåˆ†ç‰‡éå¸¸å…³é”®ï¼Ÿ é”™è¯¯çš„åˆ†ç‰‡æ•°é‡ä¼šå¯¼è‡´ï¼š\næ€§èƒ½å´©æºƒï¼ˆå¤ªå¤š shard -\u0026gt; JVM å†…å­˜æš´æ¶¨ï¼‰ æŸ¥è¯¢å˜æ…¢ï¼ˆBroadcast æŸ¥è¯¢ï¼‰ é›†ç¾¤é‡å¯æ…¢ã€æ¢å¤æ…¢ æ•°æ®è¿ç§»æ…¢ å†™å…¥ååä¸‹é™ é›†ç¾¤é¢‘ç¹ä¸ç¨³å®šï¼ˆyellowã€redï¼‰ åˆ†ç‰‡åæ¨¡å¼æ˜¯ ES æœ€å¸¸è§çš„é›†ç¾¤æ•…éšœæºå¤´ã€‚\n"},{"id":198,"href":"/database/elasticsearch/shard-number-planning-and-calculation/","title":"ElasticSearch åˆ†ç‰‡æ•°è§„åˆ’ä¸è®¡ç®—","parent":"ElasticSearch","content":"ğŸ¯ æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰\nElasticSearch åˆ†ç‰‡æ•°ä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥åˆ†ç‰‡è§„åˆ’çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š\nå•ä¸ª Primary Shard çš„æœ€ç»ˆå¤§å°æ§åˆ¶åœ¨ 20â€“50GB ä¹‹é—´ï¼ˆæ—¥å¿—ç±»æ›´å 20â€“30GBï¼‰\nä¸€ã€ä¸ºä»€ä¹ˆåˆ†ç‰‡æ•°ä¸èƒ½æ”¹ï¼Ÿ åˆ†ç‰‡è·¯ç”±ç®—æ³•ï¼š\nshard = hash(_routing) % primary_shards å†³å®šæ•°æ®å­˜å…¥å“ªä¸ªä¸»åˆ†ç‰‡ æ”¹åˆ†ç‰‡æ•° = å…¨é‡é‡å»ºç´¢å¼• ES æ²¡æœ‰ â€œåœ¨çº¿æ‹†åˆ†ä¸»åˆ†ç‰‡â€ çš„èƒ½åŠ›ï¼ˆåªèƒ½ shrink å‡å°‘ï¼‰ ğŸ‘‰ æ‰€ä»¥ï¼šåˆ†ç‰‡æ•° = å»ºç´¢å¼•å‰å¿…é¡»æƒ³æ¸…æ¥šçš„äº‹æƒ…\né€šè¿‡å¯¹è·¯ç”±å€¼è¿›è¡Œå“ˆå¸Œè®¡ç®—å¹¶å–æ¨¡ï¼Œä¿è¯æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸»åˆ†ç‰‡ä¸­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä½•ç´¢å¼•åˆ›å»ºåä¸»åˆ†ç‰‡æ•°é‡ä¸èƒ½ç›´æ¥æ›´æ”¹çš„åŸå› ã€‚\nè¯¦ç»†è§£é‡Šï¼š\nshardï¼šè®¡ç®—å‡ºçš„ç›®æ ‡ä¸»åˆ†ç‰‡ï¼ˆPrimary Shardï¼‰çš„ç´¢å¼•å·ã€‚ hash(_routing)ï¼šå¯¹ _routing å€¼è®¡ç®—å“ˆå¸Œå€¼ï¼ˆé€šå¸¸é»˜è®¤ä¸ºæ–‡æ¡£çš„ _idï¼‰ã€‚è¿™æ˜¯å°†æ–‡æ¡£å“ˆå¸Œä¸ºä¸€ä¸ªç¡®å®šçš„æ•°å­—ã€‚ %ï¼šå–æ¨¡è¿ç®—ç¬¦ï¼Œå³æ•´é™¤åçš„ä½™æ•°ã€‚ primary_shardsï¼šå½“å‰ç´¢å¼•çš„ä¸»åˆ†ç‰‡æ€»æ•°é‡ã€‚ å·¥ä½œæµç¨‹ä¸å…³é”®ç‚¹ï¼š\nç¡®å®šä½ç½®ï¼šå½“å†™å…¥æˆ–æŸ¥è¯¢æ–‡æ¡£æ—¶ï¼ŒES ä¼šæ ¹æ® _routing è®¡ç®—å‡ºå¯¹åº”çš„ shard ç¼–å·ã€‚ æ•°æ®å‡åŒ€åŒ–ï¼šåˆ©ç”¨å“ˆå¸Œå‡½æ•°çš„éšæœºæ€§ï¼Œç¡®ä¿æ–‡æ¡£å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰ä¸»åˆ†ç‰‡ä¸Šã€‚ ä¸å¯ä¿®æ”¹æ€§ï¼šå› ä¸ºåˆ†ç‰‡æ•°æ˜¯å…¬å¼çš„é™¤æ•°ï¼Œå¦‚æœåç»­ä¿®æ”¹äº†ä¸»åˆ†ç‰‡æ•°é‡ï¼ˆå¦‚ primary_shards ä» 3 å˜ä¸º 4ï¼‰ï¼ŒåŸæœ‰çš„ hash(_routing) ç»“æœå–æ¨¡åçš„æ•°å€¼å°±ä¼šæ”¹å˜ï¼Œå¯¼è‡´ä¹‹å‰çš„æ–‡æ¡£â€œæ¶ˆå¤±â€ï¼ˆå› ä¸ºæŸ¥æ‰¾æ—¶è®¡ç®—å‡ºäº†é”™è¯¯çš„åˆ†ç‰‡ä½ç½®ï¼‰ã€‚ ä¸¾ä¾‹ï¼šå¦‚æœæœ‰ 3 ä¸ªä¸»åˆ†ç‰‡ï¼ˆP0, P1, P2ï¼‰ï¼Œ_routing ä¸º id1ï¼Œå‡è®¾ hash(\u0026ldquo;id1\u0026rdquo;) çš„ç»“æœä¸º (10)ï¼Œåˆ™ 10 % 3 = 1ã€‚è¯¥æ–‡æ¡£å°†å­˜å‚¨åœ¨ P1 ä¸Šã€‚\näºŒã€åˆ†ç‰‡è§„åˆ’çš„ 4 ä¸ªå…³é”®è¾“å…¥å‚æ•°ï¼ˆå¿…é¡»çŸ¥é“ï¼‰ åœ¨è§„åˆ’å‰ï¼Œä½ è‡³å°‘è¦çŸ¥é“è¿™ 4 ä¸ªæ•°ï¼š\nå‚æ•° å«ä¹‰ D æ¯å¤©æ•°æ®é‡ï¼ˆGB/dayï¼‰ T ç´¢å¼•ä¿ç•™å‘¨æœŸï¼ˆå¤©ï¼‰ R å‰¯æœ¬æ•°ï¼ˆreplicaï¼‰ S å• shard ç›®æ ‡å¤§å°ï¼ˆGBï¼‰ ä¸‰ã€æœ€é‡è¦çš„å…¬å¼ï¼ˆå¿…èƒŒï¼‰ â­ åˆ†ç‰‡æ•°è®¡ç®—å…¬å¼\nPrimary Shards = âŒˆ ( D Ã— T ) / S âŒ‰ å‰¯æœ¬ä¸å‚ä¸è®¡ç®— primary shard æ•°é‡ã€‚\nå››ã€å…¸å‹åœºæ™¯å®æˆ˜è®¡ç®— åœºæ™¯ 1ï¼šæ—¥å¿—ç³»ç»Ÿï¼ˆæœ€å¸¸è§ï¼‰ æ¡ä»¶\næ¯å¤©æ—¥å¿—ï¼š100 GB ç´¢å¼•å‘¨æœŸï¼š1 å¤©ï¼ˆdaily indexï¼‰ shard ç›®æ ‡ï¼š25 GB è®¡ç®—\nPrimary Shards = 100 / 25 = 4 ç»“è®º\n\u0026#34;number_of_shards\u0026#34;: 4, \u0026#34;number_of_replicas\u0026#34;: 1 ğŸ‘‰ æœ€ç»ˆç£ç›˜ï¼š\n100GB Ã— (1 + 1) = 200GB åœºæ™¯ 2ï¼šå¤§æ—¥å¿—ç³»ç»Ÿï¼ˆçƒ­æ•°æ® 7 å¤©ï¼‰ æ¡ä»¶\næ¯å¤©æ—¥å¿—ï¼š200 GB Hot æ•°æ®ä¿ç•™ï¼š7 å¤© shard ç›®æ ‡ï¼š30 GB Primary Shards = (200 Ã— 7) / 30 â‰ˆ 47 âš ï¸ ä¸å»ºè®®å•ç´¢å¼• 47 shard\nğŸ‘‰ æ­£ç¡®åšæ³•ï¼š\nä½¿ç”¨ daily index + rollover æ¯å¤©ä¸€ä¸ªç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼• 7 shard åœºæ™¯ 3ï¼šä¸šåŠ¡æœç´¢ç´¢å¼•ï¼ˆé•¿æœŸå­˜åœ¨ï¼‰ æ¡ä»¶\nå½“å‰æ•°æ®é‡ï¼š300 GB æœªæ¥ä¸€å¹´é¢„è®¡å¢é•¿åˆ°ï¼š1 TB shard ç›®æ ‡ï¼š40 GB Primary Shards = 1000 / 40 = 25 ğŸ‘‰ åˆ›å»ºç´¢å¼•æ—¶ï¼š\nnumber_of_shards = 24 æˆ– 25 äº”ã€æ—¥å¿—ç³»ç»Ÿçš„æœ€ä½³å®è·µï¼ˆå¼ºçƒˆæ¨èï¼‰ âŒ é”™è¯¯åšæ³•\n1 ä¸ªç´¢å¼•ï¼Œ100+ shard\nâœ… æ­£ç¡®åšæ³•\ndaily index + rollover + ILM\nç¤ºä¾‹\n\u0026#34;rollover\u0026#34;: { \u0026#34;max_size\u0026#34;: \u0026#34;30gb\u0026#34;, \u0026#34;max_age\u0026#34;: \u0026#34;1d\u0026#34; } å¥½å¤„ï¼š\nåˆ†ç‰‡æ•°è‡ªåŠ¨æ§åˆ¶ shard æ°¸è¿œä¸è¶…å¤§ æ–¹ä¾¿å†·çƒ­åˆ†ç¦» å…­ã€ä¸åŒä¸šåŠ¡ç±»å‹çš„ shard æ¨èå€¼ åœºæ™¯ shard å¤§å° é«˜é¢‘å†™å…¥æ—¥å¿— 20â€“30 GB æ™®é€šæ—¥å¿— 30â€“40 GB æœç´¢å‹ä¸šåŠ¡ 30â€“50 GB å†·æ•°æ® 50â€“100 GB ä¸ƒã€é›†ç¾¤ç»´åº¦çš„çº¦æŸï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ æ¯ä¸ªèŠ‚ç‚¹ shard æ•°ä¸Šé™ ç»éªŒå€¼ï¼š\n\u0026lt; 20 shard / GB heap ä¾‹å¦‚ï¼š\n32GB heap -\u0026gt; ~600 shardï¼ˆå« replicaï¼‰ 2ï¸âƒ£ shard æ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ shard å¤ªå¤š shard å¤ªå¤§ é›†ç¾¤çŠ¶æ€è‡ƒè‚¿ æŸ¥è¯¢æ…¢ å†…å­˜æµªè´¹ merge å‹åŠ›å¤§ GC é¢‘ç¹ æ¢å¤æ…¢ ğŸ‘‰ å®å¯ç¨å¾®å¤§ä¸€ç‚¹ï¼Œä¹Ÿä¸è¦å¤ªå¤š\nå…«ã€é¢„ç•™æœªæ¥æ‰©å±•ï¼ˆéå¸¸å…³é”®ï¼‰ è§„åˆ’æ—¶ è‡³å°‘é¢„ç•™ 30%â€“50% å†—ä½™ï¼š\né¢„è®¡ä¸€å¹´å 1TB -\u0026gt; æŒ‰ 1.3TB è§„åˆ’\nä¹ã€å¦‚æœç°åœ¨è§„åˆ’é”™äº†æ€ä¹ˆåŠï¼Ÿ 1ï¸âƒ£ ä½¿ç”¨ rolloverï¼ˆæœ€ä¼˜è§£ï¼‰ æ§åˆ¶ shard å¤§å° ä¸å†å…³å¿ƒâ€œå•ç´¢å¼•åˆ†ç‰‡æ•°â€ 2ï¸âƒ£ Reindex é‡å»ºç´¢å¼•ï¼ˆä»£ä»·é«˜ï¼‰ 3ï¸âƒ£ Shrinkï¼ˆåªèƒ½å‡ä¸èƒ½å¢ï¼‰ POST index/_shrink/index_shrinked åã€æ€»ç»“ ElasticSearch çš„ä¸»åˆ†ç‰‡æ•°ä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥æˆ‘åœ¨å‰æœŸä¼šæ ¹æ® æ¯å¤©æ•°æ®é‡ Ã— ä¿ç•™å‘¨æœŸ Ã· å• shard ç›®æ ‡å¤§å° æ¥è®¡ç®—ã€‚\nå®è·µä¸­æˆ‘ä¼šæŠŠå• shard æ§åˆ¶åœ¨ 20â€“50GBï¼Œ æ—¥å¿—ç³»ç»Ÿç”¨ daily index + rollover + ILMï¼Œ åŒæ—¶é¢„ç•™ 30% çš„å¢é•¿ç©ºé—´ï¼Œé¿å…åæœŸé‡å»ºç´¢å¼•ã€‚\n","description":"ğŸ¯ æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰\nElasticSearch åˆ†ç‰‡æ•°ä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥åˆ†ç‰‡è§„åˆ’çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š\nå•ä¸ª Primary Shard çš„æœ€ç»ˆå¤§å°æ§åˆ¶åœ¨ 20â€“50GB ä¹‹é—´ï¼ˆæ—¥å¿—ç±»æ›´å 20â€“30GBï¼‰\nä¸€ã€ä¸ºä»€ä¹ˆåˆ†ç‰‡æ•°ä¸èƒ½æ”¹ï¼Ÿ åˆ†ç‰‡è·¯ç”±ç®—æ³•ï¼š\nshard = hash(_routing) % primary_shards å†³å®šæ•°æ®å­˜å…¥å“ªä¸ªä¸»åˆ†ç‰‡ æ”¹åˆ†ç‰‡æ•° = å…¨é‡é‡å»ºç´¢å¼• ES æ²¡æœ‰ â€œåœ¨çº¿æ‹†åˆ†ä¸»åˆ†ç‰‡â€ çš„èƒ½åŠ›ï¼ˆåªèƒ½ shrink å‡å°‘ï¼‰ ğŸ‘‰ æ‰€ä»¥ï¼šåˆ†ç‰‡æ•° = å»ºç´¢å¼•å‰å¿…é¡»æƒ³æ¸…æ¥šçš„äº‹æƒ…\né€šè¿‡å¯¹è·¯ç”±å€¼è¿›è¡Œå“ˆå¸Œè®¡ç®—å¹¶å–æ¨¡ï¼Œä¿è¯æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸»åˆ†ç‰‡ä¸­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä½•ç´¢å¼•åˆ›å»ºåä¸»åˆ†ç‰‡æ•°é‡ä¸èƒ½ç›´æ¥æ›´æ”¹çš„åŸå› ã€‚\nè¯¦ç»†è§£é‡Šï¼š\nshardï¼šè®¡ç®—å‡ºçš„ç›®æ ‡ä¸»åˆ†ç‰‡ï¼ˆPrimary Shardï¼‰çš„ç´¢å¼•å·ã€‚ hash(_routing)ï¼šå¯¹ _routing å€¼è®¡ç®—å“ˆå¸Œå€¼ï¼ˆé€šå¸¸é»˜è®¤ä¸ºæ–‡æ¡£çš„ _idï¼‰ã€‚è¿™æ˜¯å°†æ–‡æ¡£å“ˆå¸Œä¸ºä¸€ä¸ªç¡®å®šçš„æ•°å­—ã€‚ %ï¼šå–æ¨¡è¿ç®—ç¬¦ï¼Œå³æ•´é™¤åçš„ä½™æ•°ã€‚ primary_shardsï¼šå½“å‰ç´¢å¼•çš„ä¸»åˆ†ç‰‡æ€»æ•°é‡ã€‚ å·¥ä½œæµç¨‹ä¸å…³é”®ç‚¹ï¼š\nç¡®å®šä½ç½®ï¼šå½“å†™å…¥æˆ–æŸ¥è¯¢æ–‡æ¡£æ—¶ï¼ŒES ä¼šæ ¹æ® _routing è®¡ç®—å‡ºå¯¹åº”çš„ shard ç¼–å·ã€‚ æ•°æ®å‡åŒ€åŒ–ï¼šåˆ©ç”¨å“ˆå¸Œå‡½æ•°çš„éšæœºæ€§ï¼Œç¡®ä¿æ–‡æ¡£å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰ä¸»åˆ†ç‰‡ä¸Šã€‚ ä¸å¯ä¿®æ”¹æ€§ï¼šå› ä¸ºåˆ†ç‰‡æ•°æ˜¯å…¬å¼çš„é™¤æ•°ï¼Œå¦‚æœåç»­ä¿®æ”¹äº†ä¸»åˆ†ç‰‡æ•°é‡ï¼ˆå¦‚ primary_shards ä» 3 å˜ä¸º 4ï¼‰ï¼ŒåŸæœ‰çš„ hash(_routing) ç»“æœå–æ¨¡åçš„æ•°å€¼å°±ä¼šæ”¹å˜ï¼Œå¯¼è‡´ä¹‹å‰çš„æ–‡æ¡£â€œæ¶ˆå¤±â€ï¼ˆå› ä¸ºæŸ¥æ‰¾æ—¶è®¡ç®—å‡ºäº†é”™è¯¯çš„åˆ†ç‰‡ä½ç½®ï¼‰ã€‚ ä¸¾ä¾‹ï¼šå¦‚æœæœ‰ 3 ä¸ªä¸»åˆ†ç‰‡ï¼ˆP0, P1, P2ï¼‰ï¼Œ_routing ä¸º id1ï¼Œå‡è®¾ hash(\u0026ldquo;id1\u0026rdquo;) çš„ç»“æœä¸º (10)ï¼Œåˆ™ 10 % 3 = 1ã€‚è¯¥æ–‡æ¡£å°†å­˜å‚¨åœ¨ P1 ä¸Šã€‚\n"},{"id":199,"href":"/database/elasticsearch/command/","title":"ElasticSearch å¸¸ç”¨å‘½ä»¤","parent":"ElasticSearch","content":"å†…å®¹è¦†ç›–ï¼šé›†ç¾¤ã€èŠ‚ç‚¹ã€ç´¢å¼•ã€åˆ†ç‰‡ã€è·¯ç”±ã€æ€§èƒ½ã€å¥åº·ã€ä»»åŠ¡ã€å¿«ç…§ã€ILMã€æ¨¡æ¿ã€Pipelineã€‚\nå…¨éƒ¨é‡‡ç”¨ æœ€å¸¸ç”¨ã€æœ€é«˜é¢‘ã€è¿ç»´å¿…å¤‡ã€ä¸šåŠ¡å¸¸è§åœºæ™¯ çš„å‘½ä»¤ã€‚\nğŸš€ ElasticSearch å¸¸ç”¨å‘½ä»¤å¤§å…¨ï¼ˆå«é›†ç¾¤å‘½ä»¤ï¼‰ ç»“æ„å¦‚ä¸‹ï¼š\né›†ç¾¤å‘½ä»¤ï¼ˆæœ€é‡è¦ï¼‰ èŠ‚ç‚¹å‘½ä»¤ ç´¢å¼•å‘½ä»¤ åˆ†ç‰‡å‘½ä»¤ æ–‡æ¡£å‘½ä»¤ æœç´¢å‘½ä»¤ ç›‘æ§å’Œæ€§èƒ½ Task \u0026amp; Reindex æ¨¡æ¿ï¼ˆindex templateï¼‰ ILM ç”Ÿå‘½å‘¨æœŸ Snapshot \u0026amp; Restore Pipelineï¼ˆingestï¼‰ ç”¨æˆ·ä¸è§’è‰²ï¼ˆå®‰å…¨ï¼‰ å…¨éƒ¨å®æˆ˜å¯ç”¨ã€‚\n1. é›†ç¾¤å‘½ä»¤ï¼ˆClusterï¼‰ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼ˆæœ€å¸¸ç”¨ï¼‰ GET /_cluster/health æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤ä¿¡æ¯ GET /_cluster/state æŸ¥çœ‹æœªåˆ†é…çš„ shardï¼ˆå¿…æŸ¥ï¼‰ GET /_cluster/allocation/explain æŸ¥çœ‹é›†ç¾¤è®¾ç½® GET /_cluster/settings?include_defaults=true ä¿®æ”¹é›†ç¾¤è®¾ç½®ï¼ˆä¸´æ—¶ï¼‰ PUT /_cluster/settings { \u0026#34;transient\u0026#34;: { \u0026#34;cluster.routing.allocation.enable\u0026#34;: \u0026#34;all\u0026#34; } } ä¿®æ”¹é›†ç¾¤è®¾ç½®ï¼ˆæŒä¹…ï¼‰ PUT /_cluster/settings { \u0026#34;persistent\u0026#34;: { \u0026#34;indices.recovery.max_bytes_per_sec\u0026#34;: \u0026#34;200mb\u0026#34; } } æ‰‹åŠ¨æ’é™¤èŠ‚ç‚¹ï¼ˆç”¨äºä¸‹çº¿èŠ‚ç‚¹ï¼‰ PUT /_cluster/settings { \u0026#34;transient\u0026#34;: { \u0026#34;cluster.routing.allocation.exclude._name\u0026#34;: \u0026#34;node-1\u0026#34; } } 2. èŠ‚ç‚¹å‘½ä»¤ï¼ˆNodesï¼‰ æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ GET /_cat/nodes?v æŸ¥çœ‹æŸèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ GET /_nodes/node-1 æŸ¥çœ‹è§’è‰²ã€å †ã€çº¿ç¨‹æ± ã€ç£ç›˜ç­‰ã€‚\næŸ¥çœ‹èŠ‚ç‚¹ç»Ÿè®¡ GET /_nodes/stats æŸ¥çœ‹ JVMã€OSã€çº¿ç¨‹æ± ç­‰ GET /_nodes/hot_threads æŸ¥çœ‹èŠ‚ç‚¹çš„å †ä½¿ç”¨ GET /_nodes/stats/jvm 3. ç´¢å¼•å‘½ä»¤ï¼ˆIndexï¼‰ æŸ¥çœ‹æ‰€æœ‰ç´¢å¼• GET /_cat/indices?v åˆ›å»ºç´¢å¼• PUT /my-index { \u0026#34;settings\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 3, \u0026#34;number_of_replicas\u0026#34;: 1 } } åˆ é™¤ç´¢å¼• DELETE /my-index å…³é—­ç´¢å¼• POST /my-index/_close æ‰“å¼€ç´¢å¼• POST /my-index/_open æŸ¥çœ‹ç´¢å¼•é…ç½® GET /my-index/_settings ä¿®æ”¹å‰¯æœ¬æ•° PUT /my-index/_settings { \u0026#34;number_of_replicas\u0026#34;: 2 } å¼ºåˆ¶ merge POST /my-index/_forcemerge?max_num_segments=1 4. åˆ†ç‰‡ï¼ˆShardï¼‰ æŸ¥çœ‹åˆ†ç‰‡çŠ¶æ€ GET /_cat/shards?v æŸ¥çœ‹æŸ index çš„åˆ†ç‰‡åˆ†å¸ƒ GET /_cat/shards/my-index?v æŸ¥çœ‹ routing åˆ†ç‰‡é€»è¾‘ GET /my-index/_search_shards æ‰‹åŠ¨ç§»åŠ¨åˆ†ç‰‡ POST /_cluster/reroute { \u0026#34;commands\u0026#34;: [ { \u0026#34;move\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;my-index\u0026#34;, \u0026#34;shard\u0026#34;: 0, \u0026#34;from_node\u0026#34;: \u0026#34;node-1\u0026#34;, \u0026#34;to_node\u0026#34;: \u0026#34;node-2\u0026#34; } } ] } 5. æ–‡æ¡£å‘½ä»¤ï¼ˆDocumentï¼‰ æ’å…¥æ–‡æ¡£ POST /my-index/_doc/1 { \u0026#34;title\u0026#34;: \u0026#34;hello\u0026#34; } è‡ªåŠ¨ç”Ÿæˆ ID POST /my-index/_doc è·å–æ–‡æ¡£ GET /my-index/_doc/1 æ›´æ–°æ–‡æ¡£ï¼ˆå±€éƒ¨ï¼‰ POST /my-index/_update/1 { \u0026#34;doc\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;new title\u0026#34; } } åˆ é™¤æ–‡æ¡£ DELETE /my-index/_doc/1 6. æœç´¢å‘½ä»¤ï¼ˆSearchï¼‰ ç®€å•æŸ¥è¯¢ GET /my-index/_search?q=title:hello DSL æŸ¥è¯¢ POST /my-index/_search { \u0026#34;query\u0026#34;: { \u0026#34;match\u0026#34;: { \u0026#34;title\u0026#34;: \u0026#34;hello\u0026#34; } } } èšåˆæŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰ POST /my-index/_search { \u0026#34;size\u0026#34;: 0, \u0026#34;aggs\u0026#34;: { \u0026#34;by_day\u0026#34;: { \u0026#34;date_histogram\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;timestamp\u0026#34;, \u0026#34;calendar_interval\u0026#34;: \u0026#34;day\u0026#34; } } } } 7. æ€§èƒ½è°ƒè¯•ï¼ˆMonitoringï¼‰ æ…¢æŸ¥è¯¢æ—¥å¿— GET /_nodes/hot_threads æŸ¥çœ‹æŸ¥è¯¢ä¸å†™å…¥å®æ—¶æŒ‡æ ‡ GET /_nodes/stats/indices æŸ¥çœ‹æ®µä¿¡æ¯ GET /my-index/_segments æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆprofileï¼‰ POST /my-index/_search?profile=true 8. Reindex / Tasks ç®¡ç† Reindex POST /_reindex { \u0026#34;source\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;old\u0026#34; }, \u0026#34;dest\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;new\u0026#34; } } æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ GET /_tasks?detailed=true ç»ˆæ­¢ä»»åŠ¡ POST /_tasks/\u0026lt;task_id\u0026gt;/_cancel 9. ç´¢å¼•æ¨¡æ¿ï¼ˆIndex Templateï¼‰ æŸ¥çœ‹æ¨¡æ¿ GET /_index_template åˆ›å»ºæ¨¡æ¿ PUT /_index_template/logs_template { \u0026#34;index_patterns\u0026#34;: [\u0026#34;logs-*\u0026#34;], \u0026#34;template\u0026#34;: { \u0026#34;settings\u0026#34;: { \u0026#34;number_of_shards\u0026#34;: 1 } } } 10. ILM ç”Ÿå‘½å‘¨æœŸç®¡ç† æŸ¥çœ‹ ILM çŠ¶æ€ GET /_ilm/status æŸ¥çœ‹æŸç´¢å¼• ILM GET /my-index/_ilm/explain åˆ›å»º ILM ç­–ç•¥ PUT /_ilm/policy/logs_policy { \u0026#34;policy\u0026#34;: { \u0026#34;phases\u0026#34;: { \u0026#34;hot\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;rollover\u0026#34;: { \u0026#34;max_size\u0026#34;: \u0026#34;40GB\u0026#34; } } }, \u0026#34;delete\u0026#34;: { \u0026#34;min_age\u0026#34;: \u0026#34;30d\u0026#34;, \u0026#34;actions\u0026#34;: { \u0026#34;delete\u0026#34;: {} } } } } } 11. å¿«ç…§ \u0026amp; å¤‡ä»½ï¼ˆSnapshotï¼‰ æ³¨å†Œ repository PUT /_snapshot/my_repo { \u0026#34;type\u0026#34;: \u0026#34;fs\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;location\u0026#34;: \u0026#34;/data/backups\u0026#34; } } åˆ›å»ºå¿«ç…§ PUT /_snapshot/my_repo/snap-01 æ¢å¤å¿«ç…§ POST /_snapshot/my_repo/snap-01/_restore 12. Pipelineï¼ˆIngestï¼‰ æŸ¥çœ‹ pipeline GET /_ingest/pipeline åˆ›å»º pipeline PUT /_ingest/pipeline/my_pipe { \u0026#34;processors\u0026#34;: [ { \u0026#34;lowercase\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;title\u0026#34; } } ] } 13. ç”¨æˆ·ä¸è§’è‰²ï¼ˆX-Pack Securityï¼‰ åˆ›å»ºè§’è‰² POST /_security/role/log_reader { \u0026#34;indices\u0026#34;: [ { \u0026#34;names\u0026#34;: [\u0026#34;logs-*\u0026#34;], \u0026#34;privileges\u0026#34;: [\u0026#34;read\u0026#34;] } ] } åˆ›å»ºç”¨æˆ· POST /_security/user/martin { \u0026#34;password\u0026#34;: \u0026#34;123456\u0026#34;, \u0026#34;roles\u0026#34;: [\u0026#34;log_reader\u0026#34;] } ","description":"å†…å®¹è¦†ç›–ï¼šé›†ç¾¤ã€èŠ‚ç‚¹ã€ç´¢å¼•ã€åˆ†ç‰‡ã€è·¯ç”±ã€æ€§èƒ½ã€å¥åº·ã€ä»»åŠ¡ã€å¿«ç…§ã€ILMã€æ¨¡æ¿ã€Pipelineã€‚\nå…¨éƒ¨é‡‡ç”¨ æœ€å¸¸ç”¨ã€æœ€é«˜é¢‘ã€è¿ç»´å¿…å¤‡ã€ä¸šåŠ¡å¸¸è§åœºæ™¯ çš„å‘½ä»¤ã€‚\nğŸš€ ElasticSearch å¸¸ç”¨å‘½ä»¤å¤§å…¨ï¼ˆå«é›†ç¾¤å‘½ä»¤ï¼‰ ç»“æ„å¦‚ä¸‹ï¼š\né›†ç¾¤å‘½ä»¤ï¼ˆæœ€é‡è¦ï¼‰ èŠ‚ç‚¹å‘½ä»¤ ç´¢å¼•å‘½ä»¤ åˆ†ç‰‡å‘½ä»¤ æ–‡æ¡£å‘½ä»¤ æœç´¢å‘½ä»¤ ç›‘æ§å’Œæ€§èƒ½ Task \u0026amp; Reindex æ¨¡æ¿ï¼ˆindex templateï¼‰ ILM ç”Ÿå‘½å‘¨æœŸ Snapshot \u0026amp; Restore Pipelineï¼ˆingestï¼‰ ç”¨æˆ·ä¸è§’è‰²ï¼ˆå®‰å…¨ï¼‰ å…¨éƒ¨å®æˆ˜å¯ç”¨ã€‚\n1. é›†ç¾¤å‘½ä»¤ï¼ˆClusterï¼‰ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼ˆæœ€å¸¸ç”¨ï¼‰ GET /_cluster/health æŸ¥çœ‹æ‰€æœ‰é›†ç¾¤ä¿¡æ¯ GET /_cluster/state æŸ¥çœ‹æœªåˆ†é…çš„ shardï¼ˆå¿…æŸ¥ï¼‰ GET /_cluster/allocation/explain æŸ¥çœ‹é›†ç¾¤è®¾ç½® GET /_cluster/settings?include_defaults=true ä¿®æ”¹é›†ç¾¤è®¾ç½®ï¼ˆä¸´æ—¶ï¼‰ PUT /_cluster/settings { \u0026#34;transient\u0026#34;: { \u0026#34;cluster.routing.allocation.enable\u0026#34;: \u0026#34;all\u0026#34; } } ä¿®æ”¹é›†ç¾¤è®¾ç½®ï¼ˆæŒä¹…ï¼‰ PUT /_cluster/settings { \u0026#34;persistent\u0026#34;: { \u0026#34;indices.recovery.max_bytes_per_sec\u0026#34;: \u0026#34;200mb\u0026#34; } } æ‰‹åŠ¨æ’é™¤èŠ‚ç‚¹ï¼ˆç”¨äºä¸‹çº¿èŠ‚ç‚¹ï¼‰ PUT /_cluster/settings { \u0026#34;transient\u0026#34;: { \u0026#34;cluster.routing.allocation.exclude._name\u0026#34;: \u0026#34;node-1\u0026#34; } } 2. èŠ‚ç‚¹å‘½ä»¤ï¼ˆNodesï¼‰ æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ GET /_cat/nodes?v æŸ¥çœ‹æŸèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ GET /_nodes/node-1 æŸ¥çœ‹è§’è‰²ã€å †ã€çº¿ç¨‹æ± ã€ç£ç›˜ç­‰ã€‚\n"},{"id":200,"href":"/database/elasticsearch/backup/","title":"ElasticSearch æ•°æ®å¤‡ä»½","parent":"ElasticSearch","content":"å†…å®¹ï¼šå¿«ç…§æœºåˆ¶ã€å†·/çƒ­å¤‡ä»½ã€S3/HDFS/NFSã€å…¨é‡/å¢é‡ã€æ¢å¤ç­–ç•¥ã€‚\nä¸€ã€Elasticsearch æ•°æ®å¤‡ä»½æ¦‚å¿µ Elasticsearch å¤‡ä»½ä¸æ˜¯ç›´æ¥å¤åˆ¶æ•°æ®ç›®å½•ï¼Œè€Œæ˜¯ä½¿ç”¨ Snapshotï¼ˆå¿«ç…§ï¼‰æœºåˆ¶ã€‚\nSnapshotï¼šå°†ç´¢å¼•æ•°æ®å’Œå…ƒæ•°æ®å¯¼å‡ºåˆ° å¯æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚ NFSã€S3ã€HDFSï¼‰ Restoreï¼šä» Snapshot æ¢å¤ç´¢å¼• ç‰¹ç‚¹ï¼š\nå¯è·¨é›†ç¾¤æ¢å¤ æ”¯æŒå…¨é‡å’Œå¢é‡ å¯¹é›†ç¾¤åœ¨çº¿æ“ä½œå½±å“å° å†·å¤‡çƒ­å¤‡å¯ç»“åˆ äºŒã€Snapshot åŸç† Elasticsearch åˆ†ç‰‡çº§å¿«ç…§\næ¯ä¸ª shard çš„ segment æ–‡ä»¶è¢«æ£€æŸ¥ç‚¹è®°å½• ä½¿ç”¨ å¢é‡æ–¹å¼ï¼šå·²æœ‰ segment ä¸ä¼šé‡å¤å¤‡ä»½ Snapshot åªè¯»æ“ä½œ\nä¸å½±å“é›†ç¾¤å†™å…¥å’Œæœç´¢ åªå ç”¨å°‘é‡ CPU å’Œ IO å…ƒæ•°æ®å¿«ç…§\nåŒ…æ‹¬ mappingã€settingsã€alias ç­‰ ç”¨äºæ¢å¤ç´¢å¼•ç»“æ„ ä¸‰ã€å¿«ç…§å­˜å‚¨ç±»å‹ ç±»å‹ è¯´æ˜ åœºæ™¯ NFS / æœ¬åœ°å…±äº«ç›®å½• æ–‡ä»¶ç³»ç»Ÿ å°å‹é›†ç¾¤ï¼Œå±€åŸŸç½‘ AWS S3 / MinIO / OSS å¯¹è±¡å­˜å‚¨ å…¬æœ‰äº‘ / è·¨åœ°åŸŸ HDFS Hadoop é›†ç¾¤ å¤§æ•°æ®ç”Ÿæ€ GCS / Azure Blob äº‘å¹³å° äº‘åŸç”Ÿå¤‡ä»½ å››ã€Snapshot æ“ä½œ 1ï¸âƒ£ æ³¨å†Œå¿«ç…§ä»“åº“ PUT _snapshot/my_backup { \u0026#34;type\u0026#34;: \u0026#34;fs\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;location\u0026#34;: \u0026#34;/mnt/es_backup\u0026#34;, \u0026#34;compress\u0026#34;: true } } type: fs, s3, hdfs, gcs, azure location: æ–‡ä»¶ç³»ç»Ÿè·¯å¾„æˆ–æ¡¶å compress: æ˜¯å¦å‹ç¼©ï¼ˆå»ºè®® trueï¼‰ 2ï¸âƒ£ åˆ›å»ºå¿«ç…§ å…¨é‡å¿«ç…§ï¼ˆå¯é€‰æŒ‡å®šç´¢å¼•ï¼‰\nPUT _snapshot/my_backup/snapshot_20251220?wait_for_completion=true { \u0026#34;indices\u0026#34;: \u0026#34;logstash-*\u0026#34;, \u0026#34;ignore_unavailable\u0026#34;: true, \u0026#34;include_global_state\u0026#34;: true } indices: éœ€è¦å¤‡ä»½çš„ç´¢å¼•ï¼ˆ* è¡¨ç¤ºå…¨éƒ¨ï¼‰ include_global_state: æ˜¯å¦åŒ…å« cluster å…ƒæ•°æ® å¢é‡å¤‡ä»½ï¼šES Snapshot å¤©ç„¶å¢é‡ï¼ˆæœªå˜ segment ä¸ä¼šé‡å¤å¤‡ä»½ï¼‰ 3ï¸âƒ£ æŸ¥çœ‹å¿«ç…§çŠ¶æ€ GET _snapshot/my_backup/_all 4ï¸âƒ£ æ¢å¤å¿«ç…§ POST _snapshot/my_backup/snapshot_20251220/_restore { \u0026#34;indices\u0026#34;: \u0026#34;logstash-*\u0026#34;, \u0026#34;rename_pattern\u0026#34;: \u0026#34;logstash-(.*)\u0026#34;, \u0026#34;rename_replacement\u0026#34;: \u0026#34;restored-logstash-$1\u0026#34;, \u0026#34;include_global_state\u0026#34;: false } rename_pattern + rename_replacement ç”¨äºé‡å‘½åç´¢å¼• å¯é€‰æ‹©æ€§æ¢å¤æŸäº›ç´¢å¼• ä¸å½±å“åœ¨çº¿é›†ç¾¤ï¼ˆå¯å¹¶è¡Œï¼‰ äº”ã€å¤‡ä»½ç­–ç•¥ å†·çƒ­ç»“åˆ\nçƒ­æ•°æ®å¿«ç…§é¢‘ç¹ï¼ˆæ¯å¤©/æ¯ 6 å°æ—¶ï¼‰ å†·æ•°æ®å¿«ç…§å‘¨æœŸé•¿ï¼ˆæ¯å‘¨/æ¯æœˆï¼‰ å¢é‡ + å…¨é‡\nES Snapshot æ˜¯å¢é‡å­˜å‚¨ å¯ç»“åˆå…¨é‡å‘¨æœŸç­–ç•¥ï¼ˆä¾‹å¦‚æ¯æœˆä¸€æ¬¡å…¨é‡ï¼‰ å¤šåœ°å†—ä½™\nS3 + NFS åŒå­˜å‚¨ é¿å…å•ç‚¹æ•…éšœ è‡ªåŠ¨åŒ–\nä½¿ç”¨ ILM + Snapshot Lifecycle Managementï¼ˆSLMï¼‰ è‡ªåŠ¨åˆ›å»ºã€ä¿ç•™å’Œåˆ é™¤å¿«ç…§ å…­ã€Snapshot Lifecycle Managementï¼ˆSLMï¼‰ ES 7.7+ å†…ç½®ç®¡ç† ç¤ºä¾‹ç­–ç•¥ï¼šæ¯æ—¥å¿«ç…§ï¼Œä¿ç•™ 7 å¤© PUT _slm/policy/daily-snapshot { \u0026#34;schedule\u0026#34;: \u0026#34;0 2 * * *\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;\u0026lt;daily-snap-{now/d}\u0026gt;\u0026#34;, \u0026#34;repository\u0026#34;: \u0026#34;my_backup\u0026#34;, \u0026#34;config\u0026#34;: { \u0026#34;indices\u0026#34;: [\u0026#34;logstash-*\u0026#34;], \u0026#34;ignore_unavailable\u0026#34;: true, \u0026#34;include_global_state\u0026#34;: false }, \u0026#34;retention\u0026#34;: { \u0026#34;expire_after\u0026#34;: \u0026#34;7d\u0026#34;, \u0026#34;min_count\u0026#34;: 3, \u0026#34;max_count\u0026#34;: 10 } } è‡ªåŠ¨ç®¡ç†å¿«ç…§å‘¨æœŸå’Œæ¸…ç†è¿‡æœŸå¿«ç…§ ä¸ƒã€å…¶å®ƒé‡ç‚¹ ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å¤åˆ¶ / rsync æ•°æ®ç›®å½•ï¼Ÿ\nå› ä¸ºæ•°æ®ç›®å½•åœ¨ ES è¿è¡Œæ—¶å­˜åœ¨ segmentã€äº‹åŠ¡ä¸ä¸€è‡´ Snapshot æ‰èƒ½ä¿è¯å¯æ¢å¤æ€§ å¿«ç…§å¯¹æ€§èƒ½å½±å“å¤§å—ï¼Ÿ\nå°ï¼Œå¢é‡ï¼Œè¯» shard æ–‡ä»¶ï¼Œä¸é”å†™å…¥ å¤§å‹é›†ç¾¤å»ºè®®åœ¨ä½å³°æœŸ Snapshot æ˜¯å¦æ˜¯å¢é‡å¤‡ä»½ï¼Ÿ\nâœ… å¯¹ segment å¢é‡å¤‡ä»½ æ¯æ¬¡åˆ›å»º snapshot éƒ½å¯ä»¥ç§°ä¸ºå…¨é‡ï¼Œä½†åº•å±‚å­˜å‚¨æ˜¯å¢é‡ SLM ä¸ Cron æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\nSLM æ˜¯ ES å†…ç½®ç­–ç•¥ï¼Œèƒ½ç®¡ç†å¿«ç…§ç”Ÿå‘½å‘¨æœŸã€åˆ é™¤è¿‡æœŸæ•°æ® Cron åªæ˜¯è°ƒåº¦ï¼Œä¸ç®¡ç† retention ES å¤‡ä»½ç­–ç•¥å¦‚ä½•è§„åˆ’ï¼Ÿ\nçƒ­æ•°æ®ï¼šæ¯æ—¥å¿«ç…§ -\u0026gt; ä¿ç•™ 7 å¤© å†·æ•°æ®ï¼šæ¯å‘¨æˆ–æ¯æœˆå¿«ç…§ -\u0026gt; ä¿ç•™ 1 å¹´ å¤šåœ°å­˜å‚¨ï¼Œæé«˜ç¾å¤‡èƒ½åŠ› å…«ã€ç”Ÿäº§æœ€ä½³å®è·µ ä½¿ç”¨ å¯¹è±¡å­˜å‚¨ï¼ˆS3 / MinIO / OSSï¼‰è·¨é›†ç¾¤æ¢å¤ ä½¿ç”¨ SLM è‡ªåŠ¨ç®¡ç† å¿«ç…§å®šæ—¶åœ¨ä½å³°æ—¶é—´æ‰§è¡Œ ç»“åˆ å†·çƒ­åˆ†ç¦» ILM -\u0026gt; çƒ­æ•°æ®é¢‘ç¹å¿«ç…§ï¼Œå†·æ•°æ®å½’æ¡£å¿«ç…§ æµ‹è¯•æ¢å¤æµç¨‹ -\u0026gt; ç¾éš¾æ¢å¤æ¼”ç»ƒå¿…åš ä¹ã€æ€»ç»“ Elasticsearch å¤‡ä»½ä¸»è¦ä½¿ç”¨ Snapshot æœºåˆ¶ï¼Œå°†ç´¢å¼•å’Œå…ƒæ•°æ®å¢é‡å¯¼å‡ºåˆ°æ–‡ä»¶ç³»ç»Ÿæˆ–å¯¹è±¡å­˜å‚¨ã€‚\nSnapshot æ˜¯åˆ†ç‰‡çº§å¢é‡å¤‡ä»½ï¼Œä¸å½±å“åœ¨çº¿å†™å…¥å’Œæœç´¢ã€‚\nç”Ÿäº§ä¸­æˆ‘ä»¬ä¼šç»“åˆ SLM è®¾ç½®è‡ªåŠ¨å¿«ç…§å’Œè¿‡æœŸæ¸…ç†ç­–ç•¥ï¼Œå†·çƒ­æ•°æ®åˆ†å±‚å¤‡ä»½ï¼Œä¿è¯å¿«é€Ÿæ¢å¤å’Œå­˜å‚¨æˆæœ¬æœ€ä¼˜ã€‚\n","description":"å†…å®¹ï¼šå¿«ç…§æœºåˆ¶ã€å†·/çƒ­å¤‡ä»½ã€S3/HDFS/NFSã€å…¨é‡/å¢é‡ã€æ¢å¤ç­–ç•¥ã€‚\nä¸€ã€Elasticsearch æ•°æ®å¤‡ä»½æ¦‚å¿µ Elasticsearch å¤‡ä»½ä¸æ˜¯ç›´æ¥å¤åˆ¶æ•°æ®ç›®å½•ï¼Œè€Œæ˜¯ä½¿ç”¨ Snapshotï¼ˆå¿«ç…§ï¼‰æœºåˆ¶ã€‚\nSnapshotï¼šå°†ç´¢å¼•æ•°æ®å’Œå…ƒæ•°æ®å¯¼å‡ºåˆ° å¯æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚ NFSã€S3ã€HDFSï¼‰ Restoreï¼šä» Snapshot æ¢å¤ç´¢å¼• ç‰¹ç‚¹ï¼š\nå¯è·¨é›†ç¾¤æ¢å¤ æ”¯æŒå…¨é‡å’Œå¢é‡ å¯¹é›†ç¾¤åœ¨çº¿æ“ä½œå½±å“å° å†·å¤‡çƒ­å¤‡å¯ç»“åˆ äºŒã€Snapshot åŸç† Elasticsearch åˆ†ç‰‡çº§å¿«ç…§\næ¯ä¸ª shard çš„ segment æ–‡ä»¶è¢«æ£€æŸ¥ç‚¹è®°å½• ä½¿ç”¨ å¢é‡æ–¹å¼ï¼šå·²æœ‰ segment ä¸ä¼šé‡å¤å¤‡ä»½ Snapshot åªè¯»æ“ä½œ\nä¸å½±å“é›†ç¾¤å†™å…¥å’Œæœç´¢ åªå ç”¨å°‘é‡ CPU å’Œ IO å…ƒæ•°æ®å¿«ç…§\n"},{"id":201,"href":"/database/elasticsearch/best-practices/","title":"ElasticSearch æœ€ä½³å®è·µ","parent":"ElasticSearch","content":"ç›®å½•\nç´¢å¼•è®¾è®¡ Mapping è®¾è®¡ å†™å…¥ä¼˜åŒ– æœç´¢ä¼˜åŒ– åˆ†ç‰‡ä¸èŠ‚ç‚¹è§„åˆ’ è¿ç»´ä¸ç›‘æ§ å¸¸è§åæ¨¡å¼ å®‰å…¨ä¸ç¨³å®šæ€§ æ—¥å¿—/æœç´¢/ç”µå•†ä¸‰ç±»åœºæ™¯æœ€ä½³å®è·µ ğŸŒŸ 1. ç´¢å¼•ï¼ˆIndexï¼‰æœ€ä½³å®è·µ 1.1 ä¸€ä¸ªç´¢å¼•æ•°æ®é‡æ§åˆ¶åœ¨ 30â€“50GB / shard ç†ç”±ï¼š\nåˆ†ç‰‡å¤ªå¤§ï¼šè¿ç§»å›°éš¾ï¼Œæ¢å¤æ…¢ åˆ†ç‰‡å¤ªå°ï¼šshard è¿‡å¤šï¼ˆæµªè´¹å†…å­˜ï¼‰ æ¨èï¼š\næ€»æ•°æ®é‡ / 40GB = æ¨è shard æ•°é‡ 1.2 æŒ‰æ—¥æœŸæ»šåŠ¨ï¼ˆæ—¥å¿—ç±»ï¼‰ ä¸è¦æŠŠæ—¥å¿—å…¨éƒ¨å†™å…¥ logs ç´¢å¼•ã€‚\næ­£ç¡®ï¼š\nlogs-2025.01.01 logs-2025.01.02 é…åˆ ILM è‡ªåŠ¨ rolloverã€‚\n1.3 ç¦æ­¢è‡ªåŠ¨å»ºç´¢å¼•ï¼ˆå¿…åšï¼‰ action.auto_create_index: false é¿å…é‡ç”Ÿç´¢å¼•ï¼Œé¿å… mapping çˆ†ç‚¸ã€‚\n1.4 é¿å…ä¸€ä¸ªç´¢å¼•æœ‰ä¸Šåƒä¸ªå­—æ®µï¼ˆfield explosionï¼‰ ES çš„ field è¶Šå¤šï¼Œå†…å­˜è¶Šé«˜ã€æŸ¥è¯¢è¶Šæ…¢ã€‚\né™åˆ¶ï¼š\n\u0026#34;index.mapping.total_fields.limit\u0026#34;: 1000 ğŸŒŸ 2. Mapping æœ€ä½³å®è·µ 2.1 text + keyword åŒå­—æ®µæ¨¡å¼ï¼ˆæœ€ç»å…¸ï¼‰ \u0026#34;title\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;fields\u0026#34;: { \u0026#34;raw\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;keyword\u0026#34; } } } ç”¨é€”ï¼š\ntitle åšå…¨æ–‡æœç´¢ title.raw åšæ’åºã€èšåˆ 2.2 çŠ¶æ€å­—æ®µç»ä¸ä½¿ç”¨ text é”™è¯¯ï¼ˆéå¸¸æŸæ€§èƒ½ï¼‰ï¼š\n\u0026#34;status\u0026#34;: \u0026#34;text\u0026#34; æ­£ç¡®ï¼š\n\u0026#34;status\u0026#34;: \u0026#34;keyword\u0026#34; æ‰€æœ‰æšä¸¾ç±»å­—æ®µéƒ½ç”¨ keywordã€‚\n2.3 é¿å… nested è¿‡å¤šï¼ˆnested æŸ¥è¯¢éå¸¸æ…¢ï¼‰ å¦‚æœå¯ä»¥ï¼š\nç”¨å¯¹è±¡æ•°ç»„æ›¿ä»£ æˆ–è€…æ‰å¹³åŒ–ç»“æ„ï¼ˆdenormalizationï¼‰ 2.4 ç¦æ­¢ dynamic mappingï¼ˆç”Ÿäº§å¿…é¡»å…³é—­ï¼‰ \u0026#34;dynamic\u0026#34;: \u0026#34;strict\u0026#34; å‡å°‘å­—æ®µçˆ†ç‚¸ + é˜²æ­¢åƒåœ¾æ•°æ®æ±¡æŸ“ç´¢å¼•ã€‚\nğŸŒŸ 3. å†™å…¥ï¼ˆIndexingï¼‰æœ€ä½³å®è·µ 3.1 ä½¿ç”¨ bulk æ‰¹é‡å†™å…¥ æ¯æ‰¹ 1kâ€“5k æ–‡æ¡£æœ€ä½³ã€‚\n3.2 åˆ·æ–°é—´éš”è°ƒæ•´ï¼ˆå†™å…¥é‡å¤§æ—¶ï¼‰ é»˜è®¤ 1s åˆ·æ–°å¤ªé¢‘ç¹ï¼Œå†™å…¥ååä¸‹è·Œã€‚\næ—¥å¿—ç±»åœºæ™¯ï¼š\n\u0026#34;refresh_interval\u0026#34;: \u0026#34;30s\u0026#34; æ™®é€šä¸šåŠ¡ï¼š\n\u0026#34;refresh_interval\u0026#34;: \u0026#34;5s\u0026#34; 3.3 å†™å…¥é«˜å³°æ—¶å‡å°‘å‰¯æœ¬æ•° é«˜å†™å…¥åœºæ™¯ï¼ˆå¦‚å¯¼å…¥å¤§é‡æ•°æ®ï¼‰ï¼š\nnumber_of_replicas: 0 å¯¼å…¥å®Œæˆåå†æ”¹å›ï¼š\nnumber_of_replicas: 1 3.4 translog é…ç½® å†™å¯†é›†å‹åº”ç”¨ï¼š\nindex.translog.durability: async index.translog.sync_interval: 30s ååé‡æå¤§æå‡ã€‚\nğŸŒŸ 4. æœç´¢ï¼ˆQueryï¼‰æœ€ä½³å®è·µ 4.1 æŸ¥è¯¢ä¼˜å…ˆä½¿ç”¨ filterï¼ˆç¼“å­˜ + ä¸è¯„åˆ†ï¼‰ \u0026#34;bool\u0026#34;: { \u0026#34;filter\u0026#34;: [ {\u0026#34;term\u0026#34;: {\u0026#34;status\u0026#34;: \u0026#34;active\u0026#34;}} ] } filter æŸ¥è¯¢æ€§èƒ½æé«˜ï¼Œæœç´¢ç¼“å­˜å‘½ä¸­å¤šã€‚\n4.2 é¿å… wildcardã€regexpã€prefix è¿‡åº¦ä½¿ç”¨ æœ‰ä»¥ä¸‹æƒ…å†µè¯·é€‰æ‹©ï¼š\nåœºæ™¯ æ›¿ä»£æ–¹å¼ å‰ç¼€åŒ¹é… prefix edge_ngram æ¨¡ç³ŠæŸ¥è¯¢ fuzzyï¼ˆæœ‰é™åº¦ï¼‰ æ¨¡ç³ŠåŒ¹é… ngram 4.3 é¿å…æ·±åº¦åˆ†é¡µ ä¸è¦ï¼š\nfrom: 200000 æ”¹ç”¨ï¼š\nsearch_after æˆ–è€… scrollï¼ˆå¯¼å‡ºå¤§é‡æ•°æ®ï¼‰ 4.4 èšåˆå­—æ®µå¿…é¡»æ˜¯ keyword text å­—æ®µä¸èƒ½èšåˆã€‚\n4.5 æ‰“åˆ†é«˜è´¨é‡æœç´¢ç»Ÿä¸€ç”¨ bool + boost æé«˜ä¸»å­—æ®µè¯„åˆ†ï¼š\n\u0026#34;match\u0026#34;: { \u0026#34;title\u0026#34;: { \u0026#34;query\u0026#34;: \u0026#34;python\u0026#34;, \u0026#34;boost\u0026#34;: 3 } } ğŸŒŸ 5. åˆ†ç‰‡ï¼ˆShardï¼‰æœ€ä½³å®è·µ 5.1 åˆ†ç‰‡è¿‡å¤šæ˜¯ ES æ€§èƒ½æ€æ‰‹ ç—‡çŠ¶ï¼š\nJVM heap çˆ†é«˜ é›†ç¾¤å˜æ…¢ é›†ç¾¤æ¢å¤æ—¶é—´è¿‡é•¿ åŸåˆ™ï¼š\nåªåˆ†å¤Ÿæ¥ä¸‹æ¥ 1 å¹´çš„é‡ï¼Œä¸è¦å¤š æ¯èŠ‚ç‚¹ shard æ•° â‰¤ 20 Ã— CPU æ ¸æ•°ï¼ˆç»éªŒå€¼ï¼‰ 5.2 å‰¯æœ¬æ•°æ ¹æ®åœºæ™¯åŠ¨æ€è°ƒæ•´ åœºæ™¯ å‰¯æœ¬æ•° æ—¥å¿—å†™å…¥é«˜å³° 0 æ­£å¸¸ä¸šåŠ¡ 1 é«˜è¯»å–é‡ 2â€“3 ğŸŒŸ 6. è¿ç»´æœ€ä½³å®è·µ 6.1 ç¦ç”¨ swapï¼ˆå¿…é¡»ï¼‰ bootstrap.memory_lock: true 6.2 JVM heap = ç‰©ç†å†…å­˜ 50% ä¸è¦è¶…è¿‡ 32GBï¼ˆå¦åˆ™å…³é—­å‹ç¼©æŒ‡é’ˆï¼Œæ€§èƒ½ç›´çº¿ä¸‹é™ï¼‰ã€‚\n6.3 SSDï¼Œç¦ç”¨æœºæ¢°ç¡¬ç›˜ï¼ˆHDDï¼‰ ES å¯¹ç£ç›˜ IO éå¸¸æ•æ„Ÿã€‚\n6.4 ä½¿ç”¨ ILM ç®¡ç†ç´¢å¼•ç”Ÿå‘½å‘¨æœŸ è‡ªåŠ¨ï¼š\nrollover warm / cold / frozen delete 6.5 snapshot æ•°æ®å¤‡ä»½å¿…é¡»æœ‰ å¿«ç…§æ¢å¤æ˜¯åˆ†å¸ƒå¼é›†ç¾¤æ ¸å¿ƒèƒ½åŠ›ã€‚\n6.6 ä½¿ç”¨ä¸“ç”¨ masterï¼ˆ3 èŠ‚ç‚¹ï¼‰ ç”Ÿäº§å¿…é¡»åˆ†ç¦»ï¼š\nmaster data ğŸŒŸ 7. å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡åˆ«è¿™ä¹ˆåšï¼‰ âŒ åæ¨¡å¼ åŸå›  ä¸€ä¸ªç´¢å¼•å‡ ç™¾ GB åˆ†ç‰‡è¿ç§»æ…¢ï¼Œæ¢å¤æ…¢ å…¨å­—æ®µ dynamic mapping å­—æ®µçˆ†ç‚¸ æœç´¢ç”¨ wildcard â€œ*â€ å‰ç¼€ å…¨è¡¨æ‰«æ from=100000 æ·±åˆ†é¡µ æ…¢æ­» æ‰€æœ‰å­—æ®µéƒ½ text èšåˆã€æ’åºæ— æ•ˆ keyword åšå…¨æ–‡æœç´¢ åŒ¹é…ä¸åˆ° JVM heap \u0026gt; 32GB ç¦ç”¨å‹ç¼©æŒ‡é’ˆ ä¸€ä¸ªèŠ‚ç‚¹ 1000 shard OOM é£é™© ğŸŒŸ 8. å®‰å…¨æœ€ä½³å®è·µ å¯ç”¨ xpack.security HTTPS ä¼ è¾“ API key ç®¡ç†æœåŠ¡ä¹‹é—´æƒé™ ç´¢å¼•çº§åˆ«æƒé™ Kibana + Spaces + RBAC ğŸŒŸ 9. ä¸‰å¤§å¸¸è§åœºæ™¯æœ€ä½³å®è·µ 9.1 æ—¥å¿—ç³»ç»Ÿï¼ˆELKï¼‰ index æŒ‰å¤©æ»šåŠ¨ refresh_interval = 30s replicas = 0ï¼ˆé«˜å³°ï¼‰ keyword ç”¨äºèšåˆ ç¦æ­¢ wildcard å…¨æ¨¡ç³Š ä½¿ç”¨ ILM 9.2 ç”µå•†æœç´¢ï¼ˆç»“æ„åŒ– + æ–‡æœ¬ï¼‰ æ ‡é¢˜ text + keyword.raw åˆ†ç±» keyword ä»·æ ¼ range + æ•°å­—ç±»å‹ æ—¥æœŸ date ä½¿ç”¨ search_after åˆ†é¡µ 9.3 æ–‡æœ¬å‘é‡æ£€ç´¢ï¼ˆdense_vectorï¼‰ ä½¿ç”¨ HNSWï¼ˆES8 é»˜è®¤ï¼‰ ç»´åº¦ â‰¤ 2048 ä½¿ç”¨ knn æŸ¥è¯¢ ","description":"ç›®å½•\nç´¢å¼•è®¾è®¡ Mapping è®¾è®¡ å†™å…¥ä¼˜åŒ– æœç´¢ä¼˜åŒ– åˆ†ç‰‡ä¸èŠ‚ç‚¹è§„åˆ’ è¿ç»´ä¸ç›‘æ§ å¸¸è§åæ¨¡å¼ å®‰å…¨ä¸ç¨³å®šæ€§ æ—¥å¿—/æœç´¢/ç”µå•†ä¸‰ç±»åœºæ™¯æœ€ä½³å®è·µ ğŸŒŸ 1. ç´¢å¼•ï¼ˆIndexï¼‰æœ€ä½³å®è·µ 1.1 ä¸€ä¸ªç´¢å¼•æ•°æ®é‡æ§åˆ¶åœ¨ 30â€“50GB / shard ç†ç”±ï¼š\nåˆ†ç‰‡å¤ªå¤§ï¼šè¿ç§»å›°éš¾ï¼Œæ¢å¤æ…¢ åˆ†ç‰‡å¤ªå°ï¼šshard è¿‡å¤šï¼ˆæµªè´¹å†…å­˜ï¼‰ æ¨èï¼š\næ€»æ•°æ®é‡ / 40GB = æ¨è shard æ•°é‡ 1.2 æŒ‰æ—¥æœŸæ»šåŠ¨ï¼ˆæ—¥å¿—ç±»ï¼‰ ä¸è¦æŠŠæ—¥å¿—å…¨éƒ¨å†™å…¥ logs ç´¢å¼•ã€‚\n"},{"id":202,"href":"/database/elasticsearch/classic-issues/","title":"ElasticSearch ç»å…¸é—®é¢˜","parent":"ElasticSearch","content":"Elasticsearch çš„æ ¸å¿ƒé—®é¢˜æ˜¯ã€Œç´¢å¼•è®¾è®¡ + å†™æ”¾å¤§ + é›†ç¾¤ç¨³å®šæ€§ã€\nä¸€ã€Elasticsearch å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆéå¸¸é«˜é¢‘ï¼‰ 1ï¸âƒ£ å†™å…¥ä¸€è‡´æ€§é—®é¢˜ï¼ˆå‡†å®æ—¶ â‰  å®æ—¶ï¼‰ é—®é¢˜\nå†™å…¥ ES åç«‹åˆ»æŸ¥è¯¢ï¼ŒæŸ¥ä¸åˆ°æ•°æ® ä¸æ•°æ®åº“ç»“æœä¸ä¸€è‡´ åŸå› \nES æ˜¯ Near Real Timeï¼ˆNRTï¼‰ é»˜è®¤ refresh_interval = 1s è¡¨ç°\nå†™å…¥æˆåŠŸ -\u0026gt; é©¬ä¸ŠæŸ¥è¯¢ -\u0026gt; ç»“æœä¸ºç©º è§£å†³\nå…³é”®è·¯å¾„æ‰‹åŠ¨ refresh æŸ¥è¯¢ç”¨ DB åšå…œåº• å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ ä¸è¦ç›´æ¥æŸ¥ ES 2ï¸âƒ£ Mapping è®¾è®¡é”™è¯¯ï¼ˆä¸€æ—¦é”™å°±å¾ˆéš¾æ”¹ï¼‰ é—®é¢˜\nå­—æ®µè¢«è‡ªåŠ¨æ˜ å°„æˆ text keyword / date / number é”™è¯¯ æ•°å€¼è¢«å½“æˆå­—ç¬¦ä¸² åæœ\næ— æ³•æ’åº / èšåˆ æŸ¥è¯¢æ€§èƒ½æå·® åªèƒ½é‡å»ºç´¢å¼• å…¸å‹å‘\n\u0026#34;price\u0026#34;: \u0026#34;100\u0026#34; -\u0026gt; text è§£å†³\nç¦ç”¨åŠ¨æ€ mapping æ‰‹åŠ¨å®šä¹‰ mapping ç‰ˆæœ¬åŒ–ç´¢å¼•ï¼ˆindex_v1 / v2ï¼‰ 3ï¸âƒ£ åˆ†ç‰‡è®¾è®¡ä¸åˆç†ï¼ˆES çš„â€œæ…¢æ€§ç—…â€ï¼‰ é—®é¢˜\nåˆ†ç‰‡è¿‡å¤š åˆ†ç‰‡è¿‡å¤§ åˆ†ç‰‡ä¸å¯ä¿®æ”¹ åæœ\né›†ç¾¤å…ƒæ•°æ®è†¨èƒ€ æŸ¥è¯¢æ…¢ æ¢å¤æ…¢ ç»éªŒå€¼\næŒ‡æ ‡ å»ºè®® å•åˆ†ç‰‡å¤§å° 10GB ~ 50GB åˆ†ç‰‡æ•° â‰¤ èŠ‚ç‚¹æ•° Ã— 2~3 ç´¢å¼•æ•° é¿å…ç™¾ä¸‡çº§ 4ï¸âƒ£ æ·±åº¦åˆ†é¡µé—®é¢˜ï¼ˆfrom + sizeï¼‰ é—®é¢˜\nfrom = 100000 size = 10 åæœ\næ¯ä¸ª shard éƒ½è¦æ’åº + ä¸¢å¼ƒ å†…å­˜æš´æ¶¨ æŸ¥è¯¢è¶…æ—¶ æ­£ç¡®å§¿åŠ¿\nsearch_after scroll é™åˆ¶æœ€å¤§åˆ†é¡µæ·±åº¦ 5ï¸âƒ£ èšåˆï¼ˆAggregationï¼‰å†…å­˜çˆ†ç‚¸ é—®é¢˜\nterms èšåˆå­—æ®µåŸºæ•°æé«˜ cardinalityã€nested æ»¥ç”¨ åæœ\nJVM å †å†…å­˜ OOM èŠ‚ç‚¹é¢‘ç¹ GC è§£å†³\næ§åˆ¶å­—æ®µåŸºæ•° ä½¿ç”¨ keyword + doc_values é™åˆ¶èšåˆå±‚çº§ 6ï¸âƒ£ ES è¢«å½“æ•°æ®åº“ç”¨ï¼ˆè®¾è®¡çº§é”™è¯¯ï¼‰ é—®é¢˜\näº‹åŠ¡ å¼ºä¸€è‡´ join update é«˜é¢‘ åæœ\næ€§èƒ½å·® æ•°æ®é”™ä¹± è¿ç»´å¤æ‚ åŸåˆ™\nES æ˜¯æœç´¢å¼•æ“ï¼Œä¸æ˜¯æ•°æ®åº“\näºŒã€Elasticsearch è¿ç»´ä¾§å¸¸è§é—®é¢˜ï¼ˆè¡€æ³ªç»éªŒï¼‰ 7ï¸âƒ£ å†™æ”¾å¤§ \u0026amp; ç£ç›˜æš´æ¶¨ åŸå› \nsegment ä¸æ–­ merge update å®é™…æ˜¯ delete + insert å‰¯æœ¬æ”¾å¤§ è¡¨ç°\nå†™å…¥ 100GB ç£ç›˜æ¶¨ 300GB+ è§£å†³\nåˆç† refresh_interval å‡å°‘ update å†·çƒ­åˆ†ç¦» + ILM 8ï¸âƒ£ JVM å†…å­˜é—®é¢˜ï¼ˆES æœ€å¤§é›·åŒºï¼‰ å…¸å‹é”™è¯¯\nheap è®¾ç½®è¿‡å¤§ è¶…è¿‡ 32GB åæœ\næŒ‡é’ˆå‹ç¼©å¤±æ•ˆ Full GC èŠ‚ç‚¹å‡æ­» é»„é‡‘è§„åˆ™\nheap = min(32GB, ç‰©ç†å†…å­˜ 50%)\n9ï¸âƒ£ Master ä¸ç¨³å®šï¼ˆè„‘è£‚ï¼‰ é—®é¢˜\nmaster èŠ‚ç‚¹å’Œ data èŠ‚ç‚¹æ··ç”¨ ç½‘ç»œæŠ–åŠ¨ åæœ\né›†ç¾¤çº¢ ç´¢å¼•åªè¯» æœåŠ¡ä¸å¯ç”¨ è§£å†³\nä¸“ç”¨ master èŠ‚ç‚¹ å¥‡æ•°ä¸ªï¼ˆ3 / 5ï¼‰ ä¸æ‰¿è½½æ•°æ® ğŸ”Ÿ ç£ç›˜æ°´ä½è§¦å‘å†™ä¿æŠ¤ é»˜è®¤é˜ˆå€¼\n85% -\u0026gt; relocate 90% -\u0026gt; ç¦æ­¢å†™å…¥ï¼ˆåªè¯»ï¼‰ è¡¨ç°\nindex read-only / write rejected æ¢å¤æ–¹å¼\nPUT _all/_settings { \u0026#34;index.blocks.read_only_allow_delete\u0026#34;: null } 1ï¸âƒ£1ï¸âƒ£ é›†ç¾¤æ¢å¤æ…¢ åŸå› \nåˆ†ç‰‡è¿‡å¤š åˆ†ç‰‡è¿‡å¤§ ç½‘ç»œå¸¦å®½ä¸è¶³ å½±å“\nèŠ‚ç‚¹é‡å¯ -\u0026gt; é•¿æ—¶é—´ yellow / red 1ï¸âƒ£2ï¸âƒ£ Snapshot / å¤‡ä»½è¢«å¿½ç•¥ å¸¸è§è¯¯åŒº\nä»¥ä¸ºå‰¯æœ¬å°±æ˜¯å¤‡ä»½ ç›´æ¥ rsync data ç›®å½• æ­£è§£\nSnapshot æ‰æ˜¯å”¯ä¸€æ­£ç¡®å¤‡ä»½æ–¹å¼ 1ï¸âƒ£3ï¸âƒ£ æ»¥ç”¨é€šé…ç¬¦æŸ¥è¯¢ *abc* å…¨ç´¢å¼•æ‰«æ CPU é£™å‡ ä¸‰ã€Redis vs Elasticsearch é—®é¢˜å¯¹ç…§ ç»´åº¦ Redis Elasticsearch æ ¸å¿ƒé—®é¢˜ ç¼“å­˜ä¸€è‡´æ€§ ç´¢å¼•è®¾è®¡ æ•°æ®ä¸€è‡´æ€§ å¼± å¼±ï¼ˆNRTï¼‰ å®¹é‡é—®é¢˜ å†…å­˜çˆ† ç£ç›˜ + heap æ‰©å®¹é£é™© rehash shard è§„åˆ’ é«˜å¹¶å‘ å•çº¿ç¨‹ å¤š shard å¸¸è§ OOM å¤§ key èšåˆ / fielddata è¿ç»´å¤æ‚åº¦ ä¸­ é«˜ å››ã€æ€»ç»“ Redis çš„é—®é¢˜ä¸»è¦é›†ä¸­åœ¨ç¼“å­˜ä¸€è‡´æ€§å’Œå‡»ç©¿é›ªå´©ï¼Œ è€Œ Elasticsearch çš„é—®é¢˜æ›´å¤šæ¥è‡ªç´¢å¼•è®¾è®¡ä¸å½“ã€åˆ†ç‰‡è§„åˆ’é”™è¯¯ã€ JVM å†…å­˜å’Œé›†ç¾¤ç¨³å®šæ€§ã€‚\nåœ¨å¼€å‘é˜¶æ®µéœ€è¦é‡ç‚¹å…³æ³¨ mappingã€åˆ†é¡µå’Œèšåˆè®¾è®¡ï¼Œ åœ¨è¿ç»´é˜¶æ®µè¦é‡ç‚¹å…³æ³¨åˆ†ç‰‡æ•°é‡ã€ç£ç›˜æ°´ä½ã€ä¸»èŠ‚ç‚¹ç¨³å®šæ€§ä»¥åŠå¤‡ä»½ç­–ç•¥ã€‚\n","description":"Elasticsearch çš„æ ¸å¿ƒé—®é¢˜æ˜¯ã€Œç´¢å¼•è®¾è®¡ + å†™æ”¾å¤§ + é›†ç¾¤ç¨³å®šæ€§ã€\nä¸€ã€Elasticsearch å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆéå¸¸é«˜é¢‘ï¼‰ 1ï¸âƒ£ å†™å…¥ä¸€è‡´æ€§é—®é¢˜ï¼ˆå‡†å®æ—¶ â‰  å®æ—¶ï¼‰ é—®é¢˜\nå†™å…¥ ES åç«‹åˆ»æŸ¥è¯¢ï¼ŒæŸ¥ä¸åˆ°æ•°æ® ä¸æ•°æ®åº“ç»“æœä¸ä¸€è‡´ åŸå› \nES æ˜¯ Near Real Timeï¼ˆNRTï¼‰ é»˜è®¤ refresh_interval = 1s è¡¨ç°\nå†™å…¥æˆåŠŸ -\u0026gt; é©¬ä¸ŠæŸ¥è¯¢ -\u0026gt; ç»“æœä¸ºç©º è§£å†³\n"},{"id":203,"href":"/database/elasticsearch/node-roles/","title":"ElasticSearch èŠ‚ç‚¹è§’è‰²","parent":"ElasticSearch","content":"ElasticSearch èŠ‚ç‚¹æ˜¯â€œåˆ†å¸ƒå¼æœç´¢æ•°æ®åº“â€ä¸­çš„ç‹¬ç«‹è¿è¡Œå•å…ƒï¼ŒèŠ‚ç‚¹è§’è‰²å†³å®šå®ƒåœ¨é›†ç¾¤ä¸­æ‰¿æ‹…çš„èŒè´£ã€‚\nåˆç†ä½¿ç”¨èŠ‚ç‚¹è§’è‰² = é«˜æ€§èƒ½ + é«˜ç¨³å®šæ€§ + é«˜æ‰©å±•æ€§ã€‚\nES 7.x -\u0026gt; 8.x å¯¹è§’è‰²è¿›è¡Œäº†å¤§é‡å¢å¼ºï¼Œä»¥ä¸‹å†…å®¹ä¸ºæœ€æ–°å®Œæ•´ç‰ˆæœ¬ã€‚\nä¸€è§ˆè¡¨ï¼šæ‰€æœ‰ ES èŠ‚ç‚¹è§’è‰²ï¼ˆå®Œæ•´ï¼‰ è§’è‰² é…ç½®å€¼ ä½œç”¨ Master èŠ‚ç‚¹ master è´Ÿè´£é›†ç¾¤ç®¡ç†ã€é€‰ä¸»ã€åˆ†ç‰‡è°ƒåº¦ Data èŠ‚ç‚¹ï¼ˆç»å…¸ï¼‰ data æ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½å¯æ”¾ç½® Hot æ•°æ®èŠ‚ç‚¹ data_hot å†™å…¥ã€å®æ—¶æœç´¢ï¼ˆé«˜æ€§èƒ½å±‚ï¼‰ Warm æ•°æ®èŠ‚ç‚¹ data_warm æ¸©æ•°æ®å­˜å‚¨ã€ä½é¢‘æŸ¥è¯¢ Cold æ•°æ®èŠ‚ç‚¹ data_cold å†·æ•°æ®/HDD å­˜å‚¨ Frozen æ•°æ®èŠ‚ç‚¹ data_frozen æœç´¢ S3/MinIO ä¸­çš„å¿«ç…§æ•°æ® Ingest èŠ‚ç‚¹ ingest Pipeline é¢„å¤„ç†ã€è§£æã€grok Machine Learning èŠ‚ç‚¹ ml è¿è¡Œ ML jobã€å¼‚å¸¸æ£€æµ‹ Transform èŠ‚ç‚¹ transform è¿è¡Œæ•°æ®é€è§†ã€æŒ‡æ ‡èšåˆ Coordinating-only èŠ‚ç‚¹ ï¼ˆæ— é…ç½®ï¼Œåªæ˜¯å‰¥ç¦»æ‰€æœ‰è§’è‰²ï¼‰ è´Ÿè½½å‡è¡¡ + è·¯ç”± + æŸ¥è¯¢åè°ƒ Remote Cluster Client remote_cluster_client è·¨é›†ç¾¤æœç´¢ï¼ˆCCSï¼‰ã€è·¨é›†ç¾¤å¤åˆ¶ Voting-only èŠ‚ç‚¹ voting_only å‚ä¸é€‰ä¸»ä½†ä¸åš master Search èŠ‚ç‚¹ï¼ˆ8.x æ–°ï¼‰ data_content å­˜æ”¾ç”¨æˆ·å†…å®¹æ•°æ® Tiersï¼ˆå±‚çº§ç®¡ç†ï¼‰ data_hot/data_warm/\u0026hellip; çµæ´»ç®¡ç†æ•°æ®ç”Ÿå‘½å‘¨æœŸ ğŸ€ 1. Master èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒæ§åˆ¶å±‚ï¼‰ é…ç½®\nnode.roles: [\u0026#34;master\u0026#34;] èŒè´£\né€‰ä¸» / ä¿æŒé›†ç¾¤å¥åº· ç®¡ç†é›†ç¾¤çŠ¶æ€ï¼ˆCluster Stateï¼‰ ç®¡ç†åˆ†ç‰‡è°ƒåº¦ï¼ˆshard allocationï¼‰ åˆ›å»º/åˆ é™¤ç´¢å¼• ç®¡ç†èŠ‚ç‚¹åŠ å…¥å’Œé€€å‡º ç‰¹ç‚¹\nä¸å­˜å‚¨æ•°æ® CPU/å†…å­˜å‹åŠ›ä½ï¼Œä½† ä¸èƒ½æŒ‚ å»ºè®® 3 ä¸ªï¼ˆå¥‡æ•°ï¼‰ æœ€ä½³å®è·µ\nmaster å•ç‹¬éƒ¨ç½²ï¼šå¼ºçƒˆæ¨è å†…å­˜ 4â€“8GB è¶³å¤Ÿ ç£ç›˜ä¸é‡è¦ï¼Œä½†ä¸èƒ½æ»¡ ğŸ—’ï¸ 2. Data èŠ‚ç‚¹ï¼ˆæ•°æ®å±‚ï¼‰ æ—§æ—¶ä»£\nnode.roles: [\u0026#34;data\u0026#34;] ä»£è¡¨æ‰¿æ‹…æ‰€æœ‰æ•°æ®èŒè´£ï¼šå†™å…¥ + æœç´¢ + çƒ­/å†·æ•°æ®ã€‚\nä½†ä» ES 7.10 å¼€å§‹ï¼Œå®˜æ–¹å»ºè®®æ”¹ç”¨ Hot/Warm/Cold/Frozen æ•°æ®åˆ†å±‚ã€‚\nğŸ”¥ 3. Hot æ•°æ®èŠ‚ç‚¹ï¼ˆé«˜æ€§èƒ½å†™å…¥å±‚ï¼‰ é…ç½®\nnode.roles: [\u0026#34;data_hot\u0026#34;] ç”¨é€”\né«˜å¹¶å‘å†™å…¥ï¼ˆLogstashã€Beatsï¼‰ Realtime æŸ¥è¯¢ refresh/merge é«˜å¼€é”€ä»»åŠ¡ æœ€ä½³å®è·µ\nNVMe SSD å¼º CPUï¼ˆ8+ æ ¸ï¼‰ å¤§å†…å­˜ï¼ˆ16â€“64GBï¼‰ shard å°½é‡å°ï¼ˆâ‰¤ 30GBï¼‰ ğŸŸ¡ 4. Warm æ•°æ®èŠ‚ç‚¹ï¼ˆä¸­å±‚ï¼Œå°‘é‡æŸ¥è¯¢ï¼‰ é…ç½®\nnode.roles: [\u0026#34;data_warm\u0026#34;] ç”¨é€”\nç´¢å¼•å†™å…¥å®Œæˆåå­˜æ”¾ Warm å±‚ ä½é¢‘æŸ¥è¯¢ æ‰¹é‡ merge åä¿æŒé•¿æœŸå¯æŸ¥ æœ€ä½³å®è·µ\næ™®é€š SSD å³å¯ å¤§å®¹é‡ç£ç›˜ é…åˆ ILMï¼š \u0026#34;allocate\u0026#34;: { \u0026#34;include\u0026#34;: {\u0026#34;data\u0026#34;: \u0026#34;warm\u0026#34;} } ğŸ§Š 5. Cold æ•°æ®èŠ‚ç‚¹ï¼ˆä½æˆæœ¬å½’æ¡£æŸ¥è¯¢ï¼‰ é…ç½®\nnode.roles: [\u0026#34;data_cold\u0026#34;] ç”¨é€”\nå†å²æ•°æ®ï¼ˆ180 å¤©+ï¼‰ æŸ¥è¯¢éå¸¸ä½ åŸºæœ¬åªä¿ç•™å¯æŸ¥æ€§ ç‰¹ç‚¹\nHDD æœºæ¢°ç›˜å³å¯ å¯¹ CPU è¦æ±‚ä½ æŸ¥è¯¢é€Ÿåº¦æ¯” warm æ…¢ â„ï¸ 6. Frozen æ•°æ®èŠ‚ç‚¹ï¼ˆå¯æœç´¢å¿«ç…§å±‚ï¼‰ é…ç½®\nnode.roles: [\u0026#34;data_frozen\u0026#34;] ç”¨é€”\nä»å¯¹è±¡å­˜å‚¨ï¼ˆS3ã€OSSã€MinIOï¼‰æŒ‰éœ€åŠ è½½æŸ¥è¯¢æ•°æ® æˆæœ¬æœ€ä½ ä½¿ç”¨ searchable snapshot ç‰¹ç‚¹ï¼š\nä¸å­˜å‚¨æ•°æ® æŸ¥è¯¢æ—¶ä»å¯¹è±¡å­˜å‚¨åŠ è½½ å»¶è¿Ÿæé«˜ï¼ˆç§’çº§ï¼‰ ğŸ§ª 7. Ingest èŠ‚ç‚¹ï¼ˆé¢„å¤„ç†å±‚ï¼‰ é…ç½®\nnode.roles: [\u0026#34;ingest\u0026#34;] ç”¨é€”\ngrok è§£æ geoip log enrich pipeline å¤„ç† æœ€ä½³å®è·µï¼š\nè‹¥ Logstash è´Ÿè½½å¤§ï¼Œå¯è®© ES Ingest å¤„ç†éƒ¨åˆ†æ•°æ® å¯æ‰©å®¹å¤šä¸ª Ingest èŠ‚ç‚¹ ğŸ¤– 8. Machine Learningï¼ˆMLï¼‰èŠ‚ç‚¹ é…ç½®\nnode.roles: [\u0026#34;ml\u0026#34;] ç”¨é€”\nAnomaly detectionï¼ˆå¼‚å¸¸æ£€æµ‹ï¼‰ Data frame analytics æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒä¸æ¨ç† åªæœ‰åœ¨ä½¿ç”¨ Elastic ML åŠŸèƒ½æ—¶æ‰éœ€è¦ã€‚\nğŸ”„ 9. Transform èŠ‚ç‚¹ é…ç½®\nnode.roles: [\u0026#34;transform\u0026#34;] ç”¨é€”\næ•°æ®æ¢çº½ï¼ˆç±»ä¼¼æ•°æ®é€è§†è¡¨ï¼‰ ç”Ÿæˆ summary index / rollup index é€‚åˆ BI/åˆ†æåœºæ™¯ã€‚\nğŸ“¡ 10. Remote Cluster Client é…ç½®\nnode.roles: [\u0026#34;remote_cluster_client\u0026#34;] å¯¹è·¨é›†ç¾¤æœç´¢ï¼ˆCCS/CCRï¼‰æœ‰ç”¨ã€‚\nğŸ—³ï¸ 11. Voting-only èŠ‚ç‚¹ é…ç½®\nnode.roles: [\u0026#34;voting_only\u0026#34;] ç”¨é€”ï¼š\nå‚ä¸é€‰ä¸» ä¸æ‰¿æ‹…ä»»ä½•å…¶å®ƒ master èŒè´£ ç”¨äºå°é›†ç¾¤æé«˜é€‰ä¸»å¯é æ€§ å…¸å‹ä¾‹å­ï¼š\nä¸¤ä¸»ä¸€ vote-only -\u0026gt; å¯é¿å… split-brainã€‚\nğŸŒ 12. Coordinating-only èŠ‚ç‚¹ï¼ˆåè°ƒå±‚ï¼‰ é…ç½®æ–¹å¼ï¼š\nnode.roles: [] ï¼ˆæŠŠæ‰€æœ‰è§’è‰²å»æ‰å³å¯ï¼‰\nç”¨é€”ï¼š\nclient node èšåˆ è·¯ç”±è¯·æ±‚ æ‰§è¡Œ query é˜¶æ®µçš„ reduce æœ€ä½³å®è·µï¼š\nå¤§é›†ç¾¤ä¸­ç»Ÿä¸€ä½¿ç”¨ åè°ƒèŠ‚ç‚¹ æ¥å¤„ç† heavy query æœ‰æ•ˆé™ä½ Data Node çš„å‹åŠ› ğŸ§© æœ€ä½³å®è·µï¼šç”Ÿäº§é›†ç¾¤çš„è§’è‰²è§„åˆ’ â­ ä¸­å‹é›†ç¾¤ï¼ˆæ—¥å¿—ç±»ï¼‰ èŠ‚ç‚¹ç±»å‹ æ•°é‡ è¯´æ˜ 3 Ã— master 3 ä»… master 3 Ã— hot 3 NVMe 3 Ã— warm 3 æ™®é€š SSD 3 Ã— cold 3 HDD 1â€“2 Ã— ingest å¯é€‰ Log é¢„å¤„ç† 1â€“2 Ã— coordinating-only å¯é€‰ æœç´¢åˆ†å‘/èšåˆ â­ å¤§å‹é›†ç¾¤ï¼ˆä¸šåŠ¡æœç´¢ï¼‰ èŠ‚ç‚¹ç±»å‹ ç”¨é€” master é€‰ä¸»ã€çŠ¶æ€ data_content ä¸šåŠ¡æ•°æ® coordinating-only æŸ¥è¯¢åè°ƒ ml å¼‚å¸¸æ£€æµ‹ transform ç»Ÿè®¡åˆ†æ ","description":"ElasticSearch èŠ‚ç‚¹æ˜¯â€œåˆ†å¸ƒå¼æœç´¢æ•°æ®åº“â€ä¸­çš„ç‹¬ç«‹è¿è¡Œå•å…ƒï¼ŒèŠ‚ç‚¹è§’è‰²å†³å®šå®ƒåœ¨é›†ç¾¤ä¸­æ‰¿æ‹…çš„èŒè´£ã€‚\nåˆç†ä½¿ç”¨èŠ‚ç‚¹è§’è‰² = é«˜æ€§èƒ½ + é«˜ç¨³å®šæ€§ + é«˜æ‰©å±•æ€§ã€‚\nES 7.x -\u0026gt; 8.x å¯¹è§’è‰²è¿›è¡Œäº†å¤§é‡å¢å¼ºï¼Œä»¥ä¸‹å†…å®¹ä¸ºæœ€æ–°å®Œæ•´ç‰ˆæœ¬ã€‚\nä¸€è§ˆè¡¨ï¼šæ‰€æœ‰ ES èŠ‚ç‚¹è§’è‰²ï¼ˆå®Œæ•´ï¼‰ è§’è‰² é…ç½®å€¼ ä½œç”¨ Master èŠ‚ç‚¹ master è´Ÿè´£é›†ç¾¤ç®¡ç†ã€é€‰ä¸»ã€åˆ†ç‰‡è°ƒåº¦ Data èŠ‚ç‚¹ï¼ˆç»å…¸ï¼‰ data æ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½å¯æ”¾ç½® Hot æ•°æ®èŠ‚ç‚¹ data_hot å†™å…¥ã€å®æ—¶æœç´¢ï¼ˆé«˜æ€§èƒ½å±‚ï¼‰ Warm æ•°æ®èŠ‚ç‚¹ data_warm æ¸©æ•°æ®å­˜å‚¨ã€ä½é¢‘æŸ¥è¯¢ Cold æ•°æ®èŠ‚ç‚¹ data_cold å†·æ•°æ®/HDD å­˜å‚¨ Frozen æ•°æ®èŠ‚ç‚¹ data_frozen æœç´¢ S3/MinIO ä¸­çš„å¿«ç…§æ•°æ® Ingest èŠ‚ç‚¹ ingest Pipeline é¢„å¤„ç†ã€è§£æã€grok Machine Learning èŠ‚ç‚¹ ml è¿è¡Œ ML jobã€å¼‚å¸¸æ£€æµ‹ Transform èŠ‚ç‚¹ transform è¿è¡Œæ•°æ®é€è§†ã€æŒ‡æ ‡èšåˆ Coordinating-only èŠ‚ç‚¹ ï¼ˆæ— é…ç½®ï¼Œåªæ˜¯å‰¥ç¦»æ‰€æœ‰è§’è‰²ï¼‰ è´Ÿè½½å‡è¡¡ + è·¯ç”± + æŸ¥è¯¢åè°ƒ Remote Cluster Client remote_cluster_client è·¨é›†ç¾¤æœç´¢ï¼ˆCCSï¼‰ã€è·¨é›†ç¾¤å¤åˆ¶ Voting-only èŠ‚ç‚¹ voting_only å‚ä¸é€‰ä¸»ä½†ä¸åš master Search èŠ‚ç‚¹ï¼ˆ8.x æ–°ï¼‰ data_content å­˜æ”¾ç”¨æˆ·å†…å®¹æ•°æ® Tiersï¼ˆå±‚çº§ç®¡ç†ï¼‰ data_hot/data_warm/\u0026hellip; çµæ´»ç®¡ç†æ•°æ®ç”Ÿå‘½å‘¨æœŸ ğŸ€ 1. Master èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒæ§åˆ¶å±‚ï¼‰ é…ç½®\n"},{"id":204,"href":"/database/elasticsearch/operation/","title":"ElasticSearch è¿ç»´","parent":"ElasticSearch","content":"ğŸš€ ElasticSearch è¿ç»´æŒ‡å—ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…å¤‡ï¼‰\nå†…å®¹è¦†ç›–ï¼š\né›†ç¾¤è§„åˆ’ é…ç½®ä¼˜åŒ–ï¼ˆå†™ã€æŸ¥ã€å†…å­˜ã€GCï¼‰ ç›‘æ§æŒ‡å— å¸¸è§æ•…éšœæ’æŸ¥ ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ å¤‡ä»½ä¸æ¢å¤ï¼ˆå¿«ç…§ï¼‰ ç£ç›˜ã€åˆ†ç‰‡ã€JVM è°ƒä¼˜ å®‰å…¨ä¸æƒé™é…ç½® Kubernetes éƒ¨ç½²å»ºè®® é«˜å¯ç”¨æ¶æ„ç¤ºä¾‹ 1. é›†ç¾¤è§„åˆ’ï¼ˆæ ¸å¿ƒï¼‰ èŠ‚ç‚¹ç±»å‹ ç”Ÿäº§å¿…é¡»æ‹†åˆ†è§’è‰²ï¼š\nç±»å‹ ä½œç”¨ æ¨èé…ç½® master ç®¡ç†é›†ç¾¤å…ƒæ•°æ® CPUä½ã€å†…å­˜ä½ã€ç¨³å®šå³å¯ data å­˜å‚¨+æœç´¢+å†™å…¥ é«˜ CPU + é«˜ IO + å¤§å†…å­˜ ingest pipelineã€logstash æ›¿ä»£ é€‚é‡ coordinating è·¯ç”±æŸ¥è¯¢è´Ÿè½½ å¯é€‰ æ¨èé…ç½®ï¼š\n3 masterï¼ˆå¥‡æ•°ï¼‰ è‹¥å¹² data nodeï¼ˆ2+ï¼‰ å¯é€‰ 1~2 coordinating é¿å… master/data æ··ç”¨ï¼ˆå¤§è§„æ¨¡æ›´æ˜“æ•…éšœï¼‰ã€‚\n2. ç”Ÿäº§é…ç½®ï¼ˆæœ€å…³é”®éƒ¨åˆ†ï¼‰ ä¿®æ”¹ elasticsearch.yml æ—¶ ä¸è¦ä¹±æ”¹ä¸Šç™¾ä¸ªå‚æ•°ï¼Œç”Ÿäº§åªå…³æ³¨ä¸‹é¢æ ¸å¿ƒé…ç½®ã€‚\n2.1 Java Heap é…ç½®ï¼ˆéå¸¸å…³é”®ï¼‰ -Xms16g -Xmx16g åŸåˆ™ï¼š\nå›ºå®š heapï¼Œä¸è¦è®© ES è‡ªåŠ¨æ‰©å®¹ Heap â‰ˆ ç‰©ç†å†…å­˜çš„ 50% ä¸è¶…è¿‡ 32GBï¼ˆè¶…è¿‡ 32GB ä¼šå…³é—­å‹ç¼©æŒ‡é’ˆ OOPï¼Œæ€§èƒ½éª¤é™ï¼‰ 2.2 é¿å… swapï¼ˆå¼ºåˆ¶ï¼‰ bootstrap.memory_lock: true å¹¶è®¾ç½®ï¼š\nulimit -l unlimited 2.3 åˆ†ç‰‡æ•°é‡ï¼ˆæ ¸å¿ƒï¼‰ å• shard 30~50GB æœ€ä¼˜ã€‚\nå¸¸ç”¨å…¬å¼ï¼š\nshards = ceil(æ€»æ•°æ®é‡ / 40GB) é”™è¯¯ç¤ºä¾‹ï¼š\nå•ç´¢å¼• 1TB + 1 åˆ†ç‰‡ï¼ˆå¤ªå¤§ï¼‰ å•ç´¢å¼• 50GB + 20 åˆ†ç‰‡ï¼ˆå¤ªä¹±ï¼‰ 2.4 ç”Ÿäº§å¿…é¡»ç¦ç”¨è‡ªåŠ¨åˆ›å»ºç´¢å¼• action.auto_create_index: false é¿å…å†™é”™ç´¢å¼•åå¯¼è‡´é‡ç”Ÿç´¢å¼•ã€‚\n2.5 æœ€ä¼˜ refresh_interval æ—¥å¿—åœºæ™¯ï¼š\nrefresh_interval: 30s æœç´¢å®æ—¶æ€§è¦æ±‚ä½ï¼š\nrefresh_interval: 10s é»˜è®¤ 1s ä¼šå¯¼è‡´å†™å…¥å‹åŠ›å·¨å¤§ï¼ï¼\n2.6 translog ä¼˜åŒ– é«˜å†™å…¥é‡æ¨èï¼š\nindex.translog.durability: async index.translog.sync_interval: 30s å†™æ—¥å¿—ç³»ç»Ÿï¼ˆELKï¼‰éå¸¸å¥½ç”¨ã€‚\n2.7 å†™å…¥æ€§èƒ½ä¼˜åŒ– å¯ç”¨ååæ¨¡å¼ï¼š\nindex.number_of_replicas: 0 refresh_interval: 30s å†™å…¥å®Œæˆåå†è®¾ç½®ä¸ºï¼š\nnumber_of_replicas: 1 refresh_interval: 1s 3. ç›‘æ§ï¼ˆå¯è§‚æµ‹æ€§ï¼‰ 3.1 å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡ èŠ‚ç‚¹å±‚é¢ JVM heap ä½¿ç”¨ç‡ï¼ˆ\u0026gt;75%ä¸å¥åº·ï¼‰ GC æ—¶é—´ï¼ˆFull GC è¯´æ˜å †å¤ªå¤§ï¼‰ CPU IO å»¶è¿Ÿ Disk ä½¿ç”¨ç‡ï¼ˆ90% ä¼šå¯¼è‡´åªè¯»ï¼‰ é›†ç¾¤å±‚é¢ cluster healthï¼ˆred/yellow/greenï¼‰ unassigned shards æ•°é‡ indexing throughputï¼ˆå†™å…¥é€Ÿç‡ï¼‰ search latencyï¼ˆTP50/TP95ï¼‰ segment merges è€—æ—¶ 3.2 Kibana ç›‘æ§ å®‰è£… X-Pack -\u0026gt; Monitoring -\u0026gt; Node / Index / Cluster\n3.3 Prometheus + Grafana ä½¿ç”¨ exporterï¼š\nprometheus-elasticsearch-exporter æ ¸å¿ƒ dashboardï¼š\nJVM heap indexing rate / search rate segment merge cache hit ratio 4. å¸¸è§æ•…éšœæ’æŸ¥ï¼ˆæœ€å®ç”¨éƒ¨åˆ†ï¼‰ 4.1 RED çŠ¶æ€ é€šå¸¸åŸå› ï¼š\nåˆ†ç‰‡ä¸¢å¤± èŠ‚ç‚¹å®•æœº å‰¯æœ¬æ— æ³•åˆ†é… -\u0026gt; æœºå™¨ç©ºé—´ä¸å¤Ÿ ç£ç›˜ \u0026gt; 90% -\u0026gt; ES è‡ªåŠ¨åªè¯» è§£å†³ï¼š\nGET _cluster/allocation/explain 4.2 åˆ†ç‰‡æ— æ³•åˆ†é…ï¼ˆæœ€å¸¸è§ï¼‰ åŸå› ï¼š\nèŠ‚ç‚¹ç£ç›˜ä¸è¶³ èŠ‚ç‚¹è§’è‰²ä¸åŒ¹é… è®¾ç½®äº† shard allocation filtering æ¢å¤ï¼š\nPUT _cluster/settings { \u0026#34;transient\u0026#34;: {\u0026#34;cluster.routing.allocation.enable\u0026#34;: \u0026#34;all\u0026#34;} } 4.3 å†™å…¥æŠ¥é”™ï¼šFORBIDDEN/12/index read-only / allow delete åŸå› ï¼šç£ç›˜è¶…è¿‡ 90% é˜ˆå€¼\nè§£é™¤ï¼š\nPUT */_settings { \u0026#34;index.blocks.read_only_allow_delete\u0026#34;: false } 4.4 æŸ¥è¯¢è€—æ—¶é«˜ å¸¸è§åŸå› ï¼š\næ·±åº¦åˆ†é¡µ from=100000 è¿‡å¤š wildcard æŸ¥è¯¢ nested æ•°é‡å·¨å¤§ èšåˆè¿‡å¤š bucket keyword å­—æ®µæœªå¼€å¯ doc_valuesï¼ˆé»˜è®¤å¼€å¯ï¼‰ 4.5 å†™å…¥æ…¢ åŸå› ï¼š\nrefresh_interval å¤ªå° replica å¤ªå¤š shard å¤ªå¤š merge è¿‡ç¨‹è¿‡å¤š 5. ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ 5.1 ä¸è¦ä¸€ä¸ªç´¢å¼•æ°¸è¿œå¢é•¿ æ—¥å¿—ç±»ç´¢å¼•å¿…é¡»æ»šåŠ¨ï¼š\nå‘½åæ–¹å¼ï¼š\nlogs-2025.01.01 logs-2025.01.02 ä½¿ç”¨ Index Lifecycle Managementï¼ˆILMï¼‰ï¼š\n{ \u0026#34;policy\u0026#34;: { \u0026#34;phases\u0026#34;: { \u0026#34;hot\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;rollover\u0026#34;: { \u0026#34;max_age\u0026#34;: \u0026#34;1d\u0026#34;, \u0026#34;max_size\u0026#34;: \u0026#34;40GB\u0026#34; } }}, \u0026#34;warm\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;forcemerge\u0026#34;: {\u0026#34;max_num_segments\u0026#34;: 1 }}}, \u0026#34;cold\u0026#34;: {}, \u0026#34;delete\u0026#34;: { \u0026#34;actions\u0026#34;: { \u0026#34;delete\u0026#34;: {\u0026#34;min_age\u0026#34;: \u0026#34;30d\u0026#34;} }} } } } 5.2 mapping å¿…é¡»æå‰è®¾è®¡ï¼Œç¦æ­¢åŠ¨æ€ mapping index.mapper.dynamic: false é¿å…å­—æ®µçˆ†ç‚¸ï¼ˆfield explosionï¼‰ã€‚\n6. å¤‡ä»½ä¸æ¢å¤ï¼ˆSnapshotï¼‰ ES è‡ªå¸¦ snapshotï¼ˆéå¸¸å¼ºå¤§ï¼‰ã€‚\n1 æ³¨å†Œä»“åº“ PUT _snapshot/my_backup { \u0026#34;type\u0026#34;: \u0026#34;fs\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;location\u0026#34;: \u0026#34;/data/es-backup\u0026#34; } } 2. åˆ›å»ºå¿«ç…§ PUT _snapshot/my_backup/snap-20250101 3. æ¢å¤ POST _snapshot/my_backup/snap-20250101/_restore 7. ç£ç›˜è°ƒä¼˜ æ–‡ä»¶æè¿°ç¬¦\nulimit -n 65536 ç¦ç”¨ swap\nswapoff -a æŒ‚è½½ ext4/xfsï¼ˆæ¨èï¼‰\nç¦ç”¨ atime 8. å®‰å…¨ä¸æƒé™ å¯ç”¨ xpackï¼ˆES 8 é»˜è®¤å¼€å¯ï¼‰ï¼š\nxpack.security.enabled: true xpack.security.transport.ssl.enabled: true åˆ›å»ºç”¨æˆ·è§’è‰²ï¼š\nPOST /_security/user/admin æƒé™ç²’åº¦æ”¯æŒ index-level / field-levelã€‚\n9. Kubernetes éƒ¨ç½²å»ºè®®ï¼ˆé‡ç‚¹æ¨èï¼‰ æ¨èç»“æ„ï¼š\n3x master StatefulSet n x data StatefulSet 1~2 x coordinating Deployment å¿…é¡»é…ç½®ï¼š\nanti-affinityï¼ˆé¿å… master æ”¾åŒä¸€èŠ‚ç‚¹ï¼‰ local storage or SSD è®¾ç½® JVM heap readiness/liveness probes nodeSelectorï¼ˆå›ºå®šèŠ‚ç‚¹ï¼‰ æ•°æ®èŠ‚ç‚¹ StatefulSet Volumeï¼š\nvolumeClaimTemplates: - name: data storageClassName: local-ssd resources: requests: storage: 500Gi 10. é«˜å¯ç”¨å‚è€ƒæ¶æ„ï¼ˆç”Ÿäº§ï¼‰ 3 x dedicated master (2CPU/4G) 6 x data node (8CPU/32G/SSD) 1 x coordinating node 1 x machine for kibana 1 x machine for logstash / ingest ","description":"ğŸš€ ElasticSearch è¿ç»´æŒ‡å—ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…å¤‡ï¼‰\nå†…å®¹è¦†ç›–ï¼š\né›†ç¾¤è§„åˆ’ é…ç½®ä¼˜åŒ–ï¼ˆå†™ã€æŸ¥ã€å†…å­˜ã€GCï¼‰ ç›‘æ§æŒ‡å— å¸¸è§æ•…éšœæ’æŸ¥ ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ å¤‡ä»½ä¸æ¢å¤ï¼ˆå¿«ç…§ï¼‰ ç£ç›˜ã€åˆ†ç‰‡ã€JVM è°ƒä¼˜ å®‰å…¨ä¸æƒé™é…ç½® Kubernetes éƒ¨ç½²å»ºè®® é«˜å¯ç”¨æ¶æ„ç¤ºä¾‹ 1. é›†ç¾¤è§„åˆ’ï¼ˆæ ¸å¿ƒï¼‰ èŠ‚ç‚¹ç±»å‹ ç”Ÿäº§å¿…é¡»æ‹†åˆ†è§’è‰²ï¼š\nç±»å‹ ä½œç”¨ æ¨èé…ç½® master ç®¡ç†é›†ç¾¤å…ƒæ•°æ® CPUä½ã€å†…å­˜ä½ã€ç¨³å®šå³å¯ data å­˜å‚¨+æœç´¢+å†™å…¥ é«˜ CPU + é«˜ IO + å¤§å†…å­˜ ingest pipelineã€logstash æ›¿ä»£ é€‚é‡ coordinating è·¯ç”±æŸ¥è¯¢è´Ÿè½½ å¯é€‰ æ¨èé…ç½®ï¼š\n"},{"id":205,"href":"/database/elasticsearch/cluster/","title":"ElasticSearch é›†ç¾¤","parent":"ElasticSearch","content":"å†…å®¹æ¶µç›–ï¼šé›†ç¾¤æ¶æ„ã€èŠ‚ç‚¹è§’è‰²ã€åˆ†ç‰‡æœºåˆ¶ã€è·¯ç”±ã€å¤åˆ¶ã€ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€ç½‘ç»œã€æ‰©å®¹ç¼©å®¹ã€æœ€ä½³å®è·µã€é›†ç¾¤è§„åˆ’æ–¹æ¡ˆã€‚\n1. ä»€ä¹ˆæ˜¯ ES é›†ç¾¤ï¼Ÿ ElasticSearch é›†ç¾¤æ˜¯ å¤šä¸ªèŠ‚ç‚¹ï¼ˆNodesï¼‰ååŒå·¥ä½œï¼Œå­˜å‚¨æ•°æ®ã€æä¾›æœç´¢ã€æä¾›é«˜å¯ç”¨èƒ½åŠ›çš„é€»è¾‘æ•´ä½“ã€‚\nä¸€ä¸ªé›†ç¾¤ç”±ï¼š\ncluster nameï¼ˆå¿…é¡»ä¸€è‡´ï¼‰ ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ ç´¢å¼•ï¼ˆindexï¼‰ + åˆ†ç‰‡ï¼ˆshardï¼‰ ä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ç®¡ç†é›†ç¾¤å…ƒæ•°æ® data èŠ‚ç‚¹å­˜å‚¨æ•°æ® 2. ElasticSearch èŠ‚ç‚¹ç±»å‹ï¼ˆéå¸¸å…³é”®ï¼‰ èŠ‚ç‚¹è§’è‰²ç±»å‹ â­ ä» ES 7.x ä»¥åæ‰€æœ‰èŠ‚ç‚¹ã€Œé»˜è®¤å…¨è§’è‰²ã€ï¼Œä½†ç”Ÿäº§å¿…é¡»æ‹†åˆ†ã€‚\nè§’è‰² åŠŸèƒ½ æ˜¯å¦å»ºè®®ç‹¬ç«‹ master å…ƒæ•°æ®ã€é›†ç¾¤ç®¡ç†ã€åˆ†ç‰‡è°ƒåº¦ âœ… å¼ºçƒˆå»ºè®®ç‹¬ç«‹ 3 èŠ‚ç‚¹ data å­˜å‚¨ + æœç´¢ + èšåˆ âœ… æ•°æ®é‡å¤§æ—¶éœ€è¦å¤šèŠ‚ç‚¹ data_hot çƒ­æ•°æ®å†™å…¥ âœ… çƒ­æ•°æ®åˆ†å±‚åœºæ™¯ data_warm/cold å†·æ•°æ®å­˜å‚¨ âœ… ILM coordinating-only è´Ÿè´£ query åˆ†å‘ã€åˆå¹¶ç»“æœ å¯é€‰ ingest pipeline é¢„å¤„ç† å¯é€‰ é›†ç¾¤æ¨èç»“æ„ï¼ˆå¸¸ç”¨ä¸‰ç§ï¼‰ âœ… å°è§„æ¨¡ï¼ˆ\u0026lt; 3TBï¼‰\n3 ä¸ª Master + Data æ··éƒ¨ï¼ˆæœ€ä½å¯ç”¨ï¼‰ âœ… ä¸­ç­‰è§„æ¨¡ï¼ˆ3TB ~ 30TBï¼‰\n3 Master 6â€“12 Data èŠ‚ç‚¹ 1â€“3 Coordinating Nodes âœ… å¤§è§„æ¨¡ï¼ˆ30TB+ï¼‰\n3 Dedicated Master N Hot Nodes N Warm Nodes N Coordinating Nodes 3. é›†ç¾¤æ ¸å¿ƒæœºåˆ¶ 3.1 åˆ†ç‰‡ï¼ˆShardï¼‰ â­ æ¯ä¸ªç´¢å¼•ä¼šè¢«åˆ‡æˆå¤šä¸ª Primary Shardï¼ˆä¸»åˆ†ç‰‡ï¼‰ å’Œ Replica Shardï¼ˆå‰¯æœ¬ï¼‰\nå¦‚ï¼š\nindexA: 5 ä¸»åˆ†ç‰‡ï¼Œæ¯ä¸ª 1 å‰¯æœ¬ -\u0026gt; å…± 10 åˆ†ç‰‡ 3.2 è·¯ç”±æœºåˆ¶ï¼ˆRoutingï¼‰ â­ ElasticSearch ç”¨ä»¥ä¸‹æ–¹å¼å®šä½æ–‡æ¡£å±äºå“ªä¸ªåˆ†ç‰‡ï¼š\nshard = hash(_id) % number_of_primary_shards ç‰¹ç‚¹ï¼š\nä¸»åˆ†ç‰‡æ•°é‡ ç´¢å¼•åˆ›å»ºåä¸èƒ½ä¿®æ”¹ æ‰©å®¹åªèƒ½é€šè¿‡åˆ›å»ºæ–°ç´¢å¼• + Reindex 3.3 å¤åˆ¶æœºåˆ¶ï¼ˆReplicationï¼‰ â­ å‰¯æœ¬åˆ†ç‰‡ç”¨äºï¼š\né«˜å¯ç”¨ è¯»æ‰©å±• åŒä¸€ä¸ªä¸»åˆ†ç‰‡çš„å‰¯æœ¬ç»ä¸ä¼šè½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹\n3.4 ä¸»èŠ‚ç‚¹é€‰ä¸¾ â­ ES ä½¿ç”¨ Zen2 ç®—æ³•ï¼ˆRaft å˜ç§ï¼‰è¿›è¡Œé€‰ä¸¾ã€‚\nå¿…é¡»ï¼š\nè‡³å°‘ 3 ä¸ª Master èŠ‚ç‚¹ discovery.seed_hosts é…ç½®æ­£ç¡® å¦åˆ™ä¼šäº§ç”Ÿ master flappingï¼ˆä¸»èŠ‚ç‚¹éœ‡è¡ï¼‰ã€‚\n3.5 è·¨èŠ‚ç‚¹é€šä¿¡ â­ 9300 ç«¯å£ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡ 9200 ç”¨äº REST API è‹¥ 9300 è¢«é˜²ç«å¢™é˜»æŒ¡ -\u0026gt; èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ã€‚\n4. é›†ç¾¤æ‰©å®¹ç¼©å®¹æœºåˆ¶ 4.1 æ‰©å®¹ï¼ˆå¢åŠ èŠ‚ç‚¹ï¼‰ â­ æ–°å¢ data èŠ‚ç‚¹ -\u0026gt; è‡ªåŠ¨è§¦å‘åˆ†ç‰‡é‡åˆ†é…ã€‚\nå¿…é¡»ç¡®è®¤ï¼š\ncluster.routing.allocation.enable = all å¦åˆ™å¯èƒ½ä¸åˆ†é…åˆ†ç‰‡ã€‚\n4.2 ç¼©å®¹ï¼ˆå‡å°‘èŠ‚ç‚¹ï¼‰ â­ éœ€è¦å…ˆï¼š\nPUT _cluster/settings { \u0026#34;transient\u0026#34;: { \u0026#34;cluster.routing.allocation.exclude._name\u0026#34;: \u0026#34;node-01\u0026#34; } } æ•°æ®è¿èµ°åå†å…³èŠ‚ç‚¹ã€‚\n5. é›†ç¾¤å¥åº·ï¼ˆhealthï¼‰çŠ¶æ€ çŠ¶æ€ å«ä¹‰ åŸå›  ğŸŸ¢ Green ä¸» + å‰¯æœ¬å…¨éƒ¨ ok é›†ç¾¤å¥åº· ğŸŸ¡ Yellow ä¸»åˆ†ç‰‡ okï¼Œå‰¯æœ¬æœªåˆ†é… èŠ‚ç‚¹ä¸è¶³ / ç£ç›˜ä¸è¶³ ğŸ”´ Red ä¸»åˆ†ç‰‡ä¸å¯ç”¨ æ•°æ®ä¸¢å¤±é£é™©ã€èŠ‚ç‚¹å´©æºƒ æ’æŸ¥å‘½ä»¤ï¼š\nGET /_cluster/allocation/explain 6. é›†ç¾¤ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼ˆå¿…é¡»ç›‘æ§ï¼‰ 6.1 èŠ‚ç‚¹çº§ heap.percent \u0026lt; 75% CPU \u0026lt; 70% load5 \u0026lt; CPU æ ¸å¿ƒæ•° fs.disk_usage \u0026lt; 90% 6.2 åˆ†ç‰‡çº§ unassigned_shards = 0 relocating_shards \u0026lt; 5% 6.3 ç´¢å¼•çº§ segment count indexing latency query latency æ¨èç›‘æ§å·¥å…·ï¼š\nElastic Stackï¼ˆKibanaï¼‰ Grafana + ES Exporter Prometheus 7. é›†ç¾¤æœ€ä½³å®è·µï¼ˆé‡ä¸­ä¹‹é‡ï¼‰ (1) Master æœ€å° 3 ä¸ªï¼ˆå¥‡æ•°ï¼‰ â­ node.roles: [\u0026#34;master\u0026#34;] (2) ä¸è¦æ··ç”¨ master å’Œ dataï¼ˆä¸­å¤§å‹é›†ç¾¤å¿…é¡»åˆ†ç¦»ï¼‰ (3) è§„åˆ’åˆ†ç‰‡æ•°é‡ï¼ˆæœ€å¸¸è§çš„é”™è¯¯ï¼‰ â­ æ¯ä¸ªåˆ†ç‰‡å¤§å° 20GB~50GB æœ€ä½³\nä¼°ç®—ï¼š\nåˆ†ç‰‡æ•°é‡ = æ•°æ®æ€»é‡ / æ¯åˆ†ç‰‡å¤§å° (4) å…³é—­è‡ªåŠ¨åˆ›å»ºç´¢å¼• â­ é¿å…åƒåœ¾ç´¢å¼•æ’‘çˆ†é›†ç¾¤ï¼š\nPUT _cluster/settings { \u0026#34;persistent\u0026#34;: { \u0026#34;action.auto_create_index\u0026#34;: \u0026#34;false\u0026#34; } } (5) ä¸è¦å¼€å¯ swap â­ bootstrap.memory_lock: true (6) JVM ä¸è¦è¶…è¿‡ 31GBï¼ˆå› ä¸ºå‹ç¼©æŒ‡é’ˆï¼‰ â­ heap = ç‰©ç†å†…å­˜ 50% æœ€å¤§ 31GB 8. å…¸å‹é›†ç¾¤æ¶æ„æ–¹æ¡ˆï¼ˆå¯ç›´æ¥ç”¨ï¼‰ ğŸ”¥ æ–¹æ¡ˆ Aï¼šä¸­å‹ä¸šåŠ¡ï¼ˆæ¨èï¼‰ 10 èŠ‚ç‚¹\nèŠ‚ç‚¹ æ•°é‡ é…ç½® Master 3 4C16G Data Hot 4 16C64G Data Warm 2 16C64G Coordinating 1 4C16G é€‚åˆï¼šæ—¥å¿—ã€ä¸šåŠ¡æœç´¢ã€è®¢å•ç³»ç»Ÿã€‚\nğŸ”¥ æ–¹æ¡ˆ Bï¼šä¼ä¸šçº§æ—¥å¿—é›†ç¾¤ï¼ˆELKï¼‰ 25 èŠ‚ç‚¹\n3 Master 10 Hot 6 Warm 6 Cold Coordinating 2 ä½¿ç”¨ ILM ç®¡ç†å†·çƒ­æ•°æ®ã€‚\n9. å¦‚ä½•åˆ¤æ–­é›†ç¾¤éœ€è¦æ‰©å®¹ï¼Ÿ å½“å‡ºç°ä»¥ä¸‹ä»»æ„æƒ…å†µè¦æ‰©å®¹ï¼š\nheap \u0026gt; 75% ç£ç›˜ \u0026gt; 80% æŸ¥è¯¢ P99 \u0026gt; 1s åˆ†ç‰‡æ•° \u0026gt; èŠ‚ç‚¹æ•° Ã— 25 å†™å…¥é€Ÿç‡è¾¾ä¸åˆ°è¦æ±‚ ","description":"å†…å®¹æ¶µç›–ï¼šé›†ç¾¤æ¶æ„ã€èŠ‚ç‚¹è§’è‰²ã€åˆ†ç‰‡æœºåˆ¶ã€è·¯ç”±ã€å¤åˆ¶ã€ä¸»èŠ‚ç‚¹é€‰ä¸¾ã€ç½‘ç»œã€æ‰©å®¹ç¼©å®¹ã€æœ€ä½³å®è·µã€é›†ç¾¤è§„åˆ’æ–¹æ¡ˆã€‚\n1. ä»€ä¹ˆæ˜¯ ES é›†ç¾¤ï¼Ÿ ElasticSearch é›†ç¾¤æ˜¯ å¤šä¸ªèŠ‚ç‚¹ï¼ˆNodesï¼‰ååŒå·¥ä½œï¼Œå­˜å‚¨æ•°æ®ã€æä¾›æœç´¢ã€æä¾›é«˜å¯ç”¨èƒ½åŠ›çš„é€»è¾‘æ•´ä½“ã€‚\nä¸€ä¸ªé›†ç¾¤ç”±ï¼š\ncluster nameï¼ˆå¿…é¡»ä¸€è‡´ï¼‰ ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ ç´¢å¼•ï¼ˆindexï¼‰ + åˆ†ç‰‡ï¼ˆshardï¼‰ ä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ç®¡ç†é›†ç¾¤å…ƒæ•°æ® data èŠ‚ç‚¹å­˜å‚¨æ•°æ® 2. ElasticSearch èŠ‚ç‚¹ç±»å‹ï¼ˆéå¸¸å…³é”®ï¼‰ èŠ‚ç‚¹è§’è‰²ç±»å‹ â­ ä» ES 7.x ä»¥åæ‰€æœ‰èŠ‚ç‚¹ã€Œé»˜è®¤å…¨è§’è‰²ã€ï¼Œä½†ç”Ÿäº§å¿…é¡»æ‹†åˆ†ã€‚\n"},{"id":206,"href":"/backend/python/sqlalchemy/engine/","title":"Engine","parent":"SQLAlchemy","content":"ä¸‹é¢ç»™ä½ ä¸€ä¸ª å…¨é¢ã€æ¸…æ™°ã€å®æˆ˜å‘ çš„ SQLAlchemy Engine è®²è§£ï¼ŒåŒ…æ‹¬ï¼š\nä»€ä¹ˆæ˜¯ Engine Engine çš„èŒè´£ Engine çš„æœ€ä½³ä½¿ç”¨æ–¹å¼ï¼ˆåŒæ­¥ / å¼‚æ­¥ï¼‰ Engine çš„åˆ›å»ºæ–¹å¼ Engine ç›¸å…³çš„å¸¸è§å‘ ç»“åˆä½ æ­£åœ¨åšçš„ FastAPI + SQLAlchemy + PostgreSQL çš„æ¨èæ¶æ„ ğŸš€ 1. ä»€ä¹ˆæ˜¯ SQLAlchemy Engineï¼Ÿ Engine æ˜¯ SQLAlchemy çš„æ ¸å¿ƒå¯¹è±¡ï¼Œä»£è¡¨ä½ çš„æ•°æ®åº“è¿æ¥åº•å±‚æ¥å£ã€‚\nå®ƒæœ¬è´¨ä¸Šåš 3 ä»¶äº‹æƒ…ï¼š\n1. ç®¡ç†æ•°æ®åº“è¿æ¥æ± ï¼ˆConnection Poolï¼‰ Engine å†…éƒ¨åŒ…å«ä¸€ä¸ªè¿æ¥æ± ï¼ˆé»˜è®¤æ˜¯ QueuePoolï¼‰ã€‚\nè¿™ä½¿å¾— SQLAlchemy ä¸ä¼šæ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºæ–°è¿æ¥ï¼Œé€Ÿåº¦å¤§å¹…æå‡ã€‚\n2. ç®¡ç†æ–¹è¨€ï¼ˆDialectï¼‰ Engine å†³å®šä½ è¿æ¥çš„æ˜¯ PostgreSQLã€MySQLã€SQLiteâ€¦â€¦\nè´Ÿè´£æŠŠ SQLAlchemy çš„è¯­å¥è½¬æ¢æˆå¯¹åº”æ•°æ®åº“çš„ SQLã€‚\n3. æä¾› connect() æ–¹æ³•è·å–åº•å±‚è¿æ¥ with engine.connect() as conn: conn.execute(text(\u0026#34;SELECT 1\u0026#34;)) å®ƒæ˜¯æ‰€æœ‰ ORM / SQL / Async Session çš„â€œæ ¹æºâ€ã€‚\nğŸš€ 2. å¦‚ä½•åˆ›å»º Engineï¼Ÿ SQLAlchemy 2.0 æ¨èæ–¹å¼ï¼š\nåŒæ­¥ engineï¼ˆå¸¸è§„ Web åç«¯ä½¿ç”¨ä¸æ¨èï¼‰ from sqlalchemy import create_engine engine = create_engine( \u0026#34;postgresql://user:pass@localhost:5432/dbname\u0026#34;, echo=False, pool_size=10, max_overflow=20, ) å¼‚æ­¥ engineï¼ˆFastAPI æ¨èï¼‰ from sqlalchemy.ext.asyncio import create_async_engine async_engine = create_async_engine( \u0026#34;postgresql+asyncpg://user:pass@localhost:5432/dbname\u0026#34;, echo=False, pool_size=10, max_overflow=20, ) FastAPI æ¨èä½¿ç”¨ asyncpg + async engineï¼Œæ€§èƒ½æ›´å¼ºã€‚\nğŸš€ 3. Engine å’Œ Session çš„å…³ç³»ï¼ˆé‡ç‚¹ï¼ï¼‰ ä½ è¦è®°ä½ï¼š\nEngine = è¿æ¥æ± ç®¡ç†è€… Session = ORM æŸ¥è¯¢å¯¹è±¡ ä¸åº”è¯¥åœ¨ä»£ç ä¸­éšä¾¿æ‰§è¡Œï¼š\nengine.connect().execute(...) é™¤éå†™åŸç”Ÿ SQL å·¥å…·å‡½æ•°ï¼ˆä½ ç°åœ¨æ­£åœ¨åšçš„ï¼‰ã€‚\næ­£å¸¸ ORM åº”è¯¥è¿™æ ·ï¼š\nasync with async_session() as session: result = await session.execute(select(User)) ğŸš€ 4. Engine çš„æœ€ä½³ä½¿ç”¨æ–¹å¼ â—Engine åº”è¯¥æ˜¯â€œå…¨å±€å•ä¾‹â€\nä½ ä¸åº”è¯¥æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»º engineï¼ˆéå¸¸æ˜‚è´µï¼‰ã€‚\næ­£ç¡®æ–¹å¼ï¼š\ndb.py\nfrom sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker DATABASE_URL = \u0026#34;postgresql+asyncpg://user:pass@127.0.0.1/db\u0026#34; engine = create_async_engine(DATABASE_URL, echo=False) AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False) åœ¨ FastAPI ä¾èµ–é¡¹ä¸­ä½¿ç”¨ï¼š\nasync def get_db(): async with AsyncSessionLocal() as session: yield session ğŸš€ 5. å¸¸è§å‘ âŒ 5.1 è¿æ¥è€—å°½ å¦‚æœä½ æ²¡æœ‰å…³é—­è¿æ¥ï¼Œä¼šå¯¼è‡´ pool è¢«è€—å°½ï¼š\nconn = engine.connect() # å¿˜è®° close() åº”å§‹ç»ˆä½¿ç”¨ withï¼š\nwith engine.connect() as conn: ... å¼‚æ­¥ï¼š\nasync with engine.connect() as conn: ... âŒ 5.2 åˆ›å»ºè¿‡å¤š Engine ä»¥ä¸‹é”™è¯¯æ–¹å¼ï¼š\ndef get_engine(): return create_async_engine(...) æ¯ä¸ªè¯·æ±‚æ–°å»º engine -\u0026gt; æ€§èƒ½æå·®ã€‚\nâŒ 5.3 Engine æ‰§è¡Œ ORM è¯­å¥ï¼ˆé”™è¯¯ç”¨æ³•ï¼‰ ORM è¯­å¥å¿…é¡»é€šè¿‡ Sessionï¼Œè€Œä¸æ˜¯ Engineã€‚\nğŸš€ 6. ç»“åˆä½ çš„é¡¹ç›®ï¼šæ¨èæ¶æ„ ä½ ç°åœ¨ä½¿ç”¨ï¼š\nFastAPI PostgreSQL SQLAlchemy 2.0 Asyncï¼ˆä½ å°†æ·»åŠ æƒé™æ¨¡å—ã€Casbin ç­‰ï¼‰ æœ€ä½³ç»“æ„å¦‚ä¸‹ï¼š\napp/ â”œâ”€â”€ db/ â”‚ â”œâ”€â”€ engine.py # åˆ›å»ºå…¨å±€ engineã€sessionmaker â”‚ â”œâ”€â”€ base.py # Base = declarative_base() â”‚ â”œâ”€â”€ models/ # ORM models â”‚ â””â”€â”€ utils.py # åŸç”Ÿ SQL å·¥å…·å‡½æ•° â”œâ”€â”€ api/ â”‚ â””â”€â”€ ... # è·¯ç”± â””â”€â”€ main.py # FastAPI å¯åŠ¨å…¥å£ ä½ çš„ engine.pyï¼š\nfrom sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker DATABASE_URL = \u0026#34;postgresql+asyncpg://user:pass@localhost/db\u0026#34; engine = create_async_engine( DATABASE_URL, echo=False, pool_size=10, max_overflow=20, ) async_session = async_sessionmaker( bind=engine, expire_on_commit=False, ) ä½ çš„â€œå·¥å…·æ–¹æ³•â€å¯ä»¥æ³¨å…¥ engineï¼š\nclass SQLTool: def __init__(self, engine): self.engine = engine async def run(self, sql): async with self.engine.connect() as conn: result = await conn.execute(text(sql)) return result.mappings().all() ğŸš€ 7. ä½ é—®çš„é‡ç‚¹ï¼šEngine åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ å¼ºçƒˆå»ºè®®ï¼š\nä½¿ç”¨â€œå¤–éƒ¨ä¼ å…¥ Engineâ€çš„æ–¹å¼ å› ä¸ºï¼š\nå¯æµ‹è¯•æ€§æ›´å¥½ï¼ˆä½ å¯ä»¥ä¼ å…¥æµ‹è¯•æ•°æ®åº“ engineï¼‰ å¯å¤ç”¨ï¼ˆå¤šä¸ªå·¥å…·ç±»å…±äº«åŒä¸€ä¸ª engineï¼‰ é¿å…æ„å¤–åˆ›å»ºå¤šä¸ª engine æŒ‰ä½ çš„é¡¹ç›®ç»“æ„ï¼ˆå¤šæ¨¡å—ï¼‰æ›´æ˜“æ‰©å±• ä¾‹å¦‚ï¼š\nfrom app.db.engine import engine sql_tool = SQLTool(engine) ä¸è¦åœ¨ç±»é‡Œé¢åˆå§‹åŒ–ï¼š\n# âŒ ä¸æ¨è class SQLTool: def __init__(self): self.engine = create_async_engine(...) ğŸ“Œ æ€»ç»“ é¡¹ç›® æ¨èæ–¹å¼ Engine æ˜¯å¦å•ä¾‹ï¼Ÿ âœ… å¿…é¡»æ˜¯å…¨å±€å•ä¾‹ Engine æ”¾å“ªé‡Œï¼Ÿ âœ… åœ¨ db/engine.py ä¸­ç»Ÿä¸€ç®¡ç† å·¥å…·ç±»éœ€è¦ Engine å—ï¼Ÿ âœ… å¤–éƒ¨ä¼ å…¥ï¼Œä¸è¦å†…éƒ¨åˆ›å»º ORM æ“ä½œç”¨ Sessionï¼Ÿ âœ… æ˜¯ åŸç”Ÿ SQL ç”¨ Engineï¼Ÿ âœ… å¯ä»¥ FastAPI é…åˆæ–¹å¼ âœ… async_engine + async_sessionmaker è‡ªå®šä¹‰ç±»ï¼Œæ˜¯åœ¨ç±»ä¸­åˆå§‹åŒ– engine å¥½ï¼Œè¿˜æ˜¯å°†åˆå§‹åŒ–å¥½çš„ engine ä¼ å…¥åˆ°ç±»ä¸­ï¼Ÿ ä¸‹é¢ç»™ä½ ä¸€ä¸ªæ¶æ„çº§åˆ«çš„ç­”æ¡ˆï¼Œè¦†ç›–å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§ã€æ€§èƒ½ã€å¼ºè€¦åˆç­‰æ‰€æœ‰å…³é”®ç‚¹ã€‚\nç»“è®ºéå¸¸æ˜ç¡®ï¼š\nâœ… æœ€ä½³å®è·µï¼šengine åœ¨å¤–éƒ¨åˆå§‹åŒ–ï¼Œç„¶åæ³¨å…¥ï¼ˆä¼ å…¥ï¼‰è‡ªå®šä¹‰ç±»ä¸­\nä¹Ÿå°±æ˜¯ï¼š\nengine = create_engine(...) db = MyDB(engine) è€Œä¸æ˜¯ï¼š\nclass MyDB: def __init__(...): self.engine = create_engine(...) ğŸ“Œ ä¸ºä»€ä¹ˆè¦æŠŠ engine ä¼ å…¥ç±»ï¼ˆä¾èµ–æ³¨å…¥ï¼‰ï¼Ÿ 1. å¯æµ‹è¯•æ€§æ›´å¼ºï¼ˆæœ€é‡è¦ï¼‰ å¦‚æœç±»å†…éƒ¨åˆ›å»º engineï¼Œä½ æ— æ³•æ›¿æ¢ä¸ºï¼š\nSQLite å†…å­˜åº“ æµ‹è¯•æ•°æ®åº“ Mock å¯¹è±¡ è€Œä¾èµ–æ³¨å…¥å¯ä»¥è½»æ¾åšåˆ°ï¼š\ntest_engine = create_engine(\u0026#34;sqlite://\u0026#34;) db = MyDB(test_engine) è¿™æ˜¯å•å…ƒæµ‹è¯•ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€CI/CD å¿…é¡»çš„è®¾è®¡ã€‚\n2. å‡å°‘å…¨å±€è€¦åˆï¼Œç±»æ›´åŠ é€šç”¨ å¦‚æœç±»å†…éƒ¨å†™æ­»ï¼š\ncreate_engine(\u0026#34;postgresql+asyncpg://...\u0026#34;) é‚£ä¹ˆï¼š\nä½ æ— æ³•åˆ‡æ¢æ•°æ®åº“ æ— æ³•è¿æ¥å¤šä¸ªæ•°æ®åº“ æ— æ³•å¤ç”¨è¯¥ç±»ï¼ˆå¼ºè€¦åˆï¼‰ å¦‚æœä¼ å…¥ engineï¼Œä½ å¯ä»¥å¤ç”¨ï¼š\ndb1 = MyDB(engine1) # è¿æ¥æ•°æ®åº“A db2 = MyDB(engine2) # è¿æ¥æ•°æ®åº“B 3. æå‡ç¨‹åºæ¶æ„çš„â€œåˆ†å±‚æ¸…æ™°åº¦â€ é€šå¸¸æ¨èï¼š\napp â¬‡ db_engine / db_session ç®¡ç†å™¨ â¬‡ repository / service å±‚ï¼ˆä½ çš„è‡ªå®šä¹‰ç±»ï¼‰ æ•°æ®åº“è¿æ¥å±äº åŸºç¡€è®¾æ–½å±‚ è€Œä½ çš„ç±»å±äº ä¸šåŠ¡é€»è¾‘å±‚ å¦‚æœä¸¤è€…æ··åœ¨ä¸€èµ· -\u0026gt; æ¶æ„æ··ä¹±ã€éš¾ä»¥ç»´æŠ¤ã€‚\n4. å¯ä»¥åœ¨å¤šä¸ªç±»ä¸­å…±äº« engineï¼ˆæ€§èƒ½æ›´å¥½ï¼‰ engine æ˜¯ä¸€ä¸ªé‡é‡çº§å¯¹è±¡ï¼Œå¹¶ä¸”ï¼š\nå®ƒç»´æŠ¤è¿æ¥æ±  æ˜¯çº¿ç¨‹å®‰å…¨çš„ åº”è¯¥æ˜¯å•ä¾‹ å¤–éƒ¨åˆ›å»º engine -\u0026gt; å…±äº«ä¸€ä¸ªè¿æ¥æ±  -\u0026gt; æ€§èƒ½æœ€ä½³ã€‚\nå¦‚æœæ¯ä¸ªç±»éƒ½è‡ªå·±åˆå§‹åŒ– engineï¼š\nå¤šä¸ªè¿æ¥æ± æµªè´¹èµ„æº æ€§èƒ½æ›´å·® æ± ä¸Šé™éš¾ä»¥ç®¡ç† 5. çµæ´»æ›¿æ¢ä¸º AsyncEngine æœªæ¥ä½ åˆ‡æ¢åˆ° async æ—¶ï¼š\ncreate_async_engine(...) åªéœ€æ›¿æ¢åˆ›å»º engine çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯ä¿®æ”¹æ‰€æœ‰ç±»ã€‚\nğŸ†š å¯¹æ¯”ç¤ºä¾‹ âŒ åæ¨¡å¼ï¼ˆä¸æ¨èï¼‰ class UserRepository: def __init__(self): self.engine = create_engine(\u0026#34;postgresql://...\u0026#34;) ç¼ºç‚¹ï¼š\næ— æ³•æµ‹è¯• æ— æ³•é…ç½® å¤šä¸ªç±»é‡å¤åˆ›å»º engine éš¾ä»¥æ‰©å±•åˆ° async âœ… æ­£ç¡®æ¨¡å¼ï¼ˆæ¨èï¼‰ class UserRepository: def __init__(self, engine): self.engine = engine å¤–éƒ¨ï¼š\nengine = create_engine(\u0026#34;postgresql://...\u0026#34;) user_repo = UserRepository(engine) æ›´çµæ´»ã€æ›´æ¸…æ™°ã€æ›´å¯ç»´æŠ¤ã€‚\nâ­ æ›´é«˜çº§çš„æ–¹å¼ï¼ˆä½ ä¸€å®šä¼šç”¨å¾—åˆ°ï¼‰ å°† engine å°è£…åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†å™¨ä¸­ï¼š\nclass Database: def __init__(self, url: str): self.engine = create_engine(url) self.SessionLocal = sessionmaker(bind=self.engine) db = Database(\u0026#34;postgresql://...\u0026#34;) user_repo = UserRepository(db) ç”šè‡³ä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆFastAPI åŸç”Ÿæ”¯æŒï¼‰ã€‚\nğŸ“Œ æœ€ç»ˆå»ºè®®ï¼ˆé’ˆå¯¹ä½ å½“å‰çš„é¡¹ç›®æ¶æ„ï¼‰ ä½ çš„æŠ€æœ¯æ ˆï¼š\nFastAPI SQLAlchemy 2.x RBAC ç³»ç»Ÿ å¤šæ¨¡å—ç»“æ„ï¼ˆusers, roles, permissions, menusâ€¦ï¼‰ æœ€ä½³æ–¹æ¡ˆæ˜¯ï¼š\nengine å•ä¾‹ â†“ sessionmaker å•ä¾‹ â†“ æ³¨å…¥åˆ° Repository / Service å±‚ è¿™æ ·ç»“æ„æœ€æ¸…æ™°ã€æµ‹è¯•æœ€æ–¹ä¾¿ã€æ€§èƒ½æœ€ä½³ã€‚\nä¸‹é¢ç»™ä½ ä¸€ä»½ æå®Œæ•´ã€ææ¸…æ™°ã€å®æˆ˜çº§çš„ SQLAlchemy 2.0 create_engine / create_async_engine è¯¦ç»†æ•™ç¨‹ï¼ŒåŒ…å«ç”¨æ³•ã€å‚æ•°ã€æœ€ä½³å®è·µã€æ³¨æ„äº‹é¡¹ã€ORM + Core ä½¿ç”¨æ¨¡å¼ç­‰ã€‚\nå†…å®¹é€‚ç”¨äº PostgreSQL / MySQL / SQLite / Oracle / MSSQL å…¨éƒ¨æ•°æ®åº“ã€‚\nğŸš€ ä¸€ã€SQLAlchemy 2.0ï¼šåŒæ­¥ vs å¼‚æ­¥ é¡¹ç›® åŒæ­¥ å¼‚æ­¥ Engine create_engine() create_async_engine() Session Session AsyncSession Run query åŒæ­¥ I/O åŸç”Ÿ async I/O é€‚ç”¨åœºæ™¯ è„šæœ¬ã€æ‰¹å¤„ç†ã€åå°æœåŠ¡ é«˜å¹¶å‘ APIã€FastAPI åŒä¸€é¡¹ç›®å¯åŒæ—¶ç”¨åŒæ­¥å’Œå¼‚æ­¥ï¼Œä½†ä¸å»ºè®®æ··åœ¨åŒä¸€å¥— ORM å¯¹è±¡ä¸­ã€‚\nğŸ— äºŒã€åŒæ­¥ engineï¼šcreate_engine from sqlalchemy import create_engine engine = create_engine( \u0026#34;postgresql+psycopg://user:pass@localhost:5432/dbname\u0026#34;, echo=False, future=True, pool_size=10, max_overflow=20, pool_timeout=30, pool_recycle=1800, ) 2.1 å‚æ•°è¯¦è§£ï¼ˆåŒæ­¥ï¼‰ ğŸ”¹ urlï¼ˆè¿æ¥å­—ç¬¦ä¸²ï¼‰ æ ¼å¼ï¼š\ndialect+driver://username:password@host:port/database ä¾‹å¦‚ï¼š\næ•°æ®åº“ URL ç¤ºä¾‹ PostgreSQL postgresql+psycopg://user:pwd@127.0.0.1/db MySQL mysql+pymysql://user:pwd@127.0.0.1/db SQLite sqlite:///local.db ğŸ”¹ echo æ˜¯å¦æ‰“å° SQLï¼š\nengine = create_engine(url, echo=True) ğŸ”¹ future=True SQLAlchemy 2.0 æ¨èï¼Œæ€»æ˜¯å¼€å¯ã€‚\nğŸ”¹ è¿æ¥æ± å‚æ•° å‚æ•° ä½œç”¨ pool_size ä¿æŒçš„è¿æ¥æ•° max_overflow è¶…å‡º pool_size æ—¶é¢å¤–åˆ›å»ºçš„è¿æ¥ pool_timeout ç­‰å¾…è¿æ¥çš„è¶…æ—¶æ—¶é—´ pool_recycle è¿æ¥å›æ”¶æ—¶é—´ï¼ˆé˜²æ­¢ MySQL â€œgone awayâ€ï¼‰ ç¤ºä¾‹ï¼š\nengine = create_engine( url, pool_size=10, max_overflow=20, pool_recycle=1800, ) ğŸ”¹ pool_pre_ping=True é˜²æ­¢æ•°æ®åº“æ–­å¼€è¿æ¥ï¼ˆå¼ºçƒˆå»ºè®® PostgreSQL/MySQL ç”Ÿäº§å¼€å¯ï¼‰\ncreate_engine(url, pool_pre_ping=True) ğŸ”¹ ç¦ç”¨ poolï¼ˆè„šæœ¬ç±»ï¼‰ è„šæœ¬/çŸ­ä»»åŠ¡ï¼š\nengine = create_engine(url, poolclass=NullPool) 2.2 åŒæ­¥ engine ä½¿ç”¨ç¤ºä¾‹ ORM session\nfrom sqlalchemy.orm import Session with Session(engine) as session: result = session.execute(select(User)) rows = result.scalars().all() Core\nwith engine.connect() as conn: result = conn.execute(text(\u0026#34;SELECT 1\u0026#34;)) print(result.all()) ğŸŒ€ ä¸‰ã€å¼‚æ­¥ engineï¼šcreate_async_engine å¼‚æ­¥ engine ç”±ï¼š\nfrom sqlalchemy.ext.asyncio import create_async_engine åˆ›å»ºï¼š\nasync_engine = create_async_engine( \u0026#34;postgresql+asyncpg://user:pass@localhost/dbname\u0026#34;, echo=False, future=True, pool_size=10, max_overflow=20, pool_recycle=1800, ) 3.1 æ•°æ®åº“é©±åŠ¨å¿…é¡»æ˜¯ async ç‰ˆæœ¬ æ•°æ®åº“ é©±åŠ¨ PostgreSQL asyncpg MySQL aiomysql SQLite aiosqlite ç¤ºä¾‹ï¼š\npostgresql+asyncpg://user:pwd@host/db ä¸èƒ½å†™ï¼š\npostgresql+psycopg://user:pwd@host/db âŒ 3.2 å¼‚æ­¥ engine å‚æ•°å®Œå…¨ä¸åŒæ­¥ engine ç›¸åŒ ä¾‹å¦‚ï¼š\ncreate_async_engine( url, echo=False, pool_size=20, pool_timeout=30, pool_recycle=1800, pool_pre_ping=True, ) 3.3 å¼‚æ­¥æ‰§è¡Œç¤ºä¾‹ ORM AsyncSession\nfrom sqlalchemy.ext.asyncio import AsyncSession async with AsyncSession(async_engine) as session: result = await session.execute(select(User)) rows = result.scalars().all() Core æ–¹å¼\nasync with async_engine.connect() as conn: result = await conn.execute(text(\u0026#34;SELECT 1\u0026#34;)) print(result.all()) 3.4 å¼‚æ­¥ engine å¸¸è§é”™è¯¯ âŒ é”™è¯¯ï¼šä½¿ç”¨åŒæ­¥ Session Session(async_engine) # é”™è¯¯ åº”è¯¥ï¼š\nAsyncSession(async_engine) âŒ é”™è¯¯ï¼šç›´æ¥å¯¹ AsyncSession è°ƒç”¨é async æ–¹æ³• ä¾‹å¦‚ï¼š\nsession.commit() # é”™è¯¯ æ­£ç¡®ï¼š\nawait session.commit() âŒ é”™è¯¯ï¼šURL ä½¿ç”¨é”™è¯¯é©±åŠ¨ æ¯”å¦‚ PostgreSQLï¼š\npostgresql+psycopg://... âŒ è¿™æ˜¯åŒæ­¥ postgresql+asyncpg://... âœ… è¿™æ˜¯å¼‚æ­¥ ğŸ§± å››ã€æ­£ç¡®çš„ Engine + Session ç»„åˆæ–¹å¼ åŒæ­¥ engine = create_engine(url) SessionLocal = sessionmaker(engine, expire_on_commit=False) def get_session(): with SessionLocal() as session: yield session å¼‚æ­¥ async_engine = create_async_engine(url) AsyncSessionLocal = async_sessionmaker( async_engine, expire_on_commit=False ) async def get_session(): async with AsyncSessionLocal() as session: yield session â­ äº”ã€Engine åˆ›å»ºæœ€ä½³å®è·µï¼ˆä½ é¡¹ç›®å¯ç›´æ¥ä½¿ç”¨ï¼‰ ğŸ”¥ PostgreSQL + FastAPIï¼ˆå¼‚æ­¥æ¨èï¼‰\nfrom sqlalchemy.ext.asyncio import create_async_engine DATABASE_URL = \u0026#34;postgresql+asyncpg://user:pwd@127.0.0.1/mydb\u0026#34; engine = create_async_engine( DATABASE_URL, echo=False, pool_size=20, max_overflow=10, pool_pre_ping=True, pool_recycle=1800, future=True, ) ğŸ”¥ åå°ä»»åŠ¡ / ç®¡ç†è„šæœ¬ï¼ˆåŒæ­¥ï¼‰\nfrom sqlalchemy import create_engine DATABASE_URL = \u0026#34;postgresql+psycopg://user:pwd@127.0.0.1/mydb\u0026#34; engine = create_engine( DATABASE_URL, echo=False, pool_pre_ping=True, pool_recycle=1800, ) ğŸ§© å…­ã€è¡¥å……ï¼šEngine ä¸å»ºè®®æ”¾åœ¨ç±»å†…éƒ¨ ä½†å»ºè®®ä½ å°è£…ä¸€ä¸ªå…¨å±€æ•°æ®åº“ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰\nåŸå› ï¼š\nğŸ‘ ä¼˜ç‚¹\nå…¨å±€å…±äº« engineï¼ˆè¿æ¥æ± æ‰èƒ½å‘æŒ¥ä½œç”¨ï¼‰ session factory ç»Ÿä¸€ç®¡ç† é…ç½®é›†ä¸­ï¼Œä¾¿äºè°ƒè¯• é¿å…å¤š engine å¯¼è‡´è¿æ¥æ± çˆ†ç‚¸ æ—¢ç„¶ä¸å»ºè®®åœ¨ç±»ä¸­åˆå§‹åŒ–ï¼Œä¸ºä»€ä¹ˆè¿˜å»ºè®®å°† engine å°è£…åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†å™¨ä¸­ï¼Ÿ éå¸¸å¥½çš„é—®é¢˜â€”â€”è¿™ä¸€ç‚¹ç¡®å®å®¹æ˜“è®©äººå›°æƒ‘ã€‚ å…³é”®åŒºåˆ«åœ¨äºï¼š\nâœ… â€œç±»ä¸­åˆå§‹åŒ– engineâ€ å’Œ â€œæ•°æ®åº“ç®¡ç†å™¨ç»Ÿä¸€å°è£… engineâ€ ä¸æ˜¯ä¸€å›äº‹ï¼\nå®ƒä»¬çš„ç›®çš„ä¸åŒã€é£é™©ä¸åŒã€è®¾è®¡å“²å­¦ä¹Ÿä¸åŒã€‚\næˆ‘æ¥ç»™ä½ è®²éå¸¸æ¸…æ¥šğŸ‘‡\nâŒ 1. ä¸ºä»€ä¹ˆä¸å»ºè®® åœ¨ç±»å†…éƒ¨åˆå§‹åŒ– engineï¼Ÿ ç¤ºä¾‹ï¼ˆä¸æ¨èï¼‰ï¼š\nclass SQLTool: def __init__(self): self.engine = create_async_engine(\u0026#34;postgres://...\u0026#34;) é—®é¢˜ï¼š\nâŒ 1.1 æ¯ä¸ªç±»å®ä¾‹éƒ½é‡æ–°åˆ›å»ºä¸€ä¸ª engineï¼ˆå·¨å¤§å¼€é”€ï¼‰ Engine å†…éƒ¨æœ‰ï¼š\nè¿æ¥æ±  å¤šçº¿ç¨‹é” è¿æ¥åˆå§‹åŒ– æ–¹è¨€åŠ è½½ è¿™æ˜¯æ˜‚è´µå¯¹è±¡ï¼Œåº”è¯¥å…¨å±€å…±äº«ã€‚\nå¦‚æœä½ åˆ›å»ºå¤šä¸ª SQLTool å®ä¾‹ï¼Œå°±ä¼šæœ‰å¤šä¸ª engineï¼Œæ€§èƒ½ä¼šæš´æ­»ã€‚\nâŒ 1.2 éš¾ä»¥æµ‹è¯•ï¼ˆä¸èƒ½æ›¿æ¢ä¸º mock æ•°æ®åº“ï¼‰ ä½ æ— æ³•åœ¨æµ‹è¯•ä¸­è¿™æ ·åšï¼š\nSQLTool(test_engine)\nå› ä¸º SQLTool æŠŠ engine å†™æ­»äº†ã€‚\nâŒ 1.3 éš¾ä»¥æ§åˆ¶è¿æ¥æ± å¤§å° ä¾‹å¦‚ä½ æƒ³è°ƒæ•´ï¼š\npool_size=20 å¿…é¡»ä¿®æ”¹æ¯ä¸ªç±»çš„å†…éƒ¨ä»£ç  -\u0026gt; éå¸¸ç³Ÿç³•ã€‚\nâŒ 1.4 ä¸æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ ä¾‹å¦‚åº”ç”¨å…³é—­æ—¶ï¼š\nawait engine.dispose() å¦‚æœ engine åˆ†æ•£åœ¨ N ä¸ªç±»ä¸­ï¼Œä½ æ ¹æœ¬ä¸çŸ¥é“åœ¨å“ªé‡Œå…³é—­ã€‚\nâš ï¸ æ ¸å¿ƒï¼š\næŠŠ engine åˆ›å»ºå†™æ­»åœ¨æŸä¸ªç±»å†…éƒ¨ = æœ€ä¸çµæ´»ã€æœ€ä¸å¥½ç»´æŠ¤çš„æ¨¡å¼ã€‚\nâœ… 2. ä¸ºä»€ä¹ˆå»ºè®®å°† engine æ”¾åœ¨â€œç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†å™¨ï¼ˆdb.pyï¼‰â€ä¸­ï¼Ÿ å› ä¸ºç»Ÿä¸€ç®¡ç† â‰  åœ¨ç±»ä¸­åˆå§‹åŒ– è€Œæ˜¯ï¼š\nåœ¨å…¨å±€åªåˆ›å»ºä¸€æ¬¡ engine ä¾‹å¦‚ï¼š\ndb/engine.py\nengine = create_async_engine(DATABASE_URL, echo=False) SessionLocal = async_sessionmaker(engine) ç„¶åç”±å…¶ä»–ç±»/æ¨¡å—ä¾èµ–æ³¨å…¥ä½¿ç”¨ï¼ˆDependency Injectionï¼‰ class SQLTool: def __init__(self, engine): self.engine = engine æˆ– FastAPI ä¸­ï¼š\nasync def get_db(): async with SessionLocal() as session: yield session â˜˜ï¸ ä¸ºä»€ä¹ˆè¿™ç§æ–¹å¼æ˜¯æœ€ä½³å®è·µï¼Ÿ å› ä¸ºå®ƒè§£å†³äº†æ‰€æœ‰é—®é¢˜ï¼š\n1) Engine å…¨å±€å”¯ä¸€ï¼ˆä¸é‡å¤åˆ›å»ºï¼‰ æ‰€æœ‰ç»„ä»¶å…±äº«åŒä¸€ä¸ª engine\n-\u0026gt; æ€§èƒ½æœ€ä½³ -\u0026gt; è¿æ¥ç®¡ç†ç»Ÿä¸€ 2) æ‰€æœ‰ç±»èƒ½ä»å¤–éƒ¨æ¥æ”¶ engineï¼ˆä¾èµ–æ³¨å…¥ï¼‰ æ›´çµæ´»\næµ‹è¯•å¯ä»¥è¿™æ ·ï¼š\nSQLTool(test_engine) 3) è¿æ¥æ± é…ç½®ç»Ÿä¸€ ä¾‹å¦‚ pool_sizeã€max_overflowã€timeout\nä¿®æ”¹ä¸€æ¬¡ï¼Œå…¨ç³»ç»Ÿæ›´æ–°ã€‚\n4) ç”Ÿå‘½å‘¨æœŸæ˜ç¡® FastAPI å¯åœ¨ shutdown äº‹ä»¶å…³é—­ engineï¼š\n@app.on_event(\u0026#34;shutdown\u0026#34;) async def shutdown(): await engine.dispose() 5) ä»£ç ç»“æ„æ¸…æ™°å¯ç»´æŠ¤ db.py è´Ÿè´£æ•°æ®åº“åº•åº§ models/ è´Ÿè´£ ORM æ¨¡å‹ crud/ æˆ– service/ è´Ÿè´£ä¸šåŠ¡é€»è¾‘ å·¥å…·ç±»ã€ä»»åŠ¡ã€è„šæœ¬éƒ½å§‹ç»ˆç”¨åŒä¸€ä¸ª engine ğŸ“Œ ç”¨æ€»ç»“ ä¸æ¨èâ€œæ¯ä¸ªç±»è‡ªå·±åˆå§‹åŒ– engineâ€ã€‚\næ¨èâ€œå…¨å±€åªåˆå§‹åŒ–ä¸€æ¬¡ engineâ€ï¼Œåœ¨å…¶ä»–ç±»ä¸­é€šè¿‡å‚æ•°ä¼ å…¥æˆ–ä¾èµ–æ³¨å…¥ä½¿ç”¨ã€‚\næœ€ç»ˆç»“æ„ï¼ˆæœ€ä½³å®è·µç¤ºä¾‹ï¼‰ app/ â”œâ”€â”€ db/ â”‚ â”œâ”€â”€ engine.py # è¿™é‡Œåˆ›å»ºå”¯ä¸€ engine â”‚ â”œâ”€â”€ session.py â”‚ â”œâ”€â”€ base.py â”‚ â””â”€â”€ models/ â”œâ”€â”€ services/ â”‚ â””â”€â”€ sql_tool.py # æ¥æ”¶ engine ä½œä¸ºå‚æ•° â””â”€â”€ api/ engine.py\nengine = create_async_engine(DATABASE_URL, echo=False) SessionLocal = async_sessionmaker(engine, expire_on_commit=False) sql_tool.py class SQLTool: def __init__(self, engine): self.engine = engine async def execute(self, sql): async with self.engine.connect() as conn: result = await conn.execute(text(sql)) return result.mappings().all() ","description":"ä¸‹é¢ç»™ä½ ä¸€ä¸ª å…¨é¢ã€æ¸…æ™°ã€å®æˆ˜å‘ çš„ SQLAlchemy Engine è®²è§£ï¼ŒåŒ…æ‹¬ï¼š\nä»€ä¹ˆæ˜¯ Engine Engine çš„èŒè´£ Engine çš„æœ€ä½³ä½¿ç”¨æ–¹å¼ï¼ˆåŒæ­¥ / å¼‚æ­¥ï¼‰ Engine çš„åˆ›å»ºæ–¹å¼ Engine ç›¸å…³çš„å¸¸è§å‘ ç»“åˆä½ æ­£åœ¨åšçš„ FastAPI + SQLAlchemy + PostgreSQL çš„æ¨èæ¶æ„ ğŸš€ 1. ä»€ä¹ˆæ˜¯ SQLAlchemy Engineï¼Ÿ Engine æ˜¯ SQLAlchemy çš„æ ¸å¿ƒå¯¹è±¡ï¼Œä»£è¡¨ä½ çš„æ•°æ®åº“è¿æ¥åº•å±‚æ¥å£ã€‚\nå®ƒæœ¬è´¨ä¸Šåš 3 ä»¶äº‹æƒ…ï¼š\n1. ç®¡ç†æ•°æ®åº“è¿æ¥æ± ï¼ˆConnection Poolï¼‰ Engine å†…éƒ¨åŒ…å«ä¸€ä¸ªè¿æ¥æ± ï¼ˆé»˜è®¤æ˜¯ QueuePoolï¼‰ã€‚\n"},{"id":207,"href":"/backend/python/official/enumerate/","title":"Enumerate (æšä¸¾)","parent":"Official","content":" ğŸš€ ä»€ä¹ˆæ˜¯ enumerateï¼Ÿ enumerate æ˜¯ Python å†…ç½®å‡½æ•°ï¼š\nåœ¨éå†å¯è¿­ä»£å¯¹è±¡æ—¶ï¼ŒåŒæ—¶è¿”å› â€œç´¢å¼• + å…ƒç´ â€ã€‚\nå®ƒè®©å¾ªç¯æ›´ç®€æ´ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆã€‚\n1. åŸºç¡€ç”¨æ³•ï¼šè·å–ç´¢å¼•å’Œå€¼ for index, value in enumerate([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;]): print(index, value) è¾“å‡ºï¼š\n0 a 1 b 2 c 2. æŒ‡å®šèµ·å§‹ç´¢å¼•ï¼ˆstartï¼‰ for i, v in enumerate([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;], start=1): print(i, v) è¾“å‡ºï¼š\n1 a 2 b 3 c 3. enumerate çš„ 3 ç§å¸¸è§ç”¨é€” 3.1 éå†åˆ—è¡¨è·å– indexï¼ˆæœ€å¸¸è§ï¼‰ for i, item in enumerate(items): ... 3.2 åŒæ­¥æ›´æ–°åˆ—è¡¨ä¸­çš„å…ƒç´  for i, val in enumerate(nums): nums[i] = val * 2 3.3 éå†å­—ç¬¦ä¸²ï¼ˆå­—ç¬¦ + ä½ç½®ï¼‰ for i, ch in enumerate(\u0026#34;hello\u0026#34;): print(i, ch) 4. å’Œ zip ä¸€èµ·ä½¿ç”¨ ç”¨äºå¤„ç†åŒåºåˆ—å¹¶åŒ…å«ç´¢å¼•ï¼š\nfor i, (a, b) in enumerate(zip(list1, list2)): print(i, a, b) 5. enumerate çš„â€œè§£åŒ…å¼â€ä½¿ç”¨ for entry in enumerate([\u0026#34;x\u0026#34;, \u0026#34;y\u0026#34;]): print(entry) è¾“å‡ºï¼š\n(0, \u0026#39;x\u0026#39;) (1, \u0026#39;y\u0026#39;) ä¹Ÿå¯ä»¥ï¼š\ni, val = entry 6. enumerate çš„é«˜çº§æŠ€å·§ 6.1 æ•è·ç´¢å¼•å’Œå…ƒç´ ï¼Œä½†ä¸éœ€è¦å…ƒç´ æ—¶ for i, _ in enumerate(items): print(i) 6.2 æ‰¾åˆ°é¦–æ¬¡æ»¡è¶³æ¡ä»¶çš„ä¸‹æ ‡ï¼ˆéå¸¸å¸¸ç”¨!!!!ï¼‰ idx = next((i for i, v in enumerate(nums) if v == target), -1) 6.3 enumerate + sortedï¼ˆæŒ‰å€¼æ’åºï¼ŒåŒæ—¶è®°å½•åŸå§‹ç´¢å¼•ï¼‰ for i, v in sorted(enumerate(nums), key=lambda x: x[1]): print(i, v) 6.4 enumerate + list comprehensionï¼ˆæ›´ Pythonicï¼‰ indexed = [(i, v) for i, v in enumerate(items)] 7. enumerate vs range(len())ï¼ˆä¸ºä»€ä¹ˆ enumerate æ›´å¥½ï¼‰ å†™æ³• å¯è¯»æ€§ å®‰å…¨æ€§ Pythonic for i in range(len(x)) âŒ å·® âŒ å®¹æ˜“è¶Šç•Œ âŒ for i, v in enumerate(x) âœ… âœ… âœ… ç†ç”±ï¼š\nrange(len()) éœ€è¦è‡ªå·±å–å…ƒç´ ï¼ˆéº»çƒ¦ï¼‰ å®¹æ˜“å†™é”™ enumerate å¯è¯»æ€§æ›´é«˜ enumerate ä¸ä¾èµ–â€œé•¿åº¦â€æ¦‚å¿µï¼ˆé€‚ç”¨èŒƒå›´æ›´å¹¿ï¼‰ 8. enumerate çš„æ€§èƒ½ enumerate å†…éƒ¨ç”¨ C å®ç°ï¼Œæ€§èƒ½éå¸¸é«˜ã€‚\nå®é™…æ€§èƒ½æµ‹è¯•ï¼š\nfor i in range(len(a)): ... # æ…¢ for i, v in enumerate(a): ... # å¿« enumerate æ›´å¿«ã€æ›´å®¹æ˜“è¢« Python ä¼˜åŒ–ã€‚\n9. å‡½æ•°ç­¾å enumerate(iterable, start=0) iterableï¼šåˆ—è¡¨ã€å…ƒç»„ã€å­—ç¬¦ä¸²ã€ç”Ÿæˆå™¨â€¦â€¦ startï¼šåˆå§‹ç´¢å¼• è¿”å›ï¼šenumerate å¯¹è±¡ï¼ˆæƒ°æ€§è¿­ä»£å™¨ï¼‰\nlist(enumerate(\u0026#34;ab\u0026#34;)) # [(0, \u0026#39;a\u0026#39;), (1, \u0026#39;b\u0026#39;)] 10. enumerate + åŠ¨æ€è·³å‡ºå¾ªç¯ for i, v in enumerate(items): if v == target: break 11. æœ€ Pythonic çš„å†™æ³•ï¼ˆæœ€ä½³å®è·µï¼‰ 11.1 éå†å¹¶éœ€è¦ç´¢å¼• -\u0026gt; å¿…ç”¨ enumerate for i, item in enumerate(items): ... 11.2 ä» 1 å¼€å§‹ for i, item in enumerate(items, 1): ... 11.3 æŸ¥æ‰¾ä½ç½® idx = next((i for i, x in enumerate(items) if x == \u0026#34;target\u0026#34;), None) 11.4 åŒæ—¶å¤„ç†å¤šåºåˆ— -\u0026gt; zip + enumerate for i, (a, b) in enumerate(zip(list1, list2)): ... æ€»ç»“ï¼šenumerate çš„æœ¬è´¨ä»·å€¼ è®©å¾ªç¯æ›´ Pythonic æ›´å®‰å…¨ã€å¯è¯» æ€§èƒ½æ›´é«˜ ç”¨æ³•çµæ´»ï¼Œé€‚åˆæ­é…è§£åŒ…ã€zipã€ç”Ÿæˆå™¨ç­‰ å¦‚æœéœ€è¦ index -\u0026gt; ä¸€å¾‹ç”¨ enumerateã€‚\nå¦‚æœä¸éœ€è¦ index -\u0026gt; ä¸€å¾‹ç”¨ for item in iterableã€‚\n","description":" ğŸš€ ä»€ä¹ˆæ˜¯ enumerateï¼Ÿ enumerate æ˜¯ Python å†…ç½®å‡½æ•°ï¼š\nåœ¨éå†å¯è¿­ä»£å¯¹è±¡æ—¶ï¼ŒåŒæ—¶è¿”å› â€œç´¢å¼• + å…ƒç´ â€ã€‚\nå®ƒè®©å¾ªç¯æ›´ç®€æ´ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆã€‚\n1. åŸºç¡€ç”¨æ³•ï¼šè·å–ç´¢å¼•å’Œå€¼ for index, value in enumerate([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;]): print(index, value) è¾“å‡ºï¼š\n0 a 1 b 2 c 2. æŒ‡å®šèµ·å§‹ç´¢å¼•ï¼ˆstartï¼‰ for i, v in enumerate([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;], start=1): print(i, v) è¾“å‡ºï¼š\n"},{"id":208,"href":"/backend/python/official/eval/","title":"Eval å‡½æ•°","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŠPython eval() æœ€ä½³å®è·µ + å®‰å…¨é£é™© + æ›¿ä»£æ–¹æ¡ˆå®Œæ•´ç‰ˆæŒ‡å—ã€‹\nå†…å®¹æ¶µç›–ï¼ševal æ˜¯ä»€ä¹ˆã€èƒ½åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆå±é™©ã€æ­£ç¡®å®‰å…¨æ›¿ä»£æ–¹æ¡ˆã€å®é™…é¡¹ç›®ä¸­çš„æœ€ä½³å†™æ³•ã€‚\nâœ… 1. eval æ˜¯ä»€ä¹ˆï¼Ÿ eval(expr) ä¼šæŠŠ å­—ç¬¦ä¸²è½¬æˆ Python è¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼Œå¹¶è¿”å›è¡¨è¾¾å¼çš„â€œå€¼â€ã€‚\nç¤ºä¾‹ï¼š\neval(\u0026#34;1 + 2\u0026#34;) # 3 eval(\u0026#34;\u0026#39;a\u0026#39; * 3\u0026#34;) # \u0026#39;aaa\u0026#39; eval(\u0026#34;{\u0026#39;x\u0026#39;: 1}\u0026#34;) # {\u0026#39;x\u0026#39;: 1} å®ƒä¼šï¼š\nè§£æå­—ç¬¦ä¸² å½“æˆ Python ä»£ç æ‰§è¡Œ è¿”å›æ‰§è¡Œç»“æœ âš ï¸ eval ä¸ exec çš„åŒºåˆ«ï¼š\nå‡½æ•° ç”¨é€” eval() æ‰§è¡Œè¡¨è¾¾å¼ï¼Œæœ‰è¿”å›å€¼ exec() æ‰§è¡Œä¸€æ®µä»£ç å—ï¼Œæ— è¿”å›å€¼ âŒ 2. eval çš„å·¨å¤§å®‰å…¨é£é™©ï¼ˆå¿…é¡»äº†è§£ï¼‰ å¦‚æœå­—ç¬¦ä¸²ä¸æ˜¯ä½ è‡ªå·±å®Œå…¨æ§åˆ¶ï¼Œä¾‹å¦‚æ¥è‡ªï¼š\nç”¨æˆ·è¾“å…¥ æ•°æ®åº“å†…å®¹ HTTP è¯·æ±‚å‚æ•° å¤–éƒ¨æ–‡ä»¶ é‚£ä¹ˆè¿è¡Œ eval ä¼šç­‰äºï¼š\nğŸ‘‰ ç»™ç”¨æˆ·ä¸€æŠŠå¯ä»¥è¿œç¨‹æ‰§è¡Œä½ æœåŠ¡å™¨ä¸Šä»»æ„ Python ä»£ç çš„åˆ€\nä¾‹å¦‚ï¼š\neval(\u0026#34;__import__(\u0026#39;os\u0026#39;).system(\u0026#39;rm -rf /\u0026#39;)\u0026#34;) è¿™å¯ä»¥ç›´æ¥ç ´åæœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿã€‚\nâš ï¸ åªè¦ä½ ä¸æ˜¯åœ¨è‡ªå·±æ§åˆ¶çš„ä»£ç é‡Œï¼Œeval æ°¸è¿œä¸èƒ½ç›´æ¥ç”¨ã€‚\nâš ï¸ 3. å“ªäº›åœºæ™¯ä¸è¦ä½¿ç”¨ evalï¼Ÿ ä»¥ä¸‹å…¨éƒ½ä¸å…è®¸ evalï¼š\nâŒ å­—å…¸è½¬ä¸ºå¯¹è±¡ âŒ å°†å­—ç¬¦ä¸²è§£æä¸º list/dict âŒ é…ç½®æ–‡ä»¶è§£æ âŒ SQL è§£æ âŒ JSON è§£æ âŒ æ•°å­¦è¡¨è¾¾å¼è®¡ç®— âŒ æ ¼å¼åŒ–æ¨¡æ¿ âœ… 4. eval çš„å®‰å…¨æ›¿ä»£æ–¹æ¡ˆï¼ˆæœ€å¸¸ç”¨ï¼‰ 4.1 å­—ç¬¦ä¸² -\u0026gt; dict / list âŒ ä¸è¦ç”¨ï¼š\neval(\u0026#34;{\u0026#39;a\u0026#39;: 1}\u0026#34;) âœ… å®‰å…¨ï¼š\nimport ast data = ast.literal_eval(\u0026#34;{\u0026#39;a\u0026#39;: 1}\u0026#34;) literal_eval åªå…è®¸å­—é¢é‡ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€åˆ—è¡¨ã€å­—å…¸ç­‰ï¼‰ï¼Œå®‰å…¨æ— å®³ã€‚\n4.2 è§£æ JSON import json json.loads(\u0026#39;{\u0026#34;a\u0026#34;: 1}\u0026#39;) 4.3 æ‰§è¡Œæ•°å­¦è¡¨è¾¾å¼ å®‰å…¨åº“ï¼š\npip install simpleeval from simpleeval import simple_eval simple_eval(\u0026#34;1 + 2 * 3\u0026#34;) 4.4 è¿è¡Œå—é™ç¯å¢ƒä¸‹çš„ eval å¦‚æœå¿…é¡»ä½¿ç”¨ evalï¼ˆæå°‘æ•°æƒ…å†µï¼‰ï¼Œè¯·åŠ ä¸Š é™åˆ¶å˜é‡ç¯å¢ƒï¼š\nsafe = eval(\u0026#34;1 + 2\u0026#34;, {\u0026#34;__builtins__\u0026#34;: None}, {}) âœ… 5. eval çš„æ­£ç¡®ç”¨æ³•ï¼ˆæå°‘æ•°æƒ…å†µï¼‰ åªæœ‰ä½  å®Œå…¨ä¿¡ä»»è¡¨è¾¾å¼å†…å®¹æ¥æº æ—¶å¯ä»¥ç”¨ evalã€‚\nä¾‹å¦‚ï¼š\nåœ¨ä½ å†™çš„é…ç½®è„šæœ¬é‡Œ åœ¨å†…éƒ¨å·¥å…·è„šæœ¬ä¸­ åœ¨ REPL æ„å»ºåŠ¨æ€è¡¨è¾¾å¼ ç¤ºä¾‹ï¼š\nexpr = \u0026#34;a + b\u0026#34; result = eval(expr, {}, {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}) è¿™ä»£è¡¨ï¼š\nä¸å…è®¸ä½¿ç”¨ Python å†…ç½®å‡½æ•° ä»…å…è®¸ä½¿ç”¨ a å’Œ b æ— æ³•æ‰§è¡Œå±é™©ä»£ç  âœ… 6. eval çš„å…¸å‹ä½¿ç”¨ç¤ºä¾‹ï¼ˆå®‰å…¨ç¯å¢ƒä¸­ï¼‰ åŠ¨æ€è¿è¡Œç®€å•è¡¨è¾¾å¼\nallowed = {\u0026#34;x\u0026#34;: 10, \u0026#34;y\u0026#34;: 20} expr = \u0026#34;x * y + 5\u0026#34; result = eval(expr, {\u0026#34;__builtins__\u0026#34;: None}, allowed) åŠ¨æ€é€‰æ‹©å‡½æ•°\nactions = { \u0026#34;sum\u0026#34;: lambda x, y: x + y, \u0026#34;mul\u0026#34;: lambda x, y: x * y, } func_name = \u0026#34;sum\u0026#34; expr = f\u0026#34;actions[\u0026#39;{func_name}\u0026#39;](3, 5)\u0026#34; result = eval(expr, {\u0026#34;actions\u0026#34;: actions}) ğŸš« 7. é¡¹ç›®ä¸­ç¦æ­¢ eval çš„åŸå› ï¼ˆç”Ÿäº§ç¯å¢ƒç»éªŒï¼‰ åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œ99% çš„ eval ä½¿ç”¨åœºæ™¯éƒ½å¯ä»¥ç”¨å®‰å…¨æ–¹æ³•æ›¿æ¢ï¼š\néœ€æ±‚ æ›¿ä»£æ–¹æ¡ˆ å­—ç¬¦ä¸²è½¬ dict ast.literal_eval è§£æ JSON json.loads æ„é€ è¡¨è¾¾å¼ å­—å…¸æ˜ å°„ + if/dispatch é…ç½®æ–‡ä»¶ json / yaml / toml æ•°å­¦è¡¨è¾¾å¼ simpleeval åŠ¨æ€å‡½æ•° æ˜ å°„è¡¨ + getattr ğŸ¯ 8. æ€»ç»“ï¼ˆè®°ä½ä¸‰å¥è¯ï¼‰ eval ä¼šæ‰§è¡Œä»»æ„ Python ä»£ç ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸å®‰å…¨çš„ã€‚ ç»ä¸è¦åœ¨ä¸å¯ä¿¡æ•°æ®ä¸Šä½¿ç”¨ evalã€‚ ä½¿ç”¨ ast.literal_eval æˆ– json.loads ä»£æ›¿ã€‚ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ã€ŠPython eval() æœ€ä½³å®è·µ + å®‰å…¨é£é™© + æ›¿ä»£æ–¹æ¡ˆå®Œæ•´ç‰ˆæŒ‡å—ã€‹\nå†…å®¹æ¶µç›–ï¼ševal æ˜¯ä»€ä¹ˆã€èƒ½åšä»€ä¹ˆã€ä¸ºä»€ä¹ˆå±é™©ã€æ­£ç¡®å®‰å…¨æ›¿ä»£æ–¹æ¡ˆã€å®é™…é¡¹ç›®ä¸­çš„æœ€ä½³å†™æ³•ã€‚\nâœ… 1. eval æ˜¯ä»€ä¹ˆï¼Ÿ eval(expr) ä¼šæŠŠ å­—ç¬¦ä¸²è½¬æˆ Python è¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼Œå¹¶è¿”å›è¡¨è¾¾å¼çš„â€œå€¼â€ã€‚\nç¤ºä¾‹ï¼š\neval(\u0026#34;1 + 2\u0026#34;) # 3 eval(\u0026#34;\u0026#39;a\u0026#39; * 3\u0026#34;) # \u0026#39;aaa\u0026#39; eval(\u0026#34;{\u0026#39;x\u0026#39;: 1}\u0026#34;) # {\u0026#39;x\u0026#39;: 1} å®ƒä¼šï¼š\nè§£æå­—ç¬¦ä¸² å½“æˆ Python ä»£ç æ‰§è¡Œ è¿”å›æ‰§è¡Œç»“æœ âš ï¸ eval ä¸ exec çš„åŒºåˆ«ï¼š\nå‡½æ•° ç”¨é€” eval() æ‰§è¡Œè¡¨è¾¾å¼ï¼Œæœ‰è¿”å›å€¼ exec() æ‰§è¡Œä¸€æ®µä»£ç å—ï¼Œæ— è¿”å›å€¼ âŒ 2. eval çš„å·¨å¤§å®‰å…¨é£é™©ï¼ˆå¿…é¡»äº†è§£ï¼‰ å¦‚æœå­—ç¬¦ä¸²ä¸æ˜¯ä½ è‡ªå·±å®Œå…¨æ§åˆ¶ï¼Œä¾‹å¦‚æ¥è‡ªï¼š\n"},{"id":209,"href":"/backend/python/official/f-string/","title":"f-string","parent":"Official","content":"f-string æ˜¯ Python 3.6+ å¼•å…¥çš„æœ€å¼ºå­—ç¬¦ä¸²æ ¼å¼åŒ–æ–¹å¼ï¼š\nf\u0026#34;...{è¡¨è¾¾å¼}...\u0026#34; å®ƒæœ€å¤§çš„èƒ½åŠ›æ˜¯ï¼š\nå†…åµŒä»»ä½•è¡¨è¾¾å¼ é«˜æ€§èƒ½ï¼ˆæ¯” format å’Œ % æ›´å¿«ï¼‰ å¯è¯»æ€§æœ€å¼º æ”¯æŒæ ¼å¼åŒ–æ§åˆ¶ï¼ˆæ•°å­—ã€æ—¥æœŸã€è¡¥é›¶ã€å¯¹é½ç­‰ï¼‰ 1. f-string åŸºç¡€ç”¨æ³• name = \u0026#34;Martin\u0026#34; age = 30 print(f\u0026#34;My name is {name}, age {age}\u0026#34;) 2. æ”¯æŒä»»æ„è¡¨è¾¾å¼ å››åˆ™è¿ç®—\nf\u0026#34;{1 + 2 + 3}\u0026#34; å‡½æ•°è°ƒç”¨\nf\u0026#34;{len([1, 2, 3])}\u0026#34; æ–¹æ³•è°ƒç”¨\nf\u0026#34;{name.upper()}\u0026#34; 3. f-string å¯ç›´æ¥æ‰“å°å­—å…¸ã€åˆ—è¡¨ã€å¯¹è±¡ d = {\u0026#34;a\u0026#34;: 1} print(f\u0026#34;dict: {d}\u0026#34;) 4. å˜é‡åè‡ªåŠ¨æ‰“å°ï¼ˆè°ƒè¯•ç¥å™¨ï¼‰ Python 3.8+:\na = 10 print(f\u0026#34;{a=}\u0026#34;) è¾“å‡ºï¼š\na=10 æ›´å¼ºï¼š\nprint(f\u0026#34;{a=}, {a*2=}\u0026#34;) 5. f-string æ ¼å¼åŒ–æ•°å­—ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ 5.1 å°æ•°ä½æ•°æ§åˆ¶ f\u0026#34;{3.1415926:.2f}\u0026#34; # 3.14 5.2 åƒåˆ†ä½ f\u0026#34;{1234567:,}\u0026#34; # \u0026#39;1,234,567\u0026#39; 5.3 ç™¾åˆ†æ¯” f\u0026#34;{0.123:.2%}\u0026#34; # \u0026#39;12.30%\u0026#39; 5.4 è¡¥é›¶ f\u0026#34;{7:03d}\u0026#34; # \u0026#39;007\u0026#39; 5.5 å¯¹é½å’Œå®½åº¦ï¼ˆå·¦å³ä¸­å¯¹é½ï¼‰ f\u0026#34;{\u0026#39;hi\u0026#39;:\u0026lt;10}\u0026#34; # å·¦å¯¹é½ï¼Œå 10å®½åº¦ f\u0026#34;{\u0026#39;hi\u0026#39;:\u0026gt;10}\u0026#34; # å³å¯¹é½ f\u0026#34;{\u0026#39;hi\u0026#39;:^10}\u0026#34; # å±…ä¸­ 6. f-string æ ¼å¼åŒ–æ—¥æœŸ from datetime import datetime now = datetime.now() print(f\u0026#34;{now:%Y-%m-%d %H:%M:%S}\u0026#34;) 7. f-string ä¸­ä½¿ç”¨å­—å…¸ key user = {\u0026#34;name\u0026#34;: \u0026#34;Martin\u0026#34;, \u0026#34;age\u0026#34;: 30} f\u0026#34;{user[\u0026#39;name\u0026#39;]}\u0026#34; 8. f-string å†…è” if æ¡ä»¶ f\u0026#34;{\u0026#39;VIP\u0026#39; if is_vip else \u0026#39;Normal\u0026#39;}\u0026#34; 9. f-string å†…ä½¿ç”¨ escape å¦‚æœè¦åœ¨ f-string å†…å†™å¤§æ‹¬å·ï¼Œéœ€è¦ç”¨ {{ }}ï¼š\nf\u0026#34;{{Hello}}\u0026#34; è¾“å‡ºï¼š\n{Hello} 10. f-string å¤šè¡Œï¼ˆéå¸¸å¸¸ç”¨ï¼‰ msg = f\u0026#34;\u0026#34;\u0026#34; User: {name} Age : {age} \u0026#34;\u0026#34;\u0026#34; 11. f-string è°ƒè¯• JSONï¼ˆwith indentï¼‰ import json print(f\u0026#34;{json.dumps(user, indent=2)}\u0026#34;) 12. f-string + lambdaï¼ˆå°‘è§ä½†åˆæ³•ï¼‰ f\u0026#34;{(lambda x: x*2)(5)}\u0026#34; # \u0026#39;10\u0026#39; 13. f-string + åŠ ä¸Šæ ¼å¼è¯´æ˜ç¬¦ = è°ƒè¯•æ›´å¼º x = 3.14159 print(f\u0026#34;{x=:.2f}\u0026#34;) è¾“å‡ºï¼š\nx=3.14 14. f-string é»‘é­”æ³•ï¼šå˜é‡åè‡ªåŠ¨æå–ï¼ˆinspectï¼‰ è°ƒè¯•æ¡†æ¶é‡Œå¸¸è§ï¼š\ndef debug(var): print(f\u0026#34;{var=}\u0026#34;) # Python è‡ªåŠ¨æå–è¡¨è¾¾å¼æºç  15. f-string æ€§èƒ½æé«˜ï¼ˆæœ€å¿«ï¼‰ é€Ÿåº¦æ¯”è¾ƒï¼š\næ ¼å¼æ–¹å¼ é€Ÿåº¦ å¯è¯»æ€§ f-string â­â­â­â­â­ï¼ˆæœ€å¿«ï¼‰ æœ€å¼º format() ä¸­ç­‰ ä¸­ç­‰ % æ ¼å¼ æ¬¡å¿« ä¸å¤Ÿç›´è§‚ æ‹¼æ¥ â€œ+â€ æœ€æ…¢ æœ€ä¹± 16. f-string å†…åµŒå¤æ‚è¡¨è¾¾å¼ï¼ˆä½†è¦é€‚åº¦ï¼‰ f\u0026#34;{[x*x for x in range(5)]}\u0026#34; å¯ä»¥ï¼Œä½†å¤ªå¤æ‚ä¼šé™ä½å¯è¯»æ€§ã€‚\n17. f-string vs format å¯¹ç…§è¡¨ åŠŸèƒ½ f-string format æ•°å­—æ ¼å¼åŒ– âœ… âœ… å†…è”è¡¨è¾¾å¼ âœ… âŒ å˜é‡åè°ƒè¯• âœ… âŒ å†…ç½®æ€§èƒ½ â­â­â­â­â­ â­â­â­ 18. f-string ä¸èƒ½åšçš„äº‹ï¼ˆå¾ˆå°‘ï¼‰ âŒ f-string ä¸èƒ½åŠ¨æ€ç”Ÿæˆå˜é‡å âŒ f-string ä¸èƒ½è·¨å¼•å·åµŒå¥—ï¼ˆéœ€è¦è½¬ä¹‰ï¼‰ âŒ f-string è¡¨è¾¾å¼ä¸èƒ½åŒ…å« \\ï¼ˆå¦‚æ¢è¡Œï¼‰ ğŸ“Œ æœ€æ¨èçš„ä½¿ç”¨æ¨¡å¼ï¼ˆå†™æ³•æœ€ Pythonicï¼‰ 1. é…åˆè¡¨è¾¾å¼ f\u0026#34;total={sum(prices):.2f}\u0026#34; 2. é…åˆå­—å…¸å–å€¼ f\u0026#34;user={user[\u0026#39;id\u0026#39;]}, name={user[\u0026#39;name\u0026#39;]}\u0026#34; 3. ç”¨ = f\u0026#34;{response.status_code=}\u0026#34; 4. åµŒå…¥ JSON è°ƒè¯• f\u0026#34;{json.dumps(config, indent=2)}\u0026#34; ","description":"f-string æ˜¯ Python 3.6+ å¼•å…¥çš„æœ€å¼ºå­—ç¬¦ä¸²æ ¼å¼åŒ–æ–¹å¼ï¼š\nf\u0026#34;...{è¡¨è¾¾å¼}...\u0026#34; å®ƒæœ€å¤§çš„èƒ½åŠ›æ˜¯ï¼š\nå†…åµŒä»»ä½•è¡¨è¾¾å¼ é«˜æ€§èƒ½ï¼ˆæ¯” format å’Œ % æ›´å¿«ï¼‰ å¯è¯»æ€§æœ€å¼º æ”¯æŒæ ¼å¼åŒ–æ§åˆ¶ï¼ˆæ•°å­—ã€æ—¥æœŸã€è¡¥é›¶ã€å¯¹é½ç­‰ï¼‰ 1. f-string åŸºç¡€ç”¨æ³• name = \u0026#34;Martin\u0026#34; age = 30 print(f\u0026#34;My name is {name}, age {age}\u0026#34;) 2. æ”¯æŒä»»æ„è¡¨è¾¾å¼ å››åˆ™è¿ç®—\nf\u0026#34;{1 + 2 + 3}\u0026#34; å‡½æ•°è°ƒç”¨\nf\u0026#34;{len([1, 2, 3])}\u0026#34; æ–¹æ³•è°ƒç”¨\n"},{"id":210,"href":"/backend/python/fastapi/","title":"FastAPI","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£: https://fastapi.tiangolo.com/\nDirectory List:\nFastAPI åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ ","description":"å®˜æ–¹æ–‡æ¡£: https://fastapi.tiangolo.com/\nDirectory List:\nFastAPI åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ "},{"id":211,"href":"/backend/python/official/filter/","title":"Filter å‡½æ•°","parent":"Official","content":" âœ… filter()ï¼šæ ¸å¿ƒæ¦‚å¿µ filter(function, iterable)\nè®© function å¯¹ iterable çš„æ¯ä¸ªå…ƒç´ æ±‚å€¼ï¼Œä¿ç•™è¿”å› True çš„å…ƒç´ ã€‚\nè¿”å›ä¸€ä¸ª æƒ°æ€§ filter å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰ã€‚\nâœ… 1. åŸºæœ¬ç¤ºä¾‹ï¼šè¿‡æ»¤å¶æ•° nums = [1, 2, 3, 4, 5, 6] even = filter(lambda x: x % 2 == 0, nums) print(list(even)) # [2, 4, 6] âœ… 2. è‹¥ function ä¸º None -\u0026gt; è¿‡æ»¤æ‰â€œå‡å€¼â€ ç­‰ä»·äºï¼šä¿ç•™ä¸º True çš„å…ƒç´ ã€‚\nå‡å€¼åŒ…æ‹¬ï¼š0, False, \u0026lsquo;\u0026rsquo;, None, [], {}, set()\nitems = [0, 1, \u0026#34;\u0026#34;, \u0026#34;hi\u0026#34;, None, \u0026#34;abc\u0026#34;] print(list(filter(None, items))) # [\u0026#39;hi\u0026#39;, \u0026#39;abc\u0026#39;, 1] âœ… 3. ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°è¿‡æ»¤ def is_long(s): return len(s) \u0026gt; 3 words = [\u0026#34;hi\u0026#34;, \u0026#34;hello\u0026#34;, \u0026#34;cat\u0026#34;, \u0026#34;python\u0026#34;] result = filter(is_long, words) print(list(result)) # [\u0026#39;hello\u0026#39;, \u0026#39;python\u0026#39;] âœ… 4. filter + å­—å…¸ï¼ˆå¸¸ç”¨ï¼‰ è¿‡æ»¤æ‰ price \u0026lt; 10 çš„è‚¡ç¥¨ï¼š\nstocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;price\u0026#34;: 9.5}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;price\u0026#34;: 12}, ] cheap = list(filter(lambda s: s[\u0026#34;price\u0026#34;] \u0026lt; 10, stocks)) print(cheap) # [{\u0026#39;code\u0026#39;: \u0026#39;600001\u0026#39;, \u0026#39;price\u0026#39;: 9.5}] âœ… 5. filter + æ•°æ®æ¸…æ´—ï¼ˆçœŸå®ä¸šåŠ¡æœ€ä½³ç”¨æ³•ï¼‰ å»ç©ºå­—ç¬¦ä¸²\nitems = [\u0026#34;A\u0026#34;, \u0026#34;\u0026#34;, \u0026#34; \u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;] valid = list(filter(lambda s: s.strip(), items)) print(valid) # [\u0026#39;A\u0026#39;, \u0026#39;B\u0026#39;, \u0026#39;C\u0026#39;] å»æ‰ None æ•°æ®\ncleaned = list(filter(lambda x: x is not None, data)) âœ… 6. filter + å¤šæ¡ä»¶è¿‡æ»¤ nums = range(50) result = list(filter(lambda x: x % 2 == 0 and x \u0026gt; 10 and x \u0026lt; 40, nums)) print(result) # [12, 14, ..., 38] âœ… 7. filter æ˜¯â€œæƒ°æ€§çš„â€ ä¸ä¼šæ‰§è¡Œï¼Œç›´åˆ°æ¶ˆè´¹ï¼š\nf = filter(lambda x: x \u0026gt; 3, [1, 2, 3, 4, 5]) print(next(f)) # 4 print(next(f)) # 5 ä½ å·²ç»å­¦è¿‡æƒ°æ€§ -\u0026gt; è¿™å°±æ˜¯é‚£ä¸€ç±»å¯¹è±¡ã€‚\nâœ… 8. filter ä¸åˆ—è¡¨æ¨å¯¼å¼çš„å¯¹æ¯” filter å†™æ³•\nlist(filter(lambda x: x \u0026gt; 3, arr)) åˆ—è¡¨æ¨å¯¼ï¼ˆæ›´å¯è¯»ï¼‰\n[x for x in arr if x \u0026gt; 3] å¤æ‚è¿‡æ»¤åœºæ™¯ -\u0026gt; æ¨èåˆ—è¡¨æ¨å¯¼\næ˜ç¡®çš„å¸ƒå°”åˆ¤æ–­ -\u0026gt; æ¨è filter\nâœ… 9. å®æˆ˜ï¼šè‚¡ç¥¨æ•°æ®ç­›é€‰ æ ¹æ® code å‰ç¼€ + é‡‘é¢è¿‡æ»¤ï¼š\nstocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;price\u0026#34;: 9.5}, {\u0026#34;code\u0026#34;: \u0026#34;300200\u0026#34;, \u0026#34;price\u0026#34;: 22}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;price\u0026#34;: 15}, ] filtered = list(filter( lambda s: s[\u0026#34;code\u0026#34;].startswith(\u0026#34;600\u0026#34;) and s[\u0026#34;price\u0026#34;] \u0026gt; 10, stocks )) print(filtered) è¾“å‡ºï¼š\n[{\u0026#39;code\u0026#39;: \u0026#39;600002\u0026#39;, \u0026#39;price\u0026#39;: 15}] ğŸ¯ æ€»ç»“ï¼šfilter çš„å…¸å‹ä½¿ç”¨åœºæ™¯ åœºæ™¯ æ˜¯å¦é€‚åˆ æ•°æ®æ¸…æ´—ï¼ˆå» None / ç©ºå€¼ï¼‰ âœ…ï¸ éå¸¸é€‚åˆ è¿‡æ»¤æ•°ç»„æˆ–å­—å…¸åˆ—è¡¨ âœ… éå¸¸é«˜é¢‘ æƒ°æ€§åŠ è½½å¤§æ•°æ® âœ… æ€§èƒ½å¥½ å¤æ‚è¿‡æ»¤é€»è¾‘ âŒ åˆ—è¡¨æ¨å¯¼æ›´å¯è¯» ä¸€æ­¥å¤„ç†å¤šåºåˆ— âŒ ç”¨ map æ›´åˆé€‚ ","description":" âœ… filter()ï¼šæ ¸å¿ƒæ¦‚å¿µ filter(function, iterable)\nè®© function å¯¹ iterable çš„æ¯ä¸ªå…ƒç´ æ±‚å€¼ï¼Œä¿ç•™è¿”å› True çš„å…ƒç´ ã€‚\nè¿”å›ä¸€ä¸ª æƒ°æ€§ filter å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰ã€‚\nâœ… 1. åŸºæœ¬ç¤ºä¾‹ï¼šè¿‡æ»¤å¶æ•° nums = [1, 2, 3, 4, 5, 6] even = filter(lambda x: x % 2 == 0, nums) print(list(even)) # [2, 4, 6] âœ… 2. è‹¥ function ä¸º None -\u0026gt; è¿‡æ»¤æ‰â€œå‡å€¼â€ ç­‰ä»·äºï¼šä¿ç•™ä¸º True çš„å…ƒç´ ã€‚\n"},{"id":212,"href":"/backend/python/official/for/","title":"For (å¾ªç¯)","parent":"Official","content":" 1. for çš„æœ¬è´¨ï¼šè¿­ä»£å™¨åè®® Python çš„ for å¾ªç¯æœ¬è´¨æ˜¯ï¼š\niterator = iter(obj) while True: try: item = next(iterator) except StopIteration: break è¿™æ„å‘³ç€ï¼š\nä»»ä½•å¯è¿­ä»£å¯¹è±¡éƒ½èƒ½ forï¼ˆlistã€tupleã€dictã€strã€setã€fileã€generatorï¼‰ åº•å±‚ä¾èµ– iter() å’Œ next() 2. for çš„åŸºæœ¬è¯­æ³• for item in iterable: ... ä¾‹å­ï¼š\nfor i in [1, 2, 3]: print(i) 3. for + rangeï¼ˆæœ€å¸¸è§ï¼‰ for i in range(5): print(i) range ä¹Ÿæ˜¯ä¸€ä¸ªæƒ°æ€§å¯¹è±¡ï¼ˆä¸ä¼šä¸€æ¬¡æ€§äº§ç”Ÿåˆ—è¡¨ï¼‰ã€‚\n4. for è¿­ä»£å­—å…¸ è¿­ä»£ keyï¼š\nfor k in d: print(k) è¿­ä»£ key-valueï¼š\nfor k, v in d.items(): print(k, v) è¿­ä»£ valueï¼š\nfor v in d.values(): print(v) 5. for + enumerateï¼ˆå¸¦ç´¢å¼•éå†ï¼‰ for idx, value in enumerate(items): print(idx, value) å¸¦èµ·å§‹å€¼ï¼š\nenumerate(items, start=1) 6. for + zipï¼ˆå¹¶è¡Œéå†ï¼‰ for a, b in zip(list1, list2): print(a, b) 7. for + elseï¼ˆæœ€å¸¸è¢«è¯¯è§£ï¼‰ else åœ¨å¾ªç¯ æ­£å¸¸ç»“æŸï¼ˆä¸æ˜¯ breakï¼‰æ—¶æ‰§è¡Œã€‚\nä¾‹å­ï¼š\nfor x in items: if x == target: print(\u0026#34;found\u0026#34;) break else: print(\u0026#34;not found\u0026#34;) ç”¨é€”ï¼šæœç´¢é€»è¾‘ã€‚\n8. for å¤„ç†ç”Ÿæˆå™¨ ç”Ÿæˆå™¨æƒ°æ€§äº§å‡ºæ•°æ®ï¼š\ndef gen(): for i in range(3): yield i for x in gen(): print(x) 9. for å¤„ç†è¿­ä»£å™¨ è¿­ä»£å™¨åªèƒ½éå†ä¸€æ¬¡ï¼š\nit = iter([1,2,3]) for x in it: print(x) # å†éå† -\u0026gt; æ²¡æœ‰æ•°æ®äº† for x in it: print(x) # ä¸æ‰“å° 10. for ä¸åˆ—è¡¨æ¨å¯¼å¼ï¼ˆè¯­æ³•ç³–ï¼‰ result = [x*x for x in range(10)] ç­‰ä»·äºï¼š\nresult = [] for x in range(10): result.append(x*x) 11. for ä¸é›†åˆ / å­—å…¸æ¨å¯¼å¼ é›†åˆæ¨å¯¼ï¼š\ns = {x*x for x in range(10)} å­—å…¸æ¨å¯¼ï¼š\nd = {x: x*x for x in range(10)} 12. for ä¸ break/continue for x in items: if x \u0026lt; 0: continue if x == 0: break 13. for å¸¸è§é«˜é˜¶ç”¨æ³• 13.1 è§£åŒ…éå† pairs = [(1,2),(3,4)] for a, b in pairs: print(a, b) 13.2 å¤šé‡å¾ªç¯ for i in range(3): for j in range(2): print(i, j) 14. for ä¸ iter(func, sentinel) é«˜çº§æŠ€å·§ for chunk in iter(lambda: f.read(1024), b\u0026#39;\u0026#39;): process(chunk) ä½œç”¨ï¼šæŒç»­è¯»å–ç›´åˆ°é‡åˆ°æŸä¸ªâ€œç»ˆæ­¢ç¬¦â€ã€‚\néå¸¸ç”¨äºæ–‡ä»¶æµã€‚\n15. for çš„æ€§èƒ½æœ€ä½³å®è·µ 15.1 å°½é‡ä½¿ç”¨å±€éƒ¨å˜é‡ Python è®¿é—®å±€éƒ¨å˜é‡æœ€å¿«ã€‚\n15.2 é¿å…æ¯è½®æ·»åŠ å±æ€§æŸ¥æ‰¾ æ…¢ï¼š\nfor x in data: result.append(x) å¿«ï¼š\nappend = result.append for x in data: append(x) 15.3 é¿å… for + å¤§åˆ—è¡¨ -\u0026gt; ç”¨ç”Ÿæˆå™¨ ç”Ÿæˆå™¨ä¸ä¼šå ç”¨å†…å­˜ï¼Œæå‡æ€§èƒ½ã€‚\n15.4 é¿å…å¾ªç¯å†…éƒ¨å¤§é‡è®¡ç®—ï¼Œå°½é‡æå‰è®¡ç®— 16. for å¯è¿­ä»£å¯¹è±¡æ¸…å• list / tuple / set / dict file å¥æŸ„ str range generator / yield zip / map / filter / enumerate è‡ªå®šä¹‰å®ç° __iter__ 17. è‡ªå®šä¹‰å¯è¿­ä»£å¯¹è±¡ class MyRange: def __init__(self, end): self.i = 0 self.end = end def __iter__(self): return self def __next__(self): if self.i \u0026lt; self.end: self.i += 1 return self.i - 1 raise StopIteration for x in MyRange(5): print(x) 18. for çš„å¸¸è§å‘ 18.1 ä¿®æ”¹æ­£åœ¨éå†çš„ listï¼ˆå±é™©ï¼‰ é”™è¯¯ï¼š\nfor x in items: items.remove(x) æ­£ç¡®ï¼š\nfor x in items[:]: items.remove(x) æˆ–ï¼š\nitems = [x for x in items if ...] 18.2 éå† dict æ—¶ä¸èƒ½ä¿®æ”¹ dict 18.3 for éå†è¿­ä»£å™¨åªèƒ½ä¸€æ¬¡ 19. for çš„åº”ç”¨åœºæ™¯ éå†æ•°æ®ç»“æ„ è¯»å–å¤§æ–‡ä»¶ æ•°æ®æµå¤„ç† æ¶ˆè´¹é˜Ÿåˆ—ï¼ˆå¦‚ Redis / Kafkaï¼‰ å®ç°ç”Ÿæˆå™¨ç®—æ³• æ•°æ®è¿‡æ»¤ã€å˜æ¢ ğŸ“Œ æ€»ç»“ï¼ˆæœ€æ ¸å¿ƒ 10 æ¡ï¼‰ for æ˜¯å¯¹è¿­ä»£å™¨åè®®çš„è¯­æ³•ç³–ã€‚ æ”¯æŒæ‰€æœ‰â€œå¯è¿­ä»£å¯¹è±¡â€ã€‚ range æ˜¯æƒ°æ€§çš„ï¼Œä¸ä¼šä¸€æ¬¡æ€§ç”Ÿæˆåˆ—è¡¨ã€‚ forâ€¦else ä»…åœ¨å¾ªç¯æ­£å¸¸ç»“æŸæ—¶æ‰§è¡Œã€‚ enumerate ç”¨äºéœ€è¦ä¸‹æ ‡çš„éå†ã€‚ zip æ”¯æŒå¹¶è¡Œéå†ã€‚ åˆ—è¡¨æ¨å¯¼å¼ = å¿«é€Ÿ for + appendã€‚ è¿­ä»£å™¨åªèƒ½éå†ä¸€æ¬¡ã€‚ iter(func, sentinel) æ˜¯å¾ˆå¼ºå¤§çš„é«˜çº§æŠ€å·§ã€‚ é¿å…åœ¨éå†ä¸­ä¿®æ”¹åŸå§‹åˆ—è¡¨æˆ–å­—å…¸ã€‚ for else ä»¥ä¸‹æ˜¯ æœ€æ¸…æ™°ã€æœ€ç»å…¸çš„ Python for ... else ç¤ºä¾‹ã€‚\nâœ… ç¤ºä¾‹ 1ï¼šæŸ¥æ‰¾å…ƒç´  â€”â€” å¦‚æœæ²¡æ‰¾åˆ°æ‰æ‰§è¡Œ else numbers = [1, 3, 5, 7, 9] target = 4 for n in numbers: if n == target: print(\u0026#34;æ‰¾åˆ°äº†ï¼\u0026#34;) break else: print(\u0026#34;æ²¡æ‰¾åˆ°ç›®æ ‡æ•°å­—\u0026#34;) æ‰§è¡Œç»“æœï¼š\næ²¡æ‰¾åˆ°ç›®æ ‡æ•°å­— ğŸ” åŸå› ï¼š\nfor éå† æ­£å¸¸ç»“æŸï¼Œæ²¡æœ‰è§¦å‘ break æ‰€ä»¥æ‰§è¡Œ else âœ… ç¤ºä¾‹ 2ï¼šæŸ¥æ‰¾å…ƒç´  â€”â€” æ‰¾åˆ°äº†å°± breakï¼Œelse ä¸æ‰§è¡Œ numbers = [1, 3, 4, 5, 7] target = 4 for n in numbers: if n == target: print(\u0026#34;æ‰¾åˆ°äº†ï¼\u0026#34;) break else: print(\u0026#34;æ²¡æ‰¾åˆ°ç›®æ ‡æ•°å­—\u0026#34;) è¾“å‡ºï¼š\næ‰¾åˆ°äº†ï¼ ğŸ” åŸå› ï¼š\né‡åˆ° break -\u0026gt; ç›´æ¥è·³å‡ºå¾ªç¯ ä¸æ‰§è¡Œ else âœ… ç¤ºä¾‹ 3ï¼šç”¨äºåˆ¤æ–­æ˜¯å¦åŒ…å«æŸç§æƒ…å†µ s = \u0026#34;hello world\u0026#34; for ch in s: if ch.isdigit(): print(\u0026#34;åŒ…å«æ•°å­—\u0026#34;) break else: print(\u0026#34;ä¸åŒ…å«æ•°å­—\u0026#34;) è¾“å‡ºï¼š\nä¸åŒ…å«æ•°å­— âœ… ç¤ºä¾‹ 4ï¼šä¼˜åŒ–åˆ¤å®š primeï¼ˆç´ æ•°ï¼‰é€»è¾‘ num = 17 for i in range(2, num): if num % i == 0: print(\u0026#34;ä¸æ˜¯ç´ æ•°\u0026#34;) break else: print(\u0026#34;æ˜¯ç´ æ•°\u0026#34;) è¾“å‡ºï¼š\næ˜¯ç´ æ•° å¦‚æœæ•´æ®µå¾ªç¯æ²¡æœ‰ breakï¼Œè¯´æ˜æ²¡æ‰¾åˆ°èƒ½æ•´é™¤çš„æ•°å­— -\u0026gt; æ˜¯ç´ æ•°ã€‚\nğŸ”¥ è®°ä½è§„åˆ™ï¼ˆè¶…çº§é‡è¦ï¼‰ for ... else ä¸­çš„ else åªæœ‰å¾ªç¯æ²¡æœ‰æ‰§è¡Œ break æ—¶æ‰ä¼šæ‰§è¡Œã€‚\nâŒ å’Œ if-else å®Œå…¨æ— å…³\nâœ…ï¸ æ˜¯ break æ§åˆ¶çš„ else\n","description":" 1. for çš„æœ¬è´¨ï¼šè¿­ä»£å™¨åè®® Python çš„ for å¾ªç¯æœ¬è´¨æ˜¯ï¼š\niterator = iter(obj) while True: try: item = next(iterator) except StopIteration: break è¿™æ„å‘³ç€ï¼š\nä»»ä½•å¯è¿­ä»£å¯¹è±¡éƒ½èƒ½ forï¼ˆlistã€tupleã€dictã€strã€setã€fileã€generatorï¼‰ åº•å±‚ä¾èµ– iter() å’Œ next() 2. for çš„åŸºæœ¬è¯­æ³• for item in iterable: ... ä¾‹å­ï¼š\nfor i in [1, 2, 3]: print(i) 3. for + rangeï¼ˆæœ€å¸¸è§ï¼‰ for i in range(5): print(i) range ä¹Ÿæ˜¯ä¸€ä¸ªæƒ°æ€§å¯¹è±¡ï¼ˆä¸ä¼šä¸€æ¬¡æ€§äº§ç”Ÿåˆ—è¡¨ï¼‰ã€‚\n"},{"id":213,"href":"/backend/python/official/function/","title":"Function (å‡½æ•°)","parent":"Official","content":" ğŸš€ 1. ä»€ä¹ˆæ˜¯ Python å‡½æ•°ï¼Ÿ å‡½æ•°ï¼ˆfunctionï¼‰ æ˜¯ä¸€æ®µå¯å¤ç”¨çš„ä»£ç å—ï¼Œç”¨æ¥æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚\nå‡½æ•°å¯ä»¥ï¼š\næ¥æ”¶å‚æ•° è¿”å›å€¼ å†…éƒ¨æ‰§è¡Œé€»è¾‘ å°è£…è¡Œä¸ºï¼Œæé«˜å¤ç”¨æ€§ æœ€åŸºç¡€ä¾‹å­ï¼š\ndef add(a, b): return a + b è°ƒç”¨ï¼š\nadd(1, 2) ğŸ“Œ 2. Python å‡½æ•°çš„ç»„æˆè¯­æ³• def å‡½æ•°å(å‚æ•°åˆ—è¡¨): å‡½æ•°ä½“ return è¿”å›å€¼ ä¾‹ï¼š\ndef greet(name: str) -\u0026gt; str: return f\u0026#34;Hello, {name}\u0026#34; ğŸ“Œ 3. å‚æ•°ç±»å‹ï¼ˆé‡ç‚¹ï¼‰ Python å‡½æ•°æ”¯æŒ å¤šç§å‚æ•°ç±»å‹ï¼š\n3.1 æ™®é€šä½ç½®å‚æ•° def add(a, b): return a + b 3.2 é»˜è®¤å‚æ•° def connect(host=\u0026#34;localhost\u0026#34;, port=3306): ... 3.3 å¯å˜å‚æ•°ï¼š*args def total(*nums): return sum(nums) total(1,2,3) 3.4 å…³é”®å­—å¯å˜å‚æ•°ï¼š**kwargs def debug(**info): print(info) debug(a=1, b=2) 3.5 ä»…é™å…³é”®å­—å‚æ•°ï¼š* def config(*, debug=False): print(debug) å¿…é¡»å†™æˆï¼š\nconfig(debug=True) 3.6 å¹¶æ’ç»„åˆï¼ˆéå¸¸å¸¸è§ï¼‰ def func(a, b, *args, c=1, d=2, **kwargs): ... ğŸ“Œ 4. è¿”å›å€¼ return def foo(): return 123 å¤šä¸ªè¿”å›ï¼š\ndef get_info(): return \u0026#34;jack\u0026#34;, 18 name, age = get_info() è¿”å› Noneï¼š\ndef log(msg): print(msg) # é»˜è®¤ return None ğŸ“Œ 5. å‡½æ•°ç±»å‹ï¼ˆé‡è¦ï¼‰ åœ¨ Python é‡Œï¼Œå‡½æ•°æœ¬è´¨ä¸Šæ˜¯å¯¹è±¡ï¼Œç±»å‹æ˜¯ï¼š\nimport types type(func) == types.FunctionType å‡½æ•°å¯ä»¥ï¼š\nèµ‹å€¼ å­˜å…¥ dict ä½œä¸ºå‚æ•°ä¼ é€’ ä½œä¸ºè¿”å›å€¼è¿”å› ä¾‹ï¼š\ndef a(): print(\u0026#34;a\u0026#34;) b = a b() ğŸ“Œ 6. å‡½æ•°ä½œä¸ºå‚æ•°ï¼ˆé«˜é˜¶å‡½æ•°ï¼‰ def apply(func, x): return func(x) def double(n): return n * 2 apply(double, 5) # 10 ğŸ“Œ 7. åŒ¿åå‡½æ•° lambda square = lambda x: x * x å¸¸ç”¨äº map/filter/sortedï¼š\nsorted(data, key=lambda x: x[\u0026#34;age\u0026#34;]) ğŸ“Œ 8. é—­åŒ…ï¼ˆéå¸¸é‡è¦ï¼‰ é—­åŒ… = å†…å±‚å‡½æ•° + å¤–å±‚ä½œç”¨åŸŸå˜é‡\ndef make_adder(n): def adder(x): return x + n return adder add5 = make_adder(5) add5(10) # 15\nğŸ“Œ 9. è£…é¥°å™¨ï¼ˆè¿›é˜¶ï¼‰ è£…é¥°å™¨æœ¬è´¨æ˜¯é«˜é˜¶å‡½æ•°ï¼š\ndef log(func): def wrapper(*a, **kw): print(f\u0026#34;Run {func.__name__}\u0026#34;) return func(*a, **kw) return wrapper ä½¿ç”¨ï¼š\n@log def run(): pass ğŸ“Œ 10. ç”Ÿæˆå™¨å‡½æ•°ï¼ˆyieldï¼‰ æ™®é€šå‡½æ•°ï¼šä¸€æ¬¡è¿”å› ç”Ÿæˆå™¨ï¼šé€æ¬¡è¿”å›ï¼Œæƒ°æ€§è®¡ç®—\ndef gen(): yield 1 yield 2 ğŸ“Œ 11. å¼‚æ­¥å‡½æ•° async def async def fetch(url): ... é…åˆ awaitï¼š\ndata = await fetch(url) ä½ çš„ FastAPI é¡¹ç›®å¸¸ç”¨çš„å°±æ˜¯ async å‡½æ•°ã€‚\nğŸ“Œ 12. æ‹†åŒ…å‡½æ•°å‚æ•°ï¼ˆ*args / **kwargsï¼‰ def f(a, b, c): ... args = (1,2,3) f(*args) kwargs = {\u0026#34;a\u0026#34;:1,\u0026#34;b\u0026#34;:2,\u0026#34;c\u0026#34;:3} f(**kwargs) ğŸ“Œ 13. é€’å½’å‡½æ•° å‡½æ•°è°ƒç”¨è‡ªå·±ï¼š\ndef fact(n): return 1 if n==0 else n * fact(n-1) ğŸ“Œ 14. Python å‡½æ•°ç”Ÿå‘½å‘¨æœŸã€ä½œç”¨åŸŸ LEGB LEGB è§„åˆ™ï¼š\nLocalï¼ˆå±€éƒ¨ï¼‰ Enclosingï¼ˆå¤–å±‚å‡½æ•°ï¼‰ Globalï¼ˆæ¨¡å—ï¼‰ Built-inï¼ˆå†…ç½®ï¼‰ ä¾‹ï¼š\nx = 10 # global def outer(): x = 20 # enclosing def inner(): x = 30 # local ğŸ“Œ 15. å‡½æ•°æ³¨è§£ï¼ˆType Hintï¼‰ def add(a: int, b: int) -\u0026gt; int: return a + b ğŸ“Œ 16. â­ å‡½æ•°è®¾è®¡æœ€ä½³å®è·µ é€»è¾‘å°è€Œæ¸…æ™° ä½¿ç”¨ç±»å‹æ³¨è§£æé«˜å¯è¯»æ€§ å‚æ•°ä½¿ç”¨ dict æ—¶ä¼˜å…ˆåŠ ç±»å‹åˆ«åï¼šdict[str, Any] æˆ– TypedDict å°½é‡ä¿æŒå‡½æ•°çº¯å‡€ï¼ˆæ— å‰¯ä½œç”¨ï¼‰ æŠŠå¤§å‡½æ•°æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•° é…åˆè£…é¥°å™¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†ã€æ€§èƒ½ç›‘æ§ã€æ—¥å¿— å°½é‡é¿å…ä½¿ç”¨å…¨å±€å˜é‡ è¾“å…¥å‚æ•°è¦å…ˆæ ¡éªŒï¼ˆä½ æ­£åœ¨åšï¼‰ ğŸ“Œ 17. å‡½æ•° vs ç±»ï¼šä»€ä¹ˆæ—¶å€™ç”¨å‡½æ•°ï¼Ÿ ç”¨å‡½æ•°ï¼š\néå¤æ‚é€»è¾‘ ä¸éœ€è¦çŠ¶æ€ ä¸éœ€è¦å¤šæ¬¡å¤ç”¨å†…éƒ¨æ•°æ® utils å·¥å…·ç±»ä¸­çš„å¤§éƒ¨åˆ†éƒ½å¯ä»¥ç”¨å‡½æ•° ç”¨ç±»ï¼š\néœ€è¦ä¿å­˜çŠ¶æ€ï¼ˆæ•°æ®åº“è¿æ¥æ±  / é…ç½®å¯¹è±¡ï¼‰ éœ€è¦æ‰©å±•æ€§ éœ€è¦ç»§æ‰¿ éœ€è¦ propertyã€staticã€class ç­‰ä¸°å¯Œæ¥å£ ğŸ“Œ 18. å°ç»“ï¼ˆå¼ºçƒˆå»ºè®®æ”¶è—ï¼‰ é¢†åŸŸ å†…å®¹ åŸºç¡€ def / å‚æ•° / return è¿›é˜¶ *args / **kwargs / lambda é«˜é˜¶ è£…é¥°å™¨ / é—­åŒ… / ä¸Šä¸‹æ–‡ç®¡ç† å¼‚æ­¥ async / await æƒ°æ€§ yield ç”Ÿæˆå™¨ å·¥ç¨‹ ç±»å‹æ³¨è§£ / å‡½æ•°å¼ç¼–ç¨‹ / æ¨¡å—åŒ–è®¾è®¡ æœ€ä½³å®è·µ ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£é¡¹ç›®çº§çš„ã€ŠPython å®šä¹‰å‡½æ•°æœ€ä½³å®è·µï¼ˆæœ€å¼ºå®Œæ•´ç‰ˆï¼‰ã€‹\nåŒæ—¶ç»“åˆä½ é•¿æœŸçš„ä»£ç é£æ ¼ï¼ˆFastAPI + SQLAlchemy + å·¥å…·å‡½æ•°ä¸ºä¸»ï¼‰ï¼Œç»™å‡ºæœ€å®ç”¨ã€æœ€ç°ä»£ã€æœ€å¼ºç±»å‹ã€å¯ç»´æŠ¤æ€§ä¼˜ç§€çš„æ ‡å‡†ã€‚\nå†…å®¹æ¶µç›–ï¼š\nå‘½åè§„èŒƒ å‚æ•°è®¾è®¡ è¿”å›å€¼ ç±»å‹æ³¨è§£ æ–‡æ¡£æ³¨é‡Š é”™è¯¯å¤„ç† æ€§èƒ½ä¼˜åŒ– å‡½æ•°å¼å·¥å…· æ¨¡å—å°è£… ä½•æ—¶ç”¨ç±»ã€ä½•æ—¶ç”¨å‡½æ•° â˜˜ï¸ 1. å‡½æ•°å‘½åæœ€ä½³å®è·µ åœºæ™¯ å‘½åæ–¹å¼ ç¤ºä¾‹ åŠ¨ä½œå‹å‡½æ•° åŠ¨è¯å¼€å¤´ get_userã€save_data å·¥å…·å‡½æ•° åŠ¨è¯ + åè¯ to_datetimeã€to_jsonã€map_filter è½¬æ¢å‡½æ•° to_ / from_ to_dictã€from_row åˆ¤æ–­å‡½æ•° is_ / has_ / should_ is_validã€has_permission ç§æœ‰å‡½æ•° å‰ç½®ä¸‹åˆ’çº¿ _parse_rowã€_clean_title âœ… ä¸ºåˆ«äººé˜…è¯»ä»£ç æ—¶â€œæ„å›¾å¯è§â€ã€‚\nâ˜˜ï¸ 2. å‡½æ•°å‚æ•°è®¾è®¡æœ€ä½³å®è·µ 2.1 å°‘é‡å‚æ•°ç”¨ä½ç½®å‚æ•°ï¼Œå¤šå‚æ•°ç”¨å…³é”®å­—å‚æ•° ä¸å¥½ï¼š\ndef create(x, y, z, a, b): ... å¥½ï¼š\ndef create(*, user, title, content, tags=None): ... å…³é”®å­—å‚æ•°å…·æœ‰ï¼š\nå¯è¯»æ€§å¥½ è°ƒç”¨æ›´å®‰å…¨ ä¿®æ”¹å‚æ•°é¡ºåºæ—¶ä¸ç ´åè°ƒç”¨æ–¹ 2.2 å¯é€‰å‚æ•°å¿…é¡»æœ‰é»˜è®¤å€¼ def fetch(limit: int | None = None): ... 2.3 é¿å…ä½¿ç”¨å¯å˜ç±»å‹ä½œä¸ºé»˜è®¤å€¼ï¼ˆé‡è¦!!ï¼‰ âŒ ç»å¯¹ä¸è¦ï¼š\ndef fn(data=[]): ... âœ… ä½¿ç”¨ Noneï¼š\ndef fn(data=None): if data is None: data = [] 2.4 æ¥å—ä¸å®šæ•°é‡å‚æ•°æ—¶ï¼šæ€»æ˜¯å†™æ¸…ç±»å‹ from typing import Any def sum_all(*nums: int) -\u0026gt; int: return sum(nums) â˜˜ï¸ 3. å‡½æ•°è¿”å›å€¼æœ€ä½³å®è·µ 3.1 å§‹ç»ˆè¿”å›æ˜ç¡®ç±»å‹ï¼ˆä¸è¦è¿”å›å¤šç§ç»“æ„ï¼‰ ä¸è¦è¿™æ ·ï¼š\ndef get_user(): return user or False åº”è¯¥è¿™æ ·ï¼š\ndef get_user() -\u0026gt; User | None: return user 3.2 è‹¥å¤±è´¥ï¼Œè¿”å› None æˆ–å¼‚å¸¸ï¼Œä¸è¦è¿”å› False âœ… æ›´æ˜“è¯»ï¼Œå’Œç±»å‹æ£€æŸ¥å·¥å…·å…¼å®¹ï¼š\nreturn None 3.3 è¿”å›å€¼ä¸º dict æ—¶ï¼Œä¿è¯é”®åç¨³å®šä¸å˜ ä¿æŒ API å…¼å®¹æ€§æ˜¯éå¸¸é‡è¦çš„ã€‚\nâ˜˜ï¸ 4. ç±»å‹æ³¨è§£æœ€ä½³å®è·µï¼ˆä½ å¿…é¡»éµå®ˆçš„ï¼‰ ä½ å·²ç»æ˜ç¡®è¦æ±‚ï¼š\nPython â‰¥ 3.12 ç¦æ­¢ä½¿ç”¨ typing ä¸­çš„å·²åºŸå¼ƒç±»å‹ å› æ­¤åº”è¯¥éµå¾ªï¼š\n4.1 ä½¿ç”¨åŸç”Ÿ list/dictï¼Œä¸ç”¨ List/Dict def fn(x: list[str]) -\u0026gt; dict[str, int]: ... 4.2 ä½¿ç”¨ collections.abc ä¸­çš„ç±»å‹ from collections.abc import Iterable, Callable def map_filter(iterable: Iterable[T], func: Callable[[T], R]) -\u0026gt; list[R]: ... 4.3 æ°¸è¿œå†™æ˜è¿”å›å€¼ç±»å‹ def run_task(task: Task) -\u0026gt; bool: ... 4.4 èƒ½ç”¨å…·ä½“ç±»å‹å°±ä¸ç”¨ Any ä¾‹å¦‚ï¼š\ndef parse(dt: str) -\u0026gt; datetime.datetime: ... â˜˜ï¸ 5. æ–‡æ¡£æ³¨é‡Šï¼ˆdocstringï¼‰æœ€ä½³å®è·µ è¯·ä½¿ç”¨ Google é£æ ¼æˆ– NumPy é£æ ¼ï¼Œä¸è¦ä½¿ç”¨éšæ„é£æ ¼ã€‚\næ¨è Google é£æ ¼ï¼š\ndef to_datetime(s: str) -\u0026gt; datetime: \u0026#34;\u0026#34;\u0026#34; Convert a datetime string to datetime object. Args: s: datetime string in \u0026#34;%Y-%m-%d %H:%M:%S\u0026#34; format. Returns: Parsed datetime object. Raises: ValueError: if the string cannot be parsed. \u0026#34;\u0026#34;\u0026#34; â˜˜ï¸ 6. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ âŒ ä¸è¦è¿™æ ·ï¼š\ntry: ... except Exception: return None ä½ ä¼šå±è”½ä¸€åˆ‡å¼‚å¸¸ï¼Œä¸åˆ©æ’æŸ¥ã€‚\nâœ… æ­£ç¡®åšæ³•ï¼šæ•è·æ˜ç¡®çš„å¼‚å¸¸\ntry: x = int(s) except ValueError: logger.error(...) return None â˜˜ï¸ 7. æ€§èƒ½æœ€ä½³å®è·µ ä»¥ä¸‹è§„åˆ™éå¸¸é‡è¦ï¼ˆä½ çš„é¡¹ç›®ç”¨å¾—ä¸Šï¼‰ï¼š\nâœ… ä½¿ç”¨ç”Ÿæˆå™¨æ›¿ä»£ list def gen_items(): for i in range(10): yield i âœ… æ‰¹é‡å¤„ç†ç”¨ map/filterï¼ˆCå±‚å®ç°æ›´å¿«ï¼‰ cleaned = list(map(clean, rows)) âœ… å‡½æ•°å†…é¿å…åˆ›å»ºé‡å¤å¯¹è±¡ pattern = re.compile(...) ä¸è¦ï¼š\nre.search(\u0026#34;xxx\u0026#34;, text) # æ¯æ¬¡éƒ½ç¼–è¯‘ â˜˜ï¸ 8. å‡½æ•°å¼å·¥å…·æœ€ä½³å®è·µ ï¼ˆä½ å·²ç»å¼€å§‹ä½¿ç”¨ map_filterï¼Œéå¸¸æ£’ï¼‰\næ¨èä½ ä½¿ç”¨ï¼š\nmap_filter filter_map compose pipe safe_get find_firstï¼ˆåŸºäº nextï¼‰ æˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªå®Œæ•´æ¨¡å—ï¼šutils.functional\nâ˜˜ï¸ 9. è®¾è®¡å‡½æ•°æ—¶è¦é—®çš„å…³é”®é—®é¢˜ æ¯æ¬¡å†™å‡½æ•°å‰ï¼Œè¯·é—®è‡ªå·±ï¼š\nè¿™ä¸ªå‡½æ•°çš„å”¯ä¸€èŒè´£æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆSRPï¼‰ éœ€è¦ç±»å‹å¼ºçº¦æŸå—ï¼Ÿ å¯¹è°ƒç”¨æ–¹æ˜¯å¦å‹å¥½ï¼Ÿ æ˜¯å¦å¯ä»¥æµ‹è¯•ï¼Ÿ æ˜¯å¦éœ€è¦æ–‡æ¡£ï¼Ÿ æ˜¯å¦å¿…é¡»å…¼å®¹æ—§å­—æ®µï¼Ÿ æ˜¯å¦è¦ä¿è¯ç¡®å®šæ€§ï¼ˆç¨³å®šè¾“å‡ºï¼‰ï¼Ÿ â˜˜ï¸ 10. ä½•æ—¶ä½¿ç”¨ç±»ï¼Œä½•æ—¶ä½¿ç”¨å‡½æ•°ï¼Ÿ ä½¿ç”¨ç±»(Class)â€”â€”å½“çŠ¶æ€å¾ˆé‡è¦æ—¶ï¼š\næ•°æ®åº“ Session ç®¡ç† é…ç½®å¯¹è±¡ æœåŠ¡å¯¹è±¡(Service) æœ‰ç”Ÿå‘½å‘¨æœŸé€»è¾‘ ä¾èµ–æ³¨å…¥ ä½¿ç”¨å‡½æ•°(Function)â€”â€”å½“æ“ä½œæ˜¯æ— çŠ¶æ€æ—¶ï¼š\næ–‡æœ¬å¤„ç† æ•°æ®è½¬æ¢ è§£æå™¨ éªŒè¯å™¨ å·¥å…·å‡½æ•° ä½ å·²ç»éå¸¸æ˜ç¡®ï¼šutils æ¨¡å—é€‚åˆå‡½æ•°å¼è®¾è®¡ã€‚\nğŸ¯ ç»ˆææ€»ç»“ï¼ˆå¯ä»¥ä½œä¸ºå›¢é˜Ÿä»£ç è§„èŒƒï¼‰ å‡½æ•°å‘½åæ¸…æ™°ã€è¯­ä¹‰æ˜ç¡® å‚æ•°ä½¿ç”¨ keyword-only é»˜è®¤å‚æ•°é¿å…å¯å˜ç±»å‹ è¿”å›å€¼ç±»å‹æ¸…æ™°ï¼ˆä¸è¦ False è¡¨ç¤ºå¤±è´¥ï¼‰ ä½¿ç”¨ç±»å‹æ³¨è§£ï¼ˆPython 3.12 é£æ ¼ï¼‰ é€‚åº¦ä½¿ç”¨ map/filter/next å‡½æ•°å¼å¤„ç† æä¾›æœ‰æ„ä¹‰çš„ docstring é¿å…é‡å¤æ„é€ å¯¹è±¡ å·¥å…·å‡½æ•°æ¨¡å—åŒ–å°è£… ","description":" ğŸš€ 1. ä»€ä¹ˆæ˜¯ Python å‡½æ•°ï¼Ÿ å‡½æ•°ï¼ˆfunctionï¼‰ æ˜¯ä¸€æ®µå¯å¤ç”¨çš„ä»£ç å—ï¼Œç”¨æ¥æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚\nå‡½æ•°å¯ä»¥ï¼š\næ¥æ”¶å‚æ•° è¿”å›å€¼ å†…éƒ¨æ‰§è¡Œé€»è¾‘ å°è£…è¡Œä¸ºï¼Œæé«˜å¤ç”¨æ€§ æœ€åŸºç¡€ä¾‹å­ï¼š\ndef add(a, b): return a + b è°ƒç”¨ï¼š\nadd(1, 2) ğŸ“Œ 2. Python å‡½æ•°çš„ç»„æˆè¯­æ³• def å‡½æ•°å(å‚æ•°åˆ—è¡¨): å‡½æ•°ä½“ return è¿”å›å€¼ ä¾‹ï¼š\n"},{"id":214,"href":"/backend/python/official/functional-programming/","title":"Functional Programming (å‡½æ•°å¼ç¼–ç¨‹)","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ ã€ŒPython å‡½æ•°å¼ç¼–ç¨‹çŸ¥è¯†ä½“ç³»ï¼šmap / filter / reduce / lambda / ç”Ÿæˆå™¨ / è¿­ä»£å™¨ã€å…¨å¥—æ•´ç†ã€‚\nç»“æ„æ¸…æ™°ã€åº”ç”¨åœºæ™¯æ˜ç¡®ã€æ¯èŠ‚éƒ½æœ‰ç¤ºä¾‹ï¼Œå¯ç›´æ¥ä½œä¸ºæ–‡æ¡£æˆ–ä½ ä»Šåé¡¹ç›®ä¸­çš„å·¥å…·çŸ¥è¯†åº“ã€‚\nâ˜˜ï¸ Python å‡½æ•°å¼ç¼–ç¨‹çŸ¥è¯†ä½“ç³»ï¼ˆå®Œæ•´ç‰ˆï¼‰\nç›®å½•\næ ¸å¿ƒç†å¿µï¼šä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹ lambda è¡¨è¾¾å¼ map å‡½æ•° filter å‡½æ•° reduce å‡½æ•° ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ è¿­ä»£å™¨ï¼ˆiteratorï¼‰ æƒ°æ€§æ‰§è¡Œï¼ˆlazy evaluationï¼‰ ä¸‰è€…ç»„åˆå®æˆ˜ Python å‡½æ•°å¼ç¼–ç¨‹æœ€ä½³å®è·µ 1ï¸âƒ£ æ ¸å¿ƒç†å¿µï¼šä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼Ÿ å‡½æ•°å¼ç¼–ç¨‹ï¼ˆFunctional Programming, FPï¼‰å¼ºè°ƒï¼š\næ— å‰¯ä½œç”¨ å‡½æ•°æ˜¯â€œä¸€ç­‰å…¬æ°‘â€ é“¾å¼å¤„ç†æ•°æ® å¯ç»„åˆã€å¯å¤ç”¨ åå‘ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ æ ¸å¿ƒæ€æƒ³ï¼š\nğŸ‘‰ ç”¨å‡½æ•°å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯å†™ for å¾ªç¯ã€‚\nä½“ç°ï¼šmap / filter / reduceã€è¿­ä»£å™¨ã€ç”Ÿæˆå™¨ã€lambdaã€‚\n2ï¸âƒ£ lambda è¡¨è¾¾å¼ï¼ˆåŒ¿åå‡½æ•°ï¼‰ è¯­æ³•\nlambda å‚æ•°: è¡¨è¾¾å¼ ä¾‹å­ï¼š\nadd = lambda a, b: a + b print(add(3, 5)) # 8 å¸¸ç”¨äº map / filter / reduce / sortedã€‚\n3ï¸âƒ£ map â€”â€” æ˜ å°„ï¼ˆå¯¹æ¯ä¸ªå…ƒç´ åšå˜æ¢ï¼‰ è¯­æ³•\nmap(function, iterable) åŠŸèƒ½ï¼šå¯¹ iterable æ¯ä¸ªå…ƒç´ åº”ç”¨å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæƒ°æ€§ map å¯¹è±¡ã€‚\nç¤ºä¾‹ï¼š\nnums = [1, 2, 3] result = list(map(lambda x: x * 2, nums)) print(result) # [2, 4, 6] ç­‰ä»·å†™æ³•ï¼š\n[x * 2 for x in nums] 4ï¸âƒ£ filter â€”â€” è¿‡æ»¤ï¼ˆä¿ç•™ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼‰ è¯­æ³•\nfilter(function, iterable) ç¤ºä¾‹ï¼š\nnums = [1, 2, 3, 4, 5] result = list(filter(lambda x: x % 2 == 0, nums)) print(result) # [2, 4] ç­‰ä»·å†™æ³•\n[x for x in nums if x % 2 == 0] 5ï¸âƒ£ reduce â€”â€” æŠ˜å ï¼ˆæŠŠåºåˆ—å½’çº¦ä¸ºä¸€ä¸ªå€¼ï¼‰ æ¥è‡ª functoolsï¼š\nfrom functools import reduce è¯­æ³•\nreduce(function, iterable, initializer) ç¤ºä¾‹ï¼šç´¯åŠ \nreduce(lambda a, b: a + b, [1, 2, 3, 4]) è¿‡ç¨‹ç­‰ä»·ä¸ºï¼š\n(((1 + 2) + 3) + 4) åˆå§‹åŒ–å€¼ initializer\nreduce(lambda a, b: a + b, [1, 2, 3], 10) 6ï¸âƒ£ ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ â€”â€” ç”¨ yield åŠ¨æ€ç”Ÿæˆæ•°æ®ï¼ˆæƒ°æ€§ï¼‰ ç‰¹ç‚¹ï¼š\næ¯æ¬¡åªç”Ÿæˆä¸€ä¸ªæ•°æ® å†…å­˜å ç”¨æå° å¯æ— é™åºåˆ— å¾ˆé€‚åˆæ•°æ®æµå¤„ç† ç¤ºä¾‹\ndef gen_nums(n): for i in range(n): yield i g = gen_nums(5) print(next(g)) print(next(g)) 7ï¸âƒ£ è¿­ä»£å™¨ï¼ˆiteratorï¼‰ â€”â€” æ”¯æŒ next() çš„å¯¹è±¡ åˆ¤æ–­æ˜¯å¦è¿­ä»£å™¨\nfrom collections.abc import Iterator isinstance(obj, Iterator) è‡ªå®šä¹‰è¿­ä»£å™¨\nclass Counter: def __init__(self, n): self.i = 0 self.n = n def __iter__(self): return self def __next__(self): if self.i \u0026lt; self.n: self.i += 1 return self.i raise StopIteration c = Counter(3) for x in c: print(x) 8ï¸âƒ£ æƒ°æ€§æ‰§è¡Œï¼ˆLazy Evaluationï¼‰ ä»¥ä¸‹å¯¹è±¡éƒ½æ˜¯â€œæƒ°æ€§çš„â€ï¼š\nç±»å‹ æ˜¯å¦æƒ°æ€§ generator âœ…ï¸ map âœ…ï¸ filter âœ…ï¸ zip âœ…ï¸ iter(range) âœ…ï¸ file å¯¹è±¡ âœ…ï¸ itertools é“¾æ¥ç±» âœ…ï¸ æƒ°æ€§æ„å‘³ç€ï¼š\nğŸ‘‰ ä¸ä¼šä¸€æ¬¡æ€§ç”Ÿæˆæ•°æ®ï¼Œåªåœ¨éœ€è¦æ—¶ç”Ÿæˆ\næ•ˆç‡é«˜ã€å†…å­˜å ç”¨å°ã€‚\n9ï¸âƒ£ map / filter / reduce / generator / iterator ç»„åˆå®æˆ˜ ç¤ºä¾‹ 1ï¼šå¤„ç†è‚¡ç¥¨æ•°æ® from functools import reduce stocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;price\u0026#34;: 12}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;price\u0026#34;: 8}, {\u0026#34;code\u0026#34;: \u0026#34;600003\u0026#34;, \u0026#34;price\u0026#34;: 15}, ] # (1) æå–ä»·æ ¼ prices = map(lambda s: s[\u0026#34;price\u0026#34;], stocks) # (2) è¿‡æ»¤ \u0026gt; 10 çš„ä»·æ ¼ high_prices = filter(lambda p: p \u0026gt; 10, prices) # (3) æ±‚å’Œ total = reduce(lambda a, b: a + b, high_prices, 0) print(total) # 27 é“¾å¼å‡½æ•°å¼å†™æ³•ï¼Œæ¯” for å¾ªç¯æ›´ä¼˜é›…ã€‚\nç¤ºä¾‹ 2ï¼šç”Ÿæˆå™¨å¤„ç†å¤§è§„æ¨¡æ—¥å¿— def read_lines(path): with open(path) as f: for line in f: yield line.strip() # æƒ°æ€§è¿‡æ»¤ errors = (line for line in read_lines(\u0026#34;app.log\u0026#34;) if \u0026#34;ERROR\u0026#34; in line) for e in errors: print(e) é€‚åˆå¤§å‹æ—¥å¿—å¤„ç†ï¼Œä¸ä¼šå å¤§é‡å†…å­˜ã€‚\nç¤ºä¾‹ 3ï¼šè¿­ä»£å™¨ + map å®ç°æ— é™åºåˆ— def infinite(start=0): while True: yield start start += 1 # å–æ— é™åºåˆ—çš„å¹³æ–¹ squared = map(lambda x: x * x, infinite()) for i in range(5): print(next(squared)) ğŸ”Ÿ Python å‡½æ•°å¼ç¼–ç¨‹æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ æ¨èä½¿ç”¨ï¼š\nmap/filterï¼ˆä»…å½“ç®€å•è§„åˆ™æ—¶ï¼‰ reduceï¼ˆç”¨äºç´¯ç§¯/å½’çº¦ï¼‰ ç”Ÿæˆå™¨ï¼ˆç”¨äºæ•°æ®æµï¼‰ é“¾å¼ç»„åˆ ç”Ÿæˆå™¨ä¼˜å…ˆäºåˆ—è¡¨ï¼ˆèŠ‚çœå†…å­˜ï¼‰\næ‰€æœ‰å¤§è§„æ¨¡æ•°æ®å¤„ç†éƒ½å°½é‡ç”¨ç”Ÿæˆå™¨ å¯è¯»æ€§ä¼˜å…ˆï¼Œå¦‚æœé€»è¾‘å¤æ‚ä¸è¦ç¡¬ç”¨ map/filter\nå¤æ‚é€»è¾‘ç”¨ forï¼Œç®€å•é€»è¾‘ç”¨ map/filter é¿å… lambda é‡Œå†™å¤æ‚è¯­å¥ï¼ˆå½±å“å¯è¯»æ€§ï¼‰\nğŸ“˜ æ•´ä½“è®°å¿†å…¬å¼ï¼ˆè¶…ç®€ç‰ˆï¼‰ mapï¼šå¯¹æ¯ä¸ªå…ƒç´ åšå˜æ¢ filterï¼šè¿‡æ»¤å…ƒç´  reduceï¼šæŠŠæ‰€æœ‰å…ƒç´ æŠ˜å æˆä¸€ä¸ªå€¼ lambdaï¼šç®€çŸ­å‡½æ•°è¡¨è¾¾å¼ ç”Ÿæˆå™¨ï¼šyieldï¼Œä¸€æ¬¡ä¸€ä¸ªï¼Œæƒ°æ€§ è¿­ä»£å™¨ï¼šæ”¯æŒ next() çš„å¯¹è±¡ ","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ ã€ŒPython å‡½æ•°å¼ç¼–ç¨‹çŸ¥è¯†ä½“ç³»ï¼šmap / filter / reduce / lambda / ç”Ÿæˆå™¨ / è¿­ä»£å™¨ã€å…¨å¥—æ•´ç†ã€‚\nç»“æ„æ¸…æ™°ã€åº”ç”¨åœºæ™¯æ˜ç¡®ã€æ¯èŠ‚éƒ½æœ‰ç¤ºä¾‹ï¼Œå¯ç›´æ¥ä½œä¸ºæ–‡æ¡£æˆ–ä½ ä»Šåé¡¹ç›®ä¸­çš„å·¥å…·çŸ¥è¯†åº“ã€‚\nâ˜˜ï¸ Python å‡½æ•°å¼ç¼–ç¨‹çŸ¥è¯†ä½“ç³»ï¼ˆå®Œæ•´ç‰ˆï¼‰\nç›®å½•\næ ¸å¿ƒç†å¿µï¼šä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹ lambda è¡¨è¾¾å¼ map å‡½æ•° filter å‡½æ•° reduce å‡½æ•° ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ è¿­ä»£å™¨ï¼ˆiteratorï¼‰ æƒ°æ€§æ‰§è¡Œï¼ˆlazy evaluationï¼‰ ä¸‰è€…ç»„åˆå®æˆ˜ Python å‡½æ•°å¼ç¼–ç¨‹æœ€ä½³å®è·µ 1ï¸âƒ£ æ ¸å¿ƒç†å¿µï¼šä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼Ÿ å‡½æ•°å¼ç¼–ç¨‹ï¼ˆFunctional Programming, FPï¼‰å¼ºè°ƒï¼š\næ— å‰¯ä½œç”¨ å‡½æ•°æ˜¯â€œä¸€ç­‰å…¬æ°‘â€ é“¾å¼å¤„ç†æ•°æ® å¯ç»„åˆã€å¯å¤ç”¨ åå‘ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ æ ¸å¿ƒæ€æƒ³ï¼š\nğŸ‘‰ ç”¨å‡½æ•°å¤„ç†æ•°æ®ï¼Œè€Œä¸æ˜¯å†™ for å¾ªç¯ã€‚\nä½“ç°ï¼šmap / filter / reduceã€è¿­ä»£å™¨ã€ç”Ÿæˆå™¨ã€lambdaã€‚\n"},{"id":215,"href":"/backend/python/official/functools-cache/","title":"Functools -- cache","parent":"Official","content":" â­ 1. functools.cache æ˜¯ä»€ä¹ˆï¼Ÿ Python 3.9+ æ–°å¢ï¼š\nfrom functools import cache å®ƒæ˜¯ï¼š\nâœ… æ— å‚æ•°ç‰ˆ lru_cache(maxsize=None)\næ°¸è¿œç¼“å­˜å‡½æ•°çš„æ‰€æœ‰å‚æ•°ç»“æœ é€‚ç”¨äºï¼š\nçº¯å‡½æ•° è®¡ç®—æ˜‚è´µä¸”å¤šæ¬¡é‡å¤è°ƒç”¨ å‚æ•°å¯å“ˆå¸Œï¼ˆå¿…è¦æ¡ä»¶ï¼‰ â­ 2. åŸºæœ¬ç”¨æ³• from functools import cache @cache def add(a, b): print(\u0026#34;running...\u0026#34;) return a + b print(add(1, 2)) # ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ‰“å° \u0026#34;running...\u0026#34; print(add(1, 2)) # ç¬¬äºŒæ¬¡å‘½ä¸­ç¼“å­˜ï¼Œä¸æ‰“å°\u0026#34;running...\u0026#34; ğŸ“Œ ç‰¹ç‚¹ï¼šç¬¬äºŒæ¬¡è°ƒç”¨å®Œå…¨ä¸è¿è¡Œå‡½æ•°ä½“ï¼Œé€Ÿåº¦æå¿«ã€‚\nâ­ 3. ä¸ lru_cache çš„åŒºåˆ« åŠŸèƒ½ cache lru_cache éœ€è¦è®¾ç½® maxsize âŒ æ—  (æ— é™ç¼“å­˜) âœ… å¯è®¾ç½® ç¼“å­˜ç­–ç•¥ æ°¸ä¹…ç¼“å­˜ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ æ¸…ç†ç¼“å­˜ æ‰‹åŠ¨ .cache_clear() æ‰‹åŠ¨ .cache_clear() å†…å­˜ä½¿ç”¨ æŒç»­å¢é•¿ æœ‰ä¸Šé™ â­ 4. ç¼“å­˜çš„æ¸…ç† add.cache_clear() æŸ¥çœ‹ä¿¡æ¯ï¼š\nadd.cache_info() # hits, misses, etc â­ 5. å‚æ•°å¿…é¡»å¯å“ˆå¸Œï¼ˆé‡è¦ï¼‰ âŒ ä»¥ä¸‹ä¸èƒ½ç”¨ï¼š\nlist dict set âœ… ä»¥ä¸‹å¯ä»¥ï¼š\nstr int tuple frozenset â­ 6. ä½¿ç”¨ tuple åŒ…è£…è§£å†³ä¸å¯ hash çš„å‚æ•° @cache def calc(data): return sum(data) calc(tuple([1, 2, 3])) â­ 7. ä½¿ç”¨åœºæ™¯ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¼‰é‡å¤æ€§é«˜çš„è®¡ç®—ä»»åŠ¡ @cache def fib(n): if n \u0026lt; 2: return n return fib(n-1) + fib(n-2) æ— é™ç¼“å­˜å¯æå¤§åŠ é€Ÿã€‚\n2ï¼‰æ•°æ®çˆ¬è™«é‡å¤è¯·æ±‚ï¼ˆä¾‹å¦‚è‚¡ç¥¨æ•°æ®ï¼‰ @cache def get_detail(code): return requests.get(f\u0026#34;.../{code}\u0026#34;).json() âš ï¸ æ³¨æ„ï¼šè¯·æ±‚å‡½æ•°å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œå¦åˆ™ç¼“å­˜ä¼šé€ æˆè„æ•°æ®ã€‚\n3ï¼‰é…ç½®åŠ è½½ / æ¨¡æ¿è¯»å–ï¼ˆæ–‡ä»¶ I/Oï¼‰ @cache def load_template(name): with open(name) as f: return f.read() é¿å…é‡å¤è¯»æ–‡ä»¶ã€‚\n4ï¼‰æ•°æ®åº“æŸ¥è¯¢ï¼ˆåªè¯»åœºæ™¯ï¼‰ @cache def stock_name(code): return db.query(...).first().name âš ï¸ é€‚ç”¨äºæ•°æ®ä¸é¢‘ç¹å˜åŒ–çš„å­—å…¸è¡¨ã€è¡Œä¸šè¡¨ã€é…ç½®è¡¨ã€‚\nâ­ 8. åœ¨ç±»ä¸­ä½¿ç”¨ @cache class Stock: @cache def name_by_code(self, code): return requests.get(f\u0026#34;.../{code}\u0026#34;) ğŸ“Œ æ³¨æ„ï¼š\nç±»æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•° self ä¹Ÿå‚ä¸ç¼“å­˜ï¼Œå› æ­¤å®ä¾‹å¿…é¡» hashableã€‚ è‹¥ä¸å¸Œæœ›è¿™æ ·ï¼Œåº”ä½¿ç”¨ @staticmethodã€‚ â­ 9. ä¸ async ä¸å…¼å®¹ï¼ˆé‡è¦ï¼‰ @cache ä¸èƒ½ç”¨åœ¨ async å‡½æ•°ä¸Šã€‚\nå¼‚æ­¥ç¼“å­˜éœ€è¦ï¼š\nasync_lru æˆ–ä½ è‡ªå·±ç»´æŠ¤ dict ç¼“å­˜ ä¾‹å¦‚ï¼š\nfrom functools import lru_cache import asyncio @lru_cache def fetch(url): return asyncio.run(client.get(url)) # âŒ ä¸æ¨è ğŸ“Œ async å»ºè®®æˆ‘å¸®ä½ å†™å•ç‹¬çš„ async cacheã€‚\nâ­ 10. çœŸå®å·¥ç¨‹æœ€ä½³å®è·µï¼šå°è£…ç¼“å­˜è£…é¥°å™¨ ä½ çš„é¡¹ç›®ä¸­å¯ä»¥å°è£…ï¼š\nfrom functools import cache from loguru import logger def cached(func): cached_func = cache(func) def wrapper(*args, **kwargs): logger.debug(f\u0026#34;Cache =\u0026gt; {func.__name__}({args}, {kwargs})\u0026#34;) return cached_func(*args, **kwargs) wrapper.cache_clear = cached_func.cache_clear return wrapper ä½¿ç”¨ï¼š\n@cached def get_stock(code): ... â­ 11. ç»ˆæé€ŸæŸ¥è¡¨ é¡¹ç›® å†…å®¹ å¯¼å…¥ from functools import cache ç”¨æ³• @cache æ¸…ç©ºç¼“å­˜ func.cache_clear() æŸ¥çœ‹å‘½ä¸­ç‡ func.cache_info() å¿…é¡»å¯ hash âœ… é€‚ç”¨äº çº¯å‡½æ•°ã€é‡å¤è®¡ç®—ã€é…ç½®åŠ è½½ ä¸é€‚ç”¨äº asyncã€å¯å˜å¯¹è±¡å‚æ•° å†…å­˜ç­–ç•¥ æ°¸ä¹…ç¼“å­˜ ","description":" â­ 1. functools.cache æ˜¯ä»€ä¹ˆï¼Ÿ Python 3.9+ æ–°å¢ï¼š\nfrom functools import cache å®ƒæ˜¯ï¼š\nâœ… æ— å‚æ•°ç‰ˆ lru_cache(maxsize=None)\næ°¸è¿œç¼“å­˜å‡½æ•°çš„æ‰€æœ‰å‚æ•°ç»“æœ é€‚ç”¨äºï¼š\nçº¯å‡½æ•° è®¡ç®—æ˜‚è´µä¸”å¤šæ¬¡é‡å¤è°ƒç”¨ å‚æ•°å¯å“ˆå¸Œï¼ˆå¿…è¦æ¡ä»¶ï¼‰ â­ 2. åŸºæœ¬ç”¨æ³• from functools import cache @cache def add(a, b): print(\u0026#34;running...\u0026#34;) return a + b print(add(1, 2)) # ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ‰“å° \u0026#34;running...\u0026#34; print(add(1, 2)) # ç¬¬äºŒæ¬¡å‘½ä¸­ç¼“å­˜ï¼Œä¸æ‰“å°\u0026#34;running...\u0026#34; ğŸ“Œ ç‰¹ç‚¹ï¼šç¬¬äºŒæ¬¡è°ƒç”¨å®Œå…¨ä¸è¿è¡Œå‡½æ•°ä½“ï¼Œé€Ÿåº¦æå¿«ã€‚\n"},{"id":216,"href":"/backend/python/official/functools-cached_property/","title":"Functools -- cached_property","parent":"Official","content":" âœ… 1. cached_property æ˜¯ä»€ä¹ˆï¼Ÿ cached_property æ˜¯ Python 3.8+ å¼•å…¥çš„è£…é¥°å™¨ï¼š\nfrom functools import cached_property å®ƒç”¨äº æŠŠç±»çš„æ–¹æ³•å˜æˆåªè®¡ç®—ä¸€æ¬¡çš„å±æ€§ï¼Œå¹¶æŠŠç»“æœç¼“å­˜ä¸‹æ¥ã€‚\næ¢å¥è¯è¯´ï¼š\nğŸ“Œ ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è¿è¡Œå‡½æ•°ã€è®¡ç®—ç»“æœ ğŸ“Œ åç»­è®¿é—®ä¸å†æ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜é‡Œå–å€¼ ğŸ“Œ ç”¨äºé‚£äº›è®¡ç®—æ˜‚è´µä½†åˆä¸æƒ³åœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œçš„å±æ€§ ğŸ“Œ 2. æœ€ç®€å•ç¤ºä¾‹ from functools import cached_property import time class Data: @cached_property def expensive_value(self): print(\u0026#34;è®¡ç®—ä¸­...\u0026#34;) time.sleep(2) return 42 d = Data() print(d.expensive_value) # ä¼šæ‰“å° \u0026#34;è®¡ç®—ä¸­...\u0026#34;ï¼Œç„¶åè¾“å‡º 42 print(d.expensive_value) # ç›´æ¥è¿”å› 42ï¼Œä¸å†è®¡ç®— ğŸ‘‰ ç¬¬äºŒæ¬¡è®¿é—®æ—¶ ä¸ä¼šå†æ‰§è¡Œå‡½æ•°ã€‚\nâœ… 3. ä¸ºä»€ä¹ˆå®ƒä¼˜äº propertyï¼Ÿ æ™®é€š @propertyï¼š\næ¯è®¿é—®ä¸€æ¬¡å°±è®¡ç®—ä¸€æ¬¡ -\u0026gt; æ…¢ ä¸é€‚åˆæ˜‚è´µæ“ä½œ @cached_propertyï¼š\nåªæ‰§è¡Œä¸€æ¬¡ åé¢å…¨éƒ¨ç”¨ç¼“å­˜ ç¼“å­˜çš„å€¼å­˜å‚¨åœ¨å®ä¾‹çš„ __dict__ é‡Œ ğŸŸ£ 4. cached_property çš„å†…éƒ¨æœºåˆ¶ï¼ˆå¾ˆé‡è¦ï¼‰ è®¿é—® obj.attr æ—¶ï¼š\nç¬¬ä¸€æ¬¡è°ƒç”¨æ–¹æ³• æ‰§è¡Œæ–¹æ³•ä½“ï¼Œå¾—åˆ°ç»“æœ æŠŠç»“æœæ”¾åˆ° obj.__dict__['attr'] ä¸‹æ¬¡è®¿é—®ç›´æ¥ä» dict ä¸­å–å€¼ æ‰€ä»¥ä½ å¯ä»¥æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼š\ndel obj.expensive_value ä¸‹æ¬¡è®¿é—®ä¼šé‡æ–°è®¡ç®—ã€‚\nğŸŸ¢ 5. å®ç”¨åœºæ™¯ï¼ˆéå¸¸é‡è¦ï¼‰ 1. æ•°æ®åº“è¿æ¥ï¼ˆæ‡’åŠ è½½ï¼‰ class DB: @cached_property def engine(self): return create_engine(...) è®¿é—® db.engine æ‰çœŸæ­£å»ºç«‹è¿æ¥ã€‚\n2. é…ç½®æ–‡ä»¶è¯»å– class Config: @cached_property def settings(self): with open(\u0026#34;config.json\u0026#34;) as f: return json.load(f) ä¸ä¼šæ¯æ¬¡éƒ½è¯»æ–‡ä»¶ã€‚\n3. Web é¡¹ç›®ä¸­ç¼“å­˜è®¡ç®—ç»“æœ class User: @cached_property def profile(self): return load_profile_from_db(self.id) 4. å¤§é‡è®¡ç®—ï¼ˆå¤æ‚ç»Ÿè®¡ã€è§£æã€åˆ†æï¼‰ class Stock: @cached_property def summary(self): return compute_summary(self.data) ğŸ”¥ 6. ä½•æ—¶ç”¨ cached_propertyï¼Œè€Œä¸æ˜¯ cacheï¼Ÿ åœºæ™¯ ç”¨ cached_property ç”¨ cache ç»‘å®šåˆ°å¯¹è±¡å®ä¾‹ âœ… âŒ æƒ³ç¼“å­˜æ–¹æ³•ç»“æœï¼ˆä¸ self ç»‘å®šï¼‰ âœ… âŒ æƒ³ç¼“å­˜æ™®é€šå‡½æ•° âŒ âœ… æƒ³ç¼“å­˜å¤šç§å‚æ•°çš„ç»“æœ âŒ âœ…ï¼ˆcache æ”¯æŒä¸åŒå‚æ•°ç¼“å­˜ï¼‰ æƒ³æ‡’åŠ è½½å±æ€§ âœ… âŒ cached_property æ˜¯ instance-level cache cache æ˜¯ function-level cache\nğŸŸ© 7. cached_property æ¸…é™¤ç¼“å­˜ del obj.expensive_value å†æ¬¡è®¿é—®ä¼šé‡æ–°è®¡ç®—ã€‚\nå¦‚æœä½ æƒ³ä¸€æ¬¡æ€§æ¸…ç©ºå…¨éƒ¨ cached_propertyï¼š\nfor key in list(obj.__dict__.keys()): del obj.__dict__[key] ğŸŸ¥ 8. æ³¨æ„äº‹é¡¹ï¼ˆéå¸¸å…³é”®ï¼‰ âŒ ä¸æ”¯æŒ async @cached_property async def value(): # é”™è¯¯ ä¸èƒ½è¿™ä¹ˆå†™ã€‚\nè‹¥éœ€è¦ async ç‰ˆï¼Œæˆ‘èƒ½å¸®ä½ å†™ async_cached_propertyã€‚\nâŒ ä¸è¦ç”¨äºå¯å˜å¯¹è±¡ï¼ˆå®¹æ˜“è„æ•°æ®ï¼‰ ä¾‹å¦‚ï¼š\n@cached_property def data(self): return {\u0026#34;a\u0026#34;: 1} ä½ ä¿®æ”¹å®ƒï¼š\nobj.data[\u0026#34;a\u0026#34;] = 999 ç¼“å­˜ä¸ä¼šåˆ·æ–°ï¼Œå°å¿ƒå‰¯ä½œç”¨ã€‚\nğŸŸ¦ 9. é«˜çº§ç”¨æ³•ï¼šåªè¯»å±æ€§ï¼ˆä¸å¯è¦†ç›–ï¼‰ å¦‚æœå¸Œæœ›é˜²æ­¢ç”¨æˆ·è¦†ç›– cached_propertyï¼š\nclass Safe: @cached_property def value(self): return 123 @value.setter def value(self, v): raise AttributeError(\u0026#34;value is read-only\u0026#34;) ğŸŸ£ 10. é«˜çº§å°è£…ï¼šå¸¦ logger çš„ cached_property from functools import cached_property from loguru import logger def logged_cached_property(func): @cached_property def wrapper(self): logger.debug(f\u0026#34;Computing {func.__name__}\u0026#34;) return func(self) return wrapper ä½¿ç”¨ï¼š\nclass Data: @logged_cached_property def info(self): return load_big_data() ğŸŸ© 11. ä¸€å±æŒæ¡ cached_property ç”¨æ³•ï¼š@cached_property ç›®çš„ï¼šæŠŠè®¡ç®—ä¸€æ¬¡çš„å€¼ç¼“å­˜ä¸ºå±æ€§ é¦–æ¬¡è®¿é—®ï¼šæ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ å†æ¬¡è®¿é—®ï¼šç›´æ¥è¯»å–ç¼“å­˜ï¼Œä¸æ‰§è¡Œå‡½æ•° ç¼“å­˜ä½ç½®ï¼šå®ä¾‹ __dict__ æ¸…é™¤ç¼“å­˜ï¼šdel obj.attr é€‚ç”¨åœºæ™¯ï¼šæ‡’åŠ è½½ã€æ˜‚è´µè®¡ç®—ã€é…ç½®è¯»å– ä¸é€‚ç”¨ï¼šasyncã€ä¼šå˜åŒ–çš„å€¼ã€éœ€è¦å‚æ•°çš„å‡½æ•° ","description":" âœ… 1. cached_property æ˜¯ä»€ä¹ˆï¼Ÿ cached_property æ˜¯ Python 3.8+ å¼•å…¥çš„è£…é¥°å™¨ï¼š\nfrom functools import cached_property å®ƒç”¨äº æŠŠç±»çš„æ–¹æ³•å˜æˆåªè®¡ç®—ä¸€æ¬¡çš„å±æ€§ï¼Œå¹¶æŠŠç»“æœç¼“å­˜ä¸‹æ¥ã€‚\næ¢å¥è¯è¯´ï¼š\nğŸ“Œ ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è¿è¡Œå‡½æ•°ã€è®¡ç®—ç»“æœ ğŸ“Œ åç»­è®¿é—®ä¸å†æ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜é‡Œå–å€¼ ğŸ“Œ ç”¨äºé‚£äº›è®¡ç®—æ˜‚è´µä½†åˆä¸æƒ³åœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œçš„å±æ€§ ğŸ“Œ 2. æœ€ç®€å•ç¤ºä¾‹ from functools import cached_property import time class Data: @cached_property def expensive_value(self): print(\u0026#34;è®¡ç®—ä¸­...\u0026#34;) time.sleep(2) return 42 d = Data() print(d.expensive_value) # ä¼šæ‰“å° \u0026#34;è®¡ç®—ä¸­...\u0026#34;ï¼Œç„¶åè¾“å‡º 42 print(d.expensive_value) # ç›´æ¥è¿”å› 42ï¼Œä¸å†è®¡ç®— ğŸ‘‰ ç¬¬äºŒæ¬¡è®¿é—®æ—¶ ä¸ä¼šå†æ‰§è¡Œå‡½æ•°ã€‚\n"},{"id":217,"href":"/backend/python/official/functools-cmp_to_key/","title":"Functools -- cmp_to_key","parent":"Official","content":" âœ… 1. cmp_to_key æ˜¯ä»€ä¹ˆï¼Ÿ cmp_to_key ç”¨äºæŠŠâ€œè€å¼æ¯”è¾ƒå‡½æ•°ï¼ˆcmp é£æ ¼ï¼‰â€è½¬æ¢ä¸ºâ€œæ–°å¼æ’åº key å‡½æ•°â€ã€‚\nPython3 åºŸå¼ƒäº† cmp å‚æ•°ï¼Œä½†ä½ æœ‰æ—¶ä»éœ€è¦ï¼š\nè‡ªå®šä¹‰æ’åºè§„åˆ™ å¤šæ¡ä»¶å¤æ‚æ¯”è¾ƒ éæ ‡å‡†æ’åºé€»è¾‘ ä¸ Python2 ä¿æŒå…¼å®¹ è¿™æ—¶å°±ç”¨ï¼š\nfrom functools import cmp_to_key ğŸŸ¦ 2. ä¸ºä»€ä¹ˆéœ€è¦ cmp_to_keyï¼Ÿ Python3 çš„ sorted() å’Œ list.sort() åªèƒ½ç”¨ï¼š\nkey=function reverse=True ä¸èƒ½ä¼ å…¥ cmp=functionã€‚\nä½†æœ‰äº›æ’åºæ— æ³•ç”¨ key è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š\næ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ä¹‹é—´å…³ç³» éœ€è¦çœ‹ä¸¤è€…çš„å¤§å°å˜åŒ– key è®¡ç®—æ— æ³•è¡¨ç¤ºæ’åºè§„åˆ™ ä¾‹å¦‚ï¼š\næŒ‰ç»å¯¹å€¼æ’åºï¼Œä½†è´Ÿæ•°ä¼˜å…ˆ å¤æ‚å¤šçº§æ¯”è¾ƒ ä¸­æ–‡æ‹¼éŸ³æ’åº è‡ªå®šä¹‰è‚¡ç¥¨æ’åºï¼ˆå¦‚ 00 å¼€å¤´ä¼˜å…ˆï¼‰ è‡ªå®šä¹‰ None / ç©ºå€¼ çš„æ’åºæ–¹å¼ è¿™äº›æ— æ³•ç”¨ key å‡½æ•°è¡¨è¾¾ã€‚\nğŸŸ© 3. cmp_to_key æœ€å°ç¤ºä¾‹ï¼ˆç«‹åˆ»æ‡‚ï¼‰ from functools import cmp_to_key def mycmp(a, b): if a \u0026lt; b: return -1 # a åœ¨å‰ if a \u0026gt; b: return 1 # b åœ¨å‰ return 0 # ç›¸ç­‰ nums = [5, 2, 9, 1] print(sorted(nums, key=cmp_to_key(mycmp))) è¾“å‡ºï¼š\n[1, 2, 5, 9] ç­‰æ•ˆäºæ™®é€šæ’åºï¼Œåªæ˜¯ä½¿ç”¨äº†è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ã€‚\nğŸŸª 4. cmp_to_key å·¥ä½œåŸç† cmp_to_key ä¼šå°†ï¼š\ncmp(a, b) -\u0026gt; -1 / 0 / 1 è½¬æ¢ä¸ºä¸€ä¸ª â€œå¯æ¯”è¾ƒçš„ Key å¯¹è±¡â€ï¼Œæœ€ç»ˆè®©ï¼š\nsorted(key=cmp_to_key(...)) èƒ½å¤Ÿä½¿ç”¨è¿™ä¸ª key çš„æ¯”è¾ƒé€»è¾‘ã€‚\nç®€åŒ–ç†è§£ï¼š\nâ— cmp -\u0026gt; key\ncmp_to_key æŠŠ cmp å°èµ·æ¥ï¼Œè®©æ’åºè§‰å¾—å®ƒæ˜¯ä¸€ä¸ª keyã€‚\nğŸŸ§ 5. æœ€å¸¸ç”¨å®æˆ˜ç¤ºä¾‹ â‘  æŒ‰å­—ç¬¦ä¸²é•¿åº¦æ’åºï¼Œä½†é•¿åº¦ç›¸åŒæŒ‰å­—å…¸åºæ’\ndef mycmp(a, b): if len(a) \u0026lt; len(b): return -1 if len(a) \u0026gt; len(b): return 1 return -1 if a \u0026lt; b else (1 if a \u0026gt; b else 0) lst = [\u0026#34;python\u0026#34;, \u0026#34;c\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;java\u0026#34;] print(sorted(lst, key=cmp_to_key(mycmp))) ğŸŸ§ 6. æœ€å¸¸ç”¨å®æˆ˜ç¤ºä¾‹ â‘¡ æŒ‰è‚¡ç¥¨ä»£ç æ’åºï¼ˆä¼˜å…ˆ 00 -\u0026gt; 60 -\u0026gt; å…¶ä»–ï¼‰\ndef stock_cmp(a, b): pri_a = 1 if a.startswith(\u0026#34;00\u0026#34;) else 2 if a.startswith(\u0026#34;60\u0026#34;) else 3 pri_b = 1 if b.startswith(\u0026#34;00\u0026#34;) else 2 if b.startswith(\u0026#34;60\u0026#34;) else 3 if pri_a != pri_b: return -1 if pri_a \u0026lt; pri_b else 1 return -1 if a \u0026lt; b else 1 if a \u0026gt; b else 0 codes = [\u0026#34;300001\u0026#34;, \u0026#34;600000\u0026#34;, \u0026#34;000001\u0026#34;, \u0026#34;601398\u0026#34;, \u0026#34;002594\u0026#34;] print(sorted(codes, key=cmp_to_key(stock_cmp))) ğŸŸ§ 7. æœ€å¸¸ç”¨å®æˆ˜ç¤ºä¾‹ â‘¢ None æ’åˆ°æœ€å\ndef none_last(a, b): if a is None: return 1 if b is None: return -1 return (a \u0026gt; b) - (a \u0026lt; b) values = [4, None, 2, 9, None, 1] print(sorted(values, key=cmp_to_key(none_last))) è¾“å‡ºï¼š\n[1, 2, 4, 9, None, None] ğŸŸ¦ 8. cmp_to_key çš„æ¨¡æ¿ï¼ˆç›´æ¥å¤åˆ¶ç”¨ï¼‰ def cmp(a, b): if a \u0026lt; b: return -1 if a \u0026gt; b: return 1 return 0 sorted_list = sorted(data, key=cmp_to_key(cmp)) å¤šæ¡ä»¶æ¯”è¾ƒæ¨¡æ¿ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰ï¼š\ndef cmp(a, b): # ä¸€çº§æ¯”è¾ƒ r = (a[\u0026#34;x\u0026#34;] \u0026gt; b[\u0026#34;x\u0026#34;]) - (a[\u0026#34;x\u0026#34;] \u0026lt; b[\u0026#34;x\u0026#34;]) if r != 0: return r # äºŒçº§æ¯”è¾ƒ r = (a[\u0026#34;y\u0026#34;] \u0026gt; b[\u0026#34;y\u0026#34;]) - (a[\u0026#34;y\u0026#34;] \u0026lt; b[\u0026#34;y\u0026#34;]) if r != 0: return r # ä¸‰çº§æ¯”è¾ƒ return (a[\u0026#34;z\u0026#34;] \u0026gt; b[\u0026#34;z\u0026#34;]) - (a[\u0026#34;z\u0026#34;] \u0026lt; b[\u0026#34;z\u0026#34;]) ğŸŸ© 9. cmp_to_key çš„é«˜çº§æŠ€å·§ å¤šå­—æ®µæ’åºï¼ˆå­—å…¸ / å¯¹è±¡ï¼‰ def cmp(a, b): return (a.id \u0026gt; b.id) - (a.id \u0026lt; b.id) or \\ (a.name \u0026gt; b.name) - (a.name \u0026lt; b.name) åå‘æ’åºï¼ˆè‡ªå®šä¹‰ï¼‰ def reverse_cmp(a, b): return (a \u0026lt; b) - (a \u0026gt; b) ä¸­æ–‡æ‹¼éŸ³æ’åºï¼ˆéœ€è¦å¤–éƒ¨åº“ pypinyinï¼‰ ğŸŸ¥ 10. æ€§èƒ½æ³¨æ„äº‹é¡¹ æ–¹æ³• æ€§èƒ½ key æ’åº â­â­â­â­â­ æœ€å¿« cmp_to_key â­â­ è¾ƒæ…¢ æ‰‹å†™æ’åºç®—æ³• âŒ ä¸è¦ å¦‚æœæ’åºé€»è¾‘èƒ½ç”¨ key å‡½æ•°è¡¨è¾¾ï¼Œä¸€å®šä¸è¦ç”¨ cmp_to_keyã€‚\nğŸŸ¦ 11. ä¸€å±é€ŸæŸ¥è¡¨ from functools import cmp_to_key def cmp(a, b): return -1 / 0 / 1 sorted(data, key=cmp_to_key(cmp)) ç”¨é€”ï¼š\nå¤æ‚æ’åº å¤šå­—æ®µæ¯”è¾ƒ ç‰¹æ®Šè§„åˆ™æ’åº è‡ªå®šä¹‰å¯¹è±¡æ¯”è¾ƒ ä¼˜ç‚¹ï¼š\nåŠŸèƒ½å¼ºï¼Œèƒ½è¡¨è¾¾ä»»æ„æ’åºé€»è¾‘ ç¼ºç‚¹ï¼š\næ¯” key æ’åºæ…¢ ä¸èƒ½ç”¨äºå¼‚æ­¥ cmp å‡½æ•°å¿…é¡»è¿”å› -1/0/1 ","description":" âœ… 1. cmp_to_key æ˜¯ä»€ä¹ˆï¼Ÿ cmp_to_key ç”¨äºæŠŠâ€œè€å¼æ¯”è¾ƒå‡½æ•°ï¼ˆcmp é£æ ¼ï¼‰â€è½¬æ¢ä¸ºâ€œæ–°å¼æ’åº key å‡½æ•°â€ã€‚\nPython3 åºŸå¼ƒäº† cmp å‚æ•°ï¼Œä½†ä½ æœ‰æ—¶ä»éœ€è¦ï¼š\nè‡ªå®šä¹‰æ’åºè§„åˆ™ å¤šæ¡ä»¶å¤æ‚æ¯”è¾ƒ éæ ‡å‡†æ’åºé€»è¾‘ ä¸ Python2 ä¿æŒå…¼å®¹ è¿™æ—¶å°±ç”¨ï¼š\nfrom functools import cmp_to_key ğŸŸ¦ 2. ä¸ºä»€ä¹ˆéœ€è¦ cmp_to_keyï¼Ÿ Python3 çš„ sorted() å’Œ list.sort() åªèƒ½ç”¨ï¼š\n"},{"id":218,"href":"/backend/python/official/functools-lru_cache/","title":"Functools -- lru_cache","parent":"Official","content":" ğŸŸ¦ 1. lru_cache æ˜¯ä»€ä¹ˆï¼Ÿ lru_cache æ˜¯ Python å†…ç½®çš„å‡½æ•°ç¼“å­˜è£…é¥°å™¨ï¼š\nè‡ªåŠ¨è®°å¿†å‚æ•° -\u0026gt; è¿”å›å€¼ ä¸‹æ¬¡ç›¸åŒå‚æ•°ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ æå‡æ€§èƒ½ 10ï½1000 å€ï¼ˆå¸¸è§ï¼‰ å®ç° LRUï¼šLeast Recently Usedï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°ï¼‰ æ¥è‡ªï¼š\nfrom functools import lru_cache ğŸŸ© 2. æœ€åŸºæœ¬ç”¨æ³• from functools import lru_cache @lru_cache() def add(a, b): print(\u0026#34;æ‰§è¡Œå‡½æ•°â€¦\u0026#34;) return a + b print(add(1, 2)) print(add(1, 2)) # ç¬¬äºŒæ¬¡ç›´æ¥ä½¿ç”¨ç¼“å­˜ è¾“å‡ºï¼š\næ‰§è¡Œå‡½æ•°â€¦ 3 3 ç¬¬äºŒæ¬¡æ²¡æœ‰æ‰“å°â€œæ‰§è¡Œå‡½æ•°â€ï¼Œè¯æ˜ç¼“å­˜å‘½ä¸­ã€‚\nğŸŸ¦ 3. æŒ‡å®šç¼“å­˜å¤§å° @lru_cache(maxsize=256) def expensive(): ... maxsize=None è¡¨ç¤ºæ— é™ç¼“å­˜ é»˜è®¤ maxsize=128 ğŸŸ© 4. æŸ¥çœ‹ç¼“å­˜ä¿¡æ¯ print(add.cache_info()) è¾“å‡ºç±»ä¼¼ï¼š\nCacheInfo(hits=1, misses=1, maxsize=128, currsize=1) ğŸŸ¦ 5. æ¸…ç©ºç¼“å­˜ add.cache_clear() ğŸŸ© 6. å¯ç¼“å­˜çš„æ•°æ®ç±»å‹è¦æ±‚ï¼ˆéå¸¸é‡è¦ï¼ï¼‰ å‚æ•°å¿…é¡»æ˜¯å¯å“ˆå¸Œçš„ï¼ˆå¯ä½œä¸º dict keyï¼‰ å¸¸è§å¯ç¼“å­˜ç±»å‹ï¼š int float str tupleï¼ˆå†…éƒ¨ä¹Ÿå¿…é¡»å¯å“ˆå¸Œï¼‰ bool None ä¸èƒ½ç¼“å­˜ï¼š\nlist dict set è‡ªå®šä¹‰å¯¹è±¡ï¼ˆé™¤éå®ç° __hash__ï¼‰ ä¾‹å¦‚ï¼Œè¿™ä¼šæŠ¥é”™ï¼š\n@lru_cache() def f(arr: list): return sum(arr) è§£å†³æ–¹å¼ï¼š\nâœ… ç”¨ tuple æ›¿ä»£ï¼š\n@lru_cache() def f(arr: tuple): return sum(arr) ğŸŸ¦ 7. ç¼“å­˜å¸¸ç”¨åœºæ™¯ï¼ˆå·¥ç¨‹å®è·µï¼‰ â‘  é…ç½®æ–‡ä»¶åŠ è½½ï¼ˆæœ€å¸¸è§ï¼‰ @lru_cache() def load_config(path: str) -\u0026gt; dict: with open(path) as f: return json.load(f) æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œéƒ½åªåŠ è½½ä¸€æ¬¡ã€‚\nâ‘¡ ç½‘ç»œæ•°æ®ç¼“å­˜ï¼ˆä½ çš„çˆ¬è™«ä¼šç”¨åˆ°ï¼‰ @lru_cache(maxsize=256) def fetch_stock(code: str): response = requests.get(f\u0026#34;https://api.example.com/{code}\u0026#34;) return response.json() å‡å°‘ API è°ƒç”¨é‡ï¼Œæé«˜é€Ÿåº¦ã€‚\nâ‘¢ è½¬æ¢å‡½æ•°ï¼ˆä½ è‡ªå·±çš„ stock.coderename éå¸¸é€‚ç”¨ï¼‰ @lru_cache() def coderename(code: str, restore=False): ... è‚¡ç¥¨ä»£ç æ ¼å¼è½¬æ¢éå¸¸é¢‘ç¹ï¼Œç¼“å­˜æ”¶ç›Šå·¨å¤§ã€‚\nâ‘£ æ•°æ®å­—å…¸è¯»å–ï¼ˆå¦‚è¡Œä¸šåˆ†ç±»ã€æ¿å—æ˜ å°„ï¼‰ @lru_cache() def get_industry_map(): return db.query(\u0026#34;select * from industry\u0026#34;) â‘¤ æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘ç¼“å­˜ï¼ˆæ¨èï¼‰ @lru_cache() def get_pattern(p): return re.compile(p) ğŸŸ¦ 8. å¼‚æ­¥å‡½æ•°ä¸èƒ½ç›´æ¥ç”¨ lru_cache è¿™æ˜¯å¾ˆå¤šäººè¸©å‘çš„ç‚¹ã€‚\né”™è¯¯ï¼š\n@lru_cache() async def get_data(): ... ä¼šæŠ¥é”™ï¼Œå› ä¸º async function è¿”å› coroutineï¼Œä¸å¯ç¼“å­˜ã€‚\nâœ… è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜åŒæ­¥çš„åŒ…è£…å‡½æ•°\ndef cache_wrapper(key): return fetch_sync(key) @lru_cache() def cached_fetch(key): return cache_wrapper(key) async def fetch_async(key): return await anyio.to_thread.run_sync(cached_fetch, key) å¦‚æœä½ é¡¹ç›®éœ€è¦ï¼Œæˆ‘å¯ä»¥ç»™ä½  å®Œå…¨å°è£…çš„ async + lru_cache å…¼å®¹æ–¹æ¡ˆã€‚\nğŸŸ© 9. LRU æ·˜æ±°æœºåˆ¶ï¼ˆç®€è¦ï¼‰ ç¼“å­˜æ»¡äº†æ—¶ æ·˜æ±° æœ€ä¹…æœªä½¿ç”¨ çš„ç¼“å­˜é¡¹ è®¿é—®ä¸€æ¬¡å°±ä¼šåˆ·æ–°â€œä½¿ç”¨æ—¶é—´â€ ğŸŸ¦ 10. é…ç½® maxsize çš„ç»éªŒè§„åˆ™ åœºæ™¯ æ¨è å°ç¼“å­˜ï¼ˆé…ç½®ã€æ­£åˆ™ç­‰ï¼‰ maxsize=None æˆ– 256 å¤–éƒ¨ API ç¼“å­˜ 1024 æˆ– 4096 é‡ CPU è®¡ç®— 128 æˆ– 256 éœ€è¦ä¸¥æ ¼æ§åˆ¶å†…å­˜ 64 æˆ– 128 ğŸŸ© 11. é«˜çº§ï¼šlru_cache + å‚æ•°è½¬æ¢ï¼ˆå®æˆ˜æŠ€å·§ï¼‰ å½“å‚æ•°ä¸å¯å“ˆå¸Œï¼ˆå¦‚ listã€dictï¼‰æ—¶ï¼Œè‡ªå®šä¹‰è½¬æ¢ï¼š\ndef normalize_args(func): @functools.wraps(func) def wrapper(data): key = tuple(sorted(data.items())) return func(key) return wrapper @lru_cache() @normalize_args def process(data_key): ... ä½¿ dict å¯ç¼“å­˜ã€‚\nğŸŸ¦ 12. æœ€ä½³å®è·µæ€»ç»“ï¼ˆæ”¶è—ï¼‰ âœ… ç”¨åœ¨ï¼š\né…ç½® è½¬æ¢å‡½æ•° æ­£åˆ™ç¼–è¯‘ é¢‘ç¹é‡å¤è®¡ç®— ç½‘ç»œè¯·æ±‚ æ•°æ®åº“å°è¡¨æŸ¥è¯¢ è‚¡ç¥¨æ•°æ®å¤„ç† âœ… é¿å…ï¼š\nå‚æ•°æ˜¯ list/dict è¿”å›å¤§é‡æ•°æ®ï¼ˆå å†…å­˜ï¼‰ å‚æ•°æ··ä¹±ï¼ˆç¼“å­˜å‘½ä¸­ç‡ä½ï¼‰ âœ… å·¥ç¨‹å»ºè®®ï¼š\nå¿…é¡»ç›‘æ§ cache_info() å®šæœŸ cache_clear()ï¼ˆæ ¹æ®ä¸šåŠ¡ï¼‰ ğŸŸ© 13. æœ€åç»™ä½ ä¸€ä¸ªå®æˆ˜æ¨¡æ¿ï¼ˆé€šç”¨ç‰ˆï¼‰ from functools import lru_cache @lru_cache(maxsize=1024) def get_stock_name(code: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; ç¼“å­˜è‚¡ç¥¨åç§°ï¼Œé¿å…é‡å¤è¯·æ±‚æ•°æ®åº“/æ¥å£ã€‚ \u0026#34;\u0026#34;\u0026#34; print(f\u0026#34;æŸ¥è¯¢è‚¡ç¥¨åç§°: {code}\u0026#34;) return db.query_stock_name(code) è°ƒç”¨ï¼š\nprint(get_stock_name(\u0026#34;600000\u0026#34;)) print(get_stock_name(\u0026#34;600000\u0026#34;)) # ä½¿ç”¨ç¼“å­˜ print(get_stock_name.cache_info()) ","description":" ğŸŸ¦ 1. lru_cache æ˜¯ä»€ä¹ˆï¼Ÿ lru_cache æ˜¯ Python å†…ç½®çš„å‡½æ•°ç¼“å­˜è£…é¥°å™¨ï¼š\nè‡ªåŠ¨è®°å¿†å‚æ•° -\u0026gt; è¿”å›å€¼ ä¸‹æ¬¡ç›¸åŒå‚æ•°ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ æå‡æ€§èƒ½ 10ï½1000 å€ï¼ˆå¸¸è§ï¼‰ å®ç° LRUï¼šLeast Recently Usedï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°ï¼‰ æ¥è‡ªï¼š\nfrom functools import lru_cache ğŸŸ© 2. æœ€åŸºæœ¬ç”¨æ³• from functools import lru_cache @lru_cache() def add(a, b): print(\u0026#34;æ‰§è¡Œå‡½æ•°â€¦\u0026#34;) return a + b print(add(1, 2)) print(add(1, 2)) # ç¬¬äºŒæ¬¡ç›´æ¥ä½¿ç”¨ç¼“å­˜ è¾“å‡ºï¼š\n"},{"id":219,"href":"/backend/python/official/functools-partial/","title":"Functools -- partial","parent":"Official","content":" âœ… 1. partial æ˜¯ä»€ä¹ˆï¼Ÿ partial æ˜¯ Python å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒå·¥å…·ä¹‹ä¸€ï¼š\nfrom functools import partial å®ƒçš„ä½œç”¨æ˜¯ï¼š\né¢„å…ˆä¸ºä¸€ä¸ªå‡½æ•°ç»‘å®šéƒ¨åˆ†å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚\nè¿™å« åå‡½æ•°ï¼ˆpartial functionï¼‰ã€‚\nğŸŸ© 2. æœ€ç®€å•ç¤ºä¾‹ï¼ˆç«‹å³ç†è§£ï¼‰ from functools import partial def power(base, exponent): return base ** exponent square = partial(power, exponent=2) cube = partial(power, exponent=3) print(square(5)) # 25 print(cube(5)) # 125 squareã€cube éƒ½æ˜¯ partial ç”Ÿæˆçš„æ–°å‡½æ•°ã€‚ å®ƒä»¬å·²ç»ç»‘å®šå¥½äº† exponent å‚æ•°ã€‚ ğŸŸ¦ 3. partial èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ â­ ä½œç”¨æ€»ç»“\nç»™å‡½æ•°é¢„å¡«é»˜è®¤å‚æ•° å‡½æ•°å®šåˆ¶åŒ– æ–¹ä¾¿å‡½æ•°ä½œä¸ºå›è°ƒä¼ é€’ ç”¨äº map/filter/reduce æ›´ä¼˜é›… ç”¨äº asyncio / thread pool æ›´æ–¹ä¾¿ è®©ä»£ç æ›´çŸ­ã€æ›´å¯è¯» ğŸŸ§ 4. çœŸå®åœºæ™¯ç¤ºä¾‹ï¼ˆæ›´å®ç”¨ï¼‰ åœºæ™¯ 1ï¼šrequests å¸¦é»˜è®¤ headers import requests from functools import partial get_json = partial(requests.get, headers={ \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0\u0026#34; }) resp = get_json(\u0026#34;https://api.example.com/data\u0026#34;) print(resp.json()) ä»¥åä¸éœ€è¦æ¯æ¬¡éƒ½å†™ headersã€‚\nåœºæ™¯ 2ï¼šlog å°è£… from functools import partial from loguru import logger info = partial(logger.log, \u0026#34;INFO\u0026#34;) debug = partial(logger.log, \u0026#34;DEBUG\u0026#34;) info(\u0026#34;ç¨‹åºå¼€å§‹\u0026#34;) debug(\u0026#34;å˜é‡ x=10\u0026#34;) åœºæ™¯ 3ï¼šæ–‡ä»¶è¯»å†™å¸¦é»˜è®¤ç¼–ç ï¼ˆå¸¸ç”¨ï¼ï¼‰ open_utf8 = partial(open, encoding=\u0026#34;utf-8\u0026#34;) with open_utf8(\u0026#34;text.txt\u0026#34;) as f: print(f.read()) æ¯”æ¯æ¬¡å†™ open(..., encoding=\u0026quot;utf-8\u0026quot;) æ›´ä¼˜é›…ã€‚\nåœºæ™¯ 4ï¼šfunctools.partial ä¸ map ç»“åˆ def multiply(a, b): return a * b double = partial(multiply, 2) print(list(map(double, [1, 2, 3]))) è¾“å‡ºï¼š\n[2, 4, 6] åœºæ™¯ 5ï¼šå›è°ƒå‡½æ•°ï¼ˆå¦‚ Tkinterã€GUIï¼‰ button_click = partial(on_click, id=123) GUI äº‹ä»¶å›è°ƒåªèƒ½æ”¾ä¸€ä¸ªå‡½æ•°å‚æ•°ï¼Œpartial å¾ˆå¥½ç”¨ã€‚\nåœºæ™¯ 6ï¼šå¤šçº¿ç¨‹ pool æ›´æ–¹ä¾¿ from concurrent.futures import ThreadPoolExecutor from functools import partial def download(url, folder): ... download_to_tmp = partial(download, folder=\u0026#34;/tmp\u0026#34;) with ThreadPoolExecutor() as p: p.map(download_to_tmp, urls) é¿å… lambdaï¼Œä»£ç æ›´æ¸…æ™°ã€‚\nğŸŸ© 5. partial çš„å®Œæ•´è¯­æ³• partial(func, *args, **kwargs) å…³é”®ç‚¹ï¼š\nargs ä¼šå¡«åˆ°å·¦è¾¹çš„å‚æ•° kwargs ä¼šå¡«åˆ°å‡½æ•°å¯¹åº”çš„å…³é”®å­—å‚æ•° å‰©ä½™å‚æ•°ä»å¯ä¼ å…¥ ç¤ºä¾‹ï¼š\ndef test(a, b, c): print(a, b, c) f = partial(test, 1, c=3) f(2) # a=1, b=2, c=3 ğŸ”¥ 6. é«˜çº§ç‰¹æ€§ï¼špartial è¿˜èƒ½ä¿®æ”¹å±æ€§ f = partial(pow, exponent=2) f.__name__ = \u0026#34;square\u0026#34; ğŸŸ¦ 7. partial ä¸ lambda çš„å¯¹æ¯” | åŠŸèƒ½ | partial | lambda | | å¯è¯»æ€§ | â­â­â­â­â­ | â­â­ | | æ€§èƒ½ | â­â­â­â­ | â­â­â­ | | å¯è°ƒè¯•æ€§ | â­â­â­â­â­ | â­ | | ä»£ç ç®€æ´ | â­â­â­â­â­ | â­â­â­ | | æ”¯æŒç»‘å®šå‚æ•° | âœ… | âœ… | | æ”¯æŒç»‘å®šå…³é”®å­—å‚æ•° | âœ… | âœ… | | é€‚åˆå›è°ƒ | âœ… | âš ï¸ ä¸€èˆ¬ |\npartial æ¨èä¼˜å…ˆä½¿ç”¨ã€‚\nğŸŸ§ 8. æ„é€ åå‡½æ•°ï¼ˆå®˜æ–¹ä¾‹å­ï¼‰ from functools import partial basetwo = partial(int, base=2) print(basetwo(\u0026#39;10010\u0026#39;)) # 18 ğŸŸ¥ 9. partial ä¸­çš„å‚æ•°è¦†ç›–è§„åˆ™ï¼ˆå¾ˆé‡è¦ï¼‰ def func(a, b, c): print(a, b, c) f = partial(func, 1, b=2) f(c=3) # OK å¦‚æœä¼ å…¥é‡å¤å‚æ•°ï¼š\nf(b=5) # âŒ TypeError å› ä¸º b å·²ç»åœ¨ partial ä¸­ç»‘å®šè¿‡äº†ã€‚\nğŸŸ¦ 10. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆç»ˆææ€»ç»“ï¼‰ from functools import partial partial(func, *args, **kwargs) ç”¨é€”ï¼š\nå‡½æ•°é¢„ç»‘å®šå‚æ•° è®©å‡½æ•°å˜ç®€å• GUIã€å›è°ƒã€çº¿ç¨‹æ±  requestsã€openã€logger å°è£… ä¼˜åŠ¿ï¼š\nå¯è¯»æ€§æ›´é«˜ä¼˜äº lambda å‚æ•°ä¾ç„¶å¯æ‰©å±• é€‚é…æ—§ä»£ç å’Œå›è°ƒ ","description":" âœ… 1. partial æ˜¯ä»€ä¹ˆï¼Ÿ partial æ˜¯ Python å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒå·¥å…·ä¹‹ä¸€ï¼š\nfrom functools import partial å®ƒçš„ä½œç”¨æ˜¯ï¼š\né¢„å…ˆä¸ºä¸€ä¸ªå‡½æ•°ç»‘å®šéƒ¨åˆ†å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚\nè¿™å« åå‡½æ•°ï¼ˆpartial functionï¼‰ã€‚\nğŸŸ© 2. æœ€ç®€å•ç¤ºä¾‹ï¼ˆç«‹å³ç†è§£ï¼‰ from functools import partial def power(base, exponent): return base ** exponent square = partial(power, exponent=2) cube = partial(power, exponent=3) print(square(5)) # 25 print(cube(5)) # 125 squareã€cube éƒ½æ˜¯ partial ç”Ÿæˆçš„æ–°å‡½æ•°ã€‚ å®ƒä»¬å·²ç»ç»‘å®šå¥½äº† exponent å‚æ•°ã€‚ ğŸŸ¦ 3. partial èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ â­ ä½œç”¨æ€»ç»“\n"},{"id":220,"href":"/backend/python/official/functools-partialmethod/","title":"Functools -- partialmethod","parent":"Official","content":" âœ… 1. partialmethod æ˜¯ä»€ä¹ˆï¼Ÿ partialmethod ä¸“é—¨ç”¨äº ç±»ä¸­çš„æ–¹æ³•ï¼Œå®ƒç”¨äºï¼š\né¢„å…ˆç»‘å®šæ–¹æ³•çš„ä¸€éƒ¨åˆ†å‚æ•°ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ class methodã€‚\nç±»ä¼¼äº partialï¼ˆåå‡½æ•°ï¼‰ï¼Œä½†ï¼š\nâ­ partial ç”¨äºå‡½æ•°\nâ­ partialmethod ç”¨äºç±»çš„æ–¹æ³•\nğŸŸ¦ 2. æœ€ç®€å•ç¤ºä¾‹ï¼ˆç«‹å³ç†è§£ï¼‰ from functools import partialmethod class Logger: def log(self, level, msg): print(f\u0026#34;[{level}] {msg}\u0026#34;) info = partialmethod(log, \u0026#34;INFO\u0026#34;) error = partialmethod(log, \u0026#34;ERROR\u0026#34;) l = Logger() l.info(\u0026#34;å¯åŠ¨å®Œæˆ\u0026#34;) l.error(\u0026#34;å‡ºé”™äº†\u0026#34;) è¾“å‡ºï¼š\n[INFO] å¯åŠ¨å®Œæˆ [ERROR] å‡ºé”™äº† ğŸ‘‰ info() å’Œ error() å®é™…ä¸Šæ˜¯ log() ç»‘å®šå‚æ•°åçš„æ–¹æ³•ã€‚\nğŸŸ© 3. ä¸ºä»€ä¹ˆéœ€è¦ partialmethodï¼Ÿ å¦‚æœä¸€ä¸ªç±»ä¸­ï¼š\næŸäº›æ–¹æ³•å‚æ•°å‡ ä¹ä¸€æ · éœ€è¦æ ¹æ®ä¸åŒæ¨¡å¼å®šåˆ¶æ–¹æ³• éœ€è¦å‡å°‘é‡å¤ä»£ç  ç±»å†…å¤§é‡â€œæ¨¡æ¿æ–¹æ³•â€ æƒ³ä¼˜é›…å¤ç”¨æ–¹æ³•é€»è¾‘ partialmethod èƒ½è®©ä»£ç æ›´ç®€æ´ã€‚\nğŸŸ§ 4. å†…éƒ¨åŸç†ï¼ˆé‡è¦ï¼‰ partialmethod(func, *pre_args, **pre_kwargs) ä¼šï¼š\nç”Ÿæˆä¸€ä¸ªæ–¹æ³•å¯¹è±¡ (callable) è°ƒç”¨æ—¶è‡ªåŠ¨æŠŠé¢„è®¾å‚æ•°åº”ç”¨åœ¨ åé¢å®é™…è°ƒç”¨çš„æ–¹æ³•ä¸­ self ä¼šè¢«è‡ªåŠ¨ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•° ä¾‹å¦‚ï¼š\ninfo = partialmethod(log, \u0026#34;INFO\u0026#34;) å®é™…ä¸Šç›¸å½“äºï¼š\ndef info(self, msg): return self.log(\u0026#34;INFO\u0026#34;, msg) ğŸŸ¦ 5. å¯¹æ¯” partial \u0026amp; partialmethod | åŠŸèƒ½ | partial | partialmethod | | ç”¨äºæ™®é€šå‡½æ•° | âœ… | âŒ | | ç”¨äºç±»æ–¹æ³• | âš ï¸ å¯ç”¨ä½†ä¸ä¼˜é›… | âœ… ä¸“é—¨è®¾è®¡ | | è‡ªåŠ¨ç»‘å®š self | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç† | âœ… è‡ªåŠ¨ç»‘å®š self | | è¯­æ³•å¯è¯»æ€§ | ä¸€èˆ¬ | æ›´æ¸…æ™° | | å¸¸ç”¨åœºæ™¯ | map / callbacks | ç±»ä¸­åˆ›å»ºå®šåˆ¶æ–¹æ³• |\npartial + ç±»ï¼š\nclass A: m = partial(f, x) âš ï¸ è¿™ç§æ–¹å¼ self ä¸ä¼šè‡ªåŠ¨ä¼ å…¥ï¼Œä¼šå‡ºé”™ã€‚\nğŸŸ§ 6. partialmethod çš„å®æˆ˜åœºæ™¯ ä¸‹é¢æ˜¯æœ€å¸¸è§çš„å·¥ç¨‹ç”¨æ³•ï¼š\nåœºæ™¯ 1ï¼šæ—¥å¿—ç±»ï¼ˆä½ å¯èƒ½åœ¨é¡¹ç›®ä¸­ç›´æ¥ç”¨åˆ°ï¼‰ class Log: def log(self, level, msg): print(f\u0026#34;[{level}] {msg}\u0026#34;) info = partialmethod(log, \u0026#34;INFO\u0026#34;) debug = partialmethod(log, \u0026#34;DEBUG\u0026#34;) error = partialmethod(log, \u0026#34;ERROR\u0026#34;) é¿å…å†™é‡å¤ä»£ç ï¼š\nlog.error(\u0026#34;æ•°æ®åº“è¿æ¥å¤±è´¥\u0026#34;) åœºæ™¯ 2ï¼šçŠ¶æ€æœº class FSM: def transition(self, event, *args): print(f\u0026#34;è½¬ç§»çŠ¶æ€: {event}, args={args}\u0026#34;) start = partialmethod(transition, \u0026#34;start\u0026#34;) stop = partialmethod(transition, \u0026#34;stop\u0026#34;) reset = partialmethod(transition, \u0026#34;reset\u0026#34;) åœºæ™¯ 3ï¼šHTTP å®¢æˆ·ç«¯å°è£… class APIClient: def request(self, method, path, **kwargs): print(f\u0026#34;{method} {path}\u0026#34;, kwargs) get = partialmethod(request, \u0026#34;GET\u0026#34;) post = partialmethod(request, \u0026#34;POST\u0026#34;) put = partialmethod(request, \u0026#34;PUT\u0026#34;) ä½¿ç”¨ï¼š\napi = APIClient() api.get(\u0026#34;/users\u0026#34;) api.post(\u0026#34;/users\u0026#34;, json={\u0026#34;a\u0026#34;: 1}) åœºæ™¯ 4ï¼šSQL æ“ä½œç±» class DB: def query(self, table, where=None): ... query_users = partialmethod(query, \u0026#34;users\u0026#34;) query_logs = partialmethod(query, \u0026#34;logs\u0026#34;) ğŸŸ© 7. partialmethod å®Œæ•´è¯­æ³• partialmethod(func, /, *args, **kwargs) args -\u0026gt; å›ºå®šä½ç½®å‚æ•° kwargs -\u0026gt; å›ºå®šå…³é”®å­—å‚æ•° self åœ¨è°ƒç”¨æ—¶è‡ªåŠ¨æ³¨å…¥ ğŸŸ¥ 8. æ·±å…¥ç¤ºä¾‹ï¼šå¤šå‚æ•°ç»‘å®š class Calculator: def calc(self, x, y, op): if op == \u0026#34;+\u0026#34;: return x + y else: return x - y add = partialmethod(calc, op=\u0026#34;+\u0026#34;) sub = partialmethod(calc, op=\u0026#34;-\u0026#34;) c = Calculator() print(c.add(1, 2)) # 3 print(c.sub(5, 3)) # 2 ğŸŸ¦ 9. partialmethod å¯ä»¥å åŠ ä½¿ç”¨ debug_info = partialmethod(Logger.info, \u0026#34;[DEBUG]\u0026#34;) ğŸŸª 10. æ³¨æ„äº‹é¡¹ï¼ˆéå¸¸å…³é”®ï¼‰ âŒ ä¸èƒ½ç”¨äº staticmethod / classmethod ä¸Š\nä¾‹å¦‚ï¼š\nclass A: @staticmethod def f(x): pass g = partialmethod(f, 1) # âŒ ä¸èƒ½è¿™æ ·ç”¨ partialmethod éœ€è¦â€œç»‘å®š selfâ€ã€‚\nâœ… è¦ç»‘å®šç±»æ–¹æ³•ï¼Œå¿…é¡»ä¿æŒç›®æ ‡æ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ã€‚\nğŸŸ© 11. ä¸€å±é€ŸæŸ¥è¡¨ from functools import partialmethod class C: def func(self, x, y): ... f = partialmethod(func, 100) # ç­‰æ•ˆäº func(self, 100, y) ç”¨é€”ï¼š\nåˆ›å»ºå¤šä¸ªå‚æ•°ç•¥æœ‰ä¸åŒçš„æ–¹æ³• æ—¥å¿—ç³»ç»Ÿ HTTP Client çŠ¶æ€æœº ORM å°è£… ä¼˜ç‚¹ï¼š\nè‡ªåŠ¨ä¼  self å¯è¯»æ€§å¼º ä»£ç å¤ç”¨ç‡é«˜ ","description":" âœ… 1. partialmethod æ˜¯ä»€ä¹ˆï¼Ÿ partialmethod ä¸“é—¨ç”¨äº ç±»ä¸­çš„æ–¹æ³•ï¼Œå®ƒç”¨äºï¼š\né¢„å…ˆç»‘å®šæ–¹æ³•çš„ä¸€éƒ¨åˆ†å‚æ•°ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ class methodã€‚\nç±»ä¼¼äº partialï¼ˆåå‡½æ•°ï¼‰ï¼Œä½†ï¼š\nâ­ partial ç”¨äºå‡½æ•°\nâ­ partialmethod ç”¨äºç±»çš„æ–¹æ³•\nğŸŸ¦ 2. æœ€ç®€å•ç¤ºä¾‹ï¼ˆç«‹å³ç†è§£ï¼‰ from functools import partialmethod class Logger: def log(self, level, msg): print(f\u0026#34;[{level}] {msg}\u0026#34;) info = partialmethod(log, \u0026#34;INFO\u0026#34;) error = partialmethod(log, \u0026#34;ERROR\u0026#34;) l = Logger() l.info(\u0026#34;å¯åŠ¨å®Œæˆ\u0026#34;) l.error(\u0026#34;å‡ºé”™äº†\u0026#34;) è¾“å‡ºï¼š\n"},{"id":221,"href":"/backend/python/official/functools-reduce/","title":"Functools -- reduce","parent":"Official","content":" âœ… reduce() â€”â€” æ ¸å¿ƒæ¦‚å¿µ reduce æŠŠä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ç¼©å‡ä¸ºå•ä¸ªå€¼ã€‚\nè¿‡ç¨‹ï¼š\nvalue = func( func( func( initial, x1 ), x2 ), x3 ) ... ä½¿ç”¨æ–¹å¼ï¼š\nfrom functools import reduce reduce(function, iterable, initializer) function(a, b)ï¼šæŠŠä¸¤ä¸ªå€¼åˆå¹¶æˆä¸€ä¸ª initializer å¯é€‰ï¼šåˆå§‹å€¼ ğŸŒ° 1. æœ€ç»å…¸ç¤ºä¾‹ï¼šç´¯åŠ  from functools import reduce nums = [1, 2, 3, 4] result = reduce(lambda a, b: a + b, nums) print(result) # 10 ç­‰ä»·äºï¼š\n(((1 + 2) + 3) + 4) ğŸŒ° 2. ç´¯ä¹˜ from functools import reduce nums = [1, 2, 3, 4] result = reduce(lambda a, b: a * b, nums) print(result) # 24 ğŸŒ° 3. å¸¦ initializerï¼ˆåˆå§‹å€¼ï¼‰ result = reduce(lambda a, b: a + b, [1, 2, 3], 10) print(result) # åˆå§‹å€¼ 10 -\u0026gt; 10 + 1 + 2 + 3 = 16 ğŸŒ° 4. æ±‚æœ€å¤§å€¼ / æœ€å°å€¼ result = reduce(lambda a, b: a if a \u0026gt; b else b, [3, 9, 1, 7]) print(result) # 9 ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ maxï¼‰\nğŸŒ° 5. å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆä¸æ¨èï¼Œä½†èƒ½ç”¨ï¼‰ words = [\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;, \u0026#34;python\u0026#34;] result = reduce(lambda a, b: a + \u0026#34; \u0026#34; + b, words) print(result) # hello world python æ¨èç”¨ \u0026quot; \u0026ldquo;.join(words)ã€‚\nğŸŒ° 6. reduce ç”¨äºå­—å…¸ä¸­çš„è®¡ç®—ï¼ˆå¸¸ç”¨ï¼‰ ä¾‹å¦‚ï¼šæ±‡æ€» stock æ•°æ®ï¼š\nstocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;amount\u0026#34;: 100}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;amount\u0026#34;: 40}, {\u0026#34;code\u0026#34;: \u0026#34;600003\u0026#34;, \u0026#34;amount\u0026#34;: 60}, ] total = reduce(lambda a, b: a + b[\u0026#34;amount\u0026#34;], stocks, 0) print(total) # 200 ğŸŒ° 7. reduce å®ç° flattenï¼ˆæ‰å¹³åŒ–åˆ—è¡¨ï¼‰ nested = [[1, 2], [3, 4], [5, 6]] flat = reduce(lambda a, b: a + b, nested) print(flat) # [1, 2, 3, 4, 5, 6] ğŸŒ° 8. reduce å®ç°æ•°å­—ç´¯åŠ å™¨ï¼ˆç§¯ç´¯çŠ¶æ€ï¼‰ reduce å¯ä»¥åšçŠ¶æ€æœºã€ç´¯è®¡å™¨è¿™ç±»ä»»åŠ¡ï¼š\nnums = [1, 2, 3, 4] result = reduce(lambda s, x: {\u0026#34;sum\u0026#34;: s[\u0026#34;sum\u0026#34;] + x}, nums, {\u0026#34;sum\u0026#34;: 0}) print(result) # {\u0026#39;sum\u0026#39;: 10} ğŸŒ° 9. reduce å®ç°æœ€å¤§è‚¡ç¥¨æ¶¨å¹…ï¼ˆçœŸå®ä¸šåŠ¡ç¤ºä¾‹ï¼‰ stocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;change\u0026#34;: 5.3}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;change\u0026#34;: -2.1}, {\u0026#34;code\u0026#34;: \u0026#34;600003\u0026#34;, \u0026#34;change\u0026#34;: 8.6}, ] max_stock = reduce( lambda a, b: a if a[\u0026#34;change\u0026#34;] \u0026gt; b[\u0026#34;change\u0026#34;] else b, stocks ) print(max_stock) # {\u0026#39;code\u0026#39;: \u0026#39;600003\u0026#39;, \u0026#39;change\u0026#39;: 8.6} ğŸŒŸ reduce vs sum / max / min / join â€”â€” ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ åœºæ™¯ æœ€ä½³å·¥å…· ç´¯åŠ æ•°å­— sum() æ‰¾æœ€å¤§/æœ€å° max() / min() æ‹¼æ¥å­—ç¬¦ä¸² \u0026ldquo;\u0026quot;.join() è‡ªå®šä¹‰ç´¯è®¡æ“ä½œ reduce âœ…ï¸ å¤æ‚åˆå¹¶ã€å¸¦çŠ¶æ€ã€éå¯¹ç§°ç»“æ„ reduce âœ…ï¸ ä½ çœŸæ­£éœ€è¦ reduce çš„æƒ…å†µæ˜¯ï¼š\nä½ æ­£åœ¨â€œé€æ­¥æŠ˜å ä¸€ä¸ªåºåˆ—â€ ä½ éœ€è¦â€œçŠ¶æ€åœ¨å‰ä¸€æ¬¡ç»“æœåŸºç¡€ä¸Šç´¯åŠ â€ ä½ éœ€è¦è‡ªå®šä¹‰ç»„åˆé€»è¾‘ ğŸ¯ æ€»ç»“ reduce = æŠŠåºåˆ—å‹ç¼©æˆä¸€ä¸ªå€¼ï¼Œç”¨å‰ä¸€æ¬¡ç»“æœ + å½“å‰å€¼ä¸æ–­æŠ˜å ã€‚\n","description":" âœ… reduce() â€”â€” æ ¸å¿ƒæ¦‚å¿µ reduce æŠŠä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ç¼©å‡ä¸ºå•ä¸ªå€¼ã€‚\nè¿‡ç¨‹ï¼š\nvalue = func( func( func( initial, x1 ), x2 ), x3 ) ... ä½¿ç”¨æ–¹å¼ï¼š\nfrom functools import reduce reduce(function, iterable, initializer) function(a, b)ï¼šæŠŠä¸¤ä¸ªå€¼åˆå¹¶æˆä¸€ä¸ª initializer å¯é€‰ï¼šåˆå§‹å€¼ ğŸŒ° 1. æœ€ç»å…¸ç¤ºä¾‹ï¼šç´¯åŠ  from functools import reduce nums = [1, 2, 3, 4] result = reduce(lambda a, b: a + b, nums) print(result) # 10 ç­‰ä»·äºï¼š\n(((1 + 2) + 3) + 4) ğŸŒ° 2. ç´¯ä¹˜ from functools import reduce nums = [1, 2, 3, 4] result = reduce(lambda a, b: a * b, nums) print(result) # 24 ğŸŒ° 3. å¸¦ initializerï¼ˆåˆå§‹å€¼ï¼‰ result = reduce(lambda a, b: a + b, [1, 2, 3], 10) print(result) # åˆå§‹å€¼ 10 -\u0026gt; 10 + 1 + 2 + 3 = 16 ğŸŒ° 4. æ±‚æœ€å¤§å€¼ / æœ€å°å€¼ result = reduce(lambda a, b: a if a \u0026gt; b else b, [3, 9, 1, 7]) print(result) # 9 ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ maxï¼‰\n"},{"id":222,"href":"/backend/python/official/functools-singledispatch/","title":"Functools -- singledispatch","parent":"Official","content":" âœ… 1. singledispatch æ˜¯ä»€ä¹ˆï¼Ÿ Python ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼ˆåŒåå‡½æ•°ä¸åŒå‚æ•°ç±»å‹ï¼‰ã€‚\nä½† functools.singledispatch è®©ä½ å¯ä»¥æŒ‰ç…§â€œå‚æ•°ç±»å‹â€è‡ªåŠ¨åˆ†å‘åˆ°ä¸åŒå‡½æ•°ã€‚\nç±»ä¼¼ Java/C++ çš„å‡½æ•°é‡è½½ ä½†åŸºäºâ€œå‚æ•°ç±»å‹â€è¿›è¡Œåˆ†å‘ æ‰©å±•æ€§éå¸¸å¼ºï¼ˆç‰¹åˆ«é€‚åˆæ’ä»¶ç³»ç»Ÿï¼‰ ç”¨æ³•ï¼š\nfrom functools import singledispatch ğŸŸ¦ 2. æœ€å°ç¤ºä¾‹ï¼ˆç«‹åˆ»ç†è§£ï¼‰ from functools import singledispatch @singledispatch def process(value): raise NotImplementedError(f\u0026#34;ä¸æ”¯æŒç±»å‹: {type(value)}\u0026#34;) @process.register def _(value: int): return f\u0026#34;æ•´æ•°ï¼š{value}\u0026#34; @process.register def _(value: str): return f\u0026#34;å­—ç¬¦ä¸²ï¼š{value}\u0026#34; print(process(10)) print(process(\u0026#34;hello\u0026#34;)) è¾“å‡ºï¼š\næ•´æ•°ï¼š10 å­—ç¬¦ä¸²ï¼šhello ğŸ‘‰ åŒä¸€ä¸ªå‡½æ•°å processï¼Œæ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹è‡ªåŠ¨è°ƒç”¨ä¸åŒå‡½æ•°\nğŸŸ© 3. ä½¿ç”¨åœºæ™¯ï¼ˆéå¸¸é‡è¦ï¼‰ 1. ä¸åŒè¾“å…¥ç±»å‹éœ€è¦ä¸åŒå¤„ç†é€»è¾‘ï¼ˆæœ€å¸¸ç”¨ï¼‰ dict / list / str / int éœ€è¦ä¸åŒè§£ææ–¹å¼ JSON è½¬æ¢ æ•°æ®æ ¼å¼åŒ– æ ¹æ®è‚¡ç¥¨æ•°æ®ä¸åŒæ ¼å¼åšä¸åŒå¤„ç† 2. å°è£…é€šç”¨æ¥å£ï¼ˆä½ å¯ä»¥ç›´æ¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ï¼‰ process(obj) è°ƒç”¨è€…æ— éœ€å…³æ³¨ obj çš„ç±»å‹ã€‚\n3. æ¡†æ¶ / æ’ä»¶å¼è®¾è®¡ï¼ˆéå¸¸å¼ºå¤§ï¼‰ ä¸åŒæ¨¡å—å¯ä»¥ä½¿ç”¨ï¼š\n@process.register æ¥æ‰©å±•åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä¸»å‡½æ•°ã€‚\nğŸŸ¦ 4. å¤æ‚ç¤ºä¾‹ï¼šåºåˆ—åŒ–å™¨ï¼ˆserializerï¼‰ @singledispatch def serialize(obj): raise TypeError(f\u0026#34;ä¸èƒ½åºåˆ—åŒ–ç±»å‹ï¼š{type(obj)}\u0026#34;) @serialize.register def _(obj: int): return str(obj) @serialize.register def _(obj: str): return obj @serialize.register def _(obj: list): return \u0026#34;[\u0026#34; + \u0026#34;, \u0026#34;.join(serialize(i)) + \u0026#34;]\u0026#34; @serialize.register def _(obj: dict): return \u0026#34;{\u0026#34; + \u0026#34;, \u0026#34;.join(f\u0026#34;{k}: {serialize(v)}\u0026#34; for k, v in obj.items()) + \u0026#34;}\u0026#34; ğŸŸ§ 5. ä½¿ç”¨ type æ³¨å†Œï¼ˆå…³é”®æŠ€å·§ï¼‰ @process.register(int) def _(value): return f\u0026#34;int: {value}\u0026#34; é€‚åˆæ— æ³•æ³¨è§£ç±»å‹çš„åœºæ™¯ã€‚\nğŸŸ¦ 6. é»˜è®¤å‡½æ•°ä½¿ç”¨ â€œfallbackâ€ï¼ˆå…œåº•å¤„ç†ï¼‰ @singledispatch def handle(x): print(\u0026#34;é»˜è®¤å¤„ç†: \u0026#34;, x) å¦‚æœæ²¡æœ‰åŒ¹é…ç±»å‹ï¼Œä¼šè°ƒç”¨é»˜è®¤å‡½æ•°ã€‚\nğŸŸ§ 7. å­ç±»ç»§æ‰¿è¡Œä¸º class Animal: ... class Dog(Animal): ... @handle.register(Animal) def _(x): print(\u0026#34;åŠ¨ç‰©\u0026#34;) print(handle(Dog())) è¾“å‡ºï¼š\nåŠ¨ç‰© ğŸ‘‰ å¦‚æœç±»å‹æœªæ³¨å†Œï¼Œä¼šå‘ä¸ŠæŸ¥æ‰¾çˆ¶ç±»ç±»å‹ã€‚\nğŸŸ¥ 8. ä»…æ ¹æ®ç¬¬ 1 ä¸ªå‚æ•°åˆ†å‘ï¼ˆé™åˆ¶ï¼‰ singledispatch åªçœ‹ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ã€‚\nå¦‚æœä½ æƒ³åŸºäºå¤šä¸ªå‚æ•°ç±»å‹åˆ†å‘ï¼Œéœ€è¦ï¼š\nsingledispatchmethod æˆ–ç¬¬ä¸‰æ–¹åº“ multimethod / multipledispatch ğŸŸ¦ 9. Python 3.8+ çš„ singledispatchmethodï¼ˆæ–¹æ³•ç‰ˆï¼‰ ç”¨äºç±»çš„æ–¹æ³•ï¼š\nfrom functools import singledispatchmethod class Processor: @singledispatchmethod def process(self, value): raise NotImplementedError() @process.register def _(self, value: int): return f\u0026#34;int: {value}\u0026#34; @process.register def _(self, value: str): return f\u0026#34;str: {value}\u0026#34; p = Processor() print(p.process(10)) print(p.process(\u0026#34;abc\u0026#34;)) ğŸŸª 10. å’Œ match-case å¯¹æ¯” åŠŸèƒ½ singledispatch match-case åŸºäºç±»å‹åˆ†å‘ âœ… âœ… å¯æ‰©å±•æ€§å¼º âœ… âŒ æ’ä»¶å¼æ‰©å±• âœ… âŒ æ”¯æŒå¤æ‚é€»è¾‘ âœ… âœ… é€‚åˆæ¡†æ¶ âœ… âŒ singledispatch æ›´é€‚åˆæ„å»ºæ‰©å±•æ€§çš„ç³»ç»Ÿã€‚\nğŸŸ¦ 11. æ€§èƒ½æ³¨æ„äº‹é¡¹ ç¬¬ä¸€æ¬¡è°ƒç”¨æŸç±»å‹ä¼šè¿›è¡Œæ³¨å†Œå’Œç¼“å­˜\nåç»­è°ƒç”¨æ˜¯ O(1) æŸ¥æ‰¾ï¼Œéå¸¸å¿«ã€‚\nğŸŸ© 12. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆç»ˆææ€»ç»“ï¼‰ from functools import singledispatch @singledispatch def func(x): ... @func.register def _(x: int): ... @func.register def _(x: str): ... func(10) # è°ƒç”¨ int ç‰ˆ func(\u0026#34;hello\u0026#34;) # è°ƒç”¨ str ç‰ˆ ç‰¹ç‚¹ï¼š\næŒ‰ç±»å‹è‡ªåŠ¨åˆ†å‘ å¯æ‰©å±• æ’ä»¶å¼è®¾è®¡æœ€ä½³ ä»…æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°å†³å®š æ”¯æŒç»§æ‰¿é“¾æŸ¥æ‰¾ æ”¯æŒæ–¹æ³•ç‰ˆï¼šsingledispatchmethod ","description":" âœ… 1. singledispatch æ˜¯ä»€ä¹ˆï¼Ÿ Python ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼ˆåŒåå‡½æ•°ä¸åŒå‚æ•°ç±»å‹ï¼‰ã€‚\nä½† functools.singledispatch è®©ä½ å¯ä»¥æŒ‰ç…§â€œå‚æ•°ç±»å‹â€è‡ªåŠ¨åˆ†å‘åˆ°ä¸åŒå‡½æ•°ã€‚\nç±»ä¼¼ Java/C++ çš„å‡½æ•°é‡è½½ ä½†åŸºäºâ€œå‚æ•°ç±»å‹â€è¿›è¡Œåˆ†å‘ æ‰©å±•æ€§éå¸¸å¼ºï¼ˆç‰¹åˆ«é€‚åˆæ’ä»¶ç³»ç»Ÿï¼‰ ç”¨æ³•ï¼š\nfrom functools import singledispatch ğŸŸ¦ 2. æœ€å°ç¤ºä¾‹ï¼ˆç«‹åˆ»ç†è§£ï¼‰ from functools import singledispatch @singledispatch def process(value): raise NotImplementedError(f\u0026#34;ä¸æ”¯æŒç±»å‹: {type(value)}\u0026#34;) @process.register def _(value: int): return f\u0026#34;æ•´æ•°ï¼š{value}\u0026#34; @process.register def _(value: str): return f\u0026#34;å­—ç¬¦ä¸²ï¼š{value}\u0026#34; print(process(10)) print(process(\u0026#34;hello\u0026#34;)) è¾“å‡ºï¼š\n"},{"id":223,"href":"/backend/python/official/functools-singledispatchmethod/","title":"Functools -- singledispatchmethod","parent":"Official","content":" âœ… 1. singledispatchmethod æ˜¯ä»€ä¹ˆï¼Ÿ å®ƒæ˜¯ singledispatch çš„ ç±»æ–¹æ³•ç‰ˆæœ¬ã€‚\nfrom functools import singledispatchmethod åŠŸèƒ½ï¼š\næ ¹æ®â€œæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼ˆé™¤ self å¤–ï¼‰â€è‡ªåŠ¨åˆ†å‘åˆ°ä¸åŒæ–¹æ³• å®ç°â€œé¢å‘å¯¹è±¡ç‰ˆå‡½æ•°é‡è½½â€ è®©ç±»çš„æ–¹æ³•æ ¹æ®è¾“å…¥ç±»å‹è‡ªåŠ¨é€‰æ‹©å®ç° ğŸŸ© 2. æœ€å°ç¤ºä¾‹ï¼ˆç«‹åˆ»ç†è§£ï¼‰ from functools import singledispatchmethod class Processor: @singledispatchmethod def process(self, value): raise NotImplementedError(f\u0026#34;ä¸æ”¯æŒç±»å‹: {type(value)}\u0026#34;) @process.register def _(self, value: int): return f\u0026#34;å¤„ç†æ•´æ•°ï¼š{value}\u0026#34; @process.register def _(self, value: str): return f\u0026#34;å¤„ç†å­—ç¬¦ä¸²ï¼š{value}\u0026#34; p = Processor() print(p.process(10)) print(p.process(\u0026#34;abc\u0026#34;)) è¾“å‡ºï¼š\nå¤„ç†æ•´æ•°ï¼š10 å¤„ç†å­—ç¬¦ä¸²ï¼šabc ğŸ‘‰ æ ¹æ® value çš„ç±»å‹è‡ªåŠ¨é€‰æ‹©ä¸åŒæ–¹æ³•ã€‚\nğŸŸ¦ 3. ä½¿ç”¨åœºæ™¯ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ 3.1 æ ¹æ®â€œæ•°æ®ç±»å‹â€é€‰æ‹©ä¸åŒå¤„ç†æµç¨‹ï¼ˆæœ€å¸¸ç”¨ï¼‰ ä½ æœ‰ï¼š\ndict list str bytes pandas.DataFrame pydantic.BaseModel å‡½æ•°å¯ä»¥è‡ªåŠ¨åˆ†å‘åˆ°å¯¹åº”å¤„ç†é€»è¾‘ã€‚\n3.2 API è¾“å…¥æ ¼å¼å¤šç§å¤šæ ·ï¼ˆFastAPI / CLI æœ€é€‚ç”¨ï¼‰ ä¸€ä¸ªç±»å¤„ç†å¤šç§æ•°æ®ï¼š\np.process(str_data) p.process(json_dict) p.process(pandas_dataframe) éå¸¸é€‚åˆä½ åšçš„æ•°æ®åŒæ­¥ã€è‚¡ç¥¨æ•°æ®å¤„ç†æ¡†æ¶ã€‚\n3.3 æ’ä»¶ç³»ç»Ÿï¼ˆå¯ä»¥ç¬¬ä¸‰æ–¹æ‰©å±•ï¼‰ ä¸åŒçš„æ¨¡å—å¯ä»¥æ³¨å†Œæ–°çš„ç±»å‹å¤„ç†å™¨ï¼š\n@processor.process.register def _(self, value: MyCustomType): ... æ— éœ€ä¿®æ”¹ä¸»ç±»ã€‚\n3.4 å¤æ‚çš„é€»è¾‘æ‹†åˆ†ï¼ˆæ›¿ä»£ if/elif/elseï¼‰ é¿å…å‡ åè¡Œçš„ï¼š\nif isinstance(x, dict): elif isinstance(x, list): elif isinstance(x, str): ... ä½¿ç”¨ singledispatchmethod æ›´ä¼˜é›…ã€‚\nğŸŸ© 4. ä¾‹å­ï¼šå¤šæ ¼å¼çš„æ•°æ®åŠ è½½å™¨ class Loader: @singledispatchmethod def load(self, data): raise TypeError(\u0026#34;ä¸æ”¯æŒçš„ç±»å‹\u0026#34;) @load.register def _(self, data: str): return f\u0026#34;åŠ è½½å­—ç¬¦ä¸²: {data}\u0026#34; @load.register def _(self, data: list): return f\u0026#34;åŠ è½½åˆ—è¡¨: {data}\u0026#34; @load.register def _(self, data: dict): return f\u0026#34;åŠ è½½å­—å…¸: {data}\u0026#34; ğŸŸ§ 5. ä½¿ç”¨ç±»å‹æ³¨å†Œï¼ˆä¸å†™ç±»å‹æ³¨è§£ï¼‰ class Handler: @singledispatchmethod def handle(self, value): ... @handle.register(int) def _(self, value): return f\u0026#34;INT: {value}\u0026#34; é€‚åˆåŠ¨æ€åœºæ™¯ã€‚\nğŸŸ¥ 6. æ³¨æ„ï¼šåªæ ¹æ®â€œç¬¬ä¸€ä¸ªé self å‚æ•°â€åˆ†å‘ ä¾‹å¦‚ï¼š\ndef process(self, a, b): åˆ†å‘åªçœ‹ aï¼Œä¸çœ‹ bã€‚\nğŸŸ© 7. æ”¯æŒç»§æ‰¿é“¾æŸ¥æ‰¾ï¼ˆéå¸¸å¼ºå¤§ï¼‰ class Animal: pass class Dog(Animal): pass class P: @singledispatchmethod def speak(self, x): ... @speak.register def _(self, x: Animal): print(\u0026#34;Animal speak\u0026#34;) p = P() p.speak(Dog()) # Dog è‡ªåŠ¨åŒ¹é…çˆ¶ç±» Animal ğŸŸ¦ 8. ä¸ match-case çš„å¯¹æ¯” åŠŸèƒ½ singledispatchmethod match-case æŒ‰ç±»å‹åˆ†å‘ âœ… âœ… ç±»æ–¹æ³• âœ… âŒ æ’ä»¶æ‰©å±• âœ… âŒ ä½¿ç”¨ç»§æ‰¿é“¾ âœ… âŒ å¯é›†ä¸­ç®¡ç†é€»è¾‘ âœ… âœ… æ‰©å±•æ€§ â­â­â­â­â­ â­â­ singledispatchmethod æ›´é€‚åˆå¤§å‹é¡¹ç›®å’Œæ‰©å±•æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿã€‚\nğŸŸª 9. å®æˆ˜ï¼šè‚¡ç¥¨æ•°æ®è§£æå™¨ï¼ˆä½ èƒ½ç›´æ¥ç”¨ï¼‰ class StockParser: @singledispatchmethod def parse(self, data): raise TypeError(\u0026#34;ä¸æ”¯æŒçš„æ•°æ®ç±»å‹\u0026#34;) @parse.register def _(self, data: dict): return f\u0026#34;è§£æ dict: {data[\u0026#39;code\u0026#39;]}\u0026#34; @parse.register def _(self, data: str): return f\u0026#34;è§£æ JSON å­—ç¬¦ä¸²: {data}\u0026#34; @parse.register def _(self, data: list): return [self.parse(item) for item in data] ç”¨æ³•ï¼š\nparser = StockParser() parser.parse({\u0026#34;code\u0026#34;: \u0026#34;600000\u0026#34;}) parser.parse(\u0026#39;[{\u0026#34;code\u0026#34;: \u0026#34;600000\u0026#34;}]\u0026#39;) parser.parse([{\u0026#34;code\u0026#34;: \u0026#34;002594\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;600519\u0026#34;}]) ğŸŸ¦ 10. åœ¨ FastAPI ä¸­å°è£…ä¸‡èƒ½å‚æ•°å¤„ç†å™¨ class ParamParser: @singledispatchmethod def normalize(self, v): return v @normalize.register def _(self, v: str): return v.strip() @normalize.register def _(self, v: list): return [self.normalize(i) for i in v] â­ 11. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆç»ˆææ€»ç»“ï¼‰ from functools import singledispatchmethod class C: @singledispatchmethod def method(self, x): ... @method.register def _(self, x: int): ... @method.register def _(self, x: str): ... ç‰¹ç‚¹ï¼š\nç±»æ–¹æ³•è‡ªåŠ¨â€œæŒ‰ç±»å‹åˆ†å‘â€ æ‰©å±•æ€§å¼ºï¼Œå¯æ’ä»¶å¼å¼€å‘ æ›¿ä»£å¤§é‡ if-else é¦–ä¸ªé-self å‚æ•°å†³å®šåˆ†å‘ æ”¯æŒç»§æ‰¿é“¾æŸ¥æ‰¾ ","description":" âœ… 1. singledispatchmethod æ˜¯ä»€ä¹ˆï¼Ÿ å®ƒæ˜¯ singledispatch çš„ ç±»æ–¹æ³•ç‰ˆæœ¬ã€‚\nfrom functools import singledispatchmethod åŠŸèƒ½ï¼š\næ ¹æ®â€œæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼ˆé™¤ self å¤–ï¼‰â€è‡ªåŠ¨åˆ†å‘åˆ°ä¸åŒæ–¹æ³• å®ç°â€œé¢å‘å¯¹è±¡ç‰ˆå‡½æ•°é‡è½½â€ è®©ç±»çš„æ–¹æ³•æ ¹æ®è¾“å…¥ç±»å‹è‡ªåŠ¨é€‰æ‹©å®ç° ğŸŸ© 2. æœ€å°ç¤ºä¾‹ï¼ˆç«‹åˆ»ç†è§£ï¼‰ from functools import singledispatchmethod class Processor: @singledispatchmethod def process(self, value): raise NotImplementedError(f\u0026#34;ä¸æ”¯æŒç±»å‹: {type(value)}\u0026#34;) @process.register def _(self, value: int): return f\u0026#34;å¤„ç†æ•´æ•°ï¼š{value}\u0026#34; @process.register def _(self, value: str): return f\u0026#34;å¤„ç†å­—ç¬¦ä¸²ï¼š{value}\u0026#34; p = Processor() print(p.process(10)) print(p.process(\u0026#34;abc\u0026#34;)) è¾“å‡ºï¼š\n"},{"id":224,"href":"/backend/python/official/functools-total_ordering/","title":"Functools -- total_ordering","parent":"Official","content":" âœ… 1. total_ordering æ˜¯ä»€ä¹ˆï¼Ÿ functools.total_ordering æ˜¯ä¸€ä¸ª ç±»è£…é¥°å™¨ã€‚\nå®ƒå¯ä»¥è®©ä½ åªå®ç° 1 ä¸ªæ¯”è¾ƒæ–¹æ³• + __eq__ï¼ŒPython è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆå‰©ä¸‹çš„æ¯”è¾ƒæ–¹æ³•ï¼š\nä½ å®ç° è‡ªåŠ¨è¡¥å…¨ __eq__ + __lt__ è‡ªåŠ¨ç”Ÿæˆ __le__, __gt__, __ge__ __eq__ + __gt__ è‡ªåŠ¨ç”Ÿæˆ __ge__, __lt__, __le__ __eq__ + __le__ è‡ªåŠ¨ç”Ÿæˆ __lt__, __gt__, __ge__ åŸæœ¬ä½ è¦å†™ 4 ä¸ªæ–¹æ³•ï¼Œ ç°åœ¨åªè¦å†™ 2 ä¸ªã€‚ ğŸŸ¦ 2. æœ€å°æ ¸å¿ƒç¤ºä¾‹\nfrom functools import total_ordering @total_ordering class User: def __init__(self, score): self.score = score def __eq__(self, other): return self.score == other.score def __lt__(self, other): return self.score \u0026lt; other.score u1 = User(10) u2 = User(20) print(u1 \u0026lt; u2) # True print(u1 \u0026lt;= u2) # Trueï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ print(u1 \u0026gt; u2) # Falseï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ print(u1 \u0026gt;= u2) # Falseï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ ğŸŸ© 3. ç”¨æ³•æ€»ç»“ï¼ˆéå¸¸ç®€å•ï¼‰ from functools import total_ordering @total_ordering class ClassName: def __eq__(self, other): ... def __lt__(self, other): ... åªéœ€ä¸¤ç‚¹ï¼š\nå¿…é¡»å®ç° __eq__\nå…¶ä»–äº”ä¸ªæ¯”è¾ƒæ–¹æ³•è‡³å°‘å®ç°ä¸€ä¸ªï¼š\n__lt__ __le__ __gt__ __ge__ Python ä¼šè‡ªåŠ¨è¡¥å…¨å‰©ä¸‹çš„ã€‚\nğŸŸ§ 4. çœŸå®å·¥ç¨‹åœºæ™¯ï¼ˆé€‚ç”¨äºä½ çš„é¡¹ç›®ï¼‰ åœºæ™¯ 1ï¼šæŒ‰ä¼˜å…ˆçº§/æƒé‡æ’åº @total_ordering class Task: def __init__(self, priority): self.priority = priority def __eq__(self, other): return self.priority == other.priority def __lt__(self, other): return self.priority \u0026lt; other.priority tasks = [Task(5), Task(1), Task(3)] tasks_sorted = sorted(tasks) # è‡ªåŠ¨ç”¨ \u0026lt; æ’åº åœºæ™¯ 2ï¼šæŒ‰æ—¶é—´æ’åºï¼ˆä½ è‚¡ç¥¨é¡¹ç›®å¸¸ç”¨ï¼‰ @total_ordering class News: def __init__(self, ts): self.ts = ts def __eq__(self, other): return self.ts == other.ts def __lt__(self, other): return self.ts \u0026lt; other.ts ä½ å°±å¯ä»¥ï¼š\nsorted_news = sorted(news_list, reverse=True) åœºæ™¯ 3ï¼šå¯¹ ORM å¯¹è±¡æ’åº ä¾‹å¦‚ä½ åœ¨ FastAPI + SQLAlchemy é¡¹ç›®ä¸­ï¼š\n@total_ordering class Stock: def __init__(self, code, pe): self.code = code self.pe = pe def __eq__(self, other): return self.pe == other.pe def __lt__(self, other): return self.pe \u0026lt; other.pe ç›´æ¥å¯¹ Query å‡ºæ¥çš„å¯¹è±¡æ’åºï¼š\nsorted(stock_list) åœºæ™¯ 4ï¼šå°è£…â€œæ’åå¯¹è±¡â€ ä½ å¯ä»¥åšä¸€ä¸ªâ€œæƒé‡å¯¹è±¡â€ï¼š\n@total_ordering class RankedItem: def __init__(self, item, weight): self.item = item self.weight = weight def __eq__(self, other): return self.weight == other.weight def __lt__(self, other): return self.weight \u0026lt; other.weight ğŸŸ¥ 5. æ³¨æ„äº‹é¡¹ï¼ˆéå¸¸é‡è¦ï¼‰ â—1. æ¯”è¾ƒæ—¶å¿…é¡»ä¿è¯åŒç±»å¯¹è±¡ å¦åˆ™ä¼šæŠ¥é”™ï¼š\nTypeError: \u0026#39;\u0026lt;\u0026#39; not supported between instances ä½ å¯ä»¥åŠ ä¿æŠ¤ï¼š\nif not isinstance(other, self.__class__): return NotImplemented â—2. __hash__ é»˜è®¤è¢«ç¦ç”¨ å¦‚æœä½ å¸Œæœ›å¯¹è±¡å¯ä½œä¸º dict keyï¼š\n@total_ordering class User: __hash__ = object.__hash__ â—3. åªé€‚ç”¨äºâ€œå¯æ’åºå¯¹è±¡â€ ä¾‹å¦‚ï¼šå…¬å¸æ–°é—»ã€è‚¡ç¥¨ã€æƒé‡ã€ä¼˜å…ˆçº§ã€æ—¶é—´æˆ³ â€”â€” éƒ½é€‚åˆã€‚\nğŸŸª 6. å®Œæ•´æœ€ä½³å®è·µæ¨¡æ¿ï¼ˆä½ å¯ä»¥ç›´æ¥ copy ç”¨ï¼‰ from functools import total_ordering @total_ordering class BaseComparable: def __eq__(self, other): if not isinstance(other, self.__class__): return NotImplemented return self.key() == other.key() def __lt__(self, other): if not isinstance(other, self.__class__): return NotImplemented return self.key() \u0026lt; other.key() def key(self): raise NotImplementedError(\u0026#34;å­ç±»å¿…é¡»å®ç° key() è¿”å›æ¯”è¾ƒä¾æ®\u0026#34;) å­ç±»åªéœ€è¦è¦†ç›–ä¸€ä¸ªæ–¹æ³•ï¼š\nclass News(BaseComparable): def __init__(self, ts): self.ts = ts def key(self): return self.ts â­ 7. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆç»ˆæç‰ˆï¼‰ total_orderingï¼šæ ¹æ®å·²å®ç°çš„æ¯”è¾ƒæ–¹æ³•è‡ªåŠ¨ç”Ÿæˆå‰©ä¸‹çš„æ¯”è¾ƒæ–¹æ³•\nå¿…é¡»å®ç°ï¼š__eq__\nè¿˜éœ€è‡³å°‘å®ç°ä¸€ä¸ªï¼š\n__lt__ __le__ __gt__ __ge__ ç„¶å Python è‡ªåŠ¨è¡¥å…¨å…¶ä½™ï¼š\u0026lt;, \u0026lt;=, \u0026gt;, \u0026gt;= å…¨éƒ¨å¯ç”¨\nå…¸å‹ç”¨æ³•ï¼š\n@total_ordering class C: def __eq__(self, other): ... def __lt__(self, other): ... ","description":" âœ… 1. total_ordering æ˜¯ä»€ä¹ˆï¼Ÿ functools.total_ordering æ˜¯ä¸€ä¸ª ç±»è£…é¥°å™¨ã€‚\nå®ƒå¯ä»¥è®©ä½ åªå®ç° 1 ä¸ªæ¯”è¾ƒæ–¹æ³• + __eq__ï¼ŒPython è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆå‰©ä¸‹çš„æ¯”è¾ƒæ–¹æ³•ï¼š\nä½ å®ç° è‡ªåŠ¨è¡¥å…¨ __eq__ + __lt__ è‡ªåŠ¨ç”Ÿæˆ __le__, __gt__, __ge__ __eq__ + __gt__ è‡ªåŠ¨ç”Ÿæˆ __ge__, __lt__, __le__ __eq__ + __le__ è‡ªåŠ¨ç”Ÿæˆ __lt__, __gt__, __ge__ åŸæœ¬ä½ è¦å†™ 4 ä¸ªæ–¹æ³•ï¼Œ ç°åœ¨åªè¦å†™ 2 ä¸ªã€‚ ğŸŸ¦ 2. æœ€å°æ ¸å¿ƒç¤ºä¾‹\nfrom functools import total_ordering @total_ordering class User: def __init__(self, score): self.score = score def __eq__(self, other): return self.score == other.score def __lt__(self, other): return self.score \u0026lt; other.score u1 = User(10) u2 = User(20) print(u1 \u0026lt; u2) # True print(u1 \u0026lt;= u2) # Trueï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ print(u1 \u0026gt; u2) # Falseï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ print(u1 \u0026gt;= u2) # Falseï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ ğŸŸ© 3. ç”¨æ³•æ€»ç»“ï¼ˆéå¸¸ç®€å•ï¼‰ from functools import total_ordering @total_ordering class ClassName: def __eq__(self, other): ... def __lt__(self, other): ... åªéœ€ä¸¤ç‚¹ï¼š\n"},{"id":225,"href":"/backend/python/official/functools-update_wrapper/","title":"Functools -- update_wrapper","parent":"Official","content":" âœ… 1. functools.update_wrapper æ˜¯ä»€ä¹ˆï¼Ÿ update_wrapper æ˜¯ç”¨äºâ€œæŠŠä¸€ä¸ªå‡½æ•°çš„å…ƒæ•°æ®å¤åˆ¶åˆ°å¦ä¸€ä¸ªå‡½æ•°â€çš„å·¥å…·ã€‚\nå°±æ˜¯ wraps() çš„åº•å±‚å®ç°å·¥å…·ã€‚\nè£…é¥°å™¨å†™æ³•ï¼š\nfrom functools import wraps å…¶å®ç­‰ä»·äºï¼š\nfrom functools import update_wrapper wraps ä¸è¿‡æ˜¯ update_wrapper çš„è¯­æ³•ç³–ã€‚\nğŸ“Œ 2. æœ€ç®€å•çš„ä¾‹å­ from functools import update_wrapper def deco(func): def wrapper(*args, **kwargs): return func(*args, **kwargs) update_wrapper(wrapper, func) return wrapper @deco def add(a, b): \u0026#34;\u0026#34;\u0026#34;åŠ æ³•å‡½æ•°\u0026#34;\u0026#34;\u0026#34; return a + b print(add.__name__) # add print(add.__doc__) # åŠ æ³•å‡½æ•° å¦‚æœä¸ä½¿ç”¨ update_wrapperï¼Œç»“æœä¼šæ˜¯ï¼š\nwrapper None ğŸŸ¦ 3. update_wrapper çš„å‡½æ•°ç­¾å update_wrapper(wrapper, wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES) å«ä¹‰ï¼š\nå‚æ•° å«ä¹‰ wrapper ä½ çš„è£…é¥°å™¨å†…éƒ¨çš„å‡½æ•°ï¼ˆè¢«ä¿®æ”¹çš„å¯¹è±¡ï¼‰ wrapped åŸå§‹å‡½æ•°ï¼ˆè¢«è£…é¥°çš„å‡½æ•°ï¼‰ assigned éœ€è¦å¤åˆ¶çš„å±æ€§åˆ—è¡¨ï¼ˆé»˜è®¤æœ‰ name, docâ€¦ï¼‰ updated éœ€è¦â€œæ›´æ–°è€Œä¸æ˜¯è¦†ç›–â€çš„å±æ€§ï¼ˆä¾‹å¦‚ wrapper.dictï¼‰ ğŸ“Œ 4. é»˜è®¤å¤åˆ¶å“ªäº›å­—æ®µï¼Ÿ é»˜è®¤çš„ï¼š\nWRAPPER_ASSIGNMENTS = (\u0026#39;__module__\u0026#39;, \u0026#39;__name__\u0026#39;, \u0026#39;__qualname__\u0026#39;, \u0026#39;__doc__\u0026#39;, \u0026#39;__annotations__\u0026#39;) WRAPPER_UPDATES = (\u0026#39;__dict__\u0026#39;,) è¿™æ„å‘³ç€ï¼š\nåå­—ã€æ–‡æ¡£ã€æ³¨è§£ã€æ¨¡å—éƒ½ä¼šå¤åˆ¶ wrapper çš„ __dict__ ä¼šæ›´æ–°ï¼Œè€Œä¸æ˜¯è¦†ç›– ğŸŸ© 5. wraps() å°±æ˜¯å¯¹ update_wrapper çš„å°è£… ç­‰ä»·äºï¼š\ndef wraps(wrapped): return partial(update_wrapper, wrapped=wrapped) æ‰€ä»¥è¿™ä¸¤æ®µä»£ç æ•ˆæœä¸€è‡´ï¼š\n@wraps(func) ç­‰ä»·äºï¼š\nupdate_wrapper(wrapper, func) ğŸ”¥ 6. å®æˆ˜ç¤ºä¾‹ï¼šå¤„ç†è‡ªå®šä¹‰å±æ€§ å‡è®¾ä½ å†™ä¸€ä¸ªè£…é¥°å™¨ï¼Œéœ€è¦ä¿ç•™åŸå‡½æ•°è‡ªå®šä¹‰å±æ€§ï¼š\ndef tag(t): def decorator(fn): fn.tag = t return fn return decorator ä½¿ç”¨ update_wrapper è‡ªåŠ¨å¤åˆ¶ï¼š\ndef deco(fn): def wrapper(*args, **kwargs): return fn(*args, **kwargs) update_wrapper(wrapper, fn) return wrapper â­ 7. å¤æ‚ç¤ºä¾‹ï¼šå¤šå±‚è£…é¥°å™¨æ—¶ä¿æŒ metadata æ­£ç¡®æ€§ from functools import update_wrapper def decorator(func): def wrapper(*args, **kwargs): return func(*args, **kwargs) update_wrapper(wrapper, func) # ä¿ç•™å…ƒä¿¡æ¯ return wrapper def another_decorator(func): def wrapper(*args, **kwargs): return func(*args, **kwargs) update_wrapper(wrapper, func) # å†æ¬¡ä¿ç•™å…ƒä¿¡æ¯ return wrapper @another_decorator @decorator def hello(): \u0026#34;\u0026#34;\u0026#34;Hello Doc\u0026#34;\u0026#34;\u0026#34; pass print(hello.__doc__) # Hello Doc print(hello.__name__) # hello å¦‚æœä¸ä½¿ç”¨ update_wrapperï¼Œå‡½æ•°ä¼šè¢«å¤šæ¬¡ â€œåŒ…è£…æŸåâ€ã€‚\nâ˜˜ï¸ 8. update_wrapper èƒ½è§£å†³ä»€ä¹ˆå®é™…é—®é¢˜ï¼Ÿ é—®é¢˜ ä¸ç”¨ update_wrapper ç”¨äº† update_wrapper å‡½æ•°åå˜æˆ wrapper âŒ âœ… æ–‡æ¡£ä¸¢å¤± âŒ âœ… FastAPI æ–‡æ¡£æŠ¥é”™ âŒ âœ… IDE å‚æ•°æç¤ºæ— æ•ˆ âŒ âœ… lru_cache ä¸èƒ½å·¥ä½œ âŒ âœ… è°ƒè¯•ï¼ˆtracebackï¼‰éš¾çœ‹æ‡‚ âŒ âœ… recursive è°ƒç”¨å¤±è´¥ âŒ âœ… ğŸŸ§ 9. ä¸“ä¸šä½¿ç”¨ï¼šæŒ‡å®šå¤åˆ¶å“ªäº›å­—æ®µ ä¾‹å¦‚ä½ åªæƒ³å¤åˆ¶åå­—å’Œæ–‡æ¡£ï¼š\nupdate_wrapper(wrapper, func, assigned=(\u0026#39;__name__\u0026#39;, \u0026#39;__doc__\u0026#39;), updated=()) ğŸŸ£ 10. update_wrapper çš„é€†æ“ä½œï¼šè·å–åŸå‡½æ•° wrapper.__wrapped__ update_wrapper ä¼šè‡ªåŠ¨åŠ è¿™ä¸ªå±æ€§ã€‚\nğŸŸ¨ 11. æœ€æ¨èçš„å°è£…æ–¹å¼ï¼ˆä½ é¡¹ç›®å¯ç”¨ï¼‰ å†™ä½ è‡ªå·±çš„è£…é¥°å™¨åŸºç±»ï¼š\nfrom functools import update_wrapper def preserve(fn): def decorator(wrapper): return update_wrapper(wrapper, fn) return decorator ä½¿ç”¨ï¼š\ndef debug(fn): @preserve(fn) def wrapper(*args, **kwargs): print(fn.__name__) return fn(*args, **kwargs) return wrapper å¯¹ä½ æ‰€æœ‰è£…é¥°å™¨ç»Ÿä¸€ä¿ç•™ metadataã€‚\nğŸ¯ æ€»ç»“ï¼ˆé€ŸæŸ¥ï¼‰ update_wrapper(wrapper, wrapped):\nå°† wrapped çš„å…ƒæ•°æ®å¤åˆ¶åˆ° wrapper æ˜¯ wraps() çš„åº•å±‚ ä¿ç•™ __name__, __doc__, __annotations__, __module__ ç­‰ æ·»åŠ  __wrapped__ å±æ€§ å¯¹ç¼–å†™è£…é¥°å™¨å¿…ä¸å¯å°‘ ","description":" âœ… 1. functools.update_wrapper æ˜¯ä»€ä¹ˆï¼Ÿ update_wrapper æ˜¯ç”¨äºâ€œæŠŠä¸€ä¸ªå‡½æ•°çš„å…ƒæ•°æ®å¤åˆ¶åˆ°å¦ä¸€ä¸ªå‡½æ•°â€çš„å·¥å…·ã€‚\nå°±æ˜¯ wraps() çš„åº•å±‚å®ç°å·¥å…·ã€‚\nè£…é¥°å™¨å†™æ³•ï¼š\nfrom functools import wraps å…¶å®ç­‰ä»·äºï¼š\nfrom functools import update_wrapper wraps ä¸è¿‡æ˜¯ update_wrapper çš„è¯­æ³•ç³–ã€‚\nğŸ“Œ 2. æœ€ç®€å•çš„ä¾‹å­ from functools import update_wrapper def deco(func): def wrapper(*args, **kwargs): return func(*args, **kwargs) update_wrapper(wrapper, func) return wrapper @deco def add(a, b): \u0026#34;\u0026#34;\u0026#34;åŠ æ³•å‡½æ•°\u0026#34;\u0026#34;\u0026#34; return a + b print(add.__name__) # add print(add.__doc__) # åŠ æ³•å‡½æ•° å¦‚æœä¸ä½¿ç”¨ update_wrapperï¼Œç»“æœä¼šæ˜¯ï¼š\n"},{"id":226,"href":"/backend/python/official/functools-wraps/","title":"Functools -- wraps","parent":"Official","content":" âœ… 1. functools.wraps æ˜¯ä»€ä¹ˆï¼Ÿ wraps æ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äº ç¼–å†™è£…é¥°å™¨æ—¶ä¿æŒè¢«åŒ…è£…å‡½æ•°çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ï¼š\n__name__ __doc__ __module__ __annotations__ __wrapped__ __qualname__ å¦åˆ™ï¼Œä½¿ç”¨è£…é¥°å™¨ä¼šå¯¼è‡´å‡½æ•°è¢«æ›¿æ¢ä¸ºå†…éƒ¨ wrapperï¼Œä¸¢å¤±åŸä¿¡æ¯ã€‚\nâŒ ä¸ä½¿ç”¨ wraps çš„é—®é¢˜ ä¾‹å­ï¼š\ndef logger(func): def wrapper(*args, **kwargs): print(\u0026#34;call\u0026#34;, func.__name__) return func(*args, **kwargs) return wrapper @logger def add(a, b): \u0026#34;\u0026#34;\u0026#34;åŠ æ³•å‡½æ•°\u0026#34;\u0026#34;\u0026#34; return a + b print(add.__name__) print(add.__doc__) è¾“å‡ºï¼š\nwrapper None åŸå‡½æ•° add çš„åå­—å’Œæ–‡æ¡£éƒ½ä¸¢å¤±äº†ã€‚\nâœ… ä½¿ç”¨ functools.wraps çš„æ­£ç¡®æ–¹å¼ from functools import wraps def logger(func): @wraps(func) def wrapper(*args, **kwargs): print(\u0026#34;call\u0026#34;, func.__name__) return func(*args, **kwargs) return wrapper @logger def add(a, b): \u0026#34;\u0026#34;\u0026#34;åŠ æ³•å‡½æ•°\u0026#34;\u0026#34;\u0026#34; return a + b print(add.__name__) print(add.__doc__) è¾“å‡ºï¼š\nadd åŠ æ³•å‡½æ•° ğŸ“Œ 2. wraps æœ¬è´¨ä¸Šåšäº†ä»€ä¹ˆï¼Ÿ ç›¸å½“äºï¼š\næŠŠåŸå‡½æ•°çš„åç§°ã€æ³¨é‡Šã€æ–‡æ¡£å†™å›åŒ…è£…å‡½æ•° ç»™åŒ…è£…å‡½æ•°å¢åŠ  __wrapped__ = funcï¼Œæ”¯æŒ inspect è§£åŒ… è®© IDE / æ–‡æ¡£å·¥å…·ç»§ç»­è¯†åˆ«çœŸå®ä¿¡æ¯ åº•å±‚ç­‰ä»·äºï¼š\ndef wraps(func): def decorator(wrapper): wrapper.__name__ = func.__name__ wrapper.__doc__ = func.__doc__ wrapper.__module__ = func.__module__ wrapper.__annotations__ = func.__annotations__ wrapper.__wrapped__ = func return wrapper return decorator ğŸŸ¦ 3. æœ€ä½³å®è·µï¼šé€šç”¨è£…é¥°å™¨æ¨¡æ¿ ä½ ä»Šåå†™æ‰€æœ‰è£…é¥°å™¨éƒ½ç”¨è¿™ä¸ªç»“æ„ï¼š\nfrom functools import wraps def my_decorator(fn): @wraps(fn) def wrapper(*args, **kwargs): # å‰ç½®é€»è¾‘ result = fn(*args, **kwargs) # åç½®é€»è¾‘ return result return wrapper ğŸŸ© 4. å¸¸è§åº”ç”¨åœºæ™¯ â‘  æ—¥å¿—è£…é¥°å™¨ def log_call(fn): @wraps(fn) def wrapper(*args, **kwargs): print(f\u0026#34;[CALL] {fn.__name__}\u0026#34;) return fn(*args, **kwargs) return wrapper â‘¡ ç¼“å­˜è£…é¥°å™¨ï¼ˆä½ é¡¹ç›®å¯ç”¨ï¼‰ def cache(fn): memo = {} @wraps(fn) def wrapper(x): if x not in memo: memo[x] = fn(x) return memo[x] return wrapper â‘¢ æƒé™æ£€æŸ¥ï¼ˆé€‚åˆ FastAPIï¼‰ def require_admin(fn): @wraps(fn) def wrapper(*args, **kwargs): user = kwargs.get(\u0026#34;user\u0026#34;) if not user or user.role != \u0026#34;admin\u0026#34;: raise PermissionError(\u0026#34;éœ€è¦ç®¡ç†å‘˜æƒé™\u0026#34;) return fn(*args, **kwargs) return wrapper ğŸŸ¥ 5. ä¸ä½¿ç”¨ wraps ä¼šå¯¼è‡´çš„çœŸå®é—®é¢˜ FastAPI æ— æ³•æ­£ç¡®æ˜¾ç¤ºæ–‡æ¡£ è£…é¥°å™¨åçš„å‡½æ•° metadata ä¸¢å¤±ï¼Œå¯¼è‡´è·¯å¾„å‚æ•°é”™è¯¯ã€‚\nfunctools.lru_cache æ— æ³•å·¥ä½œ cache ä¼šè¯†åˆ« wrapperï¼Œè€Œä¸æ˜¯åŸå‡½æ•°ã€‚\nè°ƒè¯•å›°éš¾ traceback æ˜¾ç¤º wrapperï¼Œè€Œä¸æ˜¯çœŸå®å‡½æ•°åç§°ã€‚\nIDE æ— æ³•æç¤ºå‚æ•°ç±»å‹ å‡½æ•°æ³¨è§£ä¸¢å¤±ã€‚\nğŸŸª 6. ä¸“ä¸šçº§ï¼šwraps è¿˜èƒ½ä¼ å…¥å‚æ•° é»˜è®¤å¤åˆ¶ï¼š\nwraps(func) ä½ å¯ä»¥é€‰æ‹©å¤åˆ¶å“ªäº›å±æ€§ï¼š\nwraps(func, assigned=(\u0026#34;__name__\u0026#34;, \u0026#34;__doc__\u0026#34;), updated=()) â­ 7. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆè®°ä½è¿™å¼ å°±å¤Ÿäº†ï¼‰ functools.wraps ç”¨äºç¼–å†™è£…é¥°å™¨ã€‚\nä½œç”¨ï¼š\nä¿ç•™åŸå‡½æ•°çš„ __name__ ä¿ç•™åŸå‡½æ•°çš„ __doc__ ä¿ç•™ __annotations__ ä¿ç•™ __module__ æ·»åŠ  __wrapped__ï¼Œæ–¹ä¾¿ inspect è§£åŒ… ç”¨æ³•ï¼š\nfrom functools import wraps def deco(func): @wraps(func) def wrapper(*args, **kwargs): return func(*args, **kwargs) return wrapper ä¸ä½¿ç”¨çš„åæœï¼š\ndebug å’Œå †æ ˆå˜éš¾ IDE æ— æ³•æç¤ºå‚æ•° FastAPI æ–‡æ¡£ä¸å‡†ç¡® ","description":" âœ… 1. functools.wraps æ˜¯ä»€ä¹ˆï¼Ÿ wraps æ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äº ç¼–å†™è£…é¥°å™¨æ—¶ä¿æŒè¢«åŒ…è£…å‡½æ•°çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ï¼š\n__name__ __doc__ __module__ __annotations__ __wrapped__ __qualname__ å¦åˆ™ï¼Œä½¿ç”¨è£…é¥°å™¨ä¼šå¯¼è‡´å‡½æ•°è¢«æ›¿æ¢ä¸ºå†…éƒ¨ wrapperï¼Œä¸¢å¤±åŸä¿¡æ¯ã€‚\nâŒ ä¸ä½¿ç”¨ wraps çš„é—®é¢˜ ä¾‹å­ï¼š\ndef logger(func): def wrapper(*args, **kwargs): print(\u0026#34;call\u0026#34;, func.__name__) return func(*args, **kwargs) return wrapper @logger def add(a, b): \u0026#34;\u0026#34;\u0026#34;åŠ æ³•å‡½æ•°\u0026#34;\u0026#34;\u0026#34; return a + b print(add.__name__) print(add.__doc__) è¾“å‡ºï¼š\n"},{"id":227,"href":"/backend/python/official/get-env/","title":"Get ENV (è·å–ç¯å¢ƒå˜é‡)","parent":"Official","content":"os.getenv() å’Œ os.environ.get() çš„ä¸»è¦åŒºåˆ«åœ¨äºé”™è¯¯å¤„ç†ï¼šå½“ç¯å¢ƒå˜é‡ä¸å­˜åœ¨æ—¶ï¼Œos.getenv() é»˜è®¤è¿”å› None æˆ–ç”¨æˆ·æŒ‡å®šçš„é»˜è®¤å€¼ï¼Œè€Œ os.environ.get() ä¹Ÿä¼šè¿”å›é»˜è®¤å€¼ï¼Œä½† os.environ ç›´æ¥è®¿é—®ï¼ˆå¦‚ os.environ['KEY']ï¼‰åˆ™ä¼šå¼•å‘ KeyError å¼‚å¸¸ã€‚å› æ­¤ï¼Œos.getenv() æ›´é€‚åˆç”¨äºç¯å¢ƒå˜é‡å¯èƒ½ä¸å­˜åœ¨çš„æƒ…å†µï¼Œè€Œ os.environ åˆ™é€‚åˆåœ¨ç¯å¢ƒå˜é‡å¿…é¡»å­˜åœ¨ã€ä¸å­˜åœ¨æ—¶åº”å¯¼è‡´ç¨‹åºä¸­æ–­çš„åœºæ™¯ã€‚\nè¯¦ç»†å¯¹æ¯” ç‰¹æ€§ os.getenv(key, default) os.environ.get(key, default) os.environ['KEY'] å¤„ç†æœªæ‰¾åˆ°çš„ç¯å¢ƒå˜é‡ è¿”å› None æˆ–æŒ‡å®šçš„ default å€¼ã€‚ è¿”å› None æˆ–æŒ‡å®šçš„ default å€¼ã€‚ æŠ›å‡º KeyError å¼‚å¸¸ã€‚ ä¸»è¦ç”¨é€” å½“ç¯å¢ƒå˜é‡ä¸ä¸€å®šå­˜åœ¨ï¼Œä¸”ç¨‹åºéœ€è¦æä¾›é»˜è®¤å€¼æ—¶ä½¿ç”¨ã€‚ ä¸ os.getenv() ç›¸åŒï¼Œç”¨äºå®‰å…¨åœ°è·å–ç¯å¢ƒå˜é‡ã€‚ é€‚ç”¨äºç¯å¢ƒå˜é‡å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ç¨‹åºåº”å¼‚å¸¸ç»ˆæ­¢çš„åœºæ™¯ã€‚ åº•å±‚å®ç° os.getenv() æ˜¯ os.environ.get() çš„ä¸€ä¸ªå°è£…ã€‚ os.environ æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œ.get() æ–¹æ³•æ˜¯å­—å…¸æ ‡å‡†æ–¹æ³•ã€‚ ç›´æ¥å¯¹å­—å…¸è¿›è¡Œç´¢å¼•æ“ä½œï¼Œæ²¡æœ‰é”™è¯¯å¤„ç†æœºåˆ¶ã€‚ ç¤ºä¾‹ ç¤ºä¾‹ 1ï¼šå¤„ç†ä¸å­˜åœ¨çš„ç¯å¢ƒå˜é‡ import os # å‡è®¾MY_VARIABLEæœªè®¾ç½® value1 = os.getenv(\u0026#39;MY_VARIABLE\u0026#39;) # value1 çš„å€¼ä¸º None value2 = os.getenv(\u0026#39;MY_VARIABLE\u0026#39;, \u0026#39;default_value\u0026#39;) # value2 çš„å€¼ä¸º \u0026#39;default_value\u0026#39; print(value1) print(value2) ç¤ºä¾‹ 2ï¼šä½¿ç”¨ os.environ import os # å‡è®¾MY_VARIABLEæœªè®¾ç½® try: value = os.environ[\u0026#39;MY_VARIABLE\u0026#39;] print(value) except KeyError: print(\u0026#34;MY_VARIABLE is not set\u0026#34;) ç»“è®º é€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ï¼š\nå¦‚æœéœ€è¦ä¸€ä¸ªå®‰å…¨è·å–ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œå¹¶åœ¨ç¯å¢ƒå˜é‡ç¼ºå¤±æ—¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œä½¿ç”¨ os.getenv() æˆ– os.environ.get()ã€‚ä¸¤è€…åŠŸèƒ½ç›¸åŒï¼Œä½† os.getenv() é€šå¸¸æ›´ç®€æ´æ˜“è¯»ã€‚\nå¦‚æœä½ çš„ä»£ç è¦æ±‚ç¯å¢ƒå˜é‡å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™å°±åº”è¯¥æŠ¥é”™ä¸­æ–­ï¼Œä½¿ç”¨ os.environ['KEY']ï¼Œå¹¶è®©ç¨‹åºæ•è· KeyError å¼‚å¸¸ã€‚\n","description":"os.getenv() å’Œ os.environ.get() çš„ä¸»è¦åŒºåˆ«åœ¨äºé”™è¯¯å¤„ç†ï¼šå½“ç¯å¢ƒå˜é‡ä¸å­˜åœ¨æ—¶ï¼Œos.getenv() é»˜è®¤è¿”å› None æˆ–ç”¨æˆ·æŒ‡å®šçš„é»˜è®¤å€¼ï¼Œè€Œ os.environ.get() ä¹Ÿä¼šè¿”å›é»˜è®¤å€¼ï¼Œä½† os.environ ç›´æ¥è®¿é—®ï¼ˆå¦‚ os.environ['KEY']ï¼‰åˆ™ä¼šå¼•å‘ KeyError å¼‚å¸¸ã€‚å› æ­¤ï¼Œos.getenv() æ›´é€‚åˆç”¨äºç¯å¢ƒå˜é‡å¯èƒ½ä¸å­˜åœ¨çš„æƒ…å†µï¼Œè€Œ os.environ åˆ™é€‚åˆåœ¨ç¯å¢ƒå˜é‡å¿…é¡»å­˜åœ¨ã€ä¸å­˜åœ¨æ—¶åº”å¯¼è‡´ç¨‹åºä¸­æ–­çš„åœºæ™¯ã€‚\nè¯¦ç»†å¯¹æ¯” ç‰¹æ€§ os.getenv(key, default) os.environ.get(key, default) os.environ['KEY'] å¤„ç†æœªæ‰¾åˆ°çš„ç¯å¢ƒå˜é‡ è¿”å› None æˆ–æŒ‡å®šçš„ default å€¼ã€‚ è¿”å› None æˆ–æŒ‡å®šçš„ default å€¼ã€‚ æŠ›å‡º KeyError å¼‚å¸¸ã€‚ ä¸»è¦ç”¨é€” å½“ç¯å¢ƒå˜é‡ä¸ä¸€å®šå­˜åœ¨ï¼Œä¸”ç¨‹åºéœ€è¦æä¾›é»˜è®¤å€¼æ—¶ä½¿ç”¨ã€‚ ä¸ os.getenv() ç›¸åŒï¼Œç”¨äºå®‰å…¨åœ°è·å–ç¯å¢ƒå˜é‡ã€‚ é€‚ç”¨äºç¯å¢ƒå˜é‡å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ç¨‹åºåº”å¼‚å¸¸ç»ˆæ­¢çš„åœºæ™¯ã€‚ åº•å±‚å®ç° os.getenv() æ˜¯ os.environ.get() çš„ä¸€ä¸ªå°è£…ã€‚ os.environ æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œ.get() æ–¹æ³•æ˜¯å­—å…¸æ ‡å‡†æ–¹æ³•ã€‚ ç›´æ¥å¯¹å­—å…¸è¿›è¡Œç´¢å¼•æ“ä½œï¼Œæ²¡æœ‰é”™è¯¯å¤„ç†æœºåˆ¶ã€‚ ç¤ºä¾‹ ç¤ºä¾‹ 1ï¼šå¤„ç†ä¸å­˜åœ¨çš„ç¯å¢ƒå˜é‡ import os # å‡è®¾MY_VARIABLEæœªè®¾ç½® value1 = os.getenv(\u0026#39;MY_VARIABLE\u0026#39;) # value1 çš„å€¼ä¸º None value2 = os.getenv(\u0026#39;MY_VARIABLE\u0026#39;, \u0026#39;default_value\u0026#39;) # value2 çš„å€¼ä¸º \u0026#39;default_value\u0026#39; print(value1) print(value2) ç¤ºä¾‹ 2ï¼šä½¿ç”¨ os.environ import os # å‡è®¾MY_VARIABLEæœªè®¾ç½® try: value = os.environ[\u0026#39;MY_VARIABLE\u0026#39;] print(value) except KeyError: print(\u0026#34;MY_VARIABLE is not set\u0026#34;) ç»“è®º é€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ï¼š\n"},{"id":228,"href":"/operations/git/","title":"Git","parent":"Operations","content":"å®˜æ–¹ç½‘å€: https://git-scm.com/\nGit æ•™ç¨‹:\nPro Git ç¬¬äºŒç‰ˆ ä¸­æ–‡ç‰ˆ å»–é›ªå³° Git æ•™ç¨‹ Document List:\nGit FAQ Git åŸºç¡€æ•™ç¨‹ Git æ ¸å¿ƒæ¦‚å¿µ Git Config Git merge vs rebase Git æœ€ä½³å®è·µ ","description":"å®˜æ–¹ç½‘å€: https://git-scm.com/\nGit æ•™ç¨‹:\nPro Git ç¬¬äºŒç‰ˆ ä¸­æ–‡ç‰ˆ å»–é›ªå³° Git æ•™ç¨‹ Document List:\nGit FAQ Git åŸºç¡€æ•™ç¨‹ Git æ ¸å¿ƒæ¦‚å¿µ Git Config Git merge vs rebase Git æœ€ä½³å®è·µ "},{"id":229,"href":"/operations/git/git-config/","title":"Git Config","parent":"Git","content":" Git é…ç½® åŸºç¡€é…ç½®:\n# Core git config --global core.autocrlf input git config --global core.bare false git config --global core.filemode true git config --global core.ignorecase false git config --global core.quotepath false git config --global core.repositoryformatversion 0 git config --global core.safecrlf true # Core unset git config --global --unset core.excludesfile git config --system --unset core.excludesfile # Credential Storage git config --global credential.helper store git config --system credential.helper store # Initial Default Branch git config --global init.defaultBranch main git config --system init.defaultBranch main # Pull Rebase # git config --global pull.rebase true å½“å‰é¡¹ç›®é…ç½®:\ngit config core.autocrlf input git config core.bare false git config core.filemode true git config core.ignorecase false git config core.quotepath false git config core.repositoryformatversion 0 git config core.safecrlf true git config credential.helper store git config pull.rebase false git config --unset core.excludesfile git config user.name septvean git config user.email septvean@gmail.com æŸ¥çœ‹é…ç½® 3ç§é…ç½®\n--global use global config file --system use system config file --local use repository config file ç›¸å…³çš„é…ç½®æ–‡ä»¶\n# Linux global ~/.gitconfig system /etc/gitconfig local .git/config # MacOS global ~/.gitconfig system /usr/local/git/etc/gitconfig local .git/config æŸ¥çœ‹é…ç½®\ngit config --global --list git config --system --list git config --local --list å¦‚æœä¸åŠ å‚æ•°, é»˜è®¤æŸ¥çœ‹çš„æ˜¯ --local çš„é…ç½®\ngit config --list # ä¸ªäººä¿¡æ¯é…ç½®, æ ¹æ®æƒ…å†µé…ç½® # git config --global user.email septvean@gmail.com # git config --global user.name SeptVean # ä¸è®¸å¿½ç•¥æ–‡ä»¶åå¤§å°å†™ git config --system core.ignorecase false # æ¢è¡Œæ¨¡å¼ä¸º input, å³æäº¤æ—¶è½¬æ¢ä¸ºLF, æ£€å‡ºæ—¶ä¸è½¬æ¢, å‚æ•°: true | input | false # https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration git config --system core.autocrlf input # Linux/MacOS æ£€æŸ¥æ–‡ä»¶æƒé™ / Windows ä¸æ£€æŸ¥æ–‡ä»¶æƒé™ git config --system core.filemode true # æ‹’ç»æäº¤åŒ…å«æ··åˆæ¢è¡Œç¬¦çš„æ–‡ä»¶ git config --system core.safecrlf true # ç¼–è¾‘å™¨ git config --system core.editor vim # Internal variable identifying the repository format and layout version git config --system core.repositoryformatversion 0 # é»˜è®¤ä¸åˆ›å»ºè£¸ä»“åº“ git config --system core.bare false # log æ‰€æœ‰ ref çš„æ›´æ–° git config --system core.logallrefupdates true # Macä¸“ç”¨é€‰é¡¹, å¼€å¯ä»¥ä¾¿æ–‡ä»¶åå…¼å®¹å…¶ä»–ç³»ç»Ÿ # git config --system core.precomposeunicode true # åªæ¨é€æœ¬åœ°å½“å‰åˆ†æ”¯ï¼Œä¸”ä¸ä¸Šæ¸¸åˆ†æ”¯åå­—ä¸€è‡´ git config --system push.default simple # æ—¥å¿—é…ç½® (Linux) # git config --system alias.lg \u0026#34;log --color --graph --pretty=format:\u0026#39;%C(bold white)%h%Creset -%C(bold green)%d%Creset %s %C(bold green)(%cr)%Creset %C(bold blue)\u0026lt;%an\u0026gt;%Creset\u0026#39; --abbrev-commit --date=relative\u0026#34; # å¼ºåˆ¶å¼€å¯ rebase æ¨¡å¼ # git config --system pull.rebase true ç§»é™¤é…ç½® å‚æ•° --unset ç”¨äºç§»é™¤ç›¸å…³é…ç½®, ç¤ºä¾‹:\ngit config --global --unset credential.helper git config --global --unset user.name git config --global --unset user.email Command line instructions Git global setup\ngit config --global user.name \u0026#34;septvean\u0026#34; git config --global user.email \u0026#34;septvean@gmail.com\u0026#34; Create a new repository\ngit clone http://git.septvean.com:7000/websites/v2ep.com.git cd v2ep.com touch README.md git add README.md git commit -m \u0026#34;add README\u0026#34; git push -u origin master Existing folder\ncd existing_folder git init git remote add origin http://git.septvean.com:7000/websites/v2ep.com.git git add . git commit -m \u0026#34;Initial commit\u0026#34; git push -u origin master Existing Git repository\ncd existing_repo git remote rename origin old-origin git remote add origin http://git.septvean.com:7000/websites/v2ep.com.git git push -u origin --all git push -u origin --tags å¤§å°å†™æ•æ„Ÿé…ç½® Windows å’Œ MacOS ä¸Šçš„ Git é»˜è®¤æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„, è¿™æ ·å¤šå¹³å°å†™ä½œå°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜.\nå°† Git è®¾ç½®ä¸ºå¤§å°å†™æ•æ„Ÿçš„å‘½ä»¤å¦‚ä¸‹\ngit config core.ignorecase false æŸ¥çœ‹ .git/config ä¸­çš„é…ç½®\n[core] ignorecase = false ä¿å­˜è®¤è¯ä¿¡æ¯ å‚è€ƒæ–‡æ¡£: Git Tools - Credential Storage\nå‚è€ƒæ–‡æ¡£ git config ä¸€ç§æ¨èæ–¹æ¡ˆ ","description":" Git é…ç½® åŸºç¡€é…ç½®:\n# Core git config --global core.autocrlf input git config --global core.bare false git config --global core.filemode true git config --global core.ignorecase false git config --global core.quotepath false git config --global core.repositoryformatversion 0 git config --global core.safecrlf true # Core unset git config --global --unset core.excludesfile git config --system --unset core.excludesfile # Credential Storage git config --global credential.helper store git config --system credential.helper store # Initial Default Branch git config --global init.defaultBranch main git config --system init.defaultBranch main # Pull Rebase # git config --global pull.rebase true å½“å‰é¡¹ç›®é…ç½®:\n"},{"id":230,"href":"/operations/git/merge-vs-rebase/","title":"Git merge vs rebase","parent":"Git","content":" ä¸€å¥è¯æ ¸å¿ƒåŒºåˆ« merge ä¿ç•™çœŸå®å†å²ï¼Œrebase é‡å†™æäº¤å†å²ï¼Œè®©å†å²æ›´çº¿æ€§ã€‚\nä¸€ã€merge æ˜¯ä»€ä¹ˆï¼Ÿ æœ¬è´¨ åˆå¹¶ä¸¤ä¸ªåˆ†æ”¯ é€šè¿‡åˆ›å»ºä¸€ä¸ª æ–°çš„ merge commit ä¸ä¿®æ”¹å·²æœ‰æäº¤ ç¤ºæ„å›¾ A---B---C (main) \\ D---E (feature) æ‰§è¡Œï¼š\ngit checkout main git merge feature ç»“æœï¼š\nA---B---C-------M (main) \\ / D---E--- (feature) M æ˜¯ä¸€ä¸ª merge commit\nmerge çš„ç‰¹ç‚¹ âœ… ä¼˜ç‚¹\nä¿ç•™å®Œæ•´ã€çœŸå®çš„å†å² å®‰å…¨ï¼Œä¸ä¼šç ´åå·²æœ‰æäº¤ é€‚åˆå¤šäººåä½œã€å…¬å…±åˆ†æ”¯ âŒ ç¼ºç‚¹\nå†å²å¯èƒ½â€œåˆ†å‰ + åˆå¹¶â€ï¼Œè¾ƒä¹± merge commit å¤šäº†ä¹‹åä¸ç›´è§‚ äºŒã€rebase æ˜¯ä»€ä¹ˆï¼Ÿ æœ¬è´¨ æŠŠä¸€ä¸ªåˆ†æ”¯çš„æäº¤â€œæ¬åˆ°â€å¦ä¸€ä¸ªåˆ†æ”¯åé¢ å®é™…æ˜¯ï¼šé‡æ–°ç”Ÿæˆä¸€ç»„æ–°çš„æäº¤ ç¤ºæ„å›¾ A---B---C (main) \\ D---E (feature) æ‰§è¡Œï¼š\ngit checkout feature git rebase main ç»“æœï¼š\nA---B---C---D\u0026#39;---E\u0026#39; (feature) D'ã€E' æ˜¯ æ–°æäº¤ï¼ˆhash å·²å˜ï¼‰\nrebase çš„ç‰¹ç‚¹ âœ… ä¼˜ç‚¹\næäº¤å†å²çº¿æ€§ã€å¹²å‡€ æ›´å®¹æ˜“é˜…è¯» git log éå¸¸é€‚åˆæœ¬åœ°æ•´ç†æäº¤ âŒ ç¼ºç‚¹\nä¼šæ”¹å†™å†å² ä¸å½“ä½¿ç”¨ä¼šå½±å“ä»–äººåˆ†æ”¯ å…¬å…±åˆ†æ”¯ä¸Šé£é™©é«˜ ä¸‰ã€merge vs rebase å¯¹æ¯”è¡¨ï¼ˆé‡ç‚¹ï¼‰ ç»´åº¦ merge rebase æ˜¯å¦æ”¹å†™å†å² âŒ å¦ âœ… æ˜¯ æ˜¯å¦ç”Ÿæˆæ–°æäº¤ âœ… merge commit âŒï¼ˆä½†ä¼šé‡å»ºæäº¤ï¼‰ å†å²æ˜¯å¦çº¿æ€§ âŒ âœ… æ˜¯å¦å®‰å…¨ âœ… é«˜ âš ï¸ éœ€è°¨æ… é€‚åˆå…¬å…±åˆ†æ”¯ âœ… âŒ é€‚åˆæœ¬åœ°æ•´ç† ä¸€èˆ¬ âœ… å››ã€ä»€ä¹ˆæ—¶å€™ç”¨ mergeï¼Ÿ âœ… å¼ºçƒˆæ¨è merge çš„åœºæ™¯\nmain / master / release åˆ†æ”¯ å·²æ¨é€åˆ°è¿œç«¯çš„åˆ†æ”¯ å¤šäººåä½œçš„å…±äº«åˆ†æ”¯ CI / GitLab / GitHub è‡ªåŠ¨åˆå¹¶ ç¤ºä¾‹ï¼š\ngit checkout main git merge feature äº”ã€ä»€ä¹ˆæ—¶å€™ç”¨ rebaseï¼Ÿ âœ… æ¨è rebase çš„åœºæ™¯\næœ¬åœ° feature åˆ†æ”¯ æäº¤å‰æ•´ç† commit ä¸å½±å“ä»–äººçš„ç§æœ‰åˆ†æ”¯ ç¤ºä¾‹ï¼ˆæœ€å¸¸è§ï¼‰ï¼š\ngit checkout feature git rebase main å…­ã€é»„é‡‘æ³•åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰ å·²ç» push åˆ°è¿œç«¯ã€å¹¶ä¸”åˆ«äººå¯èƒ½åŸºäºå®ƒå·¥ä½œçš„åˆ†æ”¯ï¼Œç¦æ­¢ rebaseã€‚\nå¦‚æœä½  rebase äº†å¹¶å¼ºæ¨ï¼š\ngit push --force åˆ«äººå°±ä¼šé‡åˆ°ï¼š\næäº¤ä¸¢å¤± å†²çªçˆ†ç‚¸ å†å²å¯¹ä¸ä¸Š ä¸ƒã€rebase çš„è¿›é˜¶ç”¨æ³• 1ï¸âƒ£ äº¤äº’å¼ rebaseï¼ˆæ•´ç†æäº¤ï¼‰ git rebase -i HEAD~5 å¯ä»¥ï¼š\nåˆå¹¶æäº¤ï¼ˆsquashï¼‰ ä¿®æ”¹æäº¤ä¿¡æ¯ï¼ˆrewordï¼‰ åˆ é™¤æäº¤ï¼ˆdropï¼‰ 2ï¸âƒ£ pull æ—¶ç”¨ rebase git pull --rebase ç­‰ä»·äºï¼š\ngit fetch git rebase origin/main ğŸ‘‰ é¿å…äº§ç”Ÿæ— æ„ä¹‰çš„ merge commit\nå…«ã€å®é™…å›¢é˜Ÿæ¨èç­–ç•¥ï¼ˆæœ€ä½³å®è·µï¼‰ åœºæ™¯ æ¨è æœ¬åœ°å¼€å‘ rebase æ¨é€å‰ rebaseï¼ˆæ•´ç†æäº¤ï¼‰ åˆå¹¶åˆ°ä¸»åˆ†æ”¯ merge CI / å‘å¸ƒåˆ†æ”¯ merge ä¸ªäººä»“åº“ rebase ä¸ºä¸» ä¹ã€æ€»ç»“ merge ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„åˆå¹¶æäº¤ï¼Œä¿ç•™å®Œæ•´å†å²ï¼Œé€‚åˆå…¬å…±åˆ†æ”¯ï¼›\nrebase ä¼šé‡å†™æäº¤å†å²ï¼Œä½¿å†å²çº¿æ€§ï¼Œé€‚åˆæœ¬åœ°åˆ†æ”¯æ•´ç†ã€‚\nå·²ç»æ¨é€åˆ°è¿œç«¯çš„åˆ†æ”¯ä¸åº”ä½¿ç”¨ rebaseã€‚\n","description":" ä¸€å¥è¯æ ¸å¿ƒåŒºåˆ« merge ä¿ç•™çœŸå®å†å²ï¼Œrebase é‡å†™æäº¤å†å²ï¼Œè®©å†å²æ›´çº¿æ€§ã€‚\nä¸€ã€merge æ˜¯ä»€ä¹ˆï¼Ÿ æœ¬è´¨ åˆå¹¶ä¸¤ä¸ªåˆ†æ”¯ é€šè¿‡åˆ›å»ºä¸€ä¸ª æ–°çš„ merge commit ä¸ä¿®æ”¹å·²æœ‰æäº¤ ç¤ºæ„å›¾ A---B---C (main) \\ D---E (feature) æ‰§è¡Œï¼š\n"},{"id":231,"href":"/operations/git/best-practices/","title":"Git æœ€ä½³å®è·µ","parent":"Git","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£å®ç”¨ã€ç”Ÿäº§çº§çš„ Git æœ€ä½³å®è·µå¤§å…¨ï¼Œæ¶µç›–å›¢é˜Ÿåä½œã€åˆ†æ”¯ã€Commitã€Tagã€ç‰ˆæœ¬ç®¡ç†ã€å®‰å…¨ã€CI/CD åœºæ™¯ç­‰ã€‚\nâ­ 1. åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ âœ… æ¨èåˆ†æ”¯æ¨¡å‹ï¼ˆé€‚åˆ 90% çš„å›¢é˜Ÿï¼‰ main -\u0026gt; ç”Ÿäº§åˆ†æ”¯ï¼ˆç¨³å®šï¼‰ develop -\u0026gt; å¼€å‘ä¸»åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰ feature/* -\u0026gt; åŠŸèƒ½åˆ†æ”¯ hotfix/* -\u0026gt; ç”Ÿäº§çº§ç´§æ€¥ä¿®å¤ release/* -\u0026gt; å‘ç‰ˆå‰åˆå¹¶åˆ†æ”¯ ç®€åŒ–ç‰ˆï¼ˆé€‚åˆå°å›¢é˜Ÿï¼‰ï¼š\nmain feature/* hotfix/* âœ… è§„åˆ™ main æ°¸è¿œä¿æŒå¯å‘å¸ƒçŠ¶æ€ å¼€å‘äººå‘˜ä¸å…è®¸ç›´æ¥æ¨é€åˆ° main æ‰€æœ‰ä»£ç å¿…é¡»èµ° Pull Request / Merge Request feature/ å®Œæˆååªèƒ½åˆå¹¶å› main æˆ– developï¼ˆç”±æµç¨‹å†³å®šï¼‰* hotfix/ ä¼˜å…ˆåˆå¹¶å› main å’Œ develop* â­ 2. Commit æœ€ä½³å®è·µ Commit è§„èŒƒï¼ˆå¼ºçƒˆæ¨èï¼‰\nä½¿ç”¨ Conventional Commitsï¼š\nfeat: æ–°å¢ç”¨æˆ·æœç´¢åŠŸèƒ½ fix: ä¿®å¤ç™»å½•å¤±è´¥çš„é—®é¢˜ docs: æ›´æ–°å®‰è£…æ–‡æ¡£ style: è°ƒæ•´ä»£ç æ ¼å¼ï¼Œæœªä¿®æ”¹é€»è¾‘ refactor: é‡æ„ç”¨æˆ·æ¨¡å— test: æ–°å¢æ¥å£å•æµ‹ chore: æ›´æ–°ä¾èµ– perf: ä¼˜åŒ– SQL æŸ¥è¯¢é€Ÿåº¦ å¥½å¤„ï¼š\nè‡ªåŠ¨ç”Ÿæˆ CHANGELOG è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰ æ›´å®¹æ˜“ code review CI/CD è‡ªåŠ¨è¯†åˆ«æ˜¯å¦éœ€è¦å‘ç‰ˆ â­ 3. Tag / Release æœ€ä½³å®è·µ è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆSemantic Versioningï¼‰\nMAJOR.MINOR.PATCH 1.4.23 è§„åˆ™ï¼š\nMAJORï¼šé‡å¤§ç ´åæ›´æ–° MINORï¼šæ–°åŠŸèƒ½ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰ PATCHï¼šBug ä¿®å¤ ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ‰“ Tag\ngit tag -a v1.2.0 -m \u0026#34;Release v1.2.0\u0026#34; git push origin v1.2.0 â­ 4. Merge Request æœ€ä½³å®è·µ å¿…é¡» Reviewï¼ˆè‡³å°‘ä¸€äººï¼‰ Review å†…å®¹ï¼š\næ˜¯å¦æœ‰ unit test æ˜¯å¦ç ´å backward compatibility æ˜¯å¦æ»¡è¶³ coding style æ˜¯å¦æœ‰å®‰å…¨é£é™© æ˜¯å¦æœ‰å¿…è¦æ‹†åˆ† commit ç¦æ­¢ç›´æ¥ merge main çš„è§„åˆ™ æ¨èä½¿ç”¨ GitLab/Github çš„ä¿æŠ¤ç­–ç•¥ï¼š\nç¦æ­¢ force push ç¦æ­¢ç›´æ¥ push å¿…é¡»é€šè¿‡ CI æ£€æŸ¥ â­ 5. Git é…ç½®æœ€ä½³å®è·µ å…¨å±€é…ç½®æ”¾åœ¨ ~/.gitconfig é¡¹ç›®é…ç½®æ”¾åœ¨ .git/config\næ¨èçš„å…¨å±€é…ç½® git config --global pull.rebase false git config --global rebase.autoStash true git config --global core.autocrlf input git config --global merge.ff false git config --global fetch.prune true ç¦æ­¢æŠŠ Token å†™å…¥ URL ä½¿ç”¨ï¼š\nSSH key credential helper æŒ‡å®šæ–‡ä»¶ CI/CD variables â­ 6. Git Ignore æœ€ä½³å®è·µ é¡¹ç›®æ ¹ç›®å½•æ·»åŠ  .gitignoreï¼š\nvenv/ node_modules/ *.log *.pyc dist/ .env â­ 7. Rebase vs Merge æœ€ä½³å®è·µ ä½¿ç”¨ merge çš„åœºæ™¯ ä»£ç åˆå…¥ä¸»åˆ†æ”¯ ä¿ç•™å®Œæ•´å†å²è®°å½• ä½¿ç”¨ rebase çš„åœºæ™¯ æœ¬åœ° feature åˆ†æ”¯æ•´ç† commit é¿å…å‡ºç°è¿‡å¤š merge commit æ¨èæµç¨‹ git checkout feature/login git fetch git rebase origin/main fix conflicts... git push --force-with-lease â­ 8. é«˜çº§ Git æœ€ä½³å®è·µï¼ˆç”Ÿäº§è¸©å‘æ€»ç»“ï¼‰ 8.1 æ°¸è¿œä¸è¦ä½¿ç”¨ git push \u0026ndash;force ä½¿ç”¨ï¼š\ngit push --force-with-lease é¿å…è¦†ç›–åˆ«äººæäº¤ã€‚\n8.2 æäº¤å‰å¿…é¡»æ‰§è¡Œ git diff git status 8.3 æ°¸è¿œä¸è¦åœ¨ main ä¸Šåšæœ¬åœ°å¼€å‘ 8.4 å¦‚æœ Token æ³„æ¼ï¼Œç¬¬ä¸€æ—¶é—´æ‰§è¡Œ git filter-repo --replace-text ... git push --force â­ 9. å¤§æ–‡ä»¶å¤„ç†æœ€ä½³å®è·µ å¦‚æœå¿…é¡»æäº¤å¤§æ–‡ä»¶ï¼š\nä½¿ç”¨ Git LFS æˆ–è€…æäº¤ OSS/MinIO åœ°å€ â­ 10. Git Hooks æœ€ä½³å®è·µ ä½¿ç”¨ pre-commitï¼š\npre-commit install æ·»åŠ ï¼š\nè‡ªåŠ¨æ ¼å¼åŒ– è‡ªåŠ¨æ£€æŸ¥é»‘åå•è¯è¯­ è‡ªåŠ¨è¿è¡Œå•æµ‹ ç¦æ­¢è°ƒè¯•ä»£ç ï¼ˆprintã€console.logï¼‰ â­ 11. CI/CD ä¸­çš„ Git æœ€ä½³å®è·µ å…‹éš†ä»“åº“å¿…é¡»åŠ ï¼š\ngit fetch --depth=1 å‡å°‘æ—¶é—´ã€‚\nCI/CD ä¸è¦ä½¿ç”¨å…¨å±€ credential helper\nä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š\nGIT_USERNAME GIT_PASSWORD â­ 12. å¸¸ç”¨ Git å‘½ä»¤æœ€ä½³å®è·µç‰ˆ æŸ¥çœ‹ä¿®æ”¹å†å²\ngit log --oneline --graph --decorate --all å›é€€åˆ°æŸä¸ªç‰ˆæœ¬ï¼ˆä¿ç•™ä¿®æ”¹ï¼‰\ngit reset --soft HEAD~1 å›é€€ï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰\ngit reset --hard HEAD~1 æ£€æŸ¥æ˜¯è°æ”¹äº†è¿™è¡Œä»£ç \ngit blame file.py â­ 13. Git å®‰å…¨æœ€ä½³å®è·µ ç¦æ­¢ä¸Šä¼ å¯†ç ä¸ token\næ·»åŠ  .gitignoreï¼š\n*.env *.pem config.json é¿å…ä½¿ç”¨æ˜æ–‡å¯†ç \nä¼˜å…ˆé¡ºåºï¼š\nSSH key CI/CD Credential Variables ä¸´æ—¶ credential helper æ–‡ä»¶ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£å®ç”¨ã€ç”Ÿäº§çº§çš„ Git æœ€ä½³å®è·µå¤§å…¨ï¼Œæ¶µç›–å›¢é˜Ÿåä½œã€åˆ†æ”¯ã€Commitã€Tagã€ç‰ˆæœ¬ç®¡ç†ã€å®‰å…¨ã€CI/CD åœºæ™¯ç­‰ã€‚\nâ­ 1. åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ âœ… æ¨èåˆ†æ”¯æ¨¡å‹ï¼ˆé€‚åˆ 90% çš„å›¢é˜Ÿï¼‰ main -\u0026gt; ç”Ÿäº§åˆ†æ”¯ï¼ˆç¨³å®šï¼‰ develop -\u0026gt; å¼€å‘ä¸»åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰ feature/* -\u0026gt; åŠŸèƒ½åˆ†æ”¯ hotfix/* -\u0026gt; ç”Ÿäº§çº§ç´§æ€¥ä¿®å¤ release/* -\u0026gt; å‘ç‰ˆå‰åˆå¹¶åˆ†æ”¯ ç®€åŒ–ç‰ˆï¼ˆé€‚åˆå°å›¢é˜Ÿï¼‰ï¼š\nmain feature/* hotfix/* âœ… è§„åˆ™ main æ°¸è¿œä¿æŒå¯å‘å¸ƒçŠ¶æ€ å¼€å‘äººå‘˜ä¸å…è®¸ç›´æ¥æ¨é€åˆ° main æ‰€æœ‰ä»£ç å¿…é¡»èµ° Pull Request / Merge Request feature/ å®Œæˆååªèƒ½åˆå¹¶å› main æˆ– developï¼ˆç”±æµç¨‹å†³å®šï¼‰* hotfix/ ä¼˜å…ˆåˆå¹¶å› main å’Œ develop* â­ 2. Commit æœ€ä½³å®è·µ Commit è§„èŒƒï¼ˆå¼ºçƒˆæ¨èï¼‰\n"},{"id":232,"href":"/operations/gitlab/","title":"GitLab","parent":"Operations","content":"Document List:\nGitLab FAQ GitLab åŸºç¡€æ•™ç¨‹ GitLab æ ¸å¿ƒæ¦‚å¿µ GitLab CI/CD æ•™ç¨‹ GitLab CI/CD æœ€ä½³å®è·µ GitLab Runner æ•™ç¨‹ ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab CE ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab Runner ","description":"Document List:\nGitLab FAQ GitLab åŸºç¡€æ•™ç¨‹ GitLab æ ¸å¿ƒæ¦‚å¿µ GitLab CI/CD æ•™ç¨‹ GitLab CI/CD æœ€ä½³å®è·µ GitLab Runner æ•™ç¨‹ ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab CE ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab Runner "},{"id":233,"href":"/operations/gitlab/ci/","title":"GitLab CI/CD æ•™ç¨‹","parent":"GitLab","content":"ä¸‹é¢æ˜¯ä¸€ä»½ å®Œå…¨ç‰ˆ GitLab CI/CD æ•™ç¨‹ï¼Œè¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€åº•å±‚å·¥ä½œæœºåˆ¶ã€å…³é”®é…ç½®ã€ä¼ä¸šçº§å®è·µã€ä¼˜åŒ–æŠ€å·§ç­‰ã€‚\nğŸ“Œ ç›®å½•\nGitLab CI/CD æ˜¯ä»€ä¹ˆï¼Ÿ CI/CD æ ¸å¿ƒæ¦‚å¿µ .gitlab-ci.yml æ–‡ä»¶ç»“æ„ä¸å…³é”®è¯­æ³• Pipelineï¼ˆæŒç»­é›†æˆæµç¨‹ï¼‰è¯¦è§£ Jobsã€Stagesã€Rules GitLab Runner å·¥ä½œæœºåˆ¶ å¸¸ç”¨ CI æ¨¡å—ï¼ˆcacheã€artifactsã€needsã€variablesï¼‰ ç¯å¢ƒï¼ˆEnvironmentsï¼‰ä¸éƒ¨ç½²ï¼ˆDeploymentsï¼‰ GitLab å†…ç½®æ¨¡æ¿ä¸ include é«˜çº§åŠŸèƒ½ï¼šå¹¶å‘ã€ä¾èµ–ã€æ¡ä»¶æ„å»º Secretsã€é…ç½®ä¸­å¿ƒã€å˜é‡ç®¡ç† CI/CD è¿›é˜¶ä¼˜åŒ–ï¼ˆé€Ÿåº¦ã€ç¼“å­˜ã€é•œåƒï¼‰ ç”Ÿäº§çº§é¡¹ç›®å®Œæ•´ç¤ºä¾‹ å¸¸è§é—®é¢˜æ’æŸ¥ 1. GitLab CI/CD æ˜¯ä»€ä¹ˆï¼Ÿ GitLab CI/CD æ˜¯ GitLab å†…ç½®çš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ç³»ç»Ÿï¼Œç”¨äºï¼š\nä»£ç è‡ªåŠ¨æµ‹è¯• æ„å»ºé•œåƒ/äºŒè¿›åˆ¶ éƒ¨ç½²åˆ°æœåŠ¡å™¨/äº‘/K8S æŒç»­æ£€æŸ¥è´¨é‡ï¼ˆLintã€å®¡è®¡ï¼‰ åªéœ€è¦ä¸€ä¸ªæ–‡ä»¶ .gitlab-ci.yml å°±èƒ½è‡ªåŠ¨æ‰§è¡Œæ•´ä¸ªå·¥ä½œæµç¨‹ã€‚\n2. æ ¸å¿ƒæ¦‚å¿µï¼ˆCI çš„éª¨æ¶ï¼‰ ğŸ“Œ 2.1 Pipelineï¼ˆæµæ°´çº¿ï¼‰ ä¸€æ¬¡ CI æ‰§è¡Œå³ä¸ºä¸€ä¸ª Pipelineï¼Œç”±å¤šä¸ª Job/stage ç»„æˆã€‚\nä¾‹å­ï¼š\nPipeline â”œâ”€â”€ build â”œâ”€â”€ test â””â”€â”€ deploy ğŸ“Œ 2.2 Jobsï¼ˆä»»åŠ¡ï¼‰ æœ€å° CI å•å…ƒï¼Œä¸€ä¸ª job ä»£è¡¨ä¸€æ®µè¦æ‰§è¡Œçš„è„šæœ¬ã€‚\nğŸ“Œ 2.3 Stages Job åˆ†ç»„ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œï¼š\nstages: - build - test - deploy ğŸ“Œ 2.4 Runner GitLab CI çš„æ‰§è¡Œè€…ï¼Œè´Ÿè´£è¿è¡Œ Jobï¼ˆå‰é¢ä½ å·²ç»å­¦è¿‡äº†ï¼‰ã€‚\nRunner æ‰§è¡Œ .gitlab-ci.yml å†…çš„è„šæœ¬ã€‚\nğŸ“Œ 2.5 Artifactsï¼ˆæ„ä»¶ï¼‰ æŸä¸ª job äº§ç”Ÿçš„æ–‡ä»¶ï¼Œå¯è¢«åç»­ job ä¸‹è½½ä½¿ç”¨ã€‚\nğŸ“Œ 2.6 Cacheï¼ˆç¼“å­˜ï¼‰ ç”¨äºåŠ é€Ÿ Pipeline é€Ÿåº¦ï¼Œå¦‚ node_modules/ã€pip ç¼“å­˜ç­‰ã€‚\nğŸ“Œ 2.7 Variablesï¼ˆå˜é‡ï¼‰ CI ç¯å¢ƒå˜é‡ï¼Œç”¨äºé…ç½®æ•æ„Ÿä¿¡æ¯ã€ç¯å¢ƒå‚æ•°ã€‚\n3. .gitlab-ci.yml æ–‡ä»¶ç»“æ„ åŸºç¡€ç»“æ„ç¤ºä¾‹ï¼š\nstages: - build - test - deploy build_job: stage: build script: - npm install - npm run build test_job: stage: test script: - npm test deploy_job: stage: deploy script: - ./deploy.sh only: - main 4. Pipeline å·¥ä½œæµç¨‹ Pipeline æ‰§è¡Œé¡ºåºï¼š\nstages é¡ºåº -\u0026gt; åŒ stage çš„ job å¹¶è¡Œæ‰§è¡Œ -\u0026gt; ä¸‹ä¸€ä¸ª stage æ¯”å¦‚ï¼š\nbuildï¼ˆå¹¶è¡Œï¼‰ testï¼ˆå¹¶è¡Œï¼‰ deployï¼ˆå¹¶è¡Œï¼‰ 5. Jobsã€Stagesã€Rulesï¼ˆé‡ç‚¹ä¸­çš„é‡ç‚¹ï¼‰ 5.1 å®šä¹‰ Job build-job: stage: build script: - go build main.go 5.2 ä½¿ç”¨ rules æ§åˆ¶ job è§¦å‘ æ¯” only/except æ›´å¼ºå¤§çš„æ¡ä»¶åŒ¹é…ç³»ç»Ÿã€‚\nç¤ºä¾‹ï¼šåªåœ¨ main åˆ†æ”¯è¿è¡Œ\ndeploy: stage: deploy script: ./deploy.sh rules: - if: \u0026#39;$CI_COMMIT_BRANCH == \u0026#34;main\u0026#34;\u0026#39; æ›´å¤æ‚ï¼š\nrules: - if: \u0026#39;$CI_PIPELINE_SOURCE == \u0026#34;merge_request_event\u0026#34;\u0026#39; - if: \u0026#39;$CI_COMMIT_BRANCH == \u0026#34;main\u0026#34;\u0026#39; 5.3 needsï¼šçœŸæ­£å®ç°å¹¶è¡Œï¼ˆå¼ºçƒˆæ¨èï¼‰ test: stage: test needs: [\u0026#34;build\u0026#34;] 5.4 whenï¼ˆå¼ºåˆ¶ã€æ‰‹å·¥ï¼‰ when: manual ç”¨äºç”Ÿäº§éƒ¨ç½²ã€‚\n6. GitLab Runner å·¥ä½œæœºåˆ¶ï¼ˆç®€è¿°ï¼‰ æµç¨‹ï¼š\nGitLab è°ƒåº¦ pipeline åŒ¹é… tags -\u0026gt; æ‰¾ Runner Runner æ‹‰å–ä»£ç  æ‰§è¡Œ script äº§ç”Ÿ artifacts ä¸ŠæŠ¥çŠ¶æ€ç»™ GitLab 7. å¸¸ç”¨ CI æ¨¡å—ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 7.1 cache ç¼“å­˜ cache: paths: - node_modules/ 7.2 artifacts æ„ä»¶ artifacts: paths: - dist/ expire_in: 1 week 7.3 variablesï¼ˆå˜é‡ï¼‰ variables: NODE_ENV: production 7.4 before_script / after_script æ•´ä¸ª pipeline é€šç”¨ï¼š\nbefore_script: - echo \u0026#34;start\u0026#34; 8. ç¯å¢ƒï¼ˆEnvironmentï¼‰ä¸è‡ªåŠ¨éƒ¨ç½² å®šä¹‰ç¯å¢ƒï¼š\ndeploy: stage: deploy script: ./deploy.sh environment: name: production url: https://example.com æ”¯æŒï¼š\nè‡ªåŠ¨éƒ¨ç½² å›æ»šï¼ˆrollbackï¼‰ å¤šç¯å¢ƒï¼ˆdev / staging / prodï¼‰ 9. include å¯¼å…¥æ¨¡æ¿ï¼ˆæ¨èï¼‰ ä½ å¯ä»¥æŠŠ CI æ‹†åˆ†æˆå¾ˆå¤šå°æ–‡ä»¶ï¼š\ninclude: - local: \u0026#39;ci/build.yml\u0026#39; - local: \u0026#39;ci/test.yml\u0026#39; - template: \u0026#39;Jobs/Build.gitlab-ci.yml\u0026#39; éå¸¸é€‚åˆå¤§å‹é¡¹ç›®ã€‚\n10. é«˜çº§æ¦‚å¿µï¼šå¼ºå¤§çš„ CI/CD æœºåˆ¶ 10.1 å¤š Runner å¹¶å‘å¤„ç† åˆ©ç”¨ tags åˆ†é…ä¸åŒç±»å‹ä»»åŠ¡ï¼š\nbuild-job: tags: [\u0026#34;docker\u0026#34;] test-job: tags: [\u0026#34;k8s\u0026#34;] 10.2 Matrix æ„å»ºï¼ˆGo / Python å¸¸ç”¨ï¼‰ ä¾‹å¦‚ï¼š\ntest: stage: test parallel: matrix: - GO_VERSION: [\u0026#34;1.20\u0026#34;, \u0026#34;1.21\u0026#34;, \u0026#34;1.22\u0026#34;] 10.3 æ‰‹åŠ¨å®¡æ‰¹ when: manual allow_failure: false 10.4 ä¾èµ–ç¼“å­˜ï¼ˆdependenciesï¼‰ test: dependencies: - build 11. CI/CD å˜é‡ä¸ Secrets ç®¡ç†ï¼ˆéå¸¸é‡è¦ï¼‰ åœ¨ GitLab UI è®¾ç½®ï¼š\nSettings -\u0026gt; CI/CD -\u0026gt; Variables å¸¸è§æ•æ„Ÿä¿¡æ¯ï¼š\nTOKEN SSH_PRIVATE_KEY DOCKER_PASSWORD K8S_CONFIG åœ¨ CI ä¸­ä½¿ç”¨ï¼š\nscript: - echo \u0026#34;$SSH_PRIVATE_KEY\u0026#34; \u0026gt; key.pem 12. CI ä¼˜åŒ–ç­–ç•¥ï¼ˆå®æˆ˜æ€»ç»“ï¼‰ ğŸš€ 12.1 ä¼˜åŒ–é•œåƒ ä½¿ç”¨è¯­è¨€å®˜æ–¹é•œåƒ + cacheï¼š\nimage: python:3.12-slim ğŸš€ 12.2 ç¼“å­˜ node_modules/pip cache: key: ${CI_COMMIT_REF_SLUG} paths: - .cache/pip ğŸš€ 12.3 å¤šç¼“å­˜ç­–ç•¥ï¼ˆæœ¬åœ° + S3ï¼‰ ğŸš€ 12.4 å°½å¯èƒ½ä½¿ç”¨ needs: æ¥å¹¶è¡Œä»»åŠ¡ 13. ç”Ÿäº§çº§ .gitlab-ci.yml ç¤ºä¾‹ï¼ˆæœ€ç»å…¸çš„ç»“æ„ï¼‰ é€‚ç”¨äºçœŸå®ä¼ä¸šé¡¹ç›®ï¼š\nstages: - lint - build - test - docker - deploy variables: APP: myapp lint: stage: lint image: node:20 script: - npm ci - npm run lint build: stage: build image: python:3.12 script: - pip install -r requirements.txt - python build.py artifacts: paths: - build/ test: stage: test image: python:3.12 needs: [\u0026#34;build\u0026#34;] script: - pytest -v docker-build: stage: docker tags: [\u0026#34;docker\u0026#34;] image: docker:24 services: - docker:dind script: - docker build -t registry.example.com/$APP:$CI_COMMIT_SHA . - docker push registry.example.com/$APP:$CI_COMMIT_SHA deploy: stage: deploy tags: [\u0026#34;prod\u0026#34;] when: manual script: - ./deploy_prod.sh è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸è§çš„ CI/CD ç»“æ„ã€‚\n14. å¸¸è§é—®é¢˜æ’æŸ¥ âŒ 1. æ‰¾ä¸åˆ° Runner æ£€æŸ¥ä½ çš„ job æ˜¯å¦è®¾ç½®äº† tags:ã€‚\nâŒ 2. cache ä¸ç”Ÿæ•ˆ å¿…é¡»å­˜åœ¨åŒä¸€ä¸ª Runner æ‰æœ‰æ•ˆã€‚\nâŒ 3. docker build æŠ¥æƒé™é”™è¯¯ éœ€è¦ï¼š\nprivileged = true âŒ 4. .gitlab-ci.yml éªŒè¯å¤±è´¥ æ£€æŸ¥ï¼š\nCI Lint å·¥å…· GitLab è‡ªå¸¦æ£€æŸ¥å·¥å…·éå¸¸å¥½ç”¨ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ å®Œå…¨ç‰ˆ GitLab CI/CD æ•™ç¨‹ï¼Œè¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€åº•å±‚å·¥ä½œæœºåˆ¶ã€å…³é”®é…ç½®ã€ä¼ä¸šçº§å®è·µã€ä¼˜åŒ–æŠ€å·§ç­‰ã€‚\nğŸ“Œ ç›®å½•\nGitLab CI/CD æ˜¯ä»€ä¹ˆï¼Ÿ CI/CD æ ¸å¿ƒæ¦‚å¿µ .gitlab-ci.yml æ–‡ä»¶ç»“æ„ä¸å…³é”®è¯­æ³• Pipelineï¼ˆæŒç»­é›†æˆæµç¨‹ï¼‰è¯¦è§£ Jobsã€Stagesã€Rules GitLab Runner å·¥ä½œæœºåˆ¶ å¸¸ç”¨ CI æ¨¡å—ï¼ˆcacheã€artifactsã€needsã€variablesï¼‰ ç¯å¢ƒï¼ˆEnvironmentsï¼‰ä¸éƒ¨ç½²ï¼ˆDeploymentsï¼‰ GitLab å†…ç½®æ¨¡æ¿ä¸ include é«˜çº§åŠŸèƒ½ï¼šå¹¶å‘ã€ä¾èµ–ã€æ¡ä»¶æ„å»º Secretsã€é…ç½®ä¸­å¿ƒã€å˜é‡ç®¡ç† CI/CD è¿›é˜¶ä¼˜åŒ–ï¼ˆé€Ÿåº¦ã€ç¼“å­˜ã€é•œåƒï¼‰ ç”Ÿäº§çº§é¡¹ç›®å®Œæ•´ç¤ºä¾‹ å¸¸è§é—®é¢˜æ’æŸ¥ 1. GitLab CI/CD æ˜¯ä»€ä¹ˆï¼Ÿ GitLab CI/CD æ˜¯ GitLab å†…ç½®çš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²ç³»ç»Ÿï¼Œç”¨äºï¼š\nä»£ç è‡ªåŠ¨æµ‹è¯• æ„å»ºé•œåƒ/äºŒè¿›åˆ¶ éƒ¨ç½²åˆ°æœåŠ¡å™¨/äº‘/K8S æŒç»­æ£€æŸ¥è´¨é‡ï¼ˆLintã€å®¡è®¡ï¼‰ åªéœ€è¦ä¸€ä¸ªæ–‡ä»¶ .gitlab-ci.yml å°±èƒ½è‡ªåŠ¨æ‰§è¡Œæ•´ä¸ªå·¥ä½œæµç¨‹ã€‚\n2. æ ¸å¿ƒæ¦‚å¿µï¼ˆCI çš„éª¨æ¶ï¼‰ ğŸ“Œ 2.1 Pipelineï¼ˆæµæ°´çº¿ï¼‰ ä¸€æ¬¡ CI æ‰§è¡Œå³ä¸ºä¸€ä¸ª Pipelineï¼Œç”±å¤šä¸ª Job/stage ç»„æˆã€‚\n"},{"id":234,"href":"/operations/gitlab/ci-best-practices/","title":"GitLab CI/CD æœ€ä½³å®è·µ","parent":"GitLab","content":" 1. Pipeline è®¾è®¡æœ€ä½³å®è·µï¼ˆæ ¸å¿ƒï¼‰ 1.1 ä½¿ç”¨ Stage æ„å»ºæ ‡å‡† CI/CD æµæ°´çº¿ç»“æ„ æ¨èæ ‡å‡†ä¸‰æ®µå¼ï¼š\nstages: - lint - test - build - deploy ç†ç”±ï¼š\nlinters æå‰å¤±è´¥ -\u0026gt; èŠ‚çœ Runner èµ„æº å•å…ƒæµ‹è¯•é€šè¿‡åæ‰å…è®¸æ‰“åŒ… æœ€åæ‰è§¦å‘éƒ¨ç½² 1.2 ä¸€ä¸ª Job åšâ€œä¸€ç±»äº‹â€ï¼Œä¿æŒæœ€å°èŒè´£ âŒ åä¾‹ï¼šåœ¨åŒä¸€ä¸ª job é‡Œ lint + test + build âœ… æ¨èï¼šæ¯ä¸ª job ç‹¬ç«‹ï¼Œå¦‚ lint, unit_test, build_image 1.3 Job è¦å¯é‡å¤æ‰§è¡Œï¼ˆå¹‚ç­‰ï¼‰ é¿å…ï¼š\nä¿®æ”¹æœ¬åœ°çŠ¶æ€ å†™å…¥å…±äº«ç›®å½• ä¾èµ–ä¸Šä¸€æ¬¡æ„å»º 1.4 æ‰€æœ‰æ„å»ºä¾èµ–å¿…é¡»å†™å…¥ image æˆ– before_script ç¡®ä¿ Runnerã€æœºå™¨å·®å¼‚ä¸ä¼šå½±å“æ„å»ºï¼š\nimage: python:3.12 before_script: - pip install -r requirements.txt 1.5 ä½¿ç”¨ Cache åŠ é€Ÿ å…¸å‹ç”¨æ³•ï¼š\ncache: paths: - .cache/pip/ ä¸è¦ç¼“å­˜ build äº§ç‰©ï¼ˆartifact é€‚åˆè¿™ä¸ªåœºæ™¯ï¼‰ã€‚\n2. GitLab CI YAML æœ€ä½³å®è·µ 2.1 ä½¿ç”¨ YAML Anchors å‡å°‘é‡å¤ .default_job: \u0026amp;default_job tags: [docker] retry: 2 before_script: - pip install -r requirements.txt test: \u0026lt;\u0026lt;: *default_job script: - pytest å¥½å¤„ï¼š\nâœ¨ ç»“æ„æ›´å¹²å‡€ âœ¨ æ‰¹é‡ä¿®æ”¹æˆæœ¬ä½ 2.2 ä½¿ç”¨ rules æ›¿ä»£ only/except rules å¯ç²¾ç¡®æ§åˆ¶é€»è¾‘ï¼š\ndeploy_prod: stage: deploy rules: - if: \u0026#39;$CI_COMMIT_BRANCH == \u0026#34;main\u0026#34;\u0026#39; - when: manual æ¯” only: [main] æ›´çµæ´»ï¼ˆå¯åŠ æ¡ä»¶ï¼‰ã€‚\n2.3 ä½¿ç”¨ needs å¯ç”¨å¹¶è¡Œæµæ°´çº¿ï¼ˆå¤§å¹…æå‡é€Ÿåº¦ï¼‰ unit_test: stage: test lint: stage: test build: stage: build needs: [\u0026#34;unit_test\u0026#34;, \u0026#34;lint\u0026#34;] å¥½å¤„ï¼š\ntest å’Œ lint å¹¶è¡Œ åªæœ‰ test + lint æˆåŠŸæ‰ build 2.4 ä½¿ç”¨ artifacts ä¼ é€’æ„å»ºäº§ç‰© build: stage: build script: - npm run build artifacts: paths: - dist/ ä¸è¦æ»¥ç”¨ artifactï¼Œå¦åˆ™ CI ä¼šå˜æ…¢ã€‚\n2.5 å¯¹å¤–éƒ¨ä¾èµ–ç»Ÿä¸€ä½¿ç”¨ environment å˜é‡ ä¸è¦æŠŠ tokenã€å¯†ç å†™è¿› YAMLã€‚\n3. å®‰å…¨æœ€ä½³å®è·µ 3.1 æ‰€æœ‰æ•æ„Ÿä¿¡æ¯å¿…é¡»ç”¨ GitLab CI Variables ç®¡ç† å¦‚ï¼š\nAWS_KEY K8S_TOKEN PROD_DB_PASSWORD ä¸è¦å†™åœ¨ä»£ç é‡Œ\nä¸è¦æ”¾åœ¨ artifact ä¸­\n3.2 é™åˆ¶ Runner æƒé™ï¼ˆä¸è¦ç”¨ root runnerï¼‰ éƒ¨ç½²ç”¨ç‹¬ç«‹ Runner æ„å»ºç”¨æ™®é€š Runner é¿å…ä¸€ä¸ª job çš„å®‰å…¨é—®é¢˜å½±å“å…¶ä»– job 3.3 åœ¨ Deploy ä½¿ç”¨ Manual + Protected åˆ†æ”¯ deploy_prod: when: manual environment: name: production rules: - if: \u0026#39;$CI_COMMIT_BRANCH == \u0026#34;main\u0026#34;\u0026#39; åªå…è®¸ Maintainer è§¦å‘ã€‚\n4. æ€§èƒ½æœ€ä½³å®è·µ 4.1 å°½é‡ä½¿ç”¨ Docker Runnerï¼ˆshell runner å°½é‡ä¸ç”¨ï¼‰ Docker runner éš”ç¦»å¼ºã€å®‰å…¨ã€å¯æ§ã€‚\n4.2 ç”¨ Cache ä¼˜åŒ–ä¾èµ–å®‰è£… å¦‚ Python/Node/Go éƒ½å¯ä»¥ç¼“å­˜ä¾èµ–ã€‚\n4.3 æ‹†åˆ† Job å’Œ Stage åŠ é€Ÿæ‰§è¡Œ æ¯”ä¸€ä¸ªè¶…çº§å¤§ Job æ›´å¿«ä¸”æ›´ç¨³å®šã€‚\n5. å¯ç»´æŠ¤æ€§æœ€ä½³å®è·µ 5.1 æ‰€æœ‰ CI é…ç½®å†™å…¥ .gitlab-ci.yml + å•ç‹¬æ‹†æˆå¤šä¸ªæ–‡ä»¶ ä¸»æ–‡ä»¶ï¼š\ninclude: - local: \u0026#34;.gitlab/ci/lint.yml\u0026#34; - local: \u0026#34;.gitlab/ci/docker.yml\u0026#34; - local: \u0026#34;.gitlab/ci/deploy.yml\u0026#34; æ–¹ä¾¿ç®¡ç†å¤§å‹ CI é¡¹ç›®ã€‚\n5.2 æ·»åŠ æè¿°ï¼ˆdescriptionï¼‰ï¼Œè®© CI æ›´æ˜“è¯» build: stage: build description: \u0026#34;æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°ä»“åº“\u0026#34; 5.3 ç»™ Job æ·»åŠ  retry ç½‘ç»œæ³¢åŠ¨ã€å¶å‘å¤±è´¥å¸¸è§ã€‚\nretry: 2 6. è´¨é‡æ§åˆ¶æœ€ä½³å®è·µ 6.1 Lint æ°¸è¿œæ”¾åœ¨ç¬¬ä¸€é˜¶æ®µ Python -\u0026gt; flake8 / black JS -\u0026gt; eslint Go -\u0026gt; go fmt é‡åˆ°é—®é¢˜ç«‹å³ fail çœèµ„æºã€‚\n6.2 å•å…ƒæµ‹è¯•å¿…é¡»è¦†ç›–æ ¸å¿ƒé€»è¾‘å¹¶ç”ŸæˆæŠ¥å‘Š ä½¿ç”¨ coverage å·¥å…·ï¼š\ncoverage: \u0026#39;/^TOTAL.+?(\\d+\\%)$/\u0026#39; 6.3 éƒ¨ç½²å‰å¿…é¡»æ„å»º + æµ‹è¯•æˆåŠŸï¼ˆä¸è¦å…è®¸è·³è¿‡ï¼‰ 7. éƒ¨ç½²æœ€ä½³å®è·µï¼ˆK8S / Docker / Serverï¼‰ 7.1 ç¯å¢ƒé…ç½®å†™ Environmentï¼Œè€Œä¸æ˜¯ hardcode environment: name: staging url: https://staging.example.com 7.2 éƒ¨ç½²å¿…é¡»ä½¿ç”¨ artifacts æˆ–å¼•ç”¨é•œåƒ ä¸è¦åœ¨ Runner ä¸Š build å†éƒ¨ç½²ï¼ˆä¸ç¨³å®šï¼‰ã€‚\n8. è§¦å‘å™¨æœ€ä½³å®è·µ 8.1 ä½¿ç”¨ schedule åšå®šæ—¶ä»»åŠ¡ å¦‚è‡ªåŠ¨æ„å»ºé•œåƒã€å®šæ—¶å¤‡ä»½ç­‰ã€‚\n8.2 ä½¿ç”¨ trigger æ„å»ºå­é¡¹ç›® å¾®æœåŠ¡é¡¹ç›®éå¸¸å¸¸è§ï¼š\ntrigger: project: group/subproject branch: main 9. Anti-Patternï¼ˆç¦æ­¢å‡ºç°ï¼‰ åæ¨¡å¼ é£é™© job é‡Œå†™å¤šä¸ªèŒè´£ ä¸å¯ç»´æŠ¤ï¼Œéš¾æ’é”™ ä¸ä½¿ç”¨ cache CI è¶…æ…¢ ä½¿ç”¨ shell runner ä¸å®‰å…¨ é‡å¤æ‹·è´ job ä»£ç  æ— æ³•ç»´æŠ¤ æŠŠå¯†ç å†™è¿› .gitlab-ci.yml å®‰å…¨ç¾éš¾ éšæ„ä½¿ç”¨ artifact CI å˜æ…¢ï¼Œå­˜å‚¨è†¨èƒ€ éƒ¨ç½² job è‡ªåŠ¨æ‰§è¡Œ è¯¯è§¦ç”Ÿäº§ç¯å¢ƒ ğŸ“Œ é™„ï¼šæœ€ä½³å®è·µæ¨¡æ¿ï¼ˆå¯ç›´æ¥ç”¨ï¼‰ stages: - lint - test - build - deploy .default: \u0026amp;default tags: [docker] retry: 2 lint: \u0026lt;\u0026lt;: *default stage: lint script: - npm run lint test: \u0026lt;\u0026lt;: *default stage: test needs: [\u0026#34;lint\u0026#34;] script: - npm run test build: \u0026lt;\u0026lt;: *default stage: build needs: [\u0026#34;test\u0026#34;] script: - npm run build artifacts: paths: - dist/ deploy_prod: \u0026lt;\u0026lt;: *default stage: deploy needs: [\u0026#34;build\u0026#34;] when: manual environment: name: production script: - ./deploy.sh ","description":" 1. Pipeline è®¾è®¡æœ€ä½³å®è·µï¼ˆæ ¸å¿ƒï¼‰ 1.1 ä½¿ç”¨ Stage æ„å»ºæ ‡å‡† CI/CD æµæ°´çº¿ç»“æ„ æ¨èæ ‡å‡†ä¸‰æ®µå¼ï¼š\nstages: - lint - test - build - deploy ç†ç”±ï¼š\nlinters æå‰å¤±è´¥ -\u0026gt; èŠ‚çœ Runner èµ„æº å•å…ƒæµ‹è¯•é€šè¿‡åæ‰å…è®¸æ‰“åŒ… æœ€åæ‰è§¦å‘éƒ¨ç½² 1.2 ä¸€ä¸ª Job åšâ€œä¸€ç±»äº‹â€ï¼Œä¿æŒæœ€å°èŒè´£ âŒ åä¾‹ï¼šåœ¨åŒä¸€ä¸ª job é‡Œ lint + test + build âœ… æ¨èï¼šæ¯ä¸ª job ç‹¬ç«‹ï¼Œå¦‚ lint, unit_test, build_image 1.3 Job è¦å¯é‡å¤æ‰§è¡Œï¼ˆå¹‚ç­‰ï¼‰ é¿å…ï¼š\n"},{"id":235,"href":"/operations/gitlab/runner/","title":"GitLab Runner æ•™ç¨‹","parent":"GitLab","content":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€æ·±å…¥ä¸”å®æˆ˜çº§çš„ GitLab Runner æ•™ç¨‹ï¼Œè¦†ç›–ï¼š\næ ¸å¿ƒæ¦‚å¿µ æ¶æ„åŸç† å®‰è£…ä¸æ³¨å†Œ å¸¸ç”¨ Executorï¼ˆDockerã€Shellã€Kubernetesï¼‰å…¨è®²è§£ é…ç½®æ–‡ä»¶è¯¦è§£ï¼ˆconfig.tomlï¼‰ Runner æ ‡ç­¾ä¸è°ƒåº¦ é«˜çº§åŠŸèƒ½ï¼ˆCacheã€Artifactsã€å¹¶å‘ã€é™æµã€é•œåƒåŠ é€Ÿï¼‰ ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆï¼ˆDockerã€K8Sã€ç”Ÿäº§æ¶æ„ï¼‰ æœ€ä½³å®è·µ å¸¸è§é—®é¢˜æ’æŸ¥ ç›®å½•\nGitLab Runner æ˜¯ä»€ä¹ˆï¼Ÿ Runner çš„å·¥ä½œåŸç† Runner åˆ†ç±»ï¼šShared / Group / Project Runner å®‰è£…ï¼ˆLinuxã€Dockerã€K8Sï¼‰ Runner æ³¨å†Œä¸é…ç½® Executor ç±»å‹è¯¦è§£ config.toml é…ç½®è¯¦è§£ ç¼“å­˜ cache ä¸ artifacts Runner é«˜çº§èƒ½åŠ›ï¼ˆå¹¶å‘ã€é™æµã€éš”ç¦»ã€å®‰å…¨ï¼‰ ä¼ä¸šçº§éƒ¨ç½²ï¼ˆå…¨ Dockerã€K8Sï¼‰ æœ€ä½³å®è·µ å¸¸è§æ•…éšœæ’æŸ¥ 1. GitLab Runner æ˜¯ä»€ä¹ˆï¼Ÿ GitLab Runner æ˜¯ä¸€ä¸ª ç‹¬ç«‹äº GitLab çš„ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä¸“é—¨ç”¨æ¥æ‰§è¡Œ .gitlab-ci.yml ä¸­çš„ jobã€‚\nå®ƒè´Ÿè´£ï¼š\næ‹‰å–ä»£ç  æ‰§è¡Œ CI/CD è„šæœ¬ ä¸Šä¼  artifacts æä¾›æ—¥å¿— æ‰§è¡Œéƒ¨ç½² Runner å®é™…æ˜¯ä¸€ä¸ª Agentï¼Œç”± GitLab è°ƒåº¦ã€‚\n2. Runner çš„å·¥ä½œåŸç† æµç¨‹ï¼š\nGitLab CI -\u0026gt; è°ƒåº¦ job -\u0026gt; åˆ†é…ç»™ Runner -\u0026gt; Runner æ‰§è¡Œ -\u0026gt; ä¸Šä¼ ç»“æœ -\u0026gt; Pipeline å®Œæˆ æ›´è¯¦ç»†æ­¥éª¤ï¼š\n.gitlab-ci.yml ç”Ÿæˆ Pipeline GitLab è°ƒåº¦å™¨è°ƒåº¦ job Job ä¸æ ‡ç­¾ï¼ˆtagsï¼‰åŒ¹é… æ‰¾åˆ°åˆé€‚ Runnerï¼ˆå¯ç”¨çŠ¶æ€ï¼‰ Runner æ‹‰å–ä»£ç  æ‰§è¡Œè„šæœ¬ ä¸Šä¼  artifacts / cache ä¸ŠæŠ¥ç»“æœ pipeline ç»§ç»­ä¸‹ä¸€ä¸ª stage 3. Runner åˆ†ç±»ï¼šShared / Group / Project ç±»å‹ ç”¨é€” Shared Runnerï¼ˆå…±äº« Runnerï¼‰ æ•´ä¸ª GitLab å®ä¾‹éƒ½èƒ½ä½¿ç”¨ï¼ˆæ¨èï¼‰ Group Runner ä¸€ä¸ª group ä¸­çš„æ‰€æœ‰é¡¹ç›®å…±äº« Project Runner åªç»™å•ä¸ªé¡¹ç›®ä½¿ç”¨ ä¼ä¸šå¼ºçƒˆå»ºè®®ï¼šä½¿ç”¨ Shared Runner + æ ‡ç­¾ï¼ˆtagsï¼‰åŒºåˆ†ç¯å¢ƒ\n4. GitLab Runner å®‰è£… 4.1 Linux å®‰è£… curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash sudo apt install gitlab-runner æ£€æŸ¥ï¼š\ngitlab-runner --version 4.2 Docker æ–¹å¼å®‰è£…ï¼ˆæ¨èï¼‰ docker run -d --name gitlab-runner --restart always \\ -v /srv/gitlab-runner/config:/etc/gitlab-runner \\ -v /var/run/docker.sock:/var/run/docker.sock \\ gitlab/gitlab-runner:latest ä¼˜ç‚¹ï¼šç»´æŠ¤æˆæœ¬æœ€ä½ï¼Œæ‰©å®¹ç®€å•ã€‚\n4.3 Kubernetes æ–¹å¼å®‰è£…ï¼ˆä¼ä¸šçº§ï¼‰ Helm Chartï¼š\nhelm repo add gitlab https://charts.gitlab.io helm install gitlab-runner gitlab/gitlab-runner -n gitlab æ­¤æ–¹å¼é€‚ç”¨äºï¼š\nå¤§è§„æ¨¡ Runner é›†ç¾¤ å¤§é‡å¹¶å‘ Pipeline åŠ¨æ€ Pod æ‰§è¡Œ job 5. Runner æ³¨å†Œ å‘½ä»¤ï¼š\ngitlab-runner register æµç¨‹ï¼š\nGitLab URL -\u0026gt; Runner Token -\u0026gt; æè¿° -\u0026gt; æ ‡ç­¾(tags) -\u0026gt; executor -\u0026gt; ä¿å­˜ ç¤ºä¾‹ï¼š\ngitlab-runner register \\ --url \u0026#34;https://gitlab.example.com/\u0026#34; \\ --registration-token \u0026#34;PROJECT_TOKEN\u0026#34; \\ --executor \u0026#34;docker\u0026#34; \\ --description \u0026#34;docker-runner-1\u0026#34; \\ --tag-list \u0026#34;docker,prod,build\u0026#34; \\ --docker-image \u0026#34;alpine:latest\u0026#34; 6. Executor ç±»å‹è¯¦è§£ Runner æ‰§è¡Œ job çš„æ–¹å¼å« Executorã€‚\nGitLab æ”¯æŒï¼š\nExecutor åº”ç”¨åœºæ™¯ æ˜¯å¦æ¨è shell æœ¬æœºæ‰§è¡Œï¼Œæ— éš”ç¦» âŒ ä¸å®‰å…¨ docker å•æœºæœ€å¸¸ç”¨ï¼Œéš”ç¦»è‰¯å¥½ï¼Œé€Ÿåº¦å¿« âœ… æ¨è docker+machine è‡ªåŠ¨æ‰©å®¹ Runner âœ… å¤§è§„æ¨¡æ¨è kubernetes Pod çº§éš”ç¦»ï¼Œæœ€ä½³å¼¹æ€§ â­ ä¼ä¸šçº§æ¨è ssh è¿åˆ°è¿œç¨‹æœºå™¨æ‰§è¡Œ è¾ƒå°‘ä½¿ç”¨ virtualbox ä¸“ä¸šæ„å»ºæœº è¾ƒå°‘ä½¿ç”¨ 6.1 Shell Executorï¼ˆä¸æ¨èï¼‰ ç›´æ¥åœ¨ä¸»æœºæ‰§è¡Œï¼š\nexecutor = \u0026#34;shell\u0026#34; ç¼ºç‚¹ï¼š\næ— éš”ç¦» æ˜“æ±¡æŸ“ç¯å¢ƒ å®‰å…¨é£é™©å¤§ 6.2 Docker Executorï¼ˆæœ€å¸¸ç”¨ï¼‰ executor = \u0026#34;docker\u0026#34; [runners.docker] image = \u0026#34;alpine:latest\u0026#34; privileged = true volumes = [\u0026#34;/cache\u0026#34;, \u0026#34;/var/run/docker.sock:/var/run/docker.sock\u0026#34;] privileged æ¨¡å¼ç”¨äºï¼šCI é‡Œéœ€è¦ docker build çš„æƒ…å†µï¼ˆDocker in Dockerï¼‰\n6.3 Kubernetes Executorï¼ˆä¼ä¸šçº§ï¼‰ ç‰¹ç‚¹ï¼š\næ¯ä¸ª job è‡ªåŠ¨åˆ›å»º Pod Pod å¯ä»¥è‡ªå®šä¹‰é•œåƒ æœ€é€‚åˆå¤§è§„æ¨¡ CI é›†ç¾¤ é…ç½®ç¤ºä¾‹ï¼š\nexecutor = \u0026#34;kubernetes\u0026#34; [runners.kubernetes] image = \u0026#34;alpine:latest\u0026#34; namespace = \u0026#34;ci\u0026#34; privileged = true poll_timeout = 1800 7. config.toml é…ç½®è¯¦è§£ æ–‡ä»¶ä½ç½®ï¼š\n/etc/gitlab-runner/config.toml æ ¸å¿ƒå­—æ®µè¯´æ˜ï¼š\nconcurrent = 10 # runner å¹¶å‘æ•° check_interval = 0 [[runners]] name = \u0026#34;docker-runner\u0026#34; url = \u0026#34;https://gitlab.example.com\u0026#34; token = \u0026#34;xxx\u0026#34; executor = \u0026#34;docker\u0026#34; [runners.docker] image = \u0026#34;alpine:latest\u0026#34; privileged = true volumes = [\u0026#34;/cache\u0026#34;] 7.1 å¹¶å‘ï¼ˆé‡è¦ï¼‰ concurrent = 10 æ„å‘³ç€ Runner å¯ä»¥åŒæ—¶æ‰§è¡Œ 10 ä¸ª jobã€‚\nå•æœºä¸è¦è®¾ç½®å¤ªå¤§ï¼Œå¦åˆ™ä¼šæ‰“çˆ† CPUã€‚\n7.2 tags åŒ¹é…ï¼ˆæ ¸å¿ƒè°ƒåº¦æœºåˆ¶ï¼‰ åœ¨ .gitlab-ci.yml ä¸­ï¼š\nbuild-job: tags: - docker Runnerï¼š\ntags = [\u0026#34;docker\u0026#34;,\u0026#34;build\u0026#34;] åŒ¹é…åæ‰ä¼šæ‰§è¡Œã€‚\ntags ç”¨æ¥åŒºåˆ†ï¼š\nè¯­è¨€ç¯å¢ƒï¼ˆpython / go / nodeï¼‰ ç¯å¢ƒï¼ˆdev / prodï¼‰ æ‰§è¡Œæ–¹å¼ï¼ˆdocker / k8sï¼‰ 8. ç¼“å­˜ cache ä¸ artifacts cacheï¼ˆè·¨ job ç¼“å­˜ï¼‰ ç”¨äºåŠ é€Ÿæ„å»ºï¼Œä¾‹å¦‚ node_modulesã€pip cacheï¼š\ncache: paths: - node_modules/ Runner ä¼šæŠŠç¼“å­˜æ”¾åˆ°ï¼š\n/cache artifactsï¼ˆæ„å»ºäº§ç‰©ï¼‰ ä¾‹å¦‚æ„å»ºå‡ºæ¥çš„åŒ…ã€äºŒè¿›åˆ¶ï¼š\nartifacts: paths: - build/ expire_in: 7 days 9. Runner é«˜çº§èƒ½åŠ› 9.1 å¹¶å‘ä¸é™æµ config.toml è®¾ç½®ï¼š\nconcurrent = 10 å• Runner é™åˆ¶ï¼š\nlimit = 3 9.2 ç¦ç”¨ç‰¹å®šé¡¹ç›®æ‰§è¡Œ allowed_projects = [\u0026#34;group/project\u0026#34;] 9.3 ä½¿ç”¨è‡ªå®šä¹‰ Docker é•œåƒä»“åº“ pull_policy = \u0026#34;if-not-present\u0026#34; 9.4 è‡ªåŠ¨æ¸…ç†å®¹å™¨ï¼ˆDocker executorï¼‰ disable_cache = false 10. ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ 10.1 å¤š Runner æ¶æ„ GitLab â”‚ â”œâ”€â”€ Docker Runnerï¼ˆæ„å»ºï¼‰ â”œâ”€â”€ Docker Runnerï¼ˆæµ‹è¯•ï¼‰ â”œâ”€â”€ Kubernetes Runnerï¼ˆåŠ¨æ€æ‰©å®¹ï¼Œå¤§é‡ Pipelineï¼‰ â””â”€â”€ Shell Runnerï¼ˆå†…ç½‘éƒ¨ç½²ï¼‰ 10.2 Docker in Dockerï¼ˆDinDï¼‰ ç”¨äºéœ€è¦æ„å»ºé•œåƒçš„é¡¹ç›®ï¼š\nservices: - docker:dind variables: DOCKER_DRIVER: overlay2 10.3 Kubernetes åŠ¨æ€æ‰©ç¼©å®¹ Runner ä¼ä¸šçº§ç‰¹ç‚¹ï¼š\næ¯ä¸ª job ä¸€ä¸ª Pod è‡ªåŠ¨æ‰©å®¹ è‡ªåŠ¨å›æ”¶èµ„æº æœ€ç¨³å®šï¼ˆæ— æ±¡æŸ“ç¯å¢ƒï¼‰ 11. æœ€ä½³å®è·µ å¼€å‘ç¯å¢ƒ æ™®é€š Docker Runner å³å¯ pool 2C/4G -\u0026gt; å¹¶å‘ 2 ä¼ä¸šç¯å¢ƒ Docker Executorï¼ˆæ„å»ºæœºï¼‰ Kubernetes Executorï¼ˆå¤§è§„æ¨¡ CIï¼‰ Runner é•œåƒæ”¾åœ¨æœ¬åœ° Harbor é•œåƒä»“åº“ artifacts ç¼“å­˜æ”¾åˆ° S3ï¼ˆMinIO / AWSï¼‰ .gitlab-ci.yml æœ€ä½³å®è·µ æ¯ä¸ª job å¿…é¡»å†™ tags åˆ†çº§ Stageï¼šLint -\u0026gt; Build -\u0026gt; Test -\u0026gt; Deploy ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ manual 12. å¸¸è§æ•…éšœæ’æŸ¥ â‘  Runner offline æ£€æŸ¥ï¼š\ngitlab-runner status gitlab-runner verify â‘¡ Docker é‡Œ CI ä¸èƒ½è®¿é—® Docker ç¼ºå°‘ï¼š\n-v /var/run/docker.sock:/var/run/docker.sock â‘¢ â€œno matching runnerâ€ åŸå› ï¼š\njob æ²¡æœ‰æ ‡ç­¾ runner æ ‡ç­¾ä¸åŒ¹é… runner ç¦ç”¨äº†æœ¬é¡¹ç›® â‘£ Cache ä¸ç”Ÿæ•ˆ å¯èƒ½åŸå› ï¼š\nè·¯å¾„å†™é”™ Worker æ¸…ç†æœºåˆ¶ ç¼“å­˜å¤ªå¤§ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ è¶…å®Œæ•´ã€æ·±å…¥ä¸”å®æˆ˜çº§çš„ GitLab Runner æ•™ç¨‹ï¼Œè¦†ç›–ï¼š\næ ¸å¿ƒæ¦‚å¿µ æ¶æ„åŸç† å®‰è£…ä¸æ³¨å†Œ å¸¸ç”¨ Executorï¼ˆDockerã€Shellã€Kubernetesï¼‰å…¨è®²è§£ é…ç½®æ–‡ä»¶è¯¦è§£ï¼ˆconfig.tomlï¼‰ Runner æ ‡ç­¾ä¸è°ƒåº¦ é«˜çº§åŠŸèƒ½ï¼ˆCacheã€Artifactsã€å¹¶å‘ã€é™æµã€é•œåƒåŠ é€Ÿï¼‰ ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆï¼ˆDockerã€K8Sã€ç”Ÿäº§æ¶æ„ï¼‰ æœ€ä½³å®è·µ å¸¸è§é—®é¢˜æ’æŸ¥ ç›®å½•\nGitLab Runner æ˜¯ä»€ä¹ˆï¼Ÿ Runner çš„å·¥ä½œåŸç† Runner åˆ†ç±»ï¼šShared / Group / Project Runner å®‰è£…ï¼ˆLinuxã€Dockerã€K8Sï¼‰ Runner æ³¨å†Œä¸é…ç½® Executor ç±»å‹è¯¦è§£ config.toml é…ç½®è¯¦è§£ ç¼“å­˜ cache ä¸ artifacts Runner é«˜çº§èƒ½åŠ›ï¼ˆå¹¶å‘ã€é™æµã€éš”ç¦»ã€å®‰å…¨ï¼‰ ä¼ä¸šçº§éƒ¨ç½²ï¼ˆå…¨ Dockerã€K8Sï¼‰ æœ€ä½³å®è·µ å¸¸è§æ•…éšœæ’æŸ¥ 1. GitLab Runner æ˜¯ä»€ä¹ˆï¼Ÿ GitLab Runner æ˜¯ä¸€ä¸ª ç‹¬ç«‹äº GitLab çš„ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä¸“é—¨ç”¨æ¥æ‰§è¡Œ .gitlab-ci.yml ä¸­çš„ jobã€‚\n"},{"id":236,"href":"/frontend/html/","title":"HTML","parent":"Frontend","content":"Document List:\n","description":"Document List:\n"},{"id":237,"href":"/operations/troubleshooting/slow-http-requests/","title":"HTTPè¯·æ±‚ç¼“æ…¢","parent":"Troubleshooting","content":"æ•…éšœç°è±¡ï¼šå‰ç«¯æ•°æ®å±•ç¤ºå¾ˆæ…¢ï¼Œè¯·æ±‚åç«¯æ¥å£å»¶è¿Ÿå¾ˆé«˜ï¼Œåç«¯è®¿é—®æ•°æ®åº“å¾ˆæ…¢\nç½‘ç»œçŠ¶å†µï¼šVPNã€K8S\nè§£å†³æ–¹æ³•ï¼š\nå‰ç«¯è®¿é—®åç«¯èµ°çš„VPNç½‘ç»œï¼Œä¿®æ”¹è¯·æ±‚ç½‘ç»œï¼Œè®©è¯·æ±‚èµ°å†…ç½‘ åç«¯è®¿é—®æ•°æ®åº“ï¼Œèµ°K8Så†…éƒ¨ç½‘ç»œ æ’æŸ¥æ€è·¯ï¼š\nå…ˆç†æ¸…æ•°æ®æµï¼š\nå‰ç«¯ -\u0026gt; åç«¯ -\u0026gt; æ•°æ®åº“\næ’æŸ¥é¡ºåºï¼šæ•°æ®åº“ï¼Œåç«¯ï¼Œå‰ç«¯\næ•°æ®åº“\nSQL æ‰§è¡Œé€Ÿåº¦æ˜¯å¦æ…¢ï¼Ÿ CPUæ˜¯å¦è·‘æ»¡ï¼Ÿ å†…å­˜æ˜¯å¦å……è¶³ï¼Ÿ ç¡¬ç›˜IOæ˜¯å¦å¼€é”€å¾ˆå¤§ï¼Ÿ æ•°æ®åº“è¡¨æ˜¯å¦å¾ˆå¤§ï¼Ÿ æŸ¥è¯¢è¯­å¥æ˜¯å¦å¾ˆå¤æ‚ï¼Ÿ æœ‰æ²¡æœ‰ç´¢å¼•ï¼Ÿ CPUï¼Œå†…å­˜ï¼Œç¡¬ç›˜æ²¡é—®é¢˜çš„è¯ï¼Œå°±æ˜¯æŸ¥è¯¢è¯­å¥çš„é—®é¢˜äº†ã€‚\nåç«¯\nå¦‚æœæ•°æ®åº“å±‚é¢æ²¡æœ‰é—®é¢˜ï¼Œåç«¯ç›¸å…³çš„æ¥å£å“åº”å¾ˆæ…¢ï¼Œæœ‰å¯èƒ½æ˜¯åç«¯è¿æ¥æ•°æ®åº“çš„ç½‘ç»œæœ‰é—®é¢˜ã€‚ å¦‚æœèµ°äº†VPNï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯å› ä¸ºVPNçš„ç½‘ç»œå»¶è¿Ÿé—®é¢˜ å¦‚æœåº”ç”¨å’Œæ•°æ®åº“éƒ½éƒ¨ç½²åœ¨ K8S å†…éƒ¨ï¼Œé‚£ä¹ˆè¿æ¥ä½¿ç”¨K8Så†…éƒ¨ç½‘ç»œã€‚ ","description":"æ•…éšœç°è±¡ï¼šå‰ç«¯æ•°æ®å±•ç¤ºå¾ˆæ…¢ï¼Œè¯·æ±‚åç«¯æ¥å£å»¶è¿Ÿå¾ˆé«˜ï¼Œåç«¯è®¿é—®æ•°æ®åº“å¾ˆæ…¢\nç½‘ç»œçŠ¶å†µï¼šVPNã€K8S\nè§£å†³æ–¹æ³•ï¼š\nå‰ç«¯è®¿é—®åç«¯èµ°çš„VPNç½‘ç»œï¼Œä¿®æ”¹è¯·æ±‚ç½‘ç»œï¼Œè®©è¯·æ±‚èµ°å†…ç½‘ åç«¯è®¿é—®æ•°æ®åº“ï¼Œèµ°K8Så†…éƒ¨ç½‘ç»œ æ’æŸ¥æ€è·¯ï¼š\nå…ˆç†æ¸…æ•°æ®æµï¼š\nå‰ç«¯ -\u0026gt; åç«¯ -\u0026gt; æ•°æ®åº“\næ’æŸ¥é¡ºåºï¼šæ•°æ®åº“ï¼Œåç«¯ï¼Œå‰ç«¯\næ•°æ®åº“\nSQL æ‰§è¡Œé€Ÿåº¦æ˜¯å¦æ…¢ï¼Ÿ CPUæ˜¯å¦è·‘æ»¡ï¼Ÿ å†…å­˜æ˜¯å¦å……è¶³ï¼Ÿ ç¡¬ç›˜IOæ˜¯å¦å¼€é”€å¾ˆå¤§ï¼Ÿ æ•°æ®åº“è¡¨æ˜¯å¦å¾ˆå¤§ï¼Ÿ æŸ¥è¯¢è¯­å¥æ˜¯å¦å¾ˆå¤æ‚ï¼Ÿ æœ‰æ²¡æœ‰ç´¢å¼•ï¼Ÿ CPUï¼Œå†…å­˜ï¼Œç¡¬ç›˜æ²¡é—®é¢˜çš„è¯ï¼Œå°±æ˜¯æŸ¥è¯¢è¯­å¥çš„é—®é¢˜äº†ã€‚\nåç«¯\nå¦‚æœæ•°æ®åº“å±‚é¢æ²¡æœ‰é—®é¢˜ï¼Œåç«¯ç›¸å…³çš„æ¥å£å“åº”å¾ˆæ…¢ï¼Œæœ‰å¯èƒ½æ˜¯åç«¯è¿æ¥æ•°æ®åº“çš„ç½‘ç»œæœ‰é—®é¢˜ã€‚ å¦‚æœèµ°äº†VPNï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯å› ä¸ºVPNçš„ç½‘ç»œå»¶è¿Ÿé—®é¢˜ å¦‚æœåº”ç”¨å’Œæ•°æ®åº“éƒ½éƒ¨ç½²åœ¨ K8S å†…éƒ¨ï¼Œé‚£ä¹ˆè¿æ¥ä½¿ç”¨K8Så†…éƒ¨ç½‘ç»œã€‚ "},{"id":238,"href":"/backend/python/official/if/","title":"If (æ¡ä»¶åˆ¤æ–­)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/reference/compound_stmts.html\nğŸŸ¦ Python ifï¼šåŸºç¡€è¯­æ³• if condition: ... elif condition2: ... else: ... 1ï¸âƒ£ åŸºç¡€ç”¨æ³•ç¤ºä¾‹ x = 10 if x \u0026gt; 5: print(\u0026#34;å¤§äº 5\u0026#34;) elif x == 5: print(\u0026#34;ç­‰äº 5\u0026#34;) else: print(\u0026#34;å°äº 5\u0026#34;) 2ï¸âƒ£ Python ç‰¹æœ‰çš„å››ç§â€œçœŸå‡å€¼â€åˆ¤æ–­ Python ä¸­ä»¥ä¸‹å€¼ä¸º Falseï¼š\n0 \u0026ldquo;\u0026quot;ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ []ï¼ˆç©ºåˆ—è¡¨ï¼‰ {}ï¼ˆç©ºå­—å…¸ï¼‰ set() None False Decimal(0) 0.0 ç¤ºä¾‹ï¼š\nif []: print(\u0026#34;ä¸ä¼šæ‰§è¡Œ\u0026#34;) 3ï¸âƒ£ å•è¡Œ if å•è¡Œå†™æ³•ï¼š\nif condition: print(\u0026#34;yes\u0026#34;) æˆ–è€…è¡¨è¾¾å¼å†™æ³•ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰ï¼š\nresult = \u0026#34;yes\u0026#34; if x \u0026gt; 1 else \u0026#34;no\u0026#34; 4ï¸âƒ£ å¤šæ¡ä»¶å†™æ³• â‘  and / or if a \u0026gt; 0 and b \u0026lt; 10: ... â‘¡ in / not inï¼ˆå¸¸ç”¨ï¼‰ if ext in [\u0026#34;jpg\u0026#34;, \u0026#34;png\u0026#34;, \u0026#34;gif\u0026#34;]: ... â‘¢ é“¾å¼æ¯”è¾ƒï¼ˆPython ç‹¬æœ‰ï¼‰ if 0 \u0026lt; x \u0026lt; 10: ... 5ï¸âƒ£ Pythonic å†™æ³•ï¼ˆæœ€æ¨èï¼‰ ä½¿ç”¨â€œçœŸå€¼åˆ¤æ–­â€\nname = input(\u0026#34;name:\u0026#34;) if name: print(\u0026#34;æœ‰æ•ˆåå­—\u0026#34;) åœ¨å¸¸é‡å·¦ä¾§æ¯”è¾ƒï¼ˆé¿å…æ‹¼å†™é”™è¯¯ï¼‰\nif \u0026#34;admin\u0026#34; == role: # æ¨è ... é¿å…ï¼š\nif role = \u0026#34;admin\u0026#34;: # é”™è¯¯ 6ï¸âƒ£ ä½¿ç”¨ match-caseï¼ˆPython 3.10+ï¼‰ æ¯”å¤šåˆ†æ”¯ if-elif æ›´ä¼˜é›…ï¼š\nmatch status: case 200: print(\u0026#34;OK\u0026#34;) case 404: print(\u0026#34;Not Found\u0026#34;) case _: print(\u0026#34;Unknown\u0026#34;) 7ï¸âƒ£ if å’Œå¼‚å¸¸å¤„ç†é…åˆ if not isinstance(x, int): raise TypeError(\u0026#34;x must be int\u0026#34;) å·¥ç¨‹ä»£ç å¸¸ç”¨è¿™ç§æ¨¡å¼ã€‚\n8ï¸âƒ£ if ç»“åˆåˆ—è¡¨æ¨å¯¼å¼ è¿‡æ»¤ï¼š\nnumbers = [1, 2, 3, 4] even = [n for n in numbers if n % 2 == 0] 9ï¸âƒ£ if ç»“åˆ any / allï¼ˆå¼ºçƒˆæ¨èï¼‰ åœ¨å¤æ‚æ¡ä»¶åˆ¤æ–­ä¸­éå¸¸å¼ºå¤§ï¼š\nif any(ext in filename for ext in [\u0026#34;.jpg\u0026#34;, \u0026#34;.png\u0026#34;]): ... if all(x \u0026gt; 0 for x in nums): ... ğŸ”Ÿ if çš„ç‰¹æ®Šå€¼åˆ¤æ–­ is åˆ¤æ–­å¯¹è±¡ï¼ˆNone / True / Falseï¼‰\nif value is None: ... == åˆ¤æ–­å†…å®¹\nif a == b: ... 1ï¸âƒ£1ï¸âƒ£ if å¸¸è§é”™è¯¯ âŒ ç”¨ = ä»£æ›¿ ==\nâŒ åˆ¤æ–­ç©ºå€¼ç”¨ == \u0026quot;\u0026rdquo;\næ­£ç¡®å†™æ³•ï¼š\nif not s: ... âŒ ä¸æ³¨æ„ç¼©è¿›\nPython çš„ if/else å—å¿…é¡»ç¼©è¿› 4 ç©ºæ ¼ã€‚\n1ï¸âƒ£2ï¸âƒ£ é«˜çº§ï¼šif çš„çŸ­è·¯é€»è¾‘ x and y x or y ç¤ºä¾‹ï¼ˆé˜²æ­¢ Noneï¼‰ï¼š\nif user and user.is_active: ... 1ï¸âƒ£3ï¸âƒ£ if æœ€ä½³å®è·µï¼ˆå·¥ç¨‹çº§ï¼‰ æ¡ä»¶è¶ŠçŸ­è¶Šå¥½ å¸¸é‡æ”¾å·¦è¾¹æ¯”è¾ƒï¼šif 200 == status å°†å¤æ‚æ¡ä»¶æ‹†æˆå‡½æ•° å°½é‡é¿å…æ·±å±‚åµŒå¥—ï¼ˆæ—©è¿”å›æ¨¡å¼ï¼‰ ç¤ºä¾‹ï¼š\ndef process(data): if not data: return None if not validate(data): return None return save(data) ğŸ† é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰ åŠŸèƒ½ å†™æ³• åŸºæœ¬åˆ†æ”¯ if / elif / else å•è¡Œ if if x: print(x) ä¸‰å…ƒè¡¨è¾¾å¼ a if cond else b é“¾å¼æ¯”è¾ƒ 0 \u0026lt; x \u0026lt; 10 å¤šæ¡ä»¶ and / or / not åˆ¤æ–­é›†åˆ in / not in åˆ¤ç©º if not x: åˆ¤ None if x is None: æ¨¡å¼åŒ¹é… match-case å¤šæ¡ä»¶è¿‡æ»¤ any() / all() ","description":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/reference/compound_stmts.html\nğŸŸ¦ Python ifï¼šåŸºç¡€è¯­æ³• if condition: ... elif condition2: ... else: ... 1ï¸âƒ£ åŸºç¡€ç”¨æ³•ç¤ºä¾‹ x = 10 if x \u0026gt; 5: print(\u0026#34;å¤§äº 5\u0026#34;) elif x == 5: print(\u0026#34;ç­‰äº 5\u0026#34;) else: print(\u0026#34;å°äº 5\u0026#34;) 2ï¸âƒ£ Python ç‰¹æœ‰çš„å››ç§â€œçœŸå‡å€¼â€åˆ¤æ–­ Python ä¸­ä»¥ä¸‹å€¼ä¸º Falseï¼š\n"},{"id":239,"href":"/backend/python/sqlalchemy/insert/","title":"Insert","parent":"SQLAlchemy","content":" bulk_insert_mappings vs add_all SQLAlchemy çš„ bulk_insert_mappings ç”¨äºé«˜æ•ˆæ‰¹é‡æ’å…¥å­—å…¸æ•°æ®ï¼ˆé ORM å¯¹è±¡ï¼‰ï¼Œç›´æ¥æ‰§è¡Œ SQLï¼Œä¸è§¦å‘ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›è€Œ add_all ç”¨äºæ‰¹é‡æ·»åŠ  ORM æ¨¡å‹å®ä¾‹ï¼Œä¼šå‚ä¸ Session ç®¡ç†ã€è§¦å‘äº‹ä»¶å’Œè¿›è¡Œå¯¹è±¡çŠ¶æ€è·Ÿè¸ªã€‚ä¸»è¦åŒºåˆ«åœ¨äºæ“ä½œå¯¹è±¡ç±»å‹ã€æ˜¯å¦è§¦å‘ORMäº‹ä»¶åŠæ€§èƒ½ã€‚\nç‰¹æ€§ bulk_insert_mappings(mapper, mappings) session.add_all(instances) æ“ä½œå¯¹è±¡ å­—å…¸åˆ—è¡¨ (Mappings) ORM æ¨¡å‹å®ä¾‹åˆ—è¡¨ (Instances) æ‰§è¡Œæ–¹å¼ ç”Ÿæˆé«˜æ•ˆçš„å•æ¡ INSERT (æ‰¹é‡æ’å…¥ SQL)ï¼Œé€šå¸¸ä¸åˆ·æ–° Session é€ä¸ªå°†å¯¹è±¡åŠ å…¥ Sessionï¼Œä¾èµ– session.commit() è§¦å‘ INSERT ORMäº‹ä»¶ ä¸è§¦å‘ before_insert, after_insert ç­‰ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ è§¦å‘æ‰€æœ‰ç›¸å…³çš„ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚ before_insertï¼‰ æ€§èƒ½ éå¸¸å¿«ï¼Œé€‚åˆå¤§æ•°æ®é‡ã€ä»…éœ€æ•°æ®åº“å±‚é¢çš„æ’å…¥ è¾ƒæ…¢ï¼Œä½†æä¾›å®Œæ•´çš„ ORM åŠŸèƒ½å’ŒçŠ¶æ€ç®¡ç† è¿”å›å†…å®¹ æ— ï¼ˆæˆ–åªè¿”å›ä¸»é”®ï¼Œå–å†³äºæ•°æ®åº“/é©±åŠ¨ï¼Œä½†é€šå¸¸ä¸ç®¡ç†å¯¹è±¡çŠ¶æ€ï¼‰ å¯¹è±¡ä¼šè¢«æŒä¹…åŒ–ï¼ŒSession ä¼šè·Ÿè¸ªå®ƒä»¬çš„çŠ¶æ€ å¸¸ç”¨åœºæ™¯ æ•°æ®è¿ç§»ã€å¤§é‡åŸå§‹æ•°æ®å¿«é€Ÿå…¥åº“ï¼ˆä»…æ•°æ®åº“æ“ä½œï¼‰ åˆ›å»º/æ›´æ–°ä¸šåŠ¡æ•°æ®ï¼Œéœ€è¦åˆ©ç”¨ ORM ç‰¹æ€§ï¼ˆå…³ç³»ã€äº‹ä»¶ã€å˜æ›´è¿½è¸ªï¼‰ ç®€è¨€ä¹‹: bulk_insert_mappings æ˜¯ æ•°æ®åº“çº§åˆ«çš„æ‰¹é‡å¯¼å…¥ï¼Œè€Œ add_all æ˜¯ORM çº§åˆ«çš„æ‰¹é‡æ·»åŠ ã€‚\næ‰¹é‡æ’å…¥ï¼Œsession.bulk_insert_mappings æ€§èƒ½æœ€é«˜ï¼ˆç»•è¿‡ ORM äº‹ä»¶ï¼‰ï¼Œé€‚åˆè¶…å¤§æ•°æ®é‡ï¼ˆ10ä¸‡+ï¼‰ï¼›add_all æ€§èƒ½æœ€ä½ä½†æœ€ç¬¦åˆå®Œæ•´ ORM æµç¨‹ï¼ˆè§¦å‘æ‰€æœ‰äº‹ä»¶ï¼‰ï¼Œé€‚åˆå°æ‰¹é‡æ•°æ®æˆ–éœ€è¦å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„åœºæ™¯ï¼›åº”æ ¹æ®æ•°æ®é‡å’Œéœ€æ±‚ï¼ˆæ˜¯å¦éœ€è¦è§¦å‘ORMäº‹ä»¶ï¼‰é€‰æ‹©ã€‚\né€‰æ‹©æŒ‡å—ï¼š\nsession.bulk_insert_mappings() (æœ€é«˜æ€§èƒ½ï¼Œæ— ORMäº‹ä»¶)\né€‚ç”¨åœºæ™¯: æµ·é‡æ•°æ®ï¼ˆ10ä¸‡æ¡ä»¥ä¸Šï¼‰ã€çº¯æ•°æ®å¯¼å…¥ã€è¿½æ±‚æè‡´æ€§èƒ½ä¸”ä¸éœ€è¦ORMé’©å­ï¼ˆå¦‚ before_insertï¼‰æ—¶ã€‚ ä¼˜ç‚¹: é€Ÿåº¦æœ€å¿«ï¼Œå› ä¸ºç»•è¿‡äº† SQLAlchemy çš„ ORM çŠ¶æ€ç®¡ç†å’Œäº‹ä»¶ç³»ç»Ÿã€‚ ç¼ºç‚¹: ä¸ä¼šè§¦å‘ MapperEventsï¼ˆå¦‚ before_insertã€after_insertï¼‰å’Œå±æ€§ç›‘å¬å™¨ã€‚ session.add_all() (å®Œæ•´ORMï¼Œæ€§èƒ½æœ€ä½)\né€‚ç”¨åœºæ™¯: å°æ‰¹é‡æ•°æ®ï¼ˆ1ä¸‡æ¡ä»¥ä¸‹ï¼‰ã€éœ€è¦å®Œæ•´ ORM ç”Ÿå‘½å‘¨æœŸå’Œäº‹ä»¶è§¦å‘ï¼ˆä¾‹å¦‚è‡ªåŠ¨ç”ŸæˆIDã€å®¡è®¡æ—¥å¿—ç­‰ï¼‰ã€‚ ä¼˜ç‚¹: ä¿ç•™å®Œæ•´çš„ ORM åŠŸèƒ½ï¼Œä»£ç ç®€æ´ã€‚ ç¼ºç‚¹: æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œå¯¹äºå¤§é‡æ•°æ®å¯èƒ½è¾ƒæ…¢ã€‚ æ€»ç»“æ¯”è¾ƒè¡¨ï¼š\nç‰¹æ€§ session.bulk_insert_mappings session.add_all() æ€§èƒ½ æœ€é«˜ (ç»•è¿‡ORM) æœ€ä½ (å®Œæ•´ORM) ORMäº‹ä»¶ ä¸è§¦å‘ è§¦å‘æ‰€æœ‰ (å¦‚ before_insert) é€‚ç”¨æ•°æ®é‡ 10ä¸‡+ å°æ‰¹é‡ (\u0026lt;1ä¸‡) æ•°æ®æ ¼å¼ å­—å…¸åˆ—è¡¨ (Mapping) ORM æ¨¡å‹å¯¹è±¡åˆ—è¡¨ ","description":" bulk_insert_mappings vs add_all SQLAlchemy çš„ bulk_insert_mappings ç”¨äºé«˜æ•ˆæ‰¹é‡æ’å…¥å­—å…¸æ•°æ®ï¼ˆé ORM å¯¹è±¡ï¼‰ï¼Œç›´æ¥æ‰§è¡Œ SQLï¼Œä¸è§¦å‘ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›è€Œ add_all ç”¨äºæ‰¹é‡æ·»åŠ  ORM æ¨¡å‹å®ä¾‹ï¼Œä¼šå‚ä¸ Session ç®¡ç†ã€è§¦å‘äº‹ä»¶å’Œè¿›è¡Œå¯¹è±¡çŠ¶æ€è·Ÿè¸ªã€‚ä¸»è¦åŒºåˆ«åœ¨äºæ“ä½œå¯¹è±¡ç±»å‹ã€æ˜¯å¦è§¦å‘ORMäº‹ä»¶åŠæ€§èƒ½ã€‚\nç‰¹æ€§ bulk_insert_mappings(mapper, mappings) session.add_all(instances) æ“ä½œå¯¹è±¡ å­—å…¸åˆ—è¡¨ (Mappings) ORM æ¨¡å‹å®ä¾‹åˆ—è¡¨ (Instances) æ‰§è¡Œæ–¹å¼ ç”Ÿæˆé«˜æ•ˆçš„å•æ¡ INSERT (æ‰¹é‡æ’å…¥ SQL)ï¼Œé€šå¸¸ä¸åˆ·æ–° Session é€ä¸ªå°†å¯¹è±¡åŠ å…¥ Sessionï¼Œä¾èµ– session.commit() è§¦å‘ INSERT ORMäº‹ä»¶ ä¸è§¦å‘ before_insert, after_insert ç­‰ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ è§¦å‘æ‰€æœ‰ç›¸å…³çš„ ORM ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚ before_insertï¼‰ æ€§èƒ½ éå¸¸å¿«ï¼Œé€‚åˆå¤§æ•°æ®é‡ã€ä»…éœ€æ•°æ®åº“å±‚é¢çš„æ’å…¥ è¾ƒæ…¢ï¼Œä½†æä¾›å®Œæ•´çš„ ORM åŠŸèƒ½å’ŒçŠ¶æ€ç®¡ç† è¿”å›å†…å®¹ æ— ï¼ˆæˆ–åªè¿”å›ä¸»é”®ï¼Œå–å†³äºæ•°æ®åº“/é©±åŠ¨ï¼Œä½†é€šå¸¸ä¸ç®¡ç†å¯¹è±¡çŠ¶æ€ï¼‰ å¯¹è±¡ä¼šè¢«æŒä¹…åŒ–ï¼ŒSession ä¼šè·Ÿè¸ªå®ƒä»¬çš„çŠ¶æ€ å¸¸ç”¨åœºæ™¯ æ•°æ®è¿ç§»ã€å¤§é‡åŸå§‹æ•°æ®å¿«é€Ÿå…¥åº“ï¼ˆä»…æ•°æ®åº“æ“ä½œï¼‰ åˆ›å»º/æ›´æ–°ä¸šåŠ¡æ•°æ®ï¼Œéœ€è¦åˆ©ç”¨ ORM ç‰¹æ€§ï¼ˆå…³ç³»ã€äº‹ä»¶ã€å˜æ›´è¿½è¸ªï¼‰ ç®€è¨€ä¹‹: bulk_insert_mappings æ˜¯ æ•°æ®åº“çº§åˆ«çš„æ‰¹é‡å¯¼å…¥ï¼Œè€Œ add_all æ˜¯ORM çº§åˆ«çš„æ‰¹é‡æ·»åŠ ã€‚\n"},{"id":240,"href":"/operations/ipvs/","title":"IPVS","parent":"Operations","content":"Document List:\nIPVS åŸºç¡€æ•™ç¨‹ ","description":"Document List:\nIPVS åŸºç¡€æ•™ç¨‹ "},{"id":241,"href":"/operations/linux/irqbalance/","title":"irqbalance","parent":"Linux","content":" ä¸€ã€irqbalance æ˜¯ä»€ä¹ˆ irqbalance æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨è°ƒæ•´â€œä¸­æ–­äº²å’Œæ€§ï¼ˆIRQ affinityï¼‰â€çš„ç”¨æˆ·æ€å®ˆæŠ¤è¿›ç¨‹ã€‚\nå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š\nå°†ç¡¬ä»¶ä¸­æ–­åˆç†åˆ†é…åˆ°å¤šä¸ª CPU æ ¸å¿ƒä¸Šï¼Œé¿å…ä¸­æ–­é›†ä¸­åœ¨å•ä¸€ CPUï¼Œæå‡æ•´ä½“æ€§èƒ½ä¸ç¨³å®šæ€§ã€‚\näºŒã€ä¸ºä»€ä¹ˆéœ€è¦ irqbalance 1. ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼ˆIRQï¼‰ ä¸­æ–­ï¼ˆInterrupt Requestï¼ŒIRQï¼‰ æ˜¯ç¡¬ä»¶å‘ CPU å‘å‡ºçš„å³æ—¶é€šçŸ¥ï¼Œä¾‹å¦‚ï¼š\nç½‘å¡æ”¶åˆ°æ•°æ®åŒ… ç£ç›˜ I/O å®Œæˆ å®šæ—¶å™¨è§¦å‘ ç¡¬ä»¶é”™è¯¯ å½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼š\nCPU æš‚åœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡ è¿›å…¥å†…æ ¸æ€ æ‰§è¡Œå¯¹åº”çš„ ä¸­æ–­å¤„ç†å‡½æ•° 2. ä¸­æ–­äº²å’Œæ€§ï¼ˆIRQ Affinityï¼‰ ä¸­æ–­äº²å’Œæ€§ æŒ‡çš„æ˜¯ï¼š\næŸä¸ªä¸­æ–­åªèƒ½ç”±å“ªäº› CPU æ ¸å¿ƒæ¥å¤„ç†\nåœ¨ Linux ä¸­ï¼š\næ¯ä¸ª IRQ éƒ½æœ‰ä¸€ä¸ª smp_affinity ä½æ©ç  å†³å®šè¯¥ IRQ å¯åœ¨å“ªäº› CPU ä¸Šè¿è¡Œ æŸ¥çœ‹æ–¹å¼ï¼š\ncat /proc/interrupts cat /proc/irq/IRQç¼–å·/smp_affinity 3. æ²¡æœ‰ irqbalance ä¼šå‘ç”Ÿä»€ä¹ˆ åœ¨å¾ˆå¤šç³»ç»Ÿä¸­ï¼ˆå°¤å…¶æ˜¯æœåŠ¡å™¨ã€è™šæ‹Ÿæœºã€åŒè·¯ NUMAï¼‰ï¼š\nç½‘å¡ä¸­æ–­é›†ä¸­åœ¨ CPU0 CPU0 è½¯ä¸­æ–­ï¼ˆsoftirqï¼‰å ç”¨æé«˜ å…¶ä»– CPU ç©ºé—² å…¸å‹é—®é¢˜ï¼š\nç½‘ç»œååä¸‹é™ å»¶è¿Ÿå‡é«˜ CPU ä½¿ç”¨ç‡ä¸å‡è¡¡ æ•°æ®åº“ã€ç½‘ç»œæœåŠ¡æ€§èƒ½ä¸ç¨³å®š ä¸‰ã€irqbalance çš„å·¥ä½œåŸç† 1. æ•´ä½“æµç¨‹ irqbalance å‘¨æœŸæ€§æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š\nè¯»å–ç³»ç»Ÿä¸­æ‰€æœ‰ IRQ åˆ†æï¼š ä¸­æ–­é¢‘ç‡ CPU è´Ÿè½½ NUMA æ‹“æ‰‘ è®¡ç®—æ›´ä¼˜çš„ä¸­æ–­åˆ†é…æ–¹æ¡ˆ åŠ¨æ€è°ƒæ•´æ¯ä¸ª IRQ çš„ smp_affinity 2. æ ¸å¿ƒå†³ç­–ä¾æ® irqbalance ä¸»è¦è€ƒè™‘ï¼š\nCPU æ ¸å¿ƒæ•°é‡ CPU å½“å‰è´Ÿè½½ ä¸­æ–­è§¦å‘é¢‘ç‡ NUMA èŠ‚ç‚¹äº²å’Œæ€§ æ˜¯å¦ä¸º MSI/MSI-X ä¸­æ–­ 3. NUMA æ„ŸçŸ¥ åœ¨ NUMA ç³»ç»Ÿä¸­ï¼š\nä¼˜å…ˆå°†è®¾å¤‡ä¸­æ–­ç»‘å®šåˆ° æœ¬åœ° NUMA èŠ‚ç‚¹çš„ CPU å‡å°‘è·¨ NUMA å†…å­˜è®¿é—® æå‡ç¼“å­˜å‘½ä¸­ç‡ å››ã€irqbalance é€‚åˆçš„åœºæ™¯ å¼ºçƒˆå»ºè®®å¼€å¯ å¤šæ ¸æœåŠ¡å™¨ åŒè·¯ / å¤šè·¯ NUMA æœåŠ¡å™¨ é«˜é€Ÿç½‘å¡ï¼ˆ10G / 25G / 100Gï¼‰ è™šæ‹ŸåŒ–å®¿ä¸»æœº å®¹å™¨å®¿ä¸»æœº ä¸å»ºè®®å¼€å¯çš„åœºæ™¯ å®æ—¶ç³»ç»Ÿ\néœ€è¦ä¸¥æ ¼ã€å¯é¢„æµ‹çš„ä¸­æ–­å»¶è¿Ÿ æ•°æ®åº“æˆ–ç½‘ç»œæœåŠ¡å·²æ‰‹åŠ¨ç»‘å®šä¸­æ–­\näººå·¥æŒ‡å®š IRQ -\u0026gt; CPU é«˜æ€§èƒ½è°ƒä¼˜åœºæ™¯\næ˜ç¡®çŸ¥é“æ¯ä¸ªä¸­æ–­åº”è¯¥è·‘åœ¨å“ªä¸ª CPU ä¸Š äº”ã€irqbalance çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ è‡ªåŠ¨åŒ– å¼€ç®±å³ç”¨ å‡å°‘ CPU çƒ­ç‚¹ æ”¹å–„ç½‘ç»œå’Œ I/O æ€§èƒ½ å¯¹ NUMA å‹å¥½ ç¼ºç‚¹ è¡Œä¸ºä¸å¯å®Œå…¨é¢„æµ‹ å¯èƒ½æ‰“ä¹±äººå·¥ä¼˜åŒ–çš„ IRQ ç»‘å®š å¯¹æç«¯ä½å»¶è¿Ÿåœºæ™¯ä¸å‹å¥½ å…­ã€irqbalance å¸¸ç”¨æ“ä½œ 1. æŸ¥çœ‹çŠ¶æ€ systemctl status irqbalance 2. å¯åŠ¨ / åœæ­¢ systemctl enable --now irqbalance systemctl disable --now irqbalance 3. æŸ¥çœ‹å½“å‰ä¸­æ–­åˆ†å¸ƒ cat /proc/interrupts å…³æ³¨ï¼š\nå•ä¸ª IRQ æ˜¯å¦é›†ä¸­åœ¨æŸä¸€ä¸ª CPU ç½‘å¡ç›¸å…³ IRQ æ˜¯å¦åˆ†æ•£ ä¸ƒã€irqbalance ä¸æ‰‹åŠ¨ IRQ ç»‘å®šçš„å…³ç³» æ‰‹åŠ¨ç»‘å®šæ–¹å¼ echo 4 \u0026gt; /proc/irq/IRQç¼–å·/smp_affinity å«ä¹‰ï¼š\nå°†ä¸­æ–­ç»‘å®šåˆ° CPU2ï¼ˆä½æ©ç ï¼‰ å†²çªè§„åˆ™ï¼ˆé‡è¦ï¼‰ irqbalance ä¼šè¦†ç›–ä½ æ‰‹åŠ¨è®¾ç½®çš„ä¸­æ–­äº²å’Œæ€§\nå¦‚æœä½ éœ€è¦æ‰‹åŠ¨æ§åˆ¶ï¼š\nå¿…é¡»åœæ­¢ irqbalance æˆ–åœ¨ irqbalance é…ç½®ä¸­æ’é™¤æŒ‡å®š IRQ å…«ã€irqbalance é…ç½®æ–‡ä»¶ é…ç½®æ–‡ä»¶è·¯å¾„ /etc/sysconfig/irqbalance å¸¸è§é…ç½®é¡¹ IRQBALANCE_BANNED_CPUS=00000001 å«ä¹‰ï¼š\nç¦æ­¢å°†ä¸­æ–­åˆ†é…åˆ° CPU0\nå¸¸ç”¨äºï¼š\nCPU0 ä¸“é—¨è·‘ç³»ç»Ÿä»»åŠ¡ å…¶å®ƒ CPU è·‘ä¸šåŠ¡è´Ÿè½½ ä¹ã€irqbalance ä¸æ€§èƒ½è°ƒä¼˜çš„å…³ç³» ç½‘ç»œæ€§èƒ½ é¿å…ç½‘å¡ä¸­æ–­å †ç§¯ å‡å°‘è½¯ä¸­æ–­å»¶è¿Ÿ æå‡ PPS å’Œåå æ•°æ®åº“æ€§èƒ½ å‡å°‘ CPU æŠ¢å  æå‡ I/O ç¨³å®šæ€§ é™ä½å°¾å»¶è¿Ÿï¼ˆtail latencyï¼‰ åã€æ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ ä¸€å¥è¯æ€»ç»“ irqbalance çš„æœ¬è´¨æ˜¯ï¼šè‡ªåŠ¨ç®¡ç†ä¸­æ–­äº²å’Œæ€§ï¼Œè®©ä¸­æ–­â€œå¹³å‡ä¸”åˆç†â€åœ°è·‘åœ¨å¤šä¸ª CPU ä¸Šã€‚\nä½¿ç”¨å»ºè®® åœºæ™¯ å»ºè®® æ™®é€šæœåŠ¡å™¨ å¼€å¯ NUMA æœåŠ¡å™¨ å¼€å¯ äººå·¥ IRQ è°ƒä¼˜ å…³é—­ å®æ—¶ç³»ç»Ÿ å…³é—­ ","description":" ä¸€ã€irqbalance æ˜¯ä»€ä¹ˆ irqbalance æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨è°ƒæ•´â€œä¸­æ–­äº²å’Œæ€§ï¼ˆIRQ affinityï¼‰â€çš„ç”¨æˆ·æ€å®ˆæŠ¤è¿›ç¨‹ã€‚\nå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š\nå°†ç¡¬ä»¶ä¸­æ–­åˆç†åˆ†é…åˆ°å¤šä¸ª CPU æ ¸å¿ƒä¸Šï¼Œé¿å…ä¸­æ–­é›†ä¸­åœ¨å•ä¸€ CPUï¼Œæå‡æ•´ä½“æ€§èƒ½ä¸ç¨³å®šæ€§ã€‚\näºŒã€ä¸ºä»€ä¹ˆéœ€è¦ irqbalance 1. ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼ˆIRQï¼‰ ä¸­æ–­ï¼ˆInterrupt Requestï¼ŒIRQï¼‰ æ˜¯ç¡¬ä»¶å‘ CPU å‘å‡ºçš„å³æ—¶é€šçŸ¥ï¼Œä¾‹å¦‚ï¼š\n"},{"id":242,"href":"/management/beyond/it-learning-system/","title":"IT æŠ€èƒ½å­¦ä¹ ç³»ç»Ÿ","parent":"Beyond","content":"å¯ç”¨äº IT è¿ç»´ã€å¼€å‘ã€æ•°æ®åº“ã€K8Sã€ç½‘ç»œã€ä»»ä½•æŠ€æœ¯é¢†åŸŸã€‚\nğŸ§­ å­¦ä¹ ä¸€ä¸ªæ–°æŠ€èƒ½ï¼Œåº”è¯¥å­¦ä¹ ä»€ä¹ˆï¼Ÿ åˆ†ä¸º æ¦‚å¿µ -\u0026gt; èƒ½åŠ› -\u0026gt; å®æˆ˜ -\u0026gt; è¿›é˜¶ -\u0026gt; æˆ˜ç•¥ äº”ä¸ªå±‚çº§ã€‚\nâ‘  åŸºç¡€å±‚ï¼šç†è§£ä¸å…¥é—¨ 1. æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®º åŸºç¡€æ•™ç¨‹ åŸºæœ¬åŸç† æœ¯è¯­è§£é‡Š åº•å±‚æœºåˆ¶ï¼ˆå¦‚ä½ å–œæ¬¢çš„â€œåº•å±‚åŸç†â€ï¼‰ ğŸ‘‰ æ²¡åŸºç¡€ï¼Œä¸€åˆ‡æ— ä»è°ˆèµ·\nâ‘¡ åº”ç”¨å±‚ï¼šèƒ½ä½¿ç”¨ã€èƒ½è¿ç»´ 2. å®‰è£…éƒ¨ç½² \u0026amp; ç¯å¢ƒæ­å»º å•æœºå®‰è£… å¤šèŠ‚ç‚¹éƒ¨ç½² é…ç½®æ–‡ä»¶è¯¦è§£ ç›®å½•ç»“æ„è§£æ 3. è¿ç»´ç®¡ç† æ—¥å¸¸ç»´æŠ¤ æœåŠ¡å¯åœ å‚æ•°è°ƒæ•´ å®‰å…¨åŠ å›º â‘¢ æ€§èƒ½å±‚ï¼šèƒ½ä¼˜åŒ–ã€èƒ½ç¨³å®š 4. æ€§èƒ½ä¼˜åŒ– è°ƒä¼˜å‚æ•° æ¶æ„ä¼˜åŒ– èµ„æºä¼˜åŒ– å¸¸è§ç“¶é¢ˆ 5. æ•…éšœæ’æŸ¥ é—®é¢˜å®šä½æ€è·¯ å¸¸è§æ•…éšœ å·¥å…·ä½¿ç”¨ åº”æ€¥å¤„ç†æµç¨‹ â‘£ å®æˆ˜å±‚ï¼šèƒ½æ•´åˆã€èƒ½åä½œ 6. å®æˆ˜æ¡ˆä¾‹ / åœºæ™¯åŒ–å­¦ä¹  çœŸå®ä¸šåŠ¡æ¡ˆä¾‹ çº¿ä¸Šäº‹æ•…æ¡ˆä¾‹åˆ†æ åœºæ™¯æ¨¡æ‹Ÿï¼ˆå‹æµ‹ã€é™æµã€æµé‡çªå¢ï¼‰ 7. ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ ä¸æ•°æ®åº“é›†æˆ ä¸ç¼“å­˜é›†æˆ ä¸æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ ä¸ç›‘æ§ç³»ç»Ÿé›†æˆ ä¸ CI/CD æ‰“é€š ä»»ä½•æŠ€æœ¯éƒ½ä¸æ˜¯å­¤ç«‹çš„\nâ‘¤ è¿›é˜¶å±‚ï¼šèƒ½è®¾è®¡ã€èƒ½æ¶æ„ 8. æ¶æ„è®¾è®¡ å¦‚ä½•è§„åˆ’ä¸é€‰å‹ å¦‚ä½•è®¾è®¡é«˜å¯ç”¨ å¦‚ä½•è§„åˆ’æ‰©å®¹ å¦‚ä½•åšå¤šæ´»å®¹ç¾ å¦‚ä½•åšå®¹é‡è¯„ä¼° å¦‚ä½•åš SLA/SLI/SLO 9. å®‰å…¨ä½“ç³» æƒé™æ¨¡å‹ RBAC token/è¯ä¹¦ å®‰å…¨æ‰«æ æ¼æ´ä¿®å¤ åˆè§„è¦æ±‚ 10. è‡ªåŠ¨åŒ–ä¸è§„èŒƒåŒ– è„šæœ¬ï¼ˆShell/Python/Ansibleï¼‰ é…ç½®ç®¡ç† ç‰ˆæœ¬ç®¡ç† è‡ªåŠ¨åŒ–éƒ¨ç½² è‡ªåŠ¨åŒ–æµ‹è¯• â€œè‡ªåŠ¨åŒ–ç¨‹åº¦ = æˆç†Ÿåº¦ç­‰çº§â€\nâ‘¥ æˆ˜ç•¥å±‚ï¼šèƒ½è§„åˆ’ã€èƒ½ç®¡ç† 11. æœ€ä½³å®è·µï¼ˆä½ å·²æœ‰ï¼‰ æ ‡å‡†æµç¨‹ è§„èŒƒæ–‡æ¡£ é£é™©è§„é¿ é¡¹ç›®æœ€ä½³æ¨¡å¼ 12. å­¦ä¹ è·¯å¾„ / è¿›é˜¶è·¯çº¿ / æ€ç»´æ¨¡å‹ å­¦ä»€ä¹ˆ -\u0026gt; é¡ºåºæ˜¯ä»€ä¹ˆ å¦‚ä½•é¿å‘ å¦‚ä½•ä»â€œä¼šç”¨â€è¿›é˜¶åˆ°â€œä¼šè®¾è®¡â€å†åˆ°â€œèƒ½é¢†å¯¼â€ å¦‚ä½•æ„å»ºçŸ¥è¯†ä½“ç³» å¦‚ä½•åšç»éªŒæ²‰æ·€ï¼ˆç¬”è®°/çŸ¥è¯†åº“ï¼‰ ğŸ¯ æœ€ç»ˆå®Œæ•´ç»“æ„ï¼ˆå¼€ç®±å³ç”¨æ¡†æ¶ï¼‰ å­¦ä¹ ä¸€ä¸ªæ–°æŠ€èƒ½åº”è¯¥åŒ…å«ï¼š\næ ¸å¿ƒæ¦‚å¿µï¼ˆåŸºç¡€æ•™ç¨‹ï¼‰ å®‰è£…éƒ¨ç½² è¿ç»´ç®¡ç† é…ç½®è¯¦è§£ æ€§èƒ½ä¼˜åŒ– æ•…éšœæ’æŸ¥ åœºæ™¯å®æˆ˜æ¡ˆä¾‹ ä¸å…¶ä»–ç³»ç»Ÿçš„é›†æˆ æ¶æ„è®¾è®¡ï¼ˆé«˜å¯ç”¨ã€æ‰©å±•æ€§ï¼‰ å®‰å…¨ä½“ç³» è‡ªåŠ¨åŒ–/è§„èŒƒåŒ– æœ€ä½³å®è·µ å­¦ä¹ è·¯å¾„ã€æ€ç»´æ¡†æ¶ã€é¿å‘æŒ‡å— è¿™æ˜¯ä¸€ä¸ªé€šç”¨æ¡†æ¶ï¼Œé€‚ç”¨äºæ‰€æœ‰æŠ€èƒ½ï¼šæ•°æ®åº“ã€K8Sã€Linuxã€Nginxã€ç¼–ç¨‹è¯­è¨€ã€ç½‘ç»œâ€¦â€¦éƒ½èƒ½å¥—ç”¨ã€‚\n","description":"å¯ç”¨äº IT è¿ç»´ã€å¼€å‘ã€æ•°æ®åº“ã€K8Sã€ç½‘ç»œã€ä»»ä½•æŠ€æœ¯é¢†åŸŸã€‚\nğŸ§­ å­¦ä¹ ä¸€ä¸ªæ–°æŠ€èƒ½ï¼Œåº”è¯¥å­¦ä¹ ä»€ä¹ˆï¼Ÿ åˆ†ä¸º æ¦‚å¿µ -\u0026gt; èƒ½åŠ› -\u0026gt; å®æˆ˜ -\u0026gt; è¿›é˜¶ -\u0026gt; æˆ˜ç•¥ äº”ä¸ªå±‚çº§ã€‚\nâ‘  åŸºç¡€å±‚ï¼šç†è§£ä¸å…¥é—¨ 1. æ ¸å¿ƒæ¦‚å¿µ / åŸºç¡€ç†è®º åŸºç¡€æ•™ç¨‹ åŸºæœ¬åŸç† æœ¯è¯­è§£é‡Š åº•å±‚æœºåˆ¶ï¼ˆå¦‚ä½ å–œæ¬¢çš„â€œåº•å±‚åŸç†â€ï¼‰ ğŸ‘‰ æ²¡åŸºç¡€ï¼Œä¸€åˆ‡æ— ä»è°ˆèµ·\n"},{"id":243,"href":"/backend/python/official/itertools/","title":"Itertools (é«˜æ€§èƒ½è¿­ä»£å™¨å·¥å…·åº“)","parent":"Official","content":" ğŸš€ 1. itertools æ˜¯ä»€ä¹ˆï¼Ÿ itertools æ˜¯ Python å†…ç½®çš„é«˜æ€§èƒ½è¿­ä»£å™¨å·¥å…·åº“ï¼Œä¸“é—¨ç”¨äºï¼š\nå¤„ç†å¯è¿­ä»£å¯¹è±¡ æ„é€ æ— é™åºåˆ— ç»„åˆ / æ’åˆ— / ç¬›å¡å°”ç§¯ æŒ‰æ¡ä»¶åˆ†ç»„ é«˜æ•ˆæ•°æ®æµæ°´çº¿å¤„ç† æ‰€æœ‰å·¥å…·éƒ½å®ç°ä¸º æƒ°æ€§ç”Ÿæˆå™¨ï¼ŒèŠ‚çœå†…å­˜ï¼Œéå¸¸é€‚åˆå¤„ç†å¤§æ•°æ®æµã€‚\nğŸ§© 2. itertools æ¨¡å—å…¨è¡¨ï¼ˆé€ŸæŸ¥ç‰ˆï¼‰ ğŸ“¦ æ ¸å¿ƒåˆ†ç±»\nåˆ†ç±» å‡½æ•° ç”¨é€” æ— é™è¿­ä»£å™¨ count(), cycle(), repeat() æ— é™ç”Ÿæˆæ•°å­—/å¾ªç¯/é‡å¤å€¼ æŒ‰è¾“å…¥è¿­ä»£å™¨ç”Ÿæˆç»„åˆ accumulate(), chain(), compress(), dropwhile(), takewhile(), filterfalse(), islice(), starmap(), zip_longest() è¿‡æ»¤ã€åˆ‡ç‰‡ã€æ‹¼æ¥ã€æ˜ å°„ ç»„åˆæ•°å­¦ç±» product(), combinations(), combinations_with_replacement(), permutations() æ’åˆ—ç»„åˆã€ç¬›å¡å°”ç§¯ åˆ†ç»„ groupby() æŒ‰ key åˆ†ç»„ ğŸ“Œ 3. æ— é™è¿­ä»£å™¨ 3.1 count(start=0, step=1) åƒ range()ï¼Œä½†æ— é™å¢é•¿ã€‚\nfrom itertools import count for i in count(10, 2): print(i) if i \u0026gt; 20: break è¾“å‡ºï¼š\n10 12 14 16 18 20 22 3.2 cycle(iterable) æ— é™å¾ªç¯åºåˆ—ï¼š\nfrom itertools import cycle count = 0 for c in cycle(\u0026#34;AB\u0026#34;): print(c) count += 1 if count == 6: break è¾“å‡ºï¼š\nA B A B A B 3.3 repeat(value, times=None) é‡å¤ç”Ÿæˆç›¸åŒå€¼ï¼š\nfrom itertools import repeat for x in repeat(\u0026#34;Hi\u0026#34;, 3): print(x) è¾“å‡ºï¼š\nHi Hi Hi ğŸ“Œ 4. æŒ‰è¾“å…¥è¿­ä»£å™¨ç”Ÿæˆç»„åˆçš„å·¥å…· 4.1 accumulate(iterable, func=operator.add) ç´¯è®¡å€¼ï¼ˆåŠ æ³•ã€ä¹˜æ³•ã€æœ€å¤§å€¼ã€æœ€å°å€¼ï¼‰ã€‚\nfrom itertools import accumulate import operator print(list(accumulate([1,2,3,4]))) print(list(accumulate([1,2,3,4], operator.mul))) è¾“å‡ºï¼š\n[1, 3, 6, 10] [1, 2, 6, 24] 4.2 chain(*iterables) æ‹¼æ¥å¤šä¸ª iterableï¼š\nfrom itertools import chain print(list(chain(\u0026#34;ABC\u0026#34;, \u0026#34;123\u0026#34;))) è¾“å‡ºï¼š\n[\u0026#39;A\u0026#39;,\u0026#39;B\u0026#39;,\u0026#39;C\u0026#39;,\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;] chain.from_iterable(iterable)\nè¾“å…¥æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼š\nchain.from_iterable([[1,2], [3,4]]) 4.3 compress(data, selectors) æ ¹æ® True/False é€‰æ‹©å€¼ï¼š\nfrom itertools import compress print(list(compress(\u0026#34;ABCDE\u0026#34;, [1,0,1,0,1]))) è¾“å‡ºï¼š\n[\u0026#39;A\u0026#39;,\u0026#39;C\u0026#39;,\u0026#39;E\u0026#39;] 4.4 dropwhile(func, iterable) é‡åˆ° False æ‰å¼€å§‹è¾“å‡ºï¼š\nfrom itertools import dropwhile print(list(dropwhile(lambda x: x \u0026lt; 5, [1,3,7,4,10]))) è¾“å‡ºï¼š\n[7,4,10] 4.5 takewhile(func, iterable) ä¸ dropwhile åå‘ï¼š\nfrom itertools import takewhile print(list(takewhile(lambda x: x \u0026lt; 5, [1,3,7,4,10]))) è¾“å‡ºï¼š\n[1,3] 4.6 filterfalse(func, iterable) ç›¸å½“äº not func(x)ï¼š\nfrom itertools import filterfalse print(list(filterfalse(lambda x: x%2, range(6)))) è¾“å‡ºï¼š\n[0,2,4] 4.7 islice(iterable, start, stop, step) ç”Ÿæˆå™¨ç‰ˆåˆ‡ç‰‡ï¼š\nfrom itertools import islice print(list(islice(range(10), 2, 8, 2))) è¾“å‡ºï¼š\n[2,4,6] 4.8 starmap(func, iterable) å°†æ¯ä¸ªå…ƒç´ æ‹†åŒ…ä½œä¸ºå‚æ•°ï¼š\nfrom itertools import starmap print(list(starmap(pow, [(2,5), (3,2), (10,3)]))) è¾“å‡ºï¼š\n[32,9,1000] 4.9 zip_longest(a, b, fillvalue=None) è¡¥é½è¾ƒçŸ­çš„ iterableï¼š\nfrom itertools import zip_longest print(list(zip_longest(\u0026#34;ABC\u0026#34;, \u0026#34;12\u0026#34;, fillvalue=\u0026#34;_\u0026#34;))) è¾“å‡ºï¼š\n[(\u0026#39;A\u0026#39;,\u0026#39;1\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;2\u0026#39;), (\u0026#39;C\u0026#39;,\u0026#39;_\u0026#39;)] ğŸ“Œ 5. ç»„åˆæ•°å­¦å·¥å…· 5.1 product(*iterables, repeat=1) ç¬›å¡å°”ç§¯ï¼š\nfrom itertools import product print(list(product(\u0026#34;AB\u0026#34;, \u0026#34;12\u0026#34;))) è¾“å‡ºï¼š\n[(\u0026#39;A\u0026#39;,\u0026#39;1\u0026#39;), (\u0026#39;A\u0026#39;,\u0026#39;2\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;1\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;2\u0026#39;)] 5.2 permutations(iterable, r=None) æ’åˆ—ï¼ˆæ¬¡åº mattersï¼‰ï¼š\nfrom itertools import permutations print(list(permutations(\u0026#34;ABC\u0026#34;, 2))) è¾“å‡ºï¼š\n[(\u0026#39;A\u0026#39;,\u0026#39;B\u0026#39;), (\u0026#39;A\u0026#39;,\u0026#39;C\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;A\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;C\u0026#39;), ...] 5.3 combinations(iterable, r) ç»„åˆï¼ˆä¸å«é‡å¤ï¼‰ï¼š\nfrom itertools import combinations print(list(combinations(\u0026#34;ABC\u0026#34;, 2))) è¾“å‡ºï¼š\n[(\u0026#39;A\u0026#39;,\u0026#39;B\u0026#39;), (\u0026#39;A\u0026#39;,\u0026#39;C\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;C\u0026#39;)] 5.4 combinations_with_replacement(iterable, r) ç»„åˆï¼ˆå…è®¸å¯¹åŒä¸€ä¸ªå…ƒç´ é‡å¤é€‰ï¼‰ï¼š\nfrom itertools import combinations_with_replacement print(list(combinations_with_replacement(\u0026#34;ABC\u0026#34;, 2))) è¾“å‡ºï¼š\n[(\u0026#39;A\u0026#39;,\u0026#39;A\u0026#39;), (\u0026#39;A\u0026#39;,\u0026#39;B\u0026#39;), (\u0026#39;A\u0026#39;,\u0026#39;C\u0026#39;), (\u0026#39;B\u0026#39;,\u0026#39;B\u0026#39;), ...] ğŸ“Œ 6. åˆ†ç»„å·¥å…· groupby âš ï¸ å…³é”®ç‚¹ï¼šå¿…é¡»å…ˆæ’åºï¼\nfrom itertools import groupby data = [(\u0026#34;A\u0026#34;,1), (\u0026#34;A\u0026#34;,2), (\u0026#34;B\u0026#34;,1), (\u0026#34;B\u0026#34;,3)] for k, g in groupby(data, key=lambda x: x[0]): print(k, list(g)) è¾“å‡ºï¼š\nA [(\u0026#39;A\u0026#39;,1), (\u0026#39;A\u0026#39;,2)] B [(\u0026#39;B\u0026#39;,1), (\u0026#39;B\u0026#39;,3)] ğŸŒŸ 7. itertools å®æˆ˜ï¼šæ•°æ®å¤„ç†æµæ°´çº¿ï¼ˆé«˜çº§ï¼‰ å‡è®¾ä½ æƒ³ï¼š\nä» 1 åˆ° 1000 çš„æ•°å­—ä¸­ è¿‡æ»¤æ‰å¥‡æ•° è½¬æ¢æˆå¹³æ–¹ å–å‰ 5 ä¸ª ä½¿ç”¨ itertoolsï¼š\nfrom itertools import islice result = islice( (x*x for x in range(1000) if x % 2 == 0), 5 ) print(list(result)) è¾“å‡ºï¼š\n[0, 4, 16, 36, 64] éå¸¸æµç•…ï¼\nâ˜˜ï¸ 8. itertools çš„â€œæƒ°æ€§â€å®ç°ä¼˜åŠ¿ ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ® éå¸¸é€‚åˆå¤§æ–‡ä»¶æµ é€‚åˆå®æ—¶æ•°æ® å†…å­˜å ç”¨æä½ ğŸ¯ 9. æœ€å¸¸ç”¨çš„ 12 ä¸ª itertoolsï¼ˆä½ é‡ç‚¹æŒæ¡å³å¯ï¼‰ ç±»å‹ å‡½æ•° æ— é™è¿­ä»£å™¨ count, repeat, cycle é«˜æ•ˆåºåˆ—å¤„ç† islice, chain, accumulate, compress, starmap, filterfalse æ•°æ®ç»„åˆ product, permutations, combinations åˆ†ç»„ groupby ","description":" ğŸš€ 1. itertools æ˜¯ä»€ä¹ˆï¼Ÿ itertools æ˜¯ Python å†…ç½®çš„é«˜æ€§èƒ½è¿­ä»£å™¨å·¥å…·åº“ï¼Œä¸“é—¨ç”¨äºï¼š\nå¤„ç†å¯è¿­ä»£å¯¹è±¡ æ„é€ æ— é™åºåˆ— ç»„åˆ / æ’åˆ— / ç¬›å¡å°”ç§¯ æŒ‰æ¡ä»¶åˆ†ç»„ é«˜æ•ˆæ•°æ®æµæ°´çº¿å¤„ç† æ‰€æœ‰å·¥å…·éƒ½å®ç°ä¸º æƒ°æ€§ç”Ÿæˆå™¨ï¼ŒèŠ‚çœå†…å­˜ï¼Œéå¸¸é€‚åˆå¤„ç†å¤§æ•°æ®æµã€‚\nğŸ§© 2. itertools æ¨¡å—å…¨è¡¨ï¼ˆé€ŸæŸ¥ç‰ˆï¼‰ ğŸ“¦ æ ¸å¿ƒåˆ†ç±»\nåˆ†ç±» å‡½æ•° ç”¨é€” æ— é™è¿­ä»£å™¨ count(), cycle(), repeat() æ— é™ç”Ÿæˆæ•°å­—/å¾ªç¯/é‡å¤å€¼ æŒ‰è¾“å…¥è¿­ä»£å™¨ç”Ÿæˆç»„åˆ accumulate(), chain(), compress(), dropwhile(), takewhile(), filterfalse(), islice(), starmap(), zip_longest() è¿‡æ»¤ã€åˆ‡ç‰‡ã€æ‹¼æ¥ã€æ˜ å°„ ç»„åˆæ•°å­¦ç±» product(), combinations(), combinations_with_replacement(), permutations() æ’åˆ—ç»„åˆã€ç¬›å¡å°”ç§¯ åˆ†ç»„ groupby() æŒ‰ key åˆ†ç»„ ğŸ“Œ 3. æ— é™è¿­ä»£å™¨ 3.1 count(start=0, step=1) åƒ range()ï¼Œä½†æ— é™å¢é•¿ã€‚\n"},{"id":244,"href":"/operations/java/","title":"Java","parent":"Operations","content":"Document List:\nJava è¿ç»´ ","description":"Document List:\nJava è¿ç»´ "},{"id":245,"href":"/operations/java/operation/","title":"Java è¿ç»´","parent":"Java","content":"å†…å®¹ï¼šéƒ¨ç½²ã€ç›‘æ§ã€æ—¥å¿—ã€æ’é”™ã€æ€§èƒ½ã€JVMã€å®¹å™¨åŒ–ã€CI/CDã€è¿ç»´å·¥å…·ç­‰ã€‚\n1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­–ç•¥ âœ… æ¨èéƒ¨ç½²æ–¹å¼\nä¼˜å…ˆé¡ºåºï¼ˆä»å¼ºåˆ°å¼±ï¼‰ï¼š\nå®¹å™¨åŒ– + Kubernetesï¼ˆæœ€ä½³ï¼‰ systemd æ–¹å¼éƒ¨ç½² JAR Supervisor ç›´æ¥ nohup åå°è·‘ï¼ˆä¸æ¨èç”Ÿäº§ï¼‰ ç¤ºä¾‹ï¼šsystemd è¿è¡Œ Java ç¨‹åº\n[Unit] Description=My Java App After=network.target [Service] User=www WorkingDirectory=/opt/myapp ExecStart=/usr/bin/java -Xms512m -Xmx512m -jar myapp.jar --spring.profiles.active=prod SuccessExitStatus=143 Restart=always RestartSec=5 [Install] WantedBy=multi-user.target 2. Java è¿ç»´å¿…å¤‡ï¼šJVM å‚æ•°æ ‡å‡†è§„èŒƒ æ ‡å‡†å¯ç”¨äºç”Ÿäº§çš„ JVM å‚æ•° JAVA_OPTS=\u0026#34; -Xms1024m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/logs/heapdump.hprof -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/opt/logs/gc.log \u0026#34; å†…å­˜å¤§å°è§„åˆ™ å®¹å™¨ç¯å¢ƒï¼š\nXms = Xmx = container_limit * 80% `` ç‰©ç†æœºï¼šæŒ‰å†…å­˜ 50%-70%\n3. Java åœ¨çº¿ç›‘æ§ï¼ˆå¿…ä¼šï¼‰ å·¥å…· ç”¨é€” jps æŸ¥çœ‹ Java è¿›ç¨‹ jstat GCã€ç±»åŠ è½½ç»Ÿè®¡ jstack çº¿ç¨‹æ ˆã€æ­»é”åˆ†æ jmap dump å†…å­˜ã€heap æŸ¥çœ‹ jcmd ä¸‡èƒ½å·¥å…·ï¼Œå¯ä»¥æ›¿ä»£å¤§éƒ¨åˆ†å‘½ä»¤ prometheus+jmx-exporter æœ€å¼º Java ç›‘æ§ ç¤ºä¾‹ï¼šæŸ¥çœ‹ GCï¼š\njstat -gc \u0026lt;pid\u0026gt; 1s 10 æŸ¥çœ‹çº¿ç¨‹æ­»é”ï¼š\njstack \u0026lt;pid\u0026gt; å¯¼å‡º Heap dumpï¼š\njmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; 4. Java æ—¥å¿—è¿ç»´ ç”Ÿäº§å»ºè®®é‡‡ç”¨ï¼š\nlogback æ—¥å¿—æŒ‰å¤©æ»šåŠ¨ é”™è¯¯æ—¥å¿—å•ç‹¬æ–‡ä»¶ JSON æ—¥å¿—ï¼ˆæ–¹ä¾¿ ELKï¼‰ ç¤ºä¾‹ logbackï¼š\n\u0026lt;rollingPolicy class=\u0026#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy\u0026#34;\u0026gt; \u0026lt;fileNamePattern\u0026gt;/data/logs/app.%d{yyyy-MM-dd}.log.gz\u0026lt;/fileNamePattern\u0026gt; \u0026lt;maxHistory\u0026gt;15\u0026lt;/maxHistory\u0026gt; \u0026lt;/rollingPolicy\u0026gt; 5. Java çº¿ä¸Šå¸¸è§æ•…éšœæ’æŸ¥æµç¨‹ CPU 100% top # æ‰¾åˆ° java è¿›ç¨‹ PID top -Hp \u0026lt;pid\u0026gt; # æ‰¾åˆ°å  CPU çš„çº¿ç¨‹ printf \u0026#34;%x\\n\u0026#34; \u0026lt;çº¿ç¨‹ID\u0026gt; # è½¬æ¢ä¸ºåå…­è¿›åˆ¶ jstack \u0026lt;pid\u0026gt; | grep -A30 \u0026lt;0xçº¿ç¨‹ID\u0026gt; å†…å­˜æ³„æ¼ jmap -dump:format=b,file=heap.hprof \u0026lt;pid\u0026gt; ç„¶åä½¿ç”¨ MAT æˆ– VisualVM åˆ†æã€‚\nGC å¯¼è‡´å¡é¡¿ æŸ¥çœ‹ GC æ—¥å¿—ï¼š\ntail -f gc.log ç»“åˆï¼š\njstat -gcutil \u0026lt;pid\u0026gt; 1s 6. Java æœåŠ¡ä¼˜åŒ–ï¼ˆè¿ç»´è§†è§’ï¼‰ æœ€æ¨è GC G1GCï¼ˆJDK 11+ é»˜è®¤ï¼‰ å“åº”å¿«ã€åœé¡¿ä½ã€ç»´æŠ¤ç®€å• å¸¸è§æ€§èƒ½è°ƒä¼˜ç‚¹ é¿å…æ—¥å¿—é‡è¿‡å¤§ çº¿ç¨‹æ± è®¾ç½®åˆç† é™æµ / ç†”æ–­ï¼ˆSentinel / Resilience4jï¼‰ æ•°æ®åº“è¿æ¥æ± æ­£ç¡®é…ç½®ï¼ˆHikariCPï¼‰ ç¤ºä¾‹ Hikariï¼š\nmaximumPoolSize = CPU * 2 + 1 connectionTimeout = 30000 idleTimeout = 600000 7. å®¹å™¨åŒ– Java è¿ç»´ï¼ˆKubernetesï¼‰ Dockerfile æœ€ä½³å®è·µ FROM eclipse-temurin:17-jre WORKDIR /app COPY myapp.jar . ENV JAVA_OPTS=\u0026#34;-Xms512m -Xmx512m -XX:+UseG1GC\u0026#34; ENTRYPOINT [\u0026#34;sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;java $JAVA_OPTS -jar myapp.jar\u0026#34;] Kubernetes éƒ¨ç½²æœ€ä½³å®è·µ è®¾ç½® livenessProbe / readinessProbe è®¾ç½® èµ„æºé™åˆ¶ è®¾ç½® æ»šåŠ¨å‡çº§ è®¾ç½® æ—¥å¿— stdoutï¼šç”±å®¹å™¨å¹³å°æ”¶é›† ç¤ºä¾‹ï¼š\nresources: requests: memory: \u0026#34;512Mi\u0026#34; cpu: \u0026#34;200m\u0026#34; limits: memory: \u0026#34;1024Mi\u0026#34; cpu: \u0026#34;1\u0026#34; 8. Java è¿ç»´å¿…ç”¨å·¥å…· å·¥å…· ç”¨é€” jvisualvm æœ¬åœ°ç›‘æ§ arthas é˜¿é‡Œå¼€æºç¥å™¨ï¼Œå®šä½çº¿ä¸Šé—®é¢˜æœ€å¼º MAT åˆ†æ heap dump jmc (Java Mission Control) äº‹ä»¶é©±åŠ¨ç›‘æ§ï¼ˆJDK17+ï¼‰ Btrace çƒ­ä¿®æ”¹ã€æ³¨å…¥è·Ÿè¸ª Arthas å¯åŠ¨ï¼š\njava -jar arthas-boot.jar 9. æ—¥å¸¸è¿ç»´ checklist ç›‘æ§ GCã€CPUã€RAMã€çº¿ç¨‹ å®šæœŸ rotate æ—¥å¿— å®šæœŸ dump ä¸€æ¬¡çº¿ç¨‹æ ˆ å®¹å™¨è®¾ç½®åˆç† JVM å‚æ•° æœåŠ¡è‡ªå¯åŠ¨ systemd/Supervisor/k8s æ•°æ®åº“è¿æ¥æ± ç¨³å®š é™æµã€é˜²é›ªå´© è§‚å¯Ÿå¥åº·æ£€æŸ¥æ˜¯å¦æˆåŠŸ ","description":"å†…å®¹ï¼šéƒ¨ç½²ã€ç›‘æ§ã€æ—¥å¿—ã€æ’é”™ã€æ€§èƒ½ã€JVMã€å®¹å™¨åŒ–ã€CI/CDã€è¿ç»´å·¥å…·ç­‰ã€‚\n1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­–ç•¥ âœ… æ¨èéƒ¨ç½²æ–¹å¼\nä¼˜å…ˆé¡ºåºï¼ˆä»å¼ºåˆ°å¼±ï¼‰ï¼š\nå®¹å™¨åŒ– + Kubernetesï¼ˆæœ€ä½³ï¼‰ systemd æ–¹å¼éƒ¨ç½² JAR Supervisor ç›´æ¥ nohup åå°è·‘ï¼ˆä¸æ¨èç”Ÿäº§ï¼‰ ç¤ºä¾‹ï¼šsystemd è¿è¡Œ Java ç¨‹åº\n[Unit] Description=My Java App After=network.target [Service] User=www WorkingDirectory=/opt/myapp ExecStart=/usr/bin/java -Xms512m -Xmx512m -jar myapp.jar --spring.profiles.active=prod SuccessExitStatus=143 Restart=always RestartSec=5 [Install] WantedBy=multi-user.target 2. Java è¿ç»´å¿…å¤‡ï¼šJVM å‚æ•°æ ‡å‡†è§„èŒƒ æ ‡å‡†å¯ç”¨äºç”Ÿäº§çš„ JVM å‚æ•° JAVA_OPTS=\u0026#34; -Xms1024m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/opt/logs/heapdump.hprof -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/opt/logs/gc.log \u0026#34; å†…å­˜å¤§å°è§„åˆ™ å®¹å™¨ç¯å¢ƒï¼š\n"},{"id":246,"href":"/frontend/javascript/","title":"JavaScript","parent":"Frontend","content":"Document List:\n","description":"Document List:\n"},{"id":247,"href":"/operations/jenkins/","title":"Jenkins","parent":"Operations","content":"Directory List:\nJenkins FAQ Jenkins åŸºç¡€æ•™ç¨‹ Jenkins æ ¸å¿ƒæ¦‚å¿µ Jenkins éƒ¨ç½² Jenkins GitHub Pipeline Jenkins Multibranch Pipeline å®šæ—¶è§¦å‘ Jenkins å‡­æ®é”™è¯¯ Jenkins æœ€ä½³å®è·µ Jenkins é›†ç¾¤ï¼ˆMaster \u0026#43; Agentï¼‰ JNLP Agent ä½¿ç”¨ Docker éƒ¨ç½²çš„ Jenkins å¦‚ä½•æ‰“åŒ…å…¶ä»– Docker é•œåƒ ","description":"Directory List:\nJenkins FAQ Jenkins åŸºç¡€æ•™ç¨‹ Jenkins æ ¸å¿ƒæ¦‚å¿µ Jenkins éƒ¨ç½² Jenkins GitHub Pipeline Jenkins Multibranch Pipeline å®šæ—¶è§¦å‘ Jenkins å‡­æ®é”™è¯¯ Jenkins æœ€ä½³å®è·µ Jenkins é›†ç¾¤ï¼ˆMaster \u0026#43; Agentï¼‰ JNLP Agent ä½¿ç”¨ Docker éƒ¨ç½²çš„ Jenkins å¦‚ä½•æ‰“åŒ…å…¶ä»– Docker é•œåƒ "},{"id":248,"href":"/operations/jenkins/github-pipeline/","title":"Jenkins GitHub Pipeline","parent":"Jenkins","content":"é€‚ç”¨äº GitHub ç§æœ‰ä»“åº“ / å…¬æœ‰ä»“åº“ï¼Œä»»ä½•è¯­è¨€é¡¹ç›®å‡å¯å¤ç”¨ã€‚\n1. GitHub -\u0026gt; Jenkins Webhook é…ç½®ï¼ˆè‡ªåŠ¨è§¦å‘æ„å»ºï¼‰ ğŸ”¹ Step 1ï¼šåœ¨ Jenkins è·å– Webhook åœ°å€ è®¿é—®ï¼š\nhttp://\u0026lt;JENKINS_URL\u0026gt;/github-webhook/ ç¤ºä¾‹ï¼š\nhttps://documents.v2ep.com/jenkins/github-webhook/ ğŸ”¹ Step 2ï¼šåˆ° GitHub Repository è®¾ç½® è¿›å…¥ GitHub Repoï¼š\nSettings -\u0026gt; Webhooks -\u0026gt; Add webhook å¡«å†™ï¼š\nPayload URLï¼šhttps://documents.v2ep.com/jenkins/github-webhook/ Content typeï¼šapplication/json Secretï¼šå¯ç•™ç©º or å¡«ä¸€ä¸ªå­—ç¬¦ä¸² Eventsï¼šJust the push eventï¼ˆæ¨èï¼‰ æˆ– Send me everything ç‚¹å‡» Add webhookã€‚\n2. Jenkins ä¾§é…ç½® GitHub è®¤è¯ ä½¿ç”¨ Personal Access Tokenï¼ˆPATï¼‰\nï¼ˆå»ºè®®æœ€å¸¸ç”¨ï¼‰\nGitHub -\u0026gt; Settings -\u0026gt; Developer settings -\u0026gt; Tokens (classic) -\u0026gt; Generate new token -\u0026gt; Generate new token (classic)\nExpiration:\nNo expiration Select scopesï¼ˆæƒé™ï¼‰ï¼š\nrepo workflowï¼ˆå¯é€‰ï¼‰ admin:repo_hookï¼ˆç®¡ç† webhookï¼‰ ç”Ÿæˆ Token åï¼Œåˆ° Jenkinsï¼š\nJenkins -\u0026gt; Manage Jenkins -\u0026gt; Security -\u0026gt; Credentials -\u0026gt; (global) -\u0026gt; Add Credentials Kind: Username with password (ä¸è¦é€‰æ‹© Secret Text !!!) Scope: Global (Jenkins, nodes, items, all child items, etc) Username: septvean Password: xxx ID: github-user-septvean 3. Jenkins ä»»åŠ¡é…ç½®ï¼ˆMultibranch Pipelineï¼‰ â­ ä¼ä¸šæ¨èä¸€å®šä½¿ç”¨ Multibranch Pipelineï¼Œè€Œä¸æ˜¯å•ä»»åŠ¡ Pipelineã€‚\nä¼˜åŠ¿ï¼š\nè‡ªåŠ¨è¯†åˆ« GitHub åˆ†æ”¯ è‡ªåŠ¨è¯†åˆ« PR æ¯ä¸ªåˆ†æ”¯å•ç‹¬æµæ°´çº¿ è‡ªåŠ¨æ‰«ææ–°åˆ†æ”¯å¹¶æ„å»º åˆ›å»º Multibranch Pipeline\nJenkins -\u0026gt; New Item -\u0026gt; Multibranch Pipeline\nEnter an item nameï¼šDocuments Select an item typeï¼šMultibranch Pipeline é…ç½®ï¼ˆConfigure the projectï¼‰ï¼š\nğŸ”¹ Display Nameï¼šDocuments\nğŸ”¹ Branch Source -\u0026gt; GitHub\nCredentialsï¼šgithub-user-septvean Repository HTTPS URLï¼šhttps://github.com/septvean/documents.git 4. Jenkinsfile é…ç½®ï¼ˆæœ€æ ‡å‡†ç‰ˆï¼‰ ä»¥ä¸‹æ˜¯ä¸€ä¸ª é€šç”¨ã€æ‰€æœ‰è¯­è¨€éƒ½é€‚ç”¨çš„ Jenkinsfile åŸºç¡€æ¨¡æ¿ã€‚\nâœ… Jenkinsfileï¼ˆä¼ä¸šæ ‡å‡†æ¨¡æ¿ï¼‰\npipeline { agent any triggers { githubPush() // \u0026lt;- Webhook å…¥å£ } stages { stage(\u0026#39;Checkout\u0026#39;) { steps { checkout scm } } stage(\u0026#39;Build\u0026#39;) { steps { sh \u0026#39;echo \u0026#34;Building...\u0026#34;\u0026#39; } } stage(\u0026#39;Test\u0026#39;) { steps { sh \u0026#39;echo \u0026#34;Running tests...\u0026#34;\u0026#39; } } stage(\u0026#39;Deploy\u0026#39;) { when { branch \u0026#39;main\u0026#39; } steps { sh \u0026#39;echo \u0026#34;Deploying to production...\u0026#34;\u0026#39; } } } post { always { echo \u0026#34;Build finished.\u0026#34; } failure { echo \u0026#34;Build failed!\u0026#34; } } } 5. é«˜çº§ Jenkinsfileï¼ˆå« Docker æ„å»º + æ¨é€ + K8S éƒ¨ç½²ï¼‰ å¦‚æœä½ é¡¹ç›®éœ€è¦å®¹å™¨åŒ–ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿ï¼š\nâœ… Jenkinsfileï¼ˆDocker + GitHubï¼‰\npipeline { agent { label \u0026#39;docker\u0026#39; } triggers { githubPush() } environment { REGISTRY = \u0026#34;ghcr.io/\u0026lt;your_username\u0026gt;/\u0026lt;project\u0026gt;\u0026#34; IMAGE_TAG = \u0026#34;${BUILD_NUMBER}\u0026#34; } stages { stage(\u0026#39;Checkout\u0026#39;) { steps { checkout scm } } stage(\u0026#39;Build Docker\u0026#39;) { steps { sh \u0026#34;\u0026#34;\u0026#34; docker build -t $REGISTRY:$IMAGE_TAG . docker push $REGISTRY:$IMAGE_TAG \u0026#34;\u0026#34;\u0026#34; } } stage(\u0026#39;Deploy K8S\u0026#39;) { when { branch \u0026#39;main\u0026#39; } steps { sh \u0026#34;\u0026#34;\u0026#34; kubectl set image deploy/myapp myapp=$REGISTRY:$IMAGE_TAG kubectl rollout status deploy/myapp \u0026#34;\u0026#34;\u0026#34; } } } } 6. GitHub Pull Request æ„å»ºï¼ˆPR Buildï¼‰ Multibranch Pipeline é»˜è®¤æ”¯æŒï¼š\nPR opened PR updated PR synchronized è‡ªåŠ¨è§¦å‘æ„å»ºã€‚\nPR æ„å»ºæ—¶è‡ªåŠ¨ä½¿ç”¨åˆ†æ”¯å˜é‡ï¼š\nCHANGE_ID CHANGE_URL CHANGE_AUTHOR åœ¨ Jenkinsfile ä¸­åŠ ï¼š\nwhen { changeRequest() } ç¤ºä¾‹ï¼š\nstage(\u0026#39;PR Test\u0026#39;) { when { changeRequest() } steps { echo \u0026#34;Testing Pull Request #${CHANGE_ID}\u0026#34; } } 7. å¸¸è§é…ç½®å‘ï¼ˆéå¸¸é‡è¦ï¼‰ âŒ 1. Webhook ä¸è§¦å‘ åŸå› ï¼š\nGitHub æ— æ³•è®¿é—® Jenkinsï¼ˆéœ€è¦å…¬ç½‘ï¼‰ Jenkins URL é…ç½®é”™è¯¯ GitHub 403ï¼ˆToken æƒé™ä¸è¶³ï¼‰ Job ä¸æ˜¯ Multibranch Pipelineï¼ˆFreestyle æ— æ³• auto-scanï¼‰ è§£å†³æ–¹å¼ï¼š\næ‰“å¼€ GitHub -\u0026gt; Webhooks -\u0026gt; Recent Deliveries -\u0026gt; æŸ¥çœ‹ Response åº”ä¸ºï¼š\nHTTP 200 âŒ 2. GitHubToken 403 PAT å¿…é¡»å¯ç”¨ï¼š\nrepo admin:repo_hook âŒ 3. Jenkinsfile ä¸ç”Ÿæ•ˆ æ£€æŸ¥ï¼š\nåˆ†æ”¯ä¸æ˜¯ main -\u0026gt; ä½¿ç”¨ branch indexing Jenkinsfile åç§°å¿…é¡»æ˜¯ Jenkinsfile âŒ 4. å†…ç½‘ Jenkins æ— æ³•è¢« GitHub è°ƒç”¨ æ–¹æ¡ˆï¼š\nä½¿ç”¨ Cloudflare Tunnelï¼ˆæ¨èï¼‰ ä½¿ç”¨ frpï¼ˆå†…ç½‘ç©¿é€ï¼‰ ä½¿ç”¨å…¬ç½‘ Nginx -\u0026gt; Proxy åˆ° Jenkins 8ï¸âƒ£ é¢å¤–ï¼šGitHub -\u0026gt; Jenkins ç¯å¢ƒå˜é‡ï¼ˆéå¸¸æœ‰ç”¨ï¼‰ Jenkins è‡ªåŠ¨æä¾› GitHub ç¯å¢ƒå˜é‡ï¼š\nå˜é‡ è¯´æ˜ GIT_BRANCH å½“å‰æ„å»ºåˆ†æ”¯ GIT_COMMIT æäº¤ SHA GIT_PREVIOUS_COMMIT ä¸Šä¸€æ¬¡æ„å»ºçš„æäº¤ CHANGE_ID PR ç¼–å· CHANGE_AUTHOR PR ä½œè€… ","description":"é€‚ç”¨äº GitHub ç§æœ‰ä»“åº“ / å…¬æœ‰ä»“åº“ï¼Œä»»ä½•è¯­è¨€é¡¹ç›®å‡å¯å¤ç”¨ã€‚\n1. GitHub -\u0026gt; Jenkins Webhook é…ç½®ï¼ˆè‡ªåŠ¨è§¦å‘æ„å»ºï¼‰ ğŸ”¹ Step 1ï¼šåœ¨ Jenkins è·å– Webhook åœ°å€ è®¿é—®ï¼š\n"},{"id":249,"href":"/operations/jenkins/multibranch-pipeline-cron/","title":"Jenkins Multibranch Pipeline å®šæ—¶è§¦å‘","parent":"Jenkins","content":"Multibranch Pipeline å’Œæ™®é€š Pipeline æœ€å¤§çš„åŒºåˆ«æ˜¯ \u0026ndash; å®šæ—¶æ„å»ºä¸èƒ½ç›´æ¥åœ¨ Jenkinsfile ç”¨ cron è§¦å‘å…¨éƒ¨åˆ†æ”¯ï¼\nå¿…é¡»åŒºåˆ† ä¸¤ç§å±‚é¢çš„å®šæ—¶ä»»åŠ¡ï¼š\nğŸ”¥ ä½ è¦å†³å®šçš„æ˜¯ ä½ éœ€è¦çš„æ˜¯ï¼š\nâ‘  å®šæœŸæ‰«æä»“åº“ï¼ˆæ‰¾åˆ°æ–°å¢/åˆ é™¤/å˜åŒ–åˆ†æ”¯ï¼‰ï¼Ÿ -\u0026gt; é…ç½® Scan Multibranch Pipeline Triggers\nâ‘¡ å®šæœŸæ‰§è¡Œæ¯ä¸ªåˆ†æ”¯çš„ Pipelineï¼Ÿ -\u0026gt; é…ç½® åœ¨ Jenkinsfile ä¸­è®¾ç½® cronï¼ˆæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹å®šæ—¶ï¼‰\nâ‘¢ ä¸ç®¡æœ‰æ²¡æœ‰å˜åŒ–ï¼Œéƒ½å®šæ—¶æ„å»ºæ‰€æœ‰åˆ†æ”¯ï¼Ÿ -\u0026gt; éœ€è¦å¼€å¯ Periodically if not otherwise run\nä¸‹é¢é€æ¡é…ç½®\nâœ… ä¸€ã€Multibranch Pipelineï¼šå®šæ—¶æ‰«æ GitHub ä»“åº“ è¿™ä¸æ˜¯æ„å»º Pipelineï¼Œè€Œæ˜¯æ‰«æ Repoã€‚\nè·¯å¾„ï¼š\nJenkins -\u0026gt; ä½ çš„ Multibranch Pipeline Job -\u0026gt; Configure æ‰¾åˆ°ï¼š\nScan Multibranch Pipeline Triggers å‹¾é€‰ï¼š\nPeriodically if not otherwise run å¡«å†™ cronï¼Œå¦‚ï¼š\nH/5 * * * * æ„æ€æ˜¯ï¼šæ¯ 5 åˆ†é’Ÿæ‰«æä»“åº“\nğŸ“Œ ä½œç”¨ï¼š\nä»“åº“æ–°å¢ branch -\u0026gt; è‡ªåŠ¨åˆ›å»ºæ–° Job ä»“åº“åˆ é™¤ branch -\u0026gt; è‡ªåŠ¨åˆ é™¤å¯¹åº”åˆ†æ”¯çš„ Job åˆ†æ”¯çš„ Jenkinsfile ä¿®æ”¹ -\u0026gt; è‡ªåŠ¨æ›´æ–° Pipeline å®šä¹‰ æ³¨æ„ï¼šè¿™ä¸ªåªæ§åˆ¶æ‰«æï¼Œä¸æ„å»ºåˆ†æ”¯ï¼\nâœ… äºŒã€æ¯ä¸ªåˆ†æ”¯è‡ªå·±çš„å®šæ—¶æ„å»ºï¼ˆæ¨èï¼‰ åœ¨ æ¯ä¸ªåˆ†æ”¯çš„ Jenkinsfile é‡Œæ·»åŠ ï¼š\npipeline { agent any triggers { cron(\u0026#39;H 2 * * *\u0026#39;) } stages { stage(\u0026#39;Run\u0026#39;) { steps { echo \u0026#34;å®šæ—¶æ‰§è¡Œ: ${env.BRANCH_NAME}\u0026#34; } } } } æ•ˆæœï¼š\nmain åˆ†æ”¯æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œ dev åˆ†æ”¯æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œ hotfix åˆ†æ”¯æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œ ï¼ˆåªè¦è¯¥åˆ†æ”¯å¸¦æœ‰ Jenkinsfileï¼‰ è¦æ„å»º tag ä¹Ÿå¯ä»¥ç”¨ï¼š\nwhen { buildingTag() } ğŸ“Œ å¸¸è§è¯¯åŒºï¼ˆå¾ˆé‡è¦âš ï¸ï¼‰ âŒ åœ¨ Multibranch Pipeline é…ç½®é‡Œé¢æ‰¾ä¸åˆ°â€œå®šæ—¶æ„å»ºâ€ å› ä¸º Multibranch Pipeline çš„æ ¹ Job ä¸ä¼šæ„å»ºä»£ç ï¼Œåªè´Ÿè´£æ‰«æåˆ†æ”¯ï¼Œæ‰€æœ‰æ„å»ºéƒ½å‘ç”Ÿåœ¨åˆ†æ”¯çº§ Jobã€‚\nâŒ åœ¨ Jenkinsfile é‡Œæ— æ³•è§¦å‘å…¨å±€æ‰€æœ‰åˆ†æ”¯çš„å®šæ—¶è¿è¡Œ æ­£ç¡®æ–¹å¼å°±æ˜¯ï¼šæ¯ä¸ªåˆ†æ”¯å†™è‡ªå·±çš„ triggers { cron }ã€‚\nğŸ”¥ ä¸‰ã€å®šæ—¶æ„å»ºæ‰€æœ‰åˆ†æ”¯ï¼ˆæ— è®ºæ˜¯å¦æœ‰å˜åŒ–ï¼‰ å¦‚æœä½ å¸Œæœ›ï¼š\nmain æ¯æ™š 2 ç‚¹æ‰§è¡Œ dev æ¯æ™š 2 ç‚¹æ‰§è¡Œ feature/** ä¸€å¾‹æ¯æ™š 2 ç‚¹æ‰§è¡Œï¼ˆå»ºè®®æ’é™¤ï¼‰ é‚£ä¹ˆå¿…é¡»åœ¨ Jenkinsfile é‡ŒåŠ å…¥ cronï¼Œå¹¶ä¸”åœ¨ Multibranch Pipeline é…ç½®å¯ç”¨è‡ªåŠ¨æ‰«æã€‚\nç»„åˆæ–¹å¼ï¼š\n1. Jenkinsfile pipeline { agent any triggers { cron(\u0026#39;H 2 * * *\u0026#39;) } stages { stage(\u0026#39;Nightly Build\u0026#39;) { steps { echo \u0026#34;å¤œé—´æ„å»ºï¼š${env.BRANCH_NAME}\u0026#34; } } } } 2. Multibranch Pipeline ä¸­ Scan Multibranch Pipeline Triggers -\u0026gt; æ¯å°æ—¶æ‰«æä¸€æ¬¡\nè¿™æ ·ï¼š\nJenkins å®šæœŸæ„å»ºæ‰€æœ‰å­˜åœ¨ Jenkinsfile çš„åˆ†æ”¯ Jenkins ä¼šè‡ªåŠ¨å‘ç°æ–°å¢åˆ†æ”¯å¹¶åŠ å…¥å®šæ—¶ä»»åŠ¡ ğŸ”¥ å››ã€åªè®© main åˆ†æ”¯å®šæ—¶æ‰§è¡Œï¼ˆæœ€å¸¸ç”¨ï¼‰ åœ¨ main åˆ†æ”¯ Jenkinsfileï¼š\npipeline { triggers { cron(\u0026#39;H 2 * * *\u0026#39;) } stages { stage(\u0026#39;Nightly\u0026#39;) { steps { echo \u0026#34;main åˆ†æ”¯å®šæ—¶æ„å»º\u0026#34; } } } } åœ¨ devã€feature ç­‰åˆ†æ”¯åˆ æ‰ triggers {} å³å¯ã€‚\nâœ¨ äº”ã€ç»„åˆè§„åˆ™ï¼ˆç”Ÿäº§ä¸­å¸¸ç”¨æ¨¡å¼ï¼‰ ä¸‹é¢ 3 ç§æ¨¡å¼æœ€å¸¸ç”¨ï¼š\nâ‘  æ¨¡å¼ 1ï¼šåªæ‰«æï¼Œä¸å®šæ—¶æ„å»º Scan: H/5 * * * * Jenkinsfile: ä¸å†™ cron é€‚ç”¨äº PRã€CI\nâ‘¡ æ¨¡å¼ 2ï¼šmain å®šæ—¶æ„å»º + å…¨éƒ¨åˆ†æ”¯è‡ªåŠ¨æ‰«æ Scan: æ¯ 10 åˆ†é’Ÿ main Jenkinsfile: å†™ cron å…¶ä»–åˆ†æ”¯: ä¸å†™ cron é€‚ç”¨äº nightly build\nâ‘¢ æ¨¡å¼ 3ï¼šæ‰€æœ‰åˆ†æ”¯ nightly æ„å»º Scan: æ¯å°æ—¶ æ‰€æœ‰ Jenkinsfile: å†™ cronï¼Œæ€»æ˜¯ nightly build é€‚åˆ release/ å¤šç¯å¢ƒéƒ¨ç½²\n","description":"Multibranch Pipeline å’Œæ™®é€š Pipeline æœ€å¤§çš„åŒºåˆ«æ˜¯ \u0026ndash; å®šæ—¶æ„å»ºä¸èƒ½ç›´æ¥åœ¨ Jenkinsfile ç”¨ cron è§¦å‘å…¨éƒ¨åˆ†æ”¯ï¼\nå¿…é¡»åŒºåˆ† ä¸¤ç§å±‚é¢çš„å®šæ—¶ä»»åŠ¡ï¼š\nğŸ”¥ ä½ è¦å†³å®šçš„æ˜¯ ä½ éœ€è¦çš„æ˜¯ï¼š\nâ‘  å®šæœŸæ‰«æä»“åº“ï¼ˆæ‰¾åˆ°æ–°å¢/åˆ é™¤/å˜åŒ–åˆ†æ”¯ï¼‰ï¼Ÿ -\u0026gt; é…ç½® Scan Multibranch Pipeline Triggers\nâ‘¡ å®šæœŸæ‰§è¡Œæ¯ä¸ªåˆ†æ”¯çš„ Pipelineï¼Ÿ -\u0026gt; é…ç½® åœ¨ Jenkinsfile ä¸­è®¾ç½® cronï¼ˆæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹å®šæ—¶ï¼‰\n"},{"id":250,"href":"/operations/jenkins/credentials-error/","title":"Jenkins å‡­æ®é”™è¯¯","parent":"Jenkins","content":"Jenkins åˆ›å»ºå‡­æ®ååœ¨ Credentials åˆ—è¡¨ä¸­ä¸å¯è§ã€æ— æ³•é€‰æ‹©ï¼Œé€šå¸¸æ˜¯å› ä¸ºå‡­æ®ä½œç”¨åŸŸ (Scope) è®¾ç½®é”™è¯¯ã€å‡­æ®ç±»å‹ä¸ä½¿ç”¨åœºæ™¯ä¸åŒ¹é…ã€æ’ä»¶ç¼ºå¤±ï¼ˆå¦‚ Git Pluginï¼‰æˆ– Jenkins ç¼“å­˜/æƒé™é—®é¢˜ã€‚éœ€æ£€æŸ¥å‡­æ®çš„ Domain (åŸŸ) æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®è®¤å…¶å¯¹å½“å‰é¡¹ç›®çš„å¯è§æ€§ã€‚\nå¸¸è§åŸå› åŠæ’æŸ¥æ­¥éª¤ å‡­æ®ä½œç”¨åŸŸ (Scope) ä¸æ­£ç¡®ï¼ˆæœ€å¸¸è§ï¼‰ å‡­æ®å¯èƒ½è¢«é™åˆ¶åœ¨æŸä¸ªç‰¹å®šçš„ Folder æˆ– Item å†…ï¼Œè€Œä¸æ˜¯å…¨å±€ (Global)ã€‚æ£€æŸ¥åˆ›å»ºå‡­æ®æ—¶çš„ Scope è®¾ç½®ã€‚\nå‡­æ®ç±»å‹ä¸åŒ¹é… ä¾‹å¦‚ï¼ŒGit SCM éœ€è¦çš„æ˜¯ Username with password æˆ– SSH Username with private key ç±»å‹å‡­æ®ã€‚å¦‚æœåˆ›å»ºäº† Secret textï¼Œåœ¨ Git é…ç½®ä¸­å°±æ— æ³•é€‰æ‹©ã€‚\nJenkins æ’ä»¶é—®é¢˜ ç¡®ä¿å®‰è£…äº†å¿…éœ€çš„æ’ä»¶ï¼ˆå¦‚ Git plugin, Credentials Binding Plugin ç­‰ï¼‰ã€‚æŸäº›å‡­æ®ç±»å‹ï¼ˆå¦‚ SSHï¼‰ä¾èµ–ç‰¹å®šæ’ä»¶ã€‚\nJenkins ç¼“å­˜/UI é—®é¢˜ å°è¯•åˆ·æ–°é¡µé¢ã€æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œæˆ–é‡å¯ Jenkins æœåŠ¡ã€‚\næƒé™/RBAC (åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶) é—®é¢˜ å½“å‰ç™»å½•ç”¨æˆ·å¯èƒ½æ²¡æœ‰æŸ¥çœ‹è¯¥å‡­æ®çš„æƒé™ï¼ˆç‰¹åˆ«æ˜¯å¯¹äºé™åˆ¶äº†è®¿é—®æƒé™çš„å‡­æ®ï¼‰ã€‚\nåŸŸ (Domain) è®¾ç½®é—®é¢˜ æ£€æŸ¥å‡­æ®æ˜¯å¦è¢«æ·»åŠ åˆ°äº†é”™è¯¯çš„ Domain (ä¾‹å¦‚ï¼ŒæŸäº›ç‰¹å®šæ’ä»¶ä¼šåˆ›å»ºè‡ªå·±çš„åŸŸ)ã€‚\nè§£å†³æµç¨‹ è¿›å…¥ Dashboard \u0026gt; Credentials \u0026gt; System \u0026gt; Global credentials (unrestricted) æˆ–å¯¹åº”çš„ Domain æŸ¥çœ‹ã€‚\næ–°å»ºå‡­æ®æ—¶ï¼Œæ³¨æ„é€‰æ‹©æ­£ç¡®çš„ Kind (ç±»å‹) å’Œ Scope (ä½œç”¨åŸŸï¼Œé€šå¸¸é€‰ Global ä»¥ä¾¿å…¨å±€ä½¿ç”¨)ã€‚\nåœ¨å…·ä½“çš„ Job é…ç½®ä¸­ï¼ˆå¦‚ Git æºç ç®¡ç†ï¼‰ï¼Œç¡®ä¿å‡­æ®åˆ—è¡¨æ˜¾ç¤ºèŒƒå›´ç¬¦åˆé¢„æœŸã€‚\n","description":"Jenkins åˆ›å»ºå‡­æ®ååœ¨ Credentials åˆ—è¡¨ä¸­ä¸å¯è§ã€æ— æ³•é€‰æ‹©ï¼Œé€šå¸¸æ˜¯å› ä¸ºå‡­æ®ä½œç”¨åŸŸ (Scope) è®¾ç½®é”™è¯¯ã€å‡­æ®ç±»å‹ä¸ä½¿ç”¨åœºæ™¯ä¸åŒ¹é…ã€æ’ä»¶ç¼ºå¤±ï¼ˆå¦‚ Git Pluginï¼‰æˆ– Jenkins ç¼“å­˜/æƒé™é—®é¢˜ã€‚éœ€æ£€æŸ¥å‡­æ®çš„ Domain (åŸŸ) æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®è®¤å…¶å¯¹å½“å‰é¡¹ç›®çš„å¯è§æ€§ã€‚\nå¸¸è§åŸå› åŠæ’æŸ¥æ­¥éª¤ å‡­æ®ä½œç”¨åŸŸ (Scope) ä¸æ­£ç¡®ï¼ˆæœ€å¸¸è§ï¼‰ å‡­æ®å¯èƒ½è¢«é™åˆ¶åœ¨æŸä¸ªç‰¹å®šçš„ Folder æˆ– Item å†…ï¼Œè€Œä¸æ˜¯å…¨å±€ (Global)ã€‚æ£€æŸ¥åˆ›å»ºå‡­æ®æ—¶çš„ Scope è®¾ç½®ã€‚\nå‡­æ®ç±»å‹ä¸åŒ¹é… ä¾‹å¦‚ï¼ŒGit SCM éœ€è¦çš„æ˜¯ Username with password æˆ– SSH Username with private key ç±»å‹å‡­æ®ã€‚å¦‚æœåˆ›å»ºäº† Secret textï¼Œåœ¨ Git é…ç½®ä¸­å°±æ— æ³•é€‰æ‹©ã€‚\n"},{"id":251,"href":"/operations/jenkins/best-practices/","title":"Jenkins æœ€ä½³å®è·µ","parent":"Jenkins","content":" 1. Master è§’è‰²è®¾è®¡ï¼ˆä¸è¦æ„å»ºï¼ï¼‰ ç»å¯¹ä¸è¦è®© Jenkins Master æ‰§è¡Œæ„å»ºä»»åŠ¡ã€‚\nMaster åªåšï¼š\nWeb UI Pipeline è°ƒåº¦ Queue ç®¡ç† æ’ä»¶ç®¡ç† å®‰å…¨æ§åˆ¶ éšå¼è„šæœ¬ç¼–è¯‘ï¼ˆGroovyï¼‰ Master ä¸å…è®¸ä»»ä½• job ä½¿ç”¨ agent anyï¼Œå¦åˆ™ä¼šæ±¡æŸ“ Masterã€‚\n-\u0026gt; ä½¿ç”¨ï¼š\nagent { label \u0026#39;linux\u0026#39; } 2. Agent æœ€ä½³å®è·µï¼ˆæ„å»ºå…¨éƒ¨ä¸‹æ”¾ï¼‰ Agent è®¾è®¡åŸåˆ™ï¼š\næ„å»ºç¯å¢ƒéš”ç¦» å¯ä¸¢å¼ƒ è‡ªåŠ¨æ‰©å®¹ ä¸æ±¡æŸ“ç³»ç»Ÿ æœ€å°åŒ–ä¾èµ– ç”Ÿäº§æ¨èé¡ºåº ğŸ¥‡ ç¬¬ä¸€æ¨èï¼šKubernetes åŠ¨æ€ Agent æ¯æ¬¡æ„å»ºåˆ›å»ºä¸€ä¸ª pod æ„å»ºç»“æŸ pod è‡ªåŠ¨é”€æ¯ æ„å»ºç¯å¢ƒæ°¸è¿œå¹²å‡€ å¾®æœåŠ¡é¡¹ç›®ä¸€ä¸€éš”ç¦» æ— é™æ‰©ç¼©å®¹ æˆæœ¬æœ€ä½ ğŸ¥ˆ ç¬¬äºŒæ¨èï¼šDocker Agent æœ¬åœ°æ„å»ºç¯å¢ƒå®¹å™¨åŒ– ä¸æ±¡æŸ“ä¸»æœº ç‰ˆæœ¬å¯æ§ ğŸ¥‰ ç¬¬ä¸‰æ¨èï¼šSSH Agentï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰ éå®¹å™¨åŒ–ç¯å¢ƒ é€‚åˆå›ºå®šç¯å¢ƒï¼ˆå¦‚è€é¡¹ç›®ï¼‰ 3. Jenkinsfile æœ€ä½³å®è·µï¼ˆæœ€é‡è¦ï¼‰ ğŸ”¹ï¼ˆ1ï¼‰æ‰€æœ‰ Job å¿…é¡»ä½¿ç”¨ Pipelineï¼ˆå¼ƒç”¨ Freestyleï¼‰ Pipeline = DevOps as Code\nç»Ÿä¸€è§„èŒƒã€å¯è¿½æº¯ã€å¯ reviewã€å¯å¤ç”¨ã€‚\nğŸ”¹ï¼ˆ2ï¼‰ä¸è¦å†™ Groovy å¤æ‚é€»è¾‘ï¼ˆå¯ç»´æŠ¤æ€§å·®ï¼‰ åä¾‹å­ âŒ\ndef x = [] for(i=0;i\u0026lt;1000;i++){ x.add(i*i) } æ¨èï¼šå°†é€»è¾‘å†™æˆ shell / python è„šæœ¬\nä¿æŒ Jenkinsfile ç®€æ´ã€‚\nğŸ”¹ï¼ˆ3ï¼‰Jenkinsfile å¿…é¡»åˆ† Stage æ¨èç»“æ„ï¼š\nCheckout Build Unit Test Lint Security Scan Docker Build Push Image Deploy (K8S) Notify ğŸ”¹ï¼ˆ4ï¼‰ä½¿ç”¨å¹¶è¡Œæ„å»ºæå‡æ€§èƒ½ stage(\u0026#39;Test\u0026#39;) { parallel { ui: { sh \u0026#39;npm run test:ui\u0026#39; } api: { sh \u0026#39;pytest\u0026#39; } } } ğŸ”¹ï¼ˆ5ï¼‰ä¸è¦æŠŠç§˜é’¥å†™è¿›è„šæœ¬ï¼Œç”¨ Credentials Binding withCredentials([string(credentialsId: \u0026#39;gh-token\u0026#39;, variable: \u0026#39;TOKEN\u0026#39;)]) { sh \u0026#34;curl -H \u0026#39;token: $TOKEN\u0026#39; https://api.github.com\u0026#34; } ğŸ”¹ï¼ˆ6ï¼‰Jenkinsfile æ”¾åœ¨ repo æ ¹ç›®å½• å³ï¼š\nmyproject/ â”œâ”€â”€ Jenkinsfile â”œâ”€â”€ src/ â”œâ”€â”€ tests/ ğŸ”¹ï¼ˆ7ï¼‰ä¸åŒç¯å¢ƒåˆ†å¤šä¸ª Jenkinsfileï¼ˆæœ€ä½³ï¼‰ Jenkinsfile.dev Jenkinsfile.staging Jenkinsfile.prod 4. æ’ä»¶ç®¡ç†æœ€ä½³å®è·µ æ’ä»¶è¶Šå¤š = è¶Šä¸ç¨³å®š\nä¼ä¸šç»éªŒï¼šæ’ä»¶æ§åˆ¶åœ¨ â‰¤ 40 ä¸ªï¼ˆå¦åˆ™å‡çº§é£é™©å·¨å¤§ï¼‰\nå¿…è£…æ’ä»¶æ¸…å•ï¼ˆæœ€å°ç¨³å®šé›†ï¼‰\nåˆ†ç±» æ’ä»¶ Pipeline ä¸»ä½“ pipelineã€workflow-aggregator Git gitã€github branch source Credential credentials-binding Docker dockerã€docker pipeline Kubernetes kubernetes UI blue oceanï¼ˆå¯é€‰ï¼‰ é€šçŸ¥ email-extã€dingding/slack ç¦è£…æ’ä»¶ï¼š\nPublish Over SSHï¼ˆæä¸ç¨³å®šï¼‰ All-in-One Testing æ’ä»¶ï¼ˆä¸å¯æ§ï¼‰ å¤è€æ’ä»¶ï¼ˆå¾ˆå¤š 2020 å‰çš„æ’ä»¶åŸºæœ¬åºŸå¼ƒï¼‰ 5. å®‰å…¨æœ€ä½³å®è·µ ğŸ” å¿…é¡»å¯ç”¨ Global Security Manage Jenkins -\u0026gt; Security ğŸ” ä¸ä½¿ç”¨ admin/admin å¼±å£ä»¤ æ¨èï¼š\nLDAP / AD GitHub OAuth OIDCï¼ˆKeycloakï¼‰ ğŸ” Credentials å¿…é¡»åˆ†ç±» ssh-key secret-text username/password ğŸ” ç¦æ­¢åœ¨ Pipeline è¾“å‡ºæ•æ„Ÿå˜é‡ å³ç¦æ­¢ï¼š\necho \u0026#34;token: ${TOKEN}\u0026#34; ç”¨ï¼š\necho \u0026#34;Using secret token\u0026#34; 6. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ â‘  Master JVM ä¼˜åŒ– /etc/default/jenkins\n-Xms1g -Xmx4g -XX:+UseG1GC â‘¡ Jenkins Home æ”¾ SSDï¼ˆå…³é”®ï¼ï¼‰ é¿å…å¡é¡¿ã€queue å †ç§¯ã€‚\nâ‘¢ æ„å»ºå†å²ä¿ç•™ç­–ç•¥ å…¨éƒ¨æ„å»ºï¼šåªä¿ç•™ 20 æ¬¡\næ—¥å¿—ï¼šåªä¿ç•™ 14 å¤©\nâ‘£ æ¸…ç† workspace åœ¨ job ç»“æŸæ—¶åŠ å…¥ï¼š\ncleanWs() 7. é€šçŸ¥æœ€ä½³å®è·µï¼ˆä¼ä¸šå¿…é…ï¼‰ ä½¿ç”¨ï¼š\nDingTalkï¼ˆé’‰é’‰ï¼‰ Feishuï¼ˆé£ä¹¦ï¼‰ Slack ä¼ä¸šå¾®ä¿¡ ç¤ºä¾‹ï¼š\npost { always { dingTalk(accessToken: CRED, message: \u0026#34;æ„å»ºå®Œæˆ\u0026#34;) } } 8. Deployment æœ€ä½³å®è·µï¼ˆK8Sï¼‰ å¦‚ä½ ä½¿ç”¨ Kubernetesï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼š\nğŸŒŸ å¿…é¡»ä½¿ç”¨ï¼š\nkubectl rollout restart rollout status image digestï¼ˆé¿å… latestï¼‰ ç¤ºä¾‹ï¼š\nsh \u0026#34;\u0026#34;\u0026#34; kubectl set image deploy/myapi app=myapi:${BUILD_NUMBER} kubectl rollout status deploy/myapi \u0026#34;\u0026#34;\u0026#34; 9. ç›‘æ§æœ€ä½³å®è·µï¼ˆJenkins Metricsï¼‰ å¯ç”¨ Metrics Plugin\né…åˆï¼š\nPrometheus Grafana ç›‘æ§æŒ‡æ ‡ï¼š\næŒ‡æ ‡ è¯´æ˜ queue_length æ„å»ºæ’é˜Ÿæ•°é‡ executor_usage Agent ä½¿ç”¨ç‡ build_duration æ„å»ºè€—æ—¶ failed_builds å¤±è´¥ç‡ webhook_latency Git æ¨é€å»¶è¿Ÿ 10. é«˜å¯ç”¨ï¼ˆHAï¼‰ä¸å¤‡ä»½æœ€ä½³å®è·µ ğŸ§© æœ€ç¨³æ–¹æ¡ˆ Kubernetes + StatefulSet + PVC + Velero + CronJob\nJenkins å¤‡ä»½å†…å®¹\n/var/jenkins_home â”œâ”€â”€ jobs â”œâ”€â”€ credentials.xml â”œâ”€â”€ users â”œâ”€â”€ secrets â””â”€â”€ plugins å¤‡ä»½æ–¹å¼ï¼š\nNFS S3 Velero restic å¿«ç…§ 11. æ‰©å±•ï¼šæœ€ä½³ Jenkinsfile æ¨¡æ¿ï¼ˆPython/Node/Go/Javaï¼‰ å¦‚æœä½ è¦ï¼Œæˆ‘å¯ä»¥ä¸€é”®äº§å‡ºï¼š\nPython CI/CD å…¨å¥— Jenkinsfile Node å‰ç«¯/åç«¯ Jenkinsfile Go å¤šæ¨¡å— Jenkinsfile Java Maven/Gradle Jenkinsfile K8S éƒ¨ç½² + Docker æ„å»ºé€šç”¨æ¨¡æ¿ ","description":" 1. Master è§’è‰²è®¾è®¡ï¼ˆä¸è¦æ„å»ºï¼ï¼‰ ç»å¯¹ä¸è¦è®© Jenkins Master æ‰§è¡Œæ„å»ºä»»åŠ¡ã€‚\nMaster åªåšï¼š\nWeb UI Pipeline è°ƒåº¦ Queue ç®¡ç† æ’ä»¶ç®¡ç† å®‰å…¨æ§åˆ¶ éšå¼è„šæœ¬ç¼–è¯‘ï¼ˆGroovyï¼‰ Master ä¸å…è®¸ä»»ä½• job ä½¿ç”¨ agent anyï¼Œå¦åˆ™ä¼šæ±¡æŸ“ Masterã€‚\n-\u0026gt; ä½¿ç”¨ï¼š\nagent { label \u0026#39;linux\u0026#39; } 2. Agent æœ€ä½³å®è·µï¼ˆæ„å»ºå…¨éƒ¨ä¸‹æ”¾ï¼‰ Agent è®¾è®¡åŸåˆ™ï¼š\n"},{"id":252,"href":"/operations/jenkins/cluster/","title":"Jenkins é›†ç¾¤ï¼ˆMaster + Agentï¼‰","parent":"Jenkins","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ä¼ä¸šçº§ Jenkins é›†ç¾¤ï¼ˆMaster + Agent + é«˜å¯ç”¨ + Kubernetes åŠ¨æ€èŠ‚ç‚¹ï¼‰å®Œæ•´æŒ‡å—ï¼ˆæ”¶è—ç‰ˆï¼‰ï¼ŒåŒ…å«åŸç†ã€æ¶æ„å›¾ã€éƒ¨ç½²æ–¹å¼ã€æœ€ä½³å®è·µã€è¸©å‘ç‚¹ï¼Œéå¸¸å…¨é¢ã€‚\n1. Jenkins é›†ç¾¤æ˜¯ä»€ä¹ˆï¼Ÿ Jenkins é›†ç¾¤ = Controllerï¼ˆMasterï¼‰ + å¤šä¸ª Agents\nç›®çš„ï¼š\nåˆ†å¸ƒå¼æ‰§è¡Œæ„å»ºä»»åŠ¡ è§£è€¦ UI / è°ƒåº¦ å’Œ æ„å»º æ”¯æŒå¤§å‹å¹¶å‘ CI/CD éš”ç¦»æ„å»ºç¯å¢ƒï¼ˆJava/Python/Node/Docker/K8Sï¼‰ Jenkins è‡ªèº«çš„ Master ä¸è´Ÿè´£ Heavy Workloadï¼Œåªåšâ€œè°ƒåº¦ + ç®¡ç† UIâ€ã€‚\næ‰€æœ‰æ„å»ºéƒ½åº”è¯¥ä¸‹æ”¾åˆ° Agentsã€‚\n2. Jenkins é›†ç¾¤æ¶æ„å›¾ï¼ˆé€šç”¨ç‰ˆï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Jenkins Master UI / ä»»åŠ¡è°ƒåº¦ / æµæ°´çº¿ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Agent #1 â”‚ â”‚ Agent #2 â”‚ â”‚ Agent #3 â”‚ â”‚ Linux â”‚ â”‚ Docker â”‚ â”‚ Windows â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 3. Jenkins Agent ç±»å‹ï¼ˆå››ç§ä¸»æµï¼‰ ç±»å‹ æè¿° ä¼˜ç‚¹ ä½¿ç”¨åœºæ™¯ SSH Agent Master SSH åˆ°æœºå™¨ ç®€å•ç¨³å®š ä¼ ç»Ÿéƒ¨ç½² JNLP Agent ç”± Agent ä¸»åŠ¨è¿ ç½‘ç»œç©¿é€å¼º å†…ç½‘/æ··åˆç½‘ç»œ Docker Agentï¼ˆæ¨èï¼‰ æ¯æ¬¡æ„å»ºç”Ÿæˆç‹¬ç«‹å®¹å™¨ éš”ç¦»/å¹²å‡€/ä¸€è‡´ ç°ä»£é¡¹ç›® Kubernetes åŠ¨æ€ Agentï¼ˆç”Ÿäº§å¼ºæ¨ï¼‰ åŠ¨æ€åˆ›å»º Pod å¼¹æ€§æ‰©å®¹ ä¼ä¸šçº§ DevOps 4. éƒ¨ç½² Jenkins é›†ç¾¤ï¼ˆæœ€ä½³å®è·µæ¶æ„ï¼‰ â­ æ¨èæ–¹å¼ï¼š\nMaster éƒ¨ç½²åœ¨ Kubernetes Agents ä½¿ç”¨ Kubernetes Pod åŠ¨æ€åˆ›å»º è¿™æ˜¯ç°åœ¨å…¨çƒä¼ä¸šæœ€å¸¸ç”¨çš„æ–¹å¼ã€‚\nğŸ…°ï¸ æ–¹æ¡ˆ Aï¼šJenkinsï¼ˆMasterï¼‰ + SSH Agents 1. Agent æœºå™¨åˆ›å»º jenkins ç”¨æˆ· useradd jenkins mkdir /home/jenkins/.ssh -p chown jenkins:jenkins /home/jenkins/.ssh 2. åœ¨ Jenkins Master æ·»åŠ  SSH æºç å‡­è¯ Manage Jenkins -\u0026gt; Manage Credentials -\u0026gt; Add -\u0026gt; SSH Username with private key 3. ç»‘å®š SSH Agent Manage Jenkins -\u0026gt; Nodes -\u0026gt; New Node é…ç½® Label æ–¹ä¾¿ Pipeline ä½¿ç”¨ï¼š\nagent { label \u0026#39;linux\u0026#39; } ğŸ…±ï¸ æ–¹æ¡ˆ Bï¼šJNLP Agentï¼ˆåå‘è¿æ¥ï¼‰ é€‚ç”¨äºï¼š\nAgent ä¸èƒ½è¢« Master SSH ç½‘ç»œéš”ç¦»ï¼ˆå¦‚ K8S nodeã€äº‘ä¸»æœºï¼‰ Agent æœºå™¨å¯åŠ¨ï¼š\njava -jar agent.jar \\ -jnlpUrl http://master:8080/computer/node1/jenkins-agent.jnlp \\ -secret 1234567890abcdef ğŸ…¾ï¸ æ–¹æ¡ˆ Cï¼šDocker Agentï¼ˆæ„å»ºæ›´å¹²å‡€ï¼‰ å®‰è£… Docker æ’ä»¶ï¼š\nManage Jenkins -\u0026gt; Manage Plugins -\u0026gt; Docker Pipeline Plugin Jenkinsfileï¼š\npipeline { agent { docker { image \u0026#39;python:3.12\u0026#39; args \u0026#39;-v /cache:/cache\u0026#39; } } stages { stage(\u0026#39;Run\u0026#39;) { steps { sh \u0026#39;python --version\u0026#39; } } } } ä¼˜åŠ¿ï¼š\næ„å»ºç¯å¢ƒä¸€è‡´ ä»£ç ä¸ä¾èµ–éš”ç¦» é€‚åˆ Python/Node/Java/Go é¡¹ç›® ğŸ…¿ï¸ æ–¹æ¡ˆ Dï¼šKubernetes åŠ¨æ€ Agentï¼ˆä¼ä¸šçº§æœ€æ¨èï¼‰ â­ æ¶æ„å›¾ï¼ˆK8S åŠ¨æ€ Agentï¼‰\nJenkins Masterï¼ˆåœ¨ K8Sï¼‰ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Pod Agent #1 Pod Agent #2 Pod Agent #3 (python:3.12) (node:20) (maven:3-jdk17) ä¼˜ç‚¹ï¼š\næ— é™æ‰©å®¹ æ„å»ºç¯å¢ƒç”¨å®Œå³åˆ  ä¸ä¼šæ±¡æŸ“ä¸»æœº èµ„æºæˆæœ¬ä½ å¤šé¡¹ç›®éš”ç¦»å¼º â¤ å®‰è£… Kubernetes æ’ä»¶ Manage Jenkins -\u0026gt; Plugins -\u0026gt; Kubernetes â¤ é…ç½® Kubernetes Cloud Manage Jenkins -\u0026gt; Configure Clouds -\u0026gt; Add new cloud -\u0026gt; Kubernetes å¡«å†™ï¼š\nKubernetes URLï¼šè‡ªåŠ¨å¡« Jenkins ç®¡ç†å‘½åç©ºé—´ï¼šjenkins Jenkins URLï¼šhttp://jenkins:8080 Credentialsï¼šä½¿ç”¨ ServiceAccount â¤ Pod Template ç¤ºä¾‹ apiVersion: v1 kind: Pod metadata: labels: jenkins: agent spec: containers: - name: jnlp image: jenkins/inbound-agent:latest imagePullPolicy: IfNotPresent - name: python image: python:3.12 command: - cat tty: true â¤ Jenkinsfile åŠ¨æ€è°ƒåº¦ pipeline { agent { kubernetes { label \u0026#34;python-agent\u0026#34; yaml \u0026#34;\u0026#34;\u0026#34; apiVersion: v1 kind: Pod spec: containers: - name: python image: python:3.12 command: [\u0026#34;sleep\u0026#34;] args: [\u0026#34;99d\u0026#34;] \u0026#34;\u0026#34;\u0026#34; } } stages { stage(\u0026#39;Test\u0026#39;) { steps { container(\u0026#39;python\u0026#39;) { sh \u0026#39;python3 --version\u0026#39; } } } } } 5. Jenkins é›†ç¾¤æŒä¹…åŒ–å­˜å‚¨ï¼ˆéå¸¸å…³é”®ï¼‰ Master çš„ JENKINS_HOME å¿…é¡»æŒä¹…åŒ–ï¼š\nåœºæ™¯ å­˜å‚¨æ–¹å¼ Linux æœ¬åœ°å®‰è£… /var/jenkins_home + SSD Docker volume Kubernetes PVC ï¼ˆæ¨èä½¿ç”¨ 50~200GBï¼‰ 6. Jenkins é›†ç¾¤é«˜å¯ç”¨ï¼ˆHAï¼‰ Jenkins æœ¬èº« ä¸æ”¯æŒ Active/Active\nå¯å®ç°ï¼š\næ–¹å¼ Aï¼šActive/Standbyï¼ˆKeepalivedï¼‰ 2 å° Jenkins å…±äº«å­˜å‚¨ï¼ˆNFSï¼‰ VIPï¼ˆKeepalivedï¼‰ æ–¹å¼ Bï¼šMaster + Backup å®šæ—¶å¤‡ä»½ /var/jenkins_home è·³ç¾æ¢å¤ï¼ˆæœ€å¿« 3 åˆ†é’Ÿï¼‰ æ–¹å¼ Cï¼šK8S StatefulSet å•ç‚¹ï¼ˆæœ€å¸¸ç”¨ï¼‰ é…åˆï¼š\nPVC å¤‡ä»½ Velero CronJob snapshot 7. Jenkins é›†ç¾¤æœ€ä½³å®è·µï¼ˆä¼ä¸šç”Ÿäº§ç¯å¢ƒï¼‰ Master ä¸æ‰§è¡Œä»»ä½•æ„å»º\nå…¨éƒ¨æ„å»ºéƒ½åœ¨ Agentï¼ˆSSH/Docker/K8Sï¼‰\nAgent ä¸€å¾‹å¹²å‡€ä¸”ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆå¼ºçƒˆæ¨è K8S Podï¼‰\nJenkinsfile å…¨éƒ¨å­˜ Git repo\næ„å»ºç¯å¢ƒä¸è£… Node/Python/Maven -\u0026gt; äº¤ç»™å®¹å™¨\nåˆç†ç»™ Agent è®¾ç½® Labelï¼Œå¦‚ï¼š\ngo python node maven docker k8s æ§åˆ¶å°æ—¥å¿—ä¿ç•™ 14 å¤©\næ„å»ºå†å²åªä¿ç•™ 20 æ¬¡\næ’ä»¶æ§åˆ¶åœ¨ 40 ä¸ªä»¥å†…ï¼ˆè¶Šç²¾ç®€è¶Šç¨³å®šï¼‰\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ä¼ä¸šçº§ Jenkins é›†ç¾¤ï¼ˆMaster + Agent + é«˜å¯ç”¨ + Kubernetes åŠ¨æ€èŠ‚ç‚¹ï¼‰å®Œæ•´æŒ‡å—ï¼ˆæ”¶è—ç‰ˆï¼‰ï¼ŒåŒ…å«åŸç†ã€æ¶æ„å›¾ã€éƒ¨ç½²æ–¹å¼ã€æœ€ä½³å®è·µã€è¸©å‘ç‚¹ï¼Œéå¸¸å…¨é¢ã€‚\n1. Jenkins é›†ç¾¤æ˜¯ä»€ä¹ˆï¼Ÿ Jenkins é›†ç¾¤ = Controllerï¼ˆMasterï¼‰ + å¤šä¸ª Agents\nç›®çš„ï¼š\nåˆ†å¸ƒå¼æ‰§è¡Œæ„å»ºä»»åŠ¡ è§£è€¦ UI / è°ƒåº¦ å’Œ æ„å»º æ”¯æŒå¤§å‹å¹¶å‘ CI/CD éš”ç¦»æ„å»ºç¯å¢ƒï¼ˆJava/Python/Node/Docker/K8Sï¼‰ Jenkins è‡ªèº«çš„ Master ä¸è´Ÿè´£ Heavy Workloadï¼Œåªåšâ€œè°ƒåº¦ + ç®¡ç† UIâ€ã€‚\næ‰€æœ‰æ„å»ºéƒ½åº”è¯¥ä¸‹æ”¾åˆ° Agentsã€‚\n2. Jenkins é›†ç¾¤æ¶æ„å›¾ï¼ˆé€šç”¨ç‰ˆï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Jenkins Master UI / ä»»åŠ¡è°ƒåº¦ / æµæ°´çº¿ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Agent #1 â”‚ â”‚ Agent #2 â”‚ â”‚ Agent #3 â”‚ â”‚ Linux â”‚ â”‚ Docker â”‚ â”‚ Windows â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 3. Jenkins Agent ç±»å‹ï¼ˆå››ç§ä¸»æµï¼‰ ç±»å‹ æè¿° ä¼˜ç‚¹ ä½¿ç”¨åœºæ™¯ SSH Agent Master SSH åˆ°æœºå™¨ ç®€å•ç¨³å®š ä¼ ç»Ÿéƒ¨ç½² JNLP Agent ç”± Agent ä¸»åŠ¨è¿ ç½‘ç»œç©¿é€å¼º å†…ç½‘/æ··åˆç½‘ç»œ Docker Agentï¼ˆæ¨èï¼‰ æ¯æ¬¡æ„å»ºç”Ÿæˆç‹¬ç«‹å®¹å™¨ éš”ç¦»/å¹²å‡€/ä¸€è‡´ ç°ä»£é¡¹ç›® Kubernetes åŠ¨æ€ Agentï¼ˆç”Ÿäº§å¼ºæ¨ï¼‰ åŠ¨æ€åˆ›å»º Pod å¼¹æ€§æ‰©å®¹ ä¼ä¸šçº§ DevOps 4. éƒ¨ç½² Jenkins é›†ç¾¤ï¼ˆæœ€ä½³å®è·µæ¶æ„ï¼‰ â­ æ¨èæ–¹å¼ï¼š\n"},{"id":253,"href":"/operations/jenkins/jnlp-agent/","title":"JNLP Agent","parent":"Jenkins","content":"JNLP Agentï¼ˆJava Network Launch Protocol Agentï¼‰æ˜¯ Jenkins ä¸­ä¸€ç§å°† è¿œç¨‹èŠ‚ç‚¹ï¼ˆAgent/Slaveï¼‰è¿æ¥åˆ° Jenkins ä¸»èŠ‚ç‚¹ï¼ˆMaster/Controllerï¼‰çš„æ–¹å¼ã€‚å®ƒå…è®¸ä½ å°†æ„å»ºä»»åŠ¡åˆ†å‘åˆ°å…¶ä»–æœºå™¨ä¸Šæ‰§è¡Œï¼Œå®ç°åˆ†å¸ƒå¼æ„å»ºï¼Œæå‡å¹¶å‘èƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚\nğŸ”§ ä¸€ã€ä»€ä¹ˆæ˜¯ JNLP Agentï¼Ÿ JNLPï¼ˆJava Network Launch Protocolï¼‰æ˜¯ Java æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸é€šè¿‡ Web å¯åŠ¨è¿œç¨‹ Java åº”ç”¨ç¨‹åºã€‚\nåœ¨ Jenkins ä¸­ï¼ŒJNLP Agent æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨è¿œç¨‹æœºå™¨ä¸Šçš„ Java è¿›ç¨‹ï¼Œé€šè¿‡ JNLP åè®®è¿æ¥åˆ° Jenkins ä¸»èŠ‚ç‚¹ï¼Œå¹¶æ¥æ”¶æ„å»ºä»»åŠ¡ã€‚\nä¹Ÿç§°ä¸º â€œInbound Agentâ€ï¼ˆå…¥ç«™ä»£ç†ï¼‰ï¼Œå› ä¸ºæ˜¯ Agent ä¸»åŠ¨è¿æ¥ Masterï¼ˆä¸ SSH Agent çš„â€œå‡ºç«™â€æ–¹å¼ç›¸å¯¹ï¼‰ã€‚\nâœ… é€‚åˆåœºæ™¯ï¼š\nä½ æ— æ³•ä» Jenkins ä¸»æœºç›´æ¥ SSH åˆ°æ„å»ºæœºå™¨ï¼ˆå¦‚ Windows æœºå™¨ã€å®¹å™¨ã€å—é™ç½‘ç»œç¯å¢ƒï¼‰ã€‚ æ„å»ºèŠ‚ç‚¹åœ¨é˜²ç«å¢™/NAT åï¼Œåªèƒ½ä¸»åŠ¨å‘å¤–è¿æ¥ã€‚ éœ€è¦ä¸´æ—¶å¯åŠ¨çš„ Agentï¼ˆå¦‚ Kubernetes Podã€Docker å®¹å™¨ï¼‰ã€‚ ğŸ“¦ äºŒã€JNLP Agent çš„å·¥ä½œåŸç† åœ¨ Jenkins Web UI ä¸­åˆ›å»ºä¸€ä¸ª Permanent Agentï¼ˆæ°¸ä¹…èŠ‚ç‚¹ï¼‰ï¼Œç±»å‹é€‰æ‹© â€œLaunch agent via Java Web Startâ€ï¼ˆå³ JNLPï¼‰ã€‚\nJenkins ä¸ºä¸»æœºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ Agent åç§° å’Œ å¯†é’¥ï¼ˆsecretï¼‰ã€‚\nåœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Agentï¼š\njava -jar agent.jar -jnlpUrl http://\u0026lt;jenkins-url\u0026gt;/computer/\u0026lt;agent-name\u0026gt;/slave-agent.jnlp -secret \u0026lt;secret\u0026gt; -workDir \u0026#34;/path/to/workspace\u0026#34; Agent é€šè¿‡ HTTP/HTTPS è¿æ¥åˆ° Jenkins ä¸»èŠ‚ç‚¹ï¼Œå»ºç«‹æŒä¹…è¿æ¥ã€‚\nJenkins ä¸»èŠ‚ç‚¹å¯å‘è¯¥ Agent åˆ†é… Job æ„å»ºä»»åŠ¡ã€‚\nâš ï¸ æ³¨æ„ï¼š\nagent.jar æ˜¯ Jenkins æä¾›çš„å®¢æˆ·ç«¯ JAR æ–‡ä»¶ï¼Œå¯ä» http://\u0026lt;jenkins-url\u0026gt;/jnlpJars/agent.jar ä¸‹è½½ã€‚ å¿…é¡»å®‰è£… Java è¿è¡Œç¯å¢ƒï¼ˆJRE æˆ– JDKï¼‰åœ¨ Agent æœºå™¨ä¸Šï¼ˆJava 8 æˆ– 11 æ¨èï¼‰ã€‚ ğŸ›  ä¸‰ã€é…ç½® JNLP Agent çš„æ­¥éª¤ 1. åœ¨ Jenkins ä¸»èŠ‚ç‚¹åˆ›å»º Agent è¿›å…¥ Manage Jenkins \u0026gt; Nodes \u0026gt; New Node è¾“å…¥èŠ‚ç‚¹åç§°ï¼ˆå¦‚ build-node-01ï¼‰ é€‰æ‹© Permanent Agent é…ç½®ï¼š Number of executorsï¼šå¹¶å‘æ„å»ºæ•°ï¼ˆå¦‚ 2ï¼‰ Remote root directoryï¼šè¿œç¨‹å·¥ä½œç›®å½•ï¼ˆå¦‚ /data/jenkins/agentï¼‰ Labelsï¼šæ ‡ç­¾ï¼ˆç”¨äº Pipeline ä¸­ agent { label 'xxx' } è°ƒåº¦ï¼‰ï¼Œè¿™é‡Œè®¾ç½®ä¸º agent Launch methodï¼šé€‰æ‹© Launch agent by connecting it to the controller 2. è·å–è¿æ¥ä¿¡æ¯ ä¿å­˜åï¼Œè¿›å…¥è¯¥èŠ‚ç‚¹é¡µé¢ï¼Œä½ ä¼šçœ‹åˆ°ï¼š\nbuild-node-01 Built-In Node ç‚¹å‡» build-node-01ï¼Œä¼šç»™å‡ºç›¸å…³çš„å‘½ä»¤ï¼š\nRun from agent command line: (Unix)\ncurl -sO http://192.168.101.201:8910/jenkins/jnlpJars/agent.jar java -jar agent.jar -url http://192.168.101.201:8910/jenkins/ -secret 4c4e607d4387f58010817498a674c22994a7af907ca99a04da19eb4530377eee -name \u0026#34;build-node-01\u0026#34; -webSocket -workDir \u0026#34;/data/jenkins/agent\u0026#34; Run from agent command line: (Windows)\ncurl.exe -sO http://192.168.101.201:8910/jenkins/jnlpJars/agent.jar java -jar agent.jar -url http://192.168.101.201:8910/jenkins/ -secret 4c4e607d4387f58010817498a674c22994a7af907ca99a04da19eb4530377eee -name \u0026#34;build-node-01\u0026#34; -webSocket -workDir \u0026#34;/data/jenkins/agent\u0026#34; Or run from agent command line, with the secret stored in a file: (Unix)\necho 4c4e607d4387f58010817498a674c22994a7af907ca99a04da19eb4530377eee \u0026gt; secret-file curl -sO http://192.168.101.201:8910/jenkins/jnlpJars/agent.jar java -jar agent.jar -url http://192.168.101.201:8910/jenkins/ -secret @secret-file -name \u0026#34;build-node-01\u0026#34; -webSocket -workDir \u0026#34;/data/jenkins/agent\u0026#34; Or run from agent command line, with the secret stored in a file: (Windows)\necho 4c4e607d4387f58010817498a674c22994a7af907ca99a04da19eb4530377eee\u0026gt; secret-file curl.exe -sO http://192.168.101.201:8910/jenkins/jnlpJars/agent.jar java -jar agent.jar -url http://192.168.101.201:8910/jenkins/ -secret @secret-file -name \u0026#34;build-node-01\u0026#34; -webSocket -workDir \u0026#34;/data/jenkins/agent\u0026#34; ç™»å½• Agent èŠ‚ç‚¹æœåŠ¡å™¨\nmkdir -p /data/jenkins/{app,agent} cd /data/jenkins/app echo 4c4e607d4387f58010817498a674c22994a7af907ca99a04da19eb4530377eee \u0026gt; secret-file curl -sO http://192.168.101.201:8910/jenkins/jnlpJars/agent.jar cat \u0026gt; start.sh \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; #!/bin/bash cd $(dirname $0) nohup /usr/local/jdk/21.0.9/bin/java \\ -jar agent.jar \\ -url http://192.168.101.201:8910/jenkins/ \\ -secret @secret-file \\ -name \u0026#34;build-node-01\u0026#34; \\ -webSocket \\ -workDir \u0026#34;/data/jenkins/agent\u0026#34; \\ \u0026gt; agent.log 2\u0026gt;\u0026amp;1 \u0026amp; EOF bash -x start.sh å›åˆ° Nodes é¡µé¢ï¼Œç‚¹å‡» Built-In Nodeï¼Œé€‰æ‹© Configureï¼Œå°† Number of executors è®¾ç½®ä¸º 0ï¼Œä¿å­˜ï¼ˆsaveï¼‰ã€‚\nJNLP å¯åŠ¨é“¾æ¥ï¼ˆå¦‚ http://jenkins:8080/computer/build-node-01/slave-agent.jnlpï¼‰ Secret å¯†é’¥ï¼ˆç‚¹å‡» â€œSecretâ€ æ˜¾ç¤ºï¼‰ agent.jar ä¸‹è½½åœ°å€ï¼ˆhttp://jenkins:8080/jnlpJars/agent.jarï¼‰ 3. åœ¨ç›®æ ‡æœºå™¨å¯åŠ¨ Agent # ä¸‹è½½ agent.jar wget http://jenkins:8080/jnlpJars/agent.jar # å¯åŠ¨ Agentï¼ˆæ¨èä½¿ç”¨ -secret å‚æ•°ï¼Œæ›´å®‰å…¨ï¼‰ java -jar agent.jar \\ -jnlpUrl http://jenkins:8080/computer/build-node-01/slave-agent.jnlp \\ -secret 1234567890abcdef1234567890abcdef \\ -workDir \u0026#34;/home/jenkins/agent\u0026#34; ğŸ’¡ æç¤ºï¼šå¯å°†å‘½ä»¤å†™å…¥ systemd æœåŠ¡ã€Windows æœåŠ¡æˆ–å¯åŠ¨è„šæœ¬ï¼Œå®ç°å¼€æœºè‡ªå¯ã€‚\nğŸ” å››ã€å®‰å…¨æ€§è€ƒè™‘ Secret å¯†é’¥ï¼šç”¨äºèº«ä»½éªŒè¯ï¼Œé˜²æ­¢æœªæˆæƒè¿æ¥ã€‚ Jenkins å®‰å…¨è®¾ç½®ï¼š å»ºè®®å¯ç”¨ Security Realmï¼ˆå¦‚ LDAPã€ç”¨æˆ·è®¤è¯ï¼‰ã€‚ å¼€å¯ Agent -\u0026gt; Master Securityï¼ˆé˜²æ­¢ Agent æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼‰ã€‚ é™åˆ¶ Agent å¯è®¿é—®çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ã€‚ ç½‘ç»œåŠ å¯†ï¼šå»ºè®®é€šè¿‡ HTTPS æä¾› Jenkins æœåŠ¡ï¼Œé¿å…æ˜æ–‡ä¼ è¾“ã€‚ ğŸ”„ äº”ã€JNLP vs SSH Agent å¯¹æ¯” ç‰¹æ€§ JNLP Agent SSH Agent è¿æ¥æ–¹å‘ Agent -\u0026gt; Masterï¼ˆå…¥ç«™ï¼‰ Master -\u0026gt; Agentï¼ˆå‡ºç«™ï¼‰ é˜²ç«å¢™å‹å¥½ âœ… é€‚åˆ NAT/é˜²ç«å¢™å âŒ éœ€å¼€æ”¾ SSH ç«¯å£ æ“ä½œç³»ç»Ÿæ”¯æŒ è·¨å¹³å°ï¼ˆéœ€ Javaï¼‰ ä¸»è¦ Linuxï¼ˆéœ€ SSH æœåŠ¡ï¼‰ å¯åŠ¨æ–¹å¼ æ‰‹åŠ¨æ‰§è¡Œ Java å‘½ä»¤ Jenkins è‡ªåŠ¨ SSH ç™»å½•å¯åŠ¨ èµ„æºå¼€é”€ éœ€å¸¸é©» Java è¿›ç¨‹ æŒ‰éœ€å¯åŠ¨ï¼Œæ›´è½»é‡ï¼ˆä¸€æ¬¡æ€§ Agentï¼‰ âœ… ç°ä»£æ¨èï¼šå¯¹äºäº‘ç¯å¢ƒæˆ–å®¹å™¨åŒ–åœºæ™¯ï¼Œä½¿ç”¨ Pod Templateï¼ˆKubernetes Pluginï¼‰æˆ– Docker Agent æ›´çµæ´»ï¼Œå®ƒä»¬åº•å±‚ä¹Ÿå¸¸åŸºäº JNLPã€‚\nğŸš€ å…­ã€å¸¸è§é—®é¢˜æ’æŸ¥ é—®é¢˜ å¯èƒ½åŸå›  è§£å†³æ–¹æ¡ˆ Connection refused Jenkins URL ä¸å¯è¾¾ æ£€æŸ¥ç½‘ç»œã€é˜²ç«å¢™ã€Jenkins æ˜¯å¦è¿è¡Œ Invalid secret å¯†é’¥é”™è¯¯æˆ–è¿‡æœŸ é‡æ–°å¤åˆ¶ Secretï¼Œæˆ–åœ¨èŠ‚ç‚¹é…ç½®ä¸­ç‚¹å‡» â€œFixâ€ Unsupported protocol Java ç‰ˆæœ¬ä¸å…¼å®¹ ä½¿ç”¨ Java 8/11ï¼Œé¿å… Java 17+ï¼ˆé™¤é Jenkins æ”¯æŒï¼‰ Agent é¢‘ç¹æ–­å¼€ ç½‘ç»œä¸ç¨³å®š å¢åŠ é‡è¿è„šæœ¬ï¼Œæˆ–æ”¹ç”¨æ›´ç¨³å®šè¿æ¥æ–¹å¼ âœ… æ€»ç»“ JNLP Agent æ˜¯ Jenkins åˆ†å¸ƒå¼æ„å»ºçš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œç‰¹åˆ«é€‚åˆï¼š\næ— æ³•è¢«ä¸»èŠ‚ç‚¹ç›´æ¥è®¿é—®çš„æ„å»ºæœºå™¨ éœ€è¦çµæ´»æ‰©å±•æ„å»ºèµ„æºçš„åœºæ™¯ Windows æˆ–æ··åˆç¯å¢ƒæ„å»º è™½ç„¶é…ç½®ç•¥å¤æ‚ï¼ˆéœ€æ‰‹åŠ¨å¯åŠ¨ Java è¿›ç¨‹ï¼‰ï¼Œä½†å®ƒæ˜¯å®ç° æ¨ªå‘æ‰©å±• Jenkins èƒ½åŠ› çš„å…³é”®ä¸€ç¯ã€‚\n","description":"JNLP Agentï¼ˆJava Network Launch Protocol Agentï¼‰æ˜¯ Jenkins ä¸­ä¸€ç§å°† è¿œç¨‹èŠ‚ç‚¹ï¼ˆAgent/Slaveï¼‰è¿æ¥åˆ° Jenkins ä¸»èŠ‚ç‚¹ï¼ˆMaster/Controllerï¼‰çš„æ–¹å¼ã€‚å®ƒå…è®¸ä½ å°†æ„å»ºä»»åŠ¡åˆ†å‘åˆ°å…¶ä»–æœºå™¨ä¸Šæ‰§è¡Œï¼Œå®ç°åˆ†å¸ƒå¼æ„å»ºï¼Œæå‡å¹¶å‘èƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚\nğŸ”§ ä¸€ã€ä»€ä¹ˆæ˜¯ JNLP Agentï¼Ÿ JNLPï¼ˆJava Network Launch Protocolï¼‰æ˜¯ Java æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸é€šè¿‡ Web å¯åŠ¨è¿œç¨‹ Java åº”ç”¨ç¨‹åºã€‚\nåœ¨ Jenkins ä¸­ï¼ŒJNLP Agent æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨è¿œç¨‹æœºå™¨ä¸Šçš„ Java è¿›ç¨‹ï¼Œé€šè¿‡ JNLP åè®®è¿æ¥åˆ° Jenkins ä¸»èŠ‚ç‚¹ï¼Œå¹¶æ¥æ”¶æ„å»ºä»»åŠ¡ã€‚\nä¹Ÿç§°ä¸º â€œInbound Agentâ€ï¼ˆå…¥ç«™ä»£ç†ï¼‰ï¼Œå› ä¸ºæ˜¯ Agent ä¸»åŠ¨è¿æ¥ Masterï¼ˆä¸ SSH Agent çš„â€œå‡ºç«™â€æ–¹å¼ç›¸å¯¹ï¼‰ã€‚\nâœ… é€‚åˆåœºæ™¯ï¼š\nä½ æ— æ³•ä» Jenkins ä¸»æœºç›´æ¥ SSH åˆ°æ„å»ºæœºå™¨ï¼ˆå¦‚ Windows æœºå™¨ã€å®¹å™¨ã€å—é™ç½‘ç»œç¯å¢ƒï¼‰ã€‚ æ„å»ºèŠ‚ç‚¹åœ¨é˜²ç«å¢™/NAT åï¼Œåªèƒ½ä¸»åŠ¨å‘å¤–è¿æ¥ã€‚ éœ€è¦ä¸´æ—¶å¯åŠ¨çš„ Agentï¼ˆå¦‚ Kubernetes Podã€Docker å®¹å™¨ï¼‰ã€‚ ğŸ“¦ äºŒã€JNLP Agent çš„å·¥ä½œåŸç† åœ¨ Jenkins Web UI ä¸­åˆ›å»ºä¸€ä¸ª Permanent Agentï¼ˆæ°¸ä¹…èŠ‚ç‚¹ï¼‰ï¼Œç±»å‹é€‰æ‹© â€œLaunch agent via Java Web Startâ€ï¼ˆå³ JNLPï¼‰ã€‚\n"},{"id":254,"href":"/operations/linux/journal/","title":"journal","parent":"Linux","content":" ä¸€ã€journal æ˜¯ä»€ä¹ˆï¼Ÿ journal æ˜¯ systemd çš„æ—¥å¿—ç³»ç»Ÿï¼Œå…¨åï¼šsystemd-journald\nå®ƒæ›¿ä»£ï¼ˆæˆ–é…åˆï¼‰ä¼ ç»Ÿçš„ /var/log/*.log æ–‡æœ¬æ—¥å¿—ã€‚\njournal = ç»“æ„åŒ–ã€ç´¢å¼•åŒ–ã€ç»Ÿä¸€å…¥å£çš„ç³»ç»Ÿæ—¥å¿—æ•°æ®åº“\näºŒã€journal vs ä¼ ç»Ÿ syslog å¯¹æ¯”é¡¹ journal /var/log å­˜å‚¨æ ¼å¼ äºŒè¿›åˆ¶ çº¯æ–‡æœ¬ æŸ¥è¯¢ ç´¢å¼•ã€å­—æ®µè¿‡æ»¤ grep å…ƒæ•°æ® ä¸°å¯Œï¼ˆPID/UID/UNITï¼‰ å°‘ é¡ºåº å¼ºä¸€è‡´ å¯èƒ½ä¹±åº æ€§èƒ½ é«˜ IO å¯†é›† è¿œç¨‹ éœ€è½¬å‘ åŸç”Ÿæ”¯æŒ ğŸ“Œ RHEL 9 é»˜è®¤ï¼šjournal + rsyslog å¹¶å­˜\nä¸‰ã€journal çš„æ ¸å¿ƒè®¾è®¡ 1ï¸âƒ£ æ—¥å¿—æ¥æº journal æ”¶é›†ï¼š\nå†…æ ¸æ—¥å¿—ï¼ˆdmesgï¼‰ systemd æœåŠ¡ stdout/stderr syslog audit å†…æ ¸ ring buffer ç»Ÿä¸€å†™å…¥ï¼š\n/run/log/journal/ # ä¸´æ—¶ï¼ˆå†…å­˜ï¼‰ /var/log/journal/ # æŒä¹…åŒ– 2ï¸âƒ£ æŒä¹…åŒ–ç­–ç•¥ï¼ˆéå¸¸é‡è¦ï¼‰ æŸ¥çœ‹å½“å‰æ¨¡å¼\njournalctl --disk-usage é»˜è®¤è¡Œä¸º\næƒ…å†µ å­˜å‚¨ä½ç½® /var/log/journal ä¸å­˜åœ¨ å†…å­˜ï¼ˆé‡å¯å³ä¸¢ï¼‰ /var/log/journal å­˜åœ¨ æŒä¹…åŒ– å¼€å¯æŒä¹…åŒ–\nmkdir -p /var/log/journal systemctl restart systemd-journald å››ã€journalctl å¸¸ç”¨æŸ¥è¯¢ï¼ˆè¿ç»´å¿…ä¼šï¼‰ 1ï¸âƒ£ åŸºæœ¬æŸ¥çœ‹ journalctl journalctl -xe journalctl -f 2ï¸âƒ£ æŒ‰æ—¶é—´ journalctl --since \u0026#34;2025-01-01 10:00\u0026#34; journalctl --since yesterday journalctl --until \u0026#34;1 hour ago\u0026#34; 3ï¸âƒ£ æŒ‰æœåŠ¡ï¼ˆæœ€å¸¸ç”¨ï¼‰ journalctl -u sshd journalctl -u NetworkManager --since today 4ï¸âƒ£ æŒ‰ä¼˜å…ˆçº§ journalctl -p err journalctl -p warning..crit 5ï¸âƒ£ æŒ‰å¯åŠ¨å‘¨æœŸï¼ˆéå¸¸é‡è¦ï¼‰ journalctl --list-boots journalctl -b journalctl -b -1 6ï¸âƒ£ å®æ—¶è·Ÿè¸ª journalctl -u docker -f äº”ã€journal çš„â€œç»“æ„åŒ–å­—æ®µâ€ï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰ 1ï¸âƒ£ å¸¸è§å­—æ®µ å­—æ®µ å«ä¹‰ _PID è¿›ç¨‹ ID _UID ç”¨æˆ· _COMM è¿›ç¨‹å _SYSTEMD_UNIT systemd unit _BOOT_ID å¯åŠ¨ ID _HOSTNAME ä¸»æœºå 2ï¸âƒ£ æŸ¥è¯¢ç¤ºä¾‹ journalctl _PID=1234 journalctl _UID=0 journalctl _SYSTEMD_UNIT=sshd.service 3ï¸âƒ£ æŸ¥çœ‹å­—æ®µåˆ—è¡¨ journalctl -o verbose | head å…­ã€journalctl è¾“å‡ºæ ¼å¼ï¼ˆå¸¸è¢«å¿½ç•¥ï¼‰ journalctl -o short journalctl -o short-iso journalctl -o json journalctl -o json-pretty journalctl -o cat ğŸ“Œ JSON å¯¹æ¥æ—¥å¿—å¹³å°å¿…ç”¨\nä¸ƒã€journal æ—¥å¿—çº§åˆ«ï¼ˆRFC5424ï¼‰ çº§åˆ« æ•°å€¼ emerg 0 alert 1 crit 2 err 3 warning 4 notice 5 info 6 debug 7 å…«ã€journal å­˜å‚¨ä¸æ¸…ç†ï¼ˆç”Ÿäº§å¿…é…ï¼‰ 1ï¸âƒ£ æŸ¥çœ‹å ç”¨ journalctl --disk-usage 2ï¸âƒ£ æ‰‹åŠ¨æ¸…ç† journalctl --vacuum-size=500M # 500M journalctl --vacuum-time=7d # 7 å¤© journalctl --vacuum-time=1w # 1 å‘¨ 3ï¸âƒ£ è‡ªåŠ¨ç­–ç•¥é…ç½® /etc/systemd/journald.conf æ¨èé…ç½®ï¼š\nStorage=persistent SystemMaxUse=1G SystemKeepFree=500M MaxRetentionSec=7day Compress=yes ä¹ã€journal + rsyslog åä½œå…³ç³» journal -\u0026gt; rsyslog\nrsyslog ä» journal è¯»å– å†™å…¥ /var/log/messages module(load=\u0026#34;imjournal\u0026#34;) ğŸ“Œ journal æ˜¯æºï¼Œrsyslog æ˜¯åˆ†å‘\nåã€journal åœ¨æ’éšœä¸­çš„æ ¸å¿ƒç”¨æ³• 1ï¸âƒ£ å¯åŠ¨å¤±è´¥æ’æŸ¥ journalctl -b -p err 2ï¸âƒ£ æŸæœåŠ¡èµ·ä¸æ¥ journalctl -u nginx -xe 3ï¸âƒ£ ç³»ç»Ÿå¡åœ¨ boot journalctl -b -1 4ï¸âƒ£ kernel panic / OOM journalctl -k journalctl -k -p crit åä¸€ã€journal çš„ä¼˜ç¼ºç‚¹ï¼ˆå®¢è§‚ï¼‰ ä¼˜ç‚¹\nå¼ºç»“æ„åŒ– å¿«é€Ÿå®šä½ æ”¯æŒç´¢å¼• åŸç”Ÿ systemd ç¼ºç‚¹\näºŒè¿›åˆ¶ä¸ç›´è§‚ æŸåéš¾ä¿®å¤ å¿…é¡»ç”¨ journalctl åäºŒã€ç”Ÿäº§æœ€ä½³å®è·µï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ å¼€å¯æŒä¹…åŒ– é™åˆ¶ç£ç›˜ä½¿ç”¨ é‡è¦æ—¥å¿—è½¬å‘åˆ°é›†ä¸­æ—¥å¿— ç¦æ­¢æ— é™ debug é…åˆ rsyslog / ELK åä¸‰ã€æ€»ç»“ journal æ˜¯ systemd æ—¶ä»£çš„â€œæ—¥å¿—æ•°æ®åº“â€ã€‚\njournalctl æ˜¯è¿ç»´çš„â€œæ—¥å¿—æŸ¥è¯¢å¼•æ“â€ã€‚\n","description":" ä¸€ã€journal æ˜¯ä»€ä¹ˆï¼Ÿ journal æ˜¯ systemd çš„æ—¥å¿—ç³»ç»Ÿï¼Œå…¨åï¼šsystemd-journald\nå®ƒæ›¿ä»£ï¼ˆæˆ–é…åˆï¼‰ä¼ ç»Ÿçš„ /var/log/*.log æ–‡æœ¬æ—¥å¿—ã€‚\njournal = ç»“æ„åŒ–ã€ç´¢å¼•åŒ–ã€ç»Ÿä¸€å…¥å£çš„ç³»ç»Ÿæ—¥å¿—æ•°æ®åº“\näºŒã€journal vs ä¼ ç»Ÿ syslog å¯¹æ¯”é¡¹ journal /var/log å­˜å‚¨æ ¼å¼ äºŒè¿›åˆ¶ çº¯æ–‡æœ¬ æŸ¥è¯¢ ç´¢å¼•ã€å­—æ®µè¿‡æ»¤ grep å…ƒæ•°æ® ä¸°å¯Œï¼ˆPID/UID/UNITï¼‰ å°‘ é¡ºåº å¼ºä¸€è‡´ å¯èƒ½ä¹±åº æ€§èƒ½ é«˜ IO å¯†é›† è¿œç¨‹ éœ€è½¬å‘ åŸç”Ÿæ”¯æŒ ğŸ“Œ RHEL 9 é»˜è®¤ï¼šjournal + rsyslog å¹¶å­˜\n"},{"id":255,"href":"/backend/python/official/json/","title":"JSON","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/json.html\nPython æä¾› json æ¨¡å—æ¥å¤„ç† JSON æ•°æ®ï¼š\nimport json 1. JSON çš„å››ä¸ªæ ¸å¿ƒå‡½æ•° 1.1 json.loads() â€”â€” JSON å­—ç¬¦ä¸² -\u0026gt; Python å¯¹è±¡ data = json.loads(\u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39;) print(data) # {\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 2} 1.2 json.dumps() â€”â€” Python å¯¹è±¡ -\u0026gt; JSON å­—ç¬¦ä¸² s = json.dumps({\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}) print(s) # \u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39; 1.3 json.load() â€”â€” ä»æ–‡ä»¶è¯»å– JSON -\u0026gt; Python with open(\u0026#34;config.json\u0026#34;) as f: data = json.load(f) 1.4 json.dump() â€”â€” Python -\u0026gt; å†™å…¥ JSON æ–‡ä»¶ with open(\u0026#34;config.json\u0026#34;, \u0026#34;w\u0026#34;) as f: json.dump({\u0026#34;x\u0026#34;: 10}, f) 2. Python ä¸ JSON çš„ç±»å‹æ˜ å°„è¡¨ JSON Python object dict array list string str number int / float true / false True / False null None 3. å¸¸è§å‚æ•°é…ç½®ï¼ˆè¶…é‡è¦ï¼‰ 3.1 indentï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰ è®© JSON æ›´æ¼‚äº®ï¼š\nprint(json.dumps(data, indent=4)) 3.2 ensure_ascii=Falseï¼ˆè¾“å‡ºä¸­æ–‡ï¼‰ é»˜è®¤ï¼šä¸­æ–‡ä¼šå˜æˆ Unicodeï¼š\njson.dumps({\u0026#34;name\u0026#34;: \u0026#34;å¼ ä¸‰\u0026#34;}) # {\u0026#34;name\u0026#34;: \u0026#34;\\u5f20\\u4e09\u0026#34;} æ­£ç¡®ï¼š\njson.dumps({\u0026#34;name\u0026#34;: \u0026#34;å¼ ä¸‰\u0026#34;}, ensure_ascii=False) # {\u0026#34;name\u0026#34;: \u0026#34;å¼ ä¸‰\u0026#34;} 3.3 sort_keys=Trueï¼ˆæŒ‰ key æ’åºï¼‰ json.dumps(data, sort_keys=True) 3.4 default=funcï¼ˆç”¨äºæ— æ³•åºåˆ—åŒ–çš„å¯¹è±¡ï¼‰ ä¾‹å¦‚ï¼šdatetime / Decimal\nimport json from datetime import datetime result = json.dumps( {\u0026#34;time\u0026#34;: datetime.now()}, default=str, # è‡ªåŠ¨è½¬å­—ç¬¦ä¸² ensure_ascii=False ) è®©æ‰€æœ‰â€œä¸èƒ½ JSON åŒ–çš„å¯¹è±¡â€è‡ªåŠ¨å˜å­—ç¬¦ä¸²ã€‚\n4. å¤„ç†éæ ‡å‡† JSONï¼ˆå¸¸è§é”™è¯¯åœºæ™¯ï¼‰ JSON ä¸èƒ½å¤„ç†ï¼š\nå•å¼•å· { 'x': 1 } ç»“å°¾å¤šé€—å· { \u0026quot;x\u0026quot;: 1, } æ³¨é‡Š // datetime Decimal bytes è§£å†³ï¼š\nå»ºè®®ç”¨ default=str è‡ªåŠ¨è½¬æ ¼å¼ æˆ–ç”¨ç¬¬ä¸‰æ–¹åº“ orjson æ›´æ™ºèƒ½ 5. JSON è§£æé”™è¯¯çš„å…¸å‹ä¾‹å­ json.loads(\u0026#34;{\u0026#39;a\u0026#39;: 1}\u0026#34;) # JSONDecodeError: Expecting property name enclosed in double quotes å¿…é¡»æ”¹æˆï¼š\njson.loads(\u0026#39;{\u0026#34;a\u0026#34;: 1}\u0026#39;) 6. å¤„ç†å¤æ‚å¯¹è±¡ï¼ˆè‡ªå®šä¹‰åºåˆ—åŒ–ï¼‰ è‡ªå®šä¹‰ç±» -\u0026gt; JSON\nclass User: def __init__(self, name): self.name = name def encode(obj): if isinstance(obj, User): return {\u0026#34;name\u0026#34;: obj.name} raise TypeError(\u0026#34;æ— æ³•åºåˆ—åŒ–\u0026#34;) u = User(\u0026#34;martin\u0026#34;) print(json.dumps(u, default=encode, ensure_ascii=False)) 7. ååºåˆ—åŒ–è‡ªå®šä¹‰å¯¹è±¡ ç”¨ object_hookï¼š\ndef as_user(d): if \u0026#34;name\u0026#34; in d: return User(d[\u0026#34;name\u0026#34;]) return d user = json.loads(\u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;}\u0026#39;, object_hook=as_user) 8. JSON æµå¼å¤„ç†ï¼ˆå¤§æ–‡ä»¶å¿…å¤‡ï¼‰ ä¸è¦ä¸€æ¬¡æ€§åŠ è½½è¶…å¤§ JSON æ–‡ä»¶ï¼\næ¨èï¼šé€è¡Œè¯»å– NDJSONï¼ˆJSON Linesï¼‰\n{\u0026#34;a\u0026#34;:1} {\u0026#34;a\u0026#34;:2} è§£æï¼š\nwith open(\u0026#34;log.jsonl\u0026#34;) as f: for line in f: item = json.loads(line) process(item) 9. JSON æ€§èƒ½ä¼˜åŒ– 9.1 ä½¿ç”¨ orjsonï¼ˆæœ€å¿«ï¼‰ import orjson orjson.dumps(data) orjson.loads(s) æ¯”å†…ç½® json å¿« 5â€“20 å€ã€‚\n9.2 ä½¿ç”¨ ujsonï¼ˆä¸­ç­‰é€Ÿåº¦ï¼‰ 10. json.dumps() ä¸æ”¯æŒçš„ç±»å‹ï¼ˆå¸¸è§å‘ï¼‰ ç±»å‹ è§£å†³æ–¹æ¡ˆ datetime default=str æˆ–è‡ªå®šä¹‰åºåˆ—åŒ– Decimal float(x) æˆ– default=str bytes .decode() set list(set) ä¾‹å­ï¼š\njson.dumps({\u0026#34;data\u0026#34;: {1,2,3}}, default=list) 11. ä¸¤ä¸ªå¸¸è§æ˜“é”™ç‚¹ 11.1 JSON ä¸æ”¯æŒ tupleï¼Œä¼šè‡ªåŠ¨å˜ list json.dumps((1,2,3)) # [1, 2, 3] 11.2 JSON ä¸æ”¯æŒ Python æ³¨é‡Š { // ä¸è¡Œ \u0026#34;a\u0026#34;: 1 } 12. æ€»ç»“ï¼ˆæœ€æ ¸å¿ƒ 10 æ¡ï¼‰ JSON å­—ç¬¦ä¸² -\u0026gt; Python: loads() Python -\u0026gt; JSON å­—ç¬¦ä¸²: dumps() æ–‡ä»¶è¯»å–/å†™å…¥ç”¨ï¼šload() / dump() è¾“å‡ºä¸­æ–‡è¦ï¼šensure_ascii=False æ’åºï¼šsort_keys=True ç¾åŒ–ï¼šindent=4 æ— æ³•åºåˆ—åŒ–å¯¹è±¡ï¼šç”¨ default=str JSON è¦ç”¨åŒå¼•å·ï¼Œä¸å…è®¸æ³¨é‡Š è¶…å¤§ JSON ç”¨é€è¡Œè§£æï¼ˆJSON Linesï¼‰ æ€§èƒ½æ•æ„Ÿåœºæ™¯æ¨è orjson ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/json.html\nPython æä¾› json æ¨¡å—æ¥å¤„ç† JSON æ•°æ®ï¼š\nimport json 1. JSON çš„å››ä¸ªæ ¸å¿ƒå‡½æ•° 1.1 json.loads() â€”â€” JSON å­—ç¬¦ä¸² -\u0026gt; Python å¯¹è±¡ data = json.loads(\u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39;) print(data) # {\u0026#39;a\u0026#39;: 1, \u0026#39;b\u0026#39;: 2} 1.2 json.dumps() â€”â€” Python å¯¹è±¡ -\u0026gt; JSON å­—ç¬¦ä¸² s = json.dumps({\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}) print(s) # \u0026#39;{\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2}\u0026#39; 1.3 json.load() â€”â€” ä»æ–‡ä»¶è¯»å– JSON -\u0026gt; Python with open(\u0026#34;config.json\u0026#34;) as f: data = json.load(f) 1.4 json.dump() â€”â€” Python -\u0026gt; å†™å…¥ JSON æ–‡ä»¶ with open(\u0026#34;config.json\u0026#34;, \u0026#34;w\u0026#34;) as f: json.dump({\u0026#34;x\u0026#34;: 10}, f) 2. Python ä¸ JSON çš„ç±»å‹æ˜ å°„è¡¨ JSON Python object dict array list string str number int / float true / false True / False null None 3. å¸¸è§å‚æ•°é…ç½®ï¼ˆè¶…é‡è¦ï¼‰ 3.1 indentï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰ è®© JSON æ›´æ¼‚äº®ï¼š\n"},{"id":256,"href":"/operations/kafka/","title":"Kafka","parent":"Operations","content":"Directory List:\nKafka FAQ Kafka åŸºç¡€æ•™ç¨‹ Kafka æ ¸å¿ƒæ¦‚å¿µ Kafka å¸¸ç”¨å‘½ä»¤ Kafka æœ€ä½³å®è·µ Kafka æ¶æ„è¯¦è§£ï¼ˆåº•å±‚åŸç†ï¼‰ Kafka ç»å…¸é—®é¢˜ Kafka è¿ç»´ Kafka é›†ç¾¤ ","description":"Directory List:\nKafka FAQ Kafka åŸºç¡€æ•™ç¨‹ Kafka æ ¸å¿ƒæ¦‚å¿µ Kafka å¸¸ç”¨å‘½ä»¤ Kafka æœ€ä½³å®è·µ Kafka æ¶æ„è¯¦è§£ï¼ˆåº•å±‚åŸç†ï¼‰ Kafka ç»å…¸é—®é¢˜ Kafka è¿ç»´ Kafka é›†ç¾¤ "},{"id":257,"href":"/operations/kafka/command/","title":"Kafka å¸¸ç”¨å‘½ä»¤","parent":"Kafka","content":"æ‰€æœ‰å‘½ä»¤å‡ä¸º Kafka 2.x/3.x é€šç”¨ï¼ˆå« KRaft \u0026amp; Zookeeper æ¨¡å¼å·®å¼‚è¯´æ˜ï¼‰ã€‚\nğŸš€ Kafka å¸¸ç”¨å‘½ä»¤å¤§å…¨ï¼ˆå«é›†ç¾¤ï¼‰ ç›®å½•ï¼š\nKafka åŸºç¡€å‘½ä»¤ï¼ˆç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰ Topic ç›¸å…³å‘½ä»¤ï¼ˆåˆ›å»º/æŸ¥è¯¢/ä¿®æ”¹/åˆ é™¤ï¼‰ åˆ†åŒºä¸å‰¯æœ¬å‘½ä»¤ï¼ˆæ‰©åˆ†åŒº/è¿ç§»åˆ†åŒºï¼‰ æ¶ˆè´¹è€…ç»„å‘½ä»¤ï¼ˆåç§»é‡ç®¡ç†ï¼‰ é›†ç¾¤ç®¡ç†å‘½ä»¤ï¼ˆBroker / Controller / é›†ç¾¤çŠ¶æ€ï¼‰ KRaft æ¨¡å¼å‘½ä»¤ï¼ˆæ—  ZKï¼‰ ZooKeeper æ¨¡å¼å‘½ä»¤ï¼ˆç®¡ç† ISRã€Controllerã€Brokerï¼‰ Reassign Partitionï¼ˆé›†ç¾¤æ‰©å®¹è¿ç§»åˆ†åŒºï¼‰ Kafka è¯Šæ–­/æ£€æŸ¥å‘½ä»¤ï¼ˆDump æ—¥å¿—/æ£€æŸ¥ Consistencyï¼‰ Kafka å·¥å…·æ€»ç»“ï¼ˆè¿ç»´å¿…å¤‡ï¼‰ 1. Kafka åŸºç¡€å‘½ä»¤ 1.1 å¯åŠ¨ Producerï¼ˆå‘½ä»¤è¡Œï¼‰ kafka-console-producer.sh \\ --broker-list localhost:9092 \\ --topic test 1.2 å¯åŠ¨ Consumerï¼ˆå‘½ä»¤è¡Œï¼‰ kafka-console-consumer.sh \\ --bootstrap-server localhost:9092 \\ --topic test \\ --from-beginning 2. Topic ç›¸å…³å‘½ä»¤ 2.1 åˆ›å»º Topic kafka-topics.sh \\ --create \\ --topic test \\ --partitions 3 \\ --replication-factor 3 \\ --bootstrap-server localhost:9092 2.2 æŸ¥çœ‹ Topic åˆ—è¡¨ kafka-topics.sh \\ --list \\ --bootstrap-server localhost:9092 2.3 æŸ¥çœ‹ Topic è¯¦ç»†ä¿¡æ¯ kafka-topics.sh \\ --describe \\ --topic test \\ --bootstrap-server localhost:9092 è¾“å‡ºåŒ…å«ï¼š\nLeader ISR å‰¯æœ¬åˆ—è¡¨ åˆ†åŒºåˆ—è¡¨ 2.4 åˆ é™¤ Topicï¼ˆè½¯åˆ é™¤ï¼‰ kafka-topics.sh \\ --delete \\ --topic test \\ --bootstrap-server localhost:9092 3. åˆ†åŒº / å‰¯æœ¬ç›¸å…³å‘½ä»¤ 3.1 å¢åŠ  Topic åˆ†åŒºï¼ˆä¸å¯å‡å°‘ï¼‰ kafka-topics.sh \\ --alter \\ --topic test \\ --partitions 6 \\ --bootstrap-server localhost:9092 3.2 ä¿®æ”¹å‰¯æœ¬åˆ†å¸ƒï¼ˆReassign Partitionï¼‰ ç”Ÿæˆåˆ†é…è®¡åˆ’ï¼š\nkafka-reassign-partitions.sh \\ --generate \\ --bootstrap-server localhost:9092 \\ --topics-to-move-json-file topics.json \\ --broker-list \u0026#34;1,2,3\u0026#34; æ‰§è¡Œè¿ç§»ï¼š\nkafka-reassign-partitions.sh \\ --execute \\ --bootstrap-server localhost:9092 \\ --reassignment-json-file plan.json æ£€æŸ¥è¿ç§»ï¼š\nkafka-reassign-partitions.sh \\ --verify \\ --bootstrap-server localhost:9092 \\ --reassignment-json-file plan.json 4. æ¶ˆè´¹è€…ç»„å‘½ä»¤ï¼ˆå¿…ä¼šï¼ï¼‰ 4.1 æŸ¥çœ‹æ¶ˆè´¹è€…ç»„åˆ—è¡¨ kafka-consumer-groups.sh \\ --bootstrap-server localhost:9092 \\ --list 4.2 æŸ¥çœ‹æŸä¸ªæ¶ˆè´¹ç»„çŠ¶æ€ / Lag kafka-consumer-groups.sh \\ --bootstrap-server localhost:9092 \\ --describe \\ --group my-group 4.3 é‡ç½® Offsetï¼ˆæœ€å¸¸ç”¨ï¼‰ æ–¹å¼1ï¼šä»æœ€æ—©\nkafka-consumer-groups.sh --bootstrap-server localhost:9092 \\ --group my-group \\ --topic test \\ --reset-offsets --to-earliest --execute æ–¹å¼2ï¼šä»æœ€æ–°\n--to-latest æ–¹å¼3ï¼šæŒ‰å…·ä½“ offset\n--to-offset 1234 æ–¹å¼4ï¼šæŒ‰æ—¥æœŸæ—¶é—´\n--to-datetime 2024-01-01T00:00:00.000 5. é›†ç¾¤ç®¡ç†å‘½ä»¤ï¼ˆBroker / Controllerï¼‰ 5.1 æŸ¥çœ‹é›†ç¾¤ä¸­çš„ Broker åˆ—è¡¨ï¼ˆKRaftï¼‰ kafka-metadata-quorum.sh \\ --bootstrap-server broker1:9092 \\ describe --status 5.2 æŸ¥çœ‹ Controller IDï¼ˆKRaftï¼‰ kafka-metadata-quorum.sh \\ --bootstrap-server broker:9092 \\ describe --cluster-metadata ZooKeeper æ¨¡å¼ï¼š\nzookeeper-shell.sh zk01:2181 ls /brokers/ids get /controller 6. KRaft æ¨¡å¼å‘½ä»¤ï¼ˆæ—  ZKï¼‰ 6.1 å¯åŠ¨ KRaft Controller kafka-storage.sh format -t UUID -c server.properties 6.2 æŸ¥çœ‹ KRaft é›†ç¾¤çŠ¶æ€ kafka-metadata-quorum.sh \\ --bootstrap-server localhost:9092 \\ describe --status 6.3 æŸ¥çœ‹å…ƒæ•°æ®ï¼ˆTopic/Partition é›†ç¾¤ä¿¡æ¯ï¼‰ kafka-metadata-quorum.sh \\ --bootstrap-server localhost:9092 \\ describe --topic test 7. ZooKeeper æ¨¡å¼å‘½ä»¤ï¼ˆä»å¤§é‡ä½¿ç”¨ï¼‰ 7.1 æŸ¥çœ‹ Broker åˆ—è¡¨ zookeeper-shell.sh 127.0.0.1:2181 ls /brokers/ids 7.2 æŸ¥çœ‹æŸä¸ª Topic çš„åˆ†åŒºå…ƒæ•°æ® ls /brokers/topics get /brokers/topics/test 7.3 æŸ¥çœ‹ ISR get /brokers/topics/test/partitions/0/state 7.4 æŸ¥çœ‹å½“å‰ Controller get /controller 8. åˆ†åŒºè¿ç§»ï¼ˆReassign Partitionï¼‰ ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ topics.json\n{ \u0026#34;topics\u0026#34;: [{\u0026#34;topic\u0026#34;: \u0026#34;test\u0026#34;}], \u0026#34;version\u0026#34;: 1 } ç¬¬äºŒæ­¥ï¼šç”Ÿæˆè¿ç§»è®¡åˆ’ï¼š\nkafka-reassign-partitions.sh \\ --generate \\ --broker-list \u0026#34;1,2,3\u0026#34; \\ --topics-to-move-json-file topics.json \\ --bootstrap-server localhost:9092 ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œè¿ç§»\n--execute ç¬¬å››æ­¥ï¼šéªŒè¯\n--verify 9. Kafka è°ƒè¯• + è¯Šæ–­å‘½ä»¤ 9.1 æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¿¡æ¯ï¼ˆDump Log Segmentï¼‰ kafka-dump-log.sh \\ --deep-iteration \\ --files /kafka-logs/test-0/00000000000000000000.log 9.2 æ£€æŸ¥å‰¯æœ¬åŒæ­¥å»¶è¿Ÿ kafka-run-class.sh kafka.tools.GetOffsetShell \\ --broker-list localhost:9092 \\ --topic test 9.3 æŸ¥åˆ†åŒº Leader åˆ†å¸ƒ kafka-topics.sh --describe --bootstrap-server localhost:9092 10. Kafka ç›¸å…³æ‰€æœ‰ CLI å·¥å…·åˆ—è¡¨ï¼ˆæœ€å…¨ï¼‰ å·¥å…· åŠŸèƒ½ kafka-console-producer.sh å‘½ä»¤è¡Œç”Ÿäº§è€… kafka-console-consumer.sh å‘½ä»¤è¡Œæ¶ˆè´¹è€… kafka-topics.sh ç®¡ç† Topic kafka-configs.sh é…ç½®å˜æ›´ kafka-consumer-groups.sh æ¶ˆè´¹ç»„ç®¡ç† kafka-reassign-partitions.sh åˆ†åŒºè¿ç§» kafka-dump-log.sh dump æ—¥å¿—æ®µ kafka-delete-records.sh åˆ é™¤æŒ‡å®š offset ä»¥å‰çš„æ¶ˆæ¯ kafka-metadata-quorum.sh KRaft å…ƒæ•°æ®ç®¡ç† kafka-storage.sh KRaft æ ¼å¼åŒ–å·¥å…· kafka-acls.sh ACL æƒé™ç®¡ç† kafka-get-offsets.sh è·å– offsetï¼ˆæ–°ç‰ˆæœ¬ï¼‰ mirror-maker.sh é›†ç¾¤è·¨ Region åŒæ­¥ ","description":"æ‰€æœ‰å‘½ä»¤å‡ä¸º Kafka 2.x/3.x é€šç”¨ï¼ˆå« KRaft \u0026amp; Zookeeper æ¨¡å¼å·®å¼‚è¯´æ˜ï¼‰ã€‚\nğŸš€ Kafka å¸¸ç”¨å‘½ä»¤å¤§å…¨ï¼ˆå«é›†ç¾¤ï¼‰ ç›®å½•ï¼š\nKafka åŸºç¡€å‘½ä»¤ï¼ˆç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰ Topic ç›¸å…³å‘½ä»¤ï¼ˆåˆ›å»º/æŸ¥è¯¢/ä¿®æ”¹/åˆ é™¤ï¼‰ åˆ†åŒºä¸å‰¯æœ¬å‘½ä»¤ï¼ˆæ‰©åˆ†åŒº/è¿ç§»åˆ†åŒºï¼‰ æ¶ˆè´¹è€…ç»„å‘½ä»¤ï¼ˆåç§»é‡ç®¡ç†ï¼‰ é›†ç¾¤ç®¡ç†å‘½ä»¤ï¼ˆBroker / Controller / é›†ç¾¤çŠ¶æ€ï¼‰ KRaft æ¨¡å¼å‘½ä»¤ï¼ˆæ—  ZKï¼‰ ZooKeeper æ¨¡å¼å‘½ä»¤ï¼ˆç®¡ç† ISRã€Controllerã€Brokerï¼‰ Reassign Partitionï¼ˆé›†ç¾¤æ‰©å®¹è¿ç§»åˆ†åŒºï¼‰ Kafka è¯Šæ–­/æ£€æŸ¥å‘½ä»¤ï¼ˆDump æ—¥å¿—/æ£€æŸ¥ Consistencyï¼‰ Kafka å·¥å…·æ€»ç»“ï¼ˆè¿ç»´å¿…å¤‡ï¼‰ 1. Kafka åŸºç¡€å‘½ä»¤ 1.1 å¯åŠ¨ Producerï¼ˆå‘½ä»¤è¡Œï¼‰ kafka-console-producer.sh \\ --broker-list localhost:9092 \\ --topic test 1.2 å¯åŠ¨ Consumerï¼ˆå‘½ä»¤è¡Œï¼‰ kafka-console-consumer.sh \\ --bootstrap-server localhost:9092 \\ --topic test \\ --from-beginning 2. Topic ç›¸å…³å‘½ä»¤ 2.1 åˆ›å»º Topic kafka-topics.sh \\ --create \\ --topic test \\ --partitions 3 \\ --replication-factor 3 \\ --bootstrap-server localhost:9092 2.2 æŸ¥çœ‹ Topic åˆ—è¡¨ kafka-topics.sh \\ --list \\ --bootstrap-server localhost:9092 2.3 æŸ¥çœ‹ Topic è¯¦ç»†ä¿¡æ¯ kafka-topics.sh \\ --describe \\ --topic test \\ --bootstrap-server localhost:9092 è¾“å‡ºåŒ…å«ï¼š\n"},{"id":258,"href":"/operations/kafka/best-practices/","title":"Kafka æœ€ä½³å®è·µ","parent":"Kafka","content":" 1. Topic è®¾è®¡æœ€ä½³å®è·µ 1.1 åˆ†åŒºæ•°ï¼ˆpartitionsï¼‰ åˆ†åŒºè¶Šå¤šå¹¶å‘è¶Šé«˜ï¼Œä½†å‹åŠ›ä¹Ÿè¶Šå¤§ã€‚\nå»ºè®®ï¼š\næ™®é€šä¸šåŠ¡ï¼š3â€“12 åˆ†åŒº é«˜ååä¸šåŠ¡ï¼š12â€“48 åˆ†åŒº æ‰¹é‡å†™å…¥ç³»ç»Ÿï¼ˆæ—¥å¿—/åŸ‹ç‚¹ï¼‰ï¼š48â€“200 åˆ†åŒº æ³¨æ„å‘ï¼š\nâŒ åˆ†åŒºä¸èƒ½éšä¾¿å¢å¤§ï¼Œä¼šå¯¼è‡´ rebalancingã€æ•°æ®å€¾æ–œã€æ¶ˆè´¹è€…é‡å¹³è¡¡å˜æ…¢ã€‚\n1.2 å‰¯æœ¬æ•°ï¼ˆreplication-factorï¼‰ å»ºè®®ï¼š\nè‡³å°‘ 3 å‰¯æœ¬ ä¸èƒ½ç”¨ 1ï¼ˆæ¶ˆæ¯ä¸¢å¤±ä¸å¯æ¢å¤ï¼‰ 1.3 Topic åç§°è§„èŒƒ {ä¸šåŠ¡}-{æ¨¡å—}-{ç¯å¢ƒ} ç¤ºä¾‹ï¼špay-order-prod 2. ç”Ÿäº§è€…ï¼ˆProducerï¼‰æœ€ä½³å®è·µ 2.1 ACK é…ç½® ç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼š\nacks=all ç¡®ä¿æ•°æ®å†™å…¥æ‰€æœ‰ ISRï¼Œæå¤§é™ä½ä¸¢æ¶ˆæ¯æ¦‚ç‡ã€‚\n2.2 é‡è¯•æœºåˆ¶ retries=âˆ ï¼ˆæ–°ç‰ˆä¸º Integer.MAX_VALUEï¼‰ delivery.timeout.ms=120000 æ³¨æ„ï¼š\nâ— ä¸èƒ½ä½¿ç”¨ retries å°äº delivery.timeout.msï¼Œå¦åˆ™ä¼šäº§ç”Ÿæ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤å‘é€\n2.3 æ‰¹é‡å‘é€è°ƒä¼˜ batch.size=32KB ~ 128KB linger.ms=5~20ms compression.type=zstd æˆ– snappy ç›®çš„è®© Kafka åˆå¹¶æ‰¹é‡å‘é€ï¼Œæé«˜ååã€‚\n2.4 å¹‚ç­‰æ€§å¼€å¯ enable.idempotence=true ä¿è¯ä¸é‡å¤å†™æ¶ˆæ¯ï¼ˆé¿å…åå¤å†™å…¥é€ æˆé‡å¤ï¼‰ã€‚\n2.5 Producer å†…å­˜ç¼“å†² buffer.memory=512MBâ€“2GB é˜²æ­¢å†™å…¥é€Ÿåº¦å¿«äºç½‘ç»œå¸¦å®½å¯¼è‡´é˜»å¡ã€‚\n3. æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰æœ€ä½³å®è·µ 3.1 æ¶ˆè´¹ offset ç®¡ç† å¿…é¡»ä½¿ç”¨ Kafka çš„ï¼š\nenable.auto.commit=false å¹¶æ‰‹åŠ¨æäº¤ï¼š\ncommitSync / commitAsync ç¡®ä¿ï¼š\nå…ˆå¤„ç†æ¶ˆæ¯ -\u0026gt; å†æäº¤ offset é¿å…æ¶ˆæ¯ä¸¢å¤± / å¤šæ¬¡å¤„ç† 3.2 æ¶ˆè´¹ç»„åè°ƒï¼ˆrebalanceï¼‰ä¼˜åŒ– å»ºè®®ï¼š\nsession.timeout.ms=10s heartbeat.interval.ms=3s max.poll.interval.ms=5m é¿å…ï¼š\nå¤„ç†è¿‡æ…¢å¯¼è‡´ rebalance é¢‘ç¹ rebalancing å¯¼è‡´ååä¸‹é™ 3.3 æ¶ˆè´¹è€…å¹¶å‘ æ–¹å¼ï¼š\nå¢åŠ  Consumer æ•°é‡ å¢åŠ åˆ†åŒºæ•° æ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼ˆæœ€ä½³ï¼‰ 4. Broker / é›†ç¾¤æœ€ä½³å®è·µ â­ 4.1 JVM è°ƒä¼˜ Kafka å†…å­˜ï¼š\n-Xms8G -Xmx8G é¿å…åƒåœ¾å›æ”¶å½±å“æ€§èƒ½ï¼š\nG1GC æ˜¯ Kafka å®˜æ–¹æ¨è å †å°½é‡å°ï¼ˆ8â€“20GBï¼‰ é¡µç¼“å­˜äº¤ç»™ OS â­ 4.2 æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ– noatime XFSï¼ˆæ¨èï¼‰ ext4 + journaling disabled Kafka ä¾èµ–é›¶æ‹·è´ï¼ˆsendfileï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿæ€§èƒ½éå¸¸é‡è¦ã€‚\nâ­ 4.3 Socket è°ƒä¼˜ socket.send.buffer.bytes=102400 socket.receive.buffer.bytes=102400 socket.request.max.bytes=104857600 â­ 4.4 åˆ†åŒºå‰¯æœ¬å‡è¡¡ å¼€å¯è‡ªåŠ¨å‡è¡¡ï¼š\nauto.leader.rebalance.enable=true é¿å… leader å…¨åœ¨ä¸€ä¸ªèŠ‚ç‚¹å¯¼è‡´çƒ­ç‚¹ã€‚\nâ­ 4.5 æ•°æ®ç•™å­˜ï¼ˆlog.retentionï¼‰é…ç½® å»ºè®®ï¼š\nlog.retention.hours=48ï½168 log.segment.bytes=1GB log.retention.check.interval.ms=5min é¿å… log æ–‡ä»¶å¤ªå¤šå¯¼è‡´ç£ç›˜ IO å˜å·®ã€‚\n5. å¯é æ€§æœ€ä½³å®è·µï¼ˆä¸ä¸¢æ•°æ®ï¼‰ â­ å¿…é¡»é…ç½®å¦‚ä¸‹ï¼ˆé¿å…ä»»ä½•ä¸¢æ¶ˆæ¯ï¼‰ï¼š\nProducer ç«¯ acks=all enable.idempotence=true retries=âˆ min.insync.replicas=2 Broker ç«¯ min.insync.replicas=2 ä¿è¯è‡³å°‘ 2 ä¸ªå‰¯æœ¬å†™æˆåŠŸã€‚\nâ— ç¦æ­¢ä½¿ç”¨ï¼ˆä¼šå¯¼è‡´ä¸¢æ•°æ®ï¼‰ acks=1 å‰¯æœ¬æ•° = 1 Kafka è¶…è¿‡ç£ç›˜ç©ºé—´åè‡ªåŠ¨åˆ é™¤æ•°æ® auto.commit=true 6. Kafka ç›‘æ§ä¸å‘Šè­¦æœ€ä½³å®è·µ 6.1 æŒ‡æ ‡ï¼ˆé‡ç‚¹ç›‘æ§ï¼‰ ğŸ”¥ æ¶ˆæ¯æ¶ˆè´¹å»¶è¿Ÿï¼ˆLagï¼‰\nå¿…é¡»ç›‘æ§ï¼š\ntopic lag group lag consumer å»¶è¿Ÿè¶‹åŠ¿ Lag è¿‡å¤§ä¼šé€ æˆï¼š\næ¶ˆæ¯å †ç§¯ OOM rebalance ğŸ”¥ Broker é‡è¦æŒ‡æ ‡\nUnder-replicated partitionsï¼ˆURPï¼‰ Offline partitions Request handler idle % Network IO Page cache å‘½ä¸­ç‡ GC æ¬¡æ•°ä¸åœé¡¿ URP ä¸€æ—¦ \u0026gt;0 éœ€ç«‹åˆ»æŠ¥è­¦ã€‚\nğŸ”¥ ç£ç›˜ä½¿ç”¨ç‡\n90% ä»¥ä¸Šå¿…é¡»æŠ¥è­¦ï¼ˆKafka ä¾èµ–é¡ºåºå†™ï¼‰ã€‚\næ¨èç›‘æ§å·¥å…·\nPrometheus + Grafanaï¼ˆæœ€ä¼˜ï¼‰ Kafka Exporter Confluent Control Center Burrowï¼ˆConsumer ç›‘æ§ï¼‰ 7. å®‰å…¨ä¸æƒé™æœ€ä½³å®è·µ 7.1 å¼€å¯ SSLï¼ˆå¦‚æœè·¨ IDC / å…¬ç½‘ï¼‰ SSL + SASL_PLAIN æˆ– SASL SCRAM-SHA-256/SHA-512 7.2 ACL æ§åˆ¶æƒé™ ç”¨æˆ·çº§åˆ«æˆæƒï¼š\nUser:app01 -\u0026gt; TopicA Read User:app01 -\u0026gt; TopicA Write é¿å…è¯¯å†™/è¯¯åˆ ã€‚\n8. æ•°æ®å‹ç¼©ä¸ååä¼˜åŒ– 8.1 å‹ç¼©æ–¹å¼ æ¨èï¼š\nzstdï¼ˆæœ€é«˜å‹ç¼©ç‡+å¿«ï¼‰ snappyï¼ˆæ€§èƒ½æœ€å‡è¡¡ï¼‰ lz4ï¼ˆé«˜ååä¸šåŠ¡ï¼‰ 8.2 æ‰¹é‡æ‹‰å– æ¶ˆè´¹è€…ï¼š\nfetch.min.bytes=1MB fetch.max.wait.ms=50ms max.partition.fetch.bytes=10MB Producerï¼š\nbatch.size=128KB linger.ms=10ms 9. å¸¸è§æ•…éšœä¸æ’æŸ¥æœ€ä½³å®è·µ ğŸ”¥ 9.1 æ¶ˆè´¹å †ç§¯ï¼ˆLag é«˜ï¼‰ æ’æŸ¥æ­¥éª¤ï¼š\næ¶ˆè´¹è€…æ•°é‡å¤Ÿä¸å¤Ÿï¼Ÿ åˆ†åŒºæ•°å¤Ÿä¸å¤Ÿï¼Ÿ æ˜¯å¦ rebalanceï¼Ÿ å•æ¡æ¶ˆæ¯å¤„ç†æ˜¯å¦è¿‡æ…¢ï¼Ÿ æ˜¯å¦ consumer crashï¼Ÿ ğŸ”¥ 9.2 å‡ºç° Under-replicated partitions åŸå› ï¼š\nç£ç›˜æ»¡ èŠ‚ç‚¹å®•æœº ç½‘ç»œæŠ–åŠ¨ GC æ—¶é—´è¿‡é•¿ ğŸ”¥ 9.3 åˆ†åŒºçƒ­ç‚¹ï¼ˆéƒ¨åˆ†åˆ†åŒº QPS é«˜ï¼‰ åŸå› ï¼š\nåˆ†åŒº key è®¾è®¡ä¸åˆç† è§£å†³ï¼š\néšæœºåˆ†åŒº key åˆ†å¸ƒå‡åŒ€ å¢åŠ åˆ†åŒºæ•° ğŸ”¥ 9.4 ç”Ÿäº§ç«¯æŠ¥é”™ï¼šâ€œTimeoutExceptionâ€ åŸå› ï¼š\nbroker å¤ªæ…¢ acks=all + min.insync.replicas=2ï¼Œä½†æ˜¯åŒæ­¥å‰¯æœ¬ä¸å¤Ÿ ç½‘ç»œè´¨é‡å·® ğŸ”¥ 9.5 æ¶ˆè´¹ç«¯æŠ¥é”™ï¼šâ€œCommitFailedExceptionâ€ åŸå› ï¼š\nRebalance æ—¶æäº¤ offset è§£å†³ï¼š\næ”¾åœ¨ poll ä¹‹å¤–æäº¤ ä½¿ç”¨ååŒä»»åŠ¡ï¼ˆCooperative Sticky Assignorï¼‰ ","description":" 1. Topic è®¾è®¡æœ€ä½³å®è·µ 1.1 åˆ†åŒºæ•°ï¼ˆpartitionsï¼‰ åˆ†åŒºè¶Šå¤šå¹¶å‘è¶Šé«˜ï¼Œä½†å‹åŠ›ä¹Ÿè¶Šå¤§ã€‚\nå»ºè®®ï¼š\næ™®é€šä¸šåŠ¡ï¼š3â€“12 åˆ†åŒº é«˜ååä¸šåŠ¡ï¼š12â€“48 åˆ†åŒº æ‰¹é‡å†™å…¥ç³»ç»Ÿï¼ˆæ—¥å¿—/åŸ‹ç‚¹ï¼‰ï¼š48â€“200 åˆ†åŒº æ³¨æ„å‘ï¼š\nâŒ åˆ†åŒºä¸èƒ½éšä¾¿å¢å¤§ï¼Œä¼šå¯¼è‡´ rebalancingã€æ•°æ®å€¾æ–œã€æ¶ˆè´¹è€…é‡å¹³è¡¡å˜æ…¢ã€‚\n1.2 å‰¯æœ¬æ•°ï¼ˆreplication-factorï¼‰ å»ºè®®ï¼š\n"},{"id":259,"href":"/operations/kafka/architecture/","title":"Kafka æ¶æ„è¯¦è§£ï¼ˆåº•å±‚åŸç†ï¼‰","parent":"Kafka","content":" 1. Kafka æ€»ä½“æ¶æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰ Kafka ä¸»è¦ç”± 5 å¤§æ ¸å¿ƒç»„ä»¶æ„æˆï¼š\nProducer -\u0026gt; Broker(Topic/Partition/Replica) -\u0026gt; Consumer Group ^ | Controller ^ | å­˜å‚¨å±‚ 2. Broker æ¶æ„ï¼ˆæ ¸å¿ƒæœåŠ¡å™¨ï¼‰ ä¸€ä¸ª Kafka é›†ç¾¤ç”±å¤šä¸ª Brokerï¼ˆèŠ‚ç‚¹ï¼‰ç»„æˆï¼Œæ¯ä¸ª Broker è´Ÿè´£ï¼š\nTopic ä¸ Partition çš„å­˜å‚¨ è¯»å†™è¯·æ±‚å¤„ç† Leader é€‰ä¸¾ ä¸ Controller é€šä¿¡ï¼ˆä½ç½®ä¿¡æ¯ã€å…ƒæ•°æ®ï¼‰ å®ƒæ˜¯ Kafka çš„è¿è¡Œæ ¸å¿ƒã€‚\n3. Topic \u0026amp; Partitionï¼ˆæé«˜ååçš„å…³é”®ï¼‰ Topicï¼šæ¶ˆæ¯é›†åˆï¼ˆé€»è¾‘æ¦‚å¿µï¼‰\nPartitionï¼šç‰©ç†åˆ†ç‰‡ï¼ˆçœŸæ­£å­˜å‚¨æ¶ˆæ¯çš„åœ°æ–¹ï¼‰\nä¾‹å¦‚ï¼š\nTopic: order Partition æ•°é‡: 3 å¯¹åº”è·¯å¾„: /kafka-logs/order-0 /kafka-logs/order-1 /kafka-logs/order-2 ä¸ºä»€ä¹ˆ Kafka ä½¿ç”¨ Partitionï¼Ÿ\nå› ä¸ºå•çº¿ç¨‹å†™å•æ–‡ä»¶é€Ÿåº¦æœ‰é™ã€‚ä½†ï¼š\nâ€œå¤šä¸ª Partition = å¤šä¸ªæ—¥å¿—æ–‡ä»¶ = å¤šçº¿ç¨‹ + é¡ºåºå†™ = ååçº¿æ€§æå‡â€\nKafka çš„æ‰©å®¹æœ¬è´¨æ˜¯ï¼š\nå¢åŠ  Partition æ•°é‡ï¼ˆæˆ– Broker æ•°é‡ï¼‰\n4. Kafka å­˜å‚¨æ¶æ„ï¼šCommit Logï¼ˆé«˜æ€§èƒ½çš„ç§˜å¯†ï¼‰ æ¯ä¸ª Partition åº•å±‚å°±æ˜¯ä¸€ä¸ª è¿½åŠ å†™æ—¥å¿—ï¼š\nmessage-0 message-1 message-2 ... message-N å†™å…¥æ–¹å¼ï¼š\nå®Œå…¨é¡ºåºå†™ï¼Œç£ç›˜å¯ä»¥æ»¡é€Ÿ åˆ©ç”¨ OS PageCache è¿›è¡Œå†…å­˜ç¼“å­˜ ä½¿ç”¨é›¶æ‹·è´ï¼ˆzero-copyï¼‰æå‡è¯»å–é€Ÿåº¦ Kafka ä¸æ”¯æŒéšæœºåˆ é™¤æ¶ˆæ¯ï¼Œè€Œæ˜¯é€šè¿‡æ®µåˆ‡åˆ† + å®šæœŸæ¸…ç†ï¼š\nä»¥ä¸€å®šå¤§å°åˆ‡åˆ† Segmentï¼ˆlog + indexï¼‰ åˆ°äº†ä¿ç•™æ—¶é—´æˆ–å¤§å°è‡ªåŠ¨åˆ é™¤æ—§æ–‡ä»¶ 5. å‰¯æœ¬æœºåˆ¶ï¼ˆReplicaï¼‰â€” é«˜å¯ç”¨åŸºç¡€ æ¯ä¸ª Partition éƒ½æœ‰å¤šä»½å‰¯æœ¬ï¼Œé»˜è®¤ï¼š\nreplicas = 3 åŒ…å«ï¼š\nLeaderï¼šè¯»å†™çš„æ ¸å¿ƒ Followerï¼šåŒæ­¥ Leader æ•°æ® ä¾‹å¦‚ï¼š\norder-0 Leader: Broker1 Follower: Broker2, Broker3 Leader å´©æºƒæ—¶ï¼ŒController ä¼šæŒ‘ä¸€ä¸ª Follower æˆä¸ºæ–°çš„ Leaderã€‚\n6. ISRï¼ˆIn-Sync Replicasï¼‰â€” å¯é æ€§ä¿éšœ ISR = åŒæ­¥è¿›åº¦è¶³å¤Ÿå¿«çš„å‰¯æœ¬é›†åˆ\nï¼ˆè¢«è®¤ä¸ºæ˜¯â€œå¥åº·å‰¯æœ¬â€ï¼‰ å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒKafka çš„ acks æœºåˆ¶ä¾èµ– ISRï¼š\nacks=all -\u0026gt; Leader + ISR ä¸­æ‰€æœ‰å‰¯æœ¬éƒ½å†™å…¥æˆåŠŸæ‰ç¡®è®¤ å½“ ISR æ‰åˆ°åªå‰©ä¸€ä¸ªå‰¯æœ¬æ—¶ï¼ŒKafka å­˜åœ¨æ•°æ®ä¸¢å¤±é£é™© ISR çš„å­˜åœ¨é¿å…äº†æ…¢å‰¯æœ¬æ‹–æ…¢æ•´ä½“ååã€‚\n7. Controllerï¼ˆæ§åˆ¶å™¨ï¼‰â€” é›†ç¾¤çš„å¤§è„‘ Controller èŠ‚ç‚¹è´Ÿè´£ï¼š\nPartition Leader é€‰ä¸¾ å…ƒæ•°æ®ç®¡ç†ï¼ˆtopicã€åˆ†åŒºã€å‰¯æœ¬ï¼‰ Broker ä¸Šçº¿/ä¸‹çº¿ç®¡ç† é€šçŸ¥ Producer/Consumer æ›´æ–°å…ƒæ•°æ® å¦‚æœ Controller å®•æœºï¼Œä¼šé€‰ä¸¾ä¸€ä¸ªæ–°çš„ Controllerï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹ä¸šåŠ¡é€æ˜ã€‚\n8. Kafka å†™å…¥æµç¨‹ï¼ˆè¶…æ¸…æ™°ï¼‰ Producer -\u0026gt; Broker Leader -\u0026gt; Follower -\u0026gt; ACK è¿”å› è¯¦ç»†æ­¥éª¤ï¼š\nProducer ä» Controller è·å– meta ä¿¡æ¯ï¼ˆLeader èŠ‚ç‚¹ä½ç½®ï¼‰ Producer æ ¹æ®åˆ†åŒºå™¨è§„åˆ™é€‰æ‹©åˆ†åŒº Producer ç›´æ¥å°†æ•°æ®å†™å…¥ Leader Partition Leader å†™å…¥æœ¬åœ° Logï¼ˆé¡ºåºå†™ + PageCacheï¼‰ Follower ä» Leader æ‹‰å–æ•°æ®åŒæ­¥ å½“æ»¡è¶³ acks æ¡ä»¶åï¼ŒLeader è¿”å› ACK Kafka çš„é«˜ååæºè‡ªï¼š\nåˆ†åŒºå¹¶è¡Œå†™ é¡ºåºå†™ç£ç›˜ PageCache æ‰¹é‡å‘é€ï¼ˆbatchï¼‰ å‹ç¼©ï¼ˆzstd/lz4ï¼‰ 9. Kafka è¯»å–æµç¨‹ï¼ˆZero-Copyï¼‰ Consumer -\u0026gt; Broker Leader -\u0026gt; Zero-Copy -\u0026gt; Network -\u0026gt; Consumer Follower é»˜è®¤åªç”¨äºåŒæ­¥ï¼Œä¸æ¥æ”¶ Consumer è¯·æ±‚ã€‚\nï¼ˆé™¤éå¼€å¯ â€œFollower Fetchingâ€ï¼‰ è¯»å–æµç¨‹ï¼š\nConsumer ä» Broker è·å– offset å¯¹åº”çš„æ•°æ® Leader ä½¿ç”¨ index æ‰¾åˆ° file offset ä½¿ç”¨ sendfile() æ‰§è¡Œé›¶æ‹·è´ï¼Œç›´æ¥ä»æ–‡ä»¶å‘é€è‡³ socket Consumer æ”¶åˆ°æ•°æ®å¹¶æäº¤ offset é«˜æ€§èƒ½æ¥æºï¼š\nIndex + Log æ–‡ä»¶æ ¼å¼ç®€å• é¡ºåºè¯»å– Zero-Copyï¼ˆä¸ç”¨ç»è¿‡ç”¨æˆ·æ€-\u0026gt;å†…æ ¸æ€æ¥å›æ‹·è´ï¼‰ 10. Offset ç®¡ç†ï¼ˆæ¶ˆè´¹è¿›åº¦ï¼‰ Kafka ä¸è®°å½•â€œæ¶ˆæ¯æ˜¯å¦æ¶ˆè´¹â€ï¼Œåªè®°å½•ï¼š\nConsumer Group çš„æ¶ˆè´¹ä½ç½®ï¼ˆoffsetï¼‰ Offset å­˜æ”¾äºï¼š\næ—§ç‰ˆæœ¬ï¼šZooKeeper ç°åœ¨ï¼šKafka å†…ç½® Topic __consumer_offsets å¥½å¤„ï¼š\né«˜æ€§èƒ½ å¤šå‰¯æœ¬æŒä¹…åŒ– å¯å›æº¯æ¶ˆè´¹ï¼ˆé‡ç½® offsetï¼‰ 11. Rebalanceï¼ˆå†å‡è¡¡ï¼‰æœºåˆ¶ å½“ä»¥ä¸‹ä»»ä¸€åœºæ™¯è§¦å‘ï¼š\nConsumer åŠ å…¥ Group Consumer é€€å‡º Group åˆ†åŒºæ•°é‡å˜åŒ– Kafka ä¼šè‡ªåŠ¨è¿›è¡Œ Rebalanceã€‚\nRebalance ä¼šæš‚åœæ¶ˆè´¹ -\u0026gt; éœ€è¦é¿å…é¢‘ç¹è§¦å‘ ï¼ˆå¸¸ç”¨å¿ƒè·³ã€SessionTimeout è°ƒä¼˜ï¼‰ 12. KRaftï¼ˆæœ€æ–°æ¶æ„ï¼‰â€” Kafka å»æ‰ ZooKeeper Kafka 3.3 åè¿›å…¥ç”Ÿäº§å¯ç”¨é˜¶æ®µã€‚\nå˜åŒ–ï¼š\næ¨¡å¼ å…ƒæ•°æ®å­˜å‚¨ æ˜¯å¦ä¾èµ– ZK æ—§æ¶æ„ Zookeeper æ˜¯ æ–°æ¶æ„ KRaft Kafka å†…ç½®å…ƒæ•°æ®æ—¥å¿— å¦ KRaft çš„å¥½å¤„ï¼š\næ— éœ€å•ç‹¬éƒ¨ç½² ZK å¯åŠ¨é€Ÿåº¦æ›´å¿« å…ƒæ•°æ®ä¸€è‡´æ€§æ›´å¼º æ¶æ„æ›´ç®€å•ï¼Œæœªæ¥ä¸»æµ KRaft çš„ç»„ä»¶ï¼š\nController Quorumï¼ˆå¤šæ•°æ´¾é€‰ä¸¾ï¼‰ Brokerï¼ˆå…±äº«å…ƒæ•°æ®æ—¥å¿—ï¼‰ 13. Kafka é«˜æ€§èƒ½æ ¸å¿ƒåŸç†æ€»ç»“ï¼ˆæœ€å…³é”® 7 ç‚¹ï¼‰ é¡ºåºå†™ç£ç›˜ï¼ˆcommit logï¼‰ é›¶æ‹·è´ï¼ˆsendfileï¼‰ PageCacheï¼ˆåˆ©ç”¨ OS ç¼“å­˜ï¼‰ åˆ†åŒºï¼ˆPartitionï¼‰å¹¶è¡Œå†™å…¥ æ‰¹å¤„ç†ï¼ˆBatchï¼‰+ å‹ç¼© å‰¯æœ¬å¼‚æ­¥å¤åˆ¶ï¼ˆä¿è¯ååï¼‰ æ¶ˆè´¹è€…ç«¯ä½å¼€é”€ offset ç®¡ç† è¿™äº›ç‰¹æ€§è®© Kafka è½»æ¾è¾¾åˆ°ç™¾ä¸‡çº§ååã€‚\n14. Kafka é«˜å¯ç”¨æ ¸å¿ƒæœºåˆ¶æ€»ç»“ å‰¯æœ¬ï¼ˆReplicaï¼‰ ISR åŒæ­¥é›† Leader é€‰ä¸¾ Controller ç®¡ç† æ¶ˆè´¹è€… Group å†—ä½™ Kafka çš„é«˜å¯ç”¨ä¿éšœæ¥è‡ªï¼š\nâ€œåˆ†å¸ƒå¼ + å¤šå‰¯æœ¬ + è‡ªåŠ¨é€‰ä¸¾ + å…ƒæ•°æ®ä¸€è‡´æ€§â€\n15. ä¸€å›¾æ€»ç»“ Kafka åº•å±‚å·¥ä½œåŸç†ï¼ˆæ–‡å­—ç‰ˆç¤ºæ„ï¼‰ +------------------------+ Producer -----\u0026gt; | Leader Partition | ----\u0026gt; Consumer | (Commit Log + Index) | +-----------+------------+ | Replication (ISR) | Followers ğŸ“Œ æœ€ç»ˆæ€»ç»“ï¼ˆæœ€å…³é”® 15 æ¡ï¼‰ Kafka çš„åº•å±‚å®Œå…¨åŸºäºè¿½åŠ å†™æ—¥å¿—ï¼ˆcommit logï¼‰ Partition æ˜¯ Kafka é«˜ååçš„æœ¬è´¨ åˆ†åŒºå†…æœ‰åºï¼Œåˆ†åŒºé—´æ— åº å¤šå‰¯æœ¬æé«˜å¯ç”¨æ€§è€Œä¸æ˜¯åå ISR ä¿è¯å¼ºä¸€è‡´ï¼ˆacks=allï¼‰ Producer -\u0026gt; Leader å†™å…¥ Follower å¼‚æ­¥åŒæ­¥ Leader Consumer åªè¯» Leaderï¼ˆé»˜è®¤ï¼‰ Zero-copy æå‡æ¶ˆè´¹é€Ÿåº¦ Offset æ˜¯ Consumer çš„è¿›åº¦ Rebalance ä¼šæš‚åœæ¶ˆè´¹ Controller ç®¡ç†å…ƒæ•°æ®å’Œé€‰ä¸¾ Kafka é€šè¿‡æ‰¹å¤„ç†å’Œå‹ç¼©æå‡æ•ˆç‡ ç£ç›˜é¡ºåºå†™ = ä¸‡å…†åå KRaft æ¶æ„æ­£åœ¨æˆä¸ºæœªæ¥ä¸»æµ ","description":" 1. Kafka æ€»ä½“æ¶æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰ Kafka ä¸»è¦ç”± 5 å¤§æ ¸å¿ƒç»„ä»¶æ„æˆï¼š\nProducer -\u0026gt; Broker(Topic/Partition/Replica) -\u0026gt; Consumer Group ^ | Controller ^ | å­˜å‚¨å±‚ 2. Broker æ¶æ„ï¼ˆæ ¸å¿ƒæœåŠ¡å™¨ï¼‰ ä¸€ä¸ª Kafka é›†ç¾¤ç”±å¤šä¸ª Brokerï¼ˆèŠ‚ç‚¹ï¼‰ç»„æˆï¼Œæ¯ä¸ª Broker è´Ÿè´£ï¼š\n"},{"id":260,"href":"/operations/kafka/classic-issues/","title":"Kafka ç»å…¸é—®é¢˜","parent":"Kafka","content":"Kafka çš„é—®é¢˜é›†ä¸­åœ¨ï¼šä¸€è‡´æ€§ã€é¡ºåºæ€§ã€å»¶è¿Ÿã€ç§¯å‹ã€é‡å¹³è¡¡ã€ç£ç›˜ã€ç½‘ç»œã€è¿ç»´å¤æ‚åº¦ã€‚\nä¸€ã€Kafka å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆç±»ä¼¼ Redis ç¼“å­˜é—®é¢˜ï¼‰ 1ï¸âƒ£ æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ï¼ˆæœ€ç»å…¸ï¼‰ ğŸ”´ åœºæ™¯ Producer å·²å‘é€ï¼Œä½† Consumer æ¶ˆè´¹ä¸åˆ° Broker å´©æºƒåæ¶ˆæ¯æ¶ˆå¤± ğŸ” åŸå›  acks=1 / 0 ISR ä¸å¤Ÿ è‡ªåŠ¨æäº¤ offset Leader åˆ‡æ¢ unclean leader election âœ… è§£å†³æ–¹æ¡ˆï¼ˆæ ‡å‡†ç­”æ¡ˆï¼‰ acks=all enable.idempotence=true min.insync.replicas=2 replication.factor=3 enable.auto.commit=false unclean.leader.election.enable=false ğŸ‘‰ Kafka é»˜è®¤ä¸ä¿è¯ä¸ä¸¢æ¶ˆæ¯ï¼Œå¿…é¡»é é…ç½® + è§„èŒƒ\n2ï¸âƒ£ æ¶ˆæ¯é‡å¤é—®é¢˜ï¼ˆKafka å¤©ç”Ÿå­˜åœ¨ï¼‰ ğŸ”´ åœºæ™¯ Consumer é‡å¯ Rebalance æ‰‹åŠ¨é‡è¯• ğŸ” åŸå›  Offset æäº¤å¤±è´¥ ä¸šåŠ¡æœªå®ç°å¹‚ç­‰ âœ… è§£å†³æ–¹æ¡ˆ Producerï¼šå¹‚ç­‰æ€§ / äº‹åŠ¡ Consumerï¼šä¸šåŠ¡å¹‚ç­‰ï¼ˆå”¯ä¸€é”®ã€å»é‡è¡¨ï¼‰ ğŸ‘‰ Kafka çš„è®¾è®¡ç›®æ ‡æ˜¯â€œä¸ä¸¢â€ï¼Œä¸æ˜¯â€œä¸é‡â€\n3ï¸âƒ£ æ¶ˆæ¯é¡ºåºæ€§é—®é¢˜ ğŸ”´ åœºæ™¯ åŒä¸€ä¸šåŠ¡æ¶ˆæ¯ä¹±åº æ‰£æ¬¾ã€çŠ¶æ€æµè½¬å¼‚å¸¸ ğŸ” åŸå›  å¤šåˆ†åŒº ä¸€ä¸ªåˆ†åŒºå¤šä¸ª consumer çº¿ç¨‹ é‡å¹³è¡¡ âœ… è§£å†³æ–¹æ¡ˆ åŒä¸€ key -\u0026gt; åŒä¸€ partition ä¸€ä¸ª partition -\u0026gt; ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹ ä¸åœ¨ä¸šåŠ¡ä¸­ä¹±å¹¶å‘ 4ï¸âƒ£ æ¶ˆæ¯å»¶è¿Ÿé—®é¢˜ï¼ˆKafka â‰  å®æ—¶ç³»ç»Ÿï¼‰ ğŸ”´ åœºæ™¯ å†™å…¥åå‡ ç§’ç”šè‡³å‡ åç§’æ‰æ¶ˆè´¹ é«˜å³°æœŸå»¶è¿Ÿæš´æ¶¨ ğŸ” åŸå›  linger.ms batch.size å¤ªå¤§ Page Cache å‹åŠ› Consumer poll ä¸åŠæ—¶ âœ… è§£å†³æ–¹æ¡ˆ åˆç†é…ç½® linger.ms æ§åˆ¶ batch ç›‘æ§ consumer lag IO ç‹¬ç«‹ç£ç›˜ 5ï¸âƒ£ æ¶ˆæ¯ç§¯å‹ï¼ˆLagï¼‰é—®é¢˜ï¼ˆæé«˜é¢‘ï¼‰ ğŸ”´ åœºæ™¯ Consumer lag ä¸æ–­ä¸Šæ¶¨ æ¶ˆè´¹ä¸è¿‡æ¥ ğŸ” åŸå›  æ¶ˆè´¹èƒ½åŠ› \u0026lt; ç”Ÿäº§èƒ½åŠ› åˆ†åŒºä¸è¶³ å•æ¡æ¶ˆæ¯å¤„ç†å¤ªæ…¢ âœ… è§£å†³æ–¹æ¡ˆ å¢åŠ  Consumer å®ä¾‹ å¢åŠ åˆ†åŒºæ•° å¤šçº¿ç¨‹æ¶ˆè´¹ é™ä½ Producer å†™å…¥é€Ÿç‡ 6ï¸âƒ£ é‡å¹³è¡¡é£æš´ï¼ˆRebalance Stormï¼‰ ğŸ”´ åœºæ™¯ Consumer ç»å¸¸é‡å¹³è¡¡ æ¶ˆè´¹é¢‘ç¹æš‚åœ ğŸ” åŸå›  Consumer é¢‘ç¹é‡å¯ poll è¶…æ—¶ GC STW session.timeout.ms å¤ªå° âœ… è§£å†³æ–¹æ¡ˆ Cooperative Rebalance è°ƒå¤§ session / poll interval é¿å…å®¹å™¨é¢‘ç¹é‡å¯ äºŒã€Kafka è¿ç»´ä¾§å¸¸è§é—®é¢˜ï¼ˆæ¯” Redis æ›´å¤æ‚ï¼‰ 7ï¸âƒ£ ç£ç›˜é—®é¢˜ï¼ˆKafka çš„å‘½æ ¹å­ï¼‰ ğŸ”´ åœºæ™¯ Broker ç£ç›˜æ»¡ IO ç­‰å¾…é«˜ å†™å…¥å˜æ…¢ ğŸ” åŸå›  æ•°æ®ä¿ç•™æ—¶é—´è¿‡é•¿ åˆ†åŒºè¿‡å¤š segment å¤ªå° ç£ç›˜æ··ç”¨ âœ… è§£å†³æ–¹æ¡ˆ ç‹¬ç«‹æ•°æ®ç›˜ è®¾ç½® retention ç›‘æ§ç£ç›˜æ°´ä½ æ‰©å®¹ broker 8ï¸âƒ£ å‰¯æœ¬ä¸åŒæ­¥ï¼ˆUnder Replicatedï¼‰ ğŸ”´ åœºæ™¯ UnderReplicatedPartitions \u0026gt; 0\nğŸ” åŸå›  ç½‘ç»œæ…¢ IO ç“¶é¢ˆ follower æ‹‰å–æ…¢ âœ… è§£å†³æ–¹æ¡ˆ æŸ¥ broker IO æ£€æŸ¥ç½‘ç»œ æ‰©å®¹ broker å‡å°‘åˆ†åŒº 9ï¸âƒ£ Leader é¢‘ç¹åˆ‡æ¢ ğŸ”´ åœºæ™¯ topic leader ä¸ç¨³å®š æ¶ˆè´¹ä¸­æ–­ ğŸ” åŸå›  Broker ä¸ç¨³å®š ç½‘ç»œæŠ–åŠ¨ GC âœ… è§£å†³æ–¹æ¡ˆ JVM å‚æ•°ä¼˜åŒ– ç½‘ç»œæ’æŸ¥ broker èµ„æºé¢„ç•™ ğŸ”Ÿ Controller å‹åŠ›è¿‡å¤§ ğŸ”´ åœºæ™¯ é›†ç¾¤æ“ä½œæ…¢ topic / partition æ“ä½œå¡é¡¿ ğŸ” åŸå›  åˆ†åŒºæ•°è¿‡å¤š é¢‘ç¹ rebalance Broker ä¸Šä¸‹çº¿é¢‘ç¹ âœ… è§£å†³æ–¹æ¡ˆ æ§åˆ¶æ€»åˆ†åŒºæ•° æ‰© broker KRaft æ¨¡å¼ 1ï¸âƒ£1ï¸âƒ£ å…ƒæ•°æ®è†¨èƒ€é—®é¢˜ ğŸ”´ åœºæ™¯ å¯åŠ¨æ…¢ rebalance æ…¢ å†…å­˜å ç”¨å¤§ ğŸ” åŸå›  åˆ†åŒºæ•°çˆ†ç‚¸ topic å¤ªå¤š âœ… ç»éªŒæ³•åˆ™ å• broker â‰¤ 5k åˆ†åŒºï¼ˆå®‰å…¨ï¼‰ é›†ç¾¤ â‰¤ 20k åˆ†åŒºï¼ˆç¨³å¦¥ï¼‰ 1ï¸âƒ£2ï¸âƒ£ è·¨æœºæˆ¿ / è·¨ AZ é—®é¢˜ ğŸ”´ åœºæ™¯ å»¶è¿Ÿé«˜ å‰¯æœ¬ä¸åŒæ­¥ ğŸ” åŸå›  ç½‘ç»œ RTT å¤§ ISR é¢‘ç¹è¿›å‡º âœ… è§£å†³æ–¹æ¡ˆ rack awareness åŒåŸå¤š AZ MirrorMaker 2 1ï¸âƒ£3ï¸âƒ£ æ‰©å®¹ä¸è‡ªåŠ¨å‡è¡¡ï¼ˆè¿ç»´å‘ç‚¹ï¼‰ ğŸ”´ åœºæ™¯ æ–° broker å¾ˆé—² è€ broker å¾ˆå¿™ ğŸ” åŸå›  Kafka ä¸è‡ªåŠ¨è¿ç§»åˆ†åŒº âœ… è§£å†³æ–¹æ¡ˆ æ‰‹åŠ¨ reassignment å®šæœŸåšå‡è¡¡ ä¸‰ã€å¯¹æ¯” ç³»ç»Ÿ å…¸å‹é—®é¢˜ Redis ç©¿é€ã€å‡»ç©¿ã€é›ªå´© Kafka ä¸¢å¤±ã€é‡å¤ã€ä¹±åºã€ç§¯å‹ã€é‡å¹³è¡¡ã€ç£ç›˜ç“¶é¢ˆ æ€»ç»“\nRedis çš„é—®é¢˜åœ¨ã€Œç¼“å­˜ä¸€è‡´æ€§ã€ Kafka çš„é—®é¢˜åœ¨ã€Œé«˜ååä¸‹çš„ä¸€è‡´æ€§ + è¿ç»´å¤æ‚åº¦ã€ å››ã€æ€»ç»“ Kafka å¸¸è§é—®é¢˜ä¸»è¦æœ‰ï¼š\næ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯é‡å¤ã€é¡ºåºæ€§é—®é¢˜ã€æ¶ˆæ¯ç§¯å‹ã€é‡å¹³è¡¡é£æš´ï¼Œä»¥åŠè¿ç»´ä¾§çš„ç£ç›˜ç“¶é¢ˆã€å‰¯æœ¬ä¸åŒæ­¥ã€Leader é¢‘ç¹åˆ‡æ¢ã€åˆ†åŒºæ•°è¿‡å¤šå¯¼è‡´çš„å…ƒæ•°æ®å‹åŠ›ã€‚\nè¿™äº›é—®é¢˜éœ€è¦é€šè¿‡åˆç†çš„ Producer / Consumer é…ç½®ã€åˆ†åŒºä¸å‰¯æœ¬è§„åˆ’ã€ä»¥åŠæŒç»­ç›‘æ§æ¥è§£å†³ã€‚\n","description":"Kafka çš„é—®é¢˜é›†ä¸­åœ¨ï¼šä¸€è‡´æ€§ã€é¡ºåºæ€§ã€å»¶è¿Ÿã€ç§¯å‹ã€é‡å¹³è¡¡ã€ç£ç›˜ã€ç½‘ç»œã€è¿ç»´å¤æ‚åº¦ã€‚\nä¸€ã€Kafka å¼€å‘ä¾§å¸¸è§é—®é¢˜ï¼ˆç±»ä¼¼ Redis ç¼“å­˜é—®é¢˜ï¼‰ 1ï¸âƒ£ æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ï¼ˆæœ€ç»å…¸ï¼‰ ğŸ”´ åœºæ™¯ Producer å·²å‘é€ï¼Œä½† Consumer æ¶ˆè´¹ä¸åˆ° Broker å´©æºƒåæ¶ˆæ¯æ¶ˆå¤± ğŸ” åŸå›  acks=1 / 0 ISR ä¸å¤Ÿ è‡ªåŠ¨æäº¤ offset Leader åˆ‡æ¢ unclean leader election âœ… è§£å†³æ–¹æ¡ˆï¼ˆæ ‡å‡†ç­”æ¡ˆï¼‰ acks=all enable.idempotence=true min.insync.replicas=2 replication.factor=3 enable.auto.commit=false unclean.leader.election.enable=false ğŸ‘‰ Kafka é»˜è®¤ä¸ä¿è¯ä¸ä¸¢æ¶ˆæ¯ï¼Œå¿…é¡»é é…ç½® + è§„èŒƒ\n"},{"id":261,"href":"/operations/kafka/operation/","title":"Kafka è¿ç»´","parent":"Kafka","content":" 1. Kafka é›†ç¾¤è§„åˆ’ 1.1 Broker æ•°é‡å»ºè®® å°è§„æ¨¡ï¼š3 èŠ‚ç‚¹ -\u0026gt; å¯ç”¨ ä¸­è§„æ¨¡ï¼š5â€“7 èŠ‚ç‚¹ -\u0026gt; æ¨è å¤§è§„æ¨¡ï¼š9â€“15 èŠ‚ç‚¹ -\u0026gt; è§†ååæ‰©å±• ä¸è¦ç”¨å¶æ•°ï¼Œé¿å…é€‰ä¸¾å¤šæ•°æ´¾é—®é¢˜ã€‚\n1.2 ç¡¬ä»¶è§„åˆ’ CPU\n8C èµ·æ­¥ å¤§é›†ç¾¤å»ºè®® 16C+ å†…å­˜\n32G èµ·æ­¥ Kafka ä¸»è¦ä¾èµ– PageCacheï¼Œç¡®ä¿ OS æœ‰è¶³å¤Ÿå†…å­˜ç¼“å­˜æ—¥å¿—æ–‡ä»¶ ç£ç›˜\nä¼˜é€‰ SSD å•ç›˜å®¹é‡å»ºè®® 1â€“2TB åˆ†åŒºï¼ˆPartitionï¼‰å°½é‡å‡åŒ€åˆ†å¸ƒåœ¨å¤šç›˜ï¼ˆå¦‚æœç”¨ JBODï¼‰ ç½‘ç»œ\n10Gbps æœ€ä½ é«˜å¹¶å‘ç¯å¢ƒç”¨ 25Gbps 1.3 Kafka å…³é”®é…ç½®ï¼ˆç”Ÿäº§å¿…è°ƒï¼‰ num.network.threads=8 num.io.threads=16 log.retention.hours=168 # 1å‘¨ log.segment.bytes=1GB log.retention.check.interval.ms=300000 default.replication.factor=3 min.insync.replicas=2 message.max.bytes=10MB replica.fetch.max.bytes=50MB è§£é‡Šï¼š\nmin.insync.replicas=2ï¼šé˜²æ­¢ ISR åªæœ‰ 1 ä¸ªæ—¶è¿˜å†™å…¥ log.segment.bytes=1Gï¼šåˆ†ç‰‡å¢å¤§å¯å‡å°‘æ®µæ•° message.max.bytes=10MBï¼šé˜²æ­¢è¶…å¤§æ¶ˆæ¯é˜»å¡ 2. Kafka éƒ¨ç½²æœ€ä½³å®è·µï¼ˆå« K8Sï¼‰ 2.1 Linux éƒ¨ç½²è¦ç‚¹ ä½¿ç”¨ systemd ç®¡ç† å•ç‹¬ç”¨æˆ·ï¼šuseradd kafka å­˜å‚¨è·¯å¾„ï¼š/data/kafka å…³é—­ swapï¼šswapoff -a è°ƒæ•´æ–‡ä»¶å¥æŸ„ï¼šulimit -n 1000000 è®¾ç½® vm.max_map_countï¼švm.max_map_count=262144 2.2 K8S éƒ¨ç½²è¦ç‚¹ï¼ˆéå¸¸å…³é”®ï¼‰ æ¯ä¸ª Broker ç”¨ StatefulSet æ¯ä¸ª Pod è¦ç”¨å›ºå®š hostnameï¼šbroker-0/broker-1/\u0026hellip; ä½¿ç”¨ Local PV æˆ– hostPath æä¾›æœ¬åœ°å­˜å‚¨ è®¾ç½® anti-affinityï¼Œå°†æ¯ä¸ª Broker è°ƒåº¦åˆ°ä¸åŒèŠ‚ç‚¹ readinessProbe ç”¨æ¥é˜»æ­¢æµé‡åœ¨ Kafka æœªå°±ç»ªæ—¶è¿›æ¥ ä½¿ç”¨ NodePort or LoadBalancer æ¥æä¾›å¤–éƒ¨è®¿é—® 3. Kafka æ—¥å¿—ï¼ˆå­˜å‚¨ï¼‰ç®¡ç† æ—¥å¿—ä¿ç•™è§„åˆ™ï¼š\nKafka ä¼šæ ¹æ®æ—¶é—´æˆ–å¤§å°åˆ é™¤è€æ•°æ®ï¼š\nlog.retention.hours # ä¿å­˜æ—¶é—´ log.retention.bytes # ä¿å­˜æ€»å¤§å° å­˜å‚¨æ¸…ç†ç­–ç•¥ï¼š\nâ€œdeleteâ€ -\u0026gt; å¸¸è§æ–¹å¼ï¼Œè¿‡æœŸåç›´æ¥åˆ é™¤ â€œcompactâ€ -\u0026gt; ä¿å­˜æœ€æ–° key-valueï¼Œç”¨äºé…ç½®å‹ Topicï¼Œå¦‚ offsets 4. Kafka ç›‘æ§ï¼ˆå¿…åšï¼‰ 4.1 ç›‘æ§ç³»ç»Ÿå»ºè®® Prometheus + Grafana JMX Exporterï¼ˆExporter ç»™ Prometheus æŠ“ Metricsï¼‰ Kafka Exporterï¼ˆç›‘æ§æ¶ˆè´¹ç»„ Lagï¼‰ 4.2 å¿…ç›‘æ§æŒ‡æ ‡ï¼ˆæœ€å…³é”® 10 ä¸ªï¼‰ â‘  é›†ç¾¤å¥åº· Under Replicated Partitions Offline Partitions Count Active Controller Count ISR Shrink / Expand æ¬¡æ•° â‘¡ å†™å…¥å»¶è¿Ÿ RequestHandlerAvgIdlePercent ProduceRequestRate / ProduceRequestLatency â‘¢ æ¶ˆè´¹ Lag Consumer Group Lagï¼ˆæœ€é‡è¦ï¼ï¼‰ â‘£ ç£ç›˜ Partition å¤§å° Disk Utilization \u0026gt; 85%ï¼ˆå±é™©ï¼‰ â‘¤ ç½‘ç»œ Network Processor Idle Bytes In / Bytes Out â‘¥ JVM GC æ¬¡æ•° Heap Usage Metaspace Usage 5. Kafka æ‰©å®¹ï¼ˆBrokerã€Topicã€Partitionï¼‰ 5.1 æ‰©å®¹ Brokerï¼ˆå¹³æ»‘æ“ä½œï¼‰ æ­¥éª¤ï¼š\næ–°å»º Broker é…ç½®æ–‡ä»¶ï¼ˆbroker.id ä¸åŒï¼‰ å¯åŠ¨æ–° Broker åŠ å…¥é›†ç¾¤ ä½¿ç”¨ kafka-reassign-partitions.sh è¿›è¡Œåˆ†åŒºè¿ç§» ä¸è¦ä¸€æ¬¡è¿ç§»å¤ªå¤šï¼Œé¿å…ç½‘ç»œå’Œç£ç›˜å‹åŠ›ã€‚\n5.2 æ‰©å®¹ Partitionï¼ˆå‰¯ä½œç”¨ï¼ï¼‰ kafka-topics.sh --alter --partitions âš ï¸ å±é™©ç‚¹ï¼š\næ—§æ¶ˆæ¯é¡ºåºä¼šè¢«ç ´åï¼ˆè·¨åˆ†åŒºæ— åºï¼‰ Rebalance è§¦å‘ æœ€ä½³æ—¶æœºï¼šTopic è¿˜æœªæ­£å¼ä¸Šçº¿çš„æ—¶å€™è§„åˆ’ Partition æ•°ã€‚\n6. Kafka é«˜å¯ç”¨è¿ç»´ç­–ç•¥ 6.1 å‰¯æœ¬è§„åˆ’ å»ºè®®ï¼š\nreplication.factor = 3 min.insync.replicas = 2 acks = all ç¡®ä¿ï¼š\nä»»æ„ 1 å° Broker æŒ‚æ‰ä¸ä¼šä¸¢æ•°æ® Leader å´©æºƒå¯å¿«é€Ÿåˆ‡æ¢ 6.2 è·¨æœºæˆ¿éƒ¨ç½² ä¸¤ç§æ¨¡å¼ï¼š\nâ€ åŒé›†ç¾¤ï¼ˆæ¨èï¼‰ æœºæˆ¿ A ä¸€å¥—ã€æœºæˆ¿ B ä¸€å¥— æ•°æ®ç”¨ MirrorMaker åŒæ­¥ ä¼˜ç‚¹ï¼šæ•…éšœéš”ç¦» ç¼ºç‚¹ï¼šæ¶ˆæ¯å»¶è¿Ÿç•¥é«˜\nâ åŒä¸€é›†ç¾¤è·¨æœºæˆ¿ é£é™©ï¼šæœºæˆ¿æ–­ç½‘æ—¶ ISR ä¼šå¤§é‡ shrink -\u0026gt; ä¸šåŠ¡å†™å¤±è´¥\n7. Kafka è°ƒä¼˜ï¼ˆç”Ÿäº§å¿…è°ƒï¼‰ 7.1 Producer è°ƒä¼˜ acks=all retries=10 linger.ms=5~20 batch.size=32KB~128KB compression.type=lz4 max.in.flight.requests.per.connection=1 é«˜ååï¼š\næ‰¹é‡å‘é€ï¼ˆbatchï¼‰ å‹ç¼©ï¼ˆlz4/zstdï¼‰ 7.2 Broker è°ƒä¼˜ num.io.threads=16 num.network.threads=8 log.flush.interval.messages=0 log.flush.interval.ms=0 socket.send.buffer.bytes=102400 socket.receive.buffer.bytes=102400 7.3 Consumer è°ƒä¼˜ max.poll.interval.ms=300000 session.timeout.ms=10000 enable.auto.commit=false fetch.min.bytes=1MB fetch.max.wait.ms=200 å°½é‡å…³é—­è‡ªåŠ¨æäº¤ offsetã€‚\n8. Kafka æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆä¼ä¸šå¿…ç”¨ï¼‰ 8.1 Producer å†™é˜»å¡ï¼ˆå¸¸è§ï¼‰ å¯èƒ½åŸå› ï¼š\nISR ç¼©å° -\u0026gt; Leader ä¸æ»¡è¶³ min.insync.replicas Broker å‹åŠ›å¤§ -\u0026gt; IOã€ç½‘ç»œã€GC æ¶ˆæ¯å¤ªå¤§ -\u0026gt; message.max.bytes é™åˆ¶ 8.2 Consumer Lag æŒç»­ä¸Šæ¶¨ æ’æŸ¥ï¼š\næ˜¯å¦å‘ç”Ÿ Rebalance Consumer çº¿ç¨‹å¤ªå°‘ æ¶ˆè´¹å¤„ç†é€»è¾‘å¤ªæ…¢ fetch.min.bytes / fetch.max.wait è®¾ç½®ä¸åˆç† Broker Leader å‹åŠ›å¤ªå¤§ï¼ˆçƒ­ç‚¹åˆ†åŒºï¼‰ 8.3 Under Replicated Partitionsï¼ˆURPï¼‰ åŸå› ï¼š\nFollower åŒæ­¥å¤ªæ…¢ï¼ˆç£ç›˜ IOã€ç½‘ç»œï¼‰ ISR Shrink ä¸»æœºå‹åŠ›å³°å€¼ å¤„ç†ï¼š\næ£€æŸ¥ follower æ—¥å¿—åŒæ­¥çŠ¶å†µ æŸ¥çœ‹ç½‘ç»œæ˜¯å¦æœ‰ä¸¢åŒ… æ’æŸ¥è¯¥ Broker ç£ç›˜/CPU 8.4 Controller ä¸ç¨³å®š åŸå› ï¼š\nBroker è´Ÿè½½å¤ªé«˜ GC è¿‡é•¿ ç½‘ç»œæŠ–åŠ¨å¯¼è‡´é€‰ä¸¾ å¤„ç†ï¼š\nå¢åŠ  Broker èµ„æº è°ƒæ•´ JVM å‚æ•° æ£€æŸ¥ broker é—´ç½‘ç»œ 8.5 é¢‘ç¹ Rebalance åŸå› ï¼š\nå¿ƒè·³é…ç½®ä¸åˆç† Consumer å®ä¾‹é¢‘ç¹é‡å¯ Topic Partition æ‰©å®¹ å¤„ç†ï¼š\nsession.timeout.ms=10000 heartbeat.interval.ms=3000 max.poll.interval.ms=300000 é¿å…ä¸šåŠ¡é•¿æ—¶é—´ä¸ pollã€‚\n9. Kafka å®‰å…¨ï¼ˆACLã€è¯ä¹¦ï¼‰ 9.1 å¯ç”¨ SSL/TLS ssl.keystore.location ssl.truststore.location ssl.keystore.password ssl.enabled.protocols=TLSv1.2 9.2 å¯ç”¨ SASL + SCRAM ç™»é™†è®¤è¯ sasl.enabled.mechanisms=SCRAM-SHA-256 sasl.mechanism.inter.broker.protocol=SCRAM-SHA-256 å®¢æˆ·ç«¯é…ç½®ï¼š\nsasl.mechanism=SCRAM-SHA-256 security.protocol=SASL_SSL sasl.jaas.config=com.sun.security.auth.module.Krb5LoginModule required ... ğŸ“Œ æœ€ç»ˆæ€»ç»“ï¼šKafka è¿ç»´æœ€å…³é”® 20 æ¡ Broker ç”¨å¥‡æ•°å° ç£ç›˜ç”¨ SSD Partition è§„åˆ’ä¸€å®šè¦æå‰ offsets å­˜åœ¨ __consumer_offsets ç›‘æ§ï¼šLagã€URPã€Controllerã€ç£ç›˜ å¯ç”¨ KRaft ä»£æ›¿ ZooKeeper acks=all + min.insync.replicas=2 ä¸è¦è½»æ˜“æ‰©å®¹ partition Follower è½åä¸¥é‡ä¼š SHRINK ISR Rebalance ä¼šæš‚åœæ¶ˆè´¹ é¿å…è·¨æœºæˆ¿å•é›†ç¾¤ Producer æ‰¹é‡+å‹ç¼©æé«˜åå Consumer å¤šçº¿ç¨‹æé«˜å¹¶å‘ è¯»å†™éƒ½èµ° Leaderï¼ˆé»˜è®¤ï¼‰ é›¶æ‹·è´æå‡è¯»æ€§èƒ½ PageCache æå‡å†™æ€§èƒ½ æ§åˆ¶ GCï¼Œé¿å… Full GC é¿å…çƒ­ç‚¹åˆ†åŒº é¿å…è¶…å¤§å•æ¡æ¶ˆæ¯ï¼ˆ\u0026gt;5MBï¼‰ K8S ä¸­å¿…é¡»ä½¿ç”¨ StatefulSet + æœ¬åœ°å­˜å‚¨ ","description":" 1. Kafka é›†ç¾¤è§„åˆ’ 1.1 Broker æ•°é‡å»ºè®® å°è§„æ¨¡ï¼š3 èŠ‚ç‚¹ -\u0026gt; å¯ç”¨ ä¸­è§„æ¨¡ï¼š5â€“7 èŠ‚ç‚¹ -\u0026gt; æ¨è å¤§è§„æ¨¡ï¼š9â€“15 èŠ‚ç‚¹ -\u0026gt; è§†ååæ‰©å±• ä¸è¦ç”¨å¶æ•°ï¼Œé¿å…é€‰ä¸¾å¤šæ•°æ´¾é—®é¢˜ã€‚\n1.2 ç¡¬ä»¶è§„åˆ’ CPU\n"},{"id":262,"href":"/operations/kafka/cluster/","title":"Kafka é›†ç¾¤","parent":"Kafka","content":" 1. Kafka é›†ç¾¤æ˜¯ä»€ä¹ˆï¼Ÿ Kafka é›†ç¾¤ç”±å¤šä¸ª Broker èŠ‚ç‚¹ç»„æˆï¼Œå®ƒä»¬å…±åŒæ‰¿æ‹…ï¼š\næ•°æ®å†™å…¥ï¼ˆProducerï¼‰ æ•°æ®è¯»å–ï¼ˆConsumerï¼‰ å­˜å‚¨æ•°æ®ï¼ˆLog Segmentï¼‰ åˆ†åŒºå‰¯æœ¬åŒæ­¥ Leader é€‰ä¸¾ å…ƒæ•°æ®ç®¡ç† é«˜å¯ç”¨ä¸å®¹é”™ ä¸€ä¸ªç”Ÿäº§çº§ Kafka é›†ç¾¤ä¸€èˆ¬åŒ…å«ï¼š\n3â€“9 å° Brokerï¼ˆæœ€å°ç”Ÿäº§è§„æ ¼ï¼š3ï¼‰ + Zookeeperï¼ˆæˆ– KRaft æ¨¡å¼ï¼‰ 2. Kafka é›†ç¾¤å…³é”®ç»„ä»¶ 2.1 Broker ä¸€å° Kafka æœåŠ¡å®ä¾‹å°±æ˜¯ä¸€ä¸ª Brokerã€‚\nåŠŸèƒ½ï¼š\nä¿å­˜åˆ†åŒºæ•°æ® å“åº” Producer å†™è¯·æ±‚ å“åº” Consumer è¯»è¯·æ±‚ ç®¡ç†æ—¥å¿—æ–‡ä»¶ã€æ®µæ–‡ä»¶ï¼ˆsegmentï¼‰ æ ¹æ® Controller æŒ‡ä»¤å®Œæˆ leader è¿ç§» ä¸€èˆ¬å»ºè®®è‡³å°‘ 3â€“5 ä¸ª Brokerã€‚\n2.2 Zookeeper / KRaftï¼ˆå…ƒæ•°æ®ç®¡ç†ï¼‰ Kafka æœ‰ä¸¤ç§æ¨¡å¼ï¼š\n1. Zookeeper æ¨¡å¼ï¼ˆLegacyï¼‰ ç›®å‰ä¼ä¸šä½¿ç”¨æœ€å¤š ZK ç®¡ç†å…ƒæ•°æ®ï¼ˆISRã€ACLã€Broker åˆ—è¡¨ã€Topic é…ç½®ï¼‰ Kafka ä¾èµ– ZK è¿›è¡Œ Leader é€‰ä¸¾ 2. KRaft æ¨¡å¼ï¼ˆæ–°æ¶æ„ï¼Œæ— éœ€ Zookeeperï¼‰ ä» Kafka 2.8 å¼€å§‹å¼•å…¥ Kafka è‡ªå·±å­˜å‚¨å…ƒæ•°æ® ä½¿ç”¨ Raft åè®®ä¿è¯ä¸€è‡´æ€§ æ–°ç‰ˆæœ¬æœªæ¥å°†å®Œå…¨æ›¿ä»£ ZK è‹¥ä½ å‡†å¤‡æ–°å»ºé›†ç¾¤ï¼Œæ¨èç›´æ¥ä½¿ç”¨ KRaftã€‚\n3. Kafka é›†ç¾¤ä¸­çš„ Topicã€Partitionã€Replica 3.1 Topicï¼ˆä¸»é¢˜ï¼‰ ä¸€ä¸ª Topic æ˜¯æ•°æ®çš„é€»è¾‘åˆ†ç±»ï¼Œå¦‚ï¼š\norder trade user-login 3.2 Partitionï¼ˆåˆ†åŒºï¼‰ Topic ä¼šè¢«æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œä»¥æå‡ååå’Œå¹¶å‘ã€‚\nä¾‹å¦‚ï¼š\nTopic A = 6 partitions æ•°æ®åˆ†å¸ƒåœ¨ä¸åŒ Brokerï¼š\nPartition Broker p0 1 p1 2 p2 3 p3 1 p4 2 p5 3 3.3 Replicaï¼ˆå‰¯æœ¬ï¼‰ æ¯ä¸ªåˆ†åŒºå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼š\nreplication-factor=3 # 3 å‰¯æœ¬ å‰¯æœ¬åˆ†ä¸ºï¼š\nLeader å‰¯æœ¬ï¼ˆå”¯ä¸€ï¼‰ Follower å‰¯æœ¬ï¼ˆ1 æˆ–å¤šä¸ªï¼‰ Leader å¤„ç†ï¼š\nå†™ è¯» offset æäº¤ Follower åªèƒ½æ‹‰å–æ•°æ®åŒæ­¥ã€‚\n4. Kafka é›†ç¾¤æ•°æ®åŒæ­¥æœºåˆ¶ï¼ˆISRï¼‰ ISRï¼ˆIn-Sync Replicasï¼‰ Kafka ä¿è¯æ•°æ®å¯é æ€§çš„å…³é”®ï¼š\nLeader å†™å…¥æ•°æ®å Follower ä¼šå¼‚æ­¥æ‹‰å–åŒæ­¥ åªæœ‰åŒæ­¥â€œè¶³å¤Ÿå¿«â€çš„ Follower æ‰èƒ½è¿›å…¥ ISR ä¾‹å¦‚ replication=3ï¼š\np0 leader = broker1 p0 followers = broker2, broker3 ISR = {1,2,3} è‹¥ broker3 åŒæ­¥å¤ªæ…¢ï¼Œä¼šè¢«è¸¢å‡º ISRï¼š\nISR = {1,2}\nå†™å…¥æˆåŠŸçš„æ¡ä»¶ï¼ˆè¶…é‡è¦ï¼‰ acks=all + min.insync.replicas=2 è‡³å°‘ 2 ä¸ªå‰¯æœ¬å†™æˆåŠŸï¼Œæ¶ˆæ¯æ‰ç®—æˆåŠŸå†™å…¥ï¼Œä»è€Œå®ç°é«˜å¯é ã€‚\n5. Leader é€‰ä¸¾æœºåˆ¶ Kafka é›†ç¾¤ä¸­ï¼š\næ¯ä¸ªåˆ†åŒºåªæœ‰ 1 ä¸ª Leader Leader è´Ÿè´£æ”¶å‘æ•°æ® Follower åŒæ­¥ å¦‚æœæŸä¸ª broker æŒ‚æ‰ï¼š\nController é€‰æ‹©æ–° Leaderï¼ˆä» ISR ä¸­é€‰ï¼‰ Consumer / Producer è‡ªåŠ¨é‡å®šå‘è¯·æ±‚ Leader é€‰ä¸¾æ˜¯ Kafka ä¿è¯é«˜å¯ç”¨çš„æ ¸å¿ƒèƒ½åŠ›ã€‚\n6. Kafka Controller èŠ‚ç‚¹ï¼ˆé›†ç¾¤å¤§è„‘ï¼‰ æ•´ä¸ªé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ª Controllerï¼ˆç”±å¤šä¸ª Broker é€‰ä¸¾äº§ç”Ÿï¼‰ï¼Œè´Ÿè´£ï¼š\nåˆ†åŒº Leader é€‰ä¸¾ Broker ä¸Šçº¿/ä¸‹çº¿æ£€æµ‹ ISR å˜æ›´ç®¡ç† åˆ†åŒºé‡æ–°åˆ†é… å¤„ç†èŠ‚ç‚¹æ•…éšœ æ§åˆ¶å™¨æ•…éšœæ—¶ï¼š\nå¦ä¸€ä¸ª Broker ä¼šè¿…é€Ÿæˆä¸ºæ–°çš„ Controller ä¸å½±å“æ•°æ®è¯»å†™ 7. Kafka é›†ç¾¤éƒ¨ç½²æ–¹å¼ 7.1 å•é›†ç¾¤ï¼ˆæœ€å¸¸è§ï¼‰ 3â€“9 å° Brokerï¼š\nbroker1, broker2, broker3 å‰¯æœ¬ä¼šå‡åŒ€åˆ†å¸ƒã€‚\n7.2 è·¨æœºæˆ¿ï¼ˆå¤šæ•°æ®ä¸­å¿ƒï¼‰ å¸¸è§ç­–ç•¥ï¼š\n1. Kafka MirrorMaker 2ï¼ˆä¸šç•Œæœ€å¸¸ç”¨ï¼‰ è·¨æœºæˆ¿å¤åˆ¶ Topicï¼š\nA -\u0026gt; B B -\u0026gt; A å®ç°ç¾å¤‡æˆ–è€…å¼‚åœ°å¤šæ´»ã€‚\n2. Confluent Replicator æ›´ç¨³å®šï¼Œä½†æ”¶è´¹ã€‚\n7.3 å¤šé›†ç¾¤ï¼ˆå¤šç§Ÿæˆ·ï¼‰ æŒ‰ä¸šåŠ¡æ‹†ï¼š\nè®¢å•é›†ç¾¤ æ—¥å¿—é›†ç¾¤ å®æ—¶è®¡ç®—é›†ç¾¤ ä¼˜ç‚¹ï¼š\nä¸ä¼šäº’ç›¸å½±å“ æ›´æ˜“æ‰©å®¹ 8. Kafka é›†ç¾¤æ‰©å®¹ \u0026amp; ç¼©å®¹ æ‰©å®¹ï¼ˆåŠ  Brokerï¼‰ æµç¨‹ï¼š\nå¢åŠ  Broker èŠ‚ç‚¹ è¿è¡Œ kafka-reassign-partitions.sh è¿ç§»åˆ†åŒº Confirm reassign å®Œæˆ Kafka ä¸ä¼šè‡ªåŠ¨å‡è¡¡ï¼Œä¼ä¸šä¸€èˆ¬å®šæœŸæ‰§è¡Œ rebalance å·¥å…·ã€‚\nç¼©å®¹ï¼ˆä¸‹çº¿ Brokerï¼‰ è¿ç§»è¯¥ Broker çš„æ‰€æœ‰åˆ†åŒº å°†è¯¥ Broker è®¾ä¸ºâ€œåœç”¨â€ å®‰å…¨ä¸‹çº¿ ä¸èƒ½ç›´æ¥åœï¼Œå¦åˆ™å¯èƒ½é€ æˆï¼š\nåˆ†åŒºä¸å¯ç”¨ ISR å˜å° æ€§èƒ½ä¸‹é™ 9. Kafka é›†ç¾¤ç›‘æ§æŒ‡æ ‡ é›†ç¾¤ä¸­å¿…é¡»ç›‘æ§ï¼š\n1. Under Replicated Partitionsï¼ˆURPï¼‰ URP \u0026gt; 0 ç«‹å³æŠ¥è­¦ï¼ˆå‰¯æœ¬ä¸åŒæ­¥ï¼‰\n2. Offline Partitions åˆ†åŒºä¸å¯ç”¨ï¼Œä¸¥é‡é—®é¢˜\n3. Consumer Lag æ¶ˆè´¹å †ç§¯æœ€é‡è¦æŒ‡æ ‡\n4. Network / IO ç£ç›˜å‹åŠ›å†³å®šååã€‚\n5. Page Cache å‘½ä¸­ç‡ Kafka ä¾èµ– OS page cache æå‡è¯»å†™ã€‚\n10. Kafka é›†ç¾¤æ¨èé…ç½®ï¼ˆç”Ÿäº§æ ‡å‡†ï¼‰ Producer\nacks=all enable.idempotence=true retries=âˆ batch.size=64KB linger.ms=10ms compression.type=zstd Broker\nnum.partitions=3 default.replication.factor=3 min.insync.replicas=2 Consumer\nenable.auto.commit=false max.poll.interval.ms=300000 fetch.min.bytes=1MB 11. Kafka é›†ç¾¤æ¶æ„å›¾ï¼ˆå¼ºçƒˆå»ºè®®æ”¶è—ï¼‰ æ–‡å­—ç‰ˆç»“æ„ï¼š\n+------------+ Producer -----\u0026gt; | Broker 1 | \u0026lt;---- Consumer | (Leader) | +------------+ | â†‘ | | Replication | | | +------------+ | Broker 2 | (Follower) +------------+ | +------------+ | Broker 3 | (Follower) +------------+ Zookeeper/KRaft è´Ÿè´£ï¼š\né›†ç¾¤å…ƒæ•°æ® Leader é€‰ä¸¾ Broker çŠ¶æ€ ISR ç»´æŠ¤ ","description":" 1. Kafka é›†ç¾¤æ˜¯ä»€ä¹ˆï¼Ÿ Kafka é›†ç¾¤ç”±å¤šä¸ª Broker èŠ‚ç‚¹ç»„æˆï¼Œå®ƒä»¬å…±åŒæ‰¿æ‹…ï¼š\næ•°æ®å†™å…¥ï¼ˆProducerï¼‰ æ•°æ®è¯»å–ï¼ˆConsumerï¼‰ å­˜å‚¨æ•°æ®ï¼ˆLog Segmentï¼‰ åˆ†åŒºå‰¯æœ¬åŒæ­¥ Leader é€‰ä¸¾ å…ƒæ•°æ®ç®¡ç† é«˜å¯ç”¨ä¸å®¹é”™ ä¸€ä¸ªç”Ÿäº§çº§ Kafka é›†ç¾¤ä¸€èˆ¬åŒ…å«ï¼š\n3â€“9 å° Brokerï¼ˆæœ€å°ç”Ÿäº§è§„æ ¼ï¼š3ï¼‰ + Zookeeperï¼ˆæˆ– KRaft æ¨¡å¼ï¼‰ 2. Kafka é›†ç¾¤å…³é”®ç»„ä»¶ 2.1 Broker ä¸€å° Kafka æœåŠ¡å®ä¾‹å°±æ˜¯ä¸€ä¸ª Brokerã€‚\n"},{"id":263,"href":"/operations/lvs/keepalived/","title":"Keepalived åŸºç¡€æ•™ç¨‹","parent":"LVS","content":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€å·¥ä½œæœºåˆ¶ã€VRRPã€LVS é…ç½®ã€ç”Ÿäº§çº§ç¤ºä¾‹ã€æ•…éšœæ’æŸ¥ã€æœ€ä½³å®è·µã€‚\nä¸€ã€Keepalived æ˜¯ä»€ä¹ˆï¼Ÿ Keepalived æ˜¯ä¸€ä¸ªæä¾› é«˜å¯ç”¨ï¼ˆHAï¼‰+ å¥åº·æ£€æŸ¥ + LVS ç®¡ç† çš„æœåŠ¡ï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š\nVRRPï¼ˆè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼‰ -\u0026gt; ç”¨äºä¸»å¤‡åˆ‡æ¢ / VIP æ¼‚ç§» LVS Real Server å¥åº·æ£€æŸ¥ -\u0026gt; è‡ªåŠ¨ä» ipvsadm ä¸­ç§»é™¤ä¸å¥åº·çš„ RS è‡ªåŠ¨ç”Ÿæˆ/ç»´æŠ¤ LVS è§„åˆ™ è·¨å¤šå®ä¾‹ã€å¤šè™šæ‹ŸæœåŠ¡çš„ HA ç®¡ç† Keepalived ä¸»è¦ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š\nVRRPï¼ˆVIP æ¼‚ç§»ï¼Œå®ç°é«˜å¯ç”¨ï¼‰ LVSï¼ˆç®¡ç† ipvsadm çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼‰ äºŒã€Keepalived çš„è¿è¡Œæ¨¡å‹ Keepalived = VRRP + LVSï¼ŒäºŒè€…ç‹¬ç«‹ä¸”å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚\n+---------------------------------------+ | keepalived | +-------------------+-------------------+ | VRRP | LVS | | (VIP HA failover) | (LB/healthcheck) | +-------------------+-------------------+ ä¸‰ã€VRRPï¼ˆæ ¸å¿ƒ HA æœºåˆ¶ï¼‰ VRRP ä½œç”¨ï¼š\nè®©å¤šä¸ªèŠ‚ç‚¹å…±äº«ä¸€ä¸ª VIPï¼Œåªæœ‰ MASTER å¯¹å¤–æä¾›æœåŠ¡ï¼ŒBACKUP éšæ—¶æ¥ç®¡ã€‚\nVRRP å‚æ•°è¯´æ˜\nå‚æ•° ä½œç”¨ state MASTER / BACKUP interface ç»‘å®šç½‘å¡ virtual_router_id VRRP ç»„ IDï¼ˆå¿…é¡»å”¯ä¸€ï¼‰ priority ä¼˜å…ˆçº§ï¼ˆè¶Šå¤§è¶Šå…ˆæŠ¢ VIPï¼‰ advert_int å¿ƒè·³é—´éš”ï¼ˆé»˜è®¤ 1sï¼‰ virtual_ipaddress VIP åˆ—è¡¨ ä¸»å¤‡åˆ‡æ¢æµç¨‹\nMASTER å¹¿æ’­ VRRP å¿ƒè·³ BACKUP ç›‘å¬å¿ƒè·³ MASTER æ•…éšœ -\u0026gt; å¿ƒè·³ä¸­æ–­ BACKUP æ£€æµ‹åˆ°è¶…æ—¶å -\u0026gt; æŠ¢å  VIP VIP æ¼‚ç§»å®Œæˆ -\u0026gt; ARP é€šå‘Š -\u0026gt; å®¢æˆ·ç«¯è‡ªåŠ¨æ¢å¤è®¿é—® æ³¨æ„ï¼šVRRP æ˜¯äºŒå±‚åè®®ï¼ˆç»„æ’­ï¼‰\nä¸»å¤‡å¿…é¡»åœ¨ åŒä¸€äºŒå±‚ç½‘ç»œã€‚\nå››ã€Keepalived é…ç½®ç»“æ„ Keepalived é…ç½®æ–‡ä»¶ï¼š/etc/keepalived/keepalived.conf\nä¸»è¦ç»“æ„ï¼š\nglobal_defs { ... } vrrp_instance VI_1 { ... } virtual_server 10.0.0.10 80 { ... } real_server 10.0.0.11 80 { ... } real_server 10.0.0.12 80 { ... } äº”ã€Keepalived + LVSï¼ˆå¸¸ç”¨ DR/NAT é›†ç¾¤ï¼‰ Keepalived ä¸ä»…åš HAï¼Œè¿˜èƒ½è‡ªåŠ¨ç»´æŠ¤ ipvsadm è§„åˆ™ã€‚\nå…­ã€ç”Ÿäº§çº§ Keepalived é…ç½®ç¤ºä¾‹ï¼ˆDR æ¨¡å¼ï¼‰ğŸš€ ä¸‹é¢ä¸€ä»½ä½ å¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ç‰ˆæœ¬ã€‚\nkeepalived.conf\n! Keepalived é…ç½®ç¤ºä¾‹ï¼ˆLVS-DR + HAï¼‰ global_defs { router_id LVS_NODE_1 enable_script_security } # VRRP ä¸»å¤‡ vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 51 priority 120 advert_int 1 authentication { auth_type PASS auth_pass 123456 } virtual_ipaddress { 10.0.0.10/24 } # VIP è½¬ç§»æ—¶ç«‹å³å‘é€ ARP é€šå‘Š garp_master_delay 1 garp_master_refresh 5 garp_master_repeat 5 } # LVS è™šæ‹ŸæœåŠ¡ virtual_server 10.0.0.10 80 { lb_algo wlc lb_kind DR persistence_timeout 50 protocol TCP delay_loop 6 real_server 10.0.0.11 80 { weight 1 TCP_CHECK { connect_timeout 3 delay_before_retry 3 connect_port 80 } } real_server 10.0.0.12 80 { weight 1 TCP_CHECK { connect_timeout 3 delay_before_retry 3 connect_port 80 } } } ä¸ƒã€Real Server é…ç½®ï¼ˆDR æ¨¡å¼ï¼‰ ç»‘å®š VIP åˆ° lo\nip addr add 10.0.0.10/32 dev lo ç¦æ­¢ ARP æŠ¢ç­”\necho 1 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_ignore echo 2 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_announce echo 1 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_ignore echo 2 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_announce å…«ã€Keepalived å¸¸ç”¨æ“ä½œ æŸ¥çœ‹ VIP\nip addr | grep 10.0.0.10 æŸ¥çœ‹ ipvsadm è§„åˆ™\nipvsadm -Ln é‡å¯æœåŠ¡\nsystemctl restart keepalived systemctl status keepalived ä¹ã€Keepalived å¥åº·æ£€æŸ¥ï¼ˆLVS éƒ¨åˆ†ï¼‰ æ”¯æŒï¼š\n1ï¼‰TCP_CHECK è¿æ¥ç«¯å£éªŒè¯\n2ï¼‰HTTP_GET å®Œæ•´ HTTP å¥åº·æ£€æŸ¥ ç¤ºä¾‹ï¼š\nHTTP_GET { url { path /health digest 1a2b3c4d } connect_timeout 3 nb_get_retry 3 delay_before_retry 3 } 3ï¼‰SSL_GET / SMTP_CHECK / MISC_CHECKï¼ˆè„šæœ¬æ£€æŸ¥ï¼‰ å¯æ‰§è¡Œå¤–éƒ¨è„šæœ¬ï¼š\nMISC_CHECK { misc_path \u0026#34;/usr/bin/check_backend.sh\u0026#34; misc_timeout 5 } åã€Keepalived æ•…éšœæ’æŸ¥ï¼ˆç»å…¸é—®é¢˜ï¼‰ 1ï¼‰VIP ä¸æ¼‚ç§» interface å†™é”™ IP è¢«å ç”¨ VRRP ç»„ ID å†²çª ä¼˜å…ˆçº§ä¸æ­£ç¡® é˜²ç«å¢™é˜»æ­¢ VRRP ç»„æ’­ï¼š udp port 112 multicast 224.0.0.18 2ï¼‰åˆ‡æ¢å»¶è¿Ÿå¤§ advert_int å¤ªå¤§ priority å·®å¼‚å¤ªå° ç½‘ç»œä¸¢åŒ…å¯¼è‡´å¿ƒè·³å»¶è¿Ÿ æœªå¼€å¯ GARPï¼ˆå‡çº§ ARP ç¼“å­˜ï¼‰ 3ï¼‰Real Server ä¸å¥åº·ä½†æ²¡ä» LVS ç§»é™¤ æ£€æŸ¥é¡¹ä¸æ­£ç¡® TCP_CHECK é…ç½®é”™è¯¯ æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢æ¢æµ‹ç«¯å£ 4ï¼‰è®¿é—®ä¸é€šä½† LVS é…ç½®æ­£å¸¸ RS æ²¡å…³é—­ ARP æŠ¢ç­” RS å›åŒ…èµ°äº†é”™è¯¯è·¯ç”± DR æ¨¡å¼å¤šç½‘å¡å¯¼è‡´ VIP ç»‘å®šå†²çª åä¸€ã€Keepalived æœ€ä½³å®è·µï¼ˆè¿ç»´å¿…èƒŒï¼‰ 1. HA å¿…é¡»å¼€å¯æŠ¢å  nopreempt\nä¸€èˆ¬ä¸æ¨èé™¤éç‰¹æ®Šä¸šåŠ¡ï¼ˆç¨³å®šä¼˜å…ˆï¼‰\n2. VGARPï¼ˆGratuitous ARPï¼‰å¿…é¡»å¼€å¯ ç¡®ä¿ VIP åˆ‡æ¢æ—¶ ARP ç¼“å­˜æ›´æ–°åŠæ—¶\n3. VIP ç»‘å®šåˆ°ç‰©ç†ç½‘å¡ï¼Œè€Œä¸æ˜¯ lo VRRP å¿…é¡»ç»‘å®šç‰©ç†ç½‘å¡ï¼Œå¦åˆ™å¿ƒè·³å‘ä¸å‡ºå»\n4. å¥åº·æ£€æŸ¥å°½é‡ä½¿ç”¨ TCP / HTTP_GET 5. LVS æ¨èä½¿ç”¨ WLC è°ƒåº¦ç®—æ³• 6. å¼ºçƒˆå»ºè®®å¯ç”¨ conntrack åŒæ­¥ï¼ˆLVS Connection Syncï¼‰ sync_master sync_backup 7. Keepalived æ—¥å¿—è¦è¾“å‡ºåˆ° /var/log/messages æˆ–ç‹¬ç«‹æ–‡ä»¶ global_defs { router_id LVS_NODE_1 enable_script_security log_detail } ","description":"å†…å®¹ï¼šæ ¸å¿ƒæ¦‚å¿µã€å·¥ä½œæœºåˆ¶ã€VRRPã€LVS é…ç½®ã€ç”Ÿäº§çº§ç¤ºä¾‹ã€æ•…éšœæ’æŸ¥ã€æœ€ä½³å®è·µã€‚\nä¸€ã€Keepalived æ˜¯ä»€ä¹ˆï¼Ÿ Keepalived æ˜¯ä¸€ä¸ªæä¾› é«˜å¯ç”¨ï¼ˆHAï¼‰+ å¥åº·æ£€æŸ¥ + LVS ç®¡ç† çš„æœåŠ¡ï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š\nVRRPï¼ˆè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼‰ -\u0026gt; ç”¨äºä¸»å¤‡åˆ‡æ¢ / VIP æ¼‚ç§» LVS Real Server å¥åº·æ£€æŸ¥ -\u0026gt; è‡ªåŠ¨ä» ipvsadm ä¸­ç§»é™¤ä¸å¥åº·çš„ RS è‡ªåŠ¨ç”Ÿæˆ/ç»´æŠ¤ LVS è§„åˆ™ è·¨å¤šå®ä¾‹ã€å¤šè™šæ‹ŸæœåŠ¡çš„ HA ç®¡ç† Keepalived ä¸»è¦ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š\nVRRPï¼ˆVIP æ¼‚ç§»ï¼Œå®ç°é«˜å¯ç”¨ï¼‰ LVSï¼ˆç®¡ç† ipvsadm çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼‰ äºŒã€Keepalived çš„è¿è¡Œæ¨¡å‹ Keepalived = VRRP + LVSï¼ŒäºŒè€…ç‹¬ç«‹ä¸”å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚\n"},{"id":264,"href":"/operations/kubernetes/","title":"Kubernetes","parent":"Operations","content":"Document List:\nKubernetes FAQ Kubernetes åŸºç¡€æ•™ç¨‹ Kubernetes æ ¸å¿ƒæ¦‚å¿µ Kubernetes æ ¸å¿ƒç»„ä»¶ Kubernetes åˆå§‹åŒ–é…ç½® Kubernetes æ ¸å¿ƒå‘½ä»¤ Kubernetes Calico Kubernetes Calico æœ€ä½³å®è·µ Kubernetes DaemonSet Kubernetes Deployment Kubernetes Job Kubernetes Pod Kubernetes Pod è°ƒåº¦æµç¨‹å›¾ï¼ˆScheduler æ‰§è¡Œé¡ºåºï¼‰ Kubernetes Scheduler Kubernetes Service Kubernetes StatefulSet Kubernetes Storage Kubernetes Workload Kubernetes å†…æ ¸é…ç½® Kubernetes å¸¸ç”¨å‘½ä»¤ Kubernetes åº”ç”¨æ¶æ„ä»¥åŠéƒ¨ç½² Kubernetes æ•…éšœæ’æŸ¥ Kubernetes ç»å…¸é—®é¢˜ ","description":"Document List:\nKubernetes FAQ Kubernetes åŸºç¡€æ•™ç¨‹ Kubernetes æ ¸å¿ƒæ¦‚å¿µ Kubernetes æ ¸å¿ƒç»„ä»¶ Kubernetes åˆå§‹åŒ–é…ç½® Kubernetes æ ¸å¿ƒå‘½ä»¤ Kubernetes Calico Kubernetes Calico æœ€ä½³å®è·µ Kubernetes DaemonSet Kubernetes Deployment Kubernetes Job Kubernetes Pod Kubernetes Pod è°ƒåº¦æµç¨‹å›¾ï¼ˆScheduler æ‰§è¡Œé¡ºåºï¼‰ Kubernetes Scheduler Kubernetes Service Kubernetes StatefulSet Kubernetes Storage Kubernetes Workload Kubernetes å†…æ ¸é…ç½® Kubernetes å¸¸ç”¨å‘½ä»¤ Kubernetes åº”ç”¨æ¶æ„ä»¥åŠéƒ¨ç½² Kubernetes æ•…éšœæ’æŸ¥ Kubernetes ç»å…¸é—®é¢˜ "},{"id":265,"href":"/operations/kubernetes/calico/","title":"Kubernetes Calico","parent":"Kubernetes","content":"ä¸‹é¢æ˜¯ä¸€ä»½ Kubernetes Calico æœ€è¯¦ç»†ä»‹ç»ï¼ˆåŸºäº K8S 1.33 æœ€æ–°è®¤çŸ¥ï¼‰ï¼Œæ¶µç›–æ¶æ„ã€å·¥ä½œåŸç†ã€ç»„ä»¶ã€ç½‘ç»œç­–ç•¥ã€BGPã€IPIP/VXLANã€ä¼ä¸šç‰¹æ€§ç­‰ï¼Œå…¨ç¨‹ç”¨å·¥ç¨‹å¸ˆè§†è§’å†™ï¼Œå¸®åŠ©ä½ åœ¨å®é™…é›†ç¾¤ä¸­è½åœ°ã€‚\nğŸš€ Kubernetes Calico è¯¦ç»†ä»‹ç»ï¼ˆåŸºäº Kubernetes â‰¥1.33ï¼‰ Calico æ˜¯ç›®å‰ Kubernetes æœ€ä¸»æµçš„ CNI æ’ä»¶ä¹‹ä¸€ï¼Œä»¥é«˜æ€§èƒ½ã€å¯è§‚æµ‹æ€§å¼ºã€ä¼ä¸šç‰¹æ€§ä¸°å¯Œè€Œè‘—ç§°ã€‚\nå®ƒä¸æ˜¯ç®€å•çš„ Pod ç½‘ç»œæ–¹æ¡ˆï¼Œè€Œæ˜¯ä¸€å¥— L3 ç½‘ç»œã€BGP è·¯ç”±ã€ç½‘ç»œç­–ç•¥æ‰§è¡Œã€è·¨é›†ç¾¤é€šä¿¡ã€å®‰å…¨åˆè§„çš„å¤§å‹ç½‘ç»œå¹³å°ã€‚\n1. ä»€ä¹ˆæ˜¯ Calicoï¼Ÿ Calico æ˜¯ä¸€ä¸ªåŸºäº ä¸‰å±‚è·¯ç”±ï¼ˆL3 Routingï¼‰ çš„ Kubernetes ç½‘ç»œæ–¹æ¡ˆï¼Œæ ¸å¿ƒç†å¿µï¼š\næ¯ä¸ª Pod æ‹¥æœ‰ç‹¬ç«‹çš„ /32 IP Pod åˆ° Pod çš„æµé‡èµ°è·¯ç”±ï¼Œä¸èµ° Overlayï¼ˆå¯é€‰ï¼‰ ä½¿ç”¨ Linux å†…æ ¸ï¼ˆiptables/BPFï¼‰æ‰§è¡Œç­–ç•¥ ç”¨ BGP æˆ– overlay ä¸Šæ„å»ºç½‘ç»œæ‹“æ‰‘ å¯æä¾›ä¼ä¸šçº§ Zero Trust å®‰å…¨èƒ½åŠ› æ”¯æŒç½‘ç»œæ¨¡å¼åŒ…æ‹¬ï¼š\næ¨¡å¼ æè¿° æ€§èƒ½ BGP æ¨¡å¼ï¼ˆæ—  overlayï¼‰ ç›´æ¥ä½¿ç”¨ BGP äº¤æ¢è·¯ç”±ï¼ŒPod IP å¯è¾¾ â­â­â­â­â­ï¼ˆæœ€é«˜ï¼‰ IPIP overlay èŠ‚ç‚¹ä¹‹é—´åŒ…ä¸€å±‚ IPIP â­â­â­ VXLAN overlay ç”¨ VXLAN å°è£… Pod æµé‡ â­â­â­â­ WireGuard Pod é—´ç«¯åˆ°ç«¯åŠ å¯† â­â­â­â­ åŒæ—¶æ”¯æŒï¼š\nNetworkPolicyï¼ˆK8S æ ‡å‡†ï¼‰ GlobalNetworkPolicyï¼ˆCalico æ‰©å±•ï¼‰ eBPF dataplaneï¼ˆæ›´å¿«ï¼Œæ›¿ä»£ iptablesï¼‰ è·¨é›†ç¾¤é€šä¿¡ï¼ˆCalico Enterpriseï¼‰ 2. Calico æ¶æ„ç»„æˆ Calico ä¸»è¦ç»„ä»¶ï¼š\n2.1 calico-nodeï¼ˆå¿…å¤‡ï¼‰ DaemonSetï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªã€‚å®ƒè´Ÿè´£ï¼š\næŠŠ CNI ç½‘ç»œæ’å…¥ Podï¼ˆCNI æ’ä»¶ï¼‰ BGP daemonï¼šåˆ†å‘ /32 Pod è·¯ç”± è®¾ç½® iptables/eBPF è®¾ç½® IPAMï¼ˆPod IP åˆ†é…ï¼‰ ç»´æŠ¤ overlay éš§é“ï¼šIPIP/VXLAN/WireGuard 2.2 Felixï¼ˆcalico-felixï¼‰ Felix æ˜¯ Calico çš„æ ¸å¿ƒæ§åˆ¶é¢ä»£ç†ï¼Œè´Ÿè´£ï¼š\nç½‘ç»œç­–ç•¥ -\u0026gt; iptables/eBPF è§„åˆ™ è·¯ç”±è¡¨ç®¡ç† éš§é“ç«¯ç‚¹ç®¡ç† æ˜¯ Calico æœ€é‡è¦çš„è¿›ç¨‹ã€‚\n2.3 Typhaï¼ˆå¯é€‰ï¼‰ ä¸ºå¤§è§„æ¨¡é›†ç¾¤ï¼ˆ\u0026gt;200 nodesï¼‰å‡å°‘ Felix ä¸ etcd/K8S API çš„è¿æ¥å‹åŠ›ã€‚\nç›¸å½“äºä¸€ä¸ª fan-out aggregatorï¼Œè®© Felix ä¸ç›´æ¥è¯» APIï¼Œå¤§å¹…å‡å°‘ watch è¿æ¥ã€‚\n2.4 BGP Route Reflectorï¼ˆå¯é€‰ï¼‰ å½“é›†ç¾¤èŠ‚ç‚¹è§„æ¨¡å¢å¤§ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„ Full-mesh BGP æˆæœ¬ä¼šå¾ˆé«˜ï¼Œå› æ­¤å¯ä»¥éƒ¨ç½² RRã€‚\n3. Calico ç½‘ç»œæ¨¡å¼è¯¦è§£ Calico æœ€å¤§ç‰¹ç‚¹å°±æ˜¯ç½‘ç»œæ¨¡å¼çµæ´»ã€‚ä¸‹é¢æ˜¯ä½ å®é™…å·¥ç¨‹ä¸­æœ€å¸¸ç”¨çš„ 3 ç§æ¨¡å¼ã€‚\n3.1 éƒ¨ç½²æ¨¡å¼ï¼šBGPï¼ˆæ—  overlayï¼‰ğŸ”¥æ¨è ç‰¹ç‚¹ï¼šæ€§èƒ½æœ€é«˜\nç½‘ç»œèµ°ä¸‰å±‚è·¯ç”±ï¼Œä¸å°è£…ï¼š\nPod -\u0026gt; Node -\u0026gt; Node -\u0026gt; Pod\nLinux è·¯ç”±ç›´æ¥è½¬å‘ï¼Œå»¶è¿Ÿæœ€å°ã€‚\né€‚ç”¨åœºæ™¯\nè£¸é‡‘å±æœºæˆ¿ äº‘ä¸»æœºå…·å¤‡å›ºå®šè·¯ç”±èƒ½åŠ› è…¾è®¯äº‘ TKE é«˜æ€§èƒ½ç½‘ç»œ é˜¿é‡Œäº‘ ACK Pro ä¼˜ç‚¹\né›¶å°è£…ï¼Œæ€§èƒ½æœ€é«˜ è·¯ç”±å¯æ§ è¿ç»´å¯è§‚æµ‹æ€§å¼º 3.2 éƒ¨ç½²æ¨¡å¼ï¼šIPIP overlay Calico é»˜è®¤æ¨¡å¼å°±æ˜¯ IPIPã€‚\nç‰¹ç‚¹ï¼š\nPod -\u0026gt; NodeAï¼ˆIPIP å°åŒ…ï¼‰-\u0026gt; NodeB è§£åŒ… -\u0026gt; Pod\nèŠ‚ç‚¹ä¹‹é—´èµ° IPIP éš§é“ã€‚\né€‚ç”¨äºï¼š\næ²¡æœ‰ BGP èƒ½åŠ›çš„é€šç”¨ç¯å¢ƒ å¤šèŠ‚ç‚¹è·¨å­ç½‘ ä½†æ€§èƒ½ä¸€èˆ¬ï¼ˆæ¯” VXLAN æ›´ä½ä¸€ç‚¹ï¼‰ã€‚\n3.3 éƒ¨ç½²æ¨¡å¼ï¼šVXLAN overlayï¼ˆå¸¸ç”¨ï¼‰ Calico çš„ VXLAN æ¨¡å¼è¿‘å‡ å¹´æ›´æµè¡Œï¼Œå› ä¸ºï¼š\næ”¯æŒ eBPF dataplane æ€§èƒ½å¥½ äº‘åŸç”Ÿå…¼å®¹æ€§é«˜ VXLAN IDï¼ˆVNIï¼‰ä¸€èˆ¬å›ºå®šï¼š4096\nVXLAN å¤´å¤§å°å›ºå®šï¼ˆ50 bytesï¼‰ï¼Œæ¯” IPIP å¤šä¸€ç‚¹ï¼Œä½†æ”¯æŒç¡¬ä»¶ offloadã€‚\n4. IPAMï¼ˆPod ç½‘ç»œ IP åˆ†é…ï¼‰ Calico å†…ç½® IPAMï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š\n4.1 Kubernetes podCIDR æ¨¡å¼ï¼ˆhost-localï¼‰ è·Ÿé»˜è®¤ CNI ä¸€æ ·ï¼Œæ¯ä¸ª Node æœ‰å›ºå®š CIDRï¼š\nNode1 -\u0026gt; 10.244.1.0/24 Node2 -\u0026gt; 10.244.2.0/24 4.2 Calico IPAMï¼ˆæ›´å¼ºå¤§ï¼‰ Calico æä¾›ï¼š\nmultiple pools per-namespace å¤§CIDRæ‹†å°ç½‘æ®µåˆ†é… Auto-detection of interface Dual-stack IPv4/IPv6 ä½ å¯ä»¥å®šä¹‰ä¸åŒ IP æ± åˆ†é…ç»™ä¸åŒ namespaceï¼š\napiVersion: projectcalico.org/v3 kind: IPPool metadata: name: frontend spec: cidr: 10.100.0.0/16 natOutgoing: true ipipMode: Always 5. Calico ç½‘ç»œç­–ç•¥ï¼ˆPolicyï¼‰å®‰å…¨ä½“ç³» Calico æ”¯æŒä¸¤ç§ç­–ç•¥ï¼š\nç±»å‹ ä½œç”¨èŒƒå›´ åŠŸèƒ½ NetworkPolicyï¼ˆæ ‡å‡†ï¼‰ namespace å†… L3/L4 æ§åˆ¶ GlobalNetworkPolicyï¼ˆCalico æ‰©å±•ï¼‰ å…¨é›†ç¾¤ L3/L4/L7 æ§åˆ¶ï¼ˆä¼ä¸šç‰ˆï¼‰ 5.1 æ ‡å‡† NetworkPolicy ä¾‹å¦‚åªå…è®¸ frontend -\u0026gt; backend:\nkind: NetworkPolicy apiVersion: networking.k8s.io/v1 metadata: name: allow-frontend namespace: backend spec: podSelector: matchLabels: app: backend ingress: - from: - namespaceSelector: matchLabels: team: frontend 5.2 Calico GlobalNetworkPolicyï¼ˆä¼ä¸šå¸¸ç”¨ï¼‰ å…¨å±€çº§åˆ«ï¼Œä¼˜å…ˆçº§æ›´é«˜ï¼š\napiVersion: projectcalico.org/v3 kind: GlobalNetworkPolicy metadata: name: deny-all spec: selector: all() types: - Ingress - Egress å¯å®ç°ï¼š\né›†ç¾¤é»˜è®¤æ‹’ç»æ‰€æœ‰ å†é€æ¡å¼€æ”¾ç™½åå•ï¼ˆZero Trustï¼‰ 6. eBPF dataplaneï¼ˆæ–°è¶‹åŠ¿ï¼‰ Calico ä» v3.19 å¼€å§‹æ”¯æŒ eBPFã€‚\nä¼˜åŠ¿ï¼š\næ€§èƒ½é«˜äº iptables æ”¯æŒ XDP æ—  kube-proxyï¼ˆCEF-likeï¼‰ æ›´ä½å»¶è¿Ÿ æ›´é«˜ PPS ç›´æ¥å¤„ç† NodePort \u0026amp; LoadBalancer NAT æµé‡å¯è§‚æµ‹ å¦‚æœä½ ä½¿ç”¨ K8S 1.33ï¼Œå¼ºçƒˆæ¨èå¯ç”¨ eBPF æ¨¡å¼ï¼š\nCALICO_NETWORKING_BACKEND = \u0026#34;bpf\u0026#34; 7. Calico çš„ BGP åŸç† Calico æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œ BGP daemonï¼ˆBIRD æˆ– GoBGPï¼‰ï¼Œå¹¿æ’­ï¼š\nPod /32 è·¯ç”± Node /24 è·¯ç”±ï¼ˆCIDRï¼‰ Service ClusterIPï¼ˆå¯é€‰ï¼‰ 7.1 Kubernetes å†…éƒ¨ BGP ä¾‹å¦‚ Node1 ç»™ Node2 å¹¿æ’­ï¼š\n10.244.1.5/32 via 192.168.1.101 Node2 å®‰è£…åˆ°è·¯ç”±è¡¨åï¼š\nip route add 10.244.1.5/32 via 192.168.1.101 8. é«˜çº§ç‰¹æ€§ï¼ˆCalico Enterpriseï¼‰ åŠŸèƒ½ æè¿° Multi-cluster å¤šé›†ç¾¤è¿æ¥ L7 Policy åŸºäºåŸŸåã€HTTP æ–¹æ³•æ§åˆ¶ Compliance reports ç½‘ç»œå®‰å…¨æŠ¥è¡¨ Enterprise eBPF å…¨é“¾è·¯å¯è§‚æµ‹ Zero Trust Segmentation ç§Ÿæˆ·éš”ç¦»ã€å®‰å…¨æ§åˆ¶ 9. Calico æ€»ç»“ Calico ä¸ Flannel çš„åŒºåˆ«ï¼Ÿ\né¡¹ç›® Calico Flannel æ¨¡å¼ L3 Routing L2 Overlay æ€§èƒ½ â­â­â­â­â­ â­â­â­ å®‰å…¨ NetworkPolicy æ—  BGP æ”¯æŒ ä¸æ”¯æŒ eBPF æ”¯æŒ ä¸æ”¯æŒ Calico å¦‚ä½•æé«˜æ€§èƒ½ï¼Ÿ\nä½¿ç”¨ BGP æ¨¡å¼ å…³é—­ IPIP æ‰“å¼€ eBPF ä½¿ç”¨ VXLAN offload IPIP ä¸ VXLAN åŒºåˆ«ï¼Ÿ\næ¨¡å¼ IPIP VXLAN Header 20 bytes 50 bytes ç¡¬ä»¶ offload ä¸æ”¯æŒ æ”¯æŒ æ€§èƒ½ ä¸­ é«˜ ğŸ“Œ æœ€åæ€»ç»“ï¼ˆå·¥ç¨‹å¸ˆè§†è§’ï¼‰ å¦‚æœä½ è¦éƒ¨ç½² é«˜æ€§èƒ½ + å®‰å…¨ + å¯è§‚æµ‹ çš„ K8S ç½‘ç»œï¼š\næ¨èé…ç½®ï¼š\nCNIï¼šCalico Dataplaneï¼šeBPF Overlayï¼šVXLAN Node networkingï¼šBGP RRï¼ˆ\u0026gt;200 èŠ‚ç‚¹ï¼‰ IPAMï¼šCalico IPAM ç­–ç•¥ï¼šGlobalNetworkPolicyï¼ˆé›¶ä¿¡ä»»ï¼‰ åŠ å¯†ï¼šWireGuard Calico ä¹‹æ‰€ä»¥æ˜¯æœ€é€‚åˆç”Ÿäº§ç¯å¢ƒçš„ CNIï¼Œä¸æ˜¯å› ä¸ºâ€œèƒ½ç”¨â€ï¼Œè€Œæ˜¯å› ä¸ºï¼š\næ€§èƒ½å¼º åŠŸèƒ½å…¨ å®‰å…¨æ€§å¼º å¥½è°ƒè¯• ä¼ä¸šçº§èƒ½åŠ›å®Œå–„ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ Kubernetes Calico æœ€è¯¦ç»†ä»‹ç»ï¼ˆåŸºäº K8S 1.33 æœ€æ–°è®¤çŸ¥ï¼‰ï¼Œæ¶µç›–æ¶æ„ã€å·¥ä½œåŸç†ã€ç»„ä»¶ã€ç½‘ç»œç­–ç•¥ã€BGPã€IPIP/VXLANã€ä¼ä¸šç‰¹æ€§ç­‰ï¼Œå…¨ç¨‹ç”¨å·¥ç¨‹å¸ˆè§†è§’å†™ï¼Œå¸®åŠ©ä½ åœ¨å®é™…é›†ç¾¤ä¸­è½åœ°ã€‚\nğŸš€ Kubernetes Calico è¯¦ç»†ä»‹ç»ï¼ˆåŸºäº Kubernetes â‰¥1.33ï¼‰ Calico æ˜¯ç›®å‰ Kubernetes æœ€ä¸»æµçš„ CNI æ’ä»¶ä¹‹ä¸€ï¼Œä»¥é«˜æ€§èƒ½ã€å¯è§‚æµ‹æ€§å¼ºã€ä¼ä¸šç‰¹æ€§ä¸°å¯Œè€Œè‘—ç§°ã€‚\nå®ƒä¸æ˜¯ç®€å•çš„ Pod ç½‘ç»œæ–¹æ¡ˆï¼Œè€Œæ˜¯ä¸€å¥— L3 ç½‘ç»œã€BGP è·¯ç”±ã€ç½‘ç»œç­–ç•¥æ‰§è¡Œã€è·¨é›†ç¾¤é€šä¿¡ã€å®‰å…¨åˆè§„çš„å¤§å‹ç½‘ç»œå¹³å°ã€‚\n1. ä»€ä¹ˆæ˜¯ Calicoï¼Ÿ Calico æ˜¯ä¸€ä¸ªåŸºäº ä¸‰å±‚è·¯ç”±ï¼ˆL3 Routingï¼‰ çš„ Kubernetes ç½‘ç»œæ–¹æ¡ˆï¼Œæ ¸å¿ƒç†å¿µï¼š\n"},{"id":266,"href":"/operations/kubernetes/calico-best-practices/","title":"Kubernetes Calico æœ€ä½³å®è·µ","parent":"Kubernetes","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€å·¥ç¨‹çº§ã€èƒ½ç›´æ¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒçš„ã€ŠKubernetes + Calico æœ€ä½³å®è·µã€‹ï¼ŒåŸºäº Kubernetes â‰¥1.33 + Calico â‰¥3.27ï¼ˆå« eBPF æ¨¡å¼ï¼‰ï¼ŒåŒ…å«ç½‘ç»œè®¾è®¡ã€æ€§èƒ½ã€å®‰å…¨ã€IPAMã€Policyã€Troubleshootingã€ç›‘æ§ã€ç”Ÿäº§å‚æ•°ç­‰å†…å®¹ã€‚\nè¿™æ˜¯ä¼ä¸šçº§ç‰ˆæœ¬ï¼Œä¸è®²åºŸè¯ï¼Œåªç»™å¯å¤åˆ¶åˆ°ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µã€‚\nğŸš€ Kubernetes + Calico æœ€ä½³å®è·µï¼ˆK8S 1.33 / Calico 3.27+ï¼‰\n1. CNI ç½‘ç»œæ¨¡å‹é€‰å‹ï¼ˆæœ€å…³é”®ï¼‰ Calico æ”¯æŒå¤šç§ç½‘ç»œæ¨¡å¼ï¼Œä½†è¦é€‰æ­£ç¡®ï¼š\nğŸ”¥ æœ€ä½³é€‰å‹ï¼ˆå¼ºçƒˆæ¨èï¼‰\nDataplaneï¼šeBPFï¼ˆæ›¿ä»£ iptablesï¼‰\nOverlayï¼šVXLAN + eBPF NAT\nIPAMï¼šCalico IPAM\nRoutingï¼šæ—  BGPï¼ˆé™¤éè£¸é‡‘å±ï¼‰\nç†ç”±ï¼š\næ¨¡å¼ æ€§èƒ½ å¯è§‚æµ‹æ€§ å…¼å®¹æ€§ æ¨è VXLAN + eBPF â­â­â­â­â­ â­â­â­â­â­ å…¨äº‘å‚å•†æ”¯æŒ âœ“âœ“âœ“âœ“âœ“ BGP æ— å°è£… â­â­â­â­â­ â­â­â­â­â­ ä»…è£¸é‡‘å±/è‡ªå»º IDC âœ“âœ“âœ“âœ“ IPIP â­â­â­ â­â­ æ—§æœºå™¨ ä¸æ¨è çº¯ iptables â­ â­â­ å…¼å®¹æœ€å¹¿ ä¸æ¨è eBPF å¯¹ K8S 1.33 å®Œç¾æ”¯æŒ\nèƒ½æ›¿ä»£ kube-proxyï¼Œå¹¶å¤§å¹…æå‡æ€§èƒ½ã€‚\n2. Calico å®‰è£…æœ€ä½³å®è·µ 2.1 ä½¿ç”¨å®˜æ–¹ manifestï¼ˆæ¨èï¼‰ ä½¿ç”¨å®˜æ–¹ operatorï¼Œè®©å‡çº§å’Œç®¡ç†æ›´å¯æ§ï¼š\nkubectl apply -f https://docs.projectcalico.org/archive/v3.27/manifests/calico.yaml 2.2 å¯ç”¨ eBPF æ¨¡å¼ï¼ˆæ€§èƒ½ç¿»å€ï¼‰ ä¿®æ”¹ ConfigMapï¼š\napiVersion: operator.tigera.io/v1 kind: Installation spec: calicoNetwork: linuxDataplane: \u0026#34;BPF\u0026#34; mtu: 1450 encap: VXLAN ä¼˜åŠ¿ï¼š\næ—  kube-proxy NAT/NodePort/LB å…¨èµ° BPF fast path é«˜ QPS æœåŠ¡æ€§èƒ½æå‡ 30%â€“200% 3. IP åœ°å€ç®¡ç† IPAM æœ€ä½³å®è·µ é¿å…ä½¿ç”¨ k8s podCIDR\nå¿…é¡»ä½¿ç”¨ Calico IPAMï¼ˆé»˜è®¤ï¼‰\n3.1 è®¾ç½®å¤šä¸ªç½‘æ®µæ± ï¼ˆå¯æŒ‰ä¸šåŠ¡/ç¯å¢ƒåˆ’åˆ†ï¼‰ ç¤ºä¾‹ï¼š\nfrontend -\u0026gt; 10.10.0.0/16 backend -\u0026gt; 10.20.0.0/16 job/ci -\u0026gt; 10.30.0.0/16 apiVersion: projectcalico.org/v3 kind: IPPool metadata: name: frontend-pool spec: cidr: 10.10.0.0/16 ipipMode: Never vxlanMode: Always natOutgoing: true é¿å…æŠŠæ‰€æœ‰ Pod éƒ½å¡è¿›åŒä¸€ä¸ªç½‘æ®µï¼ˆéš¾ debug å’Œéš”ç¦»ï¼‰ã€‚\n4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ 4.1 MTU è®¾ç½® VXLAN MTU ä¸€èˆ¬ä¸ºï¼š\nåŸç”Ÿ MTU 1500 -\u0026gt; VXLAN -\u0026gt; 1450 Calico é»˜è®¤è‡ªåŠ¨æ£€æµ‹ï¼Œä½†å»ºè®®æ˜ç¡®å†™ï¼š\nmtu: 1450 4.2 æ‰“å¼€ eBPFï¼ˆæœ€ä½³æ€§èƒ½ï¼‰ eBPF æ¨¡å¼æ›¿ä»£ kube-proxy\nNodePortã€ClusterIP NAT éƒ½èµ° BPF fast pathã€‚\n4.3 å…³é—­ SNAT fallbackï¼ˆå‡å°‘ NATï¼‰ åœ¨è·¨èŠ‚ç‚¹è®¿é—®ä¸éœ€è¦ SNAT æ—¶ï¼š\nspec: calicoNetwork: nodeAddressAutodetectionV4: firstFound: true linuxDataplane: \u0026#34;BPF\u0026#34; autoDetectBackend: false 5. Pod â†” Pod æœ€ä½³é“¾è·¯ Pod â†” Pod æœ€ä½³å®è·µè·¯å¾„ï¼š\neBPF dataplaneï¼š\nè§„åˆ™åœ¨ BPF maps conntrack ä¼˜åŒ–å·¨å¤§ VXLAN overlayï¼š\nå…¼å®¹æ‰€æœ‰äº‘å‚å•† ç¡¬ä»¶ offload é«˜æ€§èƒ½ç¯å¢ƒæœ€å¿« æœ€ä½³ç»„åˆï¼š\nVXLAN + eBPF + æ—  kube-proxy\n6. Serviceï¼ˆClusterIP/NodePort/LBï¼‰æœ€ä½³å®è·µ 6.1 ç¦ç”¨ kube-proxyï¼ˆeBPF è‡ªåŠ¨å¤„ç†ï¼‰ Calico eBPF æ¨¡å¼å¯ç›´æ¥æ›¿ä»£ kube-proxyï¼š\nlinuxDataplane: BPF ClusterIP å’Œ NodePort éƒ½èµ° BPFï¼Œæå¤§æé«˜æ€§èƒ½ã€‚\n6.2 NodePort è°ƒä¼˜ï¼ˆé«˜å¹¶å‘ï¼‰ è®¾ç½® conntrackï¼š\nnet.netfilter.nf_conntrack_max=2621440 net.netfilter.nf_conntrack_buckets=655360 7. NetworkPolicy æœ€ä½³å®è·µ Calico çš„ NP èƒ½å®ç° Zero Trustã€‚\nå¼ºçƒˆæ¨èé»˜è®¤æ‹’ç»ç­–ç•¥ åœ¨ Namespace ä½¿ç”¨ï¼š\napiVersion: projectcalico.org/v3 kind: GlobalNetworkPolicy metadata: name: default-deny spec: selector: all() types: - Ingress - Egress åˆ†ä¸šåŠ¡ namespace ä½¿ç”¨ allow-only ç­–ç•¥ ç¤ºä¾‹ï¼šåªå…è®¸ frontend -\u0026gt; backend\napiVersion: projectcalico.org/v3 kind: NetworkPolicy metadata: name: allow-frontend namespace: backend spec: ingress: - from: - namespaceSelector: matchLabels: app: frontend 8. ç”Ÿäº§ç¯å¢ƒå¸¸è§é”™è¯¯ \u0026amp; é¿å‘ 8.1 ä¸è¦æ··ç”¨å¤šä¸ª CNI ä¸èƒ½åœ¨åŒä¸€ä¸ªé›†ç¾¤ï¼š\nå®‰è£… Calico ååˆå®‰è£… Flannel åŸæ¥æœ‰ CNIï¼Œä¸å¹²å‡€å°±è£… Calico -\u0026gt; ç›´æ¥å¯¼è‡´ Pod æ— ç½‘ç»œã€è·¯ç”±æ··ä¹±ã€CNM å†²çªã€‚\n8.2 ä¸è¦è®© kube-proxy + bpf åŒæ—¶å·¥ä½œ eBPF æ¨¡å¼ä¸‹ kube-proxy å¿…é¡»å…³é—­ã€‚\n8.3 MTU ä¸ç»Ÿä¸€ = å…¨é›†ç¾¤éšæœºä¸¢åŒ… è°ƒè¯•æœ€å®¹æ˜“å¿½ç•¥ï¼šMTUã€‚\n8.4 BGP æ¨¡å¼è¦æ…ç”¨ï¼ˆäº‘å‚å•†ä¸æ”¯æŒï¼‰ ä»…æ¨èï¼š\nè£¸é‡‘å± è‡ªå»ºæœºæˆ¿ äº‘å‚å•†å¼€å¯ VPC route table æ”¯æŒ BGP æ—¶ 9. Calico ç›‘æ§æœ€ä½³å®è·µ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç›‘æ§ï¼š\n| é¡¹ç›® | è¯´æ˜ | | felix CPU | è§„åˆ™è¿‡å¤šä¼šçˆ† | | BPF maps | æº¢å‡ºä¼šä¸­æ–­ç½‘ç»œ | | VXLAN å°åŒ… PPS | å¸¸è§ç“¶é¢ˆ | | conntrack | NodePort é«˜å¹¶å‘å¿…é¡» | | IPPool ä½™é‡ | IP ç”¨å®Œ Pod å…¨æŒ‚\næ¨èå·¥å…·ï¼š\nPrometheus + calico-exporter Grafana Calico Dashboardï¼ˆå®˜æ–¹ï¼‰ 10. Troubleshooting æœ€ä½³å®è·µ 10.1 æŸ¥çœ‹ Pod è·¯ç”± ip route 10.2 æŸ¥çœ‹ VXLAN tunnel ip -d link show vxlan.calico 10.3 æŸ¥çœ‹ IPPool kubectl get ippool 10.4 Calico node logs kubectl logs -n calico-system -l k8s-app=calico-node 11. Kubernetes + Calico æœ€ä½³ç”Ÿäº§é…ç½®æ€»ç»“ åˆ†ç±» æ¨èé…ç½® Dataplane eBPF Overlay VXLAN èŠ‚ç‚¹è·¯ç”± æ—  BGPï¼ˆäº‘ï¼‰ / BGPï¼ˆè£¸é‡‘å±ï¼‰ kube-proxy å…³é—­ MTU 1450 IPAM Calico IPAMï¼Œå¤š IP pool ç­–ç•¥ Zero Trustï¼ˆdefault deny + allowï¼‰ åŠ å¯† WireGuard ç›‘æ§ felixã€ippoolã€vxlanã€conntrack ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€å·¥ç¨‹çº§ã€èƒ½ç›´æ¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒçš„ã€ŠKubernetes + Calico æœ€ä½³å®è·µã€‹ï¼ŒåŸºäº Kubernetes â‰¥1.33 + Calico â‰¥3.27ï¼ˆå« eBPF æ¨¡å¼ï¼‰ï¼ŒåŒ…å«ç½‘ç»œè®¾è®¡ã€æ€§èƒ½ã€å®‰å…¨ã€IPAMã€Policyã€Troubleshootingã€ç›‘æ§ã€ç”Ÿäº§å‚æ•°ç­‰å†…å®¹ã€‚\nè¿™æ˜¯ä¼ä¸šçº§ç‰ˆæœ¬ï¼Œä¸è®²åºŸè¯ï¼Œåªç»™å¯å¤åˆ¶åˆ°ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µã€‚\nğŸš€ Kubernetes + Calico æœ€ä½³å®è·µï¼ˆK8S 1.33 / Calico 3.27+ï¼‰\n1. CNI ç½‘ç»œæ¨¡å‹é€‰å‹ï¼ˆæœ€å…³é”®ï¼‰ Calico æ”¯æŒå¤šç§ç½‘ç»œæ¨¡å¼ï¼Œä½†è¦é€‰æ­£ç¡®ï¼š\nğŸ”¥ æœ€ä½³é€‰å‹ï¼ˆå¼ºçƒˆæ¨èï¼‰\nDataplaneï¼šeBPFï¼ˆæ›¿ä»£ iptablesï¼‰\nOverlayï¼šVXLAN + eBPF NAT\nIPAMï¼šCalico IPAM\nRoutingï¼šæ—  BGPï¼ˆé™¤éè£¸é‡‘å±ï¼‰\nç†ç”±ï¼š\næ¨¡å¼ æ€§èƒ½ å¯è§‚æµ‹æ€§ å…¼å®¹æ€§ æ¨è VXLAN + eBPF â­â­â­â­â­ â­â­â­â­â­ å…¨äº‘å‚å•†æ”¯æŒ âœ“âœ“âœ“âœ“âœ“ BGP æ— å°è£… â­â­â­â­â­ â­â­â­â­â­ ä»…è£¸é‡‘å±/è‡ªå»º IDC âœ“âœ“âœ“âœ“ IPIP â­â­â­ â­â­ æ—§æœºå™¨ ä¸æ¨è çº¯ iptables â­ â­â­ å…¼å®¹æœ€å¹¿ ä¸æ¨è eBPF å¯¹ K8S 1.33 å®Œç¾æ”¯æŒ\n"},{"id":267,"href":"/operations/kubernetes/daemonset/","title":"Kubernetes DaemonSet","parent":"Kubernetes","content":" ğŸ“Œ 1. ä»€ä¹ˆæ˜¯ DaemonSetï¼Ÿ DaemonSet æ˜¯ Kubernetes çš„ä¸€ç§ Workload èµ„æºï¼Œç”¨æ¥ä¿è¯ï¼š\næ¯ä¸ªï¼ˆæˆ–ç‰¹å®šï¼‰èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸”ä¿æŒè¿è¡Œä¸€ä¸ª Podã€‚\nå…¸å‹ç”¨é€”åŒ…æ‹¬éœ€è¦ èŠ‚ç‚¹çº§åˆ« Agent / å®ˆæŠ¤è¿›ç¨‹ çš„åœºæ™¯ï¼š\næ—¥å¿—é‡‡é›†ï¼ˆFluentd, Vector, Filebeatï¼‰ ç›‘æ§ Agentï¼ˆNode Exporter, Prometheus Agentï¼‰ CNI / å®¹å™¨ç½‘ç»œæ’ä»¶ï¼ˆCalico, Ciliumï¼‰ å­˜å‚¨æ’ä»¶ï¼ˆCSI Node Pluginï¼‰ å®‰å…¨ Agentï¼ˆFalcoï¼‰ kube-proxyï¼ˆå¦‚æœæœªè¢« eBPF æ›¿ä»£ï¼‰ ğŸ“Œ 2. DaemonSet çš„æ ¸å¿ƒæœºåˆ¶ï¼ˆè°ƒåº¦é€»è¾‘ï¼‰ DaemonSet Controller å¹¶ä¸ç›´æ¥è°ƒåº¦ Podï¼Œè€Œæ˜¯ï¼š\n2.1 åˆ¤å®šå“ªäº›èŠ‚ç‚¹åº”è¯¥è¿è¡Œ Pod æ ¹æ®ï¼š\nnodeSelector nodeAffinity taints \u0026amp; tolerations node conditionsï¼ˆReady, DiskPressureâ€¦ï¼‰ eviction status 2.2 è‡ªåŠ¨ä¸ºæ¯ä¸ªç¬¦åˆæ¡ä»¶çš„ Node åˆ›å»º 1 ä¸ª Pod åˆ›å»ºåäº¤ç”± Scheduler è°ƒåº¦ï¼ˆK8S 1.12+ çš„è¡Œä¸ºï¼‰ã€‚\n2.3 ç›‘æ§èŠ‚ç‚¹å˜åŒ– æœ‰æ–°èŠ‚ç‚¹åŠ å…¥ -\u0026gt; è‡ªåŠ¨è¡¥é½ Pod èŠ‚ç‚¹ NotReady -\u0026gt; Pod å¯èƒ½é©±é€/é‡å»º èŠ‚ç‚¹è¢« cordon/drain -\u0026gt; Pod æŒ‰è§„åˆ™å¤„ç† ğŸ“Œ 3. DaemonSet ä¸ Deployment çš„åŒºåˆ«ï¼ˆæ ¸å¿ƒåŒºåˆ«ï¼‰ ç‰¹æ€§ DaemonSet Deployment Pod æ•°é‡ æ¯èŠ‚ç‚¹ 1 ä¸ª æŒ‰ replica æŒ‡å®š è°ƒåº¦ è‡ªåŠ¨è¦†ç›–èŠ‚ç‚¹ scheduler ç»Ÿä¸€è°ƒåº¦ åœºæ™¯ èŠ‚ç‚¹çº§å®ˆæŠ¤è¿›ç¨‹ ä¸šåŠ¡åº”ç”¨ ä¸èŠ‚ç‚¹å…³ç³» ä¸€ä¸€å¯¹åº” æ— ç»‘å®šå…³ç³» é©±é€è¡Œä¸º å¯éšèŠ‚ç‚¹å˜åŒ– æ ‡å‡†é©±é€é€»è¾‘ ç®€å•è¯´ï¼š\nDeployment = è·‘ä¸šåŠ¡æœåŠ¡ DaemonSet = ç®¡èŠ‚ç‚¹çš„æœåŠ¡ ğŸ“Œ 4. DaemonSet çš„è°ƒåº¦æµç¨‹ ä»¥ä¸‹æ˜¯ Kubernetes Scheduler + DaemonSet Controller çš„è”åˆé€»è¾‘ï¼š\nèŠ‚ç‚¹ä¸Šçº¿/æ›´æ–° â†“ DaemonSet Controller å‘ç°ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ â†“ ä¸ºè¯¥èŠ‚ç‚¹åˆ›å»º DaemonSet Podï¼ˆæœªç»‘å®šï¼‰ â†“ Scheduler è¿‡æ»¤èŠ‚ç‚¹ï¼ˆå¿…é¡»ä¸ Pod æ‰€å±èŠ‚ç‚¹åŒ¹é…ï¼‰ â†“ Scheduler å°† Pod å›ºå®šç»‘å®šåˆ°è¯¥èŠ‚ç‚¹ â†“ kubelet æ‹‰èµ· Pod æ³¨æ„ï¼š\nDaemonSet Pod é»˜è®¤å¸¦æœ‰ nodeAffinity é™åˆ¶ï¼Œä½¿å…¶ åªèƒ½è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹ã€‚\nğŸ“Œ 5. DaemonSet çš„å…³é”®å­—æ®µè¯¦è§£ ä¸€ä¸ªå…¸å‹ DaemonSetï¼š\napiVersion: apps/v1 kind: DaemonSet metadata: name: node-exporter spec: selector: matchLabels: app: node-exporter template: metadata: labels: app: node-exporter spec: tolerations: - operator: Exists # èƒ½è¿è¡Œåœ¨æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Š hostNetwork: true # ä½¿ç”¨èŠ‚ç‚¹ç½‘ç»œ containers: - name: node-exporter image: prom/node-exporter:latest updateStrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 10% â­ å…³é”®å­—æ®µè¯´æ˜ ğŸ”¹ updateStrategy DaemonSet æ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š\nRollingUpdateï¼ˆæ¨èï¼‰ å¯æ§åˆ¶ï¼š\nmaxUnavailable åˆ†æ‰¹æ›´æ–° é€‚ç”¨äºï¼š\nkube-proxy CNI æ’ä»¶ ç›‘æ§ Agent OnDelete ç®¡ç†å‘˜æ‰‹åŠ¨åˆ é™¤æ—§ Pod åï¼Œæ‰ä¼šæ‹‰èµ·æ–° Podã€‚\nç”¨åœ¨ï¼š\né£é™©è¾ƒå¤§çš„ç½‘ç»œæ’ä»¶å‡çº§ï¼ˆå¦‚ Calicoï¼‰ è‡ªå·±å¼€å‘çš„èŠ‚ç‚¹ Agent ğŸ”¹ tolerations DaemonSet å…¸å‹è¦å®¹å¿ master/infra èŠ‚ç‚¹ï¼š\ntolerations: - operator: \u0026#34;Exists\u0026#34; å¦åˆ™æ— æ³•éƒ¨ç½²åˆ°å«æ±¡ç‚¹çš„å…³é”®èŠ‚ç‚¹ã€‚\nğŸ”¹ nodeSelector / nodeAffinity æŒ‡å®šèŠ‚ç‚¹ï¼š\nnodeSelector: node-role.kubernetes.io/worker: \u0026#34;\u0026#34; æˆ–æ›´ä¸¥æ ¼ï¼š\naffinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: node-role.kubernetes.io/worker operator: Exists ğŸ”¹ hostNetwork / HostPath Agent å¸¸ç”¨ï¼š\nhostNetwork: true hostPID: true å­˜å‚¨/æ—¥å¿—æ’ä»¶ï¼š\nvolumeMounts: - mountPath: /var/log name: log-dir volumes: - hostPath: path: /var/log name: log-dir ğŸ“Œ 6. DaemonSet å¸¸è§ä½¿ç”¨åœºæ™¯ï¼ˆè¶…çº§é‡è¦ï¼‰ ğŸ§© 6.1 ç›‘æ§ \u0026amp; æ—¥å¿—é‡‡é›† Prometheus Node Exporter Promtail Vector Filebeat Fluentd ğŸ§© 6.2 Kubernetes ç³»ç»Ÿç»„ä»¶ calico-node cilium-agent kube-proxyï¼ˆæœªå¯ç”¨ eBPF æ—¶ï¼‰ ğŸ§© 6.3 å®‰å…¨å·¥å…· Falco Open Policy Agent Gatekeeper Agent ğŸ§© 6.4 å­˜å‚¨æ’ä»¶ï¼ˆCSIï¼‰ Longhorn Ceph RBD CSI Node Plugin ğŸ“Œ 7. DaemonSet çš„è°ƒä¼˜ä¸æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§ï¼‰ 7.1 å¿…é¡»åŠ  tolerations å¦åˆ™æ— æ³•åœ¨ master/infra èŠ‚ç‚¹è¿è¡Œå®šåˆ¶ Agentï¼š\ntolerations: - operator: Exists 7.2 å¿…é¡»åŠ èµ„æºé™åˆ¶ é˜²æ­¢ç³»ç»Ÿ Agent åƒå…‰ Node CPUï¼š\nresources: limits: cpu: 200m memory: 200Mi requests: cpu: 50m memory: 50Mi 7.3 ä½¿ç”¨ RollingUpdate è€Œé OnDelete é™¤éæ˜¯å‡çº§ Calico è¿™ç§é£é™©æ’ä»¶ã€‚\n7.4 ä½¿ç”¨ PodDisruptionBudgetï¼ˆPDBï¼‰ é¿å…èŠ‚ç‚¹å¤§è§„æ¨¡æ»šæ›´å¯¼è‡´ä»»åŠ¡ä¸å¯ç”¨ã€‚\n7.5 åŠ å®¿ä¸»æœºè·¯å¾„åªè¯»æŒ‚è½½ï¼ˆé™ä½é£é™©ï¼‰ readOnly: true 7.6 å¤šå‰¯æœ¬ DaemonSetï¼ˆK8S 1.12+ æ”¯æŒï¼‰ é€šè¿‡æ ‡ç­¾å½±å“è¦†ç›–èŠ‚ç‚¹\nä¾‹å¦‚ï¼š\nnodeSelector: app-monitor: \u0026#34;true\u0026#34; ğŸ“Œ 8. DaemonSet å¸¸è§é—®é¢˜ â— 8.1 ä¸ºä»€ä¹ˆ DaemonSet Pod ä¸èµ·ï¼Ÿ æ’æŸ¥é¡ºåºï¼š\nkubectl describe nodes kubectl describe ds xxx kubectl get events kubectl logs -n kube-system ds/calico-node å¸¸è§åŸå› ï¼š\nèŠ‚ç‚¹æœ‰æ±¡ç‚¹ä½†æ²¡ tolerations nodeSelector è¿‡æ»¤è¿‡ä¸¥ é•œåƒæ‹‰å–é”™è¯¯ï¼ˆç§æœ‰ä»“åº“æœªç™»å½•ï¼‰ CNI runtime é”™è¯¯ â— 8.2. DaemonSet ä¼šè‡ªåŠ¨æ¼‚ç§»å—ï¼Ÿ ä¸ä¼šã€‚\nå¦‚æœ Pod ç»‘å®šçš„ Node ä¸‹çº¿ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„ Pod ä¸ä¼šè¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒæ˜¯ èŠ‚ç‚¹ç»‘å®šå‹ Workloadã€‚\nğŸ“Œ 9. DaemonSet æ€»ç»“ DaemonSet = ä¿éšœæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ª Podï¼Œç”¨äºèŠ‚ç‚¹çº§æœåŠ¡ã€‚\né€šè¿‡ tolerations/affinity æ§åˆ¶èŠ‚ç‚¹è¦†ç›–èŒƒå›´ï¼Œç”± Controller åˆ›å»º Podï¼Œç”± Scheduler ç»‘å®šèŠ‚ç‚¹ã€‚\nå…¸å‹ç”¨äºç›‘æ§ã€æ—¥å¿—ã€ç½‘ç»œã€å®‰å…¨ã€å­˜å‚¨æ’ä»¶ã€‚\n","description":" ğŸ“Œ 1. ä»€ä¹ˆæ˜¯ DaemonSetï¼Ÿ DaemonSet æ˜¯ Kubernetes çš„ä¸€ç§ Workload èµ„æºï¼Œç”¨æ¥ä¿è¯ï¼š\næ¯ä¸ªï¼ˆæˆ–ç‰¹å®šï¼‰èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸”ä¿æŒè¿è¡Œä¸€ä¸ª Podã€‚\nå…¸å‹ç”¨é€”åŒ…æ‹¬éœ€è¦ èŠ‚ç‚¹çº§åˆ« Agent / å®ˆæŠ¤è¿›ç¨‹ çš„åœºæ™¯ï¼š\næ—¥å¿—é‡‡é›†ï¼ˆFluentd, Vector, Filebeatï¼‰ ç›‘æ§ Agentï¼ˆNode Exporter, Prometheus Agentï¼‰ CNI / å®¹å™¨ç½‘ç»œæ’ä»¶ï¼ˆCalico, Ciliumï¼‰ å­˜å‚¨æ’ä»¶ï¼ˆCSI Node Pluginï¼‰ å®‰å…¨ Agentï¼ˆFalcoï¼‰ kube-proxyï¼ˆå¦‚æœæœªè¢« eBPF æ›¿ä»£ï¼‰ ğŸ“Œ 2. DaemonSet çš„æ ¸å¿ƒæœºåˆ¶ï¼ˆè°ƒåº¦é€»è¾‘ï¼‰ DaemonSet Controller å¹¶ä¸ç›´æ¥è°ƒåº¦ Podï¼Œè€Œæ˜¯ï¼š\n"},{"id":268,"href":"/operations/kubernetes/deployment/","title":"Kubernetes Deployment","parent":"Kubernetes","content":" ğŸ“˜ Kubernetes Deployment è¯¦è§£ï¼ˆé€‚ç”¨ç‰ˆæœ¬ â‰¥ 1.20 ï½ 1.33ï¼‰ Deployment æ˜¯ Kubernetes ä¸­æœ€å¸¸ç”¨çš„å·¥ä½œè´Ÿè½½ï¼ˆWorkloadï¼‰ä¹‹ä¸€ï¼Œç”¨äºï¼š\nç®¡ç† æ— çŠ¶æ€åº”ç”¨ï¼ˆstatelessï¼‰ æ»šåŠ¨å‡çº§ï¼ˆRolling Updateï¼‰ å›æ»šï¼ˆRollbackï¼‰ è‡ªåŠ¨é‡å»ºå‰¯æœ¬ï¼ˆself-healingï¼‰ æ§åˆ¶ Pod å‰¯æœ¬æ•°ï¼ˆReplicaSetï¼‰ Deployment é€šè¿‡ ReplicaSet æ¥ç®¡ç† Podï¼Œä½†ç”¨æˆ·å‡ ä¹ä¸ç›´æ¥æ“ä½œ ReplicaSetï¼Œè€Œæ˜¯æ“ä½œ Deploymentï¼ŒK8S è‡ªåŠ¨ç»´æŠ¤ä¸€è‡´æ€§ã€‚\n1. Deployment çš„æ ¸å¿ƒç»“æ„ æœ€ç®€ Deployment ç¤ºä¾‹ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: demo spec: replicas: 3 selector: matchLabels: app: demo template: metadata: labels: app: demo spec: containers: - name: demo image: nginx:1.27 ç»“æ„è§£è¯»ï¼š\nå­—æ®µ å«ä¹‰ replicas Pod å‰¯æœ¬æ•°é‡ selector Deployment ä½¿ç”¨ selector ç»‘å®š ReplicaSet template Pod æ¨¡æ¿ï¼Œå˜åŒ–æ—¶è§¦å‘æ»šåŠ¨æ›´æ–° strategy æ›´æ–°ç­–ç•¥ï¼ˆRollingUpdate / Recreateï¼‰ 2. Deployment å·¥ä½œæœºåˆ¶ï¼ˆæœ€é‡è¦ï¼‰ Deployment -\u0026gt; åˆ›å»º ReplicaSetï¼ˆRSï¼‰ -\u0026gt; RS åˆ›å»º Pod\nå½“ Deployment æ¨¡æ¿å˜åŒ–æ—¶ï¼š\nç”Ÿæˆæ–°çš„ ReplicaSet é€æ­¥æ‰©å®¹æ–°çš„ RS é€æ­¥ç¼©å®¹æ—§çš„ RS å®Œæˆåæ—§ RS ä¿ç•™ï¼ˆç”¨äºå›æ»šï¼‰ å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªå†å² ReplicaSetã€‚\n3. Deployment æ›´æ–°ç­–ç•¥ï¼ˆRollingUpdate \u0026amp; Recreateï¼‰ 3.1 é»˜è®¤ï¼šRolling Updateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ Deployment é»˜è®¤ä½¿ç”¨ï¼š\nstrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 25% maxSurge: 25% å«ä¹‰ï¼š\nå­—æ®µ å«ä¹‰ maxUnavailable æ›´æ–°æœŸé—´å…è®¸â€œæœ€å°‘ç¼ºå¤±â€çš„ Pod æ¯”ä¾‹æˆ–æ•°é‡ maxSurge æ›´æ–°æœŸé—´å…è®¸â€œå¤šå‡ºæ¥â€çš„ Pod æ¯”ä¾‹æˆ–æ•°é‡ ä¾‹å¦‚ï¼šreplicas=4ï¼ŒmaxSurge=1ï¼ŒmaxUnavailable=1\næ›´æ–°æ—¶å…è®¸ï¼š\næœ€å¤š 5 ä¸ª Pod è¿è¡Œï¼ˆ4 + 1ï¼‰ æœ€å°‘ 3 ä¸ª Pod å¯ç”¨ï¼ˆ4 - 1ï¼‰ å¯é¿å…æœåŠ¡ä¸­æ–­ï¼Œæ˜¯æ¨èæ–¹å¼ã€‚\n3.2 Recreateï¼ˆé‡å»ºï¼‰ strategy: type: Recreate æ›´æ–°æ—¶ï¼š\nå…ˆåˆ å…‰æ‰€æœ‰ Pod å†åˆ›å»ºæ–° Pod é€‚ç”¨åœºæ™¯ï¼š\néœ€è¦å”¯ä¸€è®¿é—®æ§åˆ¶ï¼Œå¦‚ï¼š\nMySQLï¼ˆé™¤é StatefulSetï¼‰ ElasticSearch å•èŠ‚ç‚¹ æŸäº›ä¸èƒ½å¹¶å‘è¿è¡Œçš„ legacy app 4. Deployment å¸¸ç”¨ spec å­—æ®µè¯¦è§£ 4.1 revisionHistoryLimit ä¿ç•™å¤šå°‘æ¡å†å² ReplicaSetï¼ˆç”¨äºå›æ»šï¼‰\nrevisionHistoryLimit: 10 é»˜è®¤å€¼æ˜¯ 10ã€‚\n4.2 progressDeadlineSeconds Deployment æ›´æ–°æœ€å¤§æ—¶é—´ï¼Œè¶…æ—¶åˆ™æ ‡è®°å¤±è´¥ã€‚\nprogressDeadlineSeconds: 600 é»˜è®¤ 600 ç§’ã€‚\n4.3 minReadySeconds æ–°å»º Pod åœ¨ ready çŠ¶æ€è‡³å°‘ä¿æŒå¤šé•¿æ—¶é—´æ‰ç®—â€œæˆåŠŸâ€ã€‚\nminReadySeconds: 5 é€‚åˆéœ€è¦é¢„çƒ­çš„æœåŠ¡ã€‚\n5. Pod æ¨¡æ¿å˜åŒ–ä¸æ»šåŠ¨æ›´æ–°è§¦å‘è§„åˆ™ å“ªäº›å˜åŒ–ä¼šè§¦å‘æ–° RSï¼Ÿ\nä¼šè§¦å‘çš„ï¼š\né•œåƒ tagå˜åŒ– ç¯å¢ƒå˜é‡å˜åŒ– configmap/secret åç§°å˜åŒ– command/args å˜åŒ– labelsï¼ˆtemplate éƒ¨åˆ†ï¼‰å˜åŒ– èµ„æºé™åˆ¶å˜åŒ–ï¼ˆCPU/Memï¼‰ ç«¯å£é…ç½®å˜åŒ– ä¸ä¼šè§¦å‘çš„ï¼š\nDeployment çš„æ³¨è§£å˜æ›´ Deployment çš„ labelsï¼ˆä¸å½±å“ templateï¼‰ 6. Deployment ç”Ÿå‘½å‘¨æœŸç®¡ç† 6.1 æ›´æ–° kubectl set image deploy/demo demo=nginx:1.28 Kubernetes ä¼šè‡ªåŠ¨æ»šåŠ¨æ›´æ–°ã€‚\n6.2 æš‚åœæ›´æ–°ï¼ˆPauseï¼‰ ç”¨äºè¿›è¡Œå‚æ•°ä¿®æ”¹åï¼Œç»Ÿä¸€ applyã€‚\nkubectl rollout pause deploy/demo ç„¶åæ›´æ–°å­—æ®µï¼š\nkubectl edit deploy/demo å®Œæˆåï¼š\nkubectl rollout resume deploy/demo 6.3 æŸ¥çœ‹çŠ¶æ€ kubectl rollout status deploy/demo 6.4 æŸ¥çœ‹å†å²ç‰ˆæœ¬ kubectl rollout history deploy/demo 6.5 å›æ»š å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š\nkubectl rollout undo deploy/demo å›æ»šåˆ°æŒ‡å®š revisionï¼š\nkubectl rollout undo deploy/demo --to-revision=3 7. é«˜å¯ç”¨/ç”Ÿäº§çº§ Deployment æœ€ä½³å®è·µ ä»¥ä¸‹å†…å®¹éå¸¸å…³é”®ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰ç”Ÿäº§é›†ç¾¤éƒ½å»ºè®®éµå¾ªã€‚\n7.1 è®¾ç½®èµ„æºé™åˆ¶ï¼ˆrequests/limitsï¼‰ resources: requests: cpu: 100m memory: 256Mi limits: cpu: 500m memory: 1Gi ä¸è®¾ç½®æ„å‘³ç€ Node èµ„æºè°ƒåº¦ä¸å¯æ§ï¼Œå¼•å‘è¿‡è½½ã€‚\n7.2 Liveness/Readiness/Startup probesï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ livenessProbe: httpGet: { path: /healthz, port: 8080 } initialDelaySeconds: 10 periodSeconds: 10 readinessProbe: httpGet: { path: /ready, port: 8080 } initialDelaySeconds: 5 periodSeconds: 5 æœåŠ¡å¯ç”¨æ€§æ˜æ˜¾æå‡ã€‚\n7.3 Anti-affinityï¼ˆè·¨èŠ‚ç‚¹å®¹ç¾ï¼‰ affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchLabels: app: demo topologyKey: kubernetes.io/hostname ç¡®ä¿ Pod åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ã€‚\n7.4 PodDisruptionBudgetï¼ˆPDBï¼‰ ä¿è¯æ»šåŠ¨å‡çº§æˆ–èŠ‚ç‚¹ç»´æŠ¤ä¸ä¼šä¸€æ¬¡æ€§å¹²æ‰å¤ªå¤š Podã€‚\napiVersion: policy/v1 kind: PodDisruptionBudget spec: minAvailable: 2 selector: matchLabels: app: demo 7.5 HorizontalPodAutoscalerï¼ˆHPAï¼‰ è‡ªåŠ¨æ‰©å®¹ï¼ˆéœ€ metrics-serverï¼‰ï¼š\napiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler 8. å®Œæ•´ç”Ÿäº§çº§ Deployment ç¤ºä¾‹ apiVersion: apps/v1 kind: Deployment metadata: name: demo spec: replicas: 4 revisionHistoryLimit: 10 progressDeadlineSeconds: 600 minReadySeconds: 5 selector: matchLabels: app: demo strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 1 template: metadata: labels: app: demo spec: containers: - name: demo image: nginx:1.27 ports: - containerPort: 80 resources: requests: { cpu: \u0026#34;200m\u0026#34;, memory: \u0026#34;256Mi\u0026#34; } limits: { cpu: \u0026#34;1\u0026#34;, memory: \u0026#34;512Mi\u0026#34; } readinessProbe: httpGet: { path: \u0026#34;/\u0026#34;, port: 80 } initialDelaySeconds: 3 livenessProbe: httpGet: { path: \u0026#34;/\u0026#34;, port: 80 } initialDelaySeconds: 10 affinity: podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchLabels: app: demo topologyKey: kubernetes.io/hostname 9. Deployment å¸¸è§é—®é¢˜æ’æŸ¥ â— Pod ä¸æ›´æ–°ï¼Ÿ\nDeployment template æ²¡æœ‰å˜åŒ–ï¼Œä¸ä¼šè§¦å‘æ–° RSã€‚\nâ— æ›´æ–°å¡ä½ï¼Ÿ\næ£€æŸ¥ï¼š\nreadinessProbe ä¸é€šè¿‡ é•œåƒæ‹‰å–å¤±è´¥ maxUnavailable è®¾ç½®è¿‡ä½ï¼ˆå¦‚ 0ï¼‰ PDB å¯¼è‡´æ— æ³•é©±é€æ—§ Pod æ–° Pod è°ƒåº¦å¤±è´¥ï¼ˆèµ„æºä¸è¶³ï¼‰ 10. Deployment ä¸å…¶ä»– Workload å¯¹æ¯” Workload ç‰¹ç‚¹ Deployment æ— çŠ¶æ€ã€æ»šåŠ¨æ›´æ–°ã€å›æ»š StatefulSet æœ‰çŠ¶æ€ã€æœ‰åºå¯åŠ¨ã€ç¨³å®šç½‘ç»œæ ‡è¯†ã€æŒä¹…å­˜å‚¨ DaemonSet æ¯ä¸ª Node ä¸€ä¸ª Pod Job / CronJob ä¸€æ¬¡æ€§ä»»åŠ¡ / å®šæ—¶ä»»åŠ¡ ReplicaSet Deployment çš„åº•å±‚ç®¡ç†å¯¹è±¡ï¼Œå¾ˆå°‘ç›´æ¥ä½¿ç”¨ YAML Kubernetes Deployment YAML é…ç½®è¯¦è§£ï¼ˆé€å­—æ®µè§£é‡Š + æœ€ä½³å®è·µï¼‰\nå†…å®¹åŒ…æ‹¬ï¼š\nDeployment æ•´ä½“ç»“æ„ æ¯ä¸ªå­—æ®µçš„è¯¦ç»†å«ä¹‰ å®é™… YAML æ¨¡æ¿ + é€è¡Œè§£é‡Š å¤šå‰¯æœ¬æ»šåŠ¨æ›´æ–°ã€æ¢é’ˆã€èµ„æºé™åˆ¶ã€ç­–ç•¥ç­‰ æœ€ä½³å®è·µ ğŸ’¡ 1. Deployment æ˜¯ä»€ä¹ˆï¼Ÿ Deployment æ˜¯ Kubernetes ä¸­æœ€å¸¸ç”¨çš„ workloadï¼Œç”¨äºï¼š\nç®¡ç† å¤šä¸ªå‰¯æœ¬ Pod è‡ªåŠ¨é‡å»ºã€è‡ªåŠ¨ä¿®å¤ æä¾› æ»šåŠ¨æ›´æ–°ï¼ˆrolling updateï¼‰ æä¾› ç‰ˆæœ¬å›æ»š Deployment æ˜¯å¯¹ ReplicaSet çš„é«˜çº§å°è£…ã€‚\nğŸ“¦ 2. Deployment çš„ YAML å®Œæ•´ç»“æ„ ä¸€ä¸ª Deployment ä¸»è¦åŒ…å«å››å±‚ï¼š\napiVersion kind metadata spec â”œâ”€ replicas â”œâ”€ selector â”œâ”€ strategy â”œâ”€ template â”œâ”€ metadata â””â”€ spec ğŸ§± 3. æœ€å®Œæ•´å¯å¤ç”¨ Deployment æ¨¡æ¿ï¼ˆK8S 1.33ï¼‰ ä¸‹é¢æ˜¯ä¸€ä¸ªåŠŸèƒ½æœ€å®Œæ•´çš„ Deployment ç¤ºä¾‹ï¼Œ\nä½ å¯ä»¥æ ¹æ®éœ€è¦è£å‰ªã€æ‰©å±•ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: my-app namespace: default labels: app: my-app spec: replicas: 3 revisionHistoryLimit: 10 progressDeadlineSeconds: 600 minReadySeconds: 5 paused: false selector: matchLabels: app: my-app strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 25% # æ›´æ–°è¿‡ç¨‹ä¸­è‡³å°‘ä¿ç•™å¤šå°‘å¯ç”¨ Pod maxSurge: 25% # æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤šè¶…å‡ºçš„ Pod æ•°é‡ template: metadata: labels: app: my-app annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; prometheus.io/port: \u0026#34;8080\u0026#34; spec: serviceAccountName: default terminationGracePeriodSeconds: 30 dnsPolicy: ClusterFirst containers: - name: my-app image: my-app:1.0.0 imagePullPolicy: IfNotPresent ports: - containerPort: 8080 name: http env: - name: ENV value: \u0026#34;production\u0026#34; envFrom: - configMapRef: name: my-config - secretRef: name: my-secret resources: requests: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;128Mi\u0026#34; limits: cpu: \u0026#34;500m\u0026#34; memory: \u0026#34;512Mi\u0026#34; startupProbe: httpGet: path: /startup port: 8080 failureThreshold: 30 periodSeconds: 5 readinessProbe: httpGet: path: /health port: 8080 initialDelaySeconds: 5 periodSeconds: 5 livenessProbe: httpGet: path: /alive port: 8080 periodSeconds: 10 volumeMounts: - name: app-config mountPath: /etc/my-app initContainers: - name: init-db image: busybox command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo preparing\u0026#34;] volumes: - name: app-config configMap: name: my-config ğŸ“ 4. é€å­—æ®µè§£é‡Šï¼ˆæœ€è¯¦ç»†ï¼‰ 4.1 metadata metadata: name: my-app namespace: default labels: app: my-app nameï¼šDeployment åç§° namespaceï¼šä½œç”¨çš„å‘½åç©ºé—´ labelsï¼šä¸º Deployment è‡ªèº«æ‰“æ ‡ç­¾ 4.2 spec ğŸ§© replicas replicas: 3 æœŸæœ›è¿è¡Œ 3 ä¸ª Podã€‚\nğŸ§© revisionHistoryLimit revisionHistoryLimit: 10 æœ€å¤šä¿ç•™ 10 ä¸ªæ—§ ReplicaSetï¼ˆç”¨äºå›æ»šï¼‰ã€‚\nğŸ§© progressDeadlineSeconds progressDeadlineSeconds: 600 è‹¥ 600 ç§’å†…æ›´æ–°æ²¡æœ‰å®Œæˆï¼Œåˆ™ Deployment è¿›å…¥ ProgressDeadlineExceeded çŠ¶æ€ã€‚\nğŸ§© minReadySeconds minReadySeconds: 5 Pod å°±ç»ªåéœ€è¦è‡³å°‘ ready 5 ç§’æ‰ç®—å¯ç”¨ã€‚\nğŸ§© paused paused: false ä¸º trueï¼Œåˆ™æš‚åœæ»šåŠ¨æ›´æ–°ã€‚\n4.3 selectorï¼ˆå¿…é¡»å’Œ Pod template çš„ labels åŒ¹é…ï¼‰ selector: matchLabels: app: my-app ç”¨äºâ€œé€‰ä¸­â€ template ç”Ÿæˆçš„ Podã€‚\n4.4 strategyï¼ˆæ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼‰ é»˜è®¤ç±»å‹æ˜¯ RollingUpdateï¼š\nstrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 25% maxSurge: 25% maxUnavailableï¼šæ›´æ–°æ—¶æœ€å¤šå…è®¸ 25% Pod ä¸å¯ç”¨ maxSurgeï¼šæ›´æ–°æ—¶æœ€å¤šå¤šåˆ›å»º 25% Pod ğŸ‘‰ Recreate æ¨¡å¼\nstrategy: type: Recreate å…ˆåˆ æ—§ Pod -\u0026gt; å†åˆ›å»ºæ–° Pod é€‚ç”¨äºï¼šä¸èƒ½å¹¶å­˜ä¸¤ä¸ªç‰ˆæœ¬çš„åº”ç”¨ï¼ˆå¦‚ MySQL ä¸»èŠ‚ç‚¹ï¼‰ã€‚ 5. template ï¼ˆPod æ¨¡æ¿ï¼‰ è¿™æ˜¯ Deployment æœ€é‡è¦çš„éƒ¨åˆ†ã€‚\n5.1 template.metadata labels: app: my-app annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; labels ä¸ selector åŒ¹é…éå¸¸å…³é”®ã€‚\n5.2 template.spec Deployment ç®¡ç†çš„ Pod å†…å®¹ï¼Œä¾‹å¦‚ï¼š\nå®¹å™¨åˆ—è¡¨\ncontainers: - name: my-app 5.3 imagePullPolicy imagePullPolicy: IfNotPresent ä¸‰ç§ï¼š\nAlwaysï¼šæ¯æ¬¡å¯åŠ¨éƒ½æ‹‰é•œåƒ IfNotPresentï¼šæœ¬åœ°æœ‰å°±ä¸ç”¨æ‹‰ Neverï¼šæ°¸è¿œä¸æ‹‰ ğŸ”¹ æ¨èï¼šç”Ÿäº§ä½¿ç”¨ IfNotPresent + tag å›ºå®šç‰ˆæœ¬\né¿å… latest å¯¼è‡´æ›´æ–°ä¸å¯æ§ã€‚\n5.4 èµ„æºé™åˆ¶ resources: requests: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;128Mi\u0026#34; limits: cpu: \u0026#34;500m\u0026#34; memory: \u0026#34;512Mi\u0026#34; requestsï¼šè°ƒåº¦æ—¶ Pod éœ€è¦çš„èµ„æº limitsï¼šå®¹å™¨æœ€å¤§å¯ç”¨èµ„æº æœ€ä½³å®è·µï¼š\nWeb åº”ç”¨ï¼š100mâ€“200m API æœåŠ¡ï¼š256Miâ€“512Mi 5.5 Probe æ¢é’ˆ startupProbeï¼ˆåˆå§‹åŒ–å‡†å¤‡ï¼‰ é˜²æ­¢å®¹å™¨è¿˜æ²¡å¯åŠ¨å°±è¢«é‡å¯ã€‚\nreadinessProbeï¼ˆæ˜¯å¦å¯¹å¤–å¯ç”¨ï¼‰ æ§åˆ¶ Service çš„æµé‡è½¬å‘ã€‚\nlivenessProbeï¼ˆå®¹å™¨æ˜¯å¦å­˜æ´»ï¼‰ ä¸å¥åº· -\u0026gt; è‡ªåŠ¨é‡å¯ã€‚\n5.6 initContainers initContainers: - name: init-db image: busybox ç”¨äºåˆå§‹åŒ–ï¼š\nç­‰å¾…æ•°æ®åº“ åˆå§‹åŒ–ç›®å½• initContainers æŒ‰é¡ºåºæ‰§è¡Œã€‚\n5.7 volumes å¦‚æŒ‚è½½ ConfigMap / Secretï¼š\nvolumes: - name: app-config configMap: name: my-config ğŸ† 5. Deployment ä½¿ç”¨æœ€ä½³å®è·µï¼ˆK8S 1.33ï¼‰ ä½¿ç”¨å›ºå®šæ ‡ç­¾ï¼Œä¸è¦ä½¿ç”¨ latest\nimage: my-app:v1.3.0 ä½¿ç”¨ readinessProbe æ§åˆ¶æµé‡\né¿å…æœåŠ¡å¯åŠ¨æ—©æœŸæ”¶åˆ°æµé‡è€Œå´©æºƒã€‚\næ»šåŠ¨æ›´æ–°ç­–ç•¥åˆç†é…ç½®\nmaxUnavailable = 25% maxSurge = 25% requests/limits å¿…é¡»è®¾ç½®ï¼ˆé˜²æ­¢èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ï¼‰\nä½¿ç”¨ revisionHistoryLimit é¿å…å‰¯æœ¬çˆ†ç‚¸\næ¨èå°†æ—¥å¿— stdout/stderr è¾“å‡ºåˆ°å®¹å™¨æ ‡å‡†è¾“å‡º\nä½¿ç”¨ PodDisruptionBudgetï¼ˆPDBï¼‰é˜²æ­¢å‡çº§å¯¼è‡´å…¨æŒ‚\n","description":" ğŸ“˜ Kubernetes Deployment è¯¦è§£ï¼ˆé€‚ç”¨ç‰ˆæœ¬ â‰¥ 1.20 ï½ 1.33ï¼‰ Deployment æ˜¯ Kubernetes ä¸­æœ€å¸¸ç”¨çš„å·¥ä½œè´Ÿè½½ï¼ˆWorkloadï¼‰ä¹‹ä¸€ï¼Œç”¨äºï¼š\nç®¡ç† æ— çŠ¶æ€åº”ç”¨ï¼ˆstatelessï¼‰ æ»šåŠ¨å‡çº§ï¼ˆRolling Updateï¼‰ å›æ»šï¼ˆRollbackï¼‰ è‡ªåŠ¨é‡å»ºå‰¯æœ¬ï¼ˆself-healingï¼‰ æ§åˆ¶ Pod å‰¯æœ¬æ•°ï¼ˆReplicaSetï¼‰ Deployment é€šè¿‡ ReplicaSet æ¥ç®¡ç† Podï¼Œä½†ç”¨æˆ·å‡ ä¹ä¸ç›´æ¥æ“ä½œ ReplicaSetï¼Œè€Œæ˜¯æ“ä½œ Deploymentï¼ŒK8S è‡ªåŠ¨ç»´æŠ¤ä¸€è‡´æ€§ã€‚\n1. Deployment çš„æ ¸å¿ƒç»“æ„ æœ€ç®€ Deployment ç¤ºä¾‹ï¼š\n"},{"id":269,"href":"/operations/kubernetes/job/","title":"Kubernetes Job","parent":"Kubernetes","content":"Job ä¸ CronJob æ˜¯ Kubernetes ä¸­çš„ æ‰¹å¤„ç†ï¼ˆBatchï¼‰å·¥ä½œè´Ÿè½½ï¼Œç”¨äºæ‰§è¡Œä¸€æ¬¡æ€§æˆ–å‘¨æœŸæ€§ä»»åŠ¡ã€‚\nğŸŒŸ 1. Job ä¸ CronJob çš„å®šä½ Workload é€‚ç”¨åœºæ™¯ ç‰¹æ€§ Deployment æŒç»­è¿è¡ŒæœåŠ¡ æ¨ªå‘æ‰©å±•ã€æ»šåŠ¨å‡çº§ StatefulSet æœ‰çŠ¶æ€æœåŠ¡ å›ºå®šèº«ä»½ã€ç¨³å®šå­˜å‚¨ DaemonSet æ¯èŠ‚ç‚¹ Agent æ¯èŠ‚ç‚¹è¿è¡Œ Job æ‰§è¡Œä¸€æ¬¡ä¸”æˆåŠŸé€€å‡º ä¿è¯å®Œæˆ CronJob å‘¨æœŸæ€§æ‰§è¡Œ ç±»ä¼¼ Linux crontab æ€»ç»“ï¼š\nJob = ä¸€æ¬¡æ€§ä»»åŠ¡ã€‚ CronJob = æœ‰è®¡åˆ’çš„ Jobã€‚ ğŸŒŸ 2. Jobï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰è¯¦è§£ Job ç”¨äºæ‰§è¡Œå¿…é¡» æˆåŠŸä¸€æ¬¡ çš„ä»»åŠ¡ã€‚\nå¸¸ç”¨äºï¼š\næ•°æ®è¿ç§» æ•°æ®å¤‡ä»½ æ–‡ä»¶æ¸…ç† å¯åŠ¨å‰åˆå§‹åŒ–ï¼ˆInit æ“ä½œï¼‰ å¼‚æ­¥è„šæœ¬ï¼ˆå‘é€é€šçŸ¥ã€æ‰§è¡Œ ETLï¼‰ ğŸ§© 2.1 Job æ ¸å¿ƒå­—æ®µè¯´æ˜ ä¸€ä¸ªæœ€å°çš„ Jobï¼š\napiVersion: batch/v1 kind: Job metadata: name: example-job spec: template: spec: restartPolicy: Never containers: - name: task image: busybox command: [\u0026#34;echo\u0026#34;, \u0026#34;Hello World\u0026#34;] â­ å…³é”®å­—æ®µè¯´æ˜ restartPolicy\nåªèƒ½æ˜¯ï¼š\nNeverï¼ˆæ¨èï¼‰ OnFailure ä¸èƒ½ä½¿ç”¨ Alwaysï¼ˆå¦åˆ™ä¸ç¬¦åˆ Job è¯­ä¹‰ï¼‰ã€‚\nbackoffLimit\nå¤±è´¥é‡è¯•æ¬¡æ•°ï¼š\nbackoffLimit: 6 # é»˜è®¤ 6 è¶…è¿‡é™åˆ¶ -\u0026gt; Job è¿›å…¥ Failed çŠ¶æ€ã€‚\nactiveDeadlineSeconds\nè®¾ç½®ä»»åŠ¡æœ€å¤§æ‰§è¡Œæ—¶é•¿ï¼š\nactiveDeadlineSeconds: 300 é¿å… Job å¡æ­»ã€‚\nttlSecondsAfterFinished\nè‡ªåŠ¨æ¸…ç†å·²å®Œæˆçš„ Jobï¼š\nttlSecondsAfterFinished: 3600 ä¸è‡³äºå †ç§¯ã€‚\nğŸ§© 2.2 Job å¹¶è¡Œæ¨¡å¼ï¼ˆ3 ç§ï¼‰ Job æœ‰ 3 ç§æ‰§è¡Œæ¨¡å¼ï¼š\n1. éå¹¶è¡Œæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ spec.parallelism æœªè®¾ç½® ä¸€ä¸ª Pod è¿è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚\né€‚åˆï¼š\nå•ä»»åŠ¡æ‰§è¡Œï¼ˆæœ€å¸¸è§ï¼‰ 2. å®Œæˆæ•°æ¨¡å¼ï¼ˆCompletionsï¼‰ completions: 5 parallelism: 2 å«ä¹‰ï¼š\nä¸€å…±éœ€è¦å®Œæˆ 5 æ¬¡ æ¯æ¬¡æœ€å¤šå¹¶è¡Œ 2 ä¸ª Pod é€‚åˆï¼š\né‡å¤æ€§ä»»åŠ¡ å¹¶è¡Œè®¡ç®— 3. å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼ˆå®Œå…¨å¹¶è¡Œï¼‰ parallelism: 10 completions æœªæŒ‡å®š é€šå¸¸ä¸å¤–éƒ¨é˜Ÿåˆ—ï¼ˆRabbitMQ/Kafkaï¼‰é…å¥—ï¼š\næ¯ä¸ª Pod ä»é˜Ÿåˆ—å–ä»»åŠ¡ å¹¶è¡Œæ‰§è¡Œ Pod è‡ªè¡Œé€€å‡º ğŸŒŸ 3. CronJobï¼ˆå‘¨æœŸæ€§ä»»åŠ¡ï¼‰è¯¦è§£ CronJob åªæ˜¯ä¸€ä¸ª å®šæ—¶è§¦å‘çš„ Jobã€‚\nç¤ºä¾‹ï¼š\napiVersion: batch/v1 kind: CronJob metadata: name: backup spec: schedule: \u0026#34;0 */6 * * *\u0026#34; # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡ jobTemplate: spec: template: spec: restartPolicy: Never containers: - name: backup image: alpine command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo backup run\u0026#34;] ğŸ§© 3.1 Cron è¡¨è¾¾å¼ CronJob é‡‡ç”¨ Linux crontab æ ¼å¼ï¼š\nåˆ† æ—¶ æ—¥ æœˆ å‘¨ ç¤ºä¾‹ï¼š\nschedule å«ä¹‰ \u0026quot;*/5 * * * *\u0026quot; æ¯ 5 åˆ†é’Ÿ \u0026quot;0 0 * * *\u0026quot; æ¯å¤© 0 ç‚¹ \u0026quot;0 3 * * 1\u0026quot; æ¯å‘¨ä¸€ 3 ç‚¹ \u0026quot;0 */6 * * *\u0026quot; æ¯ 6 å°æ—¶ ğŸ§© 3.2 CronJob å…³é”®å­—æ®µ successfulJobsHistoryLimit ä¿ç•™æˆåŠŸ Job æ•°é‡ï¼š\nsuccessfulJobsHistoryLimit: 3 failedJobsHistoryLimit å¤±è´¥ Job æ•°é‡ï¼š\nfailedJobsHistoryLimit: 1 startingDeadlineSeconds å…è®¸å»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´ï¼ˆé¿å…é”™è¿‡è°ƒåº¦ï¼‰ï¼š\nstartingDeadlineSeconds: 200 concurrencyPolicyï¼ˆé‡è¦ï¼‰ å¤„ç†ä¸Šæ¬¡ä»»åŠ¡æ²¡æ‰§è¡Œå®Œçš„æƒ…å†µï¼š\nå­—æ®µ å«ä¹‰ Allow é»˜è®¤ï¼Œå…è®¸å¹¶å‘å¤šä¸ª Job Forbid ç¦æ­¢å¹¶å‘ï¼ˆä¸Šä¸€ä¸ªæœªå®Œæˆ -\u0026gt; æœ¬æ¬¡è·³è¿‡ï¼‰ Replace æ€æ‰æ—§ Jobï¼Œå¯åŠ¨æ–° Job ä¾‹å­ï¼š\nconcurrencyPolicy: Forbid ğŸŒŸ 4. Job / CronJob çš„è°ƒåº¦æµç¨‹å›¾ Job è°ƒåº¦æµç¨‹ åˆ›å»º Job â†“ Controller åˆ›å»º Pod â†“ Pod è¿è¡Œå®Œæˆ â†“ æˆåŠŸ/å¤±è´¥è®¡æ•°æ›´æ–° â†“ è¾¾åˆ°é™åˆ¶ (completions/backoffLimit) â†“ Job æ ‡è®°ä¸º Completed æˆ– Failed CronJob è°ƒåº¦æµç¨‹ CronJob å®šæ—¶è§¦å‘ â†“ åˆ›å»º Jobï¼ˆä¸€ä¸ª Cron æ—¶é—´ç‚¹ = ä¸€ä¸ª Jobï¼‰ â†“ Job åˆ›å»º Pod â†“ Pod æ‰§è¡Œå®Œæˆ ğŸŒŸ 5. Job + CronJob ç”Ÿäº§æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ âœ… å¿…é¡»è®¾ç½® restartPolicy: Never backoffLimit activeDeadlineSeconds ttlSecondsAfterFinished ç¤ºä¾‹ï¼ˆæœ€æ¨èï¼‰ï¼š\nspec: backoffLimit: 3 activeDeadlineSeconds: 600 ttlSecondsAfterFinished: 3600 âœ… CronJob å»ºè®®è®¾ç½® concurrencyPolicy é˜²æ­¢ä»»åŠ¡å †ç§¯ï¼š\nconcurrencyPolicy: Forbid âœ… Job çš„ Pod ä¸è¦ä½¿ç”¨ Always é‡å¯ç­–ç•¥ ä¼šå¯¼è‡´æ— é™é‡å¯ -\u0026gt; Job å¡æ­»\nâœ… CronJob éœ€è¦ç›‘æ§æ‰§è¡Œæƒ…å†µ ä½¿ç”¨ï¼š\nkubectl get jobs -A kubectl describe cronjob \u0026lt;name\u0026gt; âœ… é¿å…é¢‘ç‡è¿‡é«˜ï¼ˆä¾‹å¦‚ */1 * * * *ï¼‰ Kubernetes Job æ§åˆ¶å™¨ä¸æ˜¯ä¸ºæ¯«ç§’çº§é«˜é¢‘è°ƒåº¦è®¾è®¡çš„ã€‚\næ¯åˆ†é’Ÿä¸€æ¬¡å·²ç»æ˜¯ä¸Šé™ï¼Œç§’çº§ä»»åŠ¡åº”è¯¥ç”¨ï¼š\nå†…éƒ¨å®šæ—¶å™¨ æµå¼è®¡ç®— æŒ‡æ ‡é©±åŠ¨ï¼ˆEvent-drivenï¼‰ âœ… Job çš„ Pod éœ€è¦ä½¿ç”¨èµ„æºé™åˆ¶ï¼ˆé˜²æ­¢è€—å°½ Nodeï¼‰ é˜²æ­¢å•ä¸ªä»»åŠ¡åƒå…‰èµ„æºï¼š\nresources: limits: cpu: 500m memory: 512Mi ğŸŒŸ 6. Job/CronJob å¸¸è§é—®é¢˜ â“ CronJob ä¸ºä»€ä¹ˆä¼šæ¼æ‰§è¡Œï¼Ÿ å¯èƒ½åŸå› ï¼š\ncontroller-manager é‡å¯ schedule æ—¶é—´ç‚¹å¤ªå¯†é›† startingDeadlineSeconds è®¾ç½®å¤ªå° â“ CronJob æ‰§è¡Œå¤ªå¤šå†å² Jobï¼Ÿ å› ä¸ºï¼š\nsuccessfulJobsHistoryLimit failedJobsHistoryLimit æœªè®¾ç½®ã€‚\nâ“ Job ä¸ºä»€ä¹ˆä¸€ç›´ Pendingï¼Ÿ åŸå› ï¼š\næ²¡æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ PVC æ— æ³•ç»‘å®š èµ„æº quota é™åˆ¶ è°ƒåº¦å™¨ taint æœªå®¹å¿ â“ Job ä¼šå¹¶å‘æ‰§è¡Œå—ï¼Ÿ å–å†³äºï¼š\nparallelism CronJob åˆ™ç”±ï¼š\nconcurrencyPolicy æ§åˆ¶ã€‚\nğŸŒŸ 7. å¤šåœºæ™¯å®Œæ•´ç¤ºä¾‹ æ¯å¤©å‡Œæ™¨å¤‡ä»½æ•°æ®åº“ï¼ˆCronJobï¼‰ apiVersion: batch/v1 kind: CronJob metadata: name: mysql-backup spec: schedule: \u0026#34;0 3 * * *\u0026#34; concurrencyPolicy: Forbid successfulJobsHistoryLimit: 3 failedJobsHistoryLimit: 3 jobTemplate: spec: backoffLimit: 2 activeDeadlineSeconds: 600 template: spec: restartPolicy: Never containers: - name: backup image: alpine command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;mysqldump ... || exit 1\u0026#34;] Jobï¼šæ‰§è¡Œä¸€æ¬¡æ•°æ®è¿ç§» apiVersion: batch/v1 kind: Job metadata: name: migrate spec: backoffLimit: 3 activeDeadlineSeconds: 300 ttlSecondsAfterFinished: 3600 template: spec: restartPolicy: Never containers: - name: migrate image: myapp:migrate ğŸ¯ æœ€ç»ˆæ€»ç»“ Job = ä¸€æ¬¡æ€§ä»»åŠ¡\nå¿…é¡»æˆåŠŸå®Œæˆ æ”¯æŒé‡è¯• æ”¯æŒå¹¶è¡Œ å¯ä»¥è‡ªåŠ¨æ¸…ç† CronJob = å®šæ—¶æ‰§è¡Œçš„ Job\nå’Œ Linux crontab ç±»ä¼¼ æ”¯æŒå¹¶å‘ç­–ç•¥ å¯æ§å†å²æ•°é‡ é€‚åˆå‘¨æœŸä»»åŠ¡ ","description":"Job ä¸ CronJob æ˜¯ Kubernetes ä¸­çš„ æ‰¹å¤„ç†ï¼ˆBatchï¼‰å·¥ä½œè´Ÿè½½ï¼Œç”¨äºæ‰§è¡Œä¸€æ¬¡æ€§æˆ–å‘¨æœŸæ€§ä»»åŠ¡ã€‚\nğŸŒŸ 1. Job ä¸ CronJob çš„å®šä½ Workload é€‚ç”¨åœºæ™¯ ç‰¹æ€§ Deployment æŒç»­è¿è¡ŒæœåŠ¡ æ¨ªå‘æ‰©å±•ã€æ»šåŠ¨å‡çº§ StatefulSet æœ‰çŠ¶æ€æœåŠ¡ å›ºå®šèº«ä»½ã€ç¨³å®šå­˜å‚¨ DaemonSet æ¯èŠ‚ç‚¹ Agent æ¯èŠ‚ç‚¹è¿è¡Œ Job æ‰§è¡Œä¸€æ¬¡ä¸”æˆåŠŸé€€å‡º ä¿è¯å®Œæˆ CronJob å‘¨æœŸæ€§æ‰§è¡Œ ç±»ä¼¼ Linux crontab æ€»ç»“ï¼š\nJob = ä¸€æ¬¡æ€§ä»»åŠ¡ã€‚ CronJob = æœ‰è®¡åˆ’çš„ Jobã€‚ ğŸŒŸ 2. Jobï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰è¯¦è§£ Job ç”¨äºæ‰§è¡Œå¿…é¡» æˆåŠŸä¸€æ¬¡ çš„ä»»åŠ¡ã€‚\n"},{"id":270,"href":"/operations/kubernetes/pod/","title":"Kubernetes Pod","parent":"Kubernetes","content":" ğŸ§© 1. Pod æ˜¯ä»€ä¹ˆï¼Ÿ Pod æ˜¯ Kubernetes ä¸­ æœ€å°çš„å¯è°ƒåº¦å•ä½ Unit of Deploymentã€‚\nPod çš„æ ¸å¿ƒç‰¹ç‚¹ï¼š\nå°è£…ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆIP/Port éƒ½å…±äº«ï¼‰ å…±äº« Volumeï¼ˆæ•°æ®å·ï¼‰ ä¸ Node ç»‘å®šï¼ˆä¸ä¼šè·¨èŠ‚ç‚¹æ¼‚ç§»ï¼‰ ç”±ä¸Šå±‚æ§åˆ¶å™¨ç®¡ç†ï¼ˆä¸å¯ç›´æ¥ä½œä¸ºé«˜å¯ç”¨æ¨¡å‹ï¼‰ Pod æœ¬è´¨æ˜¯ K8S ä¸ºå®¹å™¨æä¾›çš„â€œè¿è¡Œæ²™ç®±ï¼ˆsandboxï¼‰â€ã€‚\nğŸ§© 2. ä¸ºä»€ä¹ˆéœ€è¦ Podï¼Ÿ å®¹å™¨æœ¬èº«æ˜¯è½»é‡çº§è¿›ç¨‹ï¼Œä½†å®é™…ä¸šåŠ¡é€šå¸¸éœ€è¦ï¼š\nSidecarï¼ˆå¦‚æ—¥å¿—é‡‡é›†ã€ä»£ç† containerï¼‰ InitContainerï¼ˆåˆå§‹åŒ–ä»»åŠ¡ï¼‰ åŒæœºååŒè¿è¡Œå¤šä¸ªè¿›ç¨‹ Pod å°±æ˜¯ä¸ºäº†æ»¡è¶³è¿™äº›éœ€æ±‚è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒåº¦ Docker/Containerd å®¹å™¨ã€‚\nPod æ˜¯å®¹å™¨çš„é€»è¾‘å•å…ƒï¼Œå®¹å™¨æ˜¯ä¸å¯ç›´æ¥è°ƒåº¦çš„ã€‚\nğŸ§© 3. Pod ç”Ÿå‘½å‘¨æœŸï¼ˆé‡ç‚¹ï¼‰ Kubernetes Pod ç”Ÿå‘½å‘¨æœŸæœ‰æ¸…æ™°ä¸”å¯è§‚æµ‹çš„çŠ¶æ€ï¼š\né˜¶æ®µï¼ˆPhaseï¼‰ è¯´æ˜ Pending ç­‰è°ƒåº¦/æ‹‰é•œåƒ Running æ‰€æœ‰å®¹å™¨è¿è¡Œï¼ˆè‡³å°‘ä¸€ä¸ª runningï¼‰ Succeeded ä»»åŠ¡å®Œæˆï¼ˆJob åœºæ™¯ï¼‰ Failed è‡³å°‘ä¸€ä¸ªå®¹å™¨é€€å‡ºä¸”ä¸ä¼šè‡ªåŠ¨é‡å¯ Unknown èŠ‚ç‚¹ä¸å¯è¾¾ CrashLoopBackOff å®¹å™¨ä¸åœé‡å¯ï¼ˆæœ€å¸¸è§æ•…éšœï¼‰ ğŸ§© 4. Pod ç»„æˆç»“æ„ï¼ˆSpecï¼‰ Pod = metadata + spec + status\nPod Spec å…³é”®å­—æ®µï¼ˆå…¨é‡ç‰ˆï¼‰\n1. containers ä¸»å®¹å™¨åˆ—è¡¨ã€‚\n2. initContainers åˆå§‹åŒ–å®¹å™¨ï¼ŒæŒ‰é¡ºåºè¿è¡Œã€‚\n3. ephemeralContainersï¼ˆè°ƒè¯•æ—¶ç”¨ï¼‰ å¯ç”¨äºè¿è¡Œ kubectl debug æ³¨å…¥è°ƒè¯•å®¹å™¨ã€‚\n4. volumes æŒä¹…å· / ä¸´æ—¶å·å£°æ˜ã€‚\n5. nodeSelector / affinity / tolerations å½±å“è°ƒåº¦ä½ç½®ã€‚\n6. restartPolicy Always OnFailure Never Deployment = Always\nJob = OnFailure æˆ– Never\n7. terminationGracePeriodSeconds ä¼˜é›…é€€å‡ºçš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆé»˜è®¤ 30sï¼‰ã€‚\n8. dnsPolicy / hostNetwork / hostPID / hostIPC å†³å®šç½‘ç»œ/å‘½åç©ºé—´æ˜¯å¦ä¸ Host åˆ†äº«ã€‚\n9. securityContext è¿è¡Œç”¨æˆ·æƒé™ã€SELinuxã€AppArmorã€root é™åˆ¶ç­‰ã€‚\nğŸ§© 5. å®¹å™¨ç”Ÿå‘½å‘¨æœŸé’©å­ Pod ä¸­çš„æ¯ä¸ªå®¹å™¨æ”¯æŒ lifecycle hookï¼š\npostStartï¼ˆå®¹å™¨è¿è¡Œåç«‹å³è§¦å‘ï¼‰ preStopï¼ˆå®¹å™¨é€€å‡ºå‰è§¦å‘ï¼‰ å¸¸è§ç”¨é€”ï¼š\npreStop ç”¨äºä¼˜é›…é€€å‡ºï¼ˆnginx/drain/flushï¼‰ postStart ç”¨äºæ³¨å†Œã€åˆå§‹åŒ–åŠ¨ä½œ ğŸ§© 6. Pod çš„ç½‘ç»œæ¨¡å‹ï¼ˆCNIï¼‰ Pod çš„ç½‘ç»œæœ¬è´¨ï¼š\næ¯ä¸ª Podï¼š\næœ‰å”¯ä¸€ IPï¼ˆPod IPï¼‰ å®¹å™¨ä¹‹é—´é€šè¿‡ localhost é€šä¿¡ åŒ Node è·¨ Pod é€šä¿¡ï¼šveth pair + bridge è·¨èŠ‚ç‚¹é€šä¿¡ï¼šç”± CNIï¼ˆCalico, Cilium, Flannelï¼‰è´Ÿè´£ Pod çš„ IP ä»ä¸å…±äº«ï¼Œå³ä½¿ Deployment é‡å»ºä¹Ÿä¼šå˜åŒ–ã€‚\næƒ³è¦å›ºå®šè®¿é—®ï¼Œå¿…é¡»ç”¨ Serviceã€‚\nğŸ§© 7. Pod çš„ Volume æ¨¡å‹ Pod æ”¯æŒå¤šç§ Volumeï¼š\nVolume ç±»å‹ ç‰¹ç‚¹ åœºæ™¯ emptyDir Pod åˆ é™¤å°±æ¶ˆå¤± ç¼“å­˜/ä¸´æ—¶æ–‡ä»¶ hostPath æŒ‚è½½å®¿ä¸»æœºç›®å½• è°ƒè¯•/æ—¥å¿— configMap / secret é…ç½®æ³¨å…¥ é…ç½®æ–‡ä»¶/æ•æ„Ÿæ•°æ® PVC / CSI ç”±å­˜å‚¨æ’ä»¶ç®¡ç† æ•°æ®åº“/æŒä¹…åŒ–æ•°æ® downwardAPI æ³¨å…¥ Pod å…ƒæ•°æ® Pod IP/Labels Pod çº§åˆ« Volume = åœ¨ Pod å†…æ‰€æœ‰å®¹å™¨ä¹‹é—´å…±äº«ã€‚\nğŸ§© 8. Pod è°ƒåº¦ï¼ˆè°ƒåº¦å™¨å¦‚ä½•å†³å®š Pod å»å“ªä¸ªèŠ‚ç‚¹ï¼Ÿï¼‰ K8S è°ƒåº¦ç­–ç•¥ç”±ä»¥ä¸‹å› ç´ å†³å®šï¼š\nnodeSelector ç®€å•æ ‡ç­¾é€‰æ‹© nodeAffinity é«˜çº§æ ‡ç­¾é€‰æ‹© podAffinity / antiAffinity Pod äº²å’Œ/åäº²å’Œ taints / tolerations é©±é€/å®¹å¿ èµ„æº request/limit Pod Priority / Preemption ï¼ˆä¼˜å…ˆçº§æŠ¢å ï¼‰ ğŸ§© 9. Pod çš„ä¸‰å¤§ç±»åˆ«ï¼ˆå®é™…ä½¿ç”¨éå¸¸é‡è¦ï¼‰ 1. é™æ€ Podï¼ˆStatic Podï¼‰ ç”± kubelet ç®¡ç†ï¼Œä¸å— API Server æ§åˆ¶ã€‚\né€‚ç”¨äºï¼š\næ§åˆ¶é¢åŸåœ°å¯åŠ¨ å…³é”® Agentï¼ˆç¦»çº¿ç®¡ç†ï¼‰ 2. æ™®é€š Podï¼ˆç”±æ§åˆ¶å™¨åˆ›å»ºï¼‰ ç”± Deployment/DaemonSet/StatefulSet ç®¡ç†ã€‚\n3. ä¸´æ—¶è°ƒè¯• Pod kubectl run æˆ– kubectl debug åˆ›å»ºã€‚\nğŸ§© 10. Pod æ•…éšœæ’æŸ¥æ–¹æ³•ï¼ˆæœ€å¸¸ç”¨çš„ 7 æ¡ï¼‰ 1. çœ‹ events kubectl describe pod \u0026lt;pod\u0026gt; 2. çœ‹æ—¥å¿— kubectl logs \u0026lt;pod\u0026gt; [-c container] 3. æŸ¥çœ‹å®¹å™¨é‡å¯æ¬¡æ•° kubectl get pod -o wide 4. çœ‹å®¹å™¨çŠ¶æ€ï¼ˆwaiting/reasonï¼‰ kubectl describe pod 5. è¿›å…¥å®¹å™¨ kubectl exec -it \u0026lt;pod\u0026gt; -- sh 6. è°ƒè¯•å®¹å™¨ï¼ˆephemeralï¼‰ kubectl debug \u0026lt;pod\u0026gt; -it --image=busybox 7. æŸ¥çœ‹è°ƒåº¦å¤±è´¥åŸå›  kubectl describe pod | grep -i \u0026#34;failed\u0026#34; ğŸ§© 11. æœ€ä½³å®è·µï¼ˆæŒ‰ç”Ÿäº§çº§æ•´ç†ï¼‰ 1. æ°¸è¿œä¸è¦ç›´æ¥åˆ›å»º Podï¼ˆé™¤éè°ƒè¯•ï¼‰ ç”¨ Deployment / StatefulSet / DaemonSetã€‚\n2. è®¾ç½® cpu/memory request/limits é¿å…èµ„æºæŠ¢å å¯¼è‡´ OOMKilledã€‚\n3. å®šä¹‰å¥åº·æ£€æŸ¥ï¼ˆliveness/readiness/startupï¼‰ 4. å®¹å™¨å¿…é¡»æ— çŠ¶æ€ï¼ˆæœ‰çŠ¶æ€ç”¨ StatefulSet + PVCï¼‰ 5. ä½¿ç”¨ initContainer åšåˆå§‹åŒ–æ“ä½œ 6. Sidecar æ¨¡å¼æ‹†åˆ†åŠŸèƒ½ ä¾‹å¦‚ï¼š\næ—¥å¿— sidecar envoy/istio proxy æœ¬åœ° agent 7. é¿å… hostPathï¼ˆé™¤éå¿…é¡»ï¼‰ 8. é¿å… privileged æ¨¡å¼ ğŸ§© 12. Pod å®Œæ•´ç¤ºä¾‹ï¼ˆå« initContainerã€sidecarã€probeï¼‰ apiVersion: v1 kind: Pod metadata: name: example-pod spec: initContainers: - name: init-db image: busybox command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo init \u0026amp;\u0026amp; sleep 3\u0026#34;] containers: - name: app image: nginx ports: - containerPort: 80 livenessProbe: httpGet: { path: \u0026#34;/\u0026#34;, port: 80 } initialDelaySeconds: 5 readinessProbe: httpGet: { path: \u0026#34;/\u0026#34;, port: 80 } initialDelaySeconds: 3 - name: sidecar image: busybox command: [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;tail -f /var/log/app.log\u0026#34;] volumes: - name: logs emptyDir: {} ğŸ¯ æ€»ç»“ Pod æ˜¯ Kubernetes ä¸­æœ€å°çš„å¯è°ƒåº¦ã€å¯è¿è¡Œå•å…ƒï¼Œé€šè¿‡å…±äº«ç½‘ç»œå’Œ Volume å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªåä½œå®¹å™¨ï¼Œç”±æ§åˆ¶å™¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚\n","description":" ğŸ§© 1. Pod æ˜¯ä»€ä¹ˆï¼Ÿ Pod æ˜¯ Kubernetes ä¸­ æœ€å°çš„å¯è°ƒåº¦å•ä½ Unit of Deploymentã€‚\nPod çš„æ ¸å¿ƒç‰¹ç‚¹ï¼š\nå°è£…ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆIP/Port éƒ½å…±äº«ï¼‰ å…±äº« Volumeï¼ˆæ•°æ®å·ï¼‰ ä¸ Node ç»‘å®šï¼ˆä¸ä¼šè·¨èŠ‚ç‚¹æ¼‚ç§»ï¼‰ ç”±ä¸Šå±‚æ§åˆ¶å™¨ç®¡ç†ï¼ˆä¸å¯ç›´æ¥ä½œä¸ºé«˜å¯ç”¨æ¨¡å‹ï¼‰ Pod æœ¬è´¨æ˜¯ K8S ä¸ºå®¹å™¨æä¾›çš„â€œè¿è¡Œæ²™ç®±ï¼ˆsandboxï¼‰â€ã€‚\nğŸ§© 2. ä¸ºä»€ä¹ˆéœ€è¦ Podï¼Ÿ å®¹å™¨æœ¬èº«æ˜¯è½»é‡çº§è¿›ç¨‹ï¼Œä½†å®é™…ä¸šåŠ¡é€šå¸¸éœ€è¦ï¼š\n"},{"id":271,"href":"/operations/kubernetes/pod-scheduler/","title":"Kubernetes Pod è°ƒåº¦æµç¨‹å›¾ï¼ˆScheduler æ‰§è¡Œé¡ºåºï¼‰","parent":"Kubernetes","content":" ğŸ§© ä¸€å¼ å›¾çœ‹æ‡‚è°ƒåº¦æµç¨‹ï¼ˆASCII ç‰ˆï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” API Server æ¥æ”¶ Pod (Pod å¤„äº Pending çŠ¶æ€) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Scheduler Watch åˆ°æ–° Pod â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘  é¢„é€‰é˜¶æ®µ (Filter / Predicate) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â–¼ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ - èµ„æºä¸è¶³ï¼ˆCPU/Memï¼‰ æ•…éšœã€ä¸å¯è°ƒåº¦èŠ‚ç‚¹å‰”é™¤ - ä¸ç¬¦åˆ NodeSelector - Node notReady - ä¸ç¬¦åˆ NodeAffinity - Taint ä¸å¯å®¹å¿ - ç«¯å£å†²çª / è®¾å¤‡ä¸å¯ç”¨ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘¡ è¯„åˆ†é˜¶æ®µï¼ˆScoreï¼‰ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ å¯¹æ¯ä¸ªå¯è°ƒåº¦èŠ‚ç‚¹è¯„åˆ†ï¼š - Least Loadedï¼ˆè´Ÿè½½æœ€å°ï¼‰ - Selector Spreadï¼ˆåˆ†æ•£åº¦ï¼‰ - Affinity ä¼˜å…ˆçº§ - Node èµ„æºåˆ©ç”¨ç‡ç­‰ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘¢ é€‰å‡ºå¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘£ è°ƒåº¦ç»‘å®šï¼ˆBindï¼‰ Scheduler -\u0026gt; API Server {pod: nodeName} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Kubelet Watch åˆ° Pod -\u0026gt; æ‹‰é•œåƒã€åˆ›å»ºå®¹å™¨ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Pod è¿›å…¥ Running çŠ¶æ€ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ”µ Pod è°ƒåº¦ 4 å¤§é˜¶æ®µï¼ˆ1.33 ç‰ˆæœ¬ï¼‰ 1. é¢„é€‰é˜¶æ®µï¼ˆFilter stage / Predicateï¼‰ Scheduler ä¼šæŠŠä¸æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹æ’é™¤ï¼š\nNode æ— æ³•è°ƒåº¦ï¼ˆNotReady / Unschedulableï¼‰ NodeSelector ä¸åŒ¹é… NodeAffinity ä¸åŒ¹é… Taint ä¸å¯å®¹å¿ CPU/Memory request ä¸æ»¡è¶³ Volume ä¸æ»¡è¶³ï¼ˆlocal/pvc ä¸å¯ç”¨ï¼‰ PID/Device ä¸æ»¡è¶³ HostPort å†²çª PodAffinity / AntiAffinity ä¸æ»¡è¶³ RuntimeClass ä¸å…¼å®¹ é¢„é€‰é˜¶æ®µçš„ç»“æœï¼šå‰©ä¸‹å¯è°ƒåº¦èŠ‚ç‚¹åˆ—è¡¨\n2. è¯„åˆ†é˜¶æ®µï¼ˆScore stage / Priorityï¼‰ Scheduler ä¼šå¯¹æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹æ‰“åˆ†ï¼š\nå¸¸è§ scoring ç­–ç•¥ï¼š\nLeastAllocatedï¼šä¼˜å…ˆé€‰æ‹©åˆ©ç”¨ç‡ä½çš„èŠ‚ç‚¹ BalancedAllocationï¼šé€‰æ‹© CPU/Mem è¶Šå‡è¡¡çš„èŠ‚ç‚¹ SelectorSpreadï¼šä¼˜åŒ– Pod åˆ†æ•£åº¦ ImageLocalityï¼šé•œåƒæœ¬åœ°å·²ç¼“å­˜ -\u0026gt; åˆ†æ›´é«˜ NodeAffinityPriorityï¼šåå¥½èŠ‚ç‚¹æ‰“åˆ† æœ€ç»ˆå¾—åˆ°ï¼š\næ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ª 0~100 çš„ scoreã€‚\n3. é€‰æ‹©å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹ å¦‚å¾—åˆ†ç›¸åŒï¼š\nRound Robin éšæœºæ•° seed å›ºå®š å—è°ƒåº¦å™¨é…ç½®å½±å“ 4. è°ƒåº¦ç»‘å®šï¼ˆBindingï¼‰ Scheduler å°†ç»“æœå†™å› API Serverï¼š\nPod.Spec.NodeName = target-node è‡³æ­¤ï¼Œè°ƒåº¦æµç¨‹å®Œæˆã€‚\nPod çŠ¶æ€ -\u0026gt; å˜ä¸º â€œScheduledâ€ã€‚\nğŸ”µ Pod è°ƒåº¦å®Œæˆåï¼ˆç”± Kubelet æ¥ç®¡ï¼‰ è°ƒåº¦ç»“æŸåï¼ŒKubelet å¼€å§‹æ‰§è¡Œï¼š\nåˆ›å»º Pause å®¹å™¨ï¼ˆPod Sandboxï¼‰ åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼ˆCNIï¼‰ æ‹‰å–é•œåƒ ä¾åºå¯åŠ¨ initContainers å¯åŠ¨ containers æ‰§è¡Œ liveness/readiness/startup probes Pod -\u0026gt; Running ğŸ”µ è°ƒåº¦å¤±è´¥ä¼šæ€æ ·ï¼Ÿ Pod ä¼šä¿æŒ Pending\nEvent ä¸­ä¼šå‡ºç°å…·ä½“åŸå› ï¼š\nkubectl describe pod xxx | grep -A10 \u0026#34;Events\u0026#34; å¸¸è§é”™è¯¯ï¼š\ninsufficient cpu/memory node(s) didn\u0026rsquo;t match node selector pod didn\u0026rsquo;t tolerate node taint pod has unbound ImmediatePersistentVolumeClaims ğŸ”µ æ€»ç»“ Kubernetes è°ƒåº¦å™¨æ‰§è¡Œæµç¨‹ä¸ºï¼š\nWatch Pod -\u0026gt; Filter é¢„é€‰èŠ‚ç‚¹ -\u0026gt; Score æ‰“åˆ† -\u0026gt; é€‰æœ€é«˜åˆ†èŠ‚ç‚¹ -\u0026gt; Bind -\u0026gt; Kubelet æ‰§è¡Œã€‚\næ¯ä¸€æ­¥éƒ½ç”±å¯æ’æ‹”è°ƒåº¦æ’ä»¶å®ç°ã€‚\n","description":" ğŸ§© ä¸€å¼ å›¾çœ‹æ‡‚è°ƒåº¦æµç¨‹ï¼ˆASCII ç‰ˆï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” API Server æ¥æ”¶ Pod (Pod å¤„äº Pending çŠ¶æ€) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ Scheduler Watch åˆ°æ–° Pod â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘  é¢„é€‰é˜¶æ®µ (Filter / Predicate) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â–¼ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ - èµ„æºä¸è¶³ï¼ˆCPU/Memï¼‰ æ•…éšœã€ä¸å¯è°ƒåº¦èŠ‚ç‚¹å‰”é™¤ - ä¸ç¬¦åˆ NodeSelector - Node notReady - ä¸ç¬¦åˆ NodeAffinity - Taint ä¸å¯å®¹å¿ - ç«¯å£å†²çª / è®¾å¤‡ä¸å¯ç”¨ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘¡ è¯„åˆ†é˜¶æ®µï¼ˆScoreï¼‰ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ å¯¹æ¯ä¸ªå¯è°ƒåº¦èŠ‚ç‚¹è¯„åˆ†ï¼š - Least Loadedï¼ˆè´Ÿè½½æœ€å°ï¼‰ - Selector Spreadï¼ˆåˆ†æ•£åº¦ï¼‰ - Affinity ä¼˜å…ˆçº§ - Node èµ„æºåˆ©ç”¨ç‡ç­‰ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘¢ é€‰å‡ºå¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â‘£ è°ƒåº¦ç»‘å®šï¼ˆBindï¼‰ Scheduler -\u0026gt; API Server {pod: nodeName} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Kubelet Watch åˆ° Pod -\u0026gt; æ‹‰é•œåƒã€åˆ›å»ºå®¹å™¨ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Pod è¿›å…¥ Running çŠ¶æ€ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ”µ Pod è°ƒåº¦ 4 å¤§é˜¶æ®µï¼ˆ1.33 ç‰ˆæœ¬ï¼‰ 1. é¢„é€‰é˜¶æ®µï¼ˆFilter stage / Predicateï¼‰ Scheduler ä¼šæŠŠä¸æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹æ’é™¤ï¼š\n"},{"id":272,"href":"/operations/kubernetes/scheduler/","title":"Kubernetes Scheduler","parent":"Kubernetes","content":"Kubernetes Scheduler è´Ÿè´£å°† Pending çŠ¶æ€çš„ Pod åˆ†é…åˆ°åˆé€‚çš„ Node ä¸Šï¼Œæ˜¯ä» è°ƒåº¦ç­–ç•¥ -\u0026gt; ç®—æ³•å®ç° -\u0026gt; å†³ç­–è¾“å‡º çš„æ ¸å¿ƒç»„ä»¶ã€‚\nç›®å½• â˜˜ï¸ è°ƒåº¦å™¨çš„ç›®æ ‡ ğŸ”§ è°ƒåº¦å™¨çš„æ¶æ„ ğŸ”„ è°ƒåº¦å™¨å·¥ä½œæµç¨‹ï¼ˆFilter -\u0026gt; Score -\u0026gt; Bindï¼‰ ğŸ”Œ è°ƒåº¦æ’ä»¶ï¼ˆKubernetes 1.33 å®Œæ•´æ’ä»¶ä½“ç³»ï¼‰ ğŸ§© è°ƒåº¦å™¨çš„ç®—æ³•é€»è¾‘ ğŸ§² Affinity / AntiAffinity / Taint / Toleration âš¡ ä¼˜é›…æŠ¢å ï¼ˆPreemptionï¼‰ ğŸª è°ƒåº¦æ‰©å±•ï¼šè‡ªå®šä¹‰è°ƒåº¦å™¨ / å¤šè°ƒåº¦å™¨ ğŸ“ˆ è°ƒåº¦æ€§èƒ½ä¼˜åŒ– ğŸ§ª è°ƒåº¦é—®é¢˜æ’æŸ¥æŒ‡å— 1. è°ƒåº¦å™¨ç›®æ ‡ï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ Kubernetes Scheduler çš„ç›®æ ‡ï¼š\nåœ¨æ»¡è¶³çº¦æŸæ¡ä»¶çš„å‰æä¸‹ï¼Œé€‰æ‹©æœ€åˆé€‚çš„èŠ‚ç‚¹ã€‚\nçº¦æŸæ¡ä»¶åŒ…æ‹¬ï¼š\nç±»å‹ ç¤ºä¾‹ ç¡¬çº¦æŸï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ CPU/Mem è¶³å¤Ÿã€NodeSelectorã€Taintsã€Volumeã€PodAffinity è½¯çº¦æŸï¼ˆå°½é‡æ»¡è¶³ï¼‰ Spread åˆ†æ•£ã€è´Ÿè½½æœ€å°ã€é•œåƒæœ¬åœ°å­˜åœ¨ç­‰ 2. Scheduler æ¶æ„ï¼ˆv1.33 æ ‡å‡†æµç¨‹ï¼‰ ASCII å›¾å¸®åŠ©ç†è§£ï¼š\nPod(Pending) â”‚ â–¼ [Informers] ---\u0026gt; Scheduler Queue --\u0026gt; Scheduling Cycle â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Filter (é¢„é€‰é˜¶æ®µ) â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Score (è¯„åˆ†é˜¶æ®µ) â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ PreFilter / PreScore / Permit â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Bind (ç»‘å®šé˜¶æ®µ) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ è°ƒåº¦å‘¨æœŸ (Scheduling Cycle)ï¼šä»è¿‡æ»¤ -\u0026gt; è¯„åˆ† -\u0026gt; ç»‘å®š ç»‘å®šå‘¨æœŸ (Binding Cycle)ï¼šç‹¬ç«‹å¼‚æ­¥å¤„ç†ç»‘å®šã€‚ 3. è°ƒåº¦å·¥ä½œæµç¨‹è¯¦è§£ ğŸ“Œ 3.1 è¿›å…¥é˜Ÿåˆ—ï¼ˆScheduling Queueï¼‰ Pod åˆ›å»ºåè¿›å…¥ Pending -\u0026gt; è¢«è°ƒåº¦å™¨ watch åˆ° -\u0026gt; åŠ å…¥é˜Ÿåˆ—ã€‚\né˜Ÿåˆ—å¸¦ä¼˜å…ˆçº§ï¼Œå¯ä½¿ç”¨ PriorityClass å½±å“è°ƒåº¦å…ˆåé¡ºåºã€‚\nğŸ“Œ 3.2 Filterï¼ˆé¢„é€‰é˜¶æ®µï¼‰ é€ä¸ªèŠ‚ç‚¹æ£€æŸ¥æ˜¯å¦èƒ½è°ƒåº¦ï¼š\nè¿‡æ»¤åŸå› ï¼š\nCPU/Mem request ä¸æ»¡è¶³ Node æœªå‡†å¤‡å¥½ NotReady Taint ä¸å¯å®¹å¿ NodeSelector / NodeAffinity ä¸åŒ¹é… PodAffinity / AntiAffinity ä¸æ»¡è¶³ HostPort å†²çª CSI PV ä¸å¯æŒ‚è½½ runtime class ä¸åŒ¹é… hugepages / GPU ä¸æ»¡è¶³ Filter é˜¶æ®µäº§ç‰©ï¼š\nâœ… å¯è°ƒåº¦èŠ‚ç‚¹åˆ—è¡¨ âŒ å¦‚æœåˆ—è¡¨ä¸ºç©º -\u0026gt; è°ƒåº¦å¤±è´¥ï¼ˆè§¦å‘æŠ¢å æˆ–å»¶æ—¶é‡è¯•ï¼‰ ğŸ“Œ 3.3 Scoreï¼ˆè¯„åˆ†é˜¶æ®µï¼‰ å¯¹æ¯ä¸ªå¯è°ƒåº¦èŠ‚ç‚¹è¯„åˆ†ï¼ˆ0~100ï¼‰ã€‚å¸¸è§ scoringï¼š\nâ­ LeastAllocated\né€‰æ‹©å‰©ä½™èµ„æºæœ€å¤šçš„èŠ‚ç‚¹ -\u0026gt; è¶Šç©ºèŠ‚ç‚¹ä¼˜å…ˆã€‚\nâ­ BalancedAllocation\né€‰æ‹© CPU/Mem ä½¿ç”¨æ¯”ä¾‹æ¥è¿‘çš„èŠ‚ç‚¹ -\u0026gt; é¿å…åªå‹æ»¡ CPU æˆ–å†…å­˜ã€‚\nâ­ SelectorSpread\nPod å°½é‡åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ -\u0026gt; æé«˜å¯é æ€§ã€‚\nâ­ ImageLocality\nèŠ‚ç‚¹ä¸Šå·²å­˜åœ¨é•œåƒ -\u0026gt; åˆ†é«˜ -\u0026gt; å‡å°‘æ‹‰å–æ—¶é—´ã€‚\næœ€ç»ˆåˆ†æ•° = æ‰€æœ‰ scoring æ’ä»¶çš„åŠ æƒç´¯åŠ ã€‚\nğŸ“Œ 3.4 æœ€ç»ˆèŠ‚ç‚¹é€‰æ‹© å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹è·å¾—è°ƒåº¦æƒã€‚\nå¦‚å¤šèŠ‚ç‚¹å¾—åˆ†ç›¸åŒ -\u0026gt; RoundRobin / éšæœºé€‰æ‹©ã€‚\nğŸ“Œ 3.5 Bindï¼ˆç»‘å®šé˜¶æ®µï¼‰ Scheduler å°†ç»“æœå†™å…¥ Podï¼š\nPod.Spec.NodeName = \u0026lt;node\u0026gt; Kubelet Watch åˆ°åå¼€å§‹çœŸæ­£åˆ›å»ºå®¹å™¨ã€‚\n4. Kubernetes 1.33 å…¨è°ƒåº¦æ’ä»¶ä½“ç³»ï¼ˆæœ€å…¨æœ€æ–°ï¼‰ è°ƒåº¦å™¨é€šè¿‡æ’ä»¶ç»„æˆï¼Œä¸»è¦åˆ†ï¼š\né˜¶æ®µ åŠŸèƒ½ æ’ä»¶ PreFilter å‡†å¤‡è°ƒåº¦æ‰€éœ€æ•°æ® NodePortsã€PodAffinity Filter ç¡¬çº¦æŸè¿‡æ»¤ NodeResourcesFitã€TaintTolerationã€VolumeRestrictions PostFilter å›è°ƒ / æŠ¢å  DefaultPreemption PreScore è¯„åˆ†å‰å¤„ç† PodTopologySpread Score èŠ‚ç‚¹è¯„åˆ† LeastAllocatedã€BalancedAllocationã€ImageLocality Reserve ä¸´æ—¶å ç”¨èµ„æº VolumeBinding Permit å¯é˜»å¡è°ƒåº¦ QueueSort PreBind ç»‘å®šå‰åŠ¨ä½œ VolumeBinding Bind æœ€ç»ˆç»‘å®š DefaultBinder PostBind ç»“æŸæ—¥å¿— - 5. è°ƒåº¦ç®—æ³•æ ¸å¿ƒé€»è¾‘ ğŸ“ Filter = å¯è¡Œæ€§ ï¼ˆè¿‡æ»¤æ‰ä¸å¯èƒ½è¿è¡Œçš„èŠ‚ç‚¹ï¼‰\nğŸ“ Score = ä¼˜åŒ–æ€§ ï¼ˆåœ¨å¯è¡ŒèŠ‚ç‚¹ä¸­æ‰¾æœ€ä¼˜èŠ‚ç‚¹ï¼‰\nğŸ“ Bind = æœ€ç»ˆå†³ç­–å†™å› Kubernetes è°ƒåº¦å™¨ = ç¡¬çº¦æŸè¿‡æ»¤ + è½¯çº¦æŸè¯„åˆ† + å†³ç­–ç»‘å®š\n6. Affinity / AntiAffinity / Taint / Toleration è°ƒåº¦æœ€å¸¸ç”¨çš„æœºåˆ¶ï¼š\nNodeSelectorï¼ˆæœ€ç®€å•ç¡¬çº¦æŸï¼‰ nodeSelector: disktype: ssd NodeAffinityï¼ˆæ›´å¼ºï¼‰ æ”¯æŒ Inã€NotInã€Gt/Ltã€è½¯çº¦æŸ preferredã€‚\nPodAffinity / AntiAffinity Pod ä¹‹é—´äº²å’Œ/åäº²å’Œï¼š\nä¾‹å¦‚ï¼šå¼ºåˆ¶ä¸åŒèŠ‚ç‚¹ï¼š\npodAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - topologyKey: kubernetes.io/hostname Taint / Tolerationï¼ˆæ±¡ç‚¹ä¸å®¹å¿ï¼‰\nNode æœ‰ Taint -\u0026gt; Pod éœ€è¦å¯¹åº” toleration æ‰èƒ½è°ƒåº¦è¿›å»ã€‚\n7. ä¼˜é›…æŠ¢å ï¼ˆPreemptionï¼‰ å½“é«˜ä¼˜å…ˆçº§ Pod è°ƒåº¦å¤±è´¥æ—¶ï¼š\næŸ¥æ‰¾å¯ä»¥é©±é€çš„ä½ä¼˜å…ˆçº§ Pod è®¡ç®—â€œä»£ä»·æœ€å°â€çš„èŠ‚ç‚¹ Evict æœ€å°‘æ•°é‡çš„ Pod è¢«æŠ¢å  Pod è¿›å…¥ Terminatingï¼Œå®Œæˆåé«˜ä¼˜å…ˆçº§ Pod é‡è¯•è°ƒåº¦ã€‚\n8. è°ƒåº¦æ‰©å±• â›“ï¸ è‡ªå®šä¹‰è°ƒåº¦å™¨ ç»™ Pod æŒ‡å®šï¼š\nschedulerName: custom-scheduler å³å¯è®©å…¶ä½¿ç”¨éé»˜è®¤è°ƒåº¦å™¨ã€‚\nğŸ§± è°ƒåº¦å™¨æ‰©å±•æ–¹å¼ åŸºäºè°ƒåº¦æ’ä»¶ï¼ˆæœ€æ¨èï¼‰ å¤šè°ƒåº¦å™¨ è°ƒåº¦å™¨ extenderï¼ˆæ—§æœºåˆ¶ï¼‰ è‡ªå®šä¹‰è°ƒåº¦ç¨‹åº 9. è°ƒåº¦æ€§èƒ½ä¼˜åŒ– å¤§å‹é›†ç¾¤ï¼ˆ2000+ Nodeï¼‰éœ€å…³æ³¨æ€§èƒ½ï¼š\nä½¿ç”¨ Coscheduling / Batch è°ƒåº¦ï¼ˆAI é«˜é¢‘åœºæ™¯ï¼‰ ä½¿ç”¨ PreFilterã€Cache ä¼˜åŒ– å…³é—­ä¸å¿…è¦çš„è°ƒåº¦æ’ä»¶ è°ƒå¤§ Kube-Scheduler QPS / Burst ä½¿ç”¨è°ƒåº¦å™¨ profile 10. è°ƒåº¦é—®é¢˜æ’æŸ¥ï¼ˆå®é™…å¾ˆå¸¸ç”¨ï¼‰ æŸ¥çœ‹ Pod ä¸ºä½•è°ƒåº¦å¤±è´¥ kubectl describe pod \u0026lt;pod\u0026gt; å¸¸è§å¼‚å¸¸ï¼š\n0/3 nodes are available: 3 Insufficient cpu node(s) had untolerated taint pod didn\u0026rsquo;t match pod affinity æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿— journalctl -u kube-scheduler -f è°ƒåº¦æ¨¡æ‹Ÿï¼ˆéå¸¸å¼ºå¤§ï¼‰ kubectl alpha schedule pod \u0026lt;pod.yaml\u0026gt; ğŸ‰ æ€»ç»“ Kubernetes Scheduler = Watch -\u0026gt; Filterï¼ˆç¡¬çº¦æŸï¼‰ -\u0026gt; Scoreï¼ˆè½¯çº¦æŸï¼‰ -\u0026gt; Bindï¼ˆå†³ç­–ï¼‰\né€šè¿‡è°ƒåº¦æ’ä»¶å®ç°å¯æ’æ‹”ç­–ç•¥ï¼Œå¹¶æ”¯æŒå¤šè°ƒåº¦å™¨ã€æŠ¢å ã€ä¼˜å…ˆçº§ã€Pod/Node Affinityã€Taintsã€‚\n","description":"Kubernetes Scheduler è´Ÿè´£å°† Pending çŠ¶æ€çš„ Pod åˆ†é…åˆ°åˆé€‚çš„ Node ä¸Šï¼Œæ˜¯ä» è°ƒåº¦ç­–ç•¥ -\u0026gt; ç®—æ³•å®ç° -\u0026gt; å†³ç­–è¾“å‡º çš„æ ¸å¿ƒç»„ä»¶ã€‚\nç›®å½• â˜˜ï¸ è°ƒåº¦å™¨çš„ç›®æ ‡ ğŸ”§ è°ƒåº¦å™¨çš„æ¶æ„ ğŸ”„ è°ƒåº¦å™¨å·¥ä½œæµç¨‹ï¼ˆFilter -\u0026gt; Score -\u0026gt; Bindï¼‰ ğŸ”Œ è°ƒåº¦æ’ä»¶ï¼ˆKubernetes 1.33 å®Œæ•´æ’ä»¶ä½“ç³»ï¼‰ ğŸ§© è°ƒåº¦å™¨çš„ç®—æ³•é€»è¾‘ ğŸ§² Affinity / AntiAffinity / Taint / Toleration âš¡ ä¼˜é›…æŠ¢å ï¼ˆPreemptionï¼‰ ğŸª è°ƒåº¦æ‰©å±•ï¼šè‡ªå®šä¹‰è°ƒåº¦å™¨ / å¤šè°ƒåº¦å™¨ ğŸ“ˆ è°ƒåº¦æ€§èƒ½ä¼˜åŒ– ğŸ§ª è°ƒåº¦é—®é¢˜æ’æŸ¥æŒ‡å— 1. è°ƒåº¦å™¨ç›®æ ‡ï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ Kubernetes Scheduler çš„ç›®æ ‡ï¼š\n"},{"id":273,"href":"/operations/kubernetes/service/","title":"Kubernetes Service","parent":"Kubernetes","content":"Service æ˜¯ Kubernetes ä¸­ç¨³å®šè®¿é—®åç«¯ Pod çš„æŠ½è±¡ï¼Œé€šè¿‡ æ ‡ç­¾é€‰æ‹©å™¨ + é›†ç¾¤ç½‘ç»œ ä¸º Pod æä¾›ï¼š\nå›ºå®šè™šæ‹Ÿ IPï¼ˆClusterIPï¼‰ è´Ÿè½½å‡è¡¡ï¼ˆkube-proxy / eBPFï¼‰ ç¨³å®š DNS åç§° è·¨èŠ‚ç‚¹é€æ˜è®¿é—®èƒ½åŠ›ï¼ˆæ—  NAT æˆ–å¸¦ NATï¼Œè§† CNI å’Œ kube-proxy æ¨¡å¼å†³å®šï¼‰ 1. Service ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Ÿ Pod ä¼šä¸æ–­å˜åŒ–ï¼š\nPod åˆ é™¤é‡å»º Pod é‡å¯ Pod IP ä¼šå˜åŒ– Service è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š\né—®é¢˜ Service æä¾›çš„è§£å†³æ–¹æ¡ˆ å¦‚ä½•ç¨³å®šè®¿é—® Podï¼Ÿ åˆ›å»º å›ºå®š IPï¼šClusterIP å¤šä¸ª Pod æ€ä¹ˆè´Ÿè½½å‡è¡¡ï¼Ÿ kube-proxy / CNI eBPF 2. Service ç”±ä»€ä¹ˆç»„æˆï¼Ÿ æ ¸å¿ƒç»„ä»¶\nSelectorï¼šé€‰æ‹© Pod Endpoints / EndpointSliceï¼šå­˜å‚¨è¢«é€‰ä¸­çš„ Pod åˆ—è¡¨ ClusterIP/NodePort/LoadBalancer ç±»å‹ kube-proxy / CNIï¼ˆä¾‹å¦‚ Calico eBPFï¼‰ï¼šè´Ÿè´£æµé‡è½¬å‘ æµç¨‹å›¾\nService -\u0026gt; Selector -\u0026gt; Label åŒ¹é… -\u0026gt; EndpointSlice -\u0026gt; kube-proxy/eBPF -\u0026gt; Pod\n3. Service çš„ç±»å‹ï¼ˆæœ€é‡è¦éƒ¨åˆ†ï¼‰ ğŸŸ© 3.1 ClusterIPï¼ˆé»˜è®¤ï¼‰ ä»…é›†ç¾¤å†…éƒ¨å¯è®¿é—®ã€‚\nç‰¹ç‚¹ï¼š\nåˆ›å»ºä¸€ä¸ª è™šæ‹Ÿ IPï¼ˆVIPï¼‰ kube-proxyï¼ˆæˆ– eBPFï¼‰ç›‘å¬æµé‡å¹¶å°†è¯·æ±‚è½¬å‘åˆ°åç«¯ Pod æœ€ä½³ç”¨é€”ï¼š\nå¾®æœåŠ¡å†…éƒ¨è°ƒç”¨ APIã€å†…éƒ¨æ¥å£ ğŸ”¶ 3.2 NodePort åœ¨æ¯ä¸ª Node ä¸Šå¼€æ”¾ç»Ÿä¸€ç«¯å£ï¼ˆ30000â€“32767ï¼‰ã€‚\nè®¿é—®æ–¹å¼ï¼š\nhttp://\u0026lt;NodeIP\u0026gt;:\u0026lt;NodePort\u0026gt; å¸¸ç”¨äºï¼š\næš´éœ²æœåŠ¡ç»™äº‘ LB ä¹‹å‰ è°ƒè¯•è®¿é—®æœåŠ¡ å†…éƒ¨é›†ç¾¤å¤–è®¿é—® âš ï¸ æ³¨æ„ï¼š\nNodePort ä¼šå ç”¨èŠ‚ç‚¹ç«¯å£ ä¸èƒ½åŒæ—¶æŒ‡å®šå¤šä¸ª NodePort ğŸŸ¦ 3.3 LoadBalancerï¼ˆäº‘åŸç”Ÿç¯å¢ƒï¼‰ äº‘æä¾›å•†å±‚é¢çš„ L4 è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ ALBã€ELBã€SLBï¼‰ã€‚\næµç¨‹ï¼š\nç”¨æˆ· -\u0026gt; äº‘ LB -\u0026gt; NodePort -\u0026gt; kube-proxy -\u0026gt; Pod é€‚ç”¨äºï¼š\nå¯¹å¤–æä¾›æœåŠ¡ ç”Ÿäº§çº§è®¿é—®å…¥å£ ğŸŸ§ 3.4 ExternalName å°† Service æ˜ å°„åˆ°å¤–éƒ¨ DNSï¼š\nç¤ºä¾‹ï¼š\nexternalName: mysql.example.com ç”¨é€”ï¼š\nä½¿ç”¨ Kubernetes DNS è®¿é—®å¤–éƒ¨æ•°æ®åº“ã€æœåŠ¡ âš ï¸ æ— è´Ÿè½½å‡è¡¡ï¼Œä¸æ˜¯ç½‘ç»œä»£ç†ï¼Œåªæ˜¯ DNS CNAMEã€‚\nğŸŸ¥ 3.5 Headless Serviceï¼ˆæ—  ClusterIPï¼‰ clusterIP: None ç‰¹ç‚¹ï¼š\nä¸åˆ†é… VIP ç›´æ¥å°† Pod IP è¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ DNS SRV / A è®°å½•ï¼‰ æ—  kube-proxy å‚ä¸ ç”¨é€”ï¼š\nStatefulSetï¼ˆMySQL ä¸»ä»ã€Kafkaã€ZooKeeperï¼‰ åº”ç”¨è‡ªå·±å®ç°è´Ÿè½½å‡è¡¡æˆ–å‘ç°æœºåˆ¶ 4. Service æµé‡è·¯å¾„ï¼ˆæµé‡å¦‚ä½•è¢«è½¬å‘ï¼Ÿï¼‰ æ ¹æ® proxy å®ç°ä¸åŒæœ‰ä¸‰ç±»ï¼š\nâ­ 1. kube-proxy: iptables (é»˜è®¤æ—§æ¨¡å¼) æµé‡æµç¨‹ï¼š\nclient -\u0026gt; ClusterIP -\u0026gt; iptables -\u0026gt; Pod ç‰¹æ€§ï¼š\nDNAT è§„åˆ™æ•°é‡å¤šä¼šå˜æ…¢ ç¨³å®šä½†æ€§èƒ½ä¸€èˆ¬ â­â­ 2. kube-proxy: IPVSï¼ˆæ¨èï¼‰ client -\u0026gt; ClusterIP -\u0026gt; IPVS(LVS å†…æ ¸æ¨¡å—) -\u0026gt; Pod ä¼˜ç‚¹ï¼š\né«˜æ€§èƒ½ï¼ˆç™¾ä¸‡çº§è¿æ¥ï¼‰ æ”¯æŒé«˜çº§è°ƒåº¦ç®—æ³• rrï¼ˆè½®è¯¢ï¼‰ wrrï¼ˆåŠ æƒè½®è¯¢ï¼‰ lcï¼ˆæœ€å°‘è¿æ¥ï¼‰ shï¼ˆæºåœ°å€å“ˆå¸Œï¼‰ é€‚ç”¨ï¼š\né«˜å¹¶å‘ä¸šåŠ¡ â­â­â­ 3. eBPF (Calico eBPF / Cilium BPF) å®Œå…¨ç»•è¿‡ kube-proxyï¼\næµé‡ï¼š\nclient -\u0026gt; eBPF -\u0026gt; Pod ï¼ˆæ—  NATï¼‰ ä¼˜ç‚¹ï¼š\næ›´ä½å»¶è¿Ÿï¼ˆæ— å†…æ ¸é“¾è·¯è·³è½¬ï¼‰ æ›´é«˜åå æ›´å¤šå¯è§‚æµ‹æ€§ æ›´æ™ºèƒ½çš„è´Ÿè½½å‡è¡¡ é€‚ç”¨äºï¼š\né«˜ QPS äº‘åŸç”Ÿé«˜æ€§èƒ½åœºæ™¯ 5. Service ä¸ Endpoints / EndpointSlice Endpointsï¼ˆæ—§ï¼‰ ä¸é€‚åˆå¤§è§„æ¨¡ï¼Œ100+Pod æ—¶æ€§èƒ½ä¸‹é™ã€‚\nEndpointSliceï¼ˆæ–°ï¼Œ\u0026gt;= 1.21 é»˜è®¤ï¼‰ ä¼˜åŠ¿ï¼š\nå¯æ‰©å±•ï¼ˆæ¯ä¸ª slice 100 ä¸ª Podï¼‰ æ›´å¿«çš„æ›´æ–°é€Ÿåº¦ å‡å°‘æ§åˆ¶é¢å‹åŠ› è°ƒè¯•å‘½ä»¤ï¼š\nkubectl get endpoints kubectl get endpointslices 6. Service DNS è§£æè§„åˆ™ åœ¨ pod å†…è§£æï¼š\n\u0026lt;service\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local ç¤ºä¾‹ï¼š\nnginx.default.svc.cluster.local çŸ­åè®¿é—®è§„åˆ™ï¼ˆå¸¦æœç´¢åŸŸï¼‰ï¼š\nnginx nginx.default æŸ¥çœ‹ DNSï¼š\nkubectl exec -it pod -- cat /etc/resolv.conf 7. Service è´Ÿè½½å‡è¡¡ç­–ç•¥ kube-proxy + iptables conntrack è½®è¯¢ å•ä¸ªæµé‡ä¿æŒ Session Stickiness kube-proxy + ipvs æ”¯æŒå¤šç§é«˜çº§ç®—æ³•ï¼š\nrr wrr lc shï¼ˆæºåœ°å€ä¸€è‡´æ€§ï¼‰ eBPFï¼ˆCalico/Ciliumï¼‰ æœ€ä½³æ€§èƒ½ å¯é€‰æ‹© L4 + è‡ªå®šä¹‰è°ƒåº¦ æ—  NAT æ¨¡å¼ 8ï¸âƒ£ Service å¸¸è§é—®é¢˜ \u0026amp; æ’æŸ¥ â—1. ClusterIP æ— æ³•è®¿é—® åŸå› å¯èƒ½æ˜¯ï¼š\nkube-proxy å¼‚å¸¸ iptables/ipvs ç¼ºå¤± Overlay ç½‘ç»œæ–­å¼€ EndpointSlice ä¸ºç©º æ’æŸ¥ï¼š\nkubectl get endpoints -A kubectl get endpointslices -A kubectl get pods -o wide systemctl status kube-proxy â—2. NodePort æ— æ³•è®¿é—® æ’æŸ¥ï¼š\niptables -L -n | grep NodePort æ£€æŸ¥ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰æ˜¯å¦é˜»æ–­ã€‚\nâ—3. LoadBalancer Pending åŸå› ï¼š\næ²¡ç”¨äº‘ç¯å¢ƒ æœªå®‰è£… MetalLB â—4. Service è®¿é—®æ…¢ã€ä¸¢åŒ… å¯èƒ½æ˜¯ï¼š\nconntrack æ»¡äº† kube-proxy è§„åˆ™è¿‡å¤š NAT é“¾è·¯è¿‡é•¿ è§£å†³ï¼š\nsysctl -w net.netfilter.nf_conntrack_max=2621440 9. Service YAML ç¤ºä¾‹ï¼ˆå®Œæ•´ï¼‰ ClusterIP apiVersion: v1 kind: Service metadata: name: backend spec: selector: app: backend ports: - port: 80 targetPort: 8080 NodePort spec: type: NodePort ports: - port: 80 nodePort: 30080 LoadBalancer spec: type: LoadBalancer Headless Service spec: clusterIP: None 10. Kubernetes Service æœ€ä½³å®è·µï¼ˆ1.33ï¼‰ æ¨èä½¿ç”¨ eBPF æ¨¡å¼ï¼ˆCalico eBPF / Ciliumï¼‰ æ€§èƒ½æ›´é«˜ï¼Œå»¶è¿Ÿæ›´ä½ã€‚\nå¤§è§„æ¨¡é›†ç¾¤ä½¿ç”¨ EndpointSlice Pod \u0026gt; 1000 æ—¶æ”¹å–„æ˜¾è‘—ã€‚\nNodePort å°½é‡é¿å…æš´éœ²å…¬ç½‘ å»ºè®®é…åˆ Ingress / LBã€‚\nå¯¹å¤–æœåŠ¡ï¼šLoadBalancer + Ingress å¼ºçƒˆæ¨è Nginx / Traefik / HAProxyã€‚\nå†…éƒ¨å¾®æœåŠ¡ç»Ÿä¸€ä½¿ç”¨ ClusterIP è°ƒå¤§ conntrack ç”Ÿäº§è°ƒä¼˜ï¼š\nnet.netfilter.nf_conntrack_max = 2621440 kube-proxy ä½¿ç”¨ IPVS æ€§èƒ½æ¯” iptables é«˜å¾ˆå¤šï¼š\nmode: ipvs ","description":"Service æ˜¯ Kubernetes ä¸­ç¨³å®šè®¿é—®åç«¯ Pod çš„æŠ½è±¡ï¼Œé€šè¿‡ æ ‡ç­¾é€‰æ‹©å™¨ + é›†ç¾¤ç½‘ç»œ ä¸º Pod æä¾›ï¼š\nå›ºå®šè™šæ‹Ÿ IPï¼ˆClusterIPï¼‰ è´Ÿè½½å‡è¡¡ï¼ˆkube-proxy / eBPFï¼‰ ç¨³å®š DNS åç§° è·¨èŠ‚ç‚¹é€æ˜è®¿é—®èƒ½åŠ›ï¼ˆæ—  NAT æˆ–å¸¦ NATï¼Œè§† CNI å’Œ kube-proxy æ¨¡å¼å†³å®šï¼‰ 1. Service ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Ÿ Pod ä¼šä¸æ–­å˜åŒ–ï¼š\nPod åˆ é™¤é‡å»º Pod é‡å¯ Pod IP ä¼šå˜åŒ– Service è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š\né—®é¢˜ Service æä¾›çš„è§£å†³æ–¹æ¡ˆ å¦‚ä½•ç¨³å®šè®¿é—® Podï¼Ÿ åˆ›å»º å›ºå®š IPï¼šClusterIP å¤šä¸ª Pod æ€ä¹ˆè´Ÿè½½å‡è¡¡ï¼Ÿ kube-proxy / CNI eBPF 2. Service ç”±ä»€ä¹ˆç»„æˆï¼Ÿ æ ¸å¿ƒç»„ä»¶\n"},{"id":274,"href":"/operations/kubernetes/statefulset/","title":"Kubernetes StatefulSet","parent":"Kubernetes","content":"StatefulSet æ˜¯ Kubernetes ä¸­ç”¨äº æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStateful Applicationï¼‰ çš„ Workload ç±»å‹ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š\nPod çš„èº«ä»½ä¿æŒï¼ˆIdentityï¼‰ + ç¨³å®šä¸€è‡´çš„å­˜å‚¨ï¼ˆStable Storageï¼‰ + é¡ºåºåŒ–éƒ¨ç½²ã€æ›´æ–°ã€åˆ é™¤ï¼ˆOrdered Operationï¼‰\nå…¸å‹ä¸šåŠ¡åœºæ™¯åŒ…æ‹¬ï¼š\næ•°æ®åº“é›†ç¾¤ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰ åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼ˆZooKeeperã€Etcdï¼‰ å­˜å‚¨ç³»ç»Ÿï¼ˆCephã€HDFSï¼‰ éœ€è¦å›ºå®šä¸»æœºåè®¿é—®çš„æœåŠ¡ï¼ˆKafkaã€RabbitMQï¼‰ ğŸ§© 1. ä¸ºä»€ä¹ˆéœ€è¦ StatefulSetï¼Ÿï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰ Deployment è®¾è®¡ç”¨äºæ— çŠ¶æ€åº”ç”¨ï¼š\nâŒ Pod åç§°éšæœº âŒ å­˜å‚¨ä¸å›ºå®š âŒ Pod ä¼šè¢«æ›¿æ¢ï¼Œæ— æ³•ç¨³å®šç»‘å®šæ•°æ® âŒ æ— æ³•ä¿è¯å…ˆå¯åŠ¨/å…ˆå…³é—­é¡ºåº StatefulSet åˆ™æä¾›ï¼š\n| ç‰¹æ€§ | Deployment | StatefulSet | | Pod åç§°ç¨³å®š | âŒ | âœ… | | Pod DNS ç¨³å®š | âŒ | âœ… | | Pod é¡ºåºéƒ¨ç½² | âŒ | âœ… | | Pod é¡ºåºæ›´æ–° | âŒ | âœ… | | å›ºå®šæŒä¹…å· | âŒ | âœ…ï¼ˆPVC è‡ªåŠ¨åˆ›å»ºï¼‰ | | é€‚åˆæ•°æ®åº“ | âŒ | âœ… |\næ€»ç»“ï¼š\nStatefulSet è®©æ¯ä¸ª Pod éƒ½æœ‰èº«ä»½ï¼ˆIdentityï¼‰+ æ•°æ®æŒä¹…åŒ–ï¼ˆPersistenceï¼‰ã€‚\nğŸ§© 2. StatefulSet çš„æ ¸å¿ƒç‰¹æ€§ 2.1 Pod ç¨³å®šèº«ä»½ï¼ˆStable Identityï¼‰ Pod åå­—å›ºå®šï¼š\n\u0026lt;statefulset-name\u0026gt;-0 \u0026lt;statefulset-name\u0026gt;-1 \u0026lt;statefulset-name\u0026gt;-2 ä¾‹å¦‚ï¼š\nmysql-0 mysql-1 mysql-2 é‡å¯ä¹Ÿä¸ä¼šæ”¹å˜ã€‚\n2.2 ç¨³å®šç½‘ç»œæ ‡è¯†ï¼ˆStable Network Identityï¼‰ å€ŸåŠ© Headless Serviceï¼ˆå¿…é¡»ï¼‰ï¼š\nserviceName: mysql Pod ä¼šæœ‰ç¨³å®šçš„ DNSï¼š\nmysql-0.mysql.default.svc.cluster.local mysql-1.mysql.default.svc.cluster.local æ¯ä¸ªå®ä¾‹éƒ½æœ‰å¯ç›´è¿çš„åŸŸåï¼ˆæ•°æ®åº“éå¸¸ä¾èµ–ï¼‰ã€‚\n2.3 ç¨³å®šæŒä¹…åŒ–å·ï¼ˆStable Storageï¼‰ StatefulSet + volumeClaimTemplates -\u0026gt; è‡ªåŠ¨ç”Ÿæˆ PVCï¼š\ndata-mysql-0 data-mysql-1 data-mysql-2 åˆ é™¤ Pod ä¸ä¼šåˆ é™¤ PVCï¼š\næ•°æ®ä¸ä¸¢ Pod å¯ä»¥æ¢å¤ èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ä¾æ—§èƒ½é‡å»º Pod 2.4 ä¸¥æ ¼é¡ºåºåŒ–çš„è¡Œä¸ºï¼ˆOrdered Operationsï¼‰ StatefulSet æä¾›ï¼š\nğŸ“Œ é¡ºåºéƒ¨ç½²ï¼ˆCreateï¼‰\nmysql-0 -\u0026gt; mysql-1 -\u0026gt; mysql-2 ğŸ“Œ é¡ºåºæ›´æ–°ï¼ˆUpdateï¼‰\næ»šæ›´æ—¶é€ä¸ªæ›´æ–° Pod æ–° Pod å¿…é¡» Ready æ‰èƒ½ç»§ç»­ ğŸ“Œ é¡ºåºåˆ é™¤ï¼ˆDeleteï¼‰\nmysql-2 -\u0026gt; mysql-1 -\u0026gt; mysql-0 æ•°æ®åº“ä¸»ä»åˆ‡æ¢éå¸¸ä¾èµ–æ­¤ç‰¹æ€§ã€‚\nğŸ§© 3. StatefulSet YAML è§£æï¼ˆæœ€å¹²å‡€ç‰ˆæœ¬ï¼‰ apiVersion: apps/v1 kind: StatefulSet metadata: name: mysql spec: serviceName: mysql replicas: 3 selector: matchLabels: app: mysql updateStrategy: type: RollingUpdate podManagementPolicy: OrderedReady # é»˜è®¤è¡Œä¸º template: metadata: labels: app: mysql spec: containers: - name: mysql image: mysql:8 volumeMounts: - name: data mountPath: /var/lib/mysql volumeClaimTemplates: - metadata: name: data spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] resources: requests: storage: 20Gi ğŸ§© 4. StatefulSet çš„å…³é”®å­—æ®µè§£é‡Š â­ serviceNameï¼ˆå¿…é¡»ï¼‰ ç”¨äºä¸ºæ¯ä¸ª Pod åˆ›å»ºç¨³å®š DNSï¼š\nserviceName: mysql è¦æ±‚ç»‘å®šä¸€ä¸ªï¼š\nHeadless Serviceï¼š\napiVersion: v1 kind: Service metadata: name: mysql spec: clusterIP: None selector: app: mysql ports: - port: 3306 å¦åˆ™ Pod DNS æ— æ³•ç”Ÿæˆã€‚\nâ­ podManagementPolicy é»˜è®¤ï¼šOrderedReady\næŒ‰é¡ºåºå¯åŠ¨ã€æ›´æ–°ã€åˆ é™¤ é€‚åˆæ•°æ®åº“ é€‰é¡¹ï¼šParallel\nå¹¶è¡Œå¯åŠ¨æ‰€æœ‰ Pod é€‚åˆ Kafkaã€RabbitMQ è¿™ç§èŠ‚ç‚¹é—´ç‹¬ç«‹æ€§è¾ƒå¼ºçš„æœåŠ¡ â­ updateStrategy RollingUpdateï¼ˆé»˜è®¤ï¼‰\né€ä¸ªæ›´æ–° Podï¼ˆå®‰å…¨ï¼‰\nOnDelete\næ‰‹åŠ¨åˆ é™¤æ—§ Pod æ‰æ›´æ–° ç”¨äºéå¸¸æ•æ„Ÿçš„æ•°æ®åº“å‡çº§ï¼Œä¾‹å¦‚ etcdã€‚\nâ­ volumeClaimTemplates æ¯ä¸ª Pod è‡ªåŠ¨ç”Ÿæˆç‹¬ç«‹ PVCï¼š\ndata-mysql-0 data-mysql-1 data-mysql-2 å·ä¸ä¼šéš StatefulSet åˆ é™¤ã€‚\nğŸ§© 5. StatefulSet + Persistent Volume æŒ‚è½½æµç¨‹ æµç¨‹å›¾ï¼š\nåˆ›å»º StatefulSet â†“ åˆ›å»º Pod-0 â†“ è‡ªåŠ¨åˆ›å»º PVC-0 â†“ è°ƒåº¦åˆ° Node â†“ æŒ‚è½½ PVï¼ˆåŠ¨æ€/é™æ€ï¼‰ â†“ Pod å¯åŠ¨ ç‰¹ç‚¹ï¼š\nPod ä¸ PVC æ°¸ä¹…ç»‘å®š Pod é‡å»ºä¸å½±å“æ•°æ® æ¢èŠ‚ç‚¹ä»ä¼šæŒ‚å›åŒä¸€ PVCï¼ˆä½¿ç”¨ç½‘ç»œå­˜å‚¨æ—¶ï¼‰ ğŸ§© 6. StatefulSet å¸¸è§ä½¿ç”¨åœºæ™¯ MySQL ä¸»ä»ã€MySQL InnoDB Cluster æ•°æ®å¿…é¡»å›ºå®šï¼ŒPod é¡ºåºè¦æ±‚å¼ºã€‚\nPostgreSQL Patroni é›†ç¾¤ Leader/Follower ä¾èµ–å›ºå®šä¸»æœºåã€‚\nRedis Sentinel æ¯ä¸ªèŠ‚ç‚¹èº«ä»½ä¸åŒã€‚\nZooKeeper åªæœ‰ 0 å· Pod å¯ä»¥åˆå§‹åŒ–é›†ç¾¤ã€‚\nKafkaã€RabbitMQ æ¯ä¸ª broker æœ‰ç‹¬ç«‹æ—¥å¿—ç›®å½•ã€‚\nCeph OSD æ¯ä¸ªèŠ‚ç‚¹ç»‘å®šç‰¹å®šç£ç›˜æˆ–æ•°æ®ç›®å½•ã€‚\nğŸ§© 7. StatefulSet å¸¸è§é—®é¢˜ä¸æ’æŸ¥ â— 1. ä¸ºä»€ä¹ˆ StatefulSet Pod æ— æ³•å¯åŠ¨ï¼Ÿ æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ Headless Serviceï¼š\nclusterIP: None æ£€æŸ¥å­˜å‚¨ï¼š\nkubectl get pvc kubectl describe pvc \u0026lt;name\u0026gt; â— 2. ä¸ºä»€ä¹ˆ StatefulSet ä¸èƒ½è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Ÿ å› ä¸ºï¼š\næ‰©å®¹ï¼šæ–° Pod å¦‚ 3-\u0026gt;4 ä¼šè‡ªåŠ¨åˆ›å»º PVC ç¼©å®¹ï¼šPod åˆ é™¤ï¼Œä½† PVC ä¸ä¼šåˆ é™¤ å†æ¬¡æ‰©å®¹ -\u0026gt; ç»‘å®šå›åŸ PVC â— 3. PVC å¦‚ä½•æ¸…ç†ï¼Ÿ ä½ å¿…é¡»æ‰‹åŠ¨åˆ é™¤ï¼š\nkubectl delete pvc data-mysql-2 é˜²æ­¢è¯¯åˆ æ•°æ®ã€‚\nğŸ§© 8. StatefulSet vs Deployment vs DaemonSetï¼ˆæ€»ç»“å¯¹æ¯”ï¼‰ | ç‰¹æ€§ | Deployment | StatefulSet | DaemonSet | | é€‚ç”¨åœºæ™¯ | æ— çŠ¶æ€åº”ç”¨ | æœ‰çŠ¶æ€æœåŠ¡ | èŠ‚ç‚¹ Agent | | Pod èº«ä»½ | æ—  | æœ‰ï¼ˆå›ºå®šï¼‰ | ä¸èŠ‚ç‚¹ç»‘å®š | | DNS ç¨³å®š | âŒ | âœ… | âœ… | | å­˜å‚¨ | å¯é€‰ï¼Œéç¨³å®š | ç»‘å®š PVC | é€šå¸¸ä½¿ç”¨ hostPath | | é¡ºåºå¯åŠ¨ | âŒ | âœ… | âŒ | | é€‚åˆæ•°æ®åº“ | âŒ | âœ… | âŒ |\nğŸ§© 9. StatefulSet æœ€ä½³å®è·µï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ å¿…é¡»é…åˆ Headless Service clusterIP: None å¿…é¡»ä½¿ç”¨ volumeClaimTemplatesï¼ˆä¸è¦æ‰‹å†™ PVCï¼‰ å› ä¸ºï¼š\nè‡ªåŠ¨åˆ›å»º è‡ªåŠ¨ç»‘å®šå‘½åè§„èŒƒ ä¸ç”¨æ‹…å¿ƒæ¼å†™ å¯¹æ•°æ®åº“è¯·ä½¿ç”¨ RollingUpdate + PodDisruptionBudget + readinessProbe å¼ºçƒˆå»ºè®®ä¸è¦ç»™ StatefulSet Pod è®¾ç½® hostNetwork: true ä¼šå¯¼è‡´ï¼š\nâŒ ä¸åŒ Pod DNS å†²çª âŒ ç«¯å£å†²çª âŒ ClusterIP æ— æ³•è®¿é—® StatefulSet ä¸é€‚åˆè¿™äº›åœºæ™¯ é«˜å¹¶å‘æ¨ªå‘æ‰©å±•å‹ Web æœåŠ¡ -\u0026gt; Deployment èŠ‚ç‚¹çº§æ’ä»¶ -\u0026gt; DaemonSet æ‰¹å¤„ç† -\u0026gt; Job å®šæ—¶ä»»åŠ¡ -\u0026gt; CronJob ğŸ§© 10. ä¸€å¼ å›¾ç†è§£ StatefulSetï¼ˆè¶…æ¸…æ™°ï¼‰ StatefulSet â†“ Pod 0 -- PVC-0 -- DNS: mysql-0.mysql Pod 1 -- PVC-1 -- DNS: mysql-1.mysql Pod 2 -- PVC-2 -- DNS: mysql-2.mysql é¡ºåºï¼š åˆ›å»º: 0 -\u0026gt; 1 -\u0026gt; 2 æ›´æ–°: 0 -\u0026gt; 1 -\u0026gt; 2 åˆ é™¤: 2 -\u0026gt; 1 -\u0026gt; 0 æ¯ä¸ª Pod å°±åƒæœ‰è‡ªå·± èº«ä»½è¯å·ç  å’Œ ç‹¬ç«‹ç¡¬ç›˜ã€‚\nğŸ¯ æœ€ç»ˆæ€»ç»“ï¼ˆæŒæ¡ StatefulSet çš„å…³é”®ä¸€å¥è¯ï¼‰ StatefulSet = æœ‰èº«ä»½çš„ Pod + ç¨³å®š DNS + ç¨³å®šå­˜å‚¨ + é¡ºåºåŒ–è¿ç»´ã€‚\nç”¨äºæ•°æ®åº“ã€é˜Ÿåˆ—ã€åè°ƒç³»ç»Ÿç­‰æ‰€æœ‰æœ‰çŠ¶æ€åº”ç”¨ã€‚\n","description":"StatefulSet æ˜¯ Kubernetes ä¸­ç”¨äº æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStateful Applicationï¼‰ çš„ Workload ç±»å‹ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š\nPod çš„èº«ä»½ä¿æŒï¼ˆIdentityï¼‰ + ç¨³å®šä¸€è‡´çš„å­˜å‚¨ï¼ˆStable Storageï¼‰ + é¡ºåºåŒ–éƒ¨ç½²ã€æ›´æ–°ã€åˆ é™¤ï¼ˆOrdered Operationï¼‰\nå…¸å‹ä¸šåŠ¡åœºæ™¯åŒ…æ‹¬ï¼š\næ•°æ®åº“é›†ç¾¤ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰ åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼ˆZooKeeperã€Etcdï¼‰ å­˜å‚¨ç³»ç»Ÿï¼ˆCephã€HDFSï¼‰ éœ€è¦å›ºå®šä¸»æœºåè®¿é—®çš„æœåŠ¡ï¼ˆKafkaã€RabbitMQï¼‰ ğŸ§© 1. ä¸ºä»€ä¹ˆéœ€è¦ StatefulSetï¼Ÿï¼ˆæ ¸å¿ƒä»·å€¼ï¼‰ Deployment è®¾è®¡ç”¨äºæ— çŠ¶æ€åº”ç”¨ï¼š\nâŒ Pod åç§°éšæœº âŒ å­˜å‚¨ä¸å›ºå®š âŒ Pod ä¼šè¢«æ›¿æ¢ï¼Œæ— æ³•ç¨³å®šç»‘å®šæ•°æ® âŒ æ— æ³•ä¿è¯å…ˆå¯åŠ¨/å…ˆå…³é—­é¡ºåº StatefulSet åˆ™æä¾›ï¼š\n| ç‰¹æ€§ | Deployment | StatefulSet | | Pod åç§°ç¨³å®š | âŒ | âœ… | | Pod DNS ç¨³å®š | âŒ | âœ… | | Pod é¡ºåºéƒ¨ç½² | âŒ | âœ… | | Pod é¡ºåºæ›´æ–° | âŒ | âœ… | | å›ºå®šæŒä¹…å· | âŒ | âœ…ï¼ˆPVC è‡ªåŠ¨åˆ›å»ºï¼‰ | | é€‚åˆæ•°æ®åº“ | âŒ | âœ… |\n"},{"id":275,"href":"/operations/kubernetes/storage/","title":"Kubernetes Storage","parent":"Kubernetes","content":"Kubernetes çš„å­˜å‚¨ä½“ç³»ç”± å·ï¼ˆVolumesï¼‰-\u0026gt; æŒä¹…å·ï¼ˆPVï¼‰-\u0026gt; æŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰-\u0026gt; å­˜å‚¨ç±»ï¼ˆStorageClassï¼‰ æ„æˆï¼Œæ˜¯ Pod æä¾›æŒä¹…æ•°æ®èƒ½åŠ›çš„åŸºç¡€ã€‚\nâ­ 1. Kubernetes å­˜å‚¨çš„åŸºæœ¬æ¦‚å¿µ å®¹å™¨ vs Pod vs Storage\nå¯¹è±¡ ç”Ÿå‘½å‘¨æœŸ æ•°æ®æ˜¯å¦æŒä¹…åŒ– Container é‡å¯ä¼šä¸¢å¤± âŒ Pod é‡å»ºä¼šä¸¢å¤± âŒ Volumeï¼ˆåœ¨ Pod å†…ï¼‰ Pod åœ¨åˆ™åœ¨ âŒ PVï¼ˆæŒä¹…å·ï¼‰ ä¸ Pod åˆ†ç¦» âœ… PVCï¼ˆå£°æ˜ï¼‰ Pod é‡å»ºåä»ç»‘å®š âœ… â­ 2. Volumeï¼ˆPod å†…éƒ¨å·ï¼‰è¯¦è§£ Volume æ˜¯ Pod çº§åˆ«çš„å­˜å‚¨ï¼ŒPod åˆ é™¤å Volume æ•°æ®ä¹Ÿé€šå¸¸è¢«åˆ é™¤ã€‚\nå¸¸è§ Volume ç±»å‹\nemptyDir Pod æ¯æ¬¡é‡å»ºæ•°æ®ä¸¢å¤±ã€‚ é»˜è®¤ç±»å‹ã€‚ æœ€é€‚åˆ ä¸´æ—¶ç¼“å­˜ã€å·¥ä½œç›®å½•ã€ç¼“å†²åŒºã€‚ volumes: - name: cache emptyDir: {} hostPath æŠŠä¸»æœºè·¯å¾„æŒ‚è½½åˆ°å®¹å™¨ã€‚ å¼ºä¾èµ– Nodeï¼Œä¸å¯è°ƒåº¦è¿ç§»ã€‚ ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ã€‚ configMap / secret / downwardAPI æŠŠé…ç½®ã€ç¯å¢ƒå˜é‡æ³¨å…¥åˆ° Podã€‚\nprojected ç»„åˆå¤šä¸ªæºçš„ç‰¹æ®Šå·ï¼ˆconfigMap/secret/DownwardAPIï¼‰ã€‚\nsubPath åªæŒ‚è½½ä¸€ä¸ªå­ç›®å½•ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå·ã€‚\nâ¡ï¸ Volume æ˜¯çŸ­æœŸå­˜å‚¨ï¼Œä¸é€‚ç”¨äºæŒä¹…åŒ–ã€‚\nâ­ 3. PersistentVolumeï¼ˆPVï¼‰è¯¦è§£ PV æ˜¯é›†ç¾¤çº§åˆ«èµ„æºï¼ˆClusterScopeï¼‰ï¼Œç‹¬ç«‹äº Pod å­˜åœ¨ã€‚\nå®ƒæè¿°äº†åç«¯å­˜å‚¨ï¼š\næœ¬åœ°ç£ç›˜ NFS Ceph / CephFS / RBD iSCSI äº‘å‚å•†å­˜å‚¨ï¼ˆAWS EBSã€Aliyun Diskã€GCP PDâ€¦ï¼‰ CSI é©±åŠ¨ 3.1 PV çš„é‡è¦å±æ€§ storageClassName æŒ‡å®šå…³è”çš„ StorageClassã€‚\naccessModes è®¿é—®æ¨¡å¼ï¼š\nå€¼ å«ä¹‰ ReadWriteOnce (RWO) å•èŠ‚ç‚¹è¯»å†™ï¼ˆæœ€å¸¸ç”¨ï¼‰ ReadOnlyMany (ROX) å¤šèŠ‚ç‚¹åªè¯» ReadWriteMany (RWX) å¤šèŠ‚ç‚¹è¯»å†™ï¼ˆNFS, CephFSï¼‰ ReadWriteOncePod (RWOP) ä»… 1 ä¸ª Pod å¯æŒ‚è½½ persistentVolumeReclaimPolicy Retainï¼ˆæ¨èä¸šåŠ¡éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼‰ Delete Recycleï¼ˆå·²åºŸå¼ƒï¼‰ â­ 4. PersistentVolumeClaimï¼ˆPVCï¼‰è¯¦è§£ PVC æ˜¯ Pod å‘é›†ç¾¤ç”³è¯·å­˜å‚¨çš„ä¸€ç§ â€œå£°æ˜â€ã€‚\nå®ƒå£°æ˜ï¼š\nå¤§å° è®¿é—®æ¨¡å¼ å…³è”çš„ StorageClass PVC ä¼šä¸ PV ç»‘å®šï¼Œç»‘å®šå Pod å°±å¯ä»¥ä½¿ç”¨å®ƒã€‚\nâ­ 5. StorageClass è¯¦è§£ï¼ˆæœ€é‡è¦ï¼‰ StorageClass å®šä¹‰ï¼š\nå­˜å‚¨åç«¯ï¼ˆVolume plugin æˆ– CSIï¼‰ å›æ”¶ç­–ç•¥ åŠ¨æ€ä¾›åº”ï¼ˆDynamic Provisioningï¼‰ 5.1 åŠ¨æ€ä¾›åº”ï¼ˆDynamic Provisioningï¼‰ PVC ä¸å†éœ€è¦æå‰åˆ›å»º PVã€‚\nåˆ›å»º PVC -\u0026gt; æ§åˆ¶å™¨è‡ªåŠ¨åˆ›å»º PV -\u0026gt; è‡ªåŠ¨ç»‘å®šã€‚\nğŸ“Œ ç”Ÿäº§ç¯å¢ƒ 99% ä½¿ç”¨ StorageClass + Dynamic Provisioning\n5.2 StorageClass å…³é”®å­—æ®µ provisioner: kubernetes.io/no-provisioner # æ‰‹åŠ¨ parameters: type: gp3 # äº‘å‚å•†ç£ç›˜ç±»å‹ reclaimPolicy: Delete # è‡ªåŠ¨åˆ é™¤ allowVolumeExpansion: true # è¿è¡Œä¸­æ‰©å®¹ volumeBindingMode: WaitForFirstConsumer volumeBindingMode\næ¨¡å¼ è§£é‡Š Immediate åˆ†é… PV åç«‹å³ç»‘å®šï¼ˆé»˜è®¤ï¼‰ WaitForFirstConsumerï¼ˆæ¨èï¼‰ ç›´åˆ° Pod è°ƒåº¦åæ‰å†³å®šåœ¨å“ªä¸ª node åˆ›å»ºå­˜å‚¨ ğŸ“Œ å¼ºçƒˆæ¨è\nstatefulset + local storage å¿…é¡»ä½¿ç”¨ WaitForFirstConsumerï¼Œå¦åˆ™æ— æ³•è°ƒåº¦ã€‚\nâ­ 6. CSIï¼ˆContainer Storage Interfaceï¼‰è¯¦è§£ ç°ä»£å­˜å‚¨ï¼ˆCeph, NFS, äº‘ç¡¬ç›˜ï¼‰éƒ½èµ° CSIã€‚\nCSI æ’ä»¶èƒ½åŠ›ï¼š\nåˆ›å»ºå· åˆ é™¤å· æŒ‚è½½/å¸è½½ å¿«ç…§ å…‹éš† æ‰©å®¹ â­ 7. ä¸åŒå­˜å‚¨ç±»å‹å®é™…åœºæ™¯å¯¹æ¯” åœºæ™¯ æ¨èå­˜å‚¨ MySQL / PostgreSQL LocalPV / RBD / äº‘ç›˜ï¼ˆRWOï¼‰ MongoDB / Redis LocalPV / RBD Nginx ç¼“å­˜ emptyDir å¤š pod å…±äº«æ–‡ä»¶ NFS / CephFSï¼ˆRWXï¼‰ æ—¥å¿—æ”¶é›† hostPathï¼ˆåªè¯»ï¼‰ å¤§æ–‡ä»¶åˆ†å¸ƒå¼ CephFS / GlusterFS éœ€è¦å¤‡ä»½æ¢å¤ æ”¯æŒå¿«ç…§çš„ CSIï¼ˆCeph RBD, AWS EBSï¼‰ â­ 8. Pod ä½¿ç”¨ PVC ç¤ºä¾‹ volumes: - name: data persistentVolumeClaim: claimName: mysql-pvc â­ 9. StatefulSet ä¸ PVCï¼ˆVolumeClaimTemplateï¼‰ StatefulSet ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ª Pod ç”Ÿæˆç‹¬ç«‹ PVCï¼š\nvolumeClaimTemplates: - metadata: name: data spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: local-storage resources: requests: storage: 20Gi ğŸ“Œ è‡ªåŠ¨ç”Ÿæˆï¼š\ndata-mysql-0 data-mysql-1 data-mysql-2 â­ 10. Local PVï¼ˆæœ¬åœ°æŒä¹…å·ï¼‰è¯¦è§£ Local PV = Pod åªèƒ½è°ƒåº¦åˆ°åŒä¸€ä¸ª Nodeï¼Œä½†æ€§èƒ½æé«˜ã€‚\né€‚ç”¨äºï¼š\né«˜æ€§èƒ½æ•°æ®åº“ï¼ˆMySQL, PostgreSQL, Kafkaï¼‰ å¤§é‡ IOPS åœºæ™¯ å¿…é¡»ä½¿ç”¨ï¼š\nvolumeBindingMode: WaitForFirstConsumer â­ 11. å­˜å‚¨æ€§èƒ½è°ƒä¼˜è¦ç‚¹ï¼ˆç”Ÿäº§çº§ï¼‰ 11.1 Node å±‚ vm.dirty_ratio = 5 vm.dirty_background_ratio = 2 fs.inotify.max_user_watches = 1048576 11.2 containerd å±‚ ä½¿ç”¨ overlayfs2ï¼Œé¿å… overlayfs ä¸ä¸€è‡´é—®é¢˜ã€‚\n11.3 æ–‡ä»¶ç³»ç»Ÿ XFSï¼ˆæ•°æ®åº“ï¼‰ EXT4ï¼ˆä¸€èˆ¬åº”ç”¨ï¼‰ â­ 12. æœ€ä½³å®è·µæ€»ç»“ ğŸ“Œ 12.1 å¯¹äºæ‰€æœ‰æ•°æ®åº“ ä½¿ç”¨ Local PV æˆ– RBD production å¿…ç”¨ PV/PVCï¼Œä¸è¦ç”¨ hostPath ä½¿ç”¨ StatefulSetï¼Œä¸è¦ Deployment ğŸ“Œ 12.2 å¯¹äºå…±äº«æ•°æ® ä½¿ç”¨ RWXï¼ˆNFS / CephFSï¼‰\nğŸ“Œ 12.3 å¯¹äºç¼“å­˜/ä¸´æ—¶è®¡ç®— emptyDirï¼ˆå¯ä»¥å†…å­˜ tmpfsï¼‰\nemptyDir: medium: Memory ğŸ“Œ 12.4 å¯¹äºé«˜æ€§èƒ½åº”ç”¨ Local PV + SSD\nğŸ“Œ 12.5 å¼ºçƒˆç¦æ­¢ âŒ hostPath æŒä¹…åŒ–ä¸šåŠ¡æ•°æ® âŒ ä½¿ç”¨ latest image tag æŒä¹…åŒ–æ•°æ® âŒ Pod ä½¿ç”¨åŒä¸€ä¸ª PVï¼ˆé™¤ RWX å¤–ï¼‰ ","description":"Kubernetes çš„å­˜å‚¨ä½“ç³»ç”± å·ï¼ˆVolumesï¼‰-\u0026gt; æŒä¹…å·ï¼ˆPVï¼‰-\u0026gt; æŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰-\u0026gt; å­˜å‚¨ç±»ï¼ˆStorageClassï¼‰ æ„æˆï¼Œæ˜¯ Pod æä¾›æŒä¹…æ•°æ®èƒ½åŠ›çš„åŸºç¡€ã€‚\nâ­ 1. Kubernetes å­˜å‚¨çš„åŸºæœ¬æ¦‚å¿µ å®¹å™¨ vs Pod vs Storage\nå¯¹è±¡ ç”Ÿå‘½å‘¨æœŸ æ•°æ®æ˜¯å¦æŒä¹…åŒ– Container é‡å¯ä¼šä¸¢å¤± âŒ Pod é‡å»ºä¼šä¸¢å¤± âŒ Volumeï¼ˆåœ¨ Pod å†…ï¼‰ Pod åœ¨åˆ™åœ¨ âŒ PVï¼ˆæŒä¹…å·ï¼‰ ä¸ Pod åˆ†ç¦» âœ… PVCï¼ˆå£°æ˜ï¼‰ Pod é‡å»ºåä»ç»‘å®š âœ… â­ 2. Volumeï¼ˆPod å†…éƒ¨å·ï¼‰è¯¦è§£ Volume æ˜¯ Pod çº§åˆ«çš„å­˜å‚¨ï¼ŒPod åˆ é™¤å Volume æ•°æ®ä¹Ÿé€šå¸¸è¢«åˆ é™¤ã€‚\n"},{"id":276,"href":"/operations/kubernetes/workload/","title":"Kubernetes Workload","parent":"Kubernetes","content":" Kubernetes ä¸­å¸¸è§çš„ 6 å¤§ Workload Pod ReplicaSet Deployment StatefulSet DaemonSet Job / CronJob 1. Podï¼ˆæœ€å°è°ƒåº¦å•å…ƒï¼‰ æ˜¯ä»€ä¹ˆ Kubernetes æœ€æ ¸å¿ƒçš„è¿è¡Œå•å…ƒï¼›ä¸æ˜¯æ§åˆ¶å™¨ï¼Œåªæ˜¯å®¹å™¨çš„å°è£…ã€‚\nâœ… é€‚ç”¨åœºæ™¯ ä¸´æ—¶æµ‹è¯• è°ƒè¯• ä¸éœ€è¦è‡ªåŠ¨æ¢å¤çš„ä¸´æ—¶ä»»åŠ¡ ### âŒ ä¸é€‚ç”¨ ä»»ä½•éœ€è¦é‡å¯ã€è‡ªæ„ˆã€æ‰©ç¼©å®¹çš„ä¸šåŠ¡ ç”Ÿäº§ç¯å¢ƒï¼ˆé™¤æå°‘æ•°æƒ…å†µï¼‰ 2. ReplicaSetï¼ˆæ—§æ—¶ä»£çš„æ§åˆ¶å™¨ï¼‰ æ˜¯ä»€ä¹ˆ ä¿è¯ æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬æ•°ã€‚\nDeployment å†…éƒ¨å°±æ˜¯ä½¿ç”¨ ReplicaSet å®ç°ç‰ˆæœ¬ç®¡ç†ã€‚\nâœ… é€‚ç”¨åœºæ™¯ åŸºç¡€å­¦ä¹  ç‰¹æ®Šæƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨ç®¡ç†æ»šåŠ¨å‡çº§ ### âŒ ä¸é€‚ç”¨ ä¸€èˆ¬ä¸šåŠ¡ï¼ˆæ€»æ˜¯ç”¨ Deploymentï¼‰ 3. Deploymentï¼ˆæ— çŠ¶æ€æ ¸å¿ƒ Workloadï¼‰ æ˜¯ä»€ä¹ˆ æ— çŠ¶æ€åº”ç”¨æ ‡å‡†æ¨¡æ¿ã€‚\næ”¯æŒï¼š\næ»šåŠ¨å‡çº§ / å›æ»š å‰¯æœ¬æ•°ç®¡ç† Pod ç­–ç•¥ é‡‘ä¸é›€ / è“ç»¿å‘å¸ƒï¼ˆé…åˆ Serviceï¼‰ âœ… é€‚ç”¨åœºæ™¯ Web æœåŠ¡ API æœåŠ¡ æ— çŠ¶æ€å¾®æœåŠ¡ Statless Worker ### âŒ ä¸é€‚ç”¨ æŒä¹…åŒ–å­˜å‚¨ã€æœ‰é¡ºåºè¦æ±‚çš„åº”ç”¨ -\u0026gt; ç”¨ StatefulSet 4. StatefulSetï¼ˆæœ‰çŠ¶æ€æ ¸å¿ƒ Workloadï¼‰ æ˜¯ä»€ä¹ˆ ä¸ºæœ‰çŠ¶æ€åº”ç”¨è®¾è®¡ï¼Œæä¾›ï¼š\nåŠŸèƒ½ è¯´æ˜ ç¨³å®šçš„ç½‘ç»œèº«ä»½ pod-0ã€pod-1ã€pod-2 ç¨³å®šçš„å­˜å‚¨ PVC ä¸ Pod ä¸€ä¸€ç»‘å®š æœ‰åºéƒ¨ç½²/æ‰©ç¼©å®¹/åˆ é™¤ Pod æœ‰é¡ºåºï¼ˆ0 -\u0026gt; 1 -\u0026gt; 2ï¼‰ âœ… é€‚ç”¨åœºæ™¯ æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLï¼‰ åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆCephã€MinIOï¼‰ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaã€RabbitMQï¼‰ ä»»ä½•éœ€è¦ç¨³å®š volume çš„æœåŠ¡ âŒ ä¸é€‚ç”¨ æ— çŠ¶æ€åº”ç”¨ 5. DaemonSetï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½è¦è·‘ 1 ä¸ªï¼‰ æ˜¯ä»€ä¹ˆ åœ¨ æ¯ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„æ§åˆ¶å™¨ã€‚\nâœ… é€‚ç”¨åœºæ™¯ æ—¥å¿—æ”¶é›†ï¼ˆFluentd, Vectorï¼‰ èŠ‚ç‚¹ç›‘æ§ï¼ˆNode Exporterï¼‰ CSI/ç½‘ç»œæ’ä»¶ï¼ˆCalicoã€Ciliumï¼‰ Node Agentï¼ˆæ¯”å¦‚å®ˆæŠ¤è¿›ç¨‹ï¼‰ âŒ ä¸é€‚ç”¨ æ™®é€š Web æœåŠ¡ï¼ˆåº”è¯¥ç”¨ Deploymentï¼‰ 6. Job / CronJobï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰ ğŸŸ¦ Job æ˜¯ä»€ä¹ˆ ä¸€æ¬¡æ€§å®Œæˆä»»åŠ¡çš„ Podï¼Œå¤±è´¥ä¼šé‡è¯•ã€‚\nâœ… é€‚ç”¨åœºæ™¯ æ•°æ®è¿ç§» æ–‡ä»¶å¤„ç† ETL æ‰¹å¤„ç†ä»»åŠ¡ ğŸŸ¨ CronJob æ˜¯ä»€ä¹ˆ å®šæ—¶æ‰§è¡Œ Jobï¼ˆç±»ä¼¼ Linux cronï¼‰\nâœ… é€‚ç”¨åœºæ™¯ å®šæœŸå¤‡ä»½ å®šæ—¶æŠ¥å‘Š å®šæ—¶è®¡ç®—ä»»åŠ¡ å®šæœŸæ¸…ç†ä»»åŠ¡ ğŸ§­ Workload åœºæ™¯å¯¹æ¯”æ€»ç»“ï¼ˆæœ€å®ç”¨è¡¨ï¼‰ Workload æ˜¯å¦æœ‰çŠ¶æ€ æ˜¯å¦è‡ªæ„ˆ æ˜¯å¦è‡ªåŠ¨æ‰©ç¼©å®¹ æ˜¯å¦é¡ºåºå¯åŠ¨ é€‚ç”¨åœºæ™¯ Pod âŒ æ—  âŒ æ—  âŒ æ—  âŒ æ—  è°ƒè¯•ã€ä¸´æ—¶è¿è¡Œ ReplicaSet âŒ æ—  âœ… âœ… âŒ åº•å±‚æ§åˆ¶å™¨ Deployment âŒ æ—  âœ… âœ… âŒ Web/API/å¾®æœåŠ¡ StatefulSet âœ… æœ‰çŠ¶æ€ âœ… âœ… âœ… æœ‰åº DBã€MQã€åˆ†å¸ƒå¼å­˜å‚¨ DaemonSet èŠ‚ç‚¹çº§ âœ… âŒ âŒ æ—¥å¿—/ç›‘æ§/ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ Job ä¸€æ¬¡æ€§ âœ… é‡è¯• âŒ âŒ æ‰¹å¤„ç†ä»»åŠ¡ CronJob å®šæ—¶ä»»åŠ¡ âœ… âŒ âŒ å®šæ—¶ä»»åŠ¡ ğŸ§¨ å¸¸è§è¯¯åŒº è¯¯åŒº 1ï¼šæ•°æ®åº“ç”¨ Deployment âŒ é”™è¯¯\næ•°æ®åº“éœ€è¦ç¨³å®šå­˜å‚¨ + ç½‘ç»œèº«ä»½ï¼Œåº”è¯¥ç”¨ StatefulSetã€‚\nè¯¯åŒº 2ï¼šDaemonSet ä¼šå æ»¡ CPUï¼Ÿ DaemonSet é»˜è®¤ 1 ä¸ª Pod/Nodeï¼Œèµ„æºç”±æ¯ä¸ª Pod request/limit å†³å®šã€‚\nè¯¯åŒº 3ï¼šDeployment ä¸èƒ½è·‘ statefulï¼Ÿ å¯ä»¥ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®æ¼‚ç§»ï¼ŒPod é‡å»ºä¼šä¸¢ volumeã€‚\nè¯¯åŒº 4ï¼šPod delet -\u0026gt; ä¸ä¼šé‡å»º å› ä¸º Pod ä¸æ˜¯æ§åˆ¶å™¨ï¼Œä¸ä¼šè‡ªåŠ¨æ¢å¤ã€‚\nğŸ æœ€ä½³é€‰æ‹©å£è¯€ æ— çŠ¶æ€ -\u0026gt; Deployment æœ‰çŠ¶æ€ -\u0026gt; StatefulSet èŠ‚ç‚¹çº§å®ˆæŠ¤ -\u0026gt; DaemonSet ä¸€æ¬¡æ€§ä»»åŠ¡ -\u0026gt; Job å‘¨æœŸæ€§ä»»åŠ¡ -\u0026gt; CronJob ä¸´æ—¶è°ƒè¯• -\u0026gt; Pod ä¸è¦æ‰‹åŠ¨ç”¨ ReplicaSetï¼ˆé™¤éä½ çŸ¥é“ä½ åœ¨å¹²ä»€ä¹ˆï¼‰ ","description":" Kubernetes ä¸­å¸¸è§çš„ 6 å¤§ Workload Pod ReplicaSet Deployment StatefulSet DaemonSet Job / CronJob 1. Podï¼ˆæœ€å°è°ƒåº¦å•å…ƒï¼‰ æ˜¯ä»€ä¹ˆ Kubernetes æœ€æ ¸å¿ƒçš„è¿è¡Œå•å…ƒï¼›ä¸æ˜¯æ§åˆ¶å™¨ï¼Œåªæ˜¯å®¹å™¨çš„å°è£…ã€‚\n"},{"id":277,"href":"/operations/kubernetes/kernel-config/","title":"Kubernetes å†…æ ¸é…ç½®","parent":"Kubernetes","content":"ä¸‹é¢æ˜¯ä¸€å¥— ç”Ÿäº§çº§ Kubernetesï¼ˆK8Sï¼‰å®¿ä¸»æœºå†…æ ¸é…ç½®æ€»è¡¨ï¼Œé€‚ç”¨äº AlmaLinux 9 / RHEL 9 / Rocky 9 / CentOS Stream 9ï¼ŒåŒæ—¶è¯´æ˜ ä¸ºä»€ä¹ˆè¦é…ã€å“ªäº›æ˜¯å¿…é¡»ã€å“ªäº›æ˜¯åœºæ™¯å¯é€‰ï¼Œé¿å…â€œç„å­¦è°ƒå‚â€ã€‚\næŒ‰ Kubernetes ä¾èµ–å…³ç³» -\u0026gt; å†…æ ¸å­ç³»ç»Ÿ -\u0026gt; åœºæ™¯åˆ†ç±» æ¥è®²ã€‚\nä¸€ã€Kubernetes å¯¹ Linux å†…æ ¸çš„æ ¸å¿ƒè¦æ±‚ï¼ˆå…ˆç»™ç»“è®ºï¼‰ Kubernetes æœ¬è´¨ä¾èµ–ï¼š\ncgroupsï¼šèµ„æºéš”ç¦»ï¼ˆCPU / å†…å­˜ / IOï¼‰ namespacesï¼šè¿›ç¨‹ / ç½‘ç»œ / æŒ‚è½½éš”ç¦» netfilter / conntrackï¼šService / NAT / Pod ç½‘ç»œ overlayfsï¼šå®¹å™¨é•œåƒ sysctlï¼šç½‘ç»œã€å†…å­˜ã€è¿›ç¨‹æ•°é‡æ§åˆ¶ ğŸ‘‰ æ‰€ä»¥ K8S å†…æ ¸é…ç½® é‡ç‚¹åœ¨ï¼šç½‘ç»œ + å†…å­˜ + cgroups + æ–‡ä»¶å¥æŸ„\näºŒã€Kubernetes å¿…é¡»é…ç½®ï¼ˆä¸é…ä¼šå‡ºé—®é¢˜ï¼‰ 1ï¸âƒ£ ç¦ç”¨ swapï¼ˆå¼ºåˆ¶ï¼‰ Kubernetes ä¸æ”¯æŒ swapï¼ˆé™¤éç‰¹æ®Š kubelet å‚æ•°ï¼‰\nå…³é—­ swap swapoff -a sed -i \u0026#39;/swap/d\u0026#39; /etc/fstab å†…æ ¸å‚æ•° vm.swappiness = 0 åŸå› ï¼š K8S è°ƒåº¦å’Œ QoS ä¾èµ– å†…å­˜å¯é¢„æœŸæ€§ï¼Œswap ä¼šç ´å OOM åˆ¤æ–­\n2ï¸âƒ£ ç½‘ç»œè½¬å‘ï¼ˆå¿…é¡»ï¼‰ net.ipv4.ip_forward = 1 Podã€Serviceã€CNI éƒ½ä¾èµ–\n3ï¸âƒ£ netfilterï¼ˆK8S å®˜æ–¹ç¡¬è¦æ±‚ï¼‰ net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-arptables = 1 å¹¶åŠ è½½æ¨¡å—ï¼š\nmodprobe br_netfilter 4ï¸âƒ£ conntrackï¼ˆéå¸¸å…³é”®ï¼‰ net.netfilter.nf_conntrack_max = 262144 net.netfilter.nf_conntrack_buckets = 65536 ä¸é…ç½®ä¼šå‡ºç°ï¼š\nService è®¿é—®å¼‚å¸¸ NodePort å¶å‘è¶…æ—¶ kube-proxy ä¸ç¨³å®š 5ï¸âƒ£ æ–‡ä»¶å¥æŸ„ \u0026amp; è¿›ç¨‹æ•° fs.file-max = 2097152 kernel.pid_max = 1048576 ä¸‰ã€Kubernetes æ¨èç½‘ç»œå†…æ ¸é…ç½®ï¼ˆç”Ÿäº§ï¼‰ ## TCP é˜Ÿåˆ— net.core.somaxconn = 65535 net.core.netdev_max_backlog = 16384 ## TCP ç¼“å†² net.core.rmem_max = 16777216 net.core.wmem_max = 16777216 ## TIME_WAIT ä¼˜åŒ– net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_fin_timeout = 15 ## ç«¯å£èŒƒå›´ï¼ˆPod é«˜å¹¶å‘ï¼‰ net.ipv4.ip_local_port_range = 1024 65535 å››ã€å†…å­˜ç®¡ç†ï¼ˆK8S éå¸¸æ•æ„Ÿï¼‰ 1ï¸âƒ£ å†…å­˜è¶…åˆ†é…ç­–ç•¥ï¼ˆæ¨èï¼‰ vm.overcommit_memory = 1 é¿å…å®¹å™¨é¢‘ç¹è§¦å‘ OOM Killer\n2ï¸âƒ£ è„é¡µæ§åˆ¶ï¼ˆé˜²æ­¢ I/O æŠ–åŠ¨ï¼‰ vm.dirty_ratio = 20 vm.dirty_background_ratio = 10 vm.dirty_expire_centisecs = 1000 vm.dirty_writeback_centisecs = 100 3ï¸âƒ£ å†…å­˜ç¢ç‰‡ä¸å›æ”¶ vm.zone_reclaim_mode = 0 vm.vfs_cache_pressure = 100 4ï¸âƒ£ max_map_countï¼ˆæŸäº›ç»„ä»¶å¿…é¡»ï¼‰ vm.max_map_count = 262144 Elasticsearch / OpenSearch / some JVM åº”ç”¨\näº”ã€cgroupsï¼ˆK8S å…³é”®ç‚¹ï¼‰ RHEL / AlmaLinux 9 é»˜è®¤ cgroups v2 âœ… kubeletã€containerdã€crio å®Œå…¨æ”¯æŒ ç¡®è®¤ï¼š\nstat -fc %T /sys/fs/cgroup ## cgroup2fs kubelet æ¨èå‚æ•°ï¼ˆä¸æ˜¯ sysctlï¼Œä½†å¾ˆé‡è¦ï¼‰ --cgroup-driver=systemd --runtime-cgroups=/system.slice/containerd.service --kubelet-cgroups=/system.slice/kubelet.service å…­ã€IPv6 ç­–ç•¥ï¼ˆé‡è¦ä½†å®¹æ˜“è¸©å‘ï¼‰ âœ… æ¨èåšæ³•ï¼ˆç”Ÿäº§æœ€ç¨³ï¼‰ ä¸ç¦ç”¨ IPv6 å†…æ ¸ ä¸ä½¿ç”¨ IPv6 ç½‘ç»œ sysctlï¼ˆä¸è¦ç¦ç”¨ IPv6ï¼‰ âŒ ä¸æ¨èï¼š\nnet.ipv6.conf.all.disable_ipv6 = 1 âœ… æ¨èï¼š\näº¤ç»™ CNI / NetworkManager æ§åˆ¶ é¿å… rpcbind / kubelet / systemd socket å¼‚å¸¸ ä¸ƒã€NUMAï¼ˆæ˜¯å¦éœ€è¦ï¼‰ å¤§å¤šæ•° K8S èŠ‚ç‚¹ kernel.numa_balancing = 1 ä»¥ä¸‹æƒ…å†µå¯ä»¥è€ƒè™‘å…³é—­ å• NUMA èŠ‚ç‚¹ æ˜ç¡®ä½¿ç”¨ numactl æ•°æ®åº“è£¸è·‘åœ¨èŠ‚ç‚¹ä¸Š kernel.numa_balancing = 0 æ™®é€š K8S Node ä¸éœ€è¦æ‰‹åŠ¨ numactl\nå…«ã€æ¨è sysctl æ–‡ä»¶ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰ ğŸ‘‰ /etc/sysctl.d/99-kubernetes.conf\n## ---- Kubernetes Core ---- net.ipv4.ip_forward = 1 vm.swappiness = 0 vm.overcommit_memory = 1 ## ---- Netfilter ---- net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-arptables = 1 ## ---- Conntrack ---- net.netfilter.nf_conntrack_max = 262144 net.netfilter.nf_conntrack_buckets = 65536 ## ---- Network ---- net.core.somaxconn = 65535 net.core.netdev_max_backlog = 16384 net.ipv4.ip_local_port_range = 1024 65535 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_fin_timeout = 15 ## ---- Memory ---- vm.max_map_count = 262144 vm.zone_reclaim_mode = 0 vm.vfs_cache_pressure = 100 ## ---- Files / PIDs ---- fs.file-max = 2097152 kernel.pid_max = 1048576 åŠ è½½ï¼š\nsysctl --system ä¹ã€æŒ‰èŠ‚ç‚¹è§’è‰²ç»™å»ºè®® ğŸ§± Master èŠ‚ç‚¹ conntrackï¼šä¸­ç­‰ ç½‘ç»œç¨³å®šä¼˜å…ˆ swap å¿…é¡»å…³ âš™ Worker èŠ‚ç‚¹ conntrack è¦å¤§ æ–‡ä»¶å¥æŸ„è¦é«˜ ç½‘ç»œå‚æ•°æ›´é‡è¦ ğŸ—„ è·‘æ•°æ®åº“çš„ Nodeï¼ˆä¸æ¨èï¼‰ å»ºè®® ç‹¬ç«‹èŠ‚ç‚¹ æ˜ç¡® CPU / å†…å­˜ç»‘æ ¸ ä¸å»ºè®®ä¸æ™®é€š Pod æ··ç”¨ åã€æ€»ç»“ Kubernetes å†…æ ¸é…ç½®çš„æ ¸å¿ƒç›®æ ‡ä¸æ˜¯â€œè·‘å¾—å¿«â€ï¼Œè€Œæ˜¯ï¼šç½‘ç»œç¨³å®šã€å†…å­˜å¯é¢„æµ‹ã€èµ„æºå¯æ§ã€è¡Œä¸ºä¸€è‡´ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€å¥— ç”Ÿäº§çº§ Kubernetesï¼ˆK8Sï¼‰å®¿ä¸»æœºå†…æ ¸é…ç½®æ€»è¡¨ï¼Œé€‚ç”¨äº AlmaLinux 9 / RHEL 9 / Rocky 9 / CentOS Stream 9ï¼ŒåŒæ—¶è¯´æ˜ ä¸ºä»€ä¹ˆè¦é…ã€å“ªäº›æ˜¯å¿…é¡»ã€å“ªäº›æ˜¯åœºæ™¯å¯é€‰ï¼Œé¿å…â€œç„å­¦è°ƒå‚â€ã€‚\næŒ‰ Kubernetes ä¾èµ–å…³ç³» -\u0026gt; å†…æ ¸å­ç³»ç»Ÿ -\u0026gt; åœºæ™¯åˆ†ç±» æ¥è®²ã€‚\nä¸€ã€Kubernetes å¯¹ Linux å†…æ ¸çš„æ ¸å¿ƒè¦æ±‚ï¼ˆå…ˆç»™ç»“è®ºï¼‰ Kubernetes æœ¬è´¨ä¾èµ–ï¼š\ncgroupsï¼šèµ„æºéš”ç¦»ï¼ˆCPU / å†…å­˜ / IOï¼‰ namespacesï¼šè¿›ç¨‹ / ç½‘ç»œ / æŒ‚è½½éš”ç¦» netfilter / conntrackï¼šService / NAT / Pod ç½‘ç»œ overlayfsï¼šå®¹å™¨é•œåƒ sysctlï¼šç½‘ç»œã€å†…å­˜ã€è¿›ç¨‹æ•°é‡æ§åˆ¶ ğŸ‘‰ æ‰€ä»¥ K8S å†…æ ¸é…ç½® é‡ç‚¹åœ¨ï¼šç½‘ç»œ + å†…å­˜ + cgroups + æ–‡ä»¶å¥æŸ„\n"},{"id":278,"href":"/operations/kubernetes/command/","title":"Kubernetes å¸¸ç”¨å‘½ä»¤","parent":"Kubernetes","content":"æœ€å®Œæ•´ã€æœ€å®ç”¨ã€æŒ‰åœºæ™¯åˆ†ç±»çš„ Kubernetes å¸¸ç”¨å‘½ä»¤å¤§å…¨\nè¦†ç›–ï¼šPodã€Deploymentã€Serviceã€Eventsã€è°ƒåº¦ã€ç½‘ç»œã€æ—¥å¿—ã€èŠ‚ç‚¹ã€å·ã€é›†ç¾¤ã€æ’éšœã€å¸¸ç”¨è„šæœ¬åŒ–æŠ€å·§ç­‰ã€‚\né€‚ç”¨ Kubernetes â‰¥ 1.33ï¼ˆå‘ä¸‹å…¼å®¹ 1.20+ï¼‰\n1. é›†ç¾¤ä¿¡æ¯ æŸ¥çœ‹é›†ç¾¤ç‰ˆæœ¬\nkubectl version --short æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡\nkubectl config current-context æŸ¥çœ‹ contexts\nkubectl config get-contexts åˆ‡æ¢ context\nkubectl config use-context my-context 2. Namespace æ“ä½œ æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´\nkubectl get ns åˆ›å»º namespace\nkubectl create ns dev åˆ é™¤ namespace\nkubectl delete ns dev 3. Pod æ“ä½œ æŸ¥çœ‹ Pod\nkubectl get pods kubectl get pods -A kubectl get pods -o wide æŸ¥çœ‹å¸¦ label çš„ Pod\nkubectl get pods -l app=myapp æŸ¥çœ‹ Pod è¯¦æƒ…\nkubectl describe pod pod-name æŸ¥çœ‹ Pod YAML\nkubectl get pod pod-name -o yaml å¼ºåˆ¶åˆ é™¤ Podï¼ˆå¼ºåˆ¶è·³è¿‡ gracefulï¼‰\nkubectl delete pod pod-name --force --grace-period=0 è¿›å…¥ Pod å®¹å™¨\nkubectl exec -it pod-name -- sh kubectl exec -it pod-name -c container -- bash æŸ¥çœ‹ Pod å†…æ–‡ä»¶\nkubectl exec pod-name -- ls /etc Pod æ—¥å¿—\nkubectl logs pod-name kubectl logs -f pod-name kubectl logs pod-name -c container æŸ¥çœ‹ä¸Šä¸€ä¸ªå´©æºƒæ—¥å¿—\nkubectl logs pod-name --previous 4. Deployment / DaemonSet / StatefulSet æ“ä½œ æŸ¥çœ‹ Deployment\nkubectl get deploy kubectl describe deploy myapp æ›´æ–°é•œåƒ\nkubectl set image deploy/myapp myapp=nginx:1.21 æ»šåŠ¨æ›´æ–°çŠ¶æ€\nkubectl rollout status deploy/myapp å›æ»š\nkubectl rollout undo deploy/myapp æŒ‡å®šç‰ˆæœ¬å›æ»š\nkubectl rollout undo deploy/myapp --to-revision=3 æš‚åœ/ç»§ç»­æ›´æ–°\nkubectl rollout pause deploy/myapp kubectl rollout resume deploy/myapp æŸ¥çœ‹å†å²è®°å½•\nkubectl rollout history deploy/myapp 5. Service / Ingress æŸ¥çœ‹ Service\nkubectl get svc kubectl describe svc myapp æŸ¥çœ‹ Endpoints\nkubectl get endpoints æŸ¥çœ‹ Ingress\nkubectl get ingress kubectl describe ingress myapp 6. Node æ“ä½œ æŸ¥çœ‹èŠ‚ç‚¹\nkubectl get nodes -o wide æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾\nkubectl get nodes --show-labels ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾\nkubectl label node node1 env=prod åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾\nkubectl label node node1 env- ç»™ node æ‰“ taint\nkubectl taint nodes node1 key=value:NoSchedule åˆ é™¤ taint\nkubectl taint nodes node1 key- 7. Label \u0026amp; Annotation æ·»åŠ /æ›´æ–° label\nkubectl label pod mypod version=v1 --overwrite åˆ é™¤ label\nkubectl label pod mypod version- æ·»åŠ  annotation\nkubectl annotate pod mypod description=\u0026#34;hello\u0026#34; 8. è°ƒåº¦ä¸å¯ç”¨æ€§ æŸ¥çœ‹ Pod è°ƒåº¦æƒ…å†µ\nkubectl get events --sort-by=\u0026#39;.metadata.creationTimestamp\u0026#39; æŸ¥çœ‹ Pod åœ¨å“ªä¸ªèŠ‚ç‚¹\nkubectl get pod -o wide æŸ¥çœ‹ Scheduler æ—¥å¿—ï¼ˆå–å†³äºä½ çš„é›†ç¾¤ï¼‰\njournalctl -u kube-scheduler -f 9. ConfigMap / Secret æŸ¥çœ‹\nkubectl get configmap kubectl get secret æŸ¥çœ‹ details\nkubectl describe configmap myconfig ä»¥ YAML è¾“å‡º\nkubectl get secret mysecret -o yaml 10. å®¹å™¨è°ƒè¯• åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Pod è°ƒè¯•\nkubectl run debug --rm -it --image=busybox -- sh Debug è¿›å…¥å®¹å™¨ namespaceï¼ˆK8S 1.18+ï¼‰\nkubectl debug pod-name -it --image=busybox 11. èµ„æºåº”ç”¨ä¸åˆ é™¤ åº”ç”¨ YAML\nkubectl apply -f app.yaml åˆ é™¤ YAML\nkubectl delete -f app.yaml å…ˆ dry-run æ£€æŸ¥\nkubectl apply -f app.yaml --dry-run=client 12. äº‹ä»¶ä¸è¯Šæ–­ æŸ¥çœ‹ Pod äº‹ä»¶\nkubectl get events -A --sort-by=\u0026#39;.metadata.creationTimestamp\u0026#39; æ’æŸ¥ Pod å¤±è´¥\nkubectl describe pod pod-name kubectl logs pod-name --previous æŸ¥çœ‹èµ„æºå ç”¨\nkubectl top pod -A kubectl top node 13. ç®€åŒ–å­—æ®µæ˜¾ç¤º è‡ªå®šä¹‰åˆ—\nkubectl get pods -o custom-columns=NAME:.metadata.name,IP:.status.podIP ä½¿ç”¨ jsonpath\nkubectl get pod mypod -o jsonpath=\u0026#39;{.status.podIP}\u0026#39; 14. K8S çŸ­å‘½ä»¤ï¼ˆåˆ«åï¼‰ æ¨èæ·»åŠ åˆ° ~/.bashrcï¼š\nalias k=kubectl alias kgp=\u0026#39;kubectl get pods\u0026#39; alias kgs=\u0026#39;kubectl get svc\u0026#39; alias kga=\u0026#39;kubectl get all\u0026#39; alias kdp=\u0026#39;kubectl describe pod\u0026#39; 15. æ—¥å¿—ã€èµ„æºå’Œäº‹ä»¶ä¸‰ä»¶å¥—ï¼ˆæ’éšœæœ€å¸¸ç”¨ï¼‰ kubectl describe pod myapp-xxx kubectl logs myapp-xxx kubectl get events --sort-by=.metadata.creationTimestamp 16. å¼ºåˆ¶é‡å¯ Deploymentï¼ˆå¸¸ç”¨è„šæœ¬å‘½ä»¤ï¼‰ kubectl rollout restart deploy/myapp 17. è‡ªåŠ¨è¡¥å…¨ï¼ˆå»ºè®®å¼€å¯ï¼‰ source \u0026lt;(kubectl completion bash) 18. ä½¿ç”¨ label è¿‡æ»¤ Service / Pod / Node æŸ¥æ‰¾ app=myapp çš„ Pod\nkubectl get pods -l app=myapp æŸ¥æ‰¾ env=prod çš„èŠ‚ç‚¹\nkubectl get nodes -l env=prod 19. ç«¯å£æ˜ å°„ï¼ˆè°ƒè¯•éå¸¸å¸¸ç”¨ï¼‰ kubectl port-forward pod/myapp 8080:80 kubectl port-forward svc/myapp 8080:80 20. æŸ¥çœ‹ Workload å…³ç³»å›¾ Pod -\u0026gt; Deployment -\u0026gt; ReplicaSet\nkubectl get pod myapp-xxxx -o jsonpath=\u0026#39;{.metadata.ownerReferences}\u0026#39; 21. æ¸…ç†æ— ç”¨èµ„æº åˆ é™¤ Completed çš„ Job\nkubectl delete job --field-selector status.successful=1 æ¸…ç†ä¸æ­£å¸¸çš„ pod\nkubectl delete pod -A --field-selector=status.phase=Failed 22. API èµ„æºä¸ç‰ˆæœ¬ æŸ¥çœ‹æ‰€æœ‰èµ„æºç±»å‹\nkubectl api-resources æŸ¥çœ‹æŸèµ„æºçš„ API ç‰ˆæœ¬\nkubectl explain deployment ","description":"æœ€å®Œæ•´ã€æœ€å®ç”¨ã€æŒ‰åœºæ™¯åˆ†ç±»çš„ Kubernetes å¸¸ç”¨å‘½ä»¤å¤§å…¨\nè¦†ç›–ï¼šPodã€Deploymentã€Serviceã€Eventsã€è°ƒåº¦ã€ç½‘ç»œã€æ—¥å¿—ã€èŠ‚ç‚¹ã€å·ã€é›†ç¾¤ã€æ’éšœã€å¸¸ç”¨è„šæœ¬åŒ–æŠ€å·§ç­‰ã€‚\né€‚ç”¨ Kubernetes â‰¥ 1.33ï¼ˆå‘ä¸‹å…¼å®¹ 1.20+ï¼‰\n1. é›†ç¾¤ä¿¡æ¯ æŸ¥çœ‹é›†ç¾¤ç‰ˆæœ¬\nkubectl version --short æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡\nkubectl config current-context æŸ¥çœ‹ contexts\nkubectl config get-contexts åˆ‡æ¢ context\nkubectl config use-context my-context 2. Namespace æ“ä½œ æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´\n"},{"id":279,"href":"/operations/kubernetes/architecture/","title":"Kubernetes åº”ç”¨æ¶æ„ä»¥åŠéƒ¨ç½²","parent":"Kubernetes","content":"Kubernetes é›†ç¾¤\næ­å»º etcd é›†ç¾¤ åˆ›å»º Control Planeï¼ˆæ§åˆ¶å¹³é¢ï¼‰ æ·»åŠ  Nodeï¼ˆèŠ‚ç‚¹ï¼‰ æ·»åŠ  Control Planeï¼ˆåŒèŠ‚ç‚¹ï¼Œé«˜å¯ç”¨ï¼‰ æ·»åŠ  VIP -\u0026gt; Control Plane APIï¼ˆé«˜å¯ç”¨ï¼‰ ç®¡ç† Labelï¼ˆåº”ç”¨ç¨‹åºéƒ¨ç½²è§„åˆ’ï¼‰ éƒ¨ç½² Workload ç›‘æ§ Nginx + IPVS æ›¿ä»£ Ingress / Gateway API\n","description":"Kubernetes é›†ç¾¤\næ­å»º etcd é›†ç¾¤ åˆ›å»º Control Planeï¼ˆæ§åˆ¶å¹³é¢ï¼‰ æ·»åŠ  Nodeï¼ˆèŠ‚ç‚¹ï¼‰ æ·»åŠ  Control Planeï¼ˆåŒèŠ‚ç‚¹ï¼Œé«˜å¯ç”¨ï¼‰ æ·»åŠ  VIP -\u0026gt; Control Plane APIï¼ˆé«˜å¯ç”¨ï¼‰ ç®¡ç† Labelï¼ˆåº”ç”¨ç¨‹åºéƒ¨ç½²è§„åˆ’ï¼‰ éƒ¨ç½² Workload ç›‘æ§ Nginx + IPVS æ›¿ä»£ Ingress / Gateway API\n"},{"id":280,"href":"/operations/kubernetes/troubleshooting/","title":"Kubernetes æ•…éšœæ’æŸ¥","parent":"Kubernetes","content":" ğŸ§¨ Kubernetes æ•…éšœæ’æŸ¥æ€»çº²ï¼ˆSOPï¼‰ æ’æŸ¥é¡ºåºï¼šè‡ªä¸Šè€Œä¸‹ / ç”±å¤–å‘å†… / å…ˆçœ‹äº‹ä»¶ã€å†æŸ¥æ—¥å¿—ã€æœ€åè¿›å®¹å™¨ã€‚\nèµ„æºçŠ¶æ€ -\u0026gt; kubectl get äº‹ä»¶è®°å½• -\u0026gt; kubectl describe Pod æ—¥å¿— -\u0026gt; kubectl logs Node çŠ¶æ€ -\u0026gt; kubectl get nodes Kubelet æ—¥å¿— -\u0026gt; systemctl / journalctl å®¹å™¨è¿è¡Œæ—¶ -\u0026gt; crictl CNI ç½‘ç»œ -\u0026gt; Calico / iptables / routes å­˜å‚¨ -\u0026gt; PV / PVC / StorageClass ğŸš¦ ç¬¬ä¸€ç±»ï¼šPod å¯åŠ¨ä¸äº†ï¼ˆPending / ImagePullBackOff / CrashLoopBackOffï¼‰ 1.1 Pod Pending åŸå› åˆ†ç±»\nç±»å‹ å…¸å‹äº‹ä»¶ è§£å†³åŠæ³• æ²¡èŠ‚ç‚¹å¯è°ƒåº¦ 0/3 nodes available æ£€æŸ¥ taintã€èµ„æºã€æ±¡ç‚¹ PVC ç»‘å®šå¤±è´¥ no persistent volumes found ä¿® storageClass NodeSelector ä¸åŒ¹é… node(s) didn\u0026rsquo;t match node selector æ”¹ selector æ ¸å¿ƒæ’æŸ¥å‘½ä»¤\nkubectl describe pod \u0026lt;pod\u0026gt; kubectl get nodes -owide kubectl describe node \u0026lt;node\u0026gt; 2.2 ImagePullBackOff / ErrImagePull æ’æŸ¥å‘½ä»¤\nkubectl describe pod \u0026lt;pod\u0026gt; | grep -i image å¸¸è§åŸå› \nåŸå›  æ£€æŸ¥ç‚¹ é•œåƒä¸å­˜åœ¨ image åå­—æ‹¼é”™ tag ä¸å­˜åœ¨ latest ä¸å¯æ§ registry è®¤è¯å¤±è´¥ secret ä¸å¯¹ proxy æ‹¦æˆª ç½‘ç»œé˜²ç«å¢™ è§£å†³\nkubectl create secret docker-registry mysecret ... kubectl set image deploy/myapp myapp=repo/image:v1 2.3 CrashLoopBackOff æ’æŸ¥å‘½ä»¤\nkubectl logs \u0026lt;pod\u0026gt; -p æŸ¥çœ‹ä¸Šä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼ˆCrashLoop å¿…é¡»çœ‹ -pï¼‰ã€‚ å¦‚æœè¿˜çœ‹ä¸åˆ° -\u0026gt; å¯åŠ¨å‘½ä»¤é”™è¯¯ã€‚\né‡ç‚¹æ£€æŸ¥\nentrypoint / command å†™é”™ ç¨‹åºå¯åŠ¨åç«‹å³é€€å‡º configs / secrets æŒ‚è½½å¤±è´¥ readinessProbe / livenessProbe å¼ºæ€ ğŸš§ ç¬¬äºŒç±»ï¼šPod è¿è¡Œä¸ç¨³å®šï¼ˆOOMKilled / Evicted / é‡å¯è¿‡å¤šï¼‰ 2.1 OOMKilled kubectl describe pod \u0026lt;pod\u0026gt; | grep -i oom åŸå› ï¼š\nå®¹å™¨å†…å­˜çˆ†äº†ï¼Œè¢« kubelet cgroup æ€æ‰ è§£å†³ï¼š\næé«˜ resources.limits.memory ä¼˜åŒ–åº”ç”¨å†…å­˜ 2.2 Evictedï¼ˆé©±é€ï¼‰ kubectl describe pod \u0026lt;pod\u0026gt; | grep -i evict kubectl get nodes -owide åŸå› ï¼š\nèŠ‚ç‚¹ç£ç›˜æ»¡äº†ï¼ˆæœ€å¸¸è§ï¼‰ èŠ‚ç‚¹å†…å­˜å‹åŠ› èŠ‚ç‚¹ PID ä¸å¤Ÿ è§£å†³ï¼š\ndf -h du -sh /var/lib/containerd journalctl --vacuum-size=500M 2.3 å®¹å™¨ä¸€ç›´è¢« kubelet æ€æ‰ / é‡å¯ æ£€æŸ¥ probeï¼š\nkubectl describe pod \u0026lt;pod\u0026gt; | grep -A5 -i probe ğŸ•¸ ç¬¬ä¸‰ç±»ï¼šç½‘ç»œé—®é¢˜ï¼ˆæœ€å¸¸è§ï¼‰ ğŸŒ 3.1 Pod æ— æ³•äº’ç›¸è®¿é—® æ’æŸ¥é¡ºåºï¼š\nStep 1ï¼šæ£€æŸ¥ Pod IP kubectl get pods -owide Step 2ï¼šNode ä¸Šæ£€æŸ¥è·¯ç”± ip route Step 3ï¼šCalico æ£€æŸ¥ calicoctl get nodes calicoctl get ipPool Step 4ï¼šæ£€æŸ¥ CNI ç›®å½• ls /etc/cni/net.d/ ğŸŒ 3.2 Pod è®¿é—® Service å¤±è´¥ï¼ˆClusterIP å¤±æ•ˆï¼‰ æ£€æŸ¥ kube-proxyï¼š\nkubectl get pods -n kube-system -l k8s-app=kube-proxy kubectl logs -n kube-system kube-proxy-xxxxx æ£€æŸ¥ ipvsï¼š\nipvsadm -Ln çœ‹ service ç«¯å£æ˜¯å¦å­˜åœ¨ã€‚\nğŸŒ 3.3 NodePort æ— æ³•è®¿é—® Checklistï¼š\næœåŠ¡ listen ç«¯å£æ˜¯å¦å­˜åœ¨ kube-proxy ipvs æ˜¯å¦æœ‰è®°å½• èŠ‚ç‚¹é˜²ç«å¢™æ˜¯å¦å…è®¸ç«¯å£ Pod æ˜¯å¦ ready éªŒè¯ï¼š\ncurl -v http://node-ip:\u0026lt;nodeport\u0026gt; ğŸŒ 3.4 DNSï¼ˆCoreDNSï¼‰å¼‚å¸¸ æ ¸æŸ¥ CoreDNS çŠ¶æ€\nkubectl -n kube-system get pods -l k8s-app=kube-dns kubectl logs -n kube-system coredns-xxxx å¸¸è§æŠ¥é”™ï¼š\nSERVFAIL -\u0026gt; ä¸Šæ¸¸ DNS ä¸é€š loop detected -\u0026gt; nodeLocalDNS é…ç½®é”™è¯¯ connection refused -\u0026gt; Pod æ—  network ğŸ§± ç¬¬å››ç±»ï¼šèŠ‚ç‚¹é—®é¢˜ï¼ˆNode NotReady / Kubelet å¼‚å¸¸ï¼‰ 4.1 èŠ‚ç‚¹ NotReady / Unknown kubectl describe node \u0026lt;node\u0026gt; å¸¸è§åŸå› ï¼š\nkubelet æŒ‚äº† containerd æŒ‚äº† CNI ç›®å½•ä¸¢å¤± ç£ç›˜æ»¡ æ£€æŸ¥ systemdï¼š\nsystemctl status kubelet journalctl -u kubelet -f æ£€æŸ¥ containerdï¼š\nsystemctl status containerd crictl ps 4.2 Kubelet æŠ¥é”™ï¼šcgroup é©±åŠ¨ä¸ä¸€è‡´ journalctl -u kubelet | grep cgroup è§£å†³ï¼škubelet å’Œ containerd éƒ½è¦ç”¨ systemd\nğŸ§© ç¬¬äº”ç±»ï¼šå­˜å‚¨å¼‚å¸¸ï¼ˆPVC Pending / Mount å¤±è´¥ï¼‰ 5.1 PVC Pending kubectl get pvc kubectl describe pvc \u0026lt;pvc\u0026gt; kubectl get sc åŸå› ï¼š\næ²¡æœ‰é»˜è®¤ storageClass å·æ’ä»¶ä¸å¯ç”¨ 5.2 Mount Volume å¤±è´¥ kubectl describe pod \u0026lt;pod\u0026gt; | grep -i mount å…¸å‹é—®é¢˜ï¼š\nNFS æœåŠ¡ä¸é€š Ceph keyring é”™è¯¯ ä¸»æœºè·¯å¾„æƒé™ä¸å¯¹ ğŸ“¡ ç¬¬å…­ç±»ï¼šService / Ingress æ•…éšœ Ingress è®¿é—®å¤±è´¥\næ£€æŸ¥ ingress podï¼š\nkubectl get pods -n ingress-nginx kubectl logs -n ingress-nginx ingress-nginx-controller-xxxxx æ£€æŸ¥ ingress è§„åˆ™ï¼š\nkubectl describe ingress my-ing æ£€æŸ¥ backendï¼š\nkubectl get endpoints å¦‚æœ endpoints ä¸ºç©º -\u0026gt; Service selector é”™è¯¯ã€‚\nğŸ§± ç¬¬ä¸ƒç±»ï¼šAPI Server æ— å“åº” / è¯ä¹¦é—®é¢˜ 7.1 kubectl å¡ä½ / 503 / connection refused journalctl -u kube-apiserver -f å¸¸è§åŸå› \napiserver è¯ä¹¦è¿‡æœŸ apiserver è¿›ç¨‹OOM etcd ä¸å¯ç”¨ æ£€æŸ¥è¯ä¹¦ï¼š\nopenssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -enddate ğŸ—„ ç¬¬å…«ç±»ï¼šetcd æ•…éšœï¼ˆæœ€å±é™©ï¼‰ 8.1 etcd åœæ­¢å“åº” systemctl status etcd journalctl -u etcd -f 8.2 etcd å¥åº·æ£€æŸ¥ ETCDCTL_API=3 etcdctl --endpoints=https://IP:2379 endpoint health 8.3 etcd ç©ºé—´è€—å°½ etcdctl alarm list æ¸…ç†ï¼š\netcdctl alarm disarm etcdctl defrag ğŸ”§ ç¬¬ä¹ç±»ï¼šcrictl å®¹å™¨æ’é”™ 9.1 æŸ¥çœ‹å®¹å™¨åˆ—è¡¨ crictl ps -a 9.2 æŸ¥çœ‹å®¹å™¨æ—¥å¿— crictl logs \u0026lt;container-id\u0026gt; 9.3 æŸ¥çœ‹é•œåƒ crictl images 9.4 åˆ é™¤é•œåƒ crictl rmi $(crictl images | awk \u0026#39;/\u0026lt;none\u0026gt;/{print $3}\u0026#39;) ğŸ§¨ ç¬¬åç±»ï¼šé«˜æ•ˆé€šç”¨æ’æŸ¥å‘½ä»¤ï¼ˆå¿…é¡»èƒŒï¼‰ kubectl get events --sort-by=.metadata.creationTimestamp kubectl describe pod \u0026lt;pod\u0026gt; kubectl logs \u0026lt;pod\u0026gt; -p kubectl get endpoints kubectl exec -it \u0026lt;pod\u0026gt; -- sh kubectl get nodes -owide kubectl describe node \u0026lt;node\u0026gt; ipvsadm -Ln ip route systemctl status kubelet journalctl -u kubelet -f crictl ps -a crictl logs \u0026lt;id\u0026gt; df -h dmesg | tail ","description":" ğŸ§¨ Kubernetes æ•…éšœæ’æŸ¥æ€»çº²ï¼ˆSOPï¼‰ æ’æŸ¥é¡ºåºï¼šè‡ªä¸Šè€Œä¸‹ / ç”±å¤–å‘å†… / å…ˆçœ‹äº‹ä»¶ã€å†æŸ¥æ—¥å¿—ã€æœ€åè¿›å®¹å™¨ã€‚\nèµ„æºçŠ¶æ€ -\u0026gt; kubectl get äº‹ä»¶è®°å½• -\u0026gt; kubectl describe Pod æ—¥å¿— -\u0026gt; kubectl logs Node çŠ¶æ€ -\u0026gt; kubectl get nodes Kubelet æ—¥å¿— -\u0026gt; systemctl / journalctl å®¹å™¨è¿è¡Œæ—¶ -\u0026gt; crictl CNI ç½‘ç»œ -\u0026gt; Calico / iptables / routes å­˜å‚¨ -\u0026gt; PV / PVC / StorageClass ğŸš¦ ç¬¬ä¸€ç±»ï¼šPod å¯åŠ¨ä¸äº†ï¼ˆPending / ImagePullBackOff / CrashLoopBackOffï¼‰ 1.1 Pod Pending åŸå› åˆ†ç±»\n"},{"id":281,"href":"/operations/kubernetes/classic-issues/","title":"Kubernetes ç»å…¸é—®é¢˜","parent":"Kubernetes","content":"Redis æœ‰ä¸‰å¤§ç¼“å­˜é—®é¢˜\nï¼ˆå…ˆå¯¹é½è®¤çŸ¥ï¼‰\nç¼“å­˜ç©¿é€ ç¼“å­˜å‡»ç©¿ ç¼“å­˜é›ªå´© ğŸ‘‰ æœ¬è´¨ï¼šé«˜å¹¶å‘ + ä¾èµ–å…³ç³» + ç¬æ—¶æ”¾å¤§æ•ˆåº”\nKubernetes æœ‰å“ªäº›â€œå…¸å‹ç³»ç»Ÿæ€§é—®é¢˜â€ï¼Ÿ\nKubernetes çš„é—®é¢˜ä¸åœ¨â€œåŠŸèƒ½ä¸å…¨â€ï¼Œè€Œåœ¨ è§„æ¨¡åŒ– + è‡ªåŠ¨åŒ– + åˆ†å¸ƒå¼å¸¦æ¥çš„æ”¾å¤§æ•ˆåº”ã€‚\nä¸€ã€Kubernetes ä¸‰å¤§â€œåŸºç¡€æ€§é—®é¢˜â€ 1ï¸âƒ£ æ§åˆ¶å¹³é¢ç“¶é¢ˆé—®é¢˜ï¼ˆAPI Server é£æš´ï¼‰ ğŸ“Œ ç°è±¡ é›†ç¾¤ä¸€åˆ‡æ“ä½œå˜æ…¢ kubectl å¡é¡¿ Pod åˆ›å»ºå»¶è¿Ÿå·¨å¤§ HPA / Controller å¤±æ•ˆ ğŸ“Œ æ ¹å›  kube-apiserver æ˜¯å”¯ä¸€å…¥å£ watch/list å¤ªå¤š æ§åˆ¶å™¨ã€Operatorã€CRD è¿‡å¤š é«˜é¢‘ List è€Œä¸æ˜¯ Watch ğŸ“Œ æ”¾å¤§æ•ˆåº” ä¸€ä¸ªç»„ä»¶å¼‚å¸¸ -\u0026gt; è§¦å‘å¤§é‡é‡è¯• -\u0026gt; API Server è¢«æ‰“çˆ†\nğŸ“Œ å…¸å‹åœºæ™¯ å¤§è§„æ¨¡é›†ç¾¤ï¼ˆ\u0026gt;1000 Nodeï¼‰ CRD/Operator æ»¥ç”¨ è‡ªç ”æ§åˆ¶å™¨å†™å¾—ä¸è§„èŒƒ #### ğŸ“Œ è§£å†³æ€è·¯ å¯ç”¨ APIServer ç¼“å­˜ åˆç†æ‹†åˆ†é›†ç¾¤ ä¼˜åŒ–æ§åˆ¶å™¨ Watch è¡Œä¸º é™åˆ¶ QPS / Burst ğŸ“Œ ç±»æ¯” Redis ğŸ‘‰ ç¼“å­˜é›ªå´©ï¼ˆæµé‡é›†ä¸­æ‰“åˆ°åç«¯ï¼‰\n2ï¸âƒ£ è°ƒåº¦ä¸èµ„æºå¤±çœŸé—®é¢˜ï¼ˆèµ„æºçœ‹å¾—è§ï¼Œç”¨ä¸åˆ°ï¼‰ ğŸ“Œ ç°è±¡ Node è¿˜æœ‰èµ„æºï¼Œä½† Pod Pending èµ„æºç¢ç‰‡ä¸¥é‡ HPA æ‰©å®¹å¤±è´¥ ğŸ“Œ æ ¹å›  requests / limits é…ç½®ä¸åˆç† Binpack å¯¼è‡´ç¢ç‰‡ èŠ‚ç‚¹å¼‚æ„ï¼ˆCPU / NUMA / GPUï¼‰ ğŸ“Œ å…¸å‹é”™è¯¯ resources: requests: cpu: \u0026#34;4\u0026#34; memory: \u0026#34;8Gi\u0026#34; ğŸ‘‰ å®é™…åªç”¨ 0.5C\nğŸ“Œ åæœ èµ„æºåˆ©ç”¨ç‡ä½ æ‰©å®¹æˆæœ¬æš´æ¶¨ ğŸ“Œ è§£å†³æ€è·¯ ç²¾å‡† requests VPA / æ¨èå·¥å…· Pod æ‹†åˆ† åˆç† Node Pool ğŸ“Œ ç±»æ¯” Redis ğŸ‘‰ ç¼“å­˜å‡»ç©¿ï¼ˆçƒ­ç‚¹ key èµ„æºè¢«é”æ­»ï¼‰\n3ï¸âƒ£ ç½‘ç»œå¤æ‚æ€§ä¸æ’é”™å›°éš¾ï¼ˆçœ‹ä¸è§çš„é»‘ç›’ï¼‰ ğŸ“Œ ç°è±¡ Pod äº’ç›¸ ping ä¸é€š Service æ­£å¸¸ï¼Œè®¿é—®å¤±è´¥ Node é—´é€šä¿¡å¼‚å¸¸ NetworkPolicy ç”Ÿæ•ˆå¼‚å¸¸ ğŸ“Œ æ ¹å›  CNI å¤æ‚ï¼ˆiptables / ipvs / eBPFï¼‰ Overlay ç½‘ç»œ NAT å¤šå±‚ å¤šç»„ä»¶ååŒï¼ˆkube-proxy + CNIï¼‰ ğŸ“Œ ç‰¹ç‚¹ é—®é¢˜ä¸ç¨³å®š é‡å¯å¯èƒ½â€œå¥½äº†â€ éš¾å¤ç° ğŸ“Œ è§£å†³æ€è·¯ ç½‘ç»œå¯è§‚æµ‹æ€§ ç»Ÿä¸€ CNI ä½¿ç”¨ eBPFï¼ˆCalico eBPF / Ciliumï¼‰ ğŸ“Œ ç±»æ¯” Redis ğŸ‘‰ ç¼“å­˜ç©¿é€ï¼ˆè¯·æ±‚è·¯å¾„ä¸å¯æ§ï¼‰\näºŒã€Kubernetes ä¸‰å¤§â€œè¿ç»´çº§é—®é¢˜â€ï¼ˆç”Ÿäº§å¸¸è§ï¼‰ 4ï¸âƒ£ etcd é£é™©ï¼ˆå•ç‚¹ \u0026amp; æ”¾å¤§å™¨ï¼‰ ğŸ“Œ ç°è±¡ é›†ç¾¤æ•´ä½“å¼‚å¸¸ æ‰€æœ‰æ“ä½œå¤±è´¥ ğŸ“Œ æ ¹å›  etcd æ˜¯å”¯ä¸€çŠ¶æ€æº IOPS / ç£ç›˜ / å»¶è¿Ÿæ•æ„Ÿ ç£ç›˜æ»¡ç›´æ¥å†™å¤±è´¥ ğŸ“Œ è§£å†³ SSD å®šæœŸ compaction ç›‘æ§ db size å¤šå‰¯æœ¬ 5ï¸âƒ£ æ»šåŠ¨å‡çº§ â‰  æ— æ„Ÿå‡çº§ ğŸ“Œ è¯¯åŒº Deployment rolling update = ä¸šåŠ¡æ— æ„Ÿ\nğŸ“Œ çœŸå®æƒ…å†µ readiness é…ç½®é”™è¯¯ è¿æ¥è¢«ä¸­æ–­ è´Ÿè½½çªå¢ ğŸ“Œ è§£å†³ æ­£ç¡®æ¢é’ˆ preStop maxUnavailable æ§åˆ¶ 6ï¸âƒ£ è‡ªåŠ¨åŒ–çš„â€œé”™è¯¯æ”¾å¤§â€ ğŸ“Œ ç°è±¡ é…ç½®é”™è¯¯ -\u0026gt; å…¨é›†ç¾¤ä¼ æ’­ Operator bug -\u0026gt; å¤§è§„æ¨¡äº‹æ•… ğŸ“Œ æœ¬è´¨ Kubernetes æ˜¯ä¸€ä¸ª é”™è¯¯æ”¾å¤§å™¨\nğŸ“Œ è§£å†³ ç°åº¦ å‘½åç©ºé—´éš”ç¦» Admission æ ¡éªŒ GitOps ä¸‰ã€Kubernetes çš„â€œéšæ€§ä¸‰å¤§å‘â€ï¼ˆé«˜çº§ï¼‰ 7ï¸âƒ£ å¯è§‚æµ‹æ€§ç¼ºå¤± æŒ‡æ ‡å¤šä½†ä¸å®Œæ•´ æ—¥å¿—åˆ†æ•£ Trace å›°éš¾ ğŸ‘‰ æ²¡æœ‰å¯è§‚æµ‹æ€§ = ç›²é£\n8ï¸âƒ£ å¤šç§Ÿæˆ·ä¸æƒé™å¤æ‚åº¦ RBAC éš¾ç†è§£ Namespace ä¸æ˜¯å®‰å…¨è¾¹ç•Œ ç½‘ç»œã€å­˜å‚¨éš”ç¦»ä¸å¤©ç„¶ 9ï¸âƒ£ å­¦ä¹ æˆæœ¬ä¸è®¤çŸ¥é”™ä½ ğŸ“Œ å¸¸è§è¯¯åŒºï¼š\nâ€œå­¦ä¼š kubectl = ä¼š Kubernetesâ€ â€œPod è·‘èµ·æ¥å°±ç®—ç¨³å®šâ€ â€œåŠ å‰¯æœ¬å°±èƒ½æŠ—æµé‡â€ å››ã€æ€»ç»“ Redis çš„é—®é¢˜æ˜¯ é«˜å¹¶å‘ç¼“å­˜å¤±æ•ˆçš„ç¬æ—¶å†²å‡»ï¼Œ\nKubernetes çš„é—®é¢˜æ˜¯ è‡ªåŠ¨åŒ–ã€è§„æ¨¡åŒ–ä¸‹çš„ç³»ç»Ÿæ€§æ”¾å¤§æ•ˆåº”ï¼š\næ§åˆ¶é¢ç“¶é¢ˆã€èµ„æºå¤±çœŸã€ç½‘ç»œå¤æ‚æ€§ã€çŠ¶æ€ä¸­å¿ƒï¼ˆetcdï¼‰é£é™©ã€‚\n","description":"Redis æœ‰ä¸‰å¤§ç¼“å­˜é—®é¢˜\nï¼ˆå…ˆå¯¹é½è®¤çŸ¥ï¼‰\nç¼“å­˜ç©¿é€ ç¼“å­˜å‡»ç©¿ ç¼“å­˜é›ªå´© ğŸ‘‰ æœ¬è´¨ï¼šé«˜å¹¶å‘ + ä¾èµ–å…³ç³» + ç¬æ—¶æ”¾å¤§æ•ˆåº”\nKubernetes æœ‰å“ªäº›â€œå…¸å‹ç³»ç»Ÿæ€§é—®é¢˜â€ï¼Ÿ\nKubernetes çš„é—®é¢˜ä¸åœ¨â€œåŠŸèƒ½ä¸å…¨â€ï¼Œè€Œåœ¨ è§„æ¨¡åŒ– + è‡ªåŠ¨åŒ– + åˆ†å¸ƒå¼å¸¦æ¥çš„æ”¾å¤§æ•ˆåº”ã€‚\nä¸€ã€Kubernetes ä¸‰å¤§â€œåŸºç¡€æ€§é—®é¢˜â€ 1ï¸âƒ£ æ§åˆ¶å¹³é¢ç“¶é¢ˆé—®é¢˜ï¼ˆAPI Server é£æš´ï¼‰ ğŸ“Œ ç°è±¡ é›†ç¾¤ä¸€åˆ‡æ“ä½œå˜æ…¢ kubectl å¡é¡¿ Pod åˆ›å»ºå»¶è¿Ÿå·¨å¤§ HPA / Controller å¤±æ•ˆ ğŸ“Œ æ ¹å›  kube-apiserver æ˜¯å”¯ä¸€å…¥å£ watch/list å¤ªå¤š æ§åˆ¶å™¨ã€Operatorã€CRD è¿‡å¤š é«˜é¢‘ List è€Œä¸æ˜¯ Watch ğŸ“Œ æ”¾å¤§æ•ˆåº” ä¸€ä¸ªç»„ä»¶å¼‚å¸¸ -\u0026gt; è§¦å‘å¤§é‡é‡è¯• -\u0026gt; API Server è¢«æ‰“çˆ†\n"},{"id":282,"href":"/operations/kvm/","title":"KVM","parent":"Operations","content":"Document List:\nè™šæ‹ŸåŒ– KVM æ ¸å¿ƒæ¦‚å¿µ KVM Pool KVM è™šæ‹Ÿæœºæ“ä½œå‘½ä»¤ KVM é˜²æ­¢â€œå•ä¸ªè™šæ‹Ÿæœºæ‹–æ­»æ•´å°å®¿ä¸»æœºâ€ åˆ›å»ºæ¡¥æ¥ç½‘å¡ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… KVM ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVMï¼‰ vs æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰ ","description":"Document List:\nè™šæ‹ŸåŒ– KVM æ ¸å¿ƒæ¦‚å¿µ KVM Pool KVM è™šæ‹Ÿæœºæ“ä½œå‘½ä»¤ KVM é˜²æ­¢â€œå•ä¸ªè™šæ‹Ÿæœºæ‹–æ­»æ•´å°å®¿ä¸»æœºâ€ åˆ›å»ºæ¡¥æ¥ç½‘å¡ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… KVM ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVMï¼‰ vs æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰ "},{"id":283,"href":"/operations/kvm/pool/","title":"KVM Pool","parent":"KVM","content":"# æŸ¥çœ‹å­˜å‚¨æ±  virsh pool-list --all # æŸ¥çœ‹å­˜å‚¨æ± è¯¦æƒ… virsh pool-info default virsh pool-dumpxml default # åœç”¨é»˜è®¤çš„å­˜å‚¨æ±  virsh pool-destroy default # åˆ é™¤é»˜è®¤çš„å­˜å‚¨æ±  virsh pool-undefine default # å®šä¹‰æ–°çš„é»˜è®¤å­˜å‚¨æ±  virsh pool-define-as default dir --target \u0026#34;/kvm/images\u0026#34; # æˆ–è€… # virsh pool-define-as default dir - - - - \u0026#34;/kvm/images\u0026#34; # åˆ›å»ºå­˜å‚¨æ±  virsh pool-build default # å¯åŠ¨æ–°çš„é»˜è®¤å­˜å‚¨æ±  virsh pool-start default # é…ç½®å­˜å‚¨æ± å¼€æœºå¯åŠ¨ virsh pool-autostart default ","description":"# æŸ¥çœ‹å­˜å‚¨æ±  virsh pool-list --all # æŸ¥çœ‹å­˜å‚¨æ± è¯¦æƒ… virsh pool-info default virsh pool-dumpxml default # åœç”¨é»˜è®¤çš„å­˜å‚¨æ±  virsh pool-destroy default # åˆ é™¤é»˜è®¤çš„å­˜å‚¨æ±  virsh pool-undefine default # å®šä¹‰æ–°çš„é»˜è®¤å­˜å‚¨æ±  virsh pool-define-as default dir --target \u0026#34;/kvm/images\u0026#34; # æˆ–è€… # virsh pool-define-as default dir - - - - \u0026#34;/kvm/images\u0026#34; # åˆ›å»ºå­˜å‚¨æ±  virsh pool-build default # å¯åŠ¨æ–°çš„é»˜è®¤å­˜å‚¨æ±  virsh pool-start default # é…ç½®å­˜å‚¨æ± å¼€æœºå¯åŠ¨ virsh pool-autostart default "},{"id":284,"href":"/operations/kvm/kvm-command/","title":"KVM è™šæ‹Ÿæœºæ“ä½œå‘½ä»¤","parent":"KVM","content":" æŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯ 1. æŸ¥çœ‹æ‰€æœ‰è™šæ‹Ÿæœº virsh list --all è¾“å‡ºç¤ºä¾‹ï¼š\nId Name State --------------------------- 1 vm1 running - vm2 shut off 2. æŸ¥çœ‹è™šæ‹Ÿæœºè¯¦ç»†ä¿¡æ¯ virsh dominfo VM_NAME virsh dominfo vm2 # Id: - # Name: vm2 # UUID: 3adbc6d0-a826-4eb3-baae-afa5ac661230 # OS Type: hvm # State: shut off # CPU(s): 2 # Max memory: 2097152 KiB # Used memory: 2097152 KiB # Persistent: yes # Autostart: disable # Managed save: no # Security model: none # Security DOI: 0 3. æŸ¥çœ‹è™šæ‹Ÿæœº XML é…ç½® virsh dumpxml VM_NAME 4. æŸ¥çœ‹è™šæ‹Ÿæœºç½‘ç»œä¿¡æ¯ virsh domiflist VM_NAME virsh domiflist vm2 # Interface Type Source Model MAC # ----------------------------------------------------------- # - bridge br0 virtio 52:54:00:0c:b8:dd 5. æŸ¥çœ‹è™šæ‹Ÿæœºç£ç›˜ä¿¡æ¯ virsh domblklist VM_NAME virsh domblklist vm2 # Target Source # ------------------------------------------------------- # vda /data/kvm/images/vm2.qcow2 # sda /data/isos/AlmaLinux-9.7-x86_64-minimal.iso åˆ›å»ºè™šæ‹Ÿæœº 1. ä½¿ç”¨ virt-install åˆ›å»º virt-install \\ --name vm1 \\ --memory 4096 \\ --vcpus 2 \\ --disk path=/data/kvm/images/vm1.qcow2,size=40 \\ --os-variant almalinux9 \\ --network bridge=br0 \\ --graphics vnc \\ --cdrom /data/isos/AlmaLinux-9.7-x86_64-minimal.iso å‚æ•°è¯´æ˜\nå‚æ•° ä½œç”¨ â€“name è™šæ‹Ÿæœºåç§° â€“memory å†…å­˜å¤§å° MB â€“vcpus CPU æ•°é‡ â€“disk ç£ç›˜è·¯å¾„å’Œå¤§å° â€“os-variant OS ç±»å‹ï¼Œä¼˜åŒ–æ€§èƒ½ â€“network ç½‘ç»œç±»å‹ï¼ˆbridge/NATï¼‰ â€“graphics VNC / Spice ç­‰ â€“cdrom ISO é•œåƒè·¯å¾„ 2. ä½¿ç”¨ XML åˆ›å»ºï¼ˆé«˜çº§ï¼‰ virsh define /path/to/vm.xml define -\u0026gt; ä»…æ³¨å†Œè™šæ‹Ÿæœºï¼Œä¸å¯åŠ¨ undefine -\u0026gt; åˆ é™¤è™šæ‹Ÿæœºå®šä¹‰ï¼ˆä¸åˆ é™¤ç£ç›˜ï¼‰ å¯åŠ¨ / åœæ­¢è™šæ‹Ÿæœº 1. å¯åŠ¨è™šæ‹Ÿæœº virsh start VM_NAME 2. å¼ºåˆ¶é‡å¯è™šæ‹Ÿæœº virsh reboot VM_NAME --force 3. å…³é—­è™šæ‹Ÿæœº æ­£å¸¸å…³æœºï¼š virsh shutdown VM_NAME å¼ºåˆ¶å…³æœºï¼š virsh destroy VM_NAME destroy ç›¸å½“äºæ‹”ç”µæºï¼Œæ…ç”¨\n4. è®¾ç½®å¼€æœºè‡ªå¯ virsh autostart VM_NAME åˆ é™¤è™šæ‹Ÿæœº 1. ä»…åˆ é™¤å®šä¹‰ï¼Œä¸åˆ é™¤ç£ç›˜ virsh undefine VM_NAME 2. åˆ é™¤å®šä¹‰ + åˆ é™¤ç£ç›˜ virsh undefine VM_NAME --remove-all-storage ç£ç›˜ç®¡ç† 1. åˆ›å»ºæ–°çš„ç£ç›˜ qemu-img create -f qcow2 /data/kvm/vm1-data.qcow2 20G 2. å¢åŠ ç£ç›˜åˆ°å·²æœ‰è™šæ‹Ÿæœº ç¼–è¾‘ XMLï¼š\nvirsh edit VM_NAME æ·»åŠ  é…ç½®\næŸ¥çœ‹ç£ç›˜åˆ—è¡¨\nvirsh domblklist VM_NAME å¿«ç…§ç®¡ç† 1. åˆ›å»ºå¿«ç…§ virsh snapshot-create-as VM_NAME snap1 \u0026#34;snapshot description\u0026#34; 2. åˆ—å‡ºå¿«ç…§ virsh snapshot-list VM_NAME 3. æ¢å¤å¿«ç…§ virsh snapshot-revert VM_NAME snap1 4. åˆ é™¤å¿«ç…§ virsh snapshot-delete VM_NAME snap1 ç½‘ç»œç®¡ç† 1. æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œ virsh net-list --all 2. å¯åŠ¨ / åœæ­¢ç½‘ç»œ virsh net-start default virsh net-destroy default virsh net-autostart default 3. åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ virsh net-define /usr/share/libvirt/networks/default.xml virsh net-start default virsh net-autostart default å¸¸ç”¨å›¾å½¢ç®¡ç†å·¥å…· 1. virt-managerï¼ˆGUIï¼‰ å®‰è£…ï¼š dnf install virt-manager -y æœ¬åœ° X æˆ–è¿œç¨‹ X forwarding ç™»å½• åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€å¿«ç…§ä¸€é”®æ“ä½œ 2. Cockpit + cockpit-machines å®‰è£…ï¼š dnf install cockpit cockpit-machines -y systemctl enable --now cockpit.socket æµè§ˆå™¨è®¿é—®ï¼š https://\u0026lt;IP\u0026gt;:9090 ç®¡ç† KVM VMã€ç½‘ç»œå’Œå­˜å‚¨ æ€»ç»“ æ“ä½œ å‘½ä»¤ åˆ—å‡ºè™šæ‹Ÿæœº virsh list \u0026ndash;all æŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯ virsh dominfo å¯åŠ¨è™šæ‹Ÿæœº virsh start åœæ­¢è™šæ‹Ÿæœº virsh shutdown å¼ºåˆ¶å…³æœº virsh destroy é‡å¯è™šæ‹Ÿæœº virsh reboot åˆ›å»ºè™šæ‹Ÿæœº virt-install \u0026hellip; åˆ é™¤è™šæ‹Ÿæœº virsh undefine \u0026ndash;remove-all-storage æŸ¥çœ‹ç£ç›˜ virsh domblklist åˆ›å»ºç£ç›˜ qemu-img create -f qcow2 /path/to/disk.qcow2 20G ç½‘ç»œåˆ—è¡¨ virsh net-list \u0026ndash;all ç½‘ç»œå¯åŠ¨ virsh net-start default ","description":" æŸ¥çœ‹è™šæ‹Ÿæœºä¿¡æ¯ 1. æŸ¥çœ‹æ‰€æœ‰è™šæ‹Ÿæœº virsh list --all è¾“å‡ºç¤ºä¾‹ï¼š\nId Name State --------------------------- 1 vm1 running - vm2 shut off 2. æŸ¥çœ‹è™šæ‹Ÿæœºè¯¦ç»†ä¿¡æ¯ virsh dominfo VM_NAME virsh dominfo vm2 # Id: - # Name: vm2 # UUID: 3adbc6d0-a826-4eb3-baae-afa5ac661230 # OS Type: hvm # State: shut off # CPU(s): 2 # Max memory: 2097152 KiB # Used memory: 2097152 KiB # Persistent: yes # Autostart: disable # Managed save: no # Security model: none # Security DOI: 0 3. æŸ¥çœ‹è™šæ‹Ÿæœº XML é…ç½® virsh dumpxml VM_NAME 4. æŸ¥çœ‹è™šæ‹Ÿæœºç½‘ç»œä¿¡æ¯ virsh domiflist VM_NAME virsh domiflist vm2 # Interface Type Source Model MAC # ----------------------------------------------------------- # - bridge br0 virtio 52:54:00:0c:b8:dd 5. æŸ¥çœ‹è™šæ‹Ÿæœºç£ç›˜ä¿¡æ¯ virsh domblklist VM_NAME virsh domblklist vm2 # Target Source # ------------------------------------------------------- # vda /data/kvm/images/vm2.qcow2 # sda /data/isos/AlmaLinux-9.7-x86_64-minimal.iso åˆ›å»ºè™šæ‹Ÿæœº 1. ä½¿ç”¨ virt-install åˆ›å»º virt-install \\ --name vm1 \\ --memory 4096 \\ --vcpus 2 \\ --disk path=/data/kvm/images/vm1.qcow2,size=40 \\ --os-variant almalinux9 \\ --network bridge=br0 \\ --graphics vnc \\ --cdrom /data/isos/AlmaLinux-9.7-x86_64-minimal.iso å‚æ•°è¯´æ˜\n"},{"id":285,"href":"/operations/kvm/prevents-a-single-virtual-machine-from-dragging-down-the-entire-host/","title":"KVM é˜²æ­¢â€œå•ä¸ªè™šæ‹Ÿæœºæ‹–æ­»æ•´å°å®¿ä¸»æœºâ€","parent":"KVM","content":"è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒã€éå¸¸â€œç”Ÿäº§çº§â€çš„é—®é¢˜ã€‚\nä¸€å¥è¯å…ˆç»™ç»“è®ºï¼š\nKVM é˜²æ­¢â€œå•ä¸ªè™šæ‹Ÿæœºæ‹–æ­»æ•´å°å®¿ä¸»æœºâ€çš„æ‰‹æ®µï¼Œæœ¬è´¨æ˜¯ï¼š ç”¨ Linux å†…æ ¸çš„ã€Œèµ„æºéš”ç¦» + è°ƒåº¦ + å¼ºåˆ¶ä¸Šé™ã€å»çº¦æŸ QEMU è¿›ç¨‹ã€‚\nä¸‹é¢ä» è®¾è®¡æ€æƒ³ -\u0026gt; æ ¸å¿ƒæœºåˆ¶ -\u0026gt; å®æˆ˜é…ç½® -\u0026gt; å…¸å‹äº‹æ•… -\u0026gt; é¢è¯•æ€»ç»“ äº”ä¸ªå±‚æ¬¡ï¼ŒæŠŠè¿™ä¸ªé—®é¢˜è®²é€ã€‚\nä¸€ã€é—®é¢˜æœ¬è´¨ï¼ˆå…ˆæƒ³æ¸…æ¥šï¼‰ åœ¨å®¿ä¸»æœºçœ¼é‡Œï¼Œæ¯ä¸ªè™šæ‹Ÿæœº = ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰QEMU è¿›ç¨‹\nå¦‚æœä¸é™åˆ¶ï¼š\nCPU æ‰“æ»¡ -\u0026gt; Host å¡æ­» å†…å­˜åƒå…‰ -\u0026gt; OOM -\u0026gt; å…¨éƒ¨æœåŠ¡å´© I/O ç‹‚åˆ· -\u0026gt; å…¨ç›˜æŠ– ç½‘ç»œé£æš´ -\u0026gt; å®¿ä¸»æœºä¸¢åŒ… æ‰€ä»¥ç›®æ ‡æ˜¯ï¼š\nè®© VMâ€œæœ€å¤šæŠŠè‡ªå·±ç©æ­»â€ï¼Œä½†æ°¸è¿œæ‹–ä¸å®å®¿ä¸»æœº\näºŒã€KVM é˜²æŠ¤çš„æ€»ä½“è®¾è®¡æ€æƒ³ QEMU è¿›ç¨‹ â”œâ”€â”€ CPUï¼šcgroup + è°ƒåº¦å™¨ â”œâ”€â”€ å†…å­˜ï¼šhard limit + OOM æ§åˆ¶ â”œâ”€â”€ I/Oï¼šblkio / io controller â”œâ”€â”€ ç½‘ç»œï¼šqdisc / virtio-net â””â”€â”€ æ•…éšœï¼šè‡ªåŠ¨éš”ç¦» / kill KVM ä¸è‡ªå·±é€ è½®å­ï¼Œè€Œæ˜¯å…¨é¢å¤ç”¨ Linux å†…æ ¸èƒ½åŠ›\nä¸‰ã€CPU é˜²æŠ¤ï¼ˆæœ€é‡è¦ã€æœ€å®¹æ˜“å¿½ç•¥ï¼‰ 1ï¸âƒ£ vCPU â‰  ç‰©ç† CPU vCPU æ˜¯ çº¿ç¨‹ è°ƒåº¦ç”± Linux CFS è°ƒåº¦å™¨ æ§åˆ¶ é˜²æŠ¤æœºåˆ¶ æœºåˆ¶ ä½œç”¨ vCPU ä¸Šé™ é™åˆ¶æœ€å¤§å¹¶å‘ CPU pinning é˜²æ­¢æŠ¢å  CPU share / quota é™é€Ÿ 2ï¸âƒ£ CPU ä¸Šé™ï¼ˆå¿…é¡»é…ç½®ï¼‰ libvirt XML ç¤ºä¾‹ \u0026lt;vcpu placement=\u0026#39;static\u0026#39;\u0026gt;4\u0026lt;/vcpu\u0026gt; \u0026lt;cputune\u0026gt; \u0026lt;shares\u0026gt;1024\u0026lt;/shares\u0026gt; \u0026lt;quota\u0026gt;400000\u0026lt;/quota\u0026gt; \u0026lt;!-- 4 æ ¸ --\u0026gt; \u0026lt;period\u0026gt;100000\u0026lt;/period\u0026gt; \u0026lt;/cputune\u0026gt; æ•ˆæœï¼š\nVM CPU æ‰“æ»¡ Host ä»ç„¶æµç•… 3ï¸âƒ£ CPU Pinningï¼ˆç”Ÿäº§å¼ºçƒˆæ¨èï¼‰ \u0026lt;cputune\u0026gt; \u0026lt;vcpupin vcpu=\u0026#39;0\u0026#39; cpuset=\u0026#39;2\u0026#39;/\u0026gt; \u0026lt;vcpupin vcpu=\u0026#39;1\u0026#39; cpuset=\u0026#39;3\u0026#39;/\u0026gt; \u0026lt;/cputune\u0026gt; ğŸ‘‰ é˜²æ­¢ VM æŠ¢å å®¿ä¸»æœºå…³é”®æ ¸\nå››ã€å†…å­˜é˜²æŠ¤ï¼ˆæœ€è‡´å‘½ï¼‰ 90% çš„â€œæ•´æœºè¢«æ‹–æ­»â€æ¥è‡ªå†…å­˜å¤±æ§\n1ï¸âƒ£ å†…å­˜ç¡¬é™åˆ¶ï¼ˆä¸æ˜¯å»ºè®®ï¼Œæ˜¯å¿…é¡»ï¼‰ \u0026lt;memory unit=\u0026#39;MiB\u0026#39;\u0026gt;8192\u0026lt;/memory\u0026gt; \u0026lt;currentMemory unit=\u0026#39;MiB\u0026#39;\u0026gt;8192\u0026lt;/currentMemory\u0026gt; ç»“æœ VM å†…å­˜æ°¸è¿œä¸ä¼šè¶…è¿‡ 8G Host ä¸ä¼šè¢«åƒç©º 2ï¸âƒ£ ç¦æ­¢ overcommitï¼ˆå…³é”®ï¼‰ vm.overcommit_memory = 2 vm.overcommit_ratio = 80 ğŸ‘‰ é˜²æ­¢æ‰€æœ‰ VM åŠ èµ·æ¥â€œçº¸é¢å†…å­˜ \u0026gt; å®é™…å†…å­˜â€\n3ï¸âƒ£ OOM ä¼˜å…ˆçº§ï¼ˆæ•‘å®¿ä¸»æœºï¼‰ echo -1000 \u0026gt; /proc/$(pidof qemu-system-x86_64)/oom_score_adj VM OOM ä¼˜å…ˆ Host æ°¸è¿œæœ€åæ­» 4ï¸âƒ£ Balloonï¼ˆåŠ¨æ€å›æ”¶ï¼‰ \u0026lt;memballoon model=\u0026#39;virtio\u0026#39;/\u0026gt; å›æ”¶ç©ºé—²å†…å­˜ é˜²æ­¢è™šæ‹Ÿæœºå‡å ç”¨ äº”ã€ç£ç›˜ I/O é˜²æŠ¤ï¼ˆæœ€å®¹æ˜“è¢«å¿½è§†ï¼‰ ä¸€ä¸ª fsync é£æš´ = æ•´æœºå¡æ­»\n1ï¸âƒ£ blkio é™é€Ÿ \u0026lt;blkio\u0026gt; \u0026lt;weight\u0026gt;500\u0026lt;/weight\u0026gt; \u0026lt;/blkio\u0026gt; æˆ–ï¼š\n\u0026lt;disk\u0026gt; \u0026lt;iotune\u0026gt; \u0026lt;read_bytes_sec\u0026gt;10485760\u0026lt;/read_bytes_sec\u0026gt; \u0026lt;write_bytes_sec\u0026gt;10485760\u0026lt;/write_bytes_sec\u0026gt; \u0026lt;/iotune\u0026gt; \u0026lt;/disk\u0026gt; ğŸ‘‰ VM æœ€å¤š 10MB/s\n2ï¸âƒ£ å¼ºåˆ¶ virtio + io_uring ç¦æ­¢ IDE ç¦æ­¢ qcow2 on busy hostï¼ˆç”Ÿäº§å»ºè®® LVM / rawï¼‰ å…­ã€ç½‘ç»œé˜²æŠ¤ï¼ˆé˜²å¹¿æ’­é£æš´ï¼‰ 1ï¸âƒ£ è™šæ‹Ÿç½‘å¡é™é€Ÿ \u0026lt;interface\u0026gt; \u0026lt;bandwidth\u0026gt; \u0026lt;inbound average=\u0026#39;100000\u0026#39;/\u0026gt; \u0026lt;outbound average=\u0026#39;100000\u0026#39;/\u0026gt; \u0026lt;/bandwidth\u0026gt; \u0026lt;/interface\u0026gt; 2ï¸âƒ£ Bridge å±‚é˜²æŠ¤ tc qdisc add dev br0 root tbf rate 100mbit burst 32k latency 400ms ä¸ƒã€è°ƒåº¦ä¸ä¼˜å…ˆçº§ï¼ˆå®¿ä¸»æœºæ°¸è¿œä¼˜å…ˆï¼‰ renice -10 $(pidof qemu-system-x86_64) æˆ– systemdï¼š\n[Service] CPUWeight=100 MemoryMax=8G IOWeight=100 å…«ã€libvirt çš„â€œæœ€åä¸€é“ä¿é™©â€ è‡ªåŠ¨ kill VM è¶…é™ Host å†…å­˜ä¸è¶³ libvirt ä¼˜å…ˆæ€ VM Watchdog \u0026lt;watchdog model=\u0026#39;i6300esb\u0026#39; action=\u0026#39;reset\u0026#39;/\u0026gt; ä¹ã€çœŸå®ç”Ÿäº§äº‹æ•…æ¡ˆä¾‹ï¼ˆä½ ä¸€å®šä¼šé‡åˆ°ï¼‰ âŒ æœªé™å†…å­˜ ä¸€ä¸ª VM OOM Host swap çˆ† SSH å¡æ­» æ‰€æœ‰ VM æŒ‚ âœ… æ­£ç¡®é…ç½® VM è¢« kill Host æ— æ„ŸçŸ¥ å…¶ä»– VM æ­£å¸¸ åã€ç”Ÿäº§çº§ã€Œé˜²æ‹–æ­»ã€æ¸…å•ï¼ˆå¿…åšï¼‰ âœ… vCPU ä¸è¶…å– âœ… å†…å­˜ hard limit âœ… ç¦æ­¢å†…å­˜ overcommit âœ… blkio é™é€Ÿ âœ… ç½‘ç»œé™é€Ÿ âœ… CPU pinning âœ… OOM ä¼˜å…ˆçº§ âœ… Watchdog åä¸€ã€æ€»ç»“ KVM é€šè¿‡æŠŠè™šæ‹Ÿæœºæ˜ å°„ä¸ºå— cgroup ç®¡æ§çš„ QEMU è¿›ç¨‹ï¼Œç»“åˆ CPUã€å†…å­˜ã€I/Oã€ç½‘ç»œçš„ç¡¬é™åˆ¶ä¸è°ƒåº¦æœºåˆ¶ï¼Œç¡®ä¿å•ä¸ªè™šæ‹Ÿæœºèµ„æºå¤±æ§åªä¼šå½±å“è‡ªèº«ï¼Œè€Œä¸ä¼šæ‹–å®å®¿ä¸»æœºã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒã€éå¸¸â€œç”Ÿäº§çº§â€çš„é—®é¢˜ã€‚\nä¸€å¥è¯å…ˆç»™ç»“è®ºï¼š\nKVM é˜²æ­¢â€œå•ä¸ªè™šæ‹Ÿæœºæ‹–æ­»æ•´å°å®¿ä¸»æœºâ€çš„æ‰‹æ®µï¼Œæœ¬è´¨æ˜¯ï¼š ç”¨ Linux å†…æ ¸çš„ã€Œèµ„æºéš”ç¦» + è°ƒåº¦ + å¼ºåˆ¶ä¸Šé™ã€å»çº¦æŸ QEMU è¿›ç¨‹ã€‚\nä¸‹é¢ä» è®¾è®¡æ€æƒ³ -\u0026gt; æ ¸å¿ƒæœºåˆ¶ -\u0026gt; å®æˆ˜é…ç½® -\u0026gt; å…¸å‹äº‹æ•… -\u0026gt; é¢è¯•æ€»ç»“ äº”ä¸ªå±‚æ¬¡ï¼ŒæŠŠè¿™ä¸ªé—®é¢˜è®²é€ã€‚\nä¸€ã€é—®é¢˜æœ¬è´¨ï¼ˆå…ˆæƒ³æ¸…æ¥šï¼‰ åœ¨å®¿ä¸»æœºçœ¼é‡Œï¼Œæ¯ä¸ªè™šæ‹Ÿæœº = ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰QEMU è¿›ç¨‹\nå¦‚æœä¸é™åˆ¶ï¼š\nCPU æ‰“æ»¡ -\u0026gt; Host å¡æ­» å†…å­˜åƒå…‰ -\u0026gt; OOM -\u0026gt; å…¨éƒ¨æœåŠ¡å´© I/O ç‹‚åˆ· -\u0026gt; å…¨ç›˜æŠ– ç½‘ç»œé£æš´ -\u0026gt; å®¿ä¸»æœºä¸¢åŒ… æ‰€ä»¥ç›®æ ‡æ˜¯ï¼š\nè®© VMâ€œæœ€å¤šæŠŠè‡ªå·±ç©æ­»â€ï¼Œä½†æ°¸è¿œæ‹–ä¸å®å®¿ä¸»æœº\näºŒã€KVM é˜²æŠ¤çš„æ€»ä½“è®¾è®¡æ€æƒ³ QEMU è¿›ç¨‹ â”œâ”€â”€ CPUï¼šcgroup + è°ƒåº¦å™¨ â”œâ”€â”€ å†…å­˜ï¼šhard limit + OOM æ§åˆ¶ â”œâ”€â”€ I/Oï¼šblkio / io controller â”œâ”€â”€ ç½‘ç»œï¼šqdisc / virtio-net â””â”€â”€ æ•…éšœï¼šè‡ªåŠ¨éš”ç¦» / kill KVM ä¸è‡ªå·±é€ è½®å­ï¼Œè€Œæ˜¯å…¨é¢å¤ç”¨ Linux å†…æ ¸èƒ½åŠ›\n"},{"id":286,"href":"/backend/python/official/lambda/","title":"Lambda","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å…¨é¢ã€æœ€å®æˆ˜çš„ Python Î»ï¼ˆlambdaï¼‰æŒ‡å—ï¼Œé€‚åˆå¿«é€Ÿç†è§£ + å®æˆ˜åº”ç”¨ã€‚\nğŸ”¥ 1. lambda æ˜¯ä»€ä¹ˆï¼Ÿ lambda æ˜¯ Python çš„åŒ¿åå‡½æ•°ï¼ˆæ²¡æœ‰åå­—çš„å‡½æ•°ï¼‰\nå¸¸å†™æ³•ï¼š\nlambda å‚æ•°: è¡¨è¾¾å¼ å®ƒç­‰ä»·äºï¼š\ndef func(å‚æ•°): return è¡¨è¾¾å¼ ğŸ”¥ 2. lambda çš„ç‰¹ç‚¹ ç‰¹ç‚¹ è¯´æ˜ åŒ¿å ä¸éœ€è¦ç”¨ def å®šä¹‰ ä¸€è¡Œè¡¨è¾¾å¼ åªèƒ½å†™ å•è¡¨è¾¾å¼ï¼Œä¸èƒ½å†™å¤šè¡Œ å¿«é€Ÿ å¸¸ç”¨äºç®€çŸ­é€»è¾‘ å¸¸ä¸ map/filter/sorted ç­‰æ­é… ğŸ”¥ 3. æœ€ç®€å•ç¤ºä¾‹ add = lambda x, y: x + y print(add(1, 2)) # 3 ç­‰ä»·äºï¼š\ndef add(x, y): return x + y ğŸ”¥ 4. lambda å¸¸è§ä½¿ç”¨åœºæ™¯ï¼ˆæœ€é‡è¦ï¼‰ â‘  æ’åºæ—¶ä½¿ç”¨ keyï¼ˆæœ€å¸¸è§ï¼‰ æŒ‰é•¿åº¦æ’åºå­—ç¬¦ä¸²ï¼š\nnames = [\u0026#34;aaa\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;cccc\u0026#34;] sorted(names, key=lambda s: len(s)) æŒ‰å¯¹è±¡å­—æ®µæ’åºï¼š\nusers = [ {\u0026#34;name\u0026#34;: \u0026#34;A\u0026#34;, \u0026#34;age\u0026#34;: 20}, {\u0026#34;name\u0026#34;: \u0026#34;B\u0026#34;, \u0026#34;age\u0026#34;: 18}, ] sorted(users, key=lambda x: x[\u0026#34;age\u0026#34;]) â‘¡ filter() è¿‡æ»¤æ•°æ® nums = [1, 2, 3, 4, 5] odd = list(filter(lambda x: x % 2 == 1, nums)) # [1, 3, 5] â‘¢ map() æ˜ å°„è½¬æ¢ nums = [1, 2, 3] doubled = list(map(lambda x: x * 2, nums)) # [2, 4, 6] â‘£ reduce() ç´¯ç§¯è®¡ç®— from functools import reduce nums = [1, 2, 3, 4] total = reduce(lambda x, y: x + y, nums) # 10 â‘¤ åœ¨ GUI æˆ–å›è°ƒä¸­å¿«é€Ÿå®šä¹‰é€»è¾‘ ä¾‹å¦‚æŒ‰é’®ç‚¹å‡»ï¼š\nbutton.on_click(lambda: print(\u0026#34;clicked\u0026#34;)) â‘¥ ä¸å‡½æ•°å¼ç¼–ç¨‹ç»“åˆ ä½œä¸ºå‚æ•°ä¼ ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼š\ndef apply(func, x): return func(x) apply(lambda v: v * 10, 5) # 50 ğŸ”¥ 5. lambda çš„é«˜çº§ç”¨æ³• â‘  åµŒå¥— lambda adder = lambda x: lambda y: x + y add_10 = adder(10) add_10(5) # 15 â‘¡ lambda + åˆ—è¡¨æ¨å¯¼å¼ funcs = [lambda x=i: x * 2 for i in range(5)] [fn() for fn in funcs] # [0, 2, 4, 6, 8] â‘¢ lambda + å­—å…¸åˆ†å‘ï¼ˆä»£æ›¿ if/elseï¼‰ action = { \u0026#34;add\u0026#34;: lambda x, y: x + y, \u0026#34;mul\u0026#34;: lambda x, y: x * y, } action[\u0026#34;add\u0026#34;](1, 2) # 3 ğŸ”¥ 6. lambda ä¸æ™®é€šå‡½æ•°çš„åŒºåˆ« å¯¹æ¯”é¡¹ lambda def å‡½æ•° æ˜¯å¦æœ‰åå­— æ—  æœ‰ åŠŸèƒ½ ç®€çŸ­è¡¨è¾¾å¼ å¤šè¡Œé€»è¾‘ æ˜¯å¦èƒ½å†™ if/for/print ç­‰è¯­å¥ âŒ ä¸è¡Œ âœ… å¯ä»¥ æ˜¯å¦æ”¯æŒç±»å‹æ³¨è§£ âŒ ä¸æ”¯æŒ âœ… æ”¯æŒ å¯è¯»æ€§ è¾ƒå·® è¾ƒå¥½ ç»“è®ºï¼š\nlambda ç”¨äºâ€œä¸€è¡Œå°åŠŸèƒ½â€ï¼Œå¤æ‚é€»è¾‘å¿…é¡»ä½¿ç”¨ defã€‚\nğŸ”¥ 7. lambda çš„å¸¸è§å‘ âŒ â‘  å¤šè¡Œä¸å…è®¸ é”™è¯¯ï¼š\nlambda x: ( y = x + 1, y * 2 ) lambda ä¸­ä¸èƒ½å‡ºç° =ã€ä¸èƒ½å†™è¯­å¥ï¼Œåªèƒ½å†™è¡¨è¾¾å¼ã€‚\nâŒ â‘¡ å¾ªç¯ä¸­çš„ lambda å»¶è¿Ÿç»‘å®šé—®é¢˜ é”™è¯¯ç¤ºä¾‹ï¼š\nfuncs = [lambda: i for i in range(3)] print([f() for f in funcs]) # [2, 2, 2] æ­£ç¡®ï¼š\nfuncs = [lambda x=i: x for i in range(3)] ğŸ”¥ 8. ä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨ lambdaï¼Ÿ å»ºè®®ï¼š\nâœ… å®Œå…¨å¯ä»¥ç”¨ sorted(key=xxx) map/filter/reduce ç®€å•å›è°ƒ å­—å…¸åˆ†å‘è¡¨ ä¸´æ—¶å°å‡½æ•° âŒ ä¸åº”è¯¥ç”¨ ä»»ä½•å¤æ‚é€»è¾‘ éœ€è¦ç±»å‹æ ‡æ³¨çš„åœ°æ–¹ éœ€è¦æµ‹è¯•/è°ƒè¯•çš„å‡½æ•° ğŸ“Œ æ€»ç»“ lambda æ˜¯â€œä¸€è¡ŒåŒ¿åå‡½æ•°â€ï¼Œé€‚åˆæçŸ­é€»è¾‘ï¼Œè¿‡é•¿è¯·æ¢æˆ defï¼Œé˜²æ­¢ä»£ç ä¸å¯ç»´æŠ¤ã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å…¨é¢ã€æœ€å®æˆ˜çš„ Python Î»ï¼ˆlambdaï¼‰æŒ‡å—ï¼Œé€‚åˆå¿«é€Ÿç†è§£ + å®æˆ˜åº”ç”¨ã€‚\nğŸ”¥ 1. lambda æ˜¯ä»€ä¹ˆï¼Ÿ lambda æ˜¯ Python çš„åŒ¿åå‡½æ•°ï¼ˆæ²¡æœ‰åå­—çš„å‡½æ•°ï¼‰\nå¸¸å†™æ³•ï¼š\nlambda å‚æ•°: è¡¨è¾¾å¼ å®ƒç­‰ä»·äºï¼š\ndef func(å‚æ•°): return è¡¨è¾¾å¼ ğŸ”¥ 2. lambda çš„ç‰¹ç‚¹ ç‰¹ç‚¹ è¯´æ˜ åŒ¿å ä¸éœ€è¦ç”¨ def å®šä¹‰ ä¸€è¡Œè¡¨è¾¾å¼ åªèƒ½å†™ å•è¡¨è¾¾å¼ï¼Œä¸èƒ½å†™å¤šè¡Œ å¿«é€Ÿ å¸¸ç”¨äºç®€çŸ­é€»è¾‘ å¸¸ä¸ map/filter/sorted ç­‰æ­é… ğŸ”¥ 3. æœ€ç®€å•ç¤ºä¾‹ add = lambda x, y: x + y print(add(1, 2)) # 3 ç­‰ä»·äºï¼š\n"},{"id":287,"href":"/backend/python/official/lazy/","title":"Lazy (æƒ°æ€§)","parent":"Official","content":" ä»€ä¹ˆæ˜¯æƒ°æ€§ åœ¨ Python ä¸­ï¼Œâ€œæƒ°æ€§ï¼ˆlazyï¼‰â€æŒ‡çš„æ˜¯ï¼š\nâœ… ä¸ç«‹å³è®¡ç®—æˆ–ç”Ÿæˆæ•°æ®ï¼Œè€Œæ˜¯åœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œã€‚\nå³ï¼šæŒ‰éœ€è®¡ç®—ã€å»¶è¿Ÿæ‰§è¡Œã€‚\nğŸ”¥ è§£é‡Š æƒ°æ€§ = æ•°æ®ä¸æ˜¯é©¬ä¸Šç”Ÿæˆï¼Œè€Œæ˜¯ç”¨åˆ°æ—¶æ‰ç”Ÿæˆã€‚\nğŸš€ å…¸å‹ä»£è¡¨ï¼šç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ ä¾‹å¦‚ï¼š\ndef generate_items(): for i in range(10): print(\u0026#34;ç”Ÿæˆ:\u0026#34;, i) yield i è°ƒç”¨ï¼š\ngen = generate_items() æ­¤æ—¶ æ²¡æœ‰æ‰“å°ä»»ä½•ä¸œè¥¿ã€‚\nåªæœ‰å½“ä½ å¼€å§‹å–å€¼æ—¶ï¼Œæ‰ä¼šç”Ÿæˆï¼š\nnext(gen) è¾“å‡ºï¼š\nç”Ÿæˆ: 0 è¿™å°±æ˜¯æƒ°æ€§ã€‚\nâ˜˜ï¸ ä¸ºä»€ä¹ˆè¦â€œæƒ°æ€§â€ï¼Ÿ 1. èŠ‚çœå†…å­˜ï¼ˆæœ€é‡è¦ï¼‰ å¦‚æœæ•°æ®æœ‰ 100 ä¸‡æ¡ï¼Œä½¿ç”¨åˆ—è¡¨ä¼šæŠŠå…¨éƒ¨æ•°æ®ä¸€æ¬¡æ€§åŠ è½½ï¼š\nlst = [i for i in range(1_000_000)] å·¨å¤§å†…å­˜å¼€é”€ã€‚\nä½†ç”Ÿæˆå™¨åªåœ¨ä½ å–ä¸€ä¸ªæ—¶ç”Ÿæˆä¸€ä¸ªï¼š\ngen = (i for i in range(1_000_000)) å‡ ä¹ä¸å å†…å­˜ã€‚\n2. åŠ å¿«å¯åŠ¨é€Ÿåº¦ ç¨‹åºä¸ç”¨ç­‰å…¨éƒ¨æ•°æ®å‡†å¤‡å¥½ï¼Œå³å¯å¼€å§‹å¤„ç†ã€‚\n3. æµå¼å¤„ç† ä¾‹å¦‚ï¼š\né€è¡Œè¯»å–å¤§æ–‡ä»¶ ç½‘ç»œæµ åˆ†é¡µæ•°æ®åº“æŸ¥è¯¢ Kafkaã€Redis é˜Ÿåˆ—æ¶ˆè´¹ éƒ½æ˜¯å…¸å‹çš„â€œæƒ°æ€§â€æ¨¡å‹ã€‚\nğŸ†š æƒ°æ€§ vs éæƒ°æ€§ï¼ˆç«‹å³æ‰§è¡Œï¼‰ æ–¹å¼ æƒ°æ€§ï¼Ÿ ä¸¾ä¾‹ è¡Œä¸º ç”Ÿæˆå™¨ âœ… æ˜¯ yieldã€(x for x in \u0026hellip;) éœ€è¦æ—¶æ‰ç”Ÿæˆ åˆ—è¡¨æ¨å¯¼å¼ âŒ å¦ [x for x in \u0026hellip;] ä¸€æ¬¡æ€§ç”Ÿæˆå…¨éƒ¨ mapã€filter âœ… Python3 æ˜¯ map(), filter() è¿”å›å¯è¿­ä»£å¯¹è±¡ï¼Œä¸ç«‹å³æ‰§è¡Œ range() âœ… range(1000000) ä¸åˆ›å»ºåˆ—è¡¨ï¼Œåªä¿å­˜è¾¹ç•Œ list()ã€sum() âŒ å¦ list(gen) ä¸€æ¬¡æ€§æ¶ˆè€— ğŸ§© å…³é”®ç‰¹å¾ï¼ˆè®°ä½è¿™ 3 æ¡å°±æ‡‚æƒ°æ€§ï¼‰ ä¸æå‰å ç”¨å†…å­˜ ä¸ç«‹å³æ‰§è¡Œé€»è¾‘ ä»…åœ¨ä½¿ç”¨å…ƒç´ æ—¶æ‰æ‰§è¡Œ/ç”Ÿæˆ ğŸ¯ ç¤ºä¾‹ï¼šæƒ°æ€§è¯»å–å¤§æ–‡ä»¶ def read_lines(fp): with open(fp) as f: for line in f: yield line.rstrip() for éå†æ—¶ï¼š\nfor line in read_lines(\u0026#34;big.log\u0026#34;): print(line) æ–‡ä»¶ä¸ä¼šä¸€æ¬¡æ€§è¯»å…¥å†…å­˜ï¼Œè€Œæ˜¯ æŒ‰è¡Œè¯»å–ï¼ˆæƒ°æ€§ï¼‰ã€‚\nğŸ“Œ æ€»ç»“ Python çš„æƒ°æ€§ï¼ˆLazy Evaluationï¼‰æŒ‡çš„æ˜¯ï¼šåªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰è®¡ç®—å€¼æˆ–ç”Ÿæˆæ•°æ®ï¼Œä»è€ŒèŠ‚çœå†…å­˜ã€æé«˜æ•ˆç‡ã€‚å…¸å‹æ¡ˆä¾‹åŒ…æ‹¬ç”Ÿæˆå™¨ã€rangeã€mapã€filterï¼Œå®ƒä»¬ä¸ä¼šç«‹å³åˆ›å»ºå®Œæ•´çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯åœ¨è¿­ä»£æ—¶é€ä¸ªç”Ÿæˆå…ƒç´ ã€‚\nPython ä¸­æ‰€æœ‰â€œæƒ°æ€§å¯¹è±¡â€æ¸…å• ä»¥ä¸‹æ˜¯ä¸€ä»½ ã€ŒPython ä¸­æ‰€æœ‰å¸¸è§æƒ°æ€§ï¼ˆLazyï¼‰å¯¹è±¡ä¸æƒ°æ€§æœºåˆ¶æ¸…å•ã€ â€”â€” éå¸¸ç³»ç»Ÿä¸”å®ç”¨ï¼Œé€‚åˆåšé€ŸæŸ¥è¡¨ã€‚\nâœ… Python ä¸­æ‰€æœ‰å¸¸è§çš„â€œæƒ°æ€§å¯¹è±¡â€ï¼ˆLazy Objectsï¼‰ æƒ°æ€§ï¼ˆLazyï¼‰= ä¸ä¼šç«‹åˆ»è®¡ç®—/ç”Ÿæˆæ•°æ®ï¼Œè€Œæ˜¯åœ¨éœ€è¦æ—¶æ‰è¿›è¡Œè®¡ç®—ã€‚\nâ¸»\nğŸŸ¦ ä¸€ã€ç”Ÿæˆå™¨ï¼ˆGeneratorsï¼‰â€”â€” æœ€å…¸å‹çš„æƒ°æ€§å¯¹è±¡ ç±»å‹ ç¤ºä¾‹ æè¿° ç”Ÿæˆå™¨å‡½æ•° def f(): yield x è°ƒç”¨åè¿”å›ç”Ÿæˆå™¨å¯¹è±¡ï¼ŒæŒ‰éœ€ç”Ÿæˆå€¼ ç”Ÿæˆå™¨è¡¨è¾¾å¼ (x*x for x in range(10)) è¯­æ³•ç±»ä¼¼åˆ—è¡¨æ¨å¯¼å¼ï¼Œä½†ä¸ä¼šä¸€æ¬¡æ€§ç”Ÿæˆå…¨éƒ¨æ•°æ® è¿­ä»£å™¨å¯¹è±¡å†…çš„ next() è¡Œä¸º next(it) æ¯æ¬¡å–ä¸€ä¸ªï¼Œä¸ä¼šé¢„å…ˆç”Ÿæˆ ğŸŸ¦ äºŒã€è¿­ä»£å™¨ï¼ˆIteratorsï¼‰â€”â€” å¤§å¤šæ˜¯æƒ°æ€§çš„ å¯è¿­ä»£å¯¹è±¡ï¼ˆlist/tuple/dictï¼‰ä¸æ˜¯è¿­ä»£å™¨ï¼Œä½† iter() èƒ½åˆ›å»ºè¿­ä»£å™¨ã€‚\nå¸¸è§æƒ°æ€§è¿­ä»£å™¨ï¼š\nå¯¹è±¡ ç¤ºä¾‹ æƒ°æ€§è¡Œä¸º iter(list) iter([1,2,3]) é€ä¸ªè¿”å›å…ƒç´ ï¼Œä¸å¤åˆ¶ dict.keys() / values() / items() d.items() åŠ¨æ€è§†å›¾ï¼Œè®¿é—®æ—¶æ‰å–å€¼ file å¯¹è±¡ f = open(\u0026lsquo;xx\u0026rsquo;); next(f) ä¸€æ¬¡è¯»ä¸€è¡Œï¼Œä¸è¯»å–æ•´ä¸ªæ–‡ä»¶ enumerate enumerate([1,2,3]) æ¯æ¬¡ç”Ÿæˆä¸€ä¸ªå…ƒç»„ï¼Œä¸é¢„ç”Ÿæˆæ‰€æœ‰é¡¹ zip zip(a, b) å¹¶è¡Œé€é¡¹äº§ç”Ÿï¼Œä¸æ„å»ºåˆ—è¡¨ map map(f, iterable) æ¯æ¬¡è°ƒç”¨å‡½æ•°ç”Ÿæˆä¸€ä¸ªå€¼ filter filter(f, iterable) æƒ°æ€§è¿‡æ»¤ï¼ŒæŒ‰éœ€ç”Ÿæˆ reversed(iterator) éƒ¨åˆ†æƒ°æ€§ å¯¹è¿­ä»£å™¨æ˜¯æƒ°æ€§çš„ iter(callable, sentinel) è‡ªå®šä¹‰è¿­ä»£å™¨ æ¯æ¬¡è°ƒç”¨å‡½æ•°ç”Ÿæˆä¸€ä¸ªå€¼ ğŸŸ¦ ä¸‰ã€æ ‡å‡†åº“ä¸­çš„æƒ°æ€§å¯¹è±¡ï¼ˆé‡è¦ï¼‰ 1ï¼‰range() ä»£è¡¨åŒºé—´ï¼Œä¸ç”ŸæˆçœŸå®åˆ—è¡¨ è®¿é—®å…ƒç´ æ—¶æ‰è®¡ç®— 2ï¼‰itertools æ¨¡å— è¿™æ•´ä¸ªæ¨¡å—éƒ½æ˜¯â€œæƒ°æ€§çš„â€ï¼ŒåŒ…æ‹¬ï¼š\nå‡½æ•° è¯´æ˜ count() æ— é™è®¡æ•°åºåˆ— cycle() æ— é™å¾ªç¯ repeat() é‡å¤ä¸€ä¸ªå¯¹è±¡ islice() æƒ°æ€§åˆ‡ç‰‡ chain() è¿æ¥å¤šä¸ªå¯è¿­ä»£å¯¹è±¡ compress() æ ¹æ®æ©ç è¿‡æ»¤ accumulate() æƒ°æ€§ç´¯åŠ  takewhile() æ¡ä»¶æˆç«‹ç”Ÿæˆ dropwhile() æ¡ä»¶æˆç«‹ä¸¢å¼ƒ itertools æ˜¯å…¸å‹çš„æƒ°æ€§å·¥å…·é›†ã€‚\nğŸŸ¦ å››ã€å¼‚æ­¥æƒ°æ€§å¯¹è±¡ï¼ˆAsync Lazy Objectsï¼‰ Python 3.6+ å¼•å…¥äº†å¼‚æ­¥è¿­ä»£å™¨ï¼Œä¹Ÿå¤©ç„¶æ˜¯æƒ°æ€§çš„ã€‚\n| å¯¹è±¡ç±»åˆ« | ç¤ºä¾‹ | æè¿° | | \u0026mdash; | \u0026mdash; | | å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•° | async def gen(): yield x | æŒ‰éœ€ await ç”Ÿæˆ | | aiter / anext | aiter(obj) | å¼‚æ­¥æƒ°æ€§è¿­ä»£ | | async for | å¼‚æ­¥æµå¼å¤„ç†æ•°æ® |\nå¸¸ç”¨äº I/O æµå¼æ•°æ®ã€‚\nğŸŸ¦ äº”ã€å…¶ä»–å…·æœ‰â€œæƒ°æ€§è¡Œä¸ºâ€çš„ç»“æ„ å¯¹è±¡ ç¤ºä¾‹ æƒ°æ€§ç‚¹ memoryview memoryview(b) ä¸å¤åˆ¶æ•°æ®ï¼ŒæŒ‰éœ€è®¿é—® æŸäº› NumPy array views arr[::2] è§†å›¾ä¸å¤åˆ¶ï¼Œä»…æƒ°æ€§å¼•ç”¨ pandas iterrows / itertuples æƒ°æ€§äº§ç”Ÿè¡Œæ•°æ® æ—¥å¿—æ¨¡å—çš„æƒ°æ€§æ ¼å¼åŒ– logger.debug(\u0026ldquo;x=%s\u0026rdquo;, x) ä¸åˆ° debug çº§åˆ«ä¸æ ¼å¼åŒ– ğŸŸ¦ å…­ã€å“ªäº›ä¸æ˜¯æƒ°æ€§çš„ï¼Ÿ å¯¹æ¯”ä¸€ä¸‹ï¼š\nç±»å‹ æ˜¯å¦æƒ°æ€§ åŸå›  list/tuple/set/dict âŒ é©¬ä¸Šæ„å»ºå…¨éƒ¨å†…å®¹ list comprehension âŒ ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰å…ƒç´  set/dict comprehension âŒ åŒä¸Š sorted() âŒ ç«‹å³æ’åºè¿”å›æ–°åˆ—è¡¨ read() è¯»æ–‡ä»¶ âŒ ä¸€æ¬¡è¯»å®Œ ğŸŸ§ æ€»ç»“ï¼ˆé€ŸæŸ¥ç‰ˆï¼‰ âœ… æƒ°æ€§ï¼šæŒ‰éœ€ generator, iterator, range, map, filter, zip, enumerate, yield, yield from, itertools.*\nâœ… å¼‚æ­¥æƒ°æ€§ async generator, aiter, anext, async for\nâœ… ç‰¹æ®Šæƒ°æ€§ memoryview, numpy/pandas è§†å›¾å‹æ“ä½œ\nâŒ éæƒ°æ€§ list/tuple/set/dict + comprehension\nå¦‚ä½•è‡ªå·±å®ç°ä¸€ä¸ªâ€œæƒ°æ€§å¯¹è±¡â€ ä»¥ä¸‹æ˜¯ä¸€å¥— ä»ç®€å• -\u0026gt; è¿›é˜¶ çš„æŒ‡å—ï¼Œæ•™ä½ å¦‚ä½•åœ¨ Python ä¸­ è‡ªå·±å®ç°ä¸€ä¸ªâ€œæƒ°æ€§å¯¹è±¡â€ï¼ˆLazy Objectï¼‰ã€‚\nå†…å®¹éå¸¸å®ç”¨ï¼Œé€‚ç”¨äºä½ ä»»ä½•é¡¹ç›®ï¼Œä¾‹å¦‚æ•°æ®æŸ¥è¯¢ã€åˆ†é¡µã€ç½‘ç»œè¯·æ±‚ã€æµå¼å¤„ç†ç­‰ã€‚\nâœ… ä¸€ã€ä»€ä¹ˆå«â€œæƒ°æ€§å¯¹è±¡â€ï¼Ÿ æƒ°æ€§å¯¹è±¡ = ä¸ç«‹å³è®¡ç®—ï¼Œç­‰åˆ°éœ€è¦æ—¶æ‰è®¡ç®—ã€‚\nåœ¨ Python ä¸­ï¼š\néœ€è¦æ—¶æ‰ç”Ÿæˆæ•°æ® -\u0026gt; æƒ°æ€§ç”Ÿæˆï¼ˆlazy generationï¼‰ éœ€è¦æ—¶æ‰è®¡ç®—ç»“æœ -\u0026gt; æƒ°æ€§è®¡ç®—ï¼ˆlazy evaluationï¼‰ ğŸŸ¦ äºŒã€æœ€ç®€å•çš„ï¼šç”¨ __iter__ + __next__ è‡ªå®šä¹‰æƒ°æ€§è¿­ä»£å™¨ ä¸‹é¢æ˜¯ä¸€ä¸ª ä¸€æ¬¡åªç”Ÿæˆä¸€ä¸ªå€¼ çš„æƒ°æ€§å¯¹è±¡ï¼š\nclass LazyCounter: def __init__(self, start, end): self.current = start self.end = end def __iter__(self): return self def __next__(self): if self.current \u0026gt;= self.end: raise StopIteration value = self.current self.current += 1 return value ä½¿ç”¨ï¼š\ncounter = LazyCounter(0, 5) for x in counter: print(x) ç‰¹ç‚¹ï¼š\nä¸ç”Ÿæˆ list æ¯æ¬¡ next æ‰äº§ç”Ÿä¸€ä¸ªå€¼ å†…å­˜å ç”¨æä½ ğŸŸ¦ ä¸‰ã€ç”¨ç”Ÿæˆå™¨æ›´ç®€å•ï¼šyieldï¼ˆæƒ°æ€§ç”Ÿæˆçš„æ¨èæ–¹å¼ï¼‰ def lazy_numbers(start, end): while start \u0026lt; end: yield start start += 1 ä½¿ç”¨ï¼š\nfor n in lazy_numbers(0, 5): print(n) ä¼˜ç‚¹ï¼š\nè‡ªåŠ¨å®ç°è¿­ä»£å™¨åè®® å†™æ³•æ›´ç®€æ´ é€»è¾‘æ›´æ¸…æ™° ğŸŸ¦ å››ã€æƒ°æ€§å±æ€§ï¼ˆLazy Propertyï¼‰ å½“ä½ å¸Œæœ›ä¸€ä¸ªå±æ€§ç¬¬ä¸€æ¬¡è®¿é—®æ—¶è®¡ç®—ï¼Œä»¥åç¼“å­˜ï¼š\nclass LazyObject: @property def heavy_result(self): print(\u0026#34;Running heavy computation ...\u0026#34;) return sum(i*i for i in range(10_000_000)) ä½†è¿™æ ·æ¯æ¬¡è®¿é—®éƒ½é‡æ–°è®¡ç®—ã€‚æˆ‘ä»¬è®©å®ƒå˜æˆ æƒ°æ€§ä¸”ç¼“å­˜ï¼š\nclass LazyObject: @property def heavy_result(self): if not hasattr(self, \u0026#34;_cached\u0026#34;): print(\u0026#34;Running heavy computation ...\u0026#34;) self._cached = sum(i*i for i in range(10_000_000)) return self._cached ç”¨æ³•ï¼š\nobj = LazyObject() print(obj.heavy_result) # ç¬¬ä¸€æ¬¡ï¼Œæ‰§è¡Œè®¡ç®— print(obj.heavy_result) # ç¬¬äºŒæ¬¡ï¼Œè¯»å–ç¼“å­˜ ğŸŸ¦ äº”ã€æƒ°æ€§å¯¹è±¡ç±»ï¼šæŒ‰éœ€ä»æ•°æ®åº“ / API å–æ•°æ® æ›´å®é™…ä¸€ç‚¹çš„ï¼šä¾‹å¦‚â€œè‚¡ç¥¨æ•°æ®æµå¼è·å–â€\nclass StockLazyFetcher: def __init__(self, fetch_func): self.fetch_func = fetch_func self.buffer = [] self.finished = False def __iter__(self): return self def __next__(self): if not self.buffer and not self.finished: chunk = self.fetch_func() # ä¸€æ¬¡ä» API æ‹¿ä¸€æ‰¹ if not chunk: self.finished = True else: self.buffer.extend(chunk) if not self.buffer: raise StopIteration return self.buffer.pop(0) ä½¿ç”¨ï¼š\nfetcher = StockLazyFetcher(fetch_api) for stock in fetcher: print(stock) ç›Šå¤„ï¼š\nä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ® å‡å°‘ API å‹åŠ›ã€æ•°æ®åº“å‹åŠ› ç‰¹åˆ«é€‚åˆåˆ†é¡µ APIã€æ—¥å¿—æµã€æ¶ˆæ¯é˜Ÿåˆ— ğŸŸ¦ å…­ã€æƒ°æ€§åºåˆ—ï¼ˆLazySequenceï¼‰ï¼šåªåœ¨è®¿é—®æ—¶è®¡ç®— å®ç°ä¸€ä¸ªæƒ°æ€§çš„ Fibonacciï¼š\nclass LazyFibo: def __init__(self): self.cache = [0, 1] def __getitem__(self, n): while len(self.cache) \u0026lt;= n: self.cache.append(self.cache[-1] + self.cache[-2]) return self.cache[n] ä½¿ç”¨ï¼š\nf = LazyFibo() print(f[10]) # ç¬¬ä¸€æ¬¡è®¡ç®— print(f[50]) # è‡ªåŠ¨ç®—åˆ° 50 print(f[10]) # ç›´æ¥ä½¿ç”¨ç¼“å­˜ è¿™æ˜¯ â€œæƒ°æ€§ + ç¼“å­˜ï¼ˆmemoizationï¼‰â€ çš„ç»å…¸æ¨¡å¼ã€‚\nğŸŸ¦ ä¸ƒã€æƒ°æ€§åŒ…è£…å™¨ï¼ˆLazy Wrapperï¼‰â€”â€”è®©ä»»æ„å‡½æ•°å˜æƒ°æ€§ ä¾‹å¦‚ï¼š\nclass Lazy: def __init__(self, func, *args, **kwargs): self.func = func self.args = args self.kwargs = kwargs self._value = None self._done = False def value(self): if not self._done: self._value = self.func(*self.args, **self.kwargs) self._done = True return self._value ä½¿ç”¨ï¼š\nimport time def slow_add(a, b): time.sleep(2) return a + b lazy_result = Lazy(slow_add, 3, 5) print(\u0026#34;not executed yet\u0026#34;) print(lazy_result.value()) # 2ç§’è®¡ç®— print(lazy_result.value()) # ç«‹å³è¿”å› ğŸŸ¦ å…«ã€æ€»ç»“ï¼ˆé€ŸæŸ¥ç‰ˆï¼‰ æƒ°æ€§ç±»å‹ ç¤ºä¾‹ é€‚ç”¨åœºæ™¯ æƒ°æ€§è¿­ä»£å™¨ __iter__ + __next__ æµå¼æ•°æ®ã€æ— é™åºåˆ— ç”Ÿæˆå™¨ yield æœ€å¸¸ç”¨æƒ°æ€§ç”Ÿæˆ æƒ°æ€§å±æ€§ lazy @property é‡è®¡ç®—ç¼“å­˜ æƒ°æ€§åºåˆ— __getitem__ æ— é™æ•°ç»„ã€æ•°å­¦åºåˆ— æƒ°æ€§åŒ…è£…å™¨ Lazy(func) å»¶è¿Ÿæ‰§è¡Œå¤æ‚é€»è¾‘ æ•°æ®æµæƒ°æ€§æ‹‰å– fetcher API åˆ†é¡µã€æ•°æ®åº“æ‡’åŠ è½½ Next def lazy_numbers(start, end): while start \u0026lt; end: yield start start += 1 start += 1 ä¸ºä»€ä¹ˆè¦æ”¾åœ¨ yield start ä¹‹åï¼Ÿ\næŠŠ start += 1 æ”¾åœ¨ yield start ä¹‹åï¼Œæ˜¯ä¸ºäº†ä¿è¯ç”Ÿæˆçš„åºåˆ—é¡ºåºæ­£ç¡®ã€å€¼ä¸ä¼šè·³è¿‡ã€‚\nä¸‹é¢ç»™ä½ è¯¦ç»†è§£é‡Šï¼š\nâœ… ç»“è®º yield start ä¼š å…ˆè¿”å›å½“å‰å€¼ï¼Œç„¶å start += 1 å†è®©ä¸‹æ¬¡è¿­ä»£è¿”å›ä¸‹ä¸€ä¸ªå€¼ã€‚\nå¦‚æœä½ æŠŠ start += 1 æ”¾å‰é¢ï¼Œä¼šå¯¼è‡´å°‘ä¸€ä¸ªå€¼ / ç¬¬ä¸€ä¸ªå€¼ä¸¢å¤±ã€‚\nâœ… ä¸ºä»€ä¹ˆè¦å†™åœ¨åé¢ï¼Ÿï¼ˆé€è¡Œæµç¨‹ï¼‰ ä»¥ä½ çš„ä»£ç ä¸ºä¾‹ï¼š\ndef lazy_numbers(start, end): while start \u0026lt; end: yield start # â‘  æŠŠå½“å‰ start è¿”å›ç»™è°ƒç”¨è€… start += 1 # â‘¡ æ›´æ–° startï¼Œä¸‹ä¸€è½®ä¼šè¿”å›æ–°å€¼ å¦‚æœ start=0 end=3ï¼š\nå¾ªç¯ yield è¿”å›å€¼ æ›´æ–°å start ç¬¬1æ¬¡ 0 1 ç¬¬2æ¬¡ 1 2 ç¬¬3æ¬¡ 2 3 -\u0026gt; while ç»“æŸ ç”Ÿæˆï¼š0, 1, 2\nè¡Œä¸ºå®Œå…¨ç¬¦åˆ range(start, end)ã€‚\nâŒ å¦‚æœ start += 1 æ”¾åœ¨ yield å‰é¢ï¼Ÿ æ”¹æˆè¿™æ ·ï¼š\ndef lazy_numbers(start, end): while start \u0026lt; end: start += 1 yield start å†çœ‹æµç¨‹ï¼š\nstart=0, end=3\nå¾ªç¯ start+=1 å yield è¿”å›å€¼ ç¬¬1æ¬¡ 1 1 ç¬¬2æ¬¡ 2 2 ç¬¬3æ¬¡ 3 while ç»ˆæ­¢ï¼ˆä¸ yieldï¼‰ ç»“æœï¼š1, 2\nğŸ‘‰ 0 è¢«è·³è¿‡äº† ğŸ‘‰ 3 æ²¡æœ‰è¢« yield è¿™æ˜¾ç„¶ä¸ç¬¦åˆé¢„æœŸã€‚\nğŸ“Œ å’Œ for i in range(start, end) ä¸€æ ·çš„é€»è¾‘ çœŸæ­£æ¨¡æ‹Ÿ range çš„å†™æ³•å¿…é¡»æ˜¯ï¼š\nç¬¬ä¸€æ¬¡äº§å‡º start æœ¬èº« ç„¶åå†å¢åŠ  start å¦åˆ™è¡Œä¸ºæ— æ³•ä¸ range å¯¹é½ã€‚\nğŸ¯ æœ€é€šä¿—çš„è§£é‡Š yield ç±»ä¼¼ï¼š\nâ€œæŠŠè¿™ä¸ªå€¼ç»™ä½ ï¼Œç­‰ä½ ä¸‹ä¸€æ¬¡æ¥æ‹¿çš„æ—¶å€™ï¼Œæˆ‘å†æ›´æ–°çŠ¶æ€ã€‚â€\næ‰€ä»¥å¿…é¡»ï¼š\nå…ˆç»™å½“å‰å€¼ (yield start) å†å‡†å¤‡ä¸‹ä¸€æ¬¡çš„å€¼ (start += 1) å¦‚æœé¡ºåºåäº†ï¼š\nâ€œæˆ‘å…ˆæ›´æ–°å†ç»™ä½ â€ï¼Œé‚£ç¬¬ä¸€æ¬¡å°±é”™äº†ã€‚\n","description":" ä»€ä¹ˆæ˜¯æƒ°æ€§ åœ¨ Python ä¸­ï¼Œâ€œæƒ°æ€§ï¼ˆlazyï¼‰â€æŒ‡çš„æ˜¯ï¼š\nâœ… ä¸ç«‹å³è®¡ç®—æˆ–ç”Ÿæˆæ•°æ®ï¼Œè€Œæ˜¯åœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œã€‚\nå³ï¼šæŒ‰éœ€è®¡ç®—ã€å»¶è¿Ÿæ‰§è¡Œã€‚\nğŸ”¥ è§£é‡Š æƒ°æ€§ = æ•°æ®ä¸æ˜¯é©¬ä¸Šç”Ÿæˆï¼Œè€Œæ˜¯ç”¨åˆ°æ—¶æ‰ç”Ÿæˆã€‚\nğŸš€ å…¸å‹ä»£è¡¨ï¼šç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ ä¾‹å¦‚ï¼š\ndef generate_items(): for i in range(10): print(\u0026#34;ç”Ÿæˆ:\u0026#34;, i) yield i è°ƒç”¨ï¼š\ngen = generate_items() æ­¤æ—¶ æ²¡æœ‰æ‰“å°ä»»ä½•ä¸œè¥¿ã€‚\n"},{"id":288,"href":"/operations/linux/sysctl-danger-list/","title":"Linux å†…æ ¸ \"ä¸€è°ƒå°±ç¿»è½¦\" å±é™©å‚æ•°æ¸…å•","parent":"Linux","content":"ä¸‹é¢è¿™ä»½æ˜¯ çœŸæ­£çš„ã€Œä¸€è°ƒå°±ç¿»è½¦ã€å†…æ ¸å‚æ•°é»‘åå•ã€‚\nç‰¹ç‚¹åªæœ‰ä¸€ä¸ªï¼šä¸æ˜¯æ€§èƒ½å‚æ•°ï¼Œè€Œæ˜¯â€œè¯­ä¹‰ / å®‰å…¨ / æ­£ç¡®æ€§â€å‚æ•°ï¼Œ\nğŸ‘‰ è°ƒé”™ä¸æ˜¯â€œå˜æ…¢â€ï¼Œè€Œæ˜¯ï¼šæ–­ç½‘ã€ä¸¢æ•°æ®ã€è¿›ç¨‹è¢«æ€ã€ç³»ç»Ÿä¸ç¨³å®šã€‚\næŒ‰ é£é™©ç­‰çº§ + ç¿»è½¦æ–¹å¼ + æ­£ç¡®è®¤çŸ¥ ç»™ä½ ä¸€ä»½å¯ç›´æ¥çº³å…¥è¿ç»´è§„èŒƒçš„æ¸…å•ã€‚\nç»“è®ºå…ˆè¡Œ\nğŸ‘‰ è¿™äº›å‚æ•° ä¸é€‚åˆâ€œåŠ¨æ€ç®—â€\nğŸ‘‰ ä¸é€‚åˆâ€œç½‘ä¸ŠæŠ„ä¸€å¥—â€\nğŸ‘‰ æ”¹ä¹‹å‰å¿…é¡»çŸ¥é“â€œä½ åœ¨æ”¹å˜ä»€ä¹ˆç³»ç»Ÿè¡Œä¸ºâ€\nä¸€ã€å†…å­˜ / OOM / è¿›ç¨‹ç›¸å…³ï¼ˆæœ€é«˜ç¿»è½¦ç‡ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥ 1. vm.overcommit_memoryï¼ˆç¿»è½¦ç‹ï¼‰ vm.overcommit_memory = 2 âŒ å¸¸è§ç¿»è½¦ PostgreSQL / Redis å¯åŠ¨å¤±è´¥ Java / Python malloc failed K8S Pod éšæœºå¯åŠ¨ä¸äº† â—æœ¬è´¨ è¿™æ˜¯â€œå†…å­˜åˆ†é…ç­–ç•¥â€ï¼Œä¸æ˜¯æ€§èƒ½å‚æ•°\nå€¼ å«ä¹‰ 0 å¯å‘å¼ï¼ˆé»˜è®¤ï¼Œæœ€å®‰å…¨ï¼‰ 1 å…è®¸è¿‡åº¦åˆ†é… 2 ä¸¥æ ¼é™åˆ¶ï¼ˆç”Ÿäº§æœ€å®¹æ˜“ç¿»ï¼‰ âœ… æ­£ç¡®å»ºè®® é€šç”¨æœåŠ¡å™¨ï¼š0 æ•°æ®åº“ä¸“ç”¨ + ç²¾ç¡®è®¡ç®—ï¼šæ‰è€ƒè™‘ 2 2. vm.panic_on_oom vm.panic_on_oom = 1 âŒ å¸¸è§ç¿»è½¦ ä¸€æ¬¡ OOM -\u0026gt; æ•´æœºç›´æ¥é‡å¯ KVM / è£¸æœºå…¨éƒ¨ä¸šåŠ¡ç¬é—´æ¶ˆå¤± â—æœ¬è´¨ è¿™æ˜¯â€œç³»ç»Ÿè‡ªæ€å¼€å…³â€\nâœ… æ­£ç¡®å»ºè®® å‡ ä¹æ°¸è¿œä¸åº”è¯¥å¼€å¯ åªç”¨äºæç«¯é‡‘è / é«˜å¯ç”¨èŠ‚ç‚¹ 3. kernel.oom_kill_allocating_task kernel.oom_kill_allocating_task = 1 âŒ å¸¸è§ç¿»è½¦ æ­£åœ¨å†™æ•°æ®çš„æ•°æ®åº“è¿›ç¨‹è¢«ç›´æ¥æ€ Redis RDB / AOF ä¸­æ–­ â—æœ¬è´¨ è°ç”³è¯·å†…å­˜å°±æ€è°ï¼ˆä¸çœ‹é‡è¦æ€§ï¼‰\nâœ… æ­£ç¡®å»ºè®® ä¿æŒé»˜è®¤ 0 ç”¨ OOMScoreAdjust ç²¾å‡†æ§åˆ¶ äºŒã€NUMA / CPU ç›¸å…³ï¼ˆéšè”½å‹ç¿»è½¦ï¼‰ğŸ”¥ğŸ”¥ 4. kernel.numa_balancing kernel.numa_balancing = 1 âŒ å¸¸è§ç¿»è½¦ PostgreSQL / Redis å»¶è¿ŸæŠ–åŠ¨ Python / Java æ€§èƒ½ä¸ç¨³å®š CPU åˆ©ç”¨ç‡ä½ä½†æ€§èƒ½å·® â—æœ¬è´¨ å†…æ ¸è‡ªåŠ¨æ¬å†…å­˜é¡µï¼ˆé¢‘ç¹ TLB å¤±æ•ˆï¼‰\nâœ… æ­£ç¡®å»ºè®® æ•°æ®åº“ / å»¶è¿Ÿæ•æ„ŸæœåŠ¡ï¼š0 æ¡Œé¢ / é€šç”¨è´Ÿè½½ï¼š1 5. kernel.sched_autogroup_enabled kernel.sched_autogroup_enabled = 1 âŒ å¸¸è§ç¿»è½¦ åå°æœåŠ¡ CPU è¢«â€œæ¡Œé¢äº¤äº’â€æŠ¢èµ° å®¹å™¨è°ƒåº¦å¼‚å¸¸ â—æœ¬è´¨ è¿™æ˜¯æ¡Œé¢å‹å¥½ç­–ç•¥\nâœ… æ­£ç¡®å»ºè®® æœåŠ¡å™¨ç»Ÿä¸€è®¾ä¸º 0 ä¸‰ã€ç½‘ç»œå‚æ•°ï¼ˆæœ€å®¹æ˜“â€œçœ‹ä¼¼ä¼˜åŒ–ï¼Œå…¶å®æ–­ç½‘â€ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥ 6. net.ipv4.tcp_tw_recycleï¼ˆå·²åºŸå¼ƒï¼Œä½†ä»æœ‰äººä¹±é…ï¼‰ net.ipv4.tcp_tw_recycle = 1 âŒ å¸¸è§ç¿»è½¦ NAT åå®¢æˆ·ç«¯å¤§é‡è¿æ¥å¤±è´¥ Web æœåŠ¡â€œæ—¶å¥½æ—¶åâ€ â—æœ¬è´¨ è¿å TCP åè®®è®¾è®¡\nâœ… æ­£ç¡®å»ºè®® æ°¸è¿œä¸è¦é…ç½® æ–°å†…æ ¸å·²ç§»é™¤ 7. rp_filter = 1ï¼ˆå¤šç½‘å¡ç›´æ¥ç¿»ï¼‰ net.ipv4.conf.all.rp_filter = 1 âŒ å¸¸è§ç¿»è½¦ åŒç½‘å¡ / å¤šè·¯ç”±æœåŠ¡å™¨æ— æ³•å›åŒ… K8S / VPN / overlay ç½‘ç»œå¼‚å¸¸ â—æœ¬è´¨ ä¸¥æ ¼åå‘è·¯å¾„æ ¡éªŒ\nâœ… æ­£ç¡®å»ºè®® net.ipv4.conf.all.rp_filter = 0 net.ipv4.conf.default.rp_filter = 0 8. tcp_syncookies = 0 net.ipv4.tcp_syncookies = 0 âŒ å¸¸è§ç¿»è½¦ SYN flood ä¸‹ç›´æ¥æ‹’ç»è¿æ¥ è´Ÿè½½é«˜å³°æœåŠ¡é›ªå´© â—æœ¬è´¨ å…³é—­ TCP é˜²æŠ¤æœºåˆ¶\nâœ… æ­£ç¡®å»ºè®® æ°¸è¿œä¿æŒ 1 å››ã€Swap / å†…å­˜å›æ”¶ï¼ˆæ•°æ®åº“ç¿»è½¦é«˜å‘åŒºï¼‰ğŸ”¥ğŸ”¥ğŸ”¥ 9. vm.swappiness = 0ï¼ˆè¢«ä¸¥é‡è¯¯ç”¨ï¼‰ vm.swappiness = 0 âŒ å¸¸è§ç¿»è½¦ å†…å­˜ç´§å¼ æ—¶ç›´æ¥ OOM æ•°æ®åº“è¢«æ€è€Œä¸æ˜¯ swap â—æœ¬è´¨ ä¸æ˜¯â€œç¦ç”¨ swapâ€ï¼Œè€Œæ˜¯â€œæåº¦åŒæ¶ swapâ€\nâœ… æ­£ç¡®å»ºè®® åœºæ™¯ å€¼ æ•°æ®åº“ 1 é€šç”¨æœåŠ¡å™¨ 10~30 ç¦ swap swapoff 10. vm.drop_caches å®šæ—¶ä»»åŠ¡ echo 3 \u0026gt; /proc/sys/vm/drop_caches âŒ å¸¸è§ç¿»è½¦ ç£ç›˜ IO æš´å¢ æ•°æ®åº“ç¼“å­˜è¢«æ¸…ç©º å»¶è¿Ÿé›ªå´© â—æœ¬è´¨ è¿™æ˜¯è°ƒè¯•æ¥å£ï¼Œä¸æ˜¯ä¼˜åŒ–æ‰‹æ®µ\nâœ… æ­£ç¡®å»ºè®® ç¦æ­¢å®šæ—¶æ‰§è¡Œ ä»…ç”¨äºä¸€æ¬¡æ€§æµ‹è¯• äº”ã€æ–‡ä»¶ç³»ç»Ÿ / æ•°æ®ä¸€è‡´æ€§ï¼ˆæ•°æ®çº§ç¿»è½¦ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥ 11. nobarrier / barrier=0 nobarrier âŒ å¸¸è§ç¿»è½¦ æ‰ç”µ -\u0026gt; æ–‡ä»¶ç³»ç»ŸæŸå æ•°æ®åº“ä¸å¯æ¢å¤ â—æœ¬è´¨ ä½ åœ¨å‘Šè¯‰å†…æ ¸ï¼šåº•å±‚å­˜å‚¨â€œç»å¯¹å¯é â€\nâœ… æ­£ç¡®å»ºè®® ä»…åœ¨ å¸¦ç”µæ±  RAID / ä¼ä¸šçº§å­˜å‚¨ ä½¿ç”¨ äº‘ç›˜ / æœ¬åœ°ç›˜ç¦æ­¢ 12. data=writeback âŒ å¸¸è§ç¿»è½¦ å…ƒæ•°æ®å’Œæ•°æ®ä¸ä¸€è‡´ æ–‡ä»¶â€œå­˜åœ¨ä½†å†…å®¹é”™ä¹±â€ âœ… æ­£ç¡®å»ºè®® éç¼“å­˜ç›®å½•è°¨æ…ä½¿ç”¨ å…­ã€ä¸€å¥è¯â€œçº¢çº¿æ€»ç»“â€ğŸ§  å‡¡æ˜¯æ”¹å˜ã€Œåˆ†é…ç­–ç•¥ / ç½‘ç»œè¯­ä¹‰ / ä¸€è‡´æ€§ä¿è¯ / å®‰å…¨å‡è®¾ã€çš„å†…æ ¸å‚æ•°ï¼Œ\néƒ½å±äºâ€œä¸€è°ƒå°±ç¿»è½¦â€çº§åˆ«ï¼Œç»ä¸å…è®¸æ¨¡æ¿åŒ–ã€åŠ¨æ€åŒ–ã€ç…§æŠ„ã€‚\nä¸ƒã€å¯ä»¥ç›´æ¥çº³å…¥è§„èŒƒçš„åˆ†ç±» ğŸš« ç¦æ­¢ä¿®æ”¹ï¼ˆé»‘åå•ï¼‰ vm.panic_on_oom tcp_tw_recycle drop_caches data=writebackï¼ˆéç¼“å­˜ç›®å½•ï¼‰ âš ï¸ å¿…é¡»è¯„å®¡ vm.overcommit_memory nobarrier kernel.numa_balancing rp_filter âœ… å¯å®‰å…¨è°ƒä¼˜ fs.file-max pid_max conntrack_max TCP buffer ","description":"ä¸‹é¢è¿™ä»½æ˜¯ çœŸæ­£çš„ã€Œä¸€è°ƒå°±ç¿»è½¦ã€å†…æ ¸å‚æ•°é»‘åå•ã€‚\nç‰¹ç‚¹åªæœ‰ä¸€ä¸ªï¼šä¸æ˜¯æ€§èƒ½å‚æ•°ï¼Œè€Œæ˜¯â€œè¯­ä¹‰ / å®‰å…¨ / æ­£ç¡®æ€§â€å‚æ•°ï¼Œ\nğŸ‘‰ è°ƒé”™ä¸æ˜¯â€œå˜æ…¢â€ï¼Œè€Œæ˜¯ï¼šæ–­ç½‘ã€ä¸¢æ•°æ®ã€è¿›ç¨‹è¢«æ€ã€ç³»ç»Ÿä¸ç¨³å®šã€‚\næŒ‰ é£é™©ç­‰çº§ + ç¿»è½¦æ–¹å¼ + æ­£ç¡®è®¤çŸ¥ ç»™ä½ ä¸€ä»½å¯ç›´æ¥çº³å…¥è¿ç»´è§„èŒƒçš„æ¸…å•ã€‚\nç»“è®ºå…ˆè¡Œ\nğŸ‘‰ è¿™äº›å‚æ•° ä¸é€‚åˆâ€œåŠ¨æ€ç®—â€\nğŸ‘‰ ä¸é€‚åˆâ€œç½‘ä¸ŠæŠ„ä¸€å¥—â€\nğŸ‘‰ æ”¹ä¹‹å‰å¿…é¡»çŸ¥é“â€œä½ åœ¨æ”¹å˜ä»€ä¹ˆç³»ç»Ÿè¡Œä¸ºâ€\nä¸€ã€å†…å­˜ / OOM / è¿›ç¨‹ç›¸å…³ï¼ˆæœ€é«˜ç¿»è½¦ç‡ï¼‰ğŸ”¥ğŸ”¥ğŸ”¥ 1. vm.overcommit_memoryï¼ˆç¿»è½¦ç‹ï¼‰ vm.overcommit_memory = 2 âŒ å¸¸è§ç¿»è½¦ PostgreSQL / Redis å¯åŠ¨å¤±è´¥ Java / Python malloc failed K8S Pod éšæœºå¯åŠ¨ä¸äº† â—æœ¬è´¨ è¿™æ˜¯â€œå†…å­˜åˆ†é…ç­–ç•¥â€ï¼Œä¸æ˜¯æ€§èƒ½å‚æ•°\n"},{"id":289,"href":"/operations/linux/sysctl-dynamic-adjustment/","title":"Linux å†…æ ¸ æ ¹æ® CPU å’Œ å†…å­˜ åŠ¨æ€è°ƒæ•´","parent":"Linux","content":"å“ªäº›å†…æ ¸å‚æ•°é€‚åˆæ ¹æ®CPUå’Œå†…å­˜åŠ¨æ€è°ƒæ•´ï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šã€è€Œä¸”éå¸¸â€œç”Ÿäº§å‘â€çš„é—®é¢˜ ğŸ‘\nç»“è®ºå…ˆè¡Œï¼šä¸æ˜¯æ‰€æœ‰å†…æ ¸å‚æ•°éƒ½é€‚åˆâ€œåŠ¨æ€ç®—â€ï¼Œä½†æœ‰ä¸€å°éƒ¨åˆ†â€œå¼ºçƒˆé€‚åˆâ€æ ¹æ® CPU / å†…å­˜è‡ªåŠ¨è°ƒæ•´ï¼Œå…¶ä½™è¦ä¹ˆå›ºå®šå€¼æ›´å®‰å…¨ï¼Œè¦ä¹ˆåªå’Œåœºæ™¯æœ‰å…³ã€‚\næŒ‰ â€œå¼ºçƒˆå»ºè®®åŠ¨æ€ -\u0026gt; å¯é€‰åŠ¨æ€ -\u0026gt; ä¸å»ºè®®åŠ¨æ€â€ ç»™ä½ ä¸€ä»½æ¸…æ™°æ¸…å•ï¼Œå¹¶ç»™å‡ºè®¡ç®—é€»è¾‘ä¸åŸå› ã€‚\nä¸€ã€å¼ºçƒˆå»ºè®®æ ¹æ® CPU / å†…å­˜åŠ¨æ€è°ƒæ•´çš„å†…æ ¸å‚æ•° âœ… è¿™äº›å‚æ•°ä¸ç³»ç»Ÿå®¹é‡å¼ºç›¸å…³ï¼Œå†™æ­»å®¹æ˜“æµªè´¹æˆ–æˆä¸ºç“¶é¢ˆã€‚\n1ï¸âƒ£ kernel.pid_maxï¼ˆå¼ºçƒˆï¼‰ ä½œç”¨ï¼šæœ€å¤§è¿›ç¨‹ / çº¿ç¨‹æ•°\næ ¸å¿ƒç“¶é¢ˆï¼šçº¿ç¨‹å¤šçš„æœåŠ¡ï¼ˆJava / Python / K8S / PostgreSQLï¼‰\næ¨èè§„åˆ™ pid_max â‰ˆ CPU æ ¸æ•° Ã— 32768 ç¤ºä¾‹ CPU æ¨è pid_max 2 æ ¸ 65536 4 æ ¸ 131072 8 æ ¸ 262144 â‰¥16 æ ¸ 524288 ~ 1048576 é…ç½®ç¤ºä¾‹ kernel.pid_max = 262144 2ï¸âƒ£ fs.file-maxï¼ˆå¼ºçƒˆï¼‰ ä½œç”¨ï¼šç³»ç»Ÿçº§æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°\nå½±å“å¯¹è±¡ï¼šæ•°æ®åº“ã€K8Sã€Nginxã€Redisã€Prometheus\næ¨èè§„åˆ™ file-max â‰ˆ å†…å­˜(GB) Ã— 262144 ç¤ºä¾‹ å†…å­˜ file-max 4 GB 1048576 8 GB 2097152 16 GB 4194304 fs.file-max = 4194304 3ï¸âƒ£ net.netfilter.nf_conntrack_maxï¼ˆå¼ºçƒˆï¼‰ ä½œç”¨ï¼šæœ€å¤§ç½‘ç»œè¿æ¥è·Ÿè¸ªæ•°\nK8S / å®¹å™¨ / NAT å¿…é¡»\næ¨èè§„åˆ™ nf_conntrack_max â‰ˆ å†…å­˜(MB) Ã— 64 ç¤ºä¾‹ å†…å­˜ conntrack 4 GB 262144 8 GB 524288 16 GB 1048576 net.netfilter.nf_conntrack_max = 524288 net.netfilter.nf_conntrack_buckets = 131072 buckets â‰ˆ conntrack / 4\n4ï¸âƒ£ vm.max_map_countï¼ˆå¼ºçƒˆï¼‰ ä½œç”¨ï¼šæœ€å¤§ mmap æ•°\nJVM / Elasticsearch / MongoDB å¿…é¡»\næ¨èè§„åˆ™ max_map_count â‰ˆ å†…å­˜(GB) Ã— 16384 å¸¸ç”¨å®‰å…¨å€¼ vm.max_map_count = 262144 äºŒã€é€‚åˆâ€œæœ‰æ¡ä»¶â€åŠ¨æ€è°ƒæ•´çš„å‚æ•° âš ï¸ è¿™äº›å‚æ•°ä¸æ˜¯å¿…é¡»åŠ¨æ€ï¼Œä½†åœ¨é«˜å¹¶å‘ / å¤§å†…å­˜æœºå™¨ä¸Šæœ‰æ˜æ˜¾æ”¶ç›Šã€‚\n5ï¸âƒ£ TCP ç¼“å†²åŒºï¼ˆä¸å†…å­˜ç›¸å…³ï¼‰ net.core.rmem_max net.core.wmem_max net.ipv4.tcp_mem æ¨èè§„åˆ™ tcp_mem â‰ˆ å†…å­˜é¡µæ•° Ã— 0.01 / 0.02 / 0.03 ç®€åŒ–ç»éªŒå€¼ï¼ˆå¤Ÿç¨³ï¼‰ å†…å­˜ tcp_mem â‰¤8 GB 786432 1048576 1572864 â‰¥16 GB 1572864 2097152 3145728 6ï¸âƒ£ net.core.netdev_max_backlog ä½œç”¨ï¼šç½‘å¡æ”¶åŒ…é˜Ÿåˆ—\nä¸ CPU æ ¸æ•°å¼ºç›¸å…³\nnet.core.netdev_max_backlog = CPUæ ¸æ•° Ã— 2048 ç¤ºä¾‹ï¼š\n4 æ ¸ -\u0026gt; 8192 8 æ ¸ -\u0026gt; 16384 7ï¸âƒ£ kernel.shmmax / shmall é€‚ç”¨å¯¹è±¡ï¼šPostgreSQLã€Oracleã€å…±äº«å†…å­˜åº”ç”¨\næ¨èè§„åˆ™ shmmax â‰ˆ å†…å­˜ Ã— 50%~75% shmall â‰ˆ shmmax / PAGE_SIZE ä¸‰ã€ä¸å»ºè®®æ ¹æ® CPU / å†…å­˜åŠ¨æ€è°ƒæ•´çš„å‚æ•° âŒ è¿™äº›å‚æ•°ä¸æ¶æ„ã€è¯­ä¹‰ã€å®‰å…¨ç›¸å…³ï¼ŒåŠ¨æ€åè€Œå±é™©ã€‚\nâŒ ä¸å»ºè®®åŠ¨æ€çš„å…¸å‹å‚æ•° å‚æ•° åŸå›  vm.swappiness ç­–ç•¥å‚æ•°ï¼Œä¸æ˜¯å®¹é‡ vm.overcommit_memory è¡Œä¸ºè¯­ä¹‰ï¼Œéèµ„æº kernel.numa_balancing æ¶æ„çº§å†³ç­– net.ipv4.tcp_tw_reuse ç½‘ç»œè¯­ä¹‰ net.ipv4.ip_forward åŠŸèƒ½å¼€å…³ rp_filter è·¯ç”±ç­–ç•¥ tcp_syncookies å®‰å…¨ç­–ç•¥ tcp_timestamps åè®®è¯­ä¹‰ ğŸ‘‰ è¿™äº›å‚æ•°â€œå¼€ / å…³ / å›ºå®šå€¼â€æ›´å®‰å…¨\nå››ã€æ¨èçš„â€œåŠ¨æ€ç”Ÿæˆ sysctlâ€é€»è¾‘ï¼ˆç¤ºæ„ï¼‰ CPU=$(nproc) MEM_MB=$(awk \u0026#39;/MemTotal/ {print int($2/1024)}\u0026#39; /proc/meminfo) PID_MAX=$((CPU * 32768)) FILE_MAX=$((MEM_MB * 256)) CONNTRACK_MAX=$((MEM_MB * 64)) NET_BACKLOG=$((CPU * 2048)) äº”ã€æ€»ç»“ åªæœ‰â€œå®¹é‡å‹å‚æ•°â€æ‰é€‚åˆæ ¹æ® CPU / å†…å­˜åŠ¨æ€è®¡ç®—ï¼›\nâ€œè¡Œä¸ºå‹ã€ç­–ç•¥å‹ã€å®‰å…¨å‹å‚æ•°â€å¿…é¡»å›ºå®šé…ç½®ã€‚\n","description":"å“ªäº›å†…æ ¸å‚æ•°é€‚åˆæ ¹æ®CPUå’Œå†…å­˜åŠ¨æ€è°ƒæ•´ï¼Ÿ\nè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šã€è€Œä¸”éå¸¸â€œç”Ÿäº§å‘â€çš„é—®é¢˜ ğŸ‘\nç»“è®ºå…ˆè¡Œï¼šä¸æ˜¯æ‰€æœ‰å†…æ ¸å‚æ•°éƒ½é€‚åˆâ€œåŠ¨æ€ç®—â€ï¼Œä½†æœ‰ä¸€å°éƒ¨åˆ†â€œå¼ºçƒˆé€‚åˆâ€æ ¹æ® CPU / å†…å­˜è‡ªåŠ¨è°ƒæ•´ï¼Œå…¶ä½™è¦ä¹ˆå›ºå®šå€¼æ›´å®‰å…¨ï¼Œè¦ä¹ˆåªå’Œåœºæ™¯æœ‰å…³ã€‚\næŒ‰ â€œå¼ºçƒˆå»ºè®®åŠ¨æ€ -\u0026gt; å¯é€‰åŠ¨æ€ -\u0026gt; ä¸å»ºè®®åŠ¨æ€â€ ç»™ä½ ä¸€ä»½æ¸…æ™°æ¸…å•ï¼Œå¹¶ç»™å‡ºè®¡ç®—é€»è¾‘ä¸åŸå› ã€‚\nä¸€ã€å¼ºçƒˆå»ºè®®æ ¹æ® CPU / å†…å­˜åŠ¨æ€è°ƒæ•´çš„å†…æ ¸å‚æ•° âœ… è¿™äº›å‚æ•°ä¸ç³»ç»Ÿå®¹é‡å¼ºç›¸å…³ï¼Œå†™æ­»å®¹æ˜“æµªè´¹æˆ–æˆä¸ºç“¶é¢ˆã€‚\n1ï¸âƒ£ kernel.pid_maxï¼ˆå¼ºçƒˆï¼‰ ä½œç”¨ï¼šæœ€å¤§è¿›ç¨‹ / çº¿ç¨‹æ•°\næ ¸å¿ƒç“¶é¢ˆï¼šçº¿ç¨‹å¤šçš„æœåŠ¡ï¼ˆJava / Python / K8S / PostgreSQLï¼‰\n"},{"id":290,"href":"/operations/linux/mount/","title":"Linux ç£ç›˜æŒ‚è½½ä¸æ€§èƒ½ä¼˜åŒ–","parent":"Linux","content":"åŸæ–‡ï¼šLinuxæŒ‚è½½ç£ç›˜mountå‚æ•°ä¼˜åŒ–\nä¸€ã€Linux æ–‡ä»¶å±æ€§æ—¶é—´æˆ³ç†è§£ Linux æ–‡ä»¶æœ‰ä¸‰ç§é‡è¦æ—¶é—´æˆ³ï¼š\næ—¶é—´ç±»å‹ æè¿° ä¿®æ”¹æ¡ä»¶ Access Time (atime) æ–‡ä»¶æœ€åè®¿é—®æ—¶é—´ è¯»å–æ–‡ä»¶æ—¶æ”¹å˜ Modify Time (mtime) æ–‡ä»¶å†…å®¹æœ€åä¿®æ”¹æ—¶é—´ ä¿®æ”¹æ–‡ä»¶å†…å®¹æ—¶æ”¹å˜ Change Time (ctime) æ–‡ä»¶å±æ€§æœ€åä¿®æ”¹æ—¶é—´ ä¿®æ”¹æ–‡ä»¶æƒé™æˆ–å†…å®¹æ—¶æ”¹å˜ ç¤ºä¾‹æ“ä½œ åˆ›å»ºæ–‡ä»¶å¹¶æŸ¥çœ‹æ—¶é—´æˆ³ï¼š\necho \u0026#34;Hello\u0026#34; \u0026gt; hello.txt stat hello.txt ls -l --time=atime # æŸ¥çœ‹è®¿é—®æ—¶é—´ ls -l --time=ctime # æŸ¥çœ‹æ”¹å˜æ—¶é—´ ä¿®æ”¹æƒé™ï¼š\nchmod 600 hello.txt stat hello.txt ç»“æœï¼šChange Time æ”¹å˜ï¼ŒAccess/Modify Time ä¸å˜ ä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼š\necho \u0026#34;World\u0026#34; \u0026gt;\u0026gt; hello.txt stat hello.txt ç»“æœï¼šModify å’Œ Change æ”¹å˜ï¼ŒAccess ä¸ä¸€å®šæ”¹å˜ï¼ˆå–å†³äºæ˜¯å¦è¯»å–æ–‡ä»¶ï¼‰ è¯»å–æ–‡ä»¶å†…å®¹ï¼š\ncat hello.txt stat hello.txt ç»“æœï¼šAccess æ”¹å˜ ç»“è®ºï¼š\nè¯»å–æ–‡ä»¶ -\u0026gt; æ”¹å˜ Access ä¿®æ”¹æƒé™ -\u0026gt; æ”¹å˜ Change ä¿®æ”¹å†…å®¹ -\u0026gt; æ”¹å˜ Modify å’Œ Changeï¼ŒAccess è§†æ“ä½œæ–¹å¼è€Œå®š äºŒã€æ–‡ä»¶ç³»ç»Ÿä¸æŒ‚è½½å‚æ•°ä¼˜åŒ– 1. æ–‡ä»¶ç³»ç»Ÿé€‰æ‹© å¸¸ç”¨æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿï¼šExt2/Ext3/Ext4/XFS XFSï¼šæ€§èƒ½å¥½ã€ç¨³å®šï¼ŒCentOS 7 é»˜è®¤ä½¿ç”¨ XFS æ—¥å¿—æ–‡ä»¶ç³»ç»Ÿç‰¹æ€§ï¼šå…ˆå†™æ—¥å¿—ï¼Œå†å†™ä¸»æ–‡ä»¶ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†ä¼šé¢å¤–è®°å½•è®¿é—®æ—¶é—´ -\u0026gt; å¯ç¦ç”¨ä»¥æå‡æ€§èƒ½ 2. å¸¸ç”¨æŒ‚è½½å‚æ•° å‚æ•° ä½œç”¨ å»ºè®® noatime ç¦æ­¢è®°å½•æ–‡ä»¶è®¿é—®æ—¶é—´ é«˜é¢‘è¯»å†™åœºæ™¯å¿…ç”¨ï¼Œæå‡ I/O 20%-30% nodiratime ç¦æ­¢ç›®å½•è®¿é—®æ—¶é—´è®°å½• é…åˆ noatime nobarrier ç¦æ­¢å†™å±éšœï¼Œä¾èµ–å­˜å‚¨è®¾å¤‡è‡ªä¿æŠ¤ æ•°æ®å®‰å…¨æœ‰ä¿è¯æ—¶å¯ç”¨ allocsize I/O é¢„åˆ†é…å¤§å°ï¼ˆå»¶è¿Ÿåˆ†é…ï¼‰ 256m å¸¸ç”¨ä¼˜åŒ–å€¼ logbufs å†…å­˜æ—¥å¿—ç¼“å†²åŒºæ•°é‡ é»˜è®¤ 8ï¼Œå¯è°ƒæ•´ logbsize å†…å­˜æ—¥å¿—ç¼“å†²åŒºå¤§å° é»˜è®¤ 256k discard æ–‡ä»¶åˆ é™¤è§¦å‘ TRIM/Discard SSD/Flash æ¨è attr2 XFS æ‰©å±•å±æ€§ä¼˜åŒ– é»˜è®¤å¯ç”¨ 3. æŒ‚è½½ç¤ºä¾‹ Ext4 é»˜è®¤ä¼˜åŒ–æŒ‚è½½ï¼š\ndefaults,noatime,nodiratime,nobarrier XFS ä¼˜åŒ–æŒ‚è½½ï¼š\ndefaults,noatime,nodiratime,nobarrier,discard,allocsize=256m,logbufs=8,attr2,logbsize=256k æŒ‚è½½ç”Ÿæ•ˆæ— éœ€é‡å¯ï¼š mount -o remount / å¯ä½¿ç”¨ fio æµ‹è¯•æ€§èƒ½ï¼š # é¡ºåºè¯» fio -filename=/var/test.file -direct=1 -iodepth 1 -thread -rw=read -bs=16k -size=2G -numjobs=10 -runtime=60 -group_reporting # éšæœºå†™ fio -filename=/var/test.file -direct=1 -iodepth 1 -thread -rw=randwrite -bs=16k -size=2G -numjobs=10 -runtime=60 -group_reporting ä¸‰ã€XFS æ–‡ä»¶ç³»ç»Ÿå‚æ•°è¯´æ˜ï¼ˆå¸¸ç”¨ï¼‰ å‚æ•° æè¿° allocsize å»¶è¿Ÿåˆ†é…å¤§å° attr2 æ‰©å±•å±æ€§ä¼˜åŒ– barrier å†™å±éšœ inode64 æ”¯æŒå¤§ inode ç¼–å· logbufs æ—¥å¿—ç¼“å†²åŒºæ•°é‡ logbsize æ—¥å¿—ç¼“å†²åŒºå¤§å° discard è‡ªåŠ¨è§¦å‘ TRIM/Discard noatime/nodiratime ä¸æ›´æ–°è®¿é—®æ—¶é—´ osyncisosync æä¾›çœŸæ­£çš„ O_SYNC å†™ å…¶ä»–é«˜çº§å‚æ•°å¦‚ dmapi, quota, sunit/swidth å¯æ ¹æ®å®é™…éœ€æ±‚é…ç½®\nå››ã€ç£ç›˜æ€§èƒ½ä¼˜åŒ–åŸºç¡€ 1. æ–‡ä»¶ç³»ç»Ÿç›¸å…³ ç¼“å­˜ï¼šæé«˜è¯»æ€§èƒ½\nç¼“å†²ï¼šæé«˜å†™æ€§èƒ½\né¡ºåº I/O vs éšæœº I/Oï¼š\né¡ºåº I/Oï¼šè¿ç»­æ–‡ä»¶åç§»ï¼Œæ€§èƒ½é«˜ éšæœº I/Oï¼šåç§»éšæœºï¼Œå¯èƒ½å¯¼è‡´ç¢ç‰‡åŒ– 2. ç£ç›˜æ€§èƒ½å·¥å…· å·¥å…· ç”¨é€” iostat æ±‡æ€»ç£ç›˜ I/Oï¼Œtpsã€ååé‡ã€å»¶è¿Ÿ iotop æŸ¥çœ‹è¿›ç¨‹ I/O å®æ—¶å ç”¨ sar å†å²æ€§èƒ½ç»Ÿè®¡ blktrace/perf è¯¦ç»†è·Ÿè¸ª I/O iostat å‚æ•°è¯´æ˜ tpsï¼šæ¯ç§’ I/O æ¬¡æ•° kB_read/s / kB_wrtn/sï¼šæ¯ç§’è¯»/å†™ KB awaitï¼šå¹³å‡ I/O å“åº”æ—¶é—´ï¼ˆmsï¼‰ svctmï¼šç£ç›˜å¹³å‡æœåŠ¡æ—¶é—´ %utilï¼šè®¾å¤‡ç¹å¿™ç¨‹åº¦ é‡ç‚¹æŒ‡æ ‡ï¼šawait è¶Šå°è¶Šå¥½ï¼Œ%util 100% è¡¨ç¤ºæ¥è¿‘æ»¡è´Ÿè·\näº”ã€ç£ç›˜ä¸æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–æ–¹æ³• 1. ç£ç›˜å‚æ•°ä¼˜åŒ– Cacheï¼š sdparm -s WCE=1,RCD=0 -S /dev/sdb I/O è°ƒåº¦å™¨ï¼š echo deadline \u0026gt; /sys/block/sdb/queue/scheduler echo 500 \u0026gt; /sys/block/sdb/queue/iosched/read_expire echo 1000 \u0026gt; /sys/block/sdb/queue/iosched/write_expire é¢„è¯»æ‰‡åŒºæ•°ï¼š blockdev --setra 256 /dev/sdb 2. æ–‡ä»¶ç³»ç»Ÿå‚æ•° EXT3ï¼š mkfs.ext3 -b 4096 -i 16384 -m 2 /dev/sdb1 tune2fs -O^has_journal /dev/sdb1 # æ— æ—¥å¿— XFSï¼š mkfs.xfs -d agcount=256 -l size=128m,lazy-count=1,version=2 /dev/sdb1 3. æŒ‚è½½å‚æ•°ä¼˜åŒ– EXT3 ç¤ºä¾‹ï¼š mount /dev/sdb1 /cache1 -o defaults,noatime,nodiratime,async,data=writeback,barrier=0 XFS ç¤ºä¾‹ï¼š mount /dev/sdb1 /cache1 -o defaults,noatime,nodiratime,nobarrier,discard,allocsize=256m,logbufs=8,attr2,logbsize=256k å…­ã€è¿›é˜¶ I/O è°ƒåº¦ä¸è¿›ç¨‹æ§åˆ¶ ionice è®¾ç½®è¿›ç¨‹ I/O ä¼˜å…ˆçº§ï¼š ionice -c 3 -p \u0026lt;PID\u0026gt; # ç©ºé—² I/O ionice -c 2 -n 0 -p \u0026lt;PID\u0026gt; # å°½åŠ›è€Œä¸ºï¼Œä¼˜å…ˆçº§æœ€é«˜ cgroup å¯¹è¿›ç¨‹ç»„é™åˆ¶ I/O å¸¦å®½ï¼Œå¯ç”¨äºé«˜è´Ÿè½½åœºæ™¯ I/O è°ƒåº¦å™¨é€‰æ‹©å»ºè®® ç£ç›˜ç±»å‹ æ¨èè°ƒåº¦å™¨ HDD deadline SSD noop æ¡Œé¢ cfq å¤§æ–‡ä»¶é¡ºåºè¯»å†™ as âœ… æ€»ç»“\nç†è§£æ–‡ä»¶æ—¶é—´æˆ³ï¼Œæœ‰åŠ©äºé€‰æ‹©æŒ‚è½½å‚æ•°ï¼ˆå¦‚ noatimeï¼‰ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–é‡ç‚¹ï¼šé€‰æ‹© XFS / EXT4ï¼Œè°ƒæ•´ blocksizeã€æ—¥å¿—ã€æ‰©å±•å±æ€§ ç£ç›˜ä¼˜åŒ–é‡ç‚¹ï¼šcacheã€I/O è°ƒåº¦å™¨ã€readaheadã€ionice æŒ‚è½½å‚æ•°ä¼˜åŒ–é‡ç‚¹ï¼šnoatime,nodiratime,nobarrier,allocsize,logbufs,logbsize,discard æµ‹è¯•å·¥å…·ï¼šfioã€iostatã€iotopã€blktrace ç­‰ï¼Œåˆ†ææ€§èƒ½å˜åŒ– ","description":"åŸæ–‡ï¼šLinuxæŒ‚è½½ç£ç›˜mountå‚æ•°ä¼˜åŒ–\nä¸€ã€Linux æ–‡ä»¶å±æ€§æ—¶é—´æˆ³ç†è§£ Linux æ–‡ä»¶æœ‰ä¸‰ç§é‡è¦æ—¶é—´æˆ³ï¼š\næ—¶é—´ç±»å‹ æè¿° ä¿®æ”¹æ¡ä»¶ Access Time (atime) æ–‡ä»¶æœ€åè®¿é—®æ—¶é—´ è¯»å–æ–‡ä»¶æ—¶æ”¹å˜ Modify Time (mtime) æ–‡ä»¶å†…å®¹æœ€åä¿®æ”¹æ—¶é—´ ä¿®æ”¹æ–‡ä»¶å†…å®¹æ—¶æ”¹å˜ Change Time (ctime) æ–‡ä»¶å±æ€§æœ€åä¿®æ”¹æ—¶é—´ ä¿®æ”¹æ–‡ä»¶æƒé™æˆ–å†…å®¹æ—¶æ”¹å˜ ç¤ºä¾‹æ“ä½œ åˆ›å»ºæ–‡ä»¶å¹¶æŸ¥çœ‹æ—¶é—´æˆ³ï¼š\necho \u0026#34;Hello\u0026#34; \u0026gt; hello.txt stat hello.txt ls -l --time=atime # æŸ¥çœ‹è®¿é—®æ—¶é—´ ls -l --time=ctime # æŸ¥çœ‹æ”¹å˜æ—¶é—´ ä¿®æ”¹æƒé™ï¼š\n"},{"id":291,"href":"/operations/linux/setup-ipv6/","title":"Linux ç³»ç»Ÿï¼Œå†…ç½‘æœåŠ¡å™¨ï¼Œæœ‰æ²¡æœ‰å¿…è¦ç¦ç”¨ IPv6ï¼Ÿ","parent":"Linux","content":"è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ã€è€Œä¸”æ˜¯â€œæ¶æ„å±‚é¢â€çš„é—®é¢˜ã€‚ç»“è®ºå…¶å®å¹¶ä¸å¤æ‚ï¼Œä½†åˆ¤æ–­é€»è¾‘ä¸€å®šè¦æ­£ç¡®ã€‚\nå…ˆç»™ç»“è®ºï¼ˆç»™è¿ç»´ / æ¶æ„å†³ç­–ç”¨ï¼‰ å†…ç½‘ Linux æœåŠ¡å™¨ï¼š âŒâ€œæ²¡æœ‰å¼ºéœ€æ±‚ï¼Œä¸å»ºè®®ä¸»åŠ¨ç¦ç”¨ IPv6â€ âœ…â€œå»ºè®®ä¿æŒå¯ç”¨ä½†ä¸ä½¿ç”¨ï¼ˆä¸é…åœ°å€ã€ä¸èµ°æµé‡ï¼‰â€\nç¦ç”¨ IPv6 â‰  æ›´å®‰å…¨ â‰  æ›´ç¨³å®š\nåœ¨ç°ä»£ Linuxï¼ˆRHEL / AlmaLinux 9+ï¼‰é‡Œï¼Œç¦ç”¨ IPv6 åè€Œæ›´å®¹æ˜“è¸©å‘ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆå¾ˆå¤šäººâ€œæƒ³ç¦ç”¨ IPv6â€ï¼ˆåŠ¨æœºæ˜¯å¯¹çš„ï¼‰ å†…ç½‘æœåŠ¡å™¨å¸¸è§çš„æƒ³æ³•ï¼š\nå…¬å¸ç½‘ç»œä¸ç”¨ IPv6 æ‰€æœ‰ä¸šåŠ¡åªè·‘ IPv4 ä¸æƒ³å¢åŠ å¤æ‚åº¦ å®‰å…¨å›¢é˜Ÿè¦æ±‚â€œæ²¡ç”¨å°±å…³â€ ğŸ‘‰ è¿™äº›æƒ³æ³•åœ¨ 2015 å¹´ä»¥å‰ æ˜¯åˆç†çš„ ğŸ‘‰ åœ¨ RHEL 8 / 9 / systemd æ—¶ä»£ï¼Œå·²ç»ä¸å†å®Œå…¨æˆç«‹ äºŒã€ä¸ºä»€ä¹ˆåœ¨ç°ä»£ Linux ä¸­â€œä¸å»ºè®®ç¦ç”¨ IPv6â€ 1ï¸âƒ£ IPv6 å·²ç»æ˜¯ Linux ç½‘ç»œæ ˆçš„ä¸€éƒ¨åˆ†ï¼ˆä¸æ˜¯æ’ä»¶ï¼‰ åœ¨ RHEL / AlmaLinux 9ï¼š\nIPv6 æ˜¯å†…æ ¸ä¸€çº§å…¬æ°‘ systemdã€glibcã€NetworkManager é»˜è®¤å‡è®¾ IPv6 å­˜åœ¨ å¾ˆå¤šæœåŠ¡ å…ˆå°è¯• IPv6ï¼Œå†å›é€€ IPv4 ç¦ç”¨ IPv6 ä¼šå¯¼è‡´ï¼š\nsocket æ¿€æ´»å¼‚å¸¸ï¼ˆä½ å·²ç»é‡åˆ° rpcbindï¼‰ æœåŠ¡å¯åŠ¨å˜æ…¢ç”šè‡³å¤±è´¥ å‡ºç° â€œtcp6 / udp6 ä½†ä¸å¯ç”¨â€ çš„è¯¡å¼‚çŠ¶æ€ 2ï¸âƒ£ ç¦ç”¨ IPv6 â‰  å‡å°‘æ”»å‡»é¢ï¼ˆè¿™æ˜¯è¯¯è§£ï¼‰ ç°å®æƒ…å†µæ˜¯ï¼š\né¡¹ç›® è¯´æ˜ å†…ç½‘ æœ¬æ¥å°±è¢«è¾¹ç•Œé˜²æŠ¤ IPv6 æ²¡åœ°å€å°±æ— æ³•é€šä¿¡ æœåŠ¡ç›‘å¬ é»˜è®¤è¿˜æ˜¯ IPv4 ğŸ‘‰ æ²¡æœ‰ IPv6 åœ°å€ â‰ˆ ä¸å¯è¾¾\nè€Œå½»åº•ç¦ç”¨ IPv6ï¼š\nåè€Œå¯èƒ½ç»•è¿‡ä½ é¢„æœŸçš„å®‰å…¨è·¯å¾„ è§¦å‘æœåŠ¡ fallback bug 3ï¸âƒ£ systemd + socket æ¿€æ´» å¯¹ IPv6 éå¸¸æ•æ„Ÿ ä½ å·²ç»äº²èº«ç»å†ï¼š\nrpcbind NetworkManager-wait-online æŸäº› Java / Go æœåŠ¡ è¿™æ˜¯ç»“æ„æ€§é—®é¢˜ï¼Œä¸æ˜¯é…ç½®é—®é¢˜ã€‚\nä¸‰ã€ä»€ä¹ˆæ—¶å€™â€œåº”è¯¥ç¦ç”¨ IPv6â€ï¼ˆå°‘æ•°åœºæ™¯ï¼‰ ä»¥ä¸‹æƒ…å†µ å¯ä»¥ç¦ç”¨ï¼Œä½†è¦éå¸¸æ¸…æ¥šè‡ªå·±åœ¨åšä»€ä¹ˆï¼š\nâœ… 1ï¸âƒ£ æç®€ç³»ç»Ÿ / ä¸“ç”¨ appliance é˜²ç«å¢™ è·¯ç”±å™¨ å­˜å‚¨èŠ‚ç‚¹ï¼ˆå·²éªŒè¯ï¼‰ å¹¶ä¸”ä½ ï¼š\nå…¨é¢æµ‹è¯•è¿‡ æ§åˆ¶æ‰€æœ‰ systemd socket ä¸ä¾èµ– NetworkManager âœ… 2ï¸âƒ£ æ˜ç¡®çš„åˆè§„ / å®‰å…¨å®¡è®¡è¦æ±‚ ä¾‹å¦‚ï¼š\né‡‘èã€æ”¿åŠ¡\næ˜ç¡®å†™åœ¨å®¡è®¡æ¡æ¬¾é‡Œï¼š\nâ€œç¦æ­¢å¯ç”¨ IPv6 åè®®æ ˆâ€\nè¿™ç§å±äº æ”¿ç­–é©±åŠ¨ï¼Œè€Œä¸æ˜¯æŠ€æœ¯æœ€ä¼˜è§£ã€‚\nå››ã€æ¨èæ–¹æ¡ˆï¼ˆç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼‰ âœ… æ¨èç­‰çº§ï¼šâ­â­â­â­â­ ğŸ¯ ä¸ç¦ç”¨ IPv6ï¼Œä½†ä¸ä½¿ç”¨ IPv6 è¿™æ˜¯å†…ç½‘æœåŠ¡å™¨çš„æœ€ä¼˜è§£ã€‚\nåšæ³• ä¸è¦åˆ†é… IPv6 åœ°å€ ä¸è¦é…ç½® IPv6 è·¯ç”± é˜²ç«å¢™ä¸æ”¾è¡Œ IPv6 ä¸åŠ¨å†…æ ¸å‚æ•° ç»“æœ IPv6 åè®®æ ˆå­˜åœ¨ systemd / æœåŠ¡æ­£å¸¸ å®é™…æµé‡ 100% IPv4 é›¶è¸©å‘ äº”ã€å¦‚æœä½ â€œéè¦ç¦ç”¨â€ï¼Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ å¦‚æœä½ åšæŒç¦ç”¨ IPv6ï¼Œå¿…é¡»åŒæ—¶åšåˆ°ï¼š\nsysctl ç¦ç”¨ IPv6 ä¿®å¤æ‰€æœ‰ socket-activated æœåŠ¡ NetworkManager / systemd å…¨éƒ¨ IPv4-only å®Œæ•´é‡å¯æµ‹è¯• ç¦æ­¢ç”¨ modprobe é˜»æ–­ IPv6ï¼ˆRHEL 9 å·²ä¸æ¨èï¼‰ è¿™æ˜¯ä¸€ä¸ª é«˜ç»´æŠ¤æˆæœ¬æ–¹æ¡ˆï¼Œä¸é€‚åˆå¤§è§„æ¨¡æœåŠ¡å™¨\nå…­ã€ç”¨ä¸€å¥è¯ç»™è€æ¿ / å®‰å…¨ / è¿ç»´è§£é‡Š å¯ä»¥ç›´æ¥ç”¨è¿™å¥è¯ï¼š\nåœ¨ç°ä»£ Linux ç³»ç»Ÿä¸­ï¼ŒIPv6 æ˜¯åŸºç¡€èƒ½åŠ›ï¼Œä¸å¯ç”¨åœ°å€å³å¯ä¿è¯ä¸ç”¨ IPv6ï¼›å¼ºè¡Œç¦ç”¨åè€Œä¼šå¼•å…¥ systemd ä¸æœåŠ¡å¯åŠ¨é£é™©ã€‚\nä¸ƒã€æœ€ç»ˆå†³ç­–è¡¨ï¼ˆé€ŸæŸ¥ï¼‰ åœºæ™¯ å»ºè®® å†…ç½‘ä¸šåŠ¡æœåŠ¡å™¨ âŒ ä¸ç¦ç”¨ K8S / Docker èŠ‚ç‚¹ âŒ ä¸ç¦ç”¨ æ•°æ®åº“æœåŠ¡å™¨ âŒ ä¸ç¦ç”¨ å®‰å…¨åˆè§„å¼ºåˆ¶è¦æ±‚ âš ï¸ è°¨æ…ç¦ç”¨ ç½‘ç»œè®¾å¤‡ / appliance âœ… å¯ç¦ç”¨ ä¸ç¦ç”¨ IPv6ï¼Œä½†ä¸ä½¿ç”¨ IPv6ï¼Œnmcli ipv6.method é…ç½®æˆä»€ä¹ˆæ¯”è¾ƒå¥½ï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šã€è€Œä¸”é—®åˆ°ç‚¹å­ä¸Šçš„é—®é¢˜ ğŸ‘\nè¿™ä¸ªåœºæ™¯çš„ç›®æ ‡å…¶å®åªæœ‰ä¸€å¥è¯ï¼š\nIPv6 åè®®æ ˆå­˜åœ¨ï¼Œä½†æ¥å£ä¸è·å– IPv6 åœ°å€ã€ä¸èµ° IPv6 æµé‡ã€ä¸å½±å“ systemd å’ŒæœåŠ¡å¯åŠ¨\nâœ… ç›´æ¥ç»™ç»“è®ºï¼ˆæ¨èé…ç½®ï¼‰ åœ¨ NetworkManager ä¸­ï¼š ğŸ‘‰ ipv6.method ignore æ˜¯æœ€ä¼˜é€‰æ‹©\nnmcli connection modify \u0026lt;è¿æ¥å\u0026gt; ipv6.method ignore nmcli connection up \u0026lt;è¿æ¥å\u0026gt; è¿™æ˜¯ â€œä¸ç¦ç”¨ IPv6ï¼Œä½†å½»åº•ä¸ä½¿ç”¨ IPv6â€ çš„æ ‡å‡†åšæ³•ã€‚\nä¸€ã€nmcli ä¸­ ipv6.method å„å–å€¼å«ä¹‰ï¼ˆå¿…é¡»ææ¸…æ¥šï¼‰ 1ï¸âƒ£ ignore âœ…ï¼ˆå¼ºçƒˆæ¨èï¼‰ ipv6.method = ignore å«ä¹‰ï¼ˆå…³é”®ç‚¹ï¼‰ ä¸è¿›è¡Œä»»ä½• IPv6 æ“ä½œ ä¸å‘é€ RA ä¸è·å– IPv6 åœ°å€ ä¸é…ç½® IPv6 è·¯ç”± ä¸å¯åŠ¨ IPv6 DHCP å®¢æˆ·ç«¯ ä½†å†…æ ¸ IPv6 åè®®æ ˆä»ç„¶å­˜åœ¨ ğŸ‘‰ è¿™æ˜¯æœ€â€œå¹²å‡€â€çš„æ–¹å¼\né€‚åˆåœºæ™¯ å†…ç½‘æœåŠ¡å™¨ æ•°æ®åº“ ä¸­é—´ä»¶ K8S èŠ‚ç‚¹ï¼ˆåªç”¨ IPv4ï¼‰ 2ï¸âƒ£ disabled âŒï¼ˆä¸æ¨èï¼‰ ipv6.method = disabled é—®é¢˜ç‚¹ ä¼šåœ¨æ¥å£å±‚é¢å…³é—­ IPv6 å¯èƒ½è§¦å‘ systemd / socket / æœåŠ¡çš„å¼‚å¸¸è¡Œä¸º åœ¨ RHEL 9 / AlmaLinux 9 ä¸­è¸©å‘æ¦‚ç‡é«˜ ğŸ‘‰ è¿™æ˜¯â€œæ¥å£çº§ç¦ç”¨â€ï¼Œä¸æ˜¯â€œä¸ç”¨â€\n3ï¸âƒ£ autoï¼ˆé»˜è®¤ï¼‰âš ï¸ ipv6.method = auto è¡Œä¸º æ¥æ”¶ RA è‡ªåŠ¨ç”Ÿæˆ IPv6 åœ°å€ï¼ˆé€šå¸¸æ˜¯ link-local + globalï¼‰ å¯èƒ½å‡ºç°ä½ â€œä¸æƒ³ç”¨ä½†å®ƒç”¨äº†â€çš„æƒ…å†µ ğŸ‘‰ ä¸ç¬¦åˆä½ çš„ç›®æ ‡\n4ï¸âƒ£ dhcp âš ï¸ ipv6.method = dhcp æ˜ç¡®ä½¿ç”¨ DHCPv6 ä¼ä¸šç½‘ç»œå¶å°”ä½¿ç”¨ å†…ç½‘æœåŠ¡å™¨ä¸€èˆ¬ä¸éœ€è¦ 5ï¸âƒ£ link-local âš ï¸ï¼ˆå°‘æ•°åœºæ™¯ï¼‰ ipv6.method = link-local åªä¿ç•™ fe80::/64 ä¸å¯è·¯ç”± systemd ä»è®¤ä¸º IPv6 å¯ç”¨ ğŸ“Œ ä¸€èˆ¬ K8S / æŸäº›é›†ç¾¤ æ‰ç”¨ï¼Œæ™®é€šå†…ç½‘æœåŠ¡å™¨ä¸å¿…ã€‚\näºŒã€ä¸ºä»€ä¹ˆ ignore æ˜¯â€œæœ€å®‰å…¨ã€ä¸è¸©å‘â€çš„æ–¹æ¡ˆï¼Ÿ å¯¹æ¯”ä¸€ä¸‹ä¸‰ç§å¸¸è§åšæ³• æ–¹æ¡ˆ systemd æœåŠ¡å¯åŠ¨ IPv6 åœ°å€ é£é™© sysctl ç¦ç”¨ âŒ âŒ æ—  é«˜ ipv6.method disabled âš ï¸ âš ï¸ æ—  ä¸­ ipv6.method ignore âœ… âœ… æ—  æœ€ä½ ä¸‰ã€æ¨èçš„â€œå†…ç½‘æœåŠ¡å™¨æ ‡å‡†ç½‘ç»œæ¨¡æ¿â€ ä½ å¯ä»¥æŠŠå®ƒå½“æˆè§„èŒƒç”¨ï¼š\nnmcli connection modify \u0026lt;conn\u0026gt; \\ ipv4.method manual \\ ipv4.addresses 10.0.0.10/24 \\ ipv4.gateway 10.0.0.1 \\ ipv4.dns \u0026#34;10.0.0.2\u0026#34; \\ ipv6.method ignore å››ã€éªŒè¯æ–¹å¼ï¼ˆä¸€å®šè¦æ£€æŸ¥ï¼‰ 1ï¸âƒ£ æ¥å£çŠ¶æ€ ip -6 addr show ğŸ‘‰ åº” æ²¡æœ‰ global IPv6 åœ°å€\n2ï¸âƒ£ è·¯ç”± ip -6 route ğŸ‘‰ åº”ä¸ºç©º\n3ï¸âƒ£ æœåŠ¡ç›‘å¬ï¼ˆæ­£å¸¸ï¼‰ ss -lntup ä½ ä»ç„¶å¯èƒ½çœ‹åˆ°ï¼š\ntcp6 :::8080 è¿™æ˜¯ socket åŒæ ˆæ˜¾ç¤ºï¼Œå¹¶ä¸ä»£è¡¨å®é™…ä½¿ç”¨ IPv6ã€‚\nğŸ‘‰ è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸æ˜¯é—®é¢˜\näº”ã€ä½ è¿™ä¸ªé—®é¢˜çš„â€œæœ€ç»ˆä¸€å¥è¯ç­”æ¡ˆâ€ ä½ å¯ä»¥ç›´æ¥è®°ä½è¿™å¥ï¼š\nå†…ç½‘æœåŠ¡å™¨ï¼Œä¸ç¦ç”¨ IPv6 çš„æœ€ä½³åšæ³•æ˜¯ï¼šNetworkManager è®¾ç½® ipv6.method ignoreï¼Œè€Œä¸æ˜¯ sysctl ç¦ç”¨ IPv6ã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ã€è€Œä¸”æ˜¯â€œæ¶æ„å±‚é¢â€çš„é—®é¢˜ã€‚ç»“è®ºå…¶å®å¹¶ä¸å¤æ‚ï¼Œä½†åˆ¤æ–­é€»è¾‘ä¸€å®šè¦æ­£ç¡®ã€‚\nå…ˆç»™ç»“è®ºï¼ˆç»™è¿ç»´ / æ¶æ„å†³ç­–ç”¨ï¼‰ å†…ç½‘ Linux æœåŠ¡å™¨ï¼š âŒâ€œæ²¡æœ‰å¼ºéœ€æ±‚ï¼Œä¸å»ºè®®ä¸»åŠ¨ç¦ç”¨ IPv6â€ âœ…â€œå»ºè®®ä¿æŒå¯ç”¨ä½†ä¸ä½¿ç”¨ï¼ˆä¸é…åœ°å€ã€ä¸èµ°æµé‡ï¼‰â€\nç¦ç”¨ IPv6 â‰  æ›´å®‰å…¨ â‰  æ›´ç¨³å®š\nåœ¨ç°ä»£ Linuxï¼ˆRHEL / AlmaLinux 9+ï¼‰é‡Œï¼Œç¦ç”¨ IPv6 åè€Œæ›´å®¹æ˜“è¸©å‘ã€‚\nä¸€ã€ä¸ºä»€ä¹ˆå¾ˆå¤šäººâ€œæƒ³ç¦ç”¨ IPv6â€ï¼ˆåŠ¨æœºæ˜¯å¯¹çš„ï¼‰ å†…ç½‘æœåŠ¡å™¨å¸¸è§çš„æƒ³æ³•ï¼š\nå…¬å¸ç½‘ç»œä¸ç”¨ IPv6 æ‰€æœ‰ä¸šåŠ¡åªè·‘ IPv4 ä¸æƒ³å¢åŠ å¤æ‚åº¦ å®‰å…¨å›¢é˜Ÿè¦æ±‚â€œæ²¡ç”¨å°±å…³â€ ğŸ‘‰ è¿™äº›æƒ³æ³•åœ¨ 2015 å¹´ä»¥å‰ æ˜¯åˆç†çš„ ğŸ‘‰ åœ¨ RHEL 8 / 9 / systemd æ—¶ä»£ï¼Œå·²ç»ä¸å†å®Œå…¨æˆç«‹ äºŒã€ä¸ºä»€ä¹ˆåœ¨ç°ä»£ Linux ä¸­â€œä¸å»ºè®®ç¦ç”¨ IPv6â€ 1ï¸âƒ£ IPv6 å·²ç»æ˜¯ Linux ç½‘ç»œæ ˆçš„ä¸€éƒ¨åˆ†ï¼ˆä¸æ˜¯æ’ä»¶ï¼‰ åœ¨ RHEL / AlmaLinux 9ï¼š\n"},{"id":292,"href":"/operations/linux/troubleshooting-rpcbind/","title":"Linux ç³»ç»Ÿæ•…éšœæ’æŸ¥ -- rpcbind","parent":"Linux","content":"å‚è€ƒæ–‡æ¡£ï¼šIPv6ç¦ç”¨å¯¼è‡´rpcbindæœåŠ¡å¯åŠ¨å¤±è´¥å®ä¾‹\nç³»ç»Ÿï¼šAlmalin 9.7\n/etc/sysctl.conf\nnet.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.netfilter.nf_conntrack_ipv6 = 0 /usr/lib/systemd/system/rpcbind.socket\n#BindIPv6Only=ipv6-only #ListenStream=[::]:111 #ListenDatagram=[::]:111 rpcbind.service\nrpcbind.service: Main process exited, code=dumped, status=6/ABRT rpcbind.service: Failed with result \u0026#39;core-dump\u0026#39; è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ã€Œç¦ç”¨ IPv6 + æ—§æœåŠ¡ä»å°è¯•ç›‘å¬ IPv6ã€å¯¼è‡´çš„å´©æºƒé—®é¢˜ï¼Œç»™å‡ºçš„ä¿¡æ¯å·²ç»éå¸¸å®Œæ•´ï¼Œä¸‹é¢ç›´æ¥ç»™ç»“è®º + åŸå›  + æ­£ç¡®ä¿®å¤æ–¹æ¡ˆã€‚\nä¸€ã€é—®é¢˜ç»“è®ºï¼ˆä¸€å¥è¯ï¼‰ åœ¨å†…æ ¸å±‚å½»åº•ç¦ç”¨äº† IPv6ï¼Œä½† rpcbind ä»è¢« systemd é…ç½®ä¸ºä½¿ç”¨ IPv6 Socketï¼Œå¯¼è‡´è¿›ç¨‹åœ¨åˆå§‹åŒ–é˜¶æ®µç›´æ¥ ABRT å´©æºƒã€‚\näºŒã€é—®é¢˜æ ¹å› åˆ†æï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ ä½ åšäº†ä»€ä¹ˆï¼ˆå†…æ ¸å±‚ï¼‰ åœ¨ /etc/sysctl.conf ä¸­ï¼š\nnet.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.netfilter.nf_conntrack_ipv6 = 0 ğŸ‘‰ æ•ˆæœï¼š\nIPv6 åœ¨å†…æ ¸å±‚å®Œå…¨å…³é—­ AF_INET6 å¥—æ¥å­—ä¸å¯ç”¨ IPv6 conntrack ä¹Ÿè¢«ç¦ç”¨ è¿™æ˜¯ç¡¬ç¦ç”¨ï¼Œä¸æ˜¯â€œä¸ç”¨è€Œå·²â€ã€‚\n2ï¸âƒ£ rpcbind æ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼ˆsystemd å±‚ï¼‰ rpcbind ä¸æ˜¯æ™®é€š serviceï¼Œè€Œæ˜¯ï¼š\nç”± rpcbind.socket å…ˆç›‘å¬ç«¯å£ -\u0026gt; å†å”¤èµ· rpcbind.service\nè€Œä½ çš„ /usr/lib/systemd/system/rpcbind.socket ä¸­ä»ç„¶å­˜åœ¨ï¼ˆå“ªæ€•è¢«æ³¨é‡Šï¼Œä¹Ÿä¼šè¢«å‘è¡Œç‰ˆé»˜è®¤è¡Œä¸ºå½±å“ï¼‰ï¼š\n# ListenStream=[::]:111 # ListenDatagram=[::]:111 âš ï¸ å…³é”®ç‚¹ï¼š\nsystemd åœ¨åˆ›å»º socket é˜¶æ®µå°±å°è¯•ä½¿ç”¨ IPv6 å†…æ ¸å·²ç»ç¦æ­¢ IPv6 bind(AF_INET6) -\u0026gt; ç›´æ¥å¤±è´¥ rpcbind æ”¶åˆ°éæ³•çŠ¶æ€ -\u0026gt; ABRT (SIGABRT) -\u0026gt; core dump ä¸‰ã€ä¸ºä»€ä¹ˆæ˜¯ status=6/ABRT è¿™ä¸æ˜¯æ™®é€šå¯åŠ¨å¤±è´¥ï¼Œè€Œæ˜¯ï¼š\næ–­è¨€å¤±è´¥ æˆ– glibc / libtirpc åˆå§‹åŒ–æ£€æµ‹åˆ°éæ³• socket çŠ¶æ€ rpcbind ä¸»åŠ¨ abort è¿™ç±»é”™è¯¯é‡å¯ 100 æ¬¡éƒ½æ²¡ç”¨ï¼Œå¿…é¡»æ”¹é…ç½®ã€‚\nå››ã€æ­£ç¡®ä¿®å¤æ–¹æ¡ˆï¼ˆæ¨èé¡ºåºï¼‰ âœ… æ–¹æ¡ˆä¸€ï¼ˆæœ€æ¨èï¼‰ï¼šå½»åº•ç¦ç”¨ rpcbindï¼ˆå¦‚æœä½ ä¸éœ€è¦ NFSï¼‰ é€‚ç”¨åœºæ™¯ æ²¡æœ‰ä½¿ç”¨ NFS / NIS / RPC æœåŠ¡ æ•°æ®åº“æœåŠ¡å™¨ã€åº”ç”¨æœåŠ¡å™¨ã€å®¹å™¨å®¿ä¸»æœº æ“ä½œ systemctl disable --now rpcbind.service systemctl disable --now rpcbind.socket å¹¶ç¡®è®¤ï¼š\nsystemctl status rpcbind åº”æ˜¾ç¤ºï¼š\nLoaded: masked / disabled Active: inactive ğŸ‘‰ è¿™æ˜¯æœ€å¹²å‡€ã€æœ€ç¬¦åˆç°ä»£ Linux å®è·µçš„æ–¹å¼\nâœ… æ–¹æ¡ˆäºŒï¼šå¼ºåˆ¶ rpcbind ä»…ä½¿ç”¨ IPv4ï¼ˆæ¨èï¼‰ 1ï¸âƒ£ åˆ›å»º override é…ç½®ï¼ˆä¸è¦æ”¹ /usr/libï¼‰ systemctl edit rpcbind.socket å†™å…¥ï¼š\nBindIPv6Only=no ListenStream=0.0.0.0:111 ListenDatagram=0.0.0.0:111 #ListenStream=[::]:111 #ListenDatagram=[::]:111 2ï¸âƒ£ é‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨ systemctl daemon-reexec systemctl daemon-reload systemctl restart rpcbind.socket systemctl restart rpcbind.service systemd å•å…ƒæ–‡ä»¶æœ‰ç»§æ‰¿ / é»˜è®¤è¡Œä¸º socket å¯èƒ½å·²è¢«ç¼“å­˜ daemon-reexec å‰ä¸ä¼šç”Ÿæ•ˆ 3ï¸âƒ£ éªŒè¯ç›‘å¬æƒ…å†µ ss -lntup | grep 111 åº”è¯¥åªçœ‹åˆ°ï¼š\n0.0.0.0:111 ä¸åº”è¯¥å‡ºç° :::111\nğŸš« é‡æ–°å¼€å¯ IPv6 åªä¸º rpcbind net.ipv6.conf.all.disable_ipv6 = 0 âŒ åŸå› ï¼š\nä¸ºä¸€ä¸ª legacy æœåŠ¡ç ´åæ•´ä½“å†…æ ¸ç­–ç•¥ ä¼šå½±å“ç½‘ç»œå®‰å…¨æ¨¡å‹ å’Œä½ ä¹‹å‰ç³»ç»Ÿè°ƒä¼˜ç›®æ ‡å†²çª äº”ã€å¦‚ä½•åˆ¤æ–­ã€Œæ˜¯å¦éœ€è¦ rpcbindã€ rpm -q nfs-utils systemctl status nfs-server å¦‚æœä½ ï¼š\nâŒ ä¸è·‘ NFS âŒ ä¸è·‘ NIS âŒ ä¸è·‘è€ RPC æœåŠ¡ ğŸ‘‰ 100% å¯ä»¥ç¦ç”¨ rpcbind\nå…­ã€æ€»ç»“ å½“åœ¨ Linux å†…æ ¸å±‚ç¦ç”¨ IPv6 æ—¶ï¼Œæ‰€æœ‰ systemd socket-activated æœåŠ¡å¿…é¡»æ˜¾å¼åˆ‡æ¢ä¸º IPv4-onlyï¼Œå¦åˆ™ä¼šåœ¨ socket åˆå§‹åŒ–é˜¶æ®µç›´æ¥å´©æºƒã€‚\n","description":"å‚è€ƒæ–‡æ¡£ï¼šIPv6ç¦ç”¨å¯¼è‡´rpcbindæœåŠ¡å¯åŠ¨å¤±è´¥å®ä¾‹\nç³»ç»Ÿï¼šAlmalin 9.7\n/etc/sysctl.conf\nnet.ipv6.conf.all.disable_ipv6 = 1 net.ipv6.conf.default.disable_ipv6 = 1 net.ipv6.conf.lo.disable_ipv6 = 1 net.netfilter.nf_conntrack_ipv6 = 0 /usr/lib/systemd/system/rpcbind.socket\n#BindIPv6Only=ipv6-only #ListenStream=[::]:111 #ListenDatagram=[::]:111 rpcbind.service\nrpcbind.service: Main process exited, code=dumped, status=6/ABRT rpcbind.service: Failed with result \u0026#39;core-dump\u0026#39; è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ã€Œç¦ç”¨ IPv6 + æ—§æœåŠ¡ä»å°è¯•ç›‘å¬ IPv6ã€å¯¼è‡´çš„å´©æºƒé—®é¢˜ï¼Œç»™å‡ºçš„ä¿¡æ¯å·²ç»éå¸¸å®Œæ•´ï¼Œä¸‹é¢ç›´æ¥ç»™ç»“è®º + åŸå›  + æ­£ç¡®ä¿®å¤æ–¹æ¡ˆã€‚\nä¸€ã€é—®é¢˜ç»“è®ºï¼ˆä¸€å¥è¯ï¼‰ åœ¨å†…æ ¸å±‚å½»åº•ç¦ç”¨äº† IPv6ï¼Œä½† rpcbind ä»è¢« systemd é…ç½®ä¸ºä½¿ç”¨ IPv6 Socketï¼Œå¯¼è‡´è¿›ç¨‹åœ¨åˆå§‹åŒ–é˜¶æ®µç›´æ¥ ABRT å´©æºƒã€‚\näºŒã€é—®é¢˜æ ¹å› åˆ†æï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ ä½ åšäº†ä»€ä¹ˆï¼ˆå†…æ ¸å±‚ï¼‰ åœ¨ /etc/sysctl.conf ä¸­ï¼š\n"},{"id":293,"href":"/backend/python/official/list/","title":"List (åˆ—è¡¨)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ Python listï¼ˆåˆ—è¡¨ï¼‰æœ€å¼ºå­¦ä¹ ä¸é€ŸæŸ¥æŒ‡å—ï¼Œå†…å®¹ä¾æ—§ä¿æŒâ€œç®€æ´ + å…¨é¢ + å®æˆ˜åŒ–â€é£æ ¼ï¼Œæ¶µç›–åŸºç¡€ã€è¿›é˜¶ã€æ€§èƒ½ã€å¸¸è§å‘ã€é«˜çº§ç”¨æ³•ã€æ¨å¯¼å¼ã€æ’åºã€åˆ‡ç‰‡ã€é˜Ÿåˆ—/æ ˆæ¨¡å‹ç­‰ã€‚\nPython çš„ list æ˜¯ åŠ¨æ€æ•°ç»„ï¼ˆdynamic arrayï¼‰ï¼Œæ˜¯ Python ä½¿ç”¨æœ€é¢‘ç¹çš„æ•°æ®ç»“æ„ã€‚\n1. list æ ¸å¿ƒç‰¹æ€§ åŠ¨æ€æ•°ç»„ï¼ˆå¯è‡ªåŠ¨æ‰©å®¹ï¼‰ æœ‰åºï¼ˆä¿æŒæ’å…¥é¡ºåºï¼‰ å¯å˜ç±»å‹ï¼ˆmutableï¼‰ å…ƒç´ å¯ä»¥æ˜¯ä»»æ„ç±»å‹ æ”¯æŒåˆ‡ç‰‡ã€æ’åºã€æ¨å¯¼å¼ 2. å¸¸è§åˆ›å»ºæ–¹å¼ a = [1, 2, 3] b = list(\u0026#34;abc\u0026#34;) # [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;] c = [i*i for i in range(5)] d = [] # ç©ºåˆ—è¡¨ 3. å¸¸ç”¨æ“ä½œï¼ˆå¿…èƒŒï¼‰ append() # å°¾éƒ¨æ·»åŠ  extend() # æ‰©å±•å¤šä¸ªå…ƒç´  insert() # æŒ‡å®šä½ç½®æ’å…¥ pop() # åˆ é™¤æœ€åä¸€ä¸ªå¹¶è¿”å› remove() # åˆ é™¤ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ clear() # æ¸…ç©ºåˆ—è¡¨ index() # æŸ¥æ‰¾å…ƒç´ ä½ç½® count() # è®¡æ•° sort() # åŸåœ°æ’åº sorted() # ç”Ÿæˆæ–°åˆ—è¡¨ reverse() # åŸåœ°åè½¬ reversed() # æƒ°æ€§åè½¬ï¼ˆè¿­ä»£å™¨ï¼‰ 4. å¢åˆ æ”¹æŸ¥ç¤ºä¾‹ å¢åŠ \nlst.append(4) lst.extend([5, 6]) lst.insert(0, 99) åˆ é™¤\nlst.pop() # æœ€åä¸€ä¸ª lst.pop(1) # æŒ‡å®š index lst.remove(3) # åˆ é™¤å€¼ä¸º3çš„é¡¹ del lst[2] # åˆ é™¤ index 2 ä¿®æ”¹\nlst[0] = 100 lst[1:3] = [7, 8, 9] # åˆ‡ç‰‡èµ‹å€¼ æŸ¥è¯¢\nlst[0] lst[-1] lst.index(10) 10 in lst 5. åˆ‡ç‰‡ï¼ˆsliceï¼‰ lst[start:end] # å« startï¼Œä¸å« end lst[1:5:2] # æ­¥é•¿ lst[::-1] # åè½¬ lst[:] # æµ…æ‹·è´ 6. åˆ—è¡¨æ¨å¯¼å¼ï¼ˆPythonic å¿…å¤‡ï¼‰ åŸºç¡€\n[i*2 for i in range(5)] å¸¦è¿‡æ»¤\n[i for i in range(10) if i % 2 == 0] åµŒå¥—\n[(x, y) for x in range(3) for y in range(3)] å¤„ç†å­—å…¸\n[k for k, v in d.items() if v \u0026gt; 10] 7. æ’åº åŸåœ°æ’åºï¼ˆä¿®æ”¹åŸåˆ—è¡¨ï¼‰\nlst.sort() # å‡åº lst.sort(reverse=True) # é™åº lst.sort(key=lambda x: x[1]) # æŒ‰å­é¡¹æ’åº è¿”å›æ–°åˆ—è¡¨\nnew_lst = sorted(lst) 8. list é«˜çº§ç”¨æ³• 1) ä½œä¸º æ ˆï¼ˆstackï¼šåè¿›å…ˆå‡ºï¼‰ stack = [] stack.append(1) stack.append(2) stack.pop() # -\u0026gt; 2 2) ä½œä¸º é˜Ÿåˆ—ï¼ˆFIFOï¼‰ -\u0026gt; ä¸æ¨è å› ä¸º pop(0) æ˜¯ O(n) æ€§èƒ½ä½ã€‚\næ¨èç”¨ collections.dequeï¼\n3) åˆ—è¡¨å±•å¼€ï¼ˆè§£åŒ…ï¼‰ a, b, *rest = [1, 2, 3, 4, 5] 4) é“¾å¼åˆå¹¶ merged = [*list1, *list2, *list3] 5) è¿‡æ»¤ç©ºæ•°æ® clean = [x for x in lst if x] 6) å¤šå±‚åµŒå¥— flatten flat = [j for i in nested for j in i] 9. æ€§èƒ½ä¸åº•å±‚åŸç† list æœ¬è´¨æ˜¯åŠ¨æ€æ•°ç»„ï¼šè¿ç»­å†…å­˜ + è‡ªåŠ¨æ‰©å®¹æœºåˆ¶ã€‚\næ·»åŠ ï¼ˆappendï¼‰ï¼šå‡æ‘Š O(1)\néšæœºè®¿é—®ï¼šO(1)\npop(0)ã€insert(0)ï¼šO(n)ï¼ˆéœ€è¦ç§»åŠ¨æ‰€æœ‰å…ƒç´ ï¼‰\n10. æ‹·è´ä¸æ·±æµ…å¤åˆ¶ æµ…æ‹·è´ï¼ˆå¸¸ç”¨ï¼‰\nlst_copy = lst[:] lst_copy = list(lst) lst_copy = lst.copy() æ·±æ‹·è´\nimport copy deep = copy.deepcopy(lst) 11. å¸¸è§å‘ âŒ 1) åƒä¸‡ä¸è¦è¿™æ ·ç”ŸæˆäºŒç»´æ•°ç»„ x = [[0] * 3] * 3 ä¼šåˆ›å»º åŒä¸€ä¸ªå¯¹è±¡çš„ 3 ä¸ªå¼•ç”¨ã€‚\nâœ… æ­£ç¡®å†™æ³•ï¼š\nx = [[0 for _ in range(3)] for _ in range(3)] âŒ 2) ä¸è¦åœ¨éå†çš„åŒæ—¶ä¿®æ”¹åˆ—è¡¨ for i in lst: lst.remove(i) # é€»è¾‘é”™ä¹± âœ… æ­£ç¡®ï¼š\nfor i in lst[:]: lst.remove(i) âŒ 3) åˆ—è¡¨å½“é˜Ÿåˆ—æ•ˆç‡ä½ï¼ˆä½¿ç”¨ dequeï¼‰ 12. åˆ—è¡¨ vs å…¶ä»–å®¹å™¨ ç±»å‹ ç‰¹ç‚¹ åœºæ™¯ list åŠ¨æ€æ•°ç»„ï¼Œæ”¯æŒåˆ‡ç‰‡ é€šç”¨ã€å¤šç”¨é€” tuple ä¸å¯å˜ å®‰å…¨ã€å¯å“ˆå¸Œã€ä½œä¸º key set å»é‡ã€æ— åº é›†åˆè¿ç®—ã€å¿«é€Ÿ membership dict key-value ç»“æ„åŒ–æ•°æ® deque åŒç«¯é˜Ÿåˆ— é˜Ÿåˆ—/æ ˆé«˜æ€§èƒ½åœºæ™¯ 13. åˆ—è¡¨çš„æœ€ä½³å®è·µï¼ˆå¼€å‘ä¸­å¸¸ç”¨ï¼‰ è¿‡æ»¤ï¼šåˆ—è¡¨æ¨å¯¼å¼ æ„é€ æ–°åˆ—è¡¨ï¼šæ¨å¯¼å¼ or map æ‰©å±•åˆ—è¡¨ï¼šextend è€Œä¸æ˜¯ append(list) é˜Ÿåˆ—ä»»åŠ¡ï¼šç”¨ deque æ’åºï¼šsort(key=\u0026hellip;) flattensï¼šåŒå¾ªç¯æ¨å¯¼å¼ åˆå¹¶ï¼š[*a, *b] ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ Python listï¼ˆåˆ—è¡¨ï¼‰æœ€å¼ºå­¦ä¹ ä¸é€ŸæŸ¥æŒ‡å—ï¼Œå†…å®¹ä¾æ—§ä¿æŒâ€œç®€æ´ + å…¨é¢ + å®æˆ˜åŒ–â€é£æ ¼ï¼Œæ¶µç›–åŸºç¡€ã€è¿›é˜¶ã€æ€§èƒ½ã€å¸¸è§å‘ã€é«˜çº§ç”¨æ³•ã€æ¨å¯¼å¼ã€æ’åºã€åˆ‡ç‰‡ã€é˜Ÿåˆ—/æ ˆæ¨¡å‹ç­‰ã€‚\nPython çš„ list æ˜¯ åŠ¨æ€æ•°ç»„ï¼ˆdynamic arrayï¼‰ï¼Œæ˜¯ Python ä½¿ç”¨æœ€é¢‘ç¹çš„æ•°æ®ç»“æ„ã€‚\n1. list æ ¸å¿ƒç‰¹æ€§ åŠ¨æ€æ•°ç»„ï¼ˆå¯è‡ªåŠ¨æ‰©å®¹ï¼‰ æœ‰åºï¼ˆä¿æŒæ’å…¥é¡ºåºï¼‰ å¯å˜ç±»å‹ï¼ˆmutableï¼‰ å…ƒç´ å¯ä»¥æ˜¯ä»»æ„ç±»å‹ æ”¯æŒåˆ‡ç‰‡ã€æ’åºã€æ¨å¯¼å¼ 2. å¸¸è§åˆ›å»ºæ–¹å¼ a = [1, 2, 3] b = list(\u0026#34;abc\u0026#34;) # [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;] c = [i*i for i in range(5)] d = [] # ç©ºåˆ—è¡¨ 3. å¸¸ç”¨æ“ä½œï¼ˆå¿…èƒŒï¼‰ append() # å°¾éƒ¨æ·»åŠ  extend() # æ‰©å±•å¤šä¸ªå…ƒç´  insert() # æŒ‡å®šä½ç½®æ’å…¥ pop() # åˆ é™¤æœ€åä¸€ä¸ªå¹¶è¿”å› remove() # åˆ é™¤ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ clear() # æ¸…ç©ºåˆ—è¡¨ index() # æŸ¥æ‰¾å…ƒç´ ä½ç½® count() # è®¡æ•° sort() # åŸåœ°æ’åº sorted() # ç”Ÿæˆæ–°åˆ—è¡¨ reverse() # åŸåœ°åè½¬ reversed() # æƒ°æ€§åè½¬ï¼ˆè¿­ä»£å™¨ï¼‰ 4. å¢åˆ æ”¹æŸ¥ç¤ºä¾‹ å¢åŠ \n"},{"id":294,"href":"/backend/python/official/list-tuple-set/","title":"List / Tuple / Set","parent":"Official","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°ã€å¯ç›´æ¥æ”¶è—çš„æ€»ç»“ï¼šPython list / tuple / set çš„ç›¸åŒç‚¹ + é€šç”¨ç‚¹ + ä¸åŒç‚¹å¯¹æ¯”ä½“ç³»ã€‚\nğŸ¯ 1. list / tuple / set çš„å…±åŒç‚¹ï¼ˆé€šç”¨ç‰¹æ€§ï¼‰ âœ… 1.1 éƒ½æ˜¯ å®¹å™¨ç±»å‹ï¼ˆContainerï¼‰ å¯ä»¥â€œè£…å¤šä¸ªå…ƒç´ â€ã€‚\nx in container å‡å¯ä½¿ç”¨ï¼š\nlen() in / not in for å¾ªç¯éå† ( éƒ½æ˜¯ Iterable (å¯è¿­ä»£å¯¹è±¡) ) å¯ä»¥è¢«è½¬æ¢æˆå…¶ä»–å®¹å™¨ï¼šlist(), set(), tuple() âœ… 1.2 éƒ½æ˜¯ å¯è¿­ä»£å¯¹è±¡ï¼ˆIterableï¼‰ å¯ä»¥ç”¨äºï¼š\nfor x in obj: ... ä¹Ÿå¯ä»¥ç”¨äºï¼š\nsum() max() / min() sorted() enumerate() zip() map() / filter() è¿™äº›å‡½æ•°éƒ½æ¥å— list / tuple / setã€‚\nâœ… 1.3 éƒ½å¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„å…ƒç´  æ¯”å¦‚ï¼š\n[1, \u0026#34;a\u0026#34;, True] (1, [2,3], {\u0026#34;x\u0026#34;:1}) {1, 2, \u0026#34;abc\u0026#34;} âœ… 1.4 éƒ½æ”¯æŒè§£åŒ…ï¼ˆunpackingï¼‰ a, b, c = [1,2,3] a, b, c = (1,2,3) a, b, c = {1,2,3} # æ³¨æ„ set æ˜¯æ— åºçš„ âœ… 5. éƒ½å¯ä»¥ä½œä¸ºå‡½æ•°çš„å¯è¿­ä»£å‚æ•° list(x) tuple(x) set(x) âœ… 6. éƒ½å¯ä»¥è¢«æ¨å¯¼å¼ç”Ÿæˆï¼ˆcomprehensionï¼‰ åªæœ‰ set å’Œ list æ”¯æŒ â€œç›´æ¥æ¨å¯¼å¼â€ï¼Œtuple éœ€è¦ç”Ÿæˆå™¨åŒ…è£…ã€‚\nlist æ¨å¯¼å¼\n[x*2 for x in range(5)] set æ¨å¯¼å¼\n{x*2 for x in range(5)} tuple æ¨å¯¼å¼ï¼ˆå…¶å®æ˜¯ç”Ÿæˆå™¨ï¼‰\ntuple(x*2 for x in range(5)) ğŸ¯ 2. ä¸»è¦åŒºåˆ«å¯¹æ¯”ï¼ˆéå¸¸å…³é”®ï¼‰ ä¸‹é¢æ˜¯æœ€ç²¾åçš„æ€»è¡¨ï¼š\nğŸ§© æ ¸å¿ƒå¯¹æ¯”è¡¨\nç‰¹æ€§ list tuple set å¯å˜æ€§ âœ… å¯å˜ âŒ ä¸å¯å˜ âœ… å¯å˜ æ˜¯å¦å…è®¸é‡å¤ âœ… âœ… âŒ æœ‰åºæ€§ âœ… ä¿æŒé¡ºåº âœ… ä¿æŒé¡ºåº âŒ æ— åº ç´¢å¼•è®¿é—® âœ… âœ… âŒ åˆ‡ç‰‡è®¿é—® âœ… âœ… âŒ èƒ½å¦ä½œä¸º dict key âŒ âœ…ï¼ˆå…ƒç´ å¿…é¡»å¯å“ˆå¸Œï¼‰ âŒ é€Ÿåº¦ ä¸€èˆ¬ âœ… æœ€å¿« å¿« å…¸å‹åœºæ™¯ åŠ¨æ€åˆ—è¡¨ å›ºå®šç»“æ„ å»é‡ã€é›†åˆè¿ç®— ğŸ¯ 3. ä¸‰è€…å„è‡ªæœ€é‡è¦çš„ç‰¹æ€§ ğŸŸ¦ tuple ä¸å¯å˜ -\u0026gt; æ‹¥æœ‰æ›´é«˜æ€§èƒ½ä¸å®‰å…¨æ€§ å¯å“ˆå¸Œ -\u0026gt; å¯ä½œä¸º dict key æˆ– set å…ƒç´  å¸¸ç”¨äºå‡½æ•°â€œè¿”å›å¤šä¸ªå€¼â€ ğŸŸ© list é€‚åˆéœ€è¦å¢åˆ æ”¹çš„åŠ¨æ€åºåˆ— ä½¿ç”¨ append / pop æ€§èƒ½ä¸é”™ ğŸŸ§ set è‡ªåŠ¨å»é‡ æ•°å­¦é›†åˆè¿ç®—ï¼ˆéå¸¸å¼ºï¼‰ unionï¼ˆå¹¶é›†ï¼‰ intersectionï¼ˆäº¤é›†ï¼‰ differenceï¼ˆå·®é›†ï¼‰ ğŸ¯ 4. ä¸‰è€…åœ¨æŸäº›æ“ä½œä¸Šçš„ç»Ÿä¸€æ€§ 4.1 éƒ½èƒ½ç”¨äº sorted() sorted_list = sorted(my_list) sorted_tuple = sorted(my_tuple) sorted_set = sorted(my_set) # éœ€è¦æ’åºï¼Œå› ä¸º set æ— åº 4.2 éƒ½æ”¯æŒ len() len(list) len(tuple) len(set) 4.3 éƒ½èƒ½è½¬æ¢æˆå…¶ä»–å®¹å™¨ tuple([1,2,3]) list((1,2,3)) set([1,2,2,3]) 4.4 éƒ½å¯ç”¨äº for éå† ğŸ¯ 5. å“ªäº›æ“ä½œæ˜¯å…±åŒçš„ï¼Ÿ æ“ä½œ list tuple set éå† âœ… âœ… âœ… æˆå‘˜æ£€æŸ¥ âœ… âœ… âœ… é•¿åº¦ âœ… âœ… âœ… æ‹†åŒ… âœ… âœ… âœ… æ¯”è¾ƒ âœ… âœ… âœ… å¯è¿­ä»£ âœ… âœ… âœ… æ¨å¯¼å¼ï¼ˆæˆ–ç±»ä¼¼ï¼‰ âœ… ï¼ˆç”Ÿæˆå™¨ï¼‰ âœ… ğŸ¯ 6. ä¸å…±åŒçš„æ“ä½œï¼ˆæœ€å®¹æ˜“è®°é”™ï¼‰ æ“ä½œ list tuple set append âœ… âŒ âŒ extend âœ… âŒ âŒ pop âœ… âŒ âŒ å¯å“ˆå¸Œ âŒ âœ… âŒ é›†åˆè¿ç®— âŒ âŒ âœ… æœ‰åº âœ… âœ… âŒ åˆ‡ç‰‡ âœ… âœ… âŒ å»é‡ âŒ âŒ âœ…ï¼ˆå¤©ç„¶ï¼‰ ğŸ¯ 7. å“ªä¸ªæ›´çœå†…å­˜ï¼Ÿ tuple æœ€çœå†…å­˜ï¼Œæœ€å¿«\nä¸èƒ½ä¿®æ”¹ -\u0026gt; Python ä¼˜åŒ–åŠ›åº¦å¤§ å†…å­˜å ç”¨ï¼štuple \u0026lt; list \u0026lt; set\nğŸ¯ 8. å®æˆ˜ä½¿ç”¨å»ºè®®ï¼ˆæœ€é‡è¦ï¼‰ ç”¨ list åšåŠ¨æ€å¯ä¿®æ”¹çš„æ•°æ®ç»“æ„ users = [] users.append(new_user) ç”¨ tuple åšä¸å¯å˜é…ç½®ã€å‡½æ•°è¿”å›å€¼ã€ç»“æ„åŒ–å­—æ®µ config = (\u0026#34;db.example.com\u0026#34;, 5432) ç”¨ set å»é‡ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡ï¼ˆO(1)ï¼‰ unique_ids = set(ids) â­ æ€»ç»“ï¼ˆé€‚åˆä½œä¸ºé€ŸæŸ¥è¡¨ï¼‰ å…±åŒç‚¹ éƒ½æ˜¯å®¹å™¨ éƒ½å¯è¿­ä»£ éƒ½æ”¯æŒ len, in, for éå† éƒ½å¯æ¨å¯¼å¼ç”Ÿæˆï¼ˆtuple éœ€ç”Ÿæˆå™¨ï¼‰ éƒ½å¯ä»¥ç›¸äº’è½¬æ¢ ä¸»è¦åŒºåˆ« listï¼šå¯å˜ã€æœ‰åºã€å¯é‡å¤ã€å¯ç´¢å¼• tupleï¼šä¸å¯å˜ã€æœ‰åºã€å¯é‡å¤ã€å¯å“ˆå¸Œ setï¼šå¯å˜ã€æ— åºã€ä¸å¯é‡å¤ã€æ— ç´¢å¼•ã€æ”¯æŒé›†åˆè¿ç®— æ€§èƒ½ä¸ç”¨é€” tupleï¼šæœ€å¿«ã€æœ€çœå†…å­˜ -\u0026gt; ç»“æ„ä½“ã€è¿”å›å€¼ã€å¸¸é‡ listï¼šé€‚åˆåŠ¨æ€åºåˆ— -\u0026gt; è¿½åŠ ã€åˆ é™¤ setï¼šé€‚åˆå»é‡ã€é›†åˆè¿ç®— -\u0026gt; å¤§æ•°æ®å»é‡ \u0026amp; æŸ¥æ‰¾ O(1) ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°ã€å¯ç›´æ¥æ”¶è—çš„æ€»ç»“ï¼šPython list / tuple / set çš„ç›¸åŒç‚¹ + é€šç”¨ç‚¹ + ä¸åŒç‚¹å¯¹æ¯”ä½“ç³»ã€‚\nğŸ¯ 1. list / tuple / set çš„å…±åŒç‚¹ï¼ˆé€šç”¨ç‰¹æ€§ï¼‰ âœ… 1.1 éƒ½æ˜¯ å®¹å™¨ç±»å‹ï¼ˆContainerï¼‰ å¯ä»¥â€œè£…å¤šä¸ªå…ƒç´ â€ã€‚\n"},{"id":295,"href":"/backend/python/loguru/","title":"Loguru","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£: https://loguru.readthedocs.io/en/stable/\nDirectory List:\nLoguru åŸºç¡€æ•™ç¨‹ ","description":"å®˜æ–¹æ–‡æ¡£: https://loguru.readthedocs.io/en/stable/\nDirectory List:\nLoguru åŸºç¡€æ•™ç¨‹ "},{"id":296,"href":"/operations/linux/lsblk/","title":"lsblk","parent":"Linux","content":"lsblk (List Block Devices) æ˜¯ç”¨äºåˆ—å‡ºæ‰€æœ‰Linuxç³»ç»Ÿå—è®¾å¤‡ï¼ˆç¡¬ç›˜ã€SSDã€USBã€åˆ†åŒºã€æŒ‚è½½ç‚¹ï¼‰çš„å¸¸ç”¨å‘½ä»¤ã€‚å®ƒä»¥æ ‘çŠ¶ç»“æ„æ¸…æ™°å±•ç¤ºè®¾å¤‡åŠå…¶ä¾èµ–å…³ç³»ï¼Œæ˜¾ç¤ºåç§°ã€å¤§å°ã€ç±»å‹ï¼ˆdisk/partï¼‰å’ŒæŒ‚è½½ç‚¹ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹å­˜å‚¨ç»“æ„å’Œç»´æŠ¤ç³»ç»Ÿã€‚\næ ¸å¿ƒåŠŸèƒ½ä¸è¾“å‡ºå­—æ®µï¼š\nNAMEï¼šè®¾å¤‡åç§°ã€‚ MAJ:MINï¼šä¸»æ¬¡è®¾å¤‡å·ã€‚ RMï¼šæ˜¯å¦å¯ç§»åŠ¨è®¾å¤‡ï¼ˆ1è¡¨ç¤ºæ˜¯ï¼Œ0è¡¨ç¤ºå¦ï¼‰ã€‚ SIZEï¼šè®¾å¤‡å¤§å°ã€‚ ROï¼šæ˜¯å¦ä¸ºåªè¯»ã€‚ TYPEï¼šè®¾å¤‡ç±»å‹ï¼ˆå¦‚disk, part, lvmï¼‰ã€‚ MOUNTPOINTï¼šæŒ‚è½½ç‚¹ã€‚ å¸¸ç”¨é€‰é¡¹ä¸ç¤ºä¾‹ï¼š\nlsblkï¼šé»˜è®¤è¾“å‡ºï¼Œæ˜¾ç¤ºæ‰€æœ‰å—è®¾å¤‡çš„æ ‘çŠ¶ç»“æ„ã€‚ lsblk -fï¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆå¦‚ext4, xfs, vfatï¼‰å’ŒUUIDï¼Œå¯¹äºæŸ¥çœ‹åˆ†åŒºæ ¼å¼éå¸¸æœ‰ç”¨ã€‚ lsblk -aï¼šæ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡ï¼ŒåŒ…æ‹¬ç©ºè®¾å¤‡å’Œloopè®¾å¤‡ã€‚ lsblk -dï¼šä»…æ˜¾ç¤ºç£ç›˜ï¼ˆdiskï¼‰ï¼Œä¸æ˜¾ç¤ºåˆ†åŒºï¼ˆpartï¼‰ã€‚ lsblk -pï¼šæ˜¾ç¤ºè®¾å¤‡çš„å®Œæ•´è·¯å¾„ï¼ˆå¦‚ /dev/sda è€Œä¸æ˜¯ sdaï¼‰ã€‚ lsblk -mï¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿçš„æƒé™ä¿¡æ¯ã€‚ lsblk -o [åˆ—å]ï¼šè‡ªå®šä¹‰è¾“å‡ºçš„åˆ—ï¼Œä¾‹å¦‚ lsblk -o NAME,SIZE,TYPE,MOUNTPOINTã€‚ lsblk -bï¼šä»¥å­—èŠ‚ä¸ºå•ä½æ˜¾ç¤ºå¤§å°ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„æ˜“è¯»æ ¼å¼ã€‚ åº”ç”¨åœºæ™¯ï¼š\næ£€æŸ¥ç£ç›˜åˆ†åŒºï¼šå¿«é€ŸæŸ¥çœ‹æ–°ç£ç›˜æˆ–æ£€æŸ¥ç°æœ‰åˆ†åŒºã€‚ æ£€æŸ¥æŒ‚è½½æƒ…å†µï¼šç¡®å®šè®¾å¤‡æŒ‚è½½åˆ°äº†å“ªä¸ªç›®å½•ã€‚ æ’æŸ¥LVMé€»è¾‘å·ï¼šæ˜¾ç¤ºé€»è¾‘å·ä¸å…¶ç‰©ç†å·çš„ä¾èµ–å…³ç³»ã€‚ lsblk åŒ…å«åœ¨ util-linux è½¯ä»¶åŒ…ä¸­ï¼Œè¯¥åŒ…åœ¨å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆä¸­é¢„è£…ã€‚\nç¤ºä¾‹ï¼š\n# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ LVM é€»è¾‘å· lsblk -o FSTYPE | grep -i lvm ","description":"lsblk (List Block Devices) æ˜¯ç”¨äºåˆ—å‡ºæ‰€æœ‰Linuxç³»ç»Ÿå—è®¾å¤‡ï¼ˆç¡¬ç›˜ã€SSDã€USBã€åˆ†åŒºã€æŒ‚è½½ç‚¹ï¼‰çš„å¸¸ç”¨å‘½ä»¤ã€‚å®ƒä»¥æ ‘çŠ¶ç»“æ„æ¸…æ™°å±•ç¤ºè®¾å¤‡åŠå…¶ä¾èµ–å…³ç³»ï¼Œæ˜¾ç¤ºåç§°ã€å¤§å°ã€ç±»å‹ï¼ˆdisk/partï¼‰å’ŒæŒ‚è½½ç‚¹ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹å­˜å‚¨ç»“æ„å’Œç»´æŠ¤ç³»ç»Ÿã€‚\næ ¸å¿ƒåŠŸèƒ½ä¸è¾“å‡ºå­—æ®µï¼š\nNAMEï¼šè®¾å¤‡åç§°ã€‚ MAJ:MINï¼šä¸»æ¬¡è®¾å¤‡å·ã€‚ RMï¼šæ˜¯å¦å¯ç§»åŠ¨è®¾å¤‡ï¼ˆ1è¡¨ç¤ºæ˜¯ï¼Œ0è¡¨ç¤ºå¦ï¼‰ã€‚ SIZEï¼šè®¾å¤‡å¤§å°ã€‚ ROï¼šæ˜¯å¦ä¸ºåªè¯»ã€‚ TYPEï¼šè®¾å¤‡ç±»å‹ï¼ˆå¦‚disk, part, lvmï¼‰ã€‚ MOUNTPOINTï¼šæŒ‚è½½ç‚¹ã€‚ å¸¸ç”¨é€‰é¡¹ä¸ç¤ºä¾‹ï¼š\nlsblkï¼šé»˜è®¤è¾“å‡ºï¼Œæ˜¾ç¤ºæ‰€æœ‰å—è®¾å¤‡çš„æ ‘çŠ¶ç»“æ„ã€‚ lsblk -fï¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆå¦‚ext4, xfs, vfatï¼‰å’ŒUUIDï¼Œå¯¹äºæŸ¥çœ‹åˆ†åŒºæ ¼å¼éå¸¸æœ‰ç”¨ã€‚ lsblk -aï¼šæ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡ï¼ŒåŒ…æ‹¬ç©ºè®¾å¤‡å’Œloopè®¾å¤‡ã€‚ lsblk -dï¼šä»…æ˜¾ç¤ºç£ç›˜ï¼ˆdiskï¼‰ï¼Œä¸æ˜¾ç¤ºåˆ†åŒºï¼ˆpartï¼‰ã€‚ lsblk -pï¼šæ˜¾ç¤ºè®¾å¤‡çš„å®Œæ•´è·¯å¾„ï¼ˆå¦‚ /dev/sda è€Œä¸æ˜¯ sdaï¼‰ã€‚ lsblk -mï¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿçš„æƒé™ä¿¡æ¯ã€‚ lsblk -o [åˆ—å]ï¼šè‡ªå®šä¹‰è¾“å‡ºçš„åˆ—ï¼Œä¾‹å¦‚ lsblk -o NAME,SIZE,TYPE,MOUNTPOINTã€‚ lsblk -bï¼šä»¥å­—èŠ‚ä¸ºå•ä½æ˜¾ç¤ºå¤§å°ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„æ˜“è¯»æ ¼å¼ã€‚ åº”ç”¨åœºæ™¯ï¼š\næ£€æŸ¥ç£ç›˜åˆ†åŒºï¼šå¿«é€ŸæŸ¥çœ‹æ–°ç£ç›˜æˆ–æ£€æŸ¥ç°æœ‰åˆ†åŒºã€‚ æ£€æŸ¥æŒ‚è½½æƒ…å†µï¼šç¡®å®šè®¾å¤‡æŒ‚è½½åˆ°äº†å“ªä¸ªç›®å½•ã€‚ æ’æŸ¥LVMé€»è¾‘å·ï¼šæ˜¾ç¤ºé€»è¾‘å·ä¸å…¶ç‰©ç†å·çš„ä¾èµ–å…³ç³»ã€‚ lsblk åŒ…å«åœ¨ util-linux è½¯ä»¶åŒ…ä¸­ï¼Œè¯¥åŒ…åœ¨å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆä¸­é¢„è£…ã€‚\nç¤ºä¾‹ï¼š\n# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ LVM é€»è¾‘å· lsblk -o FSTYPE | grep -i lvm "},{"id":297,"href":"/operations/lvs/","title":"LVS","parent":"Operations","content":"Document List:\nLVS FAQ LVS åŸºç¡€æ•™ç¨‹ LVS æ ¸å¿ƒæ¦‚å¿µ Keepalived åŸºç¡€æ•™ç¨‹ ","description":"Document List:\nLVS FAQ LVS åŸºç¡€æ•™ç¨‹ LVS æ ¸å¿ƒæ¦‚å¿µ Keepalived åŸºç¡€æ•™ç¨‹ "},{"id":298,"href":"/operations/macos/tips/","title":"macOS Tips","parent":"macOS","content":"å¯åŠ¨ç”µè„‘\næ›´æ–°ç³»ç»Ÿ\nå°†ç¡¬ç›˜åˆ†ä¸ºä¸¤ä¸ªåŒº(ä¸åŠ å¯†, ä¸åˆ†åŒºå¤§å°å†™):\nç³»ç»Ÿç›˜: 100G æ•°æ®ç›˜: å‰©ä½™ç©ºé—´ è®¾ç½®ä¸»æœºå\nå®‰è£… Command Line Tools\nä¸‹è½½åœ°å€: https://developer.apple.com/download/more/ å®‰è£… Homebrew\nå®˜ç½‘: https://brew.sh/ å¸¸ç”¨å‘½ä»¤:\n# â€œåº”ç”¨ç¨‹åºâ€ å·²æŸåï¼Œæ— æ³•æ‰“å¼€ sudo xattr -dr com.apple.quarantine /Applications/Name.app sudo xattr -cr /Applications/Name.app # TNT App Crashe: # **Apple removed TNTâ€™s certificate, so the app will crash after July 12th. # The current solution is to sign it yourself.** # [If Crashes when opening](https://www.macbed.com/if-crashes-when-opening/) # è‹¹æœç§»é™¤äº† TNT çš„è¯ä¹¦, æ‰€ä»¥ TNT ç ´è§£çš„ APP åœ¨ 2019å¹´7æœˆ12å ä¼šæ— æ³•è¿è¡Œ(crash). å½“å‰çš„è§£å†³æ–¹æ³•æ˜¯ç§»é™¤ç­¾å. # è¿è¡Œç»ˆç«¯, ç§»é™¤æŒ‡å®š APP çš„ç­¾å. # æ‰€ä»¥, å¦‚æœ APP è¿è¡Œå‡ºé”™, æœ‰å¯èƒ½æ˜¯è¯ä¹¦çš„é—®é¢˜, ç§»é™¤è¯ä¹¦è¯•è¯•. sudo codesign --force --deep --sign - /Applications/Name.app # ç™»å½•é¡µé¢éšè—å…¶å®ƒç”¨æˆ· sudo defaults write /Library/Preferences/com.apple.loginwindow SHOWOTHERUSERS_MANAGED -bool FALSE # å®‰è£…è½¯ä»¶ä¹‹å‰ # sudo spctl --master-disable # å®‰è£…è½¯ä»¶ä¹‹å # sudo spctl --master-enable # å…³é—­å¼€æœºå£°éŸ³ sudo nvram SystemAudioVolume=%80 # æ¢å¤å¼€æœºå£°éŸ³ # sudo nvram -d SystemAudioVolume # -------------------------------------------------------------------------------------------------- # å…³é—­èšç„¦åŠŸèƒ½ (é¿å…å‘ç”Ÿè¿‡å¾…æœºå‘çƒ­çš„é—®é¢˜) sudo mdutil -a -i off # å¼€å¯èšç„¦åŠŸèƒ½ # sudo mdutil -a -i on # -------------------------------------------------------------------------------------------------- # Photoshop for i in {1..15}; do defaults write com.adobe.CSXS.$i PlayerDebugMode 1; done ","description":"å¯åŠ¨ç”µè„‘\næ›´æ–°ç³»ç»Ÿ\nå°†ç¡¬ç›˜åˆ†ä¸ºä¸¤ä¸ªåŒº(ä¸åŠ å¯†, ä¸åˆ†åŒºå¤§å°å†™):\nç³»ç»Ÿç›˜: 100G æ•°æ®ç›˜: å‰©ä½™ç©ºé—´ è®¾ç½®ä¸»æœºå\nå®‰è£… Command Line Tools\nä¸‹è½½åœ°å€: https://developer.apple.com/download/more/ å®‰è£… Homebrew\nå®˜ç½‘: https://brew.sh/ å¸¸ç”¨å‘½ä»¤:\n# â€œåº”ç”¨ç¨‹åºâ€ å·²æŸåï¼Œæ— æ³•æ‰“å¼€ sudo xattr -dr com.apple.quarantine /Applications/Name.app sudo xattr -cr /Applications/Name.app # TNT App Crashe: # **Apple removed TNTâ€™s certificate, so the app will crash after July 12th. # The current solution is to sign it yourself.** # [If Crashes when opening](https://www.macbed.com/if-crashes-when-opening/) # è‹¹æœç§»é™¤äº† TNT çš„è¯ä¹¦, æ‰€ä»¥ TNT ç ´è§£çš„ APP åœ¨ 2019å¹´7æœˆ12å ä¼šæ— æ³•è¿è¡Œ(crash). å½“å‰çš„è§£å†³æ–¹æ³•æ˜¯ç§»é™¤ç­¾å. # è¿è¡Œç»ˆç«¯, ç§»é™¤æŒ‡å®š APP çš„ç­¾å. # æ‰€ä»¥, å¦‚æœ APP è¿è¡Œå‡ºé”™, æœ‰å¯èƒ½æ˜¯è¯ä¹¦çš„é—®é¢˜, ç§»é™¤è¯ä¹¦è¯•è¯•. sudo codesign --force --deep --sign - /Applications/Name.app # ç™»å½•é¡µé¢éšè—å…¶å®ƒç”¨æˆ· sudo defaults write /Library/Preferences/com.apple.loginwindow SHOWOTHERUSERS_MANAGED -bool FALSE # å®‰è£…è½¯ä»¶ä¹‹å‰ # sudo spctl --master-disable # å®‰è£…è½¯ä»¶ä¹‹å # sudo spctl --master-enable # å…³é—­å¼€æœºå£°éŸ³ sudo nvram SystemAudioVolume=%80 # æ¢å¤å¼€æœºå£°éŸ³ # sudo nvram -d SystemAudioVolume # -------------------------------------------------------------------------------------------------- # å…³é—­èšç„¦åŠŸèƒ½ (é¿å…å‘ç”Ÿè¿‡å¾…æœºå‘çƒ­çš„é—®é¢˜) sudo mdutil -a -i off # å¼€å¯èšç„¦åŠŸèƒ½ # sudo mdutil -a -i on # -------------------------------------------------------------------------------------------------- # Photoshop for i in {1..15}; do defaults write com.adobe.CSXS.$i PlayerDebugMode 1; done "},{"id":299,"href":"/backend/python/official/map/","title":"Map å‡½æ•°","parent":"Official","content":" âœ… Python map()ï¼šæ ¸å¿ƒæ¦‚å¿µ map(function, iterable, \u0026hellip;)\nè®© function ä½œç”¨äº iterable çš„æ¯ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ª æƒ°æ€§ map å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰ã€‚\nâœ… 1. åŸºæœ¬ç”¨æ³• result = map(lambda x: x * 2, [1, 2, 3]) print(list(result)) # [2, 4, 6] âœ… 2. ä½œç”¨å¤šä¸ªåºåˆ— map() ä¼šå¹¶è¡Œå–å¤šä¸ªåºåˆ—çš„å¯¹åº”å…ƒç´ ï¼š\na = [1, 2, 3] b = [10, 20, 30] result = map(lambda x, y: x + y, a, b) print(list(result)) # [11, 22, 33] âœ… 3. map + å†…ç½®å‡½æ•° è½¬æ¢ç±»å‹\nnums = [\u0026#39;1\u0026#39;, \u0026#39;2\u0026#39;, \u0026#39;3\u0026#39;] print(list(map(int, nums))) # [1, 2, 3] å»æ‰å­—ç¬¦ä¸²ä¸¤è¾¹ç©ºæ ¼\nitems = [\u0026#39; a \u0026#39;, \u0026#39; b \u0026#39;, \u0026#39; c \u0026#39;] print(list(map(str.strip, items))) # [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;] âœ… 4. map + è‡ªå®šä¹‰å‡½æ•° def square(n): return n * n result = map(square, range(5)) print(list(result)) # [0, 1, 4, 9, 16] âœ… 5. map æ˜¯æƒ°æ€§çš„ ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œç›´åˆ°ä½ æ¶ˆè´¹å®ƒï¼š\nm = map(int, [\u0026#39;1\u0026#39;, \u0026#39;2\u0026#39;, \u0026#39;3\u0026#39;]) print(next(m)) # 1 print(next(m)) # 2 âœ… 6. map ä¸åˆ—è¡¨æ¨å¯¼å¼å¯¹æ¯” mapï¼šé€‚åˆå‡½æ•°å¼ã€æ‰¹é‡è°ƒç”¨å‡½æ•°\nåˆ—è¡¨æ¨å¯¼ï¼šæ›´å¯è¯»ï¼Œå¯å†™é€»è¾‘\nç­‰ä»·ç¤ºä¾‹ï¼š\nlist(map(lambda x: x * 2, arr)) [x * 2 for x in arr] å¤æ‚é€»è¾‘ -\u0026gt; list comprehension æ›´ç›´è§‚ã€‚\næ‰¹é‡è½¬æ¢ -\u0026gt; map æ›´ç®€æ´ã€‚\nâœ… 7. map + å¤šå‚æ•°å‡½æ•° def combine(a, b, c): return f\u0026#34;{a}-{b}-{c}\u0026#34; result = map(combine, [1,2], [\u0026#39;A\u0026#39;,\u0026#39;B\u0026#39;], [\u0026#39;x\u0026#39;,\u0026#39;y\u0026#39;]) print(list(result)) # [\u0026#39;1-A-x\u0026#39;, \u0026#39;2-B-y\u0026#39;] âœ… 8. map + dict å¤„ç† key è½¬æ¢\nd = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2} keys_upper = dict(map(lambda kv: (kv[0].upper(), kv[1]), d.items())) print(keys_upper) # {\u0026#39;A\u0026#39;: 1, \u0026#39;B\u0026#39;: 2} âœ… 9. map + æ•°æ®æ¸…æ´—ï¼ˆæœ€å¸¸è§ï¼‰ å»ç©ºæ ¼ -\u0026gt; å¤§å†™ -\u0026gt; è¿‡æ»¤ç©ºå­—ç¬¦ä¸²\nitems = [\u0026#34; a \u0026#34;, \u0026#34;B \u0026#34;, \u0026#34; \u0026#34;, \u0026#34;c\u0026#34;] clean = list(map(lambda x: x.strip().upper(), items)) print(clean) # [\u0026#39;A\u0026#39;, \u0026#39;B\u0026#39;, \u0026#39;\u0026#39;, \u0026#39;C\u0026#39;] âœ… 10. map å®æˆ˜ï¼šè‚¡ç¥¨æ•°æ®å¤„ç† stocks = [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;price\u0026#34;: \u0026#34;10.23\u0026#34;}, {\u0026#34;code\u0026#34;: \u0026#34;600002\u0026#34;, \u0026#34;price\u0026#34;: \u0026#34;12.50\u0026#34;}, ] processed = list(map(lambda s: {**s, \u0026#34;price\u0026#34;: float(s[\u0026#34;price\u0026#34;])}, stocks)) print(processed) ğŸ¯ æ€»ç»“ï¼šmap() çš„ä½¿ç”¨åœºæ™¯ åœºæ™¯ æ˜¯å¦é€‚ç”¨ æ‰¹é‡è°ƒç”¨æŸä¸ªå‡½æ•° âœ… map å¾ˆé€‚åˆ å¹¶è¡Œå¤„ç†å¤šä¸ªåˆ—è¡¨ âœ… map éå¸¸é€‚åˆ å¤æ‚é€»è¾‘ âŒ ç”¨åˆ—è¡¨æ¨å¯¼å¼æ›´å¥½ æƒ°æ€§å¤„ç†å¤§æ•°æ® âœ… map å¾ˆå¼º æ•°æ®æ¸…æ´— pipeline âœ… map å¸¸ç”¨ ","description":" âœ… Python map()ï¼šæ ¸å¿ƒæ¦‚å¿µ map(function, iterable, \u0026hellip;)\nè®© function ä½œç”¨äº iterable çš„æ¯ä¸ªå…ƒç´ ï¼Œè¿”å›ä¸€ä¸ª æƒ°æ€§ map å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰ã€‚\nâœ… 1. åŸºæœ¬ç”¨æ³• result = map(lambda x: x * 2, [1, 2, 3]) print(list(result)) # [2, 4, 6] âœ… 2. ä½œç”¨å¤šä¸ªåºåˆ— map() ä¼šå¹¶è¡Œå–å¤šä¸ªåºåˆ—çš„å¯¹åº”å…ƒç´ ï¼š\n"},{"id":300,"href":"/backend/python/official/match/","title":"Match (åŒ¹é…)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/reference/compound_stmts.html\nğŸŸ¦ 1. åŸºç¡€è¯­æ³• match value: case pattern1: ... case pattern2: ... case _: ... match ç±»ä¼¼ switch case _ ç±»ä¼¼ default ğŸŸ© 2. æœ€ç®€å•ç¤ºä¾‹ match status: case 200: print(\u0026#34;OK\u0026#34;) case 404: print(\u0026#34;Not Found\u0026#34;) case _: print(\u0026#34;Unknown\u0026#34;) ğŸŸ¦ 3. case æ”¯æŒå¤šæ¨¡å¼ | æˆ–åŒ¹é… match ext: case \u0026#34;jpg\u0026#34; | \u0026#34;png\u0026#34; | \u0026#34;gif\u0026#34;: print(\u0026#34;å›¾ç‰‡æ–‡ä»¶\u0026#34;) case \u0026#34;mp4\u0026#34; | \u0026#34;avi\u0026#34;: print(\u0026#34;è§†é¢‘æ–‡ä»¶\u0026#34;) ğŸŸ© 4. case ä¸­ç›´æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼ˆå¥½ç”¨ï¼‰ match x: case x if x \u0026gt; 10: print(\u0026#34;\u0026gt; 10\u0026#34;) case x if x == 10: print(\u0026#34;= 10\u0026#34;) case _: print(\u0026#34;\u0026lt; 10\u0026#34;) ğŸŸ¦ 5. åŒ¹é…åºåˆ—ï¼ˆåˆ—è¡¨/å…ƒç»„ï¼‰ å›ºå®šé•¿åº¦\nmatch items: case [x, y]: print(\u0026#34;ä¸¤ä¸ªå…ƒç´ \u0026#34;, x, y) å¯å˜æ•°é‡ï¼ˆ*restï¼‰\nmatch items: case [first, *rest]: print(first, rest) ğŸŸ© 6. åŒ¹é… dictï¼ˆå·¥ç¨‹ä¸­å¾ˆå¸¸ç”¨ï¼‰ match data: case {\u0026#34;code\u0026#34;: c, \u0026#34;name\u0026#34;: n}: print(c, n) éƒ¨åˆ†åŒ¹é…ä¹Ÿè¡Œï¼š\nmatch data: case {\u0026#34;code\u0026#34;: c}: print(\u0026#34;code =\u0026#34;, c) ğŸŸ¦ 7. åŒ¹é…ç±»å¯¹è±¡ï¼ˆæ¯” isinstance å¼ºå¤ªå¤šï¼‰ class User: def __init__(self, name): self.name = name user = User(\u0026#34;tom\u0026#34;) match user: case User(name=username): print(\u0026#34;ç”¨æˆ·åå­—:\u0026#34;, username) è¿™æ˜¯ è‡ªåŠ¨è§£æ„ç±»å®ä¾‹ \u0026ndash; éå¸¸å¼ºã€‚\nğŸŸ© 8. é»˜è®¤åˆ†æ”¯ï¼ˆç”¨ _ ï¼‰ match value: case _: print(\u0026#34;fallback\u0026#34;) ğŸŸ¦ 9. match-case vs if-elifï¼šä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ | åœºæ™¯ | ç”¨ match-case | | æœ‰å¤šä¸ªç¦»æ•£å€¼åˆ†æ”¯ | âœ… | | ç»“æ„åŒ–æ•°æ®ï¼ˆdict / listï¼‰åŒ¹é… | âœ…ï¼ˆå¼ºçƒˆæ¨èï¼‰ | | æ‹†è§£ç±»å¯¹è±¡ | âœ… | | å¤æ‚æ¡ä»¶åˆ¤æ–­ | âœ… | | ç®€å•æ¡ä»¶ï¼ˆ\u0026lt;ã€\u0026gt;ã€é€»è¾‘åˆ¤æ–­ï¼‰ | if æ›´å¥½ |\nğŸŸ© 10. å·¥ç¨‹åº”ç”¨ç¤ºä¾‹ï¼ˆä½ çš„é¡¹ç›®é‡Œå¸¸ç”¨ï¼‰ â‘  API ç±»å‹åˆ†å‘ï¼ˆæ¯” if-elif å¥½çœ‹ 100 å€ï¼‰ match target: case \u0026#34;up_pool\u0026#34;: info = \u0026#34;æ¶¨åœæ± \u0026#34; case \u0026#34;continuous_up_pool\u0026#34;: info = \u0026#34;è¿æ¿æ± \u0026#34; case \u0026#34;up_open_pool\u0026#34;: info = \u0026#34;ç‚¸æ¿æ± \u0026#34; case \u0026#34;down_pool\u0026#34;: info = \u0026#34;è·Œåœæ± \u0026#34; case _: raise ValueError(f\u0026#34;æœªçŸ¥ target: {target}\u0026#34;) ä¹‹å‰å†™çš„ match True: case True if ...: ä¸å¤ª Pythonicï¼Œæœ€å¥½æ”¹æˆä¸Šé¢è¿™ç§ã€‚\nâ‘¡ SQL æ„é€ å™¨ï¼ˆdict è‡ªåŠ¨è§£æï¼‰ def build_filter(expr: dict): match expr: case {\u0026#34;field\u0026#34;: field, \u0026#34;op\u0026#34;: \u0026#34;eq\u0026#34;, \u0026#34;value\u0026#34;: v}: return f\u0026#34;{field} = %s\u0026#34;, [v] case {\u0026#34;field\u0026#34;: field, \u0026#34;op\u0026#34;: \u0026#34;gt\u0026#34;, \u0026#34;value\u0026#34;: v}: return f\u0026#34;{field} \u0026gt; %s\u0026#34;, [v] case {\u0026#34;field\u0026#34;: field, \u0026#34;op\u0026#34;: \u0026#34;in\u0026#34;, \u0026#34;value\u0026#34;: list(values)}: return f\u0026#34;{field} IN ({\u0026#39;,\u0026#39;.join([\u0026#39;%s\u0026#39;]*len(values))})\u0026#34;, values case _: raise ValueError(\u0026#34;æ— æ•ˆè¡¨è¾¾å¼\u0026#34;) ğŸŸ¦ 11. é«˜çº§ï¼šåµŒå¥—ç»“æ„åŒ¹é… match data: case {\u0026#34;user\u0026#34;: {\u0026#34;name\u0026#34;: name, \u0026#34;age\u0026#34;: age}}: print(name, age) æ¯”æ‰‹åŠ¨å†™åˆ¤æ–­å¹²å‡€å¤ªå¤šã€‚\nğŸŸ© 12. é«˜çº§ï¼šä½¿ç”¨å®ˆå«ï¼ˆcase ä¸­ ifï¼‰ match user: case {\u0026#34;age\u0026#34;: age} if age \u0026gt;= 18: print(\u0026#34;adult\u0026#34;) case {\u0026#34;age\u0026#34;: age}: print(\u0026#34;child\u0026#34;) è¿™æ˜¯ match çš„æœ€å¼ºéƒ¨åˆ†ä¹‹ä¸€ã€‚\nğŸŸ¦ 13. match-case ç¦å¿Œï¼ˆå®¹æ˜“è¸©å‘ï¼‰ âŒ ä¸èƒ½å†™è¡¨è¾¾å¼\né”™è¯¯ï¼š\ncase x \u0026gt; 10: æ­£ç¡®ï¼š\ncase x if x \u0026gt; 10: âŒ åŒ¹é…é¡ºåºé‡è¦ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰\nğŸŸ¦ 14. å¿«é€Ÿé€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ï¼‰\nåŠŸèƒ½ å†™æ³• å¤šåˆ†æ”¯ match x: case 1: \u0026hellip; default case _: å¤šæ¨¡å¼ `case â€œaâ€ åˆ—è¡¨è§£æ„ case [a, b]: åˆ—è¡¨å‰©ä½™ case [a, *rest]: dict åŒ¹é… case {\u0026ldquo;a\u0026rdquo;: x}: ç±»åŒ¹é… case Class(attr=x): case å®ˆå« case x if x \u0026gt; 10: åµŒå¥—åŒ¹é… case {\u0026ldquo;u\u0026rdquo;: {\u0026ldquo;name\u0026rdquo;: n}}: ","description":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.python.org/zh-cn/3.12/reference/compound_stmts.html\nğŸŸ¦ 1. åŸºç¡€è¯­æ³• match value: case pattern1: ... case pattern2: ... case _: ... match ç±»ä¼¼ switch case _ ç±»ä¼¼ default ğŸŸ© 2. æœ€ç®€å•ç¤ºä¾‹ match status: case 200: print(\u0026#34;OK\u0026#34;) case 404: print(\u0026#34;Not Found\u0026#34;) case _: print(\u0026#34;Unknown\u0026#34;) ğŸŸ¦ 3. case æ”¯æŒå¤šæ¨¡å¼ | æˆ–åŒ¹é… match ext: case \u0026#34;jpg\u0026#34; | \u0026#34;png\u0026#34; | \u0026#34;gif\u0026#34;: print(\u0026#34;å›¾ç‰‡æ–‡ä»¶\u0026#34;) case \u0026#34;mp4\u0026#34; | \u0026#34;avi\u0026#34;: print(\u0026#34;è§†é¢‘æ–‡ä»¶\u0026#34;) ğŸŸ© 4. case ä¸­ç›´æ¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼ˆå¥½ç”¨ï¼‰ match x: case x if x \u0026gt; 10: print(\u0026#34;\u0026gt; 10\u0026#34;) case x if x == 10: print(\u0026#34;= 10\u0026#34;) case _: print(\u0026#34;\u0026lt; 10\u0026#34;) ğŸŸ¦ 5. åŒ¹é…åºåˆ—ï¼ˆåˆ—è¡¨/å…ƒç»„ï¼‰ å›ºå®šé•¿åº¦\n"},{"id":301,"href":"/database/mongo/","title":"MongoDB","parent":"Database","content":"Document List:\nMongoDB FAQ MongoDB åŸºç¡€æ•™ç¨‹ MongoDB æ ¸å¿ƒæ¦‚å¿µ MongoDB å¤‡ä»½ä¸æ¢å¤ MongoDB æ€§èƒ½ä¼˜åŒ– MongoDB æ•…éšœæ’æŸ¥ MongoDB æœ€ä½³å®è·µ MongoDB ç»å…¸é—®é¢˜ MongoDB é›†ç¾¤ ","description":"Document List:\nMongoDB FAQ MongoDB åŸºç¡€æ•™ç¨‹ MongoDB æ ¸å¿ƒæ¦‚å¿µ MongoDB å¤‡ä»½ä¸æ¢å¤ MongoDB æ€§èƒ½ä¼˜åŒ– MongoDB æ•…éšœæ’æŸ¥ MongoDB æœ€ä½³å®è·µ MongoDB ç»å…¸é—®é¢˜ MongoDB é›†ç¾¤ "},{"id":302,"href":"/database/mongo/backup-restore/","title":"MongoDB å¤‡ä»½ä¸æ¢å¤","parent":"MongoDB","content":"å†…å®¹ï¼šåŸç†ã€å·¥å…·ã€æ–¹æ¡ˆé€‰æ‹©ã€å®æ“å‘½ä»¤ã€å¸¸è§å‘\nMongoDB å¤‡ä»½çš„æ ¸å¿ƒç›®æ ‡\né˜²è¯¯åˆ  / é˜²è¯¯æ“ä½œ é˜²èŠ‚ç‚¹æ•…éšœ / ç£ç›˜æŸå æ”¯æŒæ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ ä¸å½±å“çº¿ä¸Šä¸šåŠ¡ ä¸€ã€MongoDB å¤‡ä»½æ–¹å¼æ€»è§ˆï¼ˆé‡ç‚¹ï¼‰ æ–¹å¼ æ˜¯å¦ä¸€è‡´ æ˜¯å¦æ”¯æŒ PITR å½±å“æ€§èƒ½ é€‚ç”¨åœºæ™¯ mongodump é€»è¾‘ä¸€è‡´ âŒ ä¸­ å°æ•°æ®é‡ æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ å¼ºä¸€è‡´ âš ï¸ ä½ ç”Ÿäº§ä¸»æµ Oplog å¢é‡ âœ… æä½ æ—¶é—´ç‚¹æ¢å¤ äº‘å‚å•†å¤‡ä»½ å¼ºä¸€è‡´ âœ… æä½ äº‘ç¯å¢ƒ MongoDB Atlas å¼ºä¸€è‡´ âœ… æä½ æ‰˜ç®¡ ğŸ‘‰ ç”Ÿäº§æ¨èï¼šå¿«ç…§ + Oplog\näºŒã€mongodump / mongorestoreï¼ˆæœ€å¸¸ç”¨ï¼‰ 1ï¸âƒ£ mongodumpï¼ˆé€»è¾‘å¤‡ä»½ï¼‰ ç¤ºä¾‹\nmongodump \\ --host 127.0.0.1 \\ --port 27017 \\ --db mydb \\ --out /backup/mongo ç‰¹ç‚¹\nâœ… ç®€å• âŒ æ•°æ®é‡å¤§æ—¶æ…¢ âŒ å¤‡ä»½æœŸé—´æ•°æ®å¯èƒ½å˜åŒ–ï¼ˆéå¼ºä¸€è‡´ï¼‰ 2ï¸âƒ£ mongorestoreï¼ˆæ¢å¤ï¼‰ mongorestore \\ --db mydb \\ /backup/mongo/mydb å¸¸ç”¨å‚æ•°ï¼š\n--drop # å…ˆåˆ é™¤é›†åˆ --nsInclude # æŒ‡å®š namespace --gzip # é…åˆå‹ç¼© âš ï¸ mongodump çš„å‘\næ•°æ® \u0026gt; 100GB ä¸æ¨è å¯¹åˆ†ç‰‡é›†ç¾¤ åªå¤‡ä»½ config / å• shard ä¸å®Œæ•´ ä¸æ”¯æŒæ—¶é—´ç‚¹æ¢å¤ ä¸‰ã€Oplog å¤‡ä»½ï¼ˆPITR æ ¸å¿ƒï¼‰ 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ Oplog MongoDB å¤åˆ¶é›†çš„ æ“ä½œæ—¥å¿— è®°å½•æ¯ä¸€æ¬¡å†™æ“ä½œ ğŸ“Œ åªå­˜åœ¨äº Replica Set\n2ï¸âƒ£ å¤‡ä»½ Oplog mongodump \\ --db local \\ --collection oplog.rs \\ --out /backup/oplog 3ï¸âƒ£ ä½¿ç”¨ Oplog æ¢å¤åˆ°æŸä¸€æ—¶é—´ç‚¹ mongorestore \\ --oplogReplay \\ /backup ğŸ‘‰ å®ç°ï¼š\nå…¨é‡å¤‡ä»½ + Oplog å›æ”¾ = æ—¶é—´ç‚¹æ¢å¤\nå››ã€æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼ˆç”Ÿäº§é¦–é€‰ï¼‰ 1ï¸âƒ£ åŸç† ä½¿ç”¨ LVM / äº‘ç£ç›˜å¿«ç…§ å¤‡ä»½ WiredTiger æ•°æ®æ–‡ä»¶ 2ï¸âƒ£ æ ‡å‡†æµç¨‹ï¼ˆéå¸¸é‡è¦ï¼‰ fsyncLockï¼ˆé”å†™ï¼‰ åšç£ç›˜å¿«ç…§ fsyncUnlock ç¤ºä¾‹\ndb.fsyncLock() # åšå¿«ç…§ db.fsyncUnlock() 3ï¸âƒ£ ä¼˜ç‚¹ âœ… å¼ºä¸€è‡´ âœ… æå¿« âœ… å¯¹ä¸šåŠ¡å½±å“å° 4ï¸âƒ£ æ³¨æ„ å¿…é¡»æ˜¯ å‰¯æœ¬é›†èŠ‚ç‚¹ æ¨èåœ¨ secondary ä¸Šåš äº”ã€åˆ†ç‰‡é›†ç¾¤å¤‡ä»½ âŒ é”™è¯¯åšæ³•\nåªå¤‡ä»½æŸä¸€ä¸ª shard âœ… æ­£ç¡®åšæ³•\néœ€è¦å¤‡ä»½ï¼š\næ‰€æœ‰ shard config server æ¨èæ–¹æ¡ˆ\nåœæ­¢ balancer æ‰€æœ‰èŠ‚ç‚¹åŒä¸€æ—¶é—´ç‚¹å¿«ç…§ sh.stopBalancer() # å¤‡ä»½ sh.startBalancer() å…­ã€MongoDB æ¢å¤åœºæ™¯åˆ†ç±» 1ï¸âƒ£ å•åº“ / å•é›†åˆè¯¯åˆ  mongorestore --nsInclude mydb.users 2ï¸âƒ£ æ•´åº“æ¢å¤ mongorestore --drop /backup/mongo 3ï¸âƒ£ æ¢å¤åˆ°æŸä¸ªæ—¶é—´ç‚¹ï¼ˆPITRï¼‰ å…¨é‡å¤‡ä»½ -\u0026gt; å›æ”¾ oplog åˆ°æŒ‡å®šæ—¶é—´\n4ï¸âƒ£ æ–°é›†ç¾¤è¿ç§»æ¢å¤ å…³é—­åŸé›†ç¾¤å†™å…¥ å…¨é‡å¤‡ä»½ æ–°é›†ç¾¤ restore åˆ‡æµé‡ ä¸ƒã€è‡ªåŠ¨åŒ–å¤‡ä»½æœ€ä½³å®è·µï¼ˆå¼ºçƒˆæ¨èï¼‰ 1ï¸âƒ£ å¤‡ä»½ç­–ç•¥ æ¯æ—¥å…¨é‡ Oplog æ¯ 5~10 åˆ†é’Ÿ ä¿ç•™ 7~30 å¤© 2ï¸âƒ£ å¤‡ä»½ä½ç½® æœ¬æœº âŒ è¿œç¨‹å­˜å‚¨ âœ… å¯¹è±¡å­˜å‚¨ï¼ˆS3 / OSSï¼‰âœ… 3ï¸âƒ£ æ ¡éªŒæœºåˆ¶ å®šæœŸ restore åˆ°æµ‹è¯•åº“ æ ¡éªŒå¤‡ä»½å®Œæ•´æ€§ å…«ã€å¸¸è§æ•…éšœ \u0026amp; å‘ âŒ åªå¤‡ä»½ primary\nğŸ‘‰ primary æŒ‚äº†ï¼Œå¤‡ä»½ä¸å¯ç”¨\nâŒ å¿˜è®° oplog\nğŸ‘‰ åªèƒ½æ¢å¤åˆ°å¤‡ä»½æ—¶é—´ç‚¹\nâŒ dump åˆ†ç‰‡é›†ç¾¤ä¸å®Œæ•´\nğŸ‘‰ æ•°æ®ç¼ºå¤±\nâŒ å¤‡ä»½åœ¨ä¸šåŠ¡é«˜å³°\nğŸ‘‰ ä¸»ä»å»¶è¿Ÿã€ä¸šåŠ¡æŠ–åŠ¨\nä¹ã€æ€»ç»“ MongoDB çš„ç”Ÿäº§çº§å¤‡ä»½æ–¹æ¡ˆæ˜¯ï¼š\nå‰¯æœ¬é›† + Secondary èŠ‚ç‚¹ + ç£ç›˜å¿«ç…§ + Oplog å¢é‡å›æ”¾ï¼Œmongodump åªé€‚åˆå°è§„æ¨¡æˆ–åº”æ€¥å¤‡ä»½ã€‚\n","description":"å†…å®¹ï¼šåŸç†ã€å·¥å…·ã€æ–¹æ¡ˆé€‰æ‹©ã€å®æ“å‘½ä»¤ã€å¸¸è§å‘\nMongoDB å¤‡ä»½çš„æ ¸å¿ƒç›®æ ‡\né˜²è¯¯åˆ  / é˜²è¯¯æ“ä½œ é˜²èŠ‚ç‚¹æ•…éšœ / ç£ç›˜æŸå æ”¯æŒæ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ ä¸å½±å“çº¿ä¸Šä¸šåŠ¡ ä¸€ã€MongoDB å¤‡ä»½æ–¹å¼æ€»è§ˆï¼ˆé‡ç‚¹ï¼‰ æ–¹å¼ æ˜¯å¦ä¸€è‡´ æ˜¯å¦æ”¯æŒ PITR å½±å“æ€§èƒ½ é€‚ç”¨åœºæ™¯ mongodump é€»è¾‘ä¸€è‡´ âŒ ä¸­ å°æ•°æ®é‡ æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ å¼ºä¸€è‡´ âš ï¸ ä½ ç”Ÿäº§ä¸»æµ Oplog å¢é‡ âœ… æä½ æ—¶é—´ç‚¹æ¢å¤ äº‘å‚å•†å¤‡ä»½ å¼ºä¸€è‡´ âœ… æä½ äº‘ç¯å¢ƒ MongoDB Atlas å¼ºä¸€è‡´ âœ… æä½ æ‰˜ç®¡ ğŸ‘‰ ç”Ÿäº§æ¨èï¼šå¿«ç…§ + Oplog\näºŒã€mongodump / mongorestoreï¼ˆæœ€å¸¸ç”¨ï¼‰ 1ï¸âƒ£ mongodumpï¼ˆé€»è¾‘å¤‡ä»½ï¼‰ ç¤ºä¾‹\n"},{"id":303,"href":"/database/mongo/performance/","title":"MongoDB æ€§èƒ½ä¼˜åŒ–","parent":"MongoDB","content":"å†…å®¹åˆ†ä¸ºï¼š\næ¶æ„è®¾è®¡æœ€ä½³å®è·µ æ•°æ®æ¨¡å‹ \u0026amp; Schema è®¾è®¡ ç´¢å¼•è®¾è®¡ æ€§èƒ½ä¼˜åŒ– è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ å®‰å…¨æœ€ä½³å®è·µ ç›‘æ§æœ€ä½³å®è·µ å¼€å‘ç¼–ç æœ€ä½³å®è·µ å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰ ğŸ”¥ ä¸€ã€æ¶æ„è®¾è®¡æœ€ä½³å®è·µ 1. ä¼˜å…ˆä½¿ç”¨å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ è‡³å°‘ï¼š\nprimary + secondary + arbiterï¼ˆæˆ–ç¬¬äºŒä¸ª secondaryï¼‰ ç›®çš„ï¼š\né«˜å¯ç”¨ è‡ªåŠ¨é€‰ä¸¾ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ ğŸ’¡ ä¸è¦å•èŠ‚ç‚¹éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒï¼\n2. æ•°æ®é‡å¤§æ—¶ä½¿ç”¨åˆ†ç‰‡ï¼ˆShardingï¼‰ é€‚ç”¨äºï¼š\nå• collection \u0026gt; 500GB å•èŠ‚ç‚¹å†™å…¥å‹åŠ›å¾ˆå¤§ éœ€è¦æ°´å¹³æ‰©å®¹ åˆ†ç‰‡é”®åŸåˆ™ï¼š\nåˆ†æ•£å†™å…¥ ä¸è¦å•è°ƒé€’å¢ï¼ˆ_id è‡ªåŠ¨ç”Ÿæˆçš„ ObjectId å¾ˆå•è°ƒï¼‰ æ¨èåˆ†ç‰‡é”®ï¼š\nhashed(_id) hashed(user_id) 3. ä½¿ç”¨ WiredTiger å¼•æ“ MongoDB é»˜è®¤ä½¿ç”¨ WiredTigerï¼Œæ”¯æŒï¼š\nå‹ç¼© æ–‡æ¡£çº§é” æ›´é«˜æ€§èƒ½ ä¸è¦å†ä½¿ç”¨ MMAPv1ï¼ˆå·²åºŸå¼ƒï¼‰ã€‚\nğŸ”¥ äºŒã€æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ 1. æ–‡æ¡£å¤§å°æ§åˆ¶ \u0026lt; 16MB è¶…è¿‡ä¼šæŠ¥é”™ï¼š\nBSONObj size: xxx is invalid æ¨èæœ€å¤§ 1~2MBã€‚\n2. åµŒå¥—æ–‡æ¡£ï¼ˆEmbedï¼‰ vs å¼•ç”¨ï¼ˆReferenceï¼‰ ä»€ä¹ˆæ—¶å€™ç”¨åµŒå¥—ï¼ˆEmbedï¼‰ é€‚åˆï¼š\næ•°æ®ä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å°‘ æ•°æ®ç»å¸¸ä¸€èµ·è¯»å– ä¾‹å¦‚è®¢å• -\u0026gt; å•†å“åˆ—è¡¨ ä»€ä¹ˆæ—¶å€™ç”¨å¼•ç”¨ï¼ˆReferenceï¼‰ é€‚åˆï¼š\nä¸€å¯¹å¤šï¼ˆéå¸¸å¤šï¼‰ å¤§é‡æ›´æ–° ä¸ç»å¸¸ä¸€èµ·è¯»å– 3. å­—æ®µå‘½åä¸è¦ä½¿ç”¨å¤§å†™ æ¨èï¼š\nsnake_caseï¼ˆæ¨èï¼‰ camelCaseï¼ˆä¹Ÿå¯ä»¥ï¼‰ âš ï¸ ä¸è¦ä½¿ç”¨ä¸­æ–‡å­—æ®µåã€‚\n4. é¿å…æ·±åº¦åµŒå¥—æ–‡æ¡£ æ·±åº¦ \u0026gt; 5 å±‚ ä¼šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½å˜å·®ã€‚\nğŸ”¥ ä¸‰ã€ç´¢å¼•æœ€ä½³å®è·µ 1. å¿…é¡»åˆ›å»ºç´¢å¼•çš„æƒ…å†µ where æŸ¥è¯¢å­—æ®µ sort æ’åºå­—æ®µ join å­—æ®µï¼ˆ$lookupï¼‰ å”¯ä¸€å­—æ®µï¼ˆuniqueï¼‰ 2. ç´¢å¼•è¦â€œå·¦å‰ç¼€â€ä½¿ç”¨ å¦‚å¤åˆç´¢å¼•ï¼š\n{ a: 1, b: 1, c: 1 } æœ‰æ•ˆç´¢å¼•å­—æ®µæ˜¯ï¼š\na a, b a, b, c ä¸èƒ½ç›´æ¥ç”¨ b, cã€‚\n3. é¿å…è¿‡å¤šç´¢å¼• æ¯ä¸ª index éƒ½ä¼šï¼š\nå ç”¨å†…å­˜ é™ä½å†™å…¥æ€§èƒ½ 4. å®šæœŸæ£€æŸ¥ COLLSCANï¼ˆå…¨è¡¨æ‰«æï¼‰ db.collection.find({...}).explain(\u0026#34;executionStats\u0026#34;) å‡ºç° COLLSCAN å¿…é¡»åŠ ç´¢å¼•ã€‚\nğŸ”¥ å››ã€æ€§èƒ½æœ€ä½³å®è·µ 1. æ°¸è¿œä¸è¦åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æ­£åˆ™å‰ç¼€æ¨¡ç³Š âŒ é”™è¯¯ï¼š\ndb.users.find({ name: /abc/ }) âœ… æ­£ç¡®ï¼š\ndb.users.find({ name: /^abc/ }) 2. é¿å…å¤§ $in æŸ¥è¯¢ âŒï¼š\nid in [1,2,3,4...50000] ä¼šå¯¼è‡´ huge COLLSCANã€‚\n3. åˆ†é¡µä½¿ç”¨ _id + limitï¼ˆæ›´å¿«ï¼‰ æ¯” skip å¿«æ•°åå€ã€‚\n4. èšåˆå¤§é‡æ•°æ®æ—¶ä½¿ç”¨ allowDiskUse db.collection.aggregate([...], { allowDiskUse: true }) 5. ä½¿ç”¨æŠ•å½±å‡å°‘è¿”å›å­—æ®µ åªè¦éœ€è¦å­—æ®µï¼š\n{ name: 1, age: 1 } ğŸ”¥ äº”ã€è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ 1. RAID10 + SSD æ˜¯æ ‡é… ç†ç”±ï¼š\nWiredTiger éœ€è¦å¤§é‡éšæœº I/O SSD æ˜¾è‘—æå‡å†™å…¥æ€§èƒ½ 2. ç¦æ­¢ swapï¼ˆæ€§èƒ½ç¾éš¾ï¼‰ è®¾ç½®ï¼š\nvm.swappiness=1 3. Oplog ä¿æŒè‡³å°‘ 24 å°æ—¶ æŸ¥çœ‹ï¼š\nrs.printReplicationInfo() 4. æ•°ç™¾ä¸‡çº§ collection åº”åˆ†åº“åˆ†é›†åˆ é¿å…ï¼š\nå¤ªå¤šå°é›†åˆ æ¯ä¸ªéƒ½æœ‰ç´¢å¼• -\u0026gt; å†…å­˜çˆ†ç‚¸ ğŸ”¥ å…­ã€å®‰å…¨æœ€ä½³å®è·µ 1. å¼€å¯è®¤è¯ security: authorization: enabled 2. ä¸è¦ä½¿ç”¨ admin åº“ä½œä¸ºä¸šåŠ¡åº“ é¿å…ç”¨æˆ·æƒé™è¿‡é«˜ã€‚\n3. ä½¿ç”¨è§’è‰²æƒé™ åˆ›å»ºæœ€å°æƒé™ç”¨æˆ·ï¼š\ndb.createUser({ user: \u0026#34;app\u0026#34;, pwd: \u0026#34;xxx\u0026#34;, roles: [{ role: \u0026#34;readWrite\u0026#34;, db: \u0026#34;mydb\u0026#34; }] }) 4. ä½¿ç”¨ TLS/SSL å¼€å¯è¯ä¹¦åŠ å¯†ä¼ è¾“ã€‚\nğŸ”¥ ä¸ƒã€ç›‘æ§æœ€ä½³å®è·µ å¿…ç›‘æ§æŒ‡æ ‡ï¼š\nWiredTigerï¼š\ncache usage eviction dirty bytes Replicationï¼š\nreplication lagï¼ˆå¿…é¡» \u0026lt; 10 ç§’ï¼‰ oplog time window Performanceï¼š\nopcounters slow queries queue length I/O è¯»å†™ æ¨èä½¿ç”¨ï¼š\nPrometheus + Grafana Percona Monitoring (PMM) ğŸ”¥ å…«ã€å¼€å‘ç¼–ç æœ€ä½³å®è·µ 1. ä¸è¦åœ¨ä»£ç ä¸­åˆ›å»ºå¤ªå¤šè¿æ¥ âœ… ä½¿ç”¨è¿æ¥æ± ï¼ˆpoolï¼‰\n2. å†™æ“ä½œè¦ idempotentï¼ˆå¹‚ç­‰ï¼‰ ä¾‹å¦‚ï¼š\nupdateOne(upsert=True) 3. é¿å…å•æ–‡æ¡£å¤§å­—æ®µæ›´æ–° ä¼šè§¦å‘ï¼š\ndocument move rewrite entire doc æˆæœ¬é«˜ï¼\n4. ä½¿ç”¨ bulkWrite æ‰¹é‡å†™å…¥ æ‰¹é‡æ€§èƒ½æ¯”å¾ªç¯ insert å¿« 10x+ã€‚\nğŸ”¥ ä¹ã€å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰\nâŒ å¤§é‡ä½¿ç”¨ $whereï¼ˆJS æ‰§è¡Œï¼Œææ…¢ï¼‰ âŒ ä½¿ç”¨ skip è¿›è¡Œæ·±åº¦åˆ†é¡µï¼ˆæ€§èƒ½å™©æ¢¦ï¼‰ âŒ åœ¨å­—æ®µä¸Šä½¿ç”¨æ­£åˆ™å‰ç½®é€šé…ç¬¦ .*abc âŒ æ–‡æ¡£æ— é™æ·±åº¦åµŒå¥— âŒ åŒä¸€é›†åˆåˆ›å»ºå‡ åä¸ªç´¢å¼• âŒ åƒåœ¾åˆ†ç‰‡é”®å¯¼è‡´çƒ­ç‚¹é—®é¢˜ âŒ å¤šå­—æ®µå¸¸æ”¹ -\u0026gt; åµŒå¥—å¤ªæ·±é€ æˆæ•´æ–‡æ¡£é‡å†™ ","description":"å†…å®¹åˆ†ä¸ºï¼š\næ¶æ„è®¾è®¡æœ€ä½³å®è·µ æ•°æ®æ¨¡å‹ \u0026amp; Schema è®¾è®¡ ç´¢å¼•è®¾è®¡ æ€§èƒ½ä¼˜åŒ– è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ å®‰å…¨æœ€ä½³å®è·µ ç›‘æ§æœ€ä½³å®è·µ å¼€å‘ç¼–ç æœ€ä½³å®è·µ å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰ ğŸ”¥ ä¸€ã€æ¶æ„è®¾è®¡æœ€ä½³å®è·µ 1. ä¼˜å…ˆä½¿ç”¨å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ è‡³å°‘ï¼š\nprimary + secondary + arbiterï¼ˆæˆ–ç¬¬äºŒä¸ª secondaryï¼‰ ç›®çš„ï¼š\né«˜å¯ç”¨ è‡ªåŠ¨é€‰ä¸¾ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ ğŸ’¡ ä¸è¦å•èŠ‚ç‚¹éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒï¼\n2. æ•°æ®é‡å¤§æ—¶ä½¿ç”¨åˆ†ç‰‡ï¼ˆShardingï¼‰ é€‚ç”¨äºï¼š\n"},{"id":304,"href":"/database/mongo/troubleshooting/","title":"MongoDB æ•…éšœæ’æŸ¥","parent":"MongoDB","content":"MongoDB æ•…éšœæ’æŸ¥ï¼šè¿æ¥ã€æ€§èƒ½ã€å¤åˆ¶é›†ã€åˆ†ç‰‡ã€é”ã€ç£ç›˜ã€OOM åˆ°æ…¢æŸ¥è¯¢ç­‰å…¨é‡æ’æŸ¥æµç¨‹\nä¸€ã€è¿æ¥é—®é¢˜æ’æŸ¥ï¼ˆæ— æ³•è¿æ¥ã€è¶…æ—¶ã€æ‹’ç»ï¼‰ âœ… 1. æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ systemctl status mongod ps aux | grep mongod âœ… 2. æ£€æŸ¥ç«¯å£ç›‘å¬ netstat -tunlp | grep 27017 ss -lntp | grep 27017 âœ… 3. æ£€æŸ¥é˜²ç«å¢™ \u0026amp; å®‰å…¨ç»„ firewall-cmd --list-all iptables -L -n âœ… 4. æ£€æŸ¥ bindIpï¼ˆå¸¸è§å‘ï¼‰ /etc/mongod.confï¼š\nnet: bindIp: 0.0.0.0 å¦‚æœä¸æ”¹ï¼Œå¤–éƒ¨æ°¸è¿œæ— æ³•è¿æ¥ã€‚\näºŒã€æƒé™é—®é¢˜æ’æŸ¥ï¼ˆè®¤è¯å¤±è´¥ã€Unauthorizedï¼‰ âœ… 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ use admin db.system.users.find().pretty() âœ… 2. æ£€æŸ¥è§’è‰²æƒé™ MongoDB ç”¨æˆ·æƒé™åŸºäº æ•°æ®åº“ + Roleï¼Œå¸¸è§è¯¯åŒºæ˜¯ï¼š\nä½ åœ¨ app åº“åˆ›å»ºç”¨æˆ·ï¼Œå´æƒ³åœ¨ admin ç™»å½•ã€‚\nå¸¸ç”¨æƒé™ï¼š\ndb.grantRolesToUser(\u0026#34;root\u0026#34;, [ { role: \u0026#34;root\u0026#34;, db: \u0026#34;admin\u0026#34; } ]) ä¸‰ã€æ…¢æŸ¥è¯¢ / æ€§èƒ½é—®é¢˜æ’æŸ¥ ğŸ” 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿— é»˜è®¤æ—¥å¿—æ–‡ä»¶ï¼š\n/var/log/mongodb/mongod.log\næŸ¥æ…¢æŸ¥è¯¢ï¼š\ngrep \u0026#34;COLLSCAN\u0026#34; mongod.log grep \u0026#34;stepdown\u0026#34; mongod.log grep \u0026#34;command:\u0026#34; mongod.log ğŸ” 2. æŸ¥çœ‹æ˜¯å¦å…¨è¡¨æ‰«æï¼ˆCOLLSCANï¼‰ db.collection.find({}).explain(\u0026#34;executionStats\u0026#34;) é‡ç‚¹å…³æ³¨ï¼š\nCOLLSCANï¼šæ— ç´¢å¼• nReturned vs totalDocsExamined å·®è·è¶Šå¤§è¶Šæ…¢ ğŸ” 3. æŸ¥çœ‹å½“å‰æ“ä½œ db.currentOp() ğŸ” 4. æŸ¥çœ‹é”æƒ…å†µ é«˜é”ä¼šå¯¼è‡´å¡é¡¿ã€‚\ndb.serverStatus().locks é‡ç‚¹å…³æ³¨ï¼š\nglobalLock wiredTiger.LSM acquireCount.write å››ã€ç£ç›˜ I/Oã€WiredTiger é—®é¢˜æ’æŸ¥ ğŸ”¥ 1. ç£ç›˜ 100%ï¼ˆå¸¸è§åŸå› ï¼‰ checkpoint å†™å…¥æ…¢ journal å†™å…¥é˜»å¡ æ•°æ®æ–‡ä»¶å¤ªå¤§ æŸ¥çœ‹ I/Oï¼š\niostat -x 1 10 MongoDB å†…éƒ¨ï¼š\ndb.serverStatus().wiredTiger å…³é”®å­—æ®µï¼š\ncache_overflowï¼šå†…å­˜ä¸å¤Ÿ -\u0026gt; OOM é£é™© block-managerï¼šI/O é˜»å¡ ğŸ”¥ 2. WiredTiger Cache å¤Ÿä¸å¤Ÿï¼Ÿ é»˜è®¤ Cache = å†…å­˜ 50%\næŸ¥çœ‹ï¼š\ndb.serverStatus().wiredTiger.cache å…³é”®å­—æ®µï¼š\nbytes currently in cache maximum bytes configurable å¦‚æœ cache hit ratio \u0026lt; 98% -\u0026gt; ç´¢å¼•ä¸è¶³æˆ–ç¼“å­˜å¤ªå°ã€‚\näº”ã€å†…å­˜åé«˜ / OOM æ’æŸ¥ æŸ¥çœ‹å½“å‰ä½¿ç”¨æƒ…å†µï¼š\nfree -h top ps aux | grep mongod WiredTiger æ­£å¸¸ä¼šåƒå¤§é‡å†…å­˜ï¼Œè¿™æ˜¯ é¢„æœŸè¡Œä¸ºã€‚\nçœŸæ­£çš„ OOM ç–‘ç‚¹ï¼š\nOOM-killer è®°å½• /var/log/messages WiredTiger cache è¢«æ‰“æ»¡ è§£å†³ï¼š\nå¢å¤§å†…å­˜ é€‚å½“åŠ ç´¢å¼•å‡å°‘æ‰«æ è°ƒæ•´ queryï¼Œé¿å… load å…¨è¡¨ å…­ã€å¤åˆ¶é›†æ•…éšœæ’æŸ¥ï¼ˆPRIMARY/FATAL/SECONDARY/RECOVERINGï¼‰ â— å…¸å‹é—®é¢˜ 1ï¼šPrimary ä¸é€‰ä¸¾ æŸ¥çœ‹çŠ¶æ€ï¼š\nrs.status() å¸¸è§åŸå› ï¼š\nç½‘ç»œä¸é€š ä»²è£èŠ‚ç‚¹å¼‚å¸¸ oplog å¤ªå°å¯¼è‡´è½å â— å…¸å‹é—®é¢˜ 2ï¼šæˆå‘˜çŠ¶æ€ RECOVERING å¸¸è§åŸå› ï¼š\nOplog åŒæ­¥è¿½ä¸ä¸Š æ•°æ®æŸå æŸ¥çœ‹ Oplogï¼š\nrs.printReplicationInfo() å…³é”®å­—æ®µï¼š\noplogSizeMB timeDiffï¼ˆç”¨å¤šä¹…çš„ oplogï¼‰ â— å…¸å‹é—®é¢˜ 3ï¼šSECONDARY è½åå¤ªå¤š rs.printSlaveReplicationInfo() å¦‚æœå»¶è¿Ÿ \u0026gt; 10 åˆ†é’Ÿï¼ŒåŸºæœ¬æ— æ³•è¿½ä¸Šã€‚\nè§£å†³ï¼š\né‡å»ºèŠ‚ç‚¹ï¼ˆæœ€å¿«ï¼‰ æˆ–å¢å¤§ oplog ä¸ƒã€åˆ†ç‰‡é›†ç¾¤é—®é¢˜æ’æŸ¥ï¼ˆShardingï¼‰ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š\nsh.status() å¸¸è§é—®é¢˜ï¼š\nğŸŸ¥ é—®é¢˜ 1ï¼šChunk imbalanceï¼ˆæ•°æ®ä¸å‡è¡¡ï¼‰ åŸå› ï¼š\nåˆ†ç‰‡é”®è®¾è®¡ä¸åˆç†ï¼ˆå¸¸è§ï¼‰ å•è°ƒé€’å¢ _id è§£å†³ï¼š\nä½¿ç”¨ hashed shard key å¢åŠ  balancer è¿è¡Œæ—¶é—´ ğŸŸ¥ é—®é¢˜ 2ï¼šChunk migration å¡ä½ åŸå› ï¼š\nTarget shard ç©ºé—´ä¸è¶³ ç½‘ç»œè¾ƒæ…¢ å¤§æ–‡æ¡£ï¼ˆ\u0026gt; 16MBï¼‰ æŸ¥çœ‹è¿ç§»æ—¥å¿—ï¼š\ndb.adminCommand({ getShardMap: 1 }) å…«ã€æ•°æ®åº“æ–‡ä»¶æŸå / å´©æºƒæ’æŸ¥ æŸ¥çœ‹æ—¥å¿—ï¼š\ngrep -i \u0026#34;WT\u0026#34; /var/log/mongodb/mongod.log grep -i \u0026#34;corrupt\u0026#34; mongod.log å…¸å‹æŠ¥é”™ï¼š\nWiredTiger error -31804 data file corrupted æ¢å¤æ–¹æ³•ï¼ˆå¸¸ç”¨ï¼‰ï¼š\nåœæ­¢ MongoDB \u0026ndash;repair é‡å¯ å¦‚æœä¸è¡Œ -\u0026gt; ä»å¤åˆ¶é›†å…¶ä»–èŠ‚ç‚¹åŒæ­¥ ä¹ã€å¸¸è§é”™è¯¯ç è§£æ é”™è¯¯ç  å«ä¹‰ 8000 å†…éƒ¨é”™è¯¯ 11600 Interrupted queryï¼ˆè¢« kill æˆ–è¶…æ—¶ï¼‰ 50 è¶…æ—¶ï¼ˆå¸¸è§ï¼‰ 100 æœªæ‰¾åˆ°æ•°æ® 11000 å”¯ä¸€ç´¢å¼•å†²çª 13435 ä¸»èŠ‚ç‚¹é™çº§ åã€å®Œæ•´æ•…éšœæ’æŸ¥æµç¨‹ èƒ½å¦è¿æ¥ï¼Ÿ æ—¥å¿—æ˜¯å¦æœ‰æŠ¥é”™ï¼Ÿ é”æƒ…å†µæ­£å¸¸å—ï¼Ÿ æ˜¯å¦å‘ç”Ÿ COLLSCANï¼Ÿ WiredTiger cache æ˜¯å¦å‹åŠ›è¿‡å¤§ï¼Ÿ ç£ç›˜ I/O æ˜¯å¦ 100%ï¼Ÿ å½“å‰æ“ä½œæ˜¯å¦å¡ä½ï¼Ÿ å¤åˆ¶é›†çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Ÿ åˆ†ç‰‡æ˜¯å¦å‡è¡¡ï¼Ÿ Oplog æ˜¯å¦è¶³å¤Ÿå¤§ï¼Ÿ ","description":"MongoDB æ•…éšœæ’æŸ¥ï¼šè¿æ¥ã€æ€§èƒ½ã€å¤åˆ¶é›†ã€åˆ†ç‰‡ã€é”ã€ç£ç›˜ã€OOM åˆ°æ…¢æŸ¥è¯¢ç­‰å…¨é‡æ’æŸ¥æµç¨‹\nä¸€ã€è¿æ¥é—®é¢˜æ’æŸ¥ï¼ˆæ— æ³•è¿æ¥ã€è¶…æ—¶ã€æ‹’ç»ï¼‰ âœ… 1. æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ systemctl status mongod ps aux | grep mongod âœ… 2. æ£€æŸ¥ç«¯å£ç›‘å¬ netstat -tunlp | grep 27017 ss -lntp | grep 27017 âœ… 3. æ£€æŸ¥é˜²ç«å¢™ \u0026amp; å®‰å…¨ç»„ firewall-cmd --list-all iptables -L -n âœ… 4. æ£€æŸ¥ bindIpï¼ˆå¸¸è§å‘ï¼‰ /etc/mongod.confï¼š\n"},{"id":305,"href":"/database/mongo/best-practices/","title":"MongoDB æœ€ä½³å®è·µ","parent":"MongoDB","content":"MongoDB æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§è¿ç»´ + å¼€å‘ + æ€§èƒ½ä¼˜åŒ–ï¼‰å®Œæ•´æŒ‡å—ï¼Œç›´æ¥å¯ç”¨äºæ¶æ„è®¾è®¡ã€å¼€å‘è§„èŒƒã€æ•°æ®åº“è§„åˆ’ä¸è°ƒä¼˜ã€‚\nå†…å®¹ï¼š\næ¶æ„è®¾è®¡æœ€ä½³å®è·µ æ•°æ®æ¨¡å‹ \u0026amp; Schema è®¾è®¡ ç´¢å¼•è®¾è®¡ æ€§èƒ½ä¼˜åŒ– è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ å®‰å…¨æœ€ä½³å®è·µ ç›‘æ§æœ€ä½³å®è·µ å¼€å‘ç¼–ç æœ€ä½³å®è·µ å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰ ğŸ”¥ ä¸€ã€æ¶æ„è®¾è®¡æœ€ä½³å®è·µ 1. ä¼˜å…ˆä½¿ç”¨å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ è‡³å°‘ï¼š\nprimary + secondary + arbiterï¼ˆæˆ–ç¬¬äºŒä¸ª secondaryï¼‰\nç›®çš„ï¼š\né«˜å¯ç”¨ è‡ªåŠ¨é€‰ä¸¾ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ ğŸ’¡ ä¸è¦å•èŠ‚ç‚¹éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒï¼\n2. æ•°æ®é‡å¤§æ—¶ä½¿ç”¨åˆ†ç‰‡ï¼ˆShardingï¼‰ é€‚ç”¨äºï¼š\nå• collection \u0026gt; 500GB å•èŠ‚ç‚¹å†™å…¥å‹åŠ›å¾ˆå¤§ éœ€è¦æ°´å¹³æ‰©å®¹ åˆ†ç‰‡é”®åŸåˆ™ï¼š\nåˆ†æ•£å†™å…¥ ä¸è¦å•è°ƒé€’å¢ï¼ˆ_id è‡ªåŠ¨ç”Ÿæˆçš„ ObjectId å¾ˆå•è°ƒï¼‰ æ¨èåˆ†ç‰‡é”®ï¼š\nhashed(_id) hashed(user_id) 3. ä½¿ç”¨ WiredTiger å¼•æ“ MongoDB é»˜è®¤ä½¿ç”¨ WiredTigerï¼Œæ”¯æŒï¼š\nå‹ç¼© æ–‡æ¡£çº§é” æ›´é«˜æ€§èƒ½ ä¸è¦å†ä½¿ç”¨ MMAPv1ï¼ˆå·²åºŸå¼ƒï¼‰ã€‚\nğŸ”¥ äºŒã€æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ 1. æ–‡æ¡£å¤§å°æ§åˆ¶ \u0026lt; 16MB è¶…è¿‡ä¼šæŠ¥é”™ï¼š\nBSONObj size: xxx is invalid æ¨èæœ€å¤§ 1~2MBã€‚\n2. åµŒå¥—æ–‡æ¡£ï¼ˆEmbedï¼‰ vs å¼•ç”¨ï¼ˆReferenceï¼‰ âœ… ä»€ä¹ˆæ—¶å€™ç”¨åµŒå¥—ï¼ˆEmbedï¼‰\né€‚åˆï¼š\næ•°æ®ä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å°‘ æ•°æ®ç»å¸¸ä¸€èµ·è¯»å– ä¾‹å¦‚è®¢å• -\u0026gt; å•†å“åˆ—è¡¨ âœ… ä»€ä¹ˆæ—¶å€™ç”¨å¼•ç”¨ï¼ˆReferenceï¼‰\né€‚åˆï¼š\nä¸€å¯¹å¤šï¼ˆéå¸¸å¤šï¼‰ å¤§é‡æ›´æ–° ä¸ç»å¸¸ä¸€èµ·è¯»å– 3. å­—æ®µå‘½åä¸è¦ä½¿ç”¨å¤§å†™ æ¨èï¼š\nsnake_caseï¼ˆæ¨èï¼‰ camelCaseï¼ˆä¹Ÿå¯ä»¥ï¼‰ âš ï¸ ä¸è¦ä½¿ç”¨ä¸­æ–‡å­—æ®µåã€‚\n4. é¿å…æ·±åº¦åµŒå¥—æ–‡æ¡£ æ·±åº¦ \u0026gt; 5 å±‚ ä¼šå¯¼è‡´æŸ¥è¯¢æ€§èƒ½å˜å·®ã€‚\nğŸ”¥ ä¸‰ã€ç´¢å¼•æœ€ä½³å®è·µ 1. å¿…é¡»åˆ›å»ºç´¢å¼•çš„æƒ…å†µ where æŸ¥è¯¢å­—æ®µ sort æ’åºå­—æ®µ join å­—æ®µï¼ˆ$lookupï¼‰ å”¯ä¸€å­—æ®µï¼ˆuniqueï¼‰ 2. ç´¢å¼•è¦â€œå·¦å‰ç¼€â€ä½¿ç”¨ å¦‚å¤åˆç´¢å¼•ï¼š\n{ a: 1, b: 1, c: 1 } æœ‰æ•ˆç´¢å¼•å­—æ®µæ˜¯ï¼š\na a, b a, b, c ä¸èƒ½ç›´æ¥ç”¨ b, cã€‚\n3. é¿å…è¿‡å¤šç´¢å¼• æ¯ä¸ª index éƒ½ä¼šï¼š\nå ç”¨å†…å­˜ é™ä½å†™å…¥æ€§èƒ½ 4. å®šæœŸæ£€æŸ¥ COLLSCANï¼ˆå…¨è¡¨æ‰«æï¼‰ db.collection.find({...}).explain(\u0026#34;executionStats\u0026#34;) å‡ºç° COLLSCAN å¿…é¡»åŠ ç´¢å¼•ã€‚\nğŸ”¥ å››ã€æ€§èƒ½æœ€ä½³å®è·µ 1. æ°¸è¿œä¸è¦åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨æ­£åˆ™å‰ç¼€æ¨¡ç³Š âŒ é”™è¯¯ï¼š\ndb.users.find({ name: /abc/ }) âœ… æ­£ç¡®ï¼š\ndb.users.find({ name: /^abc/ }) 2. é¿å…å¤§ $in æŸ¥è¯¢ âŒï¼š\nid in [1,2,3,4...50000] ä¼šå¯¼è‡´ huge COLLSCANã€‚\n3. åˆ†é¡µä½¿ç”¨ _id + limitï¼ˆæ›´å¿«ï¼‰ æ¯” skip å¿«æ•°åå€ã€‚\n4. èšåˆå¤§é‡æ•°æ®æ—¶ä½¿ç”¨ allowDiskUse db.collection.aggregate([...], { allowDiskUse: true }) 5. ä½¿ç”¨æŠ•å½±å‡å°‘è¿”å›å­—æ®µ åªè¦éœ€è¦å­—æ®µï¼š\n{ name: 1, age: 1 } ğŸ”¥ äº”ã€è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ 1. RAID10 + SSD æ˜¯æ ‡é… ç†ç”±ï¼š\nWiredTiger éœ€è¦å¤§é‡éšæœº I/O SSD æ˜¾è‘—æå‡å†™å…¥æ€§èƒ½ 2. ç¦æ­¢ swapï¼ˆæ€§èƒ½ç¾éš¾ï¼‰ è®¾ç½®ï¼š\nvm.swappiness = 1 3. Oplog ä¿æŒè‡³å°‘ 24 å°æ—¶ æŸ¥çœ‹ï¼š\nrs.printReplicationInfo() 4. æ•°ç™¾ä¸‡çº§ collection åº”åˆ†åº“åˆ†é›†åˆ é¿å…ï¼š\nå¤ªå¤šå°é›†åˆ æ¯ä¸ªéƒ½æœ‰ç´¢å¼• -\u0026gt; å†…å­˜çˆ†ç‚¸ ğŸ”¥ å…­ã€å®‰å…¨æœ€ä½³å®è·µ 1. å¼€å¯è®¤è¯ security: authorization: enabled 2. ä¸è¦ä½¿ç”¨ admin åº“ä½œä¸ºä¸šåŠ¡åº“ é¿å…ç”¨æˆ·æƒé™è¿‡é«˜ã€‚\n3. ä½¿ç”¨è§’è‰²æƒé™ åˆ›å»ºæœ€å°æƒé™ç”¨æˆ·ï¼š\ndb.createUser({ user: \u0026#34;app\u0026#34;, pwd: \u0026#34;xxx\u0026#34;, roles: [{ role: \u0026#34;readWrite\u0026#34;, db: \u0026#34;mydb\u0026#34; }] }) 4. ä½¿ç”¨ TLS/SSL å¼€å¯è¯ä¹¦åŠ å¯†ä¼ è¾“ã€‚\nğŸ”¥ ä¸ƒã€ç›‘æ§æœ€ä½³å®è·µ å¿…ç›‘æ§æŒ‡æ ‡ï¼š\nWiredTigerï¼š\ncache usage eviction dirty bytes Replicationï¼š\nreplication lagï¼ˆå¿…é¡» \u0026lt; 10 ç§’ï¼‰ oplog time window Performanceï¼š\nopcounters slow queries queue length I/O è¯»å†™ æ¨èä½¿ç”¨ï¼š\nPrometheus + Grafana Percona Monitoring (PMM) ğŸ”¥ å…«ã€å¼€å‘ç¼–ç æœ€ä½³å®è·µ 1. ä¸è¦åœ¨ä»£ç ä¸­åˆ›å»ºå¤ªå¤šè¿æ¥ âœ… ä½¿ç”¨è¿æ¥æ± ï¼ˆpoolï¼‰\n2. å†™æ“ä½œè¦ idempotentï¼ˆå¹‚ç­‰ï¼‰ ä¾‹å¦‚ï¼š\nupdateOne(upsert=True) 3. é¿å…å•æ–‡æ¡£å¤§å­—æ®µæ›´æ–° ä¼šè§¦å‘ï¼š\ndocument move rewrite entire doc æˆæœ¬é«˜ï¼\n4. ä½¿ç”¨ bulkWrite æ‰¹é‡å†™å…¥ æ‰¹é‡æ€§èƒ½æ¯”å¾ªç¯ insert å¿« 10x+ã€‚\nğŸ”¥ ä¹ã€å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰ âŒ å¤§é‡ä½¿ç”¨ $whereï¼ˆJS æ‰§è¡Œï¼Œææ…¢ï¼‰ âŒ ä½¿ç”¨ skip è¿›è¡Œæ·±åº¦åˆ†é¡µï¼ˆæ€§èƒ½å™©æ¢¦ï¼‰ âŒ åœ¨å­—æ®µä¸Šä½¿ç”¨æ­£åˆ™å‰ç½®é€šé…ç¬¦ .*abc âŒ æ–‡æ¡£æ— é™æ·±åº¦åµŒå¥— âŒ åŒä¸€é›†åˆåˆ›å»ºå‡ åä¸ªç´¢å¼• âŒ åƒåœ¾åˆ†ç‰‡é”®å¯¼è‡´çƒ­ç‚¹é—®é¢˜ âŒ å¤šå­—æ®µå¸¸æ”¹ -\u0026gt; åµŒå¥—å¤ªæ·±é€ æˆæ•´æ–‡æ¡£é‡å†™ ","description":"MongoDB æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§è¿ç»´ + å¼€å‘ + æ€§èƒ½ä¼˜åŒ–ï¼‰å®Œæ•´æŒ‡å—ï¼Œç›´æ¥å¯ç”¨äºæ¶æ„è®¾è®¡ã€å¼€å‘è§„èŒƒã€æ•°æ®åº“è§„åˆ’ä¸è°ƒä¼˜ã€‚\nå†…å®¹ï¼š\næ¶æ„è®¾è®¡æœ€ä½³å®è·µ æ•°æ®æ¨¡å‹ \u0026amp; Schema è®¾è®¡ ç´¢å¼•è®¾è®¡ æ€§èƒ½ä¼˜åŒ– è¿ç»´ \u0026amp; éƒ¨ç½²æœ€ä½³å®è·µ å®‰å…¨æœ€ä½³å®è·µ ç›‘æ§æœ€ä½³å®è·µ å¼€å‘ç¼–ç æœ€ä½³å®è·µ å¸¸è§åæ¨¡å¼ï¼ˆåƒä¸‡ä¸è¦åšï¼‰ ğŸ”¥ ä¸€ã€æ¶æ„è®¾è®¡æœ€ä½³å®è·µ 1. ä¼˜å…ˆä½¿ç”¨å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ è‡³å°‘ï¼š\nprimary + secondary + arbiterï¼ˆæˆ–ç¬¬äºŒä¸ª secondaryï¼‰\nç›®çš„ï¼š\n"},{"id":306,"href":"/database/mongo/classic-issues/","title":"MongoDB ç»å…¸é—®é¢˜","parent":"MongoDB","content":" ä¸€ã€å¼€å‘å±‚é¢å¸¸è§é—®é¢˜ 1ï¸âƒ£ ç´¢å¼•ç¼ºå¤± -\u0026gt; COLLSCANï¼ˆç­‰ä»·äº Redis ç©¿é€ï¼‰ ğŸ“Œ ç°è±¡\næŸ¥è¯¢æ…¢ explain å‡ºç° COLLSCAN CPU é£™é«˜ ğŸ§¨ åŸå› \nwhere / sort / lookup å­—æ®µæœªå»ºç´¢å¼• å¤åˆç´¢å¼•æœªå‘½ä¸­å·¦å‰ç¼€ ğŸ’¥ å½±å“\nå…¨è¡¨æ‰«æ å¹¶å‘é«˜æ—¶ç›´æ¥æ‹–å® MongoDB âœ… è§£å†³æ–¹æ¡ˆ\nexplain(â€œexecutionStatsâ€) å»ºç«‹åˆé€‚ç´¢å¼• å¤åˆç´¢å¼•éµå¾ªå·¦å‰ç¼€ 2ï¸âƒ£ æ·±åº¦åˆ†é¡µï¼ˆskip å¤§ï¼‰-\u0026gt; æ€§èƒ½å´©å¡Œ ğŸ“Œ ç°è±¡\ndb.col.find().skip(100000).limit(20) ğŸ§¨ åŸå› \nMongoDB å¿…é¡»æ‰«æå¹¶ä¸¢å¼ƒ skip çš„æ–‡æ¡£\nğŸ’¥ å½±å“\nIO + CPU é£™å‡ æŸ¥è¯¢æ—¶é—´çº¿æ€§å¢é•¿ âœ… è§£å†³æ–¹æ¡ˆ\nä½¿ç”¨ _id / æ—¶é—´æ¸¸æ ‡åˆ†é¡µ èŒƒå›´æŸ¥è¯¢ä»£æ›¿ skip 3ï¸âƒ£ æ–‡æ¡£è¿‡å¤§ / æ›´æ–°é¢‘ç¹ -\u0026gt; å†™æ”¾å¤§ ğŸ“Œ ç°è±¡\nupdate å¾ˆæ…¢ ç£ç›˜ IO é«˜ ğŸ§¨ åŸå› \nWiredTiger æ›´æ–°ä¼šé‡å†™æ–‡æ¡£ å¤§å­—æ®µé¢‘ç¹å˜æ›´ ğŸ’¥ å½±å“\nå†™æ”¾å¤§ é”ç«äº‰ âœ… è§£å†³æ–¹æ¡ˆ\næ‹†åˆ†æ–‡æ¡£ çƒ­å­—æ®µå•ç‹¬å­˜ é¿å…é¢‘ç¹æ›´æ–°å¤§æ•°ç»„ 4ï¸âƒ£ å¤§ $in æŸ¥è¯¢ -\u0026gt; å†…å­˜ \u0026amp; CPU ç‚¸è£‚ ğŸ“Œ ç°è±¡\n{ _id: { $in: [1..50000] } } ğŸ§¨ åŸå› \nMongoDB é€æ¡åŒ¹é…\nğŸ’¥ å½±å“\næŸ¥è¯¢æ…¢ å†…å­˜æš´æ¶¨ âœ… è§£å†³æ–¹æ¡ˆ\næ‰¹é‡åˆ†æ®µæŸ¥è¯¢ ä¸´æ—¶é›†åˆ join 5ï¸âƒ£ æ­£åˆ™è¯¯ç”¨ï¼ˆç­‰ä»·äºç¼“å­˜å‡»ç©¿ï¼‰ ğŸ“Œ ç°è±¡\n{ name: /abc/ } ğŸ§¨ åŸå› \næ— æ³•èµ°ç´¢å¼• ğŸ’¥ å½±å“\nå…¨è¡¨æ‰«æ âœ… è§£å†³æ–¹æ¡ˆ\n{ name: /^abc/ } äºŒã€æ¶æ„ \u0026amp; æ•°æ®æ¨¡å‹é—®é¢˜ 6ï¸âƒ£ åµŒå¥—è®¾è®¡é”™è¯¯ï¼ˆEmbed æ»¥ç”¨ï¼‰ ğŸ§¨ åŸå› \nä¸€å¯¹å¤šåµŒå¥—æ— é™å¢é•¿ ğŸ’¥ å½±å“\nè¶… 16MB æ›´æ–°æ…¢ âœ… è§£å†³æ–¹æ¡ˆ\nä¸€å¯¹å¤šæ”¹å¼•ç”¨ æ§åˆ¶åµŒå¥—æ·±åº¦ â‰¤ 5 7ï¸âƒ£ é›†åˆ / ç´¢å¼•è¿‡å¤š -\u0026gt; å†…å­˜è¢«åƒå…‰ ğŸ“Œ ç°è±¡\nMongoDB å†…å­˜å ç”¨æé«˜ ğŸ§¨ åŸå› \næ¯ä¸ªç´¢å¼•éƒ½è¦è¿›å†…å­˜ æ•°ä¸‡ collection ğŸ’¥ å½±å“\ncache miss æ€§èƒ½ä¸‹é™ âœ… è§£å†³æ–¹æ¡ˆ\nåˆå¹¶é›†åˆ å®šæœŸæ¸…ç†æ— ç”¨ç´¢å¼• ä¸‰ã€é›†ç¾¤ \u0026amp; å¤åˆ¶é›†é—®é¢˜ 8ï¸âƒ£ ä¸»ä»å»¶è¿Ÿï¼ˆReplication Lagï¼‰ ğŸ“Œ ç°è±¡\nsecondary æ•°æ®è½å ğŸ§¨ åŸå› \nå†™å…¥è¿‡å¿« IO ç“¶é¢ˆ oplog å¤ªå° ğŸ’¥ å½±å“\nè¯»åˆ°æ—§æ•°æ® æ•…éšœåˆ‡æ¢ä¸¢æ•°æ® âœ… è§£å†³æ–¹æ¡ˆ\næ‰©å¤§ oplog æå‡ IO å‡å°‘å¤§äº‹åŠ¡ 9ï¸âƒ£ ä¸»èŠ‚ç‚¹é¢‘ç¹åˆ‡æ¢ï¼ˆPrimary Flappingï¼‰ ğŸ“Œ ç°è±¡\né¢‘ç¹é€‰ä¸» ğŸ§¨ åŸå› \nç½‘ç»œæŠ–åŠ¨ CPU/IO æ‰“æ»¡ å¿ƒè·³è¶…æ—¶ ğŸ’¥ å½±å“\nå†™å…¥ä¸­æ–­ æœåŠ¡æŠ–åŠ¨ âœ… è§£å†³æ–¹æ¡ˆ\nä¿è¯ 3 èŠ‚ç‚¹ä»¥ä¸Š ç½‘ç»œç¨³å®š é¿å…èŠ‚ç‚¹èµ„æºæ‰“æ»¡ 1ï¸âƒ£0ï¸âƒ£ Oplog ä¸å¤Ÿ -\u0026gt; åŒæ­¥å¤±è´¥ ğŸ“Œ ç°è±¡\nsecondary éœ€è¦å…¨é‡åŒæ­¥ ğŸ§¨ åŸå› \noplog è¢«å¿«é€Ÿè¦†ç›– ğŸ’¥ å½±å“\né•¿æ—¶é—´ä¸å¯ç”¨ IO é£™å‡ âœ… è§£å†³æ–¹æ¡ˆ\nè°ƒå¤§ oplogï¼ˆâ‰¥24hï¼‰ æ§åˆ¶å†™å…¥å³°å€¼ å››ã€åˆ†ç‰‡é›†ç¾¤é—®é¢˜ 1ï¸âƒ£1ï¸âƒ£ åˆ†ç‰‡é”®é€‰æ‹©é”™è¯¯ï¼ˆç­‰ä»· Redis é›ªå´©ï¼‰ ğŸ§¨ åŸå› \nå•è°ƒé€’å¢åˆ†ç‰‡é”® ğŸ’¥ å½±å“\nçƒ­ç‚¹ shard å†™å…¥ä¸å‡è¡¡ âœ… è§£å†³æ–¹æ¡ˆ\nhashed åˆ†ç‰‡é”® ä¸šåŠ¡ç»´åº¦åˆ†ç‰‡ 1ï¸âƒ£2ï¸âƒ£ Chunk è¿ç§»å¯¼è‡´æŠ–åŠ¨ ğŸ“Œ ç°è±¡\nå»¶è¿Ÿçªç„¶å‡é«˜ ğŸ§¨ åŸå› \nbalancer åœ¨è¿ç§» chunk ğŸ’¥ å½±å“\nIO æŠ¢å  âœ… è§£å†³æ–¹æ¡ˆ\nä½å³°æœŸå¼€ balancer æ§åˆ¶ chunk å¤§å° äº”ã€è¿ç»´ \u0026amp; ç³»ç»Ÿé—®é¢˜ï¼ˆç”Ÿäº§å¿…è¸©ï¼‰ 1ï¸âƒ£3ï¸âƒ£ Swap å¯¼è‡´æ€§èƒ½é›ªå´© ğŸ§¨ åŸå› \nMongoDB æåº¦ä¾èµ–å†…å­˜ ğŸ’¥ å½±å“\nå»¶è¿Ÿ x10 å¡æ­» âœ… è§£å†³æ–¹æ¡ˆ\nvm.swappiness=1 1ï¸âƒ£4ï¸âƒ£ ç£ç›˜ IO ç“¶é¢ˆ ğŸ“Œ ç°è±¡\nå†™æ…¢ã€ä¸»ä»å»¶è¿Ÿ ğŸ§¨ åŸå› \nHDD RAID5 âœ… è§£å†³æ–¹æ¡ˆ\nSSD + RAID10 1ï¸âƒ£5ï¸âƒ£ æœªå¼€å¯è®¤è¯ï¼ˆå®‰å…¨äº‹æ•…ï¼‰ ğŸ§¨ åŸå› \nè£¸å¥” 27017 ğŸ’¥ å½±å“\nè¢«åˆ åº“å‹’ç´¢ âœ… è§£å†³æ–¹æ¡ˆ\nå¯ç”¨ auth æœ€å°æƒé™ å…­ã€MongoDB vs Redis é—®é¢˜å¯¹ç…§è¡¨ Redis MongoDB å¯¹åº”é—®é¢˜ ç¼“å­˜ç©¿é€ æ— ç´¢å¼• COLLSCAN ç¼“å­˜å‡»ç©¿ æ­£åˆ™ / çƒ­ç‚¹æŸ¥è¯¢ ç¼“å­˜é›ªå´© åˆ†ç‰‡é”®çƒ­ç‚¹ / ä¸»èŠ‚ç‚¹åˆ‡æ¢ å†…å­˜æº¢å‡º ç´¢å¼•è¿‡å¤š æŒä¹…åŒ–é˜»å¡ å¤§äº‹åŠ¡ / å†™æ”¾å¤§ ğŸ¯ æ€»ç»“ Redis çš„é—®é¢˜é›†ä¸­åœ¨ ç¼“å­˜ä¸€è‡´æ€§å’Œå¤±æ•ˆç­–ç•¥ï¼ŒMongoDB çš„é—®é¢˜é›†ä¸­åœ¨ ç´¢å¼•è®¾è®¡ã€æ•°æ®æ¨¡å‹ã€IOã€å¤åˆ¶é›†å’Œåˆ†ç‰‡æ¶æ„ã€‚\n","description":" ä¸€ã€å¼€å‘å±‚é¢å¸¸è§é—®é¢˜ 1ï¸âƒ£ ç´¢å¼•ç¼ºå¤± -\u0026gt; COLLSCANï¼ˆç­‰ä»·äº Redis ç©¿é€ï¼‰ ğŸ“Œ ç°è±¡\næŸ¥è¯¢æ…¢ explain å‡ºç° COLLSCAN CPU é£™é«˜ ğŸ§¨ åŸå› \nwhere / sort / lookup å­—æ®µæœªå»ºç´¢å¼• å¤åˆç´¢å¼•æœªå‘½ä¸­å·¦å‰ç¼€ ğŸ’¥ å½±å“\nå…¨è¡¨æ‰«æ å¹¶å‘é«˜æ—¶ç›´æ¥æ‹–å® MongoDB âœ… è§£å†³æ–¹æ¡ˆ\n"},{"id":307,"href":"/database/mongo/cluster/","title":"MongoDB é›†ç¾¤","parent":"MongoDB","content":"ä¸‹é¢æ˜¯ä¸€ä»½ MongoDB é›†ç¾¤ï¼ˆReplica Set + Shardingï¼‰å®Œæ•´è¯¦è§£ï¼Œä»æ¶æ„åŸç†ã€éƒ¨ç½²æ–¹å¼ã€è¿è¡Œæœºåˆ¶åˆ°æœ€ä½³å®è·µï¼Œä¸€æ¬¡è®²å…¨ï¼Œé€‚åˆåšçŸ¥è¯†åº“æˆ–å·¥ä½œæ–‡æ¡£ã€‚\nğŸš€ 1. MongoDB é›†ç¾¤ä½“ç³» MongoDB çš„é›†ç¾¤ç”±ä¸¤ç§æ ¸å¿ƒæœºåˆ¶ç»„æˆï¼š\nâ‘  Replica Setï¼ˆå¤åˆ¶é›†ï¼Œé«˜å¯ç”¨ï¼‰ æä¾›ï¼š\nè‡ªåŠ¨æ•…éšœè½¬ç§» è‡ªåŠ¨é€‰ä¸» å¤šå‰¯æœ¬å†—ä½™ æ•°æ®å®‰å…¨ â‘¡ Shardingï¼ˆåˆ†ç‰‡ï¼Œæ°´å¹³æ‰©å±•ï¼‰ æä¾›ï¼š\nåˆ†å¸ƒå¼å­˜å‚¨ åˆ†å¸ƒå¼æŸ¥è¯¢ æ‰©å±•è‡³ PB çº§æ•°æ® å®Œæ•´çš„ MongoDB é›†ç¾¤ï¼ˆå³ Sharded Clusterï¼‰ç”±ï¼š\nClients -\u0026gt; mongosï¼ˆè·¯ç”±ï¼‰ -\u0026gt; Shardsï¼ˆå¤šä¸ª Replica Setï¼‰ -\u0026gt; Config Serversï¼ˆå…ƒæ•°æ®ï¼‰ ğŸ§© 2. MongoDB å¤åˆ¶é›†ï¼ˆReplica Setï¼‰ 2.1 ç»“æ„ç»„æˆ ä¸€ä¸ªå…¸å‹çš„å¤åˆ¶é›†æœ‰ï¼š\nPrimaryï¼ˆä¸»èŠ‚ç‚¹ï¼‰ Secondaryï¼ˆä»èŠ‚ç‚¹ï¼‰x N Arbiterï¼ˆä»²è£èŠ‚ç‚¹ï¼Œå¯é€‰ï¼‰ ç»“æ„ç¤ºä¾‹ï¼š\n+-------------+ | Primary | +-------------+ / | \\ / | \\ +----------+ +----------+ +----------+ | Secondary| | Secondary| | Arbiter | +----------+ +----------+ +----------+ Arbiter ä»…å‚ä¸é€‰ä¸»ï¼Œä¸ä¿å­˜æ•°æ®ã€‚\n2.2 å·¥ä½œæœºåˆ¶ï¼ˆå¤åˆ¶æµç¨‹ï¼‰ å†™å…¥æµç¨‹ï¼š\nClient -\u0026gt; å†™ Primary -\u0026gt; Primary è®°å½• opLog -\u0026gt; Secondary æ‹‰å– opLog -\u0026gt; åº”ç”¨åˆ°è‡ªå·±æ•°æ®é›† Secondary åŒæ­¥ä¸»èŠ‚ç‚¹çš„ oplogï¼ˆæ“ä½œæ—¥å¿—ï¼‰ï¼Œå½¢æˆæœ€ç»ˆä¸€è‡´æ€§ã€‚\n2.3 é€‰ä¸»æœºåˆ¶ï¼ˆFailoverï¼‰ å½“ Primary æŒ‚æ‰ï¼š\nSecondary ä¹‹é—´æŠ•ç¥¨é€‰ä¸¾æ–°çš„ Primary\nè¦æ±‚å¤šæ•°èŠ‚ç‚¹å­˜æ´»ï¼ˆmajorityï¼‰\né€‰ä¸¾åŸºäºï¼š\nfreshnessï¼ˆoplog æœ€æ–°ï¼‰ priorityï¼ˆä¼˜å…ˆçº§ï¼‰ å¿ƒè·³æœºåˆ¶ è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚\n2.4 å¸¸è§å¤åˆ¶é›†éƒ¨ç½²æ–¹å¼ æ–¹æ¡ˆ Aï¼šä¸‰èŠ‚ç‚¹å¤åˆ¶é›†ï¼ˆæœ€æ¨èï¼‰ Primary + Secondary + Secondary æ–¹æ¡ˆ Bï¼šä¸¤èŠ‚ç‚¹ + ä»²è£ï¼ˆç¡¬ä»¶æœ‰é™ï¼‰ Primary + Secondary + Arbiter æ–¹æ¡ˆ Cï¼šäº”èŠ‚ç‚¹ï¼ˆç”Ÿäº§å¤§é›†ç¾¤ï¼‰ ç”¨äºæ›´é«˜çš„é«˜å¯ç”¨ä¿è¯ã€‚\n2.5 å‰¯æœ¬é›†è¯»å†™æ¨¡å¼ é»˜è®¤ï¼šå¼ºä¸€è‡´ï¼ˆè¯»å†™ Primaryï¼‰\nreadPreference = primary å¯é€‰ï¼šä»èŠ‚ç‚¹è¯»ï¼ˆå¼±ä¸€è‡´ï¼‰\nreadPreference = secondary ç”¨äºé«˜è¯»è´Ÿè½½åœºæ™¯ã€‚\nğŸ§© 3. MongoDB Shardingï¼ˆåˆ†ç‰‡é›†ç¾¤ï¼‰ å¦‚æœæ•°æ®é‡ TBã€œPBï¼Œæˆ–è¯»å†™è¯·æ±‚æå¤§ï¼Œå°±å¿…é¡»ä½¿ç”¨åˆ†ç‰‡ã€‚\n3.1 åˆ†ç‰‡é›†ç¾¤ç»„æˆ ä¸€ä¸ªå…¸å‹åˆ†ç‰‡é›†ç¾¤ç”±ï¼š\nâ‘  Shardï¼ˆæ•°æ®åˆ†ç‰‡ï¼Œç”±å¤šä¸ª Replica Set æ„æˆï¼‰ Shard1 = ReplicaSet Shard2 = ReplicaSet Shard3 = ReplicaSet â‘¡ Config Server Replica Setï¼ˆCSRSï¼‰ å­˜å‚¨é›†ç¾¤å…ƒæ•°æ®ï¼š\nåˆ†ç‰‡é”® chunk åˆ†å¸ƒ æ•°æ®è·¯ç”±è§„åˆ™ å¿…é¡»ä¸ºå¤åˆ¶é›†ã€‚\nâ‘¢ mongosï¼ˆè·¯ç”±è¿›ç¨‹ï¼‰ åº”ç”¨æ‰€æœ‰è¯»å†™è¯·æ±‚éƒ½å‘ç»™ mongosï¼Œå®ƒè´Ÿè´£åˆ†å‘åˆ°å…·ä½“åˆ†ç‰‡ã€‚\næ•´ä½“æ¶æ„ï¼š\n+-----------+ | Clients | +-----+-----+ | +--+--+ |mongos| +--+--+ | --------------------------------- | | | +------+ +------+ +------+ |Shard1| |Shard2| |Shard3| +------+ +------+ +------+ | | | ReplicaSet ReplicaSet ReplicaSet ğŸ§© 3.2 åˆ†ç‰‡çš„æ ¸å¿ƒæ¦‚å¿µ â‘  åˆ†ç‰‡é”®ï¼ˆShard Keyï¼‰ å†³å®šæ•°æ®åˆ†å¸ƒæ–¹å¼ï¼Œå†³å®šæ€§èƒ½æˆè´¥ã€‚\nä½¿ç”¨ï¼š\nsh.shardCollection(\u0026#34;test.users\u0026#34;, { user_id: 1 }) â‘¡ Chunkï¼ˆæ•°æ®å—ï¼‰ MongoDB é»˜è®¤å°†æ•°æ®é›†åˆåˆ‡æˆ 64MB çš„å—ï¼ˆchunkï¼‰ã€‚\nChunk ä¼šè‡ªåŠ¨ï¼š\nå‡è¡¡ï¼ˆbalancerï¼‰ è¿ç§»ï¼ˆmoveChunkï¼‰ â‘¢ Sharding ç­–ç•¥ ï¼ˆ1ï¼‰å“ˆå¸Œåˆ†ç‰‡ï¼ˆhashedï¼‰â€”â€”æœ€æ¨è\nè‡ªåŠ¨å‡åŒ€åˆ†å¸ƒï¼Œé˜²æ­¢çƒ­ç‚¹ã€‚\n{ user_id: \u0026#34;hashed\u0026#34; } é€‚åˆï¼š\né«˜å†™å…¥ æ—¥å¿—ã€ç›‘æ§ã€è®¢å•ç­‰ ï¼ˆ2ï¼‰èŒƒå›´åˆ†ç‰‡ï¼ˆrangeï¼‰\næŒ‰é¡ºåºæ’åˆ—æ•°æ®ï¼Œä¾‹å¦‚ï¼š\n{ timestamp: 1 } ä¼˜ç‚¹ï¼š\nèŒƒå›´æŸ¥è¯¢ç‰¹åˆ«å¿« ç¼ºç‚¹ï¼š\næ—¶é—´æˆ³ä¼šé€ æˆå†™å…¥çƒ­ç‚¹ ï¼ˆ3ï¼‰å¤åˆç´¢å¼•åˆ†ç‰‡ï¼ˆcompoundï¼‰\nä¾‹å¦‚ï¼š\n{ country: 1, user_id: 1 } é€‚åˆè·¨åŒºéƒ¨ç½²ã€‚\nğŸ§© 3.3 Sharding æŸ¥è¯¢é€»è¾‘ è·¯ç”±æµç¨‹ï¼š\nClient -\u0026gt; mongos -\u0026gt; Config Server -\u0026gt; Shard MongoDB è‡ªåŠ¨å†³å®šæŸ¥è¯¢æ˜¯å¦éœ€è¦ï¼š\nå•åˆ†ç‰‡ å¤šåˆ†ç‰‡ èšåˆåˆå¹¶ å¼€å‘è€…æ— éœ€ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ã€‚\nğŸ§© 4. MongoDB é›†ç¾¤éƒ¨ç½²æ¨èæ–¹æ¡ˆ â­ æ¨èä¼ä¸šçº§æ¶æ„ï¼ˆé«˜å¯ç”¨ + æ‰©å±•æ€§ + æ€§èƒ½ï¼‰\nConfig Servers: 3 èŠ‚ç‚¹ ReplicaSet Shards: è‡³å°‘ 2 Shardï¼Œæ¯ä¸ªæ˜¯ 3 èŠ‚ç‚¹ ReplicaSetï¼ˆ3Ã—2=6ï¼‰ mongos: å¤šä¸ªï¼Œè´Ÿè½½å‡è¡¡ æ€»è®¡ï¼š3 (ConfigRS) + 6 (Shards) + 2 (mongos) = 11 ä¸ªèŠ‚ç‚¹\néå¸¸å¯é ã€å¯æ‰©å±•åˆ° PB çº§æ•°æ®ã€‚\nğŸ§© 5. MongoDB é›†ç¾¤è¿ç»´ 5.1 å¸¸ç”¨é›†ç¾¤å‘½ä»¤ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€\nrs.status() sh.status() æ‰‹åŠ¨è¿ç§» chunk\nsh.moveChunk() æ·»åŠ åˆ†ç‰‡\nsh.addShard() é‡æ–°å¹³è¡¡\nsh.startBalancer() 5.2 å¤åˆ¶é›†å¸¸è§é—®é¢˜ primary é¢‘ç¹åˆ‡æ¢ -\u0026gt; ç½‘ç»œé—®é¢˜ / å¿ƒè·³å»¶è¿Ÿ secondary è½å -\u0026gt; oplog å¤ªå° åŒæ­¥å¤±è´¥ -\u0026gt; ç£ç›˜ IOã€ç½‘ç»œé—®é¢˜ 5.3 åˆ†ç‰‡å¸¸è§é—®é¢˜ åˆ†ç‰‡é”®é€‰æ‹©é”™è¯¯ -\u0026gt; çƒ­ç‚¹å†™å…¥ chunk ç§¯å‹ -\u0026gt; balancer è¢«å…³æ‰ æŸ¥è¯¢è·¨åˆ†ç‰‡å¤ªå¤š -\u0026gt; åˆ†ç‰‡é”®è®¾è®¡é”™è¯¯ ğŸ§© 6. é›†ç¾¤æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ 1. æ°¸è¿œä½¿ç”¨ä¸‰èŠ‚ç‚¹å¤åˆ¶é›†ï¼Œä¸è¦ç”¨ä¸¤èŠ‚ç‚¹ é¿å…è„‘è£‚ã€‚\n2. Shard æ•°é‡ä» 2 å¼€å§‹ï¼Œä¸šåŠ¡å¢é•¿å†åŠ  å¤ªå¤š Shard = ç®¡ç†æˆæœ¬é«˜ã€‚\n3. åˆ†ç‰‡é”®é€‰å¾—å¥½ï¼Œæ€§èƒ½æå‡ 10~100 å€ è¦é¿å…ï¼š\nå•è°ƒé€’å¢å­—æ®µï¼ˆå¦‚æ—¶é—´æˆ³ï¼‰ çƒ­ç‚¹å­—æ®µ å»ºè®®ï¼š\nä½¿ç”¨å“ˆå¸Œåˆ†ç‰‡ 4. oplog å¤§å°è‡³å°‘ä¿è¯ 24 å°æ—¶ é¿å… Secondary è½åé‡åŒæ­¥ã€‚\n5. mongos éœ€è¦è´Ÿè½½å‡è¡¡ ä½¿ç”¨ Nginx / LVS / HAProxyã€‚\n6. ä¸åœ¨ Config Server ä¸Šå­˜ä¸šåŠ¡æ•°æ® Config Server æ˜¯å…¨å±€å…ƒæ•°æ®åº“ã€‚\nğŸ§© 7. ä»€ä¹ˆæ—¶å€™åº”è¯¥å¼€å§‹ç”¨åˆ†ç‰‡ï¼Ÿ æ»¡è¶³ä»»æ„æ¡ä»¶å³å¯ï¼š\nå•èŠ‚ç‚¹ç£ç›˜å®¹é‡ä¸è¶³ï¼ˆ\u0026gt;1TBï¼‰ QPS éå¸¸é«˜ï¼ˆ\u0026gt; 20k/sï¼‰ å†™å…¥é‡éå¸¸å¤§ï¼ˆæ—¥å¿—ã€è®¢å•ã€è¡Œä¸ºï¼‰ æ•°æ®çƒ­ç‚¹å¼ºçƒˆ é›†ç¾¤å¼€å§‹å‡ºç°æ€§èƒ½ç“¶é¢ˆ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ MongoDB é›†ç¾¤ï¼ˆReplica Set + Shardingï¼‰å®Œæ•´è¯¦è§£ï¼Œä»æ¶æ„åŸç†ã€éƒ¨ç½²æ–¹å¼ã€è¿è¡Œæœºåˆ¶åˆ°æœ€ä½³å®è·µï¼Œä¸€æ¬¡è®²å…¨ï¼Œé€‚åˆåšçŸ¥è¯†åº“æˆ–å·¥ä½œæ–‡æ¡£ã€‚\nğŸš€ 1. MongoDB é›†ç¾¤ä½“ç³» MongoDB çš„é›†ç¾¤ç”±ä¸¤ç§æ ¸å¿ƒæœºåˆ¶ç»„æˆï¼š\nâ‘  Replica Setï¼ˆå¤åˆ¶é›†ï¼Œé«˜å¯ç”¨ï¼‰ æä¾›ï¼š\nè‡ªåŠ¨æ•…éšœè½¬ç§» è‡ªåŠ¨é€‰ä¸» å¤šå‰¯æœ¬å†—ä½™ æ•°æ®å®‰å…¨ â‘¡ Shardingï¼ˆåˆ†ç‰‡ï¼Œæ°´å¹³æ‰©å±•ï¼‰ æä¾›ï¼š\n"},{"id":308,"href":"/backend/python/official/multiprocessing/","title":"Multiprocessing (å¤šè¿›ç¨‹)","parent":"Official","content":"ä¸‹é¢æ˜¯ æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€å®Œå…¨å¤Ÿç”¨çš„ Python multiprocessingï¼ˆå¤šè¿›ç¨‹ï¼‰æŒ‡å—ï¼Œä»å…¥é—¨åˆ°è¿›é˜¶ï¼Œä¸€æ¬¡è®²æ˜ç™½ã€‚\nmultiprocessing æ˜¯ Python ç”¨æ¥ ç»•è¿‡ GILã€å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„å®˜æ–¹åº“ã€‚\né€‚ç”¨äºï¼š\nCPU å¯†é›†å‹ï¼ˆè®¡ç®—ã€å‹ç¼©ã€å›¾åƒå¤„ç†ã€åŠ å¯†ã€çŸ©é˜µè¿ç®—ï¼‰ å¹¶è¡Œè·‘å¤šä¸ªç‹¬ç«‹ä»»åŠ¡ å¹¶å‘å¤„ç†å¤§å‹æ•°æ®é›† åŠ å¿«æ¨¡å‹è®­ç»ƒå‰çš„å‡†å¤‡ä»»åŠ¡ 1. ä¸ºä»€ä¹ˆéœ€è¦ multiprocessingï¼Ÿ å› ä¸º Python æœ‰ GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰ï¼š\nå¤šçº¿ç¨‹ä¸èƒ½åˆ©ç”¨å¤šæ ¸ CPU CPU å¯†é›†è¿ç®—ç”¨çº¿ç¨‹ä¸å‡åé™ multiprocessing çš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ ç‹¬ç«‹çš„ Python è§£é‡Šå™¨å’Œ GIL -\u0026gt; çœŸæ­£å¹¶è¡Œè¿è¡Œã€‚\n2. æœ€ç®€å•çš„ multiprocessing ç¤ºä¾‹ from multiprocessing import Process def worker(n): print(\u0026#34;Working:\u0026#34;, n) if __name__ == \u0026#39;__main__\u0026#39;: p = Process(target=worker, args=(1,)) p.start() p.join() è¦ç‚¹ï¼š\nProcess() åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ start() å¯åŠ¨ join() ç­‰å¾…ç»“æŸ å¿…é¡»æ”¾åœ¨ if __name__ == '__main__' ä¸‹ï¼ˆWindows / macOS å¿…é¡»è¦ï¼Œä¸ç„¶ä¼šæ— é™é€’å½’å¯åŠ¨è¿›ç¨‹ï¼‰ 3. ç”¨ Pool æ›´ä¼˜é›…åœ°åˆ›å»ºè¿›ç¨‹æ±  Pool æ˜¯ä½¿ç”¨æœ€å¤šçš„æ–¹å¼ï¼š\nå›ºå®šæ•°é‡è¿›ç¨‹æ± ï¼ˆæ¨èï¼‰\nfrom multiprocessing import Pool def task(x): return x * x if __name__ == \u0026#39;__main__\u0026#39;: with Pool(4) as pool: results = pool.map(task, range(10)) print(results) è¾“å‡ºï¼š\n[0, 1, 4, 9, 16, ...] map() -\u0026gt; è‡ªåŠ¨æ‹†åˆ†ä»»åŠ¡ã€å¤šè¿›ç¨‹å¹¶è¡Œã€æ”¶é›†ç»“æœã€‚\n4. apply_asyncï¼šå¸¦å›è°ƒçš„å¼‚æ­¥æäº¤ä»»åŠ¡ éå¸¸é€‚åˆå¤§æ‰¹é‡ CPU ä»»åŠ¡ï¼š\nfrom multiprocessing import Pool def task(x): return x * x def done(result): print(\u0026#34;Result:\u0026#34;, result) if __name__ == \u0026#39;__main__\u0026#39;: pool = Pool(4) for i in range(10): pool.apply_async(task, args=(i,), callback=done) pool.close() pool.join() å¤šè¿›ç¨‹ + å¼‚æ­¥ + å›è°ƒã€‚\n5. è¿›ç¨‹é—´é€šä¿¡ï¼šQueue / Pipe 5.1 Queueï¼ˆæœ€å¸¸ç”¨ï¼‰ from multiprocessing import Process, Queue def worker(q): q.put(\u0026#34;hello\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: q = Queue() p = Process(target=worker, args=(q,)) p.start() print(q.get()) # ä»å­è¿›ç¨‹å–å€¼ p.join() 5.2 Pipeï¼ˆç‚¹å¯¹ç‚¹æ›´å¿«ï¼‰ from multiprocessing import Process, Pipe def worker(conn): conn.send(\u0026#34;hi\u0026#34;) conn.close() if __name__ == \u0026#39;__main__\u0026#39;: parent, child = Pipe() p = Process(target=worker, args=(child,)) p.start() print(parent.recv()) p.join() 6. å…±äº«æ•°æ®ï¼ˆValue / Array / Managerï¼‰ 6.1 Valueï¼ˆå•ä¸ªå˜é‡å…±äº«ï¼‰ from multiprocessing import Process, Value def worker(v): v.value += 1 if __name__ == \u0026#39;__main__\u0026#39;: val = Value(\u0026#39;i\u0026#39;, 0) ps = [Process(target=worker, args=(val,)) for _ in range(5)] for p in ps: p.start() for p in ps: p.join() print(val.value) # 5 6.2 Arrayï¼ˆå…±äº«æ•°ç»„ï¼‰ 6.3 Managerï¼ˆè·¨è¿›ç¨‹å…±äº« dict / listï¼‰ from multiprocessing import Process, Manager def worker(lst): lst.append(1) if __name__ == \u0026#39;__main__\u0026#39;: mgr = Manager() lst = mgr.list() ps = [Process(target=worker, args=(lst,)) for _ in range(5)] for p in ps: p.start() for p in ps: p.join() print(lst) # [1, 1, 1, 1, 1] 7. è¿›ç¨‹é”ï¼ˆLockï¼‰ é˜²æ­¢å¤šä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€èµ„æºã€‚\nfrom multiprocessing import Process, Lock def worker(lock, n): with lock: print(\u0026#34;Hello\u0026#34;, n) if __name__ == \u0026#39;__main__\u0026#39;: lock = Lock() ps = [Process(target=worker, args=(lock, i)) for i in range(5)] for p in ps: p.start() for p in ps: p.join() 8. multiprocessing vs threading ç‰¹æ€§ multiprocessing threading CPU å¯†é›† âœ… æä½³ âŒ å— GIL é™åˆ¶ IO å¯†é›† âŒ ä¸å¦‚ async âœ… å¯ä»¥ å†…å­˜å ç”¨ å¤§ å° æ•°æ®å…±äº« å¤æ‚ï¼ˆIPCï¼‰ ç®€å•ï¼ˆå†…å­˜å…±äº«ï¼‰ å¯åŠ¨é€Ÿåº¦ æ…¢ å¿« æ€»ç»“ï¼š\nCPU å¯†é›† -\u0026gt; multiprocessing IO å¯†é›† -\u0026gt; async / await è½»é‡æ··åˆä»»åŠ¡ -\u0026gt; threading 9. multiprocessing æœ€ä½³å®è·µ 9.1 å¿…é¡»åŠ ä¸»ä¿æŠ¤ if __name__ == '__main__':\n9.2 æ¨èä½¿ç”¨ Pool è€Œä¸æ˜¯æ‰‹åŠ¨å¼€è¿›ç¨‹ 9.3 ä¸è¦å…±äº«æ™®é€šå¯¹è±¡ï¼ˆè¿›ç¨‹ä¸å…±äº«å†…å­˜ï¼‰ å¿…é¡»ä½¿ç”¨ï¼š\nQueue Manager Pipe Value / Array 9.4 é•¿ä»»åŠ¡ä¼˜å…ˆ multiprocessing 9.5 å¤§æ‰¹é‡å°ä»»åŠ¡å…ˆåˆå¹¶æˆå¤§ä»»åŠ¡ï¼ˆå‡å°‘ IPC è´Ÿæ‹…ï¼‰ 10. multiprocessing + asyncï¼ˆä¸“å®¶çº§ï¼‰ ä½ å¯ä»¥åœ¨ å­è¿›ç¨‹é‡Œè¿è¡Œå¼‚æ­¥ä»»åŠ¡ï¼š\ndef run_async(): asyncio.run(main_async_function()) å¤šè¿›ç¨‹ + å¼‚æ­¥ -\u0026gt; CPU + IO åŒåŠ é€Ÿã€‚\n11. å®Œæ•´æ¨èæ¨¡æ¿ï¼ˆä½ å¯ç›´æ¥æ”¾ utils/processes.pyï¼‰ from multiprocessing import Pool, cpu_count def run_in_parallel(func, data, worker=None): worker = worker or cpu_count() with Pool(worker) as pool: return pool.map(func, data) è°ƒç”¨ï¼š\nfrom utils.processes import run_in_parallel results = run_in_parallel(task, items) 12. æ€»ç»“ï¼ˆæœ€å…³é”®çš„ä¸‰å¥è¯ï¼‰ å¤šè¿›ç¨‹ç”¨äº CPU å¯†é›†å‹ä»»åŠ¡ æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„ GIL -\u0026gt; çœŸæ­£å¹¶è¡Œ ä½¿ç”¨ Pool æ˜¯æœ€æ¨èçš„å†™æ³• ","description":"ä¸‹é¢æ˜¯ æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€å®Œå…¨å¤Ÿç”¨çš„ Python multiprocessingï¼ˆå¤šè¿›ç¨‹ï¼‰æŒ‡å—ï¼Œä»å…¥é—¨åˆ°è¿›é˜¶ï¼Œä¸€æ¬¡è®²æ˜ç™½ã€‚\nmultiprocessing æ˜¯ Python ç”¨æ¥ ç»•è¿‡ GILã€å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„å®˜æ–¹åº“ã€‚\né€‚ç”¨äºï¼š\nCPU å¯†é›†å‹ï¼ˆè®¡ç®—ã€å‹ç¼©ã€å›¾åƒå¤„ç†ã€åŠ å¯†ã€çŸ©é˜µè¿ç®—ï¼‰ å¹¶è¡Œè·‘å¤šä¸ªç‹¬ç«‹ä»»åŠ¡ å¹¶å‘å¤„ç†å¤§å‹æ•°æ®é›† åŠ å¿«æ¨¡å‹è®­ç»ƒå‰çš„å‡†å¤‡ä»»åŠ¡ 1. ä¸ºä»€ä¹ˆéœ€è¦ multiprocessingï¼Ÿ å› ä¸º Python æœ‰ GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰ï¼š\nå¤šçº¿ç¨‹ä¸èƒ½åˆ©ç”¨å¤šæ ¸ CPU CPU å¯†é›†è¿ç®—ç”¨çº¿ç¨‹ä¸å‡åé™ multiprocessing çš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ ç‹¬ç«‹çš„ Python è§£é‡Šå™¨å’Œ GIL -\u0026gt; çœŸæ­£å¹¶è¡Œè¿è¡Œã€‚\n2. æœ€ç®€å•çš„ multiprocessing ç¤ºä¾‹ from multiprocessing import Process def worker(n): print(\u0026#34;Working:\u0026#34;, n) if __name__ == \u0026#39;__main__\u0026#39;: p = Process(target=worker, args=(1,)) p.start() p.join() è¦ç‚¹ï¼š\n"},{"id":309,"href":"/database/mysql/","title":"MySQL","parent":"Database","content":"Document List:\nMySQL FAQ MySQL åŸºç¡€æ•™ç¨‹ MySQL æ ¸å¿ƒæ¦‚å¿µ MySQL COUNT MySQL CREATE TABLE MySQL EXPLAIN MySQL Join MySQL Like MySQL PITR MySQL äº‹åŠ¡ MySQL å•è¡¨ä¸è¦è¶…è¿‡ 2000 ä¸‡è¡Œ MySQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ MySQL å¤‡ä»½ä¸æ¢å¤ MySQL æ€§èƒ½ä¼˜åŒ– MySQL æ•…éšœæ’æŸ¥ MySQL ç¦ç”¨å¤–é”®æ£€æŸ¥ MySQL ç´¢å¼• MySQL ç´¢å¼• MySQL ç»å…¸é—®é¢˜ MySQL è¿ç»´ MySQL è¿ç»´æœ€ä½³å®è·µ MySQL é…ç½®æ–‡ä»¶ my.cnf MySQL é” XtraBackup åŸºç¡€æ•™ç¨‹ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… MySQL 8.4 ","description":"Document List:\nMySQL FAQ MySQL åŸºç¡€æ•™ç¨‹ MySQL æ ¸å¿ƒæ¦‚å¿µ MySQL COUNT MySQL CREATE TABLE MySQL EXPLAIN MySQL Join MySQL Like MySQL PITR MySQL äº‹åŠ¡ MySQL å•è¡¨ä¸è¦è¶…è¿‡ 2000 ä¸‡è¡Œ MySQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ MySQL å¤‡ä»½ä¸æ¢å¤ MySQL æ€§èƒ½ä¼˜åŒ– MySQL æ•…éšœæ’æŸ¥ MySQL ç¦ç”¨å¤–é”®æ£€æŸ¥ MySQL ç´¢å¼• MySQL ç´¢å¼• MySQL ç»å…¸é—®é¢˜ MySQL è¿ç»´ MySQL è¿ç»´æœ€ä½³å®è·µ MySQL é…ç½®æ–‡ä»¶ my.cnf MySQL é” XtraBackup åŸºç¡€æ•™ç¨‹ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… MySQL 8.4 "},{"id":310,"href":"/database/mysql/count/","title":"MySQL COUNT","parent":"MySQL","content":"MySQL ç»Ÿè®¡è¡¨çš„è¡Œæ•°æœ‰å¤šå°‘æ¡ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼Ÿæ¯å¤©ç»Ÿè®¡ä¸€æ¬¡æ¨èç”¨ä»€ä¹ˆæ–¹å¼ï¼Ÿ\nä¸€ã€ä¸ºä»€ä¹ˆç»Ÿè®¡è¡Œæ•°ä¸ç®€å•ï¼Ÿ InnoDB ä¸ç»´æŠ¤çœŸå®è¡Œæ•°ï¼ˆåªæ˜¯è¿‘ä¼¼å€¼ï¼ŒCOUNT(*) ä¼šå…¨è¡¨æ‰«æï¼‰ MyISAM ç»´æŠ¤äº†è¡Œæ•°ï¼ˆCOUNT(*) å¾ˆå¿«ï¼‰ è¡Œæ•°ç»Ÿè®¡å¯¹å¤§è¡¨å¯èƒ½éå¸¸æ…¢ï¼Œéœ€è¦æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©æ–¹æ¡ˆ äºŒã€ç»Ÿè®¡è¡Œæ•°çš„å‡ ç§æ–¹å¼ 1ï¸âƒ£ COUNT(*) ï¼ˆæœ€å¸¸ç”¨ï¼Œä½†å¯èƒ½æ…¢ï¼‰ SELECT COUNT(*) FROM user; ç‰¹ç‚¹ï¼š\nç²¾ç¡®å€¼ å…¨è¡¨æ‰«æï¼ˆå¤§è¡¨æ…¢ï¼‰ InnoDB ä¼šåšè¡Œé”ï¼Œå¯èƒ½å½±å“å¹¶å‘ 2ï¸âƒ£ COUNT(ä¸»é”®åˆ—) / COUNT(åˆ—) SELECT COUNT(id) FROM user; ç‰¹ç‚¹ï¼š\nå¯¹ NOT NULL åˆ—ï¼Œæ•ˆæœä¸ COUNT(*) ä¸€æ · å¯¹å¯ NULL åˆ—ï¼Œä¼šå¿½ç•¥ NULL InnoDB æ€§èƒ½ä¾ç„¶æ…¢ï¼ˆå…¨è¡¨æ‰«æï¼‰ 3ï¸âƒ£ è¿‘ä¼¼ç»Ÿè®¡ï¼šINFORMATION_SCHEMA æˆ– sys åº“ SELECT table_rows FROM information_schema.tables WHERE table_schema=\u0026#39;test\u0026#39; AND table_name=\u0026#39;user\u0026#39;; ç‰¹ç‚¹ï¼š\néå¸¸å¿« åªæ˜¯ä¼°ç®—å€¼ é€‚åˆå¤§è¡¨åš æ¯æ—¥ç»Ÿè®¡ / æ•°æ®ç›‘æ§ æ¯å¤©æ‰§è¡Œä¸€æ¬¡è¶³å¤Ÿ 4ï¸âƒ£ ç´¯è®¡è®¡æ•°è¡¨ï¼ˆä¸šåŠ¡çº§æ–¹æ¡ˆï¼‰ ç»´æŠ¤ä¸€ä¸ª è¡Œæ•°ç»Ÿè®¡è¡¨ æ¯æ¬¡ INSERT / DELETE / TRUNCATE åŒæ­¥æ›´æ–° é€‚åˆå¤§è¡¨ / OLAP åœºæ™¯ ç¤ºä¾‹ï¼š\nCREATE TABLE table_count ( table_name VARCHAR(64) PRIMARY KEY, row_count BIGINT ); -- æ¯æ¬¡å¢åˆ åŒæ­¥æ›´æ–° UPDATE table_count SET row_count = row_count + 1 WHERE table_name=\u0026#39;user\u0026#39;; ä¼˜ç‚¹ï¼š\nç»Ÿè®¡å®æ—¶ æ— éœ€å…¨è¡¨æ‰«æ ç¼ºç‚¹ï¼š\néœ€åœ¨åº”ç”¨æˆ–è§¦å‘å™¨ç»´æŠ¤ å®¹æ˜“å‡ºé”™ï¼ˆäº‹åŠ¡å¼‚å¸¸ï¼‰ 5ï¸âƒ£ MySQL 8 æ–°ç‰¹æ€§ï¼šç»Ÿè®¡ä¿¡æ¯è¾…åŠ©æŸ¥è¯¢ ANALYZE TABLE user; å¯è·å– ä¼°ç®—è¡Œæ•°ã€ç´¢å¼•åˆ†å¸ƒã€æ•°æ®åˆ†å¸ƒ å¯ç»“åˆ EXPLAIN åšä¼˜åŒ– ä¸‰ã€æ¯å¤©ç»Ÿè®¡ä¸€æ¬¡æ¨èæ–¹å¼ å¤§è¡¨æ¨èï¼šINFORMATION_SCHEMA.tables.table_rows æˆ– ä¸šåŠ¡ç´¯è®¡è¡¨ ä¸­å°è¡¨ï¼šCOUNT(*) ç²¾ç¡®ç»Ÿè®¡æ²¡é—®é¢˜ æŠ¥è¡¨ / OLAPï¼šæ¯å¤©ä¸€æ¬¡ï¼Œå¢é‡æ›´æ–°åˆ°ç»Ÿè®¡è¡¨ï¼Œé¿å…é«˜å³°æœŸæ‰«æ å››ã€æ€§èƒ½ä¼˜åŒ–å»ºè®® é¿å…é«˜å³°æœŸå…¨è¡¨ COUNT\nå½±å“äº‹åŠ¡å¹¶å‘ ç»Ÿè®¡è¡¨ + è§¦å‘å™¨æˆ–åº”ç”¨é€»è¾‘æ›´æ–°\nç²¾å‡† + é«˜æ•ˆ ç»“åˆç¼“å­˜ï¼ˆRedis / Memcachedï¼‰\nç›‘æ§ / é¢‘ç¹æŸ¥è¯¢ä¸ hit æ•°æ®åº“ ä½¿ç”¨è¿‘ä¼¼ç®—æ³•\nHyperLogLog ç­‰ï¼Œç”¨äºå¤§è§„æ¨¡ç»Ÿè®¡ï¼ˆç™¾ä¸‡çº§ä»¥ä¸Šè¡Œï¼‰ äº”ã€å¸¸è§é—®é¢˜ Q1ï¼šInnoDB ä¸ºä»€ä¹ˆ COUNT(*) æ…¢ï¼Ÿ\nå› ä¸º InnoDB ä¸ç»´æŠ¤çœŸå®è¡Œæ•°ï¼Œéœ€è¦å…¨è¡¨æ‰«æã€‚\nQ2ï¼šä¿¡æ¯æ¨¡å¼çš„ table_rows èƒ½ç”¨å—ï¼Ÿ\nå¯ä»¥ï¼Œä½†åªä¼°ç®—ï¼Œä¸ç²¾ç¡®ã€‚\nQ3ï¼šå¦‚ä½•æ¯å¤©ç»Ÿè®¡å¤§è¡¨è¡Œæ•°ï¼Ÿ\nä½¿ç”¨ table_rows ä¼°ç®— + ç´¯è®¡è¡¨ + å®šæ—¶ä»»åŠ¡ï¼Œé¿å…é«˜å³°æ‰«æã€‚\nQ4ï¼šä¸ºä»€ä¹ˆ MyISAM COUNT(*) å¿«ï¼Ÿ\nMyISAM è®°å½•äº†è¡¨è¡Œæ•°ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰«ææ•°æ®ã€‚\nå…­ã€æ¨èæ–¹æ¡ˆæ€»ç»“ åœºæ™¯ æ¨èæ–¹å¼ ç²¾ç¡® æ€§èƒ½ å°è¡¨ / ä¸é¢‘ç¹ COUNT(*) âœ… å¯ä»¥æ¥å— å¤§è¡¨ / æ—¥ç»Ÿè®¡ table_rows / ç´¯è®¡è¡¨ âŒ/âœ… é«˜ OLAP / æ—¥æŠ¥ ç´¯è®¡è¡¨ + å¢é‡ âœ… é«˜ è¿‘ä¼¼åˆ†æ HyperLogLog âŒ é«˜ ","description":"MySQL ç»Ÿè®¡è¡¨çš„è¡Œæ•°æœ‰å¤šå°‘æ¡ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼Ÿæ¯å¤©ç»Ÿè®¡ä¸€æ¬¡æ¨èç”¨ä»€ä¹ˆæ–¹å¼ï¼Ÿ\nä¸€ã€ä¸ºä»€ä¹ˆç»Ÿè®¡è¡Œæ•°ä¸ç®€å•ï¼Ÿ InnoDB ä¸ç»´æŠ¤çœŸå®è¡Œæ•°ï¼ˆåªæ˜¯è¿‘ä¼¼å€¼ï¼ŒCOUNT(*) ä¼šå…¨è¡¨æ‰«æï¼‰ MyISAM ç»´æŠ¤äº†è¡Œæ•°ï¼ˆCOUNT(*) å¾ˆå¿«ï¼‰ è¡Œæ•°ç»Ÿè®¡å¯¹å¤§è¡¨å¯èƒ½éå¸¸æ…¢ï¼Œéœ€è¦æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©æ–¹æ¡ˆ äºŒã€ç»Ÿè®¡è¡Œæ•°çš„å‡ ç§æ–¹å¼ 1ï¸âƒ£ COUNT(*) ï¼ˆæœ€å¸¸ç”¨ï¼Œä½†å¯èƒ½æ…¢ï¼‰ SELECT COUNT(*) FROM user; ç‰¹ç‚¹ï¼š\nç²¾ç¡®å€¼ å…¨è¡¨æ‰«æï¼ˆå¤§è¡¨æ…¢ï¼‰ InnoDB ä¼šåšè¡Œé”ï¼Œå¯èƒ½å½±å“å¹¶å‘ 2ï¸âƒ£ COUNT(ä¸»é”®åˆ—) / COUNT(åˆ—) SELECT COUNT(id) FROM user; ç‰¹ç‚¹ï¼š\n"},{"id":311,"href":"/database/mysql/create-table/","title":"MySQL CREATE TABLE","parent":"MySQL","content":" ä¸€ã€CREATE TABLE æ˜¯ä»€ä¹ˆï¼Ÿ CREATE TABLE ç”¨äº å®šä¹‰è¡¨ç»“æ„ï¼Œä¸€æ¬¡æ€§ç¡®å®šï¼š\nè¡¨å å­—æ®µç±»å‹ æ˜¯å¦å¯ç©º é»˜è®¤å€¼ ä¸»é”® / å”¯ä¸€é”® / æ™®é€šç´¢å¼• å¤–é”® å­˜å‚¨å¼•æ“ å­—ç¬¦é›† / æ’åºè§„åˆ™ ğŸ“Œ å»ºè¡¨æ˜¯å¦åˆç†ï¼Œå†³å®šäº†æ•°æ®åº“ 80% çš„æ€§èƒ½ä¸Šé™\näºŒã€åŸºç¡€è¯­æ³•ç»“æ„ï¼ˆæ ‡å‡†æ¨¡æ¿ï¼‰ CREATE TABLE table_name ( column_name data_type [column_constraint], ... table_constraint ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; ä¸‰ã€å­—æ®µå®šä¹‰è¯¦è§£ï¼ˆæœ€é‡è¦ï¼‰ 1ï¸âƒ£ å­—æ®µåŸºæœ¬å±æ€§ id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®\u0026#39;, å¸¸ç”¨å…³é”®å­—ï¼š\nå…³é”®å­— å«ä¹‰ NOT NULL ä¸å…è®¸ NULL NULL å…è®¸ NULL DEFAULT é»˜è®¤å€¼ AUTO_INCREMENT è‡ªå¢ COMMENT å­—æ®µæ³¨é‡Š 2ï¸âƒ£ æ•°æ®ç±»å‹é€‰å‹ ğŸ”¢ æ•´æ•°ç±»å‹ ç±»å‹ èŒƒå›´ å¤‡æ³¨ TINYINT -128~127 çŠ¶æ€ä½ INT ~21äº¿ å¸¸ç”¨ BIGINT æ›´å¤§ ID / é›ªèŠ± âš ï¸ INT(11) çš„ 11 ä¸æ˜¯é•¿åº¦é™åˆ¶ï¼ˆä»…æ˜¾ç¤ºå®½åº¦ï¼ŒMySQL 8 å·²åºŸå¼ƒï¼‰\nğŸ”¤ å­—ç¬¦ä¸²ç±»å‹ ç±»å‹ ç‰¹ç‚¹ CHAR å®šé•¿ VARCHAR å˜é•¿ï¼ˆæ¨èï¼‰ TEXT å¤§æ–‡æœ¬ï¼ˆä¸å»ºè®®é¢‘ç¹æŸ¥è¯¢ï¼‰ ğŸ“Œ å»ºè®®ï¼š\næ™®é€šå­—ç¬¦ä¸²ï¼šVARCHAR å¤§æ–‡æœ¬ï¼šTEXTï¼ˆå•ç‹¬è¡¨ï¼‰ ğŸ•’ æ—¶é—´ç±»å‹ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ ç±»å‹ è¯´æ˜ DATE æ—¥æœŸ DATETIME æ—¥æœŸæ—¶é—´ï¼ˆæ¨èï¼‰ TIMESTAMP å¸¦æ—¶åŒºã€2038 é—®é¢˜ ğŸ“Œ ä¸šåŠ¡æ—¶é—´å­—æ®µä¼˜å…ˆ DATETIME\nğŸ’° ç²¾åº¦ç±»å‹ ç±»å‹ ç”¨é€” DECIMAL(10,2) é‡‘é¢ FLOAT / DOUBLE éç²¾ç¡® 3ï¸âƒ£ UNSIGNED çš„é‡è¦æ€§ id BIGINT UNSIGNED å¯ç”¨èŒƒå›´ç¿»å€ ä¸å…è®¸è´Ÿæ•° æ¨èç”¨äº ID / è®¡æ•°å™¨ å››ã€çº¦æŸï¼ˆConstraintsï¼‰ 1ï¸âƒ£ ä¸»é”®ï¼ˆPRIMARY KEYï¼‰ PRIMARY KEY (id) è§„åˆ™ï¼š\nå”¯ä¸€ éç©º InnoDB èšç°‡ç´¢å¼• ğŸ“Œ å»ºè®®ä½¿ç”¨ BIGINT UNSIGNED è‡ªå¢ / é›ªèŠ± ID\n2ï¸âƒ£ å”¯ä¸€çº¦æŸï¼ˆUNIQUEï¼‰ UNIQUE KEY uk_email (email) è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼• å…è®¸å¤šä¸ª NULLï¼ˆInnoDBï¼‰ 3ï¸âƒ£ å¤–é”®ï¼ˆä¸æ¨èé«˜å¹¶å‘ä½¿ç”¨ï¼‰ CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES user(id) ğŸ“Œ ç”Ÿäº§å»ºè®®ï¼š\né€»è¾‘å¤–é”®ï¼ˆä»£ç æ§åˆ¶ï¼‰ é¿å…ç‰©ç†å¤–é”®å¸¦æ¥çš„é”å’Œæ€§èƒ½é—®é¢˜ 4ï¸âƒ£ CHECKï¼ˆMySQL 8 å¼€å§‹æ”¯æŒï¼‰ CHECK (status IN (0,1)) äº”ã€ç´¢å¼•å®šä¹‰ï¼ˆå»ºè¡¨å³ä¼˜åŒ–ï¼‰ 1ï¸âƒ£ æ™®é€šç´¢å¼• KEY idx_name (name) 2ï¸âƒ£ è”åˆç´¢å¼•ï¼ˆéå¸¸é‡è¦ï¼‰ KEY idx_a_b (a, b) éµå¾ª æœ€å·¦å‰ç¼€åŸåˆ™\n3ï¸âƒ£ è¦†ç›–ç´¢å¼•ä¼˜åŒ– KEY idx_name_age (name, age) å…­ã€è¡¨çº§é€‰é¡¹ï¼ˆENGINE / CHARSETï¼‰ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; ğŸ”§ å­˜å‚¨å¼•æ“ å¼•æ“ è¯´æ˜ InnoDB é»˜è®¤ï¼Œäº‹åŠ¡ / è¡Œé” MyISAM ä¸æ”¯æŒäº‹åŠ¡ï¼ˆä¸æ¨èï¼‰ ğŸ”¤ å­—ç¬¦é›†é€‰å‹ utf8mb4ï¼šæ”¯æŒ Emojiï¼ˆå¼ºçƒˆæ¨èï¼‰ ä¸è¦ç”¨ utf8ï¼ˆä¸å®Œæ•´ï¼‰ ä¸ƒã€å®Œæ•´æ ‡å‡†å»ºè¡¨ç¤ºä¾‹ï¼ˆä¼ä¸šæ¨¡æ¿ï¼‰ CREATE TABLE user ( id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®\u0026#39;, username VARCHAR(64) NOT NULL COMMENT \u0026#39;ç”¨æˆ·å\u0026#39;, email VARCHAR(128) NOT NULL COMMENT \u0026#39;é‚®ç®±\u0026#39;, status TINYINT NOT NULL DEFAULT 1 COMMENT \u0026#39;çŠ¶æ€\u0026#39;, balance DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT \u0026#39;ä½™é¢\u0026#39;, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;åˆ›å»ºæ—¶é—´\u0026#39;, updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;æ›´æ–°æ—¶é—´\u0026#39;, PRIMARY KEY (id), UNIQUE KEY uk_email (email), KEY idx_username_status (username, status) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=\u0026#39;ç”¨æˆ·è¡¨\u0026#39;; å…«ã€CREATE TABLE å¸¸è§å‘ âŒ 1. æ²¡æœ‰ä¸»é”® InnoDB ä¼šåˆ›å»ºéšè—ä¸»é”® æ€§èƒ½å·® ä¸»ä»å¤åˆ¶é—®é¢˜å¤š âŒ 2. TEXT å­—æ®µå»ºç´¢å¼• å ç©ºé—´ æ…¢ å¿…é¡»å‰ç¼€ç´¢å¼• âŒ 3. é»˜è®¤ NULL æ»¥ç”¨ NULL åˆ¤æ–­å¤æ‚ ç´¢å¼•æ•ˆç‡ä½ âŒ 4. æ²¡å»ºç´¢å¼•å°±ä¸Šçº¿ UPDATE / DELETE é”è¡¨ æ…¢æŸ¥è¯¢é¢‘å‘ âŒ 5. å­—ç¬¦é›†æ··ä¹± æ’åºä¸ä¸€è‡´ ç´¢å¼•å¤±æ•ˆ è”è¡¨å¼‚å¸¸ ä¹ã€å»ºè¡¨æœ€ä½³å®è·µ è¡¨å¿…æœ‰ä¸»é”® ä¸»é”®é€’å¢ï¼ˆå‡å°‘é¡µåˆ†è£‚ï¼‰ å­—æ®µå°½é‡ NOT NULL + DEFAULT é‡‘é¢ç”¨ DECIMAL çŠ¶æ€ç”¨ TINYINT æ—¶é—´ç»Ÿä¸€ DATETIME ç´¢å¼•å»ºåœ¨ WHERE / JOIN / ORDER BY ä¸Š ç¦ç”¨ç‰©ç†å¤–é”® åã€å…¶å®ƒ Qï¼šä¸ºä»€ä¹ˆ InnoDB å¿…é¡»æœ‰ä¸»é”®ï¼Ÿ Aï¼šä¸»é”®æ˜¯èšç°‡ç´¢å¼•ï¼Œå†³å®šæ•°æ®ç‰©ç†é¡ºåºã€‚\nQï¼šVARCHAR æœ€å¤§å¤šé•¿ï¼Ÿ Aï¼šç†è®º 65535 å­—èŠ‚ï¼ˆå—å­—ç¬¦é›†å½±å“ï¼‰\nQï¼šAUTO_INCREMENT ä¸€å®šè¿ç»­å—ï¼Ÿ Aï¼šä¸ä¿è¯ï¼ˆå›æ»š/å¹¶å‘ï¼‰\nQï¼šä¸ºä»€ä¹ˆä¸æ¨èå¤–é”®ï¼Ÿ Aï¼šæ€§èƒ½å·®ã€é”å¤šã€æ‰©å±•æ€§å·®\nğŸ”š æ€»ç»“ CREATE TABLE æ˜¯æ•°æ®åº“è®¾è®¡çš„èµ·ç‚¹ï¼Œç´¢å¼•å’Œå­—æ®µç±»å‹çš„é€‰æ‹©ï¼Œç›´æ¥å†³å®šç³»ç»Ÿçš„ä¸Šé™ã€‚\n","description":" ä¸€ã€CREATE TABLE æ˜¯ä»€ä¹ˆï¼Ÿ CREATE TABLE ç”¨äº å®šä¹‰è¡¨ç»“æ„ï¼Œä¸€æ¬¡æ€§ç¡®å®šï¼š\nè¡¨å å­—æ®µç±»å‹ æ˜¯å¦å¯ç©º é»˜è®¤å€¼ ä¸»é”® / å”¯ä¸€é”® / æ™®é€šç´¢å¼• å¤–é”® å­˜å‚¨å¼•æ“ å­—ç¬¦é›† / æ’åºè§„åˆ™ ğŸ“Œ å»ºè¡¨æ˜¯å¦åˆç†ï¼Œå†³å®šäº†æ•°æ®åº“ 80% çš„æ€§èƒ½ä¸Šé™\näºŒã€åŸºç¡€è¯­æ³•ç»“æ„ï¼ˆæ ‡å‡†æ¨¡æ¿ï¼‰ CREATE TABLE table_name ( column_name data_type [column_constraint], ... table_constraint ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci; ä¸‰ã€å­—æ®µå®šä¹‰è¯¦è§£ï¼ˆæœ€é‡è¦ï¼‰ 1ï¸âƒ£ å­—æ®µåŸºæœ¬å±æ€§ id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT \u0026#39;ä¸»é”®\u0026#39;, å¸¸ç”¨å…³é”®å­—ï¼š\n"},{"id":312,"href":"/database/mysql/explain/","title":"MySQL EXPLAIN","parent":"MySQL","content":"å®˜æ–¹æ–‡æ¡£ï¼š\nhttps://dev.mysql.com/doc/refman/8.0/en/explain.html https://dev.mysql.com/doc/refman/8.4/en/explain.html https://www.mysql.net.cn/doc/refman/8.0/en/explain.html å…¶å®ƒæ–‡æ¡£ï¼š\nMySQL EXPLAIN è¯¦è§£ MySQL EXPLAIN åº”ç”¨è¯¦è§£ ä¸€æ–‡çœ‹æ‡‚ MySQL ä¸­ EXPLAIN å…³é”®å­—çš„ä½œç”¨ MySQL EXPLAIN æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ SQL æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„å·¥å…·ï¼Œå®ƒæ¨¡æ‹Ÿä¼˜åŒ–å™¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œä¸ä¼šå®é™…è¿è¡Œï¼Œè€Œæ˜¯è¿”å›å…³äºè¡¨è®¿é—®é¡ºåºã€ç´¢å¼•ä½¿ç”¨ã€æ‰«æè¡Œæ•°ç­‰æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸®åŠ©è¯†åˆ«å’Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆã€‚\nEXPLAIN çš„ä½œç”¨ æ˜¾ç¤º MySQL å¦‚ä½•å¤„ç† SQL è¯­å¥ã€‚ åˆ†ææŸ¥è¯¢è¯­å¥æˆ–è¡¨ç»“æ„çš„æ€§èƒ½ç“¶é¢ˆã€‚ æŸ¥çœ‹ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè·¯å¾„æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ EXPLAIN è¾“å‡ºçš„ä¸»è¦å­—æ®µ (ç¤ºä¾‹) id: æŸ¥è¯¢çš„åºåˆ—å·ã€‚ select_type: æŸ¥è¯¢ç±»å‹ï¼ˆSIMPLE, PRIMARY, SUBQUERY, UNION ç­‰ï¼‰ã€‚ table: è¡¨åæˆ–åˆ«åã€‚ type: è®¿é—®ç±»å‹ï¼ˆä»å¥½åˆ°åï¼šsystem, const, eq_ref, ref, range, index, ALLï¼‰ã€‚ possible_keys: å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•ã€‚ key: å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚ key_len: ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦ã€‚ ref: ä¸ç´¢å¼•æ¯”è¾ƒçš„åˆ—æˆ–å¸¸é‡ã€‚ rows: ä¼°ç®—çš„æ‰«æè¡Œæ•°ã€‚ Extra: é¢å¤–ä¿¡æ¯ï¼ˆå¦‚ Using index, Using filesort, Using temporary ç­‰ï¼‰ã€‚ ä½¿ç”¨ç¤ºä¾‹ EXPLAIN SELECT * FROM users WHERE status = \u0026#39;active\u0026#39; AND created_at \u0026gt; \u0026#39;2025-01-01\u0026#39;; ä¸€å¥è¯å®šä½ EXPLAIN æ˜¯ MySQL æ‰§è¡Œè®¡åˆ’åˆ†æå·¥å…·ï¼Œç”¨æ¥åˆ¤æ–­ SQL æœ‰æ²¡æœ‰èµ°ç´¢å¼•ã€æ€ä¹ˆèµ°ã€ä»£ä»·å¤šå¤§ã€æ…¢åœ¨å“ªé‡Œã€‚\nä¸€ã€EXPLAIN æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ EXPLAIN ç”¨äºå›ç­” 6 ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š\nç”¨äº†å“ªäº›è¡¨ï¼Ÿ è¡¨çš„è®¿é—®é¡ºåºï¼Ÿ ç”¨æ²¡ç”¨ç´¢å¼•ï¼Ÿç”¨çš„æ˜¯å“ªä¸ªï¼Ÿ æ˜¯å…¨è¡¨æ‰«æè¿˜æ˜¯ç´¢å¼•æ‰«æï¼Ÿ é¢„è®¡æ‰«æå¤šå°‘è¡Œï¼Ÿ æœ‰æ²¡æœ‰é¢å¤–å¼€é”€ï¼ˆæ’åºã€ä¸´æ—¶è¡¨ã€å›è¡¨ç­‰ï¼‰ï¼Ÿ äºŒã€EXPLAIN åŸºæœ¬ç”¨æ³• EXPLAIN SELECT * FROM user WHERE id = 1; MySQL 8 æ¨èï¼š\nEXPLAIN ANALYZE SELECT * FROM user WHERE id = 1; EXPLAIN ANALYZE ä¼š çœŸæ­£æ‰§è¡Œ SQLï¼Œå¹¶ç»™å‡ºçœŸå®è€—æ—¶ï¼ˆéå¸¸é‡è¦ï¼‰\nä¸‰ã€EXPLAIN è¾“å‡ºå­—æ®µæ€»è§ˆï¼ˆé‡ç‚¹ï¼‰ å¸¸è§å­—æ®µï¼ˆæŒ‰é‡è¦ç¨‹åº¦ï¼‰ï¼š\nå­—æ®µ é‡è¦æ€§ å«ä¹‰ id â­â­â­ æŸ¥è¯¢å±‚çº§ / æ‰§è¡Œé¡ºåº select_type â­â­â­ æŸ¥è¯¢ç±»å‹ table â­â­ è®¿é—®çš„è¡¨ type â­â­â­â­ è®¿é—®æ–¹å¼ï¼ˆæœ€é‡è¦ï¼‰ possible_keys â­â­ å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• key â­â­â­â­ å®é™…ä½¿ç”¨çš„ç´¢å¼• key_len â­â­ ç´¢å¼•ä½¿ç”¨é•¿åº¦ ref â­â­ ç´¢å¼•æ¯”è¾ƒæ–¹å¼ rows â­â­â­ é¢„è®¡æ‰«æè¡Œæ•° filtered â­â­ æ¡ä»¶è¿‡æ»¤æ¯”ä¾‹ Extra â­â­â­â­ é¢å¤–ä¿¡æ¯ï¼ˆéå¸¸å…³é”®ï¼‰ å››ã€idï¼šæ‰§è¡Œé¡ºåºï¼ˆéå¸¸å®¹æ˜“è€ƒï¼‰ è§„åˆ™æ€»ç»“\nid è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ id ç›¸åŒ -\u0026gt; ä»ä¸Šå¾€ä¸‹æ‰§è¡Œ å­æŸ¥è¯¢ id \u0026gt; å¤–å±‚æŸ¥è¯¢ ç¤ºä¾‹ï¼š\nSELECT * FROM A WHERE id IN ( SELECT id FROM B ); æ‰§è¡Œé¡ºåºï¼š\nå­æŸ¥è¯¢ Bï¼ˆid=2ï¼‰ å¤–å±‚æŸ¥è¯¢ Aï¼ˆid=1ï¼‰ äº”ã€select_typeï¼šæŸ¥è¯¢ç±»å‹ ç±»å‹ è¯´æ˜ SIMPLE ç®€å•æŸ¥è¯¢ï¼ˆæ— å­æŸ¥è¯¢ï¼‰ PRIMARY ä¸»æŸ¥è¯¢ SUBQUERY å­æŸ¥è¯¢ DERIVED æ´¾ç”Ÿè¡¨ï¼ˆFROM å­æŸ¥è¯¢ï¼‰ UNION UNION ä¸­çš„ç¬¬äºŒä¸ªæŸ¥è¯¢ UNION RESULT UNION åˆå¹¶ç»“æœ âš ï¸ DERIVED å¸¸æ˜¯æ€§èƒ½é£é™©ç‚¹ï¼ˆä¼šç”Ÿæˆä¸´æ—¶è¡¨ï¼‰\nå…­ã€typeï¼šè®¿é—®æ–¹å¼ï¼ˆæœ€é‡è¦å­—æ®µï¼‰ ä»å¥½åˆ°åæ’åºï¼š\ntype è¯´æ˜ system ç³»ç»Ÿè¡¨ const ä¸»é”® / å”¯ä¸€ç´¢å¼•ç­‰å€¼ eq_ref å”¯ä¸€ç´¢å¼• JOIN ref éå”¯ä¸€ç´¢å¼• range èŒƒå›´æ‰«æ index å…¨ç´¢å¼•æ‰«æ ALL å…¨è¡¨æ‰«æ âŒ è®°å¿†å£è¯€ï¼š\nconst \u0026gt; eq_ref \u0026gt; ref \u0026gt; range \u0026gt; index \u0026gt; ALL\nç¤ºä¾‹å¯¹æ¯”\nâœ… å¥½ SQL\nSELECT * FROM user WHERE id = 1; type = const âš ï¸ å¯æ¥å—\nSELECT * FROM user WHERE age BETWEEN 20 AND 30; type = range âŒ å±é™©\nSELECT * FROM user WHERE name LIKE \u0026#39;%abc\u0026#39;; type = ALL ä¸ƒã€possible_keys \u0026amp; keyï¼šæœ‰æ²¡æœ‰â€œé€‰é”™ç´¢å¼•â€ possible_keysï¼šç†è®ºä¸Šèƒ½ç”¨çš„ç´¢å¼• keyï¼šå®é™…ç”¨åˆ°çš„ç´¢å¼• âš ï¸ å¦‚æœï¼š\npossible_keys = idx_a, idx_b key = NULL è¯´æ˜ï¼šä¼˜åŒ–å™¨åˆ¤æ–­å…¨è¡¨æ‰«ææ›´å¿«ï¼ˆå¾ˆå±é™©ï¼‰\nå…«ã€key_lenï¼šç´¢å¼•ç”¨äº†å¤šå°‘ï¼Ÿ åæ˜  è”åˆç´¢å¼•å‘½ä¸­åˆ°å“ªä¸€åˆ— å•ä½æ˜¯ å­—èŠ‚ ä¾‹å­ï¼š\nINDEX idx(a, b, c) WHERE a=1 AND b=2 -\u0026gt; key_len = a + b\nâš ï¸ ç”¨äºåˆ¤æ–­ æœ€å·¦å‰ç¼€æ˜¯å¦å®Œæ•´ä½¿ç”¨\nä¹ã€refï¼šç´¢å¼•åŒ¹é…æ–¹å¼ å¸¸è§å€¼ï¼š\nref å€¼ å«ä¹‰ const å¸¸é‡åŒ¹é… table.col è¡¨å­—æ®µæ¯”è¾ƒ func å‡½æ•°è®¡ç®—ï¼ˆé€šå¸¸ä¸å¥½ï¼‰ åã€rowsï¼šæ‰«æè¡Œæ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼‰ è¿™æ˜¯ä¼˜åŒ–æœ€ç›´è§‚æŒ‡æ ‡ SQL ä¼˜åŒ–çš„æ ¸å¿ƒç›®æ ‡ï¼šå‡å°‘ rows âš ï¸ rows å¾ˆå°ä½† SQL æ…¢ï¼š\nå›è¡¨å¤š filesort ä¸´æ—¶è¡¨ ç½‘ç»œ IO åä¸€ã€filteredï¼šè¿‡æ»¤æ¯”ä¾‹ï¼ˆMySQL 8 å¸¸è§ï¼‰ filtered = 10 è¡¨ç¤ºï¼š\næ‰«æçš„ rows ä¸­ï¼Œåªæœ‰ 10% èƒ½å‘½ä¸­ WHERE æ¡ä»¶\nrows Ã— filtered â‰ˆ æœ€ç»ˆç»“æœè¡Œæ•°\nåäºŒã€Extraï¼šæœ€é‡è¦çš„â€œå±é™©ä¿¡å·â€ âœ… å¥½çš„ Extra Extra å«ä¹‰ Using index è¦†ç›–ç´¢å¼•ï¼ˆéå¸¸å¥½ï¼‰ Using where ä½¿ç”¨äº†æ¡ä»¶è¿‡æ»¤ Using index condition ICP ä¸‹æ¨ âŒ å±é™©çš„ Extraï¼ˆå¿…é¡»ä¼˜åŒ–ï¼‰ Extra å«ä¹‰ Using filesort é¢å¤–æ’åºï¼ˆæ…¢ï¼‰ Using temporary ä½¿ç”¨ä¸´æ—¶è¡¨ Range checked for each record æ¯è¡Œé‡æ–°è®¡ç®—ç´¢å¼• Using join buffer Join æœªèµ°ç´¢å¼• åä¸‰ã€EXPLAIN ANALYZEï¼ˆMySQL 8 å¼ºçƒˆæ¨èï¼‰ EXPLAIN ANALYZE SELECT * FROM orders WHERE user_id = 100; è¾“å‡ºï¼š\nå®é™…æ‰§è¡Œæ—¶é—´ å®é™…æ‰«æè¡Œæ•° çœŸå®æˆæœ¬ ğŸ“Œ å¯¹æ¯” EXPLAIN å’Œ ANALYZEï¼š\nEXPLAIN -\u0026gt; é¢„ä¼° ANALYZE -\u0026gt; å®é™… åå››ã€JOIN çš„ EXPLAIN è¯»æ³• åŸåˆ™ï¼š\nå°è¡¨é©±åŠ¨å¤§è¡¨ JOIN å­—æ®µå¿…é¡»æœ‰ç´¢å¼• è¢«é©±åŠ¨è¡¨ type è‡³å°‘ ref SELECT * FROM order o JOIN user u ON o.user_id = u.id; EXPLAIN åº”è¯¥çœ‹åˆ°ï¼š\nu.id ä½¿ç”¨ PRIMARY o.user_id æœ‰ç´¢å¼• åäº”ã€å…¸å‹æ…¢ SQL åœºæ™¯ä¸ EXPLAIN å®šä½ 1ï¸âƒ£ LIKE \u0026lsquo;%xxx%\u0026rsquo; type=ALL è§£å†³ï¼š\næ”¹æˆ xxx% ä½¿ç”¨å…¨æ–‡ç´¢å¼• ES / æœç´¢å¼•æ“ 2ï¸âƒ£ WHERE ä½¿ç”¨å‡½æ•° WHERE DATE(create_time)=\u0026#39;2024-01-01\u0026#39; è§£å†³ï¼š\nWHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39; 3ï¸âƒ£ ORDER BY filesort è§£å†³ï¼š\nwhere + order by ç”¨åŒä¸€ä¸ªç´¢å¼• é¿å…è·¨ç´¢å¼•æ’åº 4ï¸âƒ£ OR å¯¼è‡´ç´¢å¼•å¤±æ•ˆ è§£å†³ï¼š\næ‹†æˆ UNION ä½¿ç”¨åŒä¸€ç´¢å¼•å­—æ®µ åå…­ã€EXPLAIN ä¼˜åŒ–å£è¯€ ä¸€çœ‹ typeï¼ŒäºŒçœ‹ keyï¼Œä¸‰çœ‹ rowsï¼Œå››çœ‹ Extra\nç›®æ ‡ï¼š\ntype â‰¥ range rows è¶Šå°è¶Šå¥½ æ²¡æœ‰ Using filesort / temporary èƒ½ Using index å°±æœ€å¥½ åä¸ƒã€å…¶å®ƒ Qï¼šEXPLAIN çœ‹å“ªäº›å­—æ®µæœ€é‡è¦ï¼Ÿ\nAï¼štypeã€keyã€rowsã€Extra\nQï¼štype=ALL ä¸€å®šæ…¢å—ï¼Ÿ\nAï¼šå¤§è¡¨ä¸€å®šæ…¢ï¼Œå°è¡¨å¯æ¥å—\nQï¼šUsing index ä¸€å®šæœ€å¥½å—ï¼Ÿ\nAï¼šæ˜¯ï¼ˆè¦†ç›–ç´¢å¼•ï¼Œé¿å…å›è¡¨ï¼‰\nQï¼šEXPLAIN èƒ½çœ‹åˆ°é”å—ï¼Ÿ\nAï¼šä¸èƒ½ï¼ˆéœ€ performance_schemaï¼‰\nğŸ”š æ€»ç»“ EXPLAIN æ˜¯ SQL æ€§èƒ½çš„â€œX å…‰ç‰‡â€ï¼ŒçœŸæ­£çš„é«˜æ‰‹ä¸æ˜¯ä¼šå†™ SQLï¼Œè€Œæ˜¯ä¼šè¯» EXPLAINã€‚\n","description":"å®˜æ–¹æ–‡æ¡£ï¼š\nhttps://dev.mysql.com/doc/refman/8.0/en/explain.html https://dev.mysql.com/doc/refman/8.4/en/explain.html https://www.mysql.net.cn/doc/refman/8.0/en/explain.html å…¶å®ƒæ–‡æ¡£ï¼š\nMySQL EXPLAIN è¯¦è§£ MySQL EXPLAIN åº”ç”¨è¯¦è§£ ä¸€æ–‡çœ‹æ‡‚ MySQL ä¸­ EXPLAIN å…³é”®å­—çš„ä½œç”¨ MySQL EXPLAIN æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ SQL æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„å·¥å…·ï¼Œå®ƒæ¨¡æ‹Ÿä¼˜åŒ–å™¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œä¸ä¼šå®é™…è¿è¡Œï¼Œè€Œæ˜¯è¿”å›å…³äºè¡¨è®¿é—®é¡ºåºã€ç´¢å¼•ä½¿ç”¨ã€æ‰«æè¡Œæ•°ç­‰æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯ï¼Œå¸®åŠ©è¯†åˆ«å’Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆã€‚\nEXPLAIN çš„ä½œç”¨ æ˜¾ç¤º MySQL å¦‚ä½•å¤„ç† SQL è¯­å¥ã€‚ åˆ†ææŸ¥è¯¢è¯­å¥æˆ–è¡¨ç»“æ„çš„æ€§èƒ½ç“¶é¢ˆã€‚ æŸ¥çœ‹ä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè·¯å¾„æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ EXPLAIN è¾“å‡ºçš„ä¸»è¦å­—æ®µ (ç¤ºä¾‹) id: æŸ¥è¯¢çš„åºåˆ—å·ã€‚ select_type: æŸ¥è¯¢ç±»å‹ï¼ˆSIMPLE, PRIMARY, SUBQUERY, UNION ç­‰ï¼‰ã€‚ table: è¡¨åæˆ–åˆ«åã€‚ type: è®¿é—®ç±»å‹ï¼ˆä»å¥½åˆ°åï¼šsystem, const, eq_ref, ref, range, index, ALLï¼‰ã€‚ possible_keys: å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•ã€‚ key: å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚ key_len: ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦ã€‚ ref: ä¸ç´¢å¼•æ¯”è¾ƒçš„åˆ—æˆ–å¸¸é‡ã€‚ rows: ä¼°ç®—çš„æ‰«æè¡Œæ•°ã€‚ Extra: é¢å¤–ä¿¡æ¯ï¼ˆå¦‚ Using index, Using filesort, Using temporary ç­‰ï¼‰ã€‚ ä½¿ç”¨ç¤ºä¾‹ EXPLAIN SELECT * FROM users WHERE status = \u0026#39;active\u0026#39; AND created_at \u0026gt; \u0026#39;2025-01-01\u0026#39;; ä¸€å¥è¯å®šä½ EXPLAIN æ˜¯ MySQL æ‰§è¡Œè®¡åˆ’åˆ†æå·¥å…·ï¼Œç”¨æ¥åˆ¤æ–­ SQL æœ‰æ²¡æœ‰èµ°ç´¢å¼•ã€æ€ä¹ˆèµ°ã€ä»£ä»·å¤šå¤§ã€æ…¢åœ¨å“ªé‡Œã€‚\n"},{"id":313,"href":"/database/mysql/join/","title":"MySQL Join","parent":"MySQL","content":" 1. ä»€ä¹ˆæ˜¯ JOINï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ JOIN ç”¨äºå°†ä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨æŒ‰å…³ç³»å­—æ®µå…³è”èµ·æ¥ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚\nSQL æ ‡å‡†æ”¯æŒçš„ JOIN ç±»å‹å¾ˆå¤šï¼Œä½†åœ¨ MySQL InnoDB ä¸­å®é™…ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ˜¯ï¼š\nINNER JOINï¼ˆå†…è¿æ¥ï¼‰ LEFT JOINï¼ˆå·¦å¤–è¿æ¥ï¼‰ RIGHT JOINï¼ˆå³å¤–è¿æ¥ï¼‰ CROSS JOINï¼ˆç¬›å¡å°”ç§¯ï¼‰ SELF JOINï¼ˆè‡ªè¿æ¥ï¼‰ ä»æœ¬è´¨ä¸Šè®²ï¼š\nJOIN = é©±åŠ¨è¡¨æ‰«æè¡Œ Ã— è¢«é©±åŠ¨è¡¨æŸ¥æ‰¾è¡Œï¼ˆNested Loop Joinï¼‰\nå…³é”®ç†è§£ï¼š\né€‰æ‹©é©±åŠ¨è¡¨éå¸¸é‡è¦ é©±åŠ¨è¡¨è¶Šå°è¶Šå¥½ è¢«é©±åŠ¨è¡¨å¿…é¡»æœ‰ç´¢å¼• 2. JOIN çš„æ‰§è¡Œæ–¹å¼ï¼ˆMySQL é‡è¦åº•å±‚åŸç†ï¼‰ MySQLï¼ˆInnoDBï¼‰JOIN æœ¬è´¨ä¸Šæ˜¯ Nested Loop Joinï¼ˆåµŒå¥—å¾ªç¯ï¼‰ï¼š\nfor row in é©±åŠ¨è¡¨: ç”¨ row çš„å…³è”å­—æ®µå»è¢«é©±åŠ¨è¡¨æŸ¥æ‰¾å¯¹åº”è®°å½• æŸ¥æ‰¾æ–¹å¼ä¾èµ–ï¼š\næ–¹å¼ åŸå›  æ€§èƒ½ Index Lookup è¢«é©±åŠ¨è¡¨æœ‰ç´¢å¼• ğŸš€ å¿«ï¼ˆæœ€ç†æƒ³ï¼‰ Block Nested Loopï¼ˆBNLï¼‰ è¢«é©±åŠ¨è¡¨æ²¡ç´¢å¼• ğŸŒ éå¸¸æ…¢ Hash JOINï¼ˆMySQL 8.0.18+ï¼‰ å¤§ JOINï¼Œè¢«ä¼˜åŒ–å™¨é€‰æ‹© ğŸš€ğŸš€ï¼ˆå¤§è¡¨é€‚ç”¨ï¼‰ InnoDB é»˜è®¤ä½¿ç”¨ Index Nested Loopï¼ˆæœ€å¸¸è§ã€æœ€éœ€ä¼˜åŒ–çš„æ¨¡å¼ï¼‰ã€‚\n3. ä¸åŒ JOIN çš„è¯­ä¹‰ï¼ˆç®€å• + éå¸¸å®ç”¨ç¤ºä¾‹ï¼‰ 3.1 INNER JOINï¼ˆæœ€å¸¸ç”¨ï¼‰ åªè¿”å›ä¸¤ä¸ªè¡¨éƒ½åŒ¹é…çš„è®°å½•ã€‚\nSELECT * FROM user u INNER JOIN order o ON u.id = o.user_id; ç»“æœï¼šäº¤é›†ã€‚\nåº”ç”¨åœºæ™¯ï¼š\næŸ¥ç”¨æˆ·å’Œè®¢å•çš„åŒ¹é…æ•°æ® 3.2 LEFT JOINï¼ˆç¬¬äºŒå¸¸ç”¨ï¼‰ è¿”å›å·¦è¡¨å…¨éƒ¨ + å³è¡¨èƒ½åŒ¹é…çš„éƒ¨åˆ†ï¼Œä¸åŒ¹é…ä¸º NULLã€‚\nSELECT * FROM user u LEFT JOIN order o ON u.id = o.user_id; åº”ç”¨åœºæ™¯ï¼š\næŸ¥ç”¨æˆ·æ˜¯å¦ä¸‹è¿‡è®¢å•ï¼ˆæ— è®¢å•ä¹Ÿè¦æ˜¾ç¤ºï¼‰ 3.3 RIGHT JOIN è¿”å›å³è¡¨å…¨éƒ¨ã€‚\næ¨èé¿å… RIGHT JOIN -\u0026gt; å¯ç­‰ä»·è½¬æ¢ä¸º LEFT JOINã€‚\n3.4 CROSS JOINï¼ˆç¬›å¡å°”ç§¯ï¼‰ è¿”å› m Ã— nã€‚\nå±é™©ï¼ˆå®¹æ˜“é€ æˆçˆ†ç‚¸æ€§æ•°æ®é‡ï¼‰\n3.5 SELF JOINï¼ˆè‡ªè¿æ¥ï¼‰ è¡¨å†…å…³è”ã€‚\nSELECT e.name, m.name FROM employee e LEFT JOIN employee m ON e.manager_id = m.id; 4. JOIN çš„æ‰§è¡Œè®¡åˆ’ï¼ˆéå¸¸å…³é”®ï¼‰ ä½¿ç”¨ EXPLAINï¼š\nEXPLAIN SELECT ... å…³é”®å…³æ³¨å­—æ®µï¼š\nå­—æ®µ æ„ä¹‰ type è®¿é—®ç±»å‹ï¼šALLã€indexã€rangeã€refã€eq_ref key æ˜¯å¦ç”¨åˆ°ç´¢å¼• rows é¢„ä¼°æ‰«æè¡Œæ•° Extra æ˜¯å¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ–‡ä»¶æ’åº JOIN æœ€å…³é”®æŒ‡æ ‡ï¼š\nè¢«é©±åŠ¨è¡¨çš„ â€œtypeâ€ å¿…é¡»ä¸º ref / eq_ref ç»ä¸èƒ½å‡ºç° ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ 5. é€‰æ‹©é©±åŠ¨è¡¨ï¼ˆä¼˜åŒ–é‡ç‚¹ï¼‰ MySQL çš„ä¼˜åŒ–å™¨ä¸€èˆ¬æŒ‰ä»¥ä¸‹åŸåˆ™é€‰æ‹©é©±åŠ¨è¡¨ï¼š\nWHERE è¿‡æ»¤åè¾ƒå°çš„è¡¨ä¼˜å…ˆåšé©±åŠ¨è¡¨ è¢«é©±åŠ¨è¡¨å¿…é¡»æœ‰å¯ç”¨ç´¢å¼•ï¼ˆå…³è”å­—æ®µç´¢å¼•ï¼‰ ä½¿ç”¨ BKA/HASH JOIN æ—¶ï¼Œä¼˜åŒ–å™¨å¯èƒ½è°ƒæ•´é¡ºåº æ­£ç¡®ç†è§£é©±åŠ¨è¡¨ï¼š\nè¯­å¥ å®é™…é©±åŠ¨è¡¨ FROM a JOIN b ä¼˜åŒ–å™¨å†³å®šï¼ˆä¸æ˜¯ a ä¹Ÿä¸æ˜¯ bï¼‰ STRAIGHT_JOIN å¼ºåˆ¶å·¦è¡¨ä¸ºé©±åŠ¨è¡¨ 6. JOIN åœºæ™¯æœ€ä½³å®è·µï¼ˆéå¸¸å®æˆ˜ï¼‰ 6.1 åœºæ™¯ 1ï¼šå¤§è¡¨ JOIN å°è¡¨ -\u0026gt; å°è¡¨åšé©±åŠ¨è¡¨ SELECT * FROM small s JOIN big b ON s.id = b.sid; 6.2 åœºæ™¯ 2ï¼šJOIN å­—æ®µå¿…é¡»åŠ ç´¢å¼•ï¼ˆæœ€é‡è¦çš„ JOIN ä¼˜åŒ–è§„åˆ™ï¼‰ ä¸åŠ ç´¢å¼•æ—¶ï¼š\nMySQL ä½¿ç”¨ Block Nested Loop -\u0026gt; æ‰«æè¢«é©±åŠ¨è¡¨å…¨è¡¨ æ€§èƒ½ç›´æ¥çˆ†ç‚¸ ç»™è¢«é©±åŠ¨è¡¨åŠ ç´¢å¼•ï¼š\nALTER TABLE order ADD INDEX idx_user_id(user_id); 6.3 åœºæ™¯ 3ï¼šé¿å…è·¨ç±»å‹ JOIN ä¸¥é‡å½±å“ä¼˜åŒ–å™¨é€‰æ‹©ï¼š\nvarchar vs int utf8 vs utf8mb4 ä¼šå¯¼è‡´éšå¼ç±»å‹è½¬æ¢ -\u0026gt; ç´¢å¼•å¤±æ•ˆã€‚\n6.4 åœºæ™¯ 4ï¼šé¿å…åœ¨ ON/WHERE å¯¹å…³è”å­—æ®µåšè¿ç®— é”™è¯¯ï¼ˆç´¢å¼•å¤±æ•ˆï¼‰ï¼š\nJOIN order o ON u.id + 1 = o.user_id æ­£ç¡®ï¼š\nJOIN order o ON u.id = o.user_id - 1 6.5 åœºæ™¯ 5ï¼šå°½é‡é¿å… JOIN è¿‡å¤šè¡¨ï¼ˆ\u0026gt;5 è¡¨ï¼‰ ä¼˜åŒ–å™¨è¿‡åº¦å¤æ‚ï¼Œæ‰§è¡Œè®¡åˆ’ä¸ç¨³å®šã€‚\n6.6 å¸¸ç”¨ä¼˜åŒ–æŠ€å·§ï¼ˆå®é™…é¡¹ç›®ç”¨å¾—æœ€å¤šï¼‰ ä½¿ç”¨ EXPLAIN æ‰¾åˆ°é”™è¯¯çš„é©±åŠ¨è¡¨ å¼ºåˆ¶é©±åŠ¨è¡¨ï¼ˆä½¿ç”¨ STRAIGHT_JOINï¼‰ é¿å…è·¨ç±»å‹ JOIN å¿…é¡»å¯¹ â€œè¢«é©±åŠ¨è¡¨â€ çš„å…³è”å­—æ®µå»ºç´¢å¼• ä¿è¯ç»Ÿè®¡ä¿¡æ¯æœ€æ–°ï¼š ANALYZE TABLE table; é¿å… ON æ¡ä»¶é‡Œè®¡ç®—ã€å‡½æ•° 7. MySQL JOIN åº•å±‚ï¼šä¸‰ç§ JOIN ç®—æ³•è¯¦è§£ 7.1 Index Nested Loop Joinï¼ˆæœ€å¸¸è§ï¼‰ æµç¨‹ï¼š\næ‰«æé©±åŠ¨è¡¨ä¸€è¡Œ ç”¨å…³è”å­—æ®µåœ¨è¢«é©±åŠ¨è¡¨ä¸­ â€œèµ°ç´¢å¼•â€ æŸ¥è®°å½• åˆå¹¶ç»“æœ ä¼˜ç‚¹ï¼šéå¸¸å¿«\nç¼ºç‚¹ï¼šè¢«é©±åŠ¨è¡¨å¿…é¡»æœ‰ç´¢å¼•ï¼Œå¦åˆ™é€€åŒ–æˆ BNL -\u0026gt; ææ…¢\n7.2 Block Nested Loop Joinï¼ˆæœ€ç³Ÿç³•ï¼‰ è¢«é©±åŠ¨è¡¨æ²¡ç´¢å¼• â‡’ MySQL å°†å¤§å—ç¼“å­˜æ‹¿æ¥ä¿å­˜é©±åŠ¨è¡¨è¡Œï¼Œå†å¾ªç¯å¯¹æ¯”ã€‚\næ€§èƒ½ï¼š\nğŸš« æ€§èƒ½æŒ‡æ•°çº§ä¸‹é™ ğŸš« éå¸¸å®¹æ˜“æ‰“çˆ† CPU / IO ä¼˜åŒ–åŠæ³•ï¼š\nğŸ‘‰ ç»™è¢«é©±åŠ¨è¡¨çš„ JOIN å­—æ®µåˆ›å»ºç´¢å¼•\n7.3 Hash Joinï¼ˆMySQL 8.0.18+ æ‰æœ‰ï¼‰ MySQL ä¼˜åŒ–å™¨ä¼šåˆ¤æ–­æ˜¯å¦ä½¿ç”¨ Hash Joinï¼Œä¾‹å¦‚ï¼š\næ— æ³•ä½¿ç”¨ç´¢å¼• è¡¨éå¸¸å¤§ ç­‰å€¼è¿æ¥ åº•å±‚é€šè¿‡å“ˆå¸Œè¡¨åŠ é€Ÿ JOINã€‚\n8. JOIN å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆï¼ˆå®æˆ˜ï¼‰ âŒ 8.1 å¤šè¡¨ JOIN + GROUP BY å›æ’åºå¤ªæ…¢ è§£å†³ï¼š\nå¢åŠ ç´¢å¼• è°ƒæ•´ SQL é¡ºåº å‡å°‘ join è¡¨æ•°é‡ âŒ 8.2 JOIN å­—æ®µç¼ºç´¢å¼•å¯¼è‡´å¤§äº‹åŠ¡å¡ä½ è§£å†³ï¼š\nALTER TABLE order ADD INDEX idx_user_id (user_id); âŒ 8.3 JOIN æ¡ä»¶å†™é”™ï¼Œè¿”å›å¤§é‡é‡å¤è¡Œ è§£å†³ï¼šä½¿ç”¨æ˜ç¡®å­—æ®µ JOINï¼Œä¸ç”¨ SELECT *\nâŒ 8.4 JOIN æ—¶ä½¿ç”¨ OR å¯¼è‡´ç´¢å¼•å¤±æ•ˆ é”™è¯¯ï¼š\nON a.id = b.id OR a.name = b.name æ”¹æˆ UNION ALL æ‹†åˆ†ï¼š\nSELECT â€¦ FROM a JOIN b ON a.id = b.id UNION ALL SELECT â€¦ FROM a JOIN b ON a.name = b.name; 9. JOIN è°ƒä¼˜ Checklistï¼ˆæœ€ç»ˆè½åœ°ç‰ˆï¼‰ å¿…é¡»åš è¢«é©±åŠ¨è¡¨ JOIN å­—æ®µå»ºç«‹ç´¢å¼• é¿å…è·¨ç±»å‹ JOIN è®©è¿‡æ»¤åæ›´å°çš„è¡¨åšé©±åŠ¨è¡¨ æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ å°½é‡åš JOIN ä¸è¶…è¿‡ 5 å¼ è¡¨ é¿å…åœ¨ ON/WHERE ä¸­è¿ç®— æ˜ç¡®é€‰æ‹©å­—æ®µï¼Œä¸ç”¨ SELECT * å¯ä»¥ä½¿ç”¨çš„æŠ€å·§ ä½¿ç”¨ STRAIGHT_JOIN å¼ºåˆ¶é©±åŠ¨è¡¨ åœ¨æŸäº›åœºæ™¯ç”¨ HASH JOINï¼ˆMySQL 8+ è‡ªåŠ¨é€‰æ‹©ï¼‰ æ€»ç»“ï¼ˆä¸€å¥è¯è®°ä½ JOINï¼‰ JOIN æ€§èƒ½ = é©±åŠ¨è¡¨å¤§å° Ã— è¢«é©±åŠ¨è¡¨çš„æŸ¥è¯¢æ•ˆç‡\næ‰€ä»¥ï¼šé©±åŠ¨è¡¨è¦å°ï¼Œè¢«é©±åŠ¨è¡¨è¦æœ‰ç´¢å¼•ï¼Œè¿™æ˜¯ JOIN çš„æ ¸å¿ƒä¼˜åŒ–é€»è¾‘ã€‚\n","description":" 1. ä»€ä¹ˆæ˜¯ JOINï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ JOIN ç”¨äºå°†ä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨æŒ‰å…³ç³»å­—æ®µå…³è”èµ·æ¥ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚\nSQL æ ‡å‡†æ”¯æŒçš„ JOIN ç±»å‹å¾ˆå¤šï¼Œä½†åœ¨ MySQL InnoDB ä¸­å®é™…ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ˜¯ï¼š\nINNER JOINï¼ˆå†…è¿æ¥ï¼‰ LEFT JOINï¼ˆå·¦å¤–è¿æ¥ï¼‰ RIGHT JOINï¼ˆå³å¤–è¿æ¥ï¼‰ CROSS JOINï¼ˆç¬›å¡å°”ç§¯ï¼‰ SELF JOINï¼ˆè‡ªè¿æ¥ï¼‰ ä»æœ¬è´¨ä¸Šè®²ï¼š\nJOIN = é©±åŠ¨è¡¨æ‰«æè¡Œ Ã— è¢«é©±åŠ¨è¡¨æŸ¥æ‰¾è¡Œï¼ˆNested Loop Joinï¼‰\nå…³é”®ç†è§£ï¼š\né€‰æ‹©é©±åŠ¨è¡¨éå¸¸é‡è¦ é©±åŠ¨è¡¨è¶Šå°è¶Šå¥½ è¢«é©±åŠ¨è¡¨å¿…é¡»æœ‰ç´¢å¼• 2. JOIN çš„æ‰§è¡Œæ–¹å¼ï¼ˆMySQL é‡è¦åº•å±‚åŸç†ï¼‰ MySQLï¼ˆInnoDBï¼‰JOIN æœ¬è´¨ä¸Šæ˜¯ Nested Loop Joinï¼ˆåµŒå¥—å¾ªç¯ï¼‰ï¼š\n"},{"id":314,"href":"/database/mysql/like/","title":"MySQL Like","parent":"MySQL","content":" 1. LIKE æ˜¯ä»€ä¹ˆï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ LIKE ç”¨äºæ¨¡ç³ŠæŸ¥è¯¢å­—ç¬¦ä¸²ï¼š\n%ï¼š0~âˆä¸ªä»»æ„å­—ç¬¦ _ï¼š1ä¸ªä»»æ„å­—ç¬¦ å¸¸è§ç¤ºä¾‹ï¼š\ncol LIKE \u0026#39;abc%\u0026#39; -- å³åŒ¹é… col LIKE \u0026#39;%abc%\u0026#39; -- å…¨æ¨¡ç³Š col LIKE \u0026#39;ab_c\u0026#39; -- å•å­—ç¬¦é€šé… 2. LIKE çš„åº•å±‚åŸç†ï¼ˆå¿…é¡»ç†è§£ï¼‰ MySQL å¯¹ LIKE æœ‰æ˜ç¡®ä¼˜åŒ–è§„åˆ™ï¼š\næ¨¡å¼ æ˜¯å¦ä½¿ç”¨ç´¢å¼• åº•å±‚è¡Œä¸º \u0026lsquo;xxx%\u0026rsquo; âœ… å¯ä½¿ç”¨ B+Tree ç´¢å¼• èŒƒå›´æ‰«æï¼ˆrangeï¼‰ \u0026lsquo;%xxx\u0026rsquo; âŒ ç´¢å¼•å¤±æ•ˆ å…¨è¡¨æ‰«æ \u0026lsquo;%xxx%\u0026rsquo; âŒ ç´¢å¼•å¤±æ•ˆ å…¨è¡¨æ‰«æ \u0026lsquo;x%y%z%\u0026rsquo; éƒ¨åˆ†å¯èƒ½ä½¿ç”¨å‰ç¼€ï¼Œä½†æ•´ä½“é€€åŒ– å¤§æ¦‚ç‡ä¸èµ°ç´¢å¼• LIKE BINARY \u0026lsquo;xxx%\u0026rsquo; ä½¿ç”¨ç´¢å¼•ä½†åŒºåˆ†å¤§å°å†™ range col LIKE \u0026lsquo;xxx%\u0026rsquo; AND col \u0026gt;= â€¦ å¯å¼ºåˆ¶èµ°ç´¢å¼• range ç»“è®ºï¼š\nLIKE åªæœ‰â€œå³åŒ¹é…â€èƒ½èµ°ç´¢å¼• å³ col LIKE \u0026lsquo;abc%\u0026rsquo; èƒ½ç”¨ç´¢å¼•ï¼Œå…¶å®ƒæƒ…å†µå¤§å¤šå…¨è¡¨æ‰«æã€‚ 3. ä¸ºä»€ä¹ˆ \u0026lsquo;%xxx\u0026rsquo; ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼Ÿ å› ä¸º B+Tree ç´¢å¼•ä» ç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹æ¯”è¾ƒã€‚\n\u0026lsquo;%xxx\u0026rsquo; æ— æ³•ç¡®å®šå¼€å¤´çš„å­—ç¬¦ -\u0026gt; ç´¢å¼•èŒƒå›´æœªçŸ¥ -\u0026gt; æ— æ³•èµ° B+Tree -\u0026gt; åªèƒ½é€€åŒ–ä¸º å…¨è¡¨é€è¡ŒåŒ¹é…ã€‚\n4. LIKE çš„æ‰§è¡Œè®¡åˆ’ï¼ˆEXPLAINï¼‰ EXPLAIN SELECT * FROM user WHERE name LIKE \u0026#39;%abc%\u0026#39;; ç»“æœä¸€èˆ¬æ˜¯ï¼š\ntype key rows Extra ALL NULL 1e6 Using where è¡¨ç¤º å…¨è¡¨æ‰«æ ALLï¼ˆæœ€æ…¢ï¼‰ã€‚\nå¦‚æœä½¿ç”¨å³åŒ¹é…ï¼š\nEXPLAIN SELECT * FROM user WHERE name LIKE \u0026#39;abc%\u0026#39;; ç»“æœï¼š\ntype key rows Extra range idx_name 100 Using index condition æ€§èƒ½å·®è·å¯è¾¾ 1000 å€ã€‚\n5. LIKE æœ€ä½³å®è·µï¼ˆä¼ä¸šå®æˆ˜ï¼‰ 5.1 åœºæ™¯ 1ï¼šå³åŒ¹é… -\u0026gt; å¼ºçƒˆæ¨è name LIKE \u0026#39;abc%\u0026#39; ç´¢å¼•åˆ©ç”¨ç‡æœ€é«˜ï¼Œæ¨èä¸ºâ€œç”Ÿäº§å®‰å…¨çº§ç”¨æ³•â€ã€‚\n5.2 åœºæ™¯ 2ï¼šå¼ºåˆ¶èµ°ç´¢å¼• å¦‚æœä½ èƒ½ç¡®å®šæ˜¯å³åŒ¹é…ï¼Œä½† MySQL å› ç»Ÿè®¡ä¿¡æ¯é”™è¯¯æ²¡èµ°ç´¢å¼•ï¼Œå¯ä½¿ç”¨ï¼š\nSELECT * FROM user FORCE INDEX(idx_name) WHERE name LIKE \u0026#39;abc%\u0026#39;; 5.3 åœºæ™¯ 3ï¼šLIKE + èŒƒå›´æ¡ä»¶å¼ºåŒ–ç´¢å¼•ä½¿ç”¨ WHERE name LIKE \u0026#39;abc%\u0026#39; AND name \u0026gt;= \u0026#39;abc\u0026#39; AND name \u0026lt; \u0026#39;abd\u0026#39; å¯å¸®åŠ©ä¼˜åŒ–å™¨æ›´æ˜ç¡®èŒƒå›´ã€‚\n5.4 åœºæ™¯ 4ï¼šé¿å…éšå¼ç±»å‹è½¬æ¢ é”™è¯¯ï¼ˆç´¢å¼•å¤±æ•ˆï¼‰ï¼š\nWHERE age LIKE \u0026#39;30\u0026#39; æ­£ç¡®ï¼š\nWHERE CAST(age AS CHAR) LIKE \u0026#39;30\u0026#39; ä½†é€šå¸¸ä¸è¦å¯¹æ•°å­—å­—æ®µç”¨ LIKEã€‚\nâŒ 6. LIKE çš„å¸¸è§é”™è¯¯ï¼ˆéå¸¸é‡è¦ï¼‰ âŒ 6.1 å¯¹ WHERE å­—æ®µä½¿ç”¨å‡½æ•° WHERE LOWER(name) LIKE \u0026#39;abc%\u0026#39; ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚\nâŒ 6.2 ä½¿ç”¨ CONCAT æ‹¼æ¥æœç´¢å†…å®¹ WHERE name LIKE CONCAT(\u0026#39;%\u0026#39;, \u0026#39;abc\u0026#39;, \u0026#39;%\u0026#39;) ä»ç„¶æ˜¯ \u0026lsquo;%abc%\u0026rsquo; -\u0026gt; æ— æ³•èµ°ç´¢å¼•ã€‚\nâŒ 6.3 æ‹¼éŸ³æœç´¢ / ä¸­æ–‡æœç´¢ ç”¨ LIKE ä¼šéå¸¸æ…¢ ä¸­æ–‡æ¨¡ç³ŠåŒ¹é…å»ºè®®ä½¿ç”¨ï¼š\nElasticSearch Mroonga Fulltext indexï¼ˆå…¨æ–‡ç´¢å¼•ï¼‰ ä¸é€‚ç”¨äºä¸­æ–‡ ğŸ”¥ 7. æƒ³å®ç° \u0026lsquo;%xxx%\u0026rsquo; ä¹Ÿèƒ½èµ°ç´¢å¼•ï¼Ÿï¼ˆæœ€å…³é”®éƒ¨åˆ†ï¼‰ ä¸‹é¢å‡ ç§æ–¹æ³•æ˜¯ä¼ä¸šå¼ºçƒˆæ¨èçš„å¤„ç†æ–¹æ¡ˆï¼š\n7.1 ä½¿ç”¨ å€’æ’ç´¢å¼•ï¼šElasticSearchï¼ˆæœ€ä½³è§£ï¼‰ é€‚åˆå¤æ‚æ¨¡ç³Šæœç´¢ / å¤šå­—æ®µæœç´¢ã€‚\nè¿™æ˜¯ç”Ÿäº§ä¸­çœŸæ­£çš„æ¨èæ–¹å¼ã€‚\n7.2 ä½¿ç”¨ MySQL å…¨æ–‡ç´¢å¼•ï¼ˆFULLTEXTï¼‰ï¼ˆè‹±æ–‡ OK / ä¸­æ–‡ä¹åŠ›ï¼‰ ALTER TABLE article ADD FULLTEXT(title, content); æœç´¢ï¼š\nSELECT * FROM article WHERE MATCH(title, content) AGAINST(\u0026#39;linux\u0026#39;); ç¼ºç‚¹ï¼šå¯¹ä¸­æ–‡æ•ˆæœå·®ã€‚\n7.3 ä½¿ç”¨ NGram åˆ†è¯ï¼ˆä¸­æ–‡æ¨¡ç³Šæœç´¢ï¼‰ ä½¿ç”¨ Mroonga æˆ– MySQL 8 çª—å£å‡½æ•°é…åˆåˆ†è¯ã€‚\n7.4 æ„é€ å‰ç¼€ç´¢å¼•ï¼ˆé€‚ç”¨äºå›ºå®šæ¨¡å¼çš„ LIKEï¼‰ å¦‚æœä½ çš„æ•°æ®å‰ä¸¤ä½æœ‰è§„å¾‹ï¼š\nINDEX idx_name_prefix(name(3)) é…åˆï¼š\nWHERE name LIKE \u0026#39;abc%\u0026#39; ä½†ä¸èƒ½è§£å†³ \u0026lsquo;%xxx%\u0026rsquo;ã€‚\n7.5 å¢åŠ åå‘å­—æ®µï¼ˆé«˜çº§æŠ€å·§ï¼‰ ä¸ºäº†æ”¯æŒåç¼€åŒ¹é… %xxxï¼Œå¯ä»¥å­˜ä¸€ä¸ªåè½¬å­—ç¬¦ä¸²ã€‚\nALTER TABLE t ADD COLUMN name_reverse VARCHAR(255); UPDATE t SET name_reverse = REVERSE(name); CREATE INDEX idx_name_reverse ON t(name_reverse); æŸ¥è¯¢ %abcï¼š\nSELECT * FROM t WHERE name_reverse LIKE REVERSE(\u0026#39;abc\u0026#39;) || \u0026#39;%\u0026#39;; å¯ä»¥èµ°ç´¢å¼•ï¼ˆä¼ä¸šå¤§é‡ä½¿ç”¨çš„æŠ€å·§ï¼‰ã€‚\nğŸ“Œ 8. MySQL LIKE çš„æ€§èƒ½å¯¹æ¯” ä»¥ 1000w è¡Œè¡¨æµ‹è¯•ï¼š\næ¡ä»¶ æ˜¯å¦èµ°ç´¢å¼• è€—æ—¶ name LIKE \u0026lsquo;abc%\u0026rsquo; âœ… 3ms name LIKE \u0026lsquo;%abc\u0026rsquo; âŒ 2s name LIKE \u0026lsquo;%abc%\u0026rsquo; âŒ 3s MATCH AGAINSTï¼ˆå…¨æ–‡ï¼‰ âœ… 15ms ElasticSearch âœ… 1~5ms å·®è·æ˜¯å‡ ååˆ°å‡ ç™¾å€ã€‚\nğŸ¯ 9. LIKE æœ€ç»ˆæ€»ç»“ï¼ˆä¸€å¥è¯è®°ä½ï¼‰ MySQL LIKE æ˜¯å¦èµ°ç´¢å¼•çš„æ ¹æœ¬é€»è¾‘ï¼šå¿…é¡»ä»å·¦è¾¹å¼€å§‹åŒ¹é…ã€‚åªè¦å·¦è¾¹ä¸æ˜¯å›ºå®šå­—ç¬¦ä¸²ï¼ˆä¸æ˜¯ \u0026lsquo;xxx%\u0026rsquo;ï¼‰ï¼Œå°±ä¸èƒ½èµ° B+Tree ç´¢å¼•ã€‚\n","description":" 1. LIKE æ˜¯ä»€ä¹ˆï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰ LIKE ç”¨äºæ¨¡ç³ŠæŸ¥è¯¢å­—ç¬¦ä¸²ï¼š\n%ï¼š0~âˆä¸ªä»»æ„å­—ç¬¦ _ï¼š1ä¸ªä»»æ„å­—ç¬¦ å¸¸è§ç¤ºä¾‹ï¼š\ncol LIKE \u0026#39;abc%\u0026#39; -- å³åŒ¹é… col LIKE \u0026#39;%abc%\u0026#39; -- å…¨æ¨¡ç³Š col LIKE \u0026#39;ab_c\u0026#39; -- å•å­—ç¬¦é€šé… 2. LIKE çš„åº•å±‚åŸç†ï¼ˆå¿…é¡»ç†è§£ï¼‰ MySQL å¯¹ LIKE æœ‰æ˜ç¡®ä¼˜åŒ–è§„åˆ™ï¼š\næ¨¡å¼ æ˜¯å¦ä½¿ç”¨ç´¢å¼• åº•å±‚è¡Œä¸º \u0026lsquo;xxx%\u0026rsquo; âœ… å¯ä½¿ç”¨ B+Tree ç´¢å¼• èŒƒå›´æ‰«æï¼ˆrangeï¼‰ \u0026lsquo;%xxx\u0026rsquo; âŒ ç´¢å¼•å¤±æ•ˆ å…¨è¡¨æ‰«æ \u0026lsquo;%xxx%\u0026rsquo; âŒ ç´¢å¼•å¤±æ•ˆ å…¨è¡¨æ‰«æ \u0026lsquo;x%y%z%\u0026rsquo; éƒ¨åˆ†å¯èƒ½ä½¿ç”¨å‰ç¼€ï¼Œä½†æ•´ä½“é€€åŒ– å¤§æ¦‚ç‡ä¸èµ°ç´¢å¼• LIKE BINARY \u0026lsquo;xxx%\u0026rsquo; ä½¿ç”¨ç´¢å¼•ä½†åŒºåˆ†å¤§å°å†™ range col LIKE \u0026lsquo;xxx%\u0026rsquo; AND col \u0026gt;= â€¦ å¯å¼ºåˆ¶èµ°ç´¢å¼• range ç»“è®ºï¼š\n"},{"id":315,"href":"/database/mysql/pitr/","title":"MySQL PITR","parent":"MySQL","content":"PITRï¼ˆPoint-In-Time Recoveryï¼Œæ—¶é—´ç‚¹æ¢å¤ï¼‰\nä¸€ã€ä»€ä¹ˆæ˜¯ MySQL PITRï¼ˆä¸€å¥è¯ï¼‰ PITR = å…¨é‡å¤‡ä»½ + Binlog -\u0026gt; æ¢å¤åˆ°â€œä»»æ„æ—¶é—´ç‚¹ / ä»»æ„äº‹åŠ¡ä½ç½®â€\nèƒ½æŠŠæ•°æ®åº“æ¢å¤åˆ°ï¼š\nè¯¯åˆ æ•°æ®ä¹‹å‰ è¯¯æ›´æ–° SQL æ‰§è¡Œå‰ 1 ç§’ ä¸»åº“å®•æœº æœ€åä¸€ä¸ªå·²æäº¤äº‹åŠ¡ äºŒã€PITR èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœºæ™¯ æ˜¯å¦èƒ½æ¢å¤ DROP TABLE âœ… DELETE FROM table; âœ… UPDATE æ²¡åŠ  WHERE âœ… ä¸»åº“ç£ç›˜æŸå âœ… äººä¸ºè¯¯æ“ä½œ âœ… Binlog è¢«åˆ  âŒ å…¨é‡å¤‡ä»½ä¸å¯ç”¨ âŒ ğŸ‘‰ PITR ä¾èµ– Binlogï¼ŒBinlog ä¸¢äº† = æ— æ³• PITR\nä¸‰ã€PITR çš„æ ¸å¿ƒç»„æˆ 1ï¸âƒ£ å…¨é‡å¤‡ä»½ï¼ˆBase Backupï¼‰ å¸¸è§æ–¹å¼ï¼š\nmysqldump mysqlpump Percona XtraBackupï¼ˆç”Ÿäº§æ¨èï¼‰ 2ï¸âƒ£ Binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ Binlog è®°å½•äº†ï¼š\næ‰€æœ‰ DDL æ‰€æœ‰ DMLï¼ˆINSERT / UPDATE / DELETEï¼‰ æäº¤é¡ºåº å››ã€PITR çš„å‰ææ¡ä»¶ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ âœ… 1. å¼€å¯ Binlog [mysqld] server-id = 1 log-bin = mysql-bin binlog_format = ROW binlog_expire_logs_seconds = 604800 # 7 å¤© æ£€æŸ¥ï¼š\nSHOW VARIABLES LIKE \u0026#39;log_bin\u0026#39;; SHOW VARIABLES LIKE \u0026#39;binlog_format\u0026#39;; âœ… 2. çŸ¥é“å…¨é‡å¤‡ä»½æ—¶çš„ Binlog ä½ç‚¹ å¤‡ä»½æ—¶å¿…é¡»è®°å½•ï¼š\nSHOW MASTER STATUS; å¾—åˆ°ï¼š\nFile: mysql-bin.000123 Position: 456789 è¿™æ˜¯ PITR çš„èµ·ç‚¹\näº”ã€PITR çš„å®Œæ•´æ¢å¤æµç¨‹ï¼ˆé‡ç‚¹ï¼‰ åœºæ™¯ï¼š\nä»Šå¤© 10:30 æœ‰äººè¯¯æ‰§è¡Œ DELETE å¸Œæœ›æ¢å¤åˆ° 10:29:59 ğŸŸ¢ ç¬¬ 1 æ­¥ï¼šæ¢å¤å…¨é‡å¤‡ä»½ ä½¿ç”¨ XtraBackupï¼ˆæ¨èï¼‰\nxtrabackup --prepare --target-dir=/backup/full systemctl stop mysqld rsync -av /backup/full/ /var/lib/mysql/ chown -R mysql:mysql /var/lib/mysql systemctl start mysqld ğŸŸ¢ ç¬¬ 2 æ­¥ï¼šç¡®å®šæ¢å¤ç»ˆç‚¹æ—¶é—´ ç›®æ ‡æ—¶é—´ï¼š2025-12-16 10:29:59\nğŸŸ¢ ç¬¬ 3 æ­¥ï¼šå›æ”¾ Binlogï¼ˆæ ¸å¿ƒï¼‰ æŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼ˆæœ€å¸¸ç”¨ï¼‰\nmysqlbinlog \\ --start-position=456789 \\ --stop-datetime=\u0026#34;2025-12-16 10:29:59\u0026#34; \\ mysql-bin.000123 mysql-bin.000124 \\ | mysql -u root -p ğŸ“Œ è¯´æ˜ï¼š\nstart-position -\u0026gt; æ¥è‡ªå…¨é‡å¤‡ä»½æ—¶ stop-datetime -\u0026gt; ç²¾ç¡®åˆ°ç§’ å¯è·¨å¤šä¸ª binlog æ–‡ä»¶ ğŸŸ¢ ç¬¬ 4 æ­¥ï¼šéªŒè¯æ•°æ® SELECT COUNT(*) FROM table; ç¡®è®¤æ— è¯¯åï¼š\nSET GLOBAL read_only = OFF; å…­ã€å¸¸è§ PITR æ–¹å¼å¯¹æ¯” æ–¹å¼ è¯´æ˜ é€‚åˆ stop-datetime æ¢å¤åˆ°æŸä¸ªæ—¶é—´ äººä¸ºè¯¯æ“ä½œ stop-position æ¢å¤åˆ°æŸä¸ªäº‹åŠ¡ ç²¾ç¡®æ§åˆ¶ è·³è¿‡æŸæ¡ SQL æ‰‹å·¥è¿‡æ»¤ binlog é«˜çº§è¿ç»´ ä¸ƒã€å¦‚ä½•è·³è¿‡â€œè¯¯æ“ä½œ SQLâ€ï¼ˆé«˜çº§ï¼‰ 1ï¸âƒ£ æŸ¥çœ‹ Binlog å†…å®¹ mysqlbinlog --base64-output=DECODE-ROWS -vv mysql-bin.000124 å®šä½åˆ°ï¼š\nDELETE FROM orders; 2ï¸âƒ£ æ‰‹åŠ¨è¿‡æ»¤ mysqlbinlog mysql-bin.000124 \\ | sed \u0026#39;/DELETE FROM orders/,+5d\u0026#39; \\ | mysql -u root -p âš ï¸ éœ€è¦éå¸¸ç†Ÿæ‚‰ binlog ç»“æ„ï¼Œä¸æ¨èæ–°æ‰‹\nå…«ã€PITR çš„ç”Ÿäº§æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ âœ… 1. ä½¿ç”¨ ROW æ¨¡å¼ binlog_format = ROW\nè®°å½•çœŸå®è¡Œå˜åŒ– é¿å…ä¸»ä»ä¸ä¸€è‡´ PITR æ›´å¯é  âœ… 2. Binlog ä¸æ•°æ®åˆ†ç›˜ log-bin = /data/binlog/mysql-bin âœ… 3. Binlog å¿…é¡»åšå¤‡ä»½ rsync /data/binlog backup-server:/binlog/ å¦åˆ™ï¼š\næ•°æ®åº“æŒ‚äº† + binlog ä¸¢å¤± = æ— æ³• PITR\nâœ… 4. å…¨é‡ + Binlog è‡ªåŠ¨åŒ– æ¨èå‘¨æœŸï¼š\nç±»å‹ å‘¨æœŸ å…¨é‡å¤‡ä»½ æ¯å¤© Binlog å¤‡ä»½ å®æ—¶ / æ¯å°æ—¶ âœ… 5. æ¢å¤å¿…é¡»åœ¨æ–°å®ä¾‹éªŒè¯ ä¸è¦åœ¨ç”Ÿäº§ç›´æ¥æ¢å¤ï¼\nä¹ã€PITR å¸¸è§é—®é¢˜ Q1ï¼šPITR çš„å‰ææ¡ä»¶ï¼Ÿ\nå¼€å¯ Binlog + æœ‰å®Œæ•´å…¨é‡å¤‡ä»½ + Binlog æœªä¸¢å¤±\nQ2ï¼šPITR èƒ½æ¢å¤ truncate å—ï¼Ÿ\nâŒ TRUNCATE æ˜¯ DDLï¼Œæ— æ³•å›æ»šï¼Œåªèƒ½æ¢å¤åˆ° TRUNCATE ä¹‹å‰\nQ3ï¼šä¸ºä»€ä¹ˆæ¨è ROW Binlogï¼Ÿ\nè®°å½•è¡Œçº§å˜åŒ–ï¼Œé¿å… STATEMENT æ¨¡å¼çš„éç¡®å®šæ€§é—®é¢˜\nQ4ï¼šPITR å’Œä¸»ä»æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ\nä¸»ä»ä¾èµ– Binlogï¼ŒPITR æœ¬è´¨ä¹Ÿæ˜¯å›æ”¾ Binlog\nåã€æ€»ç»“ MySQL PITR = å…¨é‡å¤‡ä»½æ‰“åº• + Binlog ç²¾ç¡®å›æ”¾\n","description":"PITRï¼ˆPoint-In-Time Recoveryï¼Œæ—¶é—´ç‚¹æ¢å¤ï¼‰\nä¸€ã€ä»€ä¹ˆæ˜¯ MySQL PITRï¼ˆä¸€å¥è¯ï¼‰ PITR = å…¨é‡å¤‡ä»½ + Binlog -\u0026gt; æ¢å¤åˆ°â€œä»»æ„æ—¶é—´ç‚¹ / ä»»æ„äº‹åŠ¡ä½ç½®â€\nèƒ½æŠŠæ•°æ®åº“æ¢å¤åˆ°ï¼š\nè¯¯åˆ æ•°æ®ä¹‹å‰ è¯¯æ›´æ–° SQL æ‰§è¡Œå‰ 1 ç§’ ä¸»åº“å®•æœº æœ€åä¸€ä¸ªå·²æäº¤äº‹åŠ¡ äºŒã€PITR èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ åœºæ™¯ æ˜¯å¦èƒ½æ¢å¤ DROP TABLE âœ… DELETE FROM table; âœ… UPDATE æ²¡åŠ  WHERE âœ… ä¸»åº“ç£ç›˜æŸå âœ… äººä¸ºè¯¯æ“ä½œ âœ… Binlog è¢«åˆ  âŒ å…¨é‡å¤‡ä»½ä¸å¯ç”¨ âŒ ğŸ‘‰ PITR ä¾èµ– Binlogï¼ŒBinlog ä¸¢äº† = æ— æ³• PITR\n"},{"id":316,"href":"/database/mysql/transaction/","title":"MySQL äº‹åŠ¡","parent":"MySQL","content":"å†…å®¹è¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€äº‹åŠ¡æµç¨‹ã€éš”ç¦»çº§åˆ«ã€MVCCã€é”å…³ç³»ã€æ­»é”ã€ä¼˜åŒ–å®è·µï¼Œå…¨ç¨‹æ·±å…¥ä½†ä¿æŒç®€æ´ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯ ä¸€ç»„è¦ä¹ˆå…¨éƒ¨æˆåŠŸã€è¦ä¹ˆå…¨éƒ¨å¤±è´¥çš„æ•°æ®åº“æ“ä½œã€‚æœ¬è´¨æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŸºç¡€æœºåˆ¶ã€‚\näº‹åŠ¡å…·å¤‡ ACID å››å¤§ç‰¹æ€§ï¼š\nç‰¹æ€§ æè¿° A åŸå­æ€§ï¼ˆAtomicityï¼‰ äº‹åŠ¡å†…æ“ä½œä¸å¯åˆ†å‰²ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œã€è¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼ˆé  undo log å®ç°ï¼‰ C ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼Œä¸å‡ºç°éæ³•çŠ¶æ€ I éš”ç¦»æ€§ï¼ˆIsolationï¼‰ å¤šäº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°ï¼ˆé é”ã€MVCC å®ç°ï¼‰ D æŒä¹…æ€§ï¼ˆDurabilityï¼‰ æäº¤åæ•°æ®å¿…é¡»æŒä¹…ä¿å­˜ï¼ˆé  redo log+binlog å®ç°ï¼‰ äºŒã€äº‹åŠ¡çš„åº•å±‚æ—¥å¿—ä½“ç³»ï¼ˆå…³é”®ç†è§£ç‚¹ï¼‰ MySQL InnoDB ä¸ºäº‹åŠ¡å‡†å¤‡äº† 3 å¥—å…³é”®æ—¥å¿—ï¼š\n1. redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ ä¿è¯ æŒä¹…æ€§ è®°å½•â€œé¡µé¢ä¿®æ”¹åçš„å†…å®¹â€ å´©æºƒæ¢å¤å é‡åšå·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹ WAL æœºåˆ¶ï¼šå…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®é¡µ 2. undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ ä¿è¯ åŸå­æ€§ ç”¨äºï¼š å›æ»šäº‹åŠ¡ MVCC æä¾›â€œæ—§ç‰ˆæœ¬æ•°æ®â€ç»™å¿«ç…§è¯» 3. binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ æœåŠ¡äºå¤åˆ¶ã€ä¸»ä»åŒæ­¥ã€å¤‡ä»½æ¢å¤ è®°å½•æ‰€æœ‰ é€»è¾‘å˜åŒ– append-onlyï¼Œä¸ä¼šè¦†ç›– ä¸‰ã€äº‹åŠ¡çš„ä¸¤ç§å®ç°æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰ 1. éšå¼äº‹åŠ¡ï¼ˆautocommit = 1ï¼‰ æ¯æ¡ SQL éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼š\nINSERT ... UPDATE ... æ¯æ‰§è¡Œä¸€æ¡å°±è‡ªåŠ¨æäº¤ã€‚\n2. æ˜¾å¼äº‹åŠ¡ï¼ˆæ¨èï¼‰ START TRANSACTION; UPDATE t SET ...; COMMIT; æ‰‹åŠ¨æ§åˆ¶ï¼š\nROLLBACK; å››ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆIsolation Levelsï¼‰ å››ä¸ªéš”ç¦»çº§åˆ«ï¼š\néš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» æ€§èƒ½ READ UNCOMMITTED âœ… âœ… âœ… æœ€å¿« READ COMMITTED âŒ âœ… âœ… è¾ƒå¿« REPEATABLE READï¼ˆMySQL é»˜è®¤ï¼‰ âŒ âŒ âŒï¼ˆInnoDB MVCC + Next-key lockï¼‰ å¹³è¡¡ SERIALIZABLE âŒ âŒ âŒ æœ€æ…¢ï¼Œé”è¡¨ äº”ã€MySQL æ˜¯å¦‚ä½•è§£å†³å¹¶å‘è¯»å†™å†²çªçš„ï¼Ÿ A. MVCC + å¿«ç…§è¯»ï¼ˆå¤§éƒ¨åˆ†æŸ¥è¯¢ï¼‰ InnoDB ä½¿ç”¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰è§£å†³è¯»å†™å†²çªï¼š\nä¸åŠ é”ï¼Œé«˜æ€§èƒ½ SELECT é»˜è®¤ä½¿ç”¨ å¿«ç…§è¯» ä½¿ç”¨ undo log æä¾›å†å²ç‰ˆæœ¬ ä¾‹å¦‚ï¼š\nSELECT * FROM t WHERE id = 1; ä¸ä¼šåŠ é”ã€‚\nB. åŠ é”è¯»ï¼ˆé”å®šå½“å‰è¡Œï¼‰ 1ï¼‰å…±äº«é”ï¼ˆSï¼‰ SELECT * FROM t WHERE id=1 LOCK IN SHARE MODE; å…è®¸åˆ«äººè¯»ï¼Œä¸å…è®¸å†™ã€‚\n2ï¼‰æ’ä»–é”ï¼ˆXï¼‰ SELECT * FROM t WHERE id=1 FOR UPDATE; ä¸å…è®¸åˆ«äººè¯»ï¼ˆå¿«ç…§è¯»é™¤å¤–ï¼‰ï¼Œä¹Ÿä¸å…è®¸åˆ«äººå†™ã€‚\nå…­ã€MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰è¯¦è§£ï¼ˆæ ¸å¿ƒï¼‰ MVCC ä¾é  éšè—å­—æ®µ + undo log + Read View å®ç°ï¼š\nInnoDB æ¯è¡Œæœ‰ 2 ä¸ªéšè—å…ƒæ•°æ®ï¼š\ntrx_id ï¼šæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ ID roll_pointerï¼šæŒ‡å‘ undo log ä¸­ä¸Šä¸€ç‰ˆæœ¬æ•°æ® Read View å†³å®šâ€œå¯è§ç‰ˆæœ¬â€\nåˆ›å»ºå¿«ç…§æ—¶è®°å½•æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œåˆ¤æ–­æ•°æ®ç‰ˆæœ¬æ˜¯å¦å¯è§ã€‚\nå› æ­¤ï¼š\nå¿«ç…§è¯» ä¸ä¼šè¢«å†™é˜»å¡ è¯»å†™å¹¶å‘å¤§å¹…æå‡ å¹»è¯»è¢« Next-Key Lock è§„é¿ ä¸ƒã€å¹»è¯»å¦‚ä½•è¢«è§£å†³ï¼Ÿ MySQL ä½¿ç”¨ï¼š\nèŒƒå›´é”ï¼ˆRange Lockï¼‰\nNext-Key Lockï¼ˆè®°å½•é” + é—´éš™é”ï¼‰\nä¾‹å¦‚ï¼š\nSELECT * FROM t WHERE age \u0026gt; 20 FOR UPDATE; ä¼šé”ä½ï¼š\nå·²å­˜åœ¨è¡Œï¼ˆRecord Lockï¼‰ 20ï½æœ€å¤§å€¼çš„åŒºé—´ï¼ˆGap Lockï¼‰ é˜²æ­¢åˆ«äººæ’å…¥æ–°è¡Œ -\u0026gt; é¿å…å¹»è¯»ã€‚\nå…«ã€äº‹åŠ¡çš„æ‰§è¡Œæµç¨‹ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰\nå¼€å§‹äº‹åŠ¡ ç»´æŠ¤ä¸€ä¸ªäº‹åŠ¡ IDï¼ˆtrx_idï¼‰ æ‰§è¡Œ SQL -\u0026gt; å†™ undo log ä¿®æ”¹ Buffer Pool å†…æ•°æ®é¡µ å†™ redo logï¼ˆprepare çŠ¶æ€ï¼‰ æäº¤ COMMIT -\u0026gt; redo log ç”± prepare -\u0026gt; commit çŠ¶æ€ binlog å†™å…¥æˆåŠŸï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ commit äº‹åŠ¡ç»“æŸ ä¿è¯å´©æºƒæ¢å¤åï¼š\nredo log ä¸ä¼šä¸¢æ•°æ® binlog ç²¾ç¡®ç”¨äºä¸»ä»å¤åˆ¶ ä¹ã€å¸¸è§äº‹åŠ¡é—®é¢˜ä¸ç¤ºä¾‹ 1. è„è¯»ï¼ˆDirty Readï¼‰ è¯»åˆ°äº†â€œæœªæäº¤çš„äº‹åŠ¡çš„æ•°æ®â€ã€‚\n2. ä¸å¯é‡å¤è¯»ï¼ˆNon-repeatable Readï¼‰ åŒä¸€æ¬¡äº‹åŠ¡ä¸­ï¼Œä¸¤æ¬¡ SELECT è¿”å›ä¸åŒç»“æœã€‚\n3. å¹»è¯»ï¼ˆPhantom Readï¼‰ èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œæ–°æ’å…¥äº†è®°å½•ã€‚\nåã€æ­»é”ï¼ˆDeadlockï¼‰ æ­»é”å‘ç”ŸåŸå›  å¤šä¸ªäº‹åŠ¡ç›¸äº’æŒæœ‰å¯¹æ–¹è¦çš„é” é¡ºåºä¸ä¸€è‡´ ä¸šåŠ¡é€»è¾‘ç«äº‰ è§£å†³æ–¹æ³• InnoDB è‡ªåŠ¨æ£€æµ‹å¹¶å›æ»šä¸€ä¸ªäº‹åŠ¡ï¼ˆæŠ¥ 1213ï¼‰ åº”ç”¨å±‚æ•è·é‡è¯• é¿å…æ­»é”çš„æœ€ä½³å®è·µ é¡ºåºè®¿é—®è¡¨å’Œè¡Œ ç²—ç²’åº¦é”ï¼ˆä¾‹å¦‚ä¸€æ¬¡ FOR UPDATE å–å‡ºæ‰€æœ‰ IDï¼‰ ç¼©çŸ­äº‹åŠ¡æ—¶é—´ ä½¿ç”¨åˆç†ç´¢å¼•å‡å°‘é”å®šæ•°é‡ é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤–éƒ¨æ“ä½œï¼ˆä¾‹å¦‚æ¥å£è°ƒç”¨ï¼‰ åä¸€ã€äº‹åŠ¡æœ€ä½³å®è·µ ä½¿ç”¨çŸ­äº‹åŠ¡ï¼ˆé¿å…é•¿äº‹åŠ¡å¯¼è‡´ undo çˆ†å¢ï¼‰ å¿…é¡»æœ‰ WHEREï¼Œé¿å…é”å…¨è¡¨ ä¸»é”®ç²¾ç¡®æ›´æ–°ï¼Œå‡å°‘é”å†²çª è¯»å¤šå†™å°‘ä¸šåŠ¡ -\u0026gt; ä½¿ç”¨å¿«ç…§è¯» åˆ†å¸ƒå¼ä¸šåŠ¡ -\u0026gt; è§„é¿åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆXA, 2PCï¼‰ åäºŒã€æ€»ç»“ é—®é¢˜ ç®€è¦å›ç­” MVCC çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ undo log + éšè—ç‰ˆæœ¬å· + Read View MySQL å¦‚ä½•è§£å†³å¹»è¯»ï¼Ÿ Next-key Lock redo log å’Œ binlog åŒºåˆ«ï¼Ÿ redoï¼šç‰©ç†æ—¥å¿—ï¼›binlogï¼šé€»è¾‘æ—¥å¿— ä¸¤é˜¶æ®µæäº¤ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ ä¿è¯ MySQL å´©æºƒå binlog å’Œ redo log ä¸€è‡´ RR ä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°ä¸å¯é‡å¤è¯»ï¼Ÿ å¿«ç…§è¯» + ç‰ˆæœ¬é“¾ RR ä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°å¹»è¯»ï¼Ÿ Next-key Lock ","description":"å†…å®¹è¦†ç›–æ ¸å¿ƒæ¦‚å¿µã€äº‹åŠ¡æµç¨‹ã€éš”ç¦»çº§åˆ«ã€MVCCã€é”å…³ç³»ã€æ­»é”ã€ä¼˜åŒ–å®è·µï¼Œå…¨ç¨‹æ·±å…¥ä½†ä¿æŒç®€æ´ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯ ä¸€ç»„è¦ä¹ˆå…¨éƒ¨æˆåŠŸã€è¦ä¹ˆå…¨éƒ¨å¤±è´¥çš„æ•°æ®åº“æ“ä½œã€‚æœ¬è´¨æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŸºç¡€æœºåˆ¶ã€‚\näº‹åŠ¡å…·å¤‡ ACID å››å¤§ç‰¹æ€§ï¼š\nç‰¹æ€§ æè¿° A åŸå­æ€§ï¼ˆAtomicityï¼‰ äº‹åŠ¡å†…æ“ä½œä¸å¯åˆ†å‰²ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œã€è¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼ˆé  undo log å®ç°ï¼‰ C ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼Œä¸å‡ºç°éæ³•çŠ¶æ€ I éš”ç¦»æ€§ï¼ˆIsolationï¼‰ å¤šäº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°ï¼ˆé é”ã€MVCC å®ç°ï¼‰ D æŒä¹…æ€§ï¼ˆDurabilityï¼‰ æäº¤åæ•°æ®å¿…é¡»æŒä¹…ä¿å­˜ï¼ˆé  redo log+binlog å®ç°ï¼‰ äºŒã€äº‹åŠ¡çš„åº•å±‚æ—¥å¿—ä½“ç³»ï¼ˆå…³é”®ç†è§£ç‚¹ï¼‰ MySQL InnoDB ä¸ºäº‹åŠ¡å‡†å¤‡äº† 3 å¥—å…³é”®æ—¥å¿—ï¼š\n1. redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ ä¿è¯ æŒä¹…æ€§ è®°å½•â€œé¡µé¢ä¿®æ”¹åçš„å†…å®¹â€ å´©æºƒæ¢å¤å é‡åšå·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹ WAL æœºåˆ¶ï¼šå…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®é¡µ 2. undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ ä¿è¯ åŸå­æ€§ ç”¨äºï¼š å›æ»šäº‹åŠ¡ MVCC æä¾›â€œæ—§ç‰ˆæœ¬æ•°æ®â€ç»™å¿«ç…§è¯» 3. binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ æœåŠ¡äºå¤åˆ¶ã€ä¸»ä»åŒæ­¥ã€å¤‡ä»½æ¢å¤ è®°å½•æ‰€æœ‰ é€»è¾‘å˜åŒ– append-onlyï¼Œä¸ä¼šè¦†ç›– ä¸‰ã€äº‹åŠ¡çš„ä¸¤ç§å®ç°æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰ 1. éšå¼äº‹åŠ¡ï¼ˆautocommit = 1ï¼‰ æ¯æ¡ SQL éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼š\n"},{"id":317,"href":"/database/mysql/table-2000w/","title":"MySQL å•è¡¨ä¸è¦è¶…è¿‡ 2000 ä¸‡è¡Œ","parent":"MySQL","content":"MySQL å•è¡¨è¡Œæ•°å»ºè®®ä¸è¶…è¿‡ 2000 ä¸‡è¡Œï¼ˆ2000wï¼‰ï¼Œå› ä¸ºè¶…è¿‡å B+Tree ç´¢å¼•é«˜åº¦ä¼šå¢åŠ ï¼Œå¯¼è‡´æŸ¥è¯¢ç£ç›˜IOå¢å¤šã€æ€§èƒ½ä¸‹é™ï¼Œå¹¶å¢åŠ å†…å­˜/ç£ç›˜ç©ºé—´æ¶ˆè€—ï¼Œä½†è¿™ä¸æ˜¯ç»å¯¹é™åˆ¶ï¼Œå¯æ ¹æ®ç¡¬ä»¶å’Œä¸šåŠ¡ä¼˜åŒ–ã€‚\n2000ä¸‡è¡Œé™åˆ¶çš„åŸå›  B+Tree é«˜åº¦å¢åŠ : çº¦2000ä¸‡è¡Œæ•°æ®ï¼Œç´¢å¼• B+Tree é€šå¸¸æ˜¯3å±‚ï¼Œèƒ½è¾ƒå¥½åœ°åœ¨å†…å­˜ä¸­åŠ è½½ï¼Œè¶…è¿‡æ­¤å€¼ä¼šå¢åŠ æ ‘å±‚çº§ï¼ˆ4å±‚ä»¥ä¸Šï¼‰ï¼Œå¸¦æ¥æ›´å¤šç£ç›˜I/Oã€‚ æŸ¥è¯¢æ€§èƒ½ä¸‹é™: æ ‘é«˜å¢åŠ æ„å‘³ç€éœ€è¦æ›´å¤šç£ç›˜I/Oå’Œç´¢å¼•ç»´æŠ¤æˆæœ¬ï¼ŒæŸ¥è¯¢é€Ÿåº¦å˜æ…¢ã€‚ å†…å­˜/ç£ç›˜å‹åŠ›: å¤§é‡æ•°æ®å’Œç´¢å¼•ä¼šå ç”¨æ›´å¤šå†…å­˜ï¼ˆInnoDB Buffer Poolï¼‰å’Œç£ç›˜ç©ºé—´ã€‚ å¹¶éç»å¯¹é™åˆ¶ è¿™ä¸ªå€¼æ˜¯åŸºäº OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†ï¼‰åœºæ™¯å’Œå¸¸è§ç¡¬ä»¶ï¼ˆå¦‚æ™®é€šSSDï¼‰çš„ç»éªŒå€¼ã€‚ å¦‚æœç¡¬ä»¶æ€§èƒ½å¼ºåŠ²ã€ç´¢å¼•è®¾è®¡åˆç†ã€æŸ¥è¯¢æ¨¡å¼ç®€å•ï¼Œå•è¡¨æ”¯æŒæ›´å¤§è¡Œæ•°ï¼ˆå¦‚MySQL 5.7+ InnoDBæ”¯æŒ2000äº¿è¡Œï¼Œä½†æ€§èƒ½ä¼šå—å½±å“ï¼‰ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚ è¶…è¿‡2000ä¸‡æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€åˆç†ç´¢å¼•ã€ç¡¬ä»¶å‡çº§æˆ–å‚æ•°è°ƒä¼˜ç­‰ç­–ç•¥ã€‚ å‚è€ƒæ–‡æ¡£ ä¸ºä»€ä¹ˆè¯´MySQLå•è¡¨è¡Œæ•°ä¸è¦è¶…è¿‡2000w? ä¸ºä»€ä¹ˆå•è¡¨ä¸è¦è¶…è¿‡ 2000w ","description":"MySQL å•è¡¨è¡Œæ•°å»ºè®®ä¸è¶…è¿‡ 2000 ä¸‡è¡Œï¼ˆ2000wï¼‰ï¼Œå› ä¸ºè¶…è¿‡å B+Tree ç´¢å¼•é«˜åº¦ä¼šå¢åŠ ï¼Œå¯¼è‡´æŸ¥è¯¢ç£ç›˜IOå¢å¤šã€æ€§èƒ½ä¸‹é™ï¼Œå¹¶å¢åŠ å†…å­˜/ç£ç›˜ç©ºé—´æ¶ˆè€—ï¼Œä½†è¿™ä¸æ˜¯ç»å¯¹é™åˆ¶ï¼Œå¯æ ¹æ®ç¡¬ä»¶å’Œä¸šåŠ¡ä¼˜åŒ–ã€‚\n2000ä¸‡è¡Œé™åˆ¶çš„åŸå›  B+Tree é«˜åº¦å¢åŠ : çº¦2000ä¸‡è¡Œæ•°æ®ï¼Œç´¢å¼• B+Tree é€šå¸¸æ˜¯3å±‚ï¼Œèƒ½è¾ƒå¥½åœ°åœ¨å†…å­˜ä¸­åŠ è½½ï¼Œè¶…è¿‡æ­¤å€¼ä¼šå¢åŠ æ ‘å±‚çº§ï¼ˆ4å±‚ä»¥ä¸Šï¼‰ï¼Œå¸¦æ¥æ›´å¤šç£ç›˜I/Oã€‚ æŸ¥è¯¢æ€§èƒ½ä¸‹é™: æ ‘é«˜å¢åŠ æ„å‘³ç€éœ€è¦æ›´å¤šç£ç›˜I/Oå’Œç´¢å¼•ç»´æŠ¤æˆæœ¬ï¼ŒæŸ¥è¯¢é€Ÿåº¦å˜æ…¢ã€‚ å†…å­˜/ç£ç›˜å‹åŠ›: å¤§é‡æ•°æ®å’Œç´¢å¼•ä¼šå ç”¨æ›´å¤šå†…å­˜ï¼ˆInnoDB Buffer Poolï¼‰å’Œç£ç›˜ç©ºé—´ã€‚ å¹¶éç»å¯¹é™åˆ¶ è¿™ä¸ªå€¼æ˜¯åŸºäº OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†ï¼‰åœºæ™¯å’Œå¸¸è§ç¡¬ä»¶ï¼ˆå¦‚æ™®é€šSSDï¼‰çš„ç»éªŒå€¼ã€‚ å¦‚æœç¡¬ä»¶æ€§èƒ½å¼ºåŠ²ã€ç´¢å¼•è®¾è®¡åˆç†ã€æŸ¥è¯¢æ¨¡å¼ç®€å•ï¼Œå•è¡¨æ”¯æŒæ›´å¤§è¡Œæ•°ï¼ˆå¦‚MySQL 5.7+ InnoDBæ”¯æŒ2000äº¿è¡Œï¼Œä½†æ€§èƒ½ä¼šå—å½±å“ï¼‰ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚ è¶…è¿‡2000ä¸‡æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨ã€åˆç†ç´¢å¼•ã€ç¡¬ä»¶å‡çº§æˆ–å‚æ•°è°ƒä¼˜ç­‰ç­–ç•¥ã€‚ å‚è€ƒæ–‡æ¡£ ä¸ºä»€ä¹ˆè¯´MySQLå•è¡¨è¡Œæ•°ä¸è¦è¶…è¿‡2000w? ä¸ºä»€ä¹ˆå•è¡¨ä¸è¦è¶…è¿‡ 2000w "},{"id":318,"href":"/database/mysql/update-delete-lock/","title":"MySQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ","parent":"MySQL","content":"MySQL åœ¨æ‰§è¡Œ UPDATE / DELETE æ—¶ï¼Œå¦‚ä½•é˜²æ­¢åˆ«çš„äº‹åŠ¡å¯¹åŒä¸€æ‰¹æ•°æ®è¿›è¡Œ INSERT / UPDATE / DELETE çš„å¹²æ‰°ã€‚\næ€»ç»“ è¦é˜²æ­¢å…¶å®ƒæ“ä½œå½±å“ä½ æ­£åœ¨ UPDATE/DELETE çš„æ•°æ®ï¼Œæ ¸å¿ƒæ˜¯ï¼šç”¨æ­£ç¡®çš„ InnoDB é”ï¼ˆè®°å½•é”ã€é—´éš™é”ã€Next-Key Lockï¼‰ï¼Œå¹¶ç¡®ä¿èµ°ç´¢å¼•ã€‚\nUPDATE / DELETE åœ¨æ‰§è¡Œæ—¶ï¼š\nè‡ªåŠ¨å¯¹ç›®æ ‡è¡ŒåŠ  æ’ä»–é”ï¼ˆX é”ï¼‰ -\u0026gt; é˜²æ­¢å…¶ä»–äº‹åŠ¡ UPDATE/DELETE è‡ªåŠ¨åŠ  Next-Key Lockï¼ˆè®°å½•é” + é—´éš™é”ï¼‰ -\u0026gt; é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨èŒƒå›´å†… INSERT å¦‚æœè¯­å¥ä¸èƒ½èµ°ç´¢å¼• -\u0026gt; ä¼šé”å…¨è¡¨ï¼ˆéå¸¸å±é™©ï¼ï¼‰ ğŸ“Œ MySQL åœ¨ UPDATE / DELETE æ—¶çš„å®é™…è¡Œä¸ºï¼ˆé‡ç‚¹ï¼‰ â‘  UPDATE / DELETE ä¼šè‡ªåŠ¨åŠ  X é”ï¼ˆRecord Lockï¼‰ ä¾‹å¦‚ï¼š\nUPDATE users SET age=30 WHERE id=10; é”ä½è®°å½• id=10ï¼š\nğŸ”’ é˜»æ­¢å…¶å®ƒäº‹åŠ¡ UPDATE è¿™è¡Œ ğŸ”’ é˜»æ­¢å…¶å®ƒäº‹åŠ¡ DELETE è¿™è¡Œ âŒ ä¸é˜»æ­¢ SELECTï¼ˆå¿«ç…§è¯»ï¼‰ â‘¡ WHERE æ˜¯èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œä¼šåŠ  Next-Key Lock ä¾‹å¦‚ï¼š\nDELETE FROM orders WHERE amount \u0026gt; 100 AND amount \u0026lt; 500; InnoDB ä¼šè‡ªåŠ¨åŠ  Next-Key Lockï¼ˆè®°å½•é” + é—´éš™é”ï¼‰ï¼š\nğŸ”’ é˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ï¼ˆINSERTï¼‰ ğŸ”’ é˜»æ­¢å…¶ä»–äº‹åŠ¡æ›´æ–°å‘½ä¸­è¯¥èŒƒå›´çš„æ•°æ® ğŸ”’ é˜²æ­¢å¹»è¯» ä¹Ÿå°±æ˜¯è¯´ï¼š\nä½ çš„ DELETE æ­£åœ¨æ‰«æèŒƒå›´\nå…¶ä»–äººä¸èƒ½åœ¨è¿™ä¸ªèŒƒå›´æ’å…¥ ä¹Ÿä¸èƒ½æ›´æ–°èŒƒå›´å†…è®°å½• ä¹Ÿä¸èƒ½åˆ é™¤èŒƒå›´å†…è®°å½• â‘¢ å¦‚æœ WHERE æ²¡æœ‰èµ°ç´¢å¼• -\u0026gt; é”å…¨è¡¨ ä¾‹å¦‚ï¼š\nUPDATE users SET status=1 WHERE name=\u0026#39;abc\u0026#39;; ä½† name æ²¡æœ‰ç´¢å¼• -\u0026gt; äº§ç”Ÿï¼š\nå…¨è¡¨æ‰«æ å…¨è¡¨åŠ  Next-Key Lockï¼ å…¶ä»–äº‹åŠ¡å¯¹æ•´å¼ è¡¨çš„ INSERT/UPDATE/DELETE éƒ½ä¼šè¢«é˜»å¡ã€‚\nâ‘£ INSERT ä¼šè¢«é—´éš™é”é˜»æ­¢ äº‹åŠ¡ Aï¼š\nUPDATE users SET score = score + 10 WHERE id BETWEEN 100 AND 200; è¿™ä¼šé”ä½ï¼š\n[100, 200] ä¹‹é—´çš„æ‰€æœ‰è®°å½• + æ‰€æœ‰é—´éš™ äº‹åŠ¡ Bï¼š\nINSERT INTO users(id, score) VALUES(150, 10); ä¼šè¢«é˜»å¡ï¼Œå› ä¸º 150 åœ¨äº‹åŠ¡ A çš„é”åŒºé—´å†…ã€‚\nğŸ“Œ ç»“è®ºï¼šMySQL è‡ªåŠ¨é˜»æ­¢äº†å…¶å®ƒ UPDATE/DELETE/INSERT UPDATEã€DELETE è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ï¼š\næ“ä½œ æ˜¯å¦é˜»æ­¢åˆ«äºº INSERT æ˜¯å¦é˜»æ­¢åˆ«äºº UPDATE æ˜¯å¦é˜»æ­¢åˆ«äºº DELETE åŸå›  å•ç‚¹ UPDATE âŒï¼ˆå•ç‚¹æ— é—´éš™ï¼‰ âœ… âœ… X Lock èŒƒå›´ UPDATE âœ… âœ… âœ… Next-Key Lock å•ç‚¹ DELETE âŒ âœ… âœ… X Lock èŒƒå›´ DELETE âœ… âœ… âœ… Next-Key Lock ğŸ“Œ å¦‚ä½•æ‰‹åŠ¨åŠ å¼ºéš”ç¦»ï¼Ÿï¼ˆä¸šåŠ¡å¸¸ç”¨ï¼‰ å¦‚æœå¸Œæœ›â€œå½“å‰äº‹åŠ¡æ“ä½œçš„æ•°æ®å®Œå…¨é¿å…å¤–ç•Œæ”¹åŠ¨â€ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\næ–¹æ¡ˆ 1ï¼šæ˜¾å¼åŠ é”ï¼ˆFOR UPDATEï¼‰ å…ˆé”è¡Œï¼Œå†æ›´æ–°\nSELECT * FROM users WHERE id IN (1,2,3) FOR UPDATE; UPDATE users SET ... WHERE id IN (1,2,3); ä¼˜ç‚¹ï¼š\nå¼ºåˆ¶é”å®šç›®æ ‡è®°å½• é˜»æ­¢å…¶å®ƒ UPDATE/DELETE ç¡®ä¿ä¸ä¼šå‘ç”Ÿå¹¶å‘è¦†ç›– æ–¹æ¡ˆ 2ï¼šä½¿ç”¨äº‹åŠ¡åŒ…è£¹ UPDATE / DELETE æŠŠæ‰€æœ‰æ“ä½œå˜æˆä¸€ä¸ªåŸå­è¿‡ç¨‹ï¼š\nSTART TRANSACTION; UPDATE/DELETE ...; -- å…¶å®ƒæ£€æŸ¥ã€ä¸šåŠ¡é€»è¾‘ -- è®¡ç®—æ–°å€¼ COMMIT; æ–¹æ¡ˆ 3ï¼šä½¿ç”¨æœ€ç²¾ç¡®çš„ç´¢å¼•ï¼ˆéå¸¸é‡è¦ï¼‰ å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼š\nUPDATE/DELETE ä¼šé”è¡¨ ä¼šé˜»å¡åˆ«äººæ‰€æœ‰å†™å…¥ æ€§èƒ½æå·® å¦‚æœæœ‰ç´¢å¼•ï¼š\nç²¾ç¡®é”å®šè®°å½• å‡å°‘å†²çª é¿å…é”æ‰©å¤§åŒ– æ–¹æ¡ˆ 4ï¼šèŒƒå›´æ“ä½œä¸€å®šè¦ä½¿ç”¨ç´¢å¼• ä¾‹å¦‚ï¼š\nâŒ è¿™æ ·ä¼šé”è¡¨ï¼š\nDELETE FROM msg WHERE created_at \u0026lt; \u0026#39;2020-01-01\u0026#39;; âœ… åº”åŠ ç´¢å¼•ï¼š\nALTER TABLE msg ADD INDEX idx_created_at(created_at); ğŸ“Œ å¦‚ä½•è®© UPDATE / DELETE å®Œå…¨éš”ç¦»å¹¶å‘å†™ï¼Ÿ ä¸€èˆ¬ç”¨è¿™ä¸¤ä¸ªæ–¹æ¡ˆï¼š\næ–¹æ¡ˆ Aï¼šåŠ é”è¯» + ç²¾ç¡® UPDATE START TRANSACTION; SELECT * FROM orders WHERE id = 123 FOR UPDATE; UPDATE orders SET status = \u0026#39;done\u0026#39; WHERE id = 123; COMMIT; è¿™æ—¶ï¼š\nå…¶å®ƒäº‹åŠ¡ä¸èƒ½ UPDATE åŒä¸€è¡Œ ä¹Ÿä¸èƒ½ DELETE åŒä¸€è¡Œ ä¸èƒ½ INSERT å†²çªèŒƒå›´ï¼ˆè‹¥æ˜¯èŒƒå›´æŸ¥è¯¢ï¼‰ æ–¹æ¡ˆ Bï¼šèŒƒå›´é” + UPDATE æ¯”å¦‚ä½ å¸Œæœ›èŒƒå›´å†…æ•°æ®å®Œå…¨ç”±ä½ ç‹¬å ï¼š\nSTART TRANSACTION; SELECT * FROM users WHERE score BETWEEN 100 AND 200 FOR UPDATE; UPDATE users SET level = level + 1 WHERE score BETWEEN 100 AND 200; COMMIT; è¿™ä¼šé”å®šï¼š\næ‰€æœ‰åŒ¹é…è¡Œçš„è®°å½•é” æ‰€æœ‰é—´éš™é” -\u0026gt; å…¶å®ƒäº‹åŠ¡æ— æ³•æ’å…¥ç¬¦åˆæ¡ä»¶çš„è®°å½•\nå®Œå…¨éš”ç¦»ï¼Œç»å¯¹å®‰å…¨ã€‚\nğŸ“Œ å®æˆ˜æ€»ç»“ï¼ˆæœ€æƒå¨åšæ³•ï¼‰ è¦é˜²æ­¢åˆ«äººå¯¹ä½ æ­£åœ¨ UPDATE/DELETE çš„æ•°æ®è¿›è¡Œè¯»å†™ï¼š\néœ€æ±‚ ä½¿ç”¨ é˜²æ­¢åˆ«äºº UPDATE/DELETE åŒä¸€è¡Œ è‡ªåŠ¨åŠ çš„ X é” é˜²æ­¢åˆ«äºº INSERT å†²çªæ•°æ® ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ -\u0026gt; Next-Key Lock é˜²æ­¢åˆ«äººå¹¶å‘ä¿®æ”¹åŒä¸€æ‰¹æ•°æ® SELECT â€¦ FOR UPDATE é˜²æ­¢å†™å…¥å†²çªä¸”ç¡®ä¿å¼ºä¸€è‡´ ä½¿ç”¨äº‹åŠ¡åŒ…è£¹ ","description":"MySQL åœ¨æ‰§è¡Œ UPDATE / DELETE æ—¶ï¼Œå¦‚ä½•é˜²æ­¢åˆ«çš„äº‹åŠ¡å¯¹åŒä¸€æ‰¹æ•°æ®è¿›è¡Œ INSERT / UPDATE / DELETE çš„å¹²æ‰°ã€‚\næ€»ç»“ è¦é˜²æ­¢å…¶å®ƒæ“ä½œå½±å“ä½ æ­£åœ¨ UPDATE/DELETE çš„æ•°æ®ï¼Œæ ¸å¿ƒæ˜¯ï¼šç”¨æ­£ç¡®çš„ InnoDB é”ï¼ˆè®°å½•é”ã€é—´éš™é”ã€Next-Key Lockï¼‰ï¼Œå¹¶ç¡®ä¿èµ°ç´¢å¼•ã€‚\nUPDATE / DELETE åœ¨æ‰§è¡Œæ—¶ï¼š\nè‡ªåŠ¨å¯¹ç›®æ ‡è¡ŒåŠ  æ’ä»–é”ï¼ˆX é”ï¼‰ -\u0026gt; é˜²æ­¢å…¶ä»–äº‹åŠ¡ UPDATE/DELETE è‡ªåŠ¨åŠ  Next-Key Lockï¼ˆè®°å½•é” + é—´éš™é”ï¼‰ -\u0026gt; é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨èŒƒå›´å†… INSERT å¦‚æœè¯­å¥ä¸èƒ½èµ°ç´¢å¼• -\u0026gt; ä¼šé”å…¨è¡¨ï¼ˆéå¸¸å±é™©ï¼ï¼‰ ğŸ“Œ MySQL åœ¨ UPDATE / DELETE æ—¶çš„å®é™…è¡Œä¸ºï¼ˆé‡ç‚¹ï¼‰ â‘  UPDATE / DELETE ä¼šè‡ªåŠ¨åŠ  X é”ï¼ˆRecord Lockï¼‰ ä¾‹å¦‚ï¼š\n"},{"id":319,"href":"/database/mysql/backup-restore/","title":"MySQL å¤‡ä»½ä¸æ¢å¤","parent":"MySQL","content":"é€‚ç”¨ MySQL 8.xã€ç”Ÿäº§ç¯å¢ƒã€Kubernetesã€ç‰©ç†/é€»è¾‘å¤‡ä»½åœºæ™¯ã€‚\n1. ä¸ºä»€ä¹ˆå¤‡ä»½æ˜¯æ ¸å¿ƒè¿ç»´ é˜²æ­¢è¯¯åˆ æ•°æ®ã€è¯¯æ“ä½œ é˜²æ­¢ç¡¬ä»¶å´©æºƒã€ç£ç›˜æŸå é˜²æ­¢è¢«å‹’ç´¢ç—…æ¯’ç ´å é˜²æ­¢ç¨‹åº Bug è¦†ç›–æ•°æ® ä¸šåŠ¡è¿ç»­æ€§ï¼ˆRPOã€RTO æŒ‡æ ‡ï¼‰ æ ¸å¿ƒåŸåˆ™ï¼šæ²¡æœ‰æ¢å¤éªŒè¯çš„å¤‡ä»½ = æ²¡å¤‡ä»½ã€‚\n2. MySQL å¸¸è§å¤‡ä»½ç±»å‹ï¼ˆæ€»ä½“ç»“æ„ï¼‰ MySQL å¤‡ä»½åˆ†ä¸º 3 ç±»ï¼š\nç±»å‹ å·¥å…· ç‰¹ç‚¹ æ˜¯å¦å¯çƒ­å¤‡ é€»è¾‘å¤‡ä»½ mysqldump / mydumper SQL æ–‡æœ¬ âœ… çƒ­å¤‡ ç‰©ç†å¤‡ä»½ XtraBackup äºŒè¿›åˆ¶é¡µæ–‡ä»¶æ‹·è´ âœ… çƒ­å¤‡ï¼ˆæœ€å¸¸ç”¨ï¼‰ å¿«ç…§å¤‡ä»½ LVM snapshot / ZFS / Ceph ç§’çº§å¿«ç…§ âœ… çƒ­å¤‡ å»ºè®®ï¼šç”Ÿäº§çº§ç»Ÿä¸€é‡‡ç”¨ XtraBackup + Binlog + å‘¨æœŸå…¨é‡/å¢é‡ã€‚\n3. é€»è¾‘å¤‡ä»½ï¼ˆmysqldump / mydumperï¼‰ é€‚åˆï¼šå°ä¸šåŠ¡ã€å¯è¯»æ€§é«˜ã€è·¨ç‰ˆæœ¬è¿ç§»ã€‚\n3.1 mysqldumpï¼ˆè½»é‡çº§é€»è¾‘å¤‡ä»½ï¼‰ å¸¸ç”¨å‘½ä»¤ï¼š\nğŸ”¸ å…¨åº“å¤‡ä»½ mysqldump -uroot -p --single-transaction --master-data=2 --all-databases \u0026gt; full.sql å¿…åŠ å‚æ•°è§£é‡Šï¼ˆå¢å¼ºç‰ˆï¼‰\nå‚æ•° ç”¨é€” \u0026ndash;single-transaction InnoDB çƒ­å¤‡ä¸é”è¡¨ï¼ˆå¿…é¡»åŠ ï¼‰ \u0026ndash;master-data=2 è®°å½•å½“å‰ binlog ä½ç‚¹ï¼Œç”¨äºæ¢å¤å¤åˆ¶ \u0026ndash;skip-lock-tables é˜²æ­¢ MyISAM é”è¡¨ \u0026ndash;set-gtid-purged=OFF é€‚ç”¨ GTID ç¯å¢ƒé¿å…å†²çª \u0026ndash;hex-blob é˜²æ­¢ blob å‡ºé”™ é€Ÿåº¦æ…¢ï¼Œé€‚ç”¨äºå°åº“ã€ç»“æ„å¯¼å‡ºã€‚\n3.2 mydumperï¼ˆé«˜æ€§èƒ½é€»è¾‘å¤‡ä»½ï¼‰ mydumper = åŠ é€Ÿç‰ˆ mysqldumpï¼ˆå¤šçº¿ç¨‹ã€é«˜é€Ÿï¼‰\nå¤‡ä»½\nmydumper -u root -p pass \\ --outputdir=/backup \\ --threads=8 \\ --compress \\ --build-empty-files \\ --trx-consistency-only æ¢å¤\nmyloader -u root -p pass \\ --directory=/backup \\ --threads=16 é€Ÿåº¦å¯è¾¾ mysqldump çš„ 10 å€ã€‚\n4. ç‰©ç†å¤‡ä»½ï¼ˆXtraBackupï¼‰â€”- ç”Ÿäº§å¿…ç”¨ XtraBackup = Percona çš„ MySQL çƒ­å¤‡å·¥å…·\nç‰¹ç‚¹ï¼š\nçƒ­å¤‡ï¼Œä¸é”å†™ æ”¯æŒå…¨é‡+å¢é‡ æ”¯æŒæ¢å¤ binlog ä½ç‚¹ æ¢å¤é€Ÿåº¦æå¿« 4.1 å…¨é‡å¤‡ä»½ï¼ˆæœ€å¸¸ç”¨ï¼‰ xtrabackup --backup \\ --target-dir=/backup/full \\ --user=root --password=123456 4.2 å¢é‡å¤‡ä»½ ç¬¬ä¸€å¤©ï¼š\nxtrabackup --backup \\ --target-dir=/backup/inc1 \\ --incremental-basedir=/backup/full ç¬¬äºŒå¤©ï¼š\nxtrabackup --backup \\ --target-dir=/backup/inc2 \\ --incremental-basedir=/backup/inc1 4.3 å¤‡ä»½åçš„å‡†å¤‡ï¼ˆapply logï¼‰ æ¢å¤å‰å¿…é¡»æ‰§è¡Œï¼š\nå…¨é‡ï¼š\nxtrabackup --prepare --target-dir=/backup/full å…¨é‡ + å¢é‡ï¼š\nxtrabackup --prepare --apply-log-only --target-dir=/backup/full xtrabackup --prepare --apply-log-only --target-dir=/backup/full --incremental-dir=/backup/inc1 xtrabackup --prepare --target-dir=/backup/full --incremental-dir=/backup/inc2 4.4 æ¢å¤ systemctl stop mysql xtrabackup --copy-back --target-dir=/backup/full chown -R mysql:mysql /var/lib/mysql systemctl start mysql æ¢å¤é€Ÿåº¦å¿«ï¼Œé€‚åˆ TB çº§æ•°æ®ã€‚\n5. Binlog å¤‡ä»½ï¼ˆå¢é‡æ¢å¤å…³é”®ï¼‰ äº‹åŠ¡çº§æ¢å¤ã€è¯¯åˆ æ¢å¤å¿…é¡»ä½¿ç”¨ binlogã€‚\nå¼€å¯ï¼š\nlog_bin = mysql-bin binlog_format = ROW sync_binlog = 1 æŸ¥çœ‹ binlogï¼š\nmysqlbinlog mysql-bin.000123 | less 6. å¸¸è§æ¢å¤åœºæ™¯ï¼ˆå¢å¼ºç‰ˆï¼‰ åœºæ™¯ 1ï¼šè¯¯åˆ è¡¨ï¼ˆDROP TABLEï¼‰ æµç¨‹ï¼š\næ‰¾åˆ°æœ€è¿‘å…¨é‡å¤‡ä»½ æ¢å¤åˆ°ä¸´æ—¶ MySQL å®ä¾‹ ä½¿ç”¨ binlog point-in-time æ¢å¤åˆ° drop ä¹‹å‰ å¯¼å‡ºæ•°æ® å¯¼å…¥æ­£å¼åº“ å‘½ä»¤ï¼š\nmysqlbinlog --start-datetime=\u0026#34;2025-01-10 10:00:00\u0026#34; \\ --stop-datetime=\u0026#34;2025-01-10 11:00:00\u0026#34; \\ mysql-bin.000023 \u0026gt; recover.sql mysql \u0026lt; recover.sql åœºæ™¯ 2ï¼šè¯¯åˆ è¡Œï¼ˆDELETEï¼‰ æ¢å¤åŒæ ·ä½¿ç”¨ binlogï¼š\nmysqlbinlog --start-position=12345 --stop-position=56789 \\ mysql-bin.000024 \u0026gt; recover.sql åœºæ™¯ 3ï¼šæ­å»ºä¸»ä»å¤åˆ¶ï¼ˆç”¨å¤‡ä»½æ¢å¤ï¼‰ æ¨èä½¿ç”¨ï¼š\nmysqldump --master-data=2 æˆ–\nxtrabackup --binlog-info=on æ¢å¤åï¼š\nCHANGE MASTER TO MASTER_HOST=\u0026#39;master\u0026#39;, MASTER_USER=\u0026#39;repl\u0026#39;, MASTER_PASSWORD=\u0026#39;xxx\u0026#39;, MASTER_LOG_FILE=\u0026#39;mysql-bin.000123\u0026#39;, MASTER_LOG_POS=45678; START SLAVE; 7. ä¸€è‡´æ€§å¤‡ä»½ï¼ˆéå¸¸é‡è¦ï¼‰ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿è¯ä¸€è‡´æ€§ã€‚\næ–¹æ¡ˆï¼š\næ–¹æ³• ä¸€è‡´æ€§ è¯´æ˜ mysqldump + single-transaction âœ… æœ€ç®€å• XtraBackup âœ… æœ€æ¨è LVM snapshot âœ… ç§’çº§å¿«ç…§ï¼Œè¦æ±‚ä¸šåŠ¡æš‚åœå†™å…¥ 1ms MGR / PXC å¤šå‰¯æœ¬ âœ… å»ºè®®åŸºç¡€æ¶æ„å±‚çº§å®ç° å¼ºä¸€è‡´æ€§ä¼˜å…ˆçº§ï¼šXtraBackup \u0026gt; LVM \u0026gt; mysqldump\n8. è‡ªåŠ¨åŒ–å¤‡ä»½ç­–ç•¥ï¼ˆä¼ä¸šçº§ï¼‰ 8.1 æ¯æ—¥å…¨é‡å¤‡ä»½ + ç§’çº§ Binlog æ¯å¤© 02:00 å…¨é‡å¤‡ä»½ æ¯ 5 åˆ†é’Ÿ binlog å¤‡ä»½ ä¿ç•™ 7ï½30 å¤© 8.2 å†·çƒ­åˆ†ç¦» å…¨é‡å¤‡ä»½ä¸Šä¼ å¯¹è±¡å­˜å‚¨ï¼ˆS3 / OSS / MinIOï¼‰ binlog æŒç»­æµå…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka / Pulsarï¼‰ 8.3 Kubernetes ç¯å¢ƒ å®¹å™¨å†…å¤‡ä»½æ–¹å¼ï¼š\nsidecar å¤‡ä»½å®¹å™¨ CronJob + PVC MinIO è¿œç¨‹å¤‡ä»½ 9. å¤‡ä»½æ ¡éªŒï¼ˆä¸èƒ½å¿½ç•¥ï¼‰ æ£€æŸ¥ä¸¤é¡¹ï¼š\næ–‡ä»¶å®Œæ•´æ€§ xtrabackup --prepare --target-dir=/backup/full å¯æ¢å¤æ€§ æ¢å¤åˆ°ç‹¬ç«‹ MySQL å®ä¾‹ä¸­éªŒè¯ã€‚\nä¼ä¸šè¦æ±‚ï¼š\næ¯å‘¨å¿…é¡»æ‰§è¡Œä¸€æ¬¡æ¢å¤éªŒè¯ æ¯æœˆå¿…é¡»å¯¹å…¨é‡å¤‡ä»½åšä¸€æ¬¡æ·±åº¦æ¢å¤æ¼”ç»ƒ 10. MySQL å¤‡ä»½æ¢å¤é»„é‡‘æ³•åˆ™ï¼ˆæœ€ç»ˆæ€»ç»“ï¼‰ ğŸ”¥ æœ€é‡è¦çš„ 10 ç‚¹ï¼š\nå¤‡ä»½å¿…é¡»æ”¯æŒ point-in-time æ¢å¤ï¼ˆbinlogï¼‰ã€‚ å¤‡ä»½å¿…é¡»å¯æ¢å¤ï¼Œè€Œä¸ä»…æ˜¯å¯å¤‡ä»½ã€‚ ç”Ÿäº§åº“ä¸€å¾‹ä½¿ç”¨ XtraBackupã€‚ mysqldump ä¸é€‚åˆå¤§è¡¨ \u0026gt; 50GBã€‚ å¤‡ä»½å¿…é¡»å’Œåº”ç”¨å†™å…¥ä¸€è‡´ï¼ˆsingle-transactionï¼‰ã€‚ å¤‡ä»½æ–‡ä»¶å¿…é¡»åŠ å‹ç¼©ä¸æ ¡éªŒã€‚ å¤‡ä»½å¿…é¡»ç¦»çº¿ä¿å­˜ï¼ˆå¯¹è±¡å­˜å‚¨ã€å¼‚åœ°å¤‡ä»½ï¼‰ã€‚ ä¸»ä»æ¶æ„å¿…é¡»åŸºäºå¤‡ä»½æ¢å¤ï¼Œè€Œä¸æ˜¯å¯¼åº“ã€‚ æ¢å¤å‰å¿…é¡» apply-logã€‚ æ¯æ¬¡å¤‡ä»½å¿…é¡»éªŒè¯æ¢å¤èƒ½åŠ›ï¼Œå®šæœŸæ¼”ç»ƒã€‚ ","description":"é€‚ç”¨ MySQL 8.xã€ç”Ÿäº§ç¯å¢ƒã€Kubernetesã€ç‰©ç†/é€»è¾‘å¤‡ä»½åœºæ™¯ã€‚\n1. ä¸ºä»€ä¹ˆå¤‡ä»½æ˜¯æ ¸å¿ƒè¿ç»´ é˜²æ­¢è¯¯åˆ æ•°æ®ã€è¯¯æ“ä½œ é˜²æ­¢ç¡¬ä»¶å´©æºƒã€ç£ç›˜æŸå é˜²æ­¢è¢«å‹’ç´¢ç—…æ¯’ç ´å é˜²æ­¢ç¨‹åº Bug è¦†ç›–æ•°æ® ä¸šåŠ¡è¿ç»­æ€§ï¼ˆRPOã€RTO æŒ‡æ ‡ï¼‰ æ ¸å¿ƒåŸåˆ™ï¼šæ²¡æœ‰æ¢å¤éªŒè¯çš„å¤‡ä»½ = æ²¡å¤‡ä»½ã€‚\n2. MySQL å¸¸è§å¤‡ä»½ç±»å‹ï¼ˆæ€»ä½“ç»“æ„ï¼‰ MySQL å¤‡ä»½åˆ†ä¸º 3 ç±»ï¼š\nç±»å‹ å·¥å…· ç‰¹ç‚¹ æ˜¯å¦å¯çƒ­å¤‡ é€»è¾‘å¤‡ä»½ mysqldump / mydumper SQL æ–‡æœ¬ âœ… çƒ­å¤‡ ç‰©ç†å¤‡ä»½ XtraBackup äºŒè¿›åˆ¶é¡µæ–‡ä»¶æ‹·è´ âœ… çƒ­å¤‡ï¼ˆæœ€å¸¸ç”¨ï¼‰ å¿«ç…§å¤‡ä»½ LVM snapshot / ZFS / Ceph ç§’çº§å¿«ç…§ âœ… çƒ­å¤‡ å»ºè®®ï¼šç”Ÿäº§çº§ç»Ÿä¸€é‡‡ç”¨ XtraBackup + Binlog + å‘¨æœŸå…¨é‡/å¢é‡ã€‚\n"},{"id":320,"href":"/database/mysql/performance/","title":"MySQL æ€§èƒ½ä¼˜åŒ–","parent":"MySQL","content":" é€‚ç”¨ç‰ˆæœ¬ï¼šMySQL 8.x é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§é›†ç¾¤ã€K8S éƒ¨ç½²ã€é«˜å¹¶å‘ä¸šåŠ¡ã€é«˜å¯ç”¨æ¶æ„ å†…å®¹ä½“ç³»ï¼šæŸ¥è¯¢ä¼˜åŒ– -\u0026gt; ç´¢å¼•ä¼˜åŒ– -\u0026gt; è¡¨ç»“æ„ä¼˜åŒ– -\u0026gt; InnoDB å¼•æ“ä¼˜åŒ– -\u0026gt; my.cnf æ¨èé…ç½® -\u0026gt; æ¶æ„ä¼˜åŒ– -\u0026gt; ç³»ç»Ÿä¼˜åŒ– -\u0026gt; è¿ç»´ä¼˜åŒ– -\u0026gt; æ€§èƒ½ç›‘æ§ -\u0026gt; æœ€ç»ˆé»„é‡‘æ³•åˆ™ 1. SQL æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæœ€é‡è¦çš„ä¼˜åŒ–æ–¹å‘ï¼‰ SQL æ˜¯ MySQL æ€§èƒ½çš„å†³å®šå› ç´ ï¼Œ80% çš„é—®é¢˜æ¥è‡ª SQL è®¾è®¡é”™è¯¯ã€‚\n1.1 ä½¿ç”¨ EXPLAIN åˆ†æ SQL EXPLAIN æ˜¯ SQL ä¼˜åŒ–çš„å…¥å£\né‡ç‚¹å­—æ®µï¼š\nå­—æ®µ è¯´æ˜ type è®¿é—®ç±»å‹ï¼Œå†³å®šæ‰«ææ•ˆç‡ï¼ˆæœ€å…³é”®ï¼‰ possible_keys å“ªäº›ç´¢å¼•å¯ä½¿ç”¨ key å®é™…ä½¿ç”¨çš„ç´¢ rows æ‰«æè¡Œæ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼‰ Extra æ˜¯å¦å‡ºç° filesortã€temporary typeï¼šé«˜æ€§èƒ½è®¿é—®è·¯å¾„ä»å¥½åˆ°å\nsystem \u0026gt; const \u0026gt; eq_ref \u0026gt; ref \u0026gt; range \u0026gt; index \u0026gt; ALL ç›®æ ‡ï¼šé¿å… ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œé¿å… Using filesort / Using temporaryã€‚\n1.2 å¸¸è§æ…¢ SQL ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰ ğŸ”¸1ï¼‰é¿å… SELECT * æ˜ç¡®å­—æ®µï¼Œå‡å°‘ IOã€ç½‘ç»œã€è¡Œæ ¼å¼è§£æ å‡å°‘è¯»å–ã€å‡å°‘ç½‘ç»œä¼ è¾“ é¿å…è¦†ç›–ç´¢å¼•å¤±æ•ˆ ğŸ”¸2ï¼‰LIMIT å¤§åç§»ä¼˜åŒ– SELECT * FROM log ORDER BY id LIMIT 100000, 20; -\u0026gt; ä¼šæ‰«æ 100000 è¡Œ\næ”¹ä¸ºï¼š\nSELECT * FROM log WHERE id \u0026gt; 100000 ORDER BY id LIMIT 20; æˆ–ä½¿ç”¨ è¦†ç›–ç´¢å¼• + å­æŸ¥è¯¢ã€‚\nğŸ”¸3ï¼‰å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆæ ¸å¿ƒåŸåˆ™ï¼‰ WHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39; å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼Œå› ä¸º MySQL éœ€è¦é€è¡Œè®¡ç®—å‡½æ•°ã€‚\næ­£ç¡®å†™æ³•ï¼š\nWHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2024-01-02\u0026#39; ğŸ”¸4ï¼‰éšå¼ç±»å‹è½¬æ¢å¯¼è‡´å…¨è¡¨æ‰«æ æ‰‹æœºå·å­—æ®µä¸º VARCHAR æ—¶ï¼š\nWHERE phone = 12345678901 -- ç´¢å¼•å¤±æ•ˆ phone æ˜¯ varchar -\u0026gt; ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ\næ”¹ä¸ºï¼š\nWHERE phone = \u0026#39;12345678901\u0026#39; ğŸ”¸5ï¼‰é¿å…åœ¨ OR ä¸­æ··ç”¨æœªç´¢å¼•å­—æ®µ WHERE a = ? OR b = ? ä¼˜åŒ–ï¼š\nç”¨ UNION ALL æˆ–å°† b åŠ ç´¢å¼• 2. ç´¢å¼•ä¼˜åŒ–ï¼ˆé«˜æ€§èƒ½æ ¸å¿ƒï¼‰ 2.1 ç´¢å¼•é€‚ç”¨åœºæ™¯ WHERE æ¡ä»¶é«˜é€‰æ‹©æ€§å­—æ®µ JOIN çš„ ON å­—æ®µ ORDER BY / GROUP BY å­—æ®µ é•¿å­—ç¬¦ä¸²æ”¹ HASH ç´¢å¼•ï¼ˆå‰ç¼€ç´¢å¼•ï¼‰ 2.2 ç´¢å¼•è®¾è®¡é»„é‡‘æ³•åˆ™ï¼ˆå¢å¼ºç‰ˆï¼‰ ğŸ”¸1ï¼‰æœ€å·¦å‰ç¼€åŸåˆ™ ç´¢å¼• (a, b, c)ï¼š\nâœ… å¯ç”¨äº WHERE a = ? âœ… å¯ç”¨äº WHERE a = ? AND b = ? âŒ ä¸å¯ç”¨äº WHERE b = ? æˆ– WHERE b = ? AND c = ? ğŸ”¸2ï¼‰ç­‰å€¼ä¼˜å…ˆã€èŒƒå›´æ»å èŒƒå›´ä¹‹åçš„å­—æ®µå¤±æ•ˆï¼š\nWHERE a = 1 AND b \u0026gt; 10 AND c = 20 ç´¢å¼• (a, b, c) ä¸­çš„ c ä¸ä¼šè¢«ä½¿ç”¨ã€‚\nğŸ”¸3ï¼‰è¦†ç›–ç´¢å¼•æœ€å¼ºï¼ˆé¿å…å›è¡¨ï¼‰ select å’Œ where éƒ½åœ¨ç´¢å¼•é‡Œ -\u0026gt; æå¿«\nğŸ”¸4ï¼‰é¿å…é‡å¤ç´¢å¼•ã€å¤šä½™ç´¢å¼• å¦‚åŒæ—¶å­˜åœ¨ï¼š\nidx(a) idx(a,b) -\u0026gt; idx(a) å¤šä½™ã€‚\nå‡å°‘ç»´æŠ¤æˆæœ¬ã€å‡å°‘æ•°æ®å†™å…¥å¼€é”€ã€‚\nğŸ”¸5ï¼‰ä¸é€‚åˆåŠ ç´¢å¼•çš„æƒ…å†µ ä½é€‰æ‹©æ€§å­—æ®µï¼ˆå¦‚ æ€§åˆ«ã€å¸ƒå°”ï¼‰ é«˜é¢‘æ›´æ–°å­—æ®µ å¤§æ–‡æœ¬å­—æ®µï¼ˆTEXTã€JSONï¼‰ è¡¨å¤ªå°ï¼ˆç´¢å¼•åè€Œæ…¢ï¼‰ 3. è¡¨ç»“æ„è®¾è®¡ä¼˜åŒ–ï¼ˆå¢å¼ºç‰ˆï¼‰ 3.1 å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™ å­—æ®µç±»å‹ æ¨èç¨‹åº¦ åŸå›  INT / BIGINT â­â­â­â­â­ æ€§èƒ½æœ€å¥½ï¼Œå­˜å‚¨å° VARCHAR â­â­â­â­ çµæ´»ã€èŠ‚çœç©ºé—´ DATETIME(6) â­â­â­â­ ç²¾ç¡®åˆ°å¾®ç§’ DECIMAL â­â­â­ ç²¾ç¡®è®¡ç®— TEXT / BLOB â­ æ…ç”¨ï¼ˆæº¢å‡ºé¡µã€æ…¢ï¼‰ ç±»å‹ ä¼˜å…ˆçº§ åŸå›  INT(M) å¿«ã€ç´§å‡‘ å›ºå®šé•¿åº¦ BIGINT å¤§èŒƒå›´ å…¼å®¹æœªæ¥ VARCHAR èŠ‚çœç©ºé—´ åŠ¨æ€é•¿åº¦ DATETIME(6) æ¨è æ”¯æŒå¾®ç§’ TIMESTAMP ä¸æ¨è 2038 å¹´é—®é¢˜ é¿å…ä½¿ç”¨ TEXTã€BLOBï¼Œèƒ½æ‹†è¡¨å°±æ‹†è¡¨ã€‚\n3.2 è¡Œæ ¼å¼ä¼˜åŒ–ï¼ˆimportantï¼‰ ä½¿ç”¨åˆé€‚çš„è¡Œæ ¼å¼ ROW_FORMAT\næ¨èï¼š\ninnodb_default_row_format = dynamic åŸå› ï¼š\næ”¯æŒåŠ¨æ€åˆ— é¿å… TEXT / VARCHAR æº¢å‡ºç§»åŠ¨ï¼ˆTEXT / VARCHAR é•¿å­—æ®µæº¢å‡ºæ—¶åªå­˜æŒ‡é’ˆï¼‰ é¿å…å¤šæ¬¡ page split 3.3 é¿å…å¤§å­—æ®µï¼ˆTEXT/BLOBï¼‰è¿›å…¥ä¸»è¡¨ å¤§å­—æ®µåº”è¯¥ï¼š\næ”¾åœ¨ç‹¬ç«‹è¡¨ä¸­ é€šè¿‡ä¸»é”®å¼•ç”¨ åŸå› ï¼š\nInnoDB page = 16KBï¼Œä¸€è¡Œè¶Šå¤§ï¼Œè¶Šå®¹æ˜“äº§ç”Ÿæº¢å‡ºé¡µï¼ˆæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼‰ 4. InnoDB å¼•æ“ä¼˜åŒ–ï¼ˆåº•å±‚å¢å¼ºç‰ˆï¼‰ 4.1 Buffer Poolï¼ˆæ€§èƒ½å†³å®šå› ç´ ï¼‰ æ¨èï¼š\ninnodb_buffer_pool_size = 70%~80% å†…å­˜ 16G å†…å­˜ -\u0026gt; åˆ†é… 12G 64G å†…å­˜ -\u0026gt; åˆ†é… 50G Buffer Pool ä½œç”¨ï¼š\nç¼“å­˜æ•°æ®é¡µ ç¼“å­˜ç´¢å¼•é¡µ ç¼“å­˜ undo é¡µ ç¼“å­˜è‡ªé€‚åº”å“ˆå¸Œç´¢å¼• MySQL 90% æ€§èƒ½æ¥è‡ª Buffer Pool æ˜¯å¦è¶³å¤Ÿå¤§ã€‚\n4.2 Buffer Pool å®ä¾‹ innodb_buffer_pool_instances = 8 æ¨è: 8 é€‚ç”¨ï¼šbuffer_pool \u0026gt; 8GB\nå‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘ã€‚\n4.3 Redo Logï¼ˆæé«˜å†™å…¥æ€§èƒ½ï¼‰ innodb_log_file_size = 2G~4G innodb_log_files_in_group = 2 ä½œç”¨ï¼š\né¡ºåºå†™å…¥ï¼Œæä¾›é«˜ IO æ€§èƒ½ å´©æºƒæ¢å¤æ—¶ä¿è¯ä¸€è‡´æ€§ 4.4 Flush ç­–ç•¥ï¼ˆå´©æºƒå®‰å…¨ vs æ€§èƒ½ï¼‰ æœ€å®‰å…¨ï¼š\ninnodb_flush_log_at_trx_commit = 1 sync_binlog = 1 å¦‚ä¸šåŠ¡å¯æ¥å—ä¸¢å¤± 1 ç§’æ•°æ®ï¼Œå¯ä»¥è°ƒä¸ºï¼š\ninnodb_flush_log_at_trx_commit = 2 sync_binlog = 0 4.5 Doublewrite æ‰“å¼€ ä¿è¯å´©æºƒæ¢å¤ä¸€è‡´æ€§ï¼ˆå¼ºä¸€è‡´æ€§å¿…éœ€ï¼‰\n5. ç”Ÿäº§çº§ my.cnfï¼ˆ16G~64G æœåŠ¡å™¨æ¨èï¼‰ ï¼ˆèåˆä¼˜åŒ–å‚æ•°ä¸åŸç†ï¼‰\n[mysqld] #------------------------------------- # åŸºç¡€ #------------------------------------- max_connections = 2000 max_connect_errors = 1000000 #------------------------------------- # ç¼“å­˜ä¸è¡¨ #------------------------------------- table_open_cache = 4096 table_definition_cache = 4096 query_cache_type = 0 query_cache_size = 0 #------------------------------------- # InnoDB #------------------------------------- innodb_buffer_pool_size = 48G innodb_buffer_pool_instances = 8 innodb_log_buffer_size = 256M innodb_log_file_size = 4G innodb_flush_log_at_trx_commit = 1 innodb_flush_method = O_DIRECT innodb_io_capacity = 2000 innodb_io_capacity_max = 4000 innodb_default_row_format = dynamic #------------------------------------- # Binlog #------------------------------------- log_bin = mysql-bin binlog_format = ROW sync_binlog = 1 expire_logs_days = 7 binlog_row_image = FULL #------------------------------------- # æ€§èƒ½ #------------------------------------- performance_schema = ON 6. MySQL æ¶æ„çº§ä¼˜åŒ–ï¼ˆå¢å¼ºç‰ˆï¼‰ 6.1 æœ€é«˜ä¸€è‡´æ€§çš„æ–¹æ¡ˆï¼ˆç”Ÿäº§æ¨èï¼‰ æ¶æ„ å¼ºä¸€è‡´æ€§ å¯ç”¨æ€§ æ¨èæƒ…å†µ InnoDB Clusterï¼ˆMGRï¼‰ â­â­â­â­â­ â­â­â­â­ å®˜æ–¹æœ€æ¨è Percona XtraDB Clusterï¼ˆPXCï¼‰ â­â­â­â­â­ â­â­â­ å†™å…¥å»¶è¿Ÿé«˜ åŠåŒæ­¥å¤åˆ¶ â­â­â­ â­â­â­â­â­ å†™å¢å¤šæƒ…å†µä¸‹å¼ºä¸€è‡´æ€§ä¸å¤Ÿ å¼‚æ­¥å¤åˆ¶ï¼ˆä¸»ä»ï¼‰ â­ â­â­â­â­â­ æœ€å¸¸è§æ–¹æ¡ˆ å¼ºä¸€è‡´æ€§æ¨èï¼š\nğŸ”¸1ï¼‰MySQL InnoDB Clusterï¼ˆå®˜æ–¹é«˜å¯ç”¨ï¼‰ åŸºäº Group Replication è‡ªåŠ¨è„‘è£‚æ£€æµ‹ è‡ªåŠ¨ Failover å¼ºä¸€è‡´æ€§ ğŸ”¸2ï¼‰Percona XtraDB Clusterï¼ˆPXCï¼‰ åˆ†å¸ƒå¼åŒæ­¥å¤åˆ¶ å†™å…¥å¼ºä¸€è‡´æ€§ï¼ˆä½†å»¶è¿Ÿé«˜ï¼‰ 6.2 è¯»å†™åˆ†ç¦» ä¸»åº“å†™ï¼Œå¤šä¸ªä»åº“è¯» å‡è½»ä¸»åº“å‹åŠ› é…åˆ ProxySQL / MySQL Router ä½¿ç”¨ é¿å…åœ¨åº”ç”¨ä¾§åšè´Ÿè½½å‡è¡¡ï¼Œä¼šæœ‰ä¸€è‡´æ€§é—®é¢˜ã€‚\n6.3 åˆ†åº“åˆ†è¡¨ è§¦å‘æ¡ä»¶ï¼š\nå•è¡¨ \u0026gt; 2000 ä¸‡è¡Œ æ•°æ®æ–‡ä»¶ \u0026gt; 100GB ç´¢å¼•å¤±æ•ˆé¢‘ç¹ æŸ¥è¯¢å»¶è¿Ÿ \u0026gt; 50ms ä¸”æ—  SQL ä¼˜åŒ–ç©ºé—´ å·¨å¤§å†™å…¥é‡ï¼ˆå¦‚æ—¥å¿—ç³»ç»Ÿï¼‰ 7. ç³»ç»Ÿçº§ä¼˜åŒ–ï¼ˆæ“ä½œç³»ç»Ÿ + æ–‡ä»¶ç³»ç»Ÿï¼‰ 7.1 æ–‡ä»¶ç³»ç»Ÿ æ¨èä¼˜å…ˆçº§ï¼šXFS \u0026gt; EXT4 \u0026gt; ZFS\n7.2 IO è°ƒåº¦ echo mq-deadline \u0026gt; /sys/block/nvme0n1/queue/scheduler å‡å°‘å†™æ”¾å¤§ï¼Œæé«˜ç¨³å®šæ€§ã€‚\n7.3 ulimitï¼ˆæé«˜ open files é™åˆ¶ï¼‰ ulimit -n 1000000 8. è¿ç»´çº§ä¼˜åŒ–ï¼ˆDBA æœ€ä½³å®è·µï¼‰ 8.1 æ…¢ SQL ç›‘æ§ç­–ç•¥ å¼€å¯ï¼š\nslow_query_log = 1 long_query_time = 1 log_queries_not_using_indexes = 1 8.2 æ•°æ®åº“å·¡æ£€ï¼ˆå»ºè®®æ¯æ—¥ï¼‰ QPS / TPS InnoDB ç¼“å­˜å‘½ä¸­ç‡ å…¨è¡¨æ‰«ææ¬¡æ•° çº¿ç¨‹æ•° å¤åˆ¶å»¶è¿Ÿ ä¸´æ—¶è¡¨æ•°é‡ Binlog å¢é•¿é€Ÿåº¦ å¤§äº‹åŠ¡æ•°é‡ 9. ç›‘æ§ä¸å·¡æ£€ æ¨èç›‘æ§æŒ‡æ ‡ï¼š\nCPU ç”¨æˆ·æ€ \u0026gt; 70% -\u0026gt; SQL è®¡ç®—é‡ I/O wait \u0026gt; 20% -\u0026gt; ç›˜å¾ˆæ…¢ å†…å­˜ Buffer Pool å‘½ä¸­ç‡ \u0026lt; 99% -\u0026gt; å†…å­˜ä¸è¶³ ç£ç›˜ IOPS ä¸å¤Ÿ -\u0026gt; è°ƒæ•´ SSD/NVMe SQL æ…¢æŸ¥è¯¢æ•°é‡ å…¨è¡¨æ‰«ææ•°é‡ æ’åºæ•°é‡ è¿æ¥æ•° max_used_connections \u0026gt; 80% -\u0026gt; é£é™© 10. è¿ç»´æœ€ä½³å®è·µ ç¦æ­¢å¼ºåˆ¶ kill -9 è¿›ç¨‹ï¼ˆæ˜“æŸåæ•°æ®ï¼‰ ç¦æ­¢ä½¿ç”¨ MyISAMï¼ˆä¸æ”¯æŒäº‹åŠ¡ï¼‰ è¡¨è¡Œæ•° \u0026gt; 2000 ä¸‡ è¦åˆ†åº“åˆ†è¡¨ å®šæœŸè¡¨ ANALYZE / OPTIMIZE ä¸šåŠ¡å˜æ›´å‰åš explain é™åˆ¶ ORM è‡ªåŠ¨ç”Ÿæˆ SQL é™åˆ¶å¤§äº‹åŠ¡ï¼ˆè¶…è¿‡ 1 ç§’ï¼‰ æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ + binlog å½’æ¡£ 11. MySQL æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™ï¼ˆæœ€ç»ˆæ€»ç»“ï¼‰ SQL ä¼˜åŒ–ä¼˜å…ˆçº§æœ€é«˜ï¼Œæ°¸è¿œæ’ç¬¬ä¸€ã€‚ ç´¢å¼•è¦è®¾è®¡å¥½ï¼Œè€Œä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚ Buffer Pool è¦è¶³å¤Ÿå¤§ï¼ˆ70%ï½80% å†…å­˜ï¼‰ã€‚ è¡¨é¿å… TEXT/BLOB æ”¾åœ¨ä¸»è¡¨ã€‚ ORDER BY / GROUP BY å¿…é¡»å‘½ä¸­ç´¢å¼•ã€‚ ä¸è¦å¤§äº‹åŠ¡ã€‚ ä¸»ä»å¤åˆ¶ä¸€å®šè¦ç›‘æ§å»¶è¿Ÿã€‚ è·¨æœºæˆ¿å†™å…¥ä¸€å®šç”¨ MGR æˆ– PXCã€‚ æ¯æ¡ SQL ä¸Šçº¿å‰å¿…é¡» explainã€‚ æ•°æ®é‡å¤§äº 2000 ä¸‡å¿…é¡»è§„åˆ’åˆ†è¡¨ã€‚ ","description":" é€‚ç”¨ç‰ˆæœ¬ï¼šMySQL 8.x é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§é›†ç¾¤ã€K8S éƒ¨ç½²ã€é«˜å¹¶å‘ä¸šåŠ¡ã€é«˜å¯ç”¨æ¶æ„ å†…å®¹ä½“ç³»ï¼šæŸ¥è¯¢ä¼˜åŒ– -\u0026gt; ç´¢å¼•ä¼˜åŒ– -\u0026gt; è¡¨ç»“æ„ä¼˜åŒ– -\u0026gt; InnoDB å¼•æ“ä¼˜åŒ– -\u0026gt; my.cnf æ¨èé…ç½® -\u0026gt; æ¶æ„ä¼˜åŒ– -\u0026gt; ç³»ç»Ÿä¼˜åŒ– -\u0026gt; è¿ç»´ä¼˜åŒ– -\u0026gt; æ€§èƒ½ç›‘æ§ -\u0026gt; æœ€ç»ˆé»„é‡‘æ³•åˆ™ 1. SQL æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæœ€é‡è¦çš„ä¼˜åŒ–æ–¹å‘ï¼‰ SQL æ˜¯ MySQL æ€§èƒ½çš„å†³å®šå› ç´ ï¼Œ80% çš„é—®é¢˜æ¥è‡ª SQL è®¾è®¡é”™è¯¯ã€‚\n1.1 ä½¿ç”¨ EXPLAIN åˆ†æ SQL EXPLAIN æ˜¯ SQL ä¼˜åŒ–çš„å…¥å£\n"},{"id":321,"href":"/database/mysql/troubleshooting/","title":"MySQL æ•…éšœæ’æŸ¥","parent":"MySQL","content":"è¦†ç›– MySQL æ‰€æœ‰å¸¸è§æ•…éšœåœºæ™¯ï¼ŒåŒ…å« å®šä½æµç¨‹ã€å¿…æŸ¥å‘½ä»¤ã€æ ¹å› åˆ†æã€ä¿®å¤æ–¹æ³•ã€‚\nç»“æ„æŒ‰ ä»ç°è±¡ -\u0026gt; åˆ†æ -\u0026gt; è¯Šæ–­ -\u0026gt; è§£å†³ æ’åˆ—ï¼Œå¯ç›´æ¥æ‹¿æ¥å½“è¿ç»´æ‰‹å†Œä½¿ç”¨ã€‚\n1. æ•…éšœæ’æŸ¥æ€»åŸåˆ™ï¼ˆæ ¸å¿ƒæ³•åˆ™ï¼‰ MySQL çš„æ‰€æœ‰æ•…éšœï¼ŒåŸºæœ¬éƒ½å¯ä»¥å½’ä¸ºäº”å¤§ç±»ï¼š\næ€§èƒ½ç“¶é¢ˆï¼ˆCPU / IO / å†…å­˜ / è¿æ¥æ•°ï¼‰ é”é—®é¢˜ï¼ˆæ­»é”ã€é•¿äº‹åŠ¡ã€ç­‰å¾…è¡Œé” / å…ƒæ•°æ®é”ï¼‰ èµ„æºè€—å°½ï¼ˆç£ç›˜æ»¡ / redo æ»¡ / undo è†¨èƒ€ï¼‰ å¤åˆ¶å¼‚å¸¸ï¼ˆä¸»ä»å»¶è¿Ÿã€å¤åˆ¶ä¸­æ–­ã€GTID å†²çªï¼‰ é…ç½®é”™è¯¯ / å‚æ•°ä¸å½“ æ’æŸ¥æ€»é¡ºåºï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š\nçº¿ç¨‹ -\u0026gt; é” -\u0026gt; æ…¢ SQL -\u0026gt; èµ„æº -\u0026gt; ç³»ç»Ÿ -\u0026gt; é…ç½® -\u0026gt; æ—¥å¿—\n2. é«˜ CPU ä½¿ç”¨ç‡ æ•…éšœæ’æŸ¥ 2.1 ç°è±¡ CPU æ¥è¿‘ 100% Threads_running æŒç»­é«˜ æŸ¥è¯¢å“åº”æ—¶é—´æš´æ¶¨ 2.2 å¿«é€Ÿå®šä½ï¼ˆæœ€å¸¸ç”¨è·¯å¾„ï¼‰ â‘  æŸ¥çœ‹å½“å‰æ˜¯å¦è¢« SQL æ‰“çˆ† SHOW PROCESSLIST; é«˜æ¦‚ç‡çœ‹åˆ°ï¼š\nâ€œSending dataâ€ â€œCopying to tmp tableâ€ â€œWaiting for table metadata lockâ€ â‘¡ æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„ SQL SELECT * FROM performance_schema.events_statements_current LIMIT 10; â‘¢ æŸ¥çœ‹æ˜¯å¦é”ç­‰å¾…å¯¼è‡´ CPU è¢«æ‹–çˆ† SELECT * FROM information_schema.innodb_locks; â‘£ æŸ¥çœ‹æœ€è€— CPU çš„ SQL SELECT * FROM sys.statement_analysis ORDER BY total_cpu_time DESC LIMIT 10; 2.3 æ ¹å›  ç¼ºç´¢å¼•å¼•å‘å…¨è¡¨æ‰«æ å¤§é‡å¤æ‚ JOIN å…¨è¡¨æ’åºã€ä¸´æ—¶è¡¨ å¤§äº‹åŠ¡å¯¼è‡´è¡Œé”é˜»å¡ å…ƒæ•°æ®é” MDL è¢«é•¿äº‹åŠ¡å ç”¨ 2.4 è§£å†³æ–¹æ³• æ·»åŠ ç´¢å¼•ï¼ˆæœ€å¸¸è§è§£å†³æ–¹æ¡ˆï¼‰\næ‹† SQLï¼ˆé¿å…å¤§æŸ¥è¯¢ï¼‰\nKill æ˜æ˜¾å¡ä½çš„é•¿æŸ¥è¯¢ï¼š\nKILL \u0026lt;id\u0026gt;; åœ¨çº¿å›æ”¶å…ƒæ•°æ®é”ï¼š\nKILL CONNECTION \u0026lt;trx_holding_MDL\u0026gt;; 3. é«˜ IO ä½¿ç”¨ç‡ï¼ˆRead/Write IOï¼‰æ•…éšœæ’æŸ¥ 3.1 ç°è±¡ ç£ç›˜å†™ååæš´æ¶¨ fsync å»¶è¿Ÿé«˜ å­˜å‚¨æŠ–åŠ¨å¯¼è‡´ TPS é™ä½ 3.2 æ£€æŸ¥ MySQL å†…éƒ¨ IO SHOW GLOBAL STATUS LIKE \u0026#39;innodb_data_%\u0026#39;; SHOW GLOBAL STATUS LIKE \u0026#39;innodb_os_log_fsyncs\u0026#39;; 3.3 æ£€æŸ¥æ˜¯å¦æ˜¯ check point å¯¼è‡´ SHOW ENGINE INNODB STATUS\\G; å…³æ³¨ï¼š\nLog sequence number Checkpoint age Checkpoint age æ¥è¿‘ redo log å¤§å° â‡’ MySQL å¼ºåˆ¶è½ç›˜ -\u0026gt; IO çˆ†ç‚¸\n3.4 æ ¹å›  redo log å¤ªå° buffer pool å¤ªå° æ€§èƒ½ä¸è¶³çš„å­˜å‚¨ï¼ˆé SSD / SATAï¼‰ å¤§é‡éšæœºå†™ 3.5 è§£å†³ è°ƒå¤§ redo logï¼š innodb_log_file_size = 2G å‡çº§ SSD å¢åŠ  buffer pool ä¼˜åŒ–å†™çƒ­ç‚¹è¡¨ç»“æ„ 4. é”ç­‰å¾… \u0026amp; æ­»é” æ•…éšœæ’æŸ¥ 4.1 æŸ¥çœ‹æ‰€æœ‰é” SELECT * FROM information_schema.innodb_trx; SELECT * FROM information_schema.innodb_locks; SELECT * FROM information_schema.innodb_lock_waits; 4.2 æŸ¥çœ‹æ­»é”ï¼ˆæœ€æœ‰ç”¨ï¼‰ SHOW ENGINE INNODB STATUS\\G; 4.3 æ ¹å›  å¤šäº‹åŠ¡æŠ¢åŒä¸€è¡Œ æ›´æ–°é¡ºåºä¸ä¸€è‡´ ç´¢å¼•ç¼ºå¤±å¯¼è‡´é”èŒƒå›´æ‰©å¤§ å¤§äº‹åŠ¡é•¿æ—¶é—´ä¸æäº¤ 4.4 è§£å†³ æ‹†å°äº‹åŠ¡ å¢åŠ ç´¢å¼• å°†é¢‘ç¹å†™çƒ­ç‚¹è¡¨åˆ†ç‰‡ æ”¹æˆä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰ 5. é•¿äº‹åŠ¡ï¼ˆæœ€å±é™©é—®é¢˜ä¹‹ä¸€ï¼‰ 5.1 ç°è±¡ undo è¡¨ç©ºé—´æš´æ¶¨ ç£ç›˜å˜æ»¡ å¤åˆ¶å»¶è¿ŸåŠ å‰§ Checkpoint age é•¿æœŸä¸å›æ”¶ 5.2 å®šä½ SELECT * FROM information_schema.innodb_trx ORDER BY trx_started LIMIT 5; 5.3 å¸¸è§åŸå›  åº”ç”¨å±‚å¿˜è®° commit Hibernate / JPA å¼€å¯è‡ªåŠ¨äº‹åŠ¡ MySQL å®¢æˆ·ç«¯ idle in transaction 5.4 è§£å†³ Killï¼š\nKILL \u0026lt;trx_mysql_thread_id\u0026gt;; æ”¹åº”ç”¨ï¼ˆæ ¹å› æ°¸è¿œåœ¨åº”ç”¨ï¼‰\n6. ç£ç›˜å†™æ»¡ / è¡¨ç©ºé—´æš´æ¶¨ 6.1 ç°è±¡ MySQL å´©æºƒ æ— æ³•å†™å…¥æ•°æ® undo / redo å·¨å¤§ 6.2 æ£€æŸ¥ df -h æ£€æŸ¥ undo è¡¨ç©ºé—´\nSELECT tablespace_name, file_size FROM information_schema.innodb_tablespaces; 6.3 åŸå›  é•¿äº‹åŠ¡ å¤§é‡ä¸´æ—¶è¡¨ æœªæ¸…ç† binlog InnoDB undo ä¸å¯å›æ”¶ 6.4 å¤„ç† åˆ é™¤æ—§ binlog\nPURGE BINARY LOGS BEFORE NOW() - INTERVAL 7 DAY; ç»ˆæ­¢é•¿äº‹åŠ¡\nä¼˜åŒ–å¤§æŸ¥è¯¢\næ³¨æ„ï¼šç£ç›˜æ»¡å¿…é¡»ç«‹å³åœ MySQLï¼Œå¦åˆ™è¡¨ç©ºé—´ä¼šæŸåã€‚\n7. å¤åˆ¶æ•…éšœï¼ˆä¸»ä» / MGRï¼‰æ’æŸ¥ 7.1 ä¸»ä»å¤åˆ¶ä¸­æ–­ æ£€æŸ¥ï¼š\nSHOW SLAVE STATUS\\G; å…³æ³¨å­—æ®µï¼š\nLast_IO_Error Last_SQL_Error Seconds_Behind_Master å¸¸è§é”™è¯¯\nä¸»é”®å†²çª è¡Œæ‰¾ä¸åˆ°ï¼ˆROW æ¨¡å¼ä¸‹ï¼‰ relay log æŸå GTID å†²çª 7.2 å¸¸è§ä¿®å¤ é‡ç½®å¤åˆ¶ï¼š\nRESET SLAVE ALL; CHANGE MASTER TO â€¦; START SLAVE; è·³è¿‡äº‹åŠ¡ï¼ˆä¸æ¨èï¼‰ï¼š\nSET GLOBAL sql_slave_skip_counter=1; MGR ä¿®å¤ï¼š\nSELECT * FROM performance_schema.replication_group_member_stats; 8. å†…å­˜é—®é¢˜ï¼ˆOOM / Buffer Pool ä¸å¤Ÿï¼‰ 8.1 æ’æŸ¥ SHOW GLOBAL STATUS LIKE \u0026#39;Innodb_buffer_pool_reads\u0026#39;; å‘½ä¸­ç‡ \u0026lt; 99% â‡’ buffer pool å¤ªå°\n8.2 OOM åŸå›  join_buffer / sort_buffer è¿‡å¤§ è¿æ¥æ•°å¯¼è‡´å†…å­˜é£™å‡ æŸ¥è¯¢åˆ›å»ºå·¨å¤§ä¸´æ—¶è¡¨ 8.3 æœ€ä½³é…ç½® join_buffer_size = 1M sort_buffer_size = 2M max_connections = 500 9. å¯åŠ¨å¤±è´¥ï¼ˆæ— æ³•å¯åŠ¨ mysqldï¼‰ 9.1 æ£€æŸ¥æ•°æ®ç›®å½•æƒé™ chown -R mysql:mysql /var/lib/mysql 9.2 æŸ¥çœ‹é”™è¯¯æ—¥å¿— /var/log/mysql/error.log å¸¸è§æŠ¥é”™ï¼š\nè¡¨ç©ºé—´æŸå redo log è¯»å–å¤±è´¥ ç«¯å£è¢«å ç”¨ é…ç½®æ–‡ä»¶æ‹¼å†™é”™è¯¯ 9.3 InnoDB è¡¨æŸåæ¢å¤ innodb_force_recovery = 1~6 6 æœ€å±é™©ï¼Œåªç”¨äºå¯¼å‡ºæ•°æ®ã€‚\n10. ç½‘ç»œè¿æ¥é—®é¢˜æ’æŸ¥ æ£€æŸ¥è¿æ¥æ•°\nSHOW GLOBAL STATUS LIKE \u0026#39;Threads_connected\u0026#39;; æŸ¥çœ‹æ˜¯å¦è¿æ¥æ³„æ¼\nSHOW PROCESSLIST; è¿ä¸ä¸Šæ’æŸ¥ä¸‰æ­¥éª¤\nMySQL bind-address æ˜¯å¦é™åˆ¶ é˜²ç«å¢™ï¼ˆiptables / firewalldï¼‰ å¯†ç æ’ä»¶ caching_sha2 vs mysql_native_password 11. Binlog / Redo / Undo æ•…éšœæ’æŸ¥ 11.1 redo log 100% æ»¡ æŸ¥çœ‹ï¼š\nSHOW ENGINE INNODB STATUS\\G; ç°è±¡ï¼š\nCheckpoint age æ¥è¿‘ redo å¤§å° MySQL å¡ä½ã€ä¸å“åº”å†™å…¥ è§£å†³ï¼š\nå¢åŠ  redo å¤§å°ï¼šinnodb_log_file_size ä¼˜åŒ–çƒ­ç‚¹å†™è¡¨ åœæ‰å¤§äº‹åŠ¡ 12. æ•…éšœæ’æŸ¥æµç¨‹å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰ Step 1ï¼šæ•°æ®åº“æ˜¯å¦å¡ä½ï¼Ÿ æŸ¥çœ‹ï¼š\nThreads_running Step 2ï¼šå¦‚æœ \u0026gt;20 -\u0026gt; æŸ¥é” innodb_trx / innodb_locks / innodb_lock_waits Step 3ï¼šæ— é” -\u0026gt; æŸ¥æ…¢ SQL sys.statement_analysis Step 4ï¼šæ…¢ SQL ä¸æ˜æ˜¾ -\u0026gt; æŸ¥ IO SHOW ENGINE INNODB STATUS Step 5ï¼šIO æ­£å¸¸ -\u0026gt; æŸ¥ç³»ç»Ÿ top, vmstat, iostat Step 6ï¼šç³»ç»Ÿæ­£å¸¸ -\u0026gt; æŸ¥å¤åˆ¶ SHOW SLAVE STATUS\\G; Step 7ï¼šä»æ‰¾ä¸åˆ° -\u0026gt; çœ‹ MySQL é”™è¯¯æ—¥å¿— 13. æœ€ç»ˆæ€»ç»“ï¼ˆæœ€é‡è¦çš„ 10 æ¡ï¼‰ ä»»ä½•é—®é¢˜ç¬¬ä¸€çœ‹ Threads_running æ…¢ SQL æ°¸è¿œæ¯”é…ç½®æ›´é‡è¦ é•¿äº‹åŠ¡æ˜¯ MySQL æœ€å¤§æ•Œäºº redo / undo è†¨èƒ€é€šå¸¸æ˜¯äº‹åŠ¡ä¸æäº¤ MDL é”ç»å¸¸æ˜¯ alter table å¼•èµ·çš„ å¤åˆ¶ä¸­æ–­å¤§å¤šç”±ä¸»é”®å†²çªæˆ– GTID å†²çª checkpoint age æ¥è¿‘ redo å¤§å° = IO çˆ†ç‚¸ å¤§è¡¨ä¸è¦è½»æ˜“åšå…¨è¡¨æ“ä½œ ç£ç›˜æ»¡ = å¿…é¡»åœ MySQL æ‰€æœ‰æ•…éšœæ’æŸ¥éƒ½ç¦»ä¸å¼€ error.log ","description":"è¦†ç›– MySQL æ‰€æœ‰å¸¸è§æ•…éšœåœºæ™¯ï¼ŒåŒ…å« å®šä½æµç¨‹ã€å¿…æŸ¥å‘½ä»¤ã€æ ¹å› åˆ†æã€ä¿®å¤æ–¹æ³•ã€‚\nç»“æ„æŒ‰ ä»ç°è±¡ -\u0026gt; åˆ†æ -\u0026gt; è¯Šæ–­ -\u0026gt; è§£å†³ æ’åˆ—ï¼Œå¯ç›´æ¥æ‹¿æ¥å½“è¿ç»´æ‰‹å†Œä½¿ç”¨ã€‚\n1. æ•…éšœæ’æŸ¥æ€»åŸåˆ™ï¼ˆæ ¸å¿ƒæ³•åˆ™ï¼‰ MySQL çš„æ‰€æœ‰æ•…éšœï¼ŒåŸºæœ¬éƒ½å¯ä»¥å½’ä¸ºäº”å¤§ç±»ï¼š\næ€§èƒ½ç“¶é¢ˆï¼ˆCPU / IO / å†…å­˜ / è¿æ¥æ•°ï¼‰ é”é—®é¢˜ï¼ˆæ­»é”ã€é•¿äº‹åŠ¡ã€ç­‰å¾…è¡Œé” / å…ƒæ•°æ®é”ï¼‰ èµ„æºè€—å°½ï¼ˆç£ç›˜æ»¡ / redo æ»¡ / undo è†¨èƒ€ï¼‰ å¤åˆ¶å¼‚å¸¸ï¼ˆä¸»ä»å»¶è¿Ÿã€å¤åˆ¶ä¸­æ–­ã€GTID å†²çªï¼‰ é…ç½®é”™è¯¯ / å‚æ•°ä¸å½“ æ’æŸ¥æ€»é¡ºåºï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š\nçº¿ç¨‹ -\u0026gt; é” -\u0026gt; æ…¢ SQL -\u0026gt; èµ„æº -\u0026gt; ç³»ç»Ÿ -\u0026gt; é…ç½® -\u0026gt; æ—¥å¿—\n"},{"id":322,"href":"/database/mysql/foreign-key-checks/","title":"MySQL ç¦ç”¨å¤–é”®æ£€æŸ¥","parent":"MySQL","content":"åœ¨ MySQL ä¸­ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼Œéœ€è¦ä½¿ç”¨ SET FOREIGN_KEY_CHECKS = 0; å‘½ä»¤æ¥ä¸´æ—¶ç¦ç”¨ã€‚åœ¨å®Œæˆæ“ä½œåï¼ŒåŠ¡å¿…ä½¿ç”¨ SET FOREIGN_KEY_CHECKS = 1; é‡æ–°å¯ç”¨å¤–é”®æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚\næŸ¥çœ‹å½“å‰ FOREIGN_KEY_CHECKS çš„å€¼ SELECT @@FOREIGN_KEY_CHECKS; ç¦ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹ SQL è¯­å¥ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼š\nSET FOREIGN_KEY_CHECKS = 0; ä½œç”¨ï¼š è¿™è¡Œå‘½ä»¤ä¼šå…³é—­å½“å‰ä¼šè¯çš„å¤–é”®æ£€æŸ¥ï¼Œå…è®¸åœ¨ä¸å—å¤–é”®çº¦æŸé™åˆ¶çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚æ‰¹é‡å¯¼å…¥ã€åˆ é™¤æˆ–æ›´æ–°æ•°æ®ã€‚\né‡æ–°å¯ç”¨å¤–é”® åœ¨å®Œæˆéœ€è¦ç¦ç”¨å¤–é”®çš„æ“ä½œåï¼Œæ‰§è¡Œä»¥ä¸‹ SQL è¯­å¥æ¥æ¢å¤æ£€æŸ¥ï¼š\nSET FOREIGN_KEY_CHECKS = 1; ä½œç”¨ï¼š è¿™ä¼šé‡æ–°æ¿€æ´»å¤–é”®æ£€æŸ¥ï¼Œæ¢å¤æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§ä¿æŠ¤ã€‚\n","description":"åœ¨ MySQL ä¸­ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼Œéœ€è¦ä½¿ç”¨ SET FOREIGN_KEY_CHECKS = 0; å‘½ä»¤æ¥ä¸´æ—¶ç¦ç”¨ã€‚åœ¨å®Œæˆæ“ä½œåï¼ŒåŠ¡å¿…ä½¿ç”¨ SET FOREIGN_KEY_CHECKS = 1; é‡æ–°å¯ç”¨å¤–é”®æ£€æŸ¥ï¼Œä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚\næŸ¥çœ‹å½“å‰ FOREIGN_KEY_CHECKS çš„å€¼ SELECT @@FOREIGN_KEY_CHECKS; ç¦ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹ SQL è¯­å¥ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼š\nSET FOREIGN_KEY_CHECKS = 0; ä½œç”¨ï¼š è¿™è¡Œå‘½ä»¤ä¼šå…³é—­å½“å‰ä¼šè¯çš„å¤–é”®æ£€æŸ¥ï¼Œå…è®¸åœ¨ä¸å—å¤–é”®çº¦æŸé™åˆ¶çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚æ‰¹é‡å¯¼å…¥ã€åˆ é™¤æˆ–æ›´æ–°æ•°æ®ã€‚\né‡æ–°å¯ç”¨å¤–é”® åœ¨å®Œæˆéœ€è¦ç¦ç”¨å¤–é”®çš„æ“ä½œåï¼Œæ‰§è¡Œä»¥ä¸‹ SQL è¯­å¥æ¥æ¢å¤æ£€æŸ¥ï¼š\n"},{"id":323,"href":"/database/mysql/indexs/","title":"MySQL ç´¢å¼•","parent":"MySQL","content":" ğŸ§± 1. ç´¢å¼•çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆå¿…é¡»ç†è§£ï¼‰ ç´¢å¼•æ˜¯æ•°æ®åº“é‡Œç”¨äº åŠ é€ŸæŸ¥æ‰¾ çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ç±»ä¼¼â€œç›®å½•â€ã€‚\nInnoDB ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼ˆæ ¸å¿ƒå…³é”®ç‚¹ï¼‰ã€‚\nç´¢å¼•çš„ç›®æ ‡æ˜¯ï¼š\næ›´å¿«æŸ¥æ‰¾ï¼ˆå‡å°‘ IOï¼‰ æå‡æ’åºæ€§èƒ½ åŠ é€Ÿ JOIN å‡å°‘é”èŒƒå›´ï¼ˆè¡Œé”ä¸é€€åŒ–ä¸ºè¡¨é”ï¼‰ ğŸ§± 2. InnoDB ç´¢å¼•ç»“æ„ï¼ˆåº•å±‚åŸç†ï¼‰ InnoDB å­˜å‚¨å¼•æ“ä¸­ç´¢å¼•çš„æœ¬è´¨æ˜¯ï¼š\nB+Treeï¼ˆMysql çš„æ ¸å¿ƒç´¢å¼•ç»“æ„ï¼‰ ç‰¹å¾ï¼š\næ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ å¶å­èŠ‚ç‚¹ä¹‹é—´æœ‰é“¾è¡¨ -\u0026gt; é€‚åˆèŒƒå›´æ‰«æ éå¶èŠ‚ç‚¹ä»…å­˜ keyï¼Œä¸å­˜æ•°æ® ä¼˜ç‚¹ï¼š\nIO æ¬¡æ•°å¯æ§ï¼ˆæ ‘é«˜åº¦å°ï¼‰ æœ‰åº -\u0026gt; æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€é«˜æ•ˆæ’åº ğŸ§± 3. ç´¢å¼•ç±»å‹ï¼ˆå®Œæ•´ä½“ç³»ï¼‰ 3.1 ä¸»é”®ç´¢å¼•ï¼ˆClustered Indexï¼‰ æ•°æ®è¡Œä¸ä¸»é”®ç´¢å¼•å­˜å‚¨åœ¨ä¸€èµ·ï¼ˆèšç°‡ï¼‰ æ¯å¼ è¡¨å¿…é¡»ä¸”åªæœ‰ä¸€ä¸ª ç»“æ„ï¼š\nB+Tree â””â”€ å¶å­èŠ‚ç‚¹ = å®é™…è¡Œæ•°æ® ä¸»é”®é€‰æ‹©å½±å“æ•°æ®ç»„ç»‡ï¼Œéå¸¸é‡è¦ã€‚\nå»ºè®®ï¼š\nå°½é‡ä½¿ç”¨è‡ªå¢ä¸»é”®ï¼ˆæœ€ç¨³å®šã€æœ€ä¸å®¹æ˜“åˆ†è£‚ï¼‰ 3.2 äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰ å¶å­èŠ‚ç‚¹å­˜å‚¨ï¼š\näºŒçº§ç´¢å¼• key -\u0026gt; ä¸»é”®å€¼ æŸ¥æ‰¾æµç¨‹ï¼š\næ‰¾äºŒçº§ç´¢å¼• å›è¡¨ï¼ˆæ ¹æ®ä¸»é”®ï¼‰åˆ°ä¸»é”®ç´¢å¼•å–å®Œæ•´è¡Œ 3.3 å”¯ä¸€ç´¢å¼•ï¼ˆUNIQUEï¼‰ ä¸æ™®é€šç´¢å¼•ç»“æ„ç›¸åŒï¼Œåªæ˜¯å¤šäº†å”¯ä¸€æ ¡éªŒã€‚\n3.4 è¦†ç›–ç´¢å¼•ï¼ˆCovering Indexï¼‰ æŸ¥è¯¢æ‰€éœ€å­—æ®µå…¨éƒ¨åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨ï¼Œä¾‹å¦‚ï¼š\nSELECT id, name FROM user WHERE name=\u0026#39;Alice\u0026#39;; ä¼˜åŠ¿ï¼š\næ— éœ€å›è¡¨ï¼ˆæ€§èƒ½è´¨å˜ï¼‰ æ›´å°‘ IO å‡å°‘é”èŒƒå›´ 3.5 è”åˆç´¢å¼•ï¼ˆComposite Indexï¼‰ ä¾‹å¦‚ï¼š\nINDEX (a, b, c) éµå¾ª æœ€å·¦å‰ç¼€åŸåˆ™ï¼š\n(a) (a, b) (a, b, c) æœ‰æ•ˆ (b), (c), (b, c) æ— æ•ˆ 3.6 å…¨æ–‡ç´¢å¼•ï¼ˆFULLTEXTï¼‰ é€‚ç”¨äºæ–‡æœ¬æœç´¢ï¼šMATCH AGAINST\n3.7 å“ˆå¸Œç´¢å¼•ï¼ˆMemory è¡¨ï¼‰ ç”¨äºå†…å­˜è¡¨ï¼Œä¸åœ¨ InnoDB ä¸­ä½¿ç”¨ã€‚\nğŸ§± 4. ç´¢å¼•æœ€ä½³å®è·µï¼ˆæœ€ç»ˆæ€»ç»“ç‰ˆï¼‰ 4.1 å•åˆ—ç´¢å¼• vs è”åˆç´¢å¼• ä¼˜å…ˆç”¨è”åˆç´¢å¼•ï¼Œè€Œä¸æ˜¯å•åˆ—ç´¢å¼•å †ç§¯ã€‚\n4.2 ä¸»é”®ä¸€å®šè¦è®¾è®¡å¥½ å»ºè®®ï¼š\nä½¿ç”¨è‡ªå¢ BIGINT é¿å… UUIDï¼ˆå¯¼è‡´ B+Tree ä¸è¿ç»­ -\u0026gt; åˆ†è£‚ -\u0026gt; æ€§èƒ½å·®ï¼‰ 4.3 è¦†ç›–ç´¢å¼•ä¼˜å…ˆ è®¾è®¡ SELECT é«˜é¢‘å­—æ®µæ—¶ï¼Œå°½é‡è®©æŸ¥è¯¢åªèµ°ç´¢å¼•ã€‚\nğŸ§± 5. ä»€ä¹ˆæ—¶å€™ç´¢å¼•ä¼šå¤±æ•ˆï¼Ÿï¼ˆæœ€é‡è¦ï¼‰ ä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´ç´¢å¼•æ— æ³•ä½¿ç”¨ï¼š\nâŒ 5.1 LIKE \u0026lsquo;%xxx\u0026rsquo; å‰å¯¼æ¨¡ç³Š WHERE name LIKE \u0026#39;%abc\u0026#39; è§£å†³ï¼š\nå»ºåå‘å­˜å‚¨å­—æ®µ ä½¿ç”¨å…¨æ–‡ç´¢å¼• âŒ 5.2 åœ¨åˆ—ä¸Šè¿›è¡Œè®¡ç®— WHERE DATE(create_time) = \u0026#39;2025-01-01\u0026#39; è§£å†³ï¼š\næ”¹å†™ä¸ºï¼š WHERE create_time \u0026gt;= \u0026#39;2025-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-02\u0026#39; âŒ 5.3 éšå¼ç±»å‹è½¬æ¢ WHERE phone = 1234567 -- å­—ç¬¦ç±»å‹å­—æ®µåŒ¹é…æ•°å­— âŒ 5.4 OR æ¡ä»¶æœªå…¨éƒ¨ä½¿ç”¨ç´¢å¼• WHERE a = 1 OR b = 2 âŒ 5.5 è”åˆç´¢å¼•ä¸ç¬¦åˆæœ€å·¦å‰ç¼€ INDEX(a, b) WHERE b=1 -- ä¸èƒ½ç”¨ WHERE a=1 AND b=2 -- èƒ½ç”¨ âŒ 5.6 å¯¹ç´¢å¼•å­—æ®µä½¿ç”¨å‡½æ•°/è¡¨è¾¾å¼ WHERE UPPER(name) = \u0026#39;AAA\u0026#39; âŒ 5.7 NOT IN / != / \u0026lt;\u0026gt; ä½æ¦‚ç‡ä½¿ç”¨ç´¢å¼• ğŸ§± 6. ç´¢å¼•ä¸é”çš„å…³ç³»ï¼ˆå›å¤2å†…å®¹èåˆï¼‰ ç´¢å¼•å†³å®šé”çš„èŒƒå›´ï¼š\næ‰¾åˆ°ç›®æ ‡è®°å½• -\u0026gt; åŠ ç²¾ç¡®çš„ record lock æœªæ‰¾åˆ°è®°å½• -\u0026gt; åŠ  gap lock èŒƒå›´æŸ¥è¯¢ -\u0026gt; next-key lock ä¸èµ°ç´¢å¼• -\u0026gt; é”å…¨è¡¨ï¼ˆè¡Œé”é€€åŒ–ä¸ºè¡¨é”ï¼‰ ä¾‹å­ï¼ˆç¾éš¾çº§ï¼‰ï¼š\nSELECT * FROM user WHERE email LIKE \u0026#39;%xxx%\u0026#39; FOR UPDATE; -\u0026gt; ç´¢å¼•å¤±æ•ˆ -\u0026gt; é”å…¨è¡¨\nğŸ§± 7. ç´¢å¼•è®¾è®¡æ–¹æ³•è®ºï¼ˆæœ€å®ç”¨ï¼‰ æŒ‰ç…§ä¸šåŠ¡è½åœ°ï¼š\n7.1 è¯»å¤šå†™å°‘åœºæ™¯ å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼• å°½é‡ä½¿ç”¨è”åˆç´¢å¼•å‡å°‘å›è¡¨ é¿å…å®½è¡Œï¼ˆå­—æ®µå¤ªå¤šï¼‰ 7.2 å†™å¤šè¯»å°‘ï¼ˆæ’å…¥é¢‘ç¹ï¼‰ å‡å°‘å†—ä½™ç´¢å¼•ï¼ˆæ¯ä¸ªç´¢å¼•éƒ½è¦ç»´æŠ¤ï¼‰ ä½¿ç”¨è‡ªå¢ä¸»é”®å‡å°‘é¡µé¢åˆ†è£‚ 7.3 é«˜å¹¶å‘ OLTP ç³»ç»Ÿ ä¸¥æ ¼æ§åˆ¶ç´¢å¼•æ•°é‡ å•è¡¨ç´¢å¼•ä¸è¶…è¿‡ 5~8 ä¸ª ç´¢å¼•è¦†ç›–å…³é”®æŸ¥è¯¢ äº‹åŠ¡ä¸­çš„ SQL å¿…é¡»èµ°ç´¢å¼• ğŸ§± 8. ç´¢å¼•è°ƒä¼˜ï¼šå¦‚ä½•åˆ¤æ–­æ˜¯å¦èµ°ç´¢å¼•ï¼Ÿ ä½¿ç”¨ EXPLAIN\nEXPLAIN SELECT ... å…³é”®å­—æ®µï¼š\ntypeï¼ˆè¿æ¥ç±»å‹ï¼šALL=å…¨è¡¨æ‰«æï¼‰ keyï¼ˆä½¿ç”¨çš„ç´¢å¼•ï¼‰ rowsï¼ˆæ‰«æè¡Œæ•°ï¼‰ Extraï¼ˆUsing filesortã€Using temporaryï¼‰ ğŸ§± 9. å®æˆ˜æ¡ˆä¾‹ï¼ˆæœ€é‡è¦éƒ¨åˆ†ï¼‰ ğŸ“Œ æ¡ˆä¾‹ 1ï¼šè”åˆç´¢å¼•ç”Ÿæ•ˆä¸å¤±æ•ˆ ç´¢å¼•ï¼š(a, b, c)\næŸ¥è¯¢ï¼š\nWHERE a=1 AND c=5 æœ‰æ•ˆåˆ©ç”¨ï¼š\na c ä¸èƒ½ä½¿ç”¨èŒƒå›´æ‰«æï¼Œéœ€è¦ b è¦†ç›– ä¼˜åŒ–ï¼š\nWHERE a=1 AND b=xx AND c=5 ğŸ“Œ æ¡ˆä¾‹ 2ï¼šç´¢å¼•å­—æ®µè®¡ç®—å¯¼è‡´å¤±æ•ˆ WHERE YEAR(create_time) = 2024 ä¼˜åŒ–ï¼š\nWHERE create_time \u0026gt;= \u0026#39;2024-01-01\u0026#39; AND create_time \u0026lt; \u0026#39;2025-01-01\u0026#39; ğŸ“Œ æ¡ˆä¾‹ 3ï¼šç´¢å¼•è¦†ç›–å‡å°‘å›è¡¨ è¡¨æœ‰ 1000 ä¸‡è¡Œ\næŸ¥è¯¢ï¼š\nSELECT id FROM orders WHERE status=1; ä»…è®¿é—®ç´¢å¼• -\u0026gt; æå¿«\nå¦‚æœ SELECT * -\u0026gt; å¿…é¡»å›è¡¨ -\u0026gt; æ€§èƒ½ä¸‹é™ 5ï½20 å€\nğŸ§± 10. ç´¢å¼•æœ€ç»ˆæ€»ç»“ï¼ˆæé€Ÿå¤ç›˜ï¼‰ MySQL ä½¿ç”¨ B+Tree ç´¢å¼•ï¼ˆæœ€æ ¸å¿ƒï¼‰ ä¸»é”®ç´¢å¼•åŒ…å«æ•°æ®ï¼ŒäºŒçº§ç´¢å¼•éœ€è¦å›è¡¨ ç´¢å¼•ç»“æ„å†³å®šé”èŒƒå›´ è”åˆç´¢å¼•ä¼˜äºå¤šä¸ªå•åˆ—ç´¢å¼• è¦†ç›–ç´¢å¼•æ˜¯æ€§èƒ½ç¥å™¨ ç´¢å¼•å¤±æ•ˆå¸¸è§ 7 å¤§åŸå› å¿…é¡»ç‰¢è®° é«˜é¢‘ä¸šåŠ¡æŸ¥è¯¢ä¸€å®šè¦è®¾è®¡ä¸“ç”¨ç´¢å¼• ç´¢å¼•æ•°é‡ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼ˆå†™å…¥ä»£ä»·å¾ˆé«˜ï¼‰ ","description":" ğŸ§± 1. ç´¢å¼•çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆå¿…é¡»ç†è§£ï¼‰ ç´¢å¼•æ˜¯æ•°æ®åº“é‡Œç”¨äº åŠ é€ŸæŸ¥æ‰¾ çš„æ•°æ®ç»“æ„ï¼Œæœ¬è´¨ç±»ä¼¼â€œç›®å½•â€ã€‚\nInnoDB ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼ˆæ ¸å¿ƒå…³é”®ç‚¹ï¼‰ã€‚\nç´¢å¼•çš„ç›®æ ‡æ˜¯ï¼š\næ›´å¿«æŸ¥æ‰¾ï¼ˆå‡å°‘ IOï¼‰ æå‡æ’åºæ€§èƒ½ åŠ é€Ÿ JOIN å‡å°‘é”èŒƒå›´ï¼ˆè¡Œé”ä¸é€€åŒ–ä¸ºè¡¨é”ï¼‰ ğŸ§± 2. InnoDB ç´¢å¼•ç»“æ„ï¼ˆåº•å±‚åŸç†ï¼‰ InnoDB å­˜å‚¨å¼•æ“ä¸­ç´¢å¼•çš„æœ¬è´¨æ˜¯ï¼š\nB+Treeï¼ˆMysql çš„æ ¸å¿ƒç´¢å¼•ç»“æ„ï¼‰ ç‰¹å¾ï¼š\n"},{"id":324,"href":"/database/mysql/indexs2/","title":"MySQL ç´¢å¼•","parent":"MySQL","content":"æ€»ç»“ï¼š\nç´¢å¼•æ˜¯ MySQL æ€§èƒ½çš„ç”Ÿå‘½çº¿ï¼Œ80% çš„æ…¢ SQL éƒ½èƒ½é æ­£ç¡®çš„ç´¢å¼•è§£å†³ã€‚\nä¸€ã€ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ç´¢å¼•æ˜¯ä¸€ç§ åŠ é€Ÿæ•°æ®æ£€ç´¢çš„æ•°æ®ç»“æ„ï¼Œè®©æŸ¥è¯¢ï¼š\nä» å…¨è¡¨æ‰«æ O(n) å˜ä¸º æ ‘æŸ¥æ‰¾ O(log n) ğŸ“Œ æœ¬è´¨ï¼šç©ºé—´æ¢æ—¶é—´\näºŒã€MySQL ç´¢å¼•çš„åº•å±‚ç»“æ„ï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆæ˜¯ B+Treeï¼Ÿ InnoDB ä½¿ç”¨ B+Tree ä½œä¸ºé»˜è®¤ç´¢å¼•ç»“æ„ï¼š\nä¼˜åŠ¿ï¼š\næ‰€æœ‰æ•°æ®åœ¨ å¶å­èŠ‚ç‚¹ éå¶å­èŠ‚ç‚¹åªå­˜é”® -\u0026gt; æ ‘æ›´çŸ® å¶å­èŠ‚ç‚¹é€šè¿‡ åŒå‘é“¾è¡¨ ç›¸è¿ -\u0026gt; èŒƒå›´æŸ¥è¯¢æå¿« ğŸ“Œ Hash ç´¢å¼•ä¸é€‚åˆï¼š\nä¸æ”¯æŒèŒƒå›´ ä¸æ”¯æŒæ’åº ä¸æ”¯æŒå‰ç¼€åŒ¹é… 2ï¸âƒ£ èšç°‡ç´¢å¼• vs äºŒçº§ç´¢å¼•ï¼ˆå¿…è€ƒï¼‰ ğŸ”¹ èšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼‰\nä¸»é”®ç´¢å¼• å¶å­èŠ‚ç‚¹å­˜ æ•´è¡Œæ•°æ® è¡¨æ•°æ®ç‰©ç†é¡ºåº = ä¸»é”®é¡ºåº PRIMARY KEY(id) ğŸ“Œ ä¸€å¼ è¡¨ åªæœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•\nğŸ”¹ äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰\néä¸»é”®ç´¢å¼• å¶å­èŠ‚ç‚¹å­˜ï¼šç´¢å¼•åˆ— + ä¸»é”®å€¼ æŸ¥è¯¢éœ€ å›è¡¨ KEY idx_name(name) 3ï¸âƒ£ å›è¡¨ï¼ˆé‡è¦ï¼‰ æµç¨‹ï¼š\né€šè¿‡äºŒçº§ç´¢å¼•æ‰¾åˆ°ä¸»é”® å†åˆ°ä¸»é”® B+Tree æŸ¥è¯¢è¡Œæ•°æ® ğŸ“Œ å›è¡¨ = é¢å¤– IO\nä¸‰ã€ç´¢å¼•ç±»å‹å¤§å…¨ ç±»å‹ è¯´æ˜ PRIMARY ä¸»é”®ç´¢å¼• UNIQUE å”¯ä¸€ç´¢å¼• NORMAL æ™®é€šç´¢å¼• FULLTEXT å…¨æ–‡ç´¢å¼• SPATIAL ç©ºé—´ç´¢å¼• å››ã€è”åˆç´¢å¼• \u0026amp; æœ€å·¦å‰ç¼€ KEY idx_a_b_c (a, b, c) å¯ç”¨åœºæ™¯ï¼š\nWHERE æ¡ä»¶ æ˜¯å¦ä½¿ç”¨ç´¢å¼• a=1 âœ… a=1 AND b=2 âœ… a=1 AND b=2 AND c=3 âœ… b=2 âŒ a=1 AND c=3 âœ…ï¼ˆc ä¸èƒ½å†ç»§ç»­ï¼‰ ğŸ“Œ å¿…é¡»ä»æœ€å·¦åˆ—å¼€å§‹\näº”ã€ç´¢å¼•çš„å…¸å‹ä½¿ç”¨åœºæ™¯ WHERE ç²¾ç¡®åŒ¹é… WHERE id = 10 JOIN æ¡ä»¶ ON order.user_id = user.id ORDER BY / GROUP BY ORDER BY create_time DESC è¦†ç›–ç´¢å¼•ï¼ˆæè‡´ä¼˜åŒ–ï¼‰ SELECT id, name FROM user WHERE name=\u0026#39;Tom\u0026#39;; Extraï¼š\nUsing index å…­ã€ç´¢å¼•ä½•æ—¶ä¼šå¤±æ•ˆï¼Ÿï¼ˆå¿…è€ƒï¼‰ âŒ 1. å¯¹ç´¢å¼•åˆ—åšå‡½æ•°/è¿ç®—\nWHERE DATE(create_time) = \u0026#39;2024-01-01\u0026#39; âŒ 2. éšå¼ç±»å‹è½¬æ¢\nWHERE phone = 13800138000 -- phone æ˜¯ VARCHAR âŒ 3. å·¦æ¨¡ç³ŠæŸ¥è¯¢\nLIKE \u0026#39;%abc\u0026#39; âŒ 4. OR æ··ç”¨ä¸åŒç´¢å¼•\nWHERE a=1 OR b=2 âŒ 5. NOT IN / != / \u0026lt;\u0026gt;\nWHERE status != 1 ä¸ƒã€ç´¢å¼•ä¸‹æ¨ï¼ˆICPï¼ŒMySQL 5.6+ï¼‰ SELECT * FROM user WHERE name=\u0026#39;Tom\u0026#39; AND age=20; å¦‚æœåªæœ‰ name æœ‰ç´¢å¼•ï¼š\nä»¥å‰ï¼šå›è¡¨åå†åˆ¤æ–­ age ç°åœ¨ï¼šåœ¨ç´¢å¼•å±‚ç›´æ¥è¿‡æ»¤ age EXPLAINï¼š\nUsing index condition ğŸ“Œ å‡å°‘å›è¡¨æ¬¡æ•°\nå…«ã€ç´¢å¼•ä¸é”çš„å…³ç³»ï¼ˆè¿ç»´å¿…æ‡‚ï¼‰ âš ï¸ æ²¡æœ‰ç´¢å¼•çš„ UPDATE / DELETEï¼š\nå…¨è¡¨æ‰«æ å…¨è¡¨ Next-Key Lock é˜»å¡æ‰€æœ‰å†™æ“ä½œ âœ… æœ‰ç´¢å¼•ï¼š\nç²¾ç¡®è¡Œé” å¹¶å‘å®‰å…¨ ä¹ã€ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µï¼ˆç»éªŒæ€»ç»“ï¼‰ âœ… ä¸»é”®è®¾è®¡\nBIGINT UNSIGNED å•è°ƒé€’å¢ï¼ˆå‡å°‘é¡µåˆ†è£‚ï¼‰ âœ… ç´¢å¼•æ•°é‡\nä¸å®œè¿‡å¤šï¼ˆå†™æ”¾å¤§ï¼‰ å¸¸ç”¨ï¼š3ï½5 ä¸ª âœ… è”åˆç´¢å¼•é¡ºåº\nåŒºåˆ†åº¦é«˜çš„æ”¾å‰é¢ ç­‰å€¼æ¡ä»¶åœ¨å‰ï¼ŒèŒƒå›´åœ¨å âœ… é¿å…é‡å¤ç´¢å¼•\nKEY idx_a(a), KEY idx_a_b(a,b) -- idx_a å¯åˆ  åã€EXPLAIN å¦‚ä½•åˆ¤æ–­ç´¢å¼•å¥½ä¸å¥½ï¼Ÿ é‡ç‚¹çœ‹ï¼š\nå­—æ®µ ç†æƒ³å€¼ type const / ref / range key å‘½ä¸­ç´¢å¼• rows å¾ˆå° Extra Using index / ICP åä¸€ã€å¸¸è§ç´¢å¼•é—®é¢˜ Qï¼šä¸ºä»€ä¹ˆä¸»é”®å»ºè®®è‡ªå¢ï¼Ÿ\nAï¼šå‡å°‘ B+Tree é¡µåˆ†è£‚ï¼Œæé«˜å†™å…¥æ€§èƒ½ã€‚\nQï¼šç´¢å¼•è¶Šå¤šè¶Šå¥½å—ï¼Ÿ\nAï¼šå¦ï¼Œå½±å“ INSERT/UPDATE æ€§èƒ½ã€‚\nQï¼šè¦†ç›–ç´¢å¼•ä¸€å®šå¿«å—ï¼Ÿ\nAï¼šæ˜¯ï¼ˆé¿å…å›è¡¨ï¼‰ã€‚\nQï¼šç´¢å¼•èƒ½æé«˜ INSERT å—ï¼Ÿ\nAï¼šä¸èƒ½ï¼Œåè€Œå˜æ…¢ã€‚\nQï¼šä»€ä¹ˆæ—¶å€™ç”¨å…¨æ–‡ç´¢å¼•ï¼Ÿ\nAï¼šå…¨æ–‡æœç´¢ï¼Œä¸é€‚åˆ LIKE â€˜%xxx%â€™\nåäºŒã€ç´¢å¼•ç›¸å…³ SQL é€ŸæŸ¥ -- æŸ¥çœ‹ç´¢å¼• SHOW INDEX FROM table; -- æ·»åŠ ç´¢å¼• ALTER TABLE t ADD INDEX idx_a(a); -- åˆ é™¤ç´¢å¼• ALTER TABLE t DROP INDEX idx_a; -- æŸ¥çœ‹æ˜¯å¦èµ°ç´¢å¼• EXPLAIN SELECT ... ğŸ”š æ€»ç»“ ç´¢å¼•ä¸æ˜¯â€œå»ºäº†å°±å¿«â€ï¼Œè€Œæ˜¯â€œå»ºå¯¹æ‰å¿«â€ã€‚\n","description":"æ€»ç»“ï¼š\nç´¢å¼•æ˜¯ MySQL æ€§èƒ½çš„ç”Ÿå‘½çº¿ï¼Œ80% çš„æ…¢ SQL éƒ½èƒ½é æ­£ç¡®çš„ç´¢å¼•è§£å†³ã€‚\nä¸€ã€ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ ç´¢å¼•æ˜¯ä¸€ç§ åŠ é€Ÿæ•°æ®æ£€ç´¢çš„æ•°æ®ç»“æ„ï¼Œè®©æŸ¥è¯¢ï¼š\nä» å…¨è¡¨æ‰«æ O(n) å˜ä¸º æ ‘æŸ¥æ‰¾ O(log n) ğŸ“Œ æœ¬è´¨ï¼šç©ºé—´æ¢æ—¶é—´\näºŒã€MySQL ç´¢å¼•çš„åº•å±‚ç»“æ„ï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆæ˜¯ B+Treeï¼Ÿ InnoDB ä½¿ç”¨ B+Tree ä½œä¸ºé»˜è®¤ç´¢å¼•ç»“æ„ï¼š\n"},{"id":325,"href":"/database/mysql/classic-issues/","title":"MySQL ç»å…¸é—®é¢˜","parent":"MySQL","content":" ä¸€ã€å…ˆå¯¹é½æ¦‚å¿µï¼šRedis ä¸‰å¤§ç¼“å­˜é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ Redis æœ¬è´¨ ç¼“å­˜ç©¿é€ è®¿é—®ä¸å­˜åœ¨çš„æ•°æ® ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹ Key å¤±æ•ˆ ç¼“å­˜é›ªå´© å¤§é‡ Key åŒæ—¶å¤±æ•ˆ ğŸ‘‰ æœ¬è´¨éƒ½æ˜¯ï¼šæµé‡ / å¹¶å‘ç›´æ¥æ‰“åˆ° MySQL\näºŒã€MySQL å¯¹åº”çš„â€œæ ¸å¿ƒé—®é¢˜æ¨¡å‹â€ å¦‚æœ Redis æ˜¯â€œæŒ¡åœ¨ MySQL å‰é¢çš„ç¼“å†²å±‚â€ é‚£ MySQL è‡ªèº«çš„é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ï¼š å¹¶å‘ã€é”ã€IOã€å¤åˆ¶ã€ä¸€è‡´æ€§ã€å®¹é‡\nä¸‰ã€MySQL çš„ã€Œå…­å¤§æ ¸å¿ƒé—®é¢˜ã€ï¼ˆå¼€å‘ + è¿ç»´ï¼‰ â‘  å¹¶å‘é£æš´ï¼ˆç­‰ä»·äºâ€œç¼“å­˜é›ªå´©â€ï¼‰ ğŸ”¥ ç°è±¡\nç¬æ—¶ QPS é£™å‡ CPU 100% å¤§é‡ Threads_running æ…¢æŸ¥è¯¢æš´å¢ â˜˜ï¸ æœ¬è´¨\nå¤§é‡è¯·æ±‚ åŒæ—¶å‘½ä¸­ MySQL ç¼“å­˜å¤±æ•ˆ / æœªä½¿ç”¨ç¼“å­˜ å¤§äº‹åŠ¡ + çƒ­ç‚¹è¡Œ ğŸ›  è§£å†³æ–¹æ¡ˆ\nRedis / æœ¬åœ°ç¼“å­˜ çƒ­ç‚¹æ•°æ®æ‹†è¡¨ / æ‹†è¡Œ é™æµã€ç†”æ–­ è¯»å†™åˆ†ç¦» â‘¡ é”ç«äº‰ \u0026amp; æ­»é”ï¼ˆMySQL çš„â€œå‡»ç©¿å‹é—®é¢˜â€ï¼‰ ğŸ”¥ ç°è±¡\nUPDATE / DELETE å¡æ­» Lock wait timeout exceeded æ­»é”å›æ»š â˜˜ï¸ æœ¬è´¨\nçƒ­ç‚¹è¡Œ èŒƒå›´é”ï¼ˆNext-Key Lockï¼‰ ç´¢å¼•å¤±æ•ˆ -\u0026gt; é”è¡¨ ğŸ›  è§£å†³æ–¹æ¡ˆ\nç²¾ç¡®ç´¢å¼• å‡å°‘äº‹åŠ¡æ—¶é—´ æŒ‰å›ºå®šé¡ºåºæ›´æ–° ä½¿ç”¨ FOR UPDATE SKIP LOCKED â‘¢ æ…¢æŸ¥è¯¢å †ç§¯ï¼ˆç­‰ä»·äºâ€œç¼“å­˜ç©¿é€â€ï¼‰ ğŸ”¥ ç°è±¡\nå•æ¡ SQL å¾ˆæ…¢ QPS ä¸é«˜ä½† MySQL å¾ˆå¡ â˜˜ï¸ æœ¬è´¨\nå…¨è¡¨æ‰«æ é”™è¯¯ Join æœªå‘½ä¸­ç´¢å¼• è¿”å›å¤§é‡æ— æ•ˆæ•°æ® ğŸ›  è§£å†³æ–¹æ¡ˆ\nEXPLAIN / ANALYZE è¦†ç›–ç´¢å¼• æ‹† SQL é™åˆ¶è¿”å›è¡Œæ•° â‘£ ä¸»ä»å»¶è¿Ÿ \u0026amp; æ•°æ®ä¸ä¸€è‡´ï¼ˆMySQL ç‰¹æœ‰ï¼‰ ğŸ”¥ ç°è±¡\nä¸»åº“å·²æ›´æ–°ï¼Œä»åº“æŸ¥ä¸åˆ° å»¶è¿Ÿå‡ åç§’ç”šè‡³åˆ†é’Ÿ â˜˜ï¸ æœ¬è´¨\nBinlog å•çº¿ç¨‹å›æ”¾ å¤§äº‹åŠ¡ ä»åº“ IO/CPU æ…¢ ğŸ›  è§£å†³æ–¹æ¡ˆ\nROW Binlog å¹¶è¡Œå¤åˆ¶ æ‹†å¤§äº‹åŠ¡ å…³é”®è¯»èµ°ä¸»åº“ â‘¤ ç£ç›˜ / IO ç“¶é¢ˆï¼ˆMySQL çš„â€œé›ªå´©æ ¹æºâ€ï¼‰ ğŸ”¥ ç°è±¡\nIO Util 100% TPS æ€¥å‰§ä¸‹é™ å“åº”æ—¶é—´æŠ–åŠ¨ â˜˜ï¸ æœ¬è´¨\néšæœº IO Buffer Pool ä¸å¤Ÿ Binlog / Redo / Data æ··ç›˜ ğŸ›  è§£å†³æ–¹æ¡ˆ\næ‰©å¤§ Buffer Pool Binlog/Redo åˆ†ç›˜ SSD / NVMe æ‰¹é‡å†™å…¥ â‘¥ å®¹é‡ \u0026amp; æ¶æ„é—®é¢˜ï¼ˆé•¿æœŸéšæ‚£ï¼‰ ğŸ”¥ ç°è±¡\nå•è¡¨è¿‡äº¿ ALTER TABLE å¾ˆæ…¢ å¤‡ä»½æ¢å¤æ—¶é—´çˆ†ç‚¸ â˜˜ï¸ æœ¬è´¨\nè¡¨è®¾è®¡ä¸åˆç† æ²¡æœ‰æå‰æ‹†åˆ† å•ç‚¹æ•°æ®åº“ ğŸ›  è§£å†³æ–¹æ¡ˆ\nåˆ†åº“åˆ†è¡¨ å†·çƒ­æ•°æ®åˆ†ç¦» åœ¨çº¿ DDL å½’æ¡£ç­–ç•¥ å››ã€Redis vs MySQL é—®é¢˜å¯¹ç…§è¡¨ Redis é—®é¢˜ MySQL å¯¹åº”é—®é¢˜ ç¼“å­˜ç©¿é€ æ…¢æŸ¥è¯¢ / æ— æ•ˆæŸ¥è¯¢ ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹è¡Œé”ç«äº‰ ç¼“å­˜é›ªå´© å¹¶å‘é£æš´ / IO æ‰“æ»¡ Key è¿‡æœŸ å¤§äº‹åŠ¡ / å¤§è¡¨ æ•°æ®ä¸¢å¤± ä¸»ä»å»¶è¿Ÿ / å´©æºƒæ¢å¤ äº”ã€å¼€å‘è§†è§’ï¼šæœ€å®¹æ˜“è¸©çš„ MySQL å‘ âŒ 1. UPDATE æ²¡èµ°ç´¢å¼• -\u0026gt; é”è¡¨\nâŒ 2. å¤§äº‹åŠ¡ï¼ˆå¾ªç¯å†… UPDATEï¼‰\nâŒ 3. SELECT * + å¤§ç»“æœé›†\nâŒ 4. äº‹åŠ¡é‡Œ RPC / sleep\nâŒ 5. å¿½ç•¥ä¸»ä»å»¶è¿Ÿ\nğŸ‘‰ è¿™äº›éƒ½ç­‰ä»·äºâ€œç»•è¿‡ç¼“å­˜ç›´æ¥å‹å® MySQLâ€\nå…­ã€è¿ç»´è§†è§’ï¼šæœ€è‡´å‘½çš„ MySQL é£é™© é£é™© åæœ Binlog æœªå¤‡ä»½ æ— æ³• PITR Buffer Pool å¤ªå° IO æ‰“çˆ† å•ä¸»æ— åˆ‡æ¢ é•¿æ—¶é—´ä¸å¯ç”¨ å¤§è¡¨æ— å½’æ¡£ è¿ç»´ä¸å¯æ§ æ— æ…¢æ—¥å¿— é—®é¢˜æ— æ³•å®šä½ ä¸ƒã€æ€»ç»“ Redis çš„é—®é¢˜æ˜¯â€œæŒ¡ä¸ä½æµé‡â€ï¼Œ MySQL çš„é—®é¢˜æ˜¯â€œæ‰¿ä¸ä½å¹¶å‘ã€é”ã€IO å’Œå®¹é‡â€ã€‚\n","description":" ä¸€ã€å…ˆå¯¹é½æ¦‚å¿µï¼šRedis ä¸‰å¤§ç¼“å­˜é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ Redis æœ¬è´¨ ç¼“å­˜ç©¿é€ è®¿é—®ä¸å­˜åœ¨çš„æ•°æ® ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹ Key å¤±æ•ˆ ç¼“å­˜é›ªå´© å¤§é‡ Key åŒæ—¶å¤±æ•ˆ ğŸ‘‰ æœ¬è´¨éƒ½æ˜¯ï¼šæµé‡ / å¹¶å‘ç›´æ¥æ‰“åˆ° MySQL\näºŒã€MySQL å¯¹åº”çš„â€œæ ¸å¿ƒé—®é¢˜æ¨¡å‹â€ å¦‚æœ Redis æ˜¯â€œæŒ¡åœ¨ MySQL å‰é¢çš„ç¼“å†²å±‚â€ é‚£ MySQL è‡ªèº«çš„é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ï¼š å¹¶å‘ã€é”ã€IOã€å¤åˆ¶ã€ä¸€è‡´æ€§ã€å®¹é‡\nä¸‰ã€MySQL çš„ã€Œå…­å¤§æ ¸å¿ƒé—®é¢˜ã€ï¼ˆå¼€å‘ + è¿ç»´ï¼‰ â‘  å¹¶å‘é£æš´ï¼ˆç­‰ä»·äºâ€œç¼“å­˜é›ªå´©â€ï¼‰ ğŸ”¥ ç°è±¡\n"},{"id":326,"href":"/database/mysql/operation/","title":"MySQL è¿ç»´","parent":"MySQL","content":"ç›®å½•ï¼š\nMySQL å®‰è£…ä¸åŸºç¡€è¿ç»´ é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰ä¸å…³é”®å‚æ•° ç”¨æˆ·ä¸æƒé™ç®¡ç† å­˜å‚¨å¼•æ“ä¸è¡¨ç»“æ„ æ€§èƒ½ä¼˜åŒ– InnoDB å…³é”®æœºåˆ¶ æ—¥å¸¸ç›‘æ§æŒ‡æ ‡ å¤‡ä»½ä¸æ¢å¤ é«˜å¯ç”¨ï¼ˆHAï¼‰ä¸å¤åˆ¶ æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ æ•…éšœæ’æŸ¥ æ—¥å¸¸è¿ç»´æœ€ä½³å®è·µ MySQL å®‰å…¨æŒ‡å— 1. MySQL å®‰è£…ä¸åŸºç¡€è¿ç»´ 1.1 å®‰è£…æ–¹å¼ äºŒè¿›åˆ¶å®‰è£…ï¼ˆå®˜æ–¹æ¨èï¼‰ RPM/DEB åŒ…å®‰è£… Docker / Kubernetes éƒ¨ç½² æºç ç¼–è¯‘ï¼ˆä¸æ¨èï¼‰ 1.2 å¸¸ç”¨ç›®å½• è·¯å¾„ æè¿° /etc/my.cnf é…ç½®æ–‡ä»¶ /var/lib/mysql æ•°æ®ç›®å½• /var/log/mysql æ—¥å¿—ç›®å½• /usr/bin/mysql å®¢æˆ·ç«¯ /usr/sbin/mysqld æœåŠ¡ç«¯ 1.3 å¸¸è§å‘½ä»¤ systemctl start mysql systemctl stop mysql mysql -u root -p mysqld --verbose --help 2. é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰ä¸å…³é”®å‚æ•° 2.1 é…ç½®ç»“æ„ [mysqld] [mysql] [mysqldump] [client] 2.2 InnoDB å¸¸ç”¨å‚æ•° å‚æ•° æ¨èå€¼ è¯´æ˜ innodb_buffer_pool_size å†…å­˜ 60%~70% ç¼“å­˜æ•°æ®é¡µï¼ˆæ ¸å¿ƒï¼‰ innodb_log_file_size 1GB~4GB å†™æ—¥å¿—æ–‡ä»¶å¤§å° innodb_flush_log_at_trx_commit 1 æœ€å¼ºä¸€è‡´æ€§ innodb_file_per_table ON ç‹¬ç«‹è¡¨ç©ºé—´ innodb_flush_method O_DIRECT é¿å…åŒç¼“å­˜ 2.3 è¿æ¥å‚æ•° å‚æ•° è¯´æ˜ max_connections æœ€å¤§è¿æ¥æ•° wait_timeout ç©ºé—²è¿æ¥è¶…æ—¶ max_connect_errors æœ€å¤§é”™è¯¯è¿æ¥æ•° 2.4 æ…¢æŸ¥è¯¢ slow_query_log = 1 long_query_time = 1 ä½¿ç”¨ pt-query-digest åˆ†ææ…¢æ—¥å¿—ã€‚\n3. ç”¨æˆ·ä¸æƒé™ç®¡ç† CREATE USER \u0026#39;app\u0026#39;@\u0026#39;10.%\u0026#39; IDENTIFIED BY \u0026#39;xxx\u0026#39;; GRANT SELECT, INSERT, UPDATE ON db.* TO \u0026#39;app\u0026#39;@\u0026#39;10.%\u0026#39;; FLUSH PRIVILEGES; è¿ç»´ä¸æ¨èä½¿ç”¨ %ï¼Œåº”ä½¿ç”¨æœ€å°æƒé™åŸåˆ™ã€‚ ä½¿ç”¨å¤šè´¦å·åˆ†ç¦»ï¼šè¯»å†™åˆ†ç¦»ã€å¤‡ä»½è´¦å·ã€ç›‘æ§è´¦å·ç­‰ã€‚ 4. å­˜å‚¨ä¸è¡¨ç»“æ„ç®¡ç† 4.1 InnoDB ç‰¹å¾ èšç°‡ç´¢å¼• è¡Œçº§é” æ”¯æŒäº‹åŠ¡ é‡‡ç”¨ MVCC 4.2 è¡¨ç»“æ„è®¾è®¡å»ºè®® ä½¿ç”¨ INT UNSIGNED è€Œä¸æ˜¯ BIGINTï¼ˆèŠ‚çœå­˜å‚¨ï¼‰ é¿å… TEXTï¼Œä½¿ç”¨ VARCHAR æ—¶é—´å­—æ®µä½¿ç”¨ TIMESTAMP æˆ– DATETIME(3) ç´¢å¼•å‘½åï¼šidx_xxx_column 5. æ€§èƒ½ä¼˜åŒ–ï¼ˆPerformance Tuningï¼‰ ä¸»è¦ä» SQLã€ç´¢å¼•ã€é…ç½®ã€æ¶æ„ã€å­˜å‚¨ 5 å¤§æ–¹å‘ä¼˜åŒ–ã€‚\n5.1 SQL ä¼˜åŒ– æ…¢ SQL å¸¸è§åŸå› ï¼š\nå…¨è¡¨æ‰«æ ç´¢å¼•æœªå‘½ä¸­ éšå¼ç±»å‹è½¬æ¢ OR/IN/LIKE \u0026lsquo;%xx%\u0026rsquo; æ’åº/åˆ†ç»„å¯¼è‡´ filesort å¸¸ç”¨å·¥å…·ï¼š\nEXPLAIN SHOW PROFILE performance_schema pt-query-digest 6. InnoDB æ ¸å¿ƒæœºåˆ¶ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 6.1 MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ ä¾èµ–ï¼š\nUndo æ—¥å¿— Read View éšè—åˆ— trx_id / roll_pointer 6.2 Redo Log ä¿è¯ å´©æºƒæ¢å¤ï¼ˆcrash-safeï¼‰ã€‚\n6.3 Undo Log å®ç° MVCCã€å›æ»šã€‚\n6.4 Doublewrite Buffer é˜²æ­¢éƒ¨åˆ†é¡µé¢å†™å…¥æŸåã€‚\n6.5 Buffer Pool æ•°æ®åº“æ€§èƒ½æ ¸å¿ƒæ‰€åœ¨ã€‚\n7. ç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼ˆè¿ç»´å¿…å¤‡ï¼‰ 7.1 è¿æ¥ç›¸å…³ Threads_connected Threads_running Connections 7.2 äº‹åŠ¡ä¸é” innodb_row_lock_time_avg innodb_row_lock_current_waits innodb_deadlocks 7.3 Buffer Pool innodb_buffer_pool_reads innodb_buffer_pool_read_requests Buffer Pool å‘½ä¸­ç‡ 7.4 QPS/TPS SHOW GLOBAL STATUS LIKE \u0026#39;Com%\u0026#39;; 7.5 ç£ç›˜ IOPSã€å»¶è¿Ÿ 8. å¤‡ä»½ä¸æ¢å¤ï¼ˆBackup \u0026amp; Restoreï¼‰ 8.1 å¤‡ä»½ç­–ç•¥ æ¯æ—¥å…¨é‡å¤‡ä»½ï¼ˆmysqldump / xtrabackupï¼‰ æ¯å°æ—¶ binlog å¢é‡å¤‡ä»½ å¼‚åœ°å¤‡ä»½ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ å®šæœŸæ¢å¤æ¼”ç»ƒ 8.2 å·¥å…· å·¥å…· ç‰¹ç‚¹ mysqldump é€»è¾‘å¤‡ä»½ï¼Œæ…¢ xtrabackupï¼ˆæ¨èï¼‰ ç‰©ç†å¤‡ä»½ï¼Œçƒ­å¤‡ mysqlbinlog å¢é‡æ¢å¤ 9. é«˜å¯ç”¨ï¼ˆHAï¼‰æ–¹æ¡ˆ ä»å¼ºä¸€è‡´æ€§è§’åº¦æ’åºï¼š\næ–¹æ¡ˆ ä¸€è‡´æ€§ å¯ç”¨æ€§ æ¨èåº¦ MySQL Group Replication â˜…â˜…â˜…â˜…â˜… â˜…â˜…â˜…â˜…â˜… æ¨è MySQL InnoDB Cluster â˜…â˜…â˜…â˜…â˜… â˜…â˜…â˜…â˜…â˜… æ¨è Orchestrator + ä¸»ä»å¤åˆ¶ â˜…â˜… â˜…â˜…â˜…â˜…â˜… é«˜æ€§èƒ½åœºæ™¯ MHA â˜…â˜… â˜…â˜…â˜…â˜… è€æ–¹æ¡ˆ 10. æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ ç”Ÿäº§è¿ç»´é‡è¦ç¯èŠ‚ã€‚\nå·¥å…·ï¼š\npt-table-checksum pt-table-sync æ‰‹åŠ¨ checksumï¼šCHECKSUM TABLE 11. å¸¸è§æ•…éšœæ’æŸ¥ 11.1 æ— æ³•è¿æ¥ è´¦å·å¯†ç é”™è¯¯ é˜²ç«å¢™ / å®‰å…¨ç»„ max_connections è¾¾åˆ°ä¸Šé™ è¡¨æŸå 11.2 æ€§èƒ½ä¸‹é™ ç´¢å¼•å¤±æ•ˆ å¤§äº‹åŠ¡ è¡¨é”/æ­»é” Buffer Pool ä¸å¤Ÿ IO é¥±å’Œ 11.3 ä¸»ä»å»¶è¿Ÿ å¤§äº‹åŠ¡ ç½‘ç»œæŠ–åŠ¨ ä»åº“æ‰§è¡Œæ…¢ SQL 12. æ—¥å¸¸è¿ç»´æœ€ä½³å®è·µ è®¾ç½®å®šæœŸå¤‡ä»½ + æ¢å¤æ¼”ç»ƒ ä¸»ä»å¤åˆ¶å¿…é¡»å¯ç”¨ GTID ç”Ÿäº§é¿å…ä½¿ç”¨ DELETE å¤§è¡¨ï¼Œæ”¹ç”¨åˆ†æ‰¹æ¸…ç† é™åˆ¶å¤§äº‹åŠ¡ï¼ˆå•äº‹åŠ¡ \u0026lt; 10sï¼‰ é€šè¿‡ ProxySQL åšè¯»å†™åˆ†ç¦» æ‰€æœ‰ SQL ä¸Šç”Ÿäº§å‰å¿…é¡»èµ° explain è¯„å®¡ é…ç½®æ…¢æ—¥å¿—å¹¶å®šæœŸåˆ†æ ç³»ç»Ÿèµ„æºï¼ˆCPUã€IOã€å†…å­˜ï¼‰ç›‘æ§å¿…é¡»å¯è§†åŒ– 13. å®‰å…¨æŒ‡å— ä¸å…è®¸ root è¿œç¨‹ç™»å½• æ¯ä¸ªåº”ç”¨ç‹¬ç«‹çš„è´¦å· + æœ€å°æƒé™åŸåˆ™ å¯ç”¨ SSLï¼ˆ8.0 é»˜è®¤ï¼‰ å®šæœŸ rotate å¯†ç  åˆ é™¤ test æ•°æ®åº“ ","description":"ç›®å½•ï¼š\nMySQL å®‰è£…ä¸åŸºç¡€è¿ç»´ é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰ä¸å…³é”®å‚æ•° ç”¨æˆ·ä¸æƒé™ç®¡ç† å­˜å‚¨å¼•æ“ä¸è¡¨ç»“æ„ æ€§èƒ½ä¼˜åŒ– InnoDB å…³é”®æœºåˆ¶ æ—¥å¸¸ç›‘æ§æŒ‡æ ‡ å¤‡ä»½ä¸æ¢å¤ é«˜å¯ç”¨ï¼ˆHAï¼‰ä¸å¤åˆ¶ æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ æ•…éšœæ’æŸ¥ æ—¥å¸¸è¿ç»´æœ€ä½³å®è·µ MySQL å®‰å…¨æŒ‡å— 1. MySQL å®‰è£…ä¸åŸºç¡€è¿ç»´ 1.1 å®‰è£…æ–¹å¼ äºŒè¿›åˆ¶å®‰è£…ï¼ˆå®˜æ–¹æ¨èï¼‰ RPM/DEB åŒ…å®‰è£… Docker / Kubernetes éƒ¨ç½² æºç ç¼–è¯‘ï¼ˆä¸æ¨èï¼‰ 1.2 å¸¸ç”¨ç›®å½• è·¯å¾„ æè¿° /etc/my.cnf é…ç½®æ–‡ä»¶ /var/lib/mysql æ•°æ®ç›®å½• /var/log/mysql æ—¥å¿—ç›®å½• /usr/bin/mysql å®¢æˆ·ç«¯ /usr/sbin/mysqld æœåŠ¡ç«¯ 1.3 å¸¸è§å‘½ä»¤ systemctl start mysql systemctl stop mysql mysql -u root -p mysqld --verbose --help 2. é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰ä¸å…³é”®å‚æ•° 2.1 é…ç½®ç»“æ„ [mysqld] [mysql] [mysqldump] [client] 2.2 InnoDB å¸¸ç”¨å‚æ•° å‚æ•° æ¨èå€¼ è¯´æ˜ innodb_buffer_pool_size å†…å­˜ 60%~70% ç¼“å­˜æ•°æ®é¡µï¼ˆæ ¸å¿ƒï¼‰ innodb_log_file_size 1GB~4GB å†™æ—¥å¿—æ–‡ä»¶å¤§å° innodb_flush_log_at_trx_commit 1 æœ€å¼ºä¸€è‡´æ€§ innodb_file_per_table ON ç‹¬ç«‹è¡¨ç©ºé—´ innodb_flush_method O_DIRECT é¿å…åŒç¼“å­˜ 2.3 è¿æ¥å‚æ•° å‚æ•° è¯´æ˜ max_connections æœ€å¤§è¿æ¥æ•° wait_timeout ç©ºé—²è¿æ¥è¶…æ—¶ max_connect_errors æœ€å¤§é”™è¯¯è¿æ¥æ•° 2.4 æ…¢æŸ¥è¯¢ slow_query_log = 1 long_query_time = 1 ä½¿ç”¨ pt-query-digest åˆ†ææ…¢æ—¥å¿—ã€‚\n"},{"id":327,"href":"/database/mysql/operation-best-practices/","title":"MySQL è¿ç»´æœ€ä½³å®è·µ","parent":"MySQL","content":" 1. æ¶æ„ä¸éƒ¨ç½²æœ€ä½³å®è·µ 1.1 éƒ¨ç½²æ¶æ„ä¼˜å…ˆçº§ï¼ˆæ¨èï¼‰ ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆé‡‡ç”¨ï¼š\nåœºæ™¯ æ¨èæ¶æ„ ç‰¹ç‚¹ å¼ºä¸€è‡´æ€§ã€é‡‘èçº§ MGRï¼ˆä¸‰èŠ‚ç‚¹ï¼‰ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ã€å¼ºä¸€è‡´æ€§ã€æ— è„‘è¿ç»´ é«˜å¯ç”¨ä½†è¯»å†™åˆ†ç¦» Semi-sync ä¸»ä» + VIP/Keepalived æˆç†Ÿã€ç»´æŠ¤ç®€å• é«˜å‹åŠ› OLTP Percona XtraDB Clusterï¼ˆPXCï¼‰ å¯æ‰©å±•ã€å¼ºåŒæ­¥ã€æä¾› ProxySQL äº‘åŸç”Ÿ MySQL Operator / PXC Operator è‡ªåŠ¨å¤‡ä»½ + è‡ªåŠ¨æ¢å¤ + è‡ªåŠ¨æ‰©ç¼© 1.2 æœåŠ¡å™¨ / ç³»ç»Ÿå±‚æœ€ä½³å®è·µ Linux é…ç½®\nvm.swappiness = 1 fs.file-max = 1000000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.ip_local_port_range = 10000 65000 ç¡¬ä»¶å»ºè®®\nå†…å­˜ï¼šæ•°æ®é‡è‡³å°‘ 2â€“4 å€ ç£ç›˜ï¼šNVMe SSD + RAID10 CPUï¼šMySQL å¯¹å•æ ¸æ€§èƒ½ææ•æ„Ÿï¼ˆä¼˜å…ˆé«˜ä¸»é¢‘ â‰¥ 3.0 GHzï¼‰ 2. æ•°æ®åº“é…ç½®ï¼ˆmy.cnfï¼‰æœ€ä½³å®è·µ 2.1 æœ€é‡è¦çš„ InnoDB å‚æ•° [mysqld] innodb_buffer_pool_size = 70%~80% å†…å­˜ innodb_buffer_pool_instances = CPU æ ¸å¿ƒ / 2 innodb_log_file_size = 1G~4G innodb_flush_method = O_DIRECT innodb_flush_log_at_trx_commit = 1 innodb_file_per_table = 1 å‚æ•°è§£é‡Šï¼ˆèåˆåº•å±‚åŸç†ï¼‰\ninnodb_buffer_pool_size \u0026ndash; å†³å®š è¯»æ€§èƒ½ flush_log_at_trx_commit=1 \u0026ndash; æœ€å®‰å…¨ï¼ŒçœŸæ­£çš„ ACID innodb_log_file_size å¤§ + redo log æ›´é•¿ = å†™æ”¾å¤§å‡å°‘ = TPS æå‡ O_DIRECT \u0026ndash; é¿å… OS Cache åŒç¼“å­˜ï¼Œå‡å°‘è„é¡µæŠ–åŠ¨ 2.2 è¿æ¥æ± ä¸çº¿ç¨‹é…ç½® max_connections = 800 thread_cache_size = 256 max_connect_errors = 100000 ç”Ÿäº§ä¸­ 99% çš„ç“¶é¢ˆä¸æ˜¯ max_connectionsï¼Œè€Œæ˜¯ äº‹åŠ¡è¿‡é•¿å¯¼è‡´è¿æ¥å æ»¡ã€‚\n3. è¿ç»´ç›‘æ§ä¸å·¡æ£€æœ€ä½³å®è·µ 3.1 å¿…é¡»ç›‘æ§çš„æ ¸å¿ƒæŒ‡æ ‡ï¼ˆKPIï¼‰ 1ï¼‰å†™æ€§èƒ½ Innodb_os_log_fsyncs Log sequence number (LSN) å¢é€Ÿ Redo Log Waitï¼ˆ\u0026gt;0 å¿…é¡»æŸ¥åŸå› ï¼‰ 2ï¼‰é” Innodb_row_lock_waits Threads_runningï¼ˆ\u0026gt;20 å°±è¦è­¦æƒ•ï¼‰ 3ï¼‰IO innodb_data_reads/writes fsync timeï¼ˆæœ€é‡è¦ï¼‰ 4ï¼‰å¤åˆ¶å»¶è¿Ÿ MGRï¼šperformance_schema.replication_group_member_stats ä¸»ä»ï¼šSeconds_Behind_Master 3.2 æ¯æ—¥å·¡æ£€ Checklist ä¸»ä»å¤åˆ¶æ­£å¸¸ã€æ— å»¶è¿Ÿ Redo Log æ— ç­‰å¾… TempTable ä¸è¶…è¿‡ 5% æ²¡æœ‰ full table scan çš„æ…¢ SQL è¡¨ç©ºé—´å¢é•¿åˆç† å¤‡ä»½æˆåŠŸä¸”å¯æ¢å¤ ç£ç›˜åˆ©ç”¨ç‡ \u0026lt; 80% 4. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µï¼ˆèåˆåŸç†ï¼‰ 4.1 SQL ä¼˜åŒ–ä¼˜å…ˆçº§ï¼ˆå¿…éµå®ˆï¼‰ ä¼˜åŒ– SQL åŠ ç´¢å¼• ç»“æ„ä¼˜åŒ–ï¼ˆåèŒƒå¼ï¼‰ å¢åŠ å†…å­˜ï¼ˆBuffer Poolï¼‰ å¢åŠ èŠ‚ç‚¹ ğŸ‘‰ ç»ä¸è¦ä¸€å¼€å§‹å°±è°ƒ my.cnfã€‚\n4.2 ç´¢å¼•æœ€ä½³å®è·µ å•è¡¨è¯»å†™ QPS \u0026gt; 1W å¿…é¡»æœ‰è¦†ç›–ç´¢å¼• åŒºåˆ†åº¦ä½å­—æ®µï¼ˆå¦‚æ€§åˆ«ï¼‰ä¸å»ºç´¢å¼• å°½é‡ä½¿ç”¨ å‰ç¼€ç´¢å¼• å‡å°‘ç´¢å¼•å¤§å° ä¾‹ï¼š\nALTER TABLE users ADD INDEX idx_email(email(20)); 4.3 æ…¢ SQL å®šä½æ³•ï¼ˆæœ€å¼ºï¼‰ è§‚å¯Ÿ Threads_running\nSHOW GLOBAL STATUS LIKE \u0026#39;Threads_running\u0026#39;; 20ï¼šæ•°æ®åº“å·²ç»é˜»å¡ 100ï¼šç³»ç»Ÿåœ¨é›ªå´© è§‚å¯Ÿæ˜¯å¦å­˜åœ¨é”\nSELECT * FROM information_schema.innodb_locks; 5. High Availabilityï¼ˆé«˜å¯ç”¨ï¼‰æœ€ä½³å®è·µ 5.1 ä¸»ä»å¤åˆ¶æœ€ä½³å®è·µ binlog_format = ROW sync_binlog = 1 rpl_semi_sync_master_enabled = ON rpl_semi_sync_slave_enabled = ON å…³é”®ç‚¹ï¼š\nè¦ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¿…é¡» row æ ¼å¼ + semi-sync å¼‚æ­¥å¤åˆ¶ä¸€æ—¦ä¸»æŒ‚äº†ï¼Œæ•°æ®å¿…ç„¶ä¸¢ 5.2 MGRï¼ˆMySQL Group Replicationï¼‰æœ€ä½³å®è·µ éƒ¨ç½² 3 ä¸ªèŠ‚ç‚¹ï¼ˆodd quorumï¼‰\nä½¿ç”¨ single-primary-mode\nå¿…é¡»ä½¿ç”¨ XA + GTID\né˜²æ­¢è„‘è£‚ï¼š\ngroup_replication_exit_state_action = READ_ONLY 6. å¤‡ä»½ä¸æ¢å¤æœ€ä½³å®è·µï¼ˆæ ¸å¿ƒï¼‰ 6.1 å¿…é¡»é…ç½® PITRï¼ˆPoint-In-Time Recoveryï¼‰ ç»“æ„ï¼š\nç±»å‹ å·¥å…· å‘¨æœŸ å®Œå…¨å¤‡ä»½ xtrabackup æ¯æ—¥ å¢é‡å¤‡ä»½ xtrabackup æ¯å°æ—¶ Binlog MySQL å®æ—¶ æ¢å¤å‘½ä»¤ï¼š\nmysqlbinlog --start-datetime=\u0026#34;2025-12-10 10:00:00\u0026#34; \\ --stop-datetime=\u0026#34;2025-12-10 10:30:00\u0026#34; \\ binlog.000123 | mysql 7. å¸¸è§æ•…éšœ + æœ€ä½³å¤„ç†æ–¹å¼ 7.1 ä¸»åº“å‹åŠ›é«˜ï¼ˆ90% éƒ½æ˜¯è¿™ä¸ªï¼‰ ç—‡çŠ¶\nCPU 100% Threads_running å·¨é«˜ å¤åˆ¶å»¶è¿Ÿä¸Šå‡ è§£å†³ä¼˜å…ˆçº§\næ‰¾æ…¢ SQL åŠ ç´¢å¼• å¢åŠ åªè¯»å®ä¾‹ æ‹†åº“æ‹†è¡¨ å¼•å…¥ Redis ç¼“å­˜ ğŸ‘‰ é‡ç‚¹ï¼šä¸è¦ç›²ç›®è°ƒå‚ï¼Œä¹Ÿä¸è¦ç›²ç›®æ‰©æœºå™¨ã€‚\n7.2 ç£ç›˜å†™æ»¡ ç«‹å³ï¼š\nsystemctl stop mysql å¦åˆ™ MySQL ä¼šè‡ªåŠ¨å´©æºƒå¹¶æŸåæ•°æ®ã€‚\n7.3 undo/redo çˆ†æ»¡ å¸¸è§åŸå› ï¼šé•¿äº‹åŠ¡ï¼ˆsleeping ä¹Ÿç®—ï¼‰ã€‚\nå®šä½ï¼š\nSELECT * FROM information_schema.innodb_trx; 8. å®‰å…¨æœ€ä½³å®è·µ æ‰€æœ‰è´¦å·å¿…é¡»ä½¿ç”¨ plugin = caching_sha2_password ç¦æ­¢ % å…¨ç½‘æ®µè®¿é—® root ç¦æ­¢è¿œç¨‹ç™»å½• ç¦æ­¢ skip-grant-tables åŠ å¯†æ‰€æœ‰æ•°æ®ä¼ è¾“ï¼ˆTLSï¼‰ 9. è‡ªåŠ¨åŒ–è¿ç»´æœ€ä½³å®è·µ å¿…é…å·¥å…·\nPrometheus + Grafanaï¼ˆç›‘æ§ï¼‰ Ansibleï¼ˆé…ç½®ç®¡ç†ï¼‰ XtraBackupï¼ˆå¤‡ä»½ï¼‰ Orchestratorï¼ˆä¸»ä»åˆ‡æ¢ï¼‰ ProxySQLï¼ˆè¯»å†™åˆ†ç¦»ï¼‰ 10. æœ€ä½³å®è·µæ€»ç»“ï¼ˆæœ€é‡è¦çš„ 10 æ¡ï¼‰ ä¼˜å…ˆä½¿ç”¨ MGR æˆ– Semi-syncï¼Œé¿å…å¼‚æ­¥å¤åˆ¶ æ‰€æœ‰ SQL ä¸Šçº¿å¿…é¡»å®¡æ ¸ æ—¥å¸¸å·¡æ£€é”ã€æ…¢ SQLã€ç¼“å­˜å‘½ä¸­ç‡ SQL ä¼˜åŒ–æ°¸è¿œä¼˜å…ˆäºé…ç½®ä¼˜åŒ– ç¦æ­¢é•¿äº‹åŠ¡ ç£ç›˜å¿…é¡»ä½¿ç”¨ SSD + RAID10 Buffer Pool è‡³å°‘å å†…å­˜ 70% å¤§è¡¨ä¸è¦è½»æ˜“ ALTER TABLE å¿…é¡»éƒ¨ç½²å¤‡ä»½ + Binlogï¼ˆPITRï¼‰ æ¯åŠå¹´åšä¸€æ¬¡â€œä¸»åº“åˆ‡æ¢æ¼”ç»ƒâ€ æŒ‰çœŸå®ä¼ä¸šç”Ÿäº§ç¯å¢ƒæ ‡å‡†æ•´ç†ï¼Œæ¶µç›–é…ç½®ã€å¤‡ä»½ã€é«˜å¯ç”¨ã€ç›‘æ§ã€å®‰å…¨ã€SQL ç®¡æ§ã€å®¹é‡è§„åˆ’ç­‰å¤šä¸ªæ–¹é¢ï¼Œå®ç”¨æ€§æé«˜ï¼Œå¯ä½œä¸ºé•¿æœŸè¿ç»´æ‰‹å†Œã€‚\nç›®å½•ï¼š\nç³»ç»Ÿå±‚é¢æœ€ä½³å®è·µ é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰æœ€ä½³å®è·µ MySQL è´¦æˆ·ä¸æƒé™æœ€ä½³å®è·µ æ•°æ®åº“ç»“æ„è®¾è®¡æœ€ä½³å®è·µ SQL ä¸ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ ç›‘æ§æœ€ä½³å®è·µ å¤‡ä»½ä¸æ¢å¤æœ€ä½³å®è·µ ä¸»ä»å¤åˆ¶ä¸é«˜å¯ç”¨æœ€ä½³å®è·µ æ•°æ®ä¸€è‡´æ€§æœ€ä½³å®è·µ å®¹é‡è§„åˆ’æœ€ä½³å®è·µ å®‰å…¨æœ€ä½³å®è·µ æ—¥å¸¸è¿ç»´è§„èŒƒ 1. ç³»ç»Ÿå±‚é¢æœ€ä½³å®è·µï¼ˆOSï¼‰ 1.1 æ–‡ä»¶ç³»ç»Ÿ ä½¿ç”¨ ext4 æˆ– XFSï¼ˆç”Ÿäº§æ¨è XFSï¼‰ ç¦ç”¨ atimeï¼šnoatime ç£ç›˜è¯»å†™å°½é‡ä½¿ç”¨ SSD/NVMeï¼ˆIOPS ç›´æ¥å½±å“ MySQL æ€§èƒ½ï¼‰ 1.2 ç³»ç»Ÿå‚æ•°ï¼ˆ/etc/sysctl.confï¼‰ vm.swappiness = 1 vm.dirty_ratio = 10 vm.dirty_background_ratio = 5 fs.aio-max-nr = 1048576 1.3 CPU é¿å…å…±äº« CPUã€å¼ºéš”ç¦»ç¯å¢ƒï¼ˆKVM/VM ä¹Ÿå¯ä»¥ä½†éœ€è¦ CPU ç›´é€šï¼‰ é¿å…å¼€å¯èŠ‚èƒ½æ¨¡å¼ï¼ˆæ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼‰ 2. é…ç½®æ–‡ä»¶ï¼ˆmy.cnfï¼‰æœ€ä½³å®è·µ ä»¥ä¸‹ä¸º 16GB å†…å­˜å‚è€ƒï¼ˆå¯è®©æˆ‘è¦å…¶ä»–å†…å­˜ç‰ˆæœ¬ï¼‰ï¼š\n[mysqld] innodb_buffer_pool_size = 10G innodb_log_file_size = 1G innodb_flush_method = O_DIRECT innodb_flush_log_at_trx_commit = 1 innodb_file_per_table = 1 max_connections = 400 max_connect_errors = 10000 slow_query_log = 1 long_query_time = 1 log_output = FILE binlog_format = ROW binlog_row_image = FULL gtid_mode = ON enforce_gtid_consistency = ON server_id = 1001 log_bin = mysql-bin å…³é”®åŸåˆ™ï¼š\nBuffer Pool è®¾ç½®ä¸ºå†…å­˜çš„ 60%~70% Redo Log è¶Šå¤§ï¼ˆ1~4GBï¼‰ï¼Œå†™æ€§èƒ½è¶Šå¥½ binlog æ ¼å¼å¿…é¡»ä¸º ROWï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰ å¿…é¡»å¼€å¯ GTIDï¼ˆå¤åˆ¶ã€è¿ç»´æ›´å®‰å…¨ï¼‰ 3. ç”¨æˆ·ä¸æƒé™æœ€ä½³å®è·µ æœ€å°æƒé™åŸåˆ™ GRANT SELECT, INSERT, UPDATE ON db.* TO \u0026#39;app\u0026#39;@\u0026#39;10.%.%.%\u0026#39;; ä¸å…è®¸ root è¿œç¨‹ CREATE USER \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;xxx\u0026#39;; -- âŒ ç¦æ­¢è¿™æ ·åš è´¦å·é€»è¾‘åˆ†ç¦» è¯»è´¦å· å†™è´¦å· å¤‡ä»½è´¦å· ç›‘æ§è´¦å· è¿ç»´è´¦å· å¯†ç ç­–ç•¥ å®šæœŸ rotate ç¦æ­¢å¼±å¯†ç  4. æ•°æ®åº“ç»“æ„è®¾è®¡æœ€ä½³å®è·µ 4.1 å­—æ®µç±»å‹ é¿å… BIGINT æ»¥ç”¨ VARCHAR(N) è€Œä¸è¦ä½¿ç”¨ TEXT æšä¸¾ç±»å°½é‡ç”¨ TINYINT / SMALLINT æ—¶é—´ç”¨ DATETIME(3) 4.2 ç´¢å¼• æ¯ä¸ªè¡¨æœ€å¤š 3~5 ä¸ªç´¢å¼• ç´¢å¼•åˆ—å¿…é¡»æ˜¯æŸ¥è¯¢è¿‡æ»¤æ¡ä»¶ ç´¢å¼•å‘½åè§„åˆ™ï¼šidx_table_column 4.3 è¡¨åˆ†åŒº åªé€‚ç”¨äº TB çº§éå¸¸å¤§è¡¨ ä¸å»ºè®®åˆå­¦è€…æ»¥ç”¨ 5. SQL ä¸ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ 5.1 æ‰€æœ‰ä¸Šçº¿ SQL å¿…é¡»åš EXPLAIN å‘½ä¸­ type å¿…é¡»ä¸º ref æˆ–ä»¥ä¸Š é¿å… ALLï¼ˆå…¨è¡¨æ‰«æï¼‰ 5.2 ä¸¥ç¦ä»¥ä¸‹ SQL ç›´æ¥ä¸Šç”Ÿäº§ WHERE name LIKE \u0026lsquo;%xxx%\u0026rsquo; WHERE id != xxx å¤§è¡¨ FULL JOIN 5.3 å®šæœŸåˆ†ææ…¢ SQL ä½¿ç”¨ pt-query-digestï¼š\npt-query-digest /var/log/mysql/slow.log \u0026gt; slow_report.txt 6. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ ä¼˜åŒ–é¡ºåºä¸è¦åäº† SQL \u0026gt; ç´¢å¼• \u0026gt; æ¶æ„ \u0026gt; é…ç½® \u0026gt; ç¡¬ä»¶\nåƒä¸‡ä¸è¦å…ˆè°ƒ MySQL é…ç½®ã€‚\nå¤§äº‹åŠ¡æ‹†åˆ† ä¸è¦æ‰§è¡Œè¶…è¿‡ 1s çš„äº‹åŠ¡ï¼Œé¿å…ï¼š\næŒé”æ—¶é—´é•¿ äº§ç”Ÿå¤§é‡ undo ä¸»ä»å»¶è¿Ÿ 7. ç›‘æ§æœ€ä½³å®è·µ å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡ï¼ˆæ ¸å¿ƒï¼‰ï¼š\n7.1 è¿æ¥ Threads_running Threads_connected 7.2 äº‹åŠ¡ä¸é” innodb_row_lock_time_avg innodb_deadlocks innodb_trx 7.3 Buffer Pool å‘½ä¸­ç‡ï¼ˆ\u0026gt;99%ï¼‰ innodb_buffer_pool_reads 7.4 å»¶è¿Ÿä¸ QPS QPS / TPS æ…¢æŸ¥è¯¢æ•° 7.5 IO ç£ç›˜å»¶è¿Ÿ \u0026gt; 10ms å°±å±é™© IOPS å³°å€¼ ç›‘æ§å·¥å…·ï¼š\nPrometheus + mysqld_exporter Grafana Dashboard é˜¿é‡Œäº‘ RDS ç›‘æ§æ¨¡ç‰ˆ 8. å¤‡ä»½ä¸æ¢å¤æœ€ä½³å®è·µ 8.1 å¤‡ä»½ç­–ç•¥ï¼ˆä¼ä¸šæˆç†Ÿåšæ³•ï¼‰ æ¯æ—¥å…¨é‡ï¼ˆxtrabackupï¼‰ æ¯å°æ—¶å¢é‡ï¼ˆbinlogï¼‰ å¼‚åœ°å­˜å‚¨ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ æ¯å‘¨ä¸€æ¬¡ æ¢å¤æ¼”ç»ƒ 8.2 æ¢å¤æœ€ä½³å®è·µ æ¢å¤åˆ°æµ‹è¯•ç¯å¢ƒ å¯¹æ¯” checksum éªŒè¯ä¸»ä»ä¸€è‡´æ€§ 9. é«˜å¯ç”¨æœ€ä½³å®è·µï¼ˆHAï¼‰ ä»ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¸Šï¼Œä»é«˜åˆ°ä½ï¼š\næ–¹æ¡ˆ ä¸€è‡´æ€§ å¯ç”¨æ€§ ä¼ä¸šæ¨è MySQL InnoDB Clusterï¼ˆGRï¼‰ â˜…â˜…â˜…â˜…â˜… â˜…â˜…â˜…â˜…â˜… â­â­â­â­â­ MySQL Group Replication â˜…â˜…â˜…â˜…â˜… â˜…â˜…â˜…â˜…â˜… â­â­â­â­â­ Orchestrator + ä¸»ä» â˜…â˜… â˜…â˜…â˜…â˜…â˜… â­â­â­â­ MHA â˜…â˜…â˜… â˜…â˜…â˜…â˜… â­â­â­ ä¼˜å…ˆä½¿ç”¨ï¼š\nGroup Replicationï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ InnoDB Clusterï¼ˆå®˜æ–¹å…¨å®¶æ¡¶ï¼‰ 10. æ•°æ®ä¸€è‡´æ€§æœ€ä½³å®è·µ ä¼ä¸šçº§ä¸€è‡´æ€§æ–¹æ¡ˆï¼š\npt-table-checksumï¼ˆæ¨èï¼‰ pt-table-sync åŒæ­¥æ—¶ä½¿ç”¨ ROW binlog é¿å… â€œå¹¶å‘æ›´æ–° + è¯»å†™åˆ†ç¦»â€ å¯¼è‡´è„è¯» 11. å®¹é‡è§„åˆ’æœ€ä½³å®è·µ 11.1 é¢„ä¼°å¢é•¿ æ¯ä¸ªè¡¨å®¹é‡ æ¯å¤©æ–°å¢æ•°æ®é‡ 30/90/365 å¤©å¢é•¿è¶‹åŠ¿ 11.2 æ•°æ®åˆ†åŒºç­–ç•¥ åˆ†åº“åˆ†è¡¨ï¼ˆä¸»é”® hashï¼‰ æŒ‰æ—¥æœŸåˆ†è¡¨ï¼ˆæ—¥å¿—ç±»ï¼‰ å†·çƒ­æ•°æ®æ‹†åˆ† 11.3 é¿å…å•è¡¨è¶…è¿‡ 2000 ä¸‡è¡Œï¼ˆæ™®é€šä¸šåŠ¡ï¼‰ 1 äº¿è¡Œä»¥ä¸Šå»ºè®®åˆ†è¡¨ 12. å®‰å…¨æœ€ä½³å®è·µ ç¦æ­¢ root è¿œç¨‹ å°† MySQL æ”¾åœ¨ç§ç½‘ å¼€å¯å®¡è®¡æ—¥å¿—ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰ å¯¹ binlog åŠ å¯† å®šæœŸ rotate å¯†ç  ç¦æ­¢å¼±å¯†ç  å¼€å¯ SSL è¿æ¥ï¼ˆ8.x é»˜è®¤æ”¯æŒï¼‰ 13. æ—¥å¸¸è¿ç»´è§„èŒƒ æ¯å‘¨æŸ¥çœ‹æ…¢æŸ¥è¯¢æŠ¥å‘Š æ¯å¤©æ£€æŸ¥ä¸»ä»å»¶è¿Ÿ æ¯å¤©ç›‘æ§ç£ç›˜ç©ºé—´ æ¯æœˆåšä¸€æ¬¡å¤‡ä»½æ¢å¤æ¼”ç»ƒ æ‰€æœ‰ DDL å¿…é¡»å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ æ‰€æœ‰ SQL ä¸Šçº¿å¿…é¡»ç»è¿‡ Code Review ","description":" 1. æ¶æ„ä¸éƒ¨ç½²æœ€ä½³å®è·µ 1.1 éƒ¨ç½²æ¶æ„ä¼˜å…ˆçº§ï¼ˆæ¨èï¼‰ ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆé‡‡ç”¨ï¼š\nåœºæ™¯ æ¨èæ¶æ„ ç‰¹ç‚¹ å¼ºä¸€è‡´æ€§ã€é‡‘èçº§ MGRï¼ˆä¸‰èŠ‚ç‚¹ï¼‰ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ã€å¼ºä¸€è‡´æ€§ã€æ— è„‘è¿ç»´ é«˜å¯ç”¨ä½†è¯»å†™åˆ†ç¦» Semi-sync ä¸»ä» + VIP/Keepalived æˆç†Ÿã€ç»´æŠ¤ç®€å• é«˜å‹åŠ› OLTP Percona XtraDB Clusterï¼ˆPXCï¼‰ å¯æ‰©å±•ã€å¼ºåŒæ­¥ã€æä¾› ProxySQL äº‘åŸç”Ÿ MySQL Operator / PXC Operator è‡ªåŠ¨å¤‡ä»½ + è‡ªåŠ¨æ¢å¤ + è‡ªåŠ¨æ‰©ç¼© 1.2 æœåŠ¡å™¨ / ç³»ç»Ÿå±‚æœ€ä½³å®è·µ Linux é…ç½®\n"},{"id":328,"href":"/database/mysql/my-cnf/","title":"MySQL é…ç½®æ–‡ä»¶ my.cnf","parent":"MySQL","content":" ä¸€ã€å®Œæ•´ my.cnfï¼ˆç”Ÿäº§çº§ï¼‰ ä»¥ä¸‹ my.cnf é€‚ç”¨äº MySQL 8.xï¼Œå†…å­˜çº¦ 16GB çš„æœåŠ¡å™¨ï¼ˆå¦‚éœ€ 4GB/8GB/32GB/64GBï¼‰ã€‚\nâš ï¸ ä»…åŒ…å«å®é™…ç”Ÿäº§æœ€é‡è¦ã€æœ€å¸¸ç”¨ã€å¿…é¡»é…ç½®çš„å‚æ•°ï¼ˆä¸åŒ…å«æ— æ„ä¹‰/è¿‡æ—¶å‚æ•°ï¼‰\n[mysqld] ä¸»æœåŠ¡é…ç½®æ®µ\n[mysqld] # ------------------------------- # åŸºç¡€ # ------------------------------- user = mysql server_id = 101 port = 3306 pid-file = /var/run/mysqld/mysqld.pid socket = /var/run/mysqld/mysqld.sock basedir = /usr/local/mysql datadir = /data/mysql tmpdir = /data/mysql/tmp # ------------------------------- # è¿æ¥å‚æ•° # ------------------------------- max_connections = 400 max_connect_errors = 10000 wait_timeout = 28800 interactive_timeout = 28800 # ------------------------------- # InnoDB æ ¸å¿ƒé…ç½® # ------------------------------- default_storage_engine = InnoDB innodb_buffer_pool_size = 10G innodb_buffer_pool_instances = 8 innodb_log_file_size = 1G innodb_log_buffer_size = 64M innodb_flush_method = O_DIRECT innodb_flush_log_at_trx_commit = 1 innodb_file_per_table = 1 innodb_io_capacity = 2000 innodb_io_capacity_max = 4000 innodb_read_io_threads = 4 innodb_write_io_threads = 4 # ------------------------------- # äº‹åŠ¡ä¸é” # ------------------------------- innodb_lock_wait_timeout = 50 transaction_isolation = READ-COMMITTED # ------------------------------- # äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ # ------------------------------- log_bin = mysql-bin binlog_format = ROW binlog_row_image = FULL sync_binlog = 1 expire_logs_days = 7 binlog_cache_size = 4M gtid_mode = ON enforce_gtid_consistency = ON log_slave_updates = ON # ------------------------------- # æ…¢æŸ¥è¯¢æ—¥å¿— # ------------------------------- slow_query_log = 1 slow_query_log_file = /var/log/mysql/slow.log long_query_time = 1 log_queries_not_using_indexes = 0 # ------------------------------- # é”™è¯¯æ—¥å¿— # ------------------------------- log_error = /var/log/mysql/error.log # ------------------------------- # å­—ç¬¦é›† # ------------------------------- character_set_server = utf8mb4 collation_server = utf8mb4_general_ci # ------------------------------- # å…¶ä»– # ------------------------------- skip_name_resolve = 1 äºŒã€my.cnf å‚æ•°å®Œæ•´è¯¦è§£ï¼ˆè¿ç»´å¿…é¡»æŒæ¡ï¼‰ ä»¥ä¸‹å¯¹ æœ€å¸¸ç”¨ã€æœ€é‡è¦ã€ç”Ÿäº§å¿…éœ€çš„å‚æ•° è¿›è¡Œåˆ†ç±»è®²è§£ã€‚\n1. åŸºç¡€å‚æ•° server_id ç”¨äºå¤åˆ¶é›†ç¾¤å†…å”¯ä¸€ IDã€‚\ndatadir æ•°æ®åº“æ–‡ä»¶å­˜å‚¨è·¯å¾„ã€‚\nsocket æœ¬åœ°è¿æ¥ä½¿ç”¨ã€‚\ntmpdir ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼ˆæ’åºã€æ–‡ä»¶æ’åºéƒ½ä¼šæ”¾è¿™é‡Œï¼‰ã€‚\n2. è¿æ¥å‚æ•° å‚æ•° è¯´æ˜ å»ºè®® max_connections æœ€å¤§è¿æ¥æ•° 300~500 è¶³å¤Ÿ max_connect_errors IP è¿ç»­è¿æ¥å¤±è´¥é™åˆ¶ 10000 wait_timeout ç©ºé—²è¿æ¥è¶…æ—¶ 8 å°æ—¶ interactive_timeout äº¤äº’è¿æ¥è¶…æ—¶ åŒä¸Š ğŸ’¡ ä¸è¦æŠŠ max_connections è®¾ç½®å¤ªå¤§ï¼Œå¦åˆ™ä¼šæ‰“çˆ†æœåŠ¡å™¨èµ„æºã€‚\n3. çº¿ç¨‹ã€ç¼“å­˜ã€ä¼šè¯ç›¸å…³ thread_cache_size çº¿ç¨‹ç¼“å­˜æ•°é‡ï¼ˆå‡å°‘çº¿ç¨‹åå¤åˆ›å»ºï¼‰ã€‚\ntable_open_cache è¡¨ç¼“å­˜æ•°é‡ã€‚\nquery_cache MySQL 8.0 å·²å½»åº•ç§»é™¤ï¼Œä¸èƒ½ä½¿ç”¨ã€‚\n4. InnoDB å­˜å‚¨å¼•æ“ï¼ˆæ ¸å¿ƒé‡ç‚¹ï¼‰ è¿™æ˜¯ MySQL è¿ç»´æœ€é‡è¦å†…å®¹ã€‚\ninnodb_buffer_pool_size Buffer Pool å¤§å°ï¼ˆæ ¸å¿ƒå‚æ•°ï¼‰\nMySQL æ€§èƒ½çš„ 80% éƒ½å–å†³äºè¿™ä¸ªé…ç½®ã€‚ æ¨èè®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 60%~70%ã€‚ innodb_buffer_pool_instances å®ä¾‹æ•°é‡\nå»ºè®®ï¼š8ï¼ˆ16GB å†…å­˜ï¼‰ innodb_log_file_size Redo Log æ–‡ä»¶å¤§å°\nå¸¸ç”¨å€¼ï¼š512M ~ 4G å½±å“å†™å…¥æ€§èƒ½ä¸æ¢å¤é€Ÿåº¦ã€‚\ninnodb_log_buffer_size æ—¥å¿—ç¼“å†²å¤§å°\næ¨èï¼š64M innodb_flush_method = O_DIRECT è®© MySQL ç›´æ¥å†™ç£ç›˜ï¼Œé¿å…åŒç¼“å­˜ï¼ˆOS Page Cacheï¼‰ã€‚\ninnodb_flush_log_at_trx_commit äº‹åŠ¡ä¸€è‡´æ€§ï¼š\nå€¼ å«ä¹‰ 1 æœ€å®‰å…¨ï¼ˆç”Ÿäº§å¼ºçƒˆæ¨èï¼‰ 2 æ¯ç§’åˆ·ä¸€æ¬¡ 0 ä¸å®‰å…¨ innodb_file_per_table ç‹¬ç«‹è¡¨ç©ºé—´ã€‚å¿…é¡»å¼€å¯ã€‚\ninnodb_lock_wait_timeout é”ç­‰å¾…è¶…æ—¶é¿å…æ­»é”ã€‚\n5. Binlog ä¸å¤åˆ¶ï¼ˆç”Ÿäº§å…³é”®ï¼‰ log_bin å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—ã€‚\nbinlog_format 3 ç§æ ¼å¼ï¼š\næ ¼å¼ è¯´æ˜ æ¨è STATEMENT è¯­å¥çº§ âŒ ä¸ä¸€è‡´ MIXED æ··åˆçº§ âš ï¸ ä¸æ¨è ROW è¡Œçº§ âœ… å¼ºä¸€è‡´æ€§ sync_binlog æ§åˆ¶ binlog çš„åˆ·ç›˜ï¼š\nå€¼ å«ä¹‰ æ¨è 1 æ¯æ¬¡äº‹åŠ¡åˆ·ç›˜ âœ… æœ€å®‰å…¨ 0 ä¸åˆ·ç›˜ âŒ N æ¯ N æ¬¡åˆ·ç›˜ å¯æå‡æ€§èƒ½ expire_logs_days è‡ªåŠ¨æ¸…ç† binlogã€‚\ngtid_mode = ON å¼€å¯ GTIDï¼ˆå¼ºçƒˆæ¨èï¼‰ã€‚\nlog_slave_updates è®©ä»åº“ä¹Ÿè®°å½• binlogï¼Œç”¨äºçº§è”å¤åˆ¶ã€‚\n6. æ…¢æŸ¥è¯¢æ—¥å¿— slow_query_log å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚\nlong_query_time æ…¢æŸ¥è¯¢æ—¶é—´é˜ˆå€¼å»ºè®®ï¼š1s\nlog_queries_not_using_indexes ä¸€èˆ¬ä¸å»ºè®®å¼€å¯ï¼Œä¼šå¯¼è‡´æ—¥å¿—çˆ†ç‚¸ã€‚\n7. å­—ç¬¦é›† character_set_server = utf8mb4 æ°¸è¿œç”¨ utf8mb4ï¼Œè€Œä¸æ˜¯ utf8ï¼ˆå‡ utf8ï¼‰ã€‚\n8. å…¶ä»–æ ¸å¿ƒå‚æ•° å‚æ•° è¯´æ˜ skip_name_resolve ç¦æ­¢ DNS åæŸ¥ï¼Œæé«˜è¿æ¥é€Ÿåº¦ lower_case_table_names æ˜¯å¦å¤§å°å†™æ•æ„Ÿï¼ˆLinux é»˜è®¤ä¸º 0ï¼‰ sql_mode ä¸¥æ ¼æ¨¡å¼ ç”Ÿäº§å»ºè®® SQL_MODEï¼š\nSTRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION ","description":" ä¸€ã€å®Œæ•´ my.cnfï¼ˆç”Ÿäº§çº§ï¼‰ ä»¥ä¸‹ my.cnf é€‚ç”¨äº MySQL 8.xï¼Œå†…å­˜çº¦ 16GB çš„æœåŠ¡å™¨ï¼ˆå¦‚éœ€ 4GB/8GB/32GB/64GBï¼‰ã€‚\nâš ï¸ ä»…åŒ…å«å®é™…ç”Ÿäº§æœ€é‡è¦ã€æœ€å¸¸ç”¨ã€å¿…é¡»é…ç½®çš„å‚æ•°ï¼ˆä¸åŒ…å«æ— æ„ä¹‰/è¿‡æ—¶å‚æ•°ï¼‰\n[mysqld] ä¸»æœåŠ¡é…ç½®æ®µ\n[mysqld] # ------------------------------- # åŸºç¡€ # ------------------------------- user = mysql server_id = 101 port = 3306 pid-file = /var/run/mysqld/mysqld.pid socket = /var/run/mysqld/mysqld.sock basedir = /usr/local/mysql datadir = /data/mysql tmpdir = /data/mysql/tmp # ------------------------------- # è¿æ¥å‚æ•° # ------------------------------- max_connections = 400 max_connect_errors = 10000 wait_timeout = 28800 interactive_timeout = 28800 # ------------------------------- # InnoDB æ ¸å¿ƒé…ç½® # ------------------------------- default_storage_engine = InnoDB innodb_buffer_pool_size = 10G innodb_buffer_pool_instances = 8 innodb_log_file_size = 1G innodb_log_buffer_size = 64M innodb_flush_method = O_DIRECT innodb_flush_log_at_trx_commit = 1 innodb_file_per_table = 1 innodb_io_capacity = 2000 innodb_io_capacity_max = 4000 innodb_read_io_threads = 4 innodb_write_io_threads = 4 # ------------------------------- # äº‹åŠ¡ä¸é” # ------------------------------- innodb_lock_wait_timeout = 50 transaction_isolation = READ-COMMITTED # ------------------------------- # äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ # ------------------------------- log_bin = mysql-bin binlog_format = ROW binlog_row_image = FULL sync_binlog = 1 expire_logs_days = 7 binlog_cache_size = 4M gtid_mode = ON enforce_gtid_consistency = ON log_slave_updates = ON # ------------------------------- # æ…¢æŸ¥è¯¢æ—¥å¿— # ------------------------------- slow_query_log = 1 slow_query_log_file = /var/log/mysql/slow.log long_query_time = 1 log_queries_not_using_indexes = 0 # ------------------------------- # é”™è¯¯æ—¥å¿— # ------------------------------- log_error = /var/log/mysql/error.log # ------------------------------- # å­—ç¬¦é›† # ------------------------------- character_set_server = utf8mb4 collation_server = utf8mb4_general_ci # ------------------------------- # å…¶ä»– # ------------------------------- skip_name_resolve = 1 äºŒã€my.cnf å‚æ•°å®Œæ•´è¯¦è§£ï¼ˆè¿ç»´å¿…é¡»æŒæ¡ï¼‰ ä»¥ä¸‹å¯¹ æœ€å¸¸ç”¨ã€æœ€é‡è¦ã€ç”Ÿäº§å¿…éœ€çš„å‚æ•° è¿›è¡Œåˆ†ç±»è®²è§£ã€‚\n"},{"id":329,"href":"/database/mysql/locks/","title":"MySQL é”","parent":"MySQL","content":"è¦†ç›–ï¼šæ ¸å¿ƒæ¦‚å¿µã€é”ç±»å‹ã€åŠ é”æ–¹å¼ã€é”ç­‰å¾…ã€æ­»é”ã€è¯Šæ–­ã€ä¼˜åŒ–ã€å®æˆ˜æ¡ˆä¾‹ã€‚\nğŸ§± 1. é”çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆå¿…é¡»å…ˆç†è§£ï¼‰ MySQL ä¸»æµå­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼Œé”æœºåˆ¶å›´ç»•äº‹åŠ¡ã€è¡Œçº§é”ã€MVCC ç­‰å±•å¼€ã€‚ç†è§£é”çš„ç›®çš„ï¼š\nä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ ä¿è¯äº‹åŠ¡éš”ç¦» é˜²æ­¢å¹¶å‘å†²çª ä¿è¯æ•°æ®ä¸€è‡´æ€§ æé«˜å¹¶å‘æ€§èƒ½ï¼ˆè¡Œé”æ¯”è¡¨é”æ›´ granularï¼‰ MySQL ä¸­â€œé” + MVCC + äº‹åŠ¡éš”ç¦»çº§åˆ«â€ä¸‰è€…é…åˆ é”ï¼šé˜»å¡å†™ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹é˜»å¡è¯» MVCCï¼šè®©è¯»å°½é‡ä¸åŠ é” äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šæ§åˆ¶è¯»å†™å†²çªä½•æ—¶éœ€è¦é” æŒæ¡è¿™ä¸‰è€…çš„å…³ç³»ï¼Œæ˜¯ç†è§£ MySQL å¹¶å‘è¡Œä¸ºçš„åŸºç¡€ã€‚\nğŸ§± 2. MySQLï¼ˆInnoDBï¼‰é”ç±»å‹å…¨å›¾ ä¸‹é¢æ˜¯ MySQL é‡Œæ‰€æœ‰é‡è¦é”ï¼ˆå®Œæ•´ä½“ç³»åŒ–ï¼‰ï¼š\n2.1 ä»â€œé”çš„ç²’åº¦â€åŒºåˆ† ç±»å‹ è¯´æ˜ å…¨å±€é”ï¼ˆGlobal Lockï¼‰ FLUSH TABLES WITH READ LOCKï¼ˆFTWRLï¼‰ï¼›é€»è¾‘å¤‡ä»½å¸¸ç”¨ï¼›å½±å“å…¨åº“ è¡¨çº§é”ï¼ˆTable Lockï¼‰ MySQL å±‚é¢çš„è¡¨é”ï¼›DDL ä½¿ç”¨ å…ƒæ•°æ®é”ï¼ˆMDLï¼‰ ä¿è¯ DDL ä¸ DML ä¸å†²çª è¡Œçº§é”ï¼ˆRow Lockï¼‰ InnoDB çš„æ ¸å¿ƒé”ï¼›ç²¾ç»†é”ç²’åº¦ é—´éš™é”ï¼ˆGap Lockï¼‰ é˜»æ­¢å¹»è¯»ï¼›é”ä¸å­˜åœ¨çš„è®°å½•èŒƒå›´ ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ è¡Œé” + é—´éš™é”ï¼›RR éš”ç¦»çº§åˆ«é»˜è®¤ æ’å…¥æ„å‘é”ï¼ˆInsert Intention Lockï¼‰ æ’å…¥å‰çš„èŒƒå›´é”ï¼Œç”¨äºåè°ƒ Insert å¹¶å‘ 2.2 ä»â€œé”çš„å±æ€§â€åŒºåˆ† å±æ€§ ç±»å‹ è¯´æ˜ è¯»é” S é”ï¼ˆShared Lockï¼‰ å¯å…±äº«è¯» å†™é” X é”ï¼ˆExclusive Lockï¼‰ ç‹¬å å†™ æ„å‘é” IS, IX ç”¨äºåŠ é€Ÿåˆ¤æ–­æ˜¯å¦èƒ½åœ¨è¡Œçº§åŠ é” AUTO-INC é” è‡ªå¢å­—æ®µä¸Šçš„è½»é‡é” INSERT æ—¶åºä¿è¯ éšå¼é” insert æ—¶è‡ªåŠ¨äº§ç”Ÿï¼Œä¸éœ€è¦æ˜¾å¼é”ç»“æ„ MVCC + undo æ”¯æŒ ğŸ§± 3. InnoDB è¡Œé”ï¼ˆInnoDB çš„æ ¸å¿ƒé”ï¼‰ è¡Œé”åˆ†ç±» é”ç±»å‹ è¯´æ˜ Record Lockï¼ˆè®°å½•é”ï¼‰ é”å•è¡Œè®°å½• Gap Lockï¼ˆé—´éš™é”ï¼‰ é”ä¸€ä¸ªèŒƒå›´ä½†ä¸å«ç›®æ ‡è®°å½• Next-Key Lockï¼ˆä¸´é”®é”ï¼‰ è®°å½•é” + Gapï¼›ç”¨äºé˜²æ­¢å¹»è¯» Insert Intention Lock INSERT æ—¶å¯¹ gap åŠ çš„é” åŠ é”è¡Œä¸ºç”±ä¸‰ä¸ªå› ç´ å†³å®š äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆå¦‚ RR ä¼šè‡ªåŠ¨åŠ  gap/next-keyï¼‰ æ˜¯å¦èµ°ç´¢å¼• æ˜¯å¦æ˜¯ç²¾å‡†åŒ¹é…ï¼ˆç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼‰ ğŸ”¥ é‡ç‚¹ï¼šæ²¡æœ‰èµ°ç´¢å¼• = é”å…¨è¡¨ = æ€§èƒ½ç¾éš¾\nå¿…é¡»ç‰¢è®°è¿™ä¸€ç‚¹ã€‚\nğŸ§± 4. é”æ˜¯å¦‚ä½•åŠ ä¸Šçš„ï¼Ÿï¼ˆå¿…é¡»ç†è§£çš„è§„åˆ™ï¼‰ ä»¥ä¸‹è§„åˆ™å¸®åŠ©ä½ å‡†ç¡®åˆ¤æ–­ SQL ä¼šé”ä»€ä¹ˆã€‚\n4.1 ç²¾å‡†ç­‰å€¼æŸ¥è¯¢ + å”¯ä¸€ç´¢å¼• -\u0026gt; è¡Œé” SELECT * FROM users WHERE id = 10 FOR UPDATE; -\u0026gt; åŠ  record lockï¼ˆå•è¡Œï¼‰\n4.2 ç­‰å€¼æŸ¥è¯¢ä½†éå”¯ä¸€ç´¢å¼• -\u0026gt; next-key lock / gap lock SELECT * FROM users WHERE age = 20 FOR UPDATE; å¯èƒ½é”ä½å¤šä¸ªèŒƒå›´ï¼Œè€Œä¸æ˜¯å•æ¡ã€‚\n4.3 èŒƒå›´æŸ¥è¯¢ -\u0026gt; next-key SELECT * FROM users WHERE age \u0026gt; 20 FOR UPDATE; -\u0026gt; é”æ•´ä¸ªèŒƒå›´ -\u0026gt; å®¹æ˜“å‡ºç°é”ç­‰å¾…\n4.4 æœªä½¿ç”¨ç´¢å¼• -\u0026gt; å…¨è¡¨é”ï¼ˆè¡Œé”é€€åŒ–ä¸ºè¡¨é”ï¼‰ SELECT * FROM users WHERE name LIKE \u0026#39;%abc%\u0026#39; FOR UPDATE; -\u0026gt; é”å…¨è¡¨ï¼ˆç¾éš¾çº§ï¼‰\n4.5 INSERT ä¼šåŠ  Insert Intention Lock å¤šä¸ªæ’å…¥èƒ½å¹¶å‘æ‰§è¡Œï¼Œä¸ä¼šç›¸äº’é˜»å¡ã€‚\nğŸ§± 5. MySQL é”ç­‰å¾…ä¸æ­»é” 5.1 æŸ¥çœ‹é”ç­‰å¾… SELECT * FROM information_schema.innodb_locks; SELECT * FROM information_schema.innodb_lock_waits; SELECT * FROM information_schema.innodb_trx; 5.2 æŸ¥çœ‹ç­‰å¾…é“¾ SELECT * FROM performance_schema.data_lock_waits; ğŸ§± 6. æ­»é”æ’æŸ¥ï¼ˆæœ€é‡è¦ï¼‰ 6.1 æŸ¥çœ‹æ­»é”æ—¥å¿— SHOW ENGINE INNODB STATUS; é‡ç‚¹çœ‹ï¼š\nLATEST DETECTED DEADLOCK å“ªä¸ªäº‹åŠ¡è¢«æ€ é”ç±»å‹ï¼ˆrecord, next-key, gapï¼‰ è§¦å‘è¯­å¥ ğŸ§± 7. é”ä¼˜åŒ–ç­–ç•¥ï¼ˆæœ€ç»ˆæ€»ç»“ï¼‰ 7.1 SQL å±‚é¢ä¼˜åŒ– å¿…é¡»ä½¿ç”¨ ç´¢å¼•ï¼ˆé¿å…é”å…¨è¡¨ï¼‰ ç­‰å€¼æŸ¥è¯¢å°½é‡ä½¿ç”¨ å”¯ä¸€ç´¢å¼• é¿å…èŒƒå›´æŸ¥è¯¢ + FOR UPDATE é¿å…å¤§äº‹åŠ¡ï¼ˆå¤§äº‹åŠ¡é”èŒƒå›´å¤§ï¼‰ DML è¯­å¥å¿…é¡»å¸¦æ¡ä»¶ï¼ˆWHERE / LIMITï¼‰ 7.2 äº‹åŠ¡å±‚é¢ä¼˜åŒ– å°½å¿«æäº¤äº‹åŠ¡ï¼ˆçŸ­äº‹åŠ¡ï¼‰ å‡å°‘ä¸šåŠ¡é€»è¾‘æ”¾åœ¨äº‹åŠ¡å†…éƒ¨ å°½é‡æŒ‰å›ºå®šé¡ºåºè®¿é—®è¡¨ï¼ˆé¿å…æ­»é”ï¼‰ ç¦æ­¢äº‹åŠ¡é‡Œæ‰§è¡Œå¤–éƒ¨ RPC æˆ–è€—æ—¶æ“ä½œ 7.3 é«˜å¹¶å‘åœºæ™¯çš„è®¾è®¡ä¼˜åŒ– å‡å°‘é”å†²çª -\u0026gt; æœ€å°åŒ–çƒ­ç‚¹ ç”¨ Redis æˆ–åˆ†å¸ƒå¼é”é™ä½æ•°æ®åº“äº‰æŠ¢ MySQL é‡Œçƒ­ç‚¹è®¡æ•°å¯ä»¥ä½¿ç”¨ï¼š åˆ†åº“æ‹†è¡¨ ä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰ è¡Œçº§é”æ§åˆ¶æ›´æ–°é¡ºåºï¼ˆFOR UPDATEï¼‰ 7.4 é…ç½®å±‚é¢ä¼˜åŒ–ï¼ˆå›å¤2 å†…å®¹èåˆï¼‰ å‚æ•° è¯´æ˜ innodb_lock_wait_timeout é”ç­‰å¾…æ—¶é•¿ innodb_deadlock_detect æ­»é”æ£€æµ‹å¼€å…³ innodb_print_all_deadlocks æ‰“å°æ‰€æœ‰æ­»é” transaction_isolation å»ºè®®ä½¿ç”¨ RC æå‡å¹¶å‘ ğŸ§± 8. æœ€é‡è¦çš„å®æˆ˜æ¡ˆä¾‹ï¼ˆå…¨è¦†ç›–ï¼‰ æ¡ˆä¾‹ 1ï¼šèŒƒå›´æŸ¥è¯¢å¯¼è‡´å¤§é¢ç§¯åŠ é” UPDATE orders SET status=1 WHERE id \u0026gt; 1000; é”ä½å·¨å¤§èŒƒå›´ å¤§é‡é”ç­‰å¾… è§£å†³ï¼šåˆ†æ‰¹æ›´æ–°\nUPDATE orders SET status=1 WHERE id \u0026gt; 1000 LIMIT 500; æ¡ˆä¾‹ 2ï¼šæœªèµ°ç´¢å¼•å¯¼è‡´å…¨è¡¨é” SELECT * FROM user WHERE email LIKE \u0026#39;%@gmail.com%\u0026#39; FOR UPDATE; ç´¢å¼•å¤±æ•ˆ é”å…¨è¡¨ è§£å†³ï¼šæ”¹æˆåå‘å­˜å‚¨ç­‰æ–¹å¼\næ¡ˆä¾‹ 3ï¼šæ­»é”å…¸å‹ï¼ˆä¸¤ä¸ªäº‹åŠ¡è®¿é—®é¡ºåºä¸ä¸€è‡´ï¼‰ äº‹åŠ¡ Aï¼šå…ˆé”ç”¨æˆ·è¡¨ -\u0026gt; å†é”è®¢å•è¡¨ äº‹åŠ¡ Bï¼šå…ˆé”è®¢å•è¡¨ -\u0026gt; å†é”ç”¨æˆ·è¡¨ -\u0026gt; ç¯è·¯ -\u0026gt; æ­»é”\nè§£å†³ï¼šè®¿é—®é¡ºåºç»Ÿä¸€\nuser -\u0026gt; order ç»Ÿä¸€é¡ºåºå³å¯é¿å…å¤§å¤šæ•°æ­»é”\nğŸ§± 9. æœ€ç»ˆæ€»ç»“ï¼ˆæé€Ÿå¤ç›˜ï¼‰ MySQL é” = è¡Œé” + é—´éš™é” + ä¸´é”®é” + æ„å‘é” + MDL + AUTO-INC ä½¿ç”¨ç´¢å¼• = é¿å…è¡Œé”é€€åŒ–ä¸ºè¡¨é” RR éš”ç¦»çº§åˆ« = é»˜è®¤äº§ç”Ÿ Next-Key é” æ­»é”æœ¬è´¨ = ä¸¤ä¸ªäº‹åŠ¡å¾ªç¯ç­‰å¾… æœ€å¥½çš„æ‰‹æ®µ = SQL ä¼˜åŒ– + ç´¢å¼•è®¾è®¡ + äº‹åŠ¡æœ€å°åŒ– ","description":"è¦†ç›–ï¼šæ ¸å¿ƒæ¦‚å¿µã€é”ç±»å‹ã€åŠ é”æ–¹å¼ã€é”ç­‰å¾…ã€æ­»é”ã€è¯Šæ–­ã€ä¼˜åŒ–ã€å®æˆ˜æ¡ˆä¾‹ã€‚\nğŸ§± 1. é”çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆå¿…é¡»å…ˆç†è§£ï¼‰ MySQL ä¸»æµå­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼Œé”æœºåˆ¶å›´ç»•äº‹åŠ¡ã€è¡Œçº§é”ã€MVCC ç­‰å±•å¼€ã€‚ç†è§£é”çš„ç›®çš„ï¼š\nä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ ä¿è¯äº‹åŠ¡éš”ç¦» é˜²æ­¢å¹¶å‘å†²çª ä¿è¯æ•°æ®ä¸€è‡´æ€§ æé«˜å¹¶å‘æ€§èƒ½ï¼ˆè¡Œé”æ¯”è¡¨é”æ›´ granularï¼‰ MySQL ä¸­â€œé” + MVCC + äº‹åŠ¡éš”ç¦»çº§åˆ«â€ä¸‰è€…é…åˆ é”ï¼šé˜»å¡å†™ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹é˜»å¡è¯» MVCCï¼šè®©è¯»å°½é‡ä¸åŠ é” äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šæ§åˆ¶è¯»å†™å†²çªä½•æ—¶éœ€è¦é” æŒæ¡è¿™ä¸‰è€…çš„å…³ç³»ï¼Œæ˜¯ç†è§£ MySQL å¹¶å‘è¡Œä¸ºçš„åŸºç¡€ã€‚\n"},{"id":330,"href":"/operations/nacos/","title":"Nacos","parent":"Operations","content":"Document List:\nNacos FAQ Nacos åŸºç¡€æ•™ç¨‹ Nacos æ•…éšœæ’æŸ¥ Nacos é›†ç¾¤ ","description":"Document List:\nNacos FAQ Nacos åŸºç¡€æ•™ç¨‹ Nacos æ•…éšœæ’æŸ¥ Nacos é›†ç¾¤ "},{"id":331,"href":"/operations/nacos/troubleshooting/","title":"Nacos æ•…éšœæ’æŸ¥","parent":"Nacos","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨çš„ Nacos æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆæœ€å…¨ç‰ˆï¼‰ã€‚\nè¦†ç›–ï¼šæ³¨å†Œä¸­å¿ƒé—®é¢˜ã€é…ç½®ä¸­å¿ƒé—®é¢˜ã€é›†ç¾¤é—®é¢˜ã€MySQL é—®é¢˜ã€gRPC é€šä¿¡ã€ç«¯å£ã€å®¢æˆ·ç«¯é—®é¢˜ã€æ€§èƒ½ç“¶é¢ˆã€æ—¥å¿—å®šä½ã€‚\nè¿™æ˜¯ è¿ç»´ã€åç«¯ã€æ¶æ„å¸ˆéƒ½èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„å®æˆ˜æ‰‹å†Œã€‚\n0. æ•…éšœæ’æŸ¥æ€»æ€è·¯ï¼ˆé€ŸæŸ¥ï¼‰ Nacos æ•…éšœ -\u0026gt; 80% æŒ‰ä¸‹é¢ 5 æ­¥å°±èƒ½å®šä½ï¼š\nçœ‹ç«¯å£ï¼ˆ8848ã€9848ã€7848 æ˜¯å¦æ­£å¸¸ï¼‰ çœ‹ MySQLï¼ˆè¿æ¥ã€æ…¢ SQLã€è¿æ¥æ± ï¼Œæ˜¯å¦ downï¼‰ çœ‹èŠ‚ç‚¹çŠ¶æ€ /nacos/v1/ns/operator/servers çœ‹æ—¥å¿—ï¼ˆnamingã€configã€coreï¼Œå‡ ä¹å…¨éƒ¨èƒ½çœ‹åˆ°ï¼‰ çœ‹å®¢æˆ·ç«¯é”™è¯¯ï¼ˆgRPC è¿ä¸é€šã€å¿ƒè·³å¤±è´¥ã€æ²¡æœ‰æ¨é€ï¼‰ è¿™äº›å°±æ˜¯ 80% çš„æ ¹å› ã€‚\n1. æœåŠ¡æ³¨å†Œå¼‚å¸¸ï¼ˆNamingï¼‰æ’æŸ¥ âŒ 1.1 æœåŠ¡åå¤ä¸Šä¸‹çº¿ï¼ˆæœ€å¸¸è§ï¼‰ ğŸ” å¸¸è§åŸå› \nå¿ƒè·³å¤±è´¥ -\u0026gt; ä¸´æ—¶å®ä¾‹è¢«è‡ªåŠ¨ä¸‹çº¿ Pod å¥åº·æ£€æŸ¥å¤ªä¸¥æ ¼ ç½‘ç»œæŠ–åŠ¨ å®¢æˆ·ç«¯æ—¶é—´å’Œ Nacos å·®å¤ªå¤§ gRPCï¼ˆ9848ï¼‰ä¸é€š âœ… è§£å†³æ–¹æ¡ˆ â‘  æ”¾å®½å¿ƒè·³å‚æ•°ï¼ˆå®¢æˆ·ç«¯ï¼‰\nspring.cloud.nacos.discovery.heart-beat-interval=5000 spring.cloud.nacos.discovery.heart-beat-timeout=20000 spring.cloud.nacos.discovery.ip-delete-timeout=30000 â‘¡ Kubernetes å¥åº·æ£€æŸ¥è°ƒæ•´\nlivenessProbe: periodSeconds: 30 readinessProbe: periodSeconds: 30 â‘¢ æ£€æŸ¥å®¢æˆ·ç«¯ -\u0026gt; Nacos gRPC é€šé“\ntelnet nacos-ip 9848 âŒ 1.2 å®¢æˆ·ç«¯æ— æ³•æ³¨å†ŒæœåŠ¡ ğŸ” å¸¸è§åŸå› \nä½¿ç”¨ Nginx ä»£ç†å¯¼è‡´ gRPC æ–­å¼€ è·¨æœºæˆ¿å»¶è¿Ÿè¿‡é«˜ Nacos èŠ‚ç‚¹æ—¶é—´ä¸ä¸€è‡´ Nacos cluster èŠ‚ç‚¹ä¸å¯è¾¾ âœ… æ£€æŸ¥ gRPCï¼ˆå¿…é¡»è¦é€šï¼‰\ntelnet ${nacos-ip} 9848 âœ… æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€\nè®¿é—®ä»»æ„èŠ‚ç‚¹ï¼š\n/nacos/v1/ns/operator/servers å¦‚æœæœ‰èŠ‚ç‚¹ DOWN -\u0026gt; è¯´æ˜é›†ç¾¤é€šä¿¡ 7848 å¤±è´¥ã€‚\nâŒ 1.3 æœåŠ¡åˆ—è¡¨ä¸ä¸€è‡´ï¼ˆèŠ‚ç‚¹ A æœ‰ï¼ŒèŠ‚ç‚¹ B æ²¡æœ‰ï¼‰ è¿™æ˜¯ 3 èŠ‚ç‚¹é›†ç¾¤é‡Œæœ€â€œå‘â€çš„é—®é¢˜ã€‚\nğŸ” å¸¸è§åŸå› \nç®¡ç†å‘˜è®©å®¢æˆ·ç«¯è¿æ¥â€œå•èŠ‚ç‚¹â€è€Œä¸æ˜¯ LB Nacos æœ¬èº« gRPC é›†ç¾¤åŒæ­¥å»¶è¿Ÿï¼ˆ2.x ç»å¸¸å‡ºç°ï¼‰ MySQL æ…¢ SQL å¯¼è‡´æ•°æ®æ›´æ–°ä¸ä¸€è‡´ âœ… å¿…é¡»è®©å®¢æˆ·ç«¯è¿ LBï¼ˆé‡è¦ï¼‰\næ­£ç¡®ï¼š\nhttp://nacos-lb:8848 é”™è¯¯ï¼š\nhttp://nacos-node1:8848 âœ… æ£€æŸ¥ gRPC åŒæ­¥ï¼ˆNaming logï¼‰\nlogs/naming-server.log 2. é…ç½®ä¸­å¿ƒå¼‚å¸¸ï¼ˆConfigï¼‰æ’æŸ¥ âŒ 2.1 é…ç½®ä¿®æ”¹åå®¢æˆ·ç«¯æœªåˆ·æ–° ğŸ” åŸå› \nå®¢æˆ·ç«¯é€šè¿‡ LBï¼Œä½†æ¥è‡ªä¸åŒèŠ‚ç‚¹ å®¢æˆ·ç«¯é˜²ç«å¢™é˜»æ–­ 9848 é…ç½®æ ¼å¼é—®é¢˜ï¼ˆYAML ç¼©è¿›ï¼‰ Spring @RefreshScope æ²¡ç”Ÿæ•ˆ DataID ä¸ä¸€è‡´ âœ… æ’æŸ¥æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰\n1ï¼‰å®¢æˆ·ç«¯æ—¥å¿—æ£€æŸ¥ï¼š\nRefresh config error Listener receive error 2ï¼‰æµ‹è¯•é•¿è½®è¯¢ï¼ˆConfig 2.x ç”¨ gRPCï¼‰\ntelnet nacos-ip 9848 3ï¼‰æ£€æŸ¥ DataId æ˜¯å¦æ­£ç¡®\nweb æ§åˆ¶å°æŸ¥çœ‹å®é™… DataId / Groupã€‚\n4ï¼‰æ£€æŸ¥ @RefreshScope æ˜¯å¦åŠ åœ¨å¯¹åº”ç±»ä¸Šã€‚\nâŒ 2.2 é…ç½®æ¨é€å»¶è¿Ÿ åŸå› \né›†ç¾¤èŠ‚ç‚¹å¡ä½ï¼ˆCPU / GCï¼‰ MySQL å‹åŠ›å¤§ å®¢æˆ·ç«¯é•¿è½®è¯¢é˜»å¡ è§£å†³\nå¢åŠ  JVMï¼šXms4g - Xmx4g ä¼˜åŒ– MySQLï¼šè¿æ¥æ±  / redo log æ‰©å®¹ Nacos èŠ‚ç‚¹ 3. é›†ç¾¤æ•…éšœæ’æŸ¥ âŒ 3.1 æŸèŠ‚ç‚¹ DOWNï¼Œä½†è¿›ç¨‹æ­£å¸¸ åŸå› \n7848 é›†ç¾¤é€šä¿¡ç«¯å£ä¸é€š docker/k8s å®¹å™¨ NAT é—®é¢˜ é›†ç¾¤ IP é…é”™ï¼ˆcluster.confï¼‰ è§£å†³\ntelnet 192.168.X.X 7848 æ£€æŸ¥ cluster.confï¼š\n192.168.10.11:8848 å¿…é¡»ä½¿ç”¨å†…ç½‘ IPï¼Œä¸è¦å†™ 127.0.0.1ã€‚\nâŒ 3.2 é›†ç¾¤è„‘è£‚ï¼ˆä¸¤ä¸ªèŠ‚ç‚¹äº’è®¤ä¸º masterï¼‰ åŸå› \nä¸è¦éƒ¨ç½² 2 èŠ‚ç‚¹ MySQL å†™å…¥å¤±è´¥ ç½‘ç»œåˆ†åŒºï¼ˆæœºæˆ¿éš”ç¦»ï¼‰ è§£å†³\nå¿…é¡» 3 èŠ‚ç‚¹ä»¥ä¸Š èŠ‚ç‚¹é—´ä½¿ç”¨ä¸“çº¿æˆ–åŒå†…ç½‘ MySQL ç›‘æ§ IOPS âŒ 3.3 é›†ç¾¤å¯åŠ¨é¡ºåºé”™å¯¼è‡´åˆå§‹åŒ–å¤±è´¥ åŸå› \nç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ²¡è¿ä¸Š MySQL å¦ä¸€ä¸ªèŠ‚ç‚¹ä»ç©ºæ•°æ®åº“å¯åŠ¨ -\u0026gt; æ•°æ®é”™ä¹± è§£å†³\nç¡®ä¿ MySQL å…ˆå¯åŠ¨ é¦–æ¬¡å¯åŠ¨æŒ‰é¡ºåºï¼šNode1 -\u0026gt; Node2 -\u0026gt; Node3 4. MySQL æ•…éšœæ’æŸ¥ï¼ˆå…³é”®ï¼‰ Nacos 80% æ•…éšœéƒ½æ˜¯ MySQL è¿æ¥é—®é¢˜ã€‚\nâŒ 4.1 MySQL è¿æ¥å¤±è´¥ æŸ¥çœ‹ logs/nacos.logï¼š\njava.sql.SQLNonTransientConnectionException Communications link failure æ’æŸ¥\nmysql -h192.168.x.x -unacos -p âŒ 4.2 æ…¢ SQL å¯¼è‡´ Nacos å¡æ­» Nacos å¸¸è§æ…¢ SQLï¼š\nSELECT * FROM config_info WHERE data_id = ? AND group_id = ? æ’æŸ¥ï¼š\nSHOW PROCESSLIST; è§£å†³ï¼š\nç»™ config_info åŠ ç´¢å¼• MySQL è°ƒå¤§ innodb_buffer_pool_size âŒ 4.3 MySQL è¿æ¥æ± è€—å°½ æ—¥å¿—ï¼š\nHikariPool-1 - Connection is not available è§£å†³ï¼š\ndb.pool.config.connectionTimeout=3000 db.pool.config.maximumPoolSize=50 5. æ€§èƒ½ä¸èµ„æºé—®é¢˜ âŒ 5.1 JVM å†…å­˜ä¸è¶³å¯¼è‡´é¢‘ç¹ GC è¡¨ç°ï¼š\nFull GC (Allocation Failure) è§£å†³ï¼š\n-Xms4g -Xmx4g -XX:+UseG1GC\nâŒ 5.2 Nacos CPU é£™é«˜ åŸå› ï¼š\né…ç½®æ¨é€è¿‡å¤š å®¢æˆ·ç«¯å®ä¾‹æ•°é‡è¿‡å¤§ï¼ˆ\u0026gt;10kï¼‰ MySQL æ…¢ è§£å†³ï¼š\nåˆ†ç¯å¢ƒæ‹† namespace åˆ†æœåŠ¡ Group æ‰©å®¹èŠ‚ç‚¹ï¼ˆ\u0026gt;5ï¼‰ 6. å®¢æˆ·ç«¯æ•…éšœæ’æŸ¥ âŒ 6.1 å®¢æˆ·ç«¯å¯åŠ¨æ…¢ / æ³¨å†Œæ…¢ æ—¥å¿—ï¼š\ngrpc connect timeout åŸå› ï¼š\ngRPC ç«¯å£ 9848 æœªå¼€ å®¢æˆ·ç«¯è¿çš„æ˜¯å•èŠ‚ç‚¹ IP è§£å†³ï¼š\nspring.cloud.nacos.server-addr=http://nacos-lb:8848 âŒ 6.2 å®¢æˆ·ç«¯ä¸åˆ·æ–°é…ç½® æ’æŸ¥ï¼š\nListener receive error æ ¹å› ï¼š\ngRPC é€šé“æ–­å¼€ -\u0026gt; 9848 7. æ—¥å¿—å®šä½æŒ‡å—ï¼ˆæœ€é‡è¦ï¼‰ æ—¥å¿—æ–‡ä»¶ ç”¨é€” naming-server.log æœåŠ¡æ³¨å†Œã€å¿ƒè·³ã€å¥åº·æ£€æŸ¥ config-server.log é…ç½®æ¨é€ã€ç›‘å¬ã€diff core-auth.log é‰´æƒã€ç™»å½•å¤±è´¥ start.out å¯åŠ¨è¿‡ç¨‹é—®é¢˜ nacos.log ç»Ÿä¸€æ—¥å¿—ï¼ˆéƒ¨åˆ†å¼‚å¸¸ï¼‰ 8. æ•…éšœé€ŸæŸ¥è¡¨ï¼ˆæœ€å¸¸è§ TOP 10ï¼‰ é—®é¢˜ æ ¹å›  è§£å†³æ–¹æ³• æœåŠ¡ä¸Šä¸‹çº¿é¢‘ç¹ å¿ƒè·³ä¸¢å¤± / gRPC ä¸é€š è°ƒå¿ƒè·³ï¼Œå¼€ 9848 é…ç½®ä¸åˆ·æ–° YAML é”™ / gRPC é”™ ä¿® YAMLï¼›å¼€ 9848 èŠ‚ç‚¹ DOWN 7848 ä¸é€š æ‰“é€šèŠ‚ç‚¹é€šä¿¡ç«¯å£ æœåŠ¡åˆ—è¡¨ä¸ä¸€è‡´ å®¢æˆ·ç«¯è¿å•èŠ‚ç‚¹ ä¸€å¾‹èµ° LB é›†ç¾¤èŠ‚ç‚¹ä¸äº’é€š cluster.conf é…é”™ æ”¹æˆå†…ç½‘ IP MySQL è¿æ¥å¤±è´¥ ç”¨æˆ·å¯†ç /é˜²ç«å¢™ ä¿®æƒé™ MySQL æ…¢å¯¼è‡´å¡é¡¿ æ— ç´¢å¼• åŠ ç´¢å¼•ä¼˜åŒ– é«˜ CPU æ¨é€é‡å¤§/GC æ‰©å®¹/è°ƒ JVM è„‘è£‚ åŒèŠ‚ç‚¹/ç½‘ç»œéš”ç¦» 3 èŠ‚ç‚¹ä»¥ä¸Š gRPC è¶…æ—¶ é˜²ç«å¢™æ‹¦æˆª telnet 9848 ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨çš„ Nacos æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆæœ€å…¨ç‰ˆï¼‰ã€‚\nè¦†ç›–ï¼šæ³¨å†Œä¸­å¿ƒé—®é¢˜ã€é…ç½®ä¸­å¿ƒé—®é¢˜ã€é›†ç¾¤é—®é¢˜ã€MySQL é—®é¢˜ã€gRPC é€šä¿¡ã€ç«¯å£ã€å®¢æˆ·ç«¯é—®é¢˜ã€æ€§èƒ½ç“¶é¢ˆã€æ—¥å¿—å®šä½ã€‚\nè¿™æ˜¯ è¿ç»´ã€åç«¯ã€æ¶æ„å¸ˆéƒ½èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„å®æˆ˜æ‰‹å†Œã€‚\n0. æ•…éšœæ’æŸ¥æ€»æ€è·¯ï¼ˆé€ŸæŸ¥ï¼‰ Nacos æ•…éšœ -\u0026gt; 80% æŒ‰ä¸‹é¢ 5 æ­¥å°±èƒ½å®šä½ï¼š\nçœ‹ç«¯å£ï¼ˆ8848ã€9848ã€7848 æ˜¯å¦æ­£å¸¸ï¼‰ çœ‹ MySQLï¼ˆè¿æ¥ã€æ…¢ SQLã€è¿æ¥æ± ï¼Œæ˜¯å¦ downï¼‰ çœ‹èŠ‚ç‚¹çŠ¶æ€ /nacos/v1/ns/operator/servers çœ‹æ—¥å¿—ï¼ˆnamingã€configã€coreï¼Œå‡ ä¹å…¨éƒ¨èƒ½çœ‹åˆ°ï¼‰ çœ‹å®¢æˆ·ç«¯é”™è¯¯ï¼ˆgRPC è¿ä¸é€šã€å¿ƒè·³å¤±è´¥ã€æ²¡æœ‰æ¨é€ï¼‰ è¿™äº›å°±æ˜¯ 80% çš„æ ¹å› ã€‚\n1. æœåŠ¡æ³¨å†Œå¼‚å¸¸ï¼ˆNamingï¼‰æ’æŸ¥ âŒ 1.1 æœåŠ¡åå¤ä¸Šä¸‹çº¿ï¼ˆæœ€å¸¸è§ï¼‰ ğŸ” å¸¸è§åŸå› \n"},{"id":332,"href":"/operations/nacos/cluster/","title":"Nacos é›†ç¾¤","parent":"Nacos","content":"ä¸‹é¢æ˜¯ä¸€å¥— ç”Ÿäº§çº§ã€å¯ç›´æ¥è½åœ°çš„ Nacos é›†ç¾¤æ–¹æ¡ˆï¼Œä»æ¶æ„ -\u0026gt; å®‰è£… -\u0026gt; é…ç½® -\u0026gt; MySQL -\u0026gt; Nginx -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; æ€§èƒ½ä¼˜åŒ– -\u0026gt; æ•…éšœæ’æŸ¥ï¼Œä¸€ç«™å¼å®Œæ•´æ•´ç†ã€‚\n1. Nacos é›†ç¾¤æ¶æ„ ç”Ÿäº§ç¯å¢ƒæ¨è 3 èŠ‚ç‚¹æˆ– 5 èŠ‚ç‚¹ã€‚æ¶æ„å¦‚ä¸‹ï¼š\n+-----------------------+ | Client | +----------+------------+ | v +---------+----------+ | Nginx/LB | +----+----+----+-----+ | | | +----------+ | +-----------+ | | | v v v +--------------+ +--------------+ +--------------+ | Nacos Node1 | | Nacos Node2 | | Nacos Node3 | +-------+------+ +-------+------+ +-------+------+ | | | +----------------+-----------------+ | v +---------------+ | MySQL | +---------------+ 2. ç¯å¢ƒå‡†å¤‡ é¡¹ç›® æ¨è æ“ä½œç³»ç»Ÿ CentOS 7+ / Ubuntu 20+ JDK 17ï¼ˆæœ€ä½ 8ï¼‰ Nacos 2.2.x / 2.3.x MySQL 5.7 / 8.0ï¼ˆæ¨èï¼‰ èŠ‚ç‚¹æ•° 3 ä¸ª æœåŠ¡ç«¯å£ 8848 HTTP / 9848 RPC / 7848 èŠ‚ç‚¹é—´é€šä¿¡ 3. MySQL åˆå§‹åŒ–ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å…±äº«ï¼‰ 3.1 åˆ›å»ºæ•°æ®åº“ CREATE DATABASE nacos CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci; 3.2 å¯¼å…¥åˆå§‹åŒ–ç»“æ„ åœ¨ nacos è§£å‹ç›®å½•ä¸­ï¼š\nconf/nacos-mysql.sql æ‰§è¡Œï¼š\nmysql nacos \u0026lt; nacos-mysql.sql 4. ä¸‹è½½å¹¶è§£å‹ Nacos wget https://github.com/alibaba/nacos/releases/download/2.3.0/nacos-server-2.3.0.tar.gz tar -zxvf nacos-server-2.3.0.tar.gz cd nacos/bin 5. é…ç½® Nacos é›†ç¾¤ è¿›å…¥ conf ç›®å½•ï¼š\ncd nacos/conf 5.1 ä¿®æ”¹ application.properties ä¿®æ”¹æ•°æ®åº“è¿æ¥ï¼š\nspring.datasource.platform=mysql db.num=1 db.url.0=jdbc:mysql://192.168.10.20:3306/nacos?connectTimeout=1000\u0026amp;socketTimeout=3000\u0026amp;autoReconnect=true\u0026amp;characterEncoding=utf8\u0026amp;useSSL=false db.user=nacos db.password=123456 5.2 é…ç½® cluster.conf åˆ›å»ºï¼š\ncp cluster.conf.example cluster.conf å†…å®¹ï¼ˆä½¿ç”¨å®é™…æœåŠ¡å™¨ IPï¼‰ï¼š\n192.168.10.11:8848 192.168.10.12:8848 192.168.10.13:8848 å¿…é¡»ä½¿ç”¨ å†…ç½‘ IPï¼Œä¸è¦å†™ 127.0.0.1ã€‚\n6. å¯åŠ¨é›†ç¾¤ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š\ncd nacos/bin ./startup.sh -m cluster æŸ¥çœ‹æ—¥å¿—ï¼š\ntail -f logs/start.out æ£€æŸ¥çŠ¶æ€ï¼š\n[main] Nacos started successfully in cluster 7. é…ç½® Nginx è´Ÿè½½å‡è¡¡ï¼ˆæ¨èï¼‰ upstream nacos { server 192.168.10.11:8848; server 192.168.10.12:8848; server 192.168.10.13:8848; } server { listen 8848; location /nacos/ { proxy_pass http://nacos/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; } } è®¿é—®ï¼š\nhttp://nginx-ip:8848/nacos 8. Nacos é›†ç¾¤éªŒè¯ è®¿é—®ï¼š\nGET http://nginx-ip:8848/nacos/v1/ns/operator/servers ä½ åº”è¯¥èƒ½çœ‹åˆ° 3 ä¸ªèŠ‚ç‚¹ï¼š\n{ \u0026#34;servers\u0026#34;: [ {\u0026#34;ip\u0026#34;:\u0026#34;192.168.10.11\u0026#34;,\u0026#34;state\u0026#34;:\u0026#34;UP\u0026#34;}, {\u0026#34;ip\u0026#34;:\u0026#34;192.168.10.12\u0026#34;,\u0026#34;state\u0026#34;:\u0026#34;UP\u0026#34;}, {\u0026#34;ip\u0026#34;:\u0026#34;192.168.10.13\u0026#34;,\u0026#34;state\u0026#34;:\u0026#34;UP\u0026#34;} ] } 9. Nacos é›†ç¾¤å¥åº·æ£€æŸ¥ï¼ˆé‡è¦ï¼‰ Nacos æœ‰ä¸¤ä¸ªå…³é”®ç«¯å£ï¼š\nç«¯å£ å«ä¹‰ 8848 HTTP API \u0026amp; Console 9848 gRPC å®¢æˆ·ç«¯æ³¨å†Œé€šä¿¡ 7848 é›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é€šä¿¡ è¦ç¡®ä¿ï¼š\nä¸‰èŠ‚ç‚¹é—´ 7848ã€9848 èƒ½äº’é€šï¼ˆå…³é”®ï¼ï¼ï¼ï¼‰ å®¢æˆ·ç«¯èƒ½è®¿é—® 9848ï¼ˆå¦åˆ™æ³¨å†Œå¤±è´¥ï¼‰ 10. JVM \u0026amp; æ€§èƒ½ä¼˜åŒ–ï¼ˆç”Ÿäº§å»ºè®®ï¼‰ ç¼–è¾‘ï¼šbin/startup.sh æˆ–ç¯å¢ƒå˜é‡ï¼š\nexport JVM_XMS=4g export JVM_XMX=4g export JVM_XMN=1g export JVM_MS=128m export JVM_MMS=320m Linux å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š\nsysctl -w net.ipv4.tcp_keepalive_time=300 sysctl -w fs.file-max=655350 11. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ â‘  â€œèŠ‚ç‚¹ä¸åœ¨é›†ç¾¤ä¸­â€\nå¤šä¸ºç«¯å£ 7848 æœªæ‰“é€š\ntelnet 192.168.10.12 7848 â‘¡ é…ç½®ä¸­å¿ƒä¸åˆ·æ–°\nå®¢æˆ·ç«¯è¿çš„æ˜¯æŸä¸ªå•èŠ‚ç‚¹ -\u0026gt; å¿…é¡»è¿æ¥ LB æ¶ˆæ¯æ¨é€ port 9848 æœªå¼€æ”¾ â‘¢ æœåŠ¡æ³¨å†Œå¤±è´¥\nå¤šä¸º gRPC ç«¯å£æœªå¼€ï¼š\ntelnet nacos 9848 â‘£ é›†ç¾¤ä¸ç¨³å®š\nMySQL æ— è¿æ¥æ± è°ƒä¼˜ èŠ‚ç‚¹ JVM å¤ªå°ï¼ˆé»˜è®¤ä»… 512mï¼‰ åƒåœ¾å›æ”¶é˜»å¡ -\u0026gt; ä¿®æ”¹ GC ä¸º G1 12. Nacos é›†ç¾¤æœ€ä½³å®è·µï¼ˆæ€»ç»“ï¼‰ 1ï¼‰æœ€å°‘ 3 èŠ‚ç‚¹ï¼Œå¤šä¸ºå¥‡æ•° ä¿è¯é€‰ä¸¾ä¸ä¼šè„‘è£‚ã€‚\n2ï¼‰å¿…é¡»ä½¿ç”¨ MySQL å­˜å‚¨é…ç½® å•æœºæ¨¡å¼åªèƒ½å†…å­˜å­˜å‚¨ï¼Œä¸å¯ç”¨äºç”Ÿäº§ã€‚\n3ï¼‰å®¢æˆ·ç«¯å¿…é¡»æ¥å…¥è´Ÿè½½å‡è¡¡ ä¸è¦å†™å•èŠ‚ç‚¹åœ°å€ -\u0026gt; ä¼šå¯¼è‡´æ³¨å†Œä¸ä¸€è‡´ã€‚\n4ï¼‰ä¸è¦æ··ç”¨ä¸åŒç‰ˆæœ¬èŠ‚ç‚¹ ä¸€å®šè¦ç»Ÿä¸€ç‰ˆæœ¬ã€‚\n5ï¼‰å¼€å¯é‰´æƒ Auth ç”Ÿäº§ä¸èƒ½è£¸å¥”ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€å¥— ç”Ÿäº§çº§ã€å¯ç›´æ¥è½åœ°çš„ Nacos é›†ç¾¤æ–¹æ¡ˆï¼Œä»æ¶æ„ -\u0026gt; å®‰è£… -\u0026gt; é…ç½® -\u0026gt; MySQL -\u0026gt; Nginx -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; æ€§èƒ½ä¼˜åŒ– -\u0026gt; æ•…éšœæ’æŸ¥ï¼Œä¸€ç«™å¼å®Œæ•´æ•´ç†ã€‚\n1. Nacos é›†ç¾¤æ¶æ„ ç”Ÿäº§ç¯å¢ƒæ¨è 3 èŠ‚ç‚¹æˆ– 5 èŠ‚ç‚¹ã€‚æ¶æ„å¦‚ä¸‹ï¼š\n+-----------------------+ | Client | +----------+------------+ | v +---------+----------+ | Nginx/LB | +----+----+----+-----+ | | | +----------+ | +-----------+ | | | v v v +--------------+ +--------------+ +--------------+ | Nacos Node1 | | Nacos Node2 | | Nacos Node3 | +-------+------+ +-------+------+ +-------+------+ | | | +----------------+-----------------+ | v +---------------+ | MySQL | +---------------+ 2. ç¯å¢ƒå‡†å¤‡ é¡¹ç›® æ¨è æ“ä½œç³»ç»Ÿ CentOS 7+ / Ubuntu 20+ JDK 17ï¼ˆæœ€ä½ 8ï¼‰ Nacos 2.2.x / 2.3.x MySQL 5.7 / 8.0ï¼ˆæ¨èï¼‰ èŠ‚ç‚¹æ•° 3 ä¸ª æœåŠ¡ç«¯å£ 8848 HTTP / 9848 RPC / 7848 èŠ‚ç‚¹é—´é€šä¿¡ 3. MySQL åˆå§‹åŒ–ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å…±äº«ï¼‰ 3.1 åˆ›å»ºæ•°æ®åº“ CREATE DATABASE nacos CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci; 3.2 å¯¼å…¥åˆå§‹åŒ–ç»“æ„ åœ¨ nacos è§£å‹ç›®å½•ä¸­ï¼š\n"},{"id":333,"href":"/operations/NetworkManager/","title":"NetworkManager","parent":"Operations","content":"Document List:\nnmcli ","description":"Document List:\nnmcli "},{"id":334,"href":"/backend/python/official/next/","title":"Next å‡½æ•°","parent":"Official","content":" âœ… next() å‡½æ•°ç”¨æ³•è¯¦è§£ï¼ˆå«é»˜è®¤å€¼ï¼‰ 1ï¼‰ä½œç”¨ ä»è¿­ä»£å™¨ä¸­å–å‡º ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚\nnext() åªé€‚ç”¨äºâ€œè¿­ä»£å™¨â€ï¼ŒåŒ…æ‹¬ï¼š\niter(list/tuple/dict/set/str) ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ æ–‡ä»¶å¯¹è±¡ è‡ªå®šä¹‰è¿­ä»£å™¨ç±» 2ï¼‰åŸºæœ¬è¯­æ³• next(iterator) next(iterator, default) å¦‚æœæ²¡æœ‰ default å‚æ•°ï¼Œè¿­ä»£ç»“æŸä¼šæŠ›å‡º StopIteration å¦‚æœç»™äº† defaultï¼Œè¿­ä»£ç»“æŸä¼šè¿”å›è¯¥é»˜è®¤å€¼ 3ï¼‰æœ€å¸¸è§ç¤ºä¾‹ ï¼ˆ1ï¼‰ä»è¿­ä»£å™¨å–å€¼ it = iter([10, 20, 30]) print(next(it)) # 10 print(next(it)) # 20 print(next(it)) # 30 # next(it) # StopIteration ï¼ˆ2ï¼‰å¸¦é»˜è®¤å€¼ï¼Œä¸ä¼šæŠ¥é”™ it = iter([1, 2]) print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # 1 print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # 2 print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # ç»“æŸ ï¼ˆ3ï¼‰è¿­ä»£ç”Ÿæˆå™¨ def gen(): yield \u0026#34;A\u0026#34; yield \u0026#34;B\u0026#34; g = gen() print(next(g)) # A print(next(g)) # B ï¼ˆ4ï¼‰æ–‡ä»¶å¯¹è±¡ä¹Ÿæ˜¯è¿­ä»£å™¨ with open(\u0026#34;test.txt\u0026#34;) as f: print(next(f)) ï¼ˆ5ï¼‰é…åˆ iter(callable, sentinel) å®ç°â€œè¯»åˆ°ç»“æŸæ ‡å¿—åœæ­¢â€ï¼ˆè¶…ç»å…¸ï¼‰ è¯»å–æ–‡ä»¶ç›´åˆ°ä¸ºç©ºè¡Œï¼š\nfor line in iter(lambda: input().strip(), \u0026#34;\u0026#34;): print(\u0026#34;ä½ è¾“å…¥äº†ï¼š\u0026#34;, line) è¿™æ˜¯ Python å†…éƒ¨ä½¿ç”¨ next() é©±åŠ¨å¾ªç¯çš„ç»å…¸æ¨¡å¼ã€‚\nï¼ˆ6ï¼‰é…åˆ for \u0026hellip; else åˆ¤æ–­å¾ªç¯æ˜¯å¦æ­£å¸¸ç»“æŸ it = iter([1, 2, 3]) for x in it: print(x) else: print(\u0026#34;å¾ªç¯æ­£å¸¸ç»“æŸï¼Œæ—  break\u0026#34;) å®é™…ä¸Š for èƒŒåå°±æ˜¯ä¸åœ next(it)ã€‚\nï¼ˆ7ï¼‰ä»è¿­ä»£å™¨â€œå·çœ‹â€ä¸€ä¸ªå…ƒç´ å†æ”¾å›ï¼ˆå¸¸è§æŠ€å·§ï¼‰ it = iter([1, 2, 3]) first = next(it) print(first) # 1 # é‡æ–°ç»„åˆè¿­ä»£å™¨ it = iter([first] + list(it)) print(list(it)) # [1,2,3] next() çš„æ ¸å¿ƒè®°å¿†å£è¯€ next -\u0026gt; ä»è¿­ä»£å™¨å–ä¸‹ä¸€ä¸ªå€¼ï¼›é»˜è®¤å€¼ -\u0026gt; ä¸æŠ¥é”™ï¼›for å¾ªç¯åº•å±‚é å®ƒã€‚\nNext result = next((data for data in data_list if data['code'] == code), None) æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ\nä¸‹é¢æˆ‘æŠŠè¿™è¡Œä»£ç  é€å±‚æ‹†è§£ã€æ¸…æ™°è§£é‡Šï¼Œä½ é©¬ä¸Šå°±èƒ½å®Œå…¨çœ‹æ‡‚ã€‚\nâœ… ä½ ç»™çš„ä»£ç  result = next((data for data in data_list if data[\u0026#39;code\u0026#39;] == code), None) âœ… è¿™è¡Œä»£ç çš„ä½œç”¨ åœ¨ data_list åˆ—è¡¨é‡ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ª code åŒ¹é…çš„å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±è¿”å› Noneã€‚\nğŸ” é€å±‚è§£æ â‘  å†…å±‚ç”Ÿæˆå™¨è¡¨è¾¾å¼ (data for data in data_list if data[\u0026#39;code\u0026#39;] == code) è¿™ä¼šåˆ›å»ºä¸€ä¸ªâ€œæƒ°æ€§ç”Ÿæˆå™¨â€ï¼š\néå† data_list æ‰¾å‡ºæ»¡è¶³ data['code'] == code çš„é¡¹ç›® æ¯æ‰¾åˆ°ä¸€ä¸ªç«‹å³ yield ç±»ä¼¼äºï¼š\nfor data in data_list: if data[\u0026#34;code\u0026#34;] == code: yield data â‘¡ ä½¿ç”¨ next() å–ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ next(generator, None) next(generator) ä¼šä»ç”Ÿæˆå™¨é‡Œå– ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å…ƒç´ ã€‚\nå¦‚æœæ²¡æœ‰ä»»ä½•æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±ä¼šï¼š\nå› ä¸ºç»™äº†ç¬¬äºŒå‚æ•° None æ‰€ä»¥ ä¸ä¼šæŠ› StopIterationï¼Œè€Œæ˜¯è¿”å› None âœ… ç­‰ä»·çš„é•¿å†™æ³• ä½ å¯ä»¥å®Œå…¨ç†è§£æˆï¼š\nresult = None for data in data_list: if data[\u0026#39;code\u0026#39;] == code: result = data break ğŸ“Œ å®é™…ä½¿ç”¨åœºæ™¯ï¼ˆéå¸¸å¸¸è§ï¼‰ åœ¨ä¸€å †å­—å…¸ç»„æˆçš„åˆ—è¡¨é‡ŒæŸ¥æ‰¾æŸä¸ªå¯¹è±¡ï¼š\nuser = next((u for u in users if u[\u0026#39;id\u0026#39;] == uid), None) è¿™ç§å†™æ³•ï¼š\nç²¾ç®€ å¿«é€Ÿ ä¼˜é›… ä¸ä¼šæŠ¥é”™ï¼ˆå› ä¸ºå¸¦äº† default=Noneï¼‰ ğŸš€ æ€»ç»“ï¼ˆè®°ä½è¿™ä¸‰ç‚¹ï¼‰ è¿™æ˜¯ä¸€ä¸ªæŸ¥æ‰¾ â€œç¬¬ä¸€ä¸ªåŒ¹é…é¡¹â€ çš„å¿«æ·å†™æ³• ç”Ÿæˆå™¨è¡¨è¾¾å¼è´Ÿè´£è¿‡æ»¤ next(â€¦, None) è´Ÿè´£å®‰å…¨åœ°å–ä¸€ä¸ªç»“æœ ","description":" âœ… next() å‡½æ•°ç”¨æ³•è¯¦è§£ï¼ˆå«é»˜è®¤å€¼ï¼‰ 1ï¼‰ä½œç”¨ ä»è¿­ä»£å™¨ä¸­å–å‡º ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚\nnext() åªé€‚ç”¨äºâ€œè¿­ä»£å™¨â€ï¼ŒåŒ…æ‹¬ï¼š\niter(list/tuple/dict/set/str) ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰ æ–‡ä»¶å¯¹è±¡ è‡ªå®šä¹‰è¿­ä»£å™¨ç±» 2ï¼‰åŸºæœ¬è¯­æ³• next(iterator) next(iterator, default) å¦‚æœæ²¡æœ‰ default å‚æ•°ï¼Œè¿­ä»£ç»“æŸä¼šæŠ›å‡º StopIteration å¦‚æœç»™äº† defaultï¼Œè¿­ä»£ç»“æŸä¼šè¿”å›è¯¥é»˜è®¤å€¼ 3ï¼‰æœ€å¸¸è§ç¤ºä¾‹ ï¼ˆ1ï¼‰ä»è¿­ä»£å™¨å–å€¼ it = iter([10, 20, 30]) print(next(it)) # 10 print(next(it)) # 20 print(next(it)) # 30 # next(it) # StopIteration ï¼ˆ2ï¼‰å¸¦é»˜è®¤å€¼ï¼Œä¸ä¼šæŠ¥é”™ it = iter([1, 2]) print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # 1 print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # 2 print(next(it, \u0026#34;ç»“æŸ\u0026#34;)) # ç»“æŸ ï¼ˆ3ï¼‰è¿­ä»£ç”Ÿæˆå™¨ def gen(): yield \u0026#34;A\u0026#34; yield \u0026#34;B\u0026#34; g = gen() print(next(g)) # A print(next(g)) # B ï¼ˆ4ï¼‰æ–‡ä»¶å¯¹è±¡ä¹Ÿæ˜¯è¿­ä»£å™¨ with open(\u0026#34;test.txt\u0026#34;) as f: print(next(f)) ï¼ˆ5ï¼‰é…åˆ iter(callable, sentinel) å®ç°â€œè¯»åˆ°ç»“æŸæ ‡å¿—åœæ­¢â€ï¼ˆè¶…ç»å…¸ï¼‰ è¯»å–æ–‡ä»¶ç›´åˆ°ä¸ºç©ºè¡Œï¼š\n"},{"id":335,"href":"/operations/linux/nftables/","title":"nftables","parent":"Linux","content":" ä¸€ã€nftables æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ nftables æ˜¯ Linux å†…æ ¸ä¸­çš„ç»Ÿä¸€é˜²ç«å¢™ä¸æŠ¥æ–‡è¿‡æ»¤æ¡†æ¶ï¼Œç”¨æ¥å–ä»£ iptablesã€ip6tablesã€ebtablesã€arptablesã€‚\nå®ƒä¸æ˜¯ä¸€ä¸ªâ€œæ–° iptablesâ€ï¼Œè€Œæ˜¯ å…¨æ–°æ¶æ„ã€‚\näºŒã€ä¸ºä»€ä¹ˆè¦æœ‰ nftablesï¼ˆè¯ç”ŸèƒŒæ™¯ï¼‰ iptables çš„å†å²é—®é¢˜ IPv4 / IPv6 / äºŒå±‚è§„åˆ™å‰²è£‚ è¡¨ã€é“¾ã€è§„åˆ™é‡å¤ä¸¥é‡ è§„åˆ™å¤šæ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾ ç”¨æˆ·æ€å·¥å…·å¤æ‚ã€éš¾ç»´æŠ¤ å†…æ ¸æ¥å£ä¸ç»Ÿä¸€ nftables çš„ç›®æ ‡ ç›®æ ‡ è¯´æ˜ ç»Ÿä¸€ IPv4 / IPv6 / äºŒå±‚ç»Ÿä¸€å¤„ç† é«˜æ€§èƒ½ ä½¿ç”¨å­—èŠ‚ç ï¼ˆbytecodeï¼‰ ç®€æ´ è¯­æ³•æ›´æ¥è¿‘äººç±»é€»è¾‘ åŸå­æ€§ è§„åˆ™æ‰¹é‡æäº¤ å¯æ‰©å±• åŸç”Ÿæ”¯æŒ setã€map ä¸‰ã€æ•´ä½“æ¶æ„ï¼ˆéå¸¸é‡è¦ï¼‰ ç”¨æˆ·ç©ºé—´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ nft (å‘½ä»¤è¡Œå·¥å…·) â”‚ â”‚ nftables.conf â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ netlink â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å†…æ ¸ nftables å¼•æ“ â”‚ â”‚ - bytecode è™šæ‹Ÿæœº â”‚ â”‚ - hooks â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Netfilter æ¡†æ¶ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç½‘ç»œåè®®æ ˆï¼ˆIP/TCP/UDPï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å››ã€æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 1ï¸âƒ£ Tableï¼ˆè¡¨ï¼‰ è§„åˆ™çš„é¡¶çº§å®¹å™¨ æŒ‰ åè®®æ— åŒºåˆ† å¸¸è§åè®®æ—ï¼š\nfamily ä½œç”¨ ip IPv4 ip6 IPv6 inet IPv4 + IPv6ï¼ˆæ¨èï¼‰ bridge äºŒå±‚ netdev ç½‘å¡å…¥å£ 2ï¸âƒ£ Chainï¼ˆé“¾ï¼‰ è§„åˆ™çš„æ‰§è¡Œè·¯å¾„ ç»‘å®šåˆ° Netfilter hook å¸¸è§ hook hook ä½œç”¨ prerouting è·¯ç”±å‰ input æœ¬æœºæ¥æ”¶ forward è½¬å‘ output æœ¬æœºå‘å‡º postrouting è·¯ç”±å 3ï¸âƒ£ Ruleï¼ˆè§„åˆ™ï¼‰ åŒ¹é…æ¡ä»¶ + åŠ¨ä½œ é¡ºåºæ‰§è¡Œ ç¤ºä¾‹ï¼š\nip saddr 192.168.1.0/24 tcp dport 22 accept 4ï¸âƒ£ Setï¼ˆé›†åˆï¼Œæ€§èƒ½æ ¸å¿ƒï¼‰ set æ˜¯ nftables æ€§èƒ½ä¼˜äº iptables çš„å…³é”®\né«˜æ•ˆå­˜å‚¨å¤šä¸ªå€¼ O(1) æˆ– O(log n) æŸ¥æ‰¾ æ”¯æŒåŠ¨æ€æ›´æ–° ç¤ºä¾‹ï¼š\nset trusted_ips { type ipv4_addr elements = { 192.168.1.10, 192.168.1.20 } } 5ï¸âƒ£ Mapï¼ˆæ˜ å°„ï¼‰ Key -\u0026gt; Value å¸¸ç”¨äºç«¯å£è½¬å‘ã€ç­–ç•¥é€‰æ‹© äº”ã€å·¥ä½œæµç¨‹ï¼ˆæŠ¥æ–‡è·¯å¾„ï¼‰ ä»¥ æœ¬æœºæ¥æ”¶æµé‡ ä¸ºä¾‹ï¼š\nç½‘å¡ â†“ prerouting â†“ è·¯ç”±åˆ¤æ–­ â†“ input â†“ æœ¬åœ°è¿›ç¨‹ nftables åœ¨ å„ hook ç‚¹æ‰§è¡Œè§„åˆ™ã€‚\nå…­ã€nftables è¯­æ³•ç‰¹ç‚¹ å¯¹æ¯” iptables ç‰¹æ€§ iptables nftables å¤šåè®® åˆ†å·¥å…· ç»Ÿä¸€ æ‰¹é‡åŠ è½½ å¦ æ˜¯ set åŸç”Ÿ å¦ æ˜¯ åŸå­æ›´æ–° å¦ æ˜¯ å¯è¯»æ€§ å·® é«˜ ç¤ºä¾‹ï¼šåŸºç¡€é˜²ç«å¢™ table inet filter { chain input { type filter hook input priority 0; policy drop; ct state established,related accept iif lo accept tcp dport 22 accept tcp dport { 80, 443 } accept } } ä¸ƒã€ä¸ iptables çš„å…³ç³»ï¼ˆç°å®é—®é¢˜ï¼‰ nftables â‰  iptables-nft nftablesï¼šåŸç”Ÿæ–°ä½“ç³» iptables-nftï¼šiptables è¯­æ³• -\u0026gt; nftables åç«¯ ç°ä»£ç³»ç»Ÿï¼ˆRHEL 8+ã€Debian 10+ï¼‰ï¼š\né»˜è®¤ä½¿ç”¨ nftables å†…æ ¸ iptables å‘½ä»¤åªæ˜¯å…¼å®¹å±‚ å…«ã€æ€§èƒ½ä¼˜åŠ¿æ¥æºï¼ˆåŸç†ï¼‰ è§„åˆ™ç¼–è¯‘ä¸ºå­—èŠ‚ç  set / map æ•°æ®ç»“æ„ ä¸€æ¬¡æ€§åŠ è½½è§„åˆ™ å‡å°‘å†…æ ¸æ€è§„åˆ™éå† ä¹ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ æ¨èåšæ³• ä½¿ç”¨ inet family ç”¨ set ç®¡ç† IP / ç«¯å£ æ‰€æœ‰è§„åˆ™ä¸€æ¬¡æ€§åŠ è½½ ç¦ç”¨ iptables æ··ç”¨ ä½¿ç”¨é…ç½®æ–‡ä»¶è€Œéå‘½ä»¤å †å  é…ç½®æ–‡ä»¶ä½ç½® ä¸»é…ç½®ï¼š/etc/nftables.conf systemd æœåŠ¡ï¼šnftables.service åã€å¸¸è§è¯¯åŒº âŒ æŠŠ nftables å½“ iptables ç”¨ âŒ è§„åˆ™ä¸€æ¡æ¡è¿½åŠ  âŒ ä¸ä½¿ç”¨ set âŒ åŒæ—¶å¯ç”¨ firewalld + nftables åä¸€ã€nftables ä¸ firewalld firewalldï¼šç­–ç•¥ç®¡ç†å™¨ nftablesï¼šè§„åˆ™æ‰§è¡Œå¼•æ“ å…³ç³»ï¼š\nfirewalld -\u0026gt; nftables -\u0026gt; å†…æ ¸ åäºŒã€é€‚åˆè°ä½¿ç”¨ï¼Ÿ åœºæ™¯ æ¨è ç”Ÿäº§æœåŠ¡å™¨ å¼ºçƒˆæ¨è äº‘ä¸»æœº æ¨è å®¹å™¨å®¿ä¸»æœº å¿…é¡» é«˜å¹¶å‘ç½‘ç»œ å¿…é¡» å­¦ä¹ é˜²ç«å¢™åŸç† æ¨è åä¸‰ã€ä¸€å¥è¯ç»ˆææ€»ç»“ nftables æ˜¯ç°ä»£ Linux é˜²ç«å¢™çš„â€œç»Ÿä¸€å†…æ ¸è¯­è¨€â€ã€‚\n","description":" ä¸€ã€nftables æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ nftables æ˜¯ Linux å†…æ ¸ä¸­çš„ç»Ÿä¸€é˜²ç«å¢™ä¸æŠ¥æ–‡è¿‡æ»¤æ¡†æ¶ï¼Œç”¨æ¥å–ä»£ iptablesã€ip6tablesã€ebtablesã€arptablesã€‚\nå®ƒä¸æ˜¯ä¸€ä¸ªâ€œæ–° iptablesâ€ï¼Œè€Œæ˜¯ å…¨æ–°æ¶æ„ã€‚\näºŒã€ä¸ºä»€ä¹ˆè¦æœ‰ nftablesï¼ˆè¯ç”ŸèƒŒæ™¯ï¼‰ iptables çš„å†å²é—®é¢˜ IPv4 / IPv6 / äºŒå±‚è§„åˆ™å‰²è£‚ è¡¨ã€é“¾ã€è§„åˆ™é‡å¤ä¸¥é‡ è§„åˆ™å¤šæ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾ ç”¨æˆ·æ€å·¥å…·å¤æ‚ã€éš¾ç»´æŠ¤ å†…æ ¸æ¥å£ä¸ç»Ÿä¸€ nftables çš„ç›®æ ‡ ç›®æ ‡ è¯´æ˜ ç»Ÿä¸€ IPv4 / IPv6 / äºŒå±‚ç»Ÿä¸€å¤„ç† é«˜æ€§èƒ½ ä½¿ç”¨å­—èŠ‚ç ï¼ˆbytecodeï¼‰ ç®€æ´ è¯­æ³•æ›´æ¥è¿‘äººç±»é€»è¾‘ åŸå­æ€§ è§„åˆ™æ‰¹é‡æäº¤ å¯æ‰©å±• åŸç”Ÿæ”¯æŒ setã€map ä¸‰ã€æ•´ä½“æ¶æ„ï¼ˆéå¸¸é‡è¦ï¼‰ ç”¨æˆ·ç©ºé—´ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ nft (å‘½ä»¤è¡Œå·¥å…·) â”‚ â”‚ nftables.conf â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ netlink â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ å†…æ ¸ nftables å¼•æ“ â”‚ â”‚ - bytecode è™šæ‹Ÿæœº â”‚ â”‚ - hooks â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Netfilter æ¡†æ¶ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç½‘ç»œåè®®æ ˆï¼ˆIP/TCP/UDPï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å››ã€æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 1ï¸âƒ£ Tableï¼ˆè¡¨ï¼‰ è§„åˆ™çš„é¡¶çº§å®¹å™¨ æŒ‰ åè®®æ— åŒºåˆ† å¸¸è§åè®®æ—ï¼š\n"},{"id":336,"href":"/operations/nginx/","title":"Nginx","parent":"Operations","content":"Document List:\nNginx FAQ Nginx åŸºç¡€æ•™ç¨‹ Nginx æ ¸å¿ƒæ¦‚å¿µ Nginx åå‘ä»£ç†æœ€ä½³å®è·µ Nginx åå‘ä»£ç†è¯¦è§£ Nginx æ€§èƒ½è°ƒä¼˜æŒ‡å— Nginx æ•…éšœæ’æŸ¥ Nginx æœ€ä½³å®è·µ Nginx æ³¨æ„äº‹é¡¹ Nginx ç”Ÿäº§çº§ nginx.conf Nginx ç»å…¸é—®é¢˜ Nginx è´Ÿè½½å‡è¡¡æœ€ä½³å®è·µ Nginx è´Ÿè½½å‡è¡¡è¯¦è§£ Nginx é«˜å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆ ","description":"Document List:\nNginx FAQ Nginx åŸºç¡€æ•™ç¨‹ Nginx æ ¸å¿ƒæ¦‚å¿µ Nginx åå‘ä»£ç†æœ€ä½³å®è·µ Nginx åå‘ä»£ç†è¯¦è§£ Nginx æ€§èƒ½è°ƒä¼˜æŒ‡å— Nginx æ•…éšœæ’æŸ¥ Nginx æœ€ä½³å®è·µ Nginx æ³¨æ„äº‹é¡¹ Nginx ç”Ÿäº§çº§ nginx.conf Nginx ç»å…¸é—®é¢˜ Nginx è´Ÿè½½å‡è¡¡æœ€ä½³å®è·µ Nginx è´Ÿè½½å‡è¡¡è¯¦è§£ Nginx é«˜å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆ "},{"id":337,"href":"/operations/nginx/reverse-proxy-best-practices/","title":"Nginx åå‘ä»£ç†æœ€ä½³å®è·µ","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€èƒ½è½åœ°çš„ã€ŠNginx åå‘ä»£ç†æœ€ä½³å®è·µã€‹ï¼Œç»“æ„æ¸…æ™°ã€ç”Ÿäº§çº§å¯ç›´æ¥å¤ç”¨ã€‚\n1. ä½¿ç”¨æ ‡å‡†åå‘ä»£ç†é…ç½®ï¼ˆå®‰å…¨ã€ç¨³å®šï¼‰ location /api/ { proxy_pass http://backend_api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; } è¦ç‚¹\nproxy_http_version 1.1 + Connection \u0026quot;\u0026quot; é¿å…åç«¯ keepalive å¼‚å¸¸ çœŸå® IP é€ä¼  ä¸æ”¹ Hostï¼Œåç«¯å¯æ ¹æ®åŸŸååšè·¯ç”±æˆ–é‰´æƒ 2. é¿å… proxy_pass URL æ‹¼æ¥å‘ âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¤šä¸€å±‚è·¯å¾„ï¼‰\nlocation /api/ { proxy_pass http://backend/api/; } âœ… æ­£ç¡®ï¼ˆä¸¥æ ¼éµå®ˆç»“å°¾ / è§„åˆ™ï¼‰\nlocation æœ‰ /ï¼Œproxy_pass ä¹Ÿå¿…é¡»å¸¦ /ï¼š location /api/ { proxy_pass http://backend_api/; } location ç»“å°¾ proxy_pass ç»“å°¾ ç»“æœ /api/ / å»æ‰ /api/ è·¯å¾„ï¼ˆæ¨èï¼‰ /api æ—  / ä¸å»æ‰ /api ğŸ‘‰ æœ€ä½³å®è·µï¼šlocation å’Œ proxy_pass éƒ½å¸¦ /ï¼Œæœ€å®‰å…¨ã€‚\n3. åå‘ä»£ç†å¿…é¡»åŠ è¶…æ—¶ï¼ˆå¦åˆ™ç”Ÿäº§ä¼šæŒ‚ï¼‰ proxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; send_timeout 30s; ç†ç”±\nä¸åŠ è¶…æ—¶ä¼šé€ æˆå¤§é‡ CLOSE_WAITã€TIME_WAITã€è¿æ¥å †ç§¯ é¿å…åç«¯å¼‚å¸¸æ—¶ Nginx é˜»å¡ 4. æ‰“å¼€ä»£ç†ç¼“å­˜ï¼ˆå¤§å¹…æå‡æ€§èƒ½ï¼‰ é€‚ç”¨äº API + é™æ€èµ„æºä»£ç†ï¼š\nproxy_cache_path /data/nginx/cache levels=1:2 keys_zone=api_cache:100m inactive=1d max_size=1g; location /api/ { proxy_cache api_cache; proxy_cache_valid 200 1m; proxy_cache_valid 404 10s; } 5. ç”Ÿäº§å¿…åŠ ï¼šè´Ÿè½½å‡è¡¡ + å¥åº·æ£€æŸ¥ upstream backend_api { least_conn; server 10.0.0.1:8000 max_fails=3 fail_timeout=30s; server 10.0.0.2:8000 max_fails=3 fail_timeout=30s; } ```nginx æ¨èç­–ç•¥ - **least_conn**ï¼šé€‚ç”¨äºé•¿è¿æ¥åç«¯æœåŠ¡ - **ip_hash**ï¼šé€‚ç”¨äº session ç»‘å®š - **keepalive**ï¼šå‡å°‘åç«¯ TCP å»ºè¿æˆæœ¬ ```nginx upstream backend_api { least_conn; keepalive 100; server 10.0.0.1:8000; } 6. ä¸º WebSocket åšåå‘ä»£ç†ï¼ˆå¸¸è§éœ€æ±‚ï¼‰ location /ws/ { proxy_pass http://ws_backend; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#34;upgrade\u0026#34;; } 7. ä¸ºå¤§æ–‡ä»¶ / ä¸Šä¼ ä¸“é—¨ä¼˜åŒ– client_max_body_size 200m; proxy_request_buffering off; # ä¸åœ¨ç£ç›˜ç¼“å†²ï¼Œå‡å°‘ I/O 8. åå‘ä»£ç†é™æ€èµ„æºå¿…é¡»å…³é—­ gzip çš„æŸäº›å‚æ•° gzip_vary on; gzip_proxied any; gzip_types text/plain text/css application/json application/javascript; é¿å…ä»£ç†åå¯¼è‡´é”™ä¹±çš„ gzip ç±»å‹ã€‚\n9. é¿å… headers è¢«è¦†ç›–çš„æœ€ä½³å®è·µ å¾ˆå¤šäººå†™ï¼š\nproxy_set_header Host $host; ä½†ç”Ÿäº§æ¨èï¼š\nproxy_set_header Host $http_host; proxy_set_header X-Forwarded-Host $host; è¿™æ ·åç«¯æ›´å®¹æ˜“è°ƒè¯•å’Œè·å–å…¥å£ä¸Šæ¸¸çš„ä¿¡æ¯ã€‚\n10. åå‘ä»£ç† HTTPS æ—¶é¿å…å¾ªç¯å›æºé—®é¢˜ proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header X-Forwarded-Ssl on; å¦åˆ™åç«¯åˆ¤æ–­ä¸æ¸…æ˜¯ HTTP è¿˜æ˜¯ HTTPSã€‚\n11. ä¸ºæ¥å£åŠ â€œçœŸå®å®¢æˆ·ç«¯ IPâ€æœ€ä½³å®è·µ real_ip_header X-Forwarded-For; set_real_ip_from 0.0.0.0/0; å°†ä»£ç†é“¾çš„æœ€å·¦ç«¯ IP å½“ä½œçœŸå®å®¢æˆ·ç«¯ IPã€‚\nğŸ“Œ å®Œæ•´ç”Ÿäº§çº§åå‘ä»£ç†æ¨¡æ¿ï¼ˆå¯ç›´æ¥ç”¨ï¼‰ server { listen 80; server_name api.example.com; client_max_body_size 100m; location /api/ { proxy_pass http://backend_api/; # ä¿ç•™å®¢æˆ·ç«¯ä¿¡æ¯ proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; # æ€§èƒ½ä¼˜åŒ– proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_buffering on; # è¶…æ—¶ proxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; # ç¼“å­˜ proxy_cache api_cache; proxy_cache_valid 200 1m; proxy_cache_valid 404 10s; } } ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®ç”¨ã€æœ€èƒ½è½åœ°çš„ã€ŠNginx åå‘ä»£ç†æœ€ä½³å®è·µã€‹ï¼Œç»“æ„æ¸…æ™°ã€ç”Ÿäº§çº§å¯ç›´æ¥å¤ç”¨ã€‚\n1. ä½¿ç”¨æ ‡å‡†åå‘ä»£ç†é…ç½®ï¼ˆå®‰å…¨ã€ç¨³å®šï¼‰ location /api/ { proxy_pass http://backend_api; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; } è¦ç‚¹\nproxy_http_version 1.1 + Connection \u0026quot;\u0026quot; é¿å…åç«¯ keepalive å¼‚å¸¸ çœŸå® IP é€ä¼  ä¸æ”¹ Hostï¼Œåç«¯å¯æ ¹æ®åŸŸååšè·¯ç”±æˆ–é‰´æƒ 2. é¿å… proxy_pass URL æ‹¼æ¥å‘ âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¤šä¸€å±‚è·¯å¾„ï¼‰\n"},{"id":338,"href":"/operations/nginx/reverse-proxy-core/","title":"Nginx åå‘ä»£ç†è¯¦è§£","parent":"Nginx","content":"ä¸‹é¢æ˜¯ ä¸€ä»½æ·±å…¥ä½†éå¸¸æ˜“æ‡‚çš„ã€ŠNginx åå‘ä»£ç†è¯¦è§£ã€‹ï¼ŒåŒ…å«æ¦‚å¿µã€æœºåˆ¶ã€æ ¸å¿ƒæŒ‡ä»¤ã€ç”Ÿäº§çº§é…ç½®ã€è°ƒä¼˜æ€è·¯ã€æœ€ä½³å®è·µã€å¸¸è§å‘ç‚¹ï¼Œä¸€çœ‹å°±èƒ½ç›´æ¥åº”ç”¨åˆ°ä½ çš„é¡¹ç›®ï¼ˆFastAPI / Umi / React / PostgreSQL / Redis ç­‰ï¼‰ã€‚\n1. ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰ æ­£å‘ä»£ç†ï¼ˆå®¢æˆ·ç«¯ -\u0026gt; ä»£ç† -\u0026gt; æœåŠ¡å™¨ï¼‰ åå‘ä»£ç†ï¼ˆå®¢æˆ·ç«¯ -\u0026gt; Nginx -\u0026gt; åç«¯åº”ç”¨ï¼‰ åå‘ä»£ç†éšè—åç«¯æœåŠ¡ï¼Œç»Ÿä¸€å…¥å£ï¼Œä½¿ç³»ç»Ÿå…·æœ‰ï¼š\nç»Ÿä¸€å‡ºå£ï¼ˆç»Ÿä¸€åŸŸåï¼‰ è´Ÿè½½å‡è¡¡ ç¼“å­˜èƒ½åŠ› å®‰å…¨é˜²æŠ¤ SSL offloadï¼ˆè¯ä¹¦ç»ˆæ­¢ï¼‰ é™ä½è·¨åŸŸå¤æ‚æ€§ æå‡æ€§èƒ½ 2. Nginx å¦‚ä½•å·¥ä½œï¼ˆåå‘ä»£ç†è¯·æ±‚æµï¼‰ ä¸‹é¢æ˜¯æœ€æ ¸å¿ƒçš„å…³é”®ï¼š\n1 å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥ Nginx ä¾‹å¦‚ï¼š\nGET /api/user HTTP/1.1 Host: api.example.com 2 Nginx server block æ•è·è¯·æ±‚ åŒ¹é… server_nameã€listen å’Œ locationã€‚\n3 proxy_pass è½¬å‘åˆ° upstream Nginx è½¬å‘æ•´ä¸ªè¯·æ±‚ï¼ˆå« headerã€bodyï¼‰åˆ°åç«¯ï¼Œä¾‹å¦‚ FastAPI / Flask / Java / Nodeã€‚\n4 åç«¯å“åº”è¿”å›ç»™ Nginx Nginx å†æŠŠå“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n3. åå‘ä»£ç†çš„æ ¸å¿ƒæŒ‡ä»¤ï¼ˆå¿…é¡»ææ¸…ï¼‰ â­ 3.1 proxy_pass æœ€æ ¸å¿ƒçš„æŒ‡ä»¤ã€‚\nproxy_pass http://127.0.0.1:8000; trailing slash å¤§å‘ï¼ˆå¿…é¡»æŒæ¡ï¼‰\nlocation /api/ { proxy_pass http://backend/; # å»æ‰å‰ç¼€ /api/ } location /api/ { proxy_pass http://backend; # ä¿ç•™å‰ç¼€ /api/ } è¿™æ˜¯åå‘ä»£ç†æœ€å®¹æ˜“è¸©çš„å‘ã€‚\nâ­ 3.2 proxy_set_headerï¼ˆå¿…é¡»è®¾ç½®ï¼‰ proxy_set_header Host $host; proxy_set_header X-Real-IP $proxy_protocol_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; ä½œç”¨ï¼š\nHeader ç”¨é€” Host ä¿æŒåŸå§‹åŸŸåï¼ˆå¦‚ api.xxx.comï¼‰ X-Real-IP å®¢æˆ·ç«¯çœŸå® IP X-Forwarded-For å¤šçº§ä»£ç† IP é“¾æ¡ X-Forwarded-Proto HTTP/HTTPS â­ 3.3 proxy_http_version + Connection ç”Ÿäº§å¿…é¡»ï¼š\nproxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; æå‡ååé‡ 2ï½5 å€ï¼ˆä¿æŒé•¿è¿æ¥ï¼‰ã€‚\nâ­ 3.4 è¶…æ—¶ï¼ˆå¿…é¡»é…ç½®ï¼‰ proxy_connect_timeout 3s; proxy_read_timeout 30s; proxy_send_timeout 30s; connect è¦çŸ­ï¼ˆ3sï¼‰ read/send å¯é•¿ï¼ˆæ ¹æ®ä¸šåŠ¡ï¼‰ é¿å…èŠ‚ç‚¹å¡æ­»å¯¼è‡´å…¨ç«™å¯ç”¨æ€§ä¸‹é™ã€‚\nâ­ 3.5 proxy_next_upstreamï¼ˆå¤±è´¥é‡è¯•ï¼‰ proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; proxy_next_upstream_tries 3; å¤§å¹…æå‡å¯ç”¨æ€§ã€‚\n4. åå‘ä»£ç†å®Œæ•´æµç¨‹ Client -\u0026gt; Nginx -\u0026gt; Upstream backend -\u0026gt; Nginx -\u0026gt; Client\nNginx ä¼šï¼š\næ¥æ”¶è¯·æ±‚ è§£æè¯·æ±‚ åŒ¹é… location æ ¹æ® proxy_pass è½¬å‘åˆ°åç«¯ ç®¡ç†åç«¯è¿æ¥æ±  è¯»å–å“åº”ï¼ˆç¼“å†²ï¼‰ gzip å‹ç¼© å†™å›å®¢æˆ·ç«¯ åå‘ä»£ç†ä¸ä»…æ˜¯è½¬å‘ï¼Œæ›´æ˜¯è¯·æ±‚ç”Ÿå‘½å‘¨æœŸçš„ä»£ç†å™¨ã€‚\n5. Upstreamï¼ˆåç«¯æ± ï¼‰è¯¦è§£ upstream api_backend { least_conn; server 10.0.0.1:8000 max_fails=3 fail_timeout=30s; server 10.0.0.2:8000 max_fails=3 fail_timeout=30s; keepalive 50; } å…³é”®ç‚¹ï¼š\nleast_conn -\u0026gt; é˜²æ­¢æ…¢èŠ‚ç‚¹è¢«åˆ†é…æ›´å¤šæµé‡ max_fails / fail_timeout -\u0026gt; æ•…éšœå‰”é™¤ keepalive 50 -\u0026gt; è¿æ¥å¤ç”¨æé«˜æ€§èƒ½ æ”¯æŒ session stickyï¼ˆå•†ä¸šç‰ˆï¼‰ æ”¯æŒå››å±‚è´Ÿè½½ï¼ˆstreamï¼‰ 6. åå‘ä»£ç†å®Œæ•´ç¤ºä¾‹ï¼ˆç”Ÿäº§çº§ï¼‰ é€‚é…ä½ å½“å‰æŠ€æœ¯æ ˆï¼ˆFastAPI + React + Umiï¼‰\nserver { listen 443 ssl; http2 on; server_name api.example.com; # SSL ssl_certificate /etc/nginx/ssl/example.pem; ssl_certificate_key /etc/nginx/ssl/example.key; # proxy settings proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_connect_timeout 3s; proxy_read_timeout 30s; proxy_send_timeout 30s; access_log /data/nginx/logs/api.log; location /api/ { proxy_pass http://api_backend; } } 7. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µï¼ˆåå‘ä»£ç†ç‰ˆï¼‰ ä¸€å®šè¦å¼€ keepaliveï¼ˆåç«¯å‹åŠ›éª¤é™ï¼‰ connect_timeout å¿…é¡»çŸ­ï¼ˆ3sï¼‰ å…³é—­ Connection: closeï¼ˆæå‡ååï¼‰ upstream å¿…é¡» least_connï¼ˆé¿å…å¡é¡¿æ‰©æ•£ï¼‰ åˆç†é…ç½® proxy_buffer_sizeï¼ˆé˜²æ­¢å¤§ headerï¼‰ å…³é—­ client_max_body_size é™åˆ¶æˆ–æŒ‰éœ€è®¾ç½® API è¯·æ±‚é¿å… gzip=onï¼ˆå‰ç«¯æ–‡ä»¶æ‰éœ€è¦ï¼‰ 8. å®‰å…¨æœ€ä½³å®è·µ éšè—åç«¯ IP å¼ºåˆ¶ HTTPS é™åˆ¶ HTTP methodï¼ˆå¦‚åå°æ¥å£ï¼‰ é™é€Ÿï¼ˆrate limitingï¼‰ åš request_size é™åˆ¶ é”™è¯¯é¡µé¢ä¸æš´éœ²åç«¯ä¿¡æ¯ 9. å¸¸è§å‘ç‚¹ âŒ 1. æœ‰ / å’Œæ²¡ / çš„ proxy_pass\nå¯¼è‡´è·¯å¾„é”™ä¹±\nâŒ 2. å¿˜äº†è®¾ç½® Host header\nåç«¯æœåŠ¡ä¼šä»¥ä¸ºä½ æ˜¯ default host\nâŒ 3. æ²¡æ¸…ç©º Connection header\nå¤§é‡çŸ­è¿æ¥ -\u0026gt; æ€§èƒ½å´©æºƒ\nâŒ 4. upstream ä¸è®¾å¤±è´¥é‡è¯•\nä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰ -\u0026gt; å…¨ç«™ 504\nâŒ 5. client_body_buffer_size è¿‡å°\nPOST å¤§ body é”™è¯¯ 413\n","description":"ä¸‹é¢æ˜¯ ä¸€ä»½æ·±å…¥ä½†éå¸¸æ˜“æ‡‚çš„ã€ŠNginx åå‘ä»£ç†è¯¦è§£ã€‹ï¼ŒåŒ…å«æ¦‚å¿µã€æœºåˆ¶ã€æ ¸å¿ƒæŒ‡ä»¤ã€ç”Ÿäº§çº§é…ç½®ã€è°ƒä¼˜æ€è·¯ã€æœ€ä½³å®è·µã€å¸¸è§å‘ç‚¹ï¼Œä¸€çœ‹å°±èƒ½ç›´æ¥åº”ç”¨åˆ°ä½ çš„é¡¹ç›®ï¼ˆFastAPI / Umi / React / PostgreSQL / Redis ç­‰ï¼‰ã€‚\n1. ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰ æ­£å‘ä»£ç†ï¼ˆå®¢æˆ·ç«¯ -\u0026gt; ä»£ç† -\u0026gt; æœåŠ¡å™¨ï¼‰ åå‘ä»£ç†ï¼ˆå®¢æˆ·ç«¯ -\u0026gt; Nginx -\u0026gt; åç«¯åº”ç”¨ï¼‰ åå‘ä»£ç†éšè—åç«¯æœåŠ¡ï¼Œç»Ÿä¸€å…¥å£ï¼Œä½¿ç³»ç»Ÿå…·æœ‰ï¼š\nç»Ÿä¸€å‡ºå£ï¼ˆç»Ÿä¸€åŸŸåï¼‰ è´Ÿè½½å‡è¡¡ ç¼“å­˜èƒ½åŠ› å®‰å…¨é˜²æŠ¤ SSL offloadï¼ˆè¯ä¹¦ç»ˆæ­¢ï¼‰ é™ä½è·¨åŸŸå¤æ‚æ€§ æå‡æ€§èƒ½ 2. Nginx å¦‚ä½•å·¥ä½œï¼ˆåå‘ä»£ç†è¯·æ±‚æµï¼‰ ä¸‹é¢æ˜¯æœ€æ ¸å¿ƒçš„å…³é”®ï¼š\n"},{"id":339,"href":"/operations/nginx/performance/","title":"Nginx æ€§èƒ½è°ƒä¼˜æŒ‡å—","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£å¯è½åœ°çš„ã€ŠNginx æ€§èƒ½è°ƒä¼˜æŒ‡å—ï¼ˆCPU/å†…å­˜è‡ªé€‚åº”ç‰ˆï¼‰ã€‹ï¼Œå†…å®¹æ¶µç›– CPUã€è‡ªé€‚åº” workerã€å†…å­˜ã€è‡ªé€‚åº” bufferã€è¿æ¥æ•°ã€ç½‘ç»œæ ˆã€æ–‡ä»¶ç¼“å­˜ã€åå‘ä»£ç†ä¼˜åŒ–ã€SSL/HTTP2 ä¼˜åŒ–ã€‚\nå†…å®¹éå¸¸å®æˆ˜ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼ˆ2C2G ~ 64C256G éƒ½èƒ½ç”¨ï¼‰ã€‚\n1. æ ¸å¿ƒç†å¿µï¼ˆå¿…é¡»å…ˆç†è§£ï¼‰ Nginx çš„æ€§èƒ½ä¸»è¦ä¾èµ–å››ä¸ªéƒ¨åˆ†ï¼š\néƒ¨åˆ† å½±å“å› ç´  worker æ•°é‡ CPU æ ¸å¿ƒæ•° worker_connections æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ã€ç³»ç»Ÿ ulimit buffer å¤§å° å†…å­˜å¤§å° upstream keepalive æ•°é‡ å¹¶å‘è¯·æ±‚æ•° ç½‘ç»œä¼˜åŒ– TCP å‚æ•°ã€epollã€é˜Ÿåˆ— æ‰€ä»¥æ‰€æœ‰è°ƒä¼˜å¿…é¡»å›´ç»• CPU Ã— è¿æ¥æ•° Ã— å†…å­˜ã€‚\n2. CPU è‡ªé€‚åº”é…ç½® worker æ•°é‡ï¼ˆautoï¼‰\nworker_processes auto; è‡ªåŠ¨ç­‰äº CPU æ ¸å¿ƒæ•°ã€‚\næ¨èï¼šæ°¸è¿œç”¨ autoã€‚\n3. worker ä¼˜åŒ– worker_rlimit_nofile 200000; events { use epoll; worker_connections 65535; multi_accept on; accept_mutex off; } ä¸åŒ CPU å»ºè®®\nCPU worker_processes worker_connections Max å¹¶å‘ä¼°ç®— 1 æ ¸ auto(1) 20480 ~20K 2 æ ¸ auto(2) 32768 ~60K 4 æ ¸ auto(4) 65535 ~200K 8 æ ¸+ auto 65535 ~500K 4. å†…å­˜è‡ª Ğ°Ğ´Ğ°Ğ¿tive bufferï¼ˆé‡ç‚¹ï¼ï¼‰ Nginx buffer ä¸å®œè®¾ç½®è¿‡å¤§ï¼Œä¸ä»…æµªè´¹å†…å­˜ï¼Œè¿˜å¯èƒ½ æ”¾å¤§æ”»å‡»é¢ã€‚\nä½ çš„æœºå™¨ï¼š2C / 2G\nå»ºè®®ï¼š\nclient_body_buffer_size 512k; client_header_buffer_size 4k; large_client_header_buffers 4 16k; proxy_buffers 8 16k; proxy_busy_buffers_size 32k; proxy_buffer_size 16k; å†…å­˜åŠ¨æ€åˆ†çº§ï¼ˆè¡¨æ ¼ï¼‰\nå†…å­˜ client_body_buffer proxy_buffers large_client_header 1 - 2G 256kâ€“512k 8*16k 4 16k 4 - 8G 512kâ€“1M 8*32k 4 32k 16G+ 2Mâ€“4M 16*32k 8 64k 5. Proxyï¼ˆåå‘ä»£ç†ï¼‰ä¼˜åŒ– proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_connect_timeout 10s; proxy_send_timeout 60s; proxy_read_timeout 60s; proxy_buffering off; # ä¸ç¼“å­˜ï¼ˆæ›´å®æ—¶ï¼‰ å¦‚éœ€è¦ç¼“å­˜ï¼Œå¯å¼€å¯ï¼š\nproxy_buffering on; proxy_cache_path ... 6. Keepalive ä¼˜åŒ–ï¼ˆå·¨å¹…æå‡ upstream æ€§èƒ½ï¼‰ å¯¹äº upstreamï¼š\nupstream backend { server 127.0.0.1:8000; keepalive 64; } keepalive çš„å»ºè®®å€¼ï¼š\nCPU keepalive 1â€“2 æ ¸ 32â€“64 4â€“8 æ ¸ 128 16 æ ¸ä»¥ä¸Š 256 7. Gzip ä¼˜åŒ–ï¼ˆå¿…é¡»å¼€å¯ï¼‰ gzip on; gzip_types text/plain text/css application/json application/javascript; gzip_comp_level 5; gzip_min_length 1k; gzip_vary on; 8. SSL + HTTP/2 æ€§èƒ½ä¼˜åŒ– è®°ä½æ–°ç‰ˆå†™æ³•ï¼š\nlisten 443 ssl; http2 on; ä¼˜åŒ–ï¼š\nssl_protocols TLSv1.2 TLSv1.3; ssl_session_cache shared:SSL:50m; ssl_session_timeout 1d; ssl_prefer_server_ciphers on; ssl_ciphers HIGH:!aNULL:!MD5; ssl_session_tickets on; 9. Linux ç³»ç»Ÿå±‚ä¼˜åŒ–ï¼ˆéå¸¸å…³é”®ï¼‰ å†™å…¥ /etc/sysctl.confï¼š\n# æœ€å¤§æ–‡ä»¶æ•° fs.file-max = 1000000 # TCP ä¼˜åŒ– net.core.somaxconn = 65535 net.core.netdev_max_backlog = 65535 # TIME_WAIT net.ipv4.tcp_tw_reuse = 1 # Ephemeral ports net.ipv4.ip_local_port_range = 1024 65000 # TCP buffers net.ipv4.tcp_rmem = 4096 87380 16777216 net.ipv4.tcp_wmem = 4096 65536 16777216 åº”ç”¨ï¼š\nsysctl -p 10. è‡ªé€‚åº”è°ƒä¼˜ Shellï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰ ğŸ‘‰ è‡ªåŠ¨æ£€æµ‹ CPU å’Œå†…å­˜ï¼Œå¹¶ç”Ÿæˆ nginx.conf å‚æ•°ã€‚\n#!/bin/bash CPU=$(nproc) MEM_MB=$(grep MemTotal /proc/meminfo | awk \u0026#39;{print int($2/1024)}\u0026#39;) # buffer æŒ‰å†…å­˜åˆ†çº§ if [ $MEM_MB -lt 2000 ]; then BODY_BUFFER=\u0026#34;512k\u0026#34; PROXY_BUFFER=\u0026#34;16k\u0026#34; elif [ $MEM_MB -lt 8000 ]; then BODY_BUFFER=\u0026#34;1m\u0026#34; PROXY_BUFFER=\u0026#34;32k\u0026#34; else BODY_BUFFER=\u0026#34;2m\u0026#34; PROXY_BUFFER=\u0026#34;64k\u0026#34; fi cat \u0026lt;\u0026lt;EOF worker_processes $CPU; worker_rlimit_nofile 200000; events { worker_connections 65535; use epoll; multi_accept on; } http { client_body_buffer_size $BODY_BUFFER; client_header_buffer_size 4k; large_client_header_buffers 4 16k; proxy_buffer_size $PROXY_BUFFER; proxy_buffers 8 $PROXY_BUFFER; proxy_busy_buffers_size $(( ${PROXY_BUFFER%k} * 2 ))k; } EOF ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£å¯è½åœ°çš„ã€ŠNginx æ€§èƒ½è°ƒä¼˜æŒ‡å—ï¼ˆCPU/å†…å­˜è‡ªé€‚åº”ç‰ˆï¼‰ã€‹ï¼Œå†…å®¹æ¶µç›– CPUã€è‡ªé€‚åº” workerã€å†…å­˜ã€è‡ªé€‚åº” bufferã€è¿æ¥æ•°ã€ç½‘ç»œæ ˆã€æ–‡ä»¶ç¼“å­˜ã€åå‘ä»£ç†ä¼˜åŒ–ã€SSL/HTTP2 ä¼˜åŒ–ã€‚\nå†…å®¹éå¸¸å®æˆ˜ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼ˆ2C2G ~ 64C256G éƒ½èƒ½ç”¨ï¼‰ã€‚\n1. æ ¸å¿ƒç†å¿µï¼ˆå¿…é¡»å…ˆç†è§£ï¼‰ Nginx çš„æ€§èƒ½ä¸»è¦ä¾èµ–å››ä¸ªéƒ¨åˆ†ï¼š\néƒ¨åˆ† å½±å“å› ç´  worker æ•°é‡ CPU æ ¸å¿ƒæ•° worker_connections æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ã€ç³»ç»Ÿ ulimit buffer å¤§å° å†…å­˜å¤§å° upstream keepalive æ•°é‡ å¹¶å‘è¯·æ±‚æ•° ç½‘ç»œä¼˜åŒ– TCP å‚æ•°ã€epollã€é˜Ÿåˆ— æ‰€ä»¥æ‰€æœ‰è°ƒä¼˜å¿…é¡»å›´ç»• CPU Ã— è¿æ¥æ•° Ã— å†…å­˜ã€‚\n2. CPU è‡ªé€‚åº”é…ç½® worker æ•°é‡ï¼ˆautoï¼‰\n"},{"id":340,"href":"/operations/nginx/troubleshooting/","title":"Nginx æ•…éšœæ’æŸ¥","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ç”Ÿäº§çº§ã€ŠNginx æ•…éšœæ’æŸ¥æŒ‡å—ã€‹ï¼Œä»æ—¥å¿—ã€å‘½ä»¤ã€è¿›ç¨‹ã€upstreamã€åä»£ã€SSLã€å‰ç«¯é™æ€æ–‡ä»¶ã€æ€§èƒ½ã€è¿æ¥ã€è¶…æ—¶ç­‰å…¨é“¾è·¯æ’æŸ¥ã€‚ è¿™æ˜¯ä¼ä¸šçœŸæ­£ä½¿ç”¨çš„æ’æŸ¥æ–¹å¼ï¼Œä¸€æ­¥æ­¥æŒ‰è¿™ä¸ªæŸ¥ï¼Œå¿«é€Ÿå®šä½ 99% çš„ Nginx æ•…éšœã€‚\nğŸš¨ Nginx æ•…éšœæ’æŸ¥æ€»çº²ï¼ˆé»„é‡‘ 7 æ­¥ï¼‰ æ£€æŸ¥é…ç½®è¯­æ³•æ˜¯å¦æœ‰é”™ æ£€æŸ¥ Nginx æ˜¯å¦å¯åŠ¨ã€ç«¯å£æ˜¯å¦ç›‘å¬ æŸ¥çœ‹ error.logï¼ˆæœ€å…³é”®ï¼‰ æ£€æŸ¥ upstream æœåŠ¡æ˜¯å¦å¯è®¿é—® æ£€æŸ¥è®¿é—®è·¯å¾„æ˜¯å¦åŒ¹é…æ­£ç¡®çš„ location ç¡®å®šåå‘ä»£ç†æ˜¯å¦èµ°äº†æ­£ç¡®çš„ target \u0026amp; header æ£€æŸ¥ç³»ç»Ÿå±‚ç½‘ç»œ/é˜²ç«å¢™/SElinux æ— è®ºä½ çš„ Nginx æ˜¯åå‘ä»£ç†ã€é™æ€èµ„æºã€HTTPSã€HTTP/2ã€å‰ç«¯é¡¹ç›®ï¼Œéƒ½å¯ä»¥ä¾ç…§è¿™å¥—æµç¨‹æ’æŸ¥ã€‚\nğŸ§± 1. æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡® nginx -t é”™è¯¯ç¤ºä¾‹ï¼š\ninvalid number of arguments in â€¦ duplicate location â€¦ unexpected â€œ}â€ â€¦ invalid parameter â€¦ å¦‚æœ nginx -t æœ‰é”™è¯¯ï¼Œå…ˆè§£å†³å†çœ‹å…¶ä»–é—®é¢˜ã€‚\nä¹‹åé‡è½½ï¼š\nnginx -s reload ğŸ” 2. æ£€æŸ¥ Nginx æ˜¯å¦æ­£å¸¸è¿è¡Œ ps aux | grep nginx å¦‚æœæ²¡æœ‰ worker è¿›ç¨‹ï¼Œè¯´æ˜ Nginx æ ¹æœ¬æ²¡å¯åŠ¨ã€‚\næ£€æŸ¥ç›‘å¬ç«¯å£ï¼š\nss -lntp | grep nginx ä¾‹å¦‚ï¼š\n0 0 0.0.0.0:80 LISTEN nginx 0 0 0.0.0.0:443 LISTEN nginx å¦‚æœ nginx ä¸ç›‘å¬ç«¯å£ï¼Œè¯´æ˜é…ç½®é”™è¯¯æˆ–æœªæˆåŠŸ reloadã€‚\nğŸ“œ 3. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼ˆæœ€é‡è¦ï¼‰ é»˜è®¤è·¯å¾„ï¼š\n/var/log/nginx/error.log æˆ–ä½ è‡ªå®šä¹‰çš„ï¼š\n/data/nginx/logs/default/nginx/error.log å¸¸è§é”™è¯¯ï¼š\næ—¥å¿—ä¿¡æ¯ è¯´æ˜ connect() failed (111: Connection refused) upstream æœåŠ¡æ²¡å¼€æˆ–ç«¯å£ä¸å¯¹ upstream timed out åç«¯å¤ªæ…¢ã€ç½‘ç»œä¸é€š no live upstreams upstream å…¨æŒ‚äº† open() â€œ/xxxâ€ failed (2: No such fileâ€¦) root/alias è·¯å¾„æ‹¼é”™ SSL_do_handshake() failed è¯ä¹¦æˆ–åè®®é—®é¢˜ client intended to send too large body ä¸Šä¼ å¤§å°è¶…è¿‡ client_max_body_size directory index of â€œ/xxxâ€ is forbidden ç¼ºå°‘ index æˆ–æƒé™ä¸è¶³ å¤§éƒ¨åˆ† BUG çœ‹ error.log å°±èƒ½ 30 ç§’å®šä½ã€‚\nğŸŒ 4. æ£€æŸ¥ upstream / åå‘ä»£ç†é—®é¢˜ upstream æ˜¯å¦çœŸçš„èƒ½è®¿é—®ï¼Ÿ\nåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥å‘½ä»¤ï¼š\ncurl -I http://127.0.0.1:8000/ curl -I http://backend-server-ip:8000/ å¦‚æœ curl éƒ½è®¿é—®ä¸äº†ï¼ŒNginx è‚¯å®šè®¿é—®ä¸äº†ã€‚\nå¦‚æœåä»£ HTTPS æœåŠ¡ï¼Œå¿…é¡»åŠ ï¼š\nproxy_ssl_server_name on; å¦åˆ™è®¿é—®å¾®ä¿¡ API / Google / Cloud æœåŠ¡ä¼šæŠ¥é”™ã€‚\nå¦‚æœ upstream æ˜¯å†…ç½‘ Dockerï¼Œè¦æ£€æŸ¥ï¼š\ndocker inspect your-container å¯¹åº” IP / Port æ˜¯å¦å¯¹å¾—ä¸Šã€‚\nğŸ§­ 5. location åŒ¹é…æ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆæœ€å®¹æ˜“å†™é”™ï¼‰ ä¾‹å¦‚ä½ æƒ³åŒ¹é… /admin/ï¼š\nâŒ é”™è¯¯çš„ï¼š\nlocation /admin { âœ… æ­£ç¡®çš„ï¼š\nlocation /admin/ { React/Vue/Umi SPA å…¥å£ï¼š\ntry_files $uri $uri/ /admin/index.html; alias å¿…é¡»åŠ  â€œ/â€ ç»“å°¾ï¼š\nâŒ é”™è¯¯ï¼š\nalias /data/www/admin; âœ… æ­£ç¡®ï¼š\nalias /data/www/admin/; ğŸ§¾ 6. æ£€æŸ¥åä»£è¯·æ±‚å¤´æ˜¯å¦æ­£ç¡®ä¼ é€’ æœ€å®¹æ˜“å‡ºé—®é¢˜çš„æ˜¯ Hostï¼š\nå¿…é¡»ç”¨ï¼š\nproxy_set_header Host $http_host; å¦åˆ™åç«¯å¯èƒ½åˆ¤æ–­é”™åŸŸåæˆ– 301 é‡å®šå‘å¾ªç¯ã€‚\nå…¶ä»–å¿…å¤‡ headerï¼š\nproxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; æ’æŸ¥æ—¶å¯ä»¥æŠŠè¯·æ±‚å¤´æ‰“å°å‡ºæ¥ï¼š\ncurl -I http://your-server -H \u0026#34;Debug: 1\u0026#34; å¹¶åœ¨åç«¯è®°å½• headerã€‚\nğŸ” 7. SSL / HTTPS æ•…éšœæ’æŸ¥ æŸ¥çœ‹è¯ä¹¦æ˜¯å¦é…ç½®æ­£ç¡®\nssl_certificate /etc/nginx/ssl/example.crt; ssl_certificate_key /etc/nginx/ssl/example.key; å¸¸è§é”™è¯¯ï¼š\né”™è¯¯ è¯´æ˜ SSL: error:0B080074:x509â€¦ key ä¸ cert ä¸åŒ¹é… PEM lib æ ¼å¼é”™è¯¯ no certificate found è·¯å¾„é”™ æ£€æŸ¥è¯ä¹¦æƒé™\nchmod 600 *.key æ£€æŸ¥ HTTP/2 æ˜¯å¦æ­£ç¡®å¯ç”¨\næ–°å†™æ³•ï¼š\nlisten 443 ssl; http2 on; ğŸš€ 8. æ€§èƒ½ / é«˜å¹¶å‘æ•…éšœæ’æŸ¥ worker_connections ä¸å¤Ÿä¼šæŠ¥ï¼š\ncould not create new connection æŸ¥çœ‹å½“å‰è¿æ¥æ•°ï¼š\nnetstat -anp | grep :80 | wc -l æ–‡ä»¶æè¿°ç¬¦ä¸è¶³\næŸ¥çœ‹ï¼š\nulimit -n ä¸è¶³åˆ™ï¼š\nulimit -n 200000 å¹¶ä¿®æ”¹ï¼š\n/etc/security/limits.conf æ£€æŸ¥ CPU/å†…å­˜ æ˜¯å¦è¢«æ‰“æ»¡\ntop -c ğŸ”¥ 9. é™æ€æ–‡ä»¶ 404ã€è·¯å¾„é”™è¯¯æ’æŸ¥ é”™è¯¯æ—¥å¿—ï¼š\nopen() \u0026#34;/etc/nginx/html/index.html\u0026#34; failed (2: No such file or directory) è¯´æ˜ root é…ç½®ä¸å¯¹ï¼ŒNginx æ‹¼å‡ºæ¥çš„è·¯å¾„ä¸å­˜åœ¨ã€‚\næ‰“å°æœ€ç»ˆè·¯å¾„ï¼š\nlocation / { echo $document_root; echo $request_filename; } ï¼ˆéœ€ ngx_echo æ¨¡å—ï¼‰\nğŸŒ 10. è·¨åŸŸ CORS é”™è¯¯æ’æŸ¥ å‰ç«¯æŠ¥ï¼š\nCORS header \u0026#39;Access-Control-Allow-Origin\u0026#39; missing æ£€æŸ¥ï¼š\nadd_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers *; add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS; å¹¶ä¸” OPTIONS å¿…é¡»è¿”å› 204ï¼š\nlocation /api/ { if ($request_method = OPTIONS) { return 204; } } ğŸ§± 11. ç³»ç»Ÿå±‚ç½‘ç»œ/é˜²ç«å¢™æ’æŸ¥ æ˜¯å¦è¢«é˜²ç«å¢™ã€iptables æ‹¦ä½ï¼Ÿ\niptables -L -n SELinux å¯èƒ½å¯¼è‡´ Nginx æ— æ³•è®¿é—®ç›®å½•\næŸ¥çœ‹ï¼š\ngetenforce å¦‚æœæ˜¯ Enforcingï¼š\nsetenforce 0 âš¡ 12. å¿«é€Ÿæ’æŸ¥å‘½ä»¤åˆé›†ï¼ˆæ ¸å¿ƒï¼‰ nginx -t # æ£€æŸ¥é…ç½® systemctl status nginx # çŠ¶æ€ ps aux | grep nginx # æŸ¥çœ‹è¿›ç¨‹ ss -lntp | grep nginx # æŸ¥çœ‹ç›‘å¬ç«¯å£ tail -f /var/log/nginx/error.log # æŸ¥çœ‹é”™è¯¯æ—¥å¿— curl -I http://127.0.0.1 # æœ¬åœ°è¿é€šæ€§ curl -I http://backend-ip:port # upstream è¿é€šæ€§ netstat -anp | grep :80 # æŸ¥çœ‹è¿æ¥æ•° ulimit -n # æŸ¥çœ‹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ç”Ÿäº§çº§ã€ŠNginx æ•…éšœæ’æŸ¥æŒ‡å—ã€‹ï¼Œä»æ—¥å¿—ã€å‘½ä»¤ã€è¿›ç¨‹ã€upstreamã€åä»£ã€SSLã€å‰ç«¯é™æ€æ–‡ä»¶ã€æ€§èƒ½ã€è¿æ¥ã€è¶…æ—¶ç­‰å…¨é“¾è·¯æ’æŸ¥ã€‚ è¿™æ˜¯ä¼ä¸šçœŸæ­£ä½¿ç”¨çš„æ’æŸ¥æ–¹å¼ï¼Œä¸€æ­¥æ­¥æŒ‰è¿™ä¸ªæŸ¥ï¼Œå¿«é€Ÿå®šä½ 99% çš„ Nginx æ•…éšœã€‚\nğŸš¨ Nginx æ•…éšœæ’æŸ¥æ€»çº²ï¼ˆé»„é‡‘ 7 æ­¥ï¼‰ æ£€æŸ¥é…ç½®è¯­æ³•æ˜¯å¦æœ‰é”™ æ£€æŸ¥ Nginx æ˜¯å¦å¯åŠ¨ã€ç«¯å£æ˜¯å¦ç›‘å¬ æŸ¥çœ‹ error.logï¼ˆæœ€å…³é”®ï¼‰ æ£€æŸ¥ upstream æœåŠ¡æ˜¯å¦å¯è®¿é—® æ£€æŸ¥è®¿é—®è·¯å¾„æ˜¯å¦åŒ¹é…æ­£ç¡®çš„ location ç¡®å®šåå‘ä»£ç†æ˜¯å¦èµ°äº†æ­£ç¡®çš„ target \u0026amp; header æ£€æŸ¥ç³»ç»Ÿå±‚ç½‘ç»œ/é˜²ç«å¢™/SElinux æ— è®ºä½ çš„ Nginx æ˜¯åå‘ä»£ç†ã€é™æ€èµ„æºã€HTTPSã€HTTP/2ã€å‰ç«¯é¡¹ç›®ï¼Œéƒ½å¯ä»¥ä¾ç…§è¿™å¥—æµç¨‹æ’æŸ¥ã€‚\nğŸ§± 1. æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡® nginx -t é”™è¯¯ç¤ºä¾‹ï¼š\n"},{"id":341,"href":"/operations/nginx/best-practices/","title":"Nginx æœ€ä½³å®è·µ","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£èƒ½è½åœ°ã€è¦†ç›–æ¶æ„/é…ç½®/éƒ¨ç½²/ç›‘æ§/å®‰å…¨çš„ Nginx æœ€ä½³å®è·µå¤§å…¨ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆåå‘ä»£ç† / é™æ€ç«™ç‚¹ / API ç½‘å…³åœºæ™¯ï¼‰ã€‚\n1. ç›®å½•ç»“æ„æœ€ä½³å®è·µ /etc/nginx/ â”œâ”€â”€ nginx.conf # ä¸»é…ç½® â”œâ”€â”€ conf.d/ # å„æœåŠ¡ç‹¬ç«‹é…ç½® â”‚ â”œâ”€â”€ api.conf â”‚ â”œâ”€â”€ web.conf â”‚ â””â”€â”€ ssl.conf â”œâ”€â”€ mime.types â”œâ”€â”€ modules-enabled/ # åŠ¨æ€æ¨¡å— â””â”€â”€ snippets/ # å…¬ç”¨ç‰‡æ®µï¼ˆä¾‹å¦‚ SSLã€proxyï¼‰ ä¸æ¨èæŠŠæ‰€æœ‰é…ç½®å †åœ¨ nginx.conf æ¨èæŒ‰åº”ç”¨æ‹†åˆ†ï¼Œä¿è¯å¯ç»´æŠ¤æ€§ã€‚ 2. æ ¸å¿ƒé…ç½®æœ€ä½³å®è·µï¼ˆnginx.confï¼‰ worker é…ç½®ï¼ˆè‡ªé€‚åº” CPUï¼‰\nworker_processes auto; worker_cpu_affinity auto; worker_rlimit_nofile 200000; äº‹ä»¶è°ƒä¼˜\nevents { use epoll; worker_connections 65535; multi_accept on; } HTTP å…¨å±€ä¼˜åŒ–\nhttp { sendfile on; sendfile_max_chunk 512k; tcp_nopush on; tcp_nodelay on; keepalive_timeout 15; keepalive_requests 10000; client_max_body_size 50m; gzip on; gzip_types text/plain text/css application/json application/javascript; include mime.types; default_type application/octet-stream; include /etc/nginx/conf.d/*.conf; } 3. HTTP/2 + SSL æœ€ä½³å®è·µ æ¨èå†™æ³•ï¼ˆä½ å·²ç»çº æ­£è¿‡çš„ï¼šhttp2 on; åˆ†è¡Œå†™ï¼‰\nserver { listen 443 ssl; http2 on; ssl_certificate /etc/nginx/ssl/fullchain.pem; ssl_certificate_key /etc/nginx/ssl/privkey.pem; å¼ºåŠ å¯†å¥—ä»¶å»ºè®®\nssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on; ssl_ciphers \u0026#39;TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:...\u0026#39;; ssl_session_cache shared:SSL:50m; ssl_session_timeout 1d; ssl_session_tickets off; 4. åå‘ä»£ç†æœ€ä½³å®è·µ é€šç”¨ proxy é…ç½®ï¼ˆå»ºè®®æ”¾ snippetsï¼‰\nproxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_connect_timeout 5s; proxy_send_timeout 30s; proxy_read_timeout 30s; proxy_buffering on; proxy_buffers 32 32k; proxy_busy_buffers_size 64k; 5. é™æ€ Web åº”ç”¨ï¼ˆVue/Umi/Reactï¼‰æœ€ä½³å®è·µ æ”¯æŒ SPA history æ¨¡å¼\nlocation / { try_files $uri $uri/ /index.html; } é™æ€æ–‡ä»¶ç¼“å­˜\nlocation ~* \\.(css|js|png|jpg|jpeg|gif|svg|ico)$ { expires 30d; access_log off; } 6. å®‰å…¨æœ€ä½³å®è·µ é˜²æ­¢ç‚¹å‡»åŠ«æŒ\nadd_header X-Frame-Options SAMEORIGIN; é˜²æ­¢ XSS\nadd_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34;; å¼ºåˆ¶ HSTSï¼ˆä»…åœ¨ HTTPS å®Œå…¨ç¨³å®šåå¼€å¯ï¼‰\nadd_header Strict-Transport-Security \u0026#34;max-age=63072000\u0026#34; always; éšè— Nginx ç‰ˆæœ¬\nserver_tokens off; 7. æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µï¼ˆé«˜å¹¶å‘ï¼‰ é¡¹ç›® æ¨èå€¼ è¯´æ˜ worker_processes auto è‡ªé€‚åº” CPU worker_connections 65535 é«˜è¿æ¥è´Ÿè½½ worker_rlimit_nofile 200000 æ–‡ä»¶å¥æŸ„ sendfile on é›¶æ‹·è´ gzip on æµé‡ä¼˜åŒ– keepalive_timeout 15s å¯æŒç»­è¿æ¥ proxy_buffering on é™ä½åç«¯å‹åŠ› 8. æ—¥å¿—è§„èŒƒ log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#39; \u0026#39;\u0026#34;$request\u0026#34; $status $body_bytes_sent \u0026#39; \u0026#39;\u0026#34;$http_referer\u0026#34; \u0026#34;$http_user_agent\u0026#34; \u0026#39; \u0026#39;$request_time $upstream_response_time\u0026#39;; access_log /var/log/nginx/access.log main; error_log /var/log/nginx/error.log warn; å»ºè®®é…åˆ ELK / Loki æ”¶é›†ã€‚\n9. éƒ¨ç½² \u0026amp; çƒ­æ›´æ–° æ£€æŸ¥é…ç½®\nnginx -t å¹³æ»‘é‡è½½ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰\nnginx -s reload 10. å¸¸è§é£é™©ç‚¹ï¼ˆä¸Šçº¿å¿…æŸ¥ï¼‰ HTTPS è¯ä¹¦æ˜¯å¦ç»­æœŸ gzip æ˜¯å¦å‹ç¼© js/css history æ¨¡å¼æ˜¯å¦é…ç½® try_files error_page æ˜¯å¦æ­£å¸¸ proxy è¶…æ—¶æ˜¯å¦ç¬¦åˆæœåŠ¡ SLA æ˜¯å¦å¿˜è®°è®¾ç½® client_max_body_size 11. ç‰ˆæœ¬å‡çº§æœ€ä½³å®è·µ Nginx ä¸»çº¿ç‰ˆæœ¬æ¯å¤©éƒ½ä¼˜åŒ– HTTP/2 \u0026amp; QUIC\nå»ºè®®ä½¿ç”¨ï¼š\nç¨³å®šç‰ˆï¼š1.24.x ä¸»çº¿ç‰ˆï¼š1.27.xï¼ˆæ”¯æŒ HTTP/3ï¼‰ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£èƒ½è½åœ°ã€è¦†ç›–æ¶æ„/é…ç½®/éƒ¨ç½²/ç›‘æ§/å®‰å…¨çš„ Nginx æœ€ä½³å®è·µå¤§å…¨ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆåå‘ä»£ç† / é™æ€ç«™ç‚¹ / API ç½‘å…³åœºæ™¯ï¼‰ã€‚\n1. ç›®å½•ç»“æ„æœ€ä½³å®è·µ /etc/nginx/ â”œâ”€â”€ nginx.conf # ä¸»é…ç½® â”œâ”€â”€ conf.d/ # å„æœåŠ¡ç‹¬ç«‹é…ç½® â”‚ â”œâ”€â”€ api.conf â”‚ â”œâ”€â”€ web.conf â”‚ â””â”€â”€ ssl.conf â”œâ”€â”€ mime.types â”œâ”€â”€ modules-enabled/ # åŠ¨æ€æ¨¡å— â””â”€â”€ snippets/ # å…¬ç”¨ç‰‡æ®µï¼ˆä¾‹å¦‚ SSLã€proxyï¼‰ ä¸æ¨èæŠŠæ‰€æœ‰é…ç½®å †åœ¨ nginx.conf æ¨èæŒ‰åº”ç”¨æ‹†åˆ†ï¼Œä¿è¯å¯ç»´æŠ¤æ€§ã€‚ 2. æ ¸å¿ƒé…ç½®æœ€ä½³å®è·µï¼ˆnginx.confï¼‰ worker é…ç½®ï¼ˆè‡ªé€‚åº” CPUï¼‰\n"},{"id":342,"href":"/operations/nginx/things-to-note/","title":"Nginx æ³¨æ„äº‹é¡¹","parent":"Nginx","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å®ç”¨ã€ç”Ÿäº§ç¯å¢ƒçº§åˆ«çš„ã€ŠNginx æ³¨æ„äº‹é¡¹å¤§å…¨ã€‹ï¼Œæ¶µç›–å®‰å…¨ã€æ€§èƒ½ã€éƒ¨ç½²ã€åä»£ã€é™æ€ç«™ç‚¹ã€HTTP2ã€HTTPSã€æ—¥å¿—ã€ç³»ç»Ÿå±‚ã€é™æµã€ç¼“å­˜ç­‰å…³é”®ç‚¹ã€‚ éå¸¸é€‚åˆä½œä¸º Nginx é¡¹ç›®ä¸Šçº¿ Checklistã€‚\n1. åŸºç¡€æ¦‚å¿µéƒ¨åˆ† Nginx æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œworker æ•°é‡ä¸ CPU ç»‘å®šï¼ˆä¸è¦ä¹±æ”¹ï¼‰ worker_processes auto; CPU=2 å°± 2 workerï¼›CPU=16 å°± 16 workerã€‚ worker_connections å†³å®šæœ€å¤§å¹¶å‘ æœ€å¤§å¹¶å‘ â‰ˆ worker_processes Ã— worker_connections\né»˜è®¤å€¼å¤ªå°å¿…é¡»è°ƒå¤§ï¼š\nworker_connections 65535; 2. æ€§èƒ½è°ƒä¼˜æ³¨æ„äº‹é¡¹ è¿æ¥æ•°é™åˆ¶ å¿…é¡»ç¡®ä¿ Linux ç³»ç»Ÿä¹Ÿè°ƒå¤§ï¼š\nulimit -n 200000 epoll å¿…é¡»å¼€å¯ï¼ˆé»˜è®¤ï¼‰ use epoll; multi_accept å¯ä»¥æå‡é«˜å¹¶å‘æŠ¢è¿æ¥èƒ½åŠ› multi_accept on; keepalive upstream è¦é…ç½®ï¼Œä¸ç„¶ upstream ä¼šè¢«é¢‘ç¹é‡è¿ keepalive 64; 3. åå‘ä»£ç†æ³¨æ„äº‹é¡¹ å¿…é¡»ä¼ é€’ Hostï¼Œå¦åˆ™å¾ˆå¤šåç«¯ä¼šåˆ¤é”™åŸŸå æ­£ç¡®ï¼š\nproxy_set_header Host $http_host; ä¸è¦å†™ï¼š\nproxy_set_header Host $host; å·®åˆ«ï¼š\n$host -\u0026gt; åŸŸåå˜åŒ–æ—¶å¯èƒ½å˜æˆ server_name $http_host -\u0026gt; ä¿ç•™å®¢æˆ·ç«¯çœŸå® Host ä»£ç†åˆ° HTTPS å¿…é¡»åŠ  proxy_ssl_server_name on; å¦åˆ™æŸäº›æœåŠ¡ï¼ˆå¦‚å¾®ä¿¡ APIã€äº‘æœåŠ¡ï¼‰ä¼šæŠ¥ SNI é”™ã€‚\nå®šä¹‰ proxy è®¾ç½®ä¸è¦é‡å¤å†™ ç»Ÿä¸€å†™åœ¨ http {} æˆ– include æ–‡ä»¶ï¼š\nproxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; 4. é™æ€èµ„æºæ³¨æ„äº‹é¡¹ root ä¸ alias ä¸è¦æ··ç”¨ï¼Œä¸è¦å†™é”™ root ä¼šæ‹¼æ¥è·¯å¾„ï¼š\nlocation /admin/ root /data/www; ==\u0026gt; /data/www/admin/xxx alias æ˜¯ç›´æ¥æ›¿æ¢è·¯å¾„ï¼š\nlocation /admin/ alias /data/www/admin/; ==\u0026gt; /data/www/admin/xxx try_files å¿…é¡»å†™æœ€å fallback SPA å¿…é¡»ï¼š\ntry_files $uri $uri/ /index.html; 5. è·¨åŸŸ CORS æ³¨æ„äº‹é¡¹ ç”Ÿäº§ä¸èƒ½å†™ *ï¼Œå¿…é¡»æŒ‡å®šåŸŸåï¼š\nadd_header Access-Control-Allow-Origin https://example.com; 6. HTTP/2 æ³¨æ„äº‹é¡¹ æ–°å†™æ³• listen 443 ssl; http2 on;\næ—§å†™æ³•ä¼šæŠ¥ deprecated listen 443 ssl http2; # å·²è¿‡æœŸ 7. HTTPS / SSL æ³¨æ„äº‹é¡¹ TLS ç‰ˆæœ¬ ssl_protocols TLSv1.2 TLSv1.3; ç¡®ä¿ session cache å¼€å¯ ssl_session_cache shared:SSL:50m; ssl_session_timeout 1d; å¼€å¯ session tickets ssl_session_tickets on; è¯ä¹¦æƒé™ä¸è¦é”™ chmod 600 certificate.key 8. æ—¥å¿—æ³¨æ„äº‹é¡¹ access.log å»ºè®®åœ¨é«˜å¹¶å‘ä¸‹å…³é—­æˆ–é™ä½æ—¥å¿—çº§åˆ« å¤§é‡å¹¶å‘ä¼šå†™æ»¡ç£ç›˜ IOï¼š\naccess_log off; error_log æ¨è warn çº§åˆ« error_log /var/log/nginx/error.log warn; 9. ç³»ç»Ÿå±‚è°ƒä¼˜æ³¨æ„äº‹é¡¹ å†™å…¥ /etc/sysctl.confï¼š\nfs.file-max = 1000000 net.core.somaxconn = 65535 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_fin_timeout = 10 net.ipv4.ip_local_port_range = 1024 65000 ç„¶åï¼š\nsysctl -p 10. å®‰å…¨æ³¨æ„äº‹é¡¹ï¼ˆé‡ç‚¹ï¼‰ ç¦æ­¢ç‰ˆæœ¬å·æ³„éœ² server_tokens off; ç¦æ­¢è®¿é—®æ•æ„Ÿè·¯å¾„ location ~ /\\.(git|svn|hg) { deny all; } é™æ€ç›®å½•å¿…é¡»é™åˆ¶æ‰§è¡Œæƒé™ é˜²æ­¢ä¸Šä¼  .phpã€.shï¼š\nlocation ~* \\.(php|sh)$ { deny all; } 11. é™æµæ³¨æ„äº‹é¡¹ è¯·æ±‚é™æµï¼š\nlimit_req_zone $binary_remote_addr zone=req:10m rate=10r/s; limit_conn_zone $binary_remote_addr zone=conn:10m; server { limit_req zone=req burst=20 nodelay; limit_conn conn 20; } 12. ç¼“å­˜æ³¨æ„äº‹é¡¹ é™æ€èµ„æºç¼“å­˜ï¼ˆå¼ºç¼“å­˜ï¼‰\nlocation ~* \\.(jpg|png|css|js|svg|woff2)$ { expires 30d; access_log off; } ä»£ç†ç¼“å­˜ï¼ˆæ…ç”¨ï¼‰\nproxy_cache_path /data/cache levels=1:2 keys_zone=cache:100m inactive=7d; 13. å¸¸è§è¸©å‘äº‹é¡¹ âŒ alias æœ€åå¿…é¡»åŠ  /\nå¦åˆ™è·¯å¾„ä¼šé”™ã€‚\nâŒ SPA åº”ç”¨å¿…é¡»ç”¨ try_filesï¼Œå¦åˆ™ history è·¯ç”±ä¼š 404\nâŒ proxy_pass æœ«å°¾æ˜¯å¦å¸¦ / ä¼šæ”¹å˜è·¯å¾„åŒ¹é…\nä¸¾ä¾‹ï¼š\nlocation /api/ { proxy_pass http://backend/; } å’Œï¼š\nproxy_pass http://backend; ç»“æœä¸åŒã€‚\nâŒ Nginx + Node/Java/Python upstream æœªè®¾ç½® keepalive æ—¶ä¼š OOM\nâŒ error_page ä¼šå½±å“ä»£ç†è¡Œä¸ºï¼Œå¿…é¡»å°å¿ƒ\n14. éƒ¨ç½²ä¸Šçº¿æ³¨æ„äº‹é¡¹ ä¸Šçº¿å‰å¿…é¡»æ‰§è¡Œï¼š\nnginx -t å¹¶ä¼˜é›… reloadï¼š\nnginx -s reload 15. Docker éƒ¨ç½²æ³¨æ„äº‹é¡¹ ä¸è¦æŠŠé…ç½®å†™å…¥é•œåƒå±‚\né…ç½®æ”¾åˆ°æŒ‚è½½ç›®å½•ï¼š\n-v /etc/nginx/conf.d:/etc/nginx/conf.d Keepalive æ–‡ä»¶æè¿°ç¬¦ä¸€å®šè¦è°ƒå¤§ï¼Œå¦åˆ™å®¹å™¨å†…ä¼šè¢«é™åˆ¶\n","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å®ç”¨ã€ç”Ÿäº§ç¯å¢ƒçº§åˆ«çš„ã€ŠNginx æ³¨æ„äº‹é¡¹å¤§å…¨ã€‹ï¼Œæ¶µç›–å®‰å…¨ã€æ€§èƒ½ã€éƒ¨ç½²ã€åä»£ã€é™æ€ç«™ç‚¹ã€HTTP2ã€HTTPSã€æ—¥å¿—ã€ç³»ç»Ÿå±‚ã€é™æµã€ç¼“å­˜ç­‰å…³é”®ç‚¹ã€‚ éå¸¸é€‚åˆä½œä¸º Nginx é¡¹ç›®ä¸Šçº¿ Checklistã€‚\n1. åŸºç¡€æ¦‚å¿µéƒ¨åˆ† Nginx æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œworker æ•°é‡ä¸ CPU ç»‘å®šï¼ˆä¸è¦ä¹±æ”¹ï¼‰ worker_processes auto; CPU=2 å°± 2 workerï¼›CPU=16 å°± 16 workerã€‚ worker_connections å†³å®šæœ€å¤§å¹¶å‘ æœ€å¤§å¹¶å‘ â‰ˆ worker_processes Ã— worker_connections\n"},{"id":343,"href":"/operations/nginx/config/","title":"Nginx ç”Ÿäº§çº§ nginx.conf","parent":"Nginx","content":" ç”Ÿäº§çº§ nginx.conf ä¸‹é¢æ˜¯ä¸€ä»½ç”Ÿäº§çº§ nginx.conf æ¨¡æ¿ï¼ŒåŒ…å« HTTP-\u0026gt;HTTPS å¼ºåˆ¶è·³è½¬ã€HTTP/2ã€SSLï¼ˆç°ä»£å®‰å…¨é…ç½®ï¼‰ã€æ€§èƒ½ä¼˜åŒ–ï¼ˆworkerã€è¿æ¥ã€ç¼“å†²ã€gzipã€keepaliveã€upstream keepaliveï¼‰ã€å®‰å…¨æ€§ï¼ˆHSTSã€OCSPã€sessionï¼‰ä»¥åŠå¸¸ç”¨ proxy/fastcgi è®¾ç½®ã€‚é…ç½®é‡Œå¸¦æ³¨é‡Šï¼ŒæŒ‰éœ€æ›¿æ¢è¯ä¹¦è·¯å¾„ã€åŸŸåå’Œä¸Šæ¸¸æœåŠ¡åœ°å€ã€‚\næ³¨æ„ï¼šä¸åŒ Nginx ç‰ˆæœ¬åœ¨å¯ç”¨ HTTP/2 çš„è¯­æ³•ä¸Šå¯èƒ½ç•¥æœ‰å·®åˆ«ï¼ˆhttp2;ã€http2 on; æˆ– listen \u0026hellip; http2;ï¼‰ã€‚æˆ‘åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨é€šç”¨å†™æ³• listen 443 ssl; + http2;ï¼Œå¦‚æœä½ å½“å‰ç‰ˆæœ¬æŠ¥è¯­æ³•é”™è¯¯ï¼ŒæŒ‰ä½ ç¯å¢ƒæ”¹ä¸º http2 on; æˆ– listen 443 ssl http2; å³å¯ï¼ˆåœ¨æ³¨é‡Šå¤„æ ‡æ˜ï¼‰ã€‚\n# /etc/nginx/nginx.conf user nginx; worker_processes auto; # æ¨è autoï¼Œæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨è®¾ç½® worker_rlimit_nofile 65535; error_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid; events { use epoll; worker_connections 4096; # æ¯ worker çš„æœ€å¤§è¿æ¥æ•°ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰ multi_accept on; accept_mutex off; } http { # åŸºç¡€ include mime.types; default_type application/octet-stream; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65s; types_hash_max_size 2048; server_tokens off; # æ—¥å¿—æ ¼å¼ log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; access_log /var/log/nginx/access.log main; # ç¼“å†²ä¸è¯·æ±‚é™åˆ¶ï¼ˆå¯é’ˆå¯¹ 2G å†…å­˜/åŒæ ¸é€‚å½“ä¸‹è°ƒï¼‰ client_max_body_size 20m; client_body_buffer_size 64k; client_header_buffer_size 8k; large_client_header_buffers 4 16k; client_body_timeout 20s; client_header_timeout 20s; send_timeout 20s; # Gzip å‹ç¼© gzip on; gzip_http_version 1.1; gzip_comp_level 5; gzip_min_length 1024; gzip_proxied any; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL ä¼˜åŒ–ï¼ˆæ›¿æ¢ä¸ºä½ çš„è¯ä¹¦ï¼‰ ssl_session_cache shared:SSL:50m; ssl_session_timeout 1d; ssl_session_tickets off; # æ¨èçš„å®‰å…¨åè®®ä¸å¯†ç å¥—ä»¶ï¼ˆæ”¯æŒ TLS1.2/1.3ï¼‰ ssl_protocols TLSv1.2 TLSv1.3; # å¯¹äº TLS1.3ï¼ŒCipher é…ç½®ç”± OpenSSL æ§åˆ¶ï¼›ä¸‹é¢ä¸º TLS1.2 ciphers ssl_ciphers \u0026#39;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:\u0026#39; \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:\u0026#39; \u0026#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384\u0026#39;; ssl_prefer_server_ciphers off; # OCSP Staplingï¼ˆå¯ç”¨åéœ€è¦æ­£ç¡®çš„ ssl_trusted_certificateï¼‰ resolver 1.1.1.1 8.8.8.8 valid=300s; resolver_timeout 5s; # å®‰å…¨å¤´ï¼ˆå¯æŒ‰éœ€æ‰“å¼€/ä¿®æ”¹ï¼‰ add_header X-Frame-Options SAMEORIGIN; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34;; # Limit / rate limiting # æ¯ä¸ª IP å…è®¸çš„å¹¶å‘è¯·æ±‚æ•°ä¸é€Ÿç‡æ§åˆ¶ï¼ˆæŒ‰éœ€è°ƒæ•´ï¼‰ limit_conn_zone $binary_remote_addr zone=addr:10m; limit_req_zone $binary_remote_addr zone=req_zone:10m rate=10r/s; # Upstream å¸¸ç”¨ç¤ºä¾‹ï¼ˆæ·»åŠ  keepaliveï¼‰ upstream app_backend { server 127.0.0.1:8000 max_fails=3 fail_timeout=30s; server 127.0.0.1:8001 max_fails=3 fail_timeout=30s; keepalive 16; } # Proxy é»˜è®¤è®¾ç½®ï¼ˆå¯ include åˆ° conf.d/proxy.confï¼‰ map $http_upgrade $connection_upgrade { default upgrade; \u0026#39;\u0026#39; close; } # include ç«™ç‚¹ä¸é¢å¤–é…ç½® include /etc/nginx/conf.d/*.conf; } ç¤ºä¾‹ï¼šç”Ÿäº§çº§ serverï¼ˆHTTP-\u0026gt;HTTPSã€HTTP/2ã€SSLã€Proxyï¼‰\nå°†ä¸‹é¢çš„ server å¡«å…¥ /etc/nginx/conf.d/site.confï¼ˆæ›¿æ¢ example.comã€è¯ä¹¦è·¯å¾„ä¸ upstreamï¼‰ã€‚\nserver { listen 80; server_name example.com www.example.com; # å¼ºåˆ¶ HTTPSï¼ˆå¸¦åŸå§‹è¯·æ±‚ URI ä¸ argsï¼‰ location / { return 301 https://$host$request_uri; } } server { listen 443 ssl; # è‹¥ä½ çš„ Nginx è¦æ±‚å…¶å®ƒè¯­æ³•ï¼ˆå¦‚ `http2 on;`ï¼‰ï¼Œå¯æ›¿æ¢ # å¯ç”¨ HTTP/2ï¼›åœ¨éƒ¨åˆ†ç‰ˆæœ¬éœ€è¦è°ƒæ•´è¯­æ³•ä¸º \u0026#34;http2 on;\u0026#34; æˆ– \u0026#34;listen 443 ssl http2;\u0026#34; http2; server_name example.com www.example.com; ssl_certificate /etc/ssl/certs/example.com.crt; ssl_certificate_key /etc/ssl/private/example.com.key; # å¦‚æœå¯ç”¨ OCSP staplingï¼Œéœ€è¦è®¾ç½® trusted cert ssl_trusted_certificate /etc/ssl/certs/chain.pem; # OCSP stapling ssl_stapling on; ssl_stapling_verify on; # å¼ºåˆ¶ HSTSï¼ˆæ…ç”¨ï¼Œç¡®ä¿ HTTPS å®Œæ•´å¯ç”¨ï¼‰ add_header Strict-Transport-Security \u0026#34;max-age=31536000; includeSubDomains; preload\u0026#34; always; # ç¼“å­˜é™æ€èµ„æºï¼ˆæŒ‰éœ€è°ƒæ•´ï¼‰ location ~* \\.(?:css|js|jpg|jpeg|gif|png|svg|ico|webp|woff2?)$ { root /var/www/html; # æ›¿æ¢ä¸ºä½ çš„é™æ€ç›®å½• expires 30d; add_header Cache-Control \u0026#34;public\u0026#34;; access_log off; try_files $uri =404; } # å‰ç«¯ SPAï¼ˆä¾‹å¦‚ /admin/ï¼‰ location /admin/ { alias /data/websites/default/8000/admin/; index index.html; # history æ¨¡å¼ fallback åˆ° index.html try_files $uri $uri/ /admin/index.html; } # åå‘ä»£ç†åˆ° upstreamï¼Œå¸¦å¸¸è§ header ä¸è¶…æ—¶é…ç½® location /api/ { proxy_pass http://app_backend; proxy_set_header Host $host; # æ¨è $hostï¼ˆæ¯” $http_host æ›´å®‰å…¨ï¼‰ proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_http_version 1.1; proxy_set_header Connection $connection_upgrade; proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; # proxy buffers proxy_buffer_size 16k; proxy_buffers 4 32k; proxy_busy_buffers_size 64k; # å…è®¸å°†å¤§è¯·æ±‚ä½“ä¼ ç»™åç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰ client_max_body_size 50m; } # FastCGI PHP ç¤ºä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰ location ~ \\.php$ { include fastcgi_params; fastcgi_pass unix:/run/php-fpm/php-fpm.sock; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_read_timeout 60s; # FastCGI ç¼“å†²åŒº fastcgi_buffer_size 128k; fastcgi_buffers 4 256k; fastcgi_busy_buffers_size 256k; } # è®¿é—®æ—¥å¿—/é”™è¯¯æ—¥å¿— å¯å•ç‹¬é…ç½® access_log /var/log/nginx/example.access.log main; error_log /var/log/nginx/example.error.log warn; } éƒ¨ç½²/æ£€æŸ¥æ­¥éª¤ï¼ˆå¿…åšï¼‰ æ›¿æ¢ä¸Šé¢é…ç½®ä¸­çš„åŸŸåã€è¯ä¹¦è·¯å¾„ã€upstream åœ°å€ã€é™æ€ç›®å½•ç­‰ã€‚\nè¯­æ³•æ£€æŸ¥ï¼š\nnginx -t é‡æ–°åŠ è½½ Nginxï¼š\nsystemctl reload nginx è§‚å¯Ÿæ—¥å¿—ï¼ˆé”™è¯¯/è®¿é—®ï¼‰éªŒè¯è¯·æ±‚æ˜¯å¦æŒ‰é¢„æœŸè½¬å‘ï¼š\ntail -f /var/log/nginx/error.log /var/log/nginx/access.log å°ç»“ä¸è°ƒä¼˜å»ºè®® worker_processes auto + worker_connections é…åˆå†³å®šæœ€å¤§å¹¶å‘ï¼šmax_clients â‰ˆ worker_processes * worker_connectionsã€‚2 æ ¸ã€2GB çš„æœºå™¨å¯é€‰ worker_connections 4k~8kï¼ˆæ ¹æ®å†…å­˜ä¸åº”ç”¨è°ƒæ•´ï¼‰ã€‚ å¤§æ–‡ä»¶ä¸Šä¼ åœºæ™¯è¯·è°¨æ…è°ƒ client_body_buffer_sizeï¼ˆé¿å…å¤§é‡å¹¶å‘æ—¶å†…å­˜è€—å°½ï¼‰ã€‚ å¯ç”¨ ssl_session_cache ä¸ keepalive èƒ½æ˜¾è‘—é™ä½æ¡æ‰‹/è¿æ¥å¼€é”€ã€‚ è‹¥ä½¿ç”¨ HTTP/2/3ï¼Œæ³¨æ„æµ‹è¯•æµè§ˆå™¨æ”¯æŒå’Œ Nginx/OpenSSL ç‰ˆæœ¬å…¼å®¹æ€§ã€‚ ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®ç›‘æ§ï¼ˆnginx-vtsã€Prometheus exporterï¼‰å¹¶åšå¥½æ—¥å¿—è½®è½¬ã€‚ ","description":" ç”Ÿäº§çº§ nginx.conf ä¸‹é¢æ˜¯ä¸€ä»½ç”Ÿäº§çº§ nginx.conf æ¨¡æ¿ï¼ŒåŒ…å« HTTP-\u0026gt;HTTPS å¼ºåˆ¶è·³è½¬ã€HTTP/2ã€SSLï¼ˆç°ä»£å®‰å…¨é…ç½®ï¼‰ã€æ€§èƒ½ä¼˜åŒ–ï¼ˆworkerã€è¿æ¥ã€ç¼“å†²ã€gzipã€keepaliveã€upstream keepaliveï¼‰ã€å®‰å…¨æ€§ï¼ˆHSTSã€OCSPã€sessionï¼‰ä»¥åŠå¸¸ç”¨ proxy/fastcgi è®¾ç½®ã€‚é…ç½®é‡Œå¸¦æ³¨é‡Šï¼ŒæŒ‰éœ€æ›¿æ¢è¯ä¹¦è·¯å¾„ã€åŸŸåå’Œä¸Šæ¸¸æœåŠ¡åœ°å€ã€‚\næ³¨æ„ï¼šä¸åŒ Nginx ç‰ˆæœ¬åœ¨å¯ç”¨ HTTP/2 çš„è¯­æ³•ä¸Šå¯èƒ½ç•¥æœ‰å·®åˆ«ï¼ˆhttp2;ã€http2 on; æˆ– listen \u0026hellip; http2;ï¼‰ã€‚æˆ‘åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨é€šç”¨å†™æ³• listen 443 ssl; + http2;ï¼Œå¦‚æœä½ å½“å‰ç‰ˆæœ¬æŠ¥è¯­æ³•é”™è¯¯ï¼ŒæŒ‰ä½ ç¯å¢ƒæ”¹ä¸º http2 on; æˆ– listen 443 ssl http2; å³å¯ï¼ˆåœ¨æ³¨é‡Šå¤„æ ‡æ˜ï¼‰ã€‚\n# /etc/nginx/nginx.conf user nginx; worker_processes auto; # æ¨è autoï¼Œæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨è®¾ç½® worker_rlimit_nofile 65535; error_log /var/log/nginx/error.log warn; pid /var/run/nginx.pid; events { use epoll; worker_connections 4096; # æ¯ worker çš„æœ€å¤§è¿æ¥æ•°ï¼ˆå¯æŒ‰éœ€è°ƒæ•´ï¼‰ multi_accept on; accept_mutex off; } http { # åŸºç¡€ include mime.types; default_type application/octet-stream; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65s; types_hash_max_size 2048; server_tokens off; # æ—¥å¿—æ ¼å¼ log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; access_log /var/log/nginx/access.log main; # ç¼“å†²ä¸è¯·æ±‚é™åˆ¶ï¼ˆå¯é’ˆå¯¹ 2G å†…å­˜/åŒæ ¸é€‚å½“ä¸‹è°ƒï¼‰ client_max_body_size 20m; client_body_buffer_size 64k; client_header_buffer_size 8k; large_client_header_buffers 4 16k; client_body_timeout 20s; client_header_timeout 20s; send_timeout 20s; # Gzip å‹ç¼© gzip on; gzip_http_version 1.1; gzip_comp_level 5; gzip_min_length 1024; gzip_proxied any; gzip_vary on; gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; # SSL ä¼˜åŒ–ï¼ˆæ›¿æ¢ä¸ºä½ çš„è¯ä¹¦ï¼‰ ssl_session_cache shared:SSL:50m; ssl_session_timeout 1d; ssl_session_tickets off; # æ¨èçš„å®‰å…¨åè®®ä¸å¯†ç å¥—ä»¶ï¼ˆæ”¯æŒ TLS1.2/1.3ï¼‰ ssl_protocols TLSv1.2 TLSv1.3; # å¯¹äº TLS1.3ï¼ŒCipher é…ç½®ç”± OpenSSL æ§åˆ¶ï¼›ä¸‹é¢ä¸º TLS1.2 ciphers ssl_ciphers \u0026#39;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:\u0026#39; \u0026#39;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:\u0026#39; \u0026#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384\u0026#39;; ssl_prefer_server_ciphers off; # OCSP Staplingï¼ˆå¯ç”¨åéœ€è¦æ­£ç¡®çš„ ssl_trusted_certificateï¼‰ resolver 1.1.1.1 8.8.8.8 valid=300s; resolver_timeout 5s; # å®‰å…¨å¤´ï¼ˆå¯æŒ‰éœ€æ‰“å¼€/ä¿®æ”¹ï¼‰ add_header X-Frame-Options SAMEORIGIN; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection \u0026#34;1; mode=block\u0026#34;; # Limit / rate limiting # æ¯ä¸ª IP å…è®¸çš„å¹¶å‘è¯·æ±‚æ•°ä¸é€Ÿç‡æ§åˆ¶ï¼ˆæŒ‰éœ€è°ƒæ•´ï¼‰ limit_conn_zone $binary_remote_addr zone=addr:10m; limit_req_zone $binary_remote_addr zone=req_zone:10m rate=10r/s; # Upstream å¸¸ç”¨ç¤ºä¾‹ï¼ˆæ·»åŠ  keepaliveï¼‰ upstream app_backend { server 127.0.0.1:8000 max_fails=3 fail_timeout=30s; server 127.0.0.1:8001 max_fails=3 fail_timeout=30s; keepalive 16; } # Proxy é»˜è®¤è®¾ç½®ï¼ˆå¯ include åˆ° conf.d/proxy.confï¼‰ map $http_upgrade $connection_upgrade { default upgrade; \u0026#39;\u0026#39; close; } # include ç«™ç‚¹ä¸é¢å¤–é…ç½® include /etc/nginx/conf.d/*.conf; } ç¤ºä¾‹ï¼šç”Ÿäº§çº§ serverï¼ˆHTTP-\u0026gt;HTTPSã€HTTP/2ã€SSLã€Proxyï¼‰\n"},{"id":344,"href":"/operations/nginx/classic-issues/","title":"Nginx ç»å…¸é—®é¢˜","parent":"Nginx","content":"Redis çš„é—®é¢˜æ ¸å¿ƒæ˜¯â€œç¼“å­˜ä¸€è‡´æ€§ä¸å¤±æ•ˆâ€\nNginx çš„é—®é¢˜æ ¸å¿ƒæ˜¯â€œæµé‡ã€è¿æ¥ã€ä»£ç†ä¸è¾¹ç•Œå¤±æ§â€\nä¸€ã€Nginx çš„ã€Œä¸‰å¤§ç»å…¸é—®é¢˜æ¨¡å‹ã€ï¼ˆç±»æ¯” Redisï¼‰ â‘  è¿æ¥è€—å°½ / FD è€—å°½ï¼ˆNginx ç‰ˆâ€œé›ªå´©â€ï¼‰ è¡¨ç° å¤§é‡ 502 / 504 error.log å‡ºç°ï¼š worker_connections are not enough too many open files æ–°è¯·æ±‚æ— æ³•å»ºç«‹è¿æ¥ æ ¹å›  worker_connections å¤ªå° ulimit -n å¤ªå° åç«¯è¿æ¥æœªå¤ç”¨ï¼ˆkeepalive æœªå¼€ï¼‰ TIME_WAIT å †ç§¯ å¤§é‡æ…¢è¿æ¥ï¼ˆæ…¢ POSTã€æ…¢å®¢æˆ·ç«¯ï¼‰ æœ¬è´¨ è¿æ¥èµ„æºè¢«ç¬é—´è€—å°½ï¼Œæ•´ä¸ªå…¥å£å¤±æ•ˆ\nå¯¹åº” Redis ğŸ‘‰ ç¼“å­˜é›ªå´©\nè§£å†³ worker_connections + ulimit è°ƒå¤§ upstream keepalive aggressive timeout é™æµ é˜²æ…¢è¿æ¥ â‘¡ åç«¯è¢«æ‰“çˆ†ï¼ˆNginx ç‰ˆâ€œå‡»ç©¿â€ï¼‰ è¡¨ç° Nginx æ­£å¸¸ åç«¯ CPU 100% æ¥å£å“åº”è¶Šæ¥è¶Šæ…¢ é€æ¸ 504 æ ¹å›  Nginx æ²¡æœ‰ç¼“å­˜ çƒ­ç‚¹æ¥å£è¢«ç¬é—´æ”¾å¤§ proxy_buffering å…³é—­ æ— é‡è¯• / ç†”æ–­ æœ¬è´¨ æ‰€æœ‰è¯·æ±‚åŒæ—¶æ‰“åˆ°åç«¯å•ç‚¹\nå¯¹åº” Redis ğŸ‘‰ ç¼“å­˜å‡»ç©¿\nè§£å†³ proxy_cache limit_req proxy_next_upstream ç†”æ–­ / é™çº§ upstream least_conn â‘¢ è¯·æ±‚è¢«æ— é™æ”¾å¤§ï¼ˆNginx ç‰ˆâ€œç©¿é€â€ï¼‰ è¡¨ç° å¤§é‡ 404 / 400 åç«¯ QPS å¾ˆé«˜ä½†æ— æœ‰æ•ˆä¸šåŠ¡ æ—¥å¿—æš´æ¶¨ æ ¹å›  å¯¹ä¸å­˜åœ¨èµ„æºæ— é™è½¬å‘ æœªç¼“å­˜ 404 æœªåšè·¯å¾„ / æ–¹æ³•é™åˆ¶ çˆ¬è™« / æ‰«æå™¨ æœ¬è´¨ æ— æ•ˆè¯·æ±‚ç©¿é€åˆ°åç«¯\nå¯¹åº” Redis ğŸ‘‰ ç¼“å­˜ç©¿é€\nè§£å†³ try_files proxy_cache 404 deny éæ³•è·¯å¾„ limit_req ç™½åå• API äºŒã€å†å¾€ä¸‹ï¼šNginxã€Œç³»ç»Ÿæ€§é—®é¢˜å¤§å…¨ã€ ä¸‹é¢è¿™äº›æ˜¯ç”Ÿäº§ç¯å¢ƒçœŸæ­£åœ¨å‡ºäº‹çš„ç‚¹ã€‚\n4ï¸âƒ£ æ…¢è¿æ¥ / æ…¢è¯·æ±‚ï¼ˆSilent Killerï¼‰ ç°è±¡ QPS ä¸é«˜ è¿æ¥æ•°å¾ˆé«˜ worker å æ»¡ CPU ä¸é«˜ä½†æœåŠ¡å¡æ­» åŸå›  client_body_timeout å¤ªå¤§ proxy_read_timeout å¤ªå¤§ æ…¢å®¢æˆ·ç«¯æŒç»­å ç”¨è¿æ¥ æœ¬è´¨ worker è¢«â€œæ…¢ IOâ€æ‹–æ­»\nè§£å†³ çŸ­ connect timeout é™åˆ¶ä¸Šä¼ é€Ÿç‡ é™åˆ¶ body size limit_conn 5ï¸âƒ£ è·¯å¾„é”™ä¹±ï¼ˆåå‘ä»£ç†ç»å…¸å‘ï¼‰ ç°è±¡ 404 / 302 å¾ªç¯ Jenkins / GitLab æç¤º proxy broken åŸå›  proxy_pass å¸¦ / ä¸å¸¦ / location ä¸ prefix ä¸ä¸€è‡´ proxy_redirect ç¼ºå¤± æœ¬è´¨ URI é‡å†™è§„åˆ™ç†è§£é”™è¯¯\n6ï¸âƒ£ çœŸå® IP ä¸¢å¤± / ä¼ªé€  ç°è±¡ åç«¯å…¨æ˜¯ 127.0.0.1 é£æ§å¤±æ•ˆ æ—¥å¿—æ— æ³•å®šä½ç”¨æˆ· åŸå›  X-Forwarded-For æ²¡é…ç½® real_ip æ¨¡å—æ²¡å¼€ ç›²ä¿¡å®¢æˆ·ç«¯ XFF æœ¬è´¨ ä¿¡ä»»è¾¹ç•Œæ²¡åˆ’æ¸…\n7ï¸âƒ£ TLS / HTTP2 å¸¦æ¥çš„éšæ€§å‹åŠ› ç°è±¡ HTTPS æ¯” HTTP æ…¢å¾ˆå¤š CPU è¢« TLS åƒæ»¡ åŸå›  TLS æ¡æ‰‹å¤š session cache æ²¡å¼€ HTTP/2 æœªå¯ç”¨ è§£å†³ TLS session cache HTTP/2 HSTS ç¨³å®šåå†å¼€ 8ï¸âƒ£ æ—¥å¿— I/O æ”¾å¤§ ç°è±¡ ç£ç›˜ IO 100% access.log å·¨å¤§ åŸå›  å…¨é‡è®°å½•æ—¥å¿— é«˜å¹¶å‘ä¸‹åŒæ­¥å†™ç›˜ æœ¬è´¨ æ—¥å¿—æˆä¸ºæ€§èƒ½ç“¶é¢ˆ\n9ï¸âƒ£ é…ç½®é”™è¯¯å¯¼è‡´å•ç‚¹å¤±æ•ˆ ç°è±¡ reload åç›´æ¥ 502 æŸä¸ª server block æŠ¢å é»˜è®¤ç«¯å£ åŸå›  server_name å†²çª default_server è¯¯ç”¨ upstream åç§°å†²çª ğŸ”Ÿ è¾¹ç•ŒèŒè´£æ··ä¹±ï¼ˆæ¶æ„çº§é—®é¢˜ï¼‰ ç°è±¡ Nginx åšäº†å¤ªå¤šä¸šåŠ¡é€»è¾‘ Lua è¿‡é‡ é…ç½®å¤æ‚éš¾ç»´æŠ¤ æœ¬è´¨ æŠŠ Nginx å½“åº”ç”¨æœåŠ¡å™¨ç”¨\nä¸‰ã€æ€»ç»“æˆä¸€å¼ ã€Œå¯¹æ¯”è¡¨ã€ Redis é—®é¢˜ Nginx å¯¹åº”é—®é¢˜ æœ¬è´¨ ç¼“å­˜ç©¿é€ æ— æ•ˆè¯·æ±‚ç©¿é€ è¾¹ç•Œç¼ºå¤± ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹æµé‡æ‰“çˆ†åç«¯ ç¼ºä¹ç¼“å†² ç¼“å­˜é›ªå´© è¿æ¥ / FD è€—å°½ èµ„æºæ¯ç«­ å››ã€å…¶å®ƒ Redis ä¸»è¦é¢ä¸´ç¼“å­˜ä¸€è‡´æ€§ä¸å¤±æ•ˆé—®é¢˜ï¼Œè€Œ Nginx ä½œä¸ºæµé‡å…¥å£ï¼Œæ›´å®¹æ˜“å‡ºç°è¿æ¥è€—å°½ã€è¯·æ±‚æ”¾å¤§ã€åç«¯è¢«æ‰“çˆ†ç­‰é—®é¢˜ã€‚\nåœ¨ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸é€šè¿‡é™æµã€ç¼“å­˜ã€è¶…æ—¶æ§åˆ¶ã€è´Ÿè½½å‡è¡¡å’Œè¿æ¥å¤ç”¨æ¥é˜²æ­¢è¿™äº›é—®é¢˜ï¼Œæœ¬è´¨æ˜¯æ§åˆ¶æµé‡ã€éš”ç¦»æ•…éšœã€ä¿æŠ¤åç«¯ã€‚\n","description":"Redis çš„é—®é¢˜æ ¸å¿ƒæ˜¯â€œç¼“å­˜ä¸€è‡´æ€§ä¸å¤±æ•ˆâ€\nNginx çš„é—®é¢˜æ ¸å¿ƒæ˜¯â€œæµé‡ã€è¿æ¥ã€ä»£ç†ä¸è¾¹ç•Œå¤±æ§â€\nä¸€ã€Nginx çš„ã€Œä¸‰å¤§ç»å…¸é—®é¢˜æ¨¡å‹ã€ï¼ˆç±»æ¯” Redisï¼‰ â‘  è¿æ¥è€—å°½ / FD è€—å°½ï¼ˆNginx ç‰ˆâ€œé›ªå´©â€ï¼‰ è¡¨ç° å¤§é‡ 502 / 504 error.log å‡ºç°ï¼š worker_connections are not enough too many open files æ–°è¯·æ±‚æ— æ³•å»ºç«‹è¿æ¥ æ ¹å›  worker_connections å¤ªå° ulimit -n å¤ªå° åç«¯è¿æ¥æœªå¤ç”¨ï¼ˆkeepalive æœªå¼€ï¼‰ TIME_WAIT å †ç§¯ å¤§é‡æ…¢è¿æ¥ï¼ˆæ…¢ POSTã€æ…¢å®¢æˆ·ç«¯ï¼‰ æœ¬è´¨ è¿æ¥èµ„æºè¢«ç¬é—´è€—å°½ï¼Œæ•´ä¸ªå…¥å£å¤±æ•ˆ\n"},{"id":345,"href":"/operations/nginx/upstream-best-practices/","title":"Nginx è´Ÿè½½å‡è¡¡æœ€ä½³å®è·µ","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€ç®€æ´ä½†ä¸“ä¸šã€å¯ç›´æ¥è½åœ°çš„ã€ŠNginx è´Ÿè½½å‡è¡¡æœ€ä½³å®è·µã€‹ã€‚\nå†…å®¹å…¨æ˜¯ä¼ä¸šçœŸå®ç»éªŒæ€»ç»“ï¼Œæ³¨æ„äº‹é¡¹ã€å‘ç‚¹ã€è°ƒä¼˜éƒ½æœ‰ã€‚\n1. æ˜ç¡®ç›®æ ‡ï¼šé«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±• è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒç›®çš„ï¼š\nåˆ†æ‘Šæµé‡ï¼Œé¿å…å•æœºç“¶é¢ˆ é¿å…é›ªå´©æ•ˆåº”ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰å¯¼è‡´å…¨éƒ¨å¡æ­»ï¼‰ ä¿è¯æœåŠ¡å¯æ‰©å±• æå‡ååä¸ç¨³å®šæ€§ **åŠ¡å¿…è®°ä½ï¼š**LB ä¸åªæ˜¯ç®€å•è½®è¯¢ï¼Œå®ƒæ˜¯æ•´ä¸ªæœåŠ¡ç¨³å®šæ€§çš„æ ¸å¿ƒç»„ä»¶ã€‚\n2. Upstream æœ€ä½³ç»“æ„ï¼ˆkeepalive + health check + retryï¼‰ upstream backend { least_conn; server 10.0.0.1:8000 max_fails=3 fail_timeout=30s; server 10.0.0.2:8000 max_fails=3 fail_timeout=30s; keepalive 50; # â­ å¿…å¼€ï¼šå‡å°‘åç«¯è¿æ¥å¼€é”€ } æ¨èç®—æ³•ï¼š\nä¼˜å…ˆ least_connï¼ˆé¿å…æ…¢èŠ‚ç‚¹æ‹–ç´¯ç³»ç»Ÿï¼‰ã€‚\nä¸ºä»€ä¹ˆä¸ç”¨é»˜è®¤ round robinï¼Ÿ\n-\u0026gt; ä¼šæŠŠè¯·æ±‚åˆ†ç»™æ­£åœ¨å¡ä½çš„èŠ‚ç‚¹ã€‚ 3. å¿…é¡»å¯ç”¨ proxy_next_upstreamï¼ˆé‡è¯•ï¼‰é¿å…é›ªå´© proxy_next_upstream error timeout http_500 http_502 http_503 http_504; proxy_next_upstream_tries 3; ä½œç”¨ï¼š\nå½“èŠ‚ç‚¹å¤±è´¥ -\u0026gt; è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª é¿å…å› ä¸ºå•ä¸ªèŠ‚ç‚¹å¡æ­»å¯¼è‡´æ•´ç«™å´©æºƒ API åœºæ™¯å¿…å¤‡ ä¼ä¸šçº§æ•‘å‘½é…ç½®ã€‚\n4. è¶…æ—¶ï¼ˆtimeoutï¼‰ä¸€å®šè¦æ¿€è¿› proxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; æœ€ä½³å®è·µï¼š\nConnect å±‚å¿…é¡»çŸ­ï¼ˆ3 ç§’å†…è¿ä¸ä¸Šå°±æ˜¯æ•…éšœï¼‰ Read/Send å¯é•¿ï¼ˆä¸šåŠ¡éœ€è¦ï¼‰ è¿™ç›´æ¥å†³å®šç³»ç»Ÿæ˜¯å¦èƒ½å¿«é€Ÿå‰”é™¤åèŠ‚ç‚¹ã€‚\n5. å¼€å¯ HTTP/1.1 + Connection ä¼˜åŒ–ï¼ˆæ€§èƒ½é£è·ƒï¼‰ proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; ä¸ºä»€ä¹ˆå¿…é¡»ï¼š\næ—  Connection: close ä¸æ–­å¼€ TCP è¿æ¥ æé«˜ 2~5 å€ååï¼ˆç‰¹åˆ«æ˜¯çŸ­è¿æ¥ APIï¼‰ Nginx å®˜æ–¹æ¨èã€‚\n6. ä½¿ç”¨ weight è®©é«˜æ€§èƒ½èŠ‚ç‚¹åˆ†é…æ›´é«˜æµé‡ server 10.0.0.1 weight=5; server 10.0.0.2 weight=1; é«˜ CPUã€é«˜å†…å­˜æœºå™¨ -\u0026gt; ç»™æ›´å¤š weightã€‚\nä¸è¦æŠŠå¼±èŠ‚ç‚¹å½“å¹³ç­‰èŠ‚ç‚¹ï¼Œå¦åˆ™æ‹–å®æ•´ä¸ªé›†ç¾¤ã€‚\n7. ä½¿ç”¨ backup èŠ‚ç‚¹åšå®¹ç¾ server 10.0.0.3 backup; ä¸»èŠ‚ç‚¹å…¨æŒ‚æ‰å¯ç”¨ã€‚\né€‚ç”¨äºï¼š\nä½é…å¤‡ç”¨æœº ä¸´æ—¶ç»´æŠ¤ è‡ªåŠ¨æ•…éšœè½¬ç§» 8. Session ç²˜æ€§ä¸è¦ç”¨ ip_hashï¼ˆç§»åŠ¨ç½‘ç»œä¸ç¨³å®šï¼‰ ä¸è¦ç”¨ï¼š\nip_hash; å› ä¸ºï¼š\næ‰‹æœºç”¨æˆ·é¢‘ç¹æ¢ IP ä¼šè¯ä¸¢å¤±ä¸¥é‡ åŸºæœ¬ä¸é€‚ç”¨äºçœŸå®ä¸šåŠ¡ æ¨èï¼š\n8.1 ä½¿ç”¨ stickyï¼ˆcookieï¼‰ sticky cookie srv_id expires=1h path=/; 8.2 æˆ–ä½¿ç”¨ Redis Session / JWTï¼ˆæœ€æ¨èï¼‰ è®© session ä¸èŠ‚ç‚¹è§£è€¦ï¼Œè´Ÿè½½å‡è¡¡æ›´è‡ªç”±ã€‚\n9. é¿å…æ…¢èŠ‚ç‚¹æ‹–ç´¯ â€” slow_start å¿…é¡»å¼€ï¼ˆå•†ä¸šç‰ˆï¼‰ å•†ä¸šç‰ˆï¼š\nslow_start 30s; æ–°èŠ‚ç‚¹ä¸Šçº¿ -\u0026gt; å¹³æ»‘æ¥ç®¡è¯·æ±‚ é¿å…æ–°å®ä¾‹åˆšå¯åŠ¨è¢«æµé‡æ‰“çˆ†ã€‚ å¼€æºç‰ˆï¼šæ²¡æœ‰ slow_startï¼Œåªèƒ½æ‰‹åŠ¨è®¾ç½® weightã€‚\n10. é”™è¯¯é¡µé¢ä¸è¦å‘ upstream æ³„éœ² proxy_intercept_errors on; error_page 500 502 503 504 /50x.html; é¿å…ï¼š\næ³„éœ²åç«¯æœåŠ¡å™¨ä¿¡æ¯ è®©ç”¨æˆ·çœ‹åˆ°ä¸€å † 502/504 11. ä¸ºæ¯ä¸ª upstream è®¾ç½® keepaliveï¼ˆå¼ºåˆ¶å¿…é¡»ï¼‰ keepalive 50; å¼€äº† keepaliveï¼š\nåç«¯å‹åŠ›éª¤é™ å»¶è¿Ÿé™ä½å‡ åæ¯«ç§’ ååé‡æ˜¾è‘—æå‡ ç‰¹åˆ«é€‚åˆçŸ­è¿æ¥ APIï¼ˆFastAPIã€Goã€Nodeï¼‰ 12. å¤šä¸ª upstream -\u0026gt; åˆ†æ¨¡å—éƒ¨ç½²ï¼Œé¿å…å·¨å¤§ Upstream é¿å…è¿™æ ·ï¼š\none huge upstream with 30 nodes æœ€ä½³å®è·µï¼šæŒ‰ä¸šåŠ¡æ‹†åˆ†ï¼š\nupstream user_api { ... } upstream order_api { ... } upstream file_api { ... } ä¼˜ç‚¹ï¼š\næ•…éšœéš”ç¦» æ€§èƒ½éš”ç¦» æ˜“ç»´æŠ¤ æ”¯æŒç°åº¦å‘å¸ƒ 13. å¯ç”¨ç°åº¦å‘å¸ƒï¼ˆç”Ÿäº§å¯æ§å‘å¸ƒï¼‰ map $cookie_gray $upstream { 1 backend_gray; default backend; } location / { proxy_pass http://$upstream; } æ•ˆæœï¼š\nç°åº¦ç”¨æˆ·è®¿é—®ç°åº¦ upstream æ­£å¸¸ç”¨æˆ·è®¿é—®ç”Ÿäº§ upstream ä¸å½±å“å…¨éƒ¨æµé‡ çº¿ä¸Šå¯æ§ 14. å¯ç”¨ Nginx stream åš 4 å±‚ LBï¼ˆTCP/UDPï¼‰ é€‚ç”¨äºï¼š\nMySQL Redis PostgreSQL MQTT è‡ªå®šä¹‰ TCP åè®® ç¤ºä¾‹ï¼š\nstream { upstream mysql_cluster { server 10.0.0.1:3306 max_fails=3 fail_timeout=30s; server 10.0.0.2:3306 max_fails=3 fail_timeout=30s; } server { listen 3306; proxy_pass mysql_cluster; } } 15. æ€»è§ˆï¼šç”Ÿäº§æ¨èæœ€ä½³ç»„åˆï¼ˆé€šç”¨ç‰ˆï¼‰ upstream backend { least_conn; server 10.0.0.1:8000 max_fails=3 fail_timeout=30s; server 10.0.0.2:8000 max_fails=3 fail_timeout=30s; keepalive 50; } server { listen 80; proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_next_upstream error timeout http_500 http_502 http_503 http_504; proxy_next_upstream_tries 2; proxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; location / { proxy_pass http://backend; } } è¿™æ˜¯ 99% å…¬å¸éƒ½åœ¨ç”¨çš„ç”Ÿäº§çº§ LB æœ€ä½³é…ç½®ã€‚\n16. æ€»ç»“ï¼šçœŸæ­£çš„æœ€ä½³å®è·µ least_conn \u0026gt;= round robin å¯ç”¨ keepalive aggressive connect timeoutï¼ˆ3sï¼‰ è‡ªåŠ¨é‡è¯•ï¼ˆproxy_next_upstreamï¼‰ å¯ç”¨æ€§ä¿éšœï¼ˆmax_fails / fail_timeoutï¼‰ é¿å… ip_hashï¼ˆç§»åŠ¨ç½‘ç»œé—®é¢˜ï¼‰ session ç”¨ Redis/JWT é€‚ç”¨åœºæ™¯é€‰æ‹©ä¸åŒ upstream ä½¿ç”¨å¤‡ä»½æœºå™¨æå‡é«˜å¯ç”¨ ä½¿ç”¨é”™è¯¯é¡µé¢éš”ç¦»åç«¯é”™è¯¯ ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ‹†åˆ†æ¨¡å— ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€ç®€æ´ä½†ä¸“ä¸šã€å¯ç›´æ¥è½åœ°çš„ã€ŠNginx è´Ÿè½½å‡è¡¡æœ€ä½³å®è·µã€‹ã€‚\nå†…å®¹å…¨æ˜¯ä¼ä¸šçœŸå®ç»éªŒæ€»ç»“ï¼Œæ³¨æ„äº‹é¡¹ã€å‘ç‚¹ã€è°ƒä¼˜éƒ½æœ‰ã€‚\n1. æ˜ç¡®ç›®æ ‡ï¼šé«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±• è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒç›®çš„ï¼š\nåˆ†æ‘Šæµé‡ï¼Œé¿å…å•æœºç“¶é¢ˆ é¿å…é›ªå´©æ•ˆåº”ï¼ˆä¸€ä¸ªèŠ‚ç‚¹æŒ‚æ‰å¯¼è‡´å…¨éƒ¨å¡æ­»ï¼‰ ä¿è¯æœåŠ¡å¯æ‰©å±• æå‡ååä¸ç¨³å®šæ€§ **åŠ¡å¿…è®°ä½ï¼š**LB ä¸åªæ˜¯ç®€å•è½®è¯¢ï¼Œå®ƒæ˜¯æ•´ä¸ªæœåŠ¡ç¨³å®šæ€§çš„æ ¸å¿ƒç»„ä»¶ã€‚\n2. Upstream æœ€ä½³ç»“æ„ï¼ˆkeepalive + health check + retryï¼‰ upstream backend { least_conn; server 10.0.0.1:8000 max_fails=3 fail_timeout=30s; server 10.0.0.2:8000 max_fails=3 fail_timeout=30s; keepalive 50; # â­ å¿…å¼€ï¼šå‡å°‘åç«¯è¿æ¥å¼€é”€ } æ¨èç®—æ³•ï¼š\n"},{"id":346,"href":"/operations/nginx/upstream-core/","title":"Nginx è´Ÿè½½å‡è¡¡è¯¦è§£","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨ã€ä½“ç³»åŒ–ã€å¯ç›´æ¥è½åœ°çš„ã€ŠNginx è´Ÿè½½å‡è¡¡è¯¦è§£ã€‹ï¼Œä»åŸºç¡€ -\u0026gt; æœºåˆ¶ -\u0026gt; ç®—æ³• -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; ä¼šè¯ä¿æŒ -\u0026gt; æ€§èƒ½ä¼˜åŒ– -\u0026gt; å®æˆ˜é…ç½®ï¼Œå…¨éƒ¨è¦†ç›–ã€‚\nNginx çš„è´Ÿè½½å‡è¡¡ç”± upstream æ¨¡å—é©±åŠ¨ï¼Œç”¨äºæŠŠå®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°åç«¯å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼ˆupstream serversï¼‰ã€‚\n1. è´Ÿè½½å‡è¡¡çš„åŸºæœ¬ç»“æ„ http { upstream backend { server 10.0.0.1; server 10.0.0.2; } server { location / { proxy_pass http://backend; } } } 2. Nginx è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆ4 ä¸ªæ ¸å¿ƒ + 2 ä¸ªå¢å¼ºï¼‰ 2.1 round_robinï¼ˆé»˜è®¤ï¼‰ è½®è¯¢ï¼š\nupstream backend { server 10.0.0.1; server 10.0.0.2; } é€‚åˆï¼šåç«¯æ€§èƒ½ä¸€è‡´ã€æ—  session åœºæ™¯ã€‚\n2.2 weightï¼ˆæƒé‡ï¼‰ æŒ‰æ€§èƒ½åˆ†é…è´Ÿè½½ï¼š\nupstream backend { server 10.0.0.1 weight=5; server 10.0.0.2 weight=1; } CPU å¼ºçš„ç»™æ›´å¤š weightã€‚\n2.3 ip_hashï¼ˆæŒ‰å®¢æˆ·ç«¯ IP ç²˜æ€§ä¼šè¯ï¼‰ åŒä¸€ IP æ°¸è¿œè®¿é—®åŒä¸€åç«¯ï¼š\nupstream backend { ip_hash; server 10.0.0.1; server 10.0.0.2; } é€‚åˆï¼šåç«¯æœ‰ session ä½†ä¸æ”¯æŒå…±äº«ã€‚\nä¸é€‚åˆï¼šç§»åŠ¨ç½‘ç»œç”¨æˆ·ï¼ˆIP å˜åŠ¨é¢‘ç¹ï¼‰ã€‚\n2.4 least_connï¼ˆæœ€å°‘è¿æ¥ï¼‰ æŠŠè¯·æ±‚ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„èŠ‚ç‚¹ï¼š\nupstream backend { least_conn; server 10.0.0.1; server 10.0.0.2; } é€‚åˆï¼šè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§ã€‚\n2.5 hashï¼ˆè‡ªå®šä¹‰ keyï¼Œä¸€è‡´æ€§å“ˆå¸Œï¼‰ ï¼ˆéœ€è¦ nginx hash moduleï¼‰\nupstream backend { hash $request_uri consistent; server 10.0.0.1; server 10.0.0.2; } é€‚ç”¨äºï¼š\nå†…å®¹ç¼“å­˜ æ–‡ä»¶ä¸Šä¼ åˆ‡ç‰‡ A/B æµ‹è¯•ç²¾å‡†è·¯ç”± 2.6 least_timeï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ æŒ‰å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡åˆ†é…ï¼ˆæ›´æ™ºèƒ½ï¼‰ã€‚\n3. åç«¯æœåŠ¡å™¨é…ç½®å‚æ•°ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰ 3.1 max_fails + fail_timeoutï¼ˆå¤±è´¥é‡è¯•ï¼‰ server 10.0.0.1 max_fails=3 fail_timeout=30s; å«ä¹‰ï¼š\n30 ç§’å†…å¤±è´¥ 3 æ¬¡ -\u0026gt; è®¤ä¸ºè¯¥èŠ‚ç‚¹ down ä¸å†è½¬å‘ï¼Œç›´åˆ° fail_timeout åˆ°æœŸ 3.2 backupï¼ˆå¤‡ç”¨èŠ‚ç‚¹ï¼‰ upstream backend { server 10.0.0.1; server 10.0.0.2 backup; # åªæœ‰ä¸»éƒ½æŒ‚æ‰æ‰ç”¨å®ƒ } ç”¨äºï¼šç¾å¤‡ / ç¾éš¾åˆ‡æ¢\n3.3 downï¼ˆä¸´æ—¶ä¸‹çº¿æŸä¸ªèŠ‚ç‚¹ï¼‰ server 10.0.0.3 down; 4. å¥åº·æ£€æŸ¥ï¼ˆactive + passiveï¼‰ Nginx å¼€æºç‰ˆï¼šåªæœ‰è¢«åŠ¨æ£€æŸ¥ï¼ˆpassive health checkï¼‰\nå•†ä¸šç‰ˆï¼ˆPlusï¼‰ï¼šä¸»åŠ¨æ£€æŸ¥ï¼ˆactive health checkï¼‰\nè¢«åŠ¨å¥åº·æ£€æŸ¥ï¼ˆå…è´¹ç‰ˆï¼‰\nä¾èµ– upstream å‚æ•°ï¼š\nmax_fails fail_timeout ä¸€æ—¦è¯·æ±‚å¤±è´¥ï¼ˆè¶…æ—¶ã€é 200ï¼‰ï¼ŒNginx ä¼šè‡ªåŠ¨æ ‡è®°ä¸å¥åº·ã€‚\nä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰\nä½¿ç”¨ nginx_upstream_check_moduleï¼š\ncheck interval=3000 rise=2 fall=5 timeout=1000 type=http; check_http_send \u0026#34;GET /health HTTP/1.0\\r\\n\\r\\n\u0026#34;; check_http_expect_alive http_2xx http_3xx; 5. ä¼šè¯ä¿æŒï¼ˆSticky Sessionï¼‰ æ–¹æ³• 1: ip_hash ç®€å•ï¼Œä½†ä¸é è°±ï¼ˆç§»åŠ¨ IP ä¸ç¨³å®šï¼‰ã€‚\næ–¹æ³• 2: sticky æ¨¡å—ï¼ˆæ›´ä¸“ä¸šï¼‰ upstream backend { sticky cookie srv_id expires=1h path=/; server 10.0.0.1; server 10.0.0.2; } å®¢æˆ·ç«¯å¸¦ cookieï¼Œæ¯æ¬¡æ‰“åˆ°åŒä¸€åç«¯ã€‚\né€‚ç”¨äºï¼šç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€‚\næ–¹æ³• 3. è‡ªè¡Œå…±äº« sessionï¼ˆæœ€æ¨èï¼‰ Redis Session JWT æ•°æ®åº“å­˜å‚¨ -\u0026gt; Nginx è´Ÿè½½å‡è¡¡å°±å¯ä»¥éšä¾¿æ¢ç®—æ³•ã€‚\n6. Nginx è´Ÿè½½å‡è¡¡ + Keepaliveï¼ˆæé«˜æ€§èƒ½ï¼‰ å‡å°‘åç«¯è¿æ¥æŸè€—ï¼š\nupstream backend { server 127.0.0.1:9001; server 127.0.0.1:9002; keepalive 32; } é€‚åˆï¼šæœ‰å¤§é‡çŸ­è¿æ¥çš„ API æœåŠ¡\n7ï¼‰è´Ÿè½½å‡è¡¡ + è¶…æ—¶è®¾ç½®ï¼ˆé¿å…é›ªå´©ï¼‰ åœ¨ location ä¸­ï¼š\nproxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; proxy_next_upstream_tries 3; å¯è‡ªåŠ¨é‡è¯•ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé¿å…å•èŠ‚ç‚¹å¡æ­»å¯¼è‡´ç³»ç»Ÿé›ªå´©ã€‚\n8. è´Ÿè½½å‡è¡¡æ¶æ„è®¾è®¡æ¨¡å¼ å•å±‚ LB\nå®¢æˆ·ç«¯ -\u0026gt; Nginx -\u0026gt; åç«¯\né€‚ç”¨äºå°è§„æ¨¡æœåŠ¡ã€‚\nåŒå±‚ LBï¼ˆä¼ä¸šæ¨èï¼‰\nå¤–å±‚ï¼šDNS è½®è¯¢ / Cloud LB å†…å±‚ï¼šNginx upstream è´Ÿè½½å‡è¡¡ ä¼˜ç‚¹ï¼š\né¿å…å•ç‚¹æ•…éšœ å…¨çƒåŠ é€Ÿ æ›´å¥½çš„å¯æ‰©å±•æ€§ åŠ¨æ€æ³¨å†Œï¼ˆè‡ªåŠ¨å‘ç°ï¼‰\nä½¿ç”¨ consul + consul-template æˆ– OpenResty + Lua åšè‡ªåŠ¨æ›´æ–°ä¸Šæ¸¸èŠ‚ç‚¹ã€‚ 9. ç”Ÿäº§çº§å®Œæ•´ç¤ºä¾‹ï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰ è½®è¯¢ + å¥åº·æ£€æŸ¥ + è¶…æ—¶ + keepalive\nupstream backend { least_conn; server 10.0.0.1 max_fails=3 fail_timeout=30s; server 10.0.0.2 max_fails=3 fail_timeout=30s; keepalive 50; } server { listen 80; location / { proxy_http_version 1.1; proxy_set_header Connection \u0026#34;\u0026#34;; proxy_pass http://backend; proxy_connect_timeout 3s; proxy_send_timeout 30s; proxy_read_timeout 30s; proxy_next_upstream error timeout http_500 http_502 http_503 http_504; proxy_next_upstream_tries 3; } } è¿™æ˜¯å¤§éƒ¨åˆ†å…¬å¸ç”Ÿäº§ç¯å¢ƒç›´æ¥é‡‡ç”¨çš„æœ€ä½³ç»„åˆã€‚\n10. ä¸åŒåœºæ™¯æœ€ä½³é€‰æ‹© åœºæ™¯ æ¨èç®—æ³• åŸå›  æ™®é€šç½‘ç«™ã€å¾®æœåŠ¡ API least_conn åŠ¨æ€å‡è¡¡æœ€å¥½ ä¸Šä¼ ä¸‹è½½æœåŠ¡ hash $request_uri ä¸€è‡´æ€§å“ˆå¸Œé¿å…æ–­ç‚¹ å†…å®¹åˆ†å‘ã€ç¼“å­˜ç³»ç»Ÿ hash ç²¾å‡†è·¯ç”± åç«¯æ€§èƒ½ä¸ä¸€è‡´ weight æŒ‰æ€§èƒ½åˆ†é… æœ‰ session ä¸”ä¸å…±äº« sticky å¼ºåˆ¶ç»‘å®š ç§»åŠ¨ç”¨æˆ·å¤§é‡å˜ IP âŒ ä¸æ¨è ip_hash ç²˜æ€§ä¸å¯é  ä¸æƒ³ç®¡ session JWT / Redis æœ€ç¨³å®š ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨ã€ä½“ç³»åŒ–ã€å¯ç›´æ¥è½åœ°çš„ã€ŠNginx è´Ÿè½½å‡è¡¡è¯¦è§£ã€‹ï¼Œä»åŸºç¡€ -\u0026gt; æœºåˆ¶ -\u0026gt; ç®—æ³• -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; ä¼šè¯ä¿æŒ -\u0026gt; æ€§èƒ½ä¼˜åŒ– -\u0026gt; å®æˆ˜é…ç½®ï¼Œå…¨éƒ¨è¦†ç›–ã€‚\nNginx çš„è´Ÿè½½å‡è¡¡ç”± upstream æ¨¡å—é©±åŠ¨ï¼Œç”¨äºæŠŠå®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°åç«¯å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼ˆupstream serversï¼‰ã€‚\n1. è´Ÿè½½å‡è¡¡çš„åŸºæœ¬ç»“æ„ http { upstream backend { server 10.0.0.1; server 10.0.0.2; } server { location / { proxy_pass http://backend; } } } 2. Nginx è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆ4 ä¸ªæ ¸å¿ƒ + 2 ä¸ªå¢å¼ºï¼‰ 2.1 round_robinï¼ˆé»˜è®¤ï¼‰ è½®è¯¢ï¼š\n"},{"id":347,"href":"/operations/nginx/high-concurrency/","title":"Nginx é«˜å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆ","parent":"Nginx","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£èƒ½è½åœ°çš„ã€ŠNginx é«˜å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆï¼ˆç”Ÿäº§çº§ï¼‰ã€‹ï¼Œä¸æ˜¯ç©ºæ´ç†è®ºï¼Œæ˜¯åœ¨é«˜ QPSã€æµ·é‡è¿æ¥æ—¶å¿…é¡»åšçš„è°ƒä¼˜ç‚¹ã€‚\nâ­ æ€»ä½“ç›®æ ‡\nè®© Nginx åœ¨é«˜å¹¶å‘ä¸‹ï¼š\næ›´å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ æ›´å°‘è¿æ¥é˜»å¡ æ›´é«˜ååé‡ æ›´ä½å»¶è¿Ÿ æ›´èŠ‚çœ CPU/å†…å­˜ ä»¥ä¸‹ä¼˜åŒ–é¡¹å…¨éƒ¨ç»å®æˆ˜éªŒè¯ã€‚\n1. è¿›ç¨‹æ•°ä¼˜åŒ–ï¼ˆworker_processesï¼‰ æœ€ä½³å®è·µï¼šç­‰äº CPU æ ¸å¿ƒæ•°\nworker_processes auto; Nginx æ¯ä¸ª worker å•çº¿ç¨‹ + äº‹ä»¶é©±åŠ¨\n1 worker å¯¹ 1 æ ¸å¿ƒæ•ˆç‡æœ€é«˜ã€‚ 2. è¿æ¥æ•°ä¼˜åŒ–ï¼ˆworker_connectionsï¼‰ é»˜è®¤ 1024 è¿œè¿œä¸å¤Ÿï¼Œå¹¶å‘é«˜æ—¶ç›´æ¥çˆ†ã€‚\næ¨è 20kâ€“50kï¼ˆå–å†³äº fd limitï¼‰\nworker_rlimit_nofile 200000; events { worker_connections 65535; use epoll; multi_accept on; } åŸç†:\nepollï¼šæœ€ä½³äº‹ä»¶æ¨¡å‹ï¼ˆLinuxï¼‰ multi_acceptï¼šä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥ï¼Œå‡å°‘å†…æ ¸ wakeup æ•°é‡ 3. TCP å†…æ ¸è°ƒä¼˜ï¼ˆå¿…é¡»ï¼‰ ä¿®æ”¹ /etc/sysctl.confï¼š\n# TIME_WAIT å¿«é€Ÿå›æ”¶ net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_tw_recycle = 0 # é¿å… NAT è®¾å¤‡é—®é¢˜ net.ipv4.tcp_fin_timeout = 15 # Backlog é˜Ÿåˆ—æ›´å¤§ï¼ˆé»˜è®¤å°ï¼‰ net.core.somaxconn = 65535 net.core.netdev_max_backlog = 65535 net.ipv4.tcp_max_syn_backlog = 65535 # ä¿æŒé•¿è¿æ¥æ€§èƒ½ net.ipv4.tcp_keepalive_time = 300 net.ipv4.tcp_keepalive_intvl = 20 net.ipv4.tcp_keepalive_probes = 3 # ç«¯å£å¤ç”¨ net.ipv4.ip_local_port_range = 1024 65535 åº”ç”¨ï¼š\nsysctl -p 4. å¼€å¯ Nginx è‡ªèº«æ€§èƒ½ä¼˜åŒ– 4.1 å¯ç”¨ sendfileï¼ˆé™æ€èµ„æºæå‡æ•°å€ï¼‰ sendfile on; tcp_nopush on; tcp_nodelay on; 4.2 å¯ç”¨ keepaliveï¼Œå‡å°‘ TCP å»ºè¿ ä¸Šæ¸¸ keepalive\nupstream api { server 10.0.0.1:8000; server 10.0.0.2:8000; keepalive 128; } å®¢æˆ·ç«¯ keepalive\nkeepalive_timeout 65; keepalive_requests 10000; 5. å¼€å¯ç¼“å­˜ï¼ˆå¤§å¹…å‡å°‘ä¸Šæ¸¸å‹åŠ›ï¼‰ é€‚åˆé™æ€èµ„æºã€APIã€åä»£æœåŠ¡ï¼š\nproxy_cache_path /data/nginx/cache levels=1:2 keys_zone=mycache:200m inactive=7d max_size=20g; location / { proxy_cache mycache; proxy_cache_valid 200 1m; } é«˜å¹¶å‘åœºæ™¯ç¼“å­˜æ˜¯æ ¸å¿ƒâ€”â€”å‡å°‘åç«¯åå 50%â€“90%ã€‚\n6. ä¼˜åŒ– buffer ä¸è¶…æ—¶ï¼ˆé˜²æ­¢é˜»å¡ workerï¼‰ client_body_buffer_size 128k; client_header_buffer_size 4k; large_client_header_buffers 4 32k; proxy_buffers 8 16k; proxy_busy_buffers_size 64k; proxy_buffering on; send_timeout 30s; é¿å…ï¼š\nrequest å¤´è¿‡å¤§ï¼ˆæ”»å‡»é£é™©ï¼‰ ä»£ç†é˜»å¡ worker å¡ä½ 7. è´Ÿè½½å‡è¡¡ç­–ç•¥ä¼˜åŒ– é•¿è¿æ¥æœåŠ¡ï¼šæ¨è least_conn\nupstream backend { least_conn; server 10.0.0.1:8000; server 10.0.0.2:8000; } æ— çŠ¶æ€æœåŠ¡ï¼šæ¨è round_robinï¼ˆé»˜è®¤ï¼‰\næœ‰ Sessionï¼šæ¨è ip_hash\n8. å¼€å¯ HTTP/2ï¼ˆæå‡å¹¶å‘ä¸æ€§èƒ½ï¼‰ listen 443 ssl; http2 on; # ä½ ç‰¹åˆ«å¼ºè°ƒè¿‡ï¼Œå·²æ­£ç¡®é…ç½® å¥½å¤„ï¼š\nä¸€ä¸ª TCP è¿æ¥å¤šè·¯å¤ç”¨ æ›´å°‘çš„å¹¶å‘è¿æ¥æ•° æ›´ä½å»¶è¿Ÿ å¯¹é™æ€ç½‘ç«™å’Œå‰ç«¯ç‰¹åˆ«æœ‰æ•ˆã€‚\nâ¸»\nä½¿ç”¨é›¶æ‹·è´ sendfile + gzip å¹¶å­˜ä¼˜åŒ– Nginx é»˜è®¤ gzip ä¼šç¦ç”¨ sendfile\nğŸ‘‰ æœ€ä½³å®è·µï¼š\ngzip on; gzip_static on;\ngzip_static ç›´æ¥è¿”å› .gz æ–‡ä»¶ -\u0026gt; é¿å… CPU å‹ç¼©å¼€é”€ã€‚\n10. æ—¥å¿—ä¼˜åŒ–ï¼ˆé«˜å¹¶å‘ä¼šç›´æ¥å½±å“æ€§èƒ½ï¼‰ åœ¨é«˜å¹¶å‘æ—¶ï¼Œå…³é—­ access_log æˆ–ç”¨ç¼“å­˜å†™æ³•ï¼š\naccess_log /var/log/nginx/access.log main buffer=512k flush=1s; ç”šè‡³ç¦ç”¨\naccess_log off; 11. é™åˆ¶ CC / æ´ªæ°´æ”»å‡»ï¼ˆå¿…é¡»å¯ç”¨ï¼‰ limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s; location /api/ { limit_req zone=req_limit burst=20 nodelay; } èƒ½ç›´æ¥æ‹¦æˆª 80% ä½æˆæœ¬æ”»å‡»ã€‚\n12. ä½¿ç”¨æ›´å¼ºåŠ å¯†ç®—æ³•ï¼ˆå‡å°‘ CPUï¼‰ ssl_protocols TLSv1.2 TLSv1.3; ssl_ciphers HIGH:!aNULL:!MD5; ssl_session_cache shared:SSL:20m; ssl_session_timeout 10m; ssl_prefer_server_ciphers on; ssl_session_tickets on; TLS ä¼šæ¶ˆè€— CPUï¼Œsession cache / ticket èƒ½é™ä½å‹åŠ›ã€‚\n13. å¤šæœºéƒ¨ç½²çš„é«˜å¯ç”¨æ¶æ„ æœ€ä½³æ¶æ„ï¼š\n[ Keepalived / VIP ] | ----------------- | | [Nginx #1] [Nginx #2] | | ----------------- | [Backend cluster] æä¾›ï¼š\nVIP è‡ªåŠ¨æ¼‚ç§» å‰ç«¯æ— æ„Ÿåˆ‡æ¢ åç«¯é«˜å¯ç”¨è´Ÿè½½å‡è¡¡ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£èƒ½è½åœ°çš„ã€ŠNginx é«˜å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆï¼ˆç”Ÿäº§çº§ï¼‰ã€‹ï¼Œä¸æ˜¯ç©ºæ´ç†è®ºï¼Œæ˜¯åœ¨é«˜ QPSã€æµ·é‡è¿æ¥æ—¶å¿…é¡»åšçš„è°ƒä¼˜ç‚¹ã€‚\nâ­ æ€»ä½“ç›®æ ‡\nè®© Nginx åœ¨é«˜å¹¶å‘ä¸‹ï¼š\næ›´å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ æ›´å°‘è¿æ¥é˜»å¡ æ›´é«˜ååé‡ æ›´ä½å»¶è¿Ÿ æ›´èŠ‚çœ CPU/å†…å­˜ ä»¥ä¸‹ä¼˜åŒ–é¡¹å…¨éƒ¨ç»å®æˆ˜éªŒè¯ã€‚\n1. è¿›ç¨‹æ•°ä¼˜åŒ–ï¼ˆworker_processesï¼‰ æœ€ä½³å®è·µï¼šç­‰äº CPU æ ¸å¿ƒæ•°\nworker_processes auto; Nginx æ¯ä¸ª worker å•çº¿ç¨‹ + äº‹ä»¶é©±åŠ¨\n1 worker å¯¹ 1 æ ¸å¿ƒæ•ˆç‡æœ€é«˜ã€‚ 2. è¿æ¥æ•°ä¼˜åŒ–ï¼ˆworker_connectionsï¼‰ é»˜è®¤ 1024 è¿œè¿œä¸å¤Ÿï¼Œå¹¶å‘é«˜æ—¶ç›´æ¥çˆ†ã€‚\n"},{"id":348,"href":"/operations/NetworkManager/nmcli/","title":"nmcli","parent":"NetworkManager","content":"è®¾ç½®ä¸»æœºåå’Œ IP\n# è®¾ç½®ä¸»æœºå hostnamectl hostname node-201.server.com # è®¾ç½® IP nmcli connection modify enp1s0 \\ ipv4.method manual \\ ipv4.addresses 192.168.101.201/24 \\ ipv4.gateway 192.168.101.1 \\ ipv4.dns \u0026#34;114.114.114.114 8.8.8.8\u0026#34; # å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ nmcli connection modify enp1s0 autoconnect yes # å¿½ç•¥ IPv6 (ä¸è¦ä½¿ç”¨ disabled) nmcli connection modify enp1s0 ipv6.method ignore # é‡å¯ç½‘ç»œ systemctl restart NetworkManager # é€€å‡º SSH, ä½¿ç”¨æ–° IP é‡æ–° SSH # æŸ¥çœ‹ IP åœ°å€ ip addr # æ¸…ç† IP åœ°å€ nmcli connection up enp1s0 # æŸ¥çœ‹ IP åœ°å€ ip addr # æŸ¥çœ‹é…ç½® cat /etc/NetworkManager/system-connections/enp1s0.nmconnection DHCP é…ç½®\n# æŸ¥çœ‹è¿æ¥ nmcli connection show # æŸ¥çœ‹è¿æ¥é…ç½® cat /etc/NetworkManager/system-connections/enp1s0.nmconnection # è®¾ç½® DHCP å¹¶æ¸…ç†æ‰‹åŠ¨é…ç½® nmcli connection modify enp1s0 ipv4.method auto ipv4.addresses \u0026#34;\u0026#34; ipv4.gateway \u0026#34;\u0026#34; ipv4.dns \u0026#34;\u0026#34; # é‡å¯ç½‘ç»œ nmcli connection up enp1s0 # æŸ¥çœ‹è¿æ¥é…ç½® cat /etc/NetworkManager/system-connections/enp1s0.nmconnection ","description":"è®¾ç½®ä¸»æœºåå’Œ IP\n# è®¾ç½®ä¸»æœºå hostnamectl hostname node-201.server.com # è®¾ç½® IP nmcli connection modify enp1s0 \\ ipv4.method manual \\ ipv4.addresses 192.168.101.201/24 \\ ipv4.gateway 192.168.101.1 \\ ipv4.dns \u0026#34;114.114.114.114 8.8.8.8\u0026#34; # å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ nmcli connection modify enp1s0 autoconnect yes # å¿½ç•¥ IPv6 (ä¸è¦ä½¿ç”¨ disabled) nmcli connection modify enp1s0 ipv6.method ignore # é‡å¯ç½‘ç»œ systemctl restart NetworkManager # é€€å‡º SSH, ä½¿ç”¨æ–° IP é‡æ–° SSH # æŸ¥çœ‹ IP åœ°å€ ip addr # æ¸…ç† IP åœ°å€ nmcli connection up enp1s0 # æŸ¥çœ‹ IP åœ°å€ ip addr # æŸ¥çœ‹é…ç½® cat /etc/NetworkManager/system-connections/enp1s0.nmconnection DHCP é…ç½®\n"},{"id":349,"href":"/management/operations/","title":"Operations","parent":"Management","content":"Document List:\nIT è¿ç»´ç®¡ç† ITè¿ç»´ç®¡ç†ï¼šä½“ç³»åŒ–æ¼”è¿›ä¸ä»·å€¼åˆ›é€  å‘å¸ƒç³»ç»Ÿ å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒæ¶æ„è®¾è®¡ä¸å®ç° å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒç­–ç•¥ å‘å¸ƒç³»ç»Ÿï¼šæ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰ å‘å¸ƒç³»ç»Ÿï¼šç°åº¦å‘å¸ƒï¼ˆGray Deploymentï¼‰ å‘å¸ƒç³»ç»Ÿï¼šè“ç»¿å‘å¸ƒï¼ˆBlue-Green Deploymentï¼‰ å‘å¸ƒç³»ç»Ÿï¼šé‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deploymentï¼‰ æ•…éšœæ’æŸ¥æ€è·¯ ","description":"Document List:\nIT è¿ç»´ç®¡ç† ITè¿ç»´ç®¡ç†ï¼šä½“ç³»åŒ–æ¼”è¿›ä¸ä»·å€¼åˆ›é€  å‘å¸ƒç³»ç»Ÿ å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒæ¶æ„è®¾è®¡ä¸å®ç° å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒç­–ç•¥ å‘å¸ƒç³»ç»Ÿï¼šæ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰ å‘å¸ƒç³»ç»Ÿï¼šç°åº¦å‘å¸ƒï¼ˆGray Deploymentï¼‰ å‘å¸ƒç³»ç»Ÿï¼šè“ç»¿å‘å¸ƒï¼ˆBlue-Green Deploymentï¼‰ å‘å¸ƒç³»ç»Ÿï¼šé‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deploymentï¼‰ æ•…éšœæ’æŸ¥æ€è·¯ "},{"id":350,"href":"/backend/python/orjson/","title":"orjson","parent":"Python","content":"å‚è€ƒæ–‡æ¡£:\nå®˜æ–¹æ–‡æ¡£ Directory List:\norjson åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ ","description":"å‚è€ƒæ–‡æ¡£:\nå®˜æ–¹æ–‡æ¡£ Directory List:\norjson åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ "},{"id":351,"href":"/backend/python/official/os/","title":"OS åº“","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/os.html\nos æ˜¯ Python è¿›è¡Œ æ–‡ä»¶æ“ä½œã€è·¯å¾„æ“ä½œã€è¿›ç¨‹ç®¡ç†ã€ç¯å¢ƒå˜é‡ çš„æ ¸å¿ƒåº“ä¹‹ä¸€ã€‚\n1. è·¯å¾„ç›¸å…³ï¼ˆos.pathï¼‰ import os 1.1 åˆ¤æ–­è·¯å¾„ åŠŸèƒ½ æ–¹æ³• æ˜¯å¦å­˜åœ¨ os.path.exists(path) æ˜¯å¦æ–‡ä»¶ os.path.isfile(path) æ˜¯å¦ç›®å½• os.path.isdir(path) 1.2 è·¯å¾„æ‹¼æ¥ os.path.join(a, b, c) é¿å…æ‰‹å†™ /ï¼Œè·¨å¹³å°æœ€ä½³æ–¹æ³•ã€‚\n1.3 è·å–ç›®å½•å / æ–‡ä»¶å / æ‰©å±•å os.path.dirname(path) # ç›®å½• os.path.basename(path) # æ–‡ä»¶å os.path.splitext(path) # (\u0026#39;a.txt\u0026#39;, \u0026#39;.txt\u0026#39;) 1.4 ç»å¯¹è·¯å¾„ / è§„èŒƒåŒ–è·¯å¾„ os.path.abspath(path) os.path.realpath(path) os.path.normpath(path) 2. æ–‡ä»¶æ“ä½œ 2.1 åˆ›å»ºæ–‡ä»¶ open(\u0026#34;file.txt\u0026#34;, \u0026#34;w\u0026#34;).close() 2.2 åˆ é™¤æ–‡ä»¶ os.remove(\u0026#34;file.txt\u0026#34;) 2.3 é‡å‘½å / ç§»åŠ¨æ–‡ä»¶ os.rename(\u0026#34;old.txt\u0026#34;, \u0026#34;new.txt\u0026#34;) 2.4 è·å–æ–‡ä»¶å¤§å° os.path.getsize(\u0026#34;file.txt\u0026#34;) 3. ç›®å½•æ“ä½œ 3.1 åˆ›å»ºç›®å½• os.mkdir(\u0026#34;folder\u0026#34;) # å•å±‚ç›®å½• os.makedirs(\u0026#34;a/b/c\u0026#34;, exist_ok=True) # å¤šå±‚ç›®å½• 3.2 åˆ é™¤ç›®å½• os.rmdir(\u0026#34;folder\u0026#34;) # å¿…é¡»ç©ºç›®å½• os.removedirs(\u0026#34;a/b/c\u0026#34;) # é€çº§åˆ é™¤ç©ºç›®å½• 3.3 åˆ—å‡ºç›®å½•å†…å®¹ os.listdir(\u0026#34;.\u0026#34;) 3.4 éå†ç›®å½•ï¼ˆwalkï¼‰ ğŸ‘‘ æ–‡ä»¶æ‰«æå’Œé€’å½’éå†çš„æœ€å¼ºæ–¹æ³•\nfor root, dirs, files in os.walk(\u0026#34;.\u0026#34;): print(root, dirs, files) 4. ç¯å¢ƒå˜é‡ï¼ˆENVï¼‰ 4.1 è·å–ç¯å¢ƒå˜é‡ os.getenv(\u0026#34;PATH\u0026#34;) 4.2 è®¾ç½®ç¯å¢ƒå˜é‡ os.environ[\u0026#34;DEBUG\u0026#34;] = \u0026#34;1\u0026#34; 4.3 éå†æ‰€æœ‰ç¯å¢ƒå˜é‡ os.environ 5. è¿›ç¨‹æ“ä½œï¼ˆprocessï¼‰ 5.1 è·å– PID os.getpid() 5.2 è·å–çˆ¶è¿›ç¨‹ PID os.getppid() 5.3 å¯åŠ¨ç³»ç»Ÿå‘½ä»¤ os.system(\u0026#34;ls -l\u0026#34;) âš ï¸ ä¸æ¨èæ‰§è¡Œå¤æ‚å‘½ä»¤ï¼Œå»ºè®®ä½¿ç”¨ subprocessã€‚\n5.4 é€€å‡ºç¨‹åº os._exit(0) 6. å·¥ä½œç›®å½•ï¼ˆcwdï¼‰ 6.1 è·å–å½“å‰ç›®å½• os.getcwd() 6.2 åˆ‡æ¢ç›®å½• os.chdir(\u0026#34;/path/to/dir\u0026#34;) 7. æƒé™å’Œç”¨æˆ·ç»„ï¼ˆUnixï¼‰ 7.1 æ›´æ”¹æƒé™ï¼ˆchmodï¼‰ os.chmod(path, 0o755) 7.2 æ›´æ”¹æ‰€æœ‰è€… os.chown(path, uid, gid) 7.3 æ–‡ä»¶ stat ä¿¡æ¯ os.stat(path) 8. éšæœºæ•°ï¼ˆå®‰å…¨éšæœºï¼‰ os.urandom(16) é€‚åˆç”¨äºç”Ÿæˆå¯†é’¥ã€Tokenã€‚\n9. å¸¸è§ç»„åˆç¤ºä¾‹ 9.1 é€’å½’åˆ é™¤æ‰€æœ‰ .log æ–‡ä»¶ import os for root, dirs, files in os.walk(\u0026#34;.\u0026#34;): for name in files: if name.endswith(\u0026#34;.log\u0026#34;): os.remove(os.path.join(root, name)) 9.2 éå†ç›®å½•å¹¶ç»Ÿè®¡æ–‡ä»¶å¤§å° total = 0 for root, dirs, files in os.walk(\u0026#34;.\u0026#34;): for f in files: total += os.path.getsize(os.path.join(root, f)) print(\u0026#34;Total size:\u0026#34;, total) 9.3 è¯»å– ENV + é»˜è®¤å€¼ DEBUG = os.getenv(\u0026#34;DEBUG\u0026#34;, \u0026#34;false\u0026#34;).lower() == \u0026#34;true\u0026#34; 9.4 è‡ªåŠ¨åˆ›å»ºç›®å½•ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰ path = \u0026#34;data/output\u0026#34; os.makedirs(path, exist_ok=True) 10. æ€»ç»“ï¼ˆæŒæ¡è¿™äº›å°±å¤Ÿç”¨äº†ï¼‰ åˆ†ç±» åŠŸèƒ½ å¸¸ç”¨æ–¹æ³• è·¯å¾„å¤„ç† æ‹¼æ¥ / è§£æè·¯å¾„ join basename dirname splitext æ–‡ä»¶æ“ä½œ åˆ›å»º / åˆ é™¤ / é‡å‘½å remove rename ç›®å½•æ“ä½œ åˆ›å»º / åˆ é™¤ / éå† mkdir makedirs listdir walk ç¯å¢ƒå˜é‡ è·å– / è®¾ç½® getenv environ å·¥ä½œç›®å½• è·å– / åˆ‡æ¢ getcwd chdir è¿›ç¨‹æ“ä½œ PIDï¼Œæ‰§è¡Œå‘½ä»¤ getpid system æƒé™ chmod / chown chmod chown ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/os.html\nos æ˜¯ Python è¿›è¡Œ æ–‡ä»¶æ“ä½œã€è·¯å¾„æ“ä½œã€è¿›ç¨‹ç®¡ç†ã€ç¯å¢ƒå˜é‡ çš„æ ¸å¿ƒåº“ä¹‹ä¸€ã€‚\n1. è·¯å¾„ç›¸å…³ï¼ˆos.pathï¼‰ import os 1.1 åˆ¤æ–­è·¯å¾„ åŠŸèƒ½ æ–¹æ³• æ˜¯å¦å­˜åœ¨ os.path.exists(path) æ˜¯å¦æ–‡ä»¶ os.path.isfile(path) æ˜¯å¦ç›®å½• os.path.isdir(path) 1.2 è·¯å¾„æ‹¼æ¥ os.path.join(a, b, c) é¿å…æ‰‹å†™ /ï¼Œè·¨å¹³å°æœ€ä½³æ–¹æ³•ã€‚\n"},{"id":352,"href":"/backend/python/pandas/","title":"Pandas","parent":"Python","content":"å‚è€ƒæ–‡æ¡£:\nå®˜æ–¹æ–‡æ¡£ å°† pandas æ•°æ®ä¿å­˜åˆ° PostgreSQL æ•°æ®åº“:\nhttps://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_sql.html https://stackoverflow.com/a/23104436 Directory List:\n","description":"å‚è€ƒæ–‡æ¡£:\nå®˜æ–¹æ–‡æ¡£ å°† pandas æ•°æ®ä¿å­˜åˆ° PostgreSQL æ•°æ®åº“:\nhttps://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_sql.html https://stackoverflow.com/a/23104436 Directory List:\n"},{"id":353,"href":"/backend/python/playwright/","title":"Playwright","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£: https://playwright.dev/docs/intro\nDirectory List:\nPlaywright åŸºç¡€æ•™ç¨‹ ","description":"å®˜æ–¹æ–‡æ¡£: https://playwright.dev/docs/intro\nDirectory List:\nPlaywright åŸºç¡€æ•™ç¨‹ "},{"id":354,"href":"/operations/podman/","title":"Podman","parent":"Operations","content":"Documents List:\nPodman æ ¸å¿ƒæ¦‚å¿µ Podman systemd è„šæœ¬ä¼˜åŒ– ","description":"Documents List:\nPodman æ ¸å¿ƒæ¦‚å¿µ Podman systemd è„šæœ¬ä¼˜åŒ– "},{"id":355,"href":"/operations/podman/podman-systemd/","title":"Podman systemd è„šæœ¬ä¼˜åŒ–","parent":"Podman","content":"ä¼˜åŒ–ä»¥ä¸‹ systemd é…ç½®ï¼Œä½¿å…¶æ”¯æŒ systemctl enable podman@gitlab-ceï¼Œå³ podman@ åé¢çš„å‚æ•°æ”¯æŒ - ç¬¦å·\n[Unit] Description=%I container After=network-online.target Wants=network-online.target [Service] User=root Restart=always ExecStart=/usr/bin/podman start -a %I ExecStop=/usr/bin/podman stop -t 10 %I LimitCORE=infinity LimitMEMLOCK=infinity LimitNOFILE=infinity LimitNPROC=infinity TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target è¿™ä¸ªé—®é¢˜çš„å…³é”®ç‚¹ä¸åœ¨ Podmanï¼Œè€Œåœ¨ systemd å¯¹â€œå®ä¾‹åè½¬ä¹‰â€çš„æœºåˆ¶ã€‚\nç°åœ¨ç”¨çš„æ˜¯ é”™è¯¯çš„å ä½ç¬¦ï¼Œå¯¼è‡´å¸¦ - çš„å®ä¾‹åè¡Œä¸ºä¸ç¬¦åˆé¢„æœŸã€‚\nä¸‹é¢å…ˆç»™ç»“è®ºç‰ˆä¿®å¤ï¼Œå†è§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·æ”¹æ˜¯æ­£ç¡®çš„ã€‚\nä¸€ã€ç›´æ¥ç»™ã€Œå¯ç”¨ä¸”è§„èŒƒã€çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆâœ… æ”¯æŒ podman@gitlab-ceï¼‰ âœ… æ ¸å¿ƒæ”¹åŠ¨ç‚¹ æŠŠ %I æ”¹ä¸º %i é¡ºå¸¦è¡¥é½ Podman å®˜æ–¹æ¨èçš„ systemd é€‰é¡¹ âœ… ä¿®å¤å¹¶ä¼˜åŒ–åçš„ unit æ–‡ä»¶ [Unit] Description=Podman container %i After=network-online.target Wants=network-online.target [Service] Type=simple User=root Restart=always RestartSec=5 # ä½¿ç”¨ %iï¼ˆæœªè½¬ä¹‰å®ä¾‹åï¼Œæ”¯æŒ -ï¼‰ ExecStart=/usr/bin/podman start -a %i ExecStop=/usr/bin/podman stop -t 10 %i # èµ„æºä¸ç¨³å®šæ€§ LimitCORE=infinity LimitMEMLOCK=infinity LimitNOFILE=infinity LimitNPROC=infinity TasksMax=infinity OOMScoreAdjust=-999 # systemd / cgroup / podman åä½œå¿…å¤‡ KillMode=none Delegate=yes TimeoutStartSec=0 TimeoutStopSec=30 [Install] WantedBy=multi-user.target ç°åœ¨å¯ä»¥ç›´æ¥å¯ç”¨ï¼š\nsystemctl enable podman@gitlab-ce systemctl start podman@gitlab-ce äºŒã€ä¸ºä»€ä¹ˆåŸé…ç½®åœ¨ã€Œ-ã€è¿™é‡Œä¼šå‡ºé—®é¢˜ï¼Ÿ 1ï¸âƒ£ systemd çš„ %I vs %iï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰ å ä½ç¬¦ å«ä¹‰ æ˜¯å¦è½¬ä¹‰ %i åŸå§‹å®ä¾‹å âŒ ä¸è½¬ä¹‰ %I è½¬ä¹‰åçš„å®ä¾‹å âœ… ä¼šè½¬ä¹‰ systemd çš„è½¬ä¹‰è§„åˆ™ï¼ˆé‡ç‚¹ï¼‰ - -\u0026gt; \\x2d / -\u0026gt; - å…¶å®ƒç‰¹æ®Šå­—ç¬¦ -\u0026gt; åå…­è¿›åˆ¶ ä¹Ÿå°±æ˜¯è¯´ï¼š\npodman@gitlab-ce åœ¨ %I ä¸­ä¼šå˜æˆç±»ä¼¼ï¼š\ngitlab\\x2dce è€Œ Podman å¹¶ä¸å­˜åœ¨è¿™ä¸ªå®¹å™¨å ğŸ‘‰ å¯åŠ¨å¤±è´¥\n2ï¸âƒ£ æ­£ç¡®åŸåˆ™ï¼ˆä¸€å¥è¯è®°ä½ï¼‰ systemd æ¨¡æ¿ unitï¼š\nåªè¦å®ä¾‹åæœ¬èº«å°±æ˜¯â€œçœŸå®èµ„æºåâ€ï¼ˆå®¹å™¨åã€æœåŠ¡åï¼‰ï¼Œå°±å¿…é¡»ç”¨ %iï¼Œä¸è¦ç”¨ %I\nä¸‰ã€ä¸ºä»€ä¹ˆå¾ˆå¤šç¤ºä¾‹â€œè¯¯å¯¼æ€§åœ°ä½¿ç”¨ %Iâ€ï¼Ÿ åŸå› æ˜¯ï¼š\n%I é€‚åˆæ–‡ä»¶è·¯å¾„ / mount / device å %i é€‚åˆä¸šåŠ¡æ ‡è¯†ç¬¦ï¼ˆcontainer / service / appï¼‰ Podman å®¹å™¨åå±äº ä¸šåŠ¡æ ‡è¯†ç¬¦ï¼Œä¸æ˜¯è·¯å¾„ã€‚\nå››ã€é¢å¤–ä¼˜åŒ–è¯´æ˜ 1ï¸âƒ£ KillMode=noneï¼ˆå¿…é¡»ï¼‰ å¦åˆ™ systemd ä¼šï¼š\nç›´æ¥ kill æ‰ podman è¿›ç¨‹ å¯¼è‡´å®¹å™¨è¢«å¼‚å¸¸ç»ˆæ­¢ Podman å®˜æ–¹å¼ºçƒˆå»ºè®®å¼€å¯ã€‚\n2ï¸âƒ£ Delegate=yesï¼ˆå¿…é¡»ï¼‰ è®©ï¼š\nPodman systemd cgroups ä¸äº’ç›¸æŠ¢æ§åˆ¶æƒ\n3ï¸âƒ£ ä¸ºä»€ä¹ˆä¸éœ€è¦ Type=forking ExecStart=/usr/bin/podman start -a %i -a ä¼šå‰å°é™„ç€å®¹å™¨ stdout/stderr ğŸ‘‰ systemd æ­£ç¡®è¿½è¸ªä¸»è¿›ç¨‹ ğŸ‘‰ Type=simple æ˜¯æ­£ç¡®é€‰æ‹© äº”ã€éªŒè¯æ–¹å¼ï¼ˆå»ºè®®ä½ åšä¸€æ¬¡ï¼‰ systemctl start podman@gitlab-ce systemctl status podman@gitlab-ce ç¡®è®¤ï¼š\nå®¹å™¨æˆåŠŸå¯åŠ¨ Ctrl+C ä¸å½±å“ systemd ç®¡ç† reboot åè‡ªåŠ¨æ‹‰èµ· å…­ã€æœ€ç»ˆä¸€å¥è¯æ€»ç»“ï¼ˆç»™ä½ è®°ä½ï¼‰ systemd æ¨¡æ¿ unit ä¸­ï¼š\n%i ç”¨äºçœŸå®å®ä¾‹åï¼ˆå®¹å™¨åã€æœåŠ¡åï¼‰ï¼Œ\n%I åªç”¨äºéœ€è¦ systemd è½¬ä¹‰çš„è·¯å¾„ç±»å¯¹è±¡ã€‚\næ”¹æˆ rootless Podman ä¸“ç”¨ unit ä¸‹é¢æ˜¯ä¸€ä»½æ ‡å‡†ã€å¯é•¿æœŸä½¿ç”¨çš„ã€ŒRootless Podman ä¸“ç”¨ systemd æ¨¡æ¿ unitã€ï¼Œå¹¶æŠŠå…³é”®ç‚¹ä¸€æ¬¡è®²æ¸…æ¥šã€‚\nä¸€ã€Rootless Podman çš„æ­£ç¡® systemd ä½ç½® âš ï¸ Rootless Podman â‰  system service\nå¿…é¡»æ”¾åœ¨ ç”¨æˆ·çº§ systemd ç›®å½•ï¼š\n~/.config/systemd/user/podman@.service ä¸è¦æ”¾ /usr/lib/systemd/system/\nå¦åˆ™ä½ ä¼šé‡åˆ°ï¼šcgroupã€æƒé™ã€delegateã€socket å…¨éƒ¨å¼‚å¸¸\näºŒã€Rootless Podman æ¨¡æ¿ unitï¼ˆâœ… æ”¯æŒ -ï¼‰ ğŸ“„ ~/.config/systemd/user/podman@.service [Unit] Description=Rootless Podman container %i After=network-online.target Wants=network-online.target [Service] Type=simple # rootless å¿…é¡»ä½¿ç”¨ç”¨æˆ· session Environment=PODMAN_SYSTEMD_UNIT=%n Restart=always RestartSec=5 # âš ï¸ å…³é”®ï¼šå¿…é¡»ç”¨ %iï¼ˆä¸è½¬ä¹‰ï¼‰ ExecStart=/usr/bin/podman start -a %i ExecStop=/usr/bin/podman stop -t 10 %i # systemd / podman / cgroup æ­£ç¡®åä½œ KillMode=none Delegate=yes # é¿å… systemd è¯¯åˆ¤å¯åŠ¨è¶…æ—¶ TimeoutStartSec=0 TimeoutStopSec=30 # é˜²æ­¢è¢« OOM killer ä¼˜å…ˆæ€ OOMScoreAdjust=-999 [Install] WantedBy=default.target ä¸‰ã€å¯ç”¨ä¸ä½¿ç”¨æ–¹å¼ï¼ˆrootless æ­£ç¡®æµç¨‹ï¼‰ 1ï¸âƒ£ é‡æ–°åŠ è½½ç”¨æˆ· systemd systemctl --user daemon-reload 2ï¸âƒ£ å¯åŠ¨ / å¯ç”¨æŸä¸ªå®¹å™¨ systemctl --user start podman@gitlab-ce systemctl --user enable podman@gitlab-ce 3ï¸âƒ£ æŸ¥çœ‹çŠ¶æ€ systemctl --user status podman@gitlab-ce å››ã€âš ï¸ å¿…é¡»åšçš„ä¸€æ­¥ï¼ˆå¦åˆ™é‡å¯ä¸è‡ªå¯ï¼‰ ğŸ‘‰ å…è®¸ç”¨æˆ· systemd åœ¨æ— ç™»å½•çŠ¶æ€ä¸‹è¿è¡Œ loginctl enable-linger \u0026lt;ç”¨æˆ·å\u0026gt; ä¾‹å¦‚ï¼š\nloginctl enable-linger gitlab åŸå› ï¼ˆä¸€å¥è¯ï¼‰ rootless Podman ä¾èµ– user systemdï¼Œ\næ²¡æœ‰ lingerï¼Œç”¨æˆ·é€€å‡ºç™»å½•å unit ä¼šè¢«æ€æ‰ã€‚\näº”ã€Rootless Podman å¿…é¡»æ»¡è¶³çš„ç³»ç»Ÿæ¡ä»¶ ç¡®è®¤ä»¥ä¸‹å†…æ ¸ / ç³»ç»Ÿé…ç½®æ­£å¸¸ï¼ˆAlmaLinux / RHEL å¸¸è§ï¼‰ï¼š\n1ï¸âƒ£ å­ UID / GID cat /etc/subuid cat /etc/subgid åº”åŒ…å«ï¼š\ngitlab:100000:65536 è‹¥æ²¡æœ‰ï¼š\nusermod --add-subuids 100000-165535 gitlab usermod --add-subgids 100000-165535 gitlab 2ï¸âƒ£ cgroup v2ï¼ˆéå¸¸é‡è¦ï¼‰ stat -fc %T /sys/fs/cgroup è¾“å‡ºåº”ä¸ºï¼š\ncgroup2fs AlmaLinux 9 / 10 é»˜è®¤å·²å¼€å¯ âœ”\nå…­ã€Rootless vs Root Podmanï¼ˆä¸€å¥è¯å¯¹æ¯”ï¼‰ é¡¹ç›® Rootless Root å®‰å…¨æ€§ âœ… æé«˜ âŒ systemd ç±»å‹ user unit system unit ç«¯å£ \u0026lt;1024 âŒï¼ˆéœ€ rootlesskitï¼‰ âœ… æ¨èåœºæ™¯ æœåŠ¡ / CI / GitLab åŸºç¡€è®¾æ–½ ä¸ƒã€å¸¸è§å‘ï¼ˆä½ ä¸€å®šä¼šè¸©ï¼‰ âŒ ç”¨ %I -\u0026gt; å¸¦ - çš„å®¹å™¨åç›´æ¥ç¿»è½¦\nâŒ ç”¨ /usr/lib/systemd/system -\u0026gt; rootless ç›´æ¥å¼‚å¸¸\nâŒ å¿˜äº† Delegate=yes -\u0026gt; cgroup ç®¡ç†æ··ä¹±\nâŒ å¿˜äº† loginctl enable-linger -\u0026gt; é‡å¯åå®¹å™¨ä¸åœ¨\n","description":"ä¼˜åŒ–ä»¥ä¸‹ systemd é…ç½®ï¼Œä½¿å…¶æ”¯æŒ systemctl enable podman@gitlab-ceï¼Œå³ podman@ åé¢çš„å‚æ•°æ”¯æŒ - ç¬¦å·\n[Unit] Description=%I container After=network-online.target Wants=network-online.target [Service] User=root Restart=always ExecStart=/usr/bin/podman start -a %I ExecStop=/usr/bin/podman stop -t 10 %I LimitCORE=infinity LimitMEMLOCK=infinity LimitNOFILE=infinity LimitNPROC=infinity TasksMax=infinity OOMScoreAdjust=-999 [Install] WantedBy=multi-user.target è¿™ä¸ªé—®é¢˜çš„å…³é”®ç‚¹ä¸åœ¨ Podmanï¼Œè€Œåœ¨ systemd å¯¹â€œå®ä¾‹åè½¬ä¹‰â€çš„æœºåˆ¶ã€‚\nç°åœ¨ç”¨çš„æ˜¯ é”™è¯¯çš„å ä½ç¬¦ï¼Œå¯¼è‡´å¸¦ - çš„å®ä¾‹åè¡Œä¸ºä¸ç¬¦åˆé¢„æœŸã€‚\nä¸‹é¢å…ˆç»™ç»“è®ºç‰ˆä¿®å¤ï¼Œå†è§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·æ”¹æ˜¯æ­£ç¡®çš„ã€‚\nä¸€ã€ç›´æ¥ç»™ã€Œå¯ç”¨ä¸”è§„èŒƒã€çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆâœ… æ”¯æŒ podman@gitlab-ceï¼‰ âœ… æ ¸å¿ƒæ”¹åŠ¨ç‚¹ æŠŠ %I æ”¹ä¸º %i é¡ºå¸¦è¡¥é½ Podman å®˜æ–¹æ¨èçš„ systemd é€‰é¡¹ âœ… ä¿®å¤å¹¶ä¼˜åŒ–åçš„ unit æ–‡ä»¶ [Unit] Description=Podman container %i After=network-online.target Wants=network-online.target [Service] Type=simple User=root Restart=always RestartSec=5 # ä½¿ç”¨ %iï¼ˆæœªè½¬ä¹‰å®ä¾‹åï¼Œæ”¯æŒ -ï¼‰ ExecStart=/usr/bin/podman start -a %i ExecStop=/usr/bin/podman stop -t 10 %i # èµ„æºä¸ç¨³å®šæ€§ LimitCORE=infinity LimitMEMLOCK=infinity LimitNOFILE=infinity LimitNPROC=infinity TasksMax=infinity OOMScoreAdjust=-999 # systemd / cgroup / podman åä½œå¿…å¤‡ KillMode=none Delegate=yes TimeoutStartSec=0 TimeoutStopSec=30 [Install] WantedBy=multi-user.target ç°åœ¨å¯ä»¥ç›´æ¥å¯ç”¨ï¼š\n"},{"id":356,"href":"/database/postgres/","title":"PostgreSQL","parent":"Database","content":"PostgreSQL è°ƒä¼˜å·¥å…·ï¼šPGTune\nå‚è€ƒæ–‡æ¡£ï¼š\nPostgreSQL 17 ä¸­æ–‡æ‰‹å†Œ Document List:\nPostgreSQL FAQ pgBackRest åŸºç¡€æ•™ç¨‹ PostgreSQL åŸºç¡€æ•™ç¨‹ PostgreSQL æ ¸å¿ƒæ¦‚å¿µ pgBackRest é…ç½®æ–‡ä»¶è¯¦è§£ pgBackRest \u0026#43; pg_checksums çš„å®Œæ•´å®¹ç¾é“¾è·¯ pgBackRest å·®é‡å¤‡ä»½ å’Œ å¢é‡å¤‡ä»½ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ TimescaleDB åŸºç¡€æ•™ç¨‹ PostgreSQL Example Repack PostgreSQL COPY PostgreSQL COUNT PostgreSQL CREATE TABLE PostgreSQL Datetime PostgreSQL EXPLAIN PostgreSQL huge_pages PostgreSQL Join PostgreSQL Like PostgreSQL OLTP PostgreSQL pg_trgm PostgreSQL Schema PostgreSQL vs MySQL PostgreSQL XID é—®é¢˜ PostgreSQL ä¸»é”® PostgreSQL äº‹åŠ¡ PostgreSQL å…¨æ–‡æ£€ç´¢ PostgreSQL å†…ç½®å‡½æ•° PostgreSQL å»é™¤ç©ºç™½ PostgreSQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ PostgreSQL å¤‡ä»½ä¸æ¢å¤ PostgreSQL å­—ç¬¦ç±»å‹ PostgreSQL æ€§èƒ½ä¼˜åŒ– PostgreSQL æ•…éšœæ’æŸ¥ PostgreSQL æ•…éšœæ’æŸ¥ -- pgbackrest PostgreSQL æ•°æ®å½¢æ€ PostgreSQL æ•´æ•° PostgreSQL æŸ¥çœ‹æŸä¸ªè‡ªå¢å­—æ®µ(åºåˆ—)å½“å‰æœ€æ–°å€¼ PostgreSQL ç‰©ç†å¤‡ä»½ \u0026#43; WAL è¯¦ç»†çš„ å¢é‡å¤‡ä»½ æ–¹æ¡ˆ PostgreSQL ç¦ç”¨å¤–é”®æ£€æŸ¥ PostgreSQL ç´¢å¼• PostgreSQL ç»Ÿè®¡å­—æ®µæœ€å¤§é•¿åº¦çš„æ–¹æ³• PostgreSQL è¿ç»´ PostgreSQL è¿ç»´æœ€ä½³å®è·µ PostgreSQL é” PosygreSQL TIMESTAMP å’Œ TIMESTAMPTZ SQL æŸ¥è¯¢å¾ˆæ…¢ï¼Œå¦‚ä½•æ’æŸ¥æ˜¯å¦æ˜¯ç¡¬ä»¶çš„é—®é¢˜ï¼Ÿ wal_buffers ä»€ä¹ˆæ˜¯ OLTP å’Œ OLAP ï¼Ÿ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… PostgreSQL 18 ç»å…¸é—®é¢˜ ","description":"PostgreSQL è°ƒä¼˜å·¥å…·ï¼šPGTune\nå‚è€ƒæ–‡æ¡£ï¼š\nPostgreSQL 17 ä¸­æ–‡æ‰‹å†Œ Document List:\nPostgreSQL FAQ pgBackRest åŸºç¡€æ•™ç¨‹ PostgreSQL åŸºç¡€æ•™ç¨‹ PostgreSQL æ ¸å¿ƒæ¦‚å¿µ pgBackRest é…ç½®æ–‡ä»¶è¯¦è§£ pgBackRest \u0026#43; pg_checksums çš„å®Œæ•´å®¹ç¾é“¾è·¯ pgBackRest å·®é‡å¤‡ä»½ å’Œ å¢é‡å¤‡ä»½ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ TimescaleDB åŸºç¡€æ•™ç¨‹ PostgreSQL Example Repack PostgreSQL COPY PostgreSQL COUNT PostgreSQL CREATE TABLE PostgreSQL Datetime PostgreSQL EXPLAIN PostgreSQL huge_pages PostgreSQL Join PostgreSQL Like PostgreSQL OLTP PostgreSQL pg_trgm PostgreSQL Schema PostgreSQL vs MySQL PostgreSQL XID é—®é¢˜ PostgreSQL ä¸»é”® PostgreSQL äº‹åŠ¡ PostgreSQL å…¨æ–‡æ£€ç´¢ PostgreSQL å†…ç½®å‡½æ•° PostgreSQL å»é™¤ç©ºç™½ PostgreSQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ PostgreSQL å¤‡ä»½ä¸æ¢å¤ PostgreSQL å­—ç¬¦ç±»å‹ PostgreSQL æ€§èƒ½ä¼˜åŒ– PostgreSQL æ•…éšœæ’æŸ¥ PostgreSQL æ•…éšœæ’æŸ¥ -- pgbackrest PostgreSQL æ•°æ®å½¢æ€ PostgreSQL æ•´æ•° PostgreSQL æŸ¥çœ‹æŸä¸ªè‡ªå¢å­—æ®µ(åºåˆ—)å½“å‰æœ€æ–°å€¼ PostgreSQL ç‰©ç†å¤‡ä»½ \u0026#43; WAL è¯¦ç»†çš„ å¢é‡å¤‡ä»½ æ–¹æ¡ˆ PostgreSQL ç¦ç”¨å¤–é”®æ£€æŸ¥ PostgreSQL ç´¢å¼• PostgreSQL ç»Ÿè®¡å­—æ®µæœ€å¤§é•¿åº¦çš„æ–¹æ³• PostgreSQL è¿ç»´ PostgreSQL è¿ç»´æœ€ä½³å®è·µ PostgreSQL é” PosygreSQL TIMESTAMP å’Œ TIMESTAMPTZ SQL æŸ¥è¯¢å¾ˆæ…¢ï¼Œå¦‚ä½•æ’æŸ¥æ˜¯å¦æ˜¯ç¡¬ä»¶çš„é—®é¢˜ï¼Ÿ wal_buffers ä»€ä¹ˆæ˜¯ OLTP å’Œ OLAP ï¼Ÿ åœ¨ AlmaLinux 9 ä¸Šå®‰è£… PostgreSQL 18 ç»å…¸é—®é¢˜ "},{"id":357,"href":"/database/postgres/copy/","title":"PostgreSQL COPY","parent":"PostgreSQL","content":" ä¸€ã€COPY æ˜¯ä»€ä¹ˆï¼Ÿ COPY æ˜¯ PostgreSQL æœ€å¿«çš„æ•°æ®å¯¼å…¥ / å¯¼å‡ºæ–¹å¼ï¼Œç›´æ¥åœ¨ æ•°æ®åº“æœåŠ¡ç«¯ è¯»å†™æ–‡ä»¶ã€‚\næ–‡ä»¶ \u0026lt;-\u0026gt; PostgreSQL åç«¯è¿›ç¨‹ \u0026lt;-\u0026gt; è¡¨ æ€§èƒ½è¿œè¶… INSERT / ORM / æ‰¹é‡æ‰§è¡Œ\näºŒã€COPY åŸºæœ¬è¯­æ³• 1ï¸âƒ£ ä»æ–‡ä»¶å¯¼å…¥è¡¨ COPY table_name FROM \u0026#39;/absolute/path/file.csv\u0026#39; WITH (FORMAT csv); 2ï¸âƒ£ ä»è¡¨å¯¼å‡ºæ–‡ä»¶ COPY table_name TO \u0026#39;/absolute/path/file.csv\u0026#39; WITH (FORMAT csv, HEADER true); 3ï¸âƒ£ æŒ‡å®šåˆ—ï¼ˆæœ€å¸¸ç”¨ï¼‰ COPY articles (datetime, code, source, title, url) FROM \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); é¿å…åˆ—é¡ºåºé—®é¢˜ å¯è·³è¿‡è‡ªå¢ id ä¸‰ã€COPY çš„å¸¸ç”¨å‚æ•°ï¼ˆéå¸¸é‡è¦ï¼‰ CSV ç›¸å…³\nWITH ( FORMAT csv, HEADER true, DELIMITER \u0026#39;,\u0026#39;, QUOTE \u0026#39;\u0026#34;\u0026#39;, ESCAPE \u0026#39;\u0026#34;\u0026#39;, NULL \u0026#39;\u0026#39;, ENCODING \u0026#39;UTF8\u0026#39; ); å‚æ•° è¯´æ˜ FORMAT æ ¼å¼ HEADER é¦–è¡Œæ˜¯åˆ—å DELIMITER å­—æ®µåˆ†éš”ç¬¦ QUOTE å­—æ®µåŒ…è£¹ç¬¦ï¼ˆé»˜è®¤ä¸º \u0026ldquo;ï¼‰ ESCAPE è½¬ä¹‰ç¬¦ï¼ˆé»˜è®¤ä¸º \u0026ldquo;ï¼‰ NULL ç©ºå€¼è¡¨ç¤º ENCODING æ–‡ä»¶ç¼–ç  æ—¶é—´ \u0026amp; ç©ºå€¼ ğŸŒŸ SET datestyle = \u0026#39;ISO, YMD\u0026#39;; 2025-01-01 10:00:00,,source,title,url å››ã€COPY vs \\copyï¼ˆ99% çš„å‘åœ¨è¿™ï¼‰ å¯¹æ¯”é¡¹ COPY \\copy æ‰§è¡Œä½ç½® æ•°æ®åº“æœåŠ¡å™¨ å®¢æˆ·ç«¯ï¼ˆpsqlï¼‰ æ–‡ä»¶ä½ç½® æœåŠ¡å™¨ç£ç›˜ æœ¬åœ°ç£ç›˜ æƒé™ éœ€è¦ superuser / pg_read_server_files æ™®é€šç”¨æˆ·å³å¯ å¸¸ç”¨åœºæ™¯ ç”Ÿäº§æœåŠ¡å™¨ æœ¬åœ°å¯¼å…¥ å®¢æˆ·ç«¯å¯¼å…¥ï¼ˆæ¨èï¼‰ \\copy articles (datetime, code, source, title, url) FROM \u0026#39;articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); ğŸ‘‰ ä¼˜å…ˆç”¨ \\copyï¼Œå°‘è¸©æƒé™å‘\näº”ã€IDENTITY / è‡ªå¢å­—æ®µ ä¸ COPYï¼ˆä½ åˆšè¸©çš„å‘ï¼‰ âŒ é”™è¯¯åœºæ™¯ id INTEGER GENERATED ALWAYS AS IDENTITY CSV åŒ…å« id -\u0026gt; æŠ¥é”™\nâœ… æ­£ç¡®æ–¹å¼ 1ï¼ˆæ¨èï¼‰ COPY articles (datetime, code, source, title, url) FROM \u0026#39;/path/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); âœ… æ­£ç¡®æ–¹å¼ 2ï¼ˆä¿ç•™ idï¼‰ COPY articles (id, datetime, code, source, title, url) FROM \u0026#39;/path/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true) OVERRIDING SYSTEM VALUE; OVERRIDING SYSTEM VALUE å¯èƒ½ä¸å¯ç”¨ å¯¼å…¥åä¿®å¤åºåˆ—ï¼š\nSELECT setval( pg_get_serial_sequence(\u0026#39;articles\u0026#39;, \u0026#39;id\u0026#39;), (SELECT MAX(id) FROM articles) ); å…­ã€COPY æ€§èƒ½ä¼˜åŒ–ï¼ˆç”Ÿäº§çº§ï¼‰ ğŸš€ 1ï¸âƒ£ å…³é—­åŒæ­¥å†™ï¼ˆå¯¼å…¥æœŸé—´ï¼‰ SET synchronous_commit = off; ğŸš€ 2ï¸âƒ£ ä¸´æ—¶åˆ é™¤ç´¢å¼•ï¼ˆå¤§è¡¨ï¼‰ DROP INDEX idx_articles_title; COPY ... CREATE INDEX idx_articles_title ON articles (...); ğŸš€ 3ï¸âƒ£ ä½¿ç”¨ UNLOGGED è¡¨ï¼ˆä¸­é—´è¡¨ï¼‰ CREATE UNLOGGED TABLE articles_tmp (...); ğŸš€ 4ï¸âƒ£ æ‰¹é‡å¯¼å…¥ç™¾ä¸‡è¡Œå»ºè®®å‚æ•° maintenance_work_mem = 1GB work_mem = 64MB ä¸ƒã€COPY + äº‹åŠ¡è¡Œä¸ºï¼ˆé‡è¦ï¼‰ BEGIN; COPY articles FROM \u0026#39;/data/a.csv\u0026#39; CSV; COMMIT; -- å‡ºé”™ -\u0026gt; å›æ»š -- ROLLBACK; COPY æ˜¯äº‹åŠ¡æ€§çš„ å‡ºé”™ -\u0026gt; æ•´ä¸ª COPY å›æ»š å…«ã€COPY å¸¸è§é”™è¯¯ \u0026amp; è§£å†³æ–¹æ¡ˆ âŒ è·¯å¾„ä¸å­˜åœ¨ could not open file æ–‡ä»¶å¿…é¡»åœ¨ æ•°æ®åº“æœåŠ¡å™¨\nâŒ æƒé™ä¸è¶³ must be superuser ç”¨ \\copy æˆ–æˆäºˆï¼š\nä½¿ç”¨ COPY ä¼šæœ‰æƒé™é—®é¢˜ GRANT pg_read_server_files TO user; GRANT pg_write_server_files TO user; âŒ ç¼–ç é”™è¯¯ invalid byte sequence è½¬ç ï¼š\niconv -f gbk -t utf8 a.csv \u0026gt; b.csv âŒ CSV åˆ—é”™ä½ æ˜ç¡®åˆ—å æ£€æŸ¥ delimiter / quote ä¹ã€COPY é«˜çº§ç”¨æ³• 1ï¸âƒ£ COPY æŸ¥è¯¢ç»“æœ COPY ( SELECT * FROM articles WHERE datetime \u0026gt;= \u0026#39;2025-01-01\u0026#39; ) TO \u0026#39;/data/export.csv\u0026#39; CSV HEADER; 2ï¸âƒ£ COPY + ON CONFLICTï¼ˆé—´æ¥ï¼‰ CREATE TEMP TABLE tmp_articles (LIKE articles); COPY tmp_articles FROM \u0026#39;/data/a.csv\u0026#39; CSV HEADER; INSERT INTO articles SELECT * FROM tmp_articles ON CONFLICT (code, url) DO NOTHING; 3ï¸âƒ£ COPY + JSONï¼ˆè¾ƒå°‘ç”¨ï¼‰ COPY table_name FROM \u0026#39;/data/a.json\u0026#39; JSON; åã€ç”Ÿäº§æœ€ä½³å®è·µæ€»ç»“ï¼ˆé‡ç‚¹ï¼‰ âœ… æœ¬åœ°å¯¼å…¥ç”¨ \\copy âœ… æ°¸è¿œæ˜¾å¼å†™åˆ—å âœ… ä¸å¯¼å…¥ IDï¼ˆé™¤éå¿…è¦ï¼‰ âœ… å¤§æ‰¹é‡å¯¼å…¥å‰åˆ é™¤ç´¢å¼• âœ… å¯¼å…¥å ANALYZE ANALYZE articles; DateStyle ä¸€ã€DateStyle æ˜¯ä»€ä¹ˆï¼Ÿ DateStyle å†³å®š PostgreSQL å¦‚ä½•è§£æå’Œæ˜¾ç¤ºæ—¥æœŸ/æ—¶é—´å­—ç¬¦ä¸²ã€‚\nSHOW DateStyle; å¸¸è§è¾“å‡ºï¼š\nISO, MDY å«ä¹‰ï¼š\nISOï¼šè¾“å‡ºæ ¼å¼ MDYï¼šè§£æé¡ºåºï¼ˆMonth-Day-Yearï¼‰ äºŒã€SET DateStyle çš„åŸºæœ¬ç”¨æ³• 1ï¸âƒ£ å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼ˆæœ€å¸¸ç”¨ï¼‰ SET DateStyle = \u0026#39;ISO, YMD\u0026#39;; æˆ–ï¼š\nSET DateStyle TO \u0026#39;ISO, YMD\u0026#39;; åªå½±å“ å½“å‰è¿æ¥ / å½“å‰äº‹åŠ¡ã€‚\n2ï¸âƒ£ å½“å‰äº‹åŠ¡å†…ç”Ÿæ•ˆ BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; -- åœ¨è¿™é‡Œæ‰§è¡Œ COPY / INSERT COMMIT; äº‹åŠ¡ç»“æŸè‡ªåŠ¨æ¢å¤ éå¸¸é€‚åˆä¸€æ¬¡æ€§å¯¼å…¥æ•°æ® 3ï¸âƒ£ æ•°æ®åº“çº§ï¼ˆâš ï¸ è°¨æ…ï¼‰ ALTER DATABASE mydb SET DateStyle = \u0026#39;ISO, YMD\u0026#39;; æ–°è¿æ¥ç”Ÿæ•ˆã€‚\n4ï¸âƒ£ ç³»ç»Ÿçº§ï¼ˆâš ï¸ ä¸æ¨èï¼‰ # postgresql.conf DateStyle = \u0026#39;ISO, YMD\u0026#39; éœ€è¦é‡å¯ã€‚\nä¸‰ã€DateStyle ç»„æˆè¯¦è§£ æ ¼å¼ï¼š\nDateStyle = \u0026#39;è¾“å‡ºæ ¼å¼, è¾“å…¥è§£æé¡ºåº\u0026#39; è¾“å‡ºæ ¼å¼ï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰\nå€¼ ç¤ºä¾‹ ISO 2025-12-10 10:54:37 SQL 12/10/2025 10:54:37 Postgres Wed Dec 10 10:54:37 2025 German 10.12.2025 10:54:37 è¾“å…¥è§£æé¡ºåºï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰\nå€¼ å«ä¹‰ MDY æœˆ-æ—¥-å¹´ DMY æ—¥-æœˆ-å¹´ YMD å¹´-æœˆ-æ—¥ ğŸ“Œ åªå½±å“â€œæœ‰æ­§ä¹‰â€çš„æ—¥æœŸå­—ç¬¦ä¸²\nâ—ï¸ æ¨èï¼šISO + YMD\nå››ã€å“ªäº›æ ¼å¼ä¼šå— DateStyle å½±å“ï¼Ÿ âŒ ä¼šå—å½±å“ï¼ˆå±é™©ï¼‰ 10-12-2025 12/10/2025 MDY -\u0026gt; 12 æœˆ 10 æ—¥ DMY -\u0026gt; 10 æœˆ 12 æ—¥ âœ… ä¸å—å½±å“ï¼ˆå®‰å…¨ï¼‰ 2025-12-10 2025-12-10 10:54:37 2025-12-10T10:54:37 ISO 8601 æ°¸è¿œå®‰å…¨\näº”ã€SET DateStyle + COPY çš„æ­£ç¡®å§¿åŠ¿ åœºæ™¯ï¼šCSV æ—¶é—´æ˜¯ 10/12/2025 10:54:37\næ­£ç¡®å†™æ³•ï¼š\nBEGIN; SET LOCAL DateStyle = \u0026#39;ISO, DMY\u0026#39;; \\copy articles FROM \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv); COMMIT; åªå½±å“å½“å‰å¯¼å…¥ ä¸æ±¡æŸ“å…¶ä»–ä¼šè¯ å…­ã€ä»€ä¹ˆæ—¶å€™ä¸è¯¥ç”¨ SET DateStyle âŒ é•¿æœŸä¾èµ– DateStyle âŒ ç¨‹åºä»£ç é‡Œéšå¼ä¿®æ”¹ âŒ å¤šäººå…±äº«æ•°æ®åº“ âŒ è‡ªåŠ¨åŒ–ä»»åŠ¡ä¸­ åŸå› ï¼šä¸å¯é¢„æœŸ + æ˜“å‡ºäº‹æ•…\nä¸ƒã€æ›¿ä»£æ–¹æ¡ˆï¼ˆæ›´æ¨èï¼‰ ç”¨ to_timestamp() æ˜ç¡®æ ¼å¼\nto_timestamp(\u0026#39;10/12/2025 10:54:37\u0026#39;, \u0026#39;YYYY-MM-DD HH24:MI:SS\u0026#39;) æˆ–å…ˆå¯¼ TEXT å†è½¬æ¢ï¼ˆæœ€ç¨³ï¼‰\nå…«ã€æ€»ç»“ DateStyle æ˜¯â€œæœ€åæ‰‹æ®µâ€ï¼Œä¸æ˜¯é•¿æœŸæ–¹æ¡ˆ\nISO + YMD æ—¶é—´æ ¼å¼æ‰æ˜¯æ­£è§£\nåªåœ¨â€œå†å²è„æ•°æ®â€å¯¼å…¥æ—¶ç”¨ SET LOCAL\nDateStyleï¼ˆæ‰©å±•ï¼‰ ä¸€ã€æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ COPY æœ¬èº«ä¸å®šä¹‰æ—¶é—´æ ¼å¼\nğŸ‘‰ æ—¶é—´æ ¼å¼ç”± PostgreSQL çš„ DateStyle / å­—æ®µç±»å‹å†³å®š\nä¹Ÿå°±æ˜¯è¯´ï¼š\nCOPY åªæ˜¯â€œæ¬æ•°æ®â€ è§£ææ—¶é—´çš„æ˜¯ PostgreSQL ç±»å‹ç³»ç»Ÿ äºŒã€æœ€å®‰å…¨ã€é€šç”¨çš„æ—¶é—´æ ¼å¼ï¼ˆå¼ºçƒˆæ¨èï¼‰ âœ… TIMESTAMP / TIMESTAMPTZ\nYYYY-MM-DD HH:MI:SS ç¤ºä¾‹ï¼š\n2025-12-10 10:54:37 2025-12-10 10:54:37.052 æ°¸è¿œä¸ä¼šå‡ºé”™ ä¸å— DateStyle å½±å“ æ‰€æœ‰ PostgreSQL ç‰ˆæœ¬é€šç”¨ ä¸‰ã€COPY å¯¼å…¥æ—¶é—´çš„æ­£ç¡®ç¤ºä¾‹ è¡¨ç»“æ„\ndatetime TIMESTAMP NOT NULL CSV ç¤ºä¾‹\ndatetime 2025-12-10 10:54:37 2025-12-10 10:54:37.052 COPY\n\\copy articles (datetime) FROM \u0026#39;articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); å››ã€å¸¸è§â€œèƒ½æˆåŠŸ / ä¼šå¤±è´¥â€çš„æ—¶é—´æ ¼å¼ âœ… èƒ½æˆåŠŸï¼ˆé»˜è®¤ DateStyle = ISOï¼‰\næ ¼å¼ ç¤ºä¾‹ ISO 2025-12-10 10:54:37 å¸¦æ¯«ç§’ 2025-12-10 10:54:37.052 T åˆ†éš” 2025-12-10T10:54:37 UTC 2025-12-10T10:54:37Z âŒ å¸¸è§å¤±è´¥æ ¼å¼\næ ¼å¼ åŸå›  2025/12/10 10:54:37 DateStyle ä¸å…¼å®¹ 2025å¹´12æœˆ10æ—¥ 10:54:37 éæ ‡å‡† 10-12-2025 10:54:37 æœˆæ—¥æ­§ä¹‰ 20251210 é timestamp æŠ¥é”™é€šå¸¸æ˜¯ï¼š\nERROR: invalid input syntax for type timestamp äº”ã€å¦‚æœä½ çš„ CSV æ—¶é—´æ ¼å¼â€œä¸æ ‡å‡†â€ï¼Œæ€ä¹ˆåŠï¼Ÿ æ–¹æ¡ˆ 1ï¼ˆæœ€ä½³ï¼‰ï¼šé¢„å¤„ç† CSVï¼ˆæ¨èï¼‰ æŠŠæ—¶é—´ç»Ÿä¸€æˆï¼š\nYYYY-MM-DD HH:MI:SS æ–¹æ¡ˆ 2ï¼šå…ˆå¯¼å…¥ä¸º TEXTï¼Œå†è½¬æ¢ CREATE TEMP TABLE tmp_articles ( datetime TEXT, ... ); \\copy tmp_articles FROM \u0026#39;articles.csv\u0026#39; WITH (FORMAT csv); INSERT INTO articles (datetime, ...) SELECT to_timestamp(datetime, \u0026#39;YYYY-MM-DD HH24:MI:SS\u0026#39;), ... FROM tmp_articles; æ–¹æ¡ˆ 3ï¼šä¸´æ—¶è°ƒæ•´ DateStyleï¼ˆâš ï¸ ä¸æ¨èï¼‰ SET DateStyle = \u0026#39;ISO, MDY\u0026#39;; âš ï¸ é£é™©ï¼š\nå½±å“å½“å‰ä¼šè¯ ä¸åˆ©äºè‡ªåŠ¨åŒ– å®¹æ˜“å‡ºäº‹æ•… å…­ã€TIMESTAMPTZ ç‰¹åˆ«è¯´æ˜ï¼ˆé‡è¦ï¼‰ å¦‚æœå­—æ®µæ˜¯ï¼š\ndatetime TIMESTAMPTZ CSV å¯å†™ï¼š\n2025-12-10 10:54:37+08 2025-12-10T02:54:37Z PostgreSQL ä¼šï¼š\nè‡ªåŠ¨è½¬æ¢ä¸º UTC å†…éƒ¨ç»Ÿä¸€å­˜å‚¨ ä¸ƒã€COPY + NULL æ—¶é—´çš„å†™æ³• CSVï¼š\ndatetime \\N COPYï¼š\n\\copy articles FROM \u0026#39;articles.csv\u0026#39; WITH (FORMAT csv, NULL \u0026#39;\\N\u0026#39;); å…«ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ è¡¨å­—æ®µç”¨ TIMESTAMP æˆ– TIMESTAMPTZ CSV æ—¶é—´ç»Ÿä¸€æˆ ISO 8601 ä¸åœ¨ COPY æ—¶ä¾èµ– DateStyle å¯¼å…¥å¤±è´¥å…ˆå¯¼ TEXT å†è½¬æ¢ æ°¸è¿œä¸è¦å¯¼å…¥â€œä¸­æ–‡æ—¶é—´â€ ä¹ã€æ€»ç»“ COPY ä¸å…³å¿ƒæ—¶é—´æ ¼å¼ï¼ŒPostgreSQL ç±»å‹æ‰å…³å¿ƒ\nğŸ‘‰ ç»Ÿä¸€ç”¨ YYYY-MM-DD HH:MI:SS æ°¸è¿œä¸ä¼šè¸©å‘\nQUOTE ä½¿ç”¨ Navicat å¯¼å‡º CSV æ–‡ä»¶æ—¶ï¼Œå­—æ®µæ•°æ®éƒ½æ˜¯ä½¿ç”¨ \u0026quot; \u0026quot; æ‹¬å·æ‹¬èµ·æ¥ï¼Œè€Œ PostgreSQL çš„ CSV æ–‡ä»¶åˆ™æ²¡æœ‰ \u0026quot; \u0026quot; æ‹¬å·ï¼Œæ¢³ç†åŸå› å’Œæ­£ç¡®ç”¨æ³•ã€‚\nä¸€ã€COPY TO CSV çš„åŸºæœ¬è¯­æ³• COPY articles TO \u0026#39;/path/to/file.csv\u0026#39; WITH ( FORMAT csv, HEADER true, DELIMITER \u0026#39;,\u0026#39;, QUOTE \u0026#39;\u0026#34;\u0026#39;, ESCAPE \u0026#39;\u0026#34;\u0026#39; ); DELIMITER -\u0026gt; å­—æ®µåˆ†éš”ç¬¦ QUOTE -\u0026gt; å­—æ®µåŒ…è£¹ç¬¦ï¼ˆé»˜è®¤ä¸º \u0026ldquo;ï¼‰ ESCAPE -\u0026gt; è½¬ä¹‰ç¬¦ï¼ˆé»˜è®¤ä¸º \u0026ldquo;ï¼‰ æ³¨æ„ï¼šCOPY TO æ—¶åªæœ‰åœ¨å­—æ®µä¸­å‡ºç° åˆ†éš”ç¬¦ã€æ¢è¡Œç¬¦æˆ–å¼•ç”¨ç¬¦ æ—¶æ‰ä¼šä½¿ç”¨ QUOTE åŒ…è£¹å­—æ®µã€‚\näºŒã€ä¸ºä»€ä¹ˆ QUOTE \u0026lsquo;\u0026rdquo;\u0026rsquo; æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ 1. å­—æ®µä¸­æ²¡æœ‰éœ€è¦å¼•ç”¨çš„å­—ç¬¦ å­—æ®µå†…å®¹ï¼šhello, world\nCSV é»˜è®¤è§„åˆ™ï¼š å­—æ®µä¸­ æ²¡æœ‰åˆ†éš”ç¬¦ã€æ¢è¡Œæˆ–å¼•å· -\u0026gt; ä¸ä¼šåŠ  \u0026quot; \u0026quot; æ‰€ä»¥å³ä½¿ä½ è®¾ç½® QUOTE \u0026lsquo;\u0026quot;\u0026rsquo;ï¼Œè¾“å‡ºä¹Ÿæ˜¯ï¼š hello,world åªæœ‰å‡ºç°è¿™äº›ç‰¹æ®Šå­—ç¬¦ï¼Œæ‰ä¼šè‡ªåŠ¨åŠ å¼•å·ï¼š å­—æ®µå†…å®¹ï¼šhello, \u0026#34;weixin\u0026#34; è¾“å‡ºï¼š \u0026#34;hello, \u0026#34;\u0026#34;weixin\u0026#34;\u0026#34;\u0026#34; 2. è¯¯è§£äº† QUOTE çš„ä½œç”¨ QUOTE å¹¶ä¸æ˜¯â€œæ¯ä¸ªå­—æ®µéƒ½åŠ å¼•å·â€ï¼Œè€Œæ˜¯â€œå¿…è¦æ—¶è‡ªåŠ¨åŠ å¼•å·â€ å¦‚æœæƒ³æ¯ä¸ªå­—æ®µéƒ½åŠ å¼•å·ï¼ŒPostgreSQL åŸç”Ÿ COPY æ²¡æœ‰ç›´æ¥å‚æ•°ï¼Œéœ€è¦å…ˆå¤„ç†æ•°æ®æˆ–ç”¨å®¢æˆ·ç«¯å·¥å…· ä¸‰ã€å¦‚æœæƒ³å¼ºåˆ¶æ¯ä¸ªå­—æ®µéƒ½åŠ å¼•å·çš„è§£å†³æ–¹æ¡ˆ æ–¹æ¡ˆ 1ï¼šåœ¨ SELECT æ—¶æ‰‹åŠ¨åŠ å¼•å· COPY ( SELECT \u0026#39;\u0026#34;\u0026#39; || REPLACE(title, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;\u0026#34;\u0026#34;\u0026#39;) || \u0026#39;\u0026#34;\u0026#39; AS title, \u0026#39;\u0026#34;\u0026#39; || REPLACE(content, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;\u0026#34;\u0026#34;\u0026#39;) || \u0026#39;\u0026#34;\u0026#39; AS content FROM articles ) TO \u0026#39;/path/to/file.csv\u0026#39; WITH (FORMAT csv, HEADER true, DELIMITER \u0026#39;,\u0026#39;); REPLACE(\u0026hellip;, \u0026lsquo;\u0026rdquo;\u0026rsquo;, \u0026lsquo;\u0026rdquo;\u0026rdquo;\u0026rsquo;) -\u0026gt; è½¬ä¹‰å¼•å· æ¯ä¸ªå­—æ®µéƒ½ä¼šè¢«åŒ…è£¹åŒå¼•å· æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ psql \\copy + å®¢æˆ·ç«¯å¤„ç†ï¼ˆæ›´æ¨èï¼‰ \\copy (SELECT * FROM articles) TO \u0026#39;articles.csv\u0026#39; CSV HEADER ç”±å®¢æˆ·ç«¯ psql ç”Ÿæˆ CSV é»˜è®¤éµå¾ª CSV æ ‡å‡†ï¼Œé‡åˆ°ç‰¹æ®Šå­—ç¬¦è‡ªåŠ¨åŠ å¼•å· å¯ä»¥ç»“åˆ COPY TO PROGRAM \u0026lsquo;awk \u0026hellip;\u0026rsquo; åšè‡ªå®šä¹‰ å››ã€æ€»ç»“ QUOTE \u0026lsquo;\u0026quot;\u0026rsquo; åªåœ¨å¿…è¦æ—¶åŠ å¼•å·ï¼Œå­—æ®µæ²¡æœ‰ç‰¹æ®Šå­—ç¬¦å°±ä¸ä¼šæ˜¾ç¤º æƒ³å¼ºåˆ¶åŠ å¼•å· -\u0026gt; åœ¨ SELECT é‡Œæ‹¼æ¥ \u0026quot; \u0026quot; æˆ–ç”¨å®¢æˆ·ç«¯å·¥å…·å¤„ç† COPY TO CSV æœ¬èº«ä¸¥æ ¼éµå®ˆ CSV æ ‡å‡†ï¼Œå¹¶ä¸æ˜¯â€œæ¯ä¸ªå­—æ®µéƒ½åŠ å¼•å·â€ åˆ†éš”ç¬¦ï¼šåŒå¼•å· åœ¨ PostgreSQL COPY ä¸­ï¼ŒåŒå¼•å· \u0026quot; ä¸æ˜¯åˆ†éš”ç¬¦ï¼ˆdelimiterï¼‰ï¼Œè€Œæ˜¯ æ–‡æœ¬å¼•ç”¨ç¬¦ï¼ˆQUOTEï¼‰ã€‚\nä¸€ã€æ ¸å¿ƒç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ é€‰é¡¹ å«ä¹‰ DELIMITER å­—æ®µåˆ†éš”ç¬¦ï¼ˆå¦‚ ,ã€\\tã€` QUOTE å­—æ®µåŒ…è£¹ç¬¦ï¼ˆé»˜è®¤æ˜¯ \u0026ldquo;ï¼‰ ESCAPE è½¬ä¹‰ç¬¦ï¼ˆé»˜è®¤ä¹Ÿæ˜¯ \u0026ldquo;ï¼‰ ğŸ‘‰ åŒå¼•å· \u0026quot; ä¸èƒ½å½“ delimiter ä½¿ç”¨ï¼ˆCSV è§„èŒƒä¸å…è®¸ï¼‰\näºŒã€æ ‡å‡† CSV ä¸­ \u0026quot; \u0026quot; çš„çœŸå®ä½œç”¨ ä¾‹å¦‚ä¸€è¡Œ CSVï¼š\n1,\u0026#34;hello,world\u0026#34;,\u0026#34;a \u0026#34;\u0026#34;quoted\u0026#34;\u0026#34; text\u0026#34; è§£æè§„åˆ™ï¼š\n, -\u0026gt; delimiter \u0026ldquo;hello,world\u0026rdquo; -\u0026gt; ä¸€ä¸ªå­—æ®µï¼ˆå³ä½¿å†…éƒ¨æœ‰é€—å·ï¼‰ \u0026quot;\u0026rdquo; -\u0026gt; è¡¨ç¤ºä¸€ä¸ª \u0026quot; ä¸‰ã€æ­£ç¡®çš„ COPY å†™æ³•ï¼ˆCSVï¼‰ âœ… é»˜è®¤ï¼ˆæ¨èï¼‰ COPY articles FROM STDIN WITH ( FORMAT csv, HEADER true ); ç­‰ä»·äºï¼š\nDELIMITER \u0026#39;,\u0026#39; QUOTE \u0026#39;\u0026#34;\u0026#39; ESCAPE \u0026#39;\u0026#34;\u0026#39; âœ… æ˜¾å¼æŒ‡å®šï¼ˆæ›´æ¸…æ™°ï¼‰ COPY articles FROM STDIN WITH ( FORMAT csv, DELIMITER \u0026#39;,\u0026#39;, QUOTE \u0026#39;\u0026#34;\u0026#39;, ESCAPE \u0026#39;\u0026#34;\u0026#39;, HEADER true ); å››ã€å¦‚æœä½ çš„æ–‡ä»¶æ˜¯ \u0026ldquo;|\u0026rdquo; åˆ†éš”ï¼ˆä¸æ˜¯ CSVï¼‰ ä¾‹å¦‚ï¼š\n1|\u0026#34;hello world\u0026#34;|abc æ­£ç¡®å†™æ³•ï¼š\nCOPY articles FROM STDIN WITH ( FORMAT text, DELIMITER \u0026#39;|\u0026#39; ); âš ï¸ æ³¨æ„ï¼š\nFORMAT text ä¸‹ æ²¡æœ‰ QUOTE è¯­ä¹‰ \u0026quot; \u0026quot; åªæ˜¯æ™®é€šå­—ç¬¦ äº”ã€å¦‚æœä½ çœŸçš„å†™æˆè¿™æ ·ï¼ˆâŒ é”™è¯¯ï¼‰ COPY articles FROM STDIN WITH (DELIMITER \u0026#39;\u0026#34;\u0026#39;); é—®é¢˜ï¼š\nPostgreSQL è¯­æ³•å…è®¸ ä½†å‡ ä¹ ä¸å¯ç”¨ å› ä¸º \u0026quot; æœ¬èº«ç”¨äºæ ‡è¯†å­—æ®µè¾¹ç•Œ ä¼šå¯¼è‡´å­—æ®µæ— æ³•æ­£ç¡®è§£æ ğŸ‘‰ å¼ºçƒˆä¸å»ºè®®\nå…­ã€å‡ ç§å¸¸è§æ–‡ä»¶ -\u0026gt; COPY å¯¹ç…§è¡¨ æ–‡ä»¶ç¤ºä¾‹ COPY é…ç½® 1,abc,def FORMAT csv 1,\u0026ldquo;a,b\u0026rdquo;,c FORMAT csv `1 abc 1\\tabc\\tdef FORMAT text, DELIMITER E\u0026rsquo;\\t\u0026rsquo; 1;\u0026ldquo;abc\u0026rdquo;;\u0026ldquo;def\u0026rdquo; FORMAT csv, DELIMITER \u0026lsquo;;\u0026rsquo; ä¸ƒã€è¿™ä¸ªé—®é¢˜æœ€å¯èƒ½çš„çœŸå®éœ€æ±‚æ˜¯ï¼Ÿ é—®çš„æ˜¯ï¼š\nCOPY delimiter åŒå¼•å· â€œ é€šå¸¸èƒŒåçœŸå®éœ€æ±‚æ˜¯ï¼š\n1ï¸âƒ£ CSV æ–‡ä»¶é‡Œæœ‰åŒå¼•å· ğŸ‘‰ ä¸ç”¨ç®¡ï¼Œé»˜è®¤å°±æ”¯æŒ\n2ï¸âƒ£ æƒ³â€œå¿½ç•¥åŒå¼•å·â€ ğŸ‘‰ ä¸å¯èƒ½ï¼ŒCSV è§„èŒƒå¿…é¡»ç”¨ QUOTE\n3ï¸âƒ£ æ–‡ä»¶æ˜¯ \u0026quot; åˆ†éš” ğŸ‘‰ å»ºè®®å…ˆè½¬æ¢æ–‡ä»¶ï¼ˆä¸æ¨èï¼‰\nå…«ã€æ€»ç»“ åœ¨ PostgreSQL COPY ä¸­ï¼š\nâœ… \u0026quot; æ˜¯ QUOTE âŒ ä¸æ˜¯ DELIMITER âœ… CSV 99% æƒ…å†µä¸‹ç”¨é»˜è®¤é…ç½® å®è·µ å¯¼å‡ºï¼š\n-- ç™»å½•æ•°æ®åº“ -- psql postgresql://username:password@host/database -- æ˜¾ç¤ºæ—¥æœŸæ ¼å¼ SHOW DateStyle; -- DateStyle -- ----------- -- ISO, MDY -- (1 row) -- å¯¼å‡º BEGIN; -- æ—¥æœŸæ ¼å¼: ISO, YMD SET LOCAL DateStyle = \u0026#39;ISO, YMD\u0026#39;; -- åŒ…å«åˆ—å \\copy articles TO \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); -- è¡¨å­—æ®µï¼šid, datetime, code, source, title, url -- å¦‚æœ id æ˜¯è‡ªå¢ä¸»é”®ï¼Œå¹¶æ— å®é™…çš„æ„ä¹‰ï¼Œå¯ä»¥å¿½ç•¥ id \\copy articles (datetime, code, source, title, url) TO \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; å¯¼å…¥ï¼š\n-- æ˜¾ç¤ºæ—¥æœŸæ ¼å¼ SHOW DateStyle; -- DateStyle -- ----------- -- ISO, MDY -- (1 row) -- å¯¼å…¥ -- æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœç”¨ Navicat å¯¼å‡ºçš„æ•°æ®ï¼Œæ—¥æœŸæ ¼å¼é»˜è®¤æ˜¯ ISO, DMY BEGIN; SET LOCAL DateStyle = \u0026#39;ISO, DMY\u0026#39;; \\copy articles FROM \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); COMMIT; -- é‡ç½®åºåˆ— SELECT setval( pg_get_serial_sequence(\u0026#39;articles\u0026#39;, \u0026#39;id\u0026#39;), (SELECT MAX(id) FROM articles) ); ","description":" ä¸€ã€COPY æ˜¯ä»€ä¹ˆï¼Ÿ COPY æ˜¯ PostgreSQL æœ€å¿«çš„æ•°æ®å¯¼å…¥ / å¯¼å‡ºæ–¹å¼ï¼Œç›´æ¥åœ¨ æ•°æ®åº“æœåŠ¡ç«¯ è¯»å†™æ–‡ä»¶ã€‚\næ–‡ä»¶ \u0026lt;-\u0026gt; PostgreSQL åç«¯è¿›ç¨‹ \u0026lt;-\u0026gt; è¡¨ æ€§èƒ½è¿œè¶… INSERT / ORM / æ‰¹é‡æ‰§è¡Œ\näºŒã€COPY åŸºæœ¬è¯­æ³• 1ï¸âƒ£ ä»æ–‡ä»¶å¯¼å…¥è¡¨ COPY table_name FROM \u0026#39;/absolute/path/file.csv\u0026#39; WITH (FORMAT csv); 2ï¸âƒ£ ä»è¡¨å¯¼å‡ºæ–‡ä»¶ COPY table_name TO \u0026#39;/absolute/path/file.csv\u0026#39; WITH (FORMAT csv, HEADER true); 3ï¸âƒ£ æŒ‡å®šåˆ—ï¼ˆæœ€å¸¸ç”¨ï¼‰ COPY articles (datetime, code, source, title, url) FROM \u0026#39;/tmp/articles.csv\u0026#39; WITH (FORMAT csv, HEADER true); é¿å…åˆ—é¡ºåºé—®é¢˜ å¯è·³è¿‡è‡ªå¢ id ä¸‰ã€COPY çš„å¸¸ç”¨å‚æ•°ï¼ˆéå¸¸é‡è¦ï¼‰ CSV ç›¸å…³\n"},{"id":358,"href":"/database/postgres/count/","title":"PostgreSQL COUNT","parent":"PostgreSQL","content":"å†…å®¹ï¼šç”¨æ³• -\u0026gt; è¡Œä¸ºå·®å¼‚ -\u0026gt; æ€§èƒ½ -\u0026gt; æœ€ä½³å®è·µ\nä¸€ã€SELECT COUNT() ä¸€å…±æœ‰å‡ ç§å¸¸è§ç”¨æ³•ï¼Ÿ åœ¨ PostgreSQL / MySQLï¼ˆä»¥åŠ SQL æ ‡å‡†ï¼‰ä¸­ï¼Œå¸¸è§ 4 ç§ï¼š\nå†™æ³• æ˜¯å¦ç»Ÿè®¡ NULL æ˜¯å¦ç»Ÿè®¡è¡Œ æ˜¯å¦ç­‰ä»· COUNT(*) âœ… åŒ…å« âœ… â­ æ¨è COUNT(1) âœ… åŒ…å« âœ… â‰ˆ COUNT(col) âŒ æ’é™¤ NULL âš ï¸ âŒ COUNT(DISTINCT col) âŒ æ’é™¤ NULL âŒ âŒ äºŒã€æ¯ç§ COUNT çš„è¯¦ç»†è§£é‡Šï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ COUNT(*) â€”â€” æœ€ä½³å®è·µ SELECT COUNT(*) FROM orders; è¡Œä¸º\nç»Ÿè®¡ è¡Œæ•° åŒ…å« NULL PostgreSQL å†…éƒ¨ä¼˜åŒ–æœ€å……åˆ† PostgreSQL å†…éƒ¨å®ç°\nä¸å–ä»»ä½•åˆ— ä¸å…³å¿ƒåˆ—å€¼ åªç»Ÿè®¡ tupleï¼ˆè¡Œï¼‰ ğŸ“Œ è¿™æ˜¯æ ‡å‡†ã€æœ€å¿«ã€æœ€å®‰å…¨çš„å†™æ³•\n2ï¸âƒ£ COUNT(1) â€”â€” è¯­ä¹‰ç­‰ä»·ï¼Œä½†ä¸æ¨è SELECT COUNT(1) FROM orders; è¡Œä¸º\nç»Ÿè®¡è¡Œæ•° 1 æ°¸è¿œé NULL å’Œ COUNT(*) çš„åŒºåˆ«ï¼Ÿ\né¡¹ç›® COUNT(*) COUNT(1) SQL æ ‡å‡† âœ… âœ… è¯­ä¹‰æ¸…æ™° âœ… âŒ ä¼˜åŒ–ç¨‹åº¦ âœ… âœ… æ¨èåº¦ â­â­â­â­â­ â­â­ ğŸ“Œ åœ¨ PostgreSQL ä¸­æ€§èƒ½å‡ ä¹ç›¸åŒï¼Œä½†æ²¡æœ‰ä»»ä½•ä¼˜åŠ¿\n3ï¸âƒ£ COUNT(col) â€”â€” åªç»Ÿè®¡é NULL SELECT COUNT(email) FROM users; è¡Œä¸º\nâŒ å¿½ç•¥ NULL åªç»Ÿè®¡ email IS NOT NULL ç­‰ä»·å†™æ³•\nSELECT COUNT(*) FROM users WHERE email IS NOT NULL; ä½¿ç”¨åœºæ™¯\nç»Ÿè®¡â€œå·²å¡«å†™æŸå­—æ®µâ€çš„æ•°é‡ æ•°æ®å®Œæ•´æ€§åˆ†æ âš ï¸ åƒä¸‡ä¸è¦ç”¨å®ƒä»£æ›¿ COUNT(*)\n4ï¸âƒ£ COUNT(DISTINCT col) â€”â€” å»é‡ç»Ÿè®¡ SELECT COUNT(DISTINCT user_id) FROM orders; è¡Œä¸º\nå»é‡ å¿½ç•¥ NULL æ€§èƒ½æœ€å·®çš„ä¸€ç§ å¸¸è§è¯¯åŒº\nCOUNT(DISTINCT a, b) -- PostgreSQL ä¸æ”¯æŒ æ­£ç¡®å†™æ³•ï¼š\nCOUNT(DISTINCT (a, b)) ä¸‰ã€COUNT çš„æ€§èƒ½å¯¹æ¯”ï¼ˆéå¸¸é‡è¦ï¼‰ PostgreSQL ä¸­çš„çœŸå®æƒ…å†µ\nå†™æ³• æ€§èƒ½ è¯´æ˜ COUNT(*) â­â­â­â­â­ æœ€ä¼˜ COUNT(1) â­â­â­â­ æ— ä¼˜åŠ¿ COUNT(col) â­â­â­ éœ€åˆ¤æ–­ NULL COUNT(DISTINCT col) â­ æ’åº / Hash å››ã€COUNT + WHERE çš„å…¸å‹ç”¨æ³• SELECT COUNT(*) FROM orders WHERE created_at \u0026gt;= CURRENT_DATE; ğŸ“Œ ç´¢å¼• + COUNT(*) éå¸¸é«˜æ•ˆ\näº”ã€COUNT + JOIN çš„æ­£ç¡®å§¿åŠ¿ï¼ˆé‡ç‚¹ï¼‰ âŒ é”™è¯¯å†™æ³•ï¼ˆé‡å¤è¡Œï¼‰\nSELECT COUNT(*) FROM orders o JOIN order_items i ON o.id = i.order_id; ä¸€æ¡è®¢å•å¤šæ¡ itemï¼Œä¼šè¢«æ”¾å¤§\nâœ… æ­£ç¡®å†™æ³•ï¼ˆç»Ÿè®¡ä¸»è¡¨ï¼‰\nSELECT COUNT(DISTINCT o.id) FROM orders o JOIN order_items i ON o.id = i.order_id; æˆ–è€…ï¼š\nSELECT COUNT(*) FROM orders o WHERE EXISTS ( SELECT 1 FROM order_items i WHERE i.order_id = o.id ); å…­ã€COUNT åœ¨å¤§è¡¨ä¸­çš„ä¼˜åŒ–æŠ€å·§ 1ï¸âƒ£ ä¸è¦é¢‘ç¹ COUNT(*) è¶…å¤§è¡¨ SELECT COUNT(*) FROM logs; -- ä¸Šäº¿è¡Œï¼Œæ…¢ æ›¿ä»£æ–¹æ¡ˆ\nSELECT reltuples::bigint FROM pg_class WHERE relname = \u0026#39;logs\u0026#39;; ğŸ“Œ ä¼°ç®—å€¼ï¼Œæ¯«ç§’çº§\n2ï¸âƒ£ TimescaleDB / åˆ†åŒºè¡¨ SELECT COUNT(*) FROM logs WHERE time \u0026gt;= now() - interval \u0026#39;1 day\u0026#39;; ğŸ‘‰ åªæ‰«æç›¸å…³åˆ†åŒº\nä¸ƒã€COUNT(*) vs EXISTSï¼ˆä¸šåŠ¡åœºæ™¯ï¼‰ âŒ åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼ˆé”™è¯¯ï¼‰\nSELECT COUNT(*) \u0026gt; 0 FROM users WHERE email = \u0026#39;a@b.com\u0026#39;; âœ… æ­£ç¡®å†™æ³•\nSELECT EXISTS ( SELECT 1 FROM users WHERE email = \u0026#39;a@b.com\u0026#39; ); ğŸš€ EXISTS ä¼šæå‰è¿”å›\nå…«ã€COUNT åœ¨ ORM ä¸­çš„æœ€ä½³å®è·µï¼ˆSQLAlchemyï¼‰ from sqlalchemy import select, func stmt = select(func.count()).select_from(User) count = session.scalar(stmt) ğŸ“Œ æ°¸è¿œç”¨ func.count() è€Œä¸æ˜¯ count(id)\nä¹ã€æ€»ç»“ COUNT(*) ç»Ÿè®¡è¡Œæ•°ï¼Œæ˜¯ SQL æ ‡å‡†ä¸­æœ€ä¼˜ã€æœ€å®‰å…¨çš„å†™æ³• COUNT(col) åªç»Ÿè®¡é NULL COUNT(DISTINCT col) ç”¨äºå»é‡ä½†æ€§èƒ½æœ€å·® åˆ¤æ–­æ˜¯å¦å­˜åœ¨åº”ä½¿ç”¨ EXISTS è€Œä¸æ˜¯ COUNT(*) åã€æœ€ç»ˆæœ€ä½³å®è·µæ¸…å•ï¼ˆå»ºè®®æ”¶è—ï¼‰ âœ… ç»Ÿè®¡è¡Œæ•° -\u0026gt; COUNT(*) âœ… ç»Ÿè®¡éç©ºå­—æ®µ -\u0026gt; COUNT(col) âœ… å»é‡ç»Ÿè®¡ -\u0026gt; COUNT(DISTINCT col) âŒ ä¸è¦ç”¨ COUNT åˆ¤æ–­å­˜åœ¨æ€§ âŒ ä¸è¦æ»¥ç”¨ COUNT åœ¨è¶…å¤§è¡¨ PostgreSQL ç»Ÿè®¡è¡¨çš„è¡Œæ•°æœ‰å¤šå°‘æ¡ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼Ÿæ¯å¤©ç»Ÿè®¡ä¸€æ¬¡æ¨èç”¨ä»€ä¹ˆæ–¹å¼ï¼Ÿ åœ¨ PostgreSQL ä¸­ç»Ÿè®¡è¡¨çš„è¡Œæ•°ï¼Œç¡®å®æœ‰å¤šç§æ–¹å¼ï¼Œæ¯ç§æ–¹å¼é€‚ç”¨åœºæ™¯ä¸åŒï¼Œå°¤å…¶æ˜¯æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œæ•ˆç‡å·®å¼‚éå¸¸å¤§ã€‚ä¸‹é¢æˆ‘æ•´ç†æˆè¯¦ç»†è¯´æ˜ï¼š\nä¸€ã€ç»Ÿè®¡è¡¨è¡Œæ•°çš„å‡ ç§æ–¹å¼ æ–¹æ³• ç¤ºä¾‹ SQL æ˜¯å¦ç²¾ç¡® é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ COUNT(*) SELECT COUNT(*) FROM table_name; âœ… ç²¾ç¡® å°è¡¨ã€å¶å°”ç»Ÿè®¡ ç®€å•ç›´è§‚ï¼Œä½†å…¨è¡¨æ‰«æï¼Œæ•°æ®é‡å¤§æ—¶æ…¢ COUNT(1) / COUNT(pk) SELECT COUNT(id) FROM table_name; âœ… ç²¾ç¡® å°è¡¨ã€å¶å°”ç»Ÿè®¡ æ•ˆæœå’Œ COUNT(*) ç±»ä¼¼ï¼Œæ€§èƒ½å‡ ä¹ä¸€æ · pg_class.reltuples SELECT reltuples::BIGINT AS approx_count FROM pg_class WHERE relname=\u0026lsquo;table_name\u0026rsquo;; âŒ ä¼°ç®— å¤§è¡¨ã€å¿«é€Ÿ å¾ˆå¿«ï¼Œä¸è®¿é—®è¡¨ï¼Œåªè¯»å–ç»Ÿè®¡ä¿¡æ¯ï¼›ä¸ç²¾ç¡®ï¼Œå¯èƒ½ä¸çœŸå®å€¼å·®è·è¾ƒå¤§ ANALYZE + pg_stat_all_tables ANALYZE table_name; SELECT n_live_tup FROM pg_stat_all_tables WHERE relname=\u0026lsquo;table_name\u0026rsquo;; âŒ ä¼°ç®— å¤§è¡¨ã€å¿«é€Ÿ éœ€è¦å…ˆæ‰§è¡Œ ANALYZEï¼Œè¿”å›çš„ n_live_tup åŸºäºç»Ÿè®¡ä¿¡æ¯ï¼›æ¯” pg_class.reltuples æ›´æ¥è¿‘çœŸå®å€¼ è‡ªå»ºç‰©åŒ–è®¡æ•°è¡¨ é€šè¿‡è§¦å‘å™¨ç»´æŠ¤ï¼šINSERT/DELETE æ—¶æ›´æ–°è®¡æ•°è¡¨ âœ… å®æ—¶ é«˜é¢‘ç»Ÿè®¡ æ•°æ®é‡æå¤§æˆ–é«˜å¹¶å‘åœºæ™¯æœ€ç¨³å¦¥ï¼Œä½†éœ€è¦ç»´æŠ¤é¢å¤–è¡¨ äºŒã€æ¯å¤©ç»Ÿè®¡ä¸€æ¬¡æ¨èç”¨å“ªç§æ–¹å¼ï¼Ÿ å¤§è¡¨ï¼ˆåƒä¸‡æ¡ä»¥ä¸Šï¼‰ï¼š\nä¸æ¨èç›´æ¥ COUNT(*)ï¼Œä¼šå…¨è¡¨æ‰«æ æ¨èä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢ï¼š -- æ–¹æ³• 1ï¼špg_stat_all_tables ANALYZE table_name; -- å¯æ”¾åœ¨ cron æ‰§è¡Œ SELECT n_live_tup FROM pg_stat_all_tables WHERE relname=\u0026#39;table_name\u0026#39;; å¿«é€Ÿï¼Œæ¶ˆè€—ä½\nè¯¯å·®é€šå¸¸åœ¨ 1%-5% èŒƒå›´å†…\nå¦‚æœéœ€è¦æ›´ç²¾ç¡®ï¼Œå¯å®šæ—¶ä½¿ç”¨ COUNT(*) åœ¨å¤œé—´ä½å³°æ‰§è¡Œ\nå°è¡¨ï¼ˆå‡ ä¸‡æ¡ä»¥ä¸‹ï¼‰ï¼š\nç›´æ¥ SELECT COUNT(*) FROM table_name; å°±å¤Ÿ éå¸¸é«˜å¹¶å‘ç³»ç»Ÿï¼š\nå»ºè®® ç‰©åŒ–è®¡æ•°è¡¨ + è§¦å‘å™¨ æˆ– äº‹ä»¶é˜Ÿåˆ— ç»´æŠ¤è®¡æ•° æŸ¥è¯¢ç›´æ¥è¯»å–è®¡æ•°è¡¨ï¼Œæ¯«ç§’çº§è¿”å› ä¸‰ã€æ€»ç»“å»ºè®® ç»Ÿè®¡ç²¾ç¡®è¡Œæ•° -\u0026gt; COUNT(*)ï¼ˆæ…¢ï¼‰ å¿«é€Ÿä¼°ç®—è¡Œæ•° -\u0026gt; pg_stat_all_tables.n_live_tup æˆ– pg_class.reltuples æ¯å¤©å®šæ—¶ç»Ÿè®¡å¤§è¡¨è¡Œæ•° -\u0026gt; ä½¿ç”¨ ANALYZE + n_live_tupï¼Œå­˜åˆ°ç›‘æ§è¡¨ å®æ—¶ç»Ÿè®¡ + é«˜å¹¶å‘ -\u0026gt; å»ºè®¡æ•°è¡¨ + è§¦å‘å™¨ ","description":"å†…å®¹ï¼šç”¨æ³• -\u0026gt; è¡Œä¸ºå·®å¼‚ -\u0026gt; æ€§èƒ½ -\u0026gt; æœ€ä½³å®è·µ\nä¸€ã€SELECT COUNT() ä¸€å…±æœ‰å‡ ç§å¸¸è§ç”¨æ³•ï¼Ÿ åœ¨ PostgreSQL / MySQLï¼ˆä»¥åŠ SQL æ ‡å‡†ï¼‰ä¸­ï¼Œå¸¸è§ 4 ç§ï¼š\nå†™æ³• æ˜¯å¦ç»Ÿè®¡ NULL æ˜¯å¦ç»Ÿè®¡è¡Œ æ˜¯å¦ç­‰ä»· COUNT(*) âœ… åŒ…å« âœ… â­ æ¨è COUNT(1) âœ… åŒ…å« âœ… â‰ˆ COUNT(col) âŒ æ’é™¤ NULL âš ï¸ âŒ COUNT(DISTINCT col) âŒ æ’é™¤ NULL âŒ âŒ äºŒã€æ¯ç§ COUNT çš„è¯¦ç»†è§£é‡Šï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ COUNT(*) â€”â€” æœ€ä½³å®è·µ SELECT COUNT(*) FROM orders; è¡Œä¸º\n"},{"id":359,"href":"/database/postgres/create-table/","title":"PostgreSQL CREATE TABLE","parent":"PostgreSQL","content":" ä¸€ã€CREATE TABLE åŸºæœ¬è¯­æ³• CREATE TABLE table_name ( column_name data_type [column_constraint], ... [table_constraint] ); äºŒã€æœ€åŸºç¡€ç¤ºä¾‹ CREATE TABLE users ( id BIGSERIAL PRIMARY KEY, username TEXT NOT NULL, created_at TIMESTAMP NOT NULL DEFAULT now() ); ä¸‰ã€å¸¸ç”¨å­—æ®µç±»å‹ï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ æ•´æ•°ç±»å‹ ç±»å‹ å­—èŠ‚ è¯´æ˜ SMALLINT 2 å°æ•´æ•° INTEGER / INT 4 å¸¸ç”¨ BIGINT 8 å¤§æ•°æ®é‡ id BIGSERIAL 2ï¸âƒ£ è‡ªå¢ä¸»é”®ï¼ˆæ¨èæ–¹å¼ï¼‰ PostgreSQL 10+ï¼ˆæœ€ä½³å®è·µï¼‰\nid BIGINT GENERATED ALWAYS AS IDENTITY æˆ–ï¼š\nid BIGINT GENERATED BY DEFAULT AS IDENTITY ğŸ“Œ åŒºåˆ«ï¼š\nALWAYSï¼šä¸èƒ½æ‰‹åŠ¨æ’å…¥ BY DEFAULTï¼šå¯æ‰‹åŠ¨è¦†ç›– 3ï¸âƒ£ å­—ç¬¦ä¸²ç±»å‹ ç±»å‹ åœºæ™¯ VARCHAR(n) æœ‰æ˜ç¡®é•¿åº¦é™åˆ¶ TEXT é•¿åº¦æœªçŸ¥ï¼ˆæ¨èï¼‰ CHAR(n) å®šé•¿ï¼ˆä¸æ¨èï¼‰ title VARCHAR(100) NOT NULL content TEXT 4ï¸âƒ£ æ—¶é—´ç±»å‹ï¼ˆé‡ç‚¹ï¼‰ TIMESTAMP -- ä¸å¸¦æ—¶åŒº TIMESTAMPTZ -- å¸¦æ—¶åŒºï¼ˆæ¨èï¼‰ DATE TIME created_at TIMESTAMPTZ NOT NULL DEFAULT now() 5ï¸âƒ£ å¸ƒå°” / JSON is_active BOOLEAN DEFAULT true meta JSONB å››ã€åˆ—çº¦æŸï¼ˆColumn Constraintsï¼‰ 1ï¸âƒ£ NOT NULL username TEXT NOT NULL 2ï¸âƒ£ DEFAULT created_at TIMESTAMPTZ DEFAULT now() 3ï¸âƒ£ UNIQUEï¼ˆå•åˆ—ï¼‰ email TEXT UNIQUE 4ï¸âƒ£ CHECK age INT CHECK (age \u0026gt;= 0) 5ï¸âƒ£ REFERENCESï¼ˆå¤–é”®ï¼‰ role_id INT REFERENCES roles(id) äº”ã€è¡¨çº§çº¦æŸï¼ˆTable Constraintsï¼‰ 1ï¸âƒ£ ä¸»é”® PRIMARY KEY (id) 2ï¸âƒ£ è”åˆå”¯ä¸€çº¦æŸï¼ˆéå¸¸å¸¸è§ï¼‰ UNIQUE (code, url) 3ï¸âƒ£ è”åˆå¤–é”® FOREIGN KEY (user_id, role_id) REFERENCES user_roles(user_id, role_id) å…­ã€å®Œæ•´å®æˆ˜å»ºè¡¨ç¤ºä¾‹ï¼ˆæ¨èå†™æ³•ï¼‰ CREATE TABLE articles ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, datetime TIMESTAMPTZ NOT NULL, code CHAR(6) NOT NULL, source TEXT NOT NULL, title VARCHAR(100) NOT NULL, url TEXT NOT NULL, CONSTRAINT uk_articles_code_url UNIQUE (code, url) ); ä¸ƒã€CREATE TABLE + ç´¢å¼•ï¼ˆæœ€ä½³å®è·µï¼‰ ğŸ“Œ è¡¨ç»“æ„ â‰  ç´¢å¼•\nå»ºè¡¨åå†å»ºç´¢å¼•ï¼ˆæ¨èï¼‰\nCREATE INDEX idx_articles_datetime ON articles (datetime); CREATE INDEX idx_articles_code ON articles (code); LIKE %xxx% æœç´¢ 1ï¸âƒ£ å¯ç”¨æ‰©å±• CREATE EXTENSION IF NOT EXISTS pg_trgm; 2ï¸âƒ£ GIN trigram ç´¢å¼• CREATE INDEX idx_articles_source_trgm ON articles USING gin (source gin_trgm_ops); CREATE INDEX idx_articles_title_trgm ON articles USING gin (title gin_trgm_ops); CREATE INDEX idx_articles_url_trgm ON articles USING gin (url gin_trgm_ops); å…«ã€IF NOT EXISTS / TEMP / UNLOGGED 1ï¸âƒ£ IF NOT EXISTS CREATE TABLE IF NOT EXISTS logs (...); 2ï¸âƒ£ ä¸´æ—¶è¡¨ CREATE TEMP TABLE tmp_result (...); ä¼šè¯ç»“æŸè‡ªåŠ¨åˆ é™¤\n3ï¸âƒ£ UNLOGGEDï¼ˆé«˜æ€§èƒ½ï¼Œä½å®‰å…¨ï¼‰ CREATE UNLOGGED TABLE cache_data (...); âŒ å´©æºƒä¼šä¸¢æ•°æ® âœ… å¿« ä¹ã€è¡¨æ³¨é‡Šï¼ˆå¼ºçƒˆæ¨èï¼‰ COMMENT ON TABLE articles IS \u0026#39;æ–‡ç« è¡¨\u0026#39;; COMMENT ON COLUMN articles.url IS \u0026#39;æ–‡ç« åŸå§‹é“¾æ¥\u0026#39;; åã€CREATE TABLE å¸¸è§å‘ âŒ 1ï¸âƒ£ ç”¨ CHAR å­˜å¯å˜å­—ç¬¦ä¸² code CHAR(6) -- ä¼šè¡¥ç©ºæ ¼ è‹¥æœ‰å†å²åŸå› å¯ä»¥æ¥å— å¦åˆ™ä¼˜å…ˆ VARCHAR(6) âŒ 2ï¸âƒ£ æ‰€æœ‰å­—ç¬¦ä¸²éƒ½ç”¨ VARCHAR(255) PostgreSQL ä¸­ï¼š\nVARCHAR å’Œ TEXT æ€§èƒ½æ— å·®åˆ«\nâŒ 3ï¸âƒ£ å¿½ç•¥æ—¶åŒº æ—¥å¿— / æ•°æ®é‡‡é›†è¡¨ï¼š\nTIMESTAMPTZ åä¸€ã€æ¨èå»ºè¡¨â€œé»„é‡‘æ¨¡æ¿â€ CREATE TABLE xxx ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ, ... ); åäºŒã€æ€»ç»“ CREATE TABLE çš„å…³é”®ä¸æ˜¯â€œèƒ½å»ºâ€ï¼Œè€Œæ˜¯ï¼š\nå­—æ®µç±»å‹é€‰å¯¹ çº¦æŸè®¾è®¡æ¸…æ™° ç´¢å¼•ç‹¬ç«‹è§„åˆ’ ä¸ºæœªæ¥æŸ¥è¯¢æ¨¡å¼æœåŠ¡ ","description":" ä¸€ã€CREATE TABLE åŸºæœ¬è¯­æ³• CREATE TABLE table_name ( column_name data_type [column_constraint], ... [table_constraint] ); äºŒã€æœ€åŸºç¡€ç¤ºä¾‹ CREATE TABLE users ( id BIGSERIAL PRIMARY KEY, username TEXT NOT NULL, created_at TIMESTAMP NOT NULL DEFAULT now() ); ä¸‰ã€å¸¸ç”¨å­—æ®µç±»å‹ï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ æ•´æ•°ç±»å‹ ç±»å‹ å­—èŠ‚ è¯´æ˜ SMALLINT 2 å°æ•´æ•° INTEGER / INT 4 å¸¸ç”¨ BIGINT 8 å¤§æ•°æ®é‡ id BIGSERIAL 2ï¸âƒ£ è‡ªå¢ä¸»é”®ï¼ˆæ¨èæ–¹å¼ï¼‰ PostgreSQL 10+ï¼ˆæœ€ä½³å®è·µï¼‰\n"},{"id":360,"href":"/database/postgres/datetime/","title":"PostgreSQL Datetime","parent":"PostgreSQL","content":" PostgreSQL æŸ¥è¯¢æœ€è¿‘ 3 å¤©æ•°æ®çš„ç¤ºä¾‹ ä½¿ç”¨ CURRENT_DATE (ç²¾ç¡®åˆ°å¤©)\næŸ¥æ‰¾ä»3å¤©å‰å¼€å§‹åˆ°å½“å‰æ—¶åˆ»çš„æ‰€æœ‰è®°å½•\nSELECT * FROM Table WHERE Timestamp_Column \u0026gt;= CURRENT_DATE - INTERVAL \u0026#39;3 days\u0026#39;; ä½¿ç”¨ NOW() æˆ– CURRENT_TIMESTAMP (ç²¾ç¡®åˆ°ç§’)\næ›´ç²¾ç¡®ï¼ŒåŒ…å«è¿‡å»72å°æ—¶å†…çš„æ•°æ®\nSELECT * FROM Table WHERE Timestamp_Column \u0026gt;= NOW() - INTERVAL \u0026#39;3 days\u0026#39;; æŸ¥è¯¢å…·ä½“æ—¶é—´èŒƒå›´ (æ›´ä¸¥è°¨)\næ˜ç¡®å®šä¹‰äº†3å¤©å‰åˆ°ç°åœ¨çš„æ—¶é—´æ®µ\nSELECT * FROM your_table WHERE your_timestamp_column BETWEEN (NOW() - INTERVAL \u0026#39;3 days\u0026#39;) AND NOW(); é’ˆå¯¹æ—¥æœŸç±»å‹åˆ— (DATE)\né€‚ç”¨äº DATE ç±»å‹ï¼Œè€Œä¸æ˜¯ TIMESTAMP\nSELECT * FROM your_table WHERE your_date_column \u0026gt;= CURRENT_DATE - INTERVAL \u0026#39;3 days\u0026#39; AND your_date_column \u0026lt;= CURRENT_DATE; ","description":" PostgreSQL æŸ¥è¯¢æœ€è¿‘ 3 å¤©æ•°æ®çš„ç¤ºä¾‹ ä½¿ç”¨ CURRENT_DATE (ç²¾ç¡®åˆ°å¤©)\næŸ¥æ‰¾ä»3å¤©å‰å¼€å§‹åˆ°å½“å‰æ—¶åˆ»çš„æ‰€æœ‰è®°å½•\nSELECT * FROM Table WHERE Timestamp_Column \u0026gt;= CURRENT_DATE - INTERVAL \u0026#39;3 days\u0026#39;; ä½¿ç”¨ NOW() æˆ– CURRENT_TIMESTAMP (ç²¾ç¡®åˆ°ç§’)\næ›´ç²¾ç¡®ï¼ŒåŒ…å«è¿‡å»72å°æ—¶å†…çš„æ•°æ®\nSELECT * FROM Table WHERE Timestamp_Column \u0026gt;= NOW() - INTERVAL \u0026#39;3 days\u0026#39;; æŸ¥è¯¢å…·ä½“æ—¶é—´èŒƒå›´ (æ›´ä¸¥è°¨)\næ˜ç¡®å®šä¹‰äº†3å¤©å‰åˆ°ç°åœ¨çš„æ—¶é—´æ®µ\nSELECT * FROM your_table WHERE your_timestamp_column BETWEEN (NOW() - INTERVAL \u0026#39;3 days\u0026#39;) AND NOW(); é’ˆå¯¹æ—¥æœŸç±»å‹åˆ— (DATE)\n"},{"id":361,"href":"/database/postgres/explain/","title":"PostgreSQL EXPLAIN","parent":"PostgreSQL","content":" ä¸€ã€EXPLAIN æ˜¯ä»€ä¹ˆï¼Ÿ EXPLAIN ç”¨æ¥å‘Šè¯‰ä½ ï¼šPostgreSQL æ‰“ç®—â€œå¦‚ä½•æ‰§è¡Œâ€è¿™æ¡ SQL\nEXPLAIN SELECT * FROM users WHERE id = 1; ğŸ‘‰ ä¸æ‰§è¡Œ SQLï¼Œåªç”Ÿæˆ æ‰§è¡Œè®¡åˆ’ï¼ˆExecution Planï¼‰\nEXPLAIN vs EXPLAIN ANALYZE å‘½ä»¤ æ˜¯å¦æ‰§è¡Œ SQL ç”¨é€” EXPLAIN âŒ ä¸æ‰§è¡Œ çœ‹ä¼˜åŒ–å™¨â€œæ‰“ç®—æ€ä¹ˆè·‘â€ EXPLAIN ANALYZE âœ… ä¼šæ‰§è¡Œ çœ‹çœŸå®æ‰§è¡Œæƒ…å†µï¼ˆæœ€å‡†ï¼‰ EXPLAIN ANALYZE SELECT * FROM users WHERE id = 1; âš ï¸ ç”Ÿäº§ç¯å¢ƒæ…ç”¨ ANALYZEï¼ˆå¯èƒ½æ˜¯ UPDATE / DELETEï¼‰\näºŒã€æ‰§è¡Œè®¡åˆ’çš„æ•´ä½“ç»“æ„ ä¸€ä¸ªå…¸å‹ EXPLAINï¼š\nSeq Scan on users (cost=0.00..35.50 rows=5 width=64) Filter: (age \u0026gt; 30) æ ¸å¿ƒç»“æ„\n[æ‰§è¡ŒèŠ‚ç‚¹] â””â”€ å­èŠ‚ç‚¹ ğŸ‘‰ ä»å†…åˆ°å¤–è¯»ï¼Œä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ\nä¸‰ã€æœ€é‡è¦çš„ 5 ä¸ªå­—æ®µï¼ˆå¿…èƒŒï¼‰ (cost=0.00..35.50 rows=5 width=64) å­—æ®µ å«ä¹‰ cost æ‰§è¡Œæˆæœ¬ï¼ˆä¼°ç®—å€¼ï¼‰ rows é¢„ä¼°è¿”å›è¡Œæ•° width æ¯è¡Œå¹³å‡å­—èŠ‚æ•° actual time çœŸå®è€—æ—¶ï¼ˆANALYZEï¼‰ loops èŠ‚ç‚¹æ‰§è¡Œæ¬¡æ•° cost è¯¦è§£ cost = å¯åŠ¨æˆæœ¬ .. æ€»æˆæœ¬\nå¯åŠ¨æˆæœ¬ï¼šè¿”å›ç¬¬ä¸€è¡Œå‰çš„ä»£ä»· æ€»æˆæœ¬ï¼šè¿”å›æ‰€æœ‰è¡Œçš„ä»£ä»· ğŸ‘‰ cost ä¸æ˜¯æ—¶é—´ï¼Œæ˜¯ç›¸å¯¹å€¼\nå››ã€æœ€å¸¸è§çš„æ‰«ææ–¹å¼ï¼ˆğŸ”¥é‡ç‚¹ï¼‰ 1ï¸âƒ£ Seq Scanï¼ˆå…¨è¡¨æ‰«æï¼‰ Seq Scan on users å«ä¹‰\nä»å¤´æ‰«åˆ°å°¾ å¤§è¡¨é€šå¸¸æ˜¯æ€§èƒ½æ€æ‰‹ å‡ºç°åŸå› \næ— ç´¢å¼• æ¡ä»¶ä¸èµ°ç´¢å¼• è¿”å›è¡Œå¤ªå¤š 2ï¸âƒ£ Index Scanï¼ˆç´¢å¼•æ‰«æï¼‰ Index Scan using users_pkey on users ç‰¹ç‚¹\nå…ˆèµ°ç´¢å¼• å†å›è¡¨ï¼ˆheapï¼‰ é€‚ç”¨\nè¿”å›å°‘é‡è¡Œ 3ï¸âƒ£ Index Only Scanï¼ˆè¦†ç›–ç´¢å¼•ï¼‰ Index Only Scan using idx_users_age ç‰¹ç‚¹ï¼ˆæ€§èƒ½æœ€å¥½ï¼‰\nä¸å›è¡¨ åªè¯»ç´¢å¼• æ¡ä»¶\næŸ¥è¯¢å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ visibility map è¶³å¤Ÿå¹²å‡€ï¼ˆVACUUMï¼‰ 4ï¸âƒ£ Bitmap Index Scan + Bitmap Heap Scan Bitmap Index Scan Bitmap Heap Scan é€‚ç”¨\nè¿”å›ä¸­ç­‰æ•°é‡è¡Œ å¤šæ¡ä»¶ç´¢å¼• ğŸ‘‰ å¸¸è§äºï¼š\nWHERE a = 1 AND b = 2 äº”ã€JOIN æ‰§è¡Œæ–¹å¼ï¼ˆğŸ”¥ğŸ”¥ï¼‰ 1ï¸âƒ£ Nested Loopï¼ˆåµŒå¥—å¾ªç¯ï¼‰ Nested Loop ç‰¹ç‚¹\nå°è¡¨é©±åŠ¨å¤§è¡¨ é€‚åˆï¼š ä¸»é”® JOIN å°ç»“æœé›† å±é™©\nå¤§è¡¨ Ã— å¤§è¡¨ = ç¾éš¾ 2ï¸âƒ£ Hash Joinï¼ˆæœ€å¸¸ç”¨ï¼‰ Hash Join ç‰¹ç‚¹\næ„å»º hash è¡¨ é€‚åˆç­‰å€¼ JOIN ON a.id = b.id 3ï¸âƒ£ Merge Join Merge Join ç‰¹ç‚¹\nåŒæ–¹å¿…é¡»æœ‰åº å¸¸ç”¨äºï¼š å·²æ’åºç´¢å¼• ORDER BY + JOIN å…­ã€Filter / Index Cond çš„åŒºåˆ« Index Cond: (id = 1) Filter: (status = \u0026#39;active\u0026#39;) é¡¹ å«ä¹‰ Index Cond åœ¨ç´¢å¼•å±‚è¿‡æ»¤ Filter å›è¡¨åå†è¿‡æ»¤ï¼ˆæ…¢ï¼‰ ğŸ‘‰ Filter è¶Šå¤šï¼Œç´¢å¼•è¶Šæ²¡ç”¨\nä¸ƒã€EXPLAIN ANALYZE çš„æ ¸å¿ƒæŒ‡æ ‡ actual time=0.025..0.030 rows=1 loops=1 é‡ç‚¹å…³æ³¨\nactual time æ˜¯å¦è¿œå¤§äº cost rows é¢„ä¼° vs å®é™…æ˜¯å¦å·®å¾ˆå¤š loops æ˜¯å¦å¼‚å¸¸ ä¼°ç®—ä¸å‡†çš„åŸå› \nç»Ÿè®¡ä¿¡æ¯è¿‡æ—§ æ•°æ®åˆ†å¸ƒä¸å‡ è§£å†³\nANALYZE table_name; å…«ã€å¸¸è§æ€§èƒ½é—®é¢˜ \u0026amp; EXPLAIN è¡¨ç° âŒ 1. ç´¢å¼•æ²¡ç”¨ä¸Š Seq Scan on big_table å¯èƒ½åŸå› ï¼š\nå‡½æ•°åŒ…è£¹å­—æ®µ éšå¼ç±»å‹è½¬æ¢ LIKE \u0026lsquo;%xxx%\u0026rsquo; âŒ 2. rows ä¼°ç®—ä¸¥é‡åå·® rows=10 actual rows=100000 åŸå› ï¼š\nç»Ÿè®¡ä¿¡æ¯ä¸å‡† éœ€è¦ extended statistics CREATE STATISTICS s1 ON a, b FROM t; ANALYZE t; âŒ 3. Nested Loop çˆ†ç‚¸ Nested Loop (rows=100000 loops=100000) è§£å†³ï¼š\nåŠ ç´¢å¼• æ”¹ JOIN é¡ºåº æé«˜ work_memï¼ˆå…è®¸ Hash Joinï¼‰ ä¹ã€EXPLAIN å¸¸ç”¨å‚æ•°ï¼ˆå®æˆ˜ï¼‰ EXPLAIN (ANALYZE, BUFFERS, VERBOSE) SELECT ... å‚æ•° ä½œç”¨ ANALYZE çœŸå®æ‰§è¡Œ BUFFERS æ˜¾ç¤ºç¼“å­˜å‘½ä¸­ VERBOSE æ˜¾ç¤ºè¯¦ç»†å­—æ®µ TIMING æ˜¾ç¤ºç²¾ç¡®æ—¶é—´ BUFFERS ç¤ºä¾‹\nBuffers: shared hit=120 read=10 hitï¼šå‘½ä¸­ç¼“å­˜ readï¼šç£ç›˜è¯»å–ï¼ˆæ…¢ï¼‰ åã€EXPLAIN è°ƒä¼˜å¥—è·¯ï¼ˆâ­é€šç”¨ï¼‰ ä¸€å¥å£è¯€ï¼š\nå…ˆçœ‹ Scan -\u0026gt; å†çœ‹ Join -\u0026gt; å†çœ‹ rows -\u0026gt; æœ€åçœ‹ Buffers\næ ‡å‡†æµç¨‹\næ˜¯å¦å…¨è¡¨æ‰«æï¼Ÿ ç´¢å¼•æ˜¯å¦å‘½ä¸­ï¼Ÿ JOIN æ–¹å¼æ˜¯å¦åˆç†ï¼Ÿ rows é¢„ä¼°æ˜¯å¦ç¦»è°±ï¼Ÿ æ˜¯å¦å¤§é‡ç£ç›˜ IOï¼Ÿ åä¸€ã€å…¶å®ƒ Qï¼šEXPLAIN cost æ˜¯æ—¶é—´å—ï¼Ÿ Aï¼šä¸æ˜¯ï¼Œæ˜¯ç›¸å¯¹ä»£ä»·å•ä½ã€‚\nQï¼šä¸ºä»€ä¹ˆç”¨äº†ç´¢å¼•è¿˜æ˜¯ Seq Scanï¼Ÿ Aï¼šè¿”å›è¡Œå¤ªå¤šï¼Œä¼˜åŒ–å™¨è®¤ä¸ºé¡ºæ‰«æ›´å¿«ã€‚\nQï¼šIndex Only Scan ä¸ºä»€ä¹ˆæ›´å¿«ï¼Ÿ Aï¼šä¸å›è¡¨ï¼Œåªè¯»ç´¢å¼•ã€‚\nQï¼šHash Join ä»€ä¹ˆæ—¶å€™æ¯” Nested Loop å¥½ï¼Ÿ Aï¼šå¤§è¡¨ç­‰å€¼ JOINã€‚\nQï¼šå¦‚ä½•è®©ä¼˜åŒ–å™¨æ›´å‡†ç¡®ï¼Ÿ Aï¼šANALYZEã€VACUUMã€extended statisticsã€‚\nåäºŒã€å¯ä»¥ç›´æ¥ç”¨çš„ EXPLAIN æ¨¡æ¿ EXPLAIN (ANALYZE, BUFFERS) SELECT ... EXPLAIN ANALYSE Execution Time å’Œå®é™…çš„æŸ¥è¯¢æ—¶é—´å·®è·å¾ˆå¤§ è¿™æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹ã€è€Œä¸”éå¸¸å®¹æ˜“è¢«è¯¯åˆ¤çš„é—®é¢˜ã€‚\nä¸‹é¢æŒ‰ ã€Œç»“è®º -\u0026gt; åŸå› åˆ†ç±» -\u0026gt; å¦‚ä½•éªŒè¯ -\u0026gt; è§£å†³å»ºè®®ã€ å¯ä»¥ç›´æ¥å¯¹ç…§æ’æŸ¥çš„å®Œæ•´è§£é‡Šã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆé‡ç‚¹ï¼‰ EXPLAIN ANALYZE é‡Œçš„ Execution Time â‰  å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°çš„â€œæŸ¥è¯¢è€—æ—¶â€\nä¸¤è€…æœ¬æ¥å°±ä¸ä¸€å®šç›¸ç­‰ï¼Œè€Œä¸”å·®è·å¤§é€šå¸¸æ˜¯æ­£å¸¸ç°è±¡ã€‚\näºŒã€Execution Time åˆ°åº•ç»Ÿè®¡äº†ä»€ä¹ˆï¼Ÿ EXPLAIN ANALYZE ç»Ÿè®¡çš„æ˜¯ï¼š\nåŒ…å« ä¸åŒ…å« SQL æ‰§è¡Œå™¨è€—æ—¶ ç½‘ç»œä¼ è¾“ è¡¨æ‰«æ / ç´¢å¼•æ‰«æ å®¢æˆ·ç«¯æ¸²æŸ“ æ’åº / Join / èšåˆ ORM åºåˆ—åŒ– WAL ç”Ÿæˆ å®¢æˆ·ç«¯è§£æ CPU + IO å®¢æˆ·ç«¯ç­‰å¾… ğŸ“Œ ä¸åŒ…æ‹¬ï¼š\nç»“æœé›†ä¼ è¾“æ—¶é—´ å®¢æˆ·ç«¯è¯»å–æ—¶é—´ å®¢æˆ·ç«¯æ‰“å° / JSON åºåˆ—åŒ– ORM æ˜ å°„å¯¹è±¡ ä¸‰ã€æœ€å¸¸è§çš„ 8 ä¸ªåŸå› ï¼ˆéå¸¸å®æˆ˜ï¼‰ 1ï¸âƒ£ ç»“æœé›†å¾ˆå¤§ï¼ˆç¬¬ä¸€å¤§åŸå› ï¼‰ å…¸å‹ç°è±¡\nEXPLAIN ANALYZE SELECT * FROM logs; Execution Time: 20 ms å®¢æˆ·ç«¯å´ï¼š\n2.3 ç§’\nåŸå› \nPostgreSQL å¾ˆå¿«ç®—å®Œ æ…¢åœ¨â€œå‘æ•°æ®â€ ğŸ“Œ EXPLAIN ä¸è®¡ç®— socket å‘é€æ—¶é—´\néªŒè¯æ–¹æ³•\nEXPLAIN ANALYZE SELECT count(*) FROM logs; å¦‚æœ count(*) å¾ˆå¿«ï¼Œè¯´æ˜æ…¢åœ¨ç»“æœä¼ è¾“ã€‚\n2ï¸âƒ£ ORM / é©±åŠ¨å±‚å¤„ç†å¾ˆæ…¢ å¸¸è§åœºæ™¯\nSQLAlchemy Django ORM è¿”å›å¯¹è±¡æ•°å¤š session.execute(stmt).scalars().all() # æ…¢ ğŸ“Œ ORM åˆ›å»ºå¯¹è±¡ã€æ˜ å°„å­—æ®µéå¸¸è€—æ—¶\néªŒè¯æ–¹æ³•\npsql é‡Œæ‰§è¡ŒåŒæ · SQL å¯¹æ¯” ORM æ‰§è¡Œæ—¶é—´ 3ï¸âƒ£ ç½‘ç»œå»¶è¿Ÿï¼ˆè¿œç¨‹æ•°æ®åº“ï¼‰ ç¯å¢ƒ å½±å“ æœ¬æœº psql å¾ˆå¿« è¿œç¨‹ ORM å¾ˆæ…¢ è·¨åœ°åŸŸ éå¸¸æ…¢ ğŸ“Œ EXPLAIN å®Œå…¨ä¸æ¶‰åŠç½‘ç»œ\n4ï¸âƒ£ å®¢æˆ·ç«¯åˆ†é¡µ / æ¸²æŸ“æ—¶é—´ CLI è¾“å‡º 1 ä¸‡è¡Œ GUI å·¥å…·ï¼ˆDBeaver / DataGripï¼‰ ğŸ“Œ æ˜¾ç¤ºæ¯”æŸ¥è¯¢è¿˜æ…¢\n5ï¸âƒ£ æŸ¥è¯¢è¢«ç¼“å­˜äº†ï¼ˆå‡å¿«ï¼‰ EXPLAIN ANALYZE è¿è·‘ä¸¤æ¬¡\nç¬¬ä¸€æ¬¡æ…¢ ç¬¬äºŒæ¬¡å¿« ğŸ“Œ Execution Time æ˜¯ ç¼“å­˜å‘½ä¸­åçš„\n6ï¸âƒ£ EXPLAIN ANALYZE æœ¬èº«æ”¹å˜æ‰§è¡Œæ–¹å¼ ç¦ç”¨äº†å¹¶è¡Œï¼Ÿ ä¸èµ°ç¼“å­˜è·¯å¾„ï¼Ÿ å°¤å…¶æ˜¯ï¼š\nEXPLAIN ANALYZE INSERT / UPDATE 7ï¸âƒ£ å¹¶è¡ŒæŸ¥è¯¢çš„æ—¶é—´ç†è§£é”™è¯¯ï¼ˆé«˜çº§ï¼‰ Workers Planned: 4 Execution Time: 100 ms å¹¶ä¸ç­‰äºï¼š\n4 Ã— 100 ms\nğŸ‘‰ æ˜¯ å¢™é’Ÿæ—¶é—´ï¼ˆwall clockï¼‰\n8ï¸âƒ£ autocommit / äº‹åŠ¡æäº¤è€—æ—¶ å®¢æˆ·ç«¯çœ‹åˆ°æ…¢ï¼Œå…¶å®æ…¢åœ¨ï¼š\ncommit fsync WAL flush ğŸ“Œ EXPLAIN ç»Ÿè®¡ä¸åŒ…å« commit\nå››ã€æœ€é‡è¦çš„ä¸€æ¡ï¼šå¦‚ä½•å¯¹é½çœŸå®æ—¶é—´ï¼Ÿ æ–¹æ³• 1ï¼špsql æ‰“å¼€è®¡æ—¶ \\timing on SELECT ...; ä½ çœ‹åˆ°çš„æ‰æ˜¯ çœŸå®ç«¯åˆ°ç«¯è€—æ—¶\næ–¹æ³• 2ï¼šå¯¹æ¯” 3 ä¸ªæ—¶é—´ æ—¶é—´ çœ‹å“ªé‡Œ EXPLAIN Execution Time DB æ‰§è¡Œ psql \\timing DB + ç½‘ç»œ åº”ç”¨æ—¥å¿— å…¨é“¾è·¯ äº”ã€å¿«é€Ÿå®šä½â€œæ…¢åœ¨å“ªä¸€å±‚â€ï¼ˆè¡¨æ ¼ï¼‰ ç°è±¡ ç»“è®º EXPLAIN å¿«ï¼Œpsql æ…¢ ç½‘ç»œ / ç»“æœé›† psql å¿«ï¼ŒORM æ…¢ ORM é¦–æ¬¡æ…¢ï¼Œåç»­å¿« ç¼“å­˜ count(*) å¿«ï¼Œselect æ…¢ ä¼ è¾“ æ‰§è¡Œæ—¶é—´æŠ–åŠ¨ IO / äº‘ç›˜ å…­ã€å®æˆ˜ç¤ºä¾‹å¯¹ç…§ SQL\nSELECT * FROM articles ORDER BY datetime DESC LIMIT 10000; åœºæ™¯ æ—¶é—´ EXPLAIN ANALYZE 15 ms psql 120 ms Python ORM 800 ms ğŸ‘‰ æ•°æ®åº“ä¸æ˜¯ç“¶é¢ˆ\nä¸ƒã€è§£å†³å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ âœ… ä¼˜å…ˆçº§ 1 LIMIT åª SELECT å¿…è¦å­—æ®µ âœ… ä¼˜å…ˆçº§ 2 æ¸¸æ ‡ / æµå¼è¯»å– æœåŠ¡å™¨ç«¯åˆ†é¡µ âœ… ä¼˜å…ˆçº§ 3 é™ä½ç½‘ç»œ RTT æ•°æ®åº“ä¸åº”ç”¨åŒæœºæˆ¿ å…«ã€æ€»ç»“ EXPLAIN ANALYZE çš„ Execution Time åªç»Ÿè®¡æ•°æ®åº“å†…éƒ¨æ‰§è¡Œæ—¶é—´ï¼Œ ä¸åŒ…å«ç½‘ç»œä¼ è¾“ã€å®¢æˆ·ç«¯å¤„ç†å’Œç»“æœæ¸²æŸ“ï¼Œ ä¸¤è€…å·®è·å¤§é€šå¸¸æ˜¯ç»“æœé›†æˆ–å®¢æˆ·ç«¯é—®é¢˜ï¼Œè€Œé SQL æœ¬èº«æ…¢ã€‚\n","description":" ä¸€ã€EXPLAIN æ˜¯ä»€ä¹ˆï¼Ÿ EXPLAIN ç”¨æ¥å‘Šè¯‰ä½ ï¼šPostgreSQL æ‰“ç®—â€œå¦‚ä½•æ‰§è¡Œâ€è¿™æ¡ SQL\nEXPLAIN SELECT * FROM users WHERE id = 1; ğŸ‘‰ ä¸æ‰§è¡Œ SQLï¼Œåªç”Ÿæˆ æ‰§è¡Œè®¡åˆ’ï¼ˆExecution Planï¼‰\nEXPLAIN vs EXPLAIN ANALYZE å‘½ä»¤ æ˜¯å¦æ‰§è¡Œ SQL ç”¨é€” EXPLAIN âŒ ä¸æ‰§è¡Œ çœ‹ä¼˜åŒ–å™¨â€œæ‰“ç®—æ€ä¹ˆè·‘â€ EXPLAIN ANALYZE âœ… ä¼šæ‰§è¡Œ çœ‹çœŸå®æ‰§è¡Œæƒ…å†µï¼ˆæœ€å‡†ï¼‰ EXPLAIN ANALYZE SELECT * FROM users WHERE id = 1; âš ï¸ ç”Ÿäº§ç¯å¢ƒæ…ç”¨ ANALYZEï¼ˆå¯èƒ½æ˜¯ UPDATE / DELETEï¼‰\n"},{"id":362,"href":"/database/postgres/huge_pages/","title":"PostgreSQL huge_pages","parent":"PostgreSQL","content":"PostgreSQL ä¸­çš„ huge_pages å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦ä¸º PostgreSQL å…±äº«å†…å­˜åŒºåŸŸè¯·æ±‚å¤§é¡µã€‚æœ‰æ•ˆå€¼ä¸º tryï¼ˆé»˜è®¤ï¼‰ã€on å’Œ offã€‚å½“è®¾ç½®ä¸º on æ—¶ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼ˆä¾‹å¦‚æ“ä½œç³»ç»Ÿæœªé…ç½®æˆ–é…ç½®ä¸å½“ï¼‰ï¼Œæ•°æ®åº“å°†æ— æ³•å¯åŠ¨ï¼›è®¾ç½®ä¸º try æ—¶ï¼Œå¦‚æœå¤±è´¥ä¼šå›é€€åˆ°ä½¿ç”¨æ™®é€šå†…å­˜ï¼›è®¾ç½®ä¸º off åˆ™ç¦ç”¨å¤§é¡µã€‚\nhuge_pages å‚æ•°è¯´æ˜ try: é»˜è®¤å€¼ã€‚æœåŠ¡å™¨ä¼šå°è¯•ä½¿ç”¨å¤§é¡µï¼Œå¦‚æœå¤±è´¥åˆ™ä¼šå›é€€åˆ°ä½¿ç”¨æ™®é€šå†…å­˜ã€‚\non: å¼ºåˆ¶ä½¿ç”¨å¤§é¡µã€‚å¦‚æœå¤§é¡µè¯·æ±‚å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œæ“ä½œç³»ç»Ÿæœªé…ç½®æˆ–é…ç½®çš„å¤§é¡µå°äºæ‰€éœ€çš„å†…å­˜ï¼‰ï¼ŒPostgreSQL å°†æ— æ³•å¯åŠ¨ã€‚\noff: ç¦ç”¨å¤§é¡µã€‚PostgreSQL ä¸ä¼šå°è¯•ä½¿ç”¨å¤§é¡µã€‚\nä½¿ç”¨å»ºè®® é¦–é€‰ try: åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå»ºè®®å°† huge_pages è®¾ç½®ä¸º tryï¼Œä»¥ç¡®ä¿åœ¨é…ç½®ä¸å½“çš„æƒ…å†µä¸‹æ•°æ®åº“ä»èƒ½å¯åŠ¨ï¼Œå¹¶å°è¯•åˆ©ç”¨å¤§é¡µæé«˜æ€§èƒ½ã€‚\nå…³æ³¨æ€§èƒ½å½±å“: å¤§é¡µçš„ä½¿ç”¨æ€§èƒ½å–å†³äºè¿æ¥æ•°ã€‚å½“è¿æ¥æ•°è¾ƒå°‘æ—¶ï¼Œå¯èƒ½ä¸å¦‚ä¸ä½¿ç”¨å¤§é¡µã€‚å»ºè®®ä½¿ç”¨è¿æ¥æ± æ¥å‡å°‘è¿æ¥æ•°ï¼Œä»è€Œåœ¨å¯ç”¨å¤§é¡µçš„æƒ…å†µä¸‹æå‡æ€§èƒ½ã€‚\nè°ƒæ•´å…±äº«å†…å­˜å‚æ•°åéœ€é‡æ–°è®¡ç®—: ä¿®æ”¹å¦‚ shared_buffers å’Œ wal_buffers ç­‰å…±äº«å†…å­˜ç›¸å…³å‚æ•°æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ‰€éœ€çš„æ€»å¤§é¡µå†…å­˜ï¼Œä»¥ç¡®ä¿æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œé¿å…å¯åŠ¨å¤±è´¥æˆ–å†…å­˜æµªè´¹ã€‚\n","description":"PostgreSQL ä¸­çš„ huge_pages å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦ä¸º PostgreSQL å…±äº«å†…å­˜åŒºåŸŸè¯·æ±‚å¤§é¡µã€‚æœ‰æ•ˆå€¼ä¸º tryï¼ˆé»˜è®¤ï¼‰ã€on å’Œ offã€‚å½“è®¾ç½®ä¸º on æ—¶ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼ˆä¾‹å¦‚æ“ä½œç³»ç»Ÿæœªé…ç½®æˆ–é…ç½®ä¸å½“ï¼‰ï¼Œæ•°æ®åº“å°†æ— æ³•å¯åŠ¨ï¼›è®¾ç½®ä¸º try æ—¶ï¼Œå¦‚æœå¤±è´¥ä¼šå›é€€åˆ°ä½¿ç”¨æ™®é€šå†…å­˜ï¼›è®¾ç½®ä¸º off åˆ™ç¦ç”¨å¤§é¡µã€‚\nhuge_pages å‚æ•°è¯´æ˜ try: é»˜è®¤å€¼ã€‚æœåŠ¡å™¨ä¼šå°è¯•ä½¿ç”¨å¤§é¡µï¼Œå¦‚æœå¤±è´¥åˆ™ä¼šå›é€€åˆ°ä½¿ç”¨æ™®é€šå†…å­˜ã€‚\non: å¼ºåˆ¶ä½¿ç”¨å¤§é¡µã€‚å¦‚æœå¤§é¡µè¯·æ±‚å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œæ“ä½œç³»ç»Ÿæœªé…ç½®æˆ–é…ç½®çš„å¤§é¡µå°äºæ‰€éœ€çš„å†…å­˜ï¼‰ï¼ŒPostgreSQL å°†æ— æ³•å¯åŠ¨ã€‚\noff: ç¦ç”¨å¤§é¡µã€‚PostgreSQL ä¸ä¼šå°è¯•ä½¿ç”¨å¤§é¡µã€‚\nä½¿ç”¨å»ºè®® é¦–é€‰ try: åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå»ºè®®å°† huge_pages è®¾ç½®ä¸º tryï¼Œä»¥ç¡®ä¿åœ¨é…ç½®ä¸å½“çš„æƒ…å†µä¸‹æ•°æ®åº“ä»èƒ½å¯åŠ¨ï¼Œå¹¶å°è¯•åˆ©ç”¨å¤§é¡µæé«˜æ€§èƒ½ã€‚\nå…³æ³¨æ€§èƒ½å½±å“: å¤§é¡µçš„ä½¿ç”¨æ€§èƒ½å–å†³äºè¿æ¥æ•°ã€‚å½“è¿æ¥æ•°è¾ƒå°‘æ—¶ï¼Œå¯èƒ½ä¸å¦‚ä¸ä½¿ç”¨å¤§é¡µã€‚å»ºè®®ä½¿ç”¨è¿æ¥æ± æ¥å‡å°‘è¿æ¥æ•°ï¼Œä»è€Œåœ¨å¯ç”¨å¤§é¡µçš„æƒ…å†µä¸‹æå‡æ€§èƒ½ã€‚\nè°ƒæ•´å…±äº«å†…å­˜å‚æ•°åéœ€é‡æ–°è®¡ç®—: ä¿®æ”¹å¦‚ shared_buffers å’Œ wal_buffers ç­‰å…±äº«å†…å­˜ç›¸å…³å‚æ•°æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ‰€éœ€çš„æ€»å¤§é¡µå†…å­˜ï¼Œä»¥ç¡®ä¿æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œé¿å…å¯åŠ¨å¤±è´¥æˆ–å†…å­˜æµªè´¹ã€‚\n"},{"id":363,"href":"/database/postgres/join/","title":"PostgreSQL Join","parent":"PostgreSQL","content":"ä¸‹é¢ç»™ä½ ä¸€å¥— æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°ã€æœ€å¯å®æˆ˜æ“ä½œçš„ PostgreSQL JOIN è¯¦ç»†æ•™ç¨‹ã€‚\næ¶µç›– 7 ç§ JOINã€ç»´æ©å›¾è§£é‡Šã€è¯­æ³•ã€ç¤ºä¾‹ã€æœ€ä½³å®è·µã€æ€§èƒ½ä¼˜åŒ–ï¼Œé€‚åˆä½ å½“å‰çš„åç«¯å¼€å‘ï¼ˆFastAPI + PostgreSQLï¼‰åœºæ™¯ã€‚\nğŸ“˜ PostgreSQL JOIN è¯¦ç»†æ•™ç¨‹ï¼ˆå®Œæ•´ç‰ˆï¼‰\nâ­ ç›®å½• JOIN çš„ä½œç”¨ JOIN çš„åˆ†ç±»ä¸å¯¹ç…§ æ¯ä¸€ç§ JOIN çš„è¯­æ³• + ç»´æ©å›¾ + ç¤ºä¾‹ JOIN çš„ç­›é€‰è§„åˆ™ï¼ˆWHERE ä¸ ON çš„åŒºåˆ«ï¼‰ å¤šè¡¨ JOIN JOIN æ€§èƒ½ä¼˜åŒ– JOIN å¸¸è§é”™è¯¯ä¸è§£å†³ JOIN æœ€ä½³å®è·µæ€»ç»“ 1. JOIN æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ JOIN ç”¨äºï¼š\nå°† ä¸¤å¼ æˆ–å¤šå¼ è¡¨ æŒ‰æŸä¸ªå­—æ®µ å…³è”è¿æ¥ ä»ä¸åŒè¡¨ä¸­ç»„æˆæ›´å®Œæ•´çš„æ•°æ®é›† å®ç°å¤æ‚æŸ¥è¯¢é€»è¾‘ å®ƒçš„æœ¬è´¨ï¼š\nJOIN å°±æ˜¯ç”¨ä¸€ä¸ªå­—æ®µä½œä¸ºâ€œé”®â€ï¼ŒæŠŠå¤šå¼ è¡¨çš„ç›¸å…³æ•°æ®æ‹¼æˆåŒä¸€è¡Œã€‚\n2. PostgreSQL JOIN åˆ†ç±»ï¼ˆ7 ç§ï¼‰ JOIN ç±»å‹ è¯´æ˜ æ˜¯å¦ä¿ç•™ä¸åŒ¹é…è®°å½• INNER JOIN äº¤é›† âŒ ä¸ä¿ç•™ LEFT JOIN A å…¨éƒ¨ + Aâˆ©B âœ… A RIGHT JOIN B å…¨éƒ¨ + Aâˆ©B âœ… B FULL JOIN A âˆª B âœ… A \u0026amp; B CROSS JOIN ç¬›å¡å°”ç§¯ å…¨ä¿ç•™ SELF JOIN è‡ªå·± JOIN è‡ªå·± æŒ‰è¯­æ³•å†³å®š ANTI JOINï¼ˆNOT INï¼‰ A - B âœ… A 3. å„ç§ JOIN è¯¦ç»†è§£é‡Šï¼ˆå«ç»´æ©å›¾ä¸ç¤ºä¾‹ï¼‰ å‡è®¾è¡¨ï¼š\nA(id, a_value) B(id, b_value) CREATE TABLE \u0026#34;public\u0026#34;.\u0026#34;a\u0026#34; ( \u0026#34;id\u0026#34; int4 NOT NULL, \u0026#34;name\u0026#34; varchar(255), PRIMARY KEY (\u0026#34;id\u0026#34;) ); CREATE TABLE \u0026#34;public\u0026#34;.\u0026#34;b\u0026#34; ( \u0026#34;id\u0026#34; int4 NOT NULL, \u0026#34;name\u0026#34; varchar(255), PRIMARY KEY (\u0026#34;id\u0026#34;) ); INSERT INTO \u0026#34;public\u0026#34;.\u0026#34;a\u0026#34; (\u0026#34;id\u0026#34;, \u0026#34;name\u0026#34;) VALUES (1, \u0026#39;Jack\u0026#39;); INSERT INTO \u0026#34;public\u0026#34;.\u0026#34;a\u0026#34; (\u0026#34;id\u0026#34;, \u0026#34;name\u0026#34;) VALUES (2, \u0026#39;Tom\u0026#39;); INSERT INTO \u0026#34;public\u0026#34;.\u0026#34;b\u0026#34; (\u0026#34;id\u0026#34;, \u0026#34;name\u0026#34;) VALUES (2, \u0026#39;Tom\u0026#39;); INSERT INTO \u0026#34;public\u0026#34;.\u0026#34;b\u0026#34; (\u0026#34;id\u0026#34;, \u0026#34;name\u0026#34;) VALUES (3, \u0026#39;Rose\u0026#39;); 3.1 INNER JOINï¼ˆäº¤é›†ï¼‰ ğŸ¯ ä¸¤è¾¹éƒ½å­˜åœ¨çš„è®°å½•æ‰ä¼šè¿”å›ã€‚\nè¯­æ³•ï¼š\nSELECT * FROM A INNER JOIN B ON A.id = B.id; ç¤ºä¾‹ç»“æœï¼šåªè¿”å›ä¸¤è¡¨éƒ½æœ‰çš„ idã€‚\nid name id name 2 Tom 2 Tom 3.2 LEFT JOINï¼ˆå·¦è¡¨å…¨éƒ¨ + å³è¡¨åŒ¹é…çš„éƒ¨åˆ†ï¼‰ è¯­æ³•ï¼š\nSELECT * FROM A LEFT JOIN B ON A.id = B.id; æ²¡åŒ¹é…åˆ° B æ—¶ï¼ŒB çš„å­—æ®µä¸º nullã€‚ å¸¸ç”¨åœºæ™¯ï¼šä¸»æ•°æ®åœ¨ Aï¼Œé™„å±æ•°æ®åœ¨ Bã€‚ id name id name 1 Jack 2 Tom 2 Tom 3.3 RIGHT JOINï¼ˆå³è¡¨å…¨éƒ¨ + å·¦è¡¨åŒ¹é…ï¼‰ è¯­æ³•ï¼š\nSELECT * FROM A RIGHT JOIN B ON A.id = B.id; id name id name 2 Tom 2 Tom 3 Rose 3.4 FULL JOINï¼ˆå¹¶é›†ï¼šA âˆª Bï¼‰ åŒ…æ‹¬ï¼š\nA âˆ© B A ç‹¬æœ‰ B ç‹¬æœ‰ è¯­æ³•ï¼š\nSELECT * FROM A FULL JOIN B ON A.id = B.id; å¸¸ç”¨äºï¼šåˆå¹¶ä¸¤å¥—æ•°æ®æºã€‚\nid name id name 1 Jack 2 Tom 2 Tom 3 Rose 3.5 CROSS JOINï¼ˆç¬›å¡å°”ç§¯ï¼‰ A çš„æ¯ä¸€è¡Œ Ã— B çš„æ¯ä¸€è¡Œ\nè¯­æ³•ï¼š\nSELECT * FROM A CROSS JOIN B; ç¤ºä¾‹ï¼š\nA 3 è¡Œ Ã— B 4 è¡Œ = 12 è¡Œç»“æœã€‚\nid name id name 1 Jack 2 Tom 1 Jack 3 Rose 2 Tom 2 Tom 2 Tom 3 Rose 3.6 SELF JOINï¼ˆè‡ªè¿æ¥ï¼‰ è¯­æ³•ï¼š\nSELECT a1.id, a2.id FROM A AS a1 JOIN A AS a2 ON a1.id != a2.id; id id 1 2 2 1 å¸¸ç”¨äºï¼š\nå±‚çº§ç»“æ„ çˆ¶å­å…³ç³» ç›¸é‚»æ¯”è¾ƒ 3.7 ANTI JOINï¼ˆA - Bï¼‰ PostgreSQL ç”¨ï¼š\næ–¹æ³• 1ï¼šLEFT JOIN + NULL SELECT A.* FROM A LEFT JOIN B ON A.id = B.id WHERE B.id IS NULL; id name 1 Jack æ–¹æ³• 2ï¼šNOT EXISTSï¼ˆæ€§èƒ½æœ€ä½³ï¼‰ SELECT A.* FROM A WHERE NOT EXISTS ( SELECT 1 FROM B WHERE B.id = A.id ); id name 1 Jack 4. ON vs WHERE çš„åŒºåˆ«ï¼ˆå¿…æ‡‚ï¼‰ âŒ é”™è¯¯ç”¨æ³•ï¼ˆWHERE ä¼šå½±å“ JOIN è¡Œä¸ºï¼‰ï¼š\nSELECT * FROM A LEFT JOIN B ON A.id = B.id WHERE B.name = \u0026#39;Tom\u0026#39;; âš ï¸ è¿™ä¼šæŠŠä¸åŒ¹é…çš„è¡Œè¿‡æ»¤æ‰ -\u0026gt; å®é™…å˜æˆ INNER JOINï¼\nid name id name 2 Tom 2 Tom âœ… æ­£ç¡®ç”¨æ³•ï¼š\nSELECT * FROM A LEFT JOIN B ON A.id = B.id AND B.name = \u0026#39;Tom\u0026#39;; id name id name 1 Jack 2 Tom 2 Tom è¦ç‚¹ï¼š\nLEFT JOIN çš„è¿‡æ»¤æ¡ä»¶å†™åœ¨ ON ä¸­ï¼Œä¸å†™ WHEREã€‚ WHERE ä¼šæŠŠ null è¡Œè¿‡æ»¤æ‰ã€‚ 5. å¤šè¡¨ JOINï¼ˆé“¾å¼ï¼‰ SELECT * FROM orders o JOIN users u ON o.user_id = u.id JOIN products p ON o.product_id = p.id LEFT JOIN tags t ON p.tag_id = t.id; è®¾è®¡åŸåˆ™ï¼š\nJOIN é¡ºåºæ— æ‰€è°“ï¼ˆä¼˜åŒ–å™¨ä¼šå¤„ç†ï¼‰ ä½†é€»è¾‘é¡ºåºåº”è¯¥æ¸…æ™° ä¸€èˆ¬ï¼šä¸»è¡¨å†™åœ¨æœ€å‰é¢ 6. JOIN æ€§èƒ½ä¼˜åŒ– 6.1 å¿…é¡»åŠ ç´¢å¼• ä¾‹ï¼šA.id JOIN B.id\nA.idã€B.id éƒ½åº”æœ‰ indexã€‚\nCREATE INDEX idx_a_id ON A(id); CREATE INDEX idx_b_id ON B(id); 6.2 å°½é‡é¿å… âŒ LIKE \u0026lsquo;%xxx%\u0026rsquo; JOIN âŒ è®¡ç®—å­—æ®µ JOINï¼Œå¦‚ ON SUBSTR(code,1,3) = \u0026lsquo;123\u0026rsquo; è¿™äº›ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚\n6.3 ä½¿ç”¨ EXPLAIN æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ EXPLAIN ANALYZE SELECT ... æŸ¥çœ‹æ˜¯å¦å‡ºç°ï¼š\nSeq Scanï¼ˆæ…¢ï¼‰ Hash Joinï¼ˆé€‚ä¸­ï¼‰ Nested Loopï¼ˆå¤§è¡¨æ…ç”¨ï¼‰ Merge Joinï¼ˆæ’åºï¼‰ 7. JOIN å¸¸è§é”™è¯¯ 7.1 ä½¿ç”¨ DISTINCT è¯¯ä¼¤æ•°æ® é”™è¯¯ï¼š\nSELECT DISTINCT a.id, b.name ... DISTINCT ä¼šè·¨è¡¨å­—æ®µå»é‡ï¼Œå¯¼è‡´ä¸¢æ•°æ®ã€‚\n7.2 åœ¨ WHERE ä¸­è¿‡æ»¤ LEFT JOIN -\u0026gt; å˜ INNER JOIN ï¼ˆå‰é¢å·²è®²ï¼‰\n7.3 GROUP BY + JOIN å¯¼è‡´é‡å¤ è§£å†³ï¼š\nGROUP BY a.id æˆ–\nDISTINCT ON (a.id) 8. JOIN æœ€ä½³å®è·µæ€»ç»“ åœºæ™¯ ä½¿ç”¨ ä¸¤è¡¨éƒ½å¿…é¡»æœ‰è®°å½• INNER JOIN ä¸»è¡¨ä¸º A LEFT JOIN ä¸»è¡¨ä¸º B RIGHT JOIN åˆå¹¶ä¸¤ä¸ªæ•°æ®æºï¼ˆéœ€è¦å¹¶é›†ï¼‰ FULL JOIN å­é›†/å·®é›†ï¼ˆA - Bï¼‰ NOT EXISTS å¤šçº§åˆ†ç±»ã€çˆ¶å­æ ‘ SELF JOIN ç”Ÿæˆç»„åˆ CROSS JOIN å»é‡åæŸ¥è¯¢ DISTINCT ON ","description":"ä¸‹é¢ç»™ä½ ä¸€å¥— æœ€ç³»ç»Ÿã€æœ€æ¸…æ™°ã€æœ€å¯å®æˆ˜æ“ä½œçš„ PostgreSQL JOIN è¯¦ç»†æ•™ç¨‹ã€‚\næ¶µç›– 7 ç§ JOINã€ç»´æ©å›¾è§£é‡Šã€è¯­æ³•ã€ç¤ºä¾‹ã€æœ€ä½³å®è·µã€æ€§èƒ½ä¼˜åŒ–ï¼Œé€‚åˆä½ å½“å‰çš„åç«¯å¼€å‘ï¼ˆFastAPI + PostgreSQLï¼‰åœºæ™¯ã€‚\nğŸ“˜ PostgreSQL JOIN è¯¦ç»†æ•™ç¨‹ï¼ˆå®Œæ•´ç‰ˆï¼‰\nâ­ ç›®å½• JOIN çš„ä½œç”¨ JOIN çš„åˆ†ç±»ä¸å¯¹ç…§ æ¯ä¸€ç§ JOIN çš„è¯­æ³• + ç»´æ©å›¾ + ç¤ºä¾‹ JOIN çš„ç­›é€‰è§„åˆ™ï¼ˆWHERE ä¸ ON çš„åŒºåˆ«ï¼‰ å¤šè¡¨ JOIN JOIN æ€§èƒ½ä¼˜åŒ– JOIN å¸¸è§é”™è¯¯ä¸è§£å†³ JOIN æœ€ä½³å®è·µæ€»ç»“ 1. JOIN æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ JOIN ç”¨äºï¼š\n"},{"id":364,"href":"/database/postgres/like/","title":"PostgreSQL Like","parent":"PostgreSQL","content":"PostgreSQL æ²¡æœ‰ LIKE IN è¿ç®—ç¬¦çš„ç›´æ¥ç»„åˆï¼Œä½†ä½ å¯ä»¥é€šè¿‡åœ¨ SQL è¯­å¥ä¸­ä½¿ç”¨ LIKE å’Œ IN è¿ç®—ç¬¦çš„ç»„åˆæ¥å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œæˆ–è€…ä½¿ç”¨ PostgreSQL æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼åŠŸèƒ½æ¥å®ç°æ›´çµæ´»çš„æ¨¡ç³ŠåŒ¹é…ã€‚\nå®ç°æ–¹æ³• ç»“åˆä½¿ç”¨ LIKE å’Œ IN å¦‚æœä½ æƒ³åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ¨¡å¼çš„å­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥å…ˆæ„å»ºä¸€ä¸ªåŒ…å« LIKE è¡¨è¾¾å¼çš„åˆ—è¡¨ï¼Œç„¶åå°†è¿™ä¸ªåˆ—è¡¨ä¼ é€’ç»™ IN å­å¥ã€‚\nSELECT * FROM TABLE_NAME WHERE column_name LIKE ANY (ARRAY[\u0026#39;%pattern1%\u0026#39;, \u0026#39;%pattern2%\u0026#39;, \u0026#39;%pattern3%\u0026#39;]); LIKE ANY ä¼šæ£€æŸ¥ column_name æ˜¯å¦åŒ¹é… ARRAY ä¸­çš„ä»»ä½•ä¸€ä¸ª LIKE æ¨¡å¼ %pattern% æ˜¯ä¸€ä¸ªé€šé…ç¬¦ï¼Œè¡¨ç¤ºå¯ä»¥åŒ¹é…ä»»ä½•å­—ç¬¦åºåˆ— ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼(Regexp)åŠŸèƒ½ PostgreSQL æ”¯æŒå¼ºå¤§çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥é€šè¿‡å…¶æ­£åˆ™è¡¨è¾¾å¼è¿ç®—ç¬¦å®ç°æ›´çµæ´»çš„æ¨¡å¼åŒ¹é…ã€‚\n~ è¿ç®—ç¬¦ï¼šåŒ¹é…å¤§å°å†™æ•æ„Ÿçš„æ­£åˆ™è¡¨è¾¾å¼ ~* è¿ç®—ç¬¦ï¼šåŒ¹é…å¤§å°å†™ä¸æ•æ„Ÿçš„æ­£åˆ™è¡¨è¾¾å¼ SELECT * FROM TABLE_NAME WHERE column_name ~* \u0026#39;pattern1|pattern2|pattern3\u0026#39;; | æ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„â€œæˆ–â€æ“ä½œç¬¦ï¼Œåœ¨è¿™é‡Œè¡¨ç¤ºåŒ¹é… pattern1 æˆ– pattern2 æˆ– pattern3ã€‚ è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¹Ÿå¯ä»¥ç”¨æ¥æŸ¥æ‰¾åŒ…å«è¿™äº›æ¨¡å¼çš„å­—ç¬¦ä¸² æ€»ç»“ è™½ç„¶ PostgreSQL æ²¡æœ‰å†…ç½® LIKE IN è¿™ç§è¯­æ³•ç³–ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ LIKE ANY å­å¥æ¥ç»„åˆæ¨¡ç³ŠåŒ¹é…å’Œåˆ—è¡¨æŸ¥æ‰¾ï¼Œæˆ–è€…åˆ©ç”¨å…¶å¼ºå¤§çš„æ­£åˆ™è¡¨è¾¾å¼åŠŸèƒ½æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä»¥æ»¡è¶³ä¸åŒçš„æ¨¡ç³ŠåŒ¹é…éœ€æ±‚ã€‚\n","description":"PostgreSQL æ²¡æœ‰ LIKE IN è¿ç®—ç¬¦çš„ç›´æ¥ç»„åˆï¼Œä½†ä½ å¯ä»¥é€šè¿‡åœ¨ SQL è¯­å¥ä¸­ä½¿ç”¨ LIKE å’Œ IN è¿ç®—ç¬¦çš„ç»„åˆæ¥å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œæˆ–è€…ä½¿ç”¨ PostgreSQL æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼åŠŸèƒ½æ¥å®ç°æ›´çµæ´»çš„æ¨¡ç³ŠåŒ¹é…ã€‚\nå®ç°æ–¹æ³• ç»“åˆä½¿ç”¨ LIKE å’Œ IN å¦‚æœä½ æƒ³åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ¨¡å¼çš„å­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥å…ˆæ„å»ºä¸€ä¸ªåŒ…å« LIKE è¡¨è¾¾å¼çš„åˆ—è¡¨ï¼Œç„¶åå°†è¿™ä¸ªåˆ—è¡¨ä¼ é€’ç»™ IN å­å¥ã€‚\nSELECT * FROM TABLE_NAME WHERE column_name LIKE ANY (ARRAY[\u0026#39;%pattern1%\u0026#39;, \u0026#39;%pattern2%\u0026#39;, \u0026#39;%pattern3%\u0026#39;]); LIKE ANY ä¼šæ£€æŸ¥ column_name æ˜¯å¦åŒ¹é… ARRAY ä¸­çš„ä»»ä½•ä¸€ä¸ª LIKE æ¨¡å¼ %pattern% æ˜¯ä¸€ä¸ªé€šé…ç¬¦ï¼Œè¡¨ç¤ºå¯ä»¥åŒ¹é…ä»»ä½•å­—ç¬¦åºåˆ— ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼(Regexp)åŠŸèƒ½ PostgreSQL æ”¯æŒå¼ºå¤§çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥é€šè¿‡å…¶æ­£åˆ™è¡¨è¾¾å¼è¿ç®—ç¬¦å®ç°æ›´çµæ´»çš„æ¨¡å¼åŒ¹é…ã€‚\n"},{"id":365,"href":"/database/postgres/postgresql-oltp/","title":"PostgreSQL OLTP","parent":"PostgreSQL","content":"PostgreSQL OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†ï¼‰å¸¸ç”¨è¯­æ³•å¤§å…¨ï¼Œæ¶µç›–ä¸šåŠ¡ç³»ç»Ÿä¸­æœ€å¸¸å‡ºç°çš„ å¢åˆ æ”¹æŸ¥ã€äº‹åŠ¡ã€é”ã€ç´¢å¼•ã€çº¦æŸã€å¹¶å‘æ§åˆ¶ ç­‰ç­‰ã€‚å†…å®¹éå¸¸è´´è¿‘å®é™…å¼€å‘ä¸è¿ç»´ã€‚\n1. è¡¨ç»“æ„æ“ä½œï¼ˆDDLï¼‰ åˆ›å»ºè¡¨ CREATE TABLE users ( id BIGSERIAL PRIMARY KEY, username TEXT UNIQUE NOT NULL, email TEXT UNIQUE NOT NULL, created_at TIMESTAMPTZ DEFAULT NOW() ); ä¿®æ”¹è¡¨ ALTER TABLE users ADD COLUMN status INT DEFAULT 1; ALTER TABLE users ALTER COLUMN email SET NOT NULL; ALTER TABLE users DROP COLUMN status; æ·»åŠ ç´¢å¼• OLTP åœºæ™¯éå¸¸ä¾èµ–ç´¢å¼•æ€§èƒ½ã€‚\nCREATE INDEX idx_users_username ON users (username); CREATE INDEX idx_users_created_at ON users (created_at DESC); åˆ é™¤/é‡å»ºç´¢å¼• DROP INDEX idx_users_username; REINDEX TABLE users; 2. å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰ INSERT INSERT INTO users (username, email) VALUES (\u0026#39;martin\u0026#39;, \u0026#39;martin@example.com\u0026#39;) RETURNING id; æ‰¹é‡æ’å…¥ INSERT INTO orders (uid, amount) VALUES (1, 100), (1, 50), (2, 300); UPDATE UPDATE users SET email = \u0026#39;new@example.com\u0026#39; WHERE id = 1; DELETE DELETE FROM users WHERE id = 1; SELECTï¼ˆå¸¸ç”¨ï¼‰ SELECT id, username FROM users WHERE status = 1 LIMIT 10 OFFSET 0; 3. åˆ†é¡µï¼ˆä¸šåŠ¡ç³»ç»Ÿç”¨æœ€å¤šï¼‰ SELECT * FROM orders WHERE status = 1 ORDER BY id DESC LIMIT 20 OFFSET 0; æ›´é«˜æ€§èƒ½çš„ cursor-based paginationï¼š\nSELECT * FROM orders WHERE id \u0026lt; 50000 ORDER BY id DESC LIMIT 20; 4. JOINï¼ˆä¸šåŠ¡ç³»ç»Ÿä¸‰å¤§å…³é”®æŸ¥è¯¢æ ¸å¿ƒï¼‰ SELECT u.id, u.username, o.amount FROM users u JOIN orders o ON u.id = o.uid WHERE o.amount \u0026gt; 100; å¸¸ç”¨ï¼š\nINNER JOINï¼šä¸¤è¾¹éƒ½æœ‰çš„æ•°æ® LEFT JOINï¼šä¿ç•™å·¦è¾¹å…¨éƒ¨ RIGHT JOINï¼šä¿ç•™å³è¾¹å…¨éƒ¨ FULL JOINï¼šå…¨éƒ¨ä¿ç•™ CROSS JOINï¼šç¬›å¡å°”ç§¯ ç¤ºä¾‹ï¼ˆå·¦è¿æ¥ï¼‰ï¼š\nSELECT u.username, o.amount FROM users u LEFT JOIN orders o ON u.id = o.uid; 5. èšåˆï¼ˆOLTP ç»Ÿè®¡å°éœ€æ±‚ï¼‰ SELECT uid, COUNT(*) AS cnt, SUM(amount) AS total FROM orders GROUP BY uid ORDER BY total DESC; å¸¸è§ï¼š\nCOUNT SUM AVG MIN / MAX 6. UPSERTï¼ˆä¸šåŠ¡éå¸¸å¸¸ç”¨ï¼‰ é¿å…é‡å¤æ’å…¥ï¼š\nINSERT INTO users (username, email) VALUES (\u0026#39;martin\u0026#39;, \u0026#39;martin@example.com\u0026#39;) ON CONFLICT (username) DO UPDATE SET email = EXCLUDED.email; 7. äº‹åŠ¡ï¼ˆOLTP ç³»ç»Ÿå¿…ç”¨ï¼‰ BEGIN; UPDATE accounts SET balance = balance - 100 WHERE id = 1; UPDATE accounts SET balance = balance + 100 WHERE id = 2; COMMIT; å›æ»šï¼š\nROLLBACK; 8. å¹¶å‘ä¸é” è¡Œé”ï¼ˆFOR UPDATEï¼‰ SELECT * FROM orders WHERE id = 100 FOR UPDATE; è·³è¿‡é” SELECT * FROM orders WHERE id = 100 FOR UPDATE SKIP LOCKED; å¸¸ç”¨äºé˜Ÿåˆ—æ¶ˆè´¹è€…ã€‚\nå…±äº«é” SELECT * FROM inventory FOR SHARE; 9. çº¦æŸï¼ˆä¿è¯æ•°æ®è´¨é‡ï¼‰ NOT NULL ALTER TABLE users ALTER COLUMN email SET NOT NULL; UNIQUE ALTER TABLE users ADD CONSTRAINT u_email UNIQUE(email); CHECK ALTER TABLE orders ADD CONSTRAINT chk_amount CHECK (amount \u0026gt; 0); å¤–é”® ALTER TABLE orders ADD CONSTRAINT fk_uid FOREIGN KEY(uid) REFERENCES users(id); 10. JSON æ“ä½œï¼ˆPostgreSQL ç°ä»£ OLTP æœ€å¤§ä¼˜åŠ¿ï¼‰ æŸ¥è¯¢ JSON å­—æ®µï¼š\nSELECT data-\u0026gt;\u0026gt;\u0026#39;name\u0026#39; AS name FROM user_logs; æ›´æ–° JSONï¼š\nUPDATE user_logs SET data = jsonb_set(data, \u0026#39;{ip}\u0026#39;, \u0026#39;\u0026#34;127.0.0.1\u0026#34;\u0026#39;); æŸ¥è¯¢ JSON åŒ…å«ï¼š\nSELECT * FROM user_logs WHERE data @\u0026gt; \u0026#39;{\u0026#34;action\u0026#34;: \u0026#34;login\u0026#34;}\u0026#39;; 11. æ—¶é—´åºåˆ—ï¼ˆOLTP å¸¸ç”¨ï¼‰ æŒ‰æ—¥æŸ¥è¯¢ï¼š\nSELECT * FROM logs WHERE created_at::date = CURRENT_DATE; æ—¶é—´èŒƒå›´ï¼š\nSELECT * FROM logs WHERE created_at BETWEEN NOW() - INTERVAL \u0026#39;1 day\u0026#39; AND NOW(); 12. CTEï¼ˆå¯è¯»æ€§æ›´å¼ºï¼‰ WITH recent_orders AS ( SELECT * FROM orders WHERE created_at \u0026gt; NOW() - INTERVAL \u0026#39;1 day\u0026#39; ) SELECT * FROM recent_orders WHERE amount \u0026gt; 100; 13. åˆ†åŒºè¡¨ï¼ˆé«˜å¹¶å‘ / å¤§è¡¨ä¼˜åŒ–ï¼‰ CREATE TABLE logs ( id BIGSERIAL, created_at DATE NOT NULL ) PARTITION BY RANGE (created_at); åˆ›å»ºåˆ†åŒºï¼š\nCREATE TABLE logs_2025_01 PARTITION OF logs FOR VALUES FROM (\u0026#39;2025-01-01\u0026#39;) TO (\u0026#39;2025-02-01\u0026#39;); 14. ç›‘æ§ OLTP æ€§èƒ½çš„å¸¸ç”¨è¯­æ³• æŸ¥çœ‹æ…¢ SQL SELECT * FROM pg_stat_activity WHERE state != \u0026#39;idle\u0026#39;; æŸ¥çœ‹è¡¨å¤§å° SELECT pg_size_pretty(pg_total_relation_size(\u0026#39;orders\u0026#39;)); æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ SELECT * FROM pg_stat_user_indexes; 15. æœ€ä½³å®è·µï¼ˆOLTP åœºæ™¯ï¼‰ ä¸»é”®å¿…é¡»ç”¨ BIGSERIAL æˆ– UUIDï¼Œä¸è¦ç”¨ SERIALã€‚ å­—ç¬¦ç±»å‹ç”¨ textï¼Œä¸è¦ç”¨ varchar(n)ã€‚ æ‰€æœ‰å¤–é”®å­—æ®µå¿…é¡»åˆ›å»ºç´¢å¼•ã€‚ åˆ†é¡µä½¿ç”¨ cursor åˆ†é¡µä¼˜å…ˆäº offsetã€‚ å¤§è¡¨å¿…é¡»åˆ†åŒºï¼ˆæŒ‰æ—¥æœŸï¼‰ã€‚ JSONB æ¯” JSON æ›´å¿«ï¼Œä¼˜å…ˆä½¿ç”¨ JSONBã€‚ å®šæœŸ vacuum + analyzeã€‚ ","description":"PostgreSQL OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†ï¼‰å¸¸ç”¨è¯­æ³•å¤§å…¨ï¼Œæ¶µç›–ä¸šåŠ¡ç³»ç»Ÿä¸­æœ€å¸¸å‡ºç°çš„ å¢åˆ æ”¹æŸ¥ã€äº‹åŠ¡ã€é”ã€ç´¢å¼•ã€çº¦æŸã€å¹¶å‘æ§åˆ¶ ç­‰ç­‰ã€‚å†…å®¹éå¸¸è´´è¿‘å®é™…å¼€å‘ä¸è¿ç»´ã€‚\n1. è¡¨ç»“æ„æ“ä½œï¼ˆDDLï¼‰ åˆ›å»ºè¡¨ CREATE TABLE users ( id BIGSERIAL PRIMARY KEY, username TEXT UNIQUE NOT NULL, email TEXT UNIQUE NOT NULL, created_at TIMESTAMPTZ DEFAULT NOW() ); ä¿®æ”¹è¡¨ ALTER TABLE users ADD COLUMN status INT DEFAULT 1; ALTER TABLE users ALTER COLUMN email SET NOT NULL; ALTER TABLE users DROP COLUMN status; æ·»åŠ ç´¢å¼• OLTP åœºæ™¯éå¸¸ä¾èµ–ç´¢å¼•æ€§èƒ½ã€‚\n"},{"id":366,"href":"/database/postgres/pg_trgm/","title":"PostgreSQL pg_trgm","parent":"PostgreSQL","content":" ä¸€ã€pg_trgm æ˜¯ä»€ä¹ˆï¼Ÿ pg_trgm æ˜¯ PostgreSQL çš„ä¸€ä¸ª æ‰©å±•æ¨¡å—ï¼Œç”¨äºï¼š\nåŸºäºâ€œå­—ç¬¦ç›¸ä¼¼åº¦â€è¿›è¡Œé«˜æ•ˆçš„æ¨¡ç³ŠåŒ¹é…\næ ¸å¿ƒèƒ½åŠ›ï¼š\nLIKE \u0026lsquo;%xxx%\u0026rsquo; ILIKE \u0026lsquo;%xxx%\u0026rsquo; ç›¸ä¼¼åº¦æœç´¢ï¼ˆæ¨¡ç³Šæ¨èï¼‰ æ’åºï¼ˆæŒ‰ç›¸ä¼¼åº¦ï¼‰ ğŸ“Œ å®ƒæ˜¯ PostgreSQL é‡Œå¤„ç†æ¨¡ç³Šå­—ç¬¦ä¸²æŸ¥è¯¢çš„ç‹ç‰Œ\näºŒã€ä»€ä¹ˆæ˜¯ Trigramï¼ˆä¸‰å…ƒç»„ï¼‰ï¼Ÿ Trigram = è¿ç»­çš„ 3 ä¸ªå­—ç¬¦\nä¾‹å¦‚ï¼š\n\u0026#34;èèµ„è®¡åˆ’\u0026#34; ä¼šè¢«æ‹†æˆï¼š\n\u0026#34; è\u0026#34;, \u0026#34; èèµ„\u0026#34;, \u0026#34;èèµ„è®¡\u0026#34;, \u0026#34;èµ„è®¡åˆ’\u0026#34;, \u0026#34;è®¡åˆ’ \u0026#34; pg_trgm é€šè¿‡æ¯”è¾ƒ trigram é›†åˆçš„â€œäº¤é›†æ¯”ä¾‹â€æ¥åˆ¤æ–­ç›¸ä¼¼åº¦\nä¸‰ã€å¯ç”¨ pg_trgm 1ï¸âƒ£ æŸ¥çœ‹æ˜¯å¦å·²å¯ç”¨ SELECT * FROM pg_extension WHERE extname = \u0026#39;pg_trgm\u0026#39;; 2ï¸âƒ£ å¯ç”¨æ‰©å±• CREATE EXTENSION pg_trgm; ğŸ“Œ åªéœ€æ‰§è¡Œä¸€æ¬¡ï¼ˆæ•°æ®åº“çº§ï¼‰\nå››ã€æœ€å¸¸è§ç”¨æ³•ï¼šLIKE / ILIKE åŠ é€Ÿ 1ï¸âƒ£ å»ºç´¢å¼•ï¼ˆGINï¼Œæ¨èï¼‰ CREATE INDEX idx_title_trgm ON telegraph USING gin (title gin_trgm_ops); ğŸ“Œ 90% åœºæ™¯æ¨è GIN\n2ï¸âƒ£ æŸ¥è¯¢ï¼ˆä¼šå‘½ä¸­ç´¢å¼•ï¼‰ SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„%\u0026#39;; æˆ–ï¼š\nSELECT id FROM telegraph WHERE title ILIKE \u0026#39;%èèµ„%\u0026#39;; 3ï¸âƒ£ å…¸å‹æ‰§è¡Œè®¡åˆ’ Bitmap Heap Scan -\u0026gt; Bitmap Index Scan on idx_title_trgm äº”ã€ç›¸ä¼¼åº¦æœç´¢ï¼ˆpg_trgm çš„â€œé«˜çº§ç©æ³•â€ï¼‰ 1ï¸âƒ£ ç›¸ä¼¼åº¦å‡½æ•° similarity(text, text) -- è¿”å› 0 ~ 1 ç¤ºä¾‹ï¼š\nSELECT title, similarity(title, \u0026#39;èèµ„è®¡åˆ’\u0026#39;) AS score FROM telegraph ORDER BY score DESC LIMIT 10; 2ï¸âƒ£ ç›¸ä¼¼åº¦æ“ä½œç¬¦ % title % \u0026#39;èèµ„è®¡åˆ’\u0026#39; ç­‰ä»·äºï¼š\nsimilarity(title, \u0026#39;èèµ„è®¡åˆ’\u0026#39;) \u0026gt; pg_trgm.similarity_threshold é»˜è®¤é˜ˆå€¼ï¼š\nSHOW pg_trgm.similarity_threshold; -- 0.3 3ï¸âƒ£ ç¤ºä¾‹ï¼ˆæ¨¡ç³Šæ¨èï¼‰ SELECT title FROM telegraph WHERE title % \u0026#39;èèµ„è®¡åˆ’\u0026#39; ORDER BY similarity(title, \u0026#39;èèµ„è®¡åˆ’\u0026#39;) DESC; 4ï¸âƒ£ è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆä¼šå½±å“ç´¢å¼•å‘½ä¸­ï¼‰ SET pg_trgm.similarity_threshold = 0.2; å…­ã€ç´¢å¼•ç±»å‹é€‰æ‹©ï¼ˆGIN vs GiSTï¼‰ ç±»å‹ ç‰¹ç‚¹ æ˜¯å¦æ¨è GIN æŸ¥è¯¢å¿«ã€ç´¢å¼•å¤§ âœ… æ¨è GiST ç´¢å¼•å°ã€æ”¯æŒæ’åº âš ï¸ å°‘ç”¨ GiST ç¤ºä¾‹ï¼ˆæ”¯æŒ \u0026lt;-\u0026gt; æ’åºï¼‰\nCREATE INDEX idx_title_trgm_gist ON telegraph USING gist (title gist_trgm_ops); ä¸ƒã€pg_trgm æ”¯æŒå“ªäº›æ“ä½œä¼šç”¨ç´¢å¼•ï¼Ÿ âœ… ä¼šèµ°ç´¢å¼•ï¼š\nLIKE \u0026#39;%xxx%\u0026#39; ILIKE \u0026#39;%xxx%\u0026#39; title % \u0026#39;xxx\u0026#39; title \u0026lt;-\u0026gt; \u0026#39;xxx\u0026#39; âŒ ä¸ä¼šèµ°ç´¢å¼•ï¼š\nLOWER(title) LIKE \u0026#39;%xxx%\u0026#39; -- âŒ title::text LIKE \u0026#39;%xxx%\u0026#39; -- âŒ SUBSTRING(title, ...) -- âŒ ğŸ“Œ å­—æ®µä¸Šä¸èƒ½åŒ…å‡½æ•°\nå…«ã€ä¸­æ–‡ LIKE æŸ¥è¯¢çš„æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ æé«˜ç»Ÿè®¡ç²¾åº¦ï¼ˆå¿…åšï¼‰ ALTER TABLE telegraph ALTER COLUMN title SET STATISTICS 1000; ANALYZE telegraph; å¦åˆ™ planner ä¼šä¸¥é‡ä½ä¼°åŒ¹é…è¡Œæ•°ã€‚\n2ï¸âƒ£ è‡³å°‘ 3ä¸ª ä¸­æ–‡å­—ç¬¦ ğŸŒŸğŸŒŸğŸŒŸ 3ä¸ª ä¸­æ–‡å­—ç¬¦ ä»¥ä¸Šï¼Œæ‰èƒ½åˆ©ç”¨ç´¢å¼•ã€‚\n3ï¸âƒ£ å°è¡¨ä¸ä¸€å®šèµ°ç´¢å¼•ï¼ˆæ­£å¸¸ï¼‰ è¡¨ \u0026lt; 5 ä¸‡è¡Œ è¿”å›è¡Œæ•°æ¯”ä¾‹ä¸ä½ ğŸ‘‰ PostgreSQL æ•…æ„ç”¨ Seq Scan\n4ï¸âƒ£ C collation å¯¹ trigram æœ€å‹å¥½ï¼ˆè¿›é˜¶ï¼‰ ALTER TABLE telegraph ALTER COLUMN title TYPE text COLLATE \u0026#34;C\u0026#34;; ç„¶åé‡å»ºç´¢å¼•ã€‚\nä¹ã€pg_trgm vs å…¨æ–‡ç´¢å¼•ï¼ˆtsvectorï¼‰ å¯¹æ¯” pg_trgm å…¨æ–‡ç´¢å¼• LIKE \u0026lsquo;%xxx%\u0026rsquo; âœ… å¼º âŒ å¼± ä¸­æ–‡ âœ… ä¸åˆ†è¯ âŒ éœ€åˆ†è¯ è¯­ä¹‰æœç´¢ âŒ âœ… æ¨¡ç³Šæ¨è âœ… âŒ ğŸ“Œ æ ‡é¢˜ / URL / ç¼–å· / çŸ­æ–‡æœ¬ -\u0026gt; pg_trgm\nåã€å¸¸è§å‘ âŒ å»ºäº†ç´¢å¼•ä½†ä¸èµ° åŸå›  99% æ˜¯ï¼š\nç»Ÿè®¡ä¿¡æ¯ä¸è¶³ planner è®¤ä¸º Seq Scan æ›´ä¾¿å®œ collation æˆæœ¬è¿‡é«˜ âŒ ç”¨äº† LOWER / TRIM ç´¢å¼•ç›´æ¥å¤±æ•ˆã€‚\nåä¸€ã€ä¸šåŠ¡çš„â€œæ ‡å‡†æ¨¡æ¿â€ ç»“åˆä¹‹å‰çš„ telegraph è¡¨ï¼Œæ¨èæœ€ç»ˆå½¢æ€ï¼š\nALTER TABLE telegraph ALTER COLUMN title SET STATISTICS 1000; CREATE INDEX idx_telegraph_title_trgm ON telegraph USING gin (title gin_trgm_ops); æŸ¥è¯¢ï¼š\nSELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„é¢%\u0026#39;; åäºŒã€æ€»ç»“ pg_trgm = PostgreSQL é‡Œå¤„ç†æ¨¡ç³Šå­—ç¬¦ä¸²æŸ¥è¯¢çš„ç»ˆææ­¦å™¨\nLIKE \u0026lsquo;%xxx%\u0026rsquo; å¿…å¤‡ ä¸­æ–‡åœºæ™¯å¿…å¤‡ æ ‡é¢˜ / URL / ç¼–å· / æ¨¡ç³Šæ¨èé¦–é€‰ pg_trgm ä¸­æ–‡ LIKE è‡³å°‘è¦3ä¸ªæ–‡å­—æ‰èµ°ç´¢å¼• ä¸€ã€ç»“è®ºå…ˆè¡Œï¼ˆæœ€é‡è¦ï¼‰ pg_trgm åœ¨ä¸­æ–‡åœºæ™¯ä¸‹ï¼š\n1 ä¸ªæ±‰å­—ï¼šâŒ åŸºæœ¬ä¸ä¼šèµ°ç´¢å¼• 2 ä¸ªæ±‰å­—ï¼šâš ï¸ å¯èƒ½èµ°ï¼Œä¹Ÿå¯èƒ½ä¸èµ° â‰¥ 3 ä¸ªæ±‰å­—ï¼šâœ… æ‰æ˜¯ç¨³å®šã€å¯é èµ°ç´¢å¼• ğŸ‘‰ æ‰€ä»¥å¤§å®¶ç»éªŒæ€»ç»“ä¸ºä¸€å¥è¯ï¼š\nâ€œä¸­æ–‡ LIKEï¼Œè‡³å°‘ 3 ä¸ªå­—ï¼Œpg_trgm æ‰é è°±â€\näºŒã€ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿï¼ˆæ ¸å¿ƒåŸç†ï¼‰ 1ï¸âƒ£ pg_trgm æ˜¯ã€Œä¸‰å…ƒç»„ã€ç´¢å¼• pg_trgm çš„æœ€å°åŒ¹é…å•ä½æ˜¯ 3 ä¸ªå­—ç¬¦ï¼ˆtrigramï¼‰\n2ï¸âƒ£ çœ‹ä¸­æ–‡ä¾‹å­ï¼ˆå…³é”®ï¼‰ å‡è®¾ä½ æŸ¥è¯¢ï¼š\nWHERE title LIKE \u0026#39;%èèµ„%\u0026#39; ğŸ”¹ â€œèèµ„â€ = 2 ä¸ªæ±‰å­—\nç”Ÿæˆçš„ trigram æå°‘ï¼š\n\u0026#34; èèµ„\u0026#34;, \u0026#34;èèµ„ \u0026#34; ğŸ‘‰ trigram æ•°é‡å¤ªå°‘ ğŸ‘‰ é€‰æ‹©æ€§å¤ªä½ ğŸ‘‰ planner åˆ¤æ–­ï¼šç”¨ç´¢å¼•ä¸åˆ’ç®— 3ï¸âƒ£ 3 ä¸ªæ±‰å­—å°±ä¸ä¸€æ ·äº† WHERE title LIKE \u0026#39;%èèµ„è®¡åˆ’%\u0026#39; trigram ä¼šå˜æˆï¼š\n\u0026#34; èèµ„\u0026#34;, \u0026#34;èèµ„è®¡\u0026#34;, \u0026#34;èµ„è®¡åˆ’\u0026#34;, \u0026#34;è®¡åˆ’ \u0026#34; ğŸ‘‰ trigram æ•°é‡æ˜æ˜¾å¢åŠ  ğŸ‘‰ åŒ¹é…ç²¾åº¦æé«˜ ğŸ‘‰ ç´¢å¼•è¿‡æ»¤èƒ½åŠ›è¶³å¤Ÿå¼º ä¸‰ã€ä¸ºä»€ä¹ˆè‹±æ–‡ 2 ä¸ªå­—ç¬¦ä¹Ÿå¯èƒ½èµ°ç´¢å¼•ï¼Ÿ è‹±æ–‡ä¸åŒï¼š\nLIKE \u0026#39;%AI%\u0026#39; å­—ç¬¦çŸ­ trigram åˆ†å¸ƒæ›´ç¦»æ•£ å­—ç¬¦é›†å° ğŸ“Œ ä¸­æ–‡æ˜¯å¤šå­—èŠ‚å­—ç¬¦\n-\u0026gt; trigram çš„â€œä¿¡æ¯å¯†åº¦â€åè€Œæ›´ä½\nå››ã€ä¸æ˜¯â€œä¸èƒ½èµ°â€ï¼Œè€Œæ˜¯â€œplanner ä¸æ„¿æ„èµ°â€ é‡ç‚¹ç†è§£è¿™ä¸€å¥ï¼š\nä¸æ˜¯ pg_trgm ä¸æ”¯æŒï¼Œè€Œæ˜¯ PostgreSQL è§‰å¾— Seq Scan æ›´ä¾¿å®œã€‚\nä½ å¯ä»¥å¼ºåˆ¶éªŒè¯ï¼š\nSET enable_seqscan = off; EXPLAIN ANALYZE SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„%\u0026#39;; ğŸ‘‰ å¾ˆå¯èƒ½ä¼šçœ‹åˆ° GIN Index Scan\nä½† âŒ ä¸ä»£è¡¨çº¿ä¸Šè¯¥è¿™ä¹ˆåš\näº”ã€å®˜æ–¹æ–‡æ¡£çš„éšå«è¯´æ˜ï¼ˆä¸æ˜¯æ˜è¯´ï¼‰ PostgreSQL å®˜æ–¹æ–‡æ¡£é‡Œå¹¶æ²¡æœ‰å†™ï¼š\nâ€œä¸­æ–‡è‡³å°‘ 3 ä¸ªå­—â€\nä½†å†™äº†è¿™å¥ï¼ˆå«ä¹‰éå¸¸é‡è¦ï¼‰ï¼š\nThe longer the search string, the more selective the trigram index is.\nğŸ“Œ å¯¹ä¸­æ–‡æ¥è¯´ï¼Œâ€œæ›´é•¿â€â‰ˆ è‡³å°‘ 3 ä¸ªå­—\nå…­ã€å®æˆ˜ä¸­çš„çœŸå®å»ºè®®ï¼ˆç”Ÿäº§çº§ï¼‰ âœ… 1ï¸âƒ£ æ ‡é¢˜ / å†…å®¹æœç´¢ç­–ç•¥ æœç´¢é•¿åº¦ æ¨èæ–¹æ¡ˆ 1 å­— Seq Scanï¼ˆæ­£å¸¸ï¼‰ 2 å­— å…è®¸æ…¢ï¼Œæˆ–æç¤ºç”¨æˆ· â‰¥3 å­— pg_trgm âœ… 2ï¸âƒ£ åç«¯ä¸»åŠ¨é™åˆ¶ï¼ˆéå¸¸å¸¸è§ï¼‰ if len(keyword) \u0026lt; 3: raise ValueError(\u0026#34;å…³é”®è¯è‡³å°‘ 3 ä¸ªå­—\u0026#34;) ğŸ“Œ å¾ˆå¤šæ–°é—» / æœç´¢ç³»ç»Ÿéƒ½è¿™ä¹ˆåš\nâœ… 3ï¸âƒ£ æé«˜ç»Ÿè®¡ç²¾åº¦ï¼ˆç¼“è§£ 2 å­—ä¸èµ°ç´¢å¼•ï¼‰ ALTER TABLE telegraph ALTER COLUMN title SET STATISTICS 1000; ANALYZE telegraph; âš ï¸ åªèƒ½â€œç¼“è§£â€ï¼Œä¸èƒ½ä»æ ¹æœ¬è§£å†³\nâœ… 4ï¸âƒ£ C collationï¼ˆç•¥æœ‰å¸®åŠ©ï¼‰ ALTER TABLE telegraph ALTER COLUMN title TYPE text COLLATE \u0026#34;C\u0026#34;; ä½† ä¸èƒ½æ”¹å˜ trigram çš„ç‰©ç†é™åˆ¶\nä¸ƒã€å¦‚æœä½ å¿…é¡»æ”¯æŒ 1ï½2 ä¸ªå­—æ€ä¹ˆåŠï¼Ÿ æ–¹æ¡ˆå¯¹æ¯”ï¼ˆè¯´å®è¯ï¼‰\næ–¹æ¡ˆ ç°å®è¯„ä»· pg_trgm âŒ ä¸é€‚åˆ BTree âŒ ä¸æ”¯æŒ LIKE \u0026lsquo;%x%\u0026rsquo; å…¨æ–‡ç´¢å¼• âŒ ä¸­æ–‡éœ€åˆ†è¯ ES / OpenSearch âœ… æ­£è§£ å‰ç¼€åŒ¹é…ï¼ˆLIKE \u0026lsquo;èèµ„%\u0026rsquo;ï¼‰ âš ï¸ å¯ç”¨ ğŸ“Œ ç»“è®ºï¼šæ•°æ®åº“ä¸æ˜¯ä¸‡èƒ½æœç´¢å¼•æ“\nå…«ã€æ€»ç»“ pg_trgm çš„ LIKE åœ¨ä¸­æ–‡åœºæ™¯ä¸‹ï¼š\nâœ… â‰¥ 3 ä¸ªå­—ï¼šç”Ÿäº§çº§ âš ï¸ 2 ä¸ªå­—ï¼šä¸ç¨³å®š âŒ 1 ä¸ªå­—ï¼šä¸è¦æŒ‡æœ›ç´¢å¼• åˆ†æ EXPLAIN ANALYSE SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„%\u0026#39;; -- Seq Scan on telegraph (cost=0.00..4187.25 rows=222 width=8) (actual time=0.045..16.284 rows=255 loops=1) -- Filter: (title ~~ \u0026#39;%èèµ„%\u0026#39;::text) -- Rows Removed by Filter: 45928 -- Planning Time: 0.425 ms -- Execution Time: 16.327 ms EXPLAIN ANALYSE SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„é¢%\u0026#39;; -- Bitmap Heap Scan on telegraph (cost=6.87..11.31 rows=4 width=8) (actual time=0.029..0.033 rows=2 loops=1) -- Recheck Cond: (title ~~ \u0026#39;%èèµ„é¢%\u0026#39;::text) -- Heap Blocks: exact=2 -- -\u0026gt; Bitmap Index Scan on idx_telegraph_title_trgm (cost=0.00..6.87 rows=4 width=0) (actual time=0.016..0.017 rows=2 loops=1) -- Index Cond: (title ~~ \u0026#39;%èèµ„é¢%\u0026#39;::text) -- Planning Time: 0.433 ms -- Execution Time: 0.057 ms è¿™ä¸¤æ¡ EXPLAIN ANALYZE æ­£å¥½æ˜¯ pg_trgm ä¸­æ–‡ LIKE çš„â€œæ ‡å‡†æ•™ç§‘ä¹¦çº§å¯¹æ¯”æ¡ˆä¾‹â€ã€‚\nä½ ç°åœ¨çœ‹åˆ°çš„ç°è±¡æ˜¯ å®Œå…¨æ­£ç¡®ã€å®Œå…¨ç¬¦åˆåŸç†çš„ï¼Œä¸æ˜¯é…ç½®é—®é¢˜ã€ä¸æ˜¯ç´¢å¼•é—®é¢˜ã€‚\nä¸€ã€å…ˆç»™ä¸€å¥è¯ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ pg_trgm åœ¨ä¸­æ–‡ LIKE åœºæ™¯ä¸‹ï¼š\n\u0026lsquo;%èèµ„%\u0026rsquo;ï¼ˆ2 ä¸ªå­—ï¼‰-\u0026gt; Seq Scan æ˜¯â€œç†æ€§é€‰æ‹©â€ \u0026lsquo;%èèµ„é¢%\u0026rsquo;ï¼ˆ3 ä¸ªå­—ï¼‰-\u0026gt; ç´¢å¼•å¼€å§‹â€œæœ‰ä»·å€¼â€ ä½ è¿™ä¸¤æ¡æ‰§è¡Œè®¡åˆ’ æ­£æ˜¯ PostgreSQL åœ¨â€œç†æ€§å·¥ä½œâ€ã€‚\näºŒã€é€æ¡ç²¾ç¡®è§£è¯»æ‰§è¡Œè®¡åˆ’ ğŸ”´ Case 1ï¼šLIKE \u0026lsquo;%èèµ„%\u0026rsquo;ï¼ˆ2 ä¸ªå­—ï¼‰ EXPLAIN ANALYSE SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„%\u0026#39;; æ‰§è¡Œè®¡åˆ’\nSeq Scan on telegraph cost=0.00..4187.25 actual time=0.045..16.284 rows=255 Rows Removed by Filter: 45928 Execution Time: 16.327 ms PostgreSQL çš„â€œå†…å¿ƒåˆ¤æ–­â€\n1ï¸âƒ£ è¡¨æ€»è¡Œæ•° â‰ˆ 46183 è¡Œ 2ï¸âƒ£ åŒ¹é…è¡Œæ•° = 255 è¡Œï¼ˆ0.55%ï¼‰ 3ï¸âƒ£ æŸ¥è¯¢å­—ç¬¦ä¸² = 2 ä¸ªæ±‰å­— -\u0026gt; trigram æå°‘ 4ï¸âƒ£ GIN ç´¢å¼•éœ€è¦ï¼š æ‰«ç´¢å¼• æ„å»º bitmap å›è¡¨ ğŸ“Œ ç»“è®ºï¼š\nğŸ‘‰ â€œé¡ºåºæ‰«ä¸€é 4.6 ä¸‡è¡Œï¼Œæ¯”æŠ˜è…¾ GIN æ›´å¿«â€\næ‰€ä»¥ Seq Scan æ˜¯æœ€ä¼˜è§£\nğŸŸ¢ Case 2ï¼šLIKE \u0026lsquo;%èèµ„é¢%\u0026rsquo;ï¼ˆ3 ä¸ªå­—ï¼‰ EXPLAIN ANALYSE SELECT id FROM telegraph WHERE title LIKE \u0026#39;%èèµ„é¢%\u0026#39;; æ‰§è¡Œè®¡åˆ’\nBitmap Heap Scan -\u0026gt; Bitmap Index Scan on idx_telegraph_title_trgm Execution Time: 0.057 ms PostgreSQL çš„â€œå†…å¿ƒåˆ¤æ–­â€\n1ï¸âƒ£ trigram æ•°é‡æ˜æ˜¾å¢åŠ  2ï¸âƒ£ åŒ¹é…è¡Œæ•° åªæœ‰ 2 è¡Œ 3ï¸âƒ£ ç´¢å¼•é€‰æ‹©æ€§æé«˜ 4ï¸âƒ£ bitmap åªè®¿é—® 2 ä¸ª heap block ğŸ“Œ ç»“è®ºï¼š\nğŸ‘‰ â€œGIN ä¸€ä¸‹å°±èƒ½è¿‡æ»¤åˆ°æå°‘è¡Œï¼Œéå¸¸åˆ’ç®—â€\näºæ˜¯ï¼š\nâœ… èµ° trigram ç´¢å¼• âœ… æŸ¥è¯¢æ—¶é—´ 16ms -\u0026gt; 0.05msï¼ˆâ‰ˆ300 å€æå‡ï¼‰ ä¸‰ã€è¿™æ­£å¥½éªŒè¯äº†ä¸€ä¸ªâ€œé“å¾‹â€ ğŸ“Œ ä¸­æ–‡ pg_trgm LIKE çš„ç»éªŒå®šå¾‹\nLIKE å†…å®¹ æ˜¯å¦ç¨³å®šèµ°ç´¢å¼• åŸå›  1 ä¸ªå­— âŒ ä¸èµ° trigram ä¸æˆç«‹ 2 ä¸ªå­— âŒ/âš ï¸ trigram å¤ªå°‘ â‰¥ 3 ä¸ªå­— âœ… ç¨³å®š é€‰æ‹©æ€§è¶³å¤Ÿ è¿™ä¸¤æ¡ SQL\nâ¡ï¸ æ˜¯è¿™ä¸ªå®šå¾‹çš„å®Œç¾å®è¯\nå››ã€ä¸ºä»€ä¹ˆ planner ä¸â€œèµŒä¸€æŠŠâ€ç”¨ç´¢å¼•ï¼Ÿ å› ä¸º PostgreSQL çš„ç›®æ ‡æ˜¯ï¼š\nå¹³å‡æœ€ä¼˜ï¼Œä¸æ˜¯å•æ¬¡æœ€ä¼˜\nå¯¹äº %èèµ„%ï¼š\nå¦‚æœæœªæ¥æ•°æ®æ›´å¤š åŒ¹é…æ¯”ä¾‹æ›´é«˜ GIN æˆæœ¬ä¼šä¸Šå‡ ğŸ‘‰ planner ä¿å®ˆé€‰æ‹© Seq Scan\nè¿™æ˜¯ PostgreSQL çš„è®¾è®¡å“²å­¦ï¼Œä¸æ˜¯ç¼ºé™·ã€‚\näº”ã€è¿™æ˜¯ä¸æ˜¯å¯ä»¥â€œå¼ºè¡Œä¼˜åŒ–â€ï¼Ÿï¼ˆä¸å»ºè®®ï¼‰ ä½ å¯ä»¥è¿™æ ·â€œä½œå¼Šâ€ï¼š\nSET enable_seqscan = off; ç„¶å %èèµ„% ä¹Ÿä¼šèµ°ç´¢å¼•ã€‚\nâš ï¸ ä½†è¿™æ˜¯ åä¼˜åŒ–ï¼š\næŸ¥è¯¢å¯èƒ½æ›´æ…¢ å½±å“å…¨å±€ ç”Ÿäº§ç¯å¢ƒ âŒ å…­ã€è¿™å¯¹ä½ çš„ç³»ç»Ÿè®¾è®¡æ„å‘³ç€ä»€ä¹ˆï¼ˆéå¸¸å…³é”®ï¼‰ âœ… æ­£ç¡®åšæ³•ï¼ˆç”Ÿäº§çº§ï¼‰\n1ï¸âƒ£ å‰ç«¯ / API é™åˆ¶å…³é”®è¯é•¿åº¦ å…³é”®è¯è‡³å°‘ 3 ä¸ªæ±‰å­—\nè¿™æ˜¯ æ–°é—» / æœç´¢ç³»ç»Ÿçš„è¡Œä¸šå¸¸è§„åšæ³•\n2ï¸âƒ£ åç«¯é€»è¾‘åˆ†æµ -- \u0026gt;= 3 å­— WHERE title LIKE \u0026#39;%å…³é”®è¯%\u0026#39; -- \u0026lt; 3 å­— å…è®¸æ…¢ or æç¤ºç”¨æˆ· 3ï¸âƒ£ æ¥å—ä¸€ä¸ªäº‹å® æ•°æ®åº“ä¸æ˜¯æœç´¢å¼•æ“\npg_trgm å·²ç»æ˜¯æ•°æ®åº“å±‚çš„æé™äº†\nä¸ƒã€ç°åœ¨è¿™ä¸ªç»“æœ = å®Œç¾çŠ¶æ€ âœ… âœ… ç´¢å¼•å»ºå¯¹ âœ… planner åˆ¤æ–­æ­£ç¡® âœ… æ€§èƒ½è¡Œä¸ºç¬¦åˆé¢„æœŸ âœ… æ²¡æœ‰â€œéšè— bugâ€ ä½ ç°åœ¨é‡åˆ°çš„ä¸æ˜¯é—®é¢˜ï¼Œè€Œæ˜¯ï¼š\nå·²ç»ç†è§£åˆ°äº† pg_trgm çš„è¾¹ç•Œ\nå…«ã€æ€»ç»“ pg_trgm åœ¨ä¸­æ–‡ LIKE ä¸­ï¼š\n%èèµ„% -\u0026gt; é¡ºåºæ‰«ææ˜¯å¯¹çš„ %èèµ„é¢% -\u0026gt; ç´¢å¼•æ˜¯ç‹è€… è¿™ä¸æ˜¯é…ç½®é—®é¢˜ï¼Œæ˜¯æ•°å­¦é—®é¢˜ã€‚\n","description":" ä¸€ã€pg_trgm æ˜¯ä»€ä¹ˆï¼Ÿ pg_trgm æ˜¯ PostgreSQL çš„ä¸€ä¸ª æ‰©å±•æ¨¡å—ï¼Œç”¨äºï¼š\nåŸºäºâ€œå­—ç¬¦ç›¸ä¼¼åº¦â€è¿›è¡Œé«˜æ•ˆçš„æ¨¡ç³ŠåŒ¹é…\næ ¸å¿ƒèƒ½åŠ›ï¼š\nLIKE \u0026lsquo;%xxx%\u0026rsquo; ILIKE \u0026lsquo;%xxx%\u0026rsquo; ç›¸ä¼¼åº¦æœç´¢ï¼ˆæ¨¡ç³Šæ¨èï¼‰ æ’åºï¼ˆæŒ‰ç›¸ä¼¼åº¦ï¼‰ ğŸ“Œ å®ƒæ˜¯ PostgreSQL é‡Œå¤„ç†æ¨¡ç³Šå­—ç¬¦ä¸²æŸ¥è¯¢çš„ç‹ç‰Œ\näºŒã€ä»€ä¹ˆæ˜¯ Trigramï¼ˆä¸‰å…ƒç»„ï¼‰ï¼Ÿ Trigram = è¿ç»­çš„ 3 ä¸ªå­—ç¬¦\nä¾‹å¦‚ï¼š\n\u0026#34;èèµ„è®¡åˆ’\u0026#34; ä¼šè¢«æ‹†æˆï¼š\n\u0026#34; è\u0026#34;, \u0026#34; èèµ„\u0026#34;, \u0026#34;èèµ„è®¡\u0026#34;, \u0026#34;èµ„è®¡åˆ’\u0026#34;, \u0026#34;è®¡åˆ’ \u0026#34; pg_trgm é€šè¿‡æ¯”è¾ƒ trigram é›†åˆçš„â€œäº¤é›†æ¯”ä¾‹â€æ¥åˆ¤æ–­ç›¸ä¼¼åº¦\n"},{"id":367,"href":"/database/postgres/schema/","title":"PostgreSQL Schema","parent":"PostgreSQL","content":"ä¸€ã€Schema çš„æ¦‚å¿µ\nå®šä¹‰ï¼š\nPostgreSQL ä¸­çš„ Schema æ˜¯æ•°æ®åº“å¯¹è±¡çš„å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œç”¨äºç»„ç»‡æ•°æ®åº“ä¸­çš„è¡¨ã€è§†å›¾ã€å‡½æ•°ã€ç´¢å¼•ç­‰å¯¹è±¡ã€‚\nå¯ä»¥æŠŠå®ƒç†è§£ä¸º æ•°æ®åº“å†…çš„å­ç›®å½•ã€‚\nä½œç”¨ï¼š\né¿å…åŒåå¯¹è±¡å†²çªï¼ˆä¸åŒ schema å¯ä»¥æœ‰ç›¸åŒè¡¨åï¼‰ é€»è¾‘åˆ†ç»„æ•°æ®åº“å¯¹è±¡ï¼ˆæŒ‰æ¨¡å—ã€åŠŸèƒ½ã€å›¢é˜Ÿåˆ’åˆ†ï¼‰ æ”¯æŒå¤šç§Ÿæˆ·è®¾è®¡ï¼ˆä¸åŒ tenant ç”¨ä¸åŒ schemaï¼‰ é…åˆæƒé™ç®¡ç†ï¼Œé™åˆ¶å¯¹è±¡è®¿é—® é»˜è®¤ Schemaï¼š\nPostgreSQL é»˜è®¤æœ‰ public schema å¦‚æœåˆ›å»ºå¯¹è±¡æœªæŒ‡å®š schemaï¼Œåˆ™æ”¾åœ¨ public ä¸‹ äºŒã€Schema ä¸æ•°æ®åº“ã€è¡¨çš„å…³ç³» Database â”œâ”€ Schema 1 â”‚ â”œâ”€ Table a â”‚ â”œâ”€ View b â”‚ â””â”€ Function f1() â””â”€ Schema 2 â”œâ”€ Table a \u0026lt;-- å¯ä»¥å’Œ Schema 1 çš„ a åŒå â””â”€ Function f2() Database: å®¹å™¨çº§åˆ«ï¼Œå­˜æ”¾ Schema Schema: å‘½åç©ºé—´ï¼Œå­˜æ”¾è¡¨ã€è§†å›¾ã€å‡½æ•°ç­‰å¯¹è±¡ Object: è¡¨ã€è§†å›¾ã€ç´¢å¼•ã€å‡½æ•°ç­‰ ä¸‰ã€Schema çš„æ“ä½œ 1. åˆ›å»º Schema CREATE SCHEMA hr; -- æˆ–è€…æŒ‡å®šæ‹¥æœ‰è€… CREATE SCHEMA hr AUTHORIZATION hr_user; 2. åˆ é™¤ Schema DROP SCHEMA hr; -- å¤±è´¥ï¼Œå¦‚æœé‡Œé¢æœ‰å¯¹è±¡ DROP SCHEMA hr CASCADE; -- å¼ºåˆ¶åˆ é™¤ schema å†…æ‰€æœ‰å¯¹è±¡ 3. æŸ¥çœ‹ Schema -- æ‰€æœ‰ schema \\dn -- å½“å‰æ•°æ®åº“çš„å¯¹è±¡åŠ schema \\dt *.* å››ã€æŒ‡å®š schema åˆ›å»ºå¯¹è±¡ CREATE TABLE hr.employee ( id SERIAL PRIMARY KEY, name TEXT NOT NULL ); CREATE FUNCTION hr.get_employee_count() RETURNS INT AS $$ BEGIN RETURN (SELECT COUNT(*) FROM hr.employee); END; $$ LANGUAGE plpgsql; å¯¹è±¡å…¨åï¼šschema_name.object_name å¦‚æœä¸æŒ‡å®š schemaï¼Œåˆ™é»˜è®¤ public äº”ã€æœç´¢è·¯å¾„ï¼ˆsearch_pathï¼‰ PostgreSQL æ”¯æŒ search_path æ§åˆ¶é»˜è®¤ schema æŸ¥æ‰¾é¡ºåºï¼š\nSHOW search_path; SET search_path TO hr, public; æŸ¥è¯¢æ—¶ï¼Œå¦‚æœå¯¹è±¡æœªæŒ‡å®š schemaï¼ŒPostgreSQL ä¼šæŒ‰ search_path é¡ºåºæŸ¥æ‰¾ æ¨èåœ¨å¤š schema åœºæ™¯ä¸‹æ€»æ˜¯æ˜¾å¼æŒ‡å®š schemaï¼Œé¿å…æ­§ä¹‰ å…­ã€æƒé™ç®¡ç† Schema å¯ä»¥ç‹¬ç«‹æˆæƒï¼Œæ§åˆ¶å¯¹è±¡è®¿é—®ï¼š\n-- ç»™ç”¨æˆ· hr_user ä½¿ç”¨ hr schema GRANT USAGE ON SCHEMA hr TO hr_user; -- å…è®¸ç”¨æˆ·åœ¨ schema åˆ›å»ºå¯¹è±¡ GRANT CREATE ON SCHEMA hr TO hr_user; -- æ”¶å›æƒé™ REVOKE CREATE ON SCHEMA hr FROM hr_user; æ³¨æ„ï¼š\nUSAGE æƒé™ï¼šå¯ä»¥è®¿é—® schema å†…çš„å¯¹è±¡ï¼ˆä½†ä¸åŒ…å«è¡¨æ•°æ®ï¼‰ CREATE æƒé™ï¼šå¯ä»¥åœ¨ schema å†…åˆ›å»ºæ–°å¯¹è±¡ è¡¨çº§åˆ«æƒé™å•ç‹¬ç®¡ç†ï¼ˆSELECT/INSERT/UPDATE/DELETEï¼‰ ä¸ƒã€Schema çš„æœ€ä½³å®è·µ æ¨¡å—åŒ–è®¾è®¡\næŒ‰åŠŸèƒ½ã€æ¨¡å—ã€å›¢é˜Ÿåˆ’åˆ† schemaï¼Œä¾‹å¦‚ sales, hr, inventory é¿å…æ‰€æœ‰å¯¹è±¡éƒ½åœ¨ public ä¸‹ å¤šç§Ÿæˆ·è®¾è®¡\næ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹ schemaï¼Œæ•°æ®éš”ç¦»ï¼Œæƒé™ç®€å• æƒé™æ§åˆ¶\nåŒºåˆ† USAGE å’Œ CREATE è¡¨æƒé™æŒ‰ schema ç®¡ç†ï¼Œå‡å°‘é‡å¤æˆæƒ å‘½åçº¦å®š\nschema åå°å†™ï¼Œç”¨ä¸‹åˆ’çº¿åˆ†éš” å¯¹è±¡å…¨å schema.object æ˜¾å¼ä½¿ç”¨ é¿å… public ä¹±ç”¨\nç”Ÿäº§ç¯å¢ƒå°½é‡ä¸åœ¨ public schema åˆ›å»ºè¡¨æˆ–å‡½æ•° å…«ã€æŸ¥è¯¢ Schema å†…å¯¹è±¡ -- æŸ¥è¯¢ schema å†…æ‰€æœ‰è¡¨ SELECT table_name FROM information_schema.tables WHERE table_schema = \u0026#39;hr\u0026#39;; -- æŸ¥è¯¢ schema å†…æ‰€æœ‰å‡½æ•° SELECT routine_name FROM information_schema.routines WHERE specific_schema = \u0026#39;hr\u0026#39;; ä¹ã€Schema ä¸å¤‡ä»½/è¿ç§» pg_dump æ”¯æŒæŒ‰ schema å¤‡ä»½ï¼š\npg_dump -n hr mydb \u0026gt; hr_schema.sql pg_restore æ”¯æŒè¿˜åŸæŒ‡å®š schemaï¼š\npg_restore -n hr -d mydb hr_schema.sql åã€æ€»ç»“ Schema = æ•°æ®åº“å†…çš„å‘½åç©ºé—´ ä¸»è¦ç”¨é€”ï¼šé€»è¾‘åˆ†ç»„ + é¿å…å†²çª + æƒé™ç®¡ç† + å¤šç§Ÿæˆ· ä½¿ç”¨æ–¹å¼ï¼š åˆ›å»ºï¼šCREATE SCHEMA name åˆ é™¤ï¼šDROP SCHEMA name [CASCADE] æƒé™ï¼šGRANT USAGE / CREATE æŸ¥è¯¢ï¼šschema_name.object_name æˆ–è®¾ç½® search_path æœ€ä½³å®è·µï¼š æŒ‰æ¨¡å—æˆ–ç§Ÿæˆ·åˆ’åˆ† schema é¿å…ä¹±ç”¨ public æ˜¾å¼æŒ‡å®š schema åï¼Œé…åˆæƒé™ç®¡ç† ","description":"ä¸€ã€Schema çš„æ¦‚å¿µ\nå®šä¹‰ï¼š\nPostgreSQL ä¸­çš„ Schema æ˜¯æ•°æ®åº“å¯¹è±¡çš„å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œç”¨äºç»„ç»‡æ•°æ®åº“ä¸­çš„è¡¨ã€è§†å›¾ã€å‡½æ•°ã€ç´¢å¼•ç­‰å¯¹è±¡ã€‚\nå¯ä»¥æŠŠå®ƒç†è§£ä¸º æ•°æ®åº“å†…çš„å­ç›®å½•ã€‚\nä½œç”¨ï¼š\né¿å…åŒåå¯¹è±¡å†²çªï¼ˆä¸åŒ schema å¯ä»¥æœ‰ç›¸åŒè¡¨åï¼‰ é€»è¾‘åˆ†ç»„æ•°æ®åº“å¯¹è±¡ï¼ˆæŒ‰æ¨¡å—ã€åŠŸèƒ½ã€å›¢é˜Ÿåˆ’åˆ†ï¼‰ æ”¯æŒå¤šç§Ÿæˆ·è®¾è®¡ï¼ˆä¸åŒ tenant ç”¨ä¸åŒ schemaï¼‰ é…åˆæƒé™ç®¡ç†ï¼Œé™åˆ¶å¯¹è±¡è®¿é—® é»˜è®¤ Schemaï¼š\nPostgreSQL é»˜è®¤æœ‰ public schema å¦‚æœåˆ›å»ºå¯¹è±¡æœªæŒ‡å®š schemaï¼Œåˆ™æ”¾åœ¨ public ä¸‹ äºŒã€Schema ä¸æ•°æ®åº“ã€è¡¨çš„å…³ç³» Database â”œâ”€ Schema 1 â”‚ â”œâ”€ Table a â”‚ â”œâ”€ View b â”‚ â””â”€ Function f1() â””â”€ Schema 2 â”œâ”€ Table a \u0026lt;-- å¯ä»¥å’Œ Schema 1 çš„ a åŒå â””â”€ Function f2() Database: å®¹å™¨çº§åˆ«ï¼Œå­˜æ”¾ Schema Schema: å‘½åç©ºé—´ï¼Œå­˜æ”¾è¡¨ã€è§†å›¾ã€å‡½æ•°ç­‰å¯¹è±¡ Object: è¡¨ã€è§†å›¾ã€ç´¢å¼•ã€å‡½æ•°ç­‰ ä¸‰ã€Schema çš„æ“ä½œ 1. åˆ›å»º Schema CREATE SCHEMA hr; -- æˆ–è€…æŒ‡å®šæ‹¥æœ‰è€… CREATE SCHEMA hr AUTHORIZATION hr_user; 2. åˆ é™¤ Schema DROP SCHEMA hr; -- å¤±è´¥ï¼Œå¦‚æœé‡Œé¢æœ‰å¯¹è±¡ DROP SCHEMA hr CASCADE; -- å¼ºåˆ¶åˆ é™¤ schema å†…æ‰€æœ‰å¯¹è±¡ 3. æŸ¥çœ‹ Schema -- æ‰€æœ‰ schema \\dn -- å½“å‰æ•°æ®åº“çš„å¯¹è±¡åŠ schema \\dt *.* å››ã€æŒ‡å®š schema åˆ›å»ºå¯¹è±¡ CREATE TABLE hr.employee ( id SERIAL PRIMARY KEY, name TEXT NOT NULL ); CREATE FUNCTION hr.get_employee_count() RETURNS INT AS $$ BEGIN RETURN (SELECT COUNT(*) FROM hr.employee); END; $$ LANGUAGE plpgsql; å¯¹è±¡å…¨åï¼šschema_name.object_name å¦‚æœä¸æŒ‡å®š schemaï¼Œåˆ™é»˜è®¤ public äº”ã€æœç´¢è·¯å¾„ï¼ˆsearch_pathï¼‰ PostgreSQL æ”¯æŒ search_path æ§åˆ¶é»˜è®¤ schema æŸ¥æ‰¾é¡ºåºï¼š\n"},{"id":368,"href":"/database/postgres/postgresql-vs-mysql/","title":"PostgreSQL vs MySQL","parent":"PostgreSQL","content":" 1. æŸ¥è¯¢æ€§èƒ½ ç®€å•è¯»å†™ï¼ˆOLTP åœºæ™¯ï¼‰ MySQL 8.0ï¼šåœ¨é«˜å¹¶å‘ã€ç®€å•äº‹åŠ¡ï¼ˆå¦‚ç‚¹æŸ¥ã€æ’å…¥ï¼‰åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œå°¤å…¶é…åˆ InnoDB å¼•æ“å’Œä¼˜åŒ–çš„ç´¢å¼•ç»“æ„ï¼ˆå¦‚è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼‰ã€‚\nPostgreSQLï¼šä¼ ç»Ÿä¸Š OLTP æ€§èƒ½ç•¥é€Šäº MySQLï¼Œä½† PostgreSQL 12+ å¼•å…¥äº† JIT ç¼–è¯‘ã€å¹¶è¡ŒæŸ¥è¯¢ç­‰ä¼˜åŒ–ï¼Œåœ¨å¤æ‚æŸ¥è¯¢ä¸­ä¼˜åŠ¿æ˜æ˜¾ã€‚PostgreSQL 16/17 è¿›ä¸€æ­¥ä¼˜åŒ–äº† WALã€é”æœºåˆ¶å’Œç´¢å¼•æ•ˆç‡ï¼ŒOLTP æ€§èƒ½å·®è·æ˜¾è‘—ç¼©å°ã€‚\nå¤æ‚æŸ¥è¯¢ï¼ˆOLAP åœºæ™¯ï¼‰ PostgreSQL æ˜æ˜¾å ä¼˜ï¼šæ”¯æŒçª—å£å‡½æ•°ã€CTEã€ç‰©åŒ–è§†å›¾ã€æ›´å¼ºå¤§çš„æŸ¥è¯¢è§„åˆ’å™¨ã€å¹¶è¡Œæ‰§è¡Œï¼ˆå¤šæ ¸åˆ©ç”¨ï¼‰ã€å‘é‡åŒ–æ‰§è¡Œï¼ˆéƒ¨åˆ†é€šè¿‡æ‰©å±•å¦‚ Apache Arrow FDWï¼‰ã€‚\nMySQL 8.0 è™½ç„¶ä¹Ÿæ”¯æŒ CTEã€çª—å£å‡½æ•°ï¼Œä½†åœ¨å¤§è§„æ¨¡èšåˆã€å¤šè¡¨è¿æ¥ç­‰å¤æ‚åˆ†æåœºæ™¯ä¸­æ€§èƒ½é€šå¸¸ä¸å¦‚ PostgreSQLã€‚\n2. å¹¶å‘ä¸æ‰©å±•æ€§ MySQL 8.0ï¼š\nInnoDB å¼•æ“æ”¯æŒè¡Œçº§é”ã€MVCCï¼Œä½†åœ¨é«˜å¹¶å‘å†™å…¥æ—¶å¯èƒ½å‡ºç°é”ç«äº‰ï¼ˆå°¤å…¶åœ¨è‡ªå¢ä¸»é”®ã€å”¯ä¸€ç´¢å¼•å†²çªç­‰åœºæ™¯ï¼‰ã€‚ å¤åˆ¶åŸºäº binlogï¼Œä¸»ä»å»¶è¿Ÿåœ¨é«˜è´Ÿè½½ä¸‹å¯èƒ½è¾ƒæ˜æ˜¾ã€‚ æ”¯æŒ Group Replication å’Œ InnoDB Clusterï¼Œä½†é…ç½®å¤æ‚åº¦è¾ƒé«˜ã€‚ PostgreSQLï¼š\nMVCC å®ç°æ›´æˆç†Ÿï¼Œæ— â€œå›æ»šæ®µâ€æ¦‚å¿µï¼Œå†™æ“ä½œä¸ä¼šé˜»å¡è¯»ã€‚ PostgreSQL 16/17 å¼•å…¥äº† é€»è¾‘å¤åˆ¶å¢å¼ºã€æ›´é«˜æ•ˆçš„ vacuum æœºåˆ¶ã€å‡å°‘é”äº‰ç”¨ï¼ˆå¦‚åˆ†åŒºè¡¨é”ç²’åº¦ç»†åŒ–ï¼‰ã€‚ åŸç”Ÿæ”¯æŒé€»è¾‘å¤åˆ¶ã€ç‰©ç†æµå¤åˆ¶ï¼Œæ‰©å±•æ€§è‰¯å¥½ï¼›é…åˆ Citus ç­‰å¯å®ç°åˆ†å¸ƒå¼æ‰©å±•ã€‚ 3. å­˜å‚¨å¼•æ“ä¸æ•°æ®ç±»å‹ MySQL 8.0ï¼š\né»˜è®¤ InnoDBï¼Œæ”¯æŒ JSONã€GISã€å…¨æ–‡ç´¢å¼•ã€‚ å­˜å‚¨æ ¼å¼ç›¸å¯¹ç´§å‡‘ï¼Œé€‚åˆé«˜ååå†™å…¥ã€‚ ä¸æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ç±»å‹æˆ–æ“ä½œç¬¦ã€‚ PostgreSQLï¼š\næ”¯æŒä¸°å¯Œæ•°æ®ç±»å‹ï¼ˆæ•°ç»„ã€hstoreã€JSONBã€èŒƒå›´ç±»å‹ã€å‡ ä½•ã€ç½‘ç»œåœ°å€ç­‰ï¼‰ã€‚ JSONB æ€§èƒ½ä¼˜äº MySQL çš„ JSONï¼ˆå› äºŒè¿›åˆ¶å­˜å‚¨ + GIN ç´¢å¼•ï¼‰ã€‚ æ”¯æŒè‡ªå®šä¹‰ç±»å‹ã€å‡½æ•°ã€æ“ä½œç¬¦ã€æ‰©å±•ï¼ˆå¦‚ PostGISã€pg_trgmï¼‰ã€‚ 4. ç´¢å¼•ä¸ä¼˜åŒ–å™¨ MySQL 8.0ï¼š\næ”¯æŒ B+æ ‘ã€å…¨æ–‡ç´¢å¼•ã€ç©ºé—´ç´¢å¼•ã€é™åºç´¢å¼•ã€å‡½æ•°ç´¢å¼•ï¼ˆè¡¨è¾¾å¼ç´¢å¼•ï¼‰ã€‚ ä¼˜åŒ–å™¨ç›¸å¯¹ç®€å•ï¼Œç»Ÿè®¡ä¿¡æ¯æ›´æ–°ä¸å¤Ÿæ™ºèƒ½ï¼ˆéœ€æ‰‹åŠ¨ ANALYZEï¼‰ã€‚ PostgreSQLï¼š\næ”¯æŒ B-treeã€Hashã€GiSTã€SP-GiSTã€GINã€BRIN ç­‰å¤šç§ç´¢å¼•ã€‚ æŸ¥è¯¢ä¼˜åŒ–å™¨æ›´æ™ºèƒ½ï¼Œæ”¯æŒå¤šç»´ç»Ÿè®¡ã€è‡ªåŠ¨è®¡åˆ’ç¼“å­˜ï¼ˆprepared statementï¼‰ã€JIT ç¼–è¯‘ï¼ˆPG12+ï¼‰ã€‚ PostgreSQL 17 é¢„è®¡å°†è¿›ä¸€æ­¥ä¼˜åŒ– å¹¶è¡ŒæŸ¥è¯¢è°ƒåº¦ å’Œ ç´¢å¼•æ‰«ææ•ˆç‡ã€‚ 5. å¯é æ€§ä¸ä¸€è‡´æ€§ PostgreSQLï¼šä¸¥æ ¼éµå¾ª ACIDï¼ŒWAL æœºåˆ¶æˆç†Ÿï¼Œå´©æºƒæ¢å¤å¯é ã€‚è¢«å¹¿æ³›ç”¨äºé‡‘èã€ç”µä¿¡ç­‰å¼ºä¸€è‡´æ€§åœºæ™¯ã€‚\nMySQL 8.0ï¼šInnoDB ä¹Ÿæ”¯æŒ ACIDï¼Œä½†åœ¨æç«¯æ•…éšœä¸‹ï¼ˆå¦‚åŒå†™ç¼“å†²å¤±æ•ˆï¼‰å¯èƒ½å­˜åœ¨æ•°æ®æŸåé£é™©ï¼ˆç½•è§ï¼‰ã€‚\n6. å®é™…åŸºå‡†æµ‹è¯•å‚è€ƒï¼ˆç»¼åˆï¼‰ åœºæ™¯ MySQL 8.0 PostgreSQL 16/17 é«˜å¹¶å‘ç®€å•äº‹åŠ¡ï¼ˆTPC-C ç±»ä¼¼ï¼‰ â­â­â­â­â˜† â­â­â­â˜†â˜†ï¼ˆPG16+ å·²æ¥è¿‘ï¼‰ å¤æ‚åˆ†ææŸ¥è¯¢ï¼ˆTPC-Hï¼‰ â­â­â˜†â˜†â˜† â­â­â­â­â­ JSON å¤„ç† â­â­â­â˜†â˜† â­â­â­â­â­ï¼ˆJSONB + GINï¼‰ åœ°ç†ç©ºé—´æŸ¥è¯¢ â­â­â­â˜†â˜†ï¼ˆéœ€ GIS æ‰©å±•ï¼‰ â­â­â­â­â­ï¼ˆPostGIS æˆç†Ÿï¼‰ å†™å…¥ååï¼ˆæ‰¹é‡å¯¼å…¥ï¼‰ â­â­â­â­â˜† â­â­â­â˜†â˜†ï¼ˆä½†å¯é€šè¿‡ UNLOGGED è¡¨ä¼˜åŒ–ï¼‰ ç»“è®ºå»ºè®® é€‰æ‹© MySQL 8.0ï¼š\nåº”ç”¨ä»¥é«˜å¹¶å‘ç®€å•è¯»å†™ä¸ºä¸»ï¼ˆå¦‚ Web åº”ç”¨ã€ç”µå•†è®¢å•ï¼‰ã€‚ å›¢é˜Ÿç†Ÿæ‚‰ MySQL ç”Ÿæ€ï¼Œéœ€è¦å¿«é€Ÿéƒ¨ç½²å’Œæˆç†Ÿå·¥å…·é“¾ã€‚ å¯¹å­˜å‚¨æ•ˆç‡å’Œå†™å…¥ååæœ‰è¾ƒé«˜è¦æ±‚ã€‚ é€‰æ‹© PostgreSQLï¼ˆ16/17ï¼‰ï¼š\néœ€è¦å¤æ‚æŸ¥è¯¢ã€æ•°æ®åˆ†æã€GISã€å…¨æ–‡æœç´¢ç­‰é«˜çº§åŠŸèƒ½ã€‚ å¼ºè°ƒæ•°æ®å®Œæ•´æ€§ã€æ‰©å±•æ€§å’Œæ ‡å‡† SQL å…¼å®¹æ€§ã€‚ è®¡åˆ’ä½¿ç”¨ JSONBã€è‡ªå®šä¹‰ç±»å‹æˆ–æœªæ¥è¿ç§»åˆ°åˆ†å¸ƒå¼æ¶æ„ï¼ˆå¦‚ Citusï¼‰ã€‚ å¦‚éœ€å…·ä½“åœºæ™¯çš„åŸºå‡†æµ‹è¯•ï¼ˆå¦‚ sysbenchã€pgbenchã€TPC-Hï¼‰ã€‚\n","description":" 1. æŸ¥è¯¢æ€§èƒ½ ç®€å•è¯»å†™ï¼ˆOLTP åœºæ™¯ï¼‰ MySQL 8.0ï¼šåœ¨é«˜å¹¶å‘ã€ç®€å•äº‹åŠ¡ï¼ˆå¦‚ç‚¹æŸ¥ã€æ’å…¥ï¼‰åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œå°¤å…¶é…åˆ InnoDB å¼•æ“å’Œä¼˜åŒ–çš„ç´¢å¼•ç»“æ„ï¼ˆå¦‚è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼‰ã€‚\nPostgreSQLï¼šä¼ ç»Ÿä¸Š OLTP æ€§èƒ½ç•¥é€Šäº MySQLï¼Œä½† PostgreSQL 12+ å¼•å…¥äº† JIT ç¼–è¯‘ã€å¹¶è¡ŒæŸ¥è¯¢ç­‰ä¼˜åŒ–ï¼Œåœ¨å¤æ‚æŸ¥è¯¢ä¸­ä¼˜åŠ¿æ˜æ˜¾ã€‚PostgreSQL 16/17 è¿›ä¸€æ­¥ä¼˜åŒ–äº† WALã€é”æœºåˆ¶å’Œç´¢å¼•æ•ˆç‡ï¼ŒOLTP æ€§èƒ½å·®è·æ˜¾è‘—ç¼©å°ã€‚\nå¤æ‚æŸ¥è¯¢ï¼ˆOLAP åœºæ™¯ï¼‰ PostgreSQL æ˜æ˜¾å ä¼˜ï¼šæ”¯æŒçª—å£å‡½æ•°ã€CTEã€ç‰©åŒ–è§†å›¾ã€æ›´å¼ºå¤§çš„æŸ¥è¯¢è§„åˆ’å™¨ã€å¹¶è¡Œæ‰§è¡Œï¼ˆå¤šæ ¸åˆ©ç”¨ï¼‰ã€å‘é‡åŒ–æ‰§è¡Œï¼ˆéƒ¨åˆ†é€šè¿‡æ‰©å±•å¦‚ Apache Arrow FDWï¼‰ã€‚\n"},{"id":369,"href":"/database/postgres/xid/","title":"PostgreSQL XID é—®é¢˜","parent":"PostgreSQL","content":"PostgreSQL çš„ XID é—®é¢˜æŒ‡çš„æ˜¯ XID æº¢å‡ºé—®é¢˜ï¼ˆXID Wraparound Problemï¼‰ï¼Œå®ƒå‘ç”Ÿåœ¨ 32 ä½äº‹åŠ¡ ID (XID) è®¡æ•°å™¨è€—å°½æ—¶ã€‚å½“æœ€æ—§æ´»è·ƒäº‹åŠ¡ä¸æœ€æ–°äº‹åŠ¡çš„å¹´é¾„å·®è¶…è¿‡ 21 äº¿ï¼ˆçº¦å  32 ä½ç©ºé—´çš„ä¸€åŠï¼‰æ—¶ï¼ŒPostgreSQL ä¼šè¿›å…¥äº‹åŠ¡å›å·ä¿æŠ¤çŠ¶æ€ï¼Œåœæ­¢æ¥å—æ–°çš„å†™å…¥äº‹åŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­ï¼Œé€šå¸¸éœ€è¦é€šè¿‡æ‰§è¡Œ VACUUM æ¥ä¿®å¤ã€‚\nä»€ä¹ˆæ˜¯ XID é—®é¢˜ 32 ä½äº‹åŠ¡ ID (XID)ï¼šPostgreSQL ä½¿ç”¨ 32 ä½çš„ XID æ¥è·Ÿè¸ªäº‹åŠ¡ï¼Œå…¶æœ€å¤§å€¼çº¦ä¸º 42.9 äº¿ã€‚\nXID æº¢å‡ºï¼šå½“äº‹åŠ¡ ID è®¡æ•°å™¨åˆ°è¾¾æœ€å¤§å€¼å¹¶ä»å¤´å¼€å§‹é‡æ–°è®¡æ•°æ—¶ï¼Œå°±ä¼šå‘ç”Ÿ XID æº¢å‡ºã€‚è¿™å¯èƒ½å¯¼è‡´æ–°äº‹åŠ¡çš„ ID æ¯”æ—§äº‹åŠ¡çš„ ID å°ï¼Œå¼•èµ·é€»è¾‘æ··ä¹±å’Œæ•°æ®ä¸å¯ç”¨ã€‚\näº‹åŠ¡å›å·ä¿æŠ¤ï¼šä¸ºäº†é˜²æ­¢ XID æº¢å‡ºå¯¼è‡´æ•°æ®æŸåï¼Œå½“ç³»ç»Ÿæ£€æµ‹åˆ°æœ€æ—§æ´»è·ƒäº‹åŠ¡å’Œæœ€æ–°äº‹åŠ¡ä¹‹é—´çš„å¹´é¾„å·®è¾¾åˆ°ä¸€ä¸ªä¸´ç•Œå€¼æ—¶ï¼ˆé€šå¸¸æ˜¯ 21 äº¿ï¼‰ï¼Œå®ƒä¼šè¿›å…¥ä¿æŠ¤çŠ¶æ€ï¼Œé˜»æ­¢æ–°çš„å†™å…¥äº‹åŠ¡ï¼Œä»è€Œé¿å… XID æº¢å‡ºã€‚\nå¦‚ä½•è§£å†³ XID é—®é¢˜ æ‰§è¡Œ VACUUMï¼šåœ¨ç³»ç»Ÿè¿›å…¥ä¿æŠ¤çŠ¶æ€æ—¶ï¼Œé€šå¸¸éœ€è¦ä»¥å•ç”¨æˆ·æ¨¡å¼è¿æ¥æ•°æ®åº“ï¼Œå¹¶æ‰§è¡Œ VACUUM å‘½ä»¤æ¥æ¸…ç†æ—§çš„ã€å·²å¤±æ•ˆçš„æ•°æ®å’Œäº‹åŠ¡ã€‚\né¢‘ç¹è¿è¡Œ VACUUMï¼šä¸ºäº†é˜²æ­¢ XID é—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œå»ºè®®æ ¹æ®æ•°æ®åº“çš„å†™å…¥é‡é¢‘ç¹åœ°è¿è¡Œ VACUUMï¼Œä»¥é¿å…äº‹åŠ¡å¹´é¾„è¿‡å¤§ã€‚\nç³»ç»Ÿç»´æŠ¤ï¼šå®šæœŸæ£€æŸ¥æ•°æ®åº“çš„äº‹åŠ¡å¹´é¾„ï¼Œå¹¶é‡‡å–é¢„é˜²æªæ–½ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ autovacuum å‚æ•°æˆ–è€ƒè™‘è¿›è¡Œæ•°æ®åº“åˆ†ç‰‡ï¼ˆShardingï¼‰æ¥å‡è½»è¿™ä¸ªé—®é¢˜ã€‚\nPostgreSQL ä¸­çš„äº‹åŠ¡ID (XID) æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œä¸»è¦æ¶‰åŠå…¶å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ (MVCC) æœºåˆ¶å’Œäº‹åŠ¡IDå›å· (wraparound) é—®é¢˜ã€‚ç†è§£å¹¶å¦¥å–„ç®¡ç†XIDå¯¹äºæ•°æ®åº“çš„ç¨³å®šè¿è¡Œè‡³å…³é‡è¦ã€‚\nä»€ä¹ˆæ˜¯XIDï¼Ÿ XIDæ˜¯PostgreSQLåˆ†é…ç»™æ¯ä¸ªäº‹åŠ¡çš„32ä½æ— ç¬¦å·æ•´æ•°æ ‡è¯†ç¬¦ã€‚\nMVCCåŸºç¡€: PostgreSQLåˆ©ç”¨XIDæ¥åˆ¤æ–­æ•°æ®çš„å¯è§æ€§ã€‚æ•°æ®è¡Œï¼ˆå…ƒç»„ï¼‰çš„å¤´éƒ¨ä¼šå­˜å‚¨åˆ›å»ºå’Œï¼ˆæˆ–ï¼‰åˆ é™¤è¯¥è¡Œçš„äº‹åŠ¡IDï¼Œä»¥æ­¤æ¥ç¡®å®šå“ªäº›äº‹åŠ¡å¯ä»¥çœ‹åˆ°å“ªäº›è¡Œç‰ˆæœ¬ã€‚\næœ‰é™çš„èŒƒå›´: 32ä½çš„XIDç†è®ºä¸Šæœ‰å¤§çº¦40äº¿ä¸ªå¯èƒ½çš„å€¼ï¼ˆä»3å¼€å§‹ï¼‰ã€‚ç”±äºæ˜¯æ— ç¬¦å·æ•´æ•°ï¼Œå½“è¾¾åˆ°æœ€å¤§å€¼åï¼Œå®ƒä¼šä»å¤´å¼€å§‹å¾ªç¯ä½¿ç”¨ï¼ˆå›å·ï¼‰ã€‚\nä¸»è¦é—®é¢˜ï¼šäº‹åŠ¡IDå›å· (XID Wraparound)\nXIDå›å·æœ¬èº«æ˜¯ä¸€ç§è®¾è®¡æœºåˆ¶ï¼Œä½†å¦‚æœå¤„ç†ä¸å½“ï¼Œä¼šå¼•å‘ä¸¥é‡é—®é¢˜ï¼š\næ•°æ®åº“å…³é—­/åªè¯»: å¦‚æœæ•°æ®åº“çš„è‡ªåŠ¨æ¸…ç†ï¼ˆautovacuumï¼‰è¿›ç¨‹æœªèƒ½åŠæ—¶â€œå†»ç»“â€æ—§çš„äº‹åŠ¡IDï¼Œå¯¼è‡´å½“å‰XIDæ¥è¿‘æœ€å¤§å€¼ï¼ŒPostgreSQLä¼šå¼ºåˆ¶å°†æ•°æ®åº“åˆ‡æ¢ä¸ºåªè¯»æ¨¡å¼ï¼Œä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±å’ŒMVCCåˆ¤æ–­å¤±è´¥ã€‚\næ•°æ®æŸå: MVCCä¾èµ–äºXIDçš„ç›¸å¯¹é¡ºåºæ¥ç¡®å®šå¯è§æ€§ã€‚å¦‚æœXIDå›å·ä¸”æ—§äº‹åŠ¡IDæœªè¢«æ­£ç¡®æ ‡è®°ä¸ºâ€œå·²æäº¤â€ï¼ˆå³â€œå†»ç»“â€ï¼‰ï¼Œç³»ç»Ÿå¯èƒ½ä¼šé”™è¯¯åœ°å°†æœªæ¥çš„æ–°äº‹åŠ¡IDè§†ä¸ºå·²æäº¤çš„æ—§IDï¼Œå¯¼è‡´æ•°æ®æŸåæˆ–ä¸å¯è§ã€‚\nè§£å†³æ–¹æ¡ˆå’Œé¢„é˜²æªæ–½ è§£å†³XIDé—®é¢˜çš„æ ¸å¿ƒåœ¨äºç¡®ä¿åŠæ—¶è¿›è¡ŒVACUUMæ“ä½œï¼Œå°¤å…¶æ˜¯â€œå†»ç»“â€ï¼ˆFREEZEï¼‰æ“ä½œã€‚\nè‡ªåŠ¨æ¸…ç† (Autovacuum)\nPostgreSQLçš„autovacuumå®ˆæŠ¤è¿›ç¨‹ä¸»è¦è´Ÿè´£é¢„é˜²XIDå›å·é—®é¢˜ã€‚å®ƒä¼šè‡ªåŠ¨æ¸…ç†â€œæ­»â€å…ƒç»„ï¼Œå¹¶å°†æ—§äº‹åŠ¡æ ‡è®°ä¸ºâ€œå†»ç»“â€çŠ¶æ€ã€‚\né‡è¦å‚æ•°:\nautovacuum_freeze_max_age: æ§åˆ¶è¡¨åœ¨è¢«å¼ºåˆ¶æ‰§è¡ŒVACUUM FREEZEä¹‹å‰çš„æœ€å¤§äº‹åŠ¡IDå¹´é¾„ï¼ˆé»˜è®¤é€šå¸¸æ˜¯2äº¿äº‹åŠ¡ï¼‰ã€‚ vacuum_freeze_min_age å’Œ vacuum_freeze_table_age: è¿›ä¸€æ­¥æ§åˆ¶ä½•æ—¶è§¦å‘å†»ç»“æ“ä½œã€‚ æ‰‹åŠ¨å¹²é¢„\nå¦‚æœautovacuumè·Ÿä¸ä¸Šï¼ˆä¾‹å¦‚ï¼Œç”±äºå·¥ä½œè´Ÿè½½ç¹é‡ã€é…ç½®ä¸å½“ã€é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡é˜»å¡æ¸…ç†ï¼‰ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒVACUUMå‘½ä»¤ã€‚\nVACUUM(FREEZE) table_name: å¯ä»¥é’ˆå¯¹ç‰¹å®šè¡¨å¼ºåˆ¶æ‰§è¡Œå†»ç»“æ“ä½œã€‚\næ³¨æ„: æ‰‹åŠ¨VACUUM FULLä¼šé”å®šè¡¨ï¼Œåº”è°¨æ…ä½¿ç”¨ï¼Œæ ‡å‡†VACUUMå¯ä»¥ä¸å¤§å¤šæ•°æ“ä½œå¹¶è¡Œè¿è¡Œã€‚\nç›‘æ§\nç§¯æç›‘æ§æ•°æ®åº“çš„XIDä½¿ç”¨æƒ…å†µè‡³å…³é‡è¦ã€‚ ä½¿ç”¨age()å‡½æ•°å¯ä»¥ç¡®å®šæ•°æ®åº“æˆ–ç‰¹å®šè¡¨æœ€æ—§çš„æœªå†»ç»“äº‹åŠ¡IDçš„â€œå¹´é¾„â€ã€‚ SELECT datname, age(datfrozenxid) FROM pg_database; å¯ç”¨äºæ£€æŸ¥æ•°æ®åº“çº§åˆ«çš„XIDå¹´é¾„ã€‚ è®¾ç½®è­¦æŠ¥é˜ˆå€¼ï¼Œä»¥ä¾¿åœ¨æ¥è¿‘å±é™©é™åˆ¶ä¹‹å‰é‡‡å–è¡ŒåŠ¨ã€‚\né¿å…é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡\né•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ä¼šé˜»æ­¢VACUUMæ¸…ç†è¯¥äº‹åŠ¡å¯åŠ¨æ—¶å°šæœªæäº¤çš„æ—§å…ƒç»„ï¼Œä»è€Œé˜»ç¢XIDçš„å†»ç»“å’Œå›æ”¶ã€‚åº”åŠæ—¶è¯†åˆ«å¹¶ç»ˆæ­¢ï¼ˆå¦‚æœå¿…è¦ï¼‰è¿™äº›äº‹åŠ¡ã€‚\né€šè¿‡æœ‰æ•ˆçš„ç›‘æ§å’Œç¡®ä¿é€‚å½“çš„VACUUMç»´æŠ¤ï¼Œå¯ä»¥æˆåŠŸç®¡ç†PostgreSQL XIDï¼Œé¿å…äº‹åŠ¡IDå›å·å¸¦æ¥çš„é£é™©ã€‚\nPostgreSQL 18 uuidv7 èƒ½è§£å†³ XID é—®é¢˜å— ä¸èƒ½ã€‚\nPostgreSQL 18 ä¸­å¼•å…¥çš„ UUIDv7 æ”¯æŒæ— æ³•è§£å†³ XIDï¼ˆäº‹åŠ¡ IDï¼‰è€—å°½ï¼ˆå›å·ï¼‰é—®é¢˜ã€‚\nåŸå› å¦‚ä¸‹ï¼š\nUUIDv7 çš„ä½œç”¨ï¼šUUIDv7 æ˜¯ä¸€ç§æ–°å‹çš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯é€šè¿‡åœ¨ ID ä¸­åŒ…å«æ—¶é—´æˆ³æ¥è§£å†³ä¼ ç»Ÿéšæœº UUIDï¼ˆå¦‚ UUIDv4ï¼‰åœ¨ç”¨ä½œä¸»é”®æ—¶å¯¼è‡´çš„ B æ ‘ç´¢å¼•æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚å®ƒä½¿æ’å…¥æ“ä½œæ›´å…·é¡ºåºæ€§ï¼Œæé«˜äº†ç¼“å­˜æ•ˆç‡å’Œå‡å°‘äº†ç´¢å¼•ç¢ç‰‡ã€‚\nXID çš„ä½œç”¨ï¼šXID æ˜¯ PostgreSQL å†…éƒ¨ç”¨äºç®¡ç†å¹¶å‘å’Œ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰çš„äº‹åŠ¡æ ‡è¯†ç¬¦ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½ä¼šåˆ†é…ä¸€ä¸ª XIDã€‚XID æ˜¯ä¸€ä¸ª 32 ä½æ•´æ•°ï¼ˆæˆ–æ‰©å±•çš„ 64 ä½ï¼‰ï¼Œä¼šå‘¨æœŸæ€§åœ°å›å·ã€‚PostgreSQL ä½¿ç”¨ç‰¹å®šçš„æœºåˆ¶ï¼ˆå¦‚ VACUUM è¿›ç¨‹ï¼‰æ¥ç®¡ç†å’Œæ¸…ç†æ—§çš„ XIDï¼Œé˜²æ­¢å›å·é—®é¢˜å¯¼è‡´åœæœºã€‚\nä¸¤è€…æ— å…³ï¼šUUIDv7 æ˜¯ç”¨æˆ·æ•°æ®å±‚é¢çš„ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œè€Œ XID æ˜¯æ•°æ®åº“å¼•æ“åº•å±‚çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶ã€‚ä½¿ç”¨ UUIDv7 ä½œä¸ºåº”ç”¨ç¨‹åºçš„ä¸»é”®ï¼Œå¹¶ä¸ä¼šæ”¹å˜ PostgreSQL å¼•æ“ç®¡ç† XID çš„æ–¹å¼ï¼Œä¹Ÿä¸ä¼šå½±å“ XID ç©ºé—´çš„è€—å°½é€Ÿåº¦ã€‚\nXID å›å·æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€éœ€è¦é€šè¿‡é€‚å½“çš„æ•°æ®åº“ç»´æŠ¤ï¼ˆä¾‹å¦‚ç¡®ä¿ autovacuum æ­£å¸¸è¿è¡Œï¼‰æ¥è§£å†³çš„é—®é¢˜ã€‚UUIDv7 å¸¦æ¥çš„æ”¹è¿›ä¸»è¦é›†ä¸­åœ¨æ€§èƒ½ä¼˜åŒ–å’Œå¼€å‘äººå‘˜ä½“éªŒæ–¹é¢ï¼Œä¸ XID æœºåˆ¶æ²¡æœ‰ç›´æ¥è”ç³»ã€‚\n","description":"PostgreSQL çš„ XID é—®é¢˜æŒ‡çš„æ˜¯ XID æº¢å‡ºé—®é¢˜ï¼ˆXID Wraparound Problemï¼‰ï¼Œå®ƒå‘ç”Ÿåœ¨ 32 ä½äº‹åŠ¡ ID (XID) è®¡æ•°å™¨è€—å°½æ—¶ã€‚å½“æœ€æ—§æ´»è·ƒäº‹åŠ¡ä¸æœ€æ–°äº‹åŠ¡çš„å¹´é¾„å·®è¶…è¿‡ 21 äº¿ï¼ˆçº¦å  32 ä½ç©ºé—´çš„ä¸€åŠï¼‰æ—¶ï¼ŒPostgreSQL ä¼šè¿›å…¥äº‹åŠ¡å›å·ä¿æŠ¤çŠ¶æ€ï¼Œåœæ­¢æ¥å—æ–°çš„å†™å…¥äº‹åŠ¡ï¼Œå¯¼è‡´æœåŠ¡ä¸­æ–­ï¼Œé€šå¸¸éœ€è¦é€šè¿‡æ‰§è¡Œ VACUUM æ¥ä¿®å¤ã€‚\nä»€ä¹ˆæ˜¯ XID é—®é¢˜ 32 ä½äº‹åŠ¡ ID (XID)ï¼šPostgreSQL ä½¿ç”¨ 32 ä½çš„ XID æ¥è·Ÿè¸ªäº‹åŠ¡ï¼Œå…¶æœ€å¤§å€¼çº¦ä¸º 42.9 äº¿ã€‚\nXID æº¢å‡ºï¼šå½“äº‹åŠ¡ ID è®¡æ•°å™¨åˆ°è¾¾æœ€å¤§å€¼å¹¶ä»å¤´å¼€å§‹é‡æ–°è®¡æ•°æ—¶ï¼Œå°±ä¼šå‘ç”Ÿ XID æº¢å‡ºã€‚è¿™å¯èƒ½å¯¼è‡´æ–°äº‹åŠ¡çš„ ID æ¯”æ—§äº‹åŠ¡çš„ ID å°ï¼Œå¼•èµ·é€»è¾‘æ··ä¹±å’Œæ•°æ®ä¸å¯ç”¨ã€‚\näº‹åŠ¡å›å·ä¿æŠ¤ï¼šä¸ºäº†é˜²æ­¢ XID æº¢å‡ºå¯¼è‡´æ•°æ®æŸåï¼Œå½“ç³»ç»Ÿæ£€æµ‹åˆ°æœ€æ—§æ´»è·ƒäº‹åŠ¡å’Œæœ€æ–°äº‹åŠ¡ä¹‹é—´çš„å¹´é¾„å·®è¾¾åˆ°ä¸€ä¸ªä¸´ç•Œå€¼æ—¶ï¼ˆé€šå¸¸æ˜¯ 21 äº¿ï¼‰ï¼Œå®ƒä¼šè¿›å…¥ä¿æŠ¤çŠ¶æ€ï¼Œé˜»æ­¢æ–°çš„å†™å…¥äº‹åŠ¡ï¼Œä»è€Œé¿å… XID æº¢å‡ºã€‚\n"},{"id":370,"href":"/database/postgres/primary-key/","title":"PostgreSQL ä¸»é”®","parent":"PostgreSQL","content":"å†…å®¹ï¼šå®šä¹‰æ–¹å¼ã€åº•å±‚åŸç†ã€ç´¢å¼•ã€æœ€ä½³å®è·µã€å¸¸è§å‘\nä¸€ã€ä»€ä¹ˆæ˜¯ PostgreSQL ä¸»é”®ï¼Ÿ ä¸»é”® = å”¯ä¸€æ ‡è¯†ä¸€è¡Œæ•°æ®çš„åˆ—ï¼ˆæˆ–åˆ—ç»„åˆï¼‰\nåœ¨ PostgreSQL ä¸­ï¼Œä¸»é”®åŒæ—¶æ„å‘³ç€ï¼š\nå”¯ä¸€ï¼ˆUNIQUEï¼‰ éç©ºï¼ˆNOT NULLï¼‰ è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆB-Treeï¼‰ PRIMARY KEY = UNIQUE + NOT NULL + UNIQUE INDEX äºŒã€å®šä¹‰ä¸»é”®çš„å‡ ç§æ–¹å¼ï¼ˆä»æ¨èåˆ°ä¸æ¨èï¼‰ âœ… 1ï¸âƒ£ å»ºè¡¨æ—¶å®šä¹‰ï¼ˆæœ€æ¨èï¼‰ å•å­—æ®µä¸»é”®\nCREATE TABLE users ( id BIGINT PRIMARY KEY, name TEXT NOT NULL ); è”åˆä¸»é”®\nCREATE TABLE user_roles ( user_id BIGINT, role_id BIGINT, PRIMARY KEY (user_id, role_id) ); éå¸¸é€‚åˆ å¤šå¯¹å¤šå…³ç³»è¡¨ è‡ªåŠ¨é˜²æ­¢é‡å¤å…³ç³» âœ… 2ï¸âƒ£ ä½¿ç”¨ identity è‡ªå¢ä¸»é”®ï¼ˆPostgreSQL 10+ æ¨èï¼‰ CREATE TABLE articles ( id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY, title TEXT NOT NULL ); æˆ–ï¼š\nid BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY ä¸¤è€…åŒºåˆ«ï¼ˆé‡è¦ï¼‰ï¼š\nç±»å‹ æ˜¯å¦å…è®¸æ‰‹åŠ¨æ’å…¥ ALWAYS âŒ é»˜è®¤ç¦æ­¢ BY DEFAULT âœ… å…è®¸ âš ï¸ 3ï¸âƒ£ SERIALï¼ˆæ—§å†™æ³•ï¼Œä¸æ¨èæ–°é¡¹ç›®ï¼‰ id SERIAL PRIMARY KEY é—®é¢˜ï¼š\næœ¬è´¨æ˜¯ sequence + int ä¸ç¬¦åˆ SQL æ ‡å‡† å¯æ§æ€§å·® âŒ 4ï¸âƒ£ åæœŸç”¨ UNIQUE + NOT NULL ä»£æ›¿ï¼ˆä¸ç­‰ä»·ï¼‰ UNIQUE(id) + NOT NULL âŒ ä¸ç­‰ä»· âŒ è¯­ä¹‰ä¸åŒ âŒ å·¥å…· / ORM è¯†åˆ«ä¸äº†ä¸»é”® ä¸‰ã€ä¸»é”®çš„åº•å±‚åŸç†ï¼ˆä½ å¿…é¡»çŸ¥é“ï¼‰ 1ï¸âƒ£ ä¸»é”®å°±æ˜¯ä¸€ä¸ªå”¯ä¸€ç´¢å¼• \\d articles ä½ ä¼šçœ‹åˆ°ï¼š\n\u0026#34;articles_pkey\u0026#34; PRIMARY KEY, btree (id) 2ï¸âƒ£ æ’å…¥ / æ›´æ–°æ—¶çš„è¡Œä¸º æ’å…¥é‡å¤ä¸»é”® -\u0026gt; âŒ ç›´æ¥å¤±è´¥ æ›´æ–°ä¸»é”® -\u0026gt; ç­‰ä»·äºï¼š DELETE + INSERT æˆæœ¬å¾ˆé«˜ ğŸ“Œ ä¸»é”®å­—æ®µä¸€æ—¦ç¡®å®šï¼Œç»ä¸æ›´æ–°\nå››ã€ä¸»é”® vs å”¯ä¸€ç´¢å¼•ï¼ˆé‡è¦åŒºåˆ«ï¼‰ å¯¹æ¯” ä¸»é”® UNIQUE æ˜¯å¦å…è®¸ NULL âŒ âœ… ä¸€ä¸ªè¡¨èƒ½æœ‰å‡ ä¸ª 1 ä¸ª å¤šä¸ª ORM è¯†åˆ« âœ… âŒ è¯­ä¹‰ è¡Œæ ‡è¯† çº¦æŸ ğŸ‘‰ èƒ½ç”¨ä¸»é”®å°±ä¸è¦ç”¨ UNIQUE ä»£æ›¿\näº”ã€ä¸»é”®å­—æ®µç±»å‹å¦‚ä½•é€‰ï¼ˆæœ€ä½³å®è·µï¼‰ âœ… å¼ºçƒˆæ¨è BIGINT / UUID / ULID 1ï¸âƒ£ BIGINTï¼ˆæœ€å¸¸ç”¨ï¼‰ id BIGINT GENERATED ALWAYS AS IDENTITY é¡ºåºæ’å…¥ ç´¢å¼•å‹å¥½ COPY / JOIN å¿« 2ï¸âƒ£ UUIDï¼ˆåˆ†å¸ƒå¼ï¼‰ id UUID PRIMARY KEY DEFAULT gen_random_uuid(); âœ… å¤šèŠ‚ç‚¹å®‰å…¨ âŒ ç´¢å¼•è†¨èƒ€ âŒ å†™å…¥æ…¢ 3ï¸âƒ£ ULIDï¼ˆæ¨èæ›¿ä»£ UUIDï¼‰ æœ‰åº å…¨å±€å”¯ä¸€ ç´¢å¼•å‹å¥½ å…­ã€ä¸»é”®ä¸æ€§èƒ½çš„å…³ç³»ï¼ˆéå¸¸å…³é”®ï¼‰ â— ä¸»é”® = èšé›†ç´¢å¼•å—ï¼Ÿ\nPostgreSQL æ²¡æœ‰èšé›†ç´¢å¼•æ¦‚å¿µï¼ˆå’Œ MySQL InnoDB ä¸åŒï¼‰\nä¸»é”® â‰  æ•°æ®ç‰©ç†é¡ºåº ç‰©ç†é¡ºåºç”± æ’å…¥ / VACUUM / CLUSTER å†³å®š å¯é€‰ä¼˜åŒ–ï¼ˆé«˜çº§ï¼‰ CLUSTER articles USING articles_pkey; âœ… æå‡ä¸»é”®èŒƒå›´æŸ¥è¯¢ âŒ éè‡ªåŠ¨ âŒ å†™å…¥åä¼šé€æ¸å¤±æ•ˆ ä¸ƒã€COPY / å¯¼å…¥æ•°æ® ä¸ä¸»é”® 1ï¸âƒ£ identity + COPY GENERATED ALWAYS -\u0026gt; ç¦æ­¢æ‰‹å†™ id\nè§£å†³ï¼š\nä¸å¯¼ id æˆ–ä½¿ç”¨ \\copy \u0026hellip; OVERRIDING SYSTEM VALUE æˆ–æ”¹ä¸º BY DEFAULT 2ï¸âƒ£ å¯¼å…¥åä¸€å®šè¦ä¿®å¤åºåˆ— SELECT setval( pg_get_serial_sequence(\u0026#39;articles\u0026#39;, \u0026#39;id\u0026#39;), (SELECT MAX(id) FROM articles) ); å…«ã€ä¸»é”®è®¾è®¡æœ€ä½³å®è·µï¼ˆç”Ÿäº§æ€»ç»“ï¼‰ âœ… æ¯ä¸ªè¡¨ å¿…é¡»æœ‰ä¸»é”® âœ… ä¸»é”® ä¸å¯å˜ âœ… ä¸»é”® çŸ­ã€ç®€å•ã€æ•°å€¼å‹ä¼˜å…ˆ âœ… å¤šå¯¹å¤šè¡¨ç”¨ è”åˆä¸»é”® âŒ ä¸è¦ç”¨ä¸šåŠ¡å­—æ®µå½“ä¸»é”® âŒ ä¸è¦æ›´æ–°ä¸»é”® ä¹ã€æ€»ç»“ PostgreSQL ä¸»é”® = è¡Œçš„å”¯ä¸€èº«ä»½\næ¨èï¼šBIGINT identity\nä¸€æ¬¡è®¾è®¡ï¼Œæ°¸ä¸ä¿®æ”¹\n","description":"å†…å®¹ï¼šå®šä¹‰æ–¹å¼ã€åº•å±‚åŸç†ã€ç´¢å¼•ã€æœ€ä½³å®è·µã€å¸¸è§å‘\nä¸€ã€ä»€ä¹ˆæ˜¯ PostgreSQL ä¸»é”®ï¼Ÿ ä¸»é”® = å”¯ä¸€æ ‡è¯†ä¸€è¡Œæ•°æ®çš„åˆ—ï¼ˆæˆ–åˆ—ç»„åˆï¼‰\nåœ¨ PostgreSQL ä¸­ï¼Œä¸»é”®åŒæ—¶æ„å‘³ç€ï¼š\nå”¯ä¸€ï¼ˆUNIQUEï¼‰ éç©ºï¼ˆNOT NULLï¼‰ è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼ˆB-Treeï¼‰ PRIMARY KEY = UNIQUE + NOT NULL + UNIQUE INDEX äºŒã€å®šä¹‰ä¸»é”®çš„å‡ ç§æ–¹å¼ï¼ˆä»æ¨èåˆ°ä¸æ¨èï¼‰ âœ… 1ï¸âƒ£ å»ºè¡¨æ—¶å®šä¹‰ï¼ˆæœ€æ¨èï¼‰ å•å­—æ®µä¸»é”®\n"},{"id":371,"href":"/database/postgres/transaction/","title":"PostgreSQL äº‹åŠ¡","parent":"PostgreSQL","content":"å†…å®¹æ¶µç›–ï¼šäº‹åŠ¡åŸºç¡€ã€éš”ç¦»çº§åˆ«ã€é”ã€å¸¸è§é—®é¢˜ã€æœ€ä½³å®è·µã€æ€§èƒ½å»ºè®®ã€å¼‚å¸¸å¤„ç†ã€‚\n1. ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰ï¼Ÿ äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯æ•°æ®åº“ä¸­çš„ åŸå­æ“ä½œå•å…ƒï¼Œå…·æœ‰ï¼š\nåŸå­æ€§ï¼ˆAtomicityï¼‰ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ ç®€ç§° ACIDã€‚\näº‹åŠ¡ç¡®ä¿ä¸€ç»„ SQL è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚\n2. PostgreSQL å¦‚ä½•å¼€å¯ / æäº¤ / å›æ»šäº‹åŠ¡ï¼Ÿ è‡ªåŠ¨äº‹åŠ¡æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ æ¯æ¡ SQL éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼š\nINSERT INTO ... ; -- è‡ªåŠ¨å¼€å§‹ + è‡ªåŠ¨æäº¤ æ‰‹åŠ¨äº‹åŠ¡æ¨¡å¼ï¼ˆæ¨èï¼‰ BEGIN; UPDATE accounts SET balance = balance - 100 WHERE id = 1; UPDATE accounts SET balance = balance + 100 WHERE id = 2; COMMIT; -- æˆåŠŸ å¤±è´¥å›æ»šï¼š\nROLLBACK; ç­‰ä»·å‘½ä»¤ï¼š\nBEGIN æˆ– START TRANSACTION COMMIT ROLLBACK 3. PostgreSQL äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆIsolation Levelsï¼‰ PostgreSQL æ”¯æŒ 4 ç§éš”ç¦»çº§åˆ«ï¼š\néš”ç¦»çº§åˆ« è¯´æ˜ PostgreSQL é»˜è®¤ READ UNCOMMITTED å…è®¸è¯»æœªæäº¤ï¼ˆè„è¯»ï¼‰ã€‚PostgreSQL å®é™…ç­‰åŒäº READ COMMITTEDï¼Œä¸æ”¯æŒçœŸæ­£çš„è„è¯» âŒ READ COMMITTED æ¯æ¡è¯­å¥çœ‹åˆ°æäº¤åçš„æœ€æ–°æ•°æ® âœ… é»˜è®¤ REPEATABLE READ æ•´ä¸ªäº‹åŠ¡æœŸé—´çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§ âœ… ä¸å¯é‡å¤è¯»ä¸å­˜åœ¨ SERIALIZABLE å®Œå…¨ä¸²è¡ŒåŒ– âœ… æœ€å¼º è®¾ç½®éš”ç¦»çº§åˆ«ï¼š\nBEGIN ISOLATION LEVEL REPEATABLE READ; æˆ–ï¼š\nSET TRANSACTION ISOLATION LEVEL SERIALIZABLE; 4. PostgreSQL ä¸­äº‹åŠ¡å¿«ç…§ï¼ˆMVCCï¼‰ PostgreSQL ä½¿ç”¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ æ¥ä¿è¯äº‹åŠ¡éš”ç¦»ï¼š\nä¿®æ”¹ä¸ä¼šé˜»å¡è¯» è¯»ä¹Ÿä¸ä¼šé˜»å¡å†™ æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ˜¯è‡ªå·±å¿«ç…§å†…çš„æ•°æ® è¿™ä½¿å¾— PostgreSQL éå¸¸é€‚åˆé›†ç¾¤ OLTP é«˜å¹¶å‘åœºæ™¯ã€‚\n5. äº‹åŠ¡ + é”å…³ç³»ï¼ˆå¿…ä¼šï¼‰ å¸¸è§é”ï¼š\né”ç±»å‹ è§¦å‘åœºæ™¯ Row Share SELECT FOR SHARE Row Exclusive INSERTã€UPDATEã€DELETE Share CREATE INDEX Exclusive DROP TABLE Access Exclusive ALTER TABLEã€VACUUM FULL è¡Œçº§é”ï¼ˆæœ€å¸¸ç”¨ï¼‰\nSELECT * FROM accounts WHERE id = 1 FOR UPDATE; 6. Postgres äº‹åŠ¡çš„å¸¸è§é—®é¢˜ â—1. æ­»é”ï¼ˆDeadlockï¼‰ ERROR: deadlock detected å¸¸è§åŸå› ï¼š\nä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„è¡Œé” éå…¨å±€ä¸€è‡´çš„é”é¡ºåº ğŸ’¡ è§£å†³åŠæ³•ï¼šä¿æŒä¸€è‡´çš„é”é¡ºåº\nâ—2. äº‹åŠ¡å¤ªé•¿å¯¼è‡´è†¨èƒ€ï¼ˆbloatï¼‰ é•¿äº‹åŠ¡æ— æ³•é‡Šæ”¾æ—§ç‰ˆæœ¬è®°å½• -\u0026gt; è¡¨è†¨èƒ€ -\u0026gt; æ€§èƒ½ä¸‹é™ã€‚\nè§£å†³ï¼š\né¿å…é•¿äº‹åŠ¡ é¿å…é•¿æ—¶é—´ä¿æŒé—²ç½®äº‹åŠ¡ ç›‘æ§ pg_stat_activity â—3. idle in transaction è¯¥çŠ¶æ€ä¼šé€ æˆï¼š\nè¡Œæ— æ³•åˆ é™¤ï¼ˆVACUUM æ— æ³•æ¸…ç†ï¼‰ è¡¨è†¨èƒ€ã€æŸ¥è¯¢å˜æ…¢ é¿å…ï¼š\næ¯ä¸ªäº‹åŠ¡å¿…é¡»æ˜¾å¼ COMMIT æˆ– ROLLBACK åº”ç”¨ä¸€å®šè¦æ­£ç¡®å…³é—­è¿æ¥ 7. å¸¸è§äº‹åŠ¡æ¨¡å¼ â‘  å•æ¡è¯­å¥äº‹åŠ¡ï¼ˆé»˜è®¤ï¼‰ æœ€ç®€å•ï¼Œä½†è¿ç»­æ“ä½œä¸å®‰å…¨ã€‚\nâ‘¡ æ‰‹åŠ¨äº‹åŠ¡ æ¨èç”¨äºä¸€ç»„é€»è¾‘æ€§çš„æ›´æ–°ã€‚\nâ‘¢ SAVEPOINTï¼ˆå­äº‹åŠ¡ï¼‰ ç”¨äºæ•è·å±€éƒ¨å¼‚å¸¸ï¼Œè€Œä¸å›æ»šæ•´ä¸ªäº‹åŠ¡ã€‚\nBEGIN; SAVEPOINT sp1; INSERT INTO table VALUES (...); ROLLBACK TO sp1; COMMIT; 8. PostgreSQL é«˜çº§äº‹åŠ¡è¯­æ³• â‘  SELECT â€¦ FOR UPDATE é”è¡Œç”¨äºå®‰å…¨è¯»å–ï¼š\nSELECT * FROM orders WHERE id = 10 FOR UPDATE; â‘¡ SELECT â€¦ FOR NO KEY UPDATE / SHARE / KEY SHARE PostgreSQL ç»†åŒ–äº†è¯»å†™é”ï¼š\nè¯­æ³• é”çº§åˆ« åœºæ™¯ FOR UPDATE å¼ºå†™é” å‡†å¤‡ä¿®æ”¹è¯¥è¡Œ FOR NO KEY UPDATE ä¸ä¿®æ”¹ä¸»é”®æ—¶ä½¿ç”¨ æ›´è½»é‡ FOR SHARE å…±äº«é” ä¸å½±å“åˆ«äººè¯» FOR KEY SHARE æœ€å¼± å¤–é”®æ£€æŸ¥ 9. PostgreSQL äº‹åŠ¡åœ¨ Python SQLAlchemy ä¸­ä½¿ç”¨ è‡ªåŠ¨äº‹åŠ¡ï¼ˆ2.0 APIï¼‰\nasync with async_session() as session: async with session.begin(): obj = MyTable(...) session.add(obj) æ‰‹åŠ¨ commit / rollback\nsession = Session() try: session.add(obj) session.commit() except: session.rollback() raise 10. æœ€ä½³å®è·µæ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ é¿å…é•¿äº‹åŠ¡ ä¿æŒäº‹åŠ¡å°½å¯èƒ½çŸ­ã€‚\nä¸è¦è®©äº‹åŠ¡ idle å¦åˆ™ä¼šå¯¼è‡´ MVCC è†¨èƒ€ã€‚\nç¡®ä¿åº”ç”¨å‡ºç°å¼‚å¸¸æ—¶è‡ªåŠ¨ rollback å¤§äº‹åŠ¡æ‹†å°äº‹åŠ¡ å‡å°‘é”å†²çªã€‚\nç”¨ FOR UPDATE ä¿è¯æ•°æ®ä¸€è‡´æ€§ ç”¨äºæ‰£æ¬¾ã€åº“å­˜ç­‰ä¸šåŠ¡åœºæ™¯ã€‚\néš”ç¦»çº§åˆ«ç”¨é»˜è®¤å³å¯ READ COMMITTED è¶³å¤Ÿå¤šæ•°ä¸šåŠ¡ã€‚\n11. å¸¸è§äº‹åŠ¡æ’æŸ¥ SQL æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡ï¼š\nSELECT * FROM pg_stat_activity WHERE state = \u0026#39;active\u0026#39;; æŸ¥çœ‹é”ï¼š\nSELECT * FROM pg_locks l JOIN pg_stat_activity a ON l.pid = a.pid; æŸ¥çœ‹æ­»é”ï¼š\nSELECT * FROM pg_stat_activity WHERE wait_event = \u0026#39;Deadlock\u0026#39;; 12. äº‹åŠ¡è°ƒä¼˜å»ºè®® ä½¿ç”¨ statement_timeout é¿å…å¤§é‡ UPDATEï¼Œæ”¹ç”¨ UPSERT æˆ– INSERT-only æ¨¡å¼ åŠ ç´¢å¼•é¿å…é”å†²çª é«˜å¹¶å‘ä¸‹ä½¿ç”¨ SKIP LOCKED ä¾‹å¦‚ï¼š\nSELECT * FROM jobs WHERE status = \u0026#39;pending\u0026#39; FOR UPDATE SKIP LOCKED LIMIT 1; ğŸ“Œ æ€»ç»“ PostgreSQL äº‹åŠ¡ä½“ç³»éå¸¸å¼ºå¤§ï¼ˆMVCC è¶…è¶Šå¤§å¤šæ•°æ•°æ®åº“ï¼‰ï¼Œç†è§£å®ƒå¯ä»¥è§£å†³ï¼š\nå¹¶å‘å†™å†²çª æ­»é” é”è¡¨é—®é¢˜ è†¨èƒ€é—®é¢˜ ä¸€è‡´æ€§ä¿è¯ ","description":"å†…å®¹æ¶µç›–ï¼šäº‹åŠ¡åŸºç¡€ã€éš”ç¦»çº§åˆ«ã€é”ã€å¸¸è§é—®é¢˜ã€æœ€ä½³å®è·µã€æ€§èƒ½å»ºè®®ã€å¼‚å¸¸å¤„ç†ã€‚\n1. ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼ˆTransactionï¼‰ï¼Ÿ äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯æ•°æ®åº“ä¸­çš„ åŸå­æ“ä½œå•å…ƒï¼Œå…·æœ‰ï¼š\nåŸå­æ€§ï¼ˆAtomicityï¼‰ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ éš”ç¦»æ€§ï¼ˆIsolationï¼‰ æŒä¹…æ€§ï¼ˆDurabilityï¼‰ ç®€ç§° ACIDã€‚\näº‹åŠ¡ç¡®ä¿ä¸€ç»„ SQL è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚\n2. PostgreSQL å¦‚ä½•å¼€å¯ / æäº¤ / å›æ»šäº‹åŠ¡ï¼Ÿ è‡ªåŠ¨äº‹åŠ¡æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ æ¯æ¡ SQL éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼š\n"},{"id":372,"href":"/database/postgres/fts/","title":"PostgreSQL å…¨æ–‡æ£€ç´¢","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ä» 0 åˆ°ç”Ÿäº§å¯ç”¨çš„ PostgreSQL å…¨æ–‡æ£€ç´¢ï¼ˆFull-Text Search, FTSï¼‰å®Œæ•´æ•™ç¨‹ï¼Œè¦†ç›–ï¼šåŸç† -\u0026gt; è¯­æ³• -\u0026gt; ä¸­æ–‡ -\u0026gt; ç´¢å¼• -\u0026gt; æ’åº -\u0026gt; å®æˆ˜ -\u0026gt; æ€§èƒ½ä¼˜åŒ–ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯ PostgreSQL å…¨æ–‡æ£€ç´¢ï¼Ÿ PostgreSQL è‡ªå¸¦ å…¨æ–‡æ£€ç´¢å¼•æ“ï¼Œä¸ä¾èµ–å¤–éƒ¨ç»„ä»¶ï¼ˆå¦‚ ESï¼‰ï¼š\nåŸºäº è¯é¡¹ï¼ˆlexemeï¼‰ æ”¯æŒ æƒé‡ã€ç›¸å…³æ€§æ’åº æ”¯æŒ GIN / GiST ç´¢å¼• æ”¯æŒ å¸ƒå°” / çŸ­è¯­ / å‰ç¼€æŸ¥è¯¢ ğŸ‘‰ é€‚åˆï¼šæ–‡ç« ã€æ—¥å¿—ã€è¯„è®ºã€å…¬å‘Šã€è¯´æ˜æ–‡æ¡£\näºŒã€å…¨æ–‡æ£€ç´¢çš„ 3 ä¸ªæ ¸å¿ƒå¯¹è±¡ï¼ˆå¿…é¡»ç†è§£ï¼‰ å¯¹è±¡ ç±»å‹ ä½œç”¨ tsvector æ–‡æœ¬å‘é‡ è¢«ç´¢å¼•çš„æ•°æ® tsquery æŸ¥è¯¢æ¡ä»¶ æœç´¢è¡¨è¾¾å¼ to_tsvector() å‡½æ•° æ–‡æœ¬ -\u0026gt; å‘é‡ to_tsquery() å‡½æ•° å­—ç¬¦ä¸² -\u0026gt; æŸ¥è¯¢ ä¸‰ã€æœ€åŸºç¡€çš„å…¨æ–‡æ£€ç´¢ç¤ºä¾‹ 1ï¸âƒ£ æŠŠæ–‡æœ¬è½¬æˆ tsvector SELECT to_tsvector(\u0026#39;english\u0026#39;, \u0026#39;PostgreSQL is very powerful\u0026#39;); ç»“æœï¼ˆç¤ºæ„ï¼‰ï¼š\n\u0026#39;postgresql\u0026#39;:1 \u0026#39;power\u0026#39;:4 ğŸ‘‰ è‡ªåŠ¨ï¼š\nåˆ†è¯ å°å†™ å»åœç”¨è¯ è¯å¹²åŒ– 2ï¸âƒ£ æœ€åŸºæœ¬çš„å…¨æ–‡æŸ¥è¯¢ SELECT * FROM articles WHERE to_tsvector(\u0026#39;english\u0026#39;, content) @@ to_tsquery(\u0026#39;english\u0026#39;, \u0026#39;postgresql \u0026amp; power\u0026#39;); å››ã€æ¨èçš„ç”Ÿäº§è¡¨ç»“æ„è®¾è®¡ï¼ˆé‡ç‚¹ï¼‰ âŒ ä¸è¦åœ¨ WHERE é‡Œæ¯æ¬¡ to_tsvector()\nâœ… ç”¨â€œç”Ÿæˆåˆ— + ç´¢å¼•â€\nâœ… æ¨èå»ºè¡¨æ–¹å¼ï¼ˆPostgreSQL 12+ï¼‰\nCREATE TABLE articles ( id BIGSERIAL PRIMARY KEY, title TEXT NOT NULL, content TEXT NOT NULL, search_vector tsvector GENERATED ALWAYS AS ( setweight(to_tsvector(\u0026#39;simple\u0026#39;, title), \u0026#39;A\u0026#39;) || setweight(to_tsvector(\u0026#39;simple\u0026#39;, content), \u0026#39;B\u0026#39;) ) STORED ); æƒé‡è¯´æ˜\næƒé‡ å«ä¹‰ A éå¸¸é‡è¦ï¼ˆæ ‡é¢˜ï¼‰ B é‡è¦ C ä¸€èˆ¬ D æ¬¡è¦ å»ºç«‹ç´¢å¼•ï¼ˆå¿…é¡»ï¼‰\nCREATE INDEX idx_articles_search ON articles USING GIN (search_vector); äº”ã€å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼ˆå®æˆ˜ï¼‰ 1ï¸âƒ£ æ™®é€šæŸ¥è¯¢ SELECT id, title FROM articles WHERE search_vector @@ plainto_tsquery(\u0026#39;simple\u0026#39;, \u0026#39;èèµ„ è®¡åˆ’\u0026#39;); 2ï¸âƒ£ å¸¦ç›¸å…³æ€§æ’åºï¼ˆéå¸¸é‡è¦ï¼‰ SELECT id, title, ts_rank(search_vector, plainto_tsquery(\u0026#39;simple\u0026#39;, \u0026#39;èèµ„ è®¡åˆ’\u0026#39;)) AS rank FROM articles WHERE search_vector @@ plainto_tsquery(\u0026#39;simple\u0026#39;, \u0026#39;èèµ„ è®¡åˆ’\u0026#39;) ORDER BY rank DESC; 3ï¸âƒ£ æ”¯æŒå‰ç¼€ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰ SELECT * FROM articles WHERE search_vector @@ to_tsquery(\u0026#39;simple\u0026#39;, \u0026#39;è:*\u0026#39;); å…­ã€ä¸­æ–‡å…¨æ–‡æ£€ç´¢ï¼ˆé‡ç‚¹ï¼ï¼‰ âš ï¸ PostgreSQL é»˜è®¤ ä¸æ”¯æŒä¸­æ–‡åˆ†è¯\nè§£å†³æ–¹æ¡ˆå¯¹æ¯”\næ–¹æ¡ˆ æ¨èåº¦ è¯´æ˜ pg_jieba â­â­â­â­â­ æœ€ä½³ä¸­æ–‡ä½“éªŒ zhparser â­â­â­â­ å®˜æ–¹æ”¯æŒå¥½ simple + LIKE â­ å‹‰å¼ºå¯ç”¨ pg_trgm â­â­â­ é€‚åˆæ¨¡ç³Š âœ… æ–¹æ¡ˆä¸€ï¼špg_jiebaï¼ˆæœ€æ¨èï¼‰\nCREATE EXTENSION pg_jieba; SELECT * FROM articles WHERE to_tsvector(\u0026#39;jiebacfg\u0026#39;, content) @@ to_tsquery(\u0026#39;jiebacfg\u0026#39;, \u0026#39;èèµ„\u0026#39;); âœ… ä¸­æ–‡æ¨èå»ºè¡¨æ–¹å¼\nsearch_vector tsvector GENERATED ALWAYS AS ( setweight(to_tsvector(\u0026#39;jiebacfg\u0026#39;, title), \u0026#39;A\u0026#39;) || setweight(to_tsvector(\u0026#39;jiebacfg\u0026#39;, content), \u0026#39;B\u0026#39;) ) STORED ä¸ƒã€å…¨æ–‡æ£€ç´¢ vs LIKE / pg_trgm åœºæ™¯ æ¨è å…³é”®è¯æœç´¢ FTS ç›¸å…³æ€§æ’åº FTS ä¸­æ–‡æ¨¡ç³ŠåŒ…å« pg_trgm %xxx% pg_trgm ç²¾ç¡®çŸ­è¯­ FTS ğŸ‘‰ å…¨æ–‡æ£€ç´¢ â‰  æ¨¡ç³Šæœç´¢\nå…«ã€å…¨æ–‡æ£€ç´¢å¸¸è§å‡½æ•°é€ŸæŸ¥ å‡½æ•° ç”¨é€” plainto_tsquery è‡ªåŠ¨ AND to_tsquery æ‰‹å†™é€»è¾‘ phraseto_tsquery çŸ­è¯­ ts_rank ç›¸å…³æ€§ ts_rank_cd è¦†ç›–å¯†åº¦ ts_headline é«˜äº® ç¤ºä¾‹ï¼šé«˜äº®å…³é”®è¯\nSELECT ts_headline( \u0026#39;simple\u0026#39;, content, plainto_tsquery(\u0026#39;simple\u0026#39;, \u0026#39;èèµ„\u0026#39;) ) FROM articles; ä¹ã€æ€§èƒ½æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ âœ… å¿…é¡»åš\nç”¨ GIN ç´¢å¼• ç”¨ ç”Ÿæˆåˆ— å®šæœŸ ANALYZE çƒ­å­—æ®µåˆ†åŒºï¼ˆæ—¶é—´ï¼‰ âŒ ä¸è¦åš\nWHERE ä¸­ç›´æ¥ to_tsvector æ··ç”¨ä¸­æ–‡/è‹±æ–‡é…ç½® åœ¨ OLTP çƒ­è¡¨ä¸Šé«˜é¢‘å…¨æ–‡æ£€ç´¢ åã€å…¨æ–‡æ£€ç´¢ + TimescaleDBï¼ˆæ—¥å¿—åœºæ™¯ï¼‰ CREATE INDEX ON logs USING GIN (to_tsvector(\u0026#39;simple\u0026#39;, message)); é€‚åˆï¼š\næ—¥å¿—å…³é”®å­—æœç´¢ é”™è¯¯å®šä½ è¿ç»´åˆ†æ åä¸€ã€æ€»ç»“ï¼ˆå¿…è®°ï¼‰ PostgreSQL å…¨æ–‡æ£€ç´¢æ˜¯ â€œç»“æ„åŒ– + ç›¸å…³æ€§ + é«˜æ€§èƒ½â€ çš„æœç´¢å¼•æ“\nLIKE æ˜¯å­—ç¬¦ä¸²åŒ¹é…\nFTS æ˜¯è¯­ä¹‰æœç´¢\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ä» 0 åˆ°ç”Ÿäº§å¯ç”¨çš„ PostgreSQL å…¨æ–‡æ£€ç´¢ï¼ˆFull-Text Search, FTSï¼‰å®Œæ•´æ•™ç¨‹ï¼Œè¦†ç›–ï¼šåŸç† -\u0026gt; è¯­æ³• -\u0026gt; ä¸­æ–‡ -\u0026gt; ç´¢å¼• -\u0026gt; æ’åº -\u0026gt; å®æˆ˜ -\u0026gt; æ€§èƒ½ä¼˜åŒ–ã€‚\nä¸€ã€ä»€ä¹ˆæ˜¯ PostgreSQL å…¨æ–‡æ£€ç´¢ï¼Ÿ PostgreSQL è‡ªå¸¦ å…¨æ–‡æ£€ç´¢å¼•æ“ï¼Œä¸ä¾èµ–å¤–éƒ¨ç»„ä»¶ï¼ˆå¦‚ ESï¼‰ï¼š\nåŸºäº è¯é¡¹ï¼ˆlexemeï¼‰ æ”¯æŒ æƒé‡ã€ç›¸å…³æ€§æ’åº æ”¯æŒ GIN / GiST ç´¢å¼• æ”¯æŒ å¸ƒå°” / çŸ­è¯­ / å‰ç¼€æŸ¥è¯¢ ğŸ‘‰ é€‚åˆï¼šæ–‡ç« ã€æ—¥å¿—ã€è¯„è®ºã€å…¬å‘Šã€è¯´æ˜æ–‡æ¡£\näºŒã€å…¨æ–‡æ£€ç´¢çš„ 3 ä¸ªæ ¸å¿ƒå¯¹è±¡ï¼ˆå¿…é¡»ç†è§£ï¼‰ å¯¹è±¡ ç±»å‹ ä½œç”¨ tsvector æ–‡æœ¬å‘é‡ è¢«ç´¢å¼•çš„æ•°æ® tsquery æŸ¥è¯¢æ¡ä»¶ æœç´¢è¡¨è¾¾å¼ to_tsvector() å‡½æ•° æ–‡æœ¬ -\u0026gt; å‘é‡ to_tsquery() å‡½æ•° å­—ç¬¦ä¸² -\u0026gt; æŸ¥è¯¢ ä¸‰ã€æœ€åŸºç¡€çš„å…¨æ–‡æ£€ç´¢ç¤ºä¾‹ 1ï¸âƒ£ æŠŠæ–‡æœ¬è½¬æˆ tsvector SELECT to_tsvector(\u0026#39;english\u0026#39;, \u0026#39;PostgreSQL is very powerful\u0026#39;); ç»“æœï¼ˆç¤ºæ„ï¼‰ï¼š\n"},{"id":373,"href":"/database/postgres/built-in-functions/","title":"PostgreSQL å†…ç½®å‡½æ•°","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½è¶…ç³»ç»Ÿçº§çš„ PostgreSQL å†…ç½®å‡½æ•°å¤§å…¨ï¼ˆé™„åˆ†ç±» + ç¤ºä¾‹ï¼‰ï¼Œè¦†ç›– PostgreSQL 17 æ—¶ä»£å¸¸ç”¨çš„æ‰€æœ‰å‡½æ•°ç±»å‹ï¼Œé‡ç‚¹çªå‡ºå®é™…å¼€å‘ä¸­æœ€å¸¸ä½¿ç”¨çš„éƒ¨åˆ†ã€‚\nå†…å®¹åˆ†ä¸ºï¼š\nğŸ§Š æ ¸å¿ƒå‡½æ•°ï¼ˆå¿…ä¼šï¼‰ ğŸ”§ å­—ç¬¦ä¸²å‡½æ•° ğŸ•’ æ—¥æœŸä¸æ—¶é—´å‡½æ•° ğŸ”¢ æ•°å­¦å‡½æ•° ğŸ“¦ èšåˆå‡½æ•° ğŸª çª—å£å‡½æ•° ğŸ§¬ JSON å‡½æ•° ğŸ§± æ•°ç»„å‡½æ•° ğŸ—ï¸ ç±»å‹è½¬æ¢å‡½æ•° ğŸ“š ç³»ç»Ÿä¿¡æ¯å‡½æ•° ğŸ” åŠ å¯†ä¸å“ˆå¸Œå‡½æ•° ğŸ§© ç½‘ç»œä¸ IP ç›¸å…³å‡½æ•° ğŸ”€ å…¶ä»–ç‰¹æ®Šå‡½æ•°ï¼ˆæ­£åˆ™ã€èŒƒå›´ã€å‡ ä½•ï¼‰ ğŸ§Š 1. æ ¸å¿ƒé€šç”¨å‡½æ•°ï¼ˆæœ€å¸¸ç”¨ TOP çº§ï¼‰ COALESCE(value, \u0026hellip;) è¿”å›ç¬¬ä¸€ä¸ªé NULL å€¼ã€‚\nSELECT COALESCE(null, null, 5, 9); -- 5 NULLIF(a, b) ç›¸ç­‰æ—¶è¿”å› NULLã€‚\nSELECT NULLIF(10,10); -- NULL GREATEST(a, b, \u0026hellip;) / LEAST(a, b, \u0026hellip;) SELECT GREATEST(5, 9, 1); -- 9 ROUND(x, n) ä¿ç•™å°æ•°ï¼š\nSELECT ROUND(123.456, 2); -- 123.46 CAST / :: SELECT \u0026#39;123\u0026#39;::int; ğŸ”§ 2. å­—ç¬¦ä¸²å‡½æ•° LENGTH(s) é•¿åº¦ï¼š\nSELECT LENGTH(\u0026#39;hello\u0026#39;); -- 5 LOWER(s) / UPPER(s) SELECT LOWER(\u0026#39;Hello\u0026#39;); -- hello TRIM / LTRIM / RTRIM SELECT TRIM(\u0026#39; ab cd \u0026#39;); -- \u0026#39;ab cd\u0026#39; SUBSTRING(s, from, len) SELECT SUBSTRING(\u0026#39;abcdef\u0026#39;, 2, 3); -- \u0026#39;bcd\u0026#39; REPLACE(s, from, to) SELECT REPLACE(\u0026#39;abcabc\u0026#39;,\u0026#39;a\u0026#39;,\u0026#39;X\u0026#39;); -- XbcXbc POSITION(substr IN str) SELECT POSITION(\u0026#39;cd\u0026#39; IN \u0026#39;abcde\u0026#39;); -- 3 CONCAT(\u0026hellip;) / || SELECT \u0026#39;a\u0026#39; || \u0026#39;b\u0026#39;; -- ab STRING_AGG(col, sep) ï¼ˆèšåˆï¼‰\nSELECT STRING_AGG(name, \u0026#39;,\u0026#39;) FROM users; æ­£åˆ™ç›¸å…³ REGEXP_MATCHES, REGEXP_REPLACE, REGEXP_SPLIT_TO_ARRAY ğŸ•’ 3. æ—¥æœŸä¸æ—¶é—´å‡½æ•° å½“å‰æ—¶é—´ SELECT NOW(); SELECT CURRENT_TIMESTAMP; SELECT CURRENT_DATE; æ—¶é—´åŠ å‡ SELECT NOW() + INTERVAL \u0026#39;2 days\u0026#39;; EXTRACT(field FROM date) SELECT EXTRACT(YEAR FROM NOW()); DATE_TRUNC(field, timestamp) æŒ‰å¹´æœˆæ—¥æ—¶åŒºé—´æˆªæ–­ï¼š\nSELECT DATE_TRUNC(\u0026#39;month\u0026#39;, NOW()); å¹´é¾„è®¡ç®— SELECT AGE(\u0026#39;2025-01-01\u0026#39;, \u0026#39;2000-01-01\u0026#39;); -- 25 years ğŸ”¢ 4. æ•°å­¦å‡½æ•° ABS(x)ã€CEIL(x)ã€FLOOR(x) POWER(a, b)ã€SQRT(x) RANDOM()ï¼ˆ0-1ï¼‰ SELECT FLOOR(RANDOM() * 100); ğŸ“¦ 5. èšåˆå‡½æ•°ï¼ˆAggregatesï¼‰ COUNT(*) SELECT COUNT(*) FROM users; SUM(col) / AVG(col) / MIN / MAX SELECT AVG(age) FROM users; JSON_AGG / ARRAY_AGG SELECT ARRAY_AGG(id) FROM users; ğŸª 6. çª—å£å‡½æ•°ï¼ˆWindow Functionsï¼‰ ROW_NUMBER() OVER (\u0026hellip;) SELECT ROW_NUMBER() OVER (ORDER BY id) FROM users; RANK() / DENSE_RANK() LAG() / LEAD() å‰åè¡Œå–å€¼ SELECT LAG(amount) OVER (ORDER BY id) FROM orders; SUM() OVER ç´¯è®¡æ±‚å’Œï¼š\nSELECT SUM(amount) OVER (ORDER BY id) FROM orders; ğŸ§¬ 7. JSON / JSONB å‡½æ•°ï¼ˆPostgreSQL è¶…å¼ºï¼‰ è·å–é”®å€¼ SELECT data-\u0026gt;\u0026#39;name\u0026#39; FROM users_json; SELECT data-\u0026gt;\u0026gt;\u0026#39;name\u0026#39;; -- text åˆå¹¶å¯¹è±¡ SELECT jsonb \u0026#39;{\u0026#34;a\u0026#34;:1}\u0026#39; || \u0026#39;{\u0026#34;b\u0026#34;:2}\u0026#39;; éå†é”®å€¼ SELECT jsonb_each(data) FROM users_json; json_agg() èšåˆè¡Œæˆä¸º JSON æ•°ç»„ SELECT json_agg(u) FROM (SELECT id,name FROM users LIMIT 3) u; ğŸ§± 8. æ•°ç»„å‡½æ•° æ•°ç»„é•¿åº¦ SELECT array_length(tags, 1) FROM articles; unnest() å±•å¼€ä¸ºå¤šè¡Œ SELECT unnest(tags) FROM articles; æ•°ç»„æ˜¯å¦åŒ…å« SELECT \u0026#39;{1,2,3}\u0026#39;::int[] @\u0026gt; \u0026#39;{2}\u0026#39;; ğŸ—ï¸ 9. ç±»å‹è½¬æ¢å‡½æ•° / ç±»å‹æ£€æŸ¥ TO_CHAR(number_or_date, format) SELECT TO_CHAR(NOW(),\u0026#39;YYYY-MM-DD HH24:MI:SS\u0026#39;); TO_TIMESTAMP(epoch) SELECT TO_TIMESTAMP(1700000000); pg_typeof(x) SELECT pg_typeof(123); -- integer ğŸ“š 10. ç³»ç»Ÿä¿¡æ¯å‡½æ•° å½“å‰ç”¨æˆ· / æ•°æ®åº“ / schema\nSELECT CURRENT_USER; SELECT CURRENT_DATABASE(); SELECT CURRENT_SCHEMA(); æŸ¥çœ‹å½“å‰æŸ¥è¯¢\nSELECT pg_backend_pid(); SELECT pg_stat_activity; è·å–åˆ—è¡¨ï¼š\nSELECT * FROM pg_tables; SELECT * FROM pg_indexes; ğŸ” 11. åŠ å¯† / å“ˆå¸Œå‡½æ•° md5(text) SELECT md5(\u0026#39;abc\u0026#39;); pgcrypto æ‰©å±•ï¼ˆæ¨èï¼‰ å…ˆå®‰è£…ï¼š\nCREATE EXTENSION pgcrypto; å¸¸ç”¨ï¼š\nSELECT crypt(\u0026#39;password\u0026#39;, gen_salt(\u0026#39;bf\u0026#39;)); -- hash SELECT digest(\u0026#39;abc\u0026#39;, \u0026#39;sha256\u0026#39;); -- binary SELECT encode(digest(\u0026#39;abc\u0026#39;,\u0026#39;sha256\u0026#39;),\u0026#39;hex\u0026#39;); ğŸŒ 12. ç½‘ç»œ / IP å‡½æ•° PostgreSQL åŸç”Ÿæ”¯æŒ CIDR / INET ç±»å‹ã€‚\nåˆ¤æ–­ IP æ˜¯å¦å±äºç½‘æ®µ SELECT \u0026#39;192.168.1.8\u0026#39;::inet \u0026lt;\u0026lt; \u0026#39;192.168.1.0/24\u0026#39;; å–å­ç½‘ã€å¹¿æ’­åœ°å€\nSELECT broadcast(\u0026#39;192.168.1.10/24\u0026#39;::inet); SELECT netmask(\u0026#39;192.168.1.10/24\u0026#39;::inet); ğŸ”€ 13. å…¶ä»–ç‰¹æ®Šå†…ç½®å‡½æ•° æ­£åˆ™ SELECT \u0026#39;abc123\u0026#39; ~ \u0026#39;[0-9]\u0026#39;; -- true èŒƒå›´ç±»å‹å‡½æ•° SELECT int4range(1,10) @\u0026gt; 5; å‡ ä½•å‡½æ•° SELECT area(box(point(0,0), point(10,10))); ","description":"ä¸‹é¢æ˜¯ä¸€ä»½è¶…ç³»ç»Ÿçº§çš„ PostgreSQL å†…ç½®å‡½æ•°å¤§å…¨ï¼ˆé™„åˆ†ç±» + ç¤ºä¾‹ï¼‰ï¼Œè¦†ç›– PostgreSQL 17 æ—¶ä»£å¸¸ç”¨çš„æ‰€æœ‰å‡½æ•°ç±»å‹ï¼Œé‡ç‚¹çªå‡ºå®é™…å¼€å‘ä¸­æœ€å¸¸ä½¿ç”¨çš„éƒ¨åˆ†ã€‚\nå†…å®¹åˆ†ä¸ºï¼š\nğŸ§Š æ ¸å¿ƒå‡½æ•°ï¼ˆå¿…ä¼šï¼‰ ğŸ”§ å­—ç¬¦ä¸²å‡½æ•° ğŸ•’ æ—¥æœŸä¸æ—¶é—´å‡½æ•° ğŸ”¢ æ•°å­¦å‡½æ•° ğŸ“¦ èšåˆå‡½æ•° ğŸª çª—å£å‡½æ•° ğŸ§¬ JSON å‡½æ•° ğŸ§± æ•°ç»„å‡½æ•° ğŸ—ï¸ ç±»å‹è½¬æ¢å‡½æ•° ğŸ“š ç³»ç»Ÿä¿¡æ¯å‡½æ•° ğŸ” åŠ å¯†ä¸å“ˆå¸Œå‡½æ•° ğŸ§© ç½‘ç»œä¸ IP ç›¸å…³å‡½æ•° ğŸ”€ å…¶ä»–ç‰¹æ®Šå‡½æ•°ï¼ˆæ­£åˆ™ã€èŒƒå›´ã€å‡ ä½•ï¼‰ ğŸ§Š 1. æ ¸å¿ƒé€šç”¨å‡½æ•°ï¼ˆæœ€å¸¸ç”¨ TOP çº§ï¼‰ COALESCE(value, \u0026hellip;) è¿”å›ç¬¬ä¸€ä¸ªé NULL å€¼ã€‚\n"},{"id":374,"href":"/database/postgres/strip-whitespace/","title":"PostgreSQL å»é™¤ç©ºç™½","parent":"PostgreSQL","content":"åœ¨ PostgreSQL ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ trim() å‡½æ•°å»é™¤å­—æ®µé¦–å°¾çš„ç©ºç™½å­—ç¬¦ã€‚å¦‚æœéœ€è¦å»é™¤å­—ç¬¦ä¸²ä¸­æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨ replace() å‡½æ•°å°†æ‰€æœ‰ç©ºæ ¼æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\nå»é™¤é¦–å°¾ç©ºç™½ ä½¿ç”¨ trim() å‡½æ•°ã€‚\nSELECT trim(column) FROM table; trim(): é»˜è®¤å»é™¤å­—ç¬¦ä¸²å¼€å¤´å’Œç»“å°¾çš„ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ï¼‰ column: è¦å¤„ç†çš„å­—æ®µå table: è¡¨å å»é™¤æ‰€æœ‰ç©ºç™½ ä½¿ç”¨ replace() å‡½æ•°ã€‚\nSELECT replace(column, \u0026#39; \u0026#39;, \u0026#39;\u0026#39;) FROM table; replace(): å°†ç¬¬ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å‡ºç°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆè¿™é‡Œæ˜¯ç©ºæ ¼ \u0026rsquo; \u0026lsquo;ï¼‰æ›¿æ¢ä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆè¿™é‡Œæ˜¯ç©ºå­—ç¬¦ä¸² \u0026lsquo;\u0026rsquo;ï¼‰ã€‚ ","description":"åœ¨ PostgreSQL ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ trim() å‡½æ•°å»é™¤å­—æ®µé¦–å°¾çš„ç©ºç™½å­—ç¬¦ã€‚å¦‚æœéœ€è¦å»é™¤å­—ç¬¦ä¸²ä¸­æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨ replace() å‡½æ•°å°†æ‰€æœ‰ç©ºæ ¼æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\nå»é™¤é¦–å°¾ç©ºç™½ ä½¿ç”¨ trim() å‡½æ•°ã€‚\nSELECT trim(column) FROM table; trim(): é»˜è®¤å»é™¤å­—ç¬¦ä¸²å¼€å¤´å’Œç»“å°¾çš„ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ï¼‰ column: è¦å¤„ç†çš„å­—æ®µå table: è¡¨å å»é™¤æ‰€æœ‰ç©ºç™½ ä½¿ç”¨ replace() å‡½æ•°ã€‚\nSELECT replace(column, \u0026#39; \u0026#39;, \u0026#39;\u0026#39;) FROM table; replace(): å°†ç¬¬ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å‡ºç°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆè¿™é‡Œæ˜¯ç©ºæ ¼ \u0026rsquo; \u0026lsquo;ï¼‰æ›¿æ¢ä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆè¿™é‡Œæ˜¯ç©ºå­—ç¬¦ä¸² \u0026lsquo;\u0026rsquo;ï¼‰ã€‚ "},{"id":375,"href":"/database/postgres/update-delete-lock/","title":"PostgreSQL åœ¨ UPDATE / DELETE æ—¶é˜²æ­¢å…¶å®ƒæ“ä½œ","parent":"PostgreSQL","content":"åœ¨ PostgreSQL ä¸­ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨æ‰§è¡Œ UPDATE / DELETE æ—¶ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¿™äº›è¡Œè¿›è¡Œ INSERT/UPDATE/DELETE çš„å½±å“ï¼ˆç¡®ä¿ä¸€è‡´ã€éš”ç¦»ã€é¿å…å¹¶å‘å†²çªï¼‰ï¼Œæ ¸å¿ƒå°±æ˜¯æ­£ç¡®ä½¿ç”¨ é” ä¸ äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚\nä¸€ã€ä½¿ç”¨è¡Œçº§é”ï¼ˆRow-Level Locksï¼‰ 1ï¼‰SELECT â€¦ FOR UPDATE é”ä½é€‰ä¸­çš„è¡Œï¼Œä½¿å…¶ä»–äº‹åŠ¡æ— æ³•æ›´æ–°/åˆ é™¤è¿™äº›è¡Œ é˜²æ­¢åˆ«äºº UPDATE / DELETE ä½†å…è®¸åˆ«äºº SELECT BEGIN; SELECT * FROM table_name WHERE id = 100 FOR UPDATE; UPDATE table_name SET ... WHERE id = 100; COMMIT; ä½œç”¨\nå…¶å®ƒäº‹åŠ¡å¯¹åŒä¸€è¡Œæ‰§è¡Œ UPDATE / DELETE ä¼š ç­‰å¾… å½“å‰äº‹åŠ¡æäº¤ é˜²æ­¢å¹¶å‘æ”¹å†™ï¼Œä¿è¯ä½ æ“ä½œè¿™ä¸€è¡Œçš„ç‹¬å æ€§ 2ï¼‰SELECT â€¦ FOR NO KEY UPDATE å‡ ä¹ç­‰ä»·äº FOR UPDATEï¼Œä½†å…è®¸åˆ«äººåœ¨å”¯ä¸€é”®ä¸å˜çš„å‰æä¸‹ UPDATE æ¨èç”¨äºæ™®é€š UPDATE 3ï¼‰SELECT â€¦ FOR SHARE / FOR KEY SHARE ç”¨äºè¯»å…±äº«åœºæ™¯ï¼Œå…è®¸ä½ è¯»å–ä½†é˜»æ­¢å…¶ä»–äº‹åŠ¡åˆ é™¤è¡Œã€‚\näºŒã€åœ¨ UPDATE / DELETE è¯­å¥ä¸­ç›´æ¥åŠ é” ä¸ä¸€å®šè¦å•ç‹¬ SELECTï¼Œç›´æ¥å†™ï¼š\nUPDATE â€¦ RETURNINGï¼ˆè‡ªåŠ¨åŠ è¡Œé”ï¼‰\nPostgreSQL çš„ UPDATE ä¼šè‡ªåŠ¨å¯¹æ›´æ–°è¡ŒåŠ ä¸Š RowExclusiveLockï¼Œä½†è‹¥ä½ å¸Œæœ›æå‰é”è¡Œï¼Œå¯åŠ  CTEï¼š\nWITH lock_rows AS ( SELECT * FROM users WHERE id = 100 FOR UPDATE ) UPDATE users SET name = \u0026#39;hello\u0026#39; WHERE id IN (SELECT id FROM lock_rows); å¥½å¤„ï¼š\næ˜ç¡®é”å®šç›®æ ‡è¡Œï¼Œé¿å…æ›´æ–°æ—¶å‡ºç°ç«äº‰æˆ–æ„å¤–é˜»å¡ ä¸‰ã€ä½¿ç”¨æ›´ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼ˆSerializableï¼‰ å¦‚æœä½ æƒ³ä¿è¯ä½ çš„äº‹åŠ¡æœŸé—´ï¼Œæ•°æ®ä¸è¢«åˆ«äººæ”¹å˜ï¼Œå¯ä½¿ç”¨ï¼š\nSET TRANSACTION ISOLATION LEVEL SERIALIZABLE; æ•ˆæœï¼š\né˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» è‹¥æ£€æµ‹åˆ°å¹¶å‘å†²çªï¼Œä¼šæŠ¥é”™ could not serialize access due to concurrent update é€‚åˆé˜²æ­¢å¹¶å‘å†™å…¥æ—¶å¼•å‘é€»è¾‘é”™è¯¯\nå››ã€ä½¿ç”¨è¡¨çº§é”ï¼ˆä¸æ¨èä½†å¶å°”éœ€è¦ï¼‰ ä»…å½“ä½ éœ€è¦ â€œæ•´ä¸ªè¡¨ç¦æ­¢å†™å…¥â€ æ—¶ä½¿ç”¨ï¼š\nLOCK TABLE â€¦ IN SHARE MODE\nå…è®¸æŸ¥è¯¢ï¼Œä¸å…è®¸æ›´æ–°/åˆ é™¤\nLOCK TABLE â€¦ IN ACCESS EXCLUSIVE MODE\næœ€å¼ºé”ï¼Œé˜»æ­¢æ‰€æœ‰å…¶ä»–è¯»/å†™\nä¸æ¨èåœ¨é«˜å¹¶å‘ç³»ç»Ÿä½¿ç”¨ã€‚\nâ­ å®æˆ˜åœºæ™¯æ€»ç»“ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰ åœºæ™¯ 1ï¼šæ›´æ–°ä¸€è¡Œå¹¶é˜²æ­¢åˆ«äººä¿®æ”¹è¿™è¡Œ BEGIN; SELECT id FROM orders WHERE id = 123 FOR UPDATE; UPDATE orders SET status=\u0026#39;done\u0026#39; WHERE id = 123; COMMIT; åœºæ™¯ 2ï¼šé€»è¾‘åˆ é™¤ï¼ŒæœŸé—´ç¦æ­¢åˆ«äººæ’å…¥å†²çªæ•°æ®ï¼ˆå¦‚å”¯ä¸€é”®æ£€æŸ¥ï¼‰ BEGIN; SELECT * FROM users WHERE email = \u0026#39;a@b.com\u0026#39; FOR UPDATE; UPDATE users SET deleted=true WHERE email = \u0026#39;a@b.com\u0026#39;; COMMIT; åœºæ™¯ 3ï¼šæ‰¹é‡ UPDATEï¼Œéœ€è¦å…ˆé”å®šæ‰€æœ‰å—å½±å“çš„è¡Œ BEGIN; SELECT id FROM products WHERE price \u0026lt; 10 FOR UPDATE; UPDATE products SET price = price + 1 WHERE price \u0026lt; 10; COMMIT; åœºæ™¯ 4ï¼šé˜²æ­¢å¹¶å‘ Update å¼•å‘é€»è¾‘é”™è¯¯ ä½¿ç”¨ SERIALIZABLEï¼š\nBEGIN; SET TRANSACTION ISOLATION LEVEL SERIALIZABLE; UPDATE accounts SET balance = balance - 10 WHERE id = 5; COMMIT; å¦‚å†²çªä¼šè‡ªåŠ¨å›æ»šï¼Œéœ€è¦é‡æ–°æ‰§è¡Œã€‚\nğŸ¯ æœ€ä½³å®è·µæ€»ç»“ï¼ˆç®€æ˜ï¼‰ é—®é¢˜ æ¨èè§£å†³æ–¹æ¡ˆ é˜²æ­¢åˆ«äºº UPDATE / DELETE SELECT â€¦ FOR UPDATE é˜²æ­¢åˆ«äººåˆ é™¤ FOR SHARE / FOR KEY SHARE ç¡®ä¿æ›´æ–°æœŸé—´æ•°æ®ä¸å˜ FOR UPDATE æˆ– SERIALIZABLE ä¿è¯æ‰¹é‡ UPDATE çš„ä¸€è‡´æ€§ å…ˆ SELECT FOR UPDATE é”è¡Œï¼Œå† UPDATE å…¨è¡¨ç¦æ­¢å†™å…¥ LOCK TABLE IN SHARE MODE ","description":"åœ¨ PostgreSQL ä¸­ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨æ‰§è¡Œ UPDATE / DELETE æ—¶ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¿™äº›è¡Œè¿›è¡Œ INSERT/UPDATE/DELETE çš„å½±å“ï¼ˆç¡®ä¿ä¸€è‡´ã€éš”ç¦»ã€é¿å…å¹¶å‘å†²çªï¼‰ï¼Œæ ¸å¿ƒå°±æ˜¯æ­£ç¡®ä½¿ç”¨ é” ä¸ äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚\nä¸€ã€ä½¿ç”¨è¡Œçº§é”ï¼ˆRow-Level Locksï¼‰ 1ï¼‰SELECT â€¦ FOR UPDATE é”ä½é€‰ä¸­çš„è¡Œï¼Œä½¿å…¶ä»–äº‹åŠ¡æ— æ³•æ›´æ–°/åˆ é™¤è¿™äº›è¡Œ é˜²æ­¢åˆ«äºº UPDATE / DELETE ä½†å…è®¸åˆ«äºº SELECT BEGIN; SELECT * FROM table_name WHERE id = 100 FOR UPDATE; UPDATE table_name SET ... WHERE id = 100; COMMIT; ä½œç”¨\n"},{"id":376,"href":"/database/postgres/backup-restore/","title":"PostgreSQL å¤‡ä»½ä¸æ¢å¤","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€å®ç”¨çš„ PostgreSQL å¤‡ä»½ä¸æ¢å¤æŒ‡å—ï¼Œè¦†ç›–ï¼šé€»è¾‘å¤‡ä»½ã€ç‰©ç†å¤‡ä»½ã€å¢é‡å¤‡ä»½ã€PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰ã€å¸¸è§å®æˆ˜æ–¹æ¡ˆã€ä¼ä¸šçº§æœ€ä½³å®è·µã€‚\nç›®å½•\nå¤‡ä»½ç±»å‹æ€»è§ˆ é€»è¾‘å¤‡ä»½ï¼ˆpg_dump / pg_dumpallï¼‰ ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ WAL å½’æ¡£ä¸å¢é‡å¤‡ä»½ PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰å®Œæ•´æµç¨‹ å¸¸ç”¨å¤‡ä»½ç­–ç•¥ï¼ˆä¼ä¸šçº§æ¶æ„ï¼‰ æ¢å¤å¸¸è§é—®é¢˜ æœ€ä½³å®è·µæ€»ç»“ 1. PostgreSQL å¤‡ä»½ç±»å‹æ€»è§ˆ ç±»å‹ å·¥å…· çº§åˆ« æ˜¯å¦å¢é‡ æ˜¯å¦å¯é€‰åº“/è¡¨ å…¸å‹ç”¨é€” é€»è¾‘å¤‡ä»½ pg_dump/pg_dumpall SQL/ç»“æ„çº§ âŒ âœ… å°æ•°æ®é‡å¤‡ä»½ã€è¿ç§» ç‰©ç†å¤‡ä»½ pg_basebackup æ–‡ä»¶çº§ âŒï¼ˆä½†å¯ç»“åˆWALï¼‰ âŒ åŸºç¡€åº“å®Œæ•´é•œåƒ WAL å½’æ¡£ archive_mode WALæ—¥å¿— âœ… âŒ å¢é‡å¤‡ä»½ã€PITR å¿«ç…§å¤‡ä»½ LVM/ZFS/äº‘ç›˜å¿«ç…§ å—çº§ âœ… âŒ è¶…å¤§åº“å¿«é€Ÿå¤‡ä»½ æµå¤åˆ¶å¤‡ä»½ ä¸»ä»å¤åˆ¶ å®æ—¶ âœ… âŒ é«˜å¯ç”¨ã€çƒ­å¤‡ 2. é€»è¾‘å¤‡ä»½ï¼ˆpg_dump / pg_dumpallï¼‰ â­ åœºæ™¯\nå•ä¸ª database å¤‡ä»½ å•ä¸ªè¡¨å¤‡ä»½ è·¨ä¸»æœºè¿ç§»ã€ç»“æ„å˜æ›´ã€ç‰ˆæœ¬å‡çº§ å¯¼å‡ºéƒ¨åˆ†æ•°æ®ã€ç»“æ„ 2.1 å•åº“é€»è¾‘å¤‡ä»½ï¼ˆæœ€å¸¸ç”¨ï¼‰ pg_dump -U postgres -d mydb -F c -f mydb.dump å‚æ•°è¯´æ˜ï¼š\n-F c -\u0026gt; custom æ ¼å¼ï¼Œæ”¯æŒå‹ç¼©ä¸å¹¶è¡Œæ¢å¤ pg_restore æ¢å¤é€Ÿåº¦æ›´å¿« æ¢å¤ï¼š\npg_restore -U postgres -d mydb mydb.dump 2.2 å•è¡¨å¤‡ä»½ pg_dump -U postgres -d mydb -t users -F c -f users.dump æ¢å¤ï¼š\npg_restore -U postgres -d mydb -t users users.dump 2.3 å¯¼å‡ºæ‰€æœ‰æ•°æ®åº“ï¼ˆå…¨å±€ + æ‰€æœ‰åº“ï¼‰ pg_dumpall -U postgres \u0026gt; all.sql æ¢å¤ï¼š\npsql -U postgres -f all.sql 3. ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ â­ åœºæ™¯\nå®Œæ•´é•œåƒå¤‡ä»½ é›†ç¾¤å†·å¤‡ æ­å»ºä¸»ä»å¤åˆ¶ å®Œæ•´å¤‡ä»½\npg_basebackup -U replica -D /backup/pg -Fp -Xs -P å‚æ•°è¯´æ˜ï¼š\n-Fp æ–‡ä»¶æ ¼å¼ï¼ˆç›®å½•ï¼‰ -Xs å¤‡ä»½è¿‡ç¨‹ä¸­åŒæ—¶å¤åˆ¶ WAL -P æ˜¾ç¤ºè¿›åº¦ æ¢å¤ = ç›´æ¥å¤åˆ¶å›æ¥ï¼ˆæ–‡ä»¶çº§åˆ«ï¼‰\n4. WAL å½’æ¡£ä¸å¢é‡å¤‡ä»½ WALï¼ˆWrite-Ahead Logï¼‰è®°å½•æ‰€æœ‰å˜æ›´ã€‚\nåªè¦æœ‰ï¼š\n1 æ¬¡ç‰©ç†åŸºç¡€å¤‡ä»½ WAL æ—¥å¿—å½’æ¡£ å³å¯å®ç°ï¼š\nå¢é‡æ¢å¤ æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ 4.1 å¯ç”¨ WAL å½’æ¡£ postgresql.confï¼š\narchive_mode = on archive_command = \u0026#39;cp %p /data/wal_archive/%f\u0026#39; wal_level = replica max_wal_senders = 10 åˆ›å»ºå½’æ¡£ç›®å½•ï¼š\nmkdir -p /data/wal_archive 5. PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰å®Œæ•´æµç¨‹ï¼ˆæœ€æ ¸å¿ƒğŸ”¥ï¼‰ ä»¥ä¸‹æ˜¯ ä»è¯¯åˆ /è¯¯æ›´æ–°æ•°æ®æ¢å¤åˆ°è¿‡å»ä»»æ„æ—¶åˆ» çš„å®Œæ•´æ­¥éª¤ã€‚\nâ­ å‰ææ¡ä»¶\nä¸€æ¬¡ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ WAL å½’æ¡£å¯ç”¨æˆåŠŸ 5.1 åœæ­¢ PostgreSQL systemctl stop postgresql 5.2 æ¸…ç©ºæ—§æ•°æ®ç›®å½•ï¼Œç”¨åŸºç¡€å¤‡ä»½è¦†ç›– rm -rf /var/lib/postgresql/17/main/* cp -r /backup/pg/* /var/lib/postgresql/17/main/ 5.3 åˆ›å»ºæ¢å¤é…ç½®ï¼ˆPostgreSQL â‰¥ 12ï¼‰ åˆ›å»º postgresql.conf åŒçº§ç›®å½•ä¸­çš„ï¼š\nrecovery.signal\ntouch recovery.signal postgresql.auto.conf ä¸­å¢åŠ ï¼š\nrestore_command = \u0026#39;cp /data/wal_archive/%f %p\u0026#39; recovery_target_time = \u0026#39;2025-02-10 14:22:00\u0026#39; ä½ ä¹Ÿå¯ä»¥æ ¹æ®åœºæ™¯é€‰æ‹©ï¼š\nrecovery_target_lsn recovery_target_xid recovery_target_name recovery_target_time 5.4 å¯åŠ¨ PostgreSQL systemctl start postgresql æ•°æ®åº“ä¼šè‡ªåŠ¨ replay WAL ç›´åˆ°æŒ‡å®šæ—¶é—´ã€‚\n6. å¸¸ç”¨å¤‡ä»½ç­–ç•¥ï¼ˆä¼ä¸šçº§ï¼‰ ğŸ”¥ ä¼ä¸šæ¨èç­–ç•¥ï¼ˆé€‚åˆ 99% é¡¹ç›®ï¼‰\næ¯æ—¥\n00:00ï¼špg_basebackupï¼ˆåŸºç¡€å¤‡ä»½ï¼‰ æŒç»­\nWAL å½’æ¡£ï¼ˆå¢é‡å˜åŒ–ï¼‰ æ¯å‘¨\nå…¨é‡é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰ å¤‡ä»½å­˜åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆS3 / OSSï¼‰ æ¯æœˆ\næ¢å¤æ¼”ç»ƒ æ ¡éªŒå¤‡ä»½å®Œæ•´æ€§ï¼ˆpg_verifybackupï¼‰ â­ PostgreSQL å®˜æ–¹æ¨èæ–¹æ¡ˆ\nç‰©ç†å¤‡ä»½ + WAL -\u0026gt; ä¸»æ–¹æ¡ˆ é€»è¾‘å¤‡ä»½ -\u0026gt; é¢å¤–ä¿éšœ å¤šæœºå¼‚åœ°å­˜å‚¨ æ¯ 3 ä¸ªæœˆåšä¸€æ¬¡æ¢å¤æ¼”ç»ƒ 7. å¸¸è§æ¢å¤é—®é¢˜ï¼ˆæœ€å®ç”¨ï¼‰ âŒ 1. archive_command æŠ¥é”™å¯¼è‡´ WAL ä¸¢å¤± WAL ä¸å®Œæ•´ -\u0026gt; æ— æ³• PITR -\u0026gt; åªèƒ½ç”¨é€»è¾‘å¤‡ä»½æ¢å¤éƒ¨åˆ†æ•°æ®ã€‚\nâŒ 2. pg_basebackup ä¸åŒ…å« pg_wal è§£å†³ï¼šæ·»åŠ  -Xs å‚æ•°å¤åˆ¶ WALã€‚\nâŒ 3. PostgreSQL å¯åŠ¨åä¸€ç›´ recovery åŸå› ï¼š\nrestore_command è·¯å¾„é”™è¯¯ WAL ä¸å®Œæ•´ æ£€æŸ¥æ—¥å¿—ï¼š\njournalctl -u postgresql -f âŒ 4. æ¢å¤åæ•°æ®åº“æ˜¯åªè¯» ä½ å¿˜äº†åˆ é™¤ recovery.signalã€‚\n8. PostgreSQL å¤‡ä»½ä¸æ¢å¤æœ€ä½³å®è·µ å¯ç”¨ WAL å½’æ¡£ï¼ˆå¿…é¡»ï¼‰ ä½¿ç”¨ pg_basebackup åšåŸºç¡€å¤‡ä»½ ä½¿ç”¨ pg_verifybackup æ£€æŸ¥å¤‡ä»½ WAL + ç‰©ç†å¤‡ä»½ + é€»è¾‘å¤‡ä»½ ä¸‰å±‚ä¿æŠ¤ å®šæœŸåšã€Œæ¢å¤æ¼”ç»ƒã€ åœ¨ Kubernetes / äº‘ç¯å¢ƒä¸­ä½¿ç”¨ã€Œå¿«ç…§å¤‡ä»½ã€åŠ é€Ÿ å¼‚åœ°å¤‡ä»½ï¼ˆå°¤å…¶æ˜¯å¯¹è±¡å­˜å‚¨ï¼‰ æ‰§è¡Œå¢é‡æ¢å¤æ—¶ä½¿ç”¨ recovery_target_time ç²¾å‡†æ¢å¤ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€ç³»ç»Ÿã€æœ€å®ç”¨çš„ PostgreSQL å¤‡ä»½ä¸æ¢å¤æŒ‡å—ï¼Œè¦†ç›–ï¼šé€»è¾‘å¤‡ä»½ã€ç‰©ç†å¤‡ä»½ã€å¢é‡å¤‡ä»½ã€PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰ã€å¸¸è§å®æˆ˜æ–¹æ¡ˆã€ä¼ä¸šçº§æœ€ä½³å®è·µã€‚\nç›®å½•\nå¤‡ä»½ç±»å‹æ€»è§ˆ é€»è¾‘å¤‡ä»½ï¼ˆpg_dump / pg_dumpallï¼‰ ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ WAL å½’æ¡£ä¸å¢é‡å¤‡ä»½ PITRï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰å®Œæ•´æµç¨‹ å¸¸ç”¨å¤‡ä»½ç­–ç•¥ï¼ˆä¼ä¸šçº§æ¶æ„ï¼‰ æ¢å¤å¸¸è§é—®é¢˜ æœ€ä½³å®è·µæ€»ç»“ 1. PostgreSQL å¤‡ä»½ç±»å‹æ€»è§ˆ ç±»å‹ å·¥å…· çº§åˆ« æ˜¯å¦å¢é‡ æ˜¯å¦å¯é€‰åº“/è¡¨ å…¸å‹ç”¨é€” é€»è¾‘å¤‡ä»½ pg_dump/pg_dumpall SQL/ç»“æ„çº§ âŒ âœ… å°æ•°æ®é‡å¤‡ä»½ã€è¿ç§» ç‰©ç†å¤‡ä»½ pg_basebackup æ–‡ä»¶çº§ âŒï¼ˆä½†å¯ç»“åˆWALï¼‰ âŒ åŸºç¡€åº“å®Œæ•´é•œåƒ WAL å½’æ¡£ archive_mode WALæ—¥å¿— âœ… âŒ å¢é‡å¤‡ä»½ã€PITR å¿«ç…§å¤‡ä»½ LVM/ZFS/äº‘ç›˜å¿«ç…§ å—çº§ âœ… âŒ è¶…å¤§åº“å¿«é€Ÿå¤‡ä»½ æµå¤åˆ¶å¤‡ä»½ ä¸»ä»å¤åˆ¶ å®æ—¶ âœ… âŒ é«˜å¯ç”¨ã€çƒ­å¤‡ 2. é€»è¾‘å¤‡ä»½ï¼ˆpg_dump / pg_dumpallï¼‰ â­ åœºæ™¯\n"},{"id":377,"href":"/database/postgres/character-types/","title":"PostgreSQL å­—ç¬¦ç±»å‹","parent":"PostgreSQL","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ PostgreSQL å­—ç¬¦ç±»å‹ï¼ˆCharacter Typesï¼‰æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å®ç”¨çš„æ€»ç»“ï¼ŒåŒ…å«ï¼š\nPostgreSQL å­—ç¬¦ç±»å‹æœ‰å“ªäº› é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ æ€§èƒ½ä¸å­˜å‚¨å¯¹æ¯” æœ€ä½³å®è·µæ€»ç»“ï¼ˆé‡ç‚¹ï¼‰ å†…å®¹ç®€æ˜ä½†ä¸“ä¸šï¼Œé€‚åˆå®é™…åç«¯å¼€å‘ä½¿ç”¨ï¼ˆFastAPI + PostgreSQLï¼‰ã€‚\nâœ… PostgreSQL å­—ç¬¦ç±»å‹æ€»è§ˆ PostgreSQL æä¾›ä¸»è¦ 5 ç±»å­—ç¬¦ç›¸å…³ç±»å‹ï¼š\nç±»å‹ æè¿° char(n) å›ºå®šé•¿åº¦å­—ç¬¦ä¸² varchar(n) å¯å˜é•¿åº¦ï¼Œæœ‰é•¿åº¦é™åˆ¶ varchar / text å¯å˜é•¿åº¦ï¼Œæ— é•¿åº¦é™åˆ¶ text è¶…å¤§æ–‡æœ¬ citext ä¸åŒºåˆ†å¤§å°å†™çš„ text/varcharï¼ˆæ‰©å±•ï¼‰ å¦å¤–è¿˜æœ‰ï¼š\nç±»å‹ æè¿° bytea äºŒè¿›åˆ¶æ•°æ® json / jsonb JSON æ–‡æœ¬ç±»å‹ ä¸‹é¢æˆ‘ä»¬é€ä¸ªè®²è§£ã€‚\n1. char(n) â€”â€” å›ºå®šé•¿åº¦å­—ç¬¦ä¸² âœ… åœºæ™¯\næ ¼å¼å›ºå®šçš„å€¼ï¼Œä¾‹å¦‚ï¼š æ€§åˆ«ï¼šchar(1) -\u0026gt; \u0026lsquo;M\u0026rsquo;/\u0026lsquo;F\u0026rsquo; çŠ¶æ€ç ï¼šchar(1)ã€char(2) ISO å›½å®¶ä»£ç ï¼šchar(2) å›ºå®šæ ¼å¼ç¼–ç  ğŸ‘ ä¼˜ç‚¹\né•¿åº¦å›ºå®šçš„å­˜å‚¨ï¼ŒæŸäº›åœºæ™¯ä¸­èŠ‚çœç©ºé—´ å¯¹é½ä¼˜åŒ–ï¼ˆæå°‘è§ï¼Œå‡ ä¹ç”¨ä¸åˆ°ï¼‰ ğŸ‘ ç¼ºç‚¹\nPostgreSQL ä¼š è‡ªåŠ¨è¡¥ç©ºæ ¼åˆ°å›ºå®šé•¿åº¦ æŸ¥è¯¢æ—¶ä¼šè¢« trim æ‰ï¼Œä½†è§†è§‰ä¸Šå®¹æ˜“è¯¯å¯¼ å†™å…¥ä¸åˆæ ¼çš„é•¿åº¦ä¼šæŠ¥é”™ ç»´æŠ¤éº»çƒ¦ â— ç»“è®º\né™¤éå­—æ®µæœ¬æ¥å°±æ˜¯å›ºå®šé•¿åº¦ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨ char(n)ã€‚\n2. varchar(n) â€”â€” å¯å˜é•¿åº¦ + é™åˆ¶é•¿åº¦ âœ… åœºæ™¯\nç”¨æˆ·å varchar(50) æ ‡é¢˜ title varchar(200) æ‰‹æœºå·ï¼ˆ11 å­—ç¬¦ï¼‰varchar(20) æ ‡ç­¾ label varchar(100) ğŸ‘ ä¼˜ç‚¹\næœ‰é•¿åº¦é™åˆ¶ï¼Œä¿è¯è¾“å…¥å®‰å…¨ å¸¸ç”¨äºè¾“å…¥å­—æ®µ å¯¹æ€§èƒ½å½±å“éå¸¸å°ï¼Œæ˜¯å¸¸ç”¨ç±»å‹ ğŸ‘ ç¼ºç‚¹\nè®¾è®¡ä¸å½“æ—¶ï¼šä¹±ç”¨è¿‡å°é•¿åº¦å¯¼è‡´æœªæ¥éœ€è¦è¿ç§» å¤§å¤šæ•°åœºæ™¯å¹¶ä¸çœŸçš„éœ€è¦é•¿åº¦é™åˆ¶ â— ç»“è®º\nç”¨äºæœ‰ â€œä¸šåŠ¡çº¦æŸé•¿åº¦â€ çš„å­—æ®µã€‚ ä¾‹å¦‚ï¼šæ‰‹æœºå·ç  email ç”¨æˆ·åç­‰ã€‚ 3. varcharï¼ˆæ— é™åˆ¶ï¼‰ å’Œ text â€”â€” å¯å˜é•¿åº¦ï¼Œæ— é™åˆ¶ â€» åœ¨ PostgreSQL ä¸­ï¼Œvarchar å’Œ text å®Œå…¨ç­‰ä»·ï¼Œæ€§èƒ½ä¹Ÿä¸€æ ·ã€‚ è¿™ä¸€ç‚¹å’Œ MySQL å®Œå…¨ä¸åŒã€‚\nâœ… åœºæ™¯\næ–‡ç« æ ‡é¢˜ï¼štitle textï¼ˆé•¿æ ‡é¢˜ï¼‰ å†…å®¹ä¸»ä½“ï¼šcontent text URL / JSON å­—ç¬¦ä¸² ä¸ç¡®å®šæ˜¯å¦æœ‰é•¿åº¦ä¸Šé™çš„å­—æ®µ ğŸ‘ ä¼˜ç‚¹\næ— é•¿åº¦é™åˆ¶ï¼Œçµæ´» PostgreSQL å†…éƒ¨ä¼˜åŒ–è‰¯å¥½ï¼Œæ— é¢å¤–æ€§èƒ½æŸè€— ä¸ varchar(n) ä¸€æ ·å¯å»ºç«‹ç´¢å¼• æ˜¯ PostgreSQL ä¸­æœ€å¸¸ç”¨å­—ç¬¦ç±»å‹ ğŸ‘ ç¼ºç‚¹\næ— â€œç¡¬é™åˆ¶â€å¯èƒ½å¯¼è‡´ä¸šåŠ¡å­—æ®µè¾“å…¥è¿‡é•¿ï¼ˆå¯é€šè¿‡ check constraint è§£å†³ï¼‰ â— ç»“è®º\né»˜è®¤åº”è¯¥ä½¿ç”¨ textã€‚\nå‡ºäºç®€å•ã€çµæ´»ã€æ˜“ç»´æŠ¤çš„åŸåˆ™ï¼Œtext æ˜¯æœ€æ¨èçš„ç±»å‹ã€‚\n4. citextï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ éœ€è¦å¯ç”¨æ‰©å±•ï¼š\nCREATE EXTENSION IF NOT EXISTS citext; âœ… åœºæ™¯\néœ€è¦å¤§å°å†™ä¸æ•æ„Ÿçš„å­—æ®µï¼š email username æ ‡ç­¾å ğŸ‘ ä¼˜ç‚¹\nè‡ªåŠ¨å¤§å°å†™ä¸æ•æ„Ÿæ¯”è¾ƒï¼ˆæ— éœ€ LOWER()ï¼‰ å»ºç´¢å¼•æ—¶è‡ªåŠ¨å¤§å°å†™ä¸æ•æ„Ÿ æŸ¥è¯¢æ€§èƒ½é«˜äº lower(column) ğŸ‘ ç¼ºç‚¹\næ˜¯æ‰©å±•ï¼Œä¸æ˜¯å†…ç½® ä¸æŸäº›æ¡†æ¶å…¼å®¹æ€§ç•¥å·®ï¼ˆFastAPI + SQLAlchemy æ²¡é—®é¢˜ï¼‰ â— ç»“è®º\nemail / username æœ€ä½³ç±»å‹ï¼šcitextï¼ˆè€Œä¸æ˜¯ varcharï¼‰\n5. bytea â€”â€” äºŒè¿›åˆ¶æ•°æ® âœ… åœºæ™¯\nå›¾ç‰‡äºŒè¿›åˆ¶ æ–‡ä»¶å†…å®¹ åŠ å¯†æ•°æ® â— ä¸æ¨èå­˜å‚¨å¤§æ–‡ä»¶ï¼Œç”¨å¯¹è±¡å­˜å‚¨æ›¿ä»£ï¼ˆS3ã€OSSï¼‰ã€‚\n6. JSON ç±»å‹ï¼ˆjson / jsonbï¼‰ æ–‡æœ¬ç±»ç»“æ„åŒ–æ•°æ®ï¼š\nç”¨æˆ·è®¾ç½® æ‰©å±•å­—æ®µï¼ˆæ—  schemaï¼‰ æ ‡ç­¾æ•°ç»„ å…ƒæ•°æ® æ¨è jsonbï¼ˆæœ‰ç´¢å¼•ã€å¯æŸ¥è¯¢ï¼‰ã€‚\nğŸ“Œ PostgreSQL å­—ç¬¦ç±»å‹æ€§èƒ½å¯¹æ¯”ï¼ˆé‡ç‚¹ï¼‰ ç±»å‹ æŸ¥è¯¢æ€§èƒ½ å­˜å‚¨æ•ˆç‡ ä½¿ç”¨å¤æ‚åº¦ char(n) âŒ æ…¢ \u0026amp; è¡¥ç©ºæ ¼ ä¸ä¸€å®šçœç©ºé—´ é«˜ varchar(n) âœ… å¿« âœ… é«˜ ä¸­ varchar âœ… å¿« âœ… é«˜ ä½ text âœ… å¿« âœ… é«˜ æœ€ä½ï¼ˆæœ€ä½³ï¼‰ citext âœ… ä¸­é«˜ âœ… é«˜ ä¸­ Postgres ä¸­ varchar = text æ€§èƒ½å’Œå­˜å‚¨æ— å·®åˆ«ï¼Œä¸åƒ MySQLã€‚\nâ­ PostgreSQL å­—ç¬¦ç±»å‹æœ€ä½³å®è·µï¼ˆæ€»ç»“ç‰ˆï¼‰ ğŸ”¥ æœ€æ¨è\nåœºæ™¯ æ•°æ®ç±»å‹ é•¿æ–‡æœ¬ï¼ˆæ–‡ç« ã€å†…å®¹ï¼‰ text å­—ç¬¦ä¸²ï¼ˆæ— å›ºå®šé•¿åº¦ï¼‰ text email / username citext æ‰‹æœºå·ã€èº«ä»½è¯ã€ä»£ç  varchar(n) å›ºå®šé•¿åº¦æ ‡è¯† char(n)ï¼ˆæå°‘ç”¨ï¼‰ JSON æ•°æ® jsonb ğŸ”¥ ç®€ï¼‰ä½ é—®æˆ‘ç­”ï¼štitle å’Œ content ç”¨ä»€ä¹ˆç±»å‹ï¼Ÿ ä½ é—®è¿‡ç±»ä¼¼é—®é¢˜ï¼š\ntitle å’Œ content é•¿åº¦æœªçŸ¥ï¼Œä½†æ˜¯ title è¦æ¯” content å¾ˆå¤šï¼Œç”¨ä»€ä¹ˆç±»å‹ï¼Ÿ\næˆ‘çš„å»ºè®®ï¼š\ntitle -\u0026gt; varchar(255) æˆ– text content -\u0026gt; text ç†ç”±ï¼š\nPostgres ä¸­ varchar å’Œ text ä¸€æ ·å¿« content æ˜¯é•¿æ–‡æœ¬ï¼Œç»å¯¹ç”¨ text ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ PostgreSQL å­—ç¬¦ç±»å‹ï¼ˆCharacter Typesï¼‰æœ€å®Œæ•´ã€æœ€æ¸…æ™°ã€æœ€å®ç”¨çš„æ€»ç»“ï¼ŒåŒ…å«ï¼š\nPostgreSQL å­—ç¬¦ç±»å‹æœ‰å“ªäº› é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ æ€§èƒ½ä¸å­˜å‚¨å¯¹æ¯” æœ€ä½³å®è·µæ€»ç»“ï¼ˆé‡ç‚¹ï¼‰ å†…å®¹ç®€æ˜ä½†ä¸“ä¸šï¼Œé€‚åˆå®é™…åç«¯å¼€å‘ä½¿ç”¨ï¼ˆFastAPI + PostgreSQLï¼‰ã€‚\nâœ… PostgreSQL å­—ç¬¦ç±»å‹æ€»è§ˆ PostgreSQL æä¾›ä¸»è¦ 5 ç±»å­—ç¬¦ç›¸å…³ç±»å‹ï¼š\nç±»å‹ æè¿° char(n) å›ºå®šé•¿åº¦å­—ç¬¦ä¸² varchar(n) å¯å˜é•¿åº¦ï¼Œæœ‰é•¿åº¦é™åˆ¶ varchar / text å¯å˜é•¿åº¦ï¼Œæ— é•¿åº¦é™åˆ¶ text è¶…å¤§æ–‡æœ¬ citext ä¸åŒºåˆ†å¤§å°å†™çš„ text/varcharï¼ˆæ‰©å±•ï¼‰ å¦å¤–è¿˜æœ‰ï¼š\nç±»å‹ æè¿° bytea äºŒè¿›åˆ¶æ•°æ® json / jsonb JSON æ–‡æœ¬ç±»å‹ ä¸‹é¢æˆ‘ä»¬é€ä¸ªè®²è§£ã€‚\n1. char(n) â€”â€” å›ºå®šé•¿åº¦å­—ç¬¦ä¸² âœ… åœºæ™¯\n"},{"id":378,"href":"/database/postgres/performance/","title":"PostgreSQL æ€§èƒ½ä¼˜åŒ–","parent":"PostgreSQL","content":"åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\nç³»ç»Ÿå±‚ä¼˜åŒ–ï¼ˆOS å±‚ï¼‰ æ•°æ®åº“é…ç½®ä¼˜åŒ–ï¼ˆpostgresql.confï¼‰ è¡¨ç»“æ„è®¾è®¡ä¼˜åŒ– ç´¢å¼•ä¼˜åŒ– SQL / æŸ¥è¯¢ä¼˜åŒ– Vacuum / è†¨èƒ€ï¼ˆè¡¨è†¨èƒ€ï¼‰ä¼˜åŒ– WAL / checkpoint ä¼˜åŒ– è¿æ¥æ± ä¼˜åŒ– ç¼“å­˜ä¸å†…å­˜ä¼˜åŒ– ç›‘æ§æŒ‡æ ‡ä¸å®šä½æ€§èƒ½ç“¶é¢ˆ 1. ğŸ–¥ï¸ ç³»ç»Ÿå±‚ä¼˜åŒ–ï¼ˆOS å±‚ï¼‰ 1.1 æ–‡ä»¶ç³»ç»Ÿæ¨è æ–‡ä»¶ç³»ç»Ÿ æ¨èç†ç”± XFSï¼ˆç¬¬ä¸€æ¨èï¼‰ å¤§æ–‡ä»¶å†™å…¥å¿«ã€å»¶è¿Ÿç¨³å®šã€å¹¶å‘å¥½ EXT4 æ¬¡ä¼˜é€‰æ‹©ï¼Œè¾ƒç¨³å®š 1.2 IO è°ƒåº¦ NVMeï¼š\necho none \u0026gt; /sys/block/nvme0n1/queue/scheduler SAS/SATAï¼š\necho deadline \u0026gt; /sys/block/sda/queue/scheduler 1.3 Linux å†…æ ¸å‚æ•° /etc/sysctl.confï¼š\nvm.swappiness = 1 vm.dirty_ratio = 20 vm.dirty_background_ratio = 5 kernel.sched_migration_cost_ns = 5000000 vm.overcommit_memory = 2 é¿å…å†…å­˜è¢« swapï¼Œä¿è¯ç¨³å®šå»¶è¿Ÿã€‚\n2. âš™ï¸ PostgreSQL é…ç½®ä¼˜åŒ–ï¼ˆæœ€å…³é”®ï¼‰ ä»¥ä¸‹é…ç½®å‡ä¸º ç”Ÿäº§å¯ç”¨ çš„æœ€ä½³å®è·µã€‚\n2.1 å†…å­˜ç›¸å…³ shared_buffers = 25% RAM work_mem = 32MB maintenance_work_mem = 1GB effective_cache_size = 70% RAM æ³¨æ„ï¼šwork_mem æ˜¯ per sort per queryï¼ˆæå®¹æ˜“ OOMï¼‰ï¼Œä¸è¦è¶…è¿‡ 64MBï¼Œå°¤å…¶æ˜¯é«˜å¹¶å‘ç³»ç»Ÿã€‚\n2.2 WAL ç›¸å…³ï¼ˆå†™å…¥æ€§èƒ½æ ¸å¿ƒï¼‰ wal_level = replica wal_compression = on max_wal_size = 8GB checkpoint_timeout = 15min checkpoint_completion_target = 0.9 å‡å°‘ checkpoint å¡é¡¿ã€‚\n2.3 å¹¶è¡ŒæŸ¥è¯¢ max_parallel_workers = 8 max_parallel_workers_per_gather = 4 parallel_leader_participation = on PostgreSQL å¹¶è¡Œè®¡åˆ’éå¸¸æ™ºèƒ½ï¼Œè¿™éƒ¨åˆ†æ”¶ç›Šå·¨å¤§ï¼ˆç‰¹åˆ«æ˜¯ OLAPï¼‰ã€‚\n2.4 è¿æ¥æ•° max_connections = 200 æ°¸è¿œä¸è¦å¤ªé«˜ï¼Œå¦åˆ™ä¸Šä¸‹æ–‡åˆ‡æ¢çˆ†ç‚¸ã€‚\nä½¿ç”¨ PgBouncer è¿æ¥æ± ï¼ˆå¼ºçƒˆæ¨èï¼‰ã€‚\n3. ğŸ—ï¸ è¡¨ç»“æ„è®¾è®¡ä¼˜åŒ– 3.1 é¿å…éšæœº I/O çš„ UUID ä¸»é”®ï¼ˆå·¨å¤§æ€§èƒ½å‘ï¼‰ å¦‚æœä½ ç”¨ï¼š\nuuid_generate_v4() ä¼šå¯¼è‡´ æ’å…¥å®Œå…¨éšæœº -\u0026gt; B-tree å¤§é‡ page split -\u0026gt; é¡µè†¨èƒ€ -\u0026gt; æ€§èƒ½ä¸‹é™ 10~50 å€ã€‚\nä¼˜åŒ–æ–¹å¼ï¼š\nä½¿ç”¨ ULIDï¼ˆå•è°ƒï¼‰ æˆ–ä½¿ç”¨ UUID v7ï¼ˆPostgreSQL 17+ å†…ç½®ï¼‰ æˆ–å¤§å¤šæ•°åœºæ™¯ç›´æ¥ä¸Š bigserial 3.2 å­—æ®µç±»å‹ä¼˜åŒ– åœºæ™¯ ç±»å‹ æ–‡æœ¬æœç´¢ textï¼ˆä¸è¦ varchar(n)ï¼‰ çŠ¶æ€å­—æ®µ smallint é‡‘é¢ numeric(18,2)ï¼ˆé“¶è¡Œï¼‰ or bigintï¼ˆåˆ†å•ä½ï¼‰ æ—¶é—´ timestamp with time zoneï¼ˆå¼ºçƒˆæ¨èï¼‰ varchar(n) çš„é•¿åº¦é™åˆ¶æ— æ„ä¹‰ï¼ŒPostgreSQL ä¸èŠ‚çœç©ºé—´ï¼Œè¿˜å¢åŠ æ ¡éªŒå¼€é”€ã€‚\n4. ğŸ” ç´¢å¼•ä¼˜åŒ–ï¼ˆæ€§èƒ½æœ€å…³é”®ï¼‰ 4.1 ç´¢å¼•åˆ›å»ºåŸºæœ¬åŸåˆ™ ç´¢å¼•ä¸è¦å¤ªå¤šï¼ˆå†™æ”¾å¤§ï¼‰\næ¯å¢åŠ  1 ä¸ªç´¢å¼•ï¼š\nINSERT å¤šå†™ 1 æ¬¡ UPDATE å¤šå†™ 1 æ¬¡ DELETE å¤šå†™ 1 æ¬¡ å¸¸è§é”™è¯¯\nåˆ›å»ºï¼š\nindex (col1, col2) index (col1) ç¬¬äºŒä¸ªæ°¸è¿œç”¨ä¸åˆ°ã€‚\n4.2 ç´¢å¼•é€‰å‹ ç±»å‹ åœºæ™¯ B-tree å¤§éƒ¨åˆ†æŸ¥è¯¢ GIN JSONBã€å…¨æ–‡æ£€ç´¢ GiST åœ°ç†ã€èŒƒå›´ BRIN æ—¶é—´åºåˆ—ã€æ—¥å¿—ã€Append-only è¡¨ï¼ˆæ€§èƒ½æé«˜ï¼‰ 4.3 å¸¸ç”¨ç´¢å¼• SQL å•åˆ—ç´¢å¼• CREATE INDEX idx_user_email ON users(email); å¤åˆç´¢å¼• é¡ºåºå¾ˆé‡è¦ï¼Œè¿‡æ»¤æ€§æœ€é«˜çš„æ”¾å‰é¢ã€‚\nJSONB ç´¢å¼• CREATE INDEX idx_jsonb_gin ON table USING gin (payload jsonb_path_ops); æ¨¡ç³ŠåŒ¹é… indexï¼ˆå¿…é¡»ç”¨ pg_trgmï¼‰ CREATE EXTENSION pg_trgm; CREATE INDEX idx_title_trgm ON article USING gin (title gin_trgm_ops); 5. ğŸ“Œ SQL / æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰ 5.1 æŸ¥çœ‹ SQL å®é™…æ‰§è¡Œè®¡åˆ’ï¼ˆå¿…é¡»å­¦ï¼‰ EXPLAIN (ANALYZE, BUFFERS) SELECT ... çœ‹åˆ°ï¼š\nseq scanï¼Ÿ index scanï¼Ÿ hash joinï¼Ÿ sort in memory or diskï¼Ÿ å¹¶è¡Œè®¡åˆ’ï¼Ÿ 5.2 å¸¸è§ SQL ä¼˜åŒ–æŠ€å·§ 5.2.1 é¿å… SELECT * å¢åŠ  I/O å¤±å»è¦†ç›–ç´¢å¼•å¯èƒ½æ€§ 5.2.2 é¿å… WHERE ä¸Šçš„å‡½æ•° åä¾‹å­ï¼š\nWHERE date(created_at) = CURRENT_DATE å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚\næ­£ç¡®å†™æ³•ï¼š\nWHERE created_at \u0026gt;= CURRENT_DATE AND created_at \u0026lt; CURRENT_DATE + INTERVAL \u0026#39;1 day\u0026#39; 5.2.3 ç”¨ EXISTS æ›¿ä»£ INï¼ˆå¤§é‡æ•°æ®æ—¶ï¼‰ SELECT * FROM a WHERE EXISTS (SELECT 1 FROM b WHERE b.id = a.id); 5.2.4 æ‰¹é‡ INSERT ç”¨ COPY é€Ÿåº¦æå‡ Ã—50 COPY table FROM \u0026#39;/path/file.csv\u0026#39; CSV; 6. ğŸ§¹ Vacuum / è¡¨è†¨èƒ€ä¼˜åŒ–ï¼ˆPostgreSQL ç‰¹æœ‰ï¼‰ 6.1 ä¸ºä»€ä¹ˆè†¨èƒ€ï¼Ÿ MVCC çš„æ—§ç‰ˆæœ¬æ— æ³•ç«‹å³åˆ é™¤ æ›´æ–°/åˆ é™¤é¢‘ç¹è¡¨ä¼šå˜å·¨æ…¢ SELECT è¯»å†™éƒ½å—å½±å“ 6.2 æ£€æŸ¥è†¨èƒ€ SELECT * FROM pgstattuple(\u0026#39;table\u0026#39;); 6.3 å¼ºåˆ¶ Vacuum VACUUM FULL table; -- ä¼šé”è¡¨ æ›´å®‰å…¨ï¼š\nVACUUM (VERBOSE, ANALYZE); 6.4 Autovacuum è°ƒä¼˜ï¼ˆéå¸¸å…³é”®ï¼‰ autovacuum_vacuum_scale_factor = 0.1 autovacuum_analyze_scale_factor = 0.05 autovacuum_max_workers = 4 autovacuum_naptime = 10s é€‚ç”¨äºé«˜æ›´æ–°é‡ç³»ç»Ÿã€‚\n7. ğŸ§± WAL / checkpoint ä¼˜åŒ–ï¼ˆå†™æ€§èƒ½å…³é”®ï¼‰ æ¨èé…ç½®\ncheckpoint_timeout = 15min max_wal_size = 8GB checkpoint_completion_target = 0.9 wal_compression = on å‡å°‘ â€œcheckpoint spikeâ€ å¡é¡¿ã€‚\n8. ğŸ§µ è¿æ¥æ± ä¼˜åŒ–ï¼ˆæé‡è¦ï¼‰ PostgreSQL çš„è¿æ¥æ˜¯é‡èµ„æºç»“æ„ï¼Œä¸èƒ½æ— é™å¼€æ–°è¿æ¥ã€‚\nå»ºè®®ï¼š\nåœºæ™¯ æ¨èæ–¹æ¡ˆ Web æœåŠ¡ PgBouncerï¼ˆtransaction poolingï¼‰ å¤§å¹¶å‘è¯»å†™ PgBouncer + Patroni åç«¯æ‰¹å¤„ç† ä½¿ç”¨ Python asyncpg æˆ– pgbouncer pooling 9. â˜˜ï¸ ç¼“å­˜ä¸å†…å­˜ä¼˜åŒ– 9.1 æ“ä½œç³»ç»Ÿç¼“å­˜æ¯” PostgreSQL ç¼“å­˜æ›´å¤§ PostgreSQL å°†ç£ç›˜è¯»å†™äº¤ç»™ OS çš„æ–‡ä»¶ç¼“å­˜ï¼Œå› æ­¤ effective_cache_size å¾ˆé‡è¦ã€‚\neffective_cache_size = 70% RAM å‘Šè¯‰ä¼˜åŒ–å™¨ï¼š\nOS æœ‰å¤šå°‘ cache å¯ä»¥åˆ©ç”¨\n10. ğŸ“ˆ æ€§èƒ½ç“¶é¢ˆå®šä½æµç¨‹ï¼ˆç›‘æ§ + è°ƒè¯•ï¼‰ 10.1 ç›‘æ§æ ¸å¿ƒæŒ‡æ ‡ ç±»åˆ« æŒ‡æ ‡ æ„ä¹‰ è¿æ¥ activeã€idleã€idle in transaction æ˜¯å¦è¿æ¥æ³„æ¼ é” lock waitã€deadlock æ˜¯å¦é˜»å¡ I/O read/write latency æ…¢æŸ¥è¯¢åŸå›  WAL write rate å†™ç“¶é¢ˆ Autovacuum freeze age è†¨èƒ€é£é™© ç¼“å­˜ hit ratio \u0026lt; 98% éœ€ä¼˜åŒ– 10.2 æŸ¥é˜»å¡é” SELECT * FROM pg_locks; SELECT * FROM pg_stat_activity WHERE wait_event IS NOT NULL; 10.3 æŸ¥æ…¢ SQL å¯ç”¨ï¼š\nlog_min_duration_statement = 500ms log_lock_waits = on æ…¢ SQL è‡ªåŠ¨è¿›å…¥æ—¥å¿—ã€‚\nğŸ¯ æ€»ç»“ï¼šPostgreSQL æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™ åˆ†å±‚ ä¼˜åŒ–ç‚¹ OS å±‚ swap=1ã€XFSã€NVMeã€IO è°ƒåº¦ PostgreSQL å±‚ shared_buffersã€work_memã€WAL å‚æ•° è¡¨ç»“æ„ PK è¿ç»­ã€æ­£ç¡®å­—æ®µç±»å‹ ç´¢å¼• åˆç†é€‰æ‹©ã€é¿å…è¿‡åº¦ç´¢å¼• SQL é¿å…å‡½æ•°ã€é¿å… SELECT *ã€EXPLAIN ä¼˜åŒ– Vacuum é¢„é˜²è†¨èƒ€ è¿æ¥æ±  PgBouncer å¿…é¡»ç”¨ é«˜å¯ç”¨ Patroni / æµå¤åˆ¶ ç›‘æ§ é”ã€IOã€WALã€ç¼“å­˜å‘½ä¸­ç‡ ","description":"åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\nç³»ç»Ÿå±‚ä¼˜åŒ–ï¼ˆOS å±‚ï¼‰ æ•°æ®åº“é…ç½®ä¼˜åŒ–ï¼ˆpostgresql.confï¼‰ è¡¨ç»“æ„è®¾è®¡ä¼˜åŒ– ç´¢å¼•ä¼˜åŒ– SQL / æŸ¥è¯¢ä¼˜åŒ– Vacuum / è†¨èƒ€ï¼ˆè¡¨è†¨èƒ€ï¼‰ä¼˜åŒ– WAL / checkpoint ä¼˜åŒ– è¿æ¥æ± ä¼˜åŒ– ç¼“å­˜ä¸å†…å­˜ä¼˜åŒ– ç›‘æ§æŒ‡æ ‡ä¸å®šä½æ€§èƒ½ç“¶é¢ˆ 1. ğŸ–¥ï¸ ç³»ç»Ÿå±‚ä¼˜åŒ–ï¼ˆOS å±‚ï¼‰ 1.1 æ–‡ä»¶ç³»ç»Ÿæ¨è æ–‡ä»¶ç³»ç»Ÿ æ¨èç†ç”± XFSï¼ˆç¬¬ä¸€æ¨èï¼‰ å¤§æ–‡ä»¶å†™å…¥å¿«ã€å»¶è¿Ÿç¨³å®šã€å¹¶å‘å¥½ EXT4 æ¬¡ä¼˜é€‰æ‹©ï¼Œè¾ƒç¨³å®š 1.2 IO è°ƒåº¦ NVMeï¼š\n"},{"id":379,"href":"/database/postgres/troubleshooting/","title":"PostgreSQL æ•…éšœæ’æŸ¥","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨ã€ä½“ç³»åŒ–çš„ PostgreSQL æ•…éšœæ’æŸ¥æŒ‡å—ã€‚\nè¦†ç›– è¿æ¥é—®é¢˜ã€æ€§èƒ½é—®é¢˜ã€é”ç­‰å¾…ã€æ­»é”ã€WALã€ç£ç›˜ã€å†…å­˜ã€å¤åˆ¶ã€è¡¨è†¨èƒ€ã€æ•°æ®æŸåã€é…ç½®é—®é¢˜ ç­‰å…¨éƒ¨å¸¸è§æ•…éšœã€‚\nåˆ†ä¸ºä¸‹é¢ 10 å¤§ç±»æ•…éšœï¼š\næ•°æ®åº“æ— æ³•è¿æ¥ CPUã€å†…å­˜ã€ç£ç›˜æš´æ¶¨ æŸ¥è¯¢çªç„¶å˜æ…¢ é”ç­‰å¾… / æ­»é”é—®é¢˜ Autovacuum / è¡¨è†¨èƒ€é—®é¢˜ WAL / checkpoint å†™å…¥å˜æ…¢æˆ–å¡æ­» ç£ç›˜ç©ºé—´ä¸è¶³ / WAL å †ç§¯ å¤åˆ¶é›†ç¾¤é—®é¢˜ï¼ˆä¸»ä»å»¶è¿Ÿã€å¤åˆ¶ä¸­æ–­ï¼‰ é…ç½®é”™è¯¯å¯¼è‡´å¯åŠ¨å¤±è´¥ æ•°æ®æŸå / ç´¢å¼•æŸå æ¯ä¸€ç±»éƒ½åŒ…å«ï¼š\nç—‡çŠ¶ æ’æŸ¥æ­¥éª¤ è§£å†³æ–¹æ¡ˆ 1. æ•°æ®åº“æ— æ³•è¿æ¥ å¸¸è§è¡¨ç°\npsql / åº”ç”¨è¿æ¥å¤±è´¥ â€œconnection refusedâ€ â€œtoo many connectionsâ€ â€œcould not connect to serverâ€ æ’æŸ¥æ­¥éª¤\n1. PostgreSQL æ˜¯å¦åœ¨è¿è¡Œï¼Ÿ pg_ctl status systemctl status postgresql 2. ç«¯å£æ˜¯å¦ç›‘å¬ï¼Ÿ ss -lnt | grep 5432 3. æœ€å¤§è¿æ¥æ•°æ˜¯å¦è€—å°½ï¼Ÿ SELECT count(*) FROM pg_stat_activity; SHOW max_connections; 4. æ˜¯å¦è¢«é˜²ç«å¢™é˜»æ‹¦ï¼Ÿ ufw status iptables -L 2. CPU / å†…å­˜ / I/O æš´æ¶¨ å®šä½æœ€è€—èµ„æºçš„ SQL\nSELECT pid, usename, state, query_start, query FROM pg_stat_activity ORDER BY query_start ASC; æŸ¥çœ‹ CPU ç­‰å¾… IOï¼ˆIO wait é«˜åˆ™æŸ¥è¯¢å˜æ…¢ï¼‰\niostat -x 1 æŸ¥ PostgreSQL è‡ªå·±çš„ç»Ÿè®¡\nSELECT * FROM pg_stat_bgwriter; è§£å†³æ–¹æ¡ˆ\nåŠ ç´¢å¼• è°ƒå‚ï¼ˆwork_mem / shared_buffers / effective_cache_sizeï¼‰ ä¼˜åŒ– SQL ä½¿ç”¨ PgBouncer é™åˆ¶è¿æ¥ 3. æŸ¥è¯¢çªç„¶å˜æ…¢ï¼ˆæœ€å¸¸è§é—®é¢˜ï¼‰ æ’æŸ¥é¡ºåºï¼ˆå¿…é¡»è®°ä½ï¼‰ï¼š\n1. æ˜¯å¦èµ°é”™ç´¢å¼• / æ²¡èµ°ç´¢å¼•ï¼Ÿ EXPLAIN (ANALYZE, BUFFERS) SELECT ... 2. Autovacuum æ˜¯å¦è½å -\u0026gt; è¡¨è†¨èƒ€ï¼Ÿ SELECT relname, n_dead_tup FROM pg_stat_user_tables ORDER BY n_dead_tup DESC; 3. checkpoint æ˜¯å¦å¤ªé¢‘ç¹ï¼Ÿ SELECT * FROM pg_stat_bgwriter; 4. æ˜¯å¦è§¦å‘äº†é•¿äº‹åŠ¡ï¼Œå¯¼è‡´ autovacuum ä¸èƒ½æ¸…ç†ï¼Ÿ SELECT * FROM pg_stat_activity WHERE xact_start \u0026lt; now() - interval \u0026#39;5 minutes\u0026#39;; 5. æ˜¯å¦æœ‰é”ç­‰å¾…ï¼Ÿ SELECT * FROM pg_locks; 4. é”ç­‰å¾… / æ­»é” æŸ¥é˜»å¡é“¾\n1. è°é˜»å¡äº†è°ï¼Ÿ SELECT blocked.pid AS blocked_pid, blocked.query AS blocked_query, blocking.pid AS blocking_pid, blocking.query AS blocking_query FROM pg_stat_activity blocked JOIN pg_locks blocked_l ON blocked.pid = blocked_l.pid JOIN pg_locks blocking_l ON blocking_l.locktype = blocked_l.locktype AND blocking_l.DATABASE = blocked_l.DATABASE AND blocking_l.relation = blocked_l.relation JOIN pg_stat_activity blocking ON blocking.pid = blocking_l.pid WHERE NOT blocked_l.granted; 2. å¼ºåˆ¶æ€æ‰é˜»å¡è¿›ç¨‹ SELECT pg_terminate_backend(\u0026lt;pid\u0026gt;); æ­»é”æ—¥å¿—æ’æŸ¥ å¼€å¯ï¼š\nlog_lock_waits = on log_min_duration_statement = 500ms 5. Autovacuum / Table bloat è¡¨è†¨èƒ€ è¡¨è†¨èƒ€æ£€æŸ¥ï¼ˆpgstattupleï¼‰\nSELECT * FROM pgstattuple(\u0026#39;your_table\u0026#39;); Autovacuum æ˜¯å¦è½å\nSELECT relname, last_vacuum, last_autovacuum FROM pg_stat_user_tables; è‡ªåŠ¨æ¸…ç†ä¸å·¥ä½œå¸¸è§åŸå› \nè¡¨å¤ªå¤§ -\u0026gt; autovacuum è·‘ä¸å®Œ é•¿äº‹åŠ¡é˜»å¡ autovacuum autovacuum å‚æ•°å¤ªä¿å®ˆï¼ˆé»˜è®¤ä¸é€‚åˆç”Ÿäº§ï¼‰ æ¨èå‚æ•°\nautovacuum_vacuum_scale_factor = 0.1 autovacuum_analyze_scale_factor = 0.05 6. WAL / checkpoint å¡é¡¿ï¼ˆå†™å…¥å˜æ…¢ï¼‰ symptom\nå†™å…¥çªç„¶å¡æ­» WAL ç›®å½•æš´æ¶¨ æŸ¥çœ‹ checkpoint æ¬¡æ•°\nSELECT checkpoints_timed, checkpoints_req FROM pg_stat_bgwriter; æŸ¥çœ‹ WAL å¤§å°\ndu -sh $PGDATA/pg_wal å»ºè®®é…ç½®\ncheckpoint_timeout = 15min max_wal_size = 8GB checkpoint_completion_target = 0.9 wal_compression = on 7. ç£ç›˜ç©ºé—´ä¸è¶³ / WAL å †ç§¯ï¼ˆéå¸¸å¸¸è§ï¼‰ æŸ¥çœ‹æ•°æ®ç›®å½•å¤§å°\ndu -sh $PGDATA æŸ¥çœ‹æœ€å¤§çš„è¡¨\nSELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_catalog.pg_statio_user_tables ORDER BY pg_total_relation_size(relid) DESC; WAL å †ç§¯å¸¸è§åŸå› \næµå¤åˆ¶æ–­å¼€ -\u0026gt; WAL æ— æ³•æ¸…é™¤ archive_command å¤±è´¥ checkpoint å¤ªæ…¢ è§£å†³ï¼š\nä¿®å¤å¤åˆ¶ ç¡®ä¿ archive_command è¿”å› 0 å¢åŠ  max_wal_size 8. æµå¤åˆ¶æ•…éšœ æŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ\nSELECT * FROM pg_stat_replication; å­—æ®µï¼š\nwrite_lag flush_lag replay_lag å¸¸è§å¤åˆ¶é—®é¢˜\né”™è¯¯ åŸå›  â€œrequested WAL segment has been removedâ€ ä¸»åº“æ¸…ç† WAL å‰ä»åº“æ²¡è¯»åˆ° â€œreplication terminated by primary serverâ€ ç½‘ç»œæ–­ â€œFATAL: could not receive data from WAL streamâ€ ç½‘ç»œæŠ–åŠ¨ è§£å†³æ–¹æ¡ˆ\nå¢å¤§ wal_keep_size å¢å¤§å¤‡åº“ç¡¬ä»¶æ€§èƒ½ ä½¿ç”¨ pg_basebackup é‡å»ºä»åº“ 9. PostgreSQL å¯åŠ¨å¤±è´¥ æ‰§è¡Œï¼š\njournalctl -u postgresql å¸¸è§åŸå› ï¼š\né”™è¯¯ åŸå›  è§£å†³ FATAL: lock file already exists ä¸Šæ¬¡å¼‚å¸¸é€€å‡º åˆ é™¤ postmaster.pid FATAL: could not create shared memory å‚æ•°è¿‡å¤§ è°ƒæ•´ shared_buffers fatal: corrupt xlog WAL æŸå pg_resetwalï¼ˆå±é™©ï¼‰ 10. æ•°æ®æŸå / ç´¢å¼•æŸå æ£€æŸ¥ç´¢å¼•æ˜¯å¦æŸå\nREINDEX TABLE table; æ£€æŸ¥æ‰€æœ‰ç´¢å¼•\nREINDEX DATABASE dbname; è¡¨æŸåæ£€æŸ¥\nSELECT * FROM pg_catalog.pg_stats WHERE null_frac \u0026gt; 0.9; æœ€åæ‰‹æ®µ\npg_dump -\u0026gt; dropdb -\u0026gt; restore ğŸ¯ æ•…éšœæ’æŸ¥é»„é‡‘æ³•åˆ™ï¼ˆæ€»ç»“ï¼‰ å¤§éƒ¨åˆ† PostgreSQL æ•…éšœéƒ½æ¥è‡ªï¼š\né•¿äº‹åŠ¡ é”ç­‰å¾… autovacuum ä¸å¤Ÿ è¡¨è†¨èƒ€ checkpoint è¿‡äºé¢‘ç¹ è¿æ¥æ•°è¿‡é«˜ ç´¢å¼•ç¼ºå¤±æˆ–æŸå æ—¥å¸¸æ’æŸ¥é¡ºåºï¼š\n1. å½“å‰æ­£åœ¨æ‰§è¡Œçš„ SQL SELECT * FROM pg_stat_activity; 2. æ˜¯å¦é”ç­‰å¾… SELECT * FROM pg_locks; 3. æ˜¯å¦ CPU / I/O æ¦¨å¹² top / iostat / vmstat\n4. æ˜¯å¦æ…¢æŸ¥è¯¢ æŸ¥çœ‹æ—¥å¿—\n5. autovacuum æ˜¯å¦è½å pg_stat_user_tables 6. checkpoint æ˜¯å¦é¢‘ç¹ pg_stat_bgwriter 7. WAL æ˜¯å¦å †ç§¯ du -sh pg_wal/ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨ã€ä½“ç³»åŒ–çš„ PostgreSQL æ•…éšœæ’æŸ¥æŒ‡å—ã€‚\nè¦†ç›– è¿æ¥é—®é¢˜ã€æ€§èƒ½é—®é¢˜ã€é”ç­‰å¾…ã€æ­»é”ã€WALã€ç£ç›˜ã€å†…å­˜ã€å¤åˆ¶ã€è¡¨è†¨èƒ€ã€æ•°æ®æŸåã€é…ç½®é—®é¢˜ ç­‰å…¨éƒ¨å¸¸è§æ•…éšœã€‚\nåˆ†ä¸ºä¸‹é¢ 10 å¤§ç±»æ•…éšœï¼š\næ•°æ®åº“æ— æ³•è¿æ¥ CPUã€å†…å­˜ã€ç£ç›˜æš´æ¶¨ æŸ¥è¯¢çªç„¶å˜æ…¢ é”ç­‰å¾… / æ­»é”é—®é¢˜ Autovacuum / è¡¨è†¨èƒ€é—®é¢˜ WAL / checkpoint å†™å…¥å˜æ…¢æˆ–å¡æ­» ç£ç›˜ç©ºé—´ä¸è¶³ / WAL å †ç§¯ å¤åˆ¶é›†ç¾¤é—®é¢˜ï¼ˆä¸»ä»å»¶è¿Ÿã€å¤åˆ¶ä¸­æ–­ï¼‰ é…ç½®é”™è¯¯å¯¼è‡´å¯åŠ¨å¤±è´¥ æ•°æ®æŸå / ç´¢å¼•æŸå æ¯ä¸€ç±»éƒ½åŒ…å«ï¼š\nç—‡çŠ¶ æ’æŸ¥æ­¥éª¤ è§£å†³æ–¹æ¡ˆ 1. æ•°æ®åº“æ— æ³•è¿æ¥ å¸¸è§è¡¨ç°\npsql / åº”ç”¨è¿æ¥å¤±è´¥ â€œconnection refusedâ€ â€œtoo many connectionsâ€ â€œcould not connect to serverâ€ æ’æŸ¥æ­¥éª¤\n"},{"id":380,"href":"/database/postgres/troubleshooting-pgbackrest/","title":"PostgreSQL æ•…éšœæ’æŸ¥ -- pgbackrest","parent":"PostgreSQL","content":"/etc/pgbackrest.conf\n[global] repo1-path=/var/lib/pgbackrest [main] pg1-path=/var/lib/postgresql postgresql.conf:\narchive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; æŠ¥é”™ä¿¡æ¯ï¼š\nDec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.386 P00 ERROR: [103]: unable to find a valid repository: Dec 27 17:15:37 x podman[1707]: repo1: [FileMissingError] unable to load info file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info\u0026#39; or \u0026#39;/var/lib/pgbackrest/archive/main/archive.info.copy\u0026#39;: Dec 27 17:15:37 x podman[1707]: FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info\u0026#39; for read Dec 27 17:15:37 x podman[1707]: FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info.copy\u0026#39; for read Dec 27 17:15:37 x podman[1707]: HINT: archive.info cannot be opened but is required to push/get WAL segments. Dec 27 17:15:37 x podman[1707]: HINT: is archive_command configured correctly in postgresql.conf? Dec 27 17:15:37 x podman[1707]: HINT: has a stanza-create been performed? Dec 27 17:15:37 x podman[1707]: HINT: use --no-archive-check to disable archive checks during backup if you have an alternate archiving scheme. Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] LOG: archive command failed with exit code 103 Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] DETAIL: The failed archive command was: pgbackrest --stanza=main archive-push pg_wal/000000010000000000000001 Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] WARNING: archiving write-ahead log file \u0026#34;000000010000000000000001\u0026#34; failed too many times, will try again later Dec 27 17:15:37 x postgres[1787]: 2025-12-27 09:15:37.387 PRC [29] DETAIL: The failed archive command was: pgbackrest --stanza=main archive-push pg_wal/000000010000000000000001 Dec 27 17:15:37 x postgres[1787]: 2025-12-27 09:15:37.387 PRC [29] WARNING: archiving write-ahead log file \u0026#34;000000010000000000000001\u0026#34; failed too many times, will try again later å¿«é€Ÿè§£å†³æ–¹æ³•ï¼š\npodman exec -it postgres bash chown -R postgres:root /var/lib/pgbackrest /var/lib/postgresql su - postgres -c \u0026#39;pgbackrest --stanza=main stanza-create\u0026#39; su - postgres -c \u0026#39;pgbackrest --stanza=main check\u0026#39; è¿™ä¸ªæŠ¥é”™ä¿¡æ¯å…¶å®éå¸¸å…¸å‹ï¼Œè€Œä¸” pgBackRest çš„æç¤ºå·²ç»æŠŠâ€œæ­£ç¡®ç­”æ¡ˆâ€å†™å‡ºæ¥äº†ã€‚æŒ‰ç”Ÿäº§çº§æ’é”™æµç¨‹æ¥ä¸€æ­¥æ­¥è§£é‡Šå’Œä¿®å¤ã€‚\nä¸€ã€é”™è¯¯æœ¬è´¨ï¼ˆä¸€å¥è¯ç»“è®ºï¼‰ ä½ é…ç½®äº† archive_commandï¼Œä½†ä»æœªå¯¹ stanza main æ‰§è¡Œè¿‡ stanza-createï¼Œ å¯¼è‡´ archive.info ä¸å­˜åœ¨ï¼ŒWAL æ— æ³•å½’æ¡£ã€‚\næ‰€ä»¥ pgBackRest æ²¡æœ‰ä¸€ä¸ªâ€œåˆæ³•çš„ä»“åº“ï¼ˆrepositoryï¼‰â€å¯ä»¥æ¥æ”¶ WALã€‚\näºŒã€é”™è¯¯é€è¡Œæ‹†è§£ï¼ˆç†è§£åŸç†ï¼‰ 1ï¸âƒ£ å…³é”®æŠ¥é”™ ERROR: [103]: unable to find a valid repository ğŸ‘‰ pgBackRest æ²¡æœ‰æ‰¾åˆ°å¯ç”¨ repo\n2ï¸âƒ£ æ ¸å¿ƒåŸå›  unable to load info file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info\u0026#39; pgBackRest å¿…é¡»å­˜åœ¨ä»¥ä¸‹æ–‡ä»¶ä¹‹ä¸€ æ‰èƒ½å½’æ¡£ WALï¼š\nrepo1-path/archive/\u0026lt;stanza\u0026gt;/archive.info repo1-path/archive/\u0026lt;stanza\u0026gt;/archive.info.copy è€Œä½ çš„è·¯å¾„æ˜¯ï¼š\n/var/lib/pgbackrest/archive/main/ ğŸ‘‰ ç›®å½• / æ–‡ä»¶æ ¹æœ¬è¿˜æ²¡åˆ›å»º\n3ï¸âƒ£ PostgreSQL ä¾§ååº”ï¼ˆæ­£å¸¸ï¼‰ archive command failed with exit code 103 archiving write-ahead log file failed too many times PostgreSQL åªæ˜¯å¦‚å®æ±‡æŠ¥ï¼š\næˆ‘æ‰§è¡Œ archive_command äº†ï¼Œä½†å‘½ä»¤å¤±è´¥äº†\nä¸‰ã€ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼ˆå·¥ä½œæœºåˆ¶ï¼‰ pgBackRest çš„æ­£ç¡®åˆå§‹åŒ–é¡ºåº 1ï¸âƒ£ é…ç½® pgbackrest.conf 2ï¸âƒ£ stanza-create â† ä½ æ¼äº†è¿™ä¸€æ­¥ 3ï¸âƒ£ é…ç½® archive_command 4ï¸âƒ£ å¯åŠ¨ PostgreSQL è€Œä½ ç°åœ¨æ˜¯ï¼š\n1ï¸âƒ£ é…ç½® pgbackrest.conf 2ï¸âƒ£ ç›´æ¥å¯ç”¨ archive_command âŒ å››ã€æ­£ç¡®ä¿®å¤æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰ âš ï¸ ä¸‹é¢å‘½ä»¤å¿…é¡»ç”¨ PostgreSQL è¿è¡Œç”¨æˆ·ï¼ˆé€šå¸¸æ˜¯ postgresï¼‰æ‰§è¡Œ\nâœ… Step 1ï¼šç¡®è®¤ç›®å½•æƒé™ ls -ld /var/lib/pgbackrest ls -ld /var/lib/postgresql ç¡®ä¿ï¼š\npgBackRest å’Œ PostgreSQL çœ‹åˆ°çš„æ˜¯åŒä¸€ä¸ªæ•°æ®ç›®å½• ç”¨æˆ·ä¸€è‡´ï¼ˆå®¹å™¨é‡Œé€šå¸¸æ˜¯ postgresï¼‰ âœ… Step 2ï¼šåˆ›å»º stanzaï¼ˆå…³é”®æ­¥éª¤ï¼‰ pgbackrest --stanza=main stanza-create æˆåŠŸåä½ åº”è¯¥çœ‹åˆ°ï¼š\nINFO: stanza-create for stanza \u0026#39;main\u0026#39; completed successfully âœ… Step 3ï¼šç¡®è®¤ archive.info å·²ç”Ÿæˆ ls /var/lib/pgbackrest/archive/main/ è‡³å°‘åº”æœ‰ï¼š\narchive.info archive.info.copy âœ… Step 4ï¼šæ£€æŸ¥ pgBackRest æ˜¯å¦èƒ½è¯†åˆ« PostgreSQL pgbackrest --stanza=main check æ­£å¸¸è¾“å‡ºç±»ä¼¼ï¼š\nINFO: check command end: completed successfully âœ… Step 5ï¼šé‡æ–°è§¦å‘ WAL å½’æ¡£ï¼ˆå¯é€‰ï¼‰ SELECT pg_switch_wal(); ç„¶åæŸ¥çœ‹æ—¥å¿—æ˜¯å¦è¿˜æœ‰ archive é”™è¯¯ã€‚\näº”ã€ä½ çš„é…ç½®æœ¬èº«æœ‰æ²¡æœ‰é—®é¢˜ï¼Ÿ /etc/pgbackrest.conf [global] repo1-path=/var/lib/pgbackrest [main] pg1-path=/var/lib/postgresql âœ” é…ç½®æ˜¯æ­£ç¡®çš„\npostgresql.conf archive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; âœ” å†™æ³•æ­£ç¡®\nğŸ“Œ å»ºè®®è¡¥å……ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰ï¼š\narchive_mode = on wal_level = replica å…­ã€Podman / å®¹å™¨ç¯å¢ƒçš„ç‰¹åˆ«æé†’ï¼ˆéå¸¸é‡è¦ï¼‰ ä½ æ˜¯åœ¨ podman å®¹å™¨ä¸­è¿è¡Œ PostgreSQLï¼Œè¯·é‡ç‚¹ç¡®è®¤ï¼š\n1ï¸âƒ£ repo1-path å’Œ pg1-path æ˜¯å¦éƒ½åœ¨å®¹å™¨å†… podman exec -it \u0026lt;pg_container\u0026gt; ls /var/lib/pgbackrest podman exec -it \u0026lt;pg_container\u0026gt; ls /var/lib/postgresql ğŸ‘‰ stanza-create å¿…é¡»åœ¨ PostgreSQL æ‰€åœ¨å®¹å™¨æ‰§è¡Œ\n2ï¸âƒ£ æ˜¯å¦ä½¿ç”¨ volume æŒ‚è½½ æ¨èç»“æ„ï¼ˆç¤ºä¾‹ï¼‰ï¼š\n-v /data/pgdata:/var/lib/postgresql -v /data/pgbackrest:/var/lib/pgbackrest å¦åˆ™ï¼š\nå®¹å™¨é‡å¯ = repo æ¶ˆå¤± WAL æ— æ³•æ¢å¤ ä¸ƒã€å¸¸è§è¯¯åŒºæ€»ç»“ï¼ˆä½ åˆšå¥½è¸©ä¸­äº†ï¼‰ è¯¯åŒº åæœ æœªæ‰§è¡Œ stanza-create archive.info ä¸å­˜åœ¨ archive_command å…ˆå¯ç”¨ PostgreSQL å¯åŠ¨å³æŠ¥é”™ repo ç›®å½•æœªæŒä¹…åŒ– å½’æ¡£çœ‹ä¼¼æˆåŠŸï¼Œå®é™…ä¸¢å¤± stanza åæ‹¼é”™ repo æ‰¾ä¸åˆ° å…«ã€æœ€ç»ˆä¸€å¥è¯æ€»ç»“ pgBackRest çš„ archive ä¸æ˜¯â€œå³æ’å³ç”¨â€ï¼Œstanza-create æ˜¯ WAL å½’æ¡£çš„â€œç”Ÿå‘½èµ·ç‚¹â€ã€‚\n","description":"/etc/pgbackrest.conf\n[global] repo1-path=/var/lib/pgbackrest [main] pg1-path=/var/lib/postgresql postgresql.conf:\narchive_command = \u0026#39;pgbackrest --stanza=main archive-push %p\u0026#39; æŠ¥é”™ä¿¡æ¯ï¼š\nDec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.386 P00 ERROR: [103]: unable to find a valid repository: Dec 27 17:15:37 x podman[1707]: repo1: [FileMissingError] unable to load info file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info\u0026#39; or \u0026#39;/var/lib/pgbackrest/archive/main/archive.info.copy\u0026#39;: Dec 27 17:15:37 x podman[1707]: FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info\u0026#39; for read Dec 27 17:15:37 x podman[1707]: FileMissingError: unable to open missing file \u0026#39;/var/lib/pgbackrest/archive/main/archive.info.copy\u0026#39; for read Dec 27 17:15:37 x podman[1707]: HINT: archive.info cannot be opened but is required to push/get WAL segments. Dec 27 17:15:37 x podman[1707]: HINT: is archive_command configured correctly in postgresql.conf? Dec 27 17:15:37 x podman[1707]: HINT: has a stanza-create been performed? Dec 27 17:15:37 x podman[1707]: HINT: use --no-archive-check to disable archive checks during backup if you have an alternate archiving scheme. Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] LOG: archive command failed with exit code 103 Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] DETAIL: The failed archive command was: pgbackrest --stanza=main archive-push pg_wal/000000010000000000000001 Dec 27 17:15:37 x podman[1707]: 2025-12-27 09:15:37.387 PRC [29] WARNING: archiving write-ahead log file \u0026#34;000000010000000000000001\u0026#34; failed too many times, will try again later Dec 27 17:15:37 x postgres[1787]: 2025-12-27 09:15:37.387 PRC [29] DETAIL: The failed archive command was: pgbackrest --stanza=main archive-push pg_wal/000000010000000000000001 Dec 27 17:15:37 x postgres[1787]: 2025-12-27 09:15:37.387 PRC [29] WARNING: archiving write-ahead log file \u0026#34;000000010000000000000001\u0026#34; failed too many times, will try again later å¿«é€Ÿè§£å†³æ–¹æ³•ï¼š\n"},{"id":381,"href":"/database/postgres/data-form/","title":"PostgreSQL æ•°æ®å½¢æ€","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯SQL æŸ¥è¯¢ç»“æœçš„æ‰€æœ‰å¸¸è§æ•°æ®å½¢æ€ï¼Œæ¯”â€œå•ä¸ªæ•°æ®ã€å•è¡Œæ•°æ®ã€å•åˆ—æ•°æ®ã€å¤šè¡Œæ•°æ®â€æ›´å…¨é¢ï¼Œå¹¶ä¸”æ¯ä¸€ç§éƒ½é™„å¸¦ PostgreSQL ç¤ºä¾‹ SQLï¼Œè®©ä½ ä¸€ç›®äº†ç„¶ã€‚\nâœ… SQL æŸ¥è¯¢ç»“æœçš„ 10 ç§å¸¸è§æ•°æ®å½¢æ€ï¼ˆå« PostgreSQL ç¤ºä¾‹ï¼‰ 1. å•ä¸ªæ•°æ®ï¼ˆSingle Valueï¼‰ é€šå¸¸æ˜¯èšåˆå‡½æ•°æˆ–è¡¨è¾¾å¼è¿”å›ä¸€ä¸ªå€¼ã€‚\nç¤ºä¾‹\nSELECT COUNT(*) AS total FROM users; 2. å•è¡Œæ•°æ®ï¼ˆSingle Rowï¼‰ è¿”å›ä¸€è¡Œï¼Œå¤šåˆ—ã€‚\nç¤ºä¾‹\nSELECT id, name, email FROM users WHERE id = 1001; 3. å•åˆ—æ•°æ®ï¼ˆSingle Column, Multi-rowï¼‰ ä¸€åˆ—å¤šè¡Œï¼Œå¦‚æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·åã€‚\nç¤ºä¾‹\nSELECT name FROM users; 4. å¤šè¡Œå¤šåˆ—ï¼ˆTypical Result Setï¼‰ å…¸å‹è¡¨æ ¼æŸ¥è¯¢ã€‚\nç¤ºä¾‹\nSELECT id, name, age FROM users WHERE age \u0026gt;= 18; ğŸ†• æ‰©å±•çš„æŸ¥è¯¢ç»“æœç±»å‹ï¼ˆæ›´é«˜çº§ï¼‰ 5. å¤šä¸ªç»“æœé›†ï¼ˆMultiple Result Setsï¼‰ PostgreSQL å¯ä»¥åœ¨ DO $$ã€plpgsql æˆ– psql ä¸‹è¿”å›å¤šä¸ªç»“æœé›†ï¼ˆä¸åƒ MySQL é‚£ä¹ˆå¸¸è§ï¼Œä½†æ”¯æŒï¼‰ã€‚\nç¤ºä¾‹ï¼ˆPL/pgSQLï¼‰\nDO $$ BEGIN RAISE NOTICE \u0026#39;First Result:\u0026#39;; PERFORM * FROM users LIMIT 1; RAISE NOTICE \u0026#39;Second Result:\u0026#39;; PERFORM * FROM orders LIMIT 1; END $$; 6. JSONï¼ˆå•å€¼ / å•è¡Œ / å¤šè¡ŒåµŒå¥—ç»“æ„ï¼‰ PostgreSQL çš„ JSON éå¸¸å¼ºå¤§ï¼Œå¯è¿”å› JSON å¯¹è±¡æˆ–æ•°ç»„ã€‚\nå•ä¸ª JSON å¯¹è±¡ï¼ˆRow -\u0026gt; JSONï¼‰\nSELECT row_to_json(u) FROM (SELECT id, name, age FROM users WHERE id = 1) AS u; JSON æ•°ç»„ï¼ˆRows -\u0026gt; JSON Arrayï¼‰\nSELECT json_agg(u) FROM ( SELECT id, name, age FROM users LIMIT 10 ) AS u; 7. æ•°ç»„ï¼ˆArray Resultï¼‰ PostgreSQL åŸç”Ÿæ”¯æŒæ•°ç»„ç±»å‹ã€‚\nç¤ºä¾‹\nSELECT ARRAY(SELECT id FROM users WHERE age \u0026gt; 18); 8. æ ‡é‡åˆ—è¡¨èšåˆï¼ˆString Aggregationï¼‰ ä½¿ç”¨ string_agg èšåˆæˆå­—ç¬¦ä¸²ã€‚\nç¤ºä¾‹\nSELECT string_agg(name, \u0026#39;, \u0026#39;) AS names FROM users; 9. è¡¨å‡½æ•°ç»“æœï¼ˆSet Returning Function, SRFï¼‰ æŸ¥è¯¢ç»“æœæ¥è‡ªå‡½æ•°ï¼Œå¯èƒ½æ˜¯å¤šè¡Œå¤šåˆ—ã€‚\nç¤ºä¾‹ï¼šè‡ªå®šä¹‰å‡½æ•°è¿”å›è¡¨\nCREATE OR REPLACE FUNCTION get_active_users() RETURNS TABLE(id int, name text) AS $$ BEGIN RETURN QUERY SELECT id, name FROM users WHERE active = TRUE; END; $$ LANGUAGE plpgsql; SELECT * FROM get_active_users(); 10. CTEï¼ˆå…¬ç”¨è¡¨è¾¾å¼ï¼‰ç»“æœï¼ˆå¯ä»¥æ„æˆé€»è¾‘è§†å›¾ï¼‰ æœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªç»“æœé›†ï¼Œä½†ä¾¿äºå¤šæ­¥éª¤å¤„ç†ã€‚\nç¤ºä¾‹\nWITH adult_users AS ( SELECT id, name, age FROM users WHERE age \u0026gt;= 18 ) SELECT * FROM adult_users WHERE age \u0026lt; 30; 11. é€è§† / åé€è§†ï¼ˆPivot / Unpivotï¼‰ ç»“æœæ˜¯åŠ¨æ€åˆ—æˆ–é€è§†ç»“æ„ã€‚\nç¤ºä¾‹ï¼ˆPivotï¼‰\nSELECT * FROM crosstab( \u0026#39;SELECT user_id, order_status, COUNT(*) FROM orders GROUP BY user_id, order_status\u0026#39; ) AS ct (user_id int, pending int, paid int, canceled int); 12. çª—å£å‡½æ•°ç»“æœï¼ˆWindow Function Resultï¼‰ å­—æ®µä¸­åŒ…å«è¡Œé—´è®¡ç®—ç»“æœï¼Œå¦‚æ’åã€ç´¯è®¡å’Œã€‚\nç¤ºä¾‹\nSELECT id, amount, SUM(amount) OVER (ORDER BY id) AS running_total FROM orders; 13. å¤åˆç±»å‹ï¼ˆComposite Typeï¼‰ è¿”å›ä¸€åˆ—ï¼Œä½†è¯¥åˆ—æ˜¯ç»“æ„ä½“ï¼ˆç±»ä¼¼ structï¼‰ã€‚\nç¤ºä¾‹\nSELECT (id, name) AS user_info FROM users LIMIT 1; 14. è¡Œè½¬åˆ— / åˆ—è½¬è¡Œï¼ˆRow Expanding / Column Expandingï¼‰ jsonb_each, unnest ç­‰ä¼šå˜å½¢ç»“æ„ã€‚\nç¤ºä¾‹ï¼ˆæ•°ç»„å±•å¼€ä¸ºå¤šè¡Œï¼‰\nSELECT unnest(tags) FROM articles; ğŸ“Œ æ€»ç»“å›¾ï¼ˆå¸¸è§æŸ¥è¯¢ç»“æœå½¢æ€ï¼‰ æ•°æ®å½¢æ€ æè¿° ç¤ºä¾‹ å•ä¸ªæ•°æ® å•å€¼ SELECT COUNT(*) å•è¡Œæ•°æ® ä¸€è¡Œå¤šåˆ— SELECT * FROM users WHERE id=1 å•åˆ—æ•°æ® ä¸€åˆ—å¤šè¡Œ SELECT name FROM users å¤šè¡Œå¤šåˆ— è¡¨æ ¼ SELECT * FROM users JSON JSON å¯¹è±¡æˆ–æ•°ç»„ json_agg æ•°ç»„ PostgreSQL æ•°ç»„ ARRAY(SELECT id\u0026hellip;) å­—ç¬¦ä¸²èšåˆ å°†å¤šè¡Œè¿æ¥ string_agg å¤šä¸ªç»“æœé›† ä¸€ä¸ªæ‰§è¡Œè¿”å›å¤šä¸ªé›†åˆ PL/pgSQL è¡¨å‡½æ•° ä»å‡½æ•°è¿”å›è¡¨ SRF CTE ä¸­é—´ç»“æœé›† WITH \u0026hellip; Pivot é€è§†è¡¨ crosstab çª—å£å‡½æ•° è¡Œé—´è®¡ç®— SUM() OVER Composite å¤åˆç±»å‹ å­—æ®µä¸­åŒ…å«å¤šå€¼ (id, name) è¡Œ/åˆ—å±•å¼€ unnest/jsonb_each unnest() ","description":"ä¸‹é¢æ˜¯SQL æŸ¥è¯¢ç»“æœçš„æ‰€æœ‰å¸¸è§æ•°æ®å½¢æ€ï¼Œæ¯”â€œå•ä¸ªæ•°æ®ã€å•è¡Œæ•°æ®ã€å•åˆ—æ•°æ®ã€å¤šè¡Œæ•°æ®â€æ›´å…¨é¢ï¼Œå¹¶ä¸”æ¯ä¸€ç§éƒ½é™„å¸¦ PostgreSQL ç¤ºä¾‹ SQLï¼Œè®©ä½ ä¸€ç›®äº†ç„¶ã€‚\nâœ… SQL æŸ¥è¯¢ç»“æœçš„ 10 ç§å¸¸è§æ•°æ®å½¢æ€ï¼ˆå« PostgreSQL ç¤ºä¾‹ï¼‰ 1. å•ä¸ªæ•°æ®ï¼ˆSingle Valueï¼‰ é€šå¸¸æ˜¯èšåˆå‡½æ•°æˆ–è¡¨è¾¾å¼è¿”å›ä¸€ä¸ªå€¼ã€‚\nç¤ºä¾‹\nSELECT COUNT(*) AS total FROM users; 2. å•è¡Œæ•°æ®ï¼ˆSingle Rowï¼‰ è¿”å›ä¸€è¡Œï¼Œå¤šåˆ—ã€‚\n"},{"id":382,"href":"/database/postgres/integer/","title":"PostgreSQL æ•´æ•°","parent":"PostgreSQL","content":"å†…å®¹ï¼šç±»å‹å¯¹æ¯”ã€èŒƒå›´ã€å­˜å‚¨ã€æ€§èƒ½ã€æœ€ä½³å®è·µã€å¸¸è§å‘ã€‚\nä¸€ã€PostgreSQL æ•´æ•°ç±»å‹ä¸€è§ˆï¼ˆæ ¸å¿ƒè¡¨ï¼‰ ç±»å‹ åˆ«å å­—èŠ‚ èŒƒå›´ SMALLINT INT2 2 -32,768 ï½ 32,767 INTEGER INT / INT4 4 -2,147,483,648 ï½ 2,147,483,647 BIGINT INT8 8 -9,223,372,036,854,775,808 ï½ 9,223,372,036,854,775,807 ğŸ“Œ æ²¡æœ‰ INT1 / INT16\näºŒã€å¦‚ä½•é€‰æ‹©æ•´æ•°ç±»å‹ï¼ˆç»“è®ºå…ˆè¡Œï¼‰ âœ… æ¨èè§„åˆ™ï¼ˆç›´æ¥ç…§ç”¨ï¼‰\nåœºæ™¯ æ¨èç±»å‹ è¡¨ä¸»é”® / ID BIGINT è¡Œæ•° \u0026lt; 20 äº¿ INTEGER çŠ¶æ€ç  / æšä¸¾ SMALLINT è®¡æ•° / è‡ªå¢ BIGINT è·¨ç³»ç»Ÿæ•°æ® BIGINT ä¸‰ã€å»ºè¡¨ç¤ºä¾‹ï¼ˆæ ‡å‡†å†™æ³•ï¼‰ 1ï¸âƒ£ æ™®é€šæ•´æ•°åˆ— CREATE TABLE example ( count INTEGER NOT NULL, status SMALLINT NOT NULL ); 2ï¸âƒ£ è‡ªå¢æ•´æ•°ï¼ˆPostgreSQL 10+ æ¨èï¼‰ id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY æˆ–ï¼š\nid BIGINT GENERATED BY DEFAULT AS IDENTITY 3ï¸âƒ£ æ—§å†™æ³•ï¼ˆä¸æ¨èæ–°é¡¹ç›®ï¼‰ id SERIAL id BIGSERIAL å››ã€æ•´æ•° vs æ•°å€¼ç±»å‹ï¼ˆé‡è¦åŒºåˆ«ï¼‰\nç±»å‹ ç²¾åº¦ æ€§èƒ½ é€‚ç”¨ INTEGER å›ºå®š â­â­â­â­â­ ID / è®¡æ•° NUMERIC ä»»æ„ â­â­ é‡‘é¢ FLOAT æµ®ç‚¹ â­â­â­â­ ç§‘å­¦è®¡ç®— ğŸ“Œ ID / æ•°é‡æ°¸è¿œä¸è¦ç”¨ NUMERIC\näº”ã€æ•´æ•°å­˜å‚¨ä¸æ€§èƒ½ï¼ˆä½ å¿…é¡»çŸ¥é“ï¼‰ 1ï¸âƒ£ å­˜å‚¨å›ºå®šã€æ¯”è¾ƒå¿« æ•´æ•°æ˜¯ å®šé•¿å­˜å‚¨ æ¯”è¾ƒã€æ’åºã€JOIN éå¸¸å¿« ç´¢å¼•ä½“ç§¯å° 2ï¸âƒ£ INTEGER vs BIGINT æ€§èƒ½å·®è·ï¼Ÿ å‡ ä¹å¯ä»¥å¿½ç•¥\nBIGINT æ…¢ \u0026lt; 5% æ¢æ¥çš„æ˜¯ æœªæ¥å®‰å…¨ ğŸ“Œ æ–°è¡¨ç›´æ¥ BIGINT\nå…­ã€å¸¸è§å‘ï¼ˆä½ å¾ˆå¯èƒ½è¸©è¿‡ï¼‰ âŒ 1ï¸âƒ£ MySQL é£æ ¼çš„ INT(11) INT(11) -- PostgreSQL ä¸å­˜åœ¨ PostgreSQLï¼š\nINTEGER æ²¡æœ‰é•¿åº¦ æ‹¬å·æ— æ•ˆ âŒ 2ï¸âƒ£ æ•°å­—å‰å¯¼é›¶ code INTEGER -- âŒ å¦‚æœæ˜¯ï¼š\n000591 åº”ä½¿ç”¨ï¼š\nCHAR(6) / VARCHAR(6) âŒ 3ï¸âƒ£ ç”¨ SMALLINT å½“ä¸»é”® id SMALLINT PRIMARY KEY -- âŒ 3 ä¸‡æ¡ç›´æ¥æº¢å‡º ç”Ÿäº§äº‹æ•…é«˜å‘ ä¸ƒã€æ•´æ•°ç´¢å¼•æœ€ä½³å®è·µ CREATE INDEX idx_example_count ON example(count); B-Tree æ•ˆç‡æœ€é«˜ é»˜è®¤ç´¢å¼•ç±»å‹ å…«ã€æ•´æ•°ä¸ COPY / å¯¼å…¥ CSV ç¤ºä¾‹ï¼š\nid,count 1,100 2,200 çº¯æ•°å­— ä¸è¦åŠ å¼•å·ï¼ˆå¯ä»¥åŠ ï¼Œä½†æ²¡å¿…è¦ï¼‰ ä¹ã€æŸ¥çœ‹æ•´æ•°ç±»å‹ä¿¡æ¯ SELECT typname, typlen FROM pg_type WHERE typname IN (\u0026#39;int2\u0026#39;, \u0026#39;int4\u0026#39;, \u0026#39;int8\u0026#39;); åã€æ€»ç»“ PostgreSQL çš„æ•´æ•°æ˜¯å®šé•¿ã€é«˜æ€§èƒ½ç±»å‹\næ–°è¡¨ï¼šBIGINT\nçŠ¶æ€å€¼ï¼šSMALLINT\nä¸è¦å¹»æƒ³ INT(11)\n","description":"å†…å®¹ï¼šç±»å‹å¯¹æ¯”ã€èŒƒå›´ã€å­˜å‚¨ã€æ€§èƒ½ã€æœ€ä½³å®è·µã€å¸¸è§å‘ã€‚\nä¸€ã€PostgreSQL æ•´æ•°ç±»å‹ä¸€è§ˆï¼ˆæ ¸å¿ƒè¡¨ï¼‰ ç±»å‹ åˆ«å å­—èŠ‚ èŒƒå›´ SMALLINT INT2 2 -32,768 ï½ 32,767 INTEGER INT / INT4 4 -2,147,483,648 ï½ 2,147,483,647 BIGINT INT8 8 -9,223,372,036,854,775,808 ï½ 9,223,372,036,854,775,807 ğŸ“Œ æ²¡æœ‰ INT1 / INT16\näºŒã€å¦‚ä½•é€‰æ‹©æ•´æ•°ç±»å‹ï¼ˆç»“è®ºå…ˆè¡Œï¼‰ âœ… æ¨èè§„åˆ™ï¼ˆç›´æ¥ç…§ç”¨ï¼‰\nåœºæ™¯ æ¨èç±»å‹ è¡¨ä¸»é”® / ID BIGINT è¡Œæ•° \u0026lt; 20 äº¿ INTEGER çŠ¶æ€ç  / æšä¸¾ SMALLINT è®¡æ•° / è‡ªå¢ BIGINT è·¨ç³»ç»Ÿæ•°æ® BIGINT ä¸‰ã€å»ºè¡¨ç¤ºä¾‹ï¼ˆæ ‡å‡†å†™æ³•ï¼‰ 1ï¸âƒ£ æ™®é€šæ•´æ•°åˆ— CREATE TABLE example ( count INTEGER NOT NULL, status SMALLINT NOT NULL ); 2ï¸âƒ£ è‡ªå¢æ•´æ•°ï¼ˆPostgreSQL 10+ æ¨èï¼‰ id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY æˆ–ï¼š\n"},{"id":383,"href":"/database/postgres/last-value/","title":"PostgreSQL æŸ¥çœ‹æŸä¸ªè‡ªå¢å­—æ®µ(åºåˆ—)å½“å‰æœ€æ–°å€¼","parent":"PostgreSQL","content":"åœ¨ PostgreSQL ä¸­ï¼ŒæŸ¥çœ‹ã€ŒæŸä¸ªè‡ªå¢å­—æ®µï¼ˆåºåˆ—ï¼‰ã€å½“å‰æœ€æ–°å€¼ï¼Œè¦åˆ†æ¸… åºåˆ—æ˜¯å¦å·²è¢«ä½¿ç”¨è¿‡ã€‚ä¸‹é¢æŒ‰ æœ€å¸¸ç”¨ -\u0026gt; æœ€ä¸¥è°¨ -\u0026gt; æœ€å®‰å…¨ æ€»ç»“ã€‚\nä¸€ã€æœ€å¸¸ç”¨ï¼šç›´æ¥æŸ¥åºåˆ— last_valueï¼ˆâš ï¸æ³¨æ„å«ä¹‰ï¼‰ SELECT last_value FROM articles_id_seq; å«ä¹‰\nä¸æ˜¯ä¸€å®šç­‰äºè¡¨ä¸­æœ€å¤§ id è¡¨ç¤ºï¼šåºåˆ—å½“å‰å†…éƒ¨å€¼ å¦‚æœï¼š ä»æœª nextval() -\u0026gt; å¯èƒ½æ˜¯èµ·å§‹å€¼ æœ‰å›æ»šäº‹åŠ¡ -\u0026gt; å¯èƒ½å¤§äºè¡¨ä¸­æœ€å¤§ id ğŸ‘‰ åªèƒ½è¯´æ˜åºåˆ—çŠ¶æ€ï¼Œä¸ä»£è¡¨æ•°æ®çœŸå®æœ€å¤§å€¼\näºŒã€æŸ¥çœ‹ä¸‹ä¸€ä¸ªå°†è¦ä½¿ç”¨çš„å€¼ï¼ˆæœ€å‡†ç¡®ï¼‰ SELECT nextval(\u0026#39;articles_id_seq\u0026#39;); âš ï¸ ä¼šé€’å¢åºåˆ—ï¼ˆæ…ç”¨ï¼‰\nä¸‰ã€åªè¯»æ–¹å¼æŸ¥çœ‹â€œä¸‹ä¸€ä¸ªå€¼â€ï¼ˆä¸é€’å¢ï¼‰ âœ… PostgreSQL 10+ï¼ˆæ¨èï¼‰\nSELECT last_value, increment_by FROM pg_sequences WHERE schemaname = \u0026#39;public\u0026#39; AND sequencename = \u0026#39;articles_id_seq\u0026#39;; ğŸ‘‰ ä¸‹ä¸€ä¸ªå€¼ï¼š\nlast_value + increment_by å››ã€æŸ¥è¯¢è¡¨ä¸­çœŸå®æœ€å¤§ idï¼ˆä¸åºåˆ—å¯¹æ¯”ï¼‰ SELECT MAX(id) FROM articles; ğŸ“Œ å¸¸è§ç”¨é€”ï¼š\næ•°æ®å¯¼å…¥åæ£€æŸ¥åºåˆ—æ˜¯å¦é”™ä½ åˆ¤æ–­æ˜¯å¦éœ€è¦ setval äº”ã€ä¿®å¤åºåˆ—é”™ä½ï¼ˆéå¸¸å¸¸è§ï¼‰ å¦‚æœä½ å‘ç°ï¼š\nMAX(id) = 1000 last_value = 900 ä¿®å¤ï¼š\nSELECT setval(\u0026#39;articles_id_seq\u0026#39;, (SELECT MAX(id) FROM articles)); æˆ–ï¼ˆæ›´ä¸¥è°¨ï¼‰ï¼š\nSELECT setval( \u0026#39;articles_id_seq\u0026#39;, (SELECT MAX(id) FROM articles), true ); å…­ã€IDENTITY åˆ—çš„æ­£ç¡®æŸ¥çœ‹æ–¹å¼ï¼ˆPG 10+ï¼‰ å¦‚æœä½ çš„è¡¨æ˜¯ï¼š\nid INTEGER GENERATED ALWAYS AS IDENTITY æ‰¾åˆ°åºåˆ—åï¼š\nSELECT pg_get_serial_sequence(\u0026#39;articles\u0026#39;, \u0026#39;id\u0026#39;); ç„¶åï¼š\nSELECT last_value FROM articles_id_seq; ä¸ƒã€å…¶å®ƒ Qï¼šå¦‚ä½•æŸ¥çœ‹è‡ªå¢å­—æ®µå½“å‰å€¼ï¼Ÿ SELECT last_value FROM xxx_id_seq; Qï¼šä¸ºä»€ä¹ˆä¸ç­‰äº MAX(id)ï¼Ÿ Aï¼šåºåˆ—ä¸å›æ»šï¼Œäº‹åŠ¡å¤±è´¥ä¹Ÿä¼šæ¶ˆè€—å€¼ã€‚\nQï¼šå®‰å…¨æŸ¥çœ‹æ–¹å¼ï¼Ÿ Aï¼šæŸ¥è¯¢ pg_sequencesï¼Œä¸ä½¿ç”¨ nextval()ã€‚\nå…«ã€å¸¸è§è¯¯åŒºï¼ˆâš ï¸ï¼‰ âŒ ç”¨ nextval() å½“æŸ¥çœ‹ âŒ è®¤ä¸ºåºåˆ—å€¼ä¸€å®šè¿ç»­ âŒ å¿˜è®°å¯¼å…¥æ•°æ®ååŒæ­¥åºåˆ— âœ… æœ€æ¨èæ—¥å¸¸ç”¨çš„ 2 æ¡\n-- æŸ¥çœ‹åºåˆ— SELECT pg_get_serial_sequence(\u0026#39;articles\u0026#39;, \u0026#39;id\u0026#39;); -- æŸ¥çœ‹å½“å‰å€¼ SELECT last_value FROM articles_id_seq; ","description":"åœ¨ PostgreSQL ä¸­ï¼ŒæŸ¥çœ‹ã€ŒæŸä¸ªè‡ªå¢å­—æ®µï¼ˆåºåˆ—ï¼‰ã€å½“å‰æœ€æ–°å€¼ï¼Œè¦åˆ†æ¸… åºåˆ—æ˜¯å¦å·²è¢«ä½¿ç”¨è¿‡ã€‚ä¸‹é¢æŒ‰ æœ€å¸¸ç”¨ -\u0026gt; æœ€ä¸¥è°¨ -\u0026gt; æœ€å®‰å…¨ æ€»ç»“ã€‚\nä¸€ã€æœ€å¸¸ç”¨ï¼šç›´æ¥æŸ¥åºåˆ— last_valueï¼ˆâš ï¸æ³¨æ„å«ä¹‰ï¼‰ SELECT last_value FROM articles_id_seq; å«ä¹‰\nä¸æ˜¯ä¸€å®šç­‰äºè¡¨ä¸­æœ€å¤§ id è¡¨ç¤ºï¼šåºåˆ—å½“å‰å†…éƒ¨å€¼ å¦‚æœï¼š ä»æœª nextval() -\u0026gt; å¯èƒ½æ˜¯èµ·å§‹å€¼ æœ‰å›æ»šäº‹åŠ¡ -\u0026gt; å¯èƒ½å¤§äºè¡¨ä¸­æœ€å¤§ id ğŸ‘‰ åªèƒ½è¯´æ˜åºåˆ—çŠ¶æ€ï¼Œä¸ä»£è¡¨æ•°æ®çœŸå®æœ€å¤§å€¼\näºŒã€æŸ¥çœ‹ä¸‹ä¸€ä¸ªå°†è¦ä½¿ç”¨çš„å€¼ï¼ˆæœ€å‡†ç¡®ï¼‰ SELECT nextval(\u0026#39;articles_id_seq\u0026#39;); âš ï¸ ä¼šé€’å¢åºåˆ—ï¼ˆæ…ç”¨ï¼‰\nä¸‰ã€åªè¯»æ–¹å¼æŸ¥çœ‹â€œä¸‹ä¸€ä¸ªå€¼â€ï¼ˆä¸é€’å¢ï¼‰ âœ… PostgreSQL 10+ï¼ˆæ¨èï¼‰\n"},{"id":384,"href":"/database/postgres/basebackup-and-wal/","title":"PostgreSQL ç‰©ç†å¤‡ä»½ + WAL è¯¦ç»†çš„ å¢é‡å¤‡ä»½ æ–¹æ¡ˆ","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ç‰©ç†å¤‡ä»½ + WAL çš„â€œå®Œæ•´å¢é‡å¤‡ä»½æ–¹æ¡ˆâ€ï¼Œè¿™ä¹Ÿæ˜¯ PostgreSQL å®˜æ–¹æ¨èã€ä¼ä¸šçº§æœ€å¸¸ç”¨ã€èƒ½å®ç° çœŸæ­£å¢é‡æ¢å¤ï¼ˆPITRï¼‰ çš„æ–¹æ¡ˆã€‚\nåŸç† -\u0026gt; ç›®å½•ç»“æ„ -\u0026gt; é…ç½® -\u0026gt; å¤‡ä»½æµç¨‹ -\u0026gt; å¢é‡æ¢å¤æµç¨‹ -\u0026gt; è‡ªåŠ¨åŒ–è„šæœ¬ -\u0026gt; æœ€ä½³å®è·µ\nğŸ”¥ æ ¸å¿ƒæ€æƒ³ï¼ˆä»… 3 ç‚¹ï¼‰\nç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ = ã€ŒåŸºçº¿é•œåƒã€ WAL å½’æ¡£ = è®°å½•æ‰€æœ‰åç»­å˜åŒ–ï¼ˆå¢é‡æ—¥å¿—ï¼‰ æ¢å¤æ—¶ï¼šåŸºçº¿å¤‡ä»½ + æ‰€æœ‰ WAL = ä»»æ„æ—¶é—´ç‚¹çš„æ•°æ® å¢é‡ç‚¹å®Œå…¨æ¥è‡ª WALï¼Œä¸ä¾èµ–å·®å¼‚å¤‡ä»½ï¼ˆå› ä¸º PostgreSQL ä¸æ”¯æŒå—çº§å·®å¼‚å¤‡ä»½ï¼‰ã€‚\n1. æ–‡ä»¶ç»“æ„ï¼ˆæ¨èæ ‡å‡†ï¼‰ /pgdata/ # PG æ•°æ®ç›®å½• /base_backup/ # ç‰©ç†å¤‡ä»½ï¼ˆæ¯æ—¥ï¼‰ 2025-02-01/ 2025-02-02/ ... /wal_archive/ # WAL å¢é‡æ—¥å¿—å½’æ¡£ï¼ˆæŒç»­äº§ç”Ÿï¼‰ 000000010000000000000001 000000010000000000000002 ... /backup_scripts/ # è‡ªåŠ¨åŒ–è„šæœ¬ 2. PostgreSQL WAL å½’æ¡£é…ç½®ï¼ˆæœ€å…³é”®ï¼‰ ä¿®æ”¹ postgresql.confï¼š\nwal_level = replica # å¿…é¡» archive_mode = on # å¯ç”¨å½’æ¡£ archive_command = \u0026#39;cp %p /wal_archive/%f\u0026#39; # å¤åˆ¶WAL max_wal_senders = 10 wal_keep_size = 1024 # è§†è§„æ¨¡è®¾ç½®ï¼ˆMBï¼‰ åˆ›å»ºç›®å½•ï¼š\nmkdir -p /wal_archive chmod 700 /wal_archive éªŒè¯æ˜¯å¦ç”Ÿæ•ˆï¼š\nSELECT pg_switch_wal(); çœ‹æ˜¯å¦ç”Ÿæˆ WAL æ–‡ä»¶ã€‚\n3. ç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ï¼ åŸºçº¿å¤‡ä»½ æ¯å¤©ä¸€æ¬¡å³å¯ã€‚\npg_basebackup \\ -U backup \\ -D /base_backup/2025-02-10 \\ -Fp -Xs -P è§£é‡Šï¼š\n-Fp -\u0026gt; ç›®å½•æ ¼å¼ -Xs -\u0026gt; åŒæ­¥å¤åˆ¶å¤‡ä»½æ—¶åˆ»çš„ WAL -P -\u0026gt; æ˜¾ç¤ºè¿›åº¦ å¤‡ä»½åç›®å½•ï¼š\n/base_backup/2025-02-10/ /wal_archive/ # WAL æŒç»­å¢åŠ  4. ç‰©ç† + WAL = å¦‚ä½•æ„æˆâ€œå¢é‡å¤‡ä»½â€ ç‰©ç†å¤‡ä»½ï¼šä¸€æ¬¡ WAL å½’æ¡£ï¼šæŒç»­è®°å½•å¢é‡å˜åŒ– ä¾‹å¦‚ï¼š\næ—¶é—´ äº‹ä»¶ 02-10 00:00 pg_basebackupï¼ˆå…¨é‡ï¼‰ 02-10 01:00 WAL æ–‡ä»¶å¢é‡ 02-10 02:00 WAL æ–‡ä»¶å¢é‡ 02-10 03:00 WAL æ–‡ä»¶å¢é‡ ä½ è¦æ¢å¤ 03:05 çš„æ•°æ® -\u0026gt;\nç”¨ 00:00 çš„ç‰©ç†å¤‡ä»½ + 01~03 ç‚¹ WAL = è‡ªåŠ¨æ¢å¤åˆ° 03:05ã€‚\nè¿™å°±æ˜¯ å¢é‡å¤‡ä»½ã€‚\n5. å¢é‡æ¢å¤ï¼ˆæ—¶é—´ç‚¹æ¢å¤ï¼‰å®Œæ•´æµç¨‹ è¿™æ˜¯ WAL æ–¹æ¡ˆçš„æ ¸å¿ƒä»·å€¼ã€‚\nâœ¨ Step 1ï¼šåœæ­¢ PostgreSQL systemctl stop postgresql âœ¨ Step 2ï¼šæ¸…ç©ºåŸæ•°æ®åº“ç›®å½• rm -rf /pgdata/* âœ¨ Step 3ï¼šæ¢å¤æŸæ¬¡ç‰©ç†å¤‡ä»½ ä¾‹å¦‚ï¼š\ncp -r /base_backup/2025-02-10/* /pgdata/ âœ¨ Step 4ï¼šåˆ›å»ºæ¢å¤é…ç½®ï¼ˆPostgreSQL â‰¥ 12ï¼‰ åˆ›å»ºæ¢å¤ä¿¡å·ï¼š\ntouch /pgdata/recovery.signal åœ¨ postgresql.auto.conf æ·»åŠ ï¼š\nrestore_command = \u0026#39;cp /wal_archive/%f %p\u0026#39; recovery_target_time = \u0026#39;2025-02-10 03:05:00\u0026#39; ä½ ä¹Ÿå¯ä»¥ç”¨ï¼š\nrecovery_target_lsn recovery_target_xid recovery_target_name recovery_target = \u0026lsquo;immediate\u0026rsquo;ï¼ˆæ¢å¤åˆ°å°½å¯èƒ½è¿‘ï¼‰ âœ¨ Step 5ï¼šå¯åŠ¨ PostgreSQL systemctl start postgresql PostgreSQL è‡ªåŠ¨æŒ‰é¡ºåº replay æ‰€æœ‰ WAL æ–‡ä»¶ï¼Œåˆ°è¾¾æŒ‡å®šæ—¶é—´è‡ªåŠ¨åœã€‚\n6. è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆä¼ä¸šå¿…å¤‡ï¼‰ æ¯æ—¥åŸºçº¿å¤‡ä»½ï¼ˆbackup_full.shï¼‰ #!/bin/bash DATE=$(date +%F) DIR=\u0026#34;/base_backup/$DATE\u0026#34; mkdir -p $DIR pg_basebackup -U backup -D \u0026#34;$DIR\u0026#34; -Fp -Xs -P find /base_backup/ -maxdepth 1 -mtime +7 -exec rm -rf {} \\; æ¯æ—¥ WAL æ¸…ç†ç­–ç•¥ï¼ˆæ ¹æ®ä¿ç•™å¤©æ•°ï¼‰ wal æ–‡ä»¶å¯èƒ½å¾ˆå¤šï¼Œé€šå¸¸ä¿ç•™ 3~7 å¤©ï¼š\nfind /wal_archive/ -type f -mtime +7 -delete 7. å¢é‡å¤‡ä»½å¸¸è§é—®é¢˜ âŒ archive_command æŠ¥é”™ -\u0026gt; WAL ä¸¢å¤±ï¼ˆæœ€å±é™©ï¼‰ æŸ¥çœ‹æ—¥å¿—ï¼š\njournalctl -u postgresql -f å¦‚æœ WAL ä¸¢å¤±ï¼Œåˆ™æ— æ³•æ¢å¤åˆ°æŸäº›æ—¶é—´ç‚¹ã€‚\nâŒ ç‰©ç†å¤‡ä»½ä¸å®é™… WAL ä¸åŒ¹é… ä¸€å®šè¦æ­é…ï¼š\npg_basebackup -Xs å¦åˆ™æ¢å¤ä¼šå¤±è´¥ã€‚\nâŒ æ¢å¤åå˜åªè¯» å¿˜äº†åˆ é™¤ recovery.signal\n8. æœ€ä½³å®è·µï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰ å¿…é¡»å¼€å¯ WAL å½’æ¡£ï¼ˆä¼ä¸šé»˜è®¤ï¼‰ ç‰©ç† + WAL æ˜¯æœ€å¯é ã€æœ€é«˜å¯ç”¨çš„å¤‡ä»½æ–¹æ¡ˆ æ¯å‘¨æ‰§è¡Œæ¢å¤æ¼”ç»ƒ å¤‡ä»½æ”¾å¤šåœ°ï¼ˆæœ¬åœ° + å¯¹è±¡å­˜å‚¨ S3/OSSï¼‰ å•æœºä¹Ÿå¿…é¡»åš WAL å¢é‡å¤‡ä»½ï¼ˆé˜²æ­¢è¯¯åˆ  / ç¾éš¾ï¼‰ ç‰©ç†å¤‡ä»½ + WAL + é€»è¾‘å¤‡ä»½ = ä¸‰é‡ä¿æŠ¤ æµå¤åˆ¶ä¸ç­‰äºå¤‡ä»½ -ï¼ˆå› ä¸ºè¯¯æ“ä½œä¼šåŒæ­¥åˆ°ä»åº“ï¼‰ ğŸ¯ æ€»ç»“ï¼šç‰©ç†å¤‡ä»½ + WAL = å®˜æ–¹é¡¶çº§å¢é‡æ–¹æ¡ˆ PostgreSQL æ²¡æœ‰åƒ MySQL é‚£æ ·çš„â€œå·®å¼‚å¤‡ä»½â€ï¼Œ\nå› ä¸º å¢é‡å®Œå…¨é  WAL å®Œæˆã€‚\næ‰€ä»¥â€¦â€¦\nğŸ”¥ å¢é‡å¤‡ä»½ = ç‰©ç†å¤‡ä»½ + WAL\nç‰©ç†å¤‡ä»½ = åŸºçº¿ WAL = æ‰€æœ‰å¢é‡ PITR = åˆ°ä»»æ„æ—¶é—´æ¢å¤ ä¼ä¸šæ ‡å‡†æ–¹æ¡ˆ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ç‰©ç†å¤‡ä»½ + WAL çš„â€œå®Œæ•´å¢é‡å¤‡ä»½æ–¹æ¡ˆâ€ï¼Œè¿™ä¹Ÿæ˜¯ PostgreSQL å®˜æ–¹æ¨èã€ä¼ä¸šçº§æœ€å¸¸ç”¨ã€èƒ½å®ç° çœŸæ­£å¢é‡æ¢å¤ï¼ˆPITRï¼‰ çš„æ–¹æ¡ˆã€‚\nåŸç† -\u0026gt; ç›®å½•ç»“æ„ -\u0026gt; é…ç½® -\u0026gt; å¤‡ä»½æµç¨‹ -\u0026gt; å¢é‡æ¢å¤æµç¨‹ -\u0026gt; è‡ªåŠ¨åŒ–è„šæœ¬ -\u0026gt; æœ€ä½³å®è·µ\nğŸ”¥ æ ¸å¿ƒæ€æƒ³ï¼ˆä»… 3 ç‚¹ï¼‰\nç‰©ç†å¤‡ä»½ï¼ˆpg_basebackupï¼‰ = ã€ŒåŸºçº¿é•œåƒã€ WAL å½’æ¡£ = è®°å½•æ‰€æœ‰åç»­å˜åŒ–ï¼ˆå¢é‡æ—¥å¿—ï¼‰ æ¢å¤æ—¶ï¼šåŸºçº¿å¤‡ä»½ + æ‰€æœ‰ WAL = ä»»æ„æ—¶é—´ç‚¹çš„æ•°æ® å¢é‡ç‚¹å®Œå…¨æ¥è‡ª WALï¼Œä¸ä¾èµ–å·®å¼‚å¤‡ä»½ï¼ˆå› ä¸º PostgreSQL ä¸æ”¯æŒå—çº§å·®å¼‚å¤‡ä»½ï¼‰ã€‚\n1. æ–‡ä»¶ç»“æ„ï¼ˆæ¨èæ ‡å‡†ï¼‰ /pgdata/ # PG æ•°æ®ç›®å½• /base_backup/ # ç‰©ç†å¤‡ä»½ï¼ˆæ¯æ—¥ï¼‰ 2025-02-01/ 2025-02-02/ ... /wal_archive/ # WAL å¢é‡æ—¥å¿—å½’æ¡£ï¼ˆæŒç»­äº§ç”Ÿï¼‰ 000000010000000000000001 000000010000000000000002 ... /backup_scripts/ # è‡ªåŠ¨åŒ–è„šæœ¬ 2. PostgreSQL WAL å½’æ¡£é…ç½®ï¼ˆæœ€å…³é”®ï¼‰ ä¿®æ”¹ postgresql.confï¼š\n"},{"id":385,"href":"/database/postgres/foreign-key-checks/","title":"PostgreSQL ç¦ç”¨å¤–é”®æ£€æŸ¥","parent":"PostgreSQL","content":"åœ¨ PostgreSQL ä¸­ç¦ç”¨å¤–é”®ï¼Œå¯ä»¥ä½¿ç”¨ ALTER TABLE table_name DISABLE TRIGGER ALL; å‘½ä»¤ä¸´æ—¶ç¦ç”¨æŒ‡å®šè¡¨ä¸Šçš„æ‰€æœ‰è§¦å‘å™¨ï¼ŒåŒ…æ‹¬å¤–é”®è§¦å‘å™¨ã€‚è¦é‡æ–°å¯ç”¨å¤–é”®ï¼Œä½¿ç”¨ ALTER TABLE table_name ENABLE TRIGGER ALL; å‘½ä»¤ã€‚\nç¦ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¦ç”¨æ‰€æœ‰å¤–é”®çº¦æŸï¼š\nALTER TABLE table_name DISABLE TRIGGER ALL; å°† table_name æ›¿æ¢ä¸ºè¦ç¦ç”¨å¤–é”®çš„è¡¨åã€‚\né‡æ–°å¯ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°å¯ç”¨æ‰€æœ‰å¤–é”®çº¦æŸï¼š\nALTER TABLE table_name ENABLE TRIGGER ALL; å°† table_name æ›¿æ¢ä¸ºè¦é‡æ–°å¯ç”¨å¤–é”®çš„è¡¨åã€‚\n","description":"åœ¨ PostgreSQL ä¸­ç¦ç”¨å¤–é”®ï¼Œå¯ä»¥ä½¿ç”¨ ALTER TABLE table_name DISABLE TRIGGER ALL; å‘½ä»¤ä¸´æ—¶ç¦ç”¨æŒ‡å®šè¡¨ä¸Šçš„æ‰€æœ‰è§¦å‘å™¨ï¼ŒåŒ…æ‹¬å¤–é”®è§¦å‘å™¨ã€‚è¦é‡æ–°å¯ç”¨å¤–é”®ï¼Œä½¿ç”¨ ALTER TABLE table_name ENABLE TRIGGER ALL; å‘½ä»¤ã€‚\nç¦ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¦ç”¨æ‰€æœ‰å¤–é”®çº¦æŸï¼š\nALTER TABLE table_name DISABLE TRIGGER ALL; å°† table_name æ›¿æ¢ä¸ºè¦ç¦ç”¨å¤–é”®çš„è¡¨åã€‚\né‡æ–°å¯ç”¨å¤–é”® ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°å¯ç”¨æ‰€æœ‰å¤–é”®çº¦æŸï¼š\nALTER TABLE table_name ENABLE TRIGGER ALL; å°† table_name æ›¿æ¢ä¸ºè¦é‡æ–°å¯ç”¨å¤–é”®çš„è¡¨åã€‚\n"},{"id":386,"href":"/database/postgres/indexs/","title":"PostgreSQL ç´¢å¼•","parent":"PostgreSQL","content":" 1. ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ç´¢å¼•ï¼Ÿ ç´¢å¼• = åŠ é€Ÿ WHEREã€JOINã€ORDER BYã€GROUP BY çš„ç»“æ„\næœ¬è´¨æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯ B-Treeï¼‰ï¼Œå¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½è¡Œã€‚\næœ‰ç´¢å¼• -\u0026gt; æŸ¥å°‘é‡è¡Œï¼ˆlogNï¼‰ æ²¡ç´¢å¼• -\u0026gt; æ‰«ææ•´å¼ è¡¨ï¼ˆO(N)ï¼‰ 2. PostgreSQL æ”¯æŒå“ªäº›ç´¢å¼•ï¼Ÿ ç±»å‹ é€‚ç”¨åœºæ™¯ æ˜¯å¦å¸¸ç”¨ B-Treeï¼ˆé»˜è®¤ï¼‰ æŸ¥è¯¢ã€æ’åºã€èŒƒå›´æŸ¥è¯¢ï¼ˆ=ã€\u0026gt;ã€\u0026lt;ã€BETWEENã€LIKE \u0026lsquo;abc%\u0026rsquo;ï¼‰ â­â­â­â­â­ æœ€å¸¸ç”¨ Hash ç­‰å€¼æŸ¥è¯¢ (=) â­ï¼ˆä¸€èˆ¬ç”¨ B-Tree æ›¿ä»£ï¼‰ GIN JSONBã€å…¨æ–‡æ£€ç´¢ã€æ•°ç»„ @\u0026gt; â­â­â­â­ GiST åœ°ç†ä½ç½®ã€å…¨æ–‡æ£€ç´¢ã€æ¨¡ç³ŠåŒ¹é… â­â­â­ BRIN å¤§å‹æŒ‰æ—¶é—´é¡ºåºçš„è¡¨ï¼ˆäº¿çº§æ•°æ®ï¼‰ â­â­â­â­â­ å¤§åº“ç¥å™¨ SP-GiST T-Treeã€QuadTree ç­‰ç‰¹æ®Šåœºæ™¯ â­ 3. B-Tree ç´¢å¼•ï¼ˆæœ€å¸¸ç”¨ï¼‰ åˆ›å»ºæ™®é€šç´¢å¼•\nCREATE INDEX idx_users_email ON users(email); æŸ¥è¯¢ä½¿ç”¨ B-Tree ç´¢å¼•çš„æƒ…å†µ\nSELECT * FROM users WHERE email = \u0026#39;a@b.com\u0026#39;; æ’åºä¹Ÿä¼šä½¿ç”¨ç´¢å¼•\nSELECT * FROM users ORDER BY created_at DESC LIMIT 10; èŒƒå›´æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•\nSELECT * FROM orders WHERE price \u0026gt; 100; 4. B-Tree æ”¯æŒçš„ LIKE â­ å‰ç¼€åŒ¹é…æ”¯æŒï¼ˆèƒ½èµ°ç´¢å¼•ï¼‰ï¼š\nSELECT * FROM user WHERE name LIKE \u0026#39;abc%\u0026#39;; âŒ åŒ…å«åŒ¹é…ï¼ˆä¸èƒ½èµ°ç´¢å¼•ï¼‰\nLIKE \u0026#39;%abc%\u0026#39; å¯ä½¿ç”¨ trigram æ‰©å±•ï¼ˆè§åé¢ï¼‰ã€‚\n5. å¤šåˆ—ç´¢å¼•ï¼ˆæ³¨æ„é¡ºåºï¼ï¼ï¼‰ CREATE INDEX idx_user_status_created ON users(status, created_at); âœ… åˆé€‚æŸ¥è¯¢ï¼š\nWHERE status = 1 WHERE status = 1 AND created_at \u0026gt; now() - interval \u0026#39;1 day\u0026#39; âŒ ä¸åˆé€‚æŸ¥è¯¢ï¼ˆä¸ä¼šèµ°ç´¢å¼•ï¼‰ï¼š\nWHERE created_at \u0026gt; now() -- status æ²¡ç”¨åˆ°ï¼Œç´¢å¼•å¤±æ•ˆ å¤šåˆ—ç´¢å¼•å¿…é¡»æŒ‰é¡ºåºä½¿ç”¨ã€‚\n6. è¦†ç›–ç´¢å¼•ï¼ˆIndex Only Scanï¼‰ ç´¢å¼•åŒ…å«æŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰å­—æ®µ -\u0026gt; ä¸éœ€è¦è®¿é—®è¡¨ -\u0026gt; æå‡æ€§èƒ½ 10 å€ã€‚\nCREATE INDEX idx_users_email_only ON users(email); SELECT email FROM users WHERE email = \u0026#39;a@b.com\u0026#39;; 7. å”¯ä¸€ç´¢å¼•ï¼ˆUnique Indexï¼‰ è‡ªåŠ¨ç¡®ä¿å”¯ä¸€æ€§ + å¿«é€ŸæŸ¥æ‰¾ã€‚\nCREATE UNIQUE INDEX idx_users_email_unique ON users(email); ç­‰åŒäºï¼š\nemail TEXT UNIQUE 8. è¡¨è¾¾å¼ç´¢å¼•ï¼ˆéå¸¸å¼ºï¼‰ ä¾‹å¦‚ä½ çš„éœ€æ±‚ï¼šTRIM(name) å»ç©ºæ ¼æŸ¥è¯¢\nCREATE INDEX idx_trim_name ON ashare (trim(name)); æŸ¥è¯¢ï¼š\nSELECT * FROM ashare WHERE trim(name) = \u0026#39;å¹³å®‰é“¶è¡Œ\u0026#39;; è¡¨è¾¾å¼å¿…é¡»ä¸€æ¨¡ä¸€æ ·ï¼Œç´¢å¼•æ‰ä¼šç”Ÿæ•ˆã€‚\n9. å±€éƒ¨ç´¢å¼•ï¼ˆPartial Indexï¼‰ é€‚åˆå¤§è¡¨ï¼Œåªç»™å¸¸æŸ¥è¯¢çš„æ•°æ®å»ºç´¢å¼•ï¼ˆå‡å°‘ç©ºé—´ + åŠ é€Ÿï¼‰ã€‚\nç¤ºä¾‹ï¼šåªç´¢å¼•æœªåˆ é™¤çš„æ•°æ®\nCREATE INDEX idx_active_user ON users(email) WHERE deleted = false; æŸ¥è¯¢ï¼š\nWHERE deleted = false AND email = \u0026#39;xxx\u0026#39; 10. JSONB ç´¢å¼•ï¼ˆGINï¼‰ å¤§ JSON è¡¨ï¼Œè¶…å¼ºç´¢å¼•ã€‚\nJSONB åŒ…å«æŸ¥è¯¢\nCREATE INDEX idx_json_tags ON articles USING GIN (tags); SELECT * FROM articles WHERE tags @\u0026gt; \u0026#39;[\u0026#34;python\u0026#34;]\u0026#39;; JSONB é”®æŸ¥è¯¢\nCREATE INDEX idx_json_data ON users USING GIN (data); SELECT * FROM users WHERE data-\u0026gt;\u0026gt;\u0026#39;city\u0026#39; = \u0026#39;Beijing\u0026#39;; 11. Trigramï¼ˆæ¨¡ç³Šæœç´¢ç´¢å¼•ï¼‰ æ”¯æŒ LIKE \u0026lsquo;%xxx%\u0026rsquo; æ•ˆç‡å·¨å¤§æå‡ã€‚\nå®‰è£…æ‰©å±•ï¼š\nCREATE EXTENSION pg_trgm; åˆ›å»ºç´¢å¼•ï¼š\nCREATE INDEX idx_trgm_name ON ashare USING GIN (name gin_trgm_ops); æŸ¥è¯¢ï¼š\nSELECT * FROM ashare WHERE name LIKE \u0026#39;%é“¶è¡Œ%\u0026#39;; æ€§èƒ½æå‡ 100 å€ã€‚\n12. BRIN ç´¢å¼•ï¼ˆæµ·é‡æ•°æ®ç”¨ï¼‰ é€‚ç”¨äºï¼š\næ—¶é—´åºåˆ— è‡ªå¢ id ä¸Šäº¿æ¡æ•°æ® ç¤ºä¾‹ï¼š\nCREATE INDEX idx_brin_log_created ON logs USING BRIN(created_at); ä¼˜ç‚¹ï¼š\nå ç”¨æå°ï¼ˆé€šå¸¸åªæœ‰ KB çº§ï¼‰ æŸ¥è¯¢èŒƒå›´è¿ç»­çš„æ•°æ®éå¸¸å¿« æ’å…¥é€Ÿåº¦æ¥è¿‘æ— ç´¢å¼• æ–°é—»ã€æ—¶é—´åºåˆ—åˆ†æç­‰åœºæ™¯éå¸¸é€‚ç”¨ã€‚\n13. ç´¢å¼•ä»€ä¹ˆæ—¶å€™ä¸ä¼šç”Ÿæ•ˆï¼Ÿ éå¸¸é‡è¦ï¼\nâŒ WHERE ä¸ç¬¦åˆç´¢å¼•è§„åˆ™ âŒ ç±»å‹ä¸ä¸€è‡´ âŒ ä½¿ç”¨å‡½æ•°ä½†æ— è¡¨è¾¾å¼ç´¢å¼• âŒ è¿›è¡Œè®¡ç®—ï¼ˆä¾‹å¦‚ price * 2 = 100ï¼‰ âŒ åœ¨ OR ä¸¤è¾¹éƒ½æ²¡æœ‰ç´¢å¼• âŒ LIKE \u0026lsquo;%xxx%\u0026rsquo;ï¼ˆæœªä½¿ç”¨ trigramï¼‰ 14. å¦‚ä½•æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆéå¸¸é‡è¦ï¼‰ EXPLAIN ANALYZE SELECT * FROM users WHERE id = 10; é‡ç‚¹å…³æ³¨ï¼š\nIndex Scanï¼ˆèµ°ç´¢å¼•ï¼‰ Seq Scanï¼ˆå…¨è¡¨æ‰«æï¼‰ Index Only Scanï¼ˆæœ€ä¼˜ï¼‰ Bitmap Heap Scanï¼ˆä¸­é—´çŠ¶æ€ï¼‰ 15. ä»€ä¹ˆæ—¶å€™éœ€è¦ç´¢å¼•ï¼Ÿï¼ˆå®æˆ˜å»ºè®®ï¼‰ âœ… ä¸šåŠ¡å¸¸ç”¨çš„å­—æ®µ\nâœ… WHERE ä¸­å‡ºç°çš„å­—æ®µ\nâœ… JOIN å…³è”å­—æ®µ\nâœ… ORDER BY æ’åºå­—æ®µ\nâœ… GROUP BY å­—æ®µ\nâœ… å”¯ä¸€æ€§çº¦æŸå­—æ®µ\nâœ… é«˜é¢‘æŸ¥è¯¢çš„ JSONB å­—æ®µ\nâŒ ä¸å¸¸ç”¨å­—æ®µä¸è¦å»ºç´¢å¼•\nâŒ DML é«˜è¡¨ä¸è¦éšä¾¿å¢åŠ è¿‡å¤šç´¢å¼•ï¼ˆå½±å“å†™å…¥ï¼‰\n16. å®æˆ˜ï¼šä½ çš„åœºæ™¯ç´¢å¼•æ¨è ä½ å½“å‰çš„æ•°æ®æ¨¡å‹ï¼ˆashare, plate_data, news ç­‰ï¼‰ï¼Œæ¨èï¼š\n1. è‚¡ç¥¨ code æ˜¯ä¸»é”® -\u0026gt; å¿…é¡»ç´¢å¼• CREATE UNIQUE INDEX idx_ashare_code ON ashare(code); 2. æŒ‰æ—¥æœŸæŸ¥è¯¢ CREATE INDEX idx_up_resaon_date ON up_resaon(date); 3. code + date æŸ¥è¯¢ CREATE INDEX idx_up_resaon_code_date ON up_resaon(code, date); 4. å‰ç¼€ name æŸ¥è¯¢ å¦‚æœè¦æ”¯æŒæ¨¡ç³Šæœç´¢ï¼š\nCREATE INDEX idx_trgm_ashare_name ON ashare USING GIN (name gin_trgm_ops); 5. å¤§è¡¨ï¼ˆ100M+ï¼‰å»ºè®® BRIN + æ‰©å±•è¡¨ï¼ˆTimescaleDBï¼‰ ","description":" 1. ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ç´¢å¼•ï¼Ÿ ç´¢å¼• = åŠ é€Ÿ WHEREã€JOINã€ORDER BYã€GROUP BY çš„ç»“æ„\næœ¬è´¨æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ˆé€šå¸¸æ˜¯ B-Treeï¼‰ï¼Œå¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½è¡Œã€‚\næœ‰ç´¢å¼• -\u0026gt; æŸ¥å°‘é‡è¡Œï¼ˆlogNï¼‰ æ²¡ç´¢å¼• -\u0026gt; æ‰«ææ•´å¼ è¡¨ï¼ˆO(N)ï¼‰ 2. PostgreSQL æ”¯æŒå“ªäº›ç´¢å¼•ï¼Ÿ ç±»å‹ é€‚ç”¨åœºæ™¯ æ˜¯å¦å¸¸ç”¨ B-Treeï¼ˆé»˜è®¤ï¼‰ æŸ¥è¯¢ã€æ’åºã€èŒƒå›´æŸ¥è¯¢ï¼ˆ=ã€\u0026gt;ã€\u0026lt;ã€BETWEENã€LIKE \u0026lsquo;abc%\u0026rsquo;ï¼‰ â­â­â­â­â­ æœ€å¸¸ç”¨ Hash ç­‰å€¼æŸ¥è¯¢ (=) â­ï¼ˆä¸€èˆ¬ç”¨ B-Tree æ›¿ä»£ï¼‰ GIN JSONBã€å…¨æ–‡æ£€ç´¢ã€æ•°ç»„ @\u0026gt; â­â­â­â­ GiST åœ°ç†ä½ç½®ã€å…¨æ–‡æ£€ç´¢ã€æ¨¡ç³ŠåŒ¹é… â­â­â­ BRIN å¤§å‹æŒ‰æ—¶é—´é¡ºåºçš„è¡¨ï¼ˆäº¿çº§æ•°æ®ï¼‰ â­â­â­â­â­ å¤§åº“ç¥å™¨ SP-GiST T-Treeã€QuadTree ç­‰ç‰¹æ®Šåœºæ™¯ â­ 3. B-Tree ç´¢å¼•ï¼ˆæœ€å¸¸ç”¨ï¼‰ åˆ›å»ºæ™®é€šç´¢å¼•\n"},{"id":387,"href":"/database/postgres/column-length/","title":"PostgreSQL ç»Ÿè®¡å­—æ®µæœ€å¤§é•¿åº¦çš„æ–¹æ³•","parent":"PostgreSQL","content":" ç»Ÿè®¡å­—ç¬¦é•¿åº¦ (Character Length) ä½¿ç”¨ LENGTH() å‡½æ•°ï¼š\nSELECT MAX(LENGTH(your_column)) AS max_char_length FROM your_table; æ­¤æ–¹æ³•è®¡ç®—å­—ç¬¦æ•°ï¼Œå¯¹å¤šå­—èŠ‚å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ï¼‰æŒ‰ä¸€ä¸ªå­—ç¬¦è®¡ç®—ã€‚\nç»Ÿè®¡å­—èŠ‚é•¿åº¦ (Byte Length) ä½¿ç”¨ OCTET_LENGTH() å‡½æ•°ï¼ˆæˆ– LENGTH(column_name, \u0026lsquo;bytes\u0026rsquo;) åœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­ï¼‰ï¼š\nSELECT MAX(OCTET_LENGTH(your_column)) AS max_byte_length FROM your_table; æ­¤æ–¹æ³•è¿”å›å ç”¨çš„å­—èŠ‚æ•°ï¼Œæ›´ç²¾ç¡®åœ°åæ˜ å­˜å‚¨å¤§å°ã€‚\nè·å–å®é™…ç‰©ç†å­˜å‚¨å¤§å°ï¼ˆåŒ…æ‹¬TOASTå¼€é”€ï¼‰ ä½¿ç”¨ PG_COLUMN_SIZE() å‡½æ•°ï¼š\nSELECT MAX(PG_COLUMN_SIZE(your_column)) AS max_storage_size FROM your_table; è¿™ä¼šè¿”å›è¯¥åˆ—å€¼åœ¨ç£ç›˜ä¸Šçš„å®é™…å¤§å°ï¼ˆåŒ…æ‹¬TOASTæŒ‡é’ˆå’Œå‹ç¼©å¼€é”€ï¼‰ï¼Œæ˜¯æ•°æ®åº“ç®¡ç†ä¸­æœ€æ¥è¿‘çœŸå®ç‰©ç†å­˜å‚¨çš„åº¦é‡ã€‚\nç¤ºä¾‹ -- å‡è®¾è¡¨ articles æœ‰ä¸€ä¸ª varchar ç±»å‹çš„ title åˆ— SELECT MAX(LENGTH(title)) AS max_chars, MAX(OCTET_LENGTH(title)) AS max_bytes, MAX(PG_COLUMN_SIZE(title)) AS max_physical_bytes FROM articles; ","description":" ç»Ÿè®¡å­—ç¬¦é•¿åº¦ (Character Length) ä½¿ç”¨ LENGTH() å‡½æ•°ï¼š\nSELECT MAX(LENGTH(your_column)) AS max_char_length FROM your_table; æ­¤æ–¹æ³•è®¡ç®—å­—ç¬¦æ•°ï¼Œå¯¹å¤šå­—èŠ‚å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ï¼‰æŒ‰ä¸€ä¸ªå­—ç¬¦è®¡ç®—ã€‚\nç»Ÿè®¡å­—èŠ‚é•¿åº¦ (Byte Length) ä½¿ç”¨ OCTET_LENGTH() å‡½æ•°ï¼ˆæˆ– LENGTH(column_name, \u0026lsquo;bytes\u0026rsquo;) åœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­ï¼‰ï¼š\nSELECT MAX(OCTET_LENGTH(your_column)) AS max_byte_length FROM your_table; æ­¤æ–¹æ³•è¿”å›å ç”¨çš„å­—èŠ‚æ•°ï¼Œæ›´ç²¾ç¡®åœ°åæ˜ å­˜å‚¨å¤§å°ã€‚\nè·å–å®é™…ç‰©ç†å­˜å‚¨å¤§å°ï¼ˆåŒ…æ‹¬TOASTå¼€é”€ï¼‰ ä½¿ç”¨ PG_COLUMN_SIZE() å‡½æ•°ï¼š\n"},{"id":388,"href":"/database/postgres/operation/","title":"PostgreSQL è¿ç»´","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ â€œPostgreSQL è¿ç»´ï¼ˆProduction è¿ç»´æœ€ä½³å®è·µ + æŒ‡æ ‡ä½“ç³» + æ•…éšœæ’æŸ¥ï¼‰æœ€å…¨æŒ‡å—â€ï¼Œä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡ï¼ˆé€‚åˆå¤§é‡æŸ¥è¯¢ã€è¡¨åˆ†åŒºã€TimescaleDBã€Zabbix ç›‘æ§ã€FastAPI é¡¹ç›®ç­‰ï¼‰ã€‚\nåˆ†ä¸º 9 å¤§éƒ¨åˆ†ï¼š\nPostgreSQL è¿è¡Œæœºåˆ¶ä¸æ–‡ä»¶ç»“æ„ æ—¥å¸¸å…³é”®è¿ç»´ä»»åŠ¡ å¸¸è§å‚æ•°ä¼˜åŒ– æ€§èƒ½ç›‘æ§æŒ‡æ ‡ æ—¥å¿—åˆ†æä¸æ…¢æŸ¥è¯¢ é«˜å¯ç”¨ä¸å¤åˆ¶ å­˜å‚¨ä¸è¡¨è†¨èƒ€ç®¡ç†ï¼ˆVACUUMï¼‰ æ€§èƒ½æ’æŸ¥æ€è·¯ è¿ç»´æœ€ä½³å®è·µæ€»è¡¨ 1. PostgreSQL è¿è¡Œæœºåˆ¶ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 1.1 å¤šè¿›ç¨‹ç»“æ„ ä½¿ç”¨ â€œ1 è¿æ¥ = 1 è¿›ç¨‹â€ æ¨¡å‹ï¼š\npostgres â”œâ”€â”€ checkpointer â”œâ”€â”€ walwriter â”œâ”€â”€ background writer â”œâ”€â”€ autovacuum launcher â”œâ”€â”€ logical replication launcher â””â”€â”€ æ¯ä¸ª client è¿æ¥ä¸€ä¸ª postgres è¿›ç¨‹ æ— åƒ MySQL ä¸€æ ·çš„çº¿ç¨‹æ± ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨ PgBouncerã€‚\n1.2 æ ¸å¿ƒç›®å½•ç»“æ„ PGDATAï¼š\n/var/lib/postgresql/17/main/ â”œâ”€â”€ base/ # è¡¨æ•°æ®æ–‡ä»¶ â”œâ”€â”€ global/ # å…¨å±€å…ƒæ•°æ® â”œâ”€â”€ pg_wal/ # WAL æ—¥å¿— â”œâ”€â”€ pg_stat/ # è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯ â”œâ”€â”€ pg_xact/ # äº‹åŠ¡æäº¤çŠ¶æ€ â”œâ”€â”€ postgresql.conf # ä¸»é…ç½® â””â”€â”€ pg_hba.conf # æƒé™é…ç½® WALï¼ˆWrite Ahead Logï¼‰\nPostgres æ‰€æœ‰ä¿®æ”¹å¿…é¡»å…ˆå†™ WALï¼Œä¿è¯ ACID æŒä¹…æ€§ã€‚\n2. PostgreSQL æ—¥å¸¸è¿ç»´ä»»åŠ¡ æ—¥å¸¸ä»»åŠ¡åˆ—è¡¨\nä»»åŠ¡ è¯´æ˜ ç›‘æ§è¿æ¥æ•° é˜²æ­¢çˆ†æ»¡ ç›‘æ§ autovacuum æœ€é‡è¦ æ£€æŸ¥è†¨èƒ€ï¼ˆbloatï¼‰ å¤§è¡¨è†¨èƒ€ä¸¥é‡ä¼šæ€§èƒ½ä¸‹é™ åˆ†ææ…¢æŸ¥è¯¢ explain / auto_explain é˜¶æ®µæ€§ ANALYZE ä¿è¯ä¼˜åŒ–å™¨å‡†ç¡® å¤‡ä»½ pg_dump / pg_basebackup ä¸»ä»å¤åˆ¶ç›‘æ§ å»¶è¿Ÿã€æ–­é“¾ ç£ç›˜ç©ºé—´æ£€æŸ¥ pg_wal å¯èƒ½çˆ†ç‚¸ 3. PostgreSQL æ€§èƒ½æ ¸å¿ƒå‚æ•°è°ƒä¼˜ï¼ˆå®æˆ˜é…ç½®ï¼‰ ä»¥ä¸‹æ˜¯ 2G~32G RAM çš„é€šç”¨è°ƒä¼˜ï¼ˆæ¯”é»˜è®¤å¥½ 10xï¼‰ã€‚\n3.1 å†…å­˜ç›¸å…³ shared_buffers PostgreSQL çš„æ•°æ®åº“ç¼“å­˜ï¼ˆä¸æ˜¯ OS Cacheï¼‰\nä¸€èˆ¬è®¾ä¸º 25% å†…å­˜\n2G æœºå™¨ -\u0026gt; 512MB 16G æœºå™¨ -\u0026gt; 4GB work_mem å•ä¸ªæ’åº / å“ˆå¸Œæ“ä½œçš„ä¸´æ—¶å†…å­˜ï¼Œå¤ªå¤§ä¼šçˆ†å†…å­˜\nå¸¸è§å€¼ï¼š\nwork_mem = 32MB æˆ– 64MB å¦‚æœæœ‰å¤§é‡å¹¶è¡Œæ’åºï¼Œåº”é™ä½ã€‚\nmaintenance_work_mem VACUUM / CREATE INDEX çš„å†…å­˜\nå¯è®¾å¤§ä¸€ç‚¹ï¼š\nmaintenance_work_mem = 1GB 3.2 WAL ç›¸å…³ wal_level = replica max_wal_size = 4GB~16GB min_wal_size = 1GB checkpoint_timeout = 10min é¿å…é¢‘ç¹ checkpointï¼ˆæ˜‚è´µï¼‰ã€‚\n3.3 è‡ªåŠ¨æ¸…ç†ï¼ˆautovacuumï¼‰ æœ€é‡è¦å‚æ•°ä¹‹ä¸€ï¼š\nautovacuum = on autovacuum_vacuum_scale_factor = 0.1 autovacuum_analyze_scale_factor = 0.05 autovacuum_max_workers = 5 autovacuum_naptime = 10s å¤§è¡¨å¯å•ç‹¬é…ç½®ï¼š\nALTER TABLE up_resaon SET (autovacuum_vacuum_scale_factor = 0.02); 4. PostgreSQL ç›‘æ§æŒ‡æ ‡ï¼ˆZabbixã€Prometheus å¿…å¤‡ï¼‰ å…³é”®æŒ‡æ ‡ï¼š\n4.1 è¿æ¥çŠ¶æ€ SELECT * FROM pg_stat_activity; è¦ç›‘æ§ï¼š\nactive è¿‡å¤š idle in transactionï¼ˆæœ€å¤§é—®é¢˜ï¼‰ waitingï¼ˆé”ç­‰å¾…ï¼‰ 4.2 é”ç­‰å¾… SELECT * FROM pg_locks; æœ‰æ­»é”å¿…é¡»å¤„ç†ã€‚\n4.3 autovacuum çŠ¶æ€ SELECT * FROM pg_stat_user_tables; é‡ç‚¹å­—æ®µï¼š\nn_dead_tupï¼ˆæ­»è¡Œæ•°é‡ï¼‰ last_autovacuum vacuum_count æ­»è¡Œå¤ªå¤š -\u0026gt; æ€§èƒ½ä¸‹é™ã€‚\n4.4 è¡¨è†¨èƒ€ï¼ˆBloatï¼‰ pgstattuple pg_bloat_check() è†¨èƒ€ä¸¥é‡ä¼šå½±å“æŸ¥è¯¢é€Ÿåº¦ã€‚\n5. PostgreSQL æ—¥å¿—ä¸æ…¢æŸ¥è¯¢åˆ†æ 5.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— log_min_duration_statement = 500ms åˆ†ææ…¢ SQLï¼š\nEXPLAIN ANALYZE \u0026lt;SQL\u0026gt;; 5.2 auto_explain è‡ªåŠ¨è®°å½•æ…¢æ‰§è¡Œè®¡åˆ’ï¼š\nshared_preload_libraries = \u0026#39;auto_explain\u0026#39; auto_explain.log_analyze = on auto_explain.log_min_duration = 500ms å®é™…è¿ç»´éå¸¸ç®¡ç”¨ã€‚\n6. PostgreSQL é«˜å¯ç”¨ï¼ˆHAï¼‰ æœ€æ¨èæ–¹æ¡ˆï¼ˆä¼ä¸šçº§ï¼‰ï¼š\nPatroni + etcd + HAProxy è‡ªåŠ¨ failover ä¸€è‡´æ€§é«˜ ä¼ä¸šä½¿ç”¨æœ€å¤š åŸç”Ÿæµå¤åˆ¶ï¼ˆStreaming Replicationï¼‰ primary \u0026lt;-- WAL --\u0026gt; replica å¤åˆ¶ç±»å‹ï¼š\nåŒæ­¥å¤åˆ¶ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ å¼‚æ­¥å¤åˆ¶ï¼ˆé«˜æ€§èƒ½ï¼‰ é€»è¾‘å¤åˆ¶ï¼ˆLogical Replicationï¼‰ æ”¯æŒæŒ‰è¡¨ã€æŒ‰è¡Œè¿‡æ»¤ï¼Œæ›´çµæ´»ã€‚\n7. è¡¨è†¨èƒ€ã€VACUUM ä¸å­˜å‚¨ç®¡ç† PostgreSQL æœ€å¤§çš„è¿ç»´æˆæœ¬å°±æ˜¯ è†¨èƒ€ï¼ˆbloatï¼‰å¤„ç†ã€‚\n7.1 VACUUM æœºåˆ¶ ç±»å‹ ä½œç”¨ VACUUM æ¸…ç†æ­»è¡Œ VACUUM FULL è¡¨é‡å†™ï¼ˆä¼šé”è¡¨ï¼‰ AUTOVACUUM è‡ªåŠ¨æ¸…ç† ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ‰‹åŠ¨æ‰§è¡Œ VACUUM FULLï¼ˆä¼šé˜»å¡å†™å…¥ï¼‰\né™¤éç£ç›˜ç©ºé—´ä¸å¤Ÿã€‚\n8. PostgreSQL æ€§èƒ½æ’æŸ¥æ€è·¯ï¼ˆæœ€é‡è¦ï¼‰ ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š\n1ï¼‰æ£€æŸ¥è¿æ¥æ•°/é˜»å¡ SELECT * FROM pg_stat_activity; ç‰¹åˆ«å…³æ³¨ï¼š\nidle in transaction waiting é” query æŒç»­æ—¶é—´ 2ï¼‰æ£€æŸ¥é”ç«äº‰ SELECT * FROM pg_locks; 3ï¼‰æŸ¥çœ‹æ…¢ SQL é€šè¿‡æ—¥å¿— é€šè¿‡ auto_explain é€šè¿‡ pg_stat_statementsï¼ˆå¼ºçƒˆæ¨èï¼‰ CREATE EXTENSION pg_stat_statements; 4ï¼‰æ£€æŸ¥æ‰§è¡Œè®¡åˆ’ EXPLAIN ANALYZE SQL; é‡ç‚¹å…³æ³¨ï¼š\né¡ºåºæ‰«æï¼ˆSeq Scanï¼‰ è¡Œæ•°ä¼°è®¡åå·®ï¼ˆrows vs actual rowsï¼‰ å¤§æ’åº / å“ˆå¸Œ 5ï¼‰æ£€æŸ¥è†¨èƒ€ pg_bloat_check() 6ï¼‰æ£€æŸ¥ autovacuum æ˜¯å¦æ­£å¸¸è¿è¡Œ 9. PostgreSQL è¿ç»´æœ€ä½³å®è·µï¼ˆæ€»ç»“ç‰ˆï¼‰ é»˜è®¤ä½¿ç”¨ textï¼Œè€Œä¸æ˜¯ varchar(n) JSON ä¸€å¾‹ä½¿ç”¨ jsonb è¡¨è¾¾åˆ°åƒä¸‡çº§ï¼Œå¼€å¯åˆ†åŒº æ—¶åºæ•°æ® -\u0026gt; ä½¿ç”¨ TimescaleDBï¼ˆä½ å½“å‰åœºæ™¯éå¸¸é€‚åˆï¼‰ å¿…é¡»éƒ¨ç½²è¿æ¥æ±  PgBouncer æ‰“å¼€ pg_stat_statements æ¯å¤©æ£€æŸ¥ autovacuum å¤‡åº“ç›‘æ§ WAL å»¶è¿Ÿ å‹¿éšæ„ VACUUM FULL WAL å•ç‹¬æ”¾ SSD å· å¤§è¡¨åˆ›å»ºç´¢å¼•æ—¶ä½¿ç”¨ CONCURRENTLY é«˜é¢‘å†™å…¥è¡¨ä¸è¦åˆ›å»ºå¤ªå¤šç´¢å¼• JOIN å­—æ®µå¿…é¡»ç´¢å¼• é¿å…é•¿äº‹åŠ¡ï¼ˆidle in transactionï¼‰ ","description":"ä¸‹é¢æ˜¯ â€œPostgreSQL è¿ç»´ï¼ˆProduction è¿ç»´æœ€ä½³å®è·µ + æŒ‡æ ‡ä½“ç³» + æ•…éšœæ’æŸ¥ï¼‰æœ€å…¨æŒ‡å—â€ï¼Œä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡ï¼ˆé€‚åˆå¤§é‡æŸ¥è¯¢ã€è¡¨åˆ†åŒºã€TimescaleDBã€Zabbix ç›‘æ§ã€FastAPI é¡¹ç›®ç­‰ï¼‰ã€‚\nåˆ†ä¸º 9 å¤§éƒ¨åˆ†ï¼š\nPostgreSQL è¿è¡Œæœºåˆ¶ä¸æ–‡ä»¶ç»“æ„ æ—¥å¸¸å…³é”®è¿ç»´ä»»åŠ¡ å¸¸è§å‚æ•°ä¼˜åŒ– æ€§èƒ½ç›‘æ§æŒ‡æ ‡ æ—¥å¿—åˆ†æä¸æ…¢æŸ¥è¯¢ é«˜å¯ç”¨ä¸å¤åˆ¶ å­˜å‚¨ä¸è¡¨è†¨èƒ€ç®¡ç†ï¼ˆVACUUMï¼‰ æ€§èƒ½æ’æŸ¥æ€è·¯ è¿ç»´æœ€ä½³å®è·µæ€»è¡¨ 1. PostgreSQL è¿è¡Œæœºåˆ¶ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 1.1 å¤šè¿›ç¨‹ç»“æ„ ä½¿ç”¨ â€œ1 è¿æ¥ = 1 è¿›ç¨‹â€ æ¨¡å‹ï¼š\n"},{"id":389,"href":"/database/postgres/operation-best-practices/","title":"PostgreSQL è¿ç»´æœ€ä½³å®è·µ","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ ä½“ç³»åŒ–ã€ç”Ÿäº§å¯è½åœ°çš„ PostgreSQL è¿ç»´æœ€ä½³å®è·µï¼Œè¦†ç›–å®‰è£…ã€é…ç½®ã€ç›‘æ§ã€å¤‡ä»½ã€æ€§èƒ½ã€å®¹é‡ã€å®‰å…¨ã€é«˜å¯ç”¨ç­‰å…³é”®å†…å®¹ã€‚å†…å®¹éå¸¸å®ç”¨ï¼Œé€‚åˆæ–°å»ºç”Ÿäº§é›†ç¾¤æˆ–ä¼˜åŒ–ç°æœ‰é›†ç¾¤ã€‚\nç›®å½•ï¼š\nç³»ç»Ÿå±‚é¢ å®‰è£…ä¸ç›®å½•è§„åˆ’ é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ è¿æ¥ç®¡ç† æ€§èƒ½ä¼˜åŒ–ï¼ˆCPU/å†…å­˜/IOï¼‰ ç»Ÿè®¡ä¿¡æ¯ä¸ Vacuum ç»´æŠ¤ ç›‘æ§ä¸å‘Šè­¦ æ—¥å¿—ç®¡ç† å¤‡ä»½ä¸æ¢å¤ å®‰å…¨ é«˜å¯ç”¨ï¼ˆHAï¼‰ æ‰©å±•ä¸æ’ä»¶ç®¡ç† å¸¸è§è¿ç»´å‘½ä»¤ æ—¥å¸¸è¿ç»´ checklist 1. ğŸ–¥ï¸ ç³»ç»Ÿå±‚é¢æœ€ä½³å®è·µ æ“ä½œç³»ç»Ÿ\né¡¹ æœ€ä½³å®è·µ Linux å‘è¡Œç‰ˆ Debian/Ubuntuã€RHEL/AlmaLinux/Rocky è¿è¡Œç”¨æˆ· ä½¿ç”¨ç‹¬ç«‹ç”¨æˆ· postgres æ—¶é’Ÿ chrony åŒæ­¥æ—¶é—´ï¼Œé¿å…ä¸»å¤‡æ¼‚ç§» I/O è°ƒåº¦ deadlineï¼ˆSASï¼‰ã€noneï¼ˆNVMeï¼‰ æ–‡ä»¶ç³»ç»Ÿ xfs æˆ– ext4 Swappiness vm.swappiness = 1ï¼ˆé¿å…æ¢å‡ºï¼‰ Hugepage å»ºè®®å…³é—­ï¼ˆé™¤é PostgreSQL å¤§å…±äº«å†…å­˜é…ç½®åœºæ™¯ï¼‰ 2. ğŸ“ ç›®å½•ç»“æ„è§„åˆ’ /data/postgresql/ â”œâ”€â”€ data/ # PGDATA â”œâ”€â”€ wal/ # WAL ç‹¬ç«‹ç›˜å¼ºçƒˆå»ºè®® â”œâ”€â”€ backup/ # å¤‡ä»½ â””â”€â”€ log/ # æ—¥å¿— **WAL å¼ºçƒˆå»ºè®®æ”¾ç‹¬ç«‹ SSD/NVMeï¼Œ**æå‡äº‹åŠ¡ååã€‚\n3. âš™ï¸ PostgreSQL é…ç½®æœ€ä½³å®è·µ ä»¥ä¸‹ä»¥ PostgreSQL 14â€“17 é€šç”¨é…ç½®ä¸ºä¸»ã€‚\n3.1 åŸºç¡€é…ç½® shared_buffers = 25% RAM work_mem = 64MB maintenance_work_mem = 1GB wal_level = replica max_wal_size = 8GB checkpoint_timeout = 15min effective_cache_size = 70% RAM è§£é‡Šï¼š\nshared_buffers 25% æ˜¯ç»éªŒå€¼ effective_cache_size å‘Šè¯‰ä¼˜åŒ–å™¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜å®¹é‡ work_mem è¿‡å¤§ä¼šå¯¼è‡´ OOMï¼ˆå·¨å‘ï¼‰ 3.2 WAL \u0026amp; checkpoint max_wal_size = 8GB min_wal_size = 2GB checkpoint_completion_target = 0.9 ä¿è¯ checkpoint å¹³æ»‘ï¼Œä¸é˜»å¡ã€‚\n3.3 å¹¶å‘/è¿æ¥æ±  ä¸è¦ç”¨ PostgreSQL ä½œä¸ºè¿æ¥æ± ã€‚\nmax_connections = 200 å¦‚æœä¸šåŠ¡å¾ˆå¤šï¼š\nä½¿ç”¨ PGBouncerï¼ˆå¼ºçƒˆæ¨èï¼‰\n3.4 Autovacuum é…ç½® autovacuum = on autovacuum_vacuum_cost_limit = -1 autovacuum_max_workers = 4 å¦‚æœé«˜æ›´æ–°é‡ç³»ç»Ÿï¼š\nautovacuum_vacuum_scale_factor = 0.1 autovacuum_analyze_scale_factor = 0.05 4. âš¡ æ€§èƒ½ä¼˜åŒ–ï¼ˆCPU / å†…å­˜ / ç£ç›˜ï¼‰ 4.1 CPU PostgreSQL æ˜¯å•çº¿ç¨‹æ‰§è¡ŒæŸ¥è¯¢ï¼Œè·¨æŸ¥è¯¢å¹¶è¡Œ æå‡æ€§èƒ½çš„æ–¹æ³•ï¼š æå‡ CPU ä¸»é¢‘ å¢åŠ å¹¶è¡Œé…ç½®ï¼š max_parallel_workers = 8 max_parallel_workers_per_gather = 4 4.2 å†…å­˜ shared_buffers = 25% work_mem ä¸è¦è®¾ç½®å¤ªé«˜ï¼ˆæ¯ä¸ªæ’åºéƒ½ç”¨ä¸€æ¬¡ï¼‰ å¤§å‘æ¡ˆä¾‹ï¼š\nwork_mem=512MBï¼ŒSQL åŒæ—¶ 20 æ¡å¹¶è¡Œ -\u0026gt; å†…å­˜é£™å‡è‡³ 10GB -\u0026gt; OOM -\u0026gt; PostgreSQL å´©æºƒã€‚ 4.3 ç£ç›˜ WAL å†™å…¥ååè¾ƒé«˜ï¼šå»ºè®® NVMe æ•°æ®ç›®å½•å¯ä½¿ç”¨ RAID10 æˆ– NVMe Filesystemï¼šXFS \u0026gt; EXT4 5. ğŸ§¹ Vacuum / Autovacuum / Freeze ç»´æŠ¤ è¿™éƒ¨åˆ†æ˜¯ PostgreSQL è¿ç»´æ ¸å¿ƒã€‚\n5.1 ä¸ºä»€ä¹ˆéœ€è¦ Vacuumï¼Ÿ PostgreSQL æ˜¯ MVCC update/delete ä¸ç«‹å³åˆ é™¤æ—§æ•°æ® é•¿æ—¶é—´ä¸ Vacuum -\u0026gt; è¡¨è†¨èƒ€ -\u0026gt; æ€§èƒ½æš´è·Œ 5.2 å®šæœŸ Vacuum æ‰‹åŠ¨å·¡æ£€ VACUUM VERBOSE table; ANALYZE table; 5.3 æ£€æŸ¥è†¨èƒ€ç‡ æ‰©å±•ï¼špgstattuple\nSELECT * FROM pgstattuple(\u0026#39;mytable\u0026#39;); 6. ğŸ“ˆ ç›‘æ§ä¸å‘Šè­¦ æ¨èç›‘æ§ç³»ç»Ÿï¼šPrometheus + Grafana + postgres_exporter\nå…³é”®æŒ‡æ ‡ï¼š\nç±»åˆ« æŒ‡æ ‡ è¿æ¥ active connectionsã€idle in transaction é” lock timeã€deadlocks WAL write rateã€replication lag Autovacuum freeze ageã€running workers IO read/write latency äº‹åŠ¡ TPSã€XID ä½¿ç”¨æƒ…å†µ 7. ğŸ“œ æ—¥å¿—æœ€ä½³å®è·µ logging_collector = on log_directory = \u0026#39;log\u0026#39; log_filename = \u0026#39;postgresql-%Y-%m-%d.log\u0026#39; log_min_duration_statement = 500ms log_checkpoints = on log_connections = on log_disconnections = on log_lock_waits = on æ—¥å¿—å¿…é¡»è½®è½¬ï¼ˆlogrotateï¼‰ã€‚\n8. ğŸ” å®‰å…¨æœ€ä½³å®è·µ 8.1 ç½‘ç»œå®‰å…¨ listen_addresses = \u0026#39;0.0.0.0\u0026#39; pg_hba.conf é…ç½®åŸºäº IP + SSL\n8.2 æƒé™ç®¡ç† ä¸šåŠ¡åº“å¿…é¡»ç‹¬ç«‹ç”¨æˆ· ç¦æ­¢ä½¿ç”¨è¶…çº§ç”¨æˆ·æ“ä½œä¸šåŠ¡ é‡è¦è¡¨åªè¯»/å†™åˆ†ç¦»æƒé™ 9. ğŸ’¾ å¤‡ä»½ä¸æ¢å¤ï¼ˆæ ¸å¿ƒï¼‰ 9.1 å…¨é‡å¤‡ä»½ pg_dump pg_basebackup 9.2 å¢é‡å¤‡ä»½ï¼ˆWALï¼‰ ä½¿ç”¨ï¼š\npgBackRestï¼ˆæœ€æ¨èï¼‰ WAL-G 9.3 PITRï¼ˆæŒ‰æ—¶é—´ç‚¹æ¢å¤ï¼‰ restore_command = \u0026#39;cp /backup/wal/%f %p\u0026#39; 10. ğŸ’  é«˜å¯ç”¨ï¼ˆHAï¼‰æœ€ä½³å®è·µ æ¨èæ–¹æ¡ˆ ï¼ˆç”Ÿäº§ä¼˜å…ˆçº§æ’åˆ—ï¼‰ï¼š\n10.1 Patroni + Etcd/Consulï¼ˆæœ€å¼ºæ¨èï¼‰ è‡ªåŠ¨ failover è‡ªåŠ¨ leader é€‰ä¸¾ æ”¯æŒå¤åˆ¶æ§½ ç”Ÿäº§ BAT / é‡‘èå¤§é‡ä½¿ç”¨ 10.2 Stolon è½»é‡çº§ HA ç®¡ç†å™¨\n10.3 æ‰‹å·¥æµå¤åˆ¶ï¼ˆé€‚åˆå°å‹ç³»ç»Ÿï¼‰ primary_conninfo = \u0026#39;host=... user=replica\u0026#39; 11. ğŸ§© æ‰©å±•ä¸æ’ä»¶ç®¡ç† å¸¸ç”¨æ‰©å±•ï¼š\npg_stat_statements pgstattuple uuid-ossp citext hstore ltree å¯ç”¨ï¼š\nCREATE EXTENSION pg_stat_statements; 12. ğŸ”§ å¸¸è§è¿ç»´å‘½ä»¤ é‡è½½é…ç½®ï¼ˆä¸é‡å¯ï¼‰\nSELECT pg_reload_conf(); æŸ¥çœ‹å½“å‰é…ç½®\nSHOW ALL; æŸ¥çœ‹è¿æ¥\nSELECT * FROM pg_stat_activity; ç»ˆæ­¢è¿æ¥\nSELECT pg_terminate_backend(pid); 13. ğŸ“‹ æ—¥å¸¸è¿ç»´ Checklistï¼ˆå¯ç›´æ¥ç”¨äºç”Ÿäº§ SOPï¼‰ æ¯å¤©\næ£€æŸ¥è¿æ¥æ•°ã€é” æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ æ£€æŸ¥ç£ç›˜å‰©ä½™ç©ºé—´ æ¯å‘¨\næ‰‹åŠ¨ vacuum å¤§è¡¨ æ£€æŸ¥ autovacuum æƒ…å†µ æ£€æŸ¥ XID wraparound é£é™© æ¯æœˆ\næ‰§è¡Œå…¨åº“ ANALYZE æ¸…ç†æ—§ WALã€æ—§å¤‡ä»½ ä¾èµ–æ‰©å±•æ›´æ–°/ç‰ˆæœ¬æ£€æŸ¥ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ ä½“ç³»åŒ–ã€ç”Ÿäº§å¯è½åœ°çš„ PostgreSQL è¿ç»´æœ€ä½³å®è·µï¼Œè¦†ç›–å®‰è£…ã€é…ç½®ã€ç›‘æ§ã€å¤‡ä»½ã€æ€§èƒ½ã€å®¹é‡ã€å®‰å…¨ã€é«˜å¯ç”¨ç­‰å…³é”®å†…å®¹ã€‚å†…å®¹éå¸¸å®ç”¨ï¼Œé€‚åˆæ–°å»ºç”Ÿäº§é›†ç¾¤æˆ–ä¼˜åŒ–ç°æœ‰é›†ç¾¤ã€‚\nç›®å½•ï¼š\nç³»ç»Ÿå±‚é¢ å®‰è£…ä¸ç›®å½•è§„åˆ’ é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ è¿æ¥ç®¡ç† æ€§èƒ½ä¼˜åŒ–ï¼ˆCPU/å†…å­˜/IOï¼‰ ç»Ÿè®¡ä¿¡æ¯ä¸ Vacuum ç»´æŠ¤ ç›‘æ§ä¸å‘Šè­¦ æ—¥å¿—ç®¡ç† å¤‡ä»½ä¸æ¢å¤ å®‰å…¨ é«˜å¯ç”¨ï¼ˆHAï¼‰ æ‰©å±•ä¸æ’ä»¶ç®¡ç† å¸¸è§è¿ç»´å‘½ä»¤ æ—¥å¸¸è¿ç»´ checklist 1. ğŸ–¥ï¸ ç³»ç»Ÿå±‚é¢æœ€ä½³å®è·µ æ“ä½œç³»ç»Ÿ\né¡¹ æœ€ä½³å®è·µ Linux å‘è¡Œç‰ˆ Debian/Ubuntuã€RHEL/AlmaLinux/Rocky è¿è¡Œç”¨æˆ· ä½¿ç”¨ç‹¬ç«‹ç”¨æˆ· postgres æ—¶é’Ÿ chrony åŒæ­¥æ—¶é—´ï¼Œé¿å…ä¸»å¤‡æ¼‚ç§» I/O è°ƒåº¦ deadlineï¼ˆSASï¼‰ã€noneï¼ˆNVMeï¼‰ æ–‡ä»¶ç³»ç»Ÿ xfs æˆ– ext4 Swappiness vm.swappiness = 1ï¼ˆé¿å…æ¢å‡ºï¼‰ Hugepage å»ºè®®å…³é—­ï¼ˆé™¤é PostgreSQL å¤§å…±äº«å†…å­˜é…ç½®åœºæ™¯ï¼‰ 2. ğŸ“ ç›®å½•ç»“æ„è§„åˆ’ /data/postgresql/ â”œâ”€â”€ data/ # PGDATA â”œâ”€â”€ wal/ # WAL ç‹¬ç«‹ç›˜å¼ºçƒˆå»ºè®® â”œâ”€â”€ backup/ # å¤‡ä»½ â””â”€â”€ log/ # æ—¥å¿— **WAL å¼ºçƒˆå»ºè®®æ”¾ç‹¬ç«‹ SSD/NVMeï¼Œ**æå‡äº‹åŠ¡ååã€‚\n"},{"id":390,"href":"/database/postgres/locks/","title":"PostgreSQL é”","parent":"PostgreSQL","content":"å†…å®¹ï¼š\né”çš„ç§ç±»ï¼ˆè¡Œé” / è¡¨é” / äº‹åŠ¡é” / å…ƒæ•°æ®é”ï¼‰ é”æ˜¯å¦‚ä½•äº§ç”Ÿçš„ ä¸šåŠ¡ä¸­å¸¸è§çš„é”é—®é¢˜ å¦‚ä½•æ’æŸ¥ å¦‚ä½•é¿å…é˜»å¡ æœ€ä½³å®è·µ PostgreSQL 17 ç‰ˆæœ¬é€‚ç”¨ éå¸¸é€‚åˆ OLTPã€é«˜å¹¶å‘ã€ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸è¿ç»´ã€‚\n1. PostgreSQL é”çš„åˆ†ç±»æ€»è§ˆï¼ˆæ ¸å¿ƒçŸ¥è¯†ï¼‰ PostgreSQL é”åˆ†å››å¤§ç±»ï¼š\nç±»å‹ ç¤ºä¾‹ è¯´æ˜ è¡Œçº§é” Row-Level Locks SELECT â€¦ FOR UPDATE æœ€å¸¸ç”¨äºä¸šåŠ¡ï¼Œå½±å“å•è¡Œ è¡¨çº§é” Table-Level Locks LOCK TABLE â€¦ DDLã€å¹¶å‘å†™å…¥æ—¶å‡ºç° äº‹åŠ¡é” Transaction Locks å¯¹è±¡ç‰ˆæœ¬æ£€æŸ¥ MVCC å®ç° å…ƒæ•°æ®é” Catalog Locks ä¿®æ”¹è¡¨ç»“æ„æ—¶ ä¸é˜»å¡æ™®é€šæŸ¥è¯¢ è¡Œé”ä¸ä¼šé˜»å¡è¯»ï¼ˆPostgreSQL æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ï¼‰ã€‚\n2. PostgreSQL è¡Œçº§é”ï¼ˆä¸šåŠ¡ä¸­ä½¿ç”¨æœ€å¤šï¼‰ PostgreSQL MVCC + è¡Œé” = é«˜å¹¶å‘å¼ºä¸€è‡´æ€§ã€‚\n2.1 FOR UPDATE é”å®šè¡Œä»¥ä¾¿æ›´æ–°ï¼ˆå¸¸ç”¨äºæ‰£åº“å­˜ã€ä¿®æ”¹é‡‘é¢ï¼‰\nSELECT * FROM orders WHERE id = 100 FOR UPDATE; å…¶ä»–äº‹åŠ¡ï¼š\nâŒ ä¸èƒ½æ›´æ–°æ­¤è¡Œ âŒ ä¸èƒ½åˆ é™¤æ­¤è¡Œ âœ… å¯ä»¥è¯»ï¼ˆä½†è¯»åˆ°æ—§ç‰ˆæœ¬ï¼‰ 2.2 FOR NO KEY UPDATE æ¯” FOR UPDATE çš„å†²çªèŒƒå›´æ›´å°ã€‚\n2.3 FOR SHARE å…±äº«é”ï¼Œåªå…è®¸è¯»å–ï¼Œç”¨äºå¼ºä¸€è‡´æŸ¥è¯¢ã€‚\nSELECT * FROM accounts WHERE id = 1 FOR SHARE; 2.4 FOR KEY SHARE ä¿æŠ¤å¤–é”®çº¦æŸï¼ˆé˜²æ­¢çˆ¶è¡¨è¢«åˆ ï¼‰ã€‚\n2.5 SKIP LOCKEDï¼ˆé«˜å¹¶å‘é˜Ÿåˆ—ç¥å™¨ï¼‰ SELECT * FROM jobs WHERE status = \u0026#39;pending\u0026#39; FOR UPDATE SKIP LOCKED LIMIT 1; ç‰¹ç‚¹ï¼š\nä¸ç­‰å¾…é” å¿½ç•¥è¢«é”çš„è¡Œ è¶…é€‚åˆ ä»»åŠ¡é˜Ÿåˆ—æ¶ˆè´¹è€…ã€è®¢å•å¤„ç†ã€æŠ¢å•ç³»ç»Ÿ 3. è¡¨çº§é”ï¼ˆDDL æˆ–æ‰¹é‡ä¿®æ”¹è§¦å‘ï¼‰ æœ€å¸¸å‡ºç°å¯¼è‡´é˜»å¡çš„é”ç±»å‹ã€‚\nè¡¨é”ç­‰çº§ï¼ˆç”±å¼ºåˆ°å¼±ï¼‰\né”æ¨¡å¼ å¸¸ç”¨è¯­å¥ å½±å“ ACCESS EXCLUSIVE ALTER TABLEã€DROP é˜»å¡æ‰€æœ‰è¯»å†™ EXCLUSIVE ç½•è§ é˜»å¡å†™ SHARE ROW EXCLUSIVE CREATE INDEX CONCURRENTLY é˜»å¡å†™ï¼Œå…è®¸è¯» ROW SHARE / ROW EXCLUSIVE æ™®é€š UPDATE/DELETE å…è®¸å¹¶å‘è¯» ä¾‹ï¼šALTER TABLE ä¼šé˜»å¡æ‰€æœ‰æ“ä½œï¼š\nALTER TABLE users ADD COLUMN age INT; æ‰§è¡Œæ—¶ï¼š\næ‰€æœ‰å†™é˜»å¡ æ‰€æœ‰è¯»é˜»å¡ äº‹åŠ¡ç§¯å‹é£é™©ï¼ˆDeadlock Stormï¼‰ è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ LOCK TIMEOUT\nSET lock_timeout = \u0026#39;5s\u0026#39;; ALTER TABLE users ADD COLUMN age INT; 4. æ­»é” Deadlockï¼ˆä¸šåŠ¡æœ€å¸¸è§é—®é¢˜ï¼‰ PostgreSQL è‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ã€‚\næ­»é”å…¸å‹ç¤ºä¾‹ï¼š\näº‹åŠ¡ Aï¼š\nBEGIN; UPDATE accounts SET balance = balance - 100 WHERE id = 1; äº‹åŠ¡ Bï¼š\nBEGIN; UPDATE accounts SET balance = balance - 100 WHERE id = 2; A æ¥ç€ï¼š\nUPDATE accounts SET balance = balance + 100 WHERE id = 2; B æ¥ç€ï¼š\nUPDATE accounts SET balance = balance + 100 WHERE id = 1; ğŸ‘‰ äº’é”ï¼ŒPostgreSQL ä¼šè‡ªåŠ¨ä¸­æ­¢å…¶ä¸­ä¸€ä¸ª\nä¸šåŠ¡æœ€ä½³å®è·µé¿å…æ­»é”ï¼š\næŒ‰ç»Ÿä¸€é¡ºåºè®¿é—®è¡Œï¼ˆéå¸¸é‡è¦ï¼‰ äº‹åŠ¡å°½é‡çŸ­ é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ…¢æŸ¥è¯¢æˆ–å¤–éƒ¨è¯·æ±‚ åŠ é”é¡ºåºç»Ÿä¸€ï¼šæ¯”å¦‚ always lock smaller ID first 5. å¦‚ä½•æŸ¥çœ‹å½“å‰é”æƒ…å†µï¼ˆè¿ç»´æœ€å¸¸ç”¨ï¼‰ æŸ¥çœ‹é”ï¼š\nSELECT * FROM pg_locks; æŸ¥çœ‹é” + å¯¹åº” SQLï¼š\nSELECT a.pid, a.state, a.query, l.locktype, l.mode, l.granted FROM pg_locks l JOIN pg_stat_activity a ON l.pid = a.pid ORDER BY a.pid; 6. æŸ¥å‡ºé˜»å¡é“¾ï¼ˆç”Ÿäº§çº§æ’æŸ¥å¤§æ‹›ï¼‰ SELECT blocked_locks.pid AS blocked_pid, blocked_activity.query AS blocked_query, blocking_locks.pid AS blocking_pid, blocking_activity.query AS blocking_query FROM pg_locks blocked_locks JOIN pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid JOIN pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid JOIN pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid WHERE NOT blocked_locks.granted; 7. å¼ºåˆ¶å–æ¶ˆé˜»å¡çš„ä¼šè¯ SELECT pg_terminate_backend(12345); 8. å…¸å‹ä¸šåŠ¡é”åœºæ™¯æ€»ç»“ åœºæ™¯ æ¨èç”¨æ³• è¯´æ˜ æŠ¢è®¢å•ã€æŠ¢çº¢åŒ… FOR UPDATE SKIP LOCKED å¹¶å‘é«˜æ—¶æœ€ç¨³ æ‰£åº“å­˜ FOR UPDATE å¼ºä¸€è‡´ æ¶ˆè´¹é˜Ÿåˆ— FOR UPDATE SKIP LOCKED å¸¸ç”¨ è·å–æŸè¡Œæœ€æ–°çŠ¶æ€ FOR SHARE é˜»æ­¢è¢«åˆ«äººæ›´æ–° å®¡æ ¸æµç¨‹ FOR NO KEY UPDATE ä¸éœ€è¦é”ä¸»é”® å¤–é”®ä¿æŠ¤ FOR KEY SHARE æé«˜å¹¶å‘ å¹¶å‘æ’å…¥ upsertï¼ˆON CONFLICTï¼‰ é¿å…å”¯ä¸€é”®å†²çª æ‰¹é‡æ›´æ–° åˆ†æ‰¹ LIMIT + SKIP LOCKED é˜²æ­¢é•¿é” 9. ä¼˜åŒ–é”çš„æœ€ä½³å®è·µï¼ˆéå¸¸å…³é”®ï¼‰ 1. äº‹åŠ¡è¶ŠçŸ­è¶Šå¥½ ä¸è¦åœ¨äº‹åŠ¡é‡Œåšï¼š\nAPI è¯·æ±‚ ç½‘ç»œè¯·æ±‚ æ…¢æŸ¥è¯¢ äººå·¥ç­‰å¾… 2. æŒ‰å›ºå®šé¡ºåºè®¿é—®è¡Œï¼ˆæœ€æœ‰æ•ˆé˜²æ­»é”ï¼‰ ä¾‹å¦‚ï¼š\nå…ˆé”å° IDï¼Œå†é”å¤§ ID\n3. WHERE å¸¦ç´¢å¼•ï¼Œå¦åˆ™é”æ•´è¡¨ âš ï¸ UPDATE users SET status = 1 WHERE email = \u0026#39;x\u0026#39;; å¦‚æœ email æ²¡ç´¢å¼•\nğŸ‘‰ é”è¡¨æ‰«ææœŸé—´ä¼šå µä½æ‰€æœ‰å†™æ“ä½œï¼\n4. è¯»å†™åˆ†ç¦» NOT ENOUGH OLTP ä¸šåŠ¡ä»ç„¶å¯èƒ½é”å†²çªã€‚\n5. ä½¿ç”¨ SKIP LOCKED æé«˜é˜Ÿåˆ—å¹¶å‘ ","description":"å†…å®¹ï¼š\né”çš„ç§ç±»ï¼ˆè¡Œé” / è¡¨é” / äº‹åŠ¡é” / å…ƒæ•°æ®é”ï¼‰ é”æ˜¯å¦‚ä½•äº§ç”Ÿçš„ ä¸šåŠ¡ä¸­å¸¸è§çš„é”é—®é¢˜ å¦‚ä½•æ’æŸ¥ å¦‚ä½•é¿å…é˜»å¡ æœ€ä½³å®è·µ PostgreSQL 17 ç‰ˆæœ¬é€‚ç”¨ éå¸¸é€‚åˆ OLTPã€é«˜å¹¶å‘ã€ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸è¿ç»´ã€‚\n1. PostgreSQL é”çš„åˆ†ç±»æ€»è§ˆï¼ˆæ ¸å¿ƒçŸ¥è¯†ï¼‰ PostgreSQL é”åˆ†å››å¤§ç±»ï¼š\nç±»å‹ ç¤ºä¾‹ è¯´æ˜ è¡Œçº§é” Row-Level Locks SELECT â€¦ FOR UPDATE æœ€å¸¸ç”¨äºä¸šåŠ¡ï¼Œå½±å“å•è¡Œ è¡¨çº§é” Table-Level Locks LOCK TABLE â€¦ DDLã€å¹¶å‘å†™å…¥æ—¶å‡ºç° äº‹åŠ¡é” Transaction Locks å¯¹è±¡ç‰ˆæœ¬æ£€æŸ¥ MVCC å®ç° å…ƒæ•°æ®é” Catalog Locks ä¿®æ”¹è¡¨ç»“æ„æ—¶ ä¸é˜»å¡æ™®é€šæŸ¥è¯¢ è¡Œé”ä¸ä¼šé˜»å¡è¯»ï¼ˆPostgreSQL æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ï¼‰ã€‚\n"},{"id":391,"href":"/database/postgres/timestamp/","title":"PosygreSQL TIMESTAMP å’Œ TIMESTAMPTZ","parent":"PostgreSQL","content":"åœ¨ PostgreSQL ä¸­ï¼ŒTIMESTAMP å’Œ TIMESTAMPTZ çš„åŒºåˆ«æ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“è¸©å‘ã€ä½†åˆéå¸¸é‡è¦çš„é—®é¢˜ã€‚\nä¸€å¥è¯ç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰\nPostgreSQL åªæœ‰ TIMESTAMPTZ çœŸæ­£â€œæ‡‚æ—¶åŒºâ€ï¼ŒTIMESTAMP åªæ˜¯â€œå¸¦æ—¥æœŸçš„å­—ç¬¦ä¸²â€ã€‚\nä¸€ã€ç±»å‹å®šä¹‰å¯¹æ¯”ï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ ç±»å‹ å…¨å æ˜¯å¦å­˜æ—¶åŒº æœ¬è´¨ TIMESTAMP timestamp without time zone âŒ ä¸å­˜ çº¯æ—¥æœŸ + æ—¶é—´ TIMESTAMPTZ timestamp with time zone âœ… é€»è¾‘ä¸Šæœ‰ å­˜ UTC æ—¶é—´ç‚¹ âš ï¸ å…³é”®ç‚¹ï¼š\nTIMESTAMPTZ å¹¶ä¸ä¼šå­˜â€œ+08:00â€è¿™æ ·çš„æ—¶åŒºå­—ç¬¦ä¸²\nå®ƒä¼šï¼š\nè¾“å…¥æ—¶ -\u0026gt; è½¬æˆ UTC å­˜å‚¨ æŸ¥è¯¢æ—¶ -\u0026gt; æŒ‰ä¼šè¯æ—¶åŒºè½¬å›æ¥æ˜¾ç¤º äºŒã€å­˜å‚¨ä¸æ˜¾ç¤ºæœºåˆ¶ï¼ˆæ ¸å¿ƒå·®å¼‚ï¼‰ 1ï¸âƒ£ TIMESTAMPï¼ˆä¸å…³å¿ƒæ—¶åŒºï¼‰ CREATE TABLE t1 ( ts TIMESTAMP ); SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; INSERT INTO t1 VALUES (\u0026#39;2025-01-01 12:00:00\u0026#39;); SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT ts FROM t1; ç»“æœä»ç„¶æ˜¯ï¼š\n2025-01-01 12:00:00 ğŸ‘‰ åŸæ ·å­˜ã€åŸæ ·å–ï¼Œä¸åšä»»ä½•è½¬æ¢\n2ï¸âƒ£ TIMESTAMPTZï¼ˆè‡ªåŠ¨æ—¶åŒºè½¬æ¢ï¼‰ CREATE TABLE t2 ( ts TIMESTAMPTZ ); SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; INSERT INTO t2 VALUES (\u0026#39;2025-01-01 12:00:00\u0026#39;); SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT ts FROM t2; ç»“æœæ˜¯ï¼š\n2025-01-01 04:00:00+00 ğŸ‘‰ æ’å…¥æ—¶å‡å®šæ˜¯ä¸Šæµ·æ—¶é—´ -\u0026gt; è½¬æˆ UTC -\u0026gt; å­˜å‚¨\nä¸‰ã€åŒä¸€æ¡æ•°æ®ï¼Œä¸åŒæ—¶åŒºçœ‹åˆ°ä¸åŒç»“æœï¼ˆé‡ç‚¹ï¼‰ SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; SELECT now(); -- 2025-01-01 12:00:00+08 SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT now(); -- 2025-01-01 04:00:00+00 åŒä¸€ç¬é—´ ä¸åŒæ˜¾ç¤º åº•å±‚ UTC æ—¶é—´ç‚¹ä¸€è‡´ å››ã€å¯¹æ¯”æ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ ç»´åº¦ TIMESTAMP TIMESTAMPTZ æ˜¯å¦æ—¶åŒºæ„ŸçŸ¥ âŒ âœ… å­˜å‚¨å†…å®¹ å­—é¢æ—¶é—´ UTC æ—¶é—´ç‚¹ è‡ªåŠ¨è½¬æ¢ âŒ âœ… è·¨æ—¶åŒºå®‰å…¨ âŒ âœ… æ¨èç¨‹åº¦ âš ï¸ è°¨æ… âœ… å¼ºçƒˆæ¨è äº”ã€å…¸å‹ä½¿ç”¨åœºæ™¯ï¼ˆæ€ä¹ˆé€‰ï¼‰ âœ… åº”è¯¥ç”¨ TIMESTAMPTZ å‡¡æ˜¯â€œæŸä¸ªçœŸå®å‘ç”Ÿçš„æ—¶é—´ç‚¹â€\nåˆ›å»ºæ—¶é—´ / æ›´æ–°æ—¶é—´ æ—¥å¿—æ—¶é—´ è®¢å•æ—¶é—´ ç”¨æˆ·è¡Œä¸ºæ—¶é—´ API è¯·æ±‚æ—¶é—´ äº‹ä»¶å‘ç”Ÿæ—¶é—´ created_at TIMESTAMPTZ NOT NULL DEFAULT now() âœ… è¿™æ˜¯ PostgreSQL çš„æœ€ä½³å®è·µ\nâš ï¸ å¯ä»¥ç”¨ TIMESTAMP ä»…è¡¨ç¤ºâ€œæ—¥å†æ—¶é—´ï¼Œä¸ä»£è¡¨æŸä¸€ç¬é—´â€\næ¯å¤© 09:00 ä¸Šç­ ç”Ÿæ—¥ï¼ˆä¸å…³å¿ƒæ—¶åŒºï¼‰ å®šæ—¶ä»»åŠ¡é…ç½®æ—¶é—´ è¯¾ç¨‹å¼€å§‹æ—¶é—´ï¼ˆå›ºå®šæœ¬åœ°æ—¶é—´ï¼‰ work_start_time TIMESTAMP å…­ã€å¸¸è§å‘ï¼ˆéå¸¸å¸¸è§ï¼‰ âŒ å‘ 1ï¼šç”¨ TIMESTAMP å­˜ç”¨æˆ·æ“ä½œæ—¶é—´ å¤šæ—¶åŒºç”¨æˆ· æ•°æ®å¯¹ä¸ä¸Š è·¨æ—¶åŒºç»Ÿè®¡å…¨ä¹± ğŸ‘‰ å¿…é”™\nâŒ å‘ 2ï¼šä»¥ä¸º TIMESTAMPTZ ä¼šä¿å­˜ +08:00 SELECT ts FROM table; çœ‹åˆ° +00 å°±æ…Œäº†ï¼Ÿ\nğŸ‘‰ è¿™æ˜¯æ˜¾ç¤ºæ—¶åŒºï¼Œä¸æ˜¯ä¸¢äº†ä¿¡æ¯\nâŒ å‘ 3ï¼šå‰ç«¯å·²ç»æ˜¯ UTCï¼Œåç«¯åˆè½¬ä¸€æ¬¡ INSERT INTO t VALUES (\u0026#39;2025-01-01T04:00:00Z\u0026#39;); ä½†ä¼šè¯æ—¶åŒºæ˜¯ Asia/Shanghai\nğŸ‘‰ ä¼šè¢«å½“æˆâ€œæœ¬åœ°æ—¶é—´â€å†è½¬ä¸€æ¬¡\nâœ… æ­£ç¡®æ–¹å¼ï¼š\nå‰ç«¯å‘ UTC åç«¯è®¾ç½® SET TIME ZONE \u0026lsquo;UTC\u0026rsquo; æˆ–ä½¿ç”¨ TIMESTAMPTZ + æ˜ç¡®æ—¶åŒº ä¸ƒã€ä¸ MySQL çš„å…³é”®å·®å¼‚ï¼ˆä½ ç»å¸¸é—®è¿™ä¸ªï¼‰ æ•°æ®åº“ ç±»å‹ è¡Œä¸º MySQL TIMESTAMP ä¼šè‡ªåŠ¨è½¬æ—¶åŒº MySQL DATETIME ä¸è½¬ PostgreSQL TIMESTAMP ä¸è½¬ PostgreSQL TIMESTAMPTZ è‡ªåŠ¨è½¬ï¼ˆæ¨èï¼‰ ğŸ‘‰ PostgreSQL æŠŠâ€œæ˜¯å¦å¸¦æ—¶åŒºâ€åŒºåˆ†å¾—æ›´æ¸…æ™°\nå…«ã€æœ€ä½³å®è·µæ€»ç»“ï¼ˆç›´æ¥ç…§ç€ç”¨ï¼‰ âœ… å»ºè¡¨è§„èŒƒ created_at TIMESTAMPTZ NOT NULL DEFAULT now() updated_at TIMESTAMPTZ NOT NULL DEFAULT now() âœ… ä¼šè¯æ—¶åŒºç»Ÿä¸€ SET TIME ZONE \u0026#39;UTC\u0026#39;; âœ… åº”ç”¨å±‚ æ•°æ®åº“å­˜ UTC å‰ç«¯æŒ‰ç”¨æˆ·æ—¶åŒºå±•ç¤º ä¸ºä»€ä¹ˆæ—¥å¿—ç³»ç»Ÿä¸€å®šè¦ç”¨ TIMESTAMPTZ è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ã€ä¹Ÿæ˜¯æ—¥å¿—ç³»ç»Ÿæœ€å®¹æ˜“è¸©å‘çš„é—®é¢˜ã€‚ç»“è®ºå…ˆè¡Œï¼š\næ—¥å¿—ç³»ç»Ÿå¦‚æœä¸ç”¨ TIMESTAMPTZï¼Œè¿Ÿæ—©ä¸€å®šå‡ºäº‹æ•…ã€‚\nä¸€ã€æ—¥å¿—ç³»ç»Ÿåœ¨â€œè®°å½•ä»€ä¹ˆâ€ï¼Ÿ æ—¥å¿—è®°å½•çš„ä¸æ˜¯ã€Œä¸€ä¸ªæ—¶é—´å­—ç¬¦ä¸²ã€ï¼Œè€Œæ˜¯ï¼š\næŸä¸€ä¸ªâ€œçœŸå®å‘ç”Ÿçš„æ—¶é—´ç‚¹ï¼ˆInstantï¼‰â€\nè¿™ä¸ªæ—¶é—´ç‚¹å…·æœ‰ 3 ä¸ªç‰¹å¾ï¼š\nå…¨ä¸–ç•Œå”¯ä¸€ ä¸åœ°ç†ä½ç½®æ— å…³ å¯æ’åºã€å¯å¯¹é½ ğŸ‘‰ è¿™æ­£æ˜¯ TIMESTAMPTZ çš„è¯­ä¹‰\näºŒã€å¦‚æœç”¨ TIMESTAMPï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼ˆçœŸå®é—®é¢˜ï¼‰ åœºæ™¯ 1ï¼šå¤šæœºæˆ¿ / å¤šåœ°åŒº åŒ—äº¬æœåŠ¡ï¼š2025-01-01 10:00:00 çº½çº¦æœåŠ¡ï¼š2025-01-01 10:00:00 å¦‚æœæ˜¯ TIMESTAMPï¼š\n2025-01-01 10:00:00 åŒ—äº¬ 2025-01-01 10:00:00 çº½çº¦ ğŸ‘‰ è¿™ä¸¤æ¡æ—¥å¿—æ ¹æœ¬ä¸æ˜¯åŒä¸€æ—¶åˆ» ğŸ‘‰ å´è¢«å½“æˆåŒä¸€æ—¶é—´ æ’åºã€èšåˆã€å› æœåˆ†æå…¨éƒ¨å¤±çœŸ\nåœºæ™¯ 2ï¼šæ—¥å¿—æ±‡èšï¼ˆELK / ClickHouse / PostgreSQLï¼‰ ä½ åšï¼š\nORDER BY created_at; ä½†ï¼š\nåŒ—äº¬æœºå™¨æ˜¯ UTC+8\næœåŠ¡å™¨æ˜¯ UTC\nå®¹å™¨æ˜¯ UTC\næŸå°æœºå™¨æ—¶åŒºè¢«äººæ”¹è¿‡\nğŸ‘‰ æ—¶é—´çº¿æ˜¯ä¹±çš„\nğŸ‘‰ æ’å‡ºæ¥çš„â€œå› æœé¡ºåºæ˜¯å‡çš„â€\nåœºæ™¯ 3ï¼šå¤ä»¤æ—¶ï¼ˆDSTï¼‰â€”â€”æœ€éšè”½ã€æœ€è‡´å‘½ çº½çº¦æ—¶é—´ï¼š\n2025-11-02 01:30 è¿™ä¸€å¤©ï¼š\n01:00 ~ 02:00 å‡ºç°ä¸¤æ¬¡ ç”¨ TIMESTAMPï¼š\n01:30 æ˜¯å“ªä¸€æ¬¡ï¼Ÿ ğŸ‘‰ æ ¹æœ¬æ— æ³•åŒºåˆ† ğŸ‘‰ æ—¥å¿—å‡ºç°â€œæ—¶é—´å€’æµâ€ TIMESTAMPTZï¼š\nâœ… è‡ªåŠ¨è½¬æˆ UTC âœ… ä¸å­˜åœ¨äºŒä¹‰æ€§ ä¸‰ã€TIMESTAMPTZ ä¸ºä»€ä¹ˆâ€œå¤©ç”Ÿé€‚åˆæ—¥å¿—â€ï¼Ÿ 1ï¸âƒ£ å­˜çš„æ˜¯ UTC æ—¶é—´ç‚¹ï¼ˆå”¯ä¸€ï¼‰ SELECT extract(epoch FROM now()); -\u0026gt; æœ¬è´¨æ˜¯ä¸€ä¸ªå…¨çƒå”¯ä¸€çš„æ—¶é—´è½´ä½ç½®\n2ï¸âƒ£ æ˜¾ç¤ºæ—¶æŒ‰ä¼šè¯æ—¶åŒºè½¬æ¢ï¼ˆå‹å¥½ï¼‰ SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; SELECT created_at FROM logs; SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT created_at FROM logs; ğŸ‘‰ åŒä¸€æ¡æ—¥å¿—ï¼Œä¸åŒè§†è§’\n3ï¸âƒ£ è·¨ç³»ç»Ÿå¯¹é½æ¯«æ— å‹åŠ› ç³»ç»Ÿ æ—¶é—´ Nginx UTC Kubernetes UTC PostgreSQL UTC Prometheus UTC OpenTelemetry UTC ğŸ‘‰ å¤©ç„¶å¯¹é½\nå››ã€æŸ¥è¯¢ \u0026amp; åˆ†æå±‚é¢çš„å†³å®šæ€§ä¼˜åŠ¿ 1ï¸âƒ£ æ—¶é—´èŒƒå›´æŸ¥è¯¢æ­£ç¡® SELECT * FROM logs WHERE created_at BETWEEN \u0026#39;2025-01-01 00:00:00+00\u0026#39; AND \u0026#39;2025-01-01 01:00:00+00\u0026#39;; âœ… ä¸å—æœåŠ¡å™¨æ—¶åŒºå½±å“ âœ… ä¸å—å®¢æˆ·ç«¯æ—¶åŒºå½±å“ 2ï¸âƒ£ æ—¶é—´èšåˆä¸ä¼šé”™ä½ SELECT date_trunc(\u0026#39;hour\u0026#39;, created_at), count(*) FROM logs GROUP BY 1; TIMESTAMPTZï¼šæŒ‰çœŸå®æ—¶é—´è½´ TIMESTAMPï¼šæŒ‰â€œæœºå™¨å¿ƒæƒ…â€ 3ï¸âƒ£ å¤šæ¥æºæ—¥å¿—å› æœåˆ†ææˆç«‹ A æœåŠ¡å‘è¯·æ±‚ -\u0026gt; B æœåŠ¡å¤„ç† -\u0026gt; C æœåŠ¡å†™åº“\nğŸ‘‰ åªæœ‰ UTC æ—¶é—´çº¿ æ‰èƒ½æ­£ç¡®ä¸²èµ·æ¥\näº”ã€çœŸå®äº‹æ•…æ€»ç»“ï¼ˆè¡Œä¸šå…±è¯†ï¼‰ æ‰€æœ‰å¤§å‹æ—¥å¿—ç³»ç»Ÿï¼Œæœ€ç»ˆéƒ½ä¼šç»Ÿä¸€æˆ UTC + TIMESTAMPTZ\nåŒ…æ‹¬ä½†ä¸é™äºï¼š\nELK Loki ClickHouse Datadog New Relic OpenTelemetry ä¸ç»Ÿä¸€ -\u0026gt; ä¸€å®šä¼šè¸©å‘\nå…­ã€æ—¥å¿—ç³»ç»Ÿçš„â€œé»„é‡‘è§„èŒƒâ€ï¼ˆç›´æ¥ç”¨ï¼‰ 1ï¸âƒ£ æ•°æ®åº“å­—æ®µ created_at TIMESTAMPTZ NOT NULL DEFAULT now() 2ï¸âƒ£ æ•°æ®åº“å­˜ UTC ALTER DATABASE yourdb SET TIME ZONE \u0026#39;UTC\u0026#39;; 3ï¸âƒ£ åº”ç”¨å±‚è§„åˆ™ æ‰€æœ‰æ—¥å¿—æ—¶é—´ = UTC ä¸åšæœ¬åœ°æ—¶é—´è®¡ç®— å±•ç¤ºæ—¶æ‰è½¬æ—¶åŒº 4ï¸âƒ£ å‰ç«¯ / API { \u0026#34;timestamp\u0026#34;: \u0026#34;2025-01-01T04:00:00Z\u0026#34; } ä¸ƒã€æ€»ç»“ï¼ˆè®°ä½è¿™ä¸ªï¼‰ æ—¥å¿— = æ—¶é—´è½´ä¸Šçš„äº‹ä»¶\næ—¶é—´è½´åªèƒ½æœ‰ä¸€ä¸ªï¼šUTC\nPostgreSQL é‡Œï¼Œåªæœ‰ TIMESTAMPTZ åšå¾—åˆ°\né«˜å¹¶å‘æ—¥å¿—å†™å…¥çš„è¡¨ç»“æ„è®¾è®¡ ä¸‹é¢è¿™ä»½æ˜¯çœŸæ­£å¯è½åœ°ã€èƒ½æ‰›é«˜å¹¶å‘ã€å¯é•¿æœŸè¿ç»´çš„ PostgreSQL æ—¥å¿—è¡¨ç»“æ„è®¾è®¡æ–¹æ¡ˆã€‚\næŒ‰ è®¾è®¡ç›®æ ‡ -\u0026gt; è¡¨ç»“æ„ -\u0026gt; ç´¢å¼• -\u0026gt; åˆ†åŒº -\u0026gt; å†™å…¥ä¼˜åŒ– -\u0026gt; æŸ¥è¯¢ä¼˜åŒ– -\u0026gt; å¸¸è§å‘ çš„é¡ºåºæ¥è®²ã€‚\nåœºæ™¯å‡è®¾ï¼š\næ¯ç§’ 1 ä¸‡ ~ 10 ä¸‡ æ—¥å¿—å†™å…¥ æ—¥å¿—åªè¿½åŠ ï¼ˆAppend Onlyï¼‰ å¼ºæŸ¥è¯¢ï¼šæŒ‰æ—¶é—´ / æœåŠ¡ / å…³é”®å­— æ—¥å¿—é‡ï¼šäº¿çº§ PostgreSQL 17+ ä¸€ã€è®¾è®¡ç›®æ ‡ï¼ˆå…ˆç«‹è§„çŸ©ï¼‰ æ—¥å¿—è¡¨è®¾è®¡çš„æ ¸å¿ƒç›®æ ‡åªæœ‰ 5 ä¸ªï¼š\nå†™å…¥å¿«ï¼ˆæœ€é‡è¦ï¼‰ æ—¶é—´æœ‰åº å†·çƒ­æ•°æ®å¯ç®¡ç† æŸ¥è¯¢å¯æ§ å¯è‡ªåŠ¨æ¸…ç† ğŸ‘‰ ä»»ä½•å½±å“å†™å…¥æ€§èƒ½çš„è®¾è®¡ï¼Œéƒ½è¦æ…ç”¨ã€‚\näºŒã€æ—¥å¿—è¡¨çš„ã€Œé»„é‡‘å­—æ®µæ¨¡å‹ã€ âœ… æ¨èå­—æ®µï¼ˆæœ€å°å¯ç”¨é›†ï¼‰\nCREATE TABLE logs ( id BIGINT GENERATED ALWAYS AS IDENTITY, ts TIMESTAMPTZ NOT NULL, -- çœŸå®å‘ç”Ÿæ—¶é—´ï¼ˆUTCï¼‰ level SMALLINT NOT NULL, -- æ—¥å¿—çº§åˆ«ï¼ˆæšä¸¾åŒ–ï¼‰ service TEXT NOT NULL, -- æœåŠ¡å host TEXT, -- ä¸»æœº / Pod trace_id TEXT, -- é“¾è·¯è¿½è¸ª message TEXT NOT NULL, -- æ—¥å¿—æ­£æ–‡ extra JSONB, -- æ‰©å±•å­—æ®µ PRIMARY KEY (id, ts) ) PARTITION BY RANGE (ts); ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ\nå­—æ®µ åŸå›  BIGINT id é¡ºåºå†™ï¼Œå‡å°‘ç´¢å¼•åˆ†è£‚ TIMESTAMPTZ ts æ—¶é—´è½´å”¯ä¸€ SMALLINT level æ¯” TEXT å¿«ã€å¯æ’åº JSONB extra çµæ´»ä½†å¯æ§ ä¸»é”®åŒ…å« ts åˆ†åŒºé”®å¿…é¡»åœ¨ä¸»é”®ä¸­ ä¸‰ã€æ—¥å¿—çº§åˆ«ï¼šåˆ«ç”¨ TEXTï¼ˆéå¸¸é‡è¦ï¼‰ âŒ é”™è¯¯ level TEXT -- INFO / ERROR / DEBUG âœ… æ­£ç¡®\n-- åº”ç”¨å±‚æšä¸¾ 0 = DEBUG 1 = INFO 2 = WARN 3 = ERROR 4 = FATAL level SMALLINT NOT NULL æ›´å¿« æ›´å° æ›´å¥½ç´¢å¼• å››ã€åˆ†åŒºç­–ç•¥ï¼ˆå†³å®šä½ èƒ½ä¸èƒ½æ‰›â€œäº¿çº§â€ï¼‰ âœ… å¼ºçƒˆæ¨èï¼šæŒ‰æ—¶é—´ RANGE åˆ†åŒº åˆ†åŒºç²’åº¦æ€ä¹ˆé€‰ï¼Ÿ\nå†™å…¥é‡ æ¨è \u0026lt; 1000/s æŒ‰å¤© 1000~1ä¸‡/s æŒ‰å¤© 1ä¸‡~10ä¸‡/s æŒ‰å°æ—¶ \u0026gt;10ä¸‡/s å°æ—¶ + åˆ†åº“ ç¤ºä¾‹ï¼šæŒ‰å¤©åˆ†åŒº\nCREATE TABLE logs ( ... ) PARTITION BY RANGE (ts); CREATE TABLE logs_2025_01_01 PARTITION OF logs FOR VALUES FROM (\u0026#39;2025-01-01\u0026#39;) TO (\u0026#39;2025-01-02\u0026#39;); ä¼˜ç‚¹\nINSERT å‘½ä¸­å•ä¸€åˆ†åŒº VACUUM / DELETE ä¸é”å…¨è¡¨ å¯å¿«é€Ÿ DROP å†å²æ•°æ® äº”ã€ç´¢å¼•ç­–ç•¥ï¼ˆ90% æ€§èƒ½é—®é¢˜åœ¨è¿™é‡Œï¼‰ â— é«˜å¹¶å‘å†™å…¥æ—¶çš„ç´¢å¼•åŸåˆ™\nç´¢å¼•è¶Šå°‘è¶Šå¥½\nå»ºè®®ç´¢å¼•ï¼ˆæ ¸å¿ƒï¼‰ -- æ—¶é—´èŒƒå›´æŸ¥è¯¢ CREATE INDEX ON logs USING BRIN (ts); -- æœåŠ¡ + æ—¶é—´ CREATE INDEX ON logs (service, ts DESC); -- é”™è¯¯æ—¥å¿— CREATE INDEX ON logs (level, ts DESC); âŒ ä¸è¦è½»æ˜“åšçš„äº‹ è¡Œä¸º åŸå›  å…¨å­—æ®µ BTree å†™å…¥æ…¢ message LIKE ç´¢å¼• çˆ†ç‚¸ GIN(JSONB) å…¨ç´¢å¼• å†™å…¥ææ…¢ å…­ã€å…¨æ–‡æœç´¢ï¼ˆæ­£ç¡®å§¿åŠ¿ï¼‰ âŒ é”™è¯¯ WHERE message LIKE \u0026#39;%error%\u0026#39; âœ… æ­£ç¡®ï¼ˆæ—¥å¿—å…¨æ–‡æœç´¢ï¼‰ ALTER TABLE logs ADD COLUMN message_tsv tsvector GENERATED ALWAYS AS (to_tsvector(\u0026#39;simple\u0026#39;, message)) STORED; CREATE INDEX ON logs USING GIN (message_tsv); æŸ¥è¯¢ï¼š\nWHERE message_tsv @@ to_tsquery(\u0026#39;error\u0026#39;) ä¸ƒã€å†™å…¥æ€§èƒ½çš„â€œç»ˆæä¼˜åŒ–æ‰‹æ®µâ€ 1ï¸âƒ£ æ‰¹é‡å†™ï¼ˆæœ€é‡è¦ï¼‰ INSERT INTO logs (...) VALUES (...), (...), (...); âœ… æ¯”å•æ¡å¿« 10~100 å€\n2ï¸âƒ£ å…³é—­åŒæ­¥ï¼ˆæ—¥å¿—åœºæ™¯å¯æ¥å—ï¼‰ ALTER SYSTEM SET synchronous_commit = off; ğŸ‘‰ å…è®¸æå°æ¦‚ç‡ä¸¢æ—¥å¿—ï¼Œæ¢åå\n3ï¸âƒ£ COPY å†™å…¥ï¼ˆå‹æµ‹ç¥å™¨ï¼‰ COPY logs (ts, level, service, message) FROM STDIN; 4ï¸âƒ£ WAL å‹ç¼© ALTER SYSTEM SET wal_compression = on; å…«ã€å†·çƒ­æ•°æ® \u0026amp; è‡ªåŠ¨æ¸…ç† âŒ DELETEï¼ˆç¾éš¾ï¼‰ DELETE FROM logs WHERE ts \u0026lt; now() - interval \u0026#39;30 days\u0026#39;; âœ… DROP PARTITIONï¼ˆç§’çº§ï¼‰ DROP TABLE logs_2024_11_01; æ—  WAL æ— é” ç¬é—´å®Œæˆ ä¹ã€å…¸å‹æ¶æ„ï¼ˆçœŸå®ç”Ÿäº§ï¼‰ åº”ç”¨ â†“ æ—¥å¿— SDKï¼ˆæ‰¹é‡ï¼‰ â†“ PostgreSQLï¼ˆçƒ­æ•°æ® 7 å¤©ï¼‰ â†“ å®šæœŸå¯¼å‡º â†“ ClickHouse / S3ï¼ˆå†·æ•°æ®ï¼‰ åã€æ€»ç»“ï¼ˆè®°ä½è¿™æ®µï¼‰ æ—¥å¿—è¡¨ = åªå†™ + æ—¶é—´åˆ†åŒº + å°‘ç´¢å¼•\nTIMESTAMPTZ + RANGE åˆ†åŒº æ˜¯åº•çº¿\nDELETE æ—¥å¿— = è‡ªæ€\nDROP åˆ†åŒº = æ­£é“\næ—¥å¿—è¡¨çš„æœ€ä½³ç´¢å¼•è®¾è®¡ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰ ç»“åˆ å†™å…¥æ€§èƒ½ã€æŸ¥è¯¢æ¨¡å¼ã€åˆ†åŒºè£å‰ªï¼ˆpartition pruningï¼‰ æ¥è®²ï¼Œè€Œä¸æ˜¯åªåˆ—ç´¢å¼•ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ æ—¥å¿—è¡¨çš„ç´¢å¼•è®¾è®¡åŸåˆ™åªæœ‰ä¸€å¥è¯ï¼š\næ¯ä¸ªåˆ†åŒºåªä¿ç•™â€œæ—¶é—´ç›¸å…³ + é«˜é¢‘è¿‡æ»¤â€çš„æœ€å°‘ç´¢å¼•\næ—¶é—´åˆ†åŒº â‰  å¤šå»ºç´¢å¼•\nğŸ‘‰ åˆ†åŒºè§£å†³çš„æ˜¯ã€Œæ‰«æèŒƒå›´ã€ï¼Œç´¢å¼•åªè§£å†³ã€Œåˆ†åŒºå†…è¿‡æ»¤ã€ã€‚\näºŒã€æ—¥å¿—è¡¨å‡è®¾ç»“æ„ï¼ˆæ ‡å‡†æ¨¡å‹ï¼‰ CREATE TABLE logs ( id BIGINT GENERATED ALWAYS AS IDENTITY, ts TIMESTAMPTZ NOT NULL, level SMALLINT NOT NULL, service TEXT NOT NULL, host TEXT, trace_id TEXT, message TEXT, extra JSONB, PRIMARY KEY (id, ts) ) PARTITION BY RANGE (ts); ä¸‰ã€ç´¢å¼•è®¾è®¡çš„ã€Œé»„é‡‘é¡ºåºã€ ç´¢å¼•ä¼˜å…ˆçº§æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰\n1ï¸âƒ£ æ—¶é—´èŒƒå›´æŸ¥è¯¢ 2ï¸âƒ£ æœåŠ¡ / ç³»ç»Ÿ / æ¨¡å— + æ—¶é—´ 3ï¸âƒ£ é”™è¯¯çº§åˆ« + æ—¶é—´ 4ï¸âƒ£ å…¨æ–‡æœç´¢ï¼ˆå¯é€‰ï¼‰ 5ï¸âƒ£ è¿½è¸ª IDï¼ˆtrace_idï¼‰ å››ã€å¿…é¡»è¦æœ‰çš„ç´¢å¼•ï¼ˆ90% åœºæ™¯ï¼‰ 1ï¸âƒ£ æ—¶é—´ç´¢å¼•ï¼ˆé¦–é€‰ BRINï¼‰ CREATE INDEX ON logs USING BRIN (ts); ä¸ºä»€ä¹ˆç”¨ BRINï¼Ÿ\nåŸå›  è¯´æ˜ æå° MB çº§ å†™å…¥å¿« å‡ ä¹æ— ç»´æŠ¤æˆæœ¬ æ—¶é—´æœ‰åº æ—¥å¿—å¤©ç„¶é¡ºåºå†™ âœ… åˆ†åŒº + BRIN = äº¿çº§æ—¥å¿—æ ‡é…\n2ï¸âƒ£ service + tsï¼ˆæœ€å¸¸ç”¨ï¼‰ CREATE INDEX ON logs (service, ts DESC); é€‚ç”¨æŸ¥è¯¢\nWHERE service = \u0026#39;order\u0026#39; AND ts \u0026gt;= now() - interval \u0026#39;1 hour\u0026#39; ä¸ºä»€ä¹ˆ ts æ”¾åé¢ï¼Ÿ\nservice å…ˆè¿‡æ»¤ ts ç”¨äºæ’åº + èŒƒå›´æ‰«æ 3ï¸âƒ£ level + tsï¼ˆé”™è¯¯æ—¥å¿—ï¼‰ CREATE INDEX ON logs (level, ts DESC); å…¸å‹æŸ¥è¯¢\nWHERE level \u0026gt;= 3 AND ts \u0026gt;= now() - interval \u0026#39;10 minutes\u0026#39; äº”ã€ä¸å»ºè®®çš„ç´¢å¼•ï¼ˆé«˜å¹¶å‘å†™å…¥æ€æ‰‹ï¼‰ âŒ message BTree CREATE INDEX ON logs (message); åŸå› ï¼š\nTEXT è¶…é•¿ ç´¢å¼•å·¨å¤§ å‡ ä¹æ²¡æ³•å‘½ä¸­ âŒ å…¨å­—æ®µ JSONB GIN CREATE INDEX ON logs USING GIN (extra); åŸå› ï¼š\nGIN å†™å…¥æ…¢ WAL æš´å¢ åªåœ¨å°‘é‡å­—æ®µæŸ¥è¯¢æ‰å€¼å¾— å…­ã€å…¨æ–‡æœç´¢ï¼šæ­£ç¡®å§¿åŠ¿ æ–¹å¼ä¸€ï¼štsvectorï¼ˆæ¨èï¼‰ ALTER TABLE logs ADD COLUMN message_tsv tsvector GENERATED ALWAYS AS ( to_tsvector(\u0026#39;simple\u0026#39;, message) ) STORED; CREATE INDEX ON logs USING GIN (message_tsv); æŸ¥è¯¢ï¼š\nWHERE message_tsv @@ to_tsquery(\u0026#39;timeout\u0026#39;) âœ… æ¯” LIKE å¿«å‡ ä¸ªæ•°é‡çº§ âœ… å¯æ§ æ–¹å¼äºŒï¼špg_trgmï¼ˆæ…ç”¨ï¼‰ CREATE EXTENSION IF NOT EXISTS pg_trgm; CREATE INDEX ON logs USING GIN (message gin_trgm_ops); âš ï¸ åªå»ºè®®ï¼š\nå°åˆ†åŒº å°‘é‡å­—æ®µ ä¸­æ–‡æ¨¡ç³Šæœç´¢ ä¸ƒã€trace_id ç´¢å¼•ï¼ˆé“¾è·¯è¿½è¸ªï¼‰ CREATE INDEX ON logs (trace_id); ä»…åœ¨ä½ ç¡®å®š trace_id ä¼šè¢«é¢‘ç¹æŸ¥æ—¶æ‰å»ºã€‚\nå…«ã€åˆ†åŒº + ç´¢å¼•çš„æ­£ç¡®æ‰“å¼€æ–¹å¼ å…³é”®ç‚¹ï¼šç´¢å¼•è¦å»ºåœ¨çˆ¶è¡¨ä¸Š\nCREATE INDEX idx_logs_service_ts ON logs (service, ts DESC); PostgreSQL ä¼šï¼š\nè‡ªåŠ¨åœ¨ æ–°åˆ†åŒº ä¸Šåˆ›å»ºç´¢å¼• é¿å…ä½ æ‰‹åŠ¨ç»´æŠ¤ ä¹ã€ä¸€ä¸ªã€Œæ ‡å‡†ç”Ÿäº§çº§ç´¢å¼•ç»„åˆã€ æ¯ä¸ªåˆ†åŒºæœ€ç»ˆåªä¿ç•™ 3~5 ä¸ªç´¢å¼•\n-- æ—¶é—´ BRIN (ts) -- ä¸šåŠ¡ç»´åº¦ BTREE (service, ts DESC) BTREE (level, ts DESC) -- å¯é€‰ GIN (message_tsv) BTREE (trace_id) åã€EXPLAIN ä¸­ä½ åº”è¯¥çœ‹åˆ°ä»€ä¹ˆï¼Ÿ æ­£ç¡®å§¿åŠ¿\nAppend -\u0026gt; Bitmap Heap Scan on logs_2025_01_01 Index Cond: (service = \u0026#39;api\u0026#39;) âŒ é”™è¯¯ä¿¡å·\nSeq Scan on logs ğŸ‘‰ è¡¨ç¤ºï¼š\nåˆ†åŒºæ²¡è£å‰ª ç´¢å¼•è®¾è®¡æœ‰é—®é¢˜ æŸ¥è¯¢æ¡ä»¶å†™é”™ åä¸€ã€ç´¢å¼•è®¾è®¡æ€»ç»“ æ—¶é—´åˆ†åŒºè§£å†³â€œæ‰«å“ªé‡Œâ€ï¼Œç´¢å¼•åªè§£å†³â€œæ€ä¹ˆæ‰«â€\nBRIN ç®¡æ—¶é—´ï¼ŒBTREE ç®¡ä¸šåŠ¡\nç´¢å¼•å®å°‘å‹¿å¤š\nDELETE æ—¥å¿—æ˜¯åŸç½ªï¼ŒDROP åˆ†åŒºæ˜¯æ­£é“\nTimescaleDB å’Œ TIMESTAMPTZ ä¸‹é¢è¿™éƒ¨åˆ†å†…å®¹éå¸¸å…³é”®ï¼Œä¹Ÿæ˜¯å¾ˆå¤šäººã€Œç”¨äº† TimescaleDB å´æ²¡çœŸæ­£ç”¨å¯¹ã€çš„åœ°æ–¹ã€‚\nä¸€ã€ç»“è®ºå…ˆè¡Œï¼ˆä¸€å®šè¦è®°ä½ï¼‰ TimescaleDB çš„æ—¶é—´åˆ—å¿…é¡»ç”¨ TIMESTAMPTZï¼Œä¸æ˜¯å»ºè®®ï¼Œæ˜¯äº‹å®æ ‡å‡†\nå¦‚æœä½ ç”¨ï¼š\nTIMESTAMP -\u0026gt; âŒ é£é™©æé«˜ TIMESTAMPTZ -\u0026gt; âœ… å®Œå…¨å¥‘åˆ TimescaleDB è®¾è®¡ äºŒã€TimescaleDB åœ¨â€œæ—¶é—´â€ä¸Šçš„çœŸå®è¯­ä¹‰ TimescaleDB çš„æ ¸å¿ƒä¸æ˜¯â€œè¡¨â€ï¼Œè€Œæ˜¯ï¼š\nåŸºäºæ—¶é—´è½´ï¼ˆTime Axisï¼‰çš„æ•°æ®å¼•æ“\nå®ƒå†…éƒ¨åšäº† 4 ä»¶äº‹ï¼š\næ—¶é—´åˆ†åŒºï¼ˆtime chunkï¼‰ æ—¶é—´è£å‰ªï¼ˆchunk pruningï¼‰ æ—¶é—´å‹ç¼©ï¼ˆordered by timeï¼‰ æ—¶é—´èšåˆï¼ˆtime_bucketï¼‰ ğŸ‘‰ è¿™äº›éƒ½å‡è®¾ï¼š\næ—¶é—´æ˜¯å•è°ƒã€è¿ç»­ã€æ— æ­§ä¹‰çš„\nè¿™æ­£æ˜¯ TIMESTAMPTZ çš„ç‰¹æ€§ã€‚\nä¸‰ã€ä¸ºä»€ä¹ˆ TIMESTAMP ä¼šç ´å TimescaleDBï¼Ÿ 1ï¸âƒ£ TIMESTAMP æ²¡æœ‰æ—¶åŒºè¯­ä¹‰ï¼ˆè‡´å‘½ï¼‰ TIMESTAMP \u0026#39;2025-01-01 10:00:00\u0026#39; ä¸æ˜¯ UTC ä¸æ˜¯æœ¬åœ°æ—¶é—´ æ˜¯â€œæ‚¬ç©ºæ—¶é—´â€ TimescaleDB ä¸çŸ¥é“è¿™ä¸ªæ—¶é—´ç‚¹åœ¨å…¨çƒæ—¶é—´è½´ä¸Šçš„ä½ç½®\n2ï¸âƒ£ chunk åˆ’åˆ†å¯èƒ½é”™ä½ SELECT create_hypertable(\u0026#39;metrics\u0026#39;, \u0026#39;ts\u0026#39;); TimescaleDB æŒ‰ ts åˆ’ chunkã€‚\nå¦‚æœ ts æ˜¯ TIMESTAMPï¼š\nä¸åŒæ—¶åŒºå†™å…¥ chunk è¾¹ç•Œæ··ä¹± chunk overlap chunk pruning å¤±æ•ˆ ğŸ‘‰ æ€§èƒ½ç›´æ¥ä¸‹é™ä¸€ä¸ªæ•°é‡çº§\n3ï¸âƒ£ å‹ç¼©æ’åºå¤±çœŸ TimescaleDB å‹ç¼©é»˜è®¤ï¼š\nORDER BY ts å¦‚æœ ts ä¸æ˜¯ UTCï¼š\né¡ºåºé”™è¯¯ å‹ç¼©æ¯”ä¸‹é™ è§£å‹æŸ¥è¯¢å˜æ…¢ 4ï¸âƒ£ è¿ç»­èšåˆï¼ˆContinuous Aggregateï¼‰ä¼šé”™ time_bucket(\u0026#39;5 min\u0026#39;, ts) å¦‚æœ ts æ˜¯ TIMESTAMPï¼š\nè·¨æ—¶åŒº bucket ä¸å¯¹é½ DST åˆ‡æ¢ç›´æ¥é”™ä½ å››ã€TIMESTAMPTZ æ˜¯å¦‚ä½•â€œå®Œç¾å¥‘åˆâ€çš„ï¼Ÿ å†…éƒ¨å­˜å‚¨æ–¹å¼ï¼ˆå…³é”®ï¼‰\nTIMESTAMPTZ = UTC æ—¶é—´æˆ³ + æ—¶åŒºè½¬æ¢è§„åˆ™ å­˜å‚¨ï¼šUTC æ˜¾ç¤ºï¼šä¼šè¯æ—¶åŒº æ’åºï¼šç»å¯¹æ­£ç¡® ğŸ‘‰ TimescaleDB éœ€è¦çš„æ­£æ˜¯ã€ŒUTC æ—¶é—´è½´ã€\nchunk æ˜¯è¿™æ ·åˆ’åˆ†çš„ 2025-01-01T00:00:00Z 2025-01-01T01:00:00Z 2025-01-01T02:00:00Z æ— æ­§ä¹‰ã€æ— å›é€€ã€æ— é‡å¤ã€‚\näº”ã€æ­£ç¡®å»ºè¡¨ç¤ºä¾‹ï¼ˆæ ‡å‡†ï¼‰ CREATE TABLE metrics ( ts TIMESTAMPTZ NOT NULL, device_id TEXT NOT NULL, cpu DOUBLE PRECISION, mem DOUBLE PRECISION ); SELECT create_hypertable( \u0026#39;metrics\u0026#39;, \u0026#39;ts\u0026#39;, chunk_time_interval =\u0026gt; INTERVAL \u0026#39;1 day\u0026#39; ); å…­ã€å†™å…¥å§¿åŠ¿ï¼ˆå¿…é¡»ç»Ÿä¸€ï¼‰ æ¨èå†™æ³•ï¼ˆUTCï¼‰\nINSERT INTO metrics (ts, device_id, cpu) VALUES (now(), \u0026#39;node-1\u0026#39;, 0.82); æˆ–ï¼š\nINSERT INTO metrics (ts, device_id, cpu) VALUES (\u0026#39;2025-01-01T08:00:00Z\u0026#39;, \u0026#39;node-1\u0026#39;, 0.82); âŒ é”™è¯¯å†™æ³• INSERT INTO metrics (ts) VALUES (\u0026#39;2025-01-01 08:00:00\u0026#39;); æ²¡æ—¶åŒº ä¼šæŒ‰ session timezone çŒœ ä¸å¯æ§ ä¸ƒã€æŸ¥è¯¢æ—¶ï¼šæ—¶åŒºè‡ªç”±åˆ‡æ¢ï¼ˆå·¨å¤§ä¼˜åŠ¿ï¼‰ SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; SELECT ts FROM metrics LIMIT 1; SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT ts FROM metrics LIMIT 1; ğŸ‘‰ åŒä¸€æ¡æ•°æ®ï¼Œä¸åŒæ—¶åŒºè§†è§’ã€‚\nå…«ã€TimescaleDB å®˜æ–¹éšå«è§„åˆ™ï¼ˆè¡Œä¸šå…±è¯†ï¼‰ é¡¹ç›® å®˜æ–¹é»˜è®¤ æ—¶é—´åˆ— TIMESTAMPTZ å­˜å‚¨ UTC chunk UTC å¯¹é½ time_bucket UTC è®¡ç®— ä½ å¯ä»¥ä¸ç”¨ï¼Œä½†ä½ è¸©çš„å‘ï¼Œå®˜æ–¹ä¸ä¼šå…œåº•\nä¹ã€æ—¥å¿— / ç›‘æ§ / æ—¶åº ä¸‰è€…ç»Ÿä¸€è§„åˆ™ åœºæ™¯ æ—¶é—´ç±»å‹ æ—¥å¿— TIMESTAMPTZ ç›‘æ§ TIMESTAMPTZ äº‹ä»¶ TIMESTAMPTZ èšåˆ TIMESTAMPTZ ğŸ‘‰ æ°¸è¿œä¸è¦æ··ç”¨\nåã€ä¸€å¥è¯å°ç¥æ€»ç»“ TimescaleDB æ˜¯â€œæ—¶é—´è½´æ•°æ®åº“â€\nTIMESTAMPTZ æ˜¯â€œå”¯ä¸€åˆæ³•æ—¶é—´ç±»å‹â€\nä¸ç”¨ = è‡ªæ¯æ€§èƒ½ + åŸ‹é›·\n","description":"åœ¨ PostgreSQL ä¸­ï¼ŒTIMESTAMP å’Œ TIMESTAMPTZ çš„åŒºåˆ«æ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“è¸©å‘ã€ä½†åˆéå¸¸é‡è¦çš„é—®é¢˜ã€‚\nä¸€å¥è¯ç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰\nPostgreSQL åªæœ‰ TIMESTAMPTZ çœŸæ­£â€œæ‡‚æ—¶åŒºâ€ï¼ŒTIMESTAMP åªæ˜¯â€œå¸¦æ—¥æœŸçš„å­—ç¬¦ä¸²â€ã€‚\nä¸€ã€ç±»å‹å®šä¹‰å¯¹æ¯”ï¼ˆæœ¬è´¨åŒºåˆ«ï¼‰ ç±»å‹ å…¨å æ˜¯å¦å­˜æ—¶åŒº æœ¬è´¨ TIMESTAMP timestamp without time zone âŒ ä¸å­˜ çº¯æ—¥æœŸ + æ—¶é—´ TIMESTAMPTZ timestamp with time zone âœ… é€»è¾‘ä¸Šæœ‰ å­˜ UTC æ—¶é—´ç‚¹ âš ï¸ å…³é”®ç‚¹ï¼š\nTIMESTAMPTZ å¹¶ä¸ä¼šå­˜â€œ+08:00â€è¿™æ ·çš„æ—¶åŒºå­—ç¬¦ä¸²\nå®ƒä¼šï¼š\nè¾“å…¥æ—¶ -\u0026gt; è½¬æˆ UTC å­˜å‚¨ æŸ¥è¯¢æ—¶ -\u0026gt; æŒ‰ä¼šè¯æ—¶åŒºè½¬å›æ¥æ˜¾ç¤º äºŒã€å­˜å‚¨ä¸æ˜¾ç¤ºæœºåˆ¶ï¼ˆæ ¸å¿ƒå·®å¼‚ï¼‰ 1ï¸âƒ£ TIMESTAMPï¼ˆä¸å…³å¿ƒæ—¶åŒºï¼‰ CREATE TABLE t1 ( ts TIMESTAMP ); SET TIME ZONE \u0026#39;Asia/Shanghai\u0026#39;; INSERT INTO t1 VALUES (\u0026#39;2025-01-01 12:00:00\u0026#39;); SET TIME ZONE \u0026#39;UTC\u0026#39;; SELECT ts FROM t1; ç»“æœä»ç„¶æ˜¯ï¼š\n"},{"id":392,"href":"/database/prometheus/","title":"Prometheus","parent":"Database","content":"Document List:\nPrometheus FAQ Prometheus åŸºç¡€æ•™ç¨‹ Prometheus æ ¸å¿ƒæ¦‚å¿µ Prometheus æ ¸å¿ƒæ¦‚å¿µ Prometheus è¿ç»´ ","description":"Document List:\nPrometheus FAQ Prometheus åŸºç¡€æ•™ç¨‹ Prometheus æ ¸å¿ƒæ¦‚å¿µ Prometheus æ ¸å¿ƒæ¦‚å¿µ Prometheus è¿ç»´ "},{"id":393,"href":"/database/prometheus/exporter/","title":"Prometheus æ ¸å¿ƒæ¦‚å¿µ","parent":"Prometheus","content":" ä¸€ã€ä»€ä¹ˆæ˜¯ Exporterï¼Ÿ Exporter = æŒ‡æ ‡é‡‡é›†é€‚é…å™¨\nä¸€å¥è¯ï¼š\nExporter è´Ÿè´£æŠŠâ€œè¢«ç›‘æ§å¯¹è±¡çš„çŠ¶æ€â€è½¬æ¢æˆ Prometheus èƒ½ç†è§£çš„ /metrics æ ¼å¼ã€‚\nPrometheus ä¸ä¼šä¸»åŠ¨é‡‡é›†ç³»ç»ŸæŒ‡æ ‡ï¼Œå®ƒåªä¼šï¼š\nHTTP GET /metrics Exporter å°±æ˜¯è¿™ä¸ª /metrics çš„æä¾›è€…ã€‚\näºŒã€Exporter çš„å·¥ä½œæ¨¡å¼ 2.1 åŸºæœ¬æµç¨‹ [ç³»ç»Ÿ / åº”ç”¨ / ä¸­é—´ä»¶] â†“ Exporter â†“ /metrics (HTTP) Prometheus Prometheus å®šæœŸ Pull Exporter çš„ /metricsã€‚\n2.2 Exporter çš„ä¸¤ç§å½¢æ€ ç±»å‹ è¯´æ˜ ç¤ºä¾‹ ç‹¬ç«‹è¿›ç¨‹ å•ç‹¬è¿è¡Œçš„ exporter node_exporter å†…åµŒ SDK åº”ç”¨è‡ªèº«æš´éœ²æŒ‡æ ‡ Python/Java SDK ä¸‰ã€Prometheus å®˜æ–¹ä¸å¸¸è§ Exporter 3.1 ç³»ç»Ÿä¸åŸºç¡€è®¾æ–½ Exporter è¯´æ˜ ç«¯å£ node_exporter Linux æœåŠ¡å™¨ CPU/å†…å­˜/ç£ç›˜ 9100 windows_exporter Windows ä¸»æœº 9182 blackbox_exporter HTTP/TCP/ICMP æ¢æµ‹ 9115 3.2 æ•°æ®åº“ Exporter è¯´æ˜ mysqld_exporter MySQL postgres_exporter PostgreSQL mongodb_exporter MongoDB redis_exporter Redis elasticsearch_exporter ES 3.3 ä¸­é—´ä»¶ \u0026amp; æœåŠ¡ Exporter è¯´æ˜ nginx_exporter Nginx kafka_exporter Kafka rabbitmq_exporter RabbitMQ zookeeper_exporter ZooKeeper haproxy_exporter HAProxy 3.4 å®¹å™¨ \u0026amp; Kubernetes Exporter è¯´æ˜ cAdvisor å®¹å™¨èµ„æº kube-state-metrics K8S èµ„æºçŠ¶æ€ kubelet metrics Pod/Node æŒ‡æ ‡ å››ã€Exporter è¾“å‡ºæ ¼å¼ï¼ˆéå¸¸é‡è¦ï¼‰ 4.1 æ–‡æœ¬æ ¼å¼ï¼ˆPrometheus Exposition Formatï¼‰ ç¤ºä¾‹ï¼š\n# HELP node_cpu_seconds_total Seconds the CPUs spent in each mode. # TYPE node_cpu_seconds_total counter node_cpu_seconds_total{cpu=\u0026#34;0\u0026#34;,mode=\u0026#34;idle\u0026#34;} 12345.67 åŒ…å«ï¼š\n# HELPï¼šæŒ‡æ ‡è¯´æ˜ # TYPEï¼šæŒ‡æ ‡ç±»å‹ metric + labels + value 4.2 æŒ‡æ ‡å‘½åè§„èŒƒ é¡¹ è§„åˆ™ åç§° å°å†™ + ä¸‹åˆ’çº¿ å•ä½ _seconds _bytes _total è¯­ä¹‰ åªæè¿°â€œæ˜¯ä»€ä¹ˆâ€ äº”ã€Exporter é…ç½®ä¸ Prometheus é›†æˆ 5.1 Prometheus é…ç½®ç¤ºä¾‹ scrape_configs: - job_name: \u0026#39;node\u0026#39; static_configs: - targets: - 10.0.0.1:9100 - 10.0.0.2:9100 5.2 Exporter å¥åº·æ£€æŸ¥ curl http://localhost:9100/metrics | head å…­ã€Exporter è®¾è®¡åŸåˆ™ 6.1 Exporter ä¸åšä»€ä¹ˆï¼Ÿ âŒ ä¸å­˜å‚¨æ•°æ® âŒ ä¸åšèšåˆ âŒ ä¸åšå‘Šè­¦ âŒ ä¸æ¨é€æ•°æ® 6.2 Exporter åº”è¯¥åšä»€ä¹ˆï¼Ÿ âœ… å¿«é€Ÿé‡‡é›† âœ… æš´éœ²çœŸå®çŠ¶æ€ âœ… æ ‡ç­¾ç¨³å®š âœ… ä½å¼€é”€ ä¸ƒã€é«˜åŸºæ•°ï¼ˆHigh Cardinalityï¼‰é—®é¢˜ 7.1 Exporter æ˜¯é«˜åŸºæ•°çš„æºå¤´ é”™è¯¯ç¤ºä¾‹ï¼š\nrequest_duration_seconds{url=\u0026#34;/user/12345\u0026#34;} æ­£ç¡®ç¤ºä¾‹ï¼š\nrequest_duration_seconds{handler=\u0026#34;/user/:id\u0026#34;} 7.2 Exporter å±‚é¢è§£å†³æ–¹æ³• æ§åˆ¶ label æ•°é‡ label åªè¡¨ç¤ºç»´åº¦ï¼Œä¸è¡¨ç¤ºå®ä¾‹ å…³é—­ä¸å¿…è¦çš„ metrics ä½¿ç”¨ \u0026ndash;collector.disable-defaults å…«ã€Pushgateway ä¸ Exporter çš„å…³ç³» å¯¹æ¯” Exporter Pushgateway æ¨¡å¼ Pull Push åœºæ™¯ é•¿æœŸæœåŠ¡ çŸ­ä»»åŠ¡ è‡ªåŠ¨æ¸…ç† æœ‰ æ—  æ˜¯å¦æ¨è âœ… âš ï¸ ä»…ç‰¹å®šåœºæ™¯ ä¹ã€è‡ªå®šä¹‰ Exporterï¼ˆå®æˆ˜ï¼‰ 9.1 Python è‡ªå®šä¹‰ Exporter from prometheus_client import start_http_server, Gauge import time cpu_temp = Gauge(\u0026#39;cpu_temp_celsius\u0026#39;, \u0026#39;CPU temperature\u0026#39;) start_http_server(8000) while True: cpu_temp.set(55.3) time.sleep(5) 9.2 Go è‡ªå®šä¹‰ Exporterï¼ˆç”Ÿäº§é¦–é€‰ï¼‰ prometheus.NewGaugeFunc( prometheus.GaugeOpts{ Name: \u0026#34;app_status\u0026#34;, Help: \u0026#34;Application status\u0026#34;, }, func() float64 { return 1 }, ) åã€Exporter å¸¸è§é—®é¢˜ï¼ˆè¿ç»´å¿…ä¼šï¼‰ 10.1 Exporter æŒ‡æ ‡çªç„¶æ¶ˆå¤± ç¨‹åºé‡å¯ æŒ‡æ ‡åç§°å˜æ›´ label å˜åŒ–å¯¼è‡´æ–° series 10.2 Exporter å¯¼è‡´ Prometheus OOM é«˜åŸºæ•° label histogram bucket è¿‡å¤š exporter bug æ— é™æš´éœ²æ–°æŒ‡æ ‡ 10.3 Exporter æœ¬èº« CPU é«˜ é‡‡é›†é€»è¾‘è¿‡é‡ scrape interval å¤ªçŸ­ å¹¶å‘è¿‡é«˜ åä¸€ã€Exporter æœ€ä½³å®è·µæ€»ç»“ ä¸€æŒ‡æ ‡ = ä¸€äº‹å®\næ ‡ç­¾ = ç»´åº¦ï¼Œä¸æ˜¯æ•°æ®\nå°‘å³æ˜¯å¤š\nå…ˆè®¾è®¡æŒ‡æ ‡ï¼Œå†å†™ä»£ç \nä»»ä½• exporter éƒ½è¦é™åˆ¶ cardinality\nåäºŒã€æ€»ç»“ Exporter çš„èŒè´£æ˜¯ æš´éœ²çœŸå®ã€ç¨³å®šã€ä½åŸºæ•°çš„æŒ‡æ ‡æ¥å£\nPrometheus é€šè¿‡ Pull æ¨¡å¼å‘¨æœŸæ€§é‡‡é›†\næŒ‡æ ‡è®¾è®¡çš„å¥½åï¼Œç›´æ¥å†³å®šæ•´ä¸ªç›‘æ§ç³»ç»Ÿæ˜¯å¦å¯ç”¨\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯ Exporterï¼Ÿ Exporter = æŒ‡æ ‡é‡‡é›†é€‚é…å™¨\nä¸€å¥è¯ï¼š\nExporter è´Ÿè´£æŠŠâ€œè¢«ç›‘æ§å¯¹è±¡çš„çŠ¶æ€â€è½¬æ¢æˆ Prometheus èƒ½ç†è§£çš„ /metrics æ ¼å¼ã€‚\nPrometheus ä¸ä¼šä¸»åŠ¨é‡‡é›†ç³»ç»ŸæŒ‡æ ‡ï¼Œå®ƒåªä¼šï¼š\nHTTP GET /metrics Exporter å°±æ˜¯è¿™ä¸ª /metrics çš„æä¾›è€…ã€‚\näºŒã€Exporter çš„å·¥ä½œæ¨¡å¼ 2.1 åŸºæœ¬æµç¨‹ [ç³»ç»Ÿ / åº”ç”¨ / ä¸­é—´ä»¶] â†“ Exporter â†“ /metrics (HTTP) Prometheus Prometheus å®šæœŸ Pull Exporter çš„ /metricsã€‚\n"},{"id":394,"href":"/database/prometheus/operation/","title":"Prometheus è¿ç»´","parent":"Prometheus","content":"å†…å®¹ï¼šéƒ¨ç½²ã€é…ç½®ã€ç›‘æ§ã€å­˜å‚¨ä¼˜åŒ–ã€é›†ç¾¤æ‰©å®¹ã€å®‰å…¨ã€å¤‡ä»½æ¢å¤ã€æ’é”™ã€æœ€ä½³å®è·µ\n1. Prometheus æ¶æ„ä¸å·¥ä½œåŸç† Prometheus é‡‡ç”¨ æ‹‰æ¨¡å¼ (Pull) ä» Exporter æˆ–åº”ç”¨ /metrics è·å–æŒ‡æ ‡ï¼Œå­˜å‚¨åˆ°æœ¬åœ° TSDBï¼Œä½¿ç”¨ PromQL æŸ¥è¯¢ï¼Œå¹¶é€šè¿‡ Alertmanager å‘å‡ºå‘Šè­¦ã€‚\næ ¸å¿ƒç»„ä»¶ï¼š\nç»„ä»¶ ä½œç”¨ Prometheus Server æŠ“å–ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å‘Šè­¦è®¡ç®— Alertmanager å‘Šè­¦åˆ†ç»„ã€å»é‡ã€æŠ‘åˆ¶ã€é€šçŸ¥ Exporter æš´éœ²ç›‘æ§æŒ‡æ ‡ï¼ˆnodeã€redisã€mysql ç­‰ï¼‰ Pushgateway ç”¨äºçŸ­å‘¨æœŸä»»åŠ¡æ¨é€æŒ‡æ ‡ Grafana å¯è§†åŒ– 2. Prometheus éƒ¨ç½²ä¸è¿è¡Œ äºŒè¿›åˆ¶éƒ¨ç½²ï¼ˆå¼ºçƒˆæ¨èï¼‰\næ“ä½œç³»ç»Ÿå»ºè®®ï¼šLinux x86/armï¼Œå»ºè®®ä½¿ç”¨ systemd ç®¡ç†\nä¸‹è½½ï¼š\nwget https://github.com/prometheus/prometheus/releases/latest/download/prometheus-*.linux-amd64.tar.gz tar xf prometheus-*.tar.gz cp prometheus promtool /usr/local/bin/ mkdir -p /etc/prometheus /data/prometheus cp -r consoles console_libraries /etc/prometheus/ systemdï¼š\n[Unit] Description=Prometheus Server After=network-online.target [Service] User=prometheus ExecStart=/usr/local/bin/prometheus \\ --config.file=/etc/prometheus/prometheus.yml \\ --storage.tsdb.path=/data/prometheus \\ --storage.tsdb.retention.time=30d \\ --web.enable-lifecycle \\ --web.enable-admin-api \\ --storage.tsdb.wal-compression Restart=on-failure [Install] WantedBy=multi-user.target 3. Prometheus æ ¸å¿ƒé…ç½®ï¼ˆprometheus.ymlï¼‰ 3.1 å…¨å±€å‚æ•° global: scrape_interval: 15s evaluation_interval: 15s scrape_timeout: 10s 3.2 æŠ“å–èŠ‚ç‚¹ç¤ºä¾‹ scrape_configs: - job_name: \u0026#39;node\u0026#39; static_configs: - targets: - 10.0.0.1:9100 - 10.0.0.2:9100 3.3 Kubernetes æŠ“å– å¦‚æœä½ æ˜¯ K8Sï¼š\nscrape_configs: - job_name: \u0026#39;kubernetes-nodes\u0026#39; kubernetes_sd_configs: - role: node 3.4 Alertmanager é…ç½® alerting: alertmanagers: - static_configs: - targets: [\u0026#34;10.0.0.5:9093\u0026#34;] 4. Prometheus èµ„æºè§„åˆ’ï¼ˆéå¸¸å…³é”®ï¼‰ ç›‘æ§è§„æ¨¡ TS æ•°é‡ æœåŠ¡å™¨å»ºè®®é…ç½® å°å‹ï¼ˆ\u0026lt;50å°ï¼‰ 500k 2C / 4G / 50GB ä¸­å‹ï¼ˆ\u0026lt;200å°ï¼‰ 1â€“5M 4Câ€“8C / 16â€“32G / 200GB å¤§å‹ï¼ˆ\u0026gt;500å°ï¼‰ 5Mâ€“20M ä¸å»ºè®®å•æœº -\u0026gt; Thanos/Cortex âš ï¸ Prometheus å•æœºä¸æ˜¯æ— é™æ‰©å®¹çš„\nâš ï¸ å†…å­˜ä¸»è¦å–å†³äºâ€œæ—¶é—´åºåˆ—æ•°é‡â€ï¼ˆlabels çˆ†ç‚¸ï¼‰\n5. TSDB å­˜å‚¨ä¼˜åŒ–ï¼ˆè¿ç»´æ ¸å¿ƒï¼‰ Prometheus TSDB ç›®å½•ç»“æ„ï¼š\n/data/prometheus â”œâ”€â”€ wal/ å†™å‰æ—¥å¿—ï¼ˆå®æ—¶ï¼‰ â”œâ”€â”€ chunks_head/ å†…å­˜æ•°æ®æŒä¹…åŒ– â””â”€â”€ 01AABBCCDDEEFG/ å‹ç¼©æ•°æ®å—ï¼ˆ2å°æ—¶ 1 ä¸ª blockï¼‰ 5.1 å­˜å‚¨ä¼˜åŒ–é¡¹ å­˜å‚¨æ”¾ SSDï¼ˆå¿…è¦ï¼‰ WAL å†™å…¥éå¸¸é¢‘ç¹ï¼ŒHDD ä¼šè®©æŠ“å–å¡æ­»ã€‚\nè°ƒæ•´æ•°æ®ä¿ç•™å¤©æ•° --storage.tsdb.retention.time=15d å¯ç”¨ WAL å‹ç¼© --storage.tsdb.wal-compression é¿å…é«˜åŸºæ•°æ ‡ç­¾ï¼ˆæœ€é‡è¦ï¼‰ é«˜åŸºæ•° = OOM/OOMKill å¡æ­» âŒ user_id âŒ session_id âŒ pod UID âŒ request_id âŒ random å€¼ 6. Prometheus é«˜å¯ç”¨ï¼ˆHAï¼‰ Prometheus æœ¬èº«æ˜¯å•ç‚¹ï¼Œä½†å¯ä»¥ç”¨ åŒæœºçƒ­å¤‡ å®ç°é«˜å¯ç”¨ï¼š\nPrometheus A \u0026lt;- same targets -\u0026gt; Prometheus B Alertmanager è´Ÿè´£å‘Šè­¦å»é‡ã€‚\nç¼ºç‚¹ï¼šæ•°æ®ä¸å…±äº«ï¼Œä½†å¯¹äºå‘Šè­¦ç³»ç»Ÿå®Œå…¨å¯æ¥å—ã€‚\n7. Prometheus æ‰©å±•åˆ°å¤§è§„æ¨¡ï¼ˆ\u0026gt;200+ èŠ‚ç‚¹ï¼‰ ä½¿ç”¨ Thanos æˆ– VictoriaMetricsã€‚\nThanos ç»„ä»¶\nSidecarï¼ˆè¿æ¥ Prometheusï¼‰ Storeï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ Queryï¼ˆèšåˆæŸ¥è¯¢ï¼‰ Compactorï¼ˆæ•°æ®å‹ç¼©ï¼‰ Rulerï¼ˆåˆ†å¸ƒå¼å‘Šè­¦ï¼‰ ä¼˜åŠ¿ï¼š\næ— é™å­˜å‚¨ å¤š Prometheus èšåˆæŸ¥è¯¢ è‡ªåŠ¨å»é‡ æ€§èƒ½é«˜ 8. å®‰å…¨åŠ å›ºï¼ˆProduction Securityï¼‰ Prometheus é»˜è®¤æ— é‰´æƒã€æ—  HTTPSï¼Œå› æ­¤å¿…é¡»åŠ å›ºã€‚\nä½¿ç”¨ Nginx/Traefik åš HTTPS + è®¤è¯ auth_basic \u0026#34;Auth\u0026#34;; auth_basic_user_file /etc/nginx/.passwd; éšè—ç®¡ç†æ¥å£ ç¦ç”¨ï¼š\n--web.enable-admin-api=False æˆ–ä¿æŠ¤ /api/v1/admin/* è·¯å¾„ã€‚\nä½¿ç”¨é˜²ç«å¢™é™åˆ¶ 9090 è®¿é—® 9. å¤‡ä»½ä¸æ¢å¤ Prometheus çš„ TSDB æ”¯æŒåœ¨çº¿ Snapshotã€‚\n9.1 åœ¨çº¿ Snapshotï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰ curl -XPOST http://localhost:9090/api/v1/admin/tsdb/snapshot Snapshot å­˜æ”¾åœ¨ï¼š\n/data/prometheus/snapshots/xxxxxx/ 9.2 å†·å¤‡ï¼ˆå»ºè®®ï¼‰ systemctl stop prometheus tar czf prometheus-backup.tar.gz /data/prometheus systemctl start prometheus 9.3 æ¢å¤ ç›´æ¥è¦†ç›–æ•°æ®ç›®å½•å³å¯ã€‚\n10. ç›‘æ§ Prometheus è‡ªèº« Prometheus è‡ªç›‘æ§éå¸¸é‡è¦ã€‚\næ¨èæŠ“å–è‡ªèº«ï¼š\nscrape_configs: - job_name: \u0026#39;prometheus\u0026#39; static_configs: - targets: [\u0026#39;localhost:9090\u0026#39;] å¸¸ç”¨ç›‘æ§æŒ‡æ ‡ï¼š\næŒ‡æ ‡ å«ä¹‰ prometheus_tsdb_head_series å½“å‰æ—¶åºé‡ï¼ˆå®¹é‡æ ¸å¿ƒï¼‰ prometheus_tsdb_wal_corruptions_total WAL æŸå prometheus_engine_query_duration_seconds æŸ¥è¯¢è€—æ—¶ prometheus_tsdb_compaction_duration_seconds å‹ç¼©è€—æ—¶ 11. å‘Šè­¦ï¼ˆAlertmanagerï¼‰ å¼ºçƒˆå»ºè®®è‡³å°‘é…ç½®ä»¥ä¸‹å‘Šè­¦ï¼š\nPrometheus è‡ªèº« TSDB Series \u0026gt; é˜ˆå€¼ ç›®æ ‡æŠ“å–å¤±è´¥ Scrape timeout WAL é”™è¯¯ Node Exporterï¼ˆç³»ç»Ÿï¼‰ CPU ä½¿ç”¨ç‡é«˜ å†…å­˜ \u0026gt; 90% ç£ç›˜ \u0026gt; 80% load è¿‡é«˜ network error Exporter è‡ªèº«å®•æœº 12. å¸¸è§æ•…éšœæ’æŸ¥ï¼ˆTroubleshootingï¼‰ 12.1 Prometheus CPU/å†…å­˜å¾ˆé«˜ é«˜åŸºæ•° label æŸ¥è¯¢è¯­å¥è¿‡é‡ï¼ˆGrafanaï¼‰ æŠ“å–é—´éš”å¤ªå¿« è§£å†³æ–¹æ³•ï¼š\næŸ¥ label æ•°é‡ ç”¨ recording rules å›ºåŒ–å¤æ‚è®¡ç®— é™åˆ¶ Grafana æŸ¥è¯¢æ—¶é—´èŒƒå›´ 12.2 æŠ“å–å¤±è´¥ é˜²ç«å¢™é˜»æŒ¡ /metrics ä¸å­˜åœ¨ exporter æŒ‚äº† TLS è¯ä¹¦é—®é¢˜ ICMP / DNS é—®é¢˜ 12.3 Prometheus å¯åŠ¨æ…¢/æ— å“åº” block å¤ªå¤š TSDB ç›®å½•æŸå æœªæ­£å¸¸å…³é—­å¯¼è‡´ WAL æ¢å¤è¿‡ä¹… å¯ä»¥ï¼š\npromtool tsdb analyze /data/prometheus 12.4 Grafana æŸ¥è¯¢å¾ˆæ…¢ æŸ¥è¯¢æ—¶é—´è·¨åº¦å¤ªå¤§ï¼ˆ\u0026gt;24hï¼‰ æŸ¥è¯¢æœªåŠ æ ‡ç­¾è¿‡æ»¤ å¤§é‡ label join 13. è¿ç»´æœ€ä½³å®è·µï¼ˆå…³é”®æ€»ç»“ï¼‰ æ—¶é—´åºåˆ—æ§åˆ¶åœ¨å¯æ§èŒƒå›´ \u0026lt; 5M å®Œå…¨èƒ½è·‘\n20M å¿…é¡»ä¸Š Thanos / VM\nTSDB æ”¾ SSDï¼ˆæœ€é‡è¦ï¼‰ å®šæœŸ Snapshot å¤‡ä»½ ä»»ä½•ç›‘æ§ç³»ç»Ÿå¿…é¡» HA PromQL æŸ¥è¯¢å¿…é¡»åˆç†ï¼ˆé¿å…å…¨ç›˜æ‰«æï¼‰ æ ‡ç­¾ç»´åº¦å¿…é¡»å¯æ§ï¼ˆé¿å… label çˆ†ç‚¸ï¼‰ ","description":"å†…å®¹ï¼šéƒ¨ç½²ã€é…ç½®ã€ç›‘æ§ã€å­˜å‚¨ä¼˜åŒ–ã€é›†ç¾¤æ‰©å®¹ã€å®‰å…¨ã€å¤‡ä»½æ¢å¤ã€æ’é”™ã€æœ€ä½³å®è·µ\n1. Prometheus æ¶æ„ä¸å·¥ä½œåŸç† Prometheus é‡‡ç”¨ æ‹‰æ¨¡å¼ (Pull) ä» Exporter æˆ–åº”ç”¨ /metrics è·å–æŒ‡æ ‡ï¼Œå­˜å‚¨åˆ°æœ¬åœ° TSDBï¼Œä½¿ç”¨ PromQL æŸ¥è¯¢ï¼Œå¹¶é€šè¿‡ Alertmanager å‘å‡ºå‘Šè­¦ã€‚\næ ¸å¿ƒç»„ä»¶ï¼š\nç»„ä»¶ ä½œç”¨ Prometheus Server æŠ“å–ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å‘Šè­¦è®¡ç®— Alertmanager å‘Šè­¦åˆ†ç»„ã€å»é‡ã€æŠ‘åˆ¶ã€é€šçŸ¥ Exporter æš´éœ²ç›‘æ§æŒ‡æ ‡ï¼ˆnodeã€redisã€mysql ç­‰ï¼‰ Pushgateway ç”¨äºçŸ­å‘¨æœŸä»»åŠ¡æ¨é€æŒ‡æ ‡ Grafana å¯è§†åŒ– 2. Prometheus éƒ¨ç½²ä¸è¿è¡Œ äºŒè¿›åˆ¶éƒ¨ç½²ï¼ˆå¼ºçƒˆæ¨èï¼‰\n"},{"id":395,"href":"/backend/python/pydantic/","title":"Pydantic","parent":"Python","content":"Directory List:\nPydantic åŸºç¡€æ•™ç¨‹ ","description":"Directory List:\nPydantic åŸºç¡€æ•™ç¨‹ "},{"id":396,"href":"/backend/python/","title":"Python","parent":"Backend","content":"Awesome Python: https://github.com/vinta/awesome-python\nğŸŒ Web æ¡†æ¶ä¸æœåŠ¡ ç”¨äºæ„å»ºå’Œéƒ¨ç½²ç½‘ç»œåº”ç”¨ç¨‹åºï¼ˆå°¤å…¶æ˜¯ APIï¼‰ã€‚\nfastapi: ä¸€ä¸ªç°ä»£ã€é«˜æ€§èƒ½çš„ Web æ¡†æ¶ï¼Œç”¨äºæ„å»º APIã€‚ gunicorn: ä¸€ä¸ª WSGI HTTP æœåŠ¡å™¨ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½² Python Web åº”ç”¨ï¼ˆå¦‚ FastAPI æˆ– Djangoï¼‰ã€‚ ğŸ•·ï¸ Web æŠ“å–ä¸è‡ªåŠ¨åŒ– ç”¨äºä»ç½‘ç»œä¸Šè·å–æ•°æ®æˆ–è‡ªåŠ¨æ‰§è¡Œæµè§ˆå™¨æ“ä½œã€‚\nrequests: ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ HTTP å®¢æˆ·ç«¯åº“ï¼Œç”¨äºå‘é€ç½‘ç»œè¯·æ±‚ã€‚ aiohttp: ä¸€ä¸ªåŸºäº asyncio çš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯/æœåŠ¡å™¨åº“ã€‚å®ƒæ—¢å¯ä»¥ç”¨æ¥æ„å»º Web æœåŠ¡ï¼ˆç±»ä¼¼ FastAPIï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å‘èµ·å¼‚æ­¥ç½‘ç»œè¯·æ±‚ï¼ˆç±»ä¼¼ Requestsï¼‰ã€‚ beautiful-soup: ç”¨äºè§£æ HTML å’Œ XML æ–‡æ¡£çš„åº“ï¼Œå¸¸ç”¨äºç½‘é¡µæŠ“å–ï¼ˆWeb Scrapingï¼‰ã€‚ playwright: ä¸€ä¸ªç”¨äº Web æµ‹è¯•å’Œè‡ªåŠ¨åŒ–çš„åº“ï¼Œå¯ä»¥æ§åˆ¶çœŸå®çš„æµè§ˆå™¨ï¼ˆå¦‚ Chrome, Firefoxï¼‰è¿›è¡Œæ“ä½œã€‚ ğŸ“Š æ•°æ®ç§‘å­¦ä¸åˆ†æ ä¸“æ³¨äºæ•°å€¼è®¡ç®—ã€æ•°æ®å¤„ç†ã€åˆ†æå’Œé‡‘èæŠ€æœ¯ã€‚\nnumpy: Python ç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œæä¾›äº†å¼ºå¤§çš„ N ç»´æ•°ç»„å¯¹è±¡å’Œæ•°å­¦å‡½æ•°ã€‚ pandas: ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ•°æ®åˆ†æå’Œå¤„ç†åº“ï¼Œæä¾›äº† DataFrame ç­‰æ•°æ®ç»“æ„ã€‚ polars: ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„é«˜æ€§èƒ½ DataFrame åº“ï¼Œè¢«è§†ä¸º pandas çš„ä¸€ä¸ªæå¿«æ›¿ä»£å“ã€‚ ta-lib: (Technical Analysis Library) æŠ€æœ¯åˆ†æåº“ï¼Œå¹¿æ³›ç”¨äºé‡‘èé¢†åŸŸï¼Œå¤„ç†è‚¡ç¥¨ã€æœŸè´§ç­‰å¸‚åœºæ•°æ®ã€‚ ğŸ—„ï¸ æ•°æ®åº“ä¸ç¼“å­˜ ç”¨äºä¸å„ç§æ•°æ®åº“æˆ–ç¼“å­˜ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚\nsqlalchemy: ä¸€ä¸ªå¼ºå¤§çš„ SQL å·¥å…·åŒ…å’Œå¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆORMï¼‰åº“ï¼Œç”¨äºä¸å…³ç³»å‹æ•°æ®åº“äº¤äº’ã€‚ redis: ç”¨äºè¿æ¥å’Œæ“ä½œ Redisï¼ˆä¸€ä¸ªé«˜æ€§èƒ½çš„å†…å­˜é”®å€¼æ•°æ®åº“/ç¼“å­˜ï¼‰çš„å®¢æˆ·ç«¯åº“ã€‚ ğŸ§¬ æ•°æ®éªŒè¯ä¸åºåˆ—åŒ– è¿™ç±»åº“ç”¨äºç¡®ä¿æ•°æ®ç»“æ„çš„æ­£ç¡®æ€§ï¼Œä»¥åŠåœ¨ä¸åŒæ ¼å¼ï¼ˆå¦‚ JSONï¼‰ä¹‹é—´é«˜æ•ˆè½¬æ¢ã€‚\npydantic: ä¾èµ–ç±»å‹æç¤ºè¿›è¡Œæ•°æ®éªŒè¯å’Œè®¾ç½®ç®¡ç†çš„åº“ï¼Œå¸¸ä¸ FastAPI é…åˆä½¿ç”¨ã€‚ orjson: ä¸€ä¸ªé«˜æ€§èƒ½ã€æ­£ç¡®çš„ Python JSON åº“ï¼Œç”¨äºå¿«é€Ÿåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ ğŸ› ï¸ åŸºç¡€å·¥å…·ä¸å®‰å…¨ æä¾›é€šç”¨çš„è¾…åŠ©åŠŸèƒ½ï¼Œå¦‚æ—¥å¿—è®°å½•å’ŒåŠ å¯†ã€‚\nloguru: ä¸€ä¸ªæ—¨åœ¨è®© Python æ—¥å¿—è®°å½•å˜å¾—ç®€å•ã€æ„‰å¿«çš„åº“ã€‚ arrow: ä¸€ä¸ªç”¨äºåˆ›å»ºã€æ“ä½œã€æ ¼å¼åŒ–å’Œè½¬æ¢æ—¥æœŸã€æ—¶é—´ä¸æ—¶é—´æˆ³çš„ Python åº“ï¼Œå®ƒæä¾›äº†æ¯”å†…ç½® datetime æ›´å‹å¥½å’Œæ™ºèƒ½çš„ APIã€‚ cryptography: ä¸€ä¸ªæä¾›åŠ å¯†åŸè¯­å’Œâ€œé…æ–¹â€çš„åº“ï¼Œæ—¨åœ¨æˆä¸º Python åŠ å¯†æ“ä½œçš„æ ‡å‡†åº“ï¼Œå®‰å…¨æ€§é«˜ä¸”ç°ä»£ã€‚ pycryptodome: ä¸€ä¸ªåº•å±‚çš„åŠ å¯†åŸè¯­åº“ï¼Œæä¾›äº†å“ˆå¸Œã€åŠ å¯†ã€ç­¾åç­‰åŠŸèƒ½ã€‚ ğŸ’¡ æç¤º:\nåœ¨ç°ä»£å¼€å‘ä¸­ï¼Œcryptography é€šå¸¸æ˜¯é¦–é€‰ï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´é«˜çº§åˆ«çš„å®‰å…¨æŠ½è±¡ï¼ˆå¦‚ Fernet å¯¹ç§°åŠ å¯†ï¼‰ï¼Œè€Œä¸”æ›´æ–°ç»´æŠ¤éå¸¸æ´»è·ƒï¼›è€Œ pycryptodome åˆ™å¸¸ç”¨äºéœ€è¦ç›´æ¥æ“ä½œåº•å±‚ç®—æ³•æˆ–å…¼å®¹æ—§ä»£ç çš„åœºæ™¯ã€‚ Document List:\nOfficial Aiohttp Arrow Beautiful Soup Cryptography FastAPI Loguru orjson Pandas Playwright Pydantic Redis Requests SQLAlchemy ","description":"Awesome Python: https://github.com/vinta/awesome-python\nğŸŒ Web æ¡†æ¶ä¸æœåŠ¡ ç”¨äºæ„å»ºå’Œéƒ¨ç½²ç½‘ç»œåº”ç”¨ç¨‹åºï¼ˆå°¤å…¶æ˜¯ APIï¼‰ã€‚\nfastapi: ä¸€ä¸ªç°ä»£ã€é«˜æ€§èƒ½çš„ Web æ¡†æ¶ï¼Œç”¨äºæ„å»º APIã€‚ gunicorn: ä¸€ä¸ª WSGI HTTP æœåŠ¡å™¨ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½² Python Web åº”ç”¨ï¼ˆå¦‚ FastAPI æˆ– Djangoï¼‰ã€‚ ğŸ•·ï¸ Web æŠ“å–ä¸è‡ªåŠ¨åŒ– ç”¨äºä»ç½‘ç»œä¸Šè·å–æ•°æ®æˆ–è‡ªåŠ¨æ‰§è¡Œæµè§ˆå™¨æ“ä½œã€‚\nrequests: ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ HTTP å®¢æˆ·ç«¯åº“ï¼Œç”¨äºå‘é€ç½‘ç»œè¯·æ±‚ã€‚ aiohttp: ä¸€ä¸ªåŸºäº asyncio çš„å¼‚æ­¥ HTTP å®¢æˆ·ç«¯/æœåŠ¡å™¨åº“ã€‚å®ƒæ—¢å¯ä»¥ç”¨æ¥æ„å»º Web æœåŠ¡ï¼ˆç±»ä¼¼ FastAPIï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å‘èµ·å¼‚æ­¥ç½‘ç»œè¯·æ±‚ï¼ˆç±»ä¼¼ Requestsï¼‰ã€‚ beautiful-soup: ç”¨äºè§£æ HTML å’Œ XML æ–‡æ¡£çš„åº“ï¼Œå¸¸ç”¨äºç½‘é¡µæŠ“å–ï¼ˆWeb Scrapingï¼‰ã€‚ playwright: ä¸€ä¸ªç”¨äº Web æµ‹è¯•å’Œè‡ªåŠ¨åŒ–çš„åº“ï¼Œå¯ä»¥æ§åˆ¶çœŸå®çš„æµè§ˆå™¨ï¼ˆå¦‚ Chrome, Firefoxï¼‰è¿›è¡Œæ“ä½œã€‚ ğŸ“Š æ•°æ®ç§‘å­¦ä¸åˆ†æ ä¸“æ³¨äºæ•°å€¼è®¡ç®—ã€æ•°æ®å¤„ç†ã€åˆ†æå’Œé‡‘èæŠ€æœ¯ã€‚\n"},{"id":397,"href":"/library/py-ezkit/","title":"Python ezKit","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":398,"href":"/library/py-fastapi/","title":"Python FastAPI","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":399,"href":"/library/py-numpy/","title":"Python Numpy","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":400,"href":"/library/py-pandas/","title":"Python Pandas","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":401,"href":"/library/py-redis/","title":"Python Redis","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":402,"href":"/library/py-requests/","title":"Python Requests","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":403,"href":"/library/py-sqlalchemy/","title":"Python SQLAlchemy","parent":"Library","content":"Document List:\n","description":"Document List:\n"},{"id":404,"href":"/backend/python/official/queue/","title":"Queue (é˜Ÿåˆ—)","parent":"Official","content":" ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨åˆ°å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Ÿ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—éå¸¸å¸¸ç”¨ï¼Œåªè¦åœºæ™¯ å¼ºè°ƒâ€œé¡ºåºå¤„ç†â€ã€â€œå…ˆæ¥çš„å…ˆå¤„ç†â€ã€â€œæ’é˜Ÿâ€ï¼Œéƒ½æ˜¯å…¸å‹ä½¿ç”¨åœºæ™¯ã€‚\nä»¥ä¸‹æ˜¯åˆ†ç±»ï¼‹å…·ä½“å®ä¾‹ï¼Œè®©ä½ ä¸€çœ¼å°±æ‡‚ã€‚\nâœ… ä¸€ã€æ“ä½œç³»ç»Ÿ \u0026amp; ç½‘ç»œä¸­çš„ FIFO 1.1 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå…¸å‹ï¼‰ ç”Ÿäº§è€…æ”¾ä»»åŠ¡ï¼Œæ¶ˆè´¹è€…æŒ‰é¡ºåºå¤„ç†ï¼Œä¾‹å¦‚ï¼š\nçˆ¬è™«ä»»åŠ¡é˜Ÿåˆ—ï¼ˆURL å…ˆåŠ å…¥å…ˆçˆ¬ï¼‰ æ—¥å¿—å†™å…¥é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†ï¼ˆå¦‚ RabbitMQ / Redis Listï¼‰ from queue import Queue q = Queue() q.put(\u0026#34;task1\u0026#34;) q.put(\u0026#34;task2\u0026#34;) print(q.get()) # task1 1.2 IO è¯·æ±‚é˜Ÿåˆ—ï¼ˆç£ç›˜ã€ç½‘ç»œï¼‰ ç³»ç»Ÿä¼šæŒ‰è¯·æ±‚é¡ºåºå¤„ç†è¯»å†™ä»»åŠ¡ã€‚\nâœ… äºŒã€ä¸šåŠ¡é€»è¾‘ä¸­çš„â€œæ’é˜Ÿåœºæ™¯â€ 2.1 è®¢å•å¤„ç†ç³»ç»Ÿ å…ˆä¸‹å•çš„è®¢å•è¦å…ˆå¤„ç†ä¸­ã€‚\n2.2 å®¢æœå·¥å•æ’é˜Ÿ ç”¨æˆ·å·¥å•æŒ‰æäº¤é¡ºåºå¤„ç†ã€‚\n2.3 æ¥å£é™æµã€æ’é˜Ÿç­‰å€™ ä¾‹å¦‚ï¼š\nAPI é™æµï¼šè¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼ŒæŒ‰é¡ºåºå¤„ç† ç§’æ€ç³»ç»Ÿï¼šæŠ¢è´­è¯·æ±‚å…ˆåˆ°å…ˆå¤„ç† âœ… ä¸‰ã€æ•°æ®ç»“æ„ä¸ç®—æ³•ä¸­çš„ FIFO 3.1 å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆBFSï¼‰å¿…ç”¨é˜Ÿåˆ— ä¾‹å¦‚å›¾éå†ã€æœ€çŸ­è·¯å¾„ç®—æ³• Dijkstraï¼ˆç®€åŒ–åœºæ™¯ï¼‰ã€æ ‘å±‚æ¬¡éå†ã€‚\nfrom collections import deque queue = deque([start]) 3.2 æ¶ˆæ¯ã€äº‹ä»¶ã€ä»»åŠ¡è°ƒåº¦å™¨ å…¸å‹å¦‚ï¼š\næ¸¸æˆå¾ªç¯äº‹ä»¶é˜Ÿåˆ— äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼ˆäº‹ä»¶å…ˆæ¥å…ˆå¤„ç†ï¼‰ GUI/å‰ç«¯çš„äº‹ä»¶å¾ªç¯ âœ… å››ã€æµå¼æ•°æ®ã€å®æ—¶ç³»ç»Ÿ 4.1 æ—¥å¿—æ”¶é›†ï¼ˆlog pipelineï¼‰ æ—¥å¿—æŒ‰æ—¶é—´å®æ—¶è¿›å…¥é˜Ÿåˆ— -\u0026gt; åç«¯å¤„ç†ã€‚\n4.2 æ•°æ®æµç®¡é“ï¼ˆstreamingï¼‰ Kafka / Flink / Spark éƒ½ä½¿ç”¨ç±»ä¼¼ FIFO çš„ç»“æ„ã€‚\nâœ… äº”ã€ç¼“å­˜ä¸­çš„ FIFO ç­–ç•¥ï¼ˆç¼“å­˜æ·˜æ±°ç®—æ³•ï¼‰ æ¯”å¦‚ï¼š\nFIFO Cacheï¼šæœ€æ—©è¿›å…¥çš„æœ€å…ˆæ·˜æ±° ä½†æ³¨æ„ï¼šçœŸå®ç³»ç»Ÿæ›´å¸¸ç”¨ LRUï¼Œå› ä¸º FIFO å¹¶ä¸è€ƒè™‘è®¿é—®é¢‘ç‡ã€‚\nâœ… å…­ã€å‰ç«¯ \u0026amp; Webï¼šè¯·æ±‚é˜Ÿåˆ—ã€åŠ¨ç”»é˜Ÿåˆ— ä¾‹å¦‚ï¼š\nå‰ç«¯ Ajax è¯·æ±‚æ’é˜Ÿ JS åŠ¨ç”»é˜Ÿåˆ—ï¼ˆjQueryï¼‰ ğŸ“Œ æ€»ç»“ï¼šFIFO é€‚ç”¨äº -\u0026gt; â€œé¡ºåºä¸èƒ½ä¹±â€ çš„åœºæ™¯ åœºæ™¯ ä¸ºä»€ä¹ˆ FIFOï¼Ÿ è®¢å•/å·¥å•æ’é˜Ÿ å…¬å¹³ï¼ŒæŒ‰æ—¶é—´é¡ºåºå¤„ç† æ¶ˆæ¯é˜Ÿåˆ— MQ äº‹ä»¶é¡ºåºä¸èƒ½ä¹± çˆ¬è™«ä»»åŠ¡é˜Ÿåˆ— URL æŒ‰å…ˆåçˆ¬å– æ—¥å¿—å†™å…¥ æ—¥å¿—æ˜¯æ—¶é—´åºåˆ— BFS éå† å±‚åºæ‰«æéœ€è¦å…ˆå…¥å…ˆå‡º ç¼“å­˜ FIFO æŒ‰åŠ å…¥é¡ºåºæ·˜æ±° é™æµæ’é˜Ÿ é˜²æ­¢è¯·æ±‚çˆ†ç‚¸ ä½¿ç”¨ for å’Œ queue å¤„ç†é¡ºåºé˜Ÿåˆ—æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ä¸‹é¢ç”¨æœ€æ¸…æ™°ã€æœ€å®æˆ˜çš„æ–¹å¼å‘Šè¯‰ä½ ï¼š\nfor å¾ªç¯é¡ºåºå¤„ç†åˆ—è¡¨ vs Queueï¼ˆé˜Ÿåˆ—ï¼‰å¤„ç†é¡ºåºé˜Ÿåˆ—ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«ã€ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªã€‚\nâœ… æ ¸å¿ƒåŒºåˆ«æ€»ç»“è¡¨ åœºæ™¯/ç‰¹æ€§ for å¤„ç†åˆ—è¡¨ queue.Queue / deque æ˜¯å¦çº¿ç¨‹å®‰å…¨ âŒå¦ âœ…æ˜¯ï¼ˆqueue.Queueï¼‰ æ˜¯å¦åŠ¨æ€æ·»åŠ ä»»åŠ¡ âŒéå†æœŸé—´ä¸èƒ½å®‰å…¨å˜åŠ¨ âœ…å¯ä»¥è¾¹æ¶ˆè´¹è¾¹è¿½åŠ  æ˜¯å¦é€‚åˆç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ âŒä¸é€‚åˆ âœ…éå¸¸é€‚åˆ æ˜¯å¦é˜»å¡ç­‰å¾…ä»»åŠ¡ âŒä¸ä¼šé˜»å¡ âœ…å¯ä»¥ get(block=True) ç­‰å¾… æ˜¯å¦è‡ªåŠ¨å¤„ç†åŒæ­¥é” âŒæ²¡æœ‰ âœ…å†…ç½®é”æœºåˆ¶ é€‚åˆæ•°æ®è§„æ¨¡ å°åˆ°ä¸­ ä¸­åˆ°å¤§ï¼Œå¹¶ç”¨äºå¹¶å‘ é€‚ç”¨åœºæ™¯ ç®€å•é¡ºåºå¤„ç† å·¥ä½œé˜Ÿåˆ—ã€è°ƒåº¦ã€çº¿ç¨‹æ± ã€è‡ªå®šä¹‰ä»»åŠ¡é˜Ÿåˆ— ğŸ§© åŒºåˆ« 1ï¼šæ‰§è¡Œæ¨¡å‹ä¸åŒ forï¼šå¤„ç†ä¸€ä¸ªå›ºå®šçš„é™æ€åºåˆ— tasks = [1, 2, 3] for t in tasks: process(t) ç‰¹ç‚¹ï¼š\ntasks æ˜¯å†™æ­»çš„ï¼Œéå†å¼€å§‹åä¸é€‚åˆä¿®æ”¹ï¼ˆåˆ /å¢å¯èƒ½å¯¼è‡´è¶Šç•Œã€æ¼å¤„ç†ï¼‰ ä¸èƒ½åŠ¨æ€æ¥æ”¶æ–°ä»»åŠ¡ Queueï¼šåŠ¨æ€ä»»åŠ¡æµï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åŠ å…¥ from queue import Queue import threading q = Queue() def worker(): while True: t = q.get() process(t) q.task_done() # å¯ä»¥éšæ—¶æ·»åŠ æ–°ä»»åŠ¡ q.put(1) q.put(2) q.put(3) ç‰¹ç‚¹ï¼š\nå¯åŠ¨æ€è¿½åŠ ä»»åŠ¡ worker æ°¸è¿œç­‰ç€æ¥ä»»åŠ¡ï¼ˆé˜»å¡ç­‰å¾…ï¼‰ ğŸ§© åŒºåˆ« 2ï¼šå¹¶å‘ä¸çº¿ç¨‹å®‰å…¨ âŒ for å¾ªç¯ä¸æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å¤„ç†\nå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåˆ—è¡¨ä¼šï¼š\nå†…å®¹è¢«ä¿®æ”¹ é¡ºåºæ— æ³•ä¿è¯ æ²¡æœ‰é”ä¿æŠ¤ âœ… Queue ä¸“ä¸ºå¤šçº¿ç¨‹è®¾è®¡ï¼ˆå†…ç½®é”ï¼‰\nq = Queue() def worker(): while True: item = q.get() # do work q.task_done() for _ in range(4): threading.Thread(target=worker).start() Queue å¯ä»¥å®‰å…¨é«˜æ•ˆå®ç°â€œ4 ä¸ªçº¿ç¨‹åŒæ—¶å–ä»»åŠ¡â€çš„åœºæ™¯ã€‚\nğŸ§© åŒºåˆ« 3ï¼šé˜»å¡æœºåˆ¶ for æ˜¯éé˜»å¡çš„ â€”â€” æ•°æ®æ²¡äº†å°±ç»“æŸ\nQueue å¯ä»¥é˜»å¡ç­‰å¾…ä»»åŠ¡\ntask = q.get(block=True) # å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šç­‰å¾…æ–°çš„ä»»åŠ¡ é€‚ç”¨äºï¼š\nå®ˆæŠ¤çº¿ç¨‹ æ¶ˆæ¯é˜Ÿåˆ— åå°å·¥ä½œæœåŠ¡ï¼ˆæŒç»­å¤„ç†ï¼‰ ğŸ§© åŒºåˆ« 4ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹æ˜¯å¦é€‚ç”¨ âŒ for ä¸èƒ½å®ç°çœŸå®çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼\nå› ä¸ºæ¶ˆè´¹è€…æ— æ³•ç­‰å¾…ç”Ÿäº§è€…ä¸æ–­ç”Ÿäº§ã€‚\nâœ… Queue å®Œç¾æ”¯æŒ\nç”Ÿäº§è€…\nq.put(task) æ¶ˆè´¹è€…\nq.get() ğŸ§© åŒºåˆ« 5ï¼šæ˜¯å¦èƒ½é‡ç‚¹æ§åˆ¶ä»»åŠ¡æµç¨‹ Queue æä¾›ï¼š\nq.task_done() q.join() maxsize é™åˆ¶ é˜»å¡è¡Œä¸ºæ§åˆ¶ for å¾ªç¯å®Œå…¨åšä¸åˆ°ã€‚\nğŸ“Œ ä»€ä¹ˆæ—¶å€™ç”¨ for å¾ªç¯ï¼Ÿ é€‚ç”¨äºï¼š\næ•°æ®é‡å° ä»»åŠ¡å›ºå®šã€ä¸å˜ å•çº¿ç¨‹ æ— éœ€åŠ¨æ€è¿½åŠ ä»»åŠ¡ ä¾‹å¦‚ï¼š\nfor file in file_list: process_file(file) ğŸ“Œ ä»€ä¹ˆæ—¶å€™å¿…é¡»ç”¨ Queueï¼Ÿï¼ˆæ¨èä½¿ç”¨ï¼‰ éœ€è¦å¹¶å‘å¤„ç†ä»»åŠ¡ï¼ˆå¤šçº¿ç¨‹ / å¤šè¿›ç¨‹ï¼‰ éœ€è¦å®æ—¶è¿½åŠ ä»»åŠ¡ éœ€è¦ä»»åŠ¡ç­‰å¾…æœºåˆ¶ éœ€è¦ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ ä»»åŠ¡æ•°é‡æœªçŸ¥ã€å¯èƒ½æ— é™å¢é•¿ ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸å‡è¡¡ï¼ˆé˜Ÿåˆ—è‡ªåŠ¨å¹³è¡¡ï¼‰ ååˆ†å¸¸è§åœ¨ï¼š\næŠ“å–çˆ¬è™«ï¼ˆç”Ÿäº§ URL -\u0026gt; worker è¯·æ±‚ï¼‰ æ—¥å¿—æ”¶é›†ç³»ç»Ÿ åå°ä»»åŠ¡æ‰§è¡Œå™¨ æ¶ˆæ¯é˜Ÿåˆ— Worker æ±  è°ƒåº¦ç³»ç»Ÿã€ä½œä¸šç³»ç»Ÿ ğŸ¯ æ€»ç»“ for éå†çš„æ˜¯â€œå›ºå®šåˆ—è¡¨â€ Queue å¤„ç†çš„æ˜¯â€œåŠ¨æ€ä»»åŠ¡æµâ€ for é€‚åˆä¸€æ¬¡æ€§å°ä»»åŠ¡ã€‚\nQueue é€‚åˆéœ€è¦æŒç»­è¿è¡Œã€åŠ¨æ€å¢åŠ ã€å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ç³»ç»Ÿã€‚\nqueue å’Œ collections.deque æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ä»¥ä¸‹æ˜¯ä¸€ä»½æœ€æ¸…æ™°ã€æœ€å®æˆ˜çš„å¯¹æ¯”æ€»ç»“ï¼š\nqueue.Queue vs collections.deque â€”â€” ä¸¤è€…éƒ½æ˜¯â€œé˜Ÿåˆ—â€ï¼Œä½†ç”¨æ³•å’Œç›®çš„å·®åˆ«éå¸¸å¤§ã€‚\nâœ… ä¸€å¼ è¡¨æ€»ç»“åŒºåˆ« ç‰¹æ€§ queue.Queue collections.deque æ˜¯å¦çº¿ç¨‹å®‰å…¨ âœ…æ˜¯ï¼ˆå†…ç½®é”ï¼‰ âš ï¸å¦ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰ æ˜¯å¦æ”¯æŒé˜»å¡/è¶…æ—¶ âœ…æ”¯æŒ get(block=True)ã€put(timeout=) âŒä¸æ”¯æŒé˜»å¡ç­‰å¾… é€‚åˆå¤šçº¿ç¨‹å·¥ä½œé˜Ÿåˆ—å— â­æœ€ä½³é€‰æ‹© âŒä¸é€‚åˆ æ€§èƒ½ è¾ƒæ…¢ï¼ˆé”å¼€é”€ï¼‰ â­æé«˜ï¼ˆO(1) åŒç«¯æ“ä½œï¼‰ å…è®¸ä»ä¸¤ç«¯æ“ä½œ âŒåªæ”¯æŒ put/get âœ…æ”¯æŒ append/appendleft/pop/popleft æ˜¯å¦æ”¯æŒ maxlen âŒä¸æ”¯æŒ âœ…æ”¯æŒå›ºå®šé•¿åº¦è‡ªåŠ¨ä¸¢å¼ƒæ—§æ•°æ® é€‚åˆå•çº¿ç¨‹é˜Ÿåˆ—å—ï¼Ÿ å¯ç”¨ä½†ä¸å¿…è¦ â­æœ€ä½³é€‰æ‹© å…¸å‹ç”¨é€” çº¿ç¨‹æ± ã€æ¶ˆè´¹è€…æ¨¡å‹ ç¼“å†²åŒºã€ä»»åŠ¡åˆ—è¡¨ã€LRU ç¼“å­˜ã€ç®€å•é˜Ÿåˆ— ğŸ§© 1. queue.Queueï¼šç»™å¤šçº¿ç¨‹å‡†å¤‡çš„â€œå®‰å…¨é˜Ÿåˆ—â€ ç‰¹ç‚¹ï¼š\nå†…ç½®é”ï¼ˆthread-safeï¼‰ è‡ªå¸¦é˜»å¡æœºåˆ¶ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…å¿…ç”¨ï¼‰ æä¾› put/getã€task_done/join é€Ÿåº¦æ¯” deque æ…¢ ç¤ºä¾‹ï¼šçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼ˆç”Ÿäº§è€…-æ¶ˆè´¹è€…ç»å…¸å†™æ³•ï¼‰\nfrom queue import Queue import threading q = Queue() def worker(): while True: task = q.get() # ä¼šé˜»å¡ç­‰å¾… print(\u0026#34;work:\u0026#34;, task) q.task_done() threading.Thread(target=worker, daemon=True).start() q.put(1) q.put(2) q.put(3) q.join() é€‚ç”¨äºï¼š\nå¤šçº¿ç¨‹ä»»åŠ¡è°ƒåº¦ åå° worker ä»»åŠ¡é˜Ÿåˆ— æ¶ˆæ¯é˜Ÿåˆ— ä¼˜é›…çš„çº¿ç¨‹åŒæ­¥ ğŸ§© 2. collections.dequeï¼šæœ€å¿«é€Ÿçš„åŒç«¯é˜Ÿåˆ—ï¼ˆæ— é”ï¼‰ ç‰¹ç‚¹ï¼š\nè¶…å¿«ï¼ˆC å®ç°ï¼ŒO(1) æ“ä½œï¼‰ æ”¯æŒä»ä¸¤ç«¯æ“ä½œ é»˜è®¤ä¸å®‰å…¨ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰ å¯è®¾å®š maxlen ç”¨ä½œç¯å½¢ç¼“å†²åŒº ç¤ºä¾‹ï¼šå•çº¿ç¨‹ FIFO é˜Ÿåˆ—\nfrom collections import deque dq = deque() dq.append(1) dq.append(2) print(dq.popleft()) # 1 print(dq.popleft()) # 2 ç”¨ä½œå›ºå®šé•¿åº¦ç¼“å­˜\ndq = deque(maxlen=3) dq.extend([1,2,3,4]) print(dq) # deque([2,3,4], maxlen=3) é€‚ç”¨äºï¼š\nå•çº¿ç¨‹çš„ä»»åŠ¡åˆ—è¡¨ LRU ç¼“å­˜ æ»‘åŠ¨çª—å£æ•°æ®ç»Ÿè®¡ é«˜æ€§èƒ½é˜Ÿåˆ—å¤„ç† åŒç«¯é˜Ÿåˆ—ç»“æ„ ğŸ§© 3. åŠŸèƒ½å¯¹æ¯”ï¼ˆç¤ºä¾‹å¯¹æ¯”è¯´æ˜ï¼‰ ğŸ”¸é˜»å¡ç­‰å¾…ï¼Ÿ Queue\nq.get() # ä¼šé˜»å¡ç­‰å¾…æ–°ä»»åŠ¡ deque\ndq.popleft() # å¦‚æœç©ºï¼šæŠ¥é”™ IndexErrorï¼Œè€Œä¸æ˜¯é˜»å¡ ğŸ”¸çº¿ç¨‹å®‰å…¨ï¼Ÿ Queue\n# å¤šçº¿ç¨‹è¯»å†™å®‰å…¨ q.put(x) dequeï¼ˆä¸å®‰å…¨ï¼‰\n# å¤šçº¿ç¨‹è¯»å†™è¦è‡ªå·±åŠ é” lock = threading.Lock() with lock: dq.append(x) ğŸ”¸é€Ÿåº¦ï¼Ÿ deque è¿œå¿«äº Queue Queue å› ä¸ºåŠ é”å’Œé˜»å¡æœºåˆ¶è€Œæ…¢ å¦‚æœä½ å†™çš„æ˜¯å•çº¿ç¨‹é˜Ÿåˆ— -\u0026gt; ç”¨ deque\nå¦‚æœä½ å†™çš„æ˜¯å¤šçº¿ç¨‹é˜Ÿåˆ— -\u0026gt; ç”¨ Queue\nğŸ§© 4. åˆ°åº•æ€ä¹ˆé€‰æ‹©ï¼Ÿï¼ˆæœ€å®æˆ˜å»ºè®®ï¼‰ | ä½¿ç”¨åœºæ™¯ | æ¨è | | å¤šçº¿ç¨‹ä»»åŠ¡é˜Ÿåˆ— | â­queue.Queue | | éœ€è¦é˜»å¡ç­‰å¾…ä»»åŠ¡ | â­queue.Queue | | å•çº¿ç¨‹é«˜æ€§èƒ½ FIFO | â­deque | | åŒç«¯æ“ä½œçš„æ•°æ®ç»“æ„ | â­deque | | å®ç° LRU ç¼“å­˜ | deque(maxlen=) | | å®æ—¶æµæ•°æ®ã€æ»‘åŠ¨çª—å£ | deque | | éœ€è¦ task_done/join | queue.Queue |\nğŸ¯ æ€»ç»“ Queue æ˜¯ â€œå®‰å…¨çš„æ…¢é˜Ÿåˆ—â€ï¼Œdeque æ˜¯ â€œå¿«ä½†ä¸å®‰å…¨çš„é˜Ÿåˆ—â€ã€‚\nå¤šçº¿ç¨‹ -\u0026gt; Queue å•çº¿ç¨‹é«˜æ€§èƒ½ -\u0026gt; deque åŒç«¯ç»“æ„ -\u0026gt; deque æ¶ˆè´¹è€…æ¨¡å‹ -\u0026gt; Queue ç»“åˆ Redis å®ç°é˜Ÿåˆ—æ“ä½œ ä¸‹é¢ç»™ä½ ä¸€ä»½ æœ€å®æˆ˜ã€å¯ç›´æ¥ç”¨åœ¨é¡¹ç›®ä¸­çš„ Redis é˜Ÿåˆ—ï¼ˆFIFO/LIFO/å»¶æ—¶/å¯é é˜Ÿåˆ—ï¼‰æ–¹æ¡ˆï¼Œé€‚åˆä½ çš„ FastAPI / Python ç¯å¢ƒã€‚\nâœ… ä¸€ã€Redis ä¸ºä»€ä¹ˆé€‚åˆä½œé˜Ÿåˆ—ï¼Ÿ Redis åŸç”Ÿæ”¯æŒï¼š\nåˆ—è¡¨å‹é˜Ÿåˆ—ï¼ˆlist -\u0026gt; LPUSH / RPUSH / LPOP / BRPOPï¼‰ é˜»å¡é˜Ÿåˆ—ï¼ˆBRPOPã€BLPOPï¼‰ å»¶æ—¶é˜Ÿåˆ—ï¼ˆsorted setï¼‰ å¯é é˜Ÿåˆ—ï¼ˆack æ¨¡å¼ï¼‰ï¼ˆRPOPLPUSHï¼‰ å¹¶ä¸”ï¼š\næ— é”ï¼ˆå•çº¿ç¨‹æ‰§è¡Œï¼‰ è¶…å¿«ï¼ˆå†…å­˜ï¼‰ é›†ç¾¤å¯æ‰©å±• æœåŠ¡é—´é€šä¿¡æœ€ä½³é€‰æ‹©ä¹‹ä¸€ ğŸ”¥ äºŒã€æœ€æ¨èçš„ä¸‰ç§ Redis é˜Ÿåˆ—æ¨¡å¼ï¼ˆå¸¦ä»£ç ï¼‰ âœ… 1. ç®€å• FIFO é˜Ÿåˆ—ï¼ˆæœ€å¸¸ç”¨ï¼‰ ä½¿ç”¨ Redis listï¼š\nLPUSH queue key RPOP queue æ¨ä»»åŠ¡ï¼ˆç”Ÿäº§è€…ï¼‰\nimport redis r = redis.Redis() def push_task(task: str): r.lpush(\u0026#34;task_queue\u0026#34;, task) å–ä»»åŠ¡ï¼ˆæ¶ˆè´¹è€…ï¼‰\ndef pop_task(): return r.rpop(\u0026#34;task_queue\u0026#34;) ç‰¹ç‚¹ï¼š\nFIFO ä¸é˜»å¡ ç®€å•é«˜æ•ˆ âœ… 2. é˜»å¡é˜Ÿåˆ—ï¼ˆæ¨èï¼‰ â€”â€” æ¶ˆè´¹è€…å¯ä»¥â€œç­‰å¾…ä»»åŠ¡â€ BLPOP queue timeout BRPOP queue timeout æ¶ˆè´¹è€…ç¤ºä¾‹ï¼ˆé˜»å¡æ¨¡å¼ï¼‰\ndef worker(): while True: task = r.brpop(\u0026#34;task_queue\u0026#34;, timeout=0) # æ°¸ä¹…é˜»å¡ key, value = task print(\u0026#34;å¤„ç†ä»»åŠ¡ï¼š\u0026#34;, value.decode()) ç‰¹ç‚¹ï¼š\nä¸éœ€è¦ while + sleep é«˜æ€§èƒ½ æ¶ˆè´¹è€…ç­‰ä»»åŠ¡çš„æ—¶å€™ä¸ä¼šæµªè´¹ CPU âœ… 3. å¯é é˜Ÿåˆ—ï¼ˆack æœºåˆ¶ï¼‰ â€”â€” æ¶ˆè´¹å¤±è´¥ä»»åŠ¡ä¸ä¼šä¸¢ é€šè¿‡ Redis å‘½ä»¤ï¼š\nRPOPLPUSH source processing_queue æ¶ˆè´¹å¤±è´¥æ—¶å†æŠŠä»»åŠ¡æ”¾å› sourceã€‚\nç”Ÿäº§è€…\ndef push_task(task: str): r.lpush(\u0026#34;task_queue\u0026#34;, task) æ¶ˆè´¹è€…ï¼ˆå¸¦ ACKï¼‰\ndef worker(): while True: task = r.rpoplpush(\u0026#34;task_queue\u0026#34;, \u0026#34;processing_queue\u0026#34;) try: # å¤„ç†ä»»åŠ¡ print(f\u0026#34;å¤„ç†ä»»åŠ¡ï¼š{task.decode()}\u0026#34;) # æˆåŠŸåç§»é™¤å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ r.lrem(\u0026#34;processing_queue\u0026#34;, 1, task) except Exception: # ä¸åˆ é™¤ï¼Œç•™ä¸‹å¤„ç†é˜Ÿåˆ—ï¼Œç¨åæ¢å¤ print(\u0026#34;ä»»åŠ¡å¤±è´¥ï¼Œå°†åœ¨ä¹‹åé‡è¯•\u0026#34;) ç‰¹ç‚¹ï¼š\nworker å´©æºƒæ—¶ä»»åŠ¡ä¸ä¼šä¸¢ å¯ç”¨ä¸€ä¸ªå®šæ—¶å™¨æ‰«æ processing_queue æ¢å¤å¤±è´¥ä»»åŠ¡ ğŸ”¥ ä¸‰ã€Redis å»¶æ—¶é˜Ÿåˆ—ï¼ˆé€‚åˆå®šæ—¶ä»»åŠ¡ï¼‰ ä½¿ç”¨ ZSETï¼š\nZADD delay_queue score(timestamp) value 1ï¼‰ç”Ÿäº§è€…ï¼ˆè®¾ç½®æœªæ¥æ‰§è¡Œçš„æ—¶é—´ï¼‰ def delay_push(task: str, delay_seconds: int): timestamp = time.time() + delay_seconds r.zadd(\u0026#34;delay_queue\u0026#34;, {task: timestamp}) 2ï¼‰æ¶ˆè´¹è€…ï¼ˆæ¯ç§’æ£€æŸ¥å¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡ï¼‰ def delay_worker(): while True: now = time.time() tasks = r.zrangebyscore(\u0026#34;delay_queue\u0026#34;, 0, now, start=0, num=1) if not tasks: time.sleep(0.5) continue task = tasks[0] if r.zrem(\u0026#34;delay_queue\u0026#34;, task): # é˜²æ­¢å¹¶å‘é‡å¤åˆ é™¤ print(\u0026#34;æ‰§è¡Œå»¶æ—¶ä»»åŠ¡ï¼š\u0026#34;, task.decode()) ğŸ”¥ å››ã€Redis é˜Ÿåˆ— vs Python å†…ç½® queue/deque åŠŸèƒ½ Redis queue.Queue deque å¤šè¿›ç¨‹/å¤šæœºå™¨å…±äº« â­æ”¯æŒ âŒä¸æ”¯æŒ âŒä¸æ”¯æŒ è¶…é«˜æ€§èƒ½ â­â­ ä¸­ â­â­ é˜»å¡ç­‰å¾… BRPOP get(block=True) âŒ å¯é é˜Ÿåˆ— â­æ”¯æŒ âŒ âŒ å»¶æ—¶é˜Ÿåˆ— â­æ”¯æŒ âŒ âŒ é€‚ç”¨åœºæ™¯ åˆ†å¸ƒå¼ã€å¤šæœåŠ¡ å•æœºå¤šçº¿ç¨‹ å•çº¿ç¨‹ç»“æ„ Redis é€‚åˆä½ çš„ çˆ¬è™«åˆ†å¸ƒå¼è°ƒåº¦ã€ä»»åŠ¡é˜Ÿåˆ—ã€å¼‚æ­¥æœåŠ¡ã€‚\nğŸ”¥ äº”ã€ä¸ºä½ çš„é¡¹ç›®å®šåˆ¶ï¼šRedisQueue ç±»ï¼ˆå¯ç›´æ¥ç”¨ï¼‰ import redis import json from typing import Any class RedisQueue: def __init__(self, name: str, host=\u0026#34;localhost\u0026#34;, port=6379, db=0): self.name = name self.r = redis.Redis(host=host, port=port, db=db) def push(self, data: Any): self.r.lpush(self.name, json.dumps(data)) def pop(self, block=True, timeout=0): if block: result = self.r.brpop(self.name, timeout=timeout) if result: _, value = result return json.loads(value) return None else: value = self.r.rpop(self.name) return json.loads(value) if value else None def size(self): return self.r.llen(self.name) ä½¿ç”¨\nq = RedisQueue(\u0026#34;task_queue\u0026#34;) q.push({\u0026#34;id\u0026#34;: 1, \u0026#34;action\u0026#34;: \u0026#34;crawl\u0026#34;}) task = q.pop() print(task) ","description":" ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨åˆ°å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Ÿ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—éå¸¸å¸¸ç”¨ï¼Œåªè¦åœºæ™¯ å¼ºè°ƒâ€œé¡ºåºå¤„ç†â€ã€â€œå…ˆæ¥çš„å…ˆå¤„ç†â€ã€â€œæ’é˜Ÿâ€ï¼Œéƒ½æ˜¯å…¸å‹ä½¿ç”¨åœºæ™¯ã€‚\nä»¥ä¸‹æ˜¯åˆ†ç±»ï¼‹å…·ä½“å®ä¾‹ï¼Œè®©ä½ ä¸€çœ¼å°±æ‡‚ã€‚\nâœ… ä¸€ã€æ“ä½œç³»ç»Ÿ \u0026amp; ç½‘ç»œä¸­çš„ FIFO 1.1 å¤šçº¿ç¨‹/å¤šè¿›ç¨‹ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå…¸å‹ï¼‰ ç”Ÿäº§è€…æ”¾ä»»åŠ¡ï¼Œæ¶ˆè´¹è€…æŒ‰é¡ºåºå¤„ç†ï¼Œä¾‹å¦‚ï¼š\nçˆ¬è™«ä»»åŠ¡é˜Ÿåˆ—ï¼ˆURL å…ˆåŠ å…¥å…ˆçˆ¬ï¼‰ æ—¥å¿—å†™å…¥é˜Ÿåˆ— æ¶ˆæ¯å¤„ç†ï¼ˆå¦‚ RabbitMQ / Redis Listï¼‰ from queue import Queue q = Queue() q.put(\u0026#34;task1\u0026#34;) q.put(\u0026#34;task2\u0026#34;) print(q.get()) # task1 1.2 IO è¯·æ±‚é˜Ÿåˆ—ï¼ˆç£ç›˜ã€ç½‘ç»œï¼‰ ç³»ç»Ÿä¼šæŒ‰è¯·æ±‚é¡ºåºå¤„ç†è¯»å†™ä»»åŠ¡ã€‚\n"},{"id":405,"href":"/backend/python/official/random/","title":"Random","parent":"Official","content":" ğŸ¯ 1. random æ˜¯ä»€ä¹ˆï¼Ÿ Python çš„ random æ¨¡å—ä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆMersenne Twisterï¼‰ï¼Œé€‚ç”¨äºï¼š\næ•°æ®é‡‡æ · éšæœºæ‰“ä¹± æ¨¡æ‹Ÿã€æµ‹è¯• ç”Ÿæˆéšæœº token éšæœºç­‰å¾…æ—¶é—´ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰ éšæœºé€‰æ‹©å†…å®¹ï¼ˆæ¶ˆæ¯ã€æƒ…ç»ªä»·å€¼è¯æœ¯ç­‰ï¼‰ ä¸é€‚ç”¨äºå¯†ç å®‰å…¨åœºæ™¯ï¼ï¼ˆè¯·ç”¨ secrets æ¨¡å—ï¼‰\nğŸŸ¦ 2. å¸¸è§éšæœºæ•°å‡½æ•° 2.1 è·å– [0.0, 1.0) çš„éšæœºæµ®ç‚¹æ•° import random random.random() 2.2 è·å–èŒƒå›´éšæœºæµ®ç‚¹æ•° random.uniform(1.5, 3.8) åŒ…å«ä¸¤ä¸ªç«¯ç‚¹ã€‚\n2.3 è·å–éšæœºæ•´æ•° random.randint(1, 10) # åŒ…å« 1 å’Œ 10 random.randrange(1, 10) # ä¸åŒ…å« 10 ğŸŸ© 3. éšæœºé€‰æ‹©ä¸é‡‡æ · 3.1 éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´  random.choice([\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;]) 3.2 éšæœºé€‰æ‹©å¤šä¸ªï¼ˆä¸é‡å¤ï¼‰ random.sample(range(100), 5) 3.3 éšæœºé€‰æ‹©å¤šä¸ªï¼ˆå¯é‡å¤ï¼‰ random.choices([\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;], k=3) æ”¯æŒæƒé‡ï¼š\nrandom.choices([\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;], weights=[0.7, 0.2, 0.1], k=10) ğŸŸ¦ 4. éšæœºæ‰“ä¹± data = [1, 2, 3, 4, 5] random.shuffle(data) ğŸŸ© 5. éšæœºç­‰å¾…æ—¶é—´ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰ import time time.sleep(random.uniform(0.5, 1.5)) ğŸŸ¦ 6. éšæœº Token / ID ç”Ÿæˆ è™½ç„¶ random ä¸å®‰å…¨ï¼Œä½†ç”¨äºä¸€èˆ¬ç”¨é€”å¯ä»¥ï¼š\ntoken = \u0026#39;\u0026#39;.join(random.choices(\u0026#34;abcdefghijklmnopqrstuvwxyz0123456789\u0026#34;, k=16)) å®‰å…¨åœºæ™¯è¯·ç”¨ï¼š\nimport secrets secrets.token_hex(16) ğŸŸ© 7. éšæœºç§å­ seed ä¸ºäº†å¯å¤ç°çš„éšæœºç»“æœï¼š\nrandom.seed(1234) é‡å¯è„šæœ¬åç›¸åŒçš„éšæœºæ•°é¡ºåºä¼šé‡å¤å‡ºç°ã€‚\nğŸŸ¦ 8. æ­£æ€åˆ†å¸ƒã€æ¦‚ç‡åˆ†å¸ƒ 8.1 æ­£æ€åˆ†å¸ƒ random.gauss(mu=0, sigma=1) 8.2 ä¸‰è§’åˆ†å¸ƒ random.triangular(low=1, high=5, mode=2) ğŸŸ© 9. ç»¼åˆç¤ºä¾‹ï¼ˆå·¥ç¨‹çº§ï¼‰ 9.1 éšæœºâ€œä»£ç†å»¶è¿Ÿâ€æ¨¡æ‹Ÿï¼ˆçˆ¬è™«ï¼‰ def random_delay(): time.sleep(random.uniform(0.8, 2.0)) 9.2 éšæœºæ ‡é¢˜ç”Ÿæˆï¼ˆé€‚åˆä½ çš„æƒ…ç»ªä»·å€¼è¯æœ¯åº“ï¼‰ def random_title(): titles = [ \u0026#34;ä»Šæ—¥æœ€ç¨³å»ºè®®\u0026#34;, \u0026#34;æƒ…ç»ªä»·å€¼é«˜èƒ½æé†’\u0026#34;, \u0026#34;æš–å¿ƒä¸€å¥è¯\u0026#34;, \u0026#34;ä»Šæ—¥æœ€ä½³æƒ…ç»ªå›é¦ˆ\u0026#34; ] return random.choice(titles) 9.3 éšæœºæŠ½æ ·æ•°æ®åº“å†…å®¹ def pick_random_stocks(db, k=5): all_codes = db.get_all_stock_codes() return random.sample(all_codes, k) 9.4 æ¨¡æ‹Ÿ N æ¬¡ API è°ƒç”¨ for _ in range(100): result = compute(random.random()) ğŸŸ¦ 10. random vs secrets vs numpy.random å¯¹æ¯” æ¨¡å— åœºæ™¯ ç‰¹ç‚¹ random æ™®é€šéšæœº è½»é‡ã€é€Ÿåº¦å¿«ã€éå®‰å…¨ secrets å¯†ç å­¦åœºæ™¯ å®‰å…¨ï¼ˆä¸å¯é¢„æµ‹ï¼‰ numpy.random ç§‘å­¦è®¡ç®— å¼ºå¤§ï¼Œå¯å‘é‡åŒ– ğŸŸ© 11. random æ¨¡å— API ä¸€è§ˆè¡¨ï¼ˆé€ŸæŸ¥ï¼‰ å‡½æ•° è¯´æ˜ random.random() 0-1 æµ®ç‚¹æ•° random.uniform(a, b) éšæœºæµ®ç‚¹ï¼ˆå«ç«¯ç‚¹ï¼‰ random.randint(a, b) éšæœºæ•´æ•°ï¼ˆå«ç«¯ç‚¹ï¼‰ random.randrange(a, b) éšæœºæ•´æ•°ï¼ˆä¸å« bï¼‰ random.choice(seq) éšæœºé€‰ä¸€ä¸ª random.sample(seq, k) é‡‡æ ·ï¼ˆä¸é‡å¤ï¼‰ random.choices(seq, weights, k) é‡‡æ ·ï¼ˆå¯é‡å¤ï¼‰ random.shuffle(list) åŸåœ°æ‰“ä¹± random.seed(x) è®¾ç½®éšæœºç§å­ random.gauss(mu, sigma) æ­£æ€åˆ†å¸ƒ random.triangular(a, b, mode) ä¸‰è§’åˆ†å¸ƒ ğŸŸ¦ æ€»ç»“ï¼ˆé€‚åˆæ”¶è—ï¼‰ random æ¨¡å—æ ¸å¿ƒç”¨é€”ï¼š\nç”Ÿæˆéšæœºæ•°ï¼ˆint/floatï¼‰ éšæœºé€‰æ‹© éšæœºé‡‡æ · éšæœºæ’åˆ— æ¨¡æ‹Ÿæ•°æ® éšæœºå»¶è¿Ÿï¼ˆçˆ¬è™«ï¼‰ æ§åˆ¶ seed å®ç°ç»“æœå¯é‡å¤ ","description":" ğŸ¯ 1. random æ˜¯ä»€ä¹ˆï¼Ÿ Python çš„ random æ¨¡å—ä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆMersenne Twisterï¼‰ï¼Œé€‚ç”¨äºï¼š\næ•°æ®é‡‡æ · éšæœºæ‰“ä¹± æ¨¡æ‹Ÿã€æµ‹è¯• ç”Ÿæˆéšæœº token éšæœºç­‰å¾…æ—¶é—´ï¼ˆçˆ¬è™«å¸¸ç”¨ï¼‰ éšæœºé€‰æ‹©å†…å®¹ï¼ˆæ¶ˆæ¯ã€æƒ…ç»ªä»·å€¼è¯æœ¯ç­‰ï¼‰ ä¸é€‚ç”¨äºå¯†ç å®‰å…¨åœºæ™¯ï¼ï¼ˆè¯·ç”¨ secrets æ¨¡å—ï¼‰\nğŸŸ¦ 2. å¸¸è§éšæœºæ•°å‡½æ•° 2.1 è·å– [0.0, 1.0) çš„éšæœºæµ®ç‚¹æ•° import random random.random() 2.2 è·å–èŒƒå›´éšæœºæµ®ç‚¹æ•° random.uniform(1.5, 3.8) åŒ…å«ä¸¤ä¸ªç«¯ç‚¹ã€‚\n"},{"id":406,"href":"/backend/python/official/range/","title":"Range","parent":"Official","content":" ğŸŸ¦ 1. åŸºæœ¬ç”¨æ³• range() ç”Ÿæˆä¸€ä¸ª â€œæƒ°æ€§åºåˆ—â€ ï¼ˆä¸æ˜¯åˆ—è¡¨ï¼‰ï¼Œå¸¸ç”¨äº for å¾ªç¯ã€‚\nè¯­æ³•ï¼š\nrange(stop) range(start, stop) range(start, stop, step) ğŸŸ© 2. ç¤ºä¾‹ï¼šæœ€å¸¸è§å†™æ³• â‘  ä» 0 åˆ° 9 for i in range(10): print(i) â‘¡ ä» 3 åˆ° 9 for i in range(3, 10): print(i) â‘¢ æ­¥é•¿ step for i in range(0, 10, 2): print(i) # 0 2 4 6 8 ğŸŸ¦ 3. å€’åº for i in range(10, 0, -1): print(i) ç­‰ä»·ï¼š\nfor i in reversed(range(1, 11)): print(i) ğŸŸ© 4. åˆ¤æ–­æŸä¸ªæ•°å­—æ˜¯å¦åœ¨èŒƒå›´å†… if x in range(5, 10): ... range æœ¬èº«æ”¯æŒå¿«é€Ÿåˆ¤æ–­ï¼Œä¸ä¼šéå†ï¼ˆå¸¸é‡æ—¶é—´ï¼‰ã€‚\nğŸŸ¦ 5. è·å– range çš„é•¿åº¦ len(range(10)) # 10 len(range(3, 10)) # 7 len(range(1, 10, 2)) # 5 ğŸŸ© 6. å°† range è½¬ä¸º listï¼ˆä¸æ¨èå¤§èŒƒå›´ï¼‰ list(range(5)) # [0,1,2,3,4] range æ˜¯æƒ°æ€§çš„ï¼Œä¸å å†…å­˜ï¼›ä½† list ä¼šçœŸæ­£å±•å¼€ã€‚\nğŸŸ¦ 7. æ£€æŸ¥æ˜¯å¦ä¸ºç©º rangeï¼ˆè‰¯å¥½å®è·µï¼‰ if range(5): # True if range(0): # False ğŸŸ© 8. range çš„ç‰¹ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰ ä¸å¯å˜ æƒ°æ€§ï¼ˆä¸å±•å¼€ã€ä¸å ç”¨å¤§å†…å­˜ï¼‰ å¯ä»¥å¿«é€Ÿåˆ¤æ–­åŒ…å«ï¼ˆx in range(\u0026hellip;)ï¼‰ æ”¯æŒåˆ‡ç‰‡ï¼ˆä½†ä»ç„¶æ˜¯ rangeï¼‰ ç¤ºä¾‹ï¼š\nr = range(0, 20, 2) r2 = r[1:5] print(r2) # range(2, 10, 2) ğŸŸ¦ 9. range ä¸ for çš„æœ€ä½³å®è·µ for å¾ªç¯æ¬¡æ•°æ˜ç¡®æ—¶ï¼Œç”¨ rangeï¼ˆPythonicï¼‰ for _ in range(3): print(\u0026#34;hello\u0026#34;) éå†åˆ—è¡¨ç”¨ forï¼Œä¸ç”¨ range ä¸æ¨èï¼š\nfor i in range(len(items)): print(items[i]) æ¨èï¼š\nfor item in items: print(item) éœ€è¦ index æ—¶ä½¿ç”¨ enumerate for i, item in enumerate(items): print(i, item) ğŸŸ© 10. é«˜çº§ï¼šrange çš„æ•°å­¦æ„é€ ï¼ˆå·¥ç¨‹æŠ€å·§ï¼‰ ç­‰å·®åºåˆ—ï¼š\nrange(start, stop, step) å¯ä»¥ç”¨äºï¼š\næ‰¹å¤„ç†åˆ†é¡µ æ•°æ®åˆ†ç‰‡ åˆ†æ®µä»»åŠ¡æ§åˆ¶ ç¤ºä¾‹ï¼šåˆ†é¡µæŸ¥è¯¢ï¼ˆä½ é¡¹ç›®é€‚ç”¨ï¼‰\nfor offset in range(0, total, batch_size): batch = data[offset : offset + batch_size] ğŸŸ¦ 11. ä½¿ç”¨ range é¿å…æµ®ç‚¹è¯¯å·®ï¼ˆç»å…¸æŠ€å·§ï¼‰ é”™è¯¯ï¼š\nx = 0 while x \u0026lt; 1: ... x += 0.1 # æµ®ç‚¹è¯¯å·® æ­£ç¡®ï¼š\nfor i in range(10): x = i * 0.1 ... ğŸŸ© 12. range é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰ ç”¨æ³• å†™æ³• 0..n-1 range(n) a..b-1 range(a, b) æ­¥é•¿ range(a, b, step) å€’åº range(b, a, -1) å€’åºæ›´å®‰å…¨ reversed(range(a, b)) è½¬åˆ—è¡¨ list(range(n)) å–é•¿åº¦ len(range(...)) åˆ¤æ–­åŒ…å« x in range(...) åˆ‡ç‰‡ range(...)[s:e] æ— éœ€ index éå† ç”¨ for item in seq éœ€è¦ index éå† ç”¨ enumerate ","description":" ğŸŸ¦ 1. åŸºæœ¬ç”¨æ³• range() ç”Ÿæˆä¸€ä¸ª â€œæƒ°æ€§åºåˆ—â€ ï¼ˆä¸æ˜¯åˆ—è¡¨ï¼‰ï¼Œå¸¸ç”¨äº for å¾ªç¯ã€‚\nè¯­æ³•ï¼š\nrange(stop) range(start, stop) range(start, stop, step) ğŸŸ© 2. ç¤ºä¾‹ï¼šæœ€å¸¸è§å†™æ³• â‘  ä» 0 åˆ° 9 for i in range(10): print(i) â‘¡ ä» 3 åˆ° 9 for i in range(3, 10): print(i) â‘¢ æ­¥é•¿ step for i in range(0, 10, 2): print(i) # 0 2 4 6 8 ğŸŸ¦ 3. å€’åº for i in range(10, 0, -1): print(i) ç­‰ä»·ï¼š\n"},{"id":407,"href":"/frontend/react/","title":"React","parent":"Frontend","content":"Document List:\nReact Learn ","description":"Document List:\nReact Learn "},{"id":408,"href":"/backend/python/redis/","title":"Redis","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£: https://github.com/redis/redis-py\nDirectory List:\nRedis åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ ","description":"å®˜æ–¹æ–‡æ¡£: https://github.com/redis/redis-py\nDirectory List:\nRedis åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ "},{"id":409,"href":"/database/redis/","title":"Redis","parent":"Database","content":"Document List:\nRedis FAQ Redis åŸºç¡€æ•™ç¨‹ Redis æ ¸å¿ƒæ¦‚å¿µ Redis ç»å…¸é—®é¢˜ Redis ç¼“å­˜å‘½ä¸­ç‡ Redis åŸºç¡€ Redis å¤‡ä»½ä¸æ¢å¤ Redis å¸¸ç”¨å‘½ä»¤ Redis æ–‡ä»¶å­˜å‚¨ç›®å½• Redis æœ€ä½³å®è·µ Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜ Redis é›†ç¾¤ ","description":"Document List:\nRedis FAQ Redis åŸºç¡€æ•™ç¨‹ Redis æ ¸å¿ƒæ¦‚å¿µ Redis ç»å…¸é—®é¢˜ Redis ç¼“å­˜å‘½ä¸­ç‡ Redis åŸºç¡€ Redis å¤‡ä»½ä¸æ¢å¤ Redis å¸¸ç”¨å‘½ä»¤ Redis æ–‡ä»¶å­˜å‚¨ç›®å½• Redis æœ€ä½³å®è·µ Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜ Redis é›†ç¾¤ "},{"id":410,"href":"/database/redis/base/","title":"Redis åŸºç¡€","parent":"Redis","content":" 1. Redis åŸºç¡€æ¦‚å¿µ 1.1 Redis æ˜¯ä»€ä¹ˆï¼Ÿ å¼€æºã€åŸºäºå†…å­˜ã€æ”¯æŒæŒä¹…åŒ–çš„é«˜æ€§èƒ½ Key-Value æ•°æ®åº“ å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼ˆ6.x ä¹‹åå¼•å…¥ I/O å¤šçº¿ç¨‹ï¼Œä½†æ ¸å¿ƒå‘½ä»¤æ‰§è¡Œä»æ˜¯å•çº¿ç¨‹ï¼‰ å…¸å‹ QPSï¼š10wï½50w+ 1.2 Redis é€‚ç”¨åœºæ™¯ ç¼“å­˜ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰ æ’è¡Œæ¦œï¼ˆzsetï¼‰ åˆ†å¸ƒå¼é”ï¼ˆset nx exï¼‰ é™æµï¼ˆincr + expire / Luaï¼‰ ä¼šè¯ç®¡ç†ï¼ˆtoken/sessionï¼‰ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆStream/Listï¼‰ è®¡æ•°å™¨ï¼ˆincrï¼‰ åœ°ç†ä½ç½®ï¼ˆGEOï¼‰ 2. Redis äº”å¤§æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆé™„æœ€ä½³å®è·µï¼‰ 2.1 String é€‚ç”¨äºï¼šè®¡æ•°å™¨ã€ç¼“å­˜ã€åˆ†å¸ƒå¼é”\nå¸¸ç”¨å‘½ä»¤ï¼šGET/SET/INCR/INCRBY/SETEX/MSET\næœ€ä½³å®è·µï¼š\nè®¡æ•°ç”¨ INCRï¼Œä¸ç”¨ GET+SETï¼ˆé¿å…å¹¶å‘é—®é¢˜ï¼‰ ä½¿ç”¨ SET key value NX EX 10 å®ç°åˆ†å¸ƒå¼é”ï¼ˆRedLock ä¸æ¨èï¼‰ 2.2 Hash é€‚ç”¨äºï¼šå¯¹è±¡å­˜å‚¨ï¼ˆä¾‹å¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰\næœ€ä½³å®è·µï¼š\nå­—æ®µä¸è¦å¤ªå¤šï¼ˆ\u0026gt;5000 ä¼šå½±å“æ€§èƒ½ï¼‰ é¿å…å¤§ Key å¯ä½¿ç”¨ HINCRBY ä¿å­˜æ•°å€¼å±æ€§ 2.3 List é€‚ç”¨äºï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€æ—¶é—´é¡ºåºæ•°æ®\nå¸¸ç”¨å‘½ä»¤ï¼šLPUSH / RPOP / BLPOP\næœ€ä½³å®è·µï¼š\nä¸è¦åšå¤§åˆ—è¡¨ï¼Œè¶…è¿‡ 50 ä¸‡å°±å±é™© å¦‚æœè¦åšé˜Ÿåˆ—æ¨èä½¿ç”¨ Stream 2.4 Set é€‚ç”¨äºï¼šå»é‡ã€æ ‡ç­¾ã€å…±åŒå¥½å‹ç­‰è¿ç®—\næœ€ä½³å®è·µï¼š\nå¤§é›†åˆè¿ç®—ï¼ˆå¦‚ SINTERï¼‰éå¸¸è€—æ—¶ï¼Œä¼šé€ æˆé˜»å¡ å°½é‡ç”¨ SCARD åˆ¤æ–­å¤§å°ï¼Œé¿å… SMEMBERS æ‹‰å…¨é‡ 2.5 Sorted Setï¼ˆZSetï¼‰ é€‚ç”¨äºï¼šæ’è¡Œæ¦œã€å»¶è¿Ÿé˜Ÿåˆ—\næœ€ä½³å®è·µï¼š\nZREMRANGEBYSCORE ç”¨äºæ¸…ç†è¿‡æœŸä»»åŠ¡ å»¶è¿Ÿé˜Ÿåˆ—ï¼šZADD + ZRANGEBYSCORE + Lua 3. Redis é«˜çº§æ•°æ®ç»“æ„ 3.1 HyperLogLog é€‚ç”¨äºï¼šç‹¬ç«‹è®¿å®¢ UVã€å»é‡è®¡æ•°\nè¯¯å·®ï¼š0.81% å·¦å³\nå†…å­˜æ¶ˆè€—å›ºå®šï¼š12KB\n3.2 Bitmap é€‚ç”¨äºï¼šç­¾åˆ°ã€æ´»è·ƒç”¨æˆ·ç»Ÿè®¡ã€æ˜¯å¦åœ¨çº¿ç­‰\nèŠ‚çœå†…å­˜ï¼Œä½†ä¸é€‚åˆå­˜å‚¨å¤§é‡ç¨€ç–æ•°æ®\n3.3 Streamï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ ç‰¹æ€§ï¼š\næœ‰æ¶ˆè´¹è€…ç»„ æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ— æ”¯æŒ ACK æ¯” List æ›´é€‚åˆæ¶ˆæ¯ç³»ç»Ÿã€‚\n4. Redis æŒä¹…åŒ–ï¼šRDB / AOF 4.1 RDBï¼ˆå¿«ç…§ï¼‰ ä¼˜ç‚¹ï¼šæ¢å¤å¿«ã€å ç”¨ç©ºé—´å°\nç¼ºç‚¹ï¼šå¯èƒ½ä¸¢å¤±æœ€è¿‘ä¸€æ¬¡å¿«ç…§åçš„æ•°æ®\næœ€ä½³å®è·µï¼š\nä½¿ç”¨ save \u0026quot;\u0026quot; ç¦ç”¨ç›¸å¯¹æŒä¹…åŒ–è§„åˆ™ ä½¿ç”¨ save 900 1 300 10 60 10000 4.2 AOF ä¼˜ç‚¹ï¼šå‡ ä¹ä¸ä¸¢æ•°æ®\nç¼ºç‚¹ï¼šæ–‡ä»¶è¶Šæ¥è¶Šå¤§\næ¨èæ¨¡å¼ï¼šappendfsync everysec\nAOF é‡å†™ï¼ˆrewriteï¼‰æœ€ä½³å®è·µï¼š\nå¯ç”¨ auto-aof-rewrite-percentage 100 å¯ç”¨ auto-aof-rewrite-min-size 64mb 5. Redis å†…å­˜ç®¡ç† 5.1 å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆé‡ç‚¹ï¼‰ maxmemory-policy æ¨èä½¿ç”¨ï¼š\nvolatile-lruï¼ˆåªæ·˜æ±°æœ‰ ttl çš„ keyï¼‰ allkeys-lruï¼ˆä½œä¸ºç¼“å­˜ä½¿ç”¨æ—¶ï¼‰ ä¸è¦ä½¿ç”¨ï¼š\nnoevictionï¼ˆå®¹æ˜“å¯¼è‡´ç›´æ¥æŠ¥é”™ï¼‰ 5.2 å¤§ Key é—®é¢˜ï¼ˆé‡ç‚¹ï¼‰ å±é™©çš„å¤§ Key åœºæ™¯ï¼š\nä¸€ä¸ª Hash ä¸­å‡ åä¸‡å­—æ®µ å·¨å¤§ Listã€Setã€ZSet å±å®³ï¼š\nåˆ é™¤å¤§ Key æ—¶å¯èƒ½é˜»å¡ Redis ç½‘ç»œä¼ è¾“æ”¾å¤§ è§£å†³æ–¹æ¡ˆï¼š\nç”¨ SCAN é¿å… KEYS åˆ†æ‹†å¤§ keyï¼ˆHash åˆ†ç‰‡ï¼‰ UNLINK å¼‚æ­¥åˆ é™¤ 6. Redis é«˜å¯ç”¨æ–¹æ¡ˆ 6.1 å•æœºï¼šä¸æ¨è 6.2 ä¸»ä»ï¼ˆMaster-Slaveï¼‰ï¼šå¯ä»¥è¯»å†™åˆ†ç¦» 6.3 Sentinelï¼šä¸»ä»è‡ªåŠ¨åˆ‡æ¢ï¼Œç”Ÿäº§å¯ç”¨ 6.4 Redis Clusterï¼šåˆ†ç‰‡+é«˜å¯ç”¨ï¼Œä¼ä¸šçº§ä½¿ç”¨ ç”Ÿäº§å¸¸ç”¨æ¶æ„ï¼š\nRedis Clusterï¼ˆ3ä¸»3ä»ï¼‰ Sentinelï¼ˆä¸»ä»ï¼‰ 7. Redis è¿ç»´æœ€ä½³å®è·µï¼ˆæœ€é‡è¦éƒ¨åˆ†ï¼‰ 7.1 CPU 100% / è¿æ¥æ•°é£™é«˜ åŸå› ï¼š\nä½¿ç”¨ KEYSã€HGETALLã€SMEMBERS ç­‰å…¨é‡å‘½ä»¤ Lua è„šæœ¬è€—æ—¶å¤ªä¹… å¤§ key è§£å†³ï¼š\nKEYS æ”¹ SCAN å¤§ key åˆ†ç‰‡ ä½¿ç”¨ slowlog get åˆ†ææ…¢æŸ¥è¯¢ ä½¿ç”¨ redis-cli \u0026ndash;bigkeys æ£€æŸ¥å¤§ key 7.2 å†…å­˜æš´æ¶¨ åŸå› ï¼š\nKey value å¤ªå¤§ æ²¡è®¾ç½®è¿‡æœŸ æ²¡å¯åŠ¨æ·˜æ±°ç­–ç•¥ è§£å†³ï¼š\nç»™ç¼“å­˜æ•°æ®éƒ½åŠ  TTL è®¾ç½® maxmemory å’Œ maxmemory-policy 7.3 ä¸»ä»å»¶è¿Ÿ åŸå› ï¼š\nå¤åˆ¶é˜»å¡ ç½‘ç»œå¸¦å®½ä¸è¶³ Master å†™å…¥å¤ªå¤š è§£å†³ï¼š\nä½¿ç”¨ cluster åˆ†ç‰‡å‡è½»å‹åŠ› é™æµå†™æµé‡ å¼€å¯ repl-backlog-size 8. Redis åˆ†å¸ƒå¼é”ï¼ˆæ¨èæ–¹å¼ï¼‰ æ¨èä½¿ç”¨ SET key value NX PX 30000\næ³¨æ„ï¼š\nvalue å¿…é¡»æ˜¯å”¯ä¸€å€¼ï¼Œç”¨æ¥æ¯”å¯¹é”æ˜¯ä¸æ˜¯è‡ªå·±çš„ é‡Šæ”¾é”æ—¶å¿…é¡»ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ ç¤ºä¾‹ Lua è„šæœ¬ï¼š\nif redis.call(\u0026#34;get\u0026#34;, KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;, KEYS[1]) else return 0 end 9. Redis é™æµæ–¹æ¡ˆ å›ºå®šçª—å£ï¼ˆincr + expireï¼‰ ç»å…¸ï¼š\nINCR key EXPIRE key 60 æ»‘åŠ¨çª—å£ï¼ˆZSet + æ—¶é—´æˆ³ï¼‰ æ›´ç²¾å‡†\næ¼æ¡¶/ä»¤ç‰Œæ¡¶ï¼ˆLua è„šæœ¬ï¼‰ é«˜æ€§èƒ½ä¸”ç²¾å‡†\n10. Redis å…³é”®å‘½ä»¤ç¦ç”¨åˆ—è¡¨ï¼ˆç”Ÿäº§å»ºè®®ç¦ç”¨ï¼‰ åœ¨ redis.conf è®¾ç½®ï¼š\nrename-command FLUSHALL \u0026#34;\u0026#34; rename-command FLUSHDB \u0026#34;\u0026#34; rename-command KEYS \u0026#34;\u0026#34; rename-command SHUTDOWN \u0026#34;\u0026#34; ","description":" 1. Redis åŸºç¡€æ¦‚å¿µ 1.1 Redis æ˜¯ä»€ä¹ˆï¼Ÿ å¼€æºã€åŸºäºå†…å­˜ã€æ”¯æŒæŒä¹…åŒ–çš„é«˜æ€§èƒ½ Key-Value æ•°æ®åº“ å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼ˆ6.x ä¹‹åå¼•å…¥ I/O å¤šçº¿ç¨‹ï¼Œä½†æ ¸å¿ƒå‘½ä»¤æ‰§è¡Œä»æ˜¯å•çº¿ç¨‹ï¼‰ å…¸å‹ QPSï¼š10wï½50w+ 1.2 Redis é€‚ç”¨åœºæ™¯ ç¼“å­˜ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰ æ’è¡Œæ¦œï¼ˆzsetï¼‰ åˆ†å¸ƒå¼é”ï¼ˆset nx exï¼‰ é™æµï¼ˆincr + expire / Luaï¼‰ ä¼šè¯ç®¡ç†ï¼ˆtoken/sessionï¼‰ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆStream/Listï¼‰ è®¡æ•°å™¨ï¼ˆincrï¼‰ åœ°ç†ä½ç½®ï¼ˆGEOï¼‰ 2. Redis äº”å¤§æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ˆé™„æœ€ä½³å®è·µï¼‰ 2.1 String é€‚ç”¨äºï¼šè®¡æ•°å™¨ã€ç¼“å­˜ã€åˆ†å¸ƒå¼é”\n"},{"id":411,"href":"/database/redis/backup-restore/","title":"Redis å¤‡ä»½ä¸æ¢å¤","parent":"Redis","content":"å†…å®¹ï¼š åŸç† -\u0026gt; æ“ä½œå‘½ä»¤ -\u0026gt; ç”Ÿäº§å»ºè®® -\u0026gt; æ•…éšœæ¢å¤\nä¸€ã€Redis å¤‡ä»½æ–¹å¼æ€»è§ˆ Redis ä¸»è¦æœ‰ ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼ˆä¹Ÿæ˜¯å¤‡ä»½åŸºç¡€ï¼‰ï¼š\næ–¹å¼ æ–‡ä»¶ ç‰¹ç‚¹ RDB dump.rdb å¿«ã€ä½“ç§¯å°ã€é€‚åˆå¤‡ä»½ AOF appendonly.aof æ•°æ®æ›´å®Œæ•´ã€æ¢å¤æ…¢ ğŸ‘‰ ç”Ÿäº§å¸¸ç”¨ï¼šRDB + AOFï¼ˆæ··åˆæŒä¹…åŒ–ï¼‰\näºŒã€RDB å¤‡ä»½ï¼ˆå¿«ç…§ï¼‰ 1ï¸âƒ£ åŸç† å®šæœŸæŠŠå†…å­˜æ•°æ®å¿«ç…§å†™å…¥ç£ç›˜ ä½¿ç”¨ fork() å­è¿›ç¨‹å®Œæˆ 2ï¸âƒ£ å¸¸ç”¨é…ç½® save 900 1 save 300 10 save 60 10000 dbfilename dump.rdb dir /data/redis 3ï¸âƒ£ æ‰‹åŠ¨å¤‡ä»½ redis-cli BGSAVE ğŸ“Œ é˜»å¡æ—¶é—´æçŸ­ï¼ˆåªåœ¨ fork æ—¶ï¼‰\n4ï¸âƒ£ æ¢å¤æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰ æ­¥éª¤\nåœæ­¢ Redis æŠŠ dump.rdb æ”¾åˆ° dir ç›®å½• å¯åŠ¨ Redis Redis å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½ã€‚\n5ï¸âƒ£ ä¼˜ç¼ºç‚¹ âœ… ä¼˜ç‚¹\næ–‡ä»¶å° æ¢å¤å¿« é€‚åˆå…¨é‡å¤‡ä»½ âŒ ç¼ºç‚¹\nå¯èƒ½ä¸¢å¤±æœ€åä¸€æ¬¡å¿«ç…§åçš„æ•°æ® ä¸‰ã€AOF å¤‡ä»½ï¼ˆæ—¥å¿—ï¼‰ 1ï¸âƒ£ åŸç† è®°å½•æ¯ä¸€æ¡å†™å‘½ä»¤ å¯åŠ¨æ—¶å›æ”¾å‘½ä»¤æ¢å¤æ•°æ® 2ï¸âƒ£ æ ¸å¿ƒé…ç½® appendonly yes appendfilename appendonly.aof appendfsync everysec # æ¨è 3ï¸âƒ£ AOF é‡å†™ï¼ˆå‹ç¼©ï¼‰ redis-cli BGREWRITEAOF 4ï¸âƒ£ AOF æ¢å¤ è‡ªåŠ¨\nRedis å¯åŠ¨æ—¶ä¼˜å…ˆåŠ è½½ AOF æ‰‹åŠ¨ä¿®å¤ï¼ˆAOF æŸåï¼‰\nredis-check-aof --fix appendonly.aof 5ï¸âƒ£ ä¼˜ç¼ºç‚¹ âœ… ä¼˜ç‚¹\næ•°æ®æ›´å®Œæ•´ ç§’çº§ä¸¢æ•°æ® âŒ ç¼ºç‚¹\næ–‡ä»¶å¤§ æ¢å¤æ…¢ å››ã€æ··åˆæŒä¹…åŒ–ï¼ˆç”Ÿäº§å¼ºçƒˆæ¨èï¼‰ aof-use-rdb-preamble yes æ•ˆæœ\nAOF é‡å†™æ—¶ç”Ÿæˆï¼š RDB å¿«ç…§ + AOF å¢é‡ å¯åŠ¨æ¢å¤æ›´å¿« æ–‡ä»¶æ›´å° äº”ã€å¤‡ä»½æ–‡ä»¶ç®¡ç†ï¼ˆè¿ç»´å¿…ä¼šï¼‰ 1ï¸âƒ£ å®šæœŸæ‹·è´å¤‡ä»½ crontab\ncp /data/redis/dump.rdb /backup/redis/dump_$(date +%F).rdb 2ï¸âƒ£ å¼‚åœ°å¤‡ä»½ï¼ˆéå¸¸é‡è¦ï¼‰ rsync å¯¹è±¡å­˜å‚¨ï¼ˆOSS / S3ï¼‰ NAS 3ï¸âƒ£ ä¿ç•™ç­–ç•¥ ä¿ç•™æœ€è¿‘ 7 å¤©\næ¯å‘¨ 1 ä¸ªé•¿æœŸå¤‡ä»½\nå…­ã€ä¸»ä» \u0026amp; Cluster ä¸‹çš„å¤‡ä»½å»ºè®® âœ… åœ¨ä»èŠ‚ç‚¹å¤‡ä»½\né¿å…ä¸»èŠ‚ç‚¹ fork å‹åŠ› ä¸å½±å“å†™æ€§èƒ½ RDB å¤‡ä»½æ¨èä½ç½®\nSlave èŠ‚ç‚¹\nä¸ƒã€Redis ç¾éš¾æ¢å¤æµç¨‹ï¼ˆçœŸå®ç”Ÿäº§ï¼‰ åœºæ™¯ 1ï¼šè¯¯åˆ  key # Redis æœ¬èº«æ— æ³•å›æ»š -\u0026gt; ä»å¤‡ä»½æ¢å¤åˆ°ä¸´æ—¶å®ä¾‹ -\u0026gt; å¯¼å‡ºæŒ‡å®š key -\u0026gt; å›å†™ç”Ÿäº§ åœºæ™¯ 2ï¼šRedis å…¨é‡æ•°æ®ä¸¢å¤± æ¢å¤é¡ºåº\n1ï¸âƒ£ å¯åŠ¨ Redis 2ï¸âƒ£ åŠ è½½ AOFï¼ˆè‹¥å­˜åœ¨ï¼‰ 3ï¸âƒ£ å¦åˆ™åŠ è½½ RDB åœºæ™¯ 3ï¼šä¸»ä»åˆ‡æ¢åæ•°æ®ä¸ä¸€è‡´ ä»¥ä¸»èŠ‚ç‚¹ä¸ºå‡† å¿…è¦æ—¶é‡æ–°å…¨é‡åŒæ­¥ å…«ã€å¤‡ä»½å¸¸è§å‘ï¼ˆéå¸¸çˆ±è€ƒï¼‰ âŒ åªå¼€ RDBï¼Œä¸åšå¼‚åœ°å¤‡ä»½ âŒ AOF æ–‡ä»¶æ— é™å¢é•¿ âŒ åœ¨ä¸»èŠ‚ç‚¹åšå¤§è§„æ¨¡å¤‡ä»½ âŒ æ²¡æµ‹è¯•è¿‡æ¢å¤æµç¨‹ ä¹ã€å¸¸ç”¨å·¥å…·ï¼ˆé€ŸæŸ¥ï¼‰ redis-cli BGSAVE redis-cli BGREWRITEAOF redis-check-rdb dump.rdb redis-check-aof --fix appendonly.aof INFO persistence åã€æ€»ç»“ Redis ä¸»è¦é€šè¿‡ RDB å’Œ AOF è¿›è¡Œå¤‡ä»½ä¸æ¢å¤ã€‚\nRDB æ˜¯å†…å­˜å¿«ç…§ï¼Œé€‚åˆå…¨é‡å¤‡ä»½ï¼›AOF è®°å½•å†™å‘½ä»¤ï¼Œæ•°æ®æ›´å®Œæ•´ã€‚\nç”Ÿäº§ç¯å¢ƒé€šå¸¸å¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œå¹¶åœ¨ä»èŠ‚ç‚¹è¿›è¡Œå®šæœŸå¤‡ä»½ï¼ŒåŒæ—¶åšå¼‚åœ°å­˜å‚¨ã€‚\nRedis å¯åŠ¨æ—¶ä¼šä¼˜å…ˆåŠ è½½ AOFï¼Œå…¶æ¬¡æ˜¯ RDBã€‚\n","description":"å†…å®¹ï¼š åŸç† -\u0026gt; æ“ä½œå‘½ä»¤ -\u0026gt; ç”Ÿäº§å»ºè®® -\u0026gt; æ•…éšœæ¢å¤\nä¸€ã€Redis å¤‡ä»½æ–¹å¼æ€»è§ˆ Redis ä¸»è¦æœ‰ ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼ˆä¹Ÿæ˜¯å¤‡ä»½åŸºç¡€ï¼‰ï¼š\næ–¹å¼ æ–‡ä»¶ ç‰¹ç‚¹ RDB dump.rdb å¿«ã€ä½“ç§¯å°ã€é€‚åˆå¤‡ä»½ AOF appendonly.aof æ•°æ®æ›´å®Œæ•´ã€æ¢å¤æ…¢ ğŸ‘‰ ç”Ÿäº§å¸¸ç”¨ï¼šRDB + AOFï¼ˆæ··åˆæŒä¹…åŒ–ï¼‰\näºŒã€RDB å¤‡ä»½ï¼ˆå¿«ç…§ï¼‰ 1ï¸âƒ£ åŸç† å®šæœŸæŠŠå†…å­˜æ•°æ®å¿«ç…§å†™å…¥ç£ç›˜ ä½¿ç”¨ fork() å­è¿›ç¨‹å®Œæˆ 2ï¸âƒ£ å¸¸ç”¨é…ç½® save 900 1 save 300 10 save 60 10000 dbfilename dump.rdb dir /data/redis 3ï¸âƒ£ æ‰‹åŠ¨å¤‡ä»½ redis-cli BGSAVE ğŸ“Œ é˜»å¡æ—¶é—´æçŸ­ï¼ˆåªåœ¨ fork æ—¶ï¼‰\n"},{"id":412,"href":"/database/redis/command/","title":"Redis å¸¸ç”¨å‘½ä»¤","parent":"Redis","content":" ä¸€ã€é”®ï¼ˆKeyï¼‰æ“ä½œ åŠŸèƒ½ å‘½ä»¤ è¯´æ˜ æŸ¥çœ‹æ‰€æœ‰ key KEYS pattern ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ï¼Œä¼šé˜»å¡ æ¨¡ç³ŠåŒ¹é…æ‰«æ SCAN cursor [MATCH pattern] [COUNT n] å®‰å…¨æ›¿ä»£ KEYS æŸ¥çœ‹ key ç±»å‹ TYPE key å­—ç¬¦ä¸²ã€listã€hash ç­‰ æŸ¥çœ‹ key å­˜åœ¨ EXISTS key è¿”å›å­˜åœ¨æ•°é‡ åˆ é™¤ key DEL key1 key2\u0026hellip; æ”¯æŒå¤š key è¿‡æœŸæ—¶é—´ EXPIRE key 60 è®¾ç½® TTL æŸ¥çœ‹ TTL TTL key å‰©ä½™ç§’æ•° æŒä¹…åŒ– key PERSIST key ç§»é™¤è¿‡æœŸæ—¶é—´ äºŒã€å­—ç¬¦ä¸² String æ“ä½œ å‘½ä»¤ è®¾ç½®å€¼ SET key value è®¾ç½®å€¼ + è¿‡æœŸ SETEX key 60 value è·å–å€¼ GET key æ‰¹é‡æ“ä½œ MSET k1 v1 k2 v2 / MGET k1 k2 è¿½åŠ å­—ç¬¦ä¸² APPEND key value æ•°å€¼è‡ªå¢ INCR keyã€INCRBY key n æ•°å€¼è‡ªå‡ DECR keyã€DECRBY key n å­—ç¬¦ä¸²é•¿åº¦ STRLEN key æˆªå–ç‰‡æ®µ GETRANGE key start end âœ… ä½¿ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ï¼ˆSET NX EXï¼‰\nä¸‰ã€å“ˆå¸Œ Hash é”® = keyï¼Œå­—æ®µ = field\næ“ä½œ å‘½ä»¤ è®¾ç½®å­—æ®µ HSET key field value è·å–å­—æ®µ HGET key field åŒæ—¶è®¾ç½®å¤šä¸ªå­—æ®µ HMSET key f1 v1 f2 v2 è·å–å¤šä¸ªå­—æ®µ HMGET key f1 f2 æŸ¥çœ‹æ‰€æœ‰å­—æ®µä¸å€¼ HGETALL key å­—æ®µæ˜¯å¦å­˜åœ¨ HEXISTS key field åˆ é™¤å­—æ®µ HDEL key field1 field2 æŸ¥çœ‹æ‰€æœ‰å­—æ®µ HKEYS key æŸ¥çœ‹æ‰€æœ‰å€¼ HVALS key æ•°å€¼è‡ªå¢ HINCRBY key field n âœ… ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆid -\u0026gt; JSONï¼‰ï¼Œè´­ç‰©è½¦ç­‰ã€‚\nå››ã€åˆ—è¡¨ Listï¼ˆé“¾è¡¨ï¼‰ æ“ä½œ å‘½ä»¤ å·¦æ’å…¥ LPUSH key v1 v2 å³æ’å…¥ RPUSH key v1 v2 å·¦å¼¹å‡º LPOP key å³å¼¹å‡º RPOP key è·å–åŒºé—´ LRANGE key 0 -1 åˆ—è¡¨é•¿åº¦ LLEN key æŒ‰ä¸‹æ ‡å–å€¼ LINDEX key index ä¿®æ”¹æŸä¸€é¡¹ LSET key index value é˜»å¡å¼¹å‡º BLPOP key timeoutï¼ˆå¸¸ç”¨äºé˜Ÿåˆ—ï¼‰ âœ… ä½¿ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€ä¸ä¸¥æ ¼é¡ºåºçš„æ’é˜Ÿç³»ç»Ÿã€‚\näº”ã€é›†åˆ Setï¼ˆæ— åºå»é‡ï¼‰ æ“ä½œ å‘½ä»¤ æ·»åŠ å…ƒç´  SADD key member1 member2 ç§»é™¤å…ƒç´  SREM key m1 m2 æ˜¯å¦å­˜åœ¨ SISMEMBER key member è·å–æ‰€æœ‰å…ƒç´  SMEMBERS key é›†åˆå¤§å° SCARD key éšæœºå¼¹å‡º SPOP key [count] éšæœºè·å– SRANDMEMBER key [count] äº¤é›† SINTER key1 key2 å¹¶é›† SUNION key1 key2 å·®é›† SDIFF key1 key2 âœ… ä½¿ç”¨åœºæ™¯ï¼šç‚¹èµã€æ ‡ç­¾ç³»ç»Ÿã€å¥½å‹åˆ—è¡¨ã€‚\nå…­ã€æœ‰åºé›†åˆ Sorted Setï¼ˆæ’è¡Œæ¦œï¼‰ æ“ä½œ å‘½ä»¤ æ·»åŠ æˆå‘˜ ZADD key score member åˆ é™¤æˆå‘˜ ZREM key member è·å–åˆ†æ•° ZSCORE key member è·å–æ’åï¼ˆä»å°åˆ°å¤§ï¼‰ ZRANK key member è·å–å€’åºæ’å ZREVRANK key member å¢åŠ åˆ†æ•° ZINCRBY key increment member åŒºé—´æŸ¥è¯¢ ZRANGE key start stop [WITHSCORES] å€’åºåŒºé—´æŸ¥è¯¢ ZREVRANGE key 0 10 WITHSCORES æŒ‰åˆ†æ•°åŒºé—´æŸ¥ ZRANGEBYSCORE key min max âœ… ä½¿ç”¨åœºæ™¯ï¼šæ’è¡Œæ¦œã€å»¶æ—¶é˜Ÿåˆ—ï¼ˆscore = æ—¶é—´æˆ³ï¼‰ã€‚\nä¸ƒã€ä½å›¾ Bitmapï¼ˆé«˜æ•ˆå¸ƒå°”æ•°ç»„ï¼‰ æ“ä½œ å‘½ä»¤ è®¾ç½®æŸä¸€ä½ SETBIT key offset value è·å–æŸä¸€ä½ GETBIT key offset ç»Ÿè®¡ 1 çš„ä¸ªæ•° BITCOUNT key âœ… ä½¿ç”¨åœºæ™¯ï¼šç­¾åˆ°ç³»ç»Ÿã€åœ¨çº¿çŠ¶æ€ã€‚\nå…«ã€HyperLogLogï¼ˆå»é‡è®¡æ•°ï¼‰ æ“ä½œ å‘½ä»¤ æ·»åŠ  PFADD key value ç»Ÿè®¡ PFCOUNT key åˆå¹¶ PFMERGE dest key1 key2 âœ… ä½¿ç”¨åœºæ™¯ï¼šUV ç»Ÿè®¡ã€å”¯ä¸€ç”¨æˆ·é‡ã€‚\nä¹ã€äº‹åŠ¡ Transaction æ“ä½œ å‘½ä»¤ å¼€å§‹ MULTI æäº¤ EXEC å–æ¶ˆ DISCARD ç›‘æ§ key WATCH key å–æ¶ˆç›‘æ§ UNWATCH âœ… ä½¿ç”¨åœºæ™¯ï¼šä¹è§‚é”ã€åŸå­æ“ä½œã€‚\nåã€Lua è„šæœ¬ æ“ä½œ å‘½ä»¤ æ‰§è¡Œè„šæœ¬ EVAL \u0026ldquo;lua_script\u0026rdquo; numkeys key1 value1 \u0026hellip; æ‰§è¡Œç¼“å­˜è„šæœ¬ EVALSHA sha1 \u0026hellip; âœ… ä½¿ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼é”ã€é™æµã€å¤æ‚åŸå­æ“ä½œã€‚\nåä¸€ã€Redis ä¿¡æ¯æŸ¥çœ‹ \u0026amp; è¿ç»´ ç›®çš„ å‘½ä»¤ æŸ¥çœ‹ Redis ä¿¡æ¯ INFO æŸ¥çœ‹ key å¤§å°æ’åº MEMORY USAGE key æŸ¥çœ‹å‘½ä»¤æ‰§è¡Œç»Ÿè®¡ INFO commandstats æŸ¥çœ‹æ…¢æŸ¥è¯¢ SLOWLOG get 10 æ¸…ç©ºå½“å‰ DB FLUSHDB æ¸…ç©ºæ‰€æœ‰ DB FLUSHALL æŸ¥çœ‹æ‰€æœ‰ DB ä½¿ç”¨æƒ…å†µ INFO keyspace åäºŒã€Redis æŒä¹…åŒ– AOF / RDB æ“ä½œ å‘½ä»¤ è§¦å‘ RDB ä¿å­˜ SAVEï¼ˆé˜»å¡ï¼‰ / BGSAVEï¼ˆåå°ï¼‰ é‡å†™ AOF BGREWRITEAOF æŸ¥çœ‹æŒä¹…åŒ–çŠ¶æ€ INFO persistence åä¸‰ã€Redis ä¸»ä»ï¼ˆReplicationï¼‰ æ“ä½œ å‘½ä»¤ æŸ¥çœ‹å¤åˆ¶ä¿¡æ¯ INFO replication è®¾ç½®ä¸»åº“ SLAVEOF host port å–æ¶ˆä¸»ä» SLAVEOF NO ONE è·å–åŒæ­¥åç§»é‡ WAIT numslaves timeout åå››ã€Redis é›†ç¾¤ï¼ˆé‡ç‚¹ï¼‰ 1. é›†ç¾¤èŠ‚ç‚¹ç›¸å…³å‘½ä»¤ æ“ä½œ å‘½ä»¤ æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ CLUSTER INFO æŸ¥çœ‹èŠ‚ç‚¹ CLUSTER NODES æ‰‹åŠ¨åˆ›å»ºé›†ç¾¤ redis-cli \u0026ndash;cluster create \u0026hellip; æ£€æŸ¥é›†ç¾¤ redis-cli \u0026ndash;cluster check host:port ä¿®å¤é›†ç¾¤ redis-cli \u0026ndash;cluster fix host:port 2. æ§½ä½æ“ä½œ åŠ¨ä½œ å‘½ä»¤ æŸ¥çœ‹æ§½ä½åˆ†é… CLUSTER SLOTS å°†æ§½ä» A è¿ç§»åˆ° B CLUSTER SETSLOT slot MIGRATING node-id æ¥æ”¶æ§½è¿ç§» CLUSTER SETSLOT slot IMPORTING node-id æ§½ç»‘å®šä¸»èŠ‚ç‚¹ CLUSTER SETSLOT slot NODE node-id 3. èŠ‚ç‚¹ç®¡ç† æ“ä½œ å‘½ä»¤ åŠ å…¥èŠ‚ç‚¹ CLUSTER MEET ip port ç§»é™¤èŠ‚ç‚¹ CLUSTER FORGET node-id åˆ é™¤ fail æ ‡è®° CLUSTER RESET æ‰‹åŠ¨ failover CLUSTER FAILOVER æ¨¡æ‹ŸèŠ‚ç‚¹å¤±è´¥ CLUSTER DEBUG 4. å¸¦ hash æ ‡ç­¾çš„ key é›†ç¾¤ä¸­ å¼ºåˆ¶å¤šä¸ª key åˆ†é…åˆ°åŒä¸€æ§½\nSET user:{1}:name martin SET user:{1}:age 20 âœ… {} é‡Œé¢çš„å†…å®¹å†³å®šæ§½ä½ã€‚\nåäº”ã€åˆ†å¸ƒå¼é”ç›¸å…³ æ“ä½œ å‘½ä»¤ åŸå­ä¸Šé” SET lock_key uuid NX EX 10 Lua è§£é” EVAL \u0026ldquo;if redis.call(\u0026lsquo;get\u0026rsquo;,KEYS[1])==ARGV[1] then return redis.call(\u0026lsquo;del\u0026rsquo;,KEYS[1]) else return 0 end\u0026rdquo; 1 lock_key uuid åå…­ã€Redis ä¸“ä¸šçº§è°ƒè¯•æŠ€å·§ åœºæ™¯ å‘½ä»¤ æµ‹è¯•æŸå‘½ä»¤è€—æ—¶ DEBUG SLEEP 1 æ¨¡æ‹Ÿ key è¿‡æœŸ EXPIRE key 1 æŸ¥çœ‹å†…å­˜å ç”¨ï¼ˆç²¾ç¡®ï¼‰ MEMORY USAGE key åˆ†æå¤§ key \u0026ndash;bigkeysï¼ˆredis-cli å·¥å…·ï¼‰ æ€»ç»“ï¼šå¼€å‘ + è¿ç»´å¿…ä¼šçš„æ ¸å¿ƒå‘½ä»¤ SET / GET / DEL / EXPIRE HSET / HGET / HGETALL LPUSH / BRPOP ZADD / ZRANGE / ZREVRANGE SCAN MULTI / EXEC INFO / SLOWLOG / MEMORY CLUSTER NODES / CLUSTER INFO SET NX EXï¼ˆåˆ†å¸ƒå¼é”ï¼‰ Lua + EVAL è¿™äº›å…¨éƒ¨æŒæ¡ï¼ŒRedis å°±ç®—é€šäº†ã€‚\n","description":" ä¸€ã€é”®ï¼ˆKeyï¼‰æ“ä½œ åŠŸèƒ½ å‘½ä»¤ è¯´æ˜ æŸ¥çœ‹æ‰€æœ‰ key KEYS pattern ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨ï¼Œä¼šé˜»å¡ æ¨¡ç³ŠåŒ¹é…æ‰«æ SCAN cursor [MATCH pattern] [COUNT n] å®‰å…¨æ›¿ä»£ KEYS æŸ¥çœ‹ key ç±»å‹ TYPE key å­—ç¬¦ä¸²ã€listã€hash ç­‰ æŸ¥çœ‹ key å­˜åœ¨ EXISTS key è¿”å›å­˜åœ¨æ•°é‡ åˆ é™¤ key DEL key1 key2\u0026hellip; æ”¯æŒå¤š key è¿‡æœŸæ—¶é—´ EXPIRE key 60 è®¾ç½® TTL æŸ¥çœ‹ TTL TTL key å‰©ä½™ç§’æ•° æŒä¹…åŒ– key PERSIST key ç§»é™¤è¿‡æœŸæ—¶é—´ äºŒã€å­—ç¬¦ä¸² String æ“ä½œ å‘½ä»¤ è®¾ç½®å€¼ SET key value è®¾ç½®å€¼ + è¿‡æœŸ SETEX key 60 value è·å–å€¼ GET key æ‰¹é‡æ“ä½œ MSET k1 v1 k2 v2 / MGET k1 k2 è¿½åŠ å­—ç¬¦ä¸² APPEND key value æ•°å€¼è‡ªå¢ INCR keyã€INCRBY key n æ•°å€¼è‡ªå‡ DECR keyã€DECRBY key n å­—ç¬¦ä¸²é•¿åº¦ STRLEN key æˆªå–ç‰‡æ®µ GETRANGE key start end âœ… ä½¿ç”¨åœºæ™¯ï¼šç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é”ï¼ˆSET NX EXï¼‰\n"},{"id":413,"href":"/database/redis/dir/","title":"Redis æ–‡ä»¶å­˜å‚¨ç›®å½•","parent":"Redis","content":"Redis RDB å’Œ AOF å¯ä»¥ä¿å­˜åœ¨åŒä¸€ç›®å½•å—ï¼Ÿå¦‚ä½•å¯ä»¥ï¼Œå¦‚ä½•è®¾ç½®ï¼Ÿ\nå¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯ Redis çš„æ ‡å‡†åšæ³•ã€‚\nRedis é»˜è®¤å°±æ˜¯æŠŠ RDB å’Œ AOF ä¿å­˜åœ¨åŒä¸€ç›®å½• çš„ï¼Œåªæ˜¯å¾ˆå¤šäººæ²¡æ³¨æ„æˆ–æ²¡ç³»ç»Ÿç†è§£ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ª ç»“è®º -\u0026gt; åŸç† -\u0026gt; é…ç½®æ–¹å¼ -\u0026gt; ç”Ÿäº§å»ºè®® -\u0026gt; é¢è¯•æ ‡å‡†ç­”æ¡ˆ çš„å®Œæ•´è¯´æ˜ã€‚\nä¸€ã€ç»“è®ºï¼ˆç›´æ¥è®°ï¼‰ Redis çš„ RDB å’Œ AOF å®Œå…¨å¯ä»¥ã€ä¹Ÿé€šå¸¸ä¿å­˜åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ï¼Œé€šè¿‡ dir å‚æ•°ç»Ÿä¸€æŒ‡å®šã€‚\nRDBï¼šdump.rdb AOFï¼šappendonly.aofï¼ˆæˆ– AOF ç›®å½•ï¼‰ ä¸¤è€… ä¸ä¼šäº’ç›¸è¦†ç›– Redis å¯åŠ¨æ—¶ ä¼˜å…ˆåŠ è½½ AOF äºŒã€Redis æ˜¯å¦‚ä½•å†³å®šâ€œä¿å­˜åˆ°å“ªé‡Œâ€çš„ï¼Ÿ å…³é”®åªæœ‰ä¸€ä¸ªå‚æ•° dir /data/redis ğŸ‘‰ æ‰€æœ‰æŒä¹…åŒ–æ–‡ä»¶éƒ½ä¿å­˜åœ¨è¿™ä¸ªç›®å½•ä¸‹\nRDB ç›¸å…³å‚æ•° dbfilename dump.rdb æœ€ç»ˆè·¯å¾„ï¼š\n/data/redis/dump.rdb AOF ç›¸å…³å‚æ•°ï¼ˆRedis â‰¤ 6.xï¼‰ appendonly yes appendfilename appendonly.aof æœ€ç»ˆè·¯å¾„ï¼š\n/data/redis/appendonly.aof AOF ç›¸å…³å‚æ•°ï¼ˆRedis â‰¥ 7.xï¼Œæ¨èï¼‰ appendonly yes appenddirname appendonlydir æœ€ç»ˆç›®å½•ç»“æ„ï¼š\n/data/redis/ â”œâ”€â”€ dump.rdb â””â”€â”€ appendonlydir/ â”œâ”€â”€ appendonly.aof â”œâ”€â”€ appendonly.aof.1.incr â””â”€â”€ appendonly.aof.1.base ğŸ“Œ æ³¨æ„ï¼š\nappenddirname æ˜¯ ç›¸å¯¹äº dir çš„å­ç›®å½• AOF æ–‡ä»¶ä¼šè¢«æ‹†åˆ†ï¼Œä¾¿äºç®¡ç†å’Œæ¢å¤ ä¸‰ã€å®Œæ•´ç¤ºä¾‹ï¼ˆç”Ÿäº§æ¨èé…ç½®ï¼‰ # ç»Ÿä¸€æ•°æ®ç›®å½• dir /data/redis # RDB save 900 1 save 300 10 save 60 10000 dbfilename dump.rdb # AOF appendonly yes appenddirname appendonlydir appendfsync everysec # æ··åˆæŒä¹…åŒ– aof-use-rdb-preamble yes å››ã€Redis å¯åŠ¨æ—¶å¦‚ä½•åŠ è½½ï¼Ÿï¼ˆéå¸¸çˆ±è€ƒï¼‰ åŠ è½½é¡ºåºï¼š\n1ï¸âƒ£ å¦‚æœ appendonly yes ä¸” AOF å­˜åœ¨ -\u0026gt; ä¼˜å…ˆåŠ è½½ AOF\n2ï¸âƒ£ å¦åˆ™åŠ è½½ dump.rdb\nğŸ“Œ å³ä½¿ RDB å’Œ AOF åœ¨åŒä¸€ç›®å½•ï¼Œä¹Ÿä¸ä¼šå†²çªã€‚\näº”ã€æ˜¯å¦å¯ä»¥â€œåˆ†å¼€ç›®å½•â€ï¼Ÿå¯ä»¥ï¼Œä½†ä¸æ¨è ç†è®ºä¸Šå¯ä»¥å—ï¼Ÿ âŒ ä¸æ”¯æŒ\nRedis åªæœ‰ä¸€ä¸ª dirï¼Œä¸èƒ½ä¸º RDB å’Œ AOF å•ç‹¬æŒ‡å®šä¸åŒç»å¯¹è·¯å¾„ã€‚\né‚£æ€ä¹ˆâ€œçœ‹èµ·æ¥åˆ†å¼€â€ï¼Ÿ âœ… ç”¨ AOF å­ç›®å½•ï¼ˆRedis 7+ï¼‰\nappenddirname appendonlydir æˆ–è€…ï¼š\nâœ… æ–‡ä»¶ç³»ç»Ÿå±‚é¢\nä½¿ç”¨è½¯é“¾æ¥ï¼ˆln -sï¼‰ ä½¿ç”¨ä¸åŒç£ç›˜æŒ‚è½½åˆ°åŒä¸€ç›®å½•ä¸‹çš„å­ç›®å½• å…­ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼ˆä½ è¿™ä¸ªæ°´å¹³ä¸€å®šè¦çŸ¥é“ï¼‰ âœ… æ¨èåšæ³• RDB + AOF æ”¾åŒä¸€æ•°æ®ç›®å½• å®šæœŸ æ‹·è´ /data/redis/ åšå¼‚åœ°å¤‡ä»½ åœ¨ä»èŠ‚ç‚¹åšå¤‡ä»½ âŒ ä¸æ¨è æŠŠ RDBã€AOF æ”¾åˆ°ä¸åŒ dirï¼ˆåšä¸åˆ°ï¼‰ æ‰‹åŠ¨ä¿®æ”¹ AOF æ–‡ä»¶ä½ç½® ä¸»èŠ‚ç‚¹é¢‘ç¹ fork ä¸ƒã€å¸¸è§è¯¯åŒºï¼ˆé¢è¯•å¸¸è¸©ï¼‰ âŒ è®¤ä¸º RDB å’Œ AOF ä¸èƒ½å…±å­˜ âŒ è®¤ä¸ºå¿…é¡»åˆ†ç›®å½• âŒ ä¸çŸ¥é“ Redis å¯åŠ¨ä¼˜å…ˆåŠ è½½ AOF âŒ Redis 7 ä¹‹å‰ä¸çŸ¥é“ AOF ä¸èƒ½æ‹†åˆ† å…«ã€æ€»ç»“ Redis çš„ RDB å’Œ AOF å¯ä»¥ä¹Ÿé€šå¸¸ä¿å­˜åœ¨åŒä¸€ç›®å½•ä¸­ï¼Œé€šè¿‡ dir å‚æ•°ç»Ÿä¸€æŒ‡å®šã€‚\nRDB ä½¿ç”¨ dbfilenameï¼ŒAOF ä½¿ç”¨ appendfilename æˆ– appenddirname æŒ‡å®šæ–‡ä»¶åæˆ–å­ç›®å½•ã€‚\nRedis å¯åŠ¨æ—¶å¦‚æœå¼€å¯ AOFï¼Œä¼šä¼˜å…ˆåŠ è½½ AOFï¼Œä¸ä¼šä¸ RDB å†²çªã€‚\nç”Ÿäº§ç¯å¢ƒä¸€èˆ¬é‡‡ç”¨ RDB + AOF æ··åˆæŒä¹…åŒ–ï¼Œå¹¶åœ¨ä»èŠ‚ç‚¹ç»Ÿä¸€å¤‡ä»½è¯¥ç›®å½•ã€‚\n","description":"Redis RDB å’Œ AOF å¯ä»¥ä¿å­˜åœ¨åŒä¸€ç›®å½•å—ï¼Ÿå¦‚ä½•å¯ä»¥ï¼Œå¦‚ä½•è®¾ç½®ï¼Ÿ\nå¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯ Redis çš„æ ‡å‡†åšæ³•ã€‚\nRedis é»˜è®¤å°±æ˜¯æŠŠ RDB å’Œ AOF ä¿å­˜åœ¨åŒä¸€ç›®å½• çš„ï¼Œåªæ˜¯å¾ˆå¤šäººæ²¡æ³¨æ„æˆ–æ²¡ç³»ç»Ÿç†è§£ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ª ç»“è®º -\u0026gt; åŸç† -\u0026gt; é…ç½®æ–¹å¼ -\u0026gt; ç”Ÿäº§å»ºè®® -\u0026gt; é¢è¯•æ ‡å‡†ç­”æ¡ˆ çš„å®Œæ•´è¯´æ˜ã€‚\nä¸€ã€ç»“è®ºï¼ˆç›´æ¥è®°ï¼‰ Redis çš„ RDB å’Œ AOF å®Œå…¨å¯ä»¥ã€ä¹Ÿé€šå¸¸ä¿å­˜åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ï¼Œé€šè¿‡ dir å‚æ•°ç»Ÿä¸€æŒ‡å®šã€‚\nRDBï¼šdump.rdb AOFï¼šappendonly.aofï¼ˆæˆ– AOF ç›®å½•ï¼‰ ä¸¤è€… ä¸ä¼šäº’ç›¸è¦†ç›– Redis å¯åŠ¨æ—¶ ä¼˜å…ˆåŠ è½½ AOF äºŒã€Redis æ˜¯å¦‚ä½•å†³å®šâ€œä¿å­˜åˆ°å“ªé‡Œâ€çš„ï¼Ÿ å…³é”®åªæœ‰ä¸€ä¸ªå‚æ•° dir /data/redis ğŸ‘‰ æ‰€æœ‰æŒä¹…åŒ–æ–‡ä»¶éƒ½ä¿å­˜åœ¨è¿™ä¸ªç›®å½•ä¸‹\n"},{"id":414,"href":"/database/redis/best-practices/","title":"Redis æœ€ä½³å®è·µ","parent":"Redis","content":" 1. Key è®¾è®¡æœ€ä½³å®è·µ 1.1 Key å‘½åè§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰ ç³»ç»Ÿ:ä¸šåŠ¡:å®ä½“:id:å­—æ®µ\nç¤ºä¾‹ï¼š\nuser:info:1001 order:detail:20240101:9981 product:stock:sku123 ä¼˜ç‚¹ï¼šå¯è¯»ã€å¯æœç´¢ã€å¯åˆ†å±‚ã€‚\n1.2 ç¦æ­¢ä½¿ç”¨è¿‡é•¿ key æ¨èï¼š20ï½40 å­—ç¬¦ä»¥å†… é¿å…ï¼šè¶…è¿‡ 128 å­—ç¬¦ å¦åˆ™ç½‘ç»œä¼ è¾“æˆæœ¬ä¼šè¢«æ”¾å¤§ã€‚\n2. é¿å…å¤§ Keyï¼ˆç”Ÿäº§æœ€å®¹æ˜“è¸©çš„å‘ï¼‰ å±é™©çš„å¤§ Keyï¼š\nHash æœ‰ 10 ä¸‡å­—æ®µ List é•¿åº¦ 100w+ Set / ZSet 100w+ String å¤§äº 5MB é£é™©ï¼š\nåˆ é™¤é˜»å¡ Redis å†…å­˜æ¶¨å¹…ä¸ç¨³å®š å¤åˆ¶å»¶è¿Ÿéª¤å¢ è§£å†³æ–¹æ¡ˆï¼š\næ‹†åˆ†æˆå¤šä¸ª keyï¼ˆhash åˆ†ç‰‡ï¼‰ ä½¿ç”¨ UNLINK å¼‚æ­¥åˆ é™¤ ä½¿ç”¨ SCAN ä»£æ›¿ SMEMBERS / HGETALL 3. æ‰€æœ‰ç¼“å­˜éƒ½å¿…é¡»æœ‰ TTLï¼ˆæ ¸å¿ƒï¼‰ æ°¸è¿œä¸è¦å­˜æ°¸ä¹… keyï¼\næ¨èç­–ç•¥ï¼š\næ™®é€šç¼“å­˜ï¼šéšæœº TTLï¼ˆé˜²é›ªå´©ï¼‰ ç”¨æˆ·æ•°æ®ï¼š30 åˆ†é’Ÿï½2 å°æ—¶ é…ç½®ä¿¡æ¯ï¼š5 åˆ†é’Ÿï½1 å°æ—¶ ä¼šè¯ tokenï¼š30 åˆ†é’Ÿï½12 å°æ—¶ åŠ éšæœºåç§»ï¼š\nttl = base + random(30~300) 4. é¿å…ç¼“å­˜é›ªå´© / å‡»ç©¿ / ç©¿é€ï¼ˆæ ¸å¿ƒï¼‰ 4.1 ç¼“å­˜ç©¿é€ -\u0026gt; æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® è§£å†³ï¼š\nå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰ å­˜ç©ºå€¼ TTL=30s 4.2 ç¼“å­˜é›ªå´© -\u0026gt; å¤§é‡ key åŒæ—¶è¿‡æœŸ è§£å†³ï¼š\nTTL åŠ éšæœº é¢„çƒ­ å¤šçº§ç¼“å­˜ 4.3 ç¼“å­˜å‡»ç©¿ -\u0026gt; çƒ­ç‚¹ key è¿‡æœŸç¬é—´è¢«æ‰“çˆ† è§£å†³ï¼š\næ–¹æ¡ˆä¸€ï¼šäº’æ–¥é”ï¼ˆæ¨èï¼‰ setnx(lock) query db set cache del lock æ–¹æ¡ˆäºŒï¼šæ°¸ä¸è¿‡æœŸ + åå°çº¿ç¨‹å¼‚æ­¥åˆ·æ–°ï¼ˆæœ€ç¨³å®šï¼‰ 5. Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µï¼ˆå¼ºä¸€è‡´ï¼‰ ä½¿ç”¨ SET NX EX å®ç°ï¼š\nSET lock_key unique_value NX EX 30 é‡Šæ”¾é”ä½¿ç”¨ Lua è„šæœ¬ï¼ˆå¿…é¡»åŸå­ï¼‰ï¼š\nif redis.call(\u0026#34;get\u0026#34;, KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;, KEYS[1]) else return 0 end é‡è¦ï¼š\nvalue å¿…é¡»å”¯ä¸€ï¼ˆUUIDï¼‰ ä¸èƒ½è¯¯åˆ åˆ«äººçš„é” ä¸è¦ç”¨ RedLockï¼ˆå¤æ‚ã€ä¹Ÿä¸ç»å¯¹å¯é ï¼‰ 6. è®¡æ•°å™¨ä½¿ç”¨ INCRï¼Œä¸è¦ GET+SET INCR view:article:1001 ä¸¤æ®µå¼ GET -\u0026gt; ä¿®æ”¹ -\u0026gt; SET ä¼šå¹¶å‘é”™è¯¯ã€‚\n7. Redis ä½œä¸ºé˜Ÿåˆ—çš„æœ€ä½³å®è·µ æ¨èä½¿ç”¨ Streamï¼ˆç”Ÿäº§æœ€ä½³ï¼‰ï¼Œä¸è¦ç”¨ List\nä¸ºä»€ä¹ˆä¸ç”¨ Listï¼Ÿ\næ²¡æœ‰ ACK æ²¡è‡ªåŠ¨æŒä¹…åŒ– æ¶ˆè´¹å¤±è´¥å®¹æ˜“ä¸¢æ•°æ® Stream ä¼˜åŠ¿ï¼š\næ¶ˆè´¹ç»„ ACK å¯è¿½æº¯ å¯æ°´å¹³æ‰©å±• 8. å“ˆå¸Œç»“æ„ï¼ˆhashï¼‰æœ€ä½³å®è·µ é€‚ç”¨äºå¯¹è±¡ï¼š\nuser:info:1001 -\u0026gt; { id, name, age } æ³¨æ„ï¼š\nå­—æ®µä¸è¦è¶…è¿‡ 5000 é€‚åˆå°å¯¹è±¡ï¼Œä¸é€‚åˆå¤§å¯¹è±¡ é¿å… HGETALLï¼Œæ”¹ç”¨ HMGET 9. Sorted Setï¼ˆZSetï¼‰æœ€ä½³å®è·µ å¸¸ç”¨äºæ’è¡Œæ¦œã€å»¶è¿Ÿé˜Ÿåˆ—\nå»¶è¿Ÿé˜Ÿåˆ—ç¤ºä¾‹ï¼š\nZADD delay_queue timestamp order_id ZRANGEBYSCORE delay_queue 0 now ä»»åŠ¡å®Œæˆååˆ é™¤ï¼š\nZREM delay_queue order_id 10. Session / Token å­˜å‚¨æœ€ä½³å®è·µ å­˜å‚¨æ–¹å¼ï¼š\nsession:user:1001 -\u0026gt; token token:xxxx -\u0026gt; user_info æ³¨æ„ï¼š\nè®¾ç½® TTL é€€å‡ºç™»å½•æ—¶åˆ é™¤ token ä½¿ç”¨ Pipelining æ‰¹é‡æ“ä½œæå‡æ€§èƒ½ 11. ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œï¼ˆé«˜æ€§èƒ½ï¼‰ ä¾‹å¦‚æ‰¹é‡å†™ 100 æ¡ keyï¼š\npipe = redis.pipeline() for i in range(100): pipe.set(f\u0026#34;user:{i}\u0026#34;, i) pipe.execute() ä½¿ç”¨åœºæ™¯ï¼š\næ‰¹é‡å†™å…¥ æ‰¹é‡è¯»å– ä¸é€‚åˆï¼šå¤æ‚é€»è¾‘ã€ä¾èµ–æ‰§è¡Œé¡ºåºçš„é€»è¾‘\n12. é¿å…ä½¿ç”¨å±é™©å‘½ä»¤ï¼ˆåŠ¡å¿…é‡å‘½åï¼‰ åœ¨ redis.confï¼š\nrename-command FLUSHALL \u0026#34;\u0026#34; rename-command FLUSHDB \u0026#34;\u0026#34; rename-command KEYS \u0026#34;\u0026#34; rename-command CONFIG \u0026#34;\u0026#34; rename-command SHUTDOWN \u0026#34;\u0026#34; 13. ä½¿ç”¨ SCAN ä»£æ›¿ KEYSï¼ˆå¿…é¡»ï¼‰ ä¸è¦ï¼š\nKEYS user:* ä¼šé˜»å¡æ•´ä¸ªå®ä¾‹ï¼\nè¦ç”¨ï¼š\nSCAN 0 MATCH user:* COUNT 1000 14. Redis å†…å­˜é™åˆ¶ä¸æ·˜æ±°ç­–ç•¥ï¼ˆå¿…é¡»é…ç½®ï¼‰ maxmemory 4gb maxmemory-policy allkeys-lru ç†ç”±ï¼š\né˜²æ­¢ OOM Redis åšç¼“å­˜æ—¶ LRU æ•ˆæœæœ€ä½³ 15. Redis çš„æŒä¹…åŒ–ç­–ç•¥ï¼ˆæœ€ä½³ä½¿ç”¨æ–¹å¼ï¼‰ æœ€ä½³å®è·µï¼šå¯ç”¨æ··åˆæŒä¹…åŒ–ï¼ˆé»˜è®¤ï¼‰\nRDB + AOFï¼ˆé€‰ everysec é€‰é¡¹ï¼‰\nappendfsync everysec auto-aof-rewrite-percentage 100 auto-aof-rewrite-min-size 64mb å¥½å¤„ï¼š\nå¯é æ€§å¼º å¯åŠ¨å¿« æ—¥å¿—ä¸ä¼šæ— é™è†¨èƒ€ 16. ä¸»ä»å¤åˆ¶æœ€ä½³å®è·µ å¼€å¯å¤åˆ¶ backlogï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰ repl-backlog-size 64mb ä¸»åº“ç¦ç”¨å¤§ key ä¸»ä»å¸¦å®½è¶³å¤Ÿ ä½¿ç”¨å®¢æˆ·ç«¯è¯»å†™åˆ†ç¦»ï¼ˆåªè¯»ä»åº“ï¼‰ 17. Redis Cluster æœ€ä½³å®è·µ é›†ç¾¤è§„æ¨¡æ¨èï¼š\n3 ä¸» + 3 ä»ï¼ˆ6 èŠ‚ç‚¹ï¼‰ æœ€ä½³ key è®¾è®¡ï¼š\nuser:{1001}:info {} å†…çš„å†…å®¹ç”¨äº hash slot å›ºå®šã€‚\n18. Redis æ€§èƒ½ä¼˜åŒ–ï¼ˆæœ€é‡è¦çš„ä¸€æ®µï¼‰ ç¦æ­¢ï¼š\nKEYSã€HGETALLã€LRANGE å…¨é‡ å¤§ key æ“ä½œï¼ˆ\u0026gt;5MBï¼‰ å¤§åˆ—è¡¨ä¸€æ¬¡æ€§ LRANGEï¼ˆéœ€åˆ†æ®µï¼‰ Lua è„šæœ¬è¿‡é•¿è¿è¡Œï¼ˆè¶…è¿‡ 5 ç§’ä¼šé˜»å¡ï¼‰ å¿…é¡»ï¼š\nTTL + éšæœº æ‹†åˆ†å¤§ key ä½¿ç”¨ Pipeline ä½¿ç”¨å¤šçº§ç¼“å­˜ï¼ˆæœ¬åœ° cache + Redisï¼‰ 19. Redis çš„æ•…éšœæ’æŸ¥ï¼ˆæ ¸å¿ƒï¼‰ 1. CPU 100% ä½¿ç”¨ KEYS å¤§ key Lua è„šæœ¬å¡æ­» å¤åˆ¶ç§¯å‹ 2. å†…å­˜æš´æ¶¨ æ²¡ TTL key å¤ªå¤§ æ•°æ®ç»“æ„è¿‡å¤§ï¼ˆList/Setï¼‰ 3. ä¸»ä»å»¶è¿Ÿ ä¸»åº“å‹åŠ›å¤§ å…¨é‡åŒæ­¥é¢‘ç¹ ç½‘ç»œç“¶é¢ˆ 4. è¿æ¥æ•°æš´æ¶¨ å®¢æˆ·ç«¯è¿æ¥æœªå¤ç”¨ æœªä½¿ç”¨è¿æ¥æ±  20. å¼€å‘è§„èŒƒï¼ˆå¯ç›´æ¥çº³å…¥é¡¹ç›®åˆ¶åº¦ï¼‰ æ‰€æœ‰ç¼“å­˜å¿…é¡»æœ‰ TTL æ‰€æœ‰è®¿é—® Redis çš„ä¸šåŠ¡å°è£… SDK ä¸å…è®¸ä½¿ç”¨ KEYS / FLUSHALL / FLUSHDB æ‰€æœ‰å¤§ key å®šæœŸæ‰«æ é™æµå¿…é¡»ç”¨ Lua åˆ†å¸ƒå¼é”å¿…é¡»ç”¨ SET NX EX + Lua é˜Ÿåˆ—å¿…é¡»ç”¨ Stream æ‰€æœ‰ Redis å‘½ä»¤å“åº”æ—¶é—´ \u0026gt; 5ms è®°å½•æ…¢æ—¥å¿— ğŸš€ Redis ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼ˆå®Œæ•´æŒ‡å—ï¼‰\nğŸ”¥ ç›®å½•\næ¶æ„ä¸éƒ¨ç½² é…ç½®ä¼˜åŒ– æ€§èƒ½ä¼˜åŒ– å®‰å…¨åŠ å›º å†…å­˜ç®¡ç†ä¸æ•°æ®æ·˜æ±° å¤‡ä»½ä¸æ¢å¤ é«˜å¯ç”¨æ–¹æ¡ˆæ¨è Python ç”Ÿäº§çº§ç”¨æ³• Kubernetes éƒ¨ç½²æœ€ä½³å®è·µ å¸¸è§å‘ä¸é˜²è¸©å‘æŒ‡å— 1. Redis æ¶æ„ä¸éƒ¨ç½² âœ… å»ºè®®è‡³å°‘ä½¿ç”¨ ä¸»ä» + å“¨å…µï¼ˆSentinelï¼‰ æˆ– Redis Cluster\næ¨èç»“æ„ï¼š\nåœºæ™¯ æ¨èæ¶æ„ ä¸­å°é¡¹ç›®ã€é«˜è¯»å†™ Master + Slave + Sentinel å¤§è§„æ¨¡ã€é«˜å¹¶å‘ã€åˆ†å¸ƒå¼ç¼“å­˜ Redis Clusterï¼ˆ3 ä¸» 3 ä»ï¼‰ è¶…å¤§ KV æ•°æ®ã€æ°´å¹³æ‰©å±• Redis Cluster å»¶è¿Ÿé˜Ÿåˆ—ã€å¤šæ¶ˆè´¹è€… Redis Stream 2. Redis é…ç½®ä¼˜åŒ–ï¼ˆå¿…é¡»è®¾ç½®ï¼‰ è®¾ç½®æœ€å¤§å†…å­˜ï¼ˆéå¸¸å…³é”®ï¼‰ maxmemory 4gb maxmemory-policy allkeys-lru ç¦ç”¨å±é™©å‘½ä»¤ rename-command FLUSHALL \u0026#34;\u0026#34; rename-command FLUSHDB \u0026#34;\u0026#34; rename-command CONFIG \u0026#34;\u0026#34; å¼€å¯ AOFï¼ˆæ›´å®‰å…¨ï¼‰ appendonly yes appendfsync everysec RDB å»ºè®®é…ç½® save 900 1 save 300 10 save 60 10000 ç¦ç”¨ swapï¼ˆLinuxï¼‰ sudo swapoff -a 3. æ€§èƒ½ä¼˜åŒ– ä½¿ç”¨å†…å­˜ä¼˜åŒ–æ•°æ®ç»“æ„ å“ˆå¸Œã€é›†åˆã€å¤šå­—æ®µç»“æ„ ä½¿ç”¨ HASH å¤§åˆ—è¡¨æ”¹ç”¨ Redis Streamsï¼ˆæ›´ç¨³å®šï¼‰ é¿å… å¤§ key å¤§ key é—®é¢˜=é˜»å¡ Redis + CPU çˆ†ç‚¸\nä¾‹å¦‚ï¼š\nä¸€ä¸ª List ä¿å­˜ 100 ä¸‡è¡Œ ä¸€ä¸ª key å­˜å‚¨ 10MB JSON æ£€æŸ¥å¤§ keyï¼š\nredis-cli --bigkeys é¿å… O(N) æ…¢å‘½ä»¤ é«˜å±å‘½ä»¤ï¼š\nå‘½ä»¤ é£é™© KEYS * é˜»å¡æœåŠ¡å™¨ SMEMBERS é›†åˆè¶…å¤§æ—¶å±é™© LRANGE 0 -1 åˆ—è¡¨è¿‡é•¿æ—¶å±é™© HGETALL å­—æ®µå¤ªå¤šå±é™© âš ï¸ ç¦æ­¢ KEYS\nä½¿ç”¨ SCAN æ›¿ä»£ï¼š\nfor key in r.scan_iter(\u0026#34;user:*\u0026#34;): print(key) 4. å®‰å…¨åŠ å›º å¯†ç ä¿æŠ¤ requirepass your_password_here åªç›‘å¬å†…ç½‘ bind 127.0.0.1 protected-mode yes ç¦æ­¢å…¬ç½‘ç›´æ¥è®¿é—®ï¼ˆå¿…é¡»ï¼‰ ä½¿ç”¨ Nginxã€VPCã€K8S ClusterIP éš”ç¦»ã€‚\n5. å†…å­˜ç®¡ç†ä¸æ•°æ®æ·˜æ±°ç­–ç•¥ æœ€æ¨èç­–ç•¥ï¼šallkeys-lru\nmaxmemory-policy allkeys-lru ç­–ç•¥è¯´æ˜ï¼š\nç­–ç•¥ æ¨è noeviction âŒ å®¹æ˜“å†™å¤±è´¥ volatile-lru ä¸æ¨è allkeys-lru â­ æ­£å¸¸ç¼“å­˜æœ€ä½³é€‰æ‹© allkeys-random å¤‡ç”¨ volatile-ttl é€‚åˆ TTL ç±»åœºæ™¯ 6. å¤‡ä»½ä¸æ¢å¤ AOF å¤‡ä»½ cp appendonly.aof appendonly.aof.bak RDB å¤‡ä»½ cp dump.rdb dump.rdb.bak è‡ªåŠ¨å¤‡ä»½è®¾ç½®ï¼ˆæ¨èï¼‰ Crontabï¼š\n0 */1 * * * cp /data/dump.rdb /backup/redis-$(date +\\%Y\\%m\\%d\\%H).rdb 7. é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆå¿…é¡»é€‰æ‹©ä¸€ä¸ªï¼‰ æ–¹æ¡ˆ 1ï¼šä¸»ä» + å“¨å…µï¼ˆæœ€é€‚åˆä¸­å°é¡¹ç›®ï¼‰ master â”œâ”€ slave1 â”œâ”€ slave2 sentinel x 3 æ–¹æ¡ˆ 2ï¼šRedis Clusterï¼ˆé€‚åˆå¤§è§„æ¨¡ï¼‰âœ… æ”¯æŒè‡ªåŠ¨åˆ†ç‰‡ + æ‰©å®¹ æœ€å¸¸è§é…ç½®ï¼š3 ä¸» 3 ä» 8. Kubernetes ä¸­ Redis æœ€ä½³å®è·µï¼ˆä½ çš„ç¯å¢ƒï¼‰ StateFulSet éƒ¨ç½² ä½¿ç”¨ local-path / PVC æ¯ä¸ªèŠ‚ç‚¹å›ºå®šè°ƒåº¦ readinessProbe / livenessProbe livenessProbe: exec: command: [\u0026#34;redis-cli\u0026#34;,\u0026#34;ping\u0026#34;] initialDelaySeconds: 15 periodSeconds: 10 è®¾ç½®èµ„æºé™åˆ¶ resources: limits: memory: \u0026#34;4Gi\u0026#34; cpu: \u0026#34;1\u0026#34; ç¦ç”¨ overcommit é¿å… OOMKill\n9. å¸¸è§å‘ä¸è§£å†³æ–¹æ¡ˆ é—®é¢˜ åŸå›  è§£å†³ Redis çªç„¶å¡æ­» ä½¿ç”¨ KEYSã€å¤§ keyã€æ…¢å‘½ä»¤ æ”¹ç”¨ SCANã€æ‹†åˆ†å¤§ key å†…å­˜å¢åŠ ä¸ä¸‹é™ å†…å­˜ç¢ç‰‡ é‡å¯ Redis æˆ–ä½¿ç”¨ jemalloc ä¸»ä»å»¶è¿Ÿ ç½‘ç»œ/å¤§ key é¿å…å¤§ keyï¼Œæ‹†åˆ†ç»“æ„ CPU é£™é«˜ å¤§é‡ JSONã€Lua è„šæœ¬ ä½¿ç”¨å“ˆå¸Œæˆ– RedisJSON Python å¡ä½ æœªä½¿ç”¨è¿æ¥æ±  ä½¿ç”¨ ConnectionPool ","description":" 1. Key è®¾è®¡æœ€ä½³å®è·µ 1.1 Key å‘½åè§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰ ç³»ç»Ÿ:ä¸šåŠ¡:å®ä½“:id:å­—æ®µ\nç¤ºä¾‹ï¼š\nuser:info:1001 order:detail:20240101:9981 product:stock:sku123 ä¼˜ç‚¹ï¼šå¯è¯»ã€å¯æœç´¢ã€å¯åˆ†å±‚ã€‚\n1.2 ç¦æ­¢ä½¿ç”¨è¿‡é•¿ key æ¨èï¼š20ï½40 å­—ç¬¦ä»¥å†… é¿å…ï¼šè¶…è¿‡ 128 å­—ç¬¦ å¦åˆ™ç½‘ç»œä¼ è¾“æˆæœ¬ä¼šè¢«æ”¾å¤§ã€‚\n"},{"id":415,"href":"/database/redis/three-major-issues-with-redis-caching/","title":"Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜","parent":"Redis","content":"å†…å®¹ï¼šæ¦‚å¿µã€åŸå› ã€è§£å†³æ–¹æ¡ˆã€å®æˆ˜å»ºè®®ã€‚\nRedis ç¼“å­˜ä¸‰å¤§é—®é¢˜ï¼š\nç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©\nä¸€ã€ç¼“å­˜ç©¿é€ï¼ˆCache Penetrationï¼‰ âœ… æ˜¯ä»€ä¹ˆï¼Ÿ è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nğŸ”¥ å…¸å‹åœºæ™¯ è¯·æ±‚ ä¸å­˜åœ¨çš„ ID è¢«æ¶æ„æ”»å‡»ï¼ˆå¤§é‡éšæœº keyï¼‰ æ¥å£æœªåšå‚æ•°æ ¡éªŒ GET user:99999999 -\u0026gt; Redis æ²¡æœ‰ -\u0026gt; MySQL ä¹Ÿæ²¡æœ‰ -\u0026gt; æ¯æ¬¡éƒ½æŸ¥ DB âŒ å±å®³ DB è¢«æŒç»­æ‰“çˆ† ç¼“å­˜å½¢åŒè™šè®¾ âœ… è§£å†³æ–¹æ¡ˆï¼ˆå¿…è€ƒï¼‰ 1ï¸âƒ£ ç¼“å­˜ç©ºå€¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ key ä¸å­˜åœ¨ -\u0026gt; ç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡/null TTL è®¾ç½®çŸ­ä¸€ç‚¹ï¼ˆå¦‚ 30~60sï¼‰ âœ… ä¼˜ç‚¹ï¼šç®€å•æœ‰æ•ˆ âš ï¸ æ³¨æ„ï¼šå¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ 2ï¸âƒ£ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ è¯·æ±‚å‰å…ˆåˆ¤æ–­ key æ˜¯å¦å¯èƒ½å­˜åœ¨ ä¸å­˜åœ¨ -\u0026gt; ç›´æ¥æ‹’ç»ï¼Œä¸æŸ¥ç¼“å­˜/DB ğŸ“Œ é€‚åˆï¼š\næµ·é‡ key æ¶æ„æ”»å‡»åœºæ™¯ 3ï¸âƒ£ å‚æ•°æ ¡éªŒï¼ˆæœ€åŸºæœ¬ï¼‰ ID \u0026lt;= 0 ç›´æ¥è¿”å› éæ³•å‚æ•°æ‹¦æˆª â˜˜ï¸ æ€»ç»“ ç¼“å­˜ç©¿é€æ˜¯è®¿é—®ä¸å­˜åœ¨æ•°æ®å¯¼è‡´ DB å‹åŠ›ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ç¼“å­˜ç©ºå€¼æˆ–ä½¿ç”¨ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ã€‚\näºŒã€ç¼“å­˜å‡»ç©¿ï¼ˆCache Breakdownï¼‰ âœ… æ˜¯ä»€ä¹ˆï¼Ÿ æŸä¸€ä¸ªçƒ­ç‚¹ key è¿‡æœŸç¬é—´ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ã€‚\nğŸ”¥ å…¸å‹åœºæ™¯ çƒ­ç‚¹å•†å“ çƒ­ç‚¹é…ç½® çƒ­ç‚¹æ´»åŠ¨ æŸä¸€ç§’ï¼š key è¿‡æœŸ 10000 ä¸ªè¯·æ±‚åŒæ—¶è®¿é—® -\u0026gt; DB è¢«ç¬é—´å‡»ç©¿ âŒ å±å®³ æ•°æ®åº“ç¬æ—¶å‹åŠ›æš´æ¶¨ æœåŠ¡ RT é£™å‡ âœ… è§£å†³æ–¹æ¡ˆï¼ˆæ ¸å¿ƒï¼‰ 1ï¸âƒ£ äº’æ–¥é”ï¼ˆæœ€ç»å…¸ï¼‰ ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼š åŠ é” -\u0026gt; æŸ¥ DB -\u0026gt; å›å¡«ç¼“å­˜ å…¶ä»–è¯·æ±‚ï¼š ç­‰é” / è¿”å›æ—§å€¼ ğŸ“Œ å®ç°æ–¹å¼ï¼š\nRedis SETNX Redisson åˆ†å¸ƒå¼é” 2ï¸âƒ£ é€»è¾‘è¿‡æœŸï¼ˆé«˜çº§ï¼‰ value = { data: xxx, expireTime: 2025-01-01 12:00:00 } è¿‡æœŸäº†ä¹Ÿå…ˆè¿”å›æ—§å€¼ åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜ ğŸ“Œ é€‚åˆï¼š\nè¯»å¤šå†™å°‘ å…è®¸çŸ­æ—¶é—´è„æ•°æ® 3ï¸âƒ£ çƒ­ç‚¹ key æ°¸ä¸è¿‡æœŸï¼ˆç®€å•ç²—æš´ï¼‰ åªäººå·¥æˆ–å®šæ—¶åˆ·æ–° â˜˜ï¸ æ€»ç»“ ç¼“å­˜å‡»ç©¿æ˜¯çƒ­ç‚¹ key å¤±æ•ˆå¯¼è‡´å¹¶å‘æ‰“ DBï¼Œè§£å†³æ–¹æ¡ˆæ˜¯äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸã€‚\nä¸‰ã€ç¼“å­˜é›ªå´©ï¼ˆCache Avalancheï¼‰ âœ… æ˜¯ä»€ä¹ˆï¼Ÿ å¤§é‡ key åœ¨åŒä¸€æ—¶é—´è¿‡æœŸæˆ– Redis æ•´ä½“ä¸å¯ç”¨ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚æ¶Œå‘æ•°æ®åº“ã€‚\nğŸ”¥ å…¸å‹åœºæ™¯ å¤§é‡ key ä½¿ç”¨ç›¸åŒ TTL Redis å®•æœº Redis é‡å¯ã€ä¸»ä»åˆ‡æ¢ âŒ å±å®³ï¼ˆæœ€ä¸¥é‡ï¼‰ DB è¢«æ‰“æ­» æ•´ä¸ªç³»ç»Ÿé›ªå´©å¼æ•…éšœ âœ… è§£å†³æ–¹æ¡ˆï¼ˆå¿…èƒŒï¼‰ 1ï¸âƒ£ è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ TTL = 300 + random(0~60) é¿å…å¤§é‡ key åŒæ—¶è¿‡æœŸã€‚\n2ï¸âƒ£ å¤šçº§ç¼“å­˜ æœ¬åœ°ç¼“å­˜ -\u0026gt; Redis -\u0026gt; DB Redis æŒ‚äº†ä»æœ‰å…œåº•ã€‚\n3ï¸âƒ£ Redis é«˜å¯ç”¨ ä¸»ä»å¤åˆ¶ Sentinel Cluster 4ï¸âƒ£ é™æµ + ç†”æ–­ï¼ˆç³»ç»Ÿçº§ï¼‰ QPS é™åˆ¶ é™çº§è¿”å›é»˜è®¤å€¼ â˜˜ï¸ æ€»ç»“ ç¼“å­˜é›ªå´©æ˜¯å¤§é‡ç¼“å­˜å¤±æ•ˆæˆ– Redis ä¸å¯ç”¨å¯¼è‡´ DB è¢«å‹å®ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ TTL éšæœºåŒ–å’Œé«˜å¯ç”¨æ¶æ„ã€‚\nğŸ”¥ ä¸‰å¤§é—®é¢˜å¯¹æ¯” é—®é¢˜ æ ¸å¿ƒåŸå›  å½±å“èŒƒå›´ è§£å†³é‡ç‚¹ ç¼“å­˜ç©¿é€ æ•°æ®ä¸å­˜åœ¨ æŒç»­ ç©ºå€¼ç¼“å­˜ / Bloom ç¼“å­˜å‡»ç©¿ çƒ­ç‚¹ key è¿‡æœŸ ç¬æ—¶ é” / é€»è¾‘è¿‡æœŸ ç¼“å­˜é›ªå´© å¤§é‡ key åŒæ—¶å¤±æ•ˆ å…¨å±€ éšæœº TTL / é«˜å¯ç”¨ ğŸ¯ å…¶å®ƒ Qï¼šè¿™ä¸‰è€…æœ€å¤§åŒºåˆ«ï¼Ÿ ğŸ‘‰ æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦çƒ­ç‚¹ã€æ˜¯å¦å¤§é¢ç§¯ã€‚\nQï¼šæœ€å®¹æ˜“è¢«å¿½ç•¥çš„æ˜¯å“ªä¸ªï¼Ÿ ğŸ‘‰ ç¼“å­˜å‡»ç©¿ï¼ˆçƒ­ç‚¹ keyï¼‰ã€‚\nQï¼šç”Ÿäº§ç¯å¢ƒæœ€æ¨èæ–¹æ¡ˆï¼Ÿ ç©¿é€ï¼šç¼“å­˜ç©ºå€¼ + Bloom å‡»ç©¿ï¼šäº’æ–¥é” é›ªå´©ï¼šTTL éšæœº + Redis é«˜å¯ç”¨ é€šè¿‡è®¡åˆ’ä»»åŠ¡ï¼Œå®šæœŸæ›´æ–°ç¼“å­˜ï¼Œèƒ½ä¸èƒ½è§£å†³ Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜ï¼Ÿ ç»“è®ºï¼š\nä»…é â€œè®¡åˆ’ä»»åŠ¡å®šæœŸæ›´æ–°ç¼“å­˜â€ï¼Œä¸èƒ½å½»åº•è§£å†³ Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜ï¼Œåªèƒ½ç¼“è§£å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚\nä¸‹é¢æŒ‰ ç©¿é€ / å‡»ç©¿ / é›ªå´©ï¼Œé€ä¸€ç»™å‡ºå¯è½åœ°çš„ç»“è®ºã€‚\næ€»è§ˆï¼ˆå…ˆè®°ä½ï¼‰ï¼š\né—®é¢˜ å®šæœŸä»»åŠ¡èƒ½å¦è§£å†³ ç»“è®º ç¼“å­˜ç©¿é€ âŒ ä¸èƒ½ æ•°æ®æœ¬å°±ä¸å­˜åœ¨ ç¼“å­˜å‡»ç©¿ âš ï¸ éƒ¨åˆ†ç¼“è§£ çƒ­ç‚¹ key ä»æœ‰é£é™© ç¼“å­˜é›ªå´© âš ï¸ åªèƒ½ç¼“è§£ä¸€ç±» æ— æ³•åº”å¯¹ Redis ä¸å¯ç”¨ ä¸€ã€ç¼“å­˜ç©¿é€ âŒ â€”â€” å®Œå…¨è§£å†³ä¸äº† å›é¡¾å®šä¹‰ï¼š\nè¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨\nå®šæœŸä»»åŠ¡çš„é—®é¢˜åœ¨å“ªï¼Ÿ\nå®šæ—¶ä»»åŠ¡ åªä¼šæ›´æ–°â€œå­˜åœ¨çš„æ•°æ®â€ ä¸å­˜åœ¨çš„æ•°æ® æ ¹æœ¬ä¸çŸ¥é“è¦æ›´æ–°ä»€ä¹ˆ ä¾‹å­\nGET user:99999999 ï¼ˆDB æ ¹æœ¬æ²¡æœ‰ï¼‰ å³ä½¿ä½ æ¯ 5 åˆ†é’Ÿå…¨é‡åˆ·æ–°ç¼“å­˜ï¼š\nè¿™ä¸ª key ä¾ç„¶ä¸å­˜åœ¨ è¯·æ±‚ä»ç„¶æ¯æ¬¡æ‰“åˆ° DB âœ… æ­£ç¡®è§£æ³• ç¼“å­˜ç©ºå€¼ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ å‚æ•°æ ¡éªŒ ğŸ¯ ç»“è®º ç¼“å­˜ç©¿é€æ˜¯â€œè®¿é—®ä¸å­˜åœ¨æ•°æ®â€çš„é—®é¢˜ï¼Œå®šæœŸæ›´æ–°ç¼“å­˜æ— æ³•æ„ŸçŸ¥ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå› æ­¤æ— æ•ˆã€‚\näºŒã€ç¼“å­˜å‡»ç©¿ âš ï¸ â€”â€” åªèƒ½ç¼“è§£ï¼Œä¸èƒ½æ ¹æ²» å›é¡¾å®šä¹‰ï¼š\nçƒ­ç‚¹ key å¤±æ•ˆç¬é—´ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚æ‰“ DB\nå®šæœŸä»»åŠ¡èƒ½åšä»€ä¹ˆï¼Ÿ\nåœ¨ key è¿‡æœŸå‰åˆ·æ–°ç¼“å­˜ ç†è®ºä¸Šè®©çƒ­ç‚¹ key ä¸è¿‡æœŸ âœ… åœ¨ç†æƒ³æƒ…å†µä¸‹æœ‰æ•ˆ\nâŒ å®é™…ç”Ÿäº§ä¸­çš„é—®é¢˜ 1ï¸âƒ£ å®šæ—¶ä»»åŠ¡å¯èƒ½å¤±è´¥\nä»»åŠ¡æ‰§è¡Œå¤±è´¥ æ•°æ®åº“æŠ–åŠ¨ ç½‘ç»œé—®é¢˜ ğŸ‘‰ ä¸€æ—¦åˆ·æ–°å¤±è´¥ï¼Œçƒ­ç‚¹ key ä»ç„¶ä¼šè¿‡æœŸã€‚\n2ï¸âƒ£ å®šæ—¶ä»»åŠ¡ä¸æ˜¯å®æ—¶çš„\nåˆ·æ–°å‘¨æœŸæ˜¯ 1 åˆ†é’Ÿ / 5 åˆ†é’Ÿ åœ¨å‘¨æœŸç©ºæ¡£ä»å¯èƒ½è¿‡æœŸ 3ï¸âƒ£ å¤šå®ä¾‹å¹¶å‘åˆ·æ–°\nå¤šä¸ªèŠ‚ç‚¹åŒæ—¶åˆ·æ–° DB å‹åŠ›é›†ä¸­ âœ… æ­£ç¡®å§¿åŠ¿ï¼ˆç»„åˆæ‹³ï¼‰ å®šæœŸä»»åŠ¡ + äº’æ–¥é” / é€»è¾‘è¿‡æœŸ å®šæœŸä»»åŠ¡ï¼šå‡å°‘å‡»ç©¿æ¦‚ç‡ é” / é€»è¾‘è¿‡æœŸï¼šå…œåº•é˜²å¹¶å‘ ğŸ¯ ç»“è®º å®šæœŸæ›´æ–°ç¼“å­˜åªèƒ½é™ä½çƒ­ç‚¹ key å¤±æ•ˆæ¦‚ç‡ï¼Œä¸èƒ½æ›¿ä»£äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸæœºåˆ¶ã€‚\nä¸‰ã€ç¼“å­˜é›ªå´© âš ï¸ â€”â€” åªèƒ½è§£å†³â€œåŒæ—¶è¿‡æœŸâ€ï¼Œè§£å†³ä¸äº†â€œä¸å¯ç”¨â€ é›ªå´©çš„ä¸¤ç§æ¥æº 1ï¸âƒ£ å¤§é‡ key åŒæ—¶è¿‡æœŸ\n2ï¸âƒ£ Redis æ•´ä½“ä¸å¯ç”¨\nå®šæœŸä»»åŠ¡èƒ½è§£å†³å“ªä¸€ç§ï¼Ÿ âœ… èƒ½ç¼“è§£ï¼šå¤§é‡ key åŒæ—¶è¿‡æœŸ\nå®šæ—¶ä»»åŠ¡é”™å³°åˆ·æ–° å‡å°‘åŒä¸€æ—¶é—´å¤±æ•ˆçš„ key æ•°é‡ âŒ å®Œå…¨æ— èƒ½ä¸ºåŠ›ï¼šRedis å®•æœº\nRedis crash ä¸»ä»åˆ‡æ¢ ç½‘ç»œéš”ç¦» æ­¤æ—¶ï¼š\næ‰€æœ‰è¯·æ±‚ -\u0026gt; DB ä¸ç®¡ä½ æœ‰æ²¡æœ‰å®šæ—¶ä»»åŠ¡ã€‚\nâœ… æ­£ç¡®æ–¹æ¡ˆ TTL éšæœºåŒ– Redis ä¸»ä» / Sentinel / Cluster æœ¬åœ°ç¼“å­˜ é™æµ \u0026amp; ç†”æ–­ ğŸ¯ ç»“è®º å®šæœŸæ›´æ–°ç¼“å­˜åªèƒ½ç¼“è§£â€œè¿‡æœŸå‹é›ªå´©â€ï¼Œæ— æ³•åº”å¯¹ Redis ä¸å¯ç”¨å¯¼è‡´çš„é›ªå´©ã€‚\nğŸ”¥ æ€»ç»“ é€šè¿‡è®¡åˆ’ä»»åŠ¡å®šæœŸæ›´æ–°ç¼“å­˜ï¼Œåªèƒ½ä½œä¸ºè¾…åŠ©æ–¹æ¡ˆï¼Œä¸èƒ½è§£å†³ Redis ç¼“å­˜ä¸‰å¤§é—®é¢˜ã€‚\nå¯¹ç¼“å­˜ç©¿é€æ— æ•ˆï¼Œå› ä¸ºæ•°æ®æœ¬èº«ä¸å­˜åœ¨ï¼› å¯¹ç¼“å­˜å‡»ç©¿åªèƒ½é™ä½çƒ­ç‚¹ key å¤±æ•ˆæ¦‚ç‡ï¼Œä»éœ€äº’æ–¥é”æˆ–é€»è¾‘è¿‡æœŸå…œåº•ï¼› å¯¹ç¼“å­˜é›ªå´©åªèƒ½ç¼“è§£å¤§é‡ key åŒæ—¶è¿‡æœŸï¼Œæ— æ³•åº”å¯¹ Redis ä¸å¯ç”¨ã€‚ å› æ­¤ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç»“åˆç©ºå€¼ç¼“å­˜ã€Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ã€é”æœºåˆ¶å’Œé«˜å¯ç”¨æ¶æ„ä¸€èµ·ä½¿ç”¨ã€‚\nâ˜˜ï¸ æ¶æ„çº§æœ€ä½³å®è·µæ€»ç»“ å®šæœŸä»»åŠ¡ï¼ˆé™æ¦‚ç‡ï¼‰ + é€»è¾‘è¿‡æœŸï¼ˆé˜²å‡»ç©¿ï¼‰ + ç©ºå€¼ç¼“å­˜ / Bloomï¼ˆé˜²ç©¿é€ï¼‰ + TTL éšæœºï¼ˆé˜²é›ªå´©ï¼‰ + Redis é«˜å¯ç”¨ï¼ˆå…œåº•ï¼‰ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ å‚è€ƒæ–‡æ¡£ï¼š\nå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰è¯¦è§£ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯1970å¹´è¢«å¸ƒéš†æå‡ºæ¥çš„ï¼Œç”¨äºåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œä¼˜ç‚¹æ˜¯ç©ºé—´æ•ˆç‡å’ŒæŸ¥è¯¢æ—¶é—´éƒ½éå¸¸é«˜ï¼Œç¼ºç‚¹æ˜¯æœ‰ä¸€å®šçš„è¯¯åˆ¤ç‡å’Œåˆ é™¤å›°éš¾ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”±ä¸€ä¸ªè¶…é•¿çš„äºŒè¿›åˆ¶ä½æ•°ç»„å’Œå¤šä¸ªå“ˆå¸Œå‡½æ•°ç»„æˆã€‚\nå®ƒä¸»è¦ç”¨äºå¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨äºæµ·é‡æ•°æ®é›†åˆä¸­ï¼Œç‰¹ç‚¹æ˜¯èƒ½ä¿è¯â€œç»å¯¹ä¸å­˜åœ¨â€ï¼Œä½†åˆ¤æ–­â€œå­˜åœ¨â€æ—¶å­˜åœ¨ä¸€å®šè¯¯åˆ¤ç‡ï¼ˆå‡é˜³æ€§ï¼‰ã€‚\næ ¸å¿ƒåŸç† åˆå§‹åŒ–ï¼šåˆ›å»ºä¸€ä¸ªå…¨ä¸º 0 çš„è¶…é•¿äºŒè¿›åˆ¶æ•°ç»„ã€‚ æ·»åŠ å…ƒç´ ï¼šä½¿ç”¨å¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ è¿›è¡Œè®¡ç®—ï¼Œå°†å¾—åˆ°çš„å¤šä¸ªä½ç½®çš„æ¯”ç‰¹ä½ç”± 0 ç½®ä¸º 1ã€‚ æŸ¥è¯¢å…ƒç´ ï¼šå†æ¬¡ä½¿ç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºä½ç½®ï¼Œè‹¥å¯¹åº”ä½ç½®å…¨ä¸º 1ï¼Œåˆ™è®¤ä¸ºå…ƒç´ å¯èƒ½å­˜åœ¨ï¼›è‹¥æœ‰ä»»ä½•ä¸€ä½ä¸º 0ï¼Œåˆ™è¯¥å…ƒç´ ä¸€å®šä¸å­˜åœ¨ã€‚ ç‰¹ç‚¹ä¸æƒè¡¡ ä¼˜ç‚¹ï¼š\nç©ºé—´æ•ˆç‡é«˜ï¼šä¸å­˜å‚¨å…·ä½“å…ƒç´ å†…å®¹ï¼Œä»…å­˜å‚¨æ¯”ç‰¹ä½ï¼ŒèŠ‚çœå†…å­˜ã€‚ æŸ¥è¯¢é€Ÿåº¦å¿«ï¼šæ—¶é—´å¤æ‚åº¦ä¸º (O(k))ï¼Œå…¶ä¸­ (k) ä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ã€‚ ç¼ºç‚¹ï¼š\nå­˜åœ¨è¯¯åˆ¤ï¼ˆå‡é˜³æ€§ï¼‰ï¼šå¯èƒ½ä¼šå°†ä¸å­˜åœ¨çš„å…ƒç´ è¯¯åˆ¤ä¸ºå­˜åœ¨ï¼ˆå› ä¸ºå“ˆå¸Œç¢°æ’ï¼‰ï¼Œä½†ä¸ä¼šå‡ºç°å‡é˜´æ€§ï¼ˆåˆ¤æ–­ä¸å­˜åœ¨åˆ™ä¸€å®šä¸å­˜åœ¨ï¼‰ã€‚ éš¾ä»¥åˆ é™¤ï¼šé€šå¸¸ä¸æ”¯æŒç›´æ¥åˆ é™¤å…ƒç´ ï¼Œå› ä¸ºå¤šä¸ªå…ƒç´ å¯èƒ½å…±äº«ç›¸åŒçš„ä½ã€‚ ä¸»è¦åº”ç”¨åœºæ™¯ é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šåœ¨æŸ¥è¯¢æ•°æ®åº“å‰å…ˆé€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æ‰éæ³•è¯·æ±‚ã€‚ æµ·é‡æ•°æ®å»é‡ï¼šå¦‚çˆ¬è™«è¿‡æ»¤å·²çˆ¬å–çš„ URLã€åƒåœ¾é‚®ä»¶è¿‡æ»¤ã€‚ å¤§æ•°æ®é‡åˆ¤æ–­ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨äºåºå¤§çš„é›†åˆä¸­ï¼Œå¦‚ Hbase å’Œ BigTable ä¸­çš„è¡Œé”®æŸ¥è¯¢åŠ é€Ÿã€‚ ","description":"å†…å®¹ï¼šæ¦‚å¿µã€åŸå› ã€è§£å†³æ–¹æ¡ˆã€å®æˆ˜å»ºè®®ã€‚\nRedis ç¼“å­˜ä¸‰å¤§é—®é¢˜ï¼š\nç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©\nä¸€ã€ç¼“å­˜ç©¿é€ï¼ˆCache Penetrationï¼‰ âœ… æ˜¯ä»€ä¹ˆï¼Ÿ è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚\nğŸ”¥ å…¸å‹åœºæ™¯ è¯·æ±‚ ä¸å­˜åœ¨çš„ ID è¢«æ¶æ„æ”»å‡»ï¼ˆå¤§é‡éšæœº keyï¼‰ æ¥å£æœªåšå‚æ•°æ ¡éªŒ GET user:99999999 -\u0026gt; Redis æ²¡æœ‰ -\u0026gt; MySQL ä¹Ÿæ²¡æœ‰ -\u0026gt; æ¯æ¬¡éƒ½æŸ¥ DB âŒ å±å®³ DB è¢«æŒç»­æ‰“çˆ† ç¼“å­˜å½¢åŒè™šè®¾ âœ… è§£å†³æ–¹æ¡ˆï¼ˆå¿…è€ƒï¼‰ 1ï¸âƒ£ ç¼“å­˜ç©ºå€¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ key ä¸å­˜åœ¨ -\u0026gt; ç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡/null TTL è®¾ç½®çŸ­ä¸€ç‚¹ï¼ˆå¦‚ 30~60sï¼‰ âœ… ä¼˜ç‚¹ï¼šç®€å•æœ‰æ•ˆ âš ï¸ æ³¨æ„ï¼šå¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´ 2ï¸âƒ£ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ è¯·æ±‚å‰å…ˆåˆ¤æ–­ key æ˜¯å¦å¯èƒ½å­˜åœ¨ ä¸å­˜åœ¨ -\u0026gt; ç›´æ¥æ‹’ç»ï¼Œä¸æŸ¥ç¼“å­˜/DB ğŸ“Œ é€‚åˆï¼š\n"},{"id":416,"href":"/database/redis/cluster/","title":"Redis é›†ç¾¤","parent":"Redis","content":" ğŸš€ Redis é›†ç¾¤ï¼ˆRedis Clusterï¼‰å…¨å¥—çŸ¥è¯†ä½“ç³» æ¶æ„ + åŸç† + åˆ†ç‰‡ + é€‰ä¸» + è¯»å†™ + è¿ç»´ + æœ€ä½³å®è·µ\n1. Redis Cluster æ˜¯ä»€ä¹ˆï¼Ÿ Redis Cluster æ˜¯ Redis å®˜æ–¹åŸç”Ÿçš„ åˆ†å¸ƒå¼é›†ç¾¤æ–¹æ¡ˆï¼Œç”¨äºå®ç°ï¼š\næ•°æ®åˆ†ç‰‡ï¼ˆæ°´å¹³æ‰©å®¹ï¼‰ é«˜å¯ç”¨ï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰ å¼ºä¸€è‡´æ€§ hash slot è·¯ç”± å†…ç½®ä¸»ä»å¤åˆ¶ ç›®æ ‡ï¼šåœ¨å¤šèŠ‚ç‚¹é—´å…±äº«æ•°æ®ï¼Œæ‰©å±•è¯»æ€§èƒ½ã€å†™æ€§èƒ½ï¼Œé¿å…å•æœºå†…å­˜ä¸å¸¦å®½ç“¶é¢ˆã€‚\n2. Redis Cluster æ¶æ„å›¾ï¼ˆæ ¸å¿ƒï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–º â”‚ Master1â”‚ â—„â”€â”€â” â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â–² â–² â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ Slave1 Slave2 â”‚ â”‚ â”‚ Client â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼- Cluster Bus â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â””â”€â”€â–º â”‚ Master2 â”‚ â—„â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–² Slave3 å…³é”®ç‰¹å¾ï¼š\næ¯ä¸ªä¸»èŠ‚ç‚¹ç®¡ç†ä¸€éƒ¨åˆ† Hash Slot æ¯ä¸ªä¸»èŠ‚ç‚¹è‡³å°‘ 1 ä¸ªä»èŠ‚ç‚¹ï¼ˆæ¨èï¼‰ å®¢æˆ·ç«¯ç›´è¿ä»»æ„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è¿”å›æ•°æ®æˆ– MOVED è·³è½¬ èŠ‚ç‚¹ä¹‹é—´é€šè¿‡ Cluster Busï¼ˆç«¯å£+10000ï¼‰ é€šä¿¡ 3. Redis Cluster çš„ Hash Slotï¼ˆåˆ†ç‰‡æ ¸å¿ƒï¼‰ Redis Cluster å°†æ•´ä¸ªæ•°æ®åº“åˆ’åˆ†ä¸ºï¼š\n16384 ä¸ªæ§½ä½ï¼ˆslotï¼‰\næ¯ä¸ª key é€šè¿‡ CRC16 ç®—æ³•å–æ¨¡ï¼š\nslot = CRC16(key) % 16384 æ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ† slotï¼Œä¾‹å¦‚ï¼š\nMaster1 -\u0026gt; 0 ~ 5460 Master2 -\u0026gt; 5461 ~ 10922 Master3 -\u0026gt; 10923 ~ 16383 4. å¦‚ä½•å®ç° Key çš„â€œå¼ºå®šå‘åˆ†ç‰‡â€ï¼ˆHash Tagï¼‰ ä½ å¯ä»¥é€šè¿‡ {tag} å›ºå®š key çš„ slotï¼š\nä¾‹å¦‚ï¼š\nuser:{1001}:info user:{1001}:like user:{1001}:follow ä¸‰ä¸ª key éƒ½ä¼šè½åœ¨åŒä¸€ä¸ª slot -\u0026gt; å¯ä»¥æ‰§è¡Œ MULTI å‘½ä»¤ã€Luaã€pipeline\néå¸¸é‡è¦ï¼\n5. Redis Cluster çš„æ•°æ®è¯»å†™æµç¨‹ å®¢æˆ·ç«¯å¯ä»¥è¿æ¥ä»»æ„èŠ‚ç‚¹ã€‚\nå†™æµç¨‹ï¼š\nClient -\u0026gt; NodeA if NodeA è´Ÿè´£è¯¥ slotï¼š å†™æˆåŠŸ else: NodeA è¿”å› MOVED (slot, rightNode) Client è‡ªåŠ¨é‡å®šå‘åˆ° rightNode 6. MOVED / ASK çš„åŒºåˆ« MOVED è¯¥ slot æœªæ¥éƒ½ç”±è¿™ä¸ªæ–°èŠ‚ç‚¹è´Ÿè´£ -\u0026gt; æ­£å¼è¿ç§»å·²å®Œæˆ -\u0026gt; å®¢æˆ·ç«¯åº”è¯¥æ›´æ–°è‡ªå·±çš„ slot ç¼“å­˜ ASK è¯¥ slot æ­£åœ¨è¿ç§»ä¸­ -\u0026gt; ä¸´æ—¶æ€§çš„ -\u0026gt; å®¢æˆ·ç«¯å‘æ—§èŠ‚ç‚¹ ASKINGï¼Œç„¶åè®¿é—®æ–°èŠ‚ç‚¹ 7. Redis Cluster çš„é«˜å¯ç”¨æœºåˆ¶ï¼ˆé€‰ä¸»åŸç†ï¼‰ Redis é‡‡ç”¨ Gossip åè®®ï¼ˆåŸºäº cluster busï¼‰æ„ŸçŸ¥èŠ‚ç‚¹çŠ¶æ€ã€‚\nèŠ‚ç‚¹çš„çŠ¶æ€ï¼š\nPFAILï¼šæŸä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼ˆä¸»è§‚å®•æœºï¼‰ FAILï¼šåŠæ•°ä»¥ä¸Š master è®¤ä¸ºæŸèŠ‚ç‚¹æŒ‚äº† -\u0026gt; å®¢è§‚å®•æœº é€‰ä¸»è¿‡ç¨‹ï¼ˆfailoverï¼‰ å½“æŸä¸ª Master å®•æœºï¼š\nå®ƒçš„ä»èŠ‚ç‚¹ä¸­ä¼šé€‰ä¸¾ä¸€ä¸ªä½œä¸ºæ–°çš„ Master\né€‰ä¸¾æ¡ä»¶ï¼š\nä¸ä¸»èŠ‚ç‚¹æ–­è”æ—¶é—´åœ¨ 10 ç§’ä»¥å†…ï¼ˆcluster-node-timeoutï¼‰ å¤åˆ¶ offset ä½ç½®é å‰ï¼ˆæ•°æ®æœ€å…¨ï¼‰ å…¶ä»–èŠ‚ç‚¹è¿›è¡ŒæŠ•ç¥¨ï¼Œè¿‡åŠå³å¯æˆä¸ºæ–°ä¸»\n8. Redis Cluster çš„ CAP æ¨¡å‹ Redis Cluster å±äºï¼š\nAPï¼ˆé«˜å¯ç”¨é«˜æ€§èƒ½ï¼‰+ å¼±ä¸€è‡´æ€§\nåŸå› ï¼š\né›†ç¾¤ä¸æ”¯æŒ multi-key è·¨ slot çš„äº‹åŠ¡ Cluster åœ¨å¤šæ•°èŠ‚ç‚¹å­˜æ´»æ—¶ç»§ç»­æœåŠ¡ ç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´çŸ­æš‚ä¸ä¸€è‡´ 9. Redis Cluster çš„éƒ¨ç½²è§„æ¨¡ï¼ˆæœ€ä½³å®è·µï¼‰ å®˜æ–¹æ¨èï¼š\n3 ä¸» 3 ä»ï¼ˆå…± 6 èŠ‚ç‚¹ï¼‰ æ›´å¤§éƒ¨ç½²ï¼š\n6 ä¸» 6 ä»ï¼ˆ12 èŠ‚ç‚¹ï¼‰ 9 ä¸» 9 ä»ï¼ˆ18 èŠ‚ç‚¹ï¼‰ å†…å­˜è§„åˆ’ï¼š\næ¯ä¸ªèŠ‚ç‚¹ä¸è¶…è¿‡ 50GB å†…å­˜ï¼ˆè¿‡å¤§ä¼šå¯¼è‡´ RDB/AOF å·¨å¤§ï¼‰ å• slot æŒæœ‰çš„ key å°½é‡å‡è¡¡ 10. Redis Cluster å¸¸ç”¨å‘½ä»¤ æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹\ncluster nodes æŸ¥çœ‹ slot åˆ†å¸ƒ\ncluster slots è°ƒæ•´åˆ†ç‰‡ï¼ˆslot è¿ç§»ï¼‰\nredis-cli --cluster reshard ... åˆ›å»ºé›†ç¾¤\nredis-cli --cluster create host1:7000 host2:7001 ... --cluster-replicas 1 11. Redis Cluster çš„å¸¸è§å‘ä¸æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ å¿…é¡»ä½¿ç”¨æ”¯æŒ cluster çš„å®¢æˆ·ç«¯ å¦‚ï¼š\nPythonï¼šredis-py cluster Goï¼šgo-redis cluster Javaï¼šlettuce / Redissonï¼ˆæœ€æ¨èï¼‰ æ™®é€š redis å®¢æˆ·ç«¯æ— æ³•ä½¿ç”¨ clusterã€‚\nç¦æ­¢ä½¿ç”¨ keys / flushallï¼ˆä¼šé˜»å¡æ•´ä¸ª clusterï¼‰ ä¸è¦ä½¿ç”¨å¤§ Key å¦åˆ™ï¼š\nè¿ç§» slot æ—¶éå¸¸æ…¢ ä¼šå¯¼è‡´é˜»å¡ã€å»¶è¿Ÿå¢åŠ  å†™æ“ä½œä¸èƒ½ä¿è¯å¼ºä¸€è‡´ éœ€è¦ç”¨ Lua æˆ–è€…åˆ†å¸ƒå¼é”è¿›è¡Œè¡¥å……ã€‚\nä¸è¦åœ¨é›†ç¾¤å†…ä½¿ç”¨ multi è·¨ slot æ“ä½œ é™¤é key ä½¿ç”¨ hash tagï¼š\norder:{1001}:base order:{1001}:items order:{1001}:price ä¸»ä»å»¶è¿Ÿä¼šå¯¼è‡´è¯»ä¸ä¸€è‡´ è§£å†³ï¼š\nç”¨ Redisson ä¿è¯å¼ºåˆ¶è¯»ä¸»èŠ‚ç‚¹ æˆ–ç­‰åŒæ­¥ offset ç¡®è®¤åå†è¯» 12. Redis Cluster çš„ç”Ÿäº§ç›‘æ§æŒ‡æ ‡ï¼ˆå¿…é¡»ç›‘æ§ï¼‰ å†…å­˜ used_memory mem_fragmentation_ratio å»¶è¿Ÿ latency spikes slowlog å¤åˆ¶å»¶è¿Ÿ slave_repl_offset master_repl_offset è¿æ¥æ•° connected_clients Slot å‡è¡¡ å„èŠ‚ç‚¹ key å’Œ slot æ˜¯å¦å¹³è¡¡ 13. Redis Cluster vs ä¸»ä» + å“¨å…µï¼ˆSentinelï¼‰ åŠŸèƒ½ Redis Cluster Sentinel é›†ç¾¤ æ•°æ®åˆ†ç‰‡ âœ… âŒ è‡ªåŠ¨åˆ†ç‰‡ï¼ˆæ‰©å®¹ï¼‰ âœ… âŒ é«˜å¯ç”¨ âœ… âœ… éƒ¨ç½²å¤æ‚åº¦ é«˜ ä¸­ å®¢æˆ·ç«¯è¦æ±‚ è¦æ”¯æŒ cluster æ™®é€šå®¢æˆ·ç«¯å³å¯ å¤š key äº‹åŠ¡ éƒ¨åˆ†æ”¯æŒ å®Œå…¨æ”¯æŒ ç»“è®ºï¼šéœ€è¦æ‰©å®¹é€‰ Clusterï¼Œä¼ ç»Ÿä¸šåŠ¡é€‰ Sentinelã€‚\n14. Redis Cluster æ¶æ„æœ€ä½³å®è·µï¼ˆéå¸¸å…³é”®ï¼‰ æœ€ä½³éƒ¨ç½²æ–¹æ¡ˆ 6 èŠ‚ç‚¹ï¼ˆ3 ä¸» 3 ä»ï¼‰ è‡³å°‘ä¸¤ä¸ªæœºæˆ¿ï¼ˆåˆ† AZï¼‰ å•èŠ‚ç‚¹å°½é‡ \u0026lt; 50GB ä¸ºäº†é¿å… RDB/AOF ç”Ÿæˆè¿‡æ…¢\né¿å…å¤§ key è¿™æ · slot è¿ç§»æ‰ä¼šå¿«ã€å¤åˆ¶ä¸ä¼šé˜»å¡ã€‚\nä½¿ç”¨ hash tag è®¾è®¡ keyï¼ˆæ¨èï¼‰ æé«˜ä¸šåŠ¡çš„èšåˆæ€§ã€å‡å°‘è·¨ slotã€‚\nä½¿ç”¨ pipeline æ‰¹é‡æ“ä½œï¼Œå‡å°‘ RTT 15. Redis é›†ç¾¤å¸¸è§æ•…éšœä¸è§£å†³æ–¹æ¡ˆ âŒ æ•…éšœ 1ï¼šé›†ç¾¤å‡ºç° â€œCLUSTERDOWN Hash slot not servedâ€ åŸå› ï¼š\næŸä¸ª master èŠ‚ç‚¹æŒ‚äº† æ‰€æœ‰ä»èŠ‚ç‚¹ä¹ŸæŒ‚äº† æˆ–è€… slot è¿ç§»æœªå®Œæˆ è§£å†³ï¼š\næ£€æŸ¥èŠ‚ç‚¹ é‡å»ºä»èŠ‚ç‚¹ é‡æ–°æŒ‚è½½ slot âŒ æ•…éšœ 2ï¼šè¿ç§» slot è¿‡æ…¢ åŸå› ï¼š\nå­˜åœ¨å¤§ key ç½‘ç»œç“¶é¢ˆ è§£å†³ï¼š\nå…ˆæ‰«æå¤§ key -\u0026gt; æ‹†åˆ† è°ƒæ•´ migrate å‚æ•°ï¼ˆpipelineï¼‰ âŒ æ•…éšœ 3ï¼šä¸»ä»å»¶è¿Ÿå˜å¤§ åŸå› ï¼š\nä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ ç½‘ç»œä¸ç¨³å®š å¤§ key åŒæ­¥ è§£å†³ï¼š\nä¼˜åŒ–æ…¢å‘½ä»¤ è°ƒæ•´èŠ‚ç‚¹è´Ÿè½½ é¿å…å¤§ key ","description":" ğŸš€ Redis é›†ç¾¤ï¼ˆRedis Clusterï¼‰å…¨å¥—çŸ¥è¯†ä½“ç³» æ¶æ„ + åŸç† + åˆ†ç‰‡ + é€‰ä¸» + è¯»å†™ + è¿ç»´ + æœ€ä½³å®è·µ\n1. Redis Cluster æ˜¯ä»€ä¹ˆï¼Ÿ Redis Cluster æ˜¯ Redis å®˜æ–¹åŸç”Ÿçš„ åˆ†å¸ƒå¼é›†ç¾¤æ–¹æ¡ˆï¼Œç”¨äºå®ç°ï¼š\næ•°æ®åˆ†ç‰‡ï¼ˆæ°´å¹³æ‰©å®¹ï¼‰ é«˜å¯ç”¨ï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰ å¼ºä¸€è‡´æ€§ hash slot è·¯ç”± å†…ç½®ä¸»ä»å¤åˆ¶ ç›®æ ‡ï¼šåœ¨å¤šèŠ‚ç‚¹é—´å…±äº«æ•°æ®ï¼Œæ‰©å±•è¯»æ€§èƒ½ã€å†™æ€§èƒ½ï¼Œé¿å…å•æœºå†…å­˜ä¸å¸¦å®½ç“¶é¢ˆã€‚\n"},{"id":417,"href":"/backend/python/official/regex/","title":"Regex (æ­£åˆ™è¡¨è¾¾å¼)","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/re.html\nå¯¼å…¥æ–¹å¼ï¼š\nimport re 1. æ ¸å¿ƒ APIï¼ˆå¿…é¡»è®°ä½çš„ 5 ä¸ªï¼‰ re.match(pattern, s) # ä»å¼€å¤´åŒ¹é… re.search(pattern, s) # æœç´¢ç¬¬ä¸€ä¸ªåŒ¹é… re.findall(pattern, s) # æ‰¾å‡ºå…¨éƒ¨åŒ¹é…ï¼Œè¿”å› list re.sub(pattern, repl, s) # æ›¿æ¢ re.fullmatch(pattern, s) # å®Œå…¨åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸² 2. åŸºæœ¬å…ƒå­—ç¬¦ ç¬¦å· å«ä¹‰ . ä»»æ„å­—ç¬¦ï¼ˆä¸å«æ¢è¡Œï¼‰ \\d æ•°å­— \\w å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ \\s ç©ºç™½å­—ç¬¦ ^ å¼€å¤´ $ ç»“å°¾ [] å­—ç¬¦é›† ` ` () åˆ†ç»„ 3. æ•°é‡è¯ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ è¡¨è¾¾å¼ å«ä¹‰ * 0 æ¬¡æˆ–æ— é™ + 1 æ¬¡æˆ–æ— é™ ? 0 æˆ– 1 æ¬¡ {n} æ°å¥½ n æ¬¡ {n,} n æ¬¡ä»¥ä¸Š {n,m} n åˆ° m æ¬¡ 4. å¸¸ç”¨åˆ¤æ–­ç¤ºä¾‹ åˆ¤æ–­çº¯æ•°å­—å­—ç¬¦ä¸² bool(re.fullmatch(r\u0026#34;\\d+\u0026#34;, s)) åˆ¤æ–­ä»¥ 00 æˆ– 60 å¼€å¤´çš„â€œçº¯æ•°å­—â€ bool(re.fullmatch(r\u0026#34;(00|60)\\d+\u0026#34;, s)) åˆ¤æ–­é‚®ç®±æ ¼å¼ bool(re.fullmatch(r\u0026#34;[^@]+@[^@]+\\.[^@]+\u0026#34;, email)) 5. å¸¸ç”¨æå– æå–æ‰€æœ‰æ•°å­— re.findall(r\u0026#34;\\d+\u0026#34;, text) æå–æ—¥æœŸ re.findall(r\u0026#34;\\d{4}-\\d{2}-\\d{2}\u0026#34;, text) æå–è‚¡ç¥¨ä»£ç ï¼ˆ6 ä½æ•°å­—ï¼‰ re.findall(r\u0026#34;\\b\\d{6}\\b\u0026#34;, text) 6. åˆ†ç»„ (group) m = re.search(r\u0026#34;(\\d+)-(\\d+)\u0026#34;, \u0026#34;123-456\u0026#34;) m.group(1) # \u0026#34;123\u0026#34; m.group(2) # \u0026#34;456\u0026#34; m.groups() # (\u0026#34;123\u0026#34;, \u0026#34;456\u0026#34;) 7. å‘½ååˆ†ç»„ m = re.search(r\u0026#34;(?P\u0026lt;code\u0026gt;\\d{6})-(?P\u0026lt;name\u0026gt;\\w+)\u0026#34;, \u0026#34;600001-ABC\u0026#34;) m.group(\u0026#34;code\u0026#34;) m.group(\u0026#34;name\u0026#34;) 8. æ›¿æ¢ï¼ˆé‡ç‚¹ï¼‰ åŸºæœ¬æ›¿æ¢ re.sub(r\u0026#34;cat\u0026#34;, \u0026#34;dog\u0026#34;, text) æ›¿æ¢æ•°å­—ä¸º [NUM] re.sub(r\u0026#34;\\d+\u0026#34;, \u0026#34;[NUM]\u0026#34;, text) ä½¿ç”¨å‡½æ•°æ›¿æ¢ def repl(m): return str(int(m.group()) * 2) re.sub(r\u0026#34;\\d+\u0026#34;, repl, \u0026#34;1 2 3\u0026#34;) # \u0026#34;2 4 6\u0026#34; 9. compile æå‡æ€§èƒ½ï¼ˆç”Ÿäº§å¸¸ç”¨ï¼‰ é€‚åˆå¤§é‡å¾ªç¯åŒ¹é…ï¼š\npat = re.compile(r\u0026#34;\\d{6}\u0026#34;) pat.findall(text) ä¼˜åŠ¿ï¼šé¿å…å¤šæ¬¡è§£ææ­£åˆ™ï¼Œæé«˜é€Ÿåº¦ã€‚\n10. éè´ªå©ªåŒ¹é… é»˜è®¤æ˜¯è´ªå©ªï¼š\nre.findall(r\u0026#34;\u0026lt;.*\u0026gt;\u0026#34;, \u0026#34;\u0026lt;a\u0026gt;\u0026lt;b\u0026gt;\u0026#34;) # [\u0026#39;\u0026lt;a\u0026gt;\u0026lt;b\u0026gt;\u0026#39;] éè´ªå©ªï¼š\nre.findall(r\u0026#34;\u0026lt;.*?\u0026gt;\u0026#34;, \u0026#34;\u0026lt;a\u0026gt;\u0026lt;b\u0026gt;\u0026#34;) # [\u0026#39;\u0026lt;a\u0026gt;\u0026#39;, \u0026#39;\u0026lt;b\u0026gt;\u0026#39;] 11. å‰ç» / åé¡¾ï¼ˆé«˜çº§ï¼‰ æ­£å‘å‰ç»ï¼ˆåŒ¹é…åé¢æ˜¯æŸå†…å®¹ï¼‰ æå–è·Ÿåœ¨ ï¿¥ åçš„æ•°å­—ï¼š\nre.findall(r\u0026#34;(?\u0026lt;=ï¿¥)\\d+\u0026#34;, \u0026#34;ä»·æ ¼ï¿¥199å…ƒ\u0026#34;) è´Ÿå‘å‰ç»ï¼ˆåé¢ä¸æ˜¯æŸå†…å®¹ï¼‰ åŒ¹é…ä¸ä»¥ .jpg ç»“å°¾çš„æ–‡ä»¶åï¼š\nre.findall(r\u0026#34;.+(?!\\.jpg)$\u0026#34;, filename) 12. å¤šè¡Œä¸ç‚¹å·åŒ¹é…æ¢è¡Œ Flags ä½œç”¨ re.M ^ $ åŒ¹é…æ¯ä¸€è¡Œçš„å¼€å¤´ç»“å°¾ re.S . åŒ¹é…æ¢è¡Œç¬¦ re.I ä¸åŒºåˆ†å¤§å°å†™ re.X å¿½ç•¥ç©ºç™½æ–¹ä¾¿æ’ç‰ˆ ç¤ºä¾‹ï¼š\nre.findall(r\u0026#34;\u0026lt;div.*?\u0026lt;/div\u0026gt;\u0026#34;, html, flags=re.S) 13. æœ€å¸¸ç”¨æ­£åˆ™åœºæ™¯æ€»ç»“ åœºæ™¯ æ­£åˆ™ æ£€æŸ¥æ‰‹æœºå· ^1\\d{10}$ æ£€æŸ¥ email ^[^@]+@[^@]+\\.[^@]+$ æ£€æŸ¥èº«ä»½è¯ ^\\d{17}[\\dXx]$ å…¨æ•°å­— ^\\d+$ 6 ä½è‚¡ç¥¨ä»£ç  ^\\d{6}$ ä»¥ 00/60 å¼€å¤´è‚¡ç¥¨ `^(00 æ—¥æœŸ ^\\d{4}-\\d{2}-\\d{2}$ æå–å…¨éƒ¨ä¸­æ–‡ [\\u4e00-\\u9fa5]+ æå– IP \\d+\\.\\d+\\.\\d+\\.\\d+ 14. å¸¸ç”¨çš„ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹ è‚¡ç¥¨ä»£ç è¿‡æ»¤ï¼ˆæ ‡é¢˜è¿‡æ»¤ï¼‰ is_stock = bool(re.fullmatch(r\u0026#34;(00|60)\\d+\u0026#34;, stock_code)) has_bad_title = bool(re.search(title_exclude_regex, title)) datetime_date æ›¿æ¢ä¸º datetime::date pattern = re.compile(r\u0026#34;(^|\\.)(datetime_date)(__|$)\u0026#34;) pattern.sub(r\u0026#34;\\1datetime::date\\3\u0026#34;, source) 15. å†™æ­£åˆ™æ—¶çš„æœ€ä½³å®è·µ ä½¿ç”¨ raw stringï¼šr\u0026quot;^\\d+$\u0026quot; å¤æ‚æ­£åˆ™å…ˆç”¨ re.compile ä¸ç¡®å®šæ˜¯å¦åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²ç”¨ fullmatch å°½é‡é¿å…è¿‡åº¦çš„è´ªå©ªåŒ¹é… å¤šç”¨å‘½ååˆ†ç»„æé«˜å¯è¯»æ€§ å­˜åœ¨å¤§é‡å¾ªç¯æ—¶ä¸€å®šç”¨ compile æ­£åˆ™å¤ªå¤æ‚æ—¶åˆ†æˆå¤šä¸ªæ­¥éª¤ ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/re.html\nå¯¼å…¥æ–¹å¼ï¼š\nimport re 1. æ ¸å¿ƒ APIï¼ˆå¿…é¡»è®°ä½çš„ 5 ä¸ªï¼‰ re.match(pattern, s) # ä»å¼€å¤´åŒ¹é… re.search(pattern, s) # æœç´¢ç¬¬ä¸€ä¸ªåŒ¹é… re.findall(pattern, s) # æ‰¾å‡ºå…¨éƒ¨åŒ¹é…ï¼Œè¿”å› list re.sub(pattern, repl, s) # æ›¿æ¢ re.fullmatch(pattern, s) # å®Œå…¨åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸² 2. åŸºæœ¬å…ƒå­—ç¬¦ ç¬¦å· å«ä¹‰ . ä»»æ„å­—ç¬¦ï¼ˆä¸å«æ¢è¡Œï¼‰ \\d æ•°å­— \\w å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ \\s ç©ºç™½å­—ç¬¦ ^ å¼€å¤´ $ ç»“å°¾ [] å­—ç¬¦é›† ` ` () åˆ†ç»„ 3. æ•°é‡è¯ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ è¡¨è¾¾å¼ å«ä¹‰ * 0 æ¬¡æˆ–æ— é™ + 1 æ¬¡æˆ–æ— é™ ? 0 æˆ– 1 æ¬¡ {n} æ°å¥½ n æ¬¡ {n,} n æ¬¡ä»¥ä¸Š {n,m} n åˆ° m æ¬¡ 4. å¸¸ç”¨åˆ¤æ–­ç¤ºä¾‹ åˆ¤æ–­çº¯æ•°å­—å­—ç¬¦ä¸² bool(re.fullmatch(r\u0026#34;\\d+\u0026#34;, s)) åˆ¤æ–­ä»¥ 00 æˆ– 60 å¼€å¤´çš„â€œçº¯æ•°å­—â€ bool(re.fullmatch(r\u0026#34;(00|60)\\d+\u0026#34;, s)) åˆ¤æ–­é‚®ç®±æ ¼å¼ bool(re.fullmatch(r\u0026#34;[^@]+@[^@]+\\.[^@]+\u0026#34;, email)) 5. å¸¸ç”¨æå– æå–æ‰€æœ‰æ•°å­— re.findall(r\u0026#34;\\d+\u0026#34;, text) æå–æ—¥æœŸ re.findall(r\u0026#34;\\d{4}-\\d{2}-\\d{2}\u0026#34;, text) æå–è‚¡ç¥¨ä»£ç ï¼ˆ6 ä½æ•°å­—ï¼‰ re.findall(r\u0026#34;\\b\\d{6}\\b\u0026#34;, text) 6. åˆ†ç»„ (group) m = re.search(r\u0026#34;(\\d+)-(\\d+)\u0026#34;, \u0026#34;123-456\u0026#34;) m.group(1) # \u0026#34;123\u0026#34; m.group(2) # \u0026#34;456\u0026#34; m.groups() # (\u0026#34;123\u0026#34;, \u0026#34;456\u0026#34;) 7. å‘½ååˆ†ç»„ m = re.search(r\u0026#34;(?P\u0026lt;code\u0026gt;\\d{6})-(?P\u0026lt;name\u0026gt;\\w+)\u0026#34;, \u0026#34;600001-ABC\u0026#34;) m.group(\u0026#34;code\u0026#34;) m.group(\u0026#34;name\u0026#34;) 8. æ›¿æ¢ï¼ˆé‡ç‚¹ï¼‰ åŸºæœ¬æ›¿æ¢ re.sub(r\u0026#34;cat\u0026#34;, \u0026#34;dog\u0026#34;, text) æ›¿æ¢æ•°å­—ä¸º [NUM] re.sub(r\u0026#34;\\d+\u0026#34;, \u0026#34;[NUM]\u0026#34;, text) ä½¿ç”¨å‡½æ•°æ›¿æ¢ def repl(m): return str(int(m.group()) * 2) re.sub(r\u0026#34;\\d+\u0026#34;, repl, \u0026#34;1 2 3\u0026#34;) # \u0026#34;2 4 6\u0026#34; 9. compile æå‡æ€§èƒ½ï¼ˆç”Ÿäº§å¸¸ç”¨ï¼‰ é€‚åˆå¤§é‡å¾ªç¯åŒ¹é…ï¼š\n"},{"id":418,"href":"/backend/python/official/regex-compile/","title":"Regex compile (æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ é¡¹ç›®çº§çš„ã€ŠPython æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘ä¸æœ€ä½³å®è·µã€‹ï¼Œæ¶µç›–ï¼š\næ­£åˆ™ç¼–è¯‘æœ€ä½³æ–¹å¼ æ€§èƒ½ä¼˜åŒ– é¡¹ç›®ä¸­æ¨èçš„ä½¿ç”¨æ¨¡å¼ å¸¸è§é”™è¯¯é¿å… æä¾›å®Œæ•´å¯ç”¨çš„ utils.regex å·¥å…·æ¨¡å— å…¨éƒ¨å…¼å®¹ Python 3.12 / BasedPyrightï¼Œå¯ç›´æ¥åŠ å…¥ä½ çš„é¡¹ç›®ã€‚\nâœ… 1. ä¸ºä»€ä¹ˆè¦â€œç¼–è¯‘â€æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ Python çš„æ­£åˆ™æ¨¡å— re å·¥ä½œæ–¹å¼ï¼š\nå†™æ³• æ˜¯å¦æ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘æ­£åˆ™ï¼Ÿ æ€§èƒ½ re.search(pattern, text) âœ… æ˜¯ âŒ è¾ƒæ…¢ compiled = re.compile(pattern); compiled.search(text) âŒ å¦ï¼ˆå¤ç”¨ï¼‰ âœ… å¿« åœ¨ å¾ªç¯ / é«˜é¢‘è°ƒç”¨ / å¤§è§„æ¨¡æ•°æ®å¤„ç† / HTTPè¯·æ±‚çˆ¬è™« / å®šæ—¶ä»»åŠ¡ ä¸­ï¼Œæ¨èï¼š\næ­£åˆ™æå‰ç¼–è¯‘ é‡å¤å¤ç”¨ ä¸è¦åœ¨å¾ªç¯ä¸­å†™ re.search(pattern, text) âœ… 2. æ­£åˆ™ç¼–è¯‘æœ€ä½³å®è·µå†™æ³• å•ä¸ªæ¨¡å¼ PAT_STOCK_CODE = re.compile(r\u0026#34;^(00|60)\\d+\u0026#34;) åˆ†ç»„æ•è· PAT_EQUAL = re.compile(r\u0026#34;=(.+)$\u0026#34;) æ”¯æŒä¸­æ–‡çš„ä¸¥æ ¼æ¨¡å¼ PAT_DATE_CN = re.compile(r\u0026#34;(\\d{4})å¹´(\\d{2})æœˆ(\\d{2})æ—¥\u0026#34;) å¸¦ flags PAT_MULTI = re.compile(r\u0026#34;foo.*bar\u0026#34;, re.DOTALL) âœ… 3. æ­£åˆ™å¸¸ç”¨ flags æœ€ä½³å®è·µï¼ˆé¡¹ç›®çº§ï¼‰ Flag å«ä¹‰ ä½¿ç”¨åœºæ™¯ re.I å¿½ç•¥å¤§å°å†™ loginã€email re.M å¤šè¡Œ æ‰¹é‡è§£ææ—¥å¿— re.S dot åŒ¹é…æ¢è¡Œï¼ˆ.-\u0026gt;åŒ¹é…ä»»æ„å­—ç¬¦ï¼‰ æŠ“å– HTML å— re.X å…è®¸ç©ºç™½æ³¨é‡Š é•¿ regex å¢å¼ºå¯è¯»æ€§ re.A ASCII æ¨¡å¼ æ€§èƒ½ä¼˜åŒ– re.U Unicode æ¨¡å¼ å¤„ç†ä¸­æ–‡/emoji âœ… 4. æ­£åˆ™æœ€ä½³å®è·µï¼ˆé¡¹ç›®è§„èŒƒï¼‰ 4.1 è§„åˆ™ 1ï¼šæ‰€æœ‰æ­£åˆ™éƒ½å¿…é¡»æ˜¯åŸå§‹å­—ç¬¦ä¸² râ€â€ âŒ é”™è¯¯\n\u0026#34;\\d+\u0026#34; ```py âœ… æ­£ç¡® ```py r\u0026#34;\\d+\u0026#34; 4.2 è§„åˆ™ 2ï¼šå¾ªç¯ä¸­ç»å¯¹ä¸è¦å†™ re.search / re.sub âŒ é”™è¯¯\nfor item in items: if re.search(r\u0026#34;\\d+\u0026#34;, item): ... âœ… æ­£ç¡®\nPAT_NUM = re.compile(r\u0026#34;\\d+\u0026#34;) for item in items: if PAT_NUM.search(item): ... 4.3 è§„åˆ™ 3ï¼šç®€å•ä»»åŠ¡ä¸è¦ç”¨ regexï¼ˆä¼˜å…ˆç”¨ str æ–¹æ³•ï¼‰ æ¯”å¦‚ï¼š\næ›¿æ¢å›ºå®šå†…å®¹\ns.replace(\u0026#34;abc\u0026#34;, \u0026#34;def\u0026#34;) åˆ†å‰²å›ºå®šå­—ç¬¦\ns.split(\u0026#34;,\u0026#34;) åªæœ‰å½“ï¼š\nåŠ¨æ€åŒ¹é… ç”¨åˆ°é€»è¾‘ OR å¼‚ç±»å­—ç¬¦å¤„ç† æå–ç»“æ„åŒ–æ–‡æœ¬ æ‰ä½¿ç”¨ regexã€‚\n4.4 è§„åˆ™ 4ï¼šå¤æ‚ regex å¿…é¡»åˆ†è¡Œ + æ³¨é‡Šï¼ˆre.Xï¼‰ ç¤ºä¾‹ï¼šåŒ¹é… YYYY-MM-DD\nPAT_DATE = re.compile( r\u0026#34;\u0026#34;\u0026#34; ^ # è¡Œå¼€å§‹ (\\d{4}) # å¹´ - # åˆ†éš”ç¬¦ (0[1-9]|1[0-2]) # æœˆ - # åˆ†éš”ç¬¦ (0[1-9]|[12]\\d|3[01]) # æ—¥ $ \u0026#34;\u0026#34;\u0026#34;, re.X ) âœ… 5. å¸¸è§æ­£åˆ™æ¨¡å¼ï¼ˆé¡¹ç›®å¸¸ç”¨ï¼‰ 5.1 æå– URL å‚æ•° PAT_KV = re.compile(r\u0026#34;[?\u0026amp;](\\w+)=([^\u0026amp;]+)\u0026#34;) 5.2 è‚¡ç¥¨ä»£ç ï¼š00 æˆ– 60 å¼€å¤´ PAT_STOCK = re.compile(r\u0026#34;^(00|60)\\d{4}$\u0026#34;) 5.3 ç§»é™¤ HTML æ ‡ç­¾ PAT_TAG = re.compile(r\u0026#34;\u0026lt;[^\u0026gt;]+\u0026gt;\u0026#34;) 5.4 ä¸­æ–‡æ—¥æœŸ â€œ2025å¹´12æœˆ04æ—¥â€ PAT_DATE_CN = re.compile(r\u0026#34;(\\d{4})å¹´(\\d{1,2})æœˆ(\\d{1,2})æ—¥\u0026#34;) âœ… 6. æ­£åˆ™å¤„ç†çš„å·¥å…·å‡½æ•°ï¼ˆæ¨èæ”¾ utils/regex.pyï¼‰ import re from typing import Iterable def compile_pattern(pattern: str, flags=0) -\u0026gt; re.Pattern: \u0026#34;\u0026#34;\u0026#34;ç»Ÿä¸€çš„æ­£åˆ™ç¼–è¯‘å°è£…\u0026#34;\u0026#34;\u0026#34; return re.compile(pattern, flags) def regex_search(pattern: re.Pattern, text: str) -\u0026gt; str | None: \u0026#34;\u0026#34;\u0026#34;è¿”å›æ•è·ç»„ 1 çš„å†…å®¹\u0026#34;\u0026#34;\u0026#34; m = pattern.search(text) return m.group(1) if m else None def regex_split(pattern: re.Pattern, text: str) -\u0026gt; list[str]: \u0026#34;\u0026#34;\u0026#34;æ­£åˆ™åˆ†å‰²å°è£…\u0026#34;\u0026#34;\u0026#34; return pattern.split(text) def regex_findall(pattern: re.Pattern, text: str) -\u0026gt; list[str]: \u0026#34;\u0026#34;\u0026#34;æ‰¹é‡æŸ¥æ‰¾åŒ¹é…\u0026#34;\u0026#34;\u0026#34; return pattern.findall(text) def regex_sub(pattern: re.Pattern, repl: str, text: str) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;æ›¿æ¢\u0026#34;\u0026#34;\u0026#34; return pattern.sub(repl, text) âœ… 7. å®æˆ˜ï¼šé¡¹ç›®ä¸­å¸¸ç”¨çš„æ­£åˆ™ç¼–è¯‘æ–¹å¼ 7.1 ç¤ºä¾‹ï¼šè¿‡æ»¤æ— æ•ˆæ ‡é¢˜ï¼ˆä½ é¡¹ç›®ä¸­ä½¿ç”¨ï¼‰ TITLE_EXCLUDE = re.compile( r\u0026#34;æ¿å—å±€éƒ¨å¼‚åŠ¨|æŒç»­æ´»è·ƒ|æŒç»­ä¸‹æŒ«|æŒç»­èµ°å¼º|è§¦å‘äºŒæ¬¡ä¸´åœ|æ¦‚å¿µè‚¡è¡¨ç°æ´»è·ƒ\u0026#34;, ) 7.2 ä¸­æ–‡æ—¥æœŸè½¬æ¢ DATE_CN = re.compile(r\u0026#34;(\\d{4})å¹´(\\d{2})æœˆ(\\d{2})æ—¥\u0026#34;) ä½¿ç”¨ï¼š\nDATE_CN.sub(r\u0026#34;\\1-\\2-\\3\u0026#34;, s) âœ… 8. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ 8.1 compile åªåšä¸€æ¬¡ æ¨¡å—çº§åˆ«å®šä¹‰ï¼š\nPAT_CODE = re.compile(r\u0026#34;^\\d+$\u0026#34;) 8.2 å¤§é‡æ–‡æœ¬å¤„ç†ä½¿ç”¨ finditer ï¼ˆæ¯” findall æ›´çœå†…å­˜ï¼‰ for m in PAT_CODE.finditer(text): ... 8.3 é¿å…å¤æ‚å›æº¯ï¼ˆä½¿ç”¨ +? å’Œ .*?ï¼‰ âŒ å›æº¯éå¸¸æ…¢\n.*\u0026lt;/div\u0026gt; âœ… é™åˆ¶èŒƒå›´\n[^\u0026lt;]+ re.compile ç¼–è¯‘ list ä½ å¯èƒ½æƒ³åšçš„æ˜¯ï¼š\næŠŠä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼ˆå¤šä¸ªæ­£åˆ™æ¨¡å¼ï¼‰ä¸€æ¬¡æ€§ç¼–è¯‘æˆæ­£åˆ™å¯¹è±¡ï¼Œå¹¶ç»Ÿä¸€åŒ¹é…ã€‚\nPython çš„ re.compile() åªèƒ½æ¥å— å•ä¸ªå­—ç¬¦ä¸²ï¼Œä¸èƒ½ç›´æ¥å¯¹ list ç¼–è¯‘ã€‚\nä½†æœ‰ä¸¤ç§æœ€ä½³å®è·µæ–¹å¼ï¼š\næŠŠå¤šä¸ªæ¨¡å¼åˆæˆä¸€ä¸ªæ­£åˆ™å† compileï¼ˆæ¨èï¼‰ å¯¹æ¯ä¸ªæ¨¡å¼åˆ†åˆ« compile æˆå¤šä¸ªæ­£åˆ™å¯¹è±¡ ä¸‹é¢åˆ†åˆ«è®²è¿°æœ€ä½³å®è·µã€‚\næ–¹æ³• 1ï¼šæŠŠå¤šä¸ªæ¨¡å¼åˆå¹¶æˆä¸€ä¸ªå¤§æ­£åˆ™ï¼ˆæ¨èï¼‰ é€‚ç”¨äºï¼š\nå¤šä¸ªå…³é”®è¯ä»»æ„ä¸€ä¸ªåŒ¹é…å³å¯ å¤§é‡é‡å¤åŒ¹é… æ€§èƒ½éœ€æ±‚é«˜ é¡¹ç›®ä¸­å¸¸ç”¨äºè¿‡æ»¤æ ‡é¢˜ã€å…³é”®è¯è§¦å‘ã€é»‘åå•åŒ¹é… æ¯”å¦‚ï¼š\npatterns = [ \u0026#34;æŒç»­æ´»è·ƒ\u0026#34;, \u0026#34;æŒç»­ä¸‹æŒ«\u0026#34;, \u0026#34;åå¤èµ°å¼º\u0026#34;, ] ğŸ”¥ ä¸€æ¬¡æ€§ç¼–è¯‘ï¼š\nimport re def compile_pattern_list(patterns: list[str]) -\u0026gt; re.Pattern: combined = \u0026#34;|\u0026#34;.join(map(re.escape, patterns)) return re.compile(combined) ä½¿ç”¨ï¼š\nTITLE_EXCLUDE = compile_pattern_list(patterns) if TITLE_EXCLUDE.search(title): print(\u0026#34;å‘½ä¸­æ’é™¤é¡¹\u0026#34;) ğŸ”¥ ä¼˜ç‚¹\nä»…ç¼–è¯‘ä¸€æ¬¡ -\u0026gt; æ€§èƒ½é«˜ æ­£åˆ™å¯¹è±¡å¯å¤ç”¨ ä½¿ç”¨ç®€å• (pattern.search()) æ”¯æŒå¤§é‡æ¨¡å¼ï¼ˆå‡ åã€å‡ ç™¾éƒ½æ²¡é—®é¢˜ï¼‰ é˜²æ­¢ç‰¹æ®Šå­—ç¬¦å†²çªï¼ˆå› ä¸ºä½¿ç”¨äº† re.escapeï¼‰ âš ï¸ æ³¨æ„\nå¦‚æœè¦å†™å¤æ‚æ¨¡å¼ï¼Œä¸éœ€è¦ escapeï¼Œå¯ä»¥æ”¹æˆï¼š\ncombined = \u0026#34;|\u0026#34;.join(patterns) æ–¹æ³• 2ï¼šä¸ºæ¯ä¸ª pattern åˆ†åˆ« compileï¼ˆä¿ç•™æ¨¡å¼ç‹¬ç«‹æ€§ï¼‰ é€‚ç”¨äºï¼š\næ¯ä¸ªæ¨¡å¼å¤„ç†é€»è¾‘ä¸ä¸€æ · æ¨¡å¼ä¹‹é—´ä¸èƒ½åˆå¹¶ éœ€è¦çŸ¥é“å‘½ä¸­çš„æ˜¯å“ªä¸ª pattern import re patterns = [ r\u0026#34;^00\\d+\u0026#34;, r\u0026#34;^60\\d+\u0026#34;, r\u0026#34;ST\u0026#34;, ] compiled_list = [re.compile(p) for p in patterns] for pat in compiled_list: if pat.search(text): print(\u0026#34;å‘½ä¸­:\u0026#34;, pat.pattern) â± æ€§èƒ½å¯¹æ¯”ï¼ˆé‡è¦ï¼‰\næ¨¡å¼æ•°é‡ åˆå¹¶ç¼–è¯‘ åˆ†åˆ«ç¼–è¯‘ 3 ä¸ª å·®ä¸å¤š å·®ä¸å¤š 20 ä¸ª å¿« è¾ƒæ…¢ 100 ä¸ª æ˜æ˜¾æ›´å¿«ï¼ˆ1 æ¬¡ regex engineï¼‰ 100 æ¬¡åŒ¹é…å¾ªç¯ 500 ä¸ª ä»å¾ˆå¿« æ€§èƒ½æ˜æ˜¾ä¸‹é™ å¦‚æœä½ çš„é¡¹ç›®é‡Œï¼š\nå¤§é‡æ–‡æœ¬éœ€è¦è¿‡æ»¤ æ¨¡å¼æ•°é‡å¤šï¼ˆ\u0026gt;20ï¼‰ é«˜é¢‘è°ƒç”¨ï¼ˆå¾ªç¯ã€å¼‚æ­¥ã€çˆ¬è™«ï¼‰ ğŸ‘‰ æ¨èä½¿ç”¨åˆå¹¶ç¼–è¯‘ï¼ˆæ–¹æ³• 1ï¼‰\næ–¹æ³• 3ï¼šç¼“å­˜ compiled listï¼ˆé¡¹ç›®çº§æœ€ä½³å®è·µï¼‰ æ”¾åœ¨ utils/regex.py ä¸­ï¼š\nimport re from functools import lru_cache @lru_cache(maxsize=None) def compile_patterns(patterns: tuple[str, ...]) -\u0026gt; re.Pattern: \u0026#34;\u0026#34;\u0026#34;æŠŠ list ç¼–è¯‘ä¸ºä¸€ä¸ªè¶…å¤§æ­£åˆ™ï¼ˆå¸¦ç¼“å­˜ï¼‰\u0026#34;\u0026#34;\u0026#34; combined = \u0026#34;|\u0026#34;.join(map(re.escape, patterns)) return re.compile(combined) ä½¿ç”¨ï¼š\npatterns = (\u0026#34;æŒç»­æ´»è·ƒ\u0026#34;, \u0026#34;è·ŒåŠ¿æ‰©å¤§\u0026#34;, \u0026#34;å¼€ç›˜èµ°å¼º\u0026#34;) TITLE_EXCLUDE = compile_patterns(patterns) if TITLE_EXCLUDE.search(title): ... ä¼˜ç‚¹ï¼š\nlist å˜æˆ tuple -\u0026gt; å¯ç¼“å­˜ å¤šæ¬¡è°ƒç”¨ä¸ä¼šé‡å¤ç¼–è¯‘ é¡¹ç›®çº§æ€§èƒ½æå‡æ˜¾è‘— ğŸ¯ é¡¹ç›®å®æˆ˜ç¤ºä¾‹ï¼ˆç»“åˆä½ ä¹‹å‰çš„ title_exclude_listï¼‰ ä½ çš„åŸä»£ç ï¼š\ntitle_exclude_list = [...å¾ˆå¤šå…³é”®è¯...] title_exclude_string = \u0026#34;|\u0026#34;.join(title_exclude_list) title_exclude = re.compile(title_exclude_string) æœ€ä½³ä¼˜åŒ–ï¼š\nfrom utils.regex import compile_patterns TITLE_EXCLUDE = compile_patterns(tuple(title_exclude_list)) if TITLE_EXCLUDE.search(title): return False è‡ªåŠ¨ escape æ€§èƒ½æ›´å¥½ ä»£ç æ›´ä¼˜é›… patterns å¯ç¼“å­˜ re.compile ç¼–è¯‘ list ä½ å¯èƒ½æƒ³åšçš„æ˜¯ï¼š\næŠŠä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼ˆå¤šä¸ªæ­£åˆ™æ¨¡å¼ï¼‰ä¸€æ¬¡æ€§ç¼–è¯‘æˆæ­£åˆ™å¯¹è±¡ï¼Œå¹¶ç»Ÿä¸€åŒ¹é…ã€‚\nPython çš„ re.compile() åªèƒ½æ¥å— å•ä¸ªå­—ç¬¦ä¸²ï¼Œä¸èƒ½ç›´æ¥å¯¹ list ç¼–è¯‘ã€‚\nä½†æœ‰ä¸¤ç§æœ€ä½³å®è·µæ–¹å¼ï¼š\næŠŠå¤šä¸ªæ¨¡å¼åˆæˆä¸€ä¸ªæ­£åˆ™å† compileï¼ˆæ¨èï¼‰ å¯¹æ¯ä¸ªæ¨¡å¼åˆ†åˆ« compile æˆå¤šä¸ªæ­£åˆ™å¯¹è±¡ ä¸‹é¢åˆ†åˆ«è®²è¿°æœ€ä½³å®è·µã€‚\nâœ… æ–¹æ³• 1ï¼šæŠŠå¤šä¸ªæ¨¡å¼åˆå¹¶æˆä¸€ä¸ªå¤§æ­£åˆ™ï¼ˆæ¨èï¼‰ é€‚ç”¨äºï¼š\nå¤šä¸ªå…³é”®è¯ä»»æ„ä¸€ä¸ªåŒ¹é…å³å¯ å¤§é‡é‡å¤åŒ¹é… æ€§èƒ½éœ€æ±‚é«˜ é¡¹ç›®ä¸­å¸¸ç”¨äºè¿‡æ»¤æ ‡é¢˜ã€å…³é”®è¯è§¦å‘ã€é»‘åå•åŒ¹é… æ¯”å¦‚ï¼š\npatterns = [ \u0026#34;æŒç»­æ´»è·ƒ\u0026#34;, \u0026#34;æŒç»­ä¸‹æŒ«\u0026#34;, \u0026#34;åå¤èµ°å¼º\u0026#34;, ] ğŸ”¥ ä¸€æ¬¡æ€§ç¼–è¯‘ï¼š\nimport re def compile_pattern_list(patterns: list[str]) -\u0026gt; re.Pattern: combined = \u0026#34;|\u0026#34;.join(map(re.escape, patterns)) return re.compile(combined) ä½¿ç”¨ï¼š\nTITLE_EXCLUDE = compile_pattern_list(patterns) if TITLE_EXCLUDE.search(title): print(\u0026#34;å‘½ä¸­æ’é™¤é¡¹\u0026#34;) ğŸ”¥ ä¼˜ç‚¹ ä»…ç¼–è¯‘ä¸€æ¬¡ -\u0026gt; æ€§èƒ½é«˜ æ­£åˆ™å¯¹è±¡å¯å¤ç”¨ ä½¿ç”¨ç®€å• (pattern.search()) æ”¯æŒå¤§é‡æ¨¡å¼ï¼ˆå‡ åã€å‡ ç™¾éƒ½æ²¡é—®é¢˜ï¼‰ é˜²æ­¢ç‰¹æ®Šå­—ç¬¦å†²çªï¼ˆå› ä¸ºä½¿ç”¨äº† re.escapeï¼‰ âš ï¸ æ³¨æ„ å¦‚æœè¦å†™å¤æ‚æ¨¡å¼ï¼Œä¸éœ€è¦ escapeï¼Œå¯ä»¥æ”¹æˆï¼š\ncombined = \u0026#34;|\u0026#34;.join(patterns) âœ… æ–¹æ³• 2ï¼šä¸ºæ¯ä¸ª pattern åˆ†åˆ« compileï¼ˆä¿ç•™æ¨¡å¼ç‹¬ç«‹æ€§ï¼‰ é€‚ç”¨äºï¼š\næ¯ä¸ªæ¨¡å¼å¤„ç†é€»è¾‘ä¸ä¸€æ · æ¨¡å¼ä¹‹é—´ä¸èƒ½åˆå¹¶ éœ€è¦çŸ¥é“å‘½ä¸­çš„æ˜¯å“ªä¸ª pattern import re patterns = [ r\u0026#34;^00\\d+\u0026#34;, r\u0026#34;^60\\d+\u0026#34;, r\u0026#34;ST\u0026#34;, ] compiled_list = [re.compile(p) for p in patterns] for pat in compiled_list: if pat.search(text): print(\u0026#34;å‘½ä¸­:\u0026#34;, pat.pattern) â± æ€§èƒ½å¯¹æ¯”ï¼ˆé‡è¦ï¼‰ æ¨¡å¼æ•°é‡ åˆå¹¶ç¼–è¯‘ åˆ†åˆ«ç¼–è¯‘ 3 ä¸ª å·®ä¸å¤š å·®ä¸å¤š 20 ä¸ª å¿« è¾ƒæ…¢ 100 ä¸ª æ˜æ˜¾æ›´å¿«ï¼ˆ1 æ¬¡ regex engineï¼‰ 100 æ¬¡åŒ¹é…å¾ªç¯ 500 ä¸ª ä»å¾ˆå¿« æ€§èƒ½æ˜æ˜¾ä¸‹é™ å¦‚æœä½ çš„é¡¹ç›®é‡Œï¼š\nå¤§é‡æ–‡æœ¬éœ€è¦è¿‡æ»¤ æ¨¡å¼æ•°é‡å¤šï¼ˆ\u0026gt;20ï¼‰ é«˜é¢‘è°ƒç”¨ï¼ˆå¾ªç¯ã€å¼‚æ­¥ã€çˆ¬è™«ï¼‰ ğŸ‘‰ æ¨èä½¿ç”¨åˆå¹¶ç¼–è¯‘ï¼ˆæ–¹æ³• 1ï¼‰\nâœ… æ–¹æ³• 3ï¼šç¼“å­˜ compiled listï¼ˆé¡¹ç›®çº§æœ€ä½³å®è·µï¼‰ æ”¾åœ¨ utils/regex.py ä¸­ï¼š\nimport re from functools import lru_cache @lru_cache(maxsize=None) def compile_patterns(patterns: tuple[str, ...]) -\u0026gt; re.Pattern: \u0026#34;\u0026#34;\u0026#34;æŠŠ list ç¼–è¯‘ä¸ºä¸€ä¸ªè¶…å¤§æ­£åˆ™ï¼ˆå¸¦ç¼“å­˜ï¼‰\u0026#34;\u0026#34;\u0026#34; combined = \u0026#34;|\u0026#34;.join(map(re.escape, patterns)) return re.compile(combined) ä½¿ç”¨ï¼š\npatterns = (\u0026#34;æŒç»­æ´»è·ƒ\u0026#34;, \u0026#34;è·ŒåŠ¿æ‰©å¤§\u0026#34;, \u0026#34;å¼€ç›˜èµ°å¼º\u0026#34;) TITLE_EXCLUDE = compile_patterns(patterns) if TITLE_EXCLUDE.search(title): ... ä¼˜ç‚¹ï¼š\nlist å˜æˆ tuple -\u0026gt; å¯ç¼“å­˜ å¤šæ¬¡è°ƒç”¨ä¸ä¼šé‡å¤ç¼–è¯‘ é¡¹ç›®çº§æ€§èƒ½æå‡æ˜¾è‘— ğŸ¯ é¡¹ç›®å®æˆ˜ç¤ºä¾‹ï¼ˆç»“åˆä½ ä¹‹å‰çš„ title_exclude_listï¼‰ ä½ çš„åŸä»£ç ï¼š\ntitle_exclude_list = [...å¾ˆå¤šå…³é”®è¯...] title_exclude_string = \u0026#34;|\u0026#34;.join(title_exclude_list) title_exclude = re.compile(title_exclude_string) æœ€ä½³ä¼˜åŒ–ï¼š\nfrom utils.regex import compile_patterns TITLE_EXCLUDE = compile_patterns(tuple(title_exclude_list)) if TITLE_EXCLUDE.search(title): return False è‡ªåŠ¨ escape æ€§èƒ½æ›´å¥½ ä»£ç æ›´ä¼˜é›… patterns å¯ç¼“å­˜ ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ é¡¹ç›®çº§çš„ã€ŠPython æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘ä¸æœ€ä½³å®è·µã€‹ï¼Œæ¶µç›–ï¼š\næ­£åˆ™ç¼–è¯‘æœ€ä½³æ–¹å¼ æ€§èƒ½ä¼˜åŒ– é¡¹ç›®ä¸­æ¨èçš„ä½¿ç”¨æ¨¡å¼ å¸¸è§é”™è¯¯é¿å… æä¾›å®Œæ•´å¯ç”¨çš„ utils.regex å·¥å…·æ¨¡å— å…¨éƒ¨å…¼å®¹ Python 3.12 / BasedPyrightï¼Œå¯ç›´æ¥åŠ å…¥ä½ çš„é¡¹ç›®ã€‚\nâœ… 1. ä¸ºä»€ä¹ˆè¦â€œç¼–è¯‘â€æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ Python çš„æ­£åˆ™æ¨¡å— re å·¥ä½œæ–¹å¼ï¼š\nå†™æ³• æ˜¯å¦æ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘æ­£åˆ™ï¼Ÿ æ€§èƒ½ re.search(pattern, text) âœ… æ˜¯ âŒ è¾ƒæ…¢ compiled = re.compile(pattern); compiled.search(text) âŒ å¦ï¼ˆå¤ç”¨ï¼‰ âœ… å¿« åœ¨ å¾ªç¯ / é«˜é¢‘è°ƒç”¨ / å¤§è§„æ¨¡æ•°æ®å¤„ç† / HTTPè¯·æ±‚çˆ¬è™« / å®šæ—¶ä»»åŠ¡ ä¸­ï¼Œæ¨èï¼š\næ­£åˆ™æå‰ç¼–è¯‘ é‡å¤å¤ç”¨ ä¸è¦åœ¨å¾ªç¯ä¸­å†™ re.search(pattern, text) âœ… 2. æ­£åˆ™ç¼–è¯‘æœ€ä½³å®è·µå†™æ³• å•ä¸ªæ¨¡å¼ PAT_STOCK_CODE = re.compile(r\u0026#34;^(00|60)\\d+\u0026#34;) åˆ†ç»„æ•è· PAT_EQUAL = re.compile(r\u0026#34;=(.+)$\u0026#34;) æ”¯æŒä¸­æ–‡çš„ä¸¥æ ¼æ¨¡å¼ PAT_DATE_CN = re.compile(r\u0026#34;(\\d{4})å¹´(\\d{2})æœˆ(\\d{2})æ—¥\u0026#34;) å¸¦ flags PAT_MULTI = re.compile(r\u0026#34;foo.*bar\u0026#34;, re.DOTALL) âœ… 3. æ­£åˆ™å¸¸ç”¨ flags æœ€ä½³å®è·µï¼ˆé¡¹ç›®çº§ï¼‰ Flag å«ä¹‰ ä½¿ç”¨åœºæ™¯ re.I å¿½ç•¥å¤§å°å†™ loginã€email re.M å¤šè¡Œ æ‰¹é‡è§£ææ—¥å¿— re.S dot åŒ¹é…æ¢è¡Œï¼ˆ.-\u0026gt;åŒ¹é…ä»»æ„å­—ç¬¦ï¼‰ æŠ“å– HTML å— re.X å…è®¸ç©ºç™½æ³¨é‡Š é•¿ regex å¢å¼ºå¯è¯»æ€§ re.A ASCII æ¨¡å¼ æ€§èƒ½ä¼˜åŒ– re.U Unicode æ¨¡å¼ å¤„ç†ä¸­æ–‡/emoji âœ… 4. æ­£åˆ™æœ€ä½³å®è·µï¼ˆé¡¹ç›®è§„èŒƒï¼‰ 4.1 è§„åˆ™ 1ï¼šæ‰€æœ‰æ­£åˆ™éƒ½å¿…é¡»æ˜¯åŸå§‹å­—ç¬¦ä¸² râ€â€ âŒ é”™è¯¯\n"},{"id":419,"href":"/backend/python/requests/","title":"Requests","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£: https://requests.readthedocs.io/en/latest/\nDirectory List:\nRequests åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ ","description":"å®˜æ–¹æ–‡æ¡£: https://requests.readthedocs.io/en/latest/\nDirectory List:\nRequests åŸºç¡€æ•™ç¨‹ æœ€ä½³å®è·µ "},{"id":420,"href":"/backend/python/sqlalchemy/result/","title":"Result","parent":"SQLAlchemy","content":"å®˜æ–¹æ–‡æ¡£: https://docs.sqlalchemy.org.cn/en/20/core/connections.html#sqlalchemy.engine.Result\nä¸‹é¢ç»™ä½ ä¸€ç‰ˆ æœ€å…¨ã€æœ€ç³»ç»Ÿã€SQLAlchemy 2.0 Result / ScalarResult / Row / RowMapping çš„æ–¹æ³•è¯¦è§£\nè¦†ç›–åŒæ­¥/å¼‚æ­¥é€šç”¨ APIï¼ŒåŒ…å«å¸¸ç”¨ã€å°‘ç”¨ã€åº•å±‚ç»†èŠ‚ä¸æ€§èƒ½ç‰¹æ€§ï¼Œé€‚åˆä½ ç°åœ¨å¤§é‡ä½¿ç”¨ SQLAlchemy ORM + Core çš„åœºæ™¯ã€‚\nâš ï¸ SQLAlchemy 2.0 çš„ç»“æœç³»ç»Ÿä¸ 1.4 å®Œå…¨é‡å†™ï¼š\nä¸å†è¿”å› ResultProxy ç»“æœç”± Result / ScalarResult / ChunkedIteratorResult ç»„æˆ è¡Œç±»å‹ä¸º Rowï¼Œç´¢å¼•ç»“æ„åœ¨ Row._mapping ä¸­ ğŸš€ ä¸€ã€SQLAlchemy Result çš„ç±»å‹ä½“ç³» SQLAlchemy 2.0 ä¸­ï¼Œæœ‰ 3 ç§ä¸»è¦ç»“æœç±»å‹ï¼š\nç±»å‹ å‡ºç°åœºæ™¯ è¯´æ˜ Result æ‰§è¡Œ session.execute(selectâ€¦) è¡Œä¸ºå¯¹è±¡ç»“æœï¼ŒåŒ…å« Row ScalarResult æ‰§è¡Œ session.scalars(selectâ€¦) æˆ– result.scalars() å•å€¼ç»“æœï¼ˆå•ä¸ªæˆ–å•åˆ—ï¼‰ï¼Œå¦‚ count()ã€select(User.id) CursorResult æ‰§è¡Œ Core åŸç”Ÿ SQL (connection.execute(text)) ç›´æ¥æ¸¸æ ‡ç»“æœ å¹¶ä¸” Result å†…éƒ¨è¡Œå¯¹è±¡æ˜¯ï¼š\nç±»å‹ æè¿° Row ç±»ä¼¼ tupleï¼Œå¯é€šè¿‡ indexã€attrã€key è®¿é—® RowMapping row._mappingï¼ŒçœŸæ­£çš„ dict-like ç»“æ„ â˜˜ï¸ äºŒã€Result æ–¹æ³•å¤§å…¨ âš ï¸ æ³¨æ„ï¼šResult å’Œ ScalarResult åªèƒ½è°ƒç”¨ä¸€æ¬¡å„è‡ªçš„æ–¹æ³•ï¼Œç„¶åå°±ä¼šè¢«å…³é—­ã€‚è¦è°ƒç”¨å…¶å®ƒæ–¹æ³•ï¼Œéœ€è¦å†æ¬¡æ‰§è¡ŒSQLã€‚\næ–¹æ³•åˆ—è¡¨ï¼š\ndir(sqlalchemy.Result) # [\u0026#39;__annotations__\u0026#39;, \u0026#39;__class__\u0026#39;, \u0026#39;__class_getitem__\u0026#39;, \u0026#39;__delattr__\u0026#39;, \u0026#39;__dict__\u0026#39;, \u0026#39;__dir__\u0026#39;, \u0026#39;__doc__\u0026#39;, \u0026#39;__enter__\u0026#39;, \u0026#39;__eq__\u0026#39;, \u0026#39;__exit__\u0026#39;, \u0026#39;__format__\u0026#39;, \u0026#39;__ge__\u0026#39;, \u0026#39;__getattribute__\u0026#39;, \u0026#39;__getstate__\u0026#39;, \u0026#39;__gt__\u0026#39;, \u0026#39;__hash__\u0026#39;, \u0026#39;__init__\u0026#39;, \u0026#39;__init_subclass__\u0026#39;, \u0026#39;__iter__\u0026#39;, \u0026#39;__le__\u0026#39;, \u0026#39;__lt__\u0026#39;, \u0026#39;__module__\u0026#39;, \u0026#39;__ne__\u0026#39;, \u0026#39;__new__\u0026#39;, \u0026#39;__next__\u0026#39;, \u0026#39;__orig_bases__\u0026#39;, \u0026#39;__parameters__\u0026#39;, \u0026#39;__reduce__\u0026#39;, \u0026#39;__reduce_ex__\u0026#39;, \u0026#39;__repr__\u0026#39;, \u0026#39;__setattr__\u0026#39;, \u0026#39;__sizeof__\u0026#39;, \u0026#39;__slots__\u0026#39;, \u0026#39;__str__\u0026#39;, \u0026#39;__subclasshook__\u0026#39;, \u0026#39;_allrows\u0026#39;, \u0026#39;_assert_no_memoizations\u0026#39;, \u0026#39;_attributes\u0026#39;, \u0026#39;_column_slices\u0026#39;, \u0026#39;_fetchall_impl\u0026#39;, \u0026#39;_fetchiter_impl\u0026#39;, \u0026#39;_fetchmany_impl\u0026#39;, \u0026#39;_fetchone_impl\u0026#39;, \u0026#39;_generate\u0026#39;, \u0026#39;_generate_rows\u0026#39;, \u0026#39;_getter\u0026#39;, \u0026#39;_is_cursor\u0026#39;, \u0026#39;_iter_impl\u0026#39;, \u0026#39;_iterator_getter\u0026#39;, \u0026#39;_manyrow_getter\u0026#39;, \u0026#39;_memoized_keys\u0026#39;, \u0026#39;_metadata\u0026#39;, \u0026#39;_next_impl\u0026#39;, \u0026#39;_onerow_getter\u0026#39;, \u0026#39;_only_one_row\u0026#39;, \u0026#39;_post_creational_filter\u0026#39;, \u0026#39;_raw_all_rows\u0026#39;, \u0026#39;_raw_row_iterator\u0026#39;, \u0026#39;_real_result\u0026#39;, \u0026#39;_reset_memoizations\u0026#39;, \u0026#39;_row_getter\u0026#39;, \u0026#39;_row_logging_fn\u0026#39;, \u0026#39;_set_memoized_attribute\u0026#39;, \u0026#39;_soft_close\u0026#39;, \u0026#39;_soft_closed\u0026#39;, \u0026#39;_source_supports_scalars\u0026#39;, \u0026#39;_tuple_getter\u0026#39;, \u0026#39;_unique_filter_state\u0026#39;, \u0026#39;_unique_strategy\u0026#39;, \u0026#39;_yield_per\u0026#39;, \u0026#39;all\u0026#39;, \u0026#39;close\u0026#39;, \u0026#39;closed\u0026#39;, \u0026#39;columns\u0026#39;, \u0026#39;fetchall\u0026#39;, \u0026#39;fetchmany\u0026#39;, \u0026#39;fetchone\u0026#39;, \u0026#39;first\u0026#39;, \u0026#39;freeze\u0026#39;, \u0026#39;keys\u0026#39;, \u0026#39;mappings\u0026#39;, \u0026#39;memoized_attribute\u0026#39;, \u0026#39;memoized_instancemethod\u0026#39;, \u0026#39;merge\u0026#39;, \u0026#39;one\u0026#39;, \u0026#39;one_or_none\u0026#39;, \u0026#39;partitions\u0026#39;, \u0026#39;scalar\u0026#39;, \u0026#39;scalar_one\u0026#39;, \u0026#39;scalar_one_or_none\u0026#39;, \u0026#39;scalars\u0026#39;, \u0026#39;t\u0026#39;, \u0026#39;tuples\u0026#39;, \u0026#39;unique\u0026#39;, \u0026#39;yield_per\u0026#39;] æ–¹æ³•è¯´æ˜ï¼š\næ–¹æ³• è¯´æ˜ å¤‡æ³¨ all ä»¥åºåˆ—å½¢å¼è¿”å›æ‰€æœ‰è¡Œ å¸¸ç”¨ (å°†ç»“æœè½¬æ¢ä¸º list ç±»å‹çš„æ•°æ®) close å…³é—­æ­¤ Result closed å¦‚æœæ­¤ Result æŠ¥å‘Š .closedï¼Œåˆ™è¿”å› True columns å»ºç«‹æ¯è¡Œåº”è¿”å›çš„åˆ— fetchall all æ–¹æ³•çš„åŒä¹‰è¯ fetchmany æå–å¤šè¡Œ fetchone æå–ä¸€è¡Œ first æå–ç¬¬ä¸€è¡Œï¼Œå¦‚æœæ²¡æœ‰è¡Œåˆ™è¿”å› None freeze è¿”å›ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ keys è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰å­—æ®µåçš„åºåˆ— mappings è¿”å›ä¸€ä¸ª MappingResult å¸¸ç”¨ (å°†ç»“æœè½¬æ¢ä¸º list[dict] ç±»å‹çš„æ•°æ®) memoized_attribute memoized_instancemethod merge å°†æ­¤ Result ä¸å…¶ä»–å…¼å®¹çš„ç»“æœå¯¹è±¡åˆå¹¶ one è¿”å›æ°å¥½ä¸€è¡Œï¼Œå¦åˆ™å¼•å‘å¼‚å¸¸ (å¿…é¡»è¿”å› 1 è¡Œ) one_or_none æœ€å¤šè¿”å›ä¸€ä¸ªç»“æœï¼Œå¦åˆ™å¼•å‘å¼‚å¸¸ (0 æˆ– 1 è¡Œ) partitions è¿­ä»£å¤„ç†ç»™å®šå¤§å°çš„è¡Œå­åˆ—è¡¨ scalar è·å–ç¬¬ä¸€è¡Œçš„ç¬¬ä¸€åˆ— scalar_one è¿”å›æ°å¥½ä¸€ä¸ªæ ‡é‡ç»“æœï¼Œå¦åˆ™å¼•å‘å¼‚å¸¸ scalar_one_or_none è¿”å›æ°å¥½ä¸€ä¸ªæ ‡é‡ç»“æœï¼Œæˆ–è€… None scalars è¿”å›ä¸€ä¸ª ScalarResult t tuples æ–¹æ³•çš„åŒä¹‰è¯ tuples å°† â€œç±»å‹åŒ–å…ƒç»„â€ ç±»å‹è¿‡æ»¤å™¨åº”ç”¨äºè¿”å›çš„è¡Œ å¸¸ç”¨ (å°†ç»“æœè½¬æ¢ä¸º tuple ç±»å‹çš„æ•°æ®) unique å¯¹æ­¤ Result è¿”å›çš„å¯¹è±¡åº”ç”¨å”¯ä¸€æ€§è¿‡æ»¤ yield_per é…ç½®è¡Œæå–ç­–ç•¥ï¼Œä¸€æ¬¡æå– num è¡Œ ğŸ“’ å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡éƒ½æœ‰æ–¹æ³•ã€‚å¦‚æœè¿”å›çš„æ˜¯å¯¹è±¡ï¼Œåˆ™è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨ list æˆ– tuple è½¬æ¢æ•°æ®ï¼\nè¿”å›å¯¹è±¡çš„æ–¹æ³• è·å–æ•°æ® columns è°ƒç”¨æ–¹æ³• keys list æˆ– tuple mappings è°ƒç”¨æ–¹æ³• partitions list æˆ– tuple scalars è°ƒç”¨æ–¹æ³• tuples è°ƒç”¨æ–¹æ³• unique è°ƒç”¨æ–¹æ³• 2.1 all() è¿”å›æ‰€æœ‰è¡Œï¼ˆRow å¯¹è±¡ï¼‰åˆ—è¡¨ã€‚\nrows: list[Row] = result.all() 2.2 first() è¿”å›ç¬¬ä¸€è¡Œï¼ˆæˆ– Noneï¼‰ã€‚\nrow = result.first() 2.3 one() å¿…é¡»è¿”å›ä¸”åªèƒ½è¿”å›ä¸€è¡Œï¼Œå¦åˆ™å¼‚å¸¸ã€‚\nrow = result.one() é”™è¯¯ï¼š\nè¿”å› 0 è¡Œ -\u0026gt; NoResultFound è¿”å›å¤šè¡Œ -\u0026gt; MultipleResultsFound 2.4 one_or_none() 0 è¡Œ -\u0026gt; None 1 è¡Œ -\u0026gt; è¿”å› row = result.one_or_none() 2.5 fetchone(), fetchmany(), fetchall() ç­‰åŒäº DB-APIï¼Œæ¸¸æ ‡å¼å–æ•°ï¼Œåªå¯¹ CursorResult æœ‰æ„ä¹‰ã€‚\nrow = result.fetchone() rows = result.fetchall() ORM Result å¤šç”¨ .all() è€Œä¸æ˜¯ .fetchall()ã€‚\n2.6 scalar() è¿”å›ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—çš„æ ‡é‡å€¼ã€‚\nval = result.scalar() 2.7 scalar_one() å¿…é¡»è¿”å›ä¸”åªèƒ½è¿”å›ä¸€ä¸ªæ ‡é‡ã€‚\nval = result.scalar_one() 2.8 scalar_one_or_none() 0 è¡Œ -\u0026gt; None 1 è¡Œ -\u0026gt; æ ‡é‡ 1 è¡Œ -\u0026gt; å¼‚å¸¸\n2.9 scalars() å°† Result è½¬æ¢ä¸º ScalarResultã€‚\nå¸¸ç”¨ï¼š\nids = result.scalars().all() 2.10 mappings() è¿”å›å­—å…¸è¡Œï¼ˆRowMappingï¼‰\nresult = session.execute(select(User.id, User.username)) rows = result.mappings().all() # rows = [{\u0026#34;id\u0026#34;:1,\u0026#34;username\u0026#34;:\u0026#34;a\u0026#34;}, ...] æå®ç”¨ï¼Œé¿å… Row -\u0026gt; dict æ‰‹åŠ¨å¤„ç†ã€‚\nğŸŒŸğŸŒŸ ä¼˜é›…çš„è½¬æ¢ä¸º list[dict] ç±»å‹çš„æ•°æ® ğŸŒŸğŸŒŸ\ndicts = [dict(row) for row in result.mappings().all()] 2.11 keys() è¿”å›å­—æ®µååˆ—è¡¨ï¼š\ncols = result.keys() 2.12 partitions(size) æŒ‰å—è¿­ä»£ç»“æœï¼Œæé«˜å¤§æ•°æ®é›†æ€§èƒ½ã€‚\nfor chunk in result.partitions(1000): ... 2.13 tuples() å¼ºåˆ¶ç»“æœæ¯è¡Œè½¬ tupleã€‚\ntuples = result.tuples().all() 2.14 is_singleton / returns_rows å±æ€§ï¼š\næ˜¯å¦è¿”å›è¡Œ æ˜¯å¦åªæœ‰ä¸€ä¸ªåˆ— æ˜¯å¦å·²å…³é—­ ç¤ºä¾‹ï¼š\nresult.returns_rows # True / False result.returns_columns 2.15 rowcount å¯¹ UPDATE/DELETE æœ‰ç”¨ï¼š\naffected = result.rowcount 2.16 close() æ‰‹åŠ¨å…³é—­æ¸¸æ ‡ã€‚\nğŸ¯ ä¸‰ã€ScalarResult æ–¹æ³•ï¼ˆscalars() çš„ç»“æœï¼‰ ScalarResult æ˜¯ä¸€åˆ—çš„ç»“æœ\næ–¹æ³•åˆ—è¡¨ï¼š\ndir(sqlalchemy.ScalarResult) # [\u0026#39;__annotations__\u0026#39;, \u0026#39;__class__\u0026#39;, \u0026#39;__class_getitem__\u0026#39;, \u0026#39;__delattr__\u0026#39;, \u0026#39;__dict__\u0026#39;, \u0026#39;__dir__\u0026#39;, \u0026#39;__doc__\u0026#39;, \u0026#39;__enter__\u0026#39;, \u0026#39;__eq__\u0026#39;, \u0026#39;__exit__\u0026#39;, \u0026#39;__format__\u0026#39;, \u0026#39;__ge__\u0026#39;, \u0026#39;__getattribute__\u0026#39;, \u0026#39;__getstate__\u0026#39;, \u0026#39;__gt__\u0026#39;, \u0026#39;__hash__\u0026#39;, \u0026#39;__init__\u0026#39;, \u0026#39;__init_subclass__\u0026#39;, \u0026#39;__iter__\u0026#39;, \u0026#39;__le__\u0026#39;, \u0026#39;__lt__\u0026#39;, \u0026#39;__module__\u0026#39;, \u0026#39;__ne__\u0026#39;, \u0026#39;__new__\u0026#39;, \u0026#39;__next__\u0026#39;, \u0026#39;__orig_bases__\u0026#39;, \u0026#39;__parameters__\u0026#39;, \u0026#39;__reduce__\u0026#39;, \u0026#39;__reduce_ex__\u0026#39;, \u0026#39;__repr__\u0026#39;, \u0026#39;__setattr__\u0026#39;, \u0026#39;__sizeof__\u0026#39;, \u0026#39;__slots__\u0026#39;, \u0026#39;__str__\u0026#39;, \u0026#39;__subclasshook__\u0026#39;, \u0026#39;_allrows\u0026#39;, \u0026#39;_assert_no_memoizations\u0026#39;, \u0026#39;_attributes\u0026#39;, \u0026#39;_column_slices\u0026#39;, \u0026#39;_fetchall_impl\u0026#39;, \u0026#39;_fetchiter_impl\u0026#39;, \u0026#39;_fetchmany_impl\u0026#39;, \u0026#39;_fetchone_impl\u0026#39;, \u0026#39;_generate\u0026#39;, \u0026#39;_generate_rows\u0026#39;, \u0026#39;_is_cursor\u0026#39;, \u0026#39;_iter_impl\u0026#39;, \u0026#39;_iterator_getter\u0026#39;, \u0026#39;_manyrow_getter\u0026#39;, \u0026#39;_memoized_keys\u0026#39;, \u0026#39;_metadata\u0026#39;, \u0026#39;_next_impl\u0026#39;, \u0026#39;_onerow_getter\u0026#39;, \u0026#39;_only_one_row\u0026#39;, \u0026#39;_post_creational_filter\u0026#39;, \u0026#39;_raw_all_rows\u0026#39;, \u0026#39;_real_result\u0026#39;, \u0026#39;_reset_memoizations\u0026#39;, \u0026#39;_row_getter\u0026#39;, \u0026#39;_set_memoized_attribute\u0026#39;, \u0026#39;_soft_close\u0026#39;, \u0026#39;_soft_closed\u0026#39;, \u0026#39;_unique_filter_state\u0026#39;, \u0026#39;_unique_strategy\u0026#39;, \u0026#39;all\u0026#39;, \u0026#39;close\u0026#39;, \u0026#39;closed\u0026#39;, \u0026#39;fetchall\u0026#39;, \u0026#39;fetchmany\u0026#39;, \u0026#39;first\u0026#39;, \u0026#39;memoized_attribute\u0026#39;, \u0026#39;memoized_instancemethod\u0026#39;, \u0026#39;one\u0026#39;, \u0026#39;one_or_none\u0026#39;, \u0026#39;partitions\u0026#39;, \u0026#39;unique\u0026#39;, \u0026#39;yield_per\u0026#39;] æ–¹æ³•è¯´æ˜ï¼š\næ–¹æ³• è¯´æ˜ é€‚ç”¨èŒƒå›´ all è¿”å›æ‰€æœ‰æ ‡é‡ å•åˆ—å¤šè¡Œ close å…³é—­æ­¤ FilterResult closed å¦‚æœåº•å±‚ Result æŠ¥å‘Šå·²å…³é—­ï¼Œåˆ™è¿”å› True fetchall all æ–¹æ³•çš„åŒä¹‰è¯ å•åˆ—å¤šè¡Œ fetchmany è·å–å¤šä¸ªå¯¹è±¡ first è·å–ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å¯¹è±¡åˆ™è¿”å› None å•åˆ—å¤šè¡Œ memoized_attribute memoized_instancemethod one æœ€å¤šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™å¼•å‘å¼‚å¸¸ (å¿…é¡»è¿”å› 1 ä¸ª) å•åˆ—å•è¡Œ (å•ä¸ª) one_or_none æœ€å¤šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™å¼•å‘å¼‚å¸¸ (0 æˆ– 1 ä¸ª) å•åˆ—å•è¡Œ (å•ä¸ª) partitions è¿­ä»£ç»™å®šå¤§å°çš„å…ƒç´ å­åˆ—è¡¨ unique å”¯ä¸€æ€§è¿‡æ»¤ (å»é‡) å•åˆ—å¤šè¡Œ yield_per é…ç½®è¡Œæå–ç­–ç•¥ï¼Œä¸€æ¬¡æå– num è¡Œ ç¤ºä¾‹ï¼š\nresult = session.scalars(select(User.username)) names = result.all() ğŸ“’ ç¬”è®°: ScalarResult æ—¢å¯ä»¥æ˜¯ å•åˆ—å•è¡Œ (æ¯”å¦‚ count()) ï¼Œä¹Ÿå¯ä»¥æ˜¯ å•åˆ—å¤šè¡Œ (æ¯”å¦‚ select id from table ...)ã€‚\nğŸ¯ å››ã€Row å’Œ RowMapping æ–¹æ³• Rowï¼ˆè¡Œå¯¹è±¡ï¼‰ å¯é€šè¿‡ä¸‰ç§æ–¹å¼è®¿é—®ï¼š\nrow[0] row[\u0026#34;username\u0026#34;] row.username RowMappingï¼ˆå­—å…¸è§†å›¾ï¼‰ æ¨èï¼š\nrow._mapping[\u0026#34;username\u0026#34;] dict(row._mapping) ğŸš€ äº”ã€ä½ çœŸæ­£éœ€è¦çš„â€œå¸¸ç”¨ç»„åˆâ€ 5.1 è¿”å› ORM å¯¹è±¡åˆ—è¡¨ items = session.execute(select(User)).scalars().all() 5.2 è¿”å› dict åˆ—è¡¨ï¼ˆæœ€å®ç”¨ï¼‰ rows = session.execute(select(User.id, User.username)).mappings().all() 5.3 è¿”å› tuple tuples = session.execute(select(User.id, User.username)).tuples().all() 5.4 update/delete è¿”å›å½±å“è¡Œæ•° result = session.execute(update(User).values(name=\u0026#34;xx\u0026#34;)) print(result.rowcount) ğŸ å…­ã€æ€»ç»“å¤§è¡¨ åŠŸèƒ½ æ¨èæ–¹æ³• è¯´æ˜ è¿”å› ORM å¯¹è±¡ scalars().all() æœ€å¸¸ç”¨ è¿”å› dict mappings().all() å¼ºçƒˆæ¨è è¿”å› tuple tuples().all() æ›´å¿« è¿”å›æ ‡é‡ scalar() ä¸€å€¼ è¿”å›å•è¡Œå¯¹è±¡ first() / one() åˆ¤æ–­æ˜¯å¦è¿”å›è¡Œ returns_rows UPDATE å½±å“è¡Œæ•° rowcount å¦‚ä½•è®© Result èƒ½å¤šæ¬¡è°ƒç”¨ åœ¨ SQLAlchemy 2.0 ä¸­ï¼ŒResultï¼ˆä»¥åŠ ScalarResultï¼‰é»˜è®¤æ˜¯ä¸€æ¬¡æ€§å¯è¿­ä»£ï¼ˆconsumable iteratorï¼‰ï¼Œæ„å‘³ç€ï¼š\nä½ ä¸€æ—¦è°ƒç”¨ .all()ã€.first()ã€.fetchmany()ã€.scalars()ã€è¿­ä»£ for row in result â€”â€” ç»“æœå°±è¢«â€œæ¶ˆè´¹æ‰â€ï¼› ä¹‹åå°±ä¸èƒ½å†æ¬¡è¿­ä»£æˆ–é‡æ–°è¯»å–ã€‚ æ‰€ä»¥ä½ çœ‹åˆ°çš„ç°è±¡æ˜¯ï¼š\nResult æœ‰æ—¶åªèƒ½ç”¨ä¸€æ¬¡ï¼Œå†æ¬¡ä½¿ç”¨å°±ä¸ºç©ºæˆ–æŠ¥é”™\nâœ… å¦‚ä½•è®© Result èƒ½å¤šæ¬¡è°ƒç”¨ï¼Ÿ\næ–¹æ³• 1ï¼šä¸€æ¬¡æ€§è¯»å–åˆ°å†…å­˜ï¼Œå†å¤ç”¨ï¼ˆæœ€å¸¸è§ï¼‰ ä½ å¯ä»¥ç«‹å³æŠŠç»“æœ .all() è¿›åˆ—è¡¨ï¼Œç„¶åéšä¾¿ç”¨å¤šå°‘æ¬¡ï¼š\nresult = session.execute(stmt) rows = result.all() # List[Row]ï¼Œå¯æ— é™æ¬¡ä½¿ç”¨ # å¤šæ¬¡ä½¿ç”¨ print(rows) print(rows[0]) ğŸŒŸğŸŒŸ å¦‚æœä½ éœ€è¦å­—å…¸ï¼š ğŸŒŸğŸŒŸ\ndicts = [dict(row) for row in result.mappings().all()] âœ… æœ€ç®€å•ã€æœ€å®‰å…¨ï¼Œä¹Ÿæœ€æ¨èçš„æ–¹å¼\næ–¹æ³• 2ï¼šä½¿ç”¨ session.execute(\u0026hellip;).mappings() è½¬æ¢æˆå¯é‡å¤çš„ç»“æ„ result = session.execute(stmt).mappings().all() å¾—åˆ°çš„æ˜¯ï¼š\n[{\u0026lsquo;id\u0026rsquo;: 1, \u0026rsquo;name\u0026rsquo;: \u0026lsquo;foo\u0026rsquo;}, {\u0026lsquo;id\u0026rsquo;: 2, \u0026rsquo;name\u0026rsquo;: \u0026lsquo;bar\u0026rsquo;}]\nä¸€æ ·å¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚\næ–¹æ³• 3ï¼šè®©æŸ¥è¯¢è¿”å› ORM å¯¹è±¡ï¼ˆORM æ¨¡å¼ï¼‰ ä½¿ç”¨ï¼š\nrows = session.scalars(select(User)).all() rows æ˜¯ list[User]ï¼Œè‡ªç„¶å¯åå¤ä½¿ç”¨ã€‚\næ–¹æ³• 4ï¼šé‡æ–°æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå¦‚æœä½ ä¸èƒ½ç¼“å­˜æ•°æ®ï¼‰ res1 = session.execute(stmt).all() res2 = session.execute(stmt).all() è¿™ç§æ–¹å¼æ¯”è¾ƒç¬¨ä½†å¯è¡Œã€‚\nâŒ ä¸å¯è¡Œï¼šResult æœ¬èº«ä¸èƒ½é‡å¤ä½¿ç”¨ å®˜æ–¹è¯´æ˜ï¼ˆç®€åŒ–ï¼‰ï¼š\nResult æ˜¯ä¸€æ¬¡æ€§æ¸¸æ ‡ï¼Œä¸ä¿è¯å¤šæ¬¡è¿­ä»£ã€‚\nå› æ­¤ä¸å­˜åœ¨ä¸€ç§æ–¹æ³•è®© Result æœ¬èº«å˜æˆ â€œå¯åå¤è¯»å–â€ çš„å¯¹è±¡ã€‚\nğŸ”¥ é‚£åˆ°åº•åº”è¯¥æ€ä¹ˆåšï¼Ÿï¼ˆæœ€ä½³å®è·µï¼‰ å†™ä¸€ä¸ªé€šç”¨çš„å°è£…ï¼šæ°¸è¿œä¸€æ¬¡æ€§ consume åè¿”å› list\nä¾‹å¦‚ï¼š\ndef query_all(session, stmt): result = session.execute(stmt) return result.all() æˆ–è€…å­—å…¸ç‰ˆæœ¬ï¼š\ndef query_dicts(session, stmt): return [dict(row) for row in session.execute(stmt).mappings().all()] ä½ çš„ä¸šåŠ¡ä»£ç æ°¸è¿œæ‹¿åˆ°çš„æ˜¯ï¼š\nlist å¯ JSON åºåˆ—åŒ– å¯å¤ç”¨ ğŸ¯ æœ€æ¨èçš„æ–¹å¼ å¦‚æœä½ æƒ³ ORM å¯¹è±¡ï¼š\nrows = session.scalars(stmt).all() å¦‚æœä½ æƒ³ dictï¼š\nrows = session.execute(stmt).mappings().all() äºŒè€…éƒ½è¿”å›å¯ä»¥åå¤ä½¿ç”¨çš„ Python åˆ—è¡¨ã€‚\nâ­ æ€»ç»“ æ–¹å¼ Result å¯å¤šæ¬¡ä½¿ç”¨ï¼Ÿ æ¨èï¼Ÿ ç›´æ¥ä½¿ç”¨ Result âŒ ä¸èƒ½ ä¸æ¨è ä½¿ç”¨ .all() è½¬åˆ—è¡¨ âœ… èƒ½ â˜…â˜…â˜…â˜…â˜… ä½¿ç”¨ .mappings().all() âœ… èƒ½ â˜…â˜…â˜…â˜…â˜… ä½¿ç”¨ scalars().all() âœ… èƒ½ â˜…â˜…â˜…â˜…â˜… é‡æ–°æ‰§è¡ŒæŸ¥è¯¢ âœ… èƒ½ï¼ˆä½†ä½æ•ˆï¼‰ â˜…â˜…â˜†â˜†â˜† Result ç¤ºä¾‹ test_result_01.py\nfrom session import db_session from sqlalchemy import text if __name__ == \u0026#34;__main__\u0026#34;: with db_session() as session: # å•åˆ—å¤šè¡Œ sql = text(\u0026#34;SELECT id, trim(username) as username FROM users;\u0026#34;) # ---------------------------------------------------------------------- print(session.execute(sql).all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # ---------------------------------------------------------------------- print(session.execute(sql).columns(\u0026#34;username\u0026#34;)) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x106ee4f30\u0026gt; # ä¸æ¨è print(list(session.execute(sql).columns(\u0026#34;username\u0026#34;))) # [(\u0026#39;admin\u0026#39;,), (\u0026#39;septvean\u0026#39;,), (\u0026#39;smalloc\u0026#39;,)] # æ¨è print(session.execute(sql).columns(\u0026#34;username\u0026#34;).all()) # [(\u0026#39;admin\u0026#39;,), (\u0026#39;septvean\u0026#39;,), (\u0026#39;smalloc\u0026#39;,)] for username in session.execute(sql).columns(\u0026#34;username\u0026#34;): print(username) # (\u0026#39;admin\u0026#39;,) # (\u0026#39;septvean\u0026#39;,) # (\u0026#39;smalloc\u0026#39;,) # ---------------------------------------------------------------------- print(session.execute(sql).fetchall()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] print(session.execute(sql).fetchmany(2)) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;)] print(session.execute(sql).fetchone()) # (1, \u0026#39;admin\u0026#39;) print(session.execute(sql).first()) # (1, \u0026#39;admin\u0026#39;) # ---------------------------------------------------------------------- print(session.execute(sql).keys()) # RMKeyView([\u0026#39;id\u0026#39;, \u0026#39;username\u0026#39;]) print(tuple(session.execute(sql).keys())) # (\u0026#39;id\u0026#39;, \u0026#39;username\u0026#39;) # ---------------------------------------------------------------------- print(session.execute(sql).mappings()) # \u0026lt;sqlalchemy.engine.result.MappingResult object at 0x10611dd60\u0026gt; # ä¸æ¨è print(list(session.execute(sql).mappings())) # [{\u0026#39;id\u0026#39;: 1, \u0026#39;username\u0026#39;: \u0026#39;admin\u0026#39;}, {\u0026#39;id\u0026#39;: 2, \u0026#39;username\u0026#39;: \u0026#39;septvean\u0026#39;}, {\u0026#39;id\u0026#39;: 4, \u0026#39;username\u0026#39;: \u0026#39;smalloc\u0026#39;}] # æ¨è print(session.execute(sql).mappings().all()) # [{\u0026#39;id\u0026#39;: 1, \u0026#39;username\u0026#39;: \u0026#39;admin\u0026#39;}, {\u0026#39;id\u0026#39;: 2, \u0026#39;username\u0026#39;: \u0026#39;septvean\u0026#39;}, {\u0026#39;id\u0026#39;: 4, \u0026#39;username\u0026#39;: \u0026#39;smalloc\u0026#39;}] # ---------------------------------------------------------------------- # print(session.execute(sql).one()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required # print(session.execute(sql).one_or_none()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when one or none was required # ---------------------------------------------------------------------- print(session.execute(sql).partitions(2)) # \u0026lt;generator object Result.partitions at 0x105830900\u0026gt; print(tuple(session.execute(sql).partitions(2))) # ([(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;)], [(4, \u0026#39;smalloc\u0026#39;)]) # ---------------------------------------------------------------------- print(session.execute(sql).scalar()) # 1 # print(session.execute(sql).scalar_one()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required # print(session.execute(sql).scalar_one_or_none()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when one or none was required # ---------------------------------------------------------------------- print(session.execute(sql).scalars()) # \u0026lt;sqlalchemy.engine.result.ScalarResult object at 0x1079569e0\u0026gt; # ä¸æ¨è print(list(session.execute(sql).scalars())) # [1, 2, 4] # æ¨è print(session.execute(sql).scalars().all()) # [1, 2, 4] # ---------------------------------------------------------------------- print(session.execute(sql).tuples()) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x106dc50f0\u0026gt; # ä¸æ¨è print(list(session.execute(sql).tuples())) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # æ¨è print(session.execute(sql).tuples().all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # ---------------------------------------------------------------------- print(session.execute(sql).unique()) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x103bb50f0\u0026gt; # ä¸æ¨è print(list(session.execute(sql).unique())) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # æ¨è print(session.execute(sql).unique().all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] test_result_02.py\nfrom database import session_execute from session import db_session from sqlalchemy import text if __name__ == \u0026#34;__main__\u0026#34;: with db_session() as session: # å•åˆ—å¤šè¡Œ sql = text(\u0026#34;SELECT id, trim(username) as username FROM users;\u0026#34;) # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.columns(\u0026#34;username\u0026#34;)) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x10844c830\u0026gt; # ä¸æ¨è if result := session_execute(session, sql): print(list(result.columns(\u0026#34;username\u0026#34;))) # [(\u0026#39;admin\u0026#39;,), (\u0026#39;septvean\u0026#39;,), (\u0026#39;smalloc\u0026#39;,)] # æ¨è if result := session_execute(session, sql): print(result.columns(\u0026#34;username\u0026#34;).all()) # [(\u0026#39;admin\u0026#39;,), (\u0026#39;septvean\u0026#39;,), (\u0026#39;smalloc\u0026#39;,)] # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.fetchall()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] if result := session_execute(session, sql): print(result.fetchmany(2)) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;)] if result := session_execute(session, sql): print(result.fetchone()) # (1, \u0026#39;admin\u0026#39;) if result := session_execute(session, sql): print(result.first()) # (1, \u0026#39;admin\u0026#39;) # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.keys()) # RMKeyView([\u0026#39;id\u0026#39;, \u0026#39;username\u0026#39;]) if result := session_execute(session, sql): print(tuple(result.keys())) # (\u0026#39;id\u0026#39;, \u0026#39;username\u0026#39;) # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.mappings()) # \u0026lt;sqlalchemy.engine.result.MappingResult object at 0x10847bac0\u0026gt; # ä¸æ¨è if result := session_execute(session, sql): print(list(result.mappings())) # [{\u0026#39;id\u0026#39;: 1, \u0026#39;username\u0026#39;: \u0026#39;admin\u0026#39;}, {\u0026#39;id\u0026#39;: 2, \u0026#39;username\u0026#39;: \u0026#39;septvean\u0026#39;}, {\u0026#39;id\u0026#39;: 4, \u0026#39;username\u0026#39;: \u0026#39;smalloc\u0026#39;}] # æ¨è if result := session_execute(session, sql): print(result.mappings().all()) # [{\u0026#39;id\u0026#39;: 1, \u0026#39;username\u0026#39;: \u0026#39;admin\u0026#39;}, {\u0026#39;id\u0026#39;: 2, \u0026#39;username\u0026#39;: \u0026#39;septvean\u0026#39;}, {\u0026#39;id\u0026#39;: 4, \u0026#39;username\u0026#39;: \u0026#39;smalloc\u0026#39;}] # ---------------------------------------------------------------------- # if result := session_execute(session, sql): # print(result.one()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required # if result := session_execute(session, sql): # print(result.one_or_none()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when one or none was required # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.partitions(2)) # \u0026lt;generator object Result.partitions at 0x105d73d80\u0026gt; if result := session_execute(session, sql): print(tuple(result.partitions(2))) # ([(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;)], [(4, \u0026#39;smalloc\u0026#39;)]) # ---------------------------------------------------------------------- # if result := session_execute(session, sql): # print(result.scalar()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required # if result := session_execute(session, sql): # print(result.scalar_one()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when exactly one was required # if result := session_execute(session, sql): # print(result.scalar_one_or_none()) # sqlalchemy.exc.MultipleResultsFound: Multiple rows were found when one or none was required # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.scalars()) # \u0026lt;sqlalchemy.engine.result.ScalarResult object at 0x105b3fa70\u0026gt; # ä¸æ¨è if result := session_execute(session, sql): print(list(result.scalars())) # [1, 2, 4] # æ¨è if result := session_execute(session, sql): print(result.scalars().all()) # [1, 2, 4] # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.tuples()) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x105b108a0\u0026gt; # ä¸æ¨è if result := session_execute(session, sql): print(list(result.tuples())) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # æ¨è if result := session_execute(session, sql): print(result.tuples().all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # ---------------------------------------------------------------------- if result := session_execute(session, sql): print(result.unique()) # \u0026lt;sqlalchemy.engine.cursor.CursorResult object at 0x105b10980\u0026gt; # ä¸æ¨è if result := session_execute(session, sql): print(list(result.unique())) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] # æ¨è if result := session_execute(session, sql): print(result.unique().all()) # [(1, \u0026#39;admin\u0026#39;), (2, \u0026#39;septvean\u0026#39;), (4, \u0026#39;smalloc\u0026#39;)] ScalarResult ç¤ºä¾‹ Result å¯ä»¥é€šè¿‡ scalars()æ–¹æ³• è½¬æ¢ä¸º ScalarResultã€‚\ntest_scalar_result_01.py\nfrom database import session_execute, session_scalars from session import db_session from sqlalchemy import text if __name__ == \u0026#34;__main__\u0026#34;: with db_session() as session: # å•åˆ—å•è¡Œ (å•ä¸ª) sql = text(\u0026#34;SELECT COUNT(*) AS total FROM users;\u0026#34;) # ---------------------------------------------------------------------- # execute + scalar_one_or_none # ä¹Ÿå¯ä»¥å†™æˆä¸€è¡Œ r1 = session.execute(sql) print(r1.scalar_one_or_none()) # 3 print(session.execute(sql).scalar_one_or_none()) # 3 # ---------------------------------------------------------------------- # æ³¨æ„: # # å¦‚æœè°ƒç”¨äº† scalar_one_or_none() æ–¹æ³•, å°±ä¸èƒ½å†è°ƒç”¨ scalars() # å¦åˆ™ä¼šæŠ¥é”™: This result object is closed # # print(r1.scalar_one_or_none()) # # 3 # # print(r1.scalars().one_or_none()) # # sqlalchemy.exc.ResourceClosedError: This result object is closed. # # scalars() å®é™…ä¸Šæ˜¯å°† Result è½¬æ¢ä¸º ScalarResult # ---------------------------------------------------------------------- # execute + scalars r2 = session.execute(sql) r2 = r2.scalars() print(r2.one_or_none()) # 3 # æˆ–è€… r2 = session.execute(sql).scalars() print(r2.one_or_none()) # 3 # ä¹Ÿå¯ä»¥å†™æˆä¸€è¡Œ print(session.execute(sql).scalars().one_or_none()) # 3 # ---------------------------------------------------------------------- # scalars + one_or_none # ä¹Ÿå¯ä»¥å†™æˆä¸€è¡Œ r3 = session.scalars(sql) print(r3.one_or_none()) # 3 print(session.scalars(sql).one_or_none()) # 3 # ---------------------------------------------------------------------- # session_execute + scalar_one_or_none r4 = session_execute(session, sql) if r4 is not None: print(r4.scalar_one_or_none()) # 3 # ---------------------------------------------------------------------- # session_scalars + one_or_none r5 = session_scalars(session, sql) if r5 is not None: print(r5.one_or_none()) # 3 test_scalar_result_02.py\nfrom database import session_scalars from session import db_session from sqlalchemy import text if __name__ == \u0026#34;__main__\u0026#34;: with db_session() as session: # å•åˆ—å¤šè¡Œ sql = text(\u0026#34;SELECT trim(username) FROM users;\u0026#34;) # ---------------------------------------------------------------------- # å¸¸è§„ print(session.scalars(sql).all()) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;, \u0026#39;smalloc\u0026#39;] print(session.scalars(sql).fetchmany(2)) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;] print(session.scalars(sql).first()) # admin # ---------------------------------------------------------------------- # å»é‡ print(session.scalars(sql).unique().all()) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;, \u0026#39;smalloc\u0026#39;] print(session.scalars(sql).unique().fetchmany(2)) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;] print(session.scalars(sql).unique().first()) # admin # ---------------------------------------------------------------------- # å¸¸è§„ if result := session_scalars(session, sql): print(result.all()) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;, \u0026#39;smalloc\u0026#39;] if result := session_scalars(session, sql): print(result.fetchmany(2)) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;] if result := session_scalars(session, sql): print(result.first()) # admin # ---------------------------------------------------------------------- # å»é‡ if result := session_scalars(session, sql): print(result.unique().all()) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;, \u0026#39;smalloc\u0026#39;] if result := session_scalars(session, sql): print(result.unique().fetchmany(2)) # [\u0026#39;admin\u0026#39;, \u0026#39;septvean\u0026#39;] if result := session_scalars(session, sql): print(result.unique().first()) # admin æ¨å¯¼æ•°æ®\nresults = [\u0026#34;admin\u0026#34;, \u0026#34;septvean\u0026#34;, \u0026#34;smalloc\u0026#34;] users = [{\u0026#34;username\u0026#34;: item} for item in results] # [{\u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;}, {\u0026#34;username\u0026#34;: \u0026#34;septvean\u0026#34;}, {\u0026#34;username\u0026#34;: \u0026#34;smalloc\u0026#34;}] ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.sqlalchemy.org.cn/en/20/core/connections.html#sqlalchemy.engine.Result\nä¸‹é¢ç»™ä½ ä¸€ç‰ˆ æœ€å…¨ã€æœ€ç³»ç»Ÿã€SQLAlchemy 2.0 Result / ScalarResult / Row / RowMapping çš„æ–¹æ³•è¯¦è§£\nè¦†ç›–åŒæ­¥/å¼‚æ­¥é€šç”¨ APIï¼ŒåŒ…å«å¸¸ç”¨ã€å°‘ç”¨ã€åº•å±‚ç»†èŠ‚ä¸æ€§èƒ½ç‰¹æ€§ï¼Œé€‚åˆä½ ç°åœ¨å¤§é‡ä½¿ç”¨ SQLAlchemy ORM + Core çš„åœºæ™¯ã€‚\nâš ï¸ SQLAlchemy 2.0 çš„ç»“æœç³»ç»Ÿä¸ 1.4 å®Œå…¨é‡å†™ï¼š\nä¸å†è¿”å› ResultProxy ç»“æœç”± Result / ScalarResult / ChunkedIteratorResult ç»„æˆ è¡Œç±»å‹ä¸º Rowï¼Œç´¢å¼•ç»“æ„åœ¨ Row._mapping ä¸­ ğŸš€ ä¸€ã€SQLAlchemy Result çš„ç±»å‹ä½“ç³» SQLAlchemy 2.0 ä¸­ï¼Œæœ‰ 3 ç§ä¸»è¦ç»“æœç±»å‹ï¼š\nç±»å‹ å‡ºç°åœºæ™¯ è¯´æ˜ Result æ‰§è¡Œ session.execute(selectâ€¦) è¡Œä¸ºå¯¹è±¡ç»“æœï¼ŒåŒ…å« Row ScalarResult æ‰§è¡Œ session.scalars(selectâ€¦) æˆ– result.scalars() å•å€¼ç»“æœï¼ˆå•ä¸ªæˆ–å•åˆ—ï¼‰ï¼Œå¦‚ count()ã€select(User.id) CursorResult æ‰§è¡Œ Core åŸç”Ÿ SQL (connection.execute(text)) ç›´æ¥æ¸¸æ ‡ç»“æœ å¹¶ä¸” Result å†…éƒ¨è¡Œå¯¹è±¡æ˜¯ï¼š\n"},{"id":421,"href":"/operations/linux/rhel-vs-debian/","title":"RHEL ç³»åˆ— vs Debian ç³»åˆ—","parent":"Linux","content":" ä¸€ã€ä¸¤å¤§ Linux é˜µè¥çš„æœ¬è´¨åŒºåˆ«ï¼ˆä¸€å¥è¯ï¼‰ RHEL ç³»åˆ—å¼ºè°ƒâ€œä¼ä¸šçº§ç¨³å®šä¸å¯æ§ç”Ÿå‘½å‘¨æœŸâ€ï¼Œ Debian ç³»åˆ—å¼ºè°ƒâ€œç¤¾åŒºé©±åŠ¨ã€é€šç”¨æ€§ä¸è‡ªç”±åº¦â€ã€‚\näºŒã€å‘è¡Œä½“ç³»ä¸ä»£è¡¨ç‰ˆæœ¬ RHEL ç³»åˆ—ï¼ˆRed Hat Enterprise Linux é˜µè¥ï¼‰ ä»£è¡¨å‘è¡Œç‰ˆï¼š\nRHELï¼ˆå•†ä¸šç‰ˆï¼‰ AlmaLinuxï¼ˆRHEL å…¼å®¹ç¤¾åŒºç‰ˆï¼‰ Rocky Linuxï¼ˆRHEL å…¼å®¹ç¤¾åŒºç‰ˆï¼‰ Oracle Linux ç‰¹ç‚¹ï¼š\nä¸¥æ ¼å‘åå…¼å®¹ é•¿ç”Ÿå‘½å‘¨æœŸï¼ˆ10+ å¹´ï¼‰ é¢å‘ä¼ä¸šä¸ç”Ÿäº§ç¯å¢ƒ Debian ç³»åˆ— ä»£è¡¨å‘è¡Œç‰ˆï¼š\nDebian Ubuntuï¼ˆåŸºäº Debianï¼‰ Linux Mintï¼ˆæ¡Œé¢å¯¼å‘ï¼‰ ç‰¹ç‚¹ï¼š\nç¤¾åŒºé©±åŠ¨ è½¯ä»¶æ–°æ—§å¹¶å­˜ï¼ˆstable / testing / unstableï¼‰ è¦†ç›–æœåŠ¡å™¨ä¸æ¡Œé¢ ä¸‰ã€å‘è¡Œç†å¿µä¸æ›´æ–°ç­–ç•¥ï¼ˆæ ¸å¿ƒå·®å¼‚ï¼‰ ç»´åº¦ RHEL ç³»åˆ— Debian ç³»åˆ— æ ¸å¿ƒç†å¿µ ç¨³å®šç¬¬ä¸€ è‡ªç”±ä¸é€šç”¨ æ›´æ–°ç­–ç•¥ å°‘å‡çº§ï¼Œå¤š backport å®šæœŸå¤§ç‰ˆæœ¬ å†…æ ¸ç‰ˆæœ¬ è¾ƒæ—§ä½†ç¨³å®š è¾ƒæ–° ABI å…¼å®¹æ€§ æå¼º ä¸­ç­‰ ä¼ä¸šè®¤è¯ éå¸¸é‡è§† ç›¸å¯¹å¼± æ¡Œé¢ä¼˜å…ˆçº§ ä½ é«˜ï¼ˆUbuntuï¼‰ å…³é”®è§£é‡Š backportï¼ˆå›ç§»è¡¥ä¸ï¼‰ åœ¨æ—§ç‰ˆæœ¬ä»£ç ä¸Šæ‰“å®‰å…¨ / åŠŸèƒ½è¡¥ä¸ï¼Œè€Œä¸æ˜¯æ•´ä½“å‡çº§ç‰ˆæœ¬ã€‚\nå››ã€åŒ…ç®¡ç†ä¸è½¯ä»¶ç”Ÿæ€ åŒ…ç®¡ç†å·¥å…· é¡¹ç›® RHEL ç³»åˆ— Debian ç³»åˆ— åŒ…æ ¼å¼ RPM DEB åŒ…ç®¡ç†å™¨ rpm / dnf / yum dpkg / apt ä¾èµ–å¤„ç† ç¨³å¥ä½†ä¿å®ˆ çµæ´»ä¸”ä¸°å¯Œ ä»“åº“ç»“æ„ å®˜æ–¹ä¸ºä¸» å®˜æ–¹ + PPA è½¯ä»¶ç‰ˆæœ¬ç­–ç•¥ RHELï¼š\nè½¯ä»¶ç‰ˆæœ¬â€œå†»ç»“â€ é€šè¿‡è¡¥ä¸ä¿è¯å®‰å…¨ Debian / Ubuntuï¼š\næ–°ç‰ˆæœ¬ç›´æ¥è¿›å…¥æ–°å‘è¡Œç‰ˆ Ubuntu LTS å¹³è¡¡ç¨³å®šä¸æ–°ç‰¹æ€§ äº”ã€ç³»ç»Ÿæ¶æ„ä¸ç»„ä»¶å·®å¼‚ systemd ä¸¤è€…éƒ½ä½¿ç”¨ systemd RHELï¼š æ›´ä¸¥æ ¼ ä¼ä¸šçº§é»˜è®¤å‚æ•° Debianï¼š å¯é€‰æ€§æ›´å¤š æ¡Œé¢å‹å¥½ SELinux / AppArmorï¼ˆå®‰å…¨æ¨¡å‹å·®å¼‚ï¼‰ é¡¹ç›® RHEL ç³»åˆ— Debian ç³»åˆ— é»˜è®¤å®‰å…¨æ¡†æ¶ SELinux AppArmor å¼ºåˆ¶è®¿é—®æ§åˆ¶ æ˜¯ æ˜¯ å¤æ‚åº¦ é«˜ ä½ ä¼ä¸šåˆè§„ éå¸¸å¼º ä¸€èˆ¬ å…­ã€ç½‘ç»œä¸å†…æ ¸å‚æ•°é£æ ¼ RHEL ç³»åˆ— åå‘ä¿å®ˆ sysctl é»˜è®¤å€¼æ›´å®‰å…¨ æ›´å¼ºè°ƒå…¼å®¹æ€§ Debian ç³»åˆ— åå‘é€šç”¨ æ¡Œé¢ä¸æœåŠ¡å™¨å…¼é¡¾ æ–°å†…æ ¸ç‰¹æ€§ä¸Šçº¿æ›´å¿« ä¸ƒã€å¯åŠ¨æ–¹å¼ä¸å¼•å¯¼ é¡¹ç›® RHEL ç³»åˆ— Debian ç³»åˆ— BIOS / UEFI å…¨æ”¯æŒ å…¨æ”¯æŒ GRUB é…ç½®è·¯å¾„ /boot/grub2 /boot/grub å†…æ ¸å‚æ•°å·¥å…· grubby update-grub initramfs dracut update-initramfs å…«ã€ç”Ÿå‘½å‘¨æœŸä¸ç»´æŠ¤ RHEL ç³»åˆ— ä¸»ç‰ˆæœ¬æ”¯æŒï¼š10 å¹´ æ‰©å±•æ”¯æŒï¼šå¯è¾¾ 13 å¹´ å®‰å…¨æ›´æ–°ç¨³å®šå¯æ§ Debian / Ubuntu Debian Stableï¼šçº¦ 5 å¹´ Ubuntu LTSï¼š5 å¹´ï¼ˆå¯å»¶é•¿è‡³ 10 å¹´ï¼‰ é LTS ç‰ˆæœ¬ï¼š9 ä¸ªæœˆ ä¹ã€è¿ç»´ä¸è‡ªåŠ¨åŒ–é£æ ¼ RHEL ç³»åˆ— æ ‡å‡†åŒ–å¼º ä¼ä¸šæµç¨‹æ¸…æ™° é€‚åˆå¤§è§„æ¨¡è¿ç»´ å¸¸è§å·¥å…·ï¼š\nAnsibleï¼ˆçº¢å¸½ç³»ç”Ÿæ€ï¼‰ Satellite Foreman Debian ç³»åˆ— çµæ´»åº¦é«˜ ç¤¾åŒºå·¥å…·ä¸°å¯Œ DevOps å‹å¥½ å¸¸è§å·¥å…·ï¼š\ncloud-init apt automation PPA ç”Ÿæ€ åã€è™šæ‹ŸåŒ–ä¸å®¹å™¨ç”Ÿæ€ é¡¹ç›® RHEL ç³»åˆ— Debian ç³»åˆ— KVM å®˜æ–¹ä¸»æ¨ æ”¯æŒ Podman é»˜è®¤ éé»˜è®¤ Docker æ”¯æŒ éå®˜æ–¹ CRI-O å®˜æ–¹ è¾ƒå°‘ RHEL æ›´å¼ºè°ƒ æ— å®ˆæŠ¤è¿›ç¨‹å®¹å™¨ï¼ˆPodmanï¼‰ã€‚\nåä¸€ã€æ•°æ®åº“ä¸ä¸­é—´ä»¶é€‚é… å•†ä¸šæ•°æ®åº“ï¼ˆOracleã€DB2ï¼‰ï¼š ä¼˜å…ˆæ”¯æŒ RHEL MySQL / PostgreSQLï¼š ä¸¤è€…éƒ½ç¨³å®š RHEL æ›´é€‚åˆé•¿æœŸè¿è¡Œ æ–°ç‰ˆæœ¬æ•°æ®åº“ï¼š Debian / Ubuntu æ›´å¿«æ”¯æŒ åäºŒã€é€‚ç”¨åœºæ™¯æ€»ç»“ï¼ˆéå¸¸å®ç”¨ï¼‰ é€‰æ‹© RHEL ç³»åˆ—ï¼Œå¦‚æœä½  è¿½æ±‚é•¿æœŸç¨³å®š ä¼ä¸šç”Ÿäº§ç¯å¢ƒ æ•°æ®åº“ / æ ¸å¿ƒä¸šåŠ¡ åˆè§„ã€å®¡è®¡è¦æ±‚é«˜ ä¸æƒ³é¢‘ç¹å‡çº§ç³»ç»Ÿ é€‰æ‹© Debian ç³»åˆ—ï¼Œå¦‚æœä½  éœ€è¦æ–°ç‰¹æ€§ DevOps / CI/CD æ¡Œé¢æˆ–å¼€å‘ç¯å¢ƒ äº‘åŸç”Ÿ / å¾®æœåŠ¡ æŠ€æœ¯è¿­ä»£å¿« åä¸‰ã€ç®€å•å†³ç­–è¡¨ï¼ˆæ¨èæ”¶è—ï¼‰ éœ€æ±‚ æ¨è ä¼ä¸šæ•°æ®åº“ RHEL / AlmaLinux äº‘åŸç”Ÿå¹³å° Ubuntu LTS æ¡Œé¢åŠå…¬ Ubuntu æè‡´ç¨³å®š RHEL æŠ€æœ¯æ¢ç´¢ Debian åå››ã€ä¸€å¥è¯ç»ˆææ€»ç»“ RHEL ç³»åˆ—æ˜¯â€œå·¥ç¨‹ç³»ç»Ÿâ€ï¼Œ Debian ç³»åˆ—æ˜¯â€œé€šç”¨ç³»ç»Ÿâ€ã€‚\n","description":" ä¸€ã€ä¸¤å¤§ Linux é˜µè¥çš„æœ¬è´¨åŒºåˆ«ï¼ˆä¸€å¥è¯ï¼‰ RHEL ç³»åˆ—å¼ºè°ƒâ€œä¼ä¸šçº§ç¨³å®šä¸å¯æ§ç”Ÿå‘½å‘¨æœŸâ€ï¼Œ Debian ç³»åˆ—å¼ºè°ƒâ€œç¤¾åŒºé©±åŠ¨ã€é€šç”¨æ€§ä¸è‡ªç”±åº¦â€ã€‚\näºŒã€å‘è¡Œä½“ç³»ä¸ä»£è¡¨ç‰ˆæœ¬ RHEL ç³»åˆ—ï¼ˆRed Hat Enterprise Linux é˜µè¥ï¼‰ ä»£è¡¨å‘è¡Œç‰ˆï¼š\n"},{"id":422,"href":"/operations/linux/rhel-init-system/","title":"RHEL ç³»åˆ—ç³»ç»Ÿåˆå§‹åŒ–æ–¹æ¡ˆ","parent":"Linux","content":" 1ï¸âƒ£ åŸºç¡€æ¸…ç†ä¸ç³»ç»Ÿç²¾ç®€ ç›®æ ‡ï¼šç²¾ç®€ç³»ç»Ÿã€æ¸…ç†å†—ä½™æ–‡ä»¶å’ŒåŒ…ï¼Œæé«˜å®‰å…¨æ€§ä¸æ€§èƒ½ã€‚\næ“ä½œé¡¹ï¼š\nåˆ é™¤éç³»ç»Ÿè‡ªå¸¦åŒ…æˆ–å·¥å…·ï¼ˆå¦‚ aliyun_assistï¼‰ æ¸…ç† /usr/local ç›®å½• ç§»é™¤ æ¡Œé¢/GUI ç»„ä»¶ åˆ é™¤ç³»ç»Ÿå®‰è£…å’Œå‡çº§äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ åˆ é™¤æ— æ•ˆç¬¦å·é“¾æ¥ æ¸…ç†æ—§å†…æ ¸ æ¸…ç†ç¼“å­˜ (dnf) åˆ é™¤æ— ç”¨è¯­è¨€åŒ… 2ï¸âƒ£ å®‰å…¨åŠ å›º ç›®æ ‡ï¼šå¼ºåŒ–ç³»ç»Ÿå®‰å…¨ï¼Œé™åˆ¶æœªæˆæƒè®¿é—®ã€‚\næ“ä½œé¡¹ï¼š\nå…³é—­ SELinux å…³é—­ é˜²ç«å¢™ï¼ˆç”Ÿäº§å¯é€‰æ‹©ç²¾ç®€è§„åˆ™ï¼‰ SSH å®‰å…¨ä¼˜åŒ– ç¦ç”¨ç©ºå¯†ç ã€å¯†ç è®¤è¯åªå…è®¸ç‰¹å®šç”¨æˆ· è®¾ç½® MaxAuthTries SSH é™åˆ¶ root ç”¨æˆ·ç™»å½• ç¦ç”¨ IPv6 å®‰è£…å®‰å…¨å¢å¼ºå·¥å…· é…ç½® sudo å®‰å…¨ç­–ç•¥ ç³»ç»Ÿè´¦æˆ·å®‰å…¨ åˆ é™¤æˆ–é”å®šé»˜è®¤æ— ç”¨è´¦æˆ·ï¼Œå¦‚ gamesã€lp è®¾ç½®å£ä»¤ç­–ç•¥ /etc/security/pwquality.conf 3ï¸âƒ£ è½¯ä»¶æºå’Œæ›´æ–° ç›®æ ‡ï¼šä¿è¯ç³»ç»Ÿè½¯ä»¶å¯ç”¨ä¸”å®‰å…¨ã€‚\næ“ä½œé¡¹ï¼š\næ¸…ç†å¹¶è®¾ç½® dnf/yum æº å®‰è£…ç¬¬ä¸‰æ–¹æºï¼Œä¾‹å¦‚ï¼šEPEL ç³»ç»Ÿå‡çº§ å®‰è£…å¸¸ç”¨å·¥å…·ï¼ˆvimã€wgetã€curlã€net-toolsã€lsofã€bash-completionã€gitï¼‰ ç¦ç”¨è‡ªåŠ¨æ›´æ–° é…ç½®åŒ…ç®¡ç†åŠ é€Ÿï¼ˆç¼“å­˜/é•œåƒé€‰æ‹©ï¼‰ å¯ç”¨æ¨¡å—æµï¼ˆmodule streamsï¼‰ç®¡ç†å…³é”®è½¯ä»¶ 4ï¸âƒ£ ç”¨æˆ·ä¸æƒé™ç®¡ç† ç›®æ ‡ï¼šåˆç†åˆ†é…æƒé™ï¼Œä¿è¯ç³»ç»Ÿå®‰å…¨ã€‚\næ“ä½œé¡¹ï¼š\næ·»åŠ ç”¨æˆ· è°ƒæ•´èµ„æºé™åˆ¶ï¼ˆlimitsï¼‰ SSH root ç™»å½•é™åˆ¶ 5ï¸âƒ£ æ—¶é—´ä¸åŒæ­¥ ç›®æ ‡ï¼šä¿è¯ç³»ç»Ÿæ—¶é—´å‡†ç¡®ï¼Œé˜²æ­¢æ—¶é’Ÿæ¼‚ç§»ã€‚\næ“ä½œé¡¹ï¼š\nè®¾ç½®æ—¶åŒº /etc/localtime é…ç½®æ—¶é—´åŒæ­¥ï¼ˆchronyï¼‰ å¯ç”¨ç¡¬ä»¶æ—¶é’ŸåŒæ­¥ å¯é€‰ï¼šç›‘æ§æ—¶é—´æ¼‚ç§» 6ï¸âƒ£ ç½‘ç»œä¸å†…æ ¸å‚æ•° ç›®æ ‡ï¼šä¼˜åŒ–ç½‘ç»œæ€§èƒ½ä¸å†…æ ¸å‚æ•°ã€‚\næ“ä½œé¡¹ï¼š\nç¦ç”¨ IPv6 ç²¾ç®€ç³»ç»ŸæœåŠ¡ï¼ˆåªä¿ç•™åŸºç¡€æœåŠ¡ï¼‰ è°ƒæ•´å†…æ ¸å‚æ•° /etc/sysctl.conf åŠ è½½å¸¸ç”¨ç³»ç»Ÿæ¨¡å— /etc/modules-load.d/ ç½‘ç»œå®‰å…¨å¼ºåŒ–ï¼š ç¦ç”¨ IP è½¬å‘é™¤éå¿…è¦ å¼€å¯ TCP SYN cookie é˜²æ­¢ core dump æ³„éœ²æ•æ„Ÿä¿¡æ¯ å¯ç”¨ BBR 7ï¸âƒ£ æœåŠ¡ç²¾ç®€ä¸ä¼˜åŒ– ç›®æ ‡ï¼šç²¾ç®€å¼€æœºæœåŠ¡ï¼Œä¼˜åŒ–æ—¥å¿—ç­–ç•¥ã€‚\næ“ä½œé¡¹ï¼š\nç²¾ç®€ systemd æœåŠ¡ è°ƒæ•´å¼€æœºå¯åŠ¨è„šæœ¬ï¼ˆrc.localï¼‰ æ—¥å¿—ä¼˜åŒ– (journald æ—¥å¿—å¤§å°é™åˆ¶) è®¾ç½® cron ä»»åŠ¡æ¸…ç†ç¼“å­˜ / ä¸´æ—¶æ–‡ä»¶ 8ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿä¸å­˜å‚¨ ç›®æ ‡ï¼šä¼˜åŒ–æŒ‚è½½å’Œæ€§èƒ½ã€‚\næ“ä½œé¡¹ï¼š\nè°ƒæ•´ fstab æ ¼å¼ï¼ˆcolumn -tï¼‰ æŒ‚è½½é€‰é¡¹ä¼˜åŒ– (noatime, nodiratime) æ¸…ç†ä¸´æ—¶æ–‡ä»¶ åˆ é™¤æ— æ•ˆé“¾æ¥ LVM æˆ–ç£ç›˜åˆ†åŒºæ£€æŸ¥ 9ï¸âƒ£ /etc é…ç½®æ–‡ä»¶ç®¡ç† ç›®æ ‡ï¼šä¿è¯é…ç½®è§„èŒƒåŒ–å’Œå¤‡ä»½ã€‚\næ“ä½œé¡¹ï¼š\nbashrc, profile, inputrc, locale.conf, sshd_config, sysctl.conf rc.local modules-load.d/*.conf /etc/tmpfiles.d /etc/systemd/journald.conf ğŸ”Ÿ è¿ç»´å·¥å…·å’Œç›‘æ§ ç›®æ ‡ï¼šä¿è¯å¯è§‚æµ‹æ€§å’Œè¿ç»´æ•ˆç‡ã€‚\nå»ºè®®å®‰è£…ï¼š\nç³»ç»Ÿç›‘æ§å·¥å…·ï¼šhtop, atop, glances, iotop, net-tools æ—¥å¿—æ”¶é›†/åˆ†æå·¥å…·ï¼šrsyslog, journalctl, logrotate å®‰å…¨å®¡è®¡å·¥å…·ï¼šauditd, fail2ban å…¶å®ƒ è®¾ç½®ä¸»æœºåç§° âœ… æ€»ç»“ åˆå§‹åŒ–ç›®æ ‡\nç²¾ç®€ç³»ç»Ÿï¼Œåˆ é™¤å†—ä½™åŒ…ä¸æ–‡ä»¶ å¼ºåŒ–å®‰å…¨ï¼šSELinuxã€SSHã€ç”¨æˆ·ã€å¯†ç ç­–ç•¥ è½¯ä»¶æºç®¡ç†ï¼šå®˜æ–¹ + ç¬¬ä¸‰æ–¹æº + ç³»ç»Ÿå‡çº§ ç”¨æˆ·ä¸æƒé™è§„èŒƒåŒ– æ—¶é—´åŒæ­¥å¯é  ç½‘ç»œä¸å†…æ ¸ä¼˜åŒ– æœåŠ¡ç²¾ç®€ï¼Œæ—¥å¿—ä¼˜åŒ– æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–ï¼ŒæŒ‚è½½å‚æ•°è°ƒæ•´ /etc é…ç½®è§„èŒƒåŒ–ï¼Œç»Ÿä¸€ç®¡ç† å®‰è£…ç›‘æ§ä¸è¿ç»´å·¥å…·ï¼Œæé«˜å¯è§‚æµ‹æ€§ ğŸ’¡ å»ºè®®è½åœ°æ–¹å¼ï¼š\næŒ‰æ¨¡å—ç¼–å†™åˆå§‹åŒ–è„šæœ¬ï¼Œæ¯ä¸€ç±»æ“ä½œç‹¬ç«‹æ‰§è¡Œ æ¯ä¸€æ­¥æ“ä½œå‰è¿›è¡Œæ£€æŸ¥æˆ–å¤‡ä»½ å¯ç»“åˆ ansible æˆ– shell è„šæœ¬å®ç°æ‰¹é‡åˆå§‹åŒ– ","description":" 1ï¸âƒ£ åŸºç¡€æ¸…ç†ä¸ç³»ç»Ÿç²¾ç®€ ç›®æ ‡ï¼šç²¾ç®€ç³»ç»Ÿã€æ¸…ç†å†—ä½™æ–‡ä»¶å’ŒåŒ…ï¼Œæé«˜å®‰å…¨æ€§ä¸æ€§èƒ½ã€‚\næ“ä½œé¡¹ï¼š\nåˆ é™¤éç³»ç»Ÿè‡ªå¸¦åŒ…æˆ–å·¥å…·ï¼ˆå¦‚ aliyun_assistï¼‰ æ¸…ç† /usr/local ç›®å½• ç§»é™¤ æ¡Œé¢/GUI ç»„ä»¶ åˆ é™¤ç³»ç»Ÿå®‰è£…å’Œå‡çº§äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ åˆ é™¤æ— æ•ˆç¬¦å·é“¾æ¥ æ¸…ç†æ—§å†…æ ¸ æ¸…ç†ç¼“å­˜ (dnf) åˆ é™¤æ— ç”¨è¯­è¨€åŒ… 2ï¸âƒ£ å®‰å…¨åŠ å›º ç›®æ ‡ï¼šå¼ºåŒ–ç³»ç»Ÿå®‰å…¨ï¼Œé™åˆ¶æœªæˆæƒè®¿é—®ã€‚\næ“ä½œé¡¹ï¼š\nå…³é—­ SELinux å…³é—­ é˜²ç«å¢™ï¼ˆç”Ÿäº§å¯é€‰æ‹©ç²¾ç®€è§„åˆ™ï¼‰ SSH å®‰å…¨ä¼˜åŒ– ç¦ç”¨ç©ºå¯†ç ã€å¯†ç è®¤è¯åªå…è®¸ç‰¹å®šç”¨æˆ· è®¾ç½® MaxAuthTries SSH é™åˆ¶ root ç”¨æˆ·ç™»å½• ç¦ç”¨ IPv6 å®‰è£…å®‰å…¨å¢å¼ºå·¥å…· é…ç½® sudo å®‰å…¨ç­–ç•¥ ç³»ç»Ÿè´¦æˆ·å®‰å…¨ åˆ é™¤æˆ–é”å®šé»˜è®¤æ— ç”¨è´¦æˆ·ï¼Œå¦‚ gamesã€lp è®¾ç½®å£ä»¤ç­–ç•¥ /etc/security/pwquality.conf 3ï¸âƒ£ è½¯ä»¶æºå’Œæ›´æ–° ç›®æ ‡ï¼šä¿è¯ç³»ç»Ÿè½¯ä»¶å¯ç”¨ä¸”å®‰å…¨ã€‚\n"},{"id":423,"href":"/operations/linux/rsync/","title":"rsync","parent":"Linux","content":" 1. ä»€ä¹ˆæ˜¯ rsyncï¼Ÿ rsyncï¼ˆremote syncï¼‰æ˜¯ä¸€æ¬¾å¢é‡åŒæ­¥å·¥å…·ï¼Œç”¨äºåœ¨æœ¬åœ°å’Œè¿œç¨‹ä¹‹é—´é«˜æ•ˆä¼ è¾“æ–‡ä»¶ï¼Œæ”¯æŒï¼š\nå¢é‡ä¼ è¾“ï¼ˆåªä¼ å˜åŒ–éƒ¨åˆ†ï¼‰ æ–­ç‚¹ç»­ä¼  æƒé™/æ—¶é—´æˆ³/è½¯ç¡¬é“¾æ¥åŒæ­¥ æ ¡éªŒæ¨¡å¼ ä¼ è¾“å‹ç¼© å¸¸ç”¨äºï¼šæœåŠ¡å™¨å¤‡ä»½ã€æ—¥å¿—åŒæ­¥ã€web é›†ç¾¤éƒ¨ç½²ã€é•œåƒåŒæ­¥ç­‰ã€‚\n2. rsync ä¼ è¾“æ¨¡å¼ 2.1 æœ¬åœ°åŒæ­¥ï¼ˆlocal -\u0026gt; localï¼‰ rsync -av /src/ /dst/ 2.2 æœ¬åœ° -\u0026gt; è¿œç¨‹ rsync -av /src/ user@remote:/dst/ 2.3 è¿œç¨‹ -\u0026gt; æœ¬åœ° rsync -av user@remote:/src/ /dst/ 2.4 Daemon æ¨¡å¼ï¼ˆæœåŠ¡ç«¯å®ˆæŠ¤è¿›ç¨‹ï¼‰ é€‚åˆå¤§é‡å®¢æˆ·ç«¯åŒæ­¥å›ºå®šç›®å½•ï¼Œé€Ÿåº¦æœ€å¿«ã€‚\n3. rsync æœ€å¸¸ç”¨å‚æ•°ï¼ˆæ ¸å¿ƒï¼‰ å‚æ•° ä½œç”¨ -a å½’æ¡£æ¨¡å¼ï¼ˆé€’å½’ + æƒé™ + æ—¶é—´ + é“¾æ¥ï¼‰æœ€å¸¸ç”¨ -v æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -z å‹ç¼©ä¼ è¾“ï¼ˆå¯¹å¤§é‡å°æ–‡ä»¶æ•ˆæœå·¨å¤§ï¼‰ -P æ˜¾ç¤ºè¿›åº¦ + æ–­ç‚¹ç»­ä¼  -h æ•°å­—å‹å¥½æ˜¾ç¤º \u0026ndash;delete åˆ é™¤ç›®æ ‡ä¸­æºä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆæ…ç”¨ï¼‰ \u0026ndash;exclude æ’é™¤æ–‡ä»¶ \u0026ndash;exclude-from æ‰¹é‡æ’é™¤ \u0026ndash;bwlimit=KB é™é€Ÿ ç»„åˆå¸¸ç”¨å‘½ä»¤ï¼š\nrsync -avzP /data/ app@10.0.0.1:/data/ 4. rsync æºè·¯å¾„æœ«å°¾ / çš„å«ä¹‰ è¿™ç‚¹éå¸¸é‡è¦ï¼Œå¾ˆå¤šçº¿ä¸Šäº‹æ•…ç”±æ­¤å¼•å‘ã€‚\n4.1 æœ‰ /ï¼šåŒæ­¥ç›®å½•å†…å®¹ rsync -av /src/ /dst/ æ•ˆæœï¼šdst ä¸­è·å¾— src çš„å†…å®¹ã€‚\n4.2 æ—  /ï¼šåŒæ­¥ç›®å½•æœ¬èº« rsync -av /src /dst/ æ•ˆæœï¼šdst ç›®å½•ä¸­ä¼šå‡ºç° /dst/src/\n5. exclude æ’é™¤è§„åˆ™ 5.1 å•ä¸ªæ’é™¤ rsync -av --exclude \u0026#34;node_modules\u0026#34; src/ dest/ 5.2 æ­£åˆ™æ‰¹é‡æ’é™¤ rsync -av --exclude \u0026#34;*.log\u0026#34; src/ dest/ 5.3 ä»æ–‡ä»¶æ’é™¤ node_modules *.log tmp/ rsync -av --exclude-from=exclude.txt src/ dest/ 6. â€“delete çš„ä¸‰ç§åˆ é™¤ç­–ç•¥ å‚æ•° è¡Œä¸º \u0026ndash;delete åˆ é™¤ç›®æ ‡ä¸­æºä¸å­˜åœ¨æ–‡ä»¶ \u0026ndash;delete-before ä¼ è¾“å‰åˆ é™¤ï¼Œæé«˜æ•ˆç‡ \u0026ndash;delete-after ä¼ è¾“ååˆ é™¤ï¼ˆæ›´å®‰å…¨ï¼‰ \u0026ndash;delete-excluded æŠŠ exclude è¿‡æ»¤æ‰çš„æ–‡ä»¶ä¹Ÿåˆ é™¤ â˜¢ï¸ ç”Ÿäº§å»ºè®®ï¼šä¸€å®šæµ‹è¯•åå†åŠ  \u0026ndash;deleteï¼Œå¦åˆ™ä¼šåˆ åº“è·‘è·¯çº§äº‹æ•…ã€‚\n7. rsync åŠ é€ŸæŠ€å·§ 7.1 ä½¿ç”¨ -z å‹ç¼© æ—¥å¿—ç±»æ–‡ä»¶éå¸¸å—ç›Šã€‚\n7.2 é™åˆ¶ CPU + å¸¦å®½ rsync -avz --bwlimit=50000 ... 7.3 ä½¿ç”¨ \u0026ndash;whole-file æœ¬åœ°å±€åŸŸç½‘ä¼ è¾“æ›´å¿«ï¼Œä¸åšå·®å¼‚ç®—æ³•ã€‚\n7.4 è·³è¿‡æ ¡éªŒï¼ˆé€Ÿåº¦æ›´å¿«ï¼‰ rsync -av --size-only src/ dest/ 8. rsync å…¸å‹ä½¿ç”¨åœºæ™¯ 8.1 ç½‘ç«™ä»£ç å‘å¸ƒ rsync -avz --delete /var/www/ root@web01:/var/www/ 8.2 æ—¥å¿—æ–‡ä»¶å¢é‡å¤‡ä»½ rsync -avzP /var/log/ backup:/backup/log/ 8.3 å®šæ—¶(mysqlã€pg)å¤‡ä»½ç›®å½• é…åˆ cronï¼š\n0 3 * * * rsync -avz /data/backup/ backup:/data/backup/ 8.4 å¤§å‹æ–‡ä»¶æ–­ç‚¹ç»­ä¼  rsync -avP big.iso remote:/root/ 8.5 é›†ç¾¤å†…åŒæ­¥é…ç½®æ–‡ä»¶ rsync -av --exclude \u0026#34;.git\u0026#34; /etc/nginx/ web02:/etc/nginx/ 9. rsync Daemon æ¨¡å¼ï¼ˆç”Ÿäº§çº§ï¼‰ 9.1 é…ç½® /etc/rsyncd.conf uid = root gid = root max connections = 10 use chroot = no log file = /var/log/rsyncd.log pid file = /var/run/rsyncd.pid read only = no [data] path = /data auth users = backup secrets file = /etc/rsyncd.secrets 9.2 è®¾ç½®å¯†ç  backup:123456 9.3 å¯åŠ¨ rsync --daemon 9.4 å®¢æˆ·ç«¯ä½¿ç”¨ rsync -avz backup@server::data /local/data/ 10. rsync vs scpï¼ˆå“ªä¸ªæ›´å¥½ï¼Ÿï¼‰ åœºæ™¯ é€‰æ‹© å¤§é‡å°æ–‡ä»¶ rsync å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼  rsync å•æ¬¡ç®€å•ä¼ æ–‡ä»¶ scp ä¿æŒæ—¶é—´æˆ³/æƒé™/é“¾æ¥ rsync å¢é‡åŒæ­¥ã€æŒç»­åŒæ­¥ rsync 11. rsync æœ€ä½³å®è·µ ä½¿ç”¨ -a å½’æ¡£æ¨¡å¼ ä½¿ç”¨ -P æ–¹ä¾¿æ–­ç‚¹ç»­ä¼  è·¨æœºå™¨å¼ºåˆ¶ç”¨ -z å‹ç¼© .git / .cache / node_modules ä¸€å¾‹æ’é™¤ ä½¿ç”¨ \u0026ndash;delete-after ä»£æ›¿ \u0026ndash;delete ç”¨ rsync ä»£æ›¿ scp éƒ¨ç½²/åŒæ­¥ é‡è¦ç›®å½•å…ˆ dry-run æµ‹è¯• rsync -avP --dry-run src/ dest/ ","description":" 1. ä»€ä¹ˆæ˜¯ rsyncï¼Ÿ rsyncï¼ˆremote syncï¼‰æ˜¯ä¸€æ¬¾å¢é‡åŒæ­¥å·¥å…·ï¼Œç”¨äºåœ¨æœ¬åœ°å’Œè¿œç¨‹ä¹‹é—´é«˜æ•ˆä¼ è¾“æ–‡ä»¶ï¼Œæ”¯æŒï¼š\nå¢é‡ä¼ è¾“ï¼ˆåªä¼ å˜åŒ–éƒ¨åˆ†ï¼‰ æ–­ç‚¹ç»­ä¼  æƒé™/æ—¶é—´æˆ³/è½¯ç¡¬é“¾æ¥åŒæ­¥ æ ¡éªŒæ¨¡å¼ ä¼ è¾“å‹ç¼© å¸¸ç”¨äºï¼šæœåŠ¡å™¨å¤‡ä»½ã€æ—¥å¿—åŒæ­¥ã€web é›†ç¾¤éƒ¨ç½²ã€é•œåƒåŒæ­¥ç­‰ã€‚\n2. rsync ä¼ è¾“æ¨¡å¼ 2.1 æœ¬åœ°åŒæ­¥ï¼ˆlocal -\u0026gt; localï¼‰ rsync -av /src/ /dst/ 2.2 æœ¬åœ° -\u0026gt; è¿œç¨‹ rsync -av /src/ user@remote:/dst/ 2.3 è¿œç¨‹ -\u0026gt; æœ¬åœ° rsync -av user@remote:/src/ /dst/ 2.4 Daemon æ¨¡å¼ï¼ˆæœåŠ¡ç«¯å®ˆæŠ¤è¿›ç¨‹ï¼‰ é€‚åˆå¤§é‡å®¢æˆ·ç«¯åŒæ­¥å›ºå®šç›®å½•ï¼Œé€Ÿåº¦æœ€å¿«ã€‚\n"},{"id":424,"href":"/backend/python/sqlalchemy/select/","title":"Select","parent":"SQLAlchemy","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ SQLAlchemy 2.0 ORM select() æœ€æ¸…æ™°ã€æœ€å®Œæ•´ã€æœ€å®æˆ˜çš„æ•™ç¨‹ï¼Œæ¶µç›–åŸºç¡€ã€è¿›é˜¶ã€JOINã€è¿‡æ»¤ã€å¤šè¡¨ã€åˆ†é¡µã€èšåˆã€å­æŸ¥è¯¢ã€è¿”å›å€¼å¤„ç†ç­‰å†…å®¹ã€‚\nå†…å®¹ç»è¿‡æ•´ç†ï¼Œå®Œå…¨é€‚é… SQLAlchemy 2.0ï¼ˆsync + async é€šç”¨ï¼‰ã€‚\n1. åŸºç¡€ï¼šæœ€ç®€å•çš„ select from sqlalchemy import select from models import User stmt = select(User) result = session.execute(stmt).scalars().all() è¿”å›æ ¼å¼ï¼ˆORM æ¨¡å¼ï¼‰\nresult.scalars().all() -\u0026gt; list[User] 2. åªæŸ¥è¯¢éƒ¨åˆ†å­—æ®µ stmt = select(User.id, User.name) rows = session.execute(stmt).all() è¿”å›æ ¼å¼\n[(1, \u0026#34;martin\u0026#34;), (2, \u0026#34;john\u0026#34;), ...] 3. ä½¿ç”¨è¿‡æ»¤æ¡ä»¶ï¼ˆ=ã€\u0026gt;ã€\u0026lt;ã€LIKEã€INï¼‰ 3.1 ç­‰äº stmt = select(User).where(User.status == 1) 3.2 å¤šæ¡ä»¶ AND stmt = select(User).where( User.age \u0026gt; 18, User.status == 1 ) 3.3 OR æ¡ä»¶ from sqlalchemy import or_ stmt = select(User).where( or_(User.age \u0026lt; 18, User.status == 0) ) 3.4 IN stmt = select(User).where(User.id.in_([1, 2, 3])) 3.5 LIKE stmt = select(User).where(User.name.like(\u0026#34;%martin%\u0026#34;)) 4. æ’åº ORDER BY stmt = select(User).order_by(User.id.desc()) 5. åˆ†é¡µ LIMIT OFFSET stmt = ( select(User) .order_by(User.id.desc()) .limit(10) .offset(0) ) 6. JOINï¼ˆæœ€å¸¸ç”¨ï¼‰ å†…è¿æ¥ JOIN\nstmt = ( select(User, Profile) .join(Profile, Profile.user_id == User.id) ) è¿”å›å€¼ç¤ºä¾‹ï¼š\n[(User, Profile), (User, Profile), ...] LEFT JOIN\nstmt = ( select(User, Profile) .outerjoin(Profile, Profile.user_id == User.id) ) 7. å¤šè¡¨ JOIN + æŒ‡å®šå­—æ®µ stmt = ( select(User.id, User.name, Profile.age) .join(Profile, Profile.user_id == User.id) ) è¿”å›æ ¼å¼ï¼š\n[(1, \u0026#34;Martin\u0026#34;, 25), ...] 8. DISTINCTï¼ˆå»é‡ï¼‰ stmt = select(User.name).distinct() 9. GROUP BYã€èšåˆå‡½æ•° from sqlalchemy import func stmt = ( select(User.status, func.count()) .group_by(User.status) ) è¿”å›ï¼š\n[(1, 10), (0, 3)] 10. å­æŸ¥è¯¢ Subquery å­æŸ¥è¯¢æ„å»º\nsubq = ( select(User.id) .where(User.status == 1) ).subquery() ä¸»æŸ¥è¯¢ä½¿ç”¨\nstmt = select(Profile).where(Profile.user_id.in_(subq)) 11. exists / not exists from sqlalchemy import exists subq = select(User.id).where(User.id == Profile.user_id) stmt = select(Profile).where(exists(subq)) 12. scalar()ã€scalars()ã€mappings() è¿”å›å€¼è§£é‡Š scalar() è¿”å›å•ä¸ªå€¼ï¼Œä¾‹å¦‚ COUNTã€MAXï¼š\ncount = session.execute(select(func.count()).select_from(User)).scalar() scalars() è¿”å› ORM å¯¹è±¡æˆ–å•ä¸ªåˆ—ï¼š\nnames = session.execute(select(User.name)).scalars().all() mappings() è¿”å› dict-like ç»“æ„ï¼š\nrows = session.execute(select(User.id, User.name)).mappings().all() è¿”å›ç¤ºä¾‹ï¼š\n[{\u0026#39;id\u0026#39;: 1, \u0026#39;name\u0026#39;: \u0026#39;martin\u0026#39;}] 13. å¤šæ¡ä»¶åŠ¨æ€æ„å»ºæŸ¥è¯¢ï¼ˆå®æˆ˜æœ€å¸¸ç”¨ï¼‰ filters = [] if status is not None: filters.append(User.status == status) if keyword: filters.append(User.name.like(f\u0026#34;%{keyword}%\u0026#34;)) stmt = select(User).where(*filters) 14. ORM æ¨¡å‹ä¸ SQL æ‹¼æ¥è¾“å‡º SQL print(stmt) æˆ–è€…ï¼š\nprint(stmt.compile(compile_kwargs={\u0026#34;literal_binds\u0026#34;: True})) 15. AsyncSessionï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰ åŒæ­¥åªéœ€æ¢æˆ async ç‰ˆæœ¬ï¼š\nresult = await session.execute(stmt) rows = result.scalars().all() å®Œæ•´ç¤ºä¾‹ï¼š\nasync with async_session() as session: stmt = select(User).where(User.status == 1) result = await session.execute(stmt) users = result.scalars().all() ğŸ“Œ å®Œæ•´ç¤ºä¾‹ï¼šSELECT + JOIN + åˆ†é¡µ + æ’åº + æœç´¢ stmt = ( select(User.id, User.name, Profile.age) .join(Profile, Profile.user_id == User.id) .where( User.status == 1, User.name.like(f\u0026#34;%{keyword}%\u0026#34;), ) .order_by(User.id.desc()) .limit(10) .offset(0) ) rows = session.execute(stmt).mappings().all() ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ SQLAlchemy 2.0 ORM select() æœ€æ¸…æ™°ã€æœ€å®Œæ•´ã€æœ€å®æˆ˜çš„æ•™ç¨‹ï¼Œæ¶µç›–åŸºç¡€ã€è¿›é˜¶ã€JOINã€è¿‡æ»¤ã€å¤šè¡¨ã€åˆ†é¡µã€èšåˆã€å­æŸ¥è¯¢ã€è¿”å›å€¼å¤„ç†ç­‰å†…å®¹ã€‚\nå†…å®¹ç»è¿‡æ•´ç†ï¼Œå®Œå…¨é€‚é… SQLAlchemy 2.0ï¼ˆsync + async é€šç”¨ï¼‰ã€‚\n1. åŸºç¡€ï¼šæœ€ç®€å•çš„ select from sqlalchemy import select from models import User stmt = select(User) result = session.execute(stmt).scalars().all() è¿”å›æ ¼å¼ï¼ˆORM æ¨¡å¼ï¼‰\nresult.scalars().all() -\u0026gt; list[User] 2. åªæŸ¥è¯¢éƒ¨åˆ†å­—æ®µ stmt = select(User.id, User.name) rows = session.execute(stmt).all() è¿”å›æ ¼å¼\n[(1, \u0026#34;martin\u0026#34;), (2, \u0026#34;john\u0026#34;), ...] 3. ä½¿ç”¨è¿‡æ»¤æ¡ä»¶ï¼ˆ=ã€\u0026gt;ã€\u0026lt;ã€LIKEã€INï¼‰ 3.1 ç­‰äº stmt = select(User).where(User.status == 1) 3.2 å¤šæ¡ä»¶ AND stmt = select(User).where( User.age \u0026gt; 18, User.status == 1 ) 3.3 OR æ¡ä»¶ from sqlalchemy import or_ stmt = select(User).where( or_(User.age \u0026lt; 18, User.status == 0) ) 3.4 IN stmt = select(User).where(User.id.in_([1, 2, 3])) 3.5 LIKE stmt = select(User).where(User.name.like(\u0026#34;%martin%\u0026#34;)) 4. æ’åº ORDER BY stmt = select(User).order_by(User.id.desc()) 5. åˆ†é¡µ LIMIT OFFSET stmt = ( select(User) .order_by(User.id.desc()) .limit(10) .offset(0) ) 6. JOINï¼ˆæœ€å¸¸ç”¨ï¼‰ å†…è¿æ¥ JOIN\n"},{"id":425,"href":"/backend/python/official/set/","title":"Set (é›†åˆ)","parent":"Official","content":"set æ˜¯ Python ä¸­ æ— åºã€å…ƒç´ å”¯ä¸€ã€å¯å˜ çš„æ•°æ®ç»“æ„ï¼Œåº•å±‚åŸºäº å“ˆå¸Œè¡¨\n-\u0026gt; æ’å…¥ / åˆ é™¤ / æŸ¥æ‰¾ éƒ½æ˜¯ O(1) æ—¶é—´å¤æ‚åº¦ã€‚\n1ï¸âƒ£ set çš„åˆ›å»ºæ–¹å¼ s = {1, 2, 3} # å­—é¢é‡ s = set([1, 2, 3]) # ä»åˆ—è¡¨åˆ›å»º s = set(\u0026#34;hello\u0026#34;) # {\u0026#39;h\u0026#39;, \u0026#39;e\u0026#39;, \u0026#39;l\u0026#39;, \u0026#39;o\u0026#39;} s = set() # ç©ºé›†åˆï¼Œå¿…é¡»è¿™æ ·å†™ æ³¨æ„ï¼š{} åˆ›å»ºçš„æ˜¯ dictï¼Œè€Œä¸æ˜¯ setã€‚\n2ï¸âƒ£ set çš„æ ¸å¿ƒç‰¹ç‚¹ ç‰¹æ€§ è¯´æ˜ æ— åº ä¸ä¿è¯é¡ºåº å”¯ä¸€æ€§ è‡ªåŠ¨å»é‡ å¯å˜ å¯æ–°å¢ã€åˆ é™¤å…ƒç´  å…ƒç´ å¿…é¡»å¯å“ˆå¸Œï¼ˆä¸å¯å˜ï¼‰ list/dict ä¸èƒ½æ”¾å…¥ set ç¤ºä¾‹ï¼š\n{1, 2, 2, 3} # {1, 2, 3} 3ï¸âƒ£ å¢åˆ æ”¹æŸ¥æ“ä½œï¼ˆCRUDï¼‰ â¤ æ·»åŠ å…ƒç´  s.add(4) â¤ åˆ é™¤å…ƒç´  æ–¹æ³• ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼Ÿ ç¤ºä¾‹ remove(x) âŒ ä¼šæŠ¥é”™ s.remove(3) discard(x) âœ… ä¸æŠ¥é”™ s.discard(3) pop() éšæœºåˆ é™¤å¹¶è¿”å› s.pop() â¤ æ¸…ç©º s.clear() 4ï¸âƒ£ set çš„æ•°å­¦è¿ç®—ï¼ˆğŸ”¥æœ€å¸¸ç”¨ï¼‰ â‘  äº¤é›†ï¼ˆâˆ©ï¼‰ a \u0026amp; b a.intersection(b) â‘¡ å¹¶é›†ï¼ˆâˆªï¼‰ a | b a.union(b) â‘¢ å·®é›†ï¼ˆâˆ’ï¼‰ a - b a.difference(b) â‘£ å¯¹ç§°å·®é›†ï¼ˆ^ï¼‰ ä¸¤è€…ä¸åŒçš„å…ƒç´ \na ^ b a.symmetric_difference(b) 5ï¸âƒ£ åˆ¤æ–­å…³ç³» æ“ä½œ å«ä¹‰ ç¤ºä¾‹ issubset() a âŠ† b a.issubset(b) issuperset() a âŠ‡ b a.issuperset(b) isdisjoint() æ— äº¤é›† a.isdisjoint(b) ç¤ºä¾‹ï¼š\n{1,2}.issubset({1,2,3}) # True 6ï¸âƒ£ set çš„é›†åˆæ¨å¯¼å¼ï¼ˆå¸¸ç”¨ï¼‰ s = {x * 2 for x in [1, 2, 3]} # {2, 4, 6} 7ï¸âƒ£ å†»ç»“é›†åˆï¼ˆä¸å¯å˜ setï¼‰ fs = frozenset({1, 2, 3}) ç‰¹ç‚¹ï¼š\nç‰¹æ€§ frozenset å¯å“ˆå¸Œ âœ… å¯ä½œä¸º dict key âœ… å¯ä½œä¸º set å…ƒç´  âœ… å¯ä¿®æ”¹ âŒ 8ï¸âƒ£ å¸¸è§ä½¿ç”¨åœºæ™¯ï¼ˆå·¥ç¨‹ä¸­éå¸¸å¸¸ç”¨ï¼‰ 1. å»é‡åˆ—è¡¨ï¼ˆé«˜æ€§èƒ½ï¼‰ uniq = list(set(my_list)) 2. åˆ¤æ–­æ˜¯å¦å­˜åœ¨ â€”â€” O(1) if item in my_set: ... 3. å»é‡åŒæ—¶ä¿æŒé¡ºåº ï¼ˆset ä¸ä¿è¯é¡ºåºï¼Œä½†å¯ä»¥è¿™ä¹ˆå†™ï¼‰\nseen = set() result = [x for x in items if not (x in seen or seen.add(x))] 4. åˆ¤æ–­ä¸¤ä¸ªé›†åˆæ˜¯å¦é‡å  if not a.isdisjoint(b): ... 5. é«˜é€Ÿè¿‡æ»¤æ•°æ®ï¼ˆéå¸¸å¸¸ç”¨äºé‡‘èæ•°æ® / çˆ¬è™«ï¼‰ ä¾‹å¦‚ï¼š\nvalid_codes = {\u0026#34;600001\u0026#34;, \u0026#34;600002\u0026#34;, ...} if code in valid_codes: ... 6. æ±‚å·®é›†æ‰¾å‡ºâ€œæ–°å¢â€å’Œâ€œè¢«åˆ é™¤çš„â€æ•°æ® new_items = current - old removed_items = old - current 9ï¸âƒ£ set çš„æ€§èƒ½ï¼ˆä¸ºä»€ä¹ˆå¿«ï¼Ÿï¼‰ åŸºäºå“ˆå¸Œè¡¨ï¼ˆHash Tableï¼‰ in åˆ¤æ–­ï¼šO(1) äº¤é›†/å¹¶é›†ï¼šé«˜åº¦ä¼˜åŒ–çš„ C å®ç° ğŸ”Ÿ set å¸¸è§å‘ âŒ set ä¸æ”¯æŒç´¢å¼•\ns = {1, 2, 3} s[0] # é”™è¯¯ âŒ set å†…ä¸èƒ½æ”¾åˆ—è¡¨ã€dictï¼ˆå› ä¸ºä¸å¯å“ˆå¸Œï¼‰\ns = {[1,2,3]} # TypeError âŒ set æ— é¡ºåºï¼Œä¸é€‚ç”¨äºä¿æŒé¡ºåºçš„åœºæ™¯\nğŸ† æœ€åç»™ä½ æ€»ç»“ä¸€å¼ é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ï¼‰ ç±»å‹ ç¤ºä¾‹ è¯´æ˜ åˆ›å»º set(), {1,2} ç©ºé›†å¿…é¡»ç”¨ set() æ·»åŠ  add æ·»åŠ å•ä¸ª åˆ é™¤ remove / discard æœ‰åŒºåˆ« äº¤é›† a \u0026amp; b å¸¸ç”¨ å¹¶é›† `a b` å·®é›† a - b æ‰¾å‡ºè¢«åˆ é™¤å…ƒç´  å¯¹ç§°å·® a ^ b æ‰¾å‡ºå˜åŒ–å…ƒç´  å­é›† issubset å…³ç³»åˆ¤æ–­ ä¸å¯å˜ frozenset å¯åš dict key åˆ¤æ–­å­˜åœ¨ x in set O(1) ","description":"set æ˜¯ Python ä¸­ æ— åºã€å…ƒç´ å”¯ä¸€ã€å¯å˜ çš„æ•°æ®ç»“æ„ï¼Œåº•å±‚åŸºäº å“ˆå¸Œè¡¨\n-\u0026gt; æ’å…¥ / åˆ é™¤ / æŸ¥æ‰¾ éƒ½æ˜¯ O(1) æ—¶é—´å¤æ‚åº¦ã€‚\n1ï¸âƒ£ set çš„åˆ›å»ºæ–¹å¼ s = {1, 2, 3} # å­—é¢é‡ s = set([1, 2, 3]) # ä»åˆ—è¡¨åˆ›å»º s = set(\u0026#34;hello\u0026#34;) # {\u0026#39;h\u0026#39;, \u0026#39;e\u0026#39;, \u0026#39;l\u0026#39;, \u0026#39;o\u0026#39;} s = set() # ç©ºé›†åˆï¼Œå¿…é¡»è¿™æ ·å†™ æ³¨æ„ï¼š{} åˆ›å»ºçš„æ˜¯ dictï¼Œè€Œä¸æ˜¯ setã€‚\n2ï¸âƒ£ set çš„æ ¸å¿ƒç‰¹ç‚¹ ç‰¹æ€§ è¯´æ˜ æ— åº ä¸ä¿è¯é¡ºåº å”¯ä¸€æ€§ è‡ªåŠ¨å»é‡ å¯å˜ å¯æ–°å¢ã€åˆ é™¤å…ƒç´  å…ƒç´ å¿…é¡»å¯å“ˆå¸Œï¼ˆä¸å¯å˜ï¼‰ list/dict ä¸èƒ½æ”¾å…¥ set ç¤ºä¾‹ï¼š\n"},{"id":426,"href":"/backend/python/official/sort/","title":"Sort (æ’åº)","parent":"Official","content":" ğŸ¯ 1. Python sort æ˜¯ä»€ä¹ˆï¼Ÿ Python æœ‰ä¸¤ç§æ’åºï¼š\nlist.sort() åŸåœ°æ’åºï¼ˆin-placeï¼‰ æ”¹å˜åŸåˆ—è¡¨ è¿”å›å€¼æ°¸è¿œæ˜¯ None sorted(iterable) è¿”å›ä¸€ä¸ªæ–°åˆ—è¡¨ åŸå¯¹è±¡ä¸å˜ï¼ˆé€‚ç”¨äº tupleã€dict keys ç­‰ä¸å¯å˜åºåˆ—ï¼‰ ğŸŸ¦ 2. æœ€å¸¸ç”¨ç¤ºä¾‹ åŸåœ°æ’åºï¼ˆå‡åºï¼‰ data = [5, 1, 3] data.sort() # data = [1, 3, 5] è¿”å›æ–°åˆ—è¡¨ï¼ˆæ¨èï¼‰ data = [5, 1, 3] new_list = sorted(data) # new_list = [1, 3, 5] ğŸŸ© 3. é™åºæ’åºï¼ˆreverse=Trueï¼‰ sorted(data, reverse=True) ç­‰ä»·äºï¼š\ndata.sort(reverse=True) ğŸŸ¦ 4. key å‡½æ•°æ’åºï¼ˆæœ€é‡è¦ï¼‰ sort å’Œ sorted å‡æ”¯æŒï¼š\nsorted(data, key=å‡½æ•°) ç¤ºä¾‹ï¼šæŒ‰ç…§å­—ç¬¦ä¸²é•¿åº¦æ’åº\nwords = [\u0026#34;apple\u0026#34;, \u0026#34;a\u0026#34;, \u0026#34;python\u0026#34;, \u0026#34;hi\u0026#34;] sorted(words, key=len) ç¤ºä¾‹ï¼šæŒ‰ç…§å­—å…¸å­—æ®µæ’åº\ndata = [ {\u0026#34;name\u0026#34;: \u0026#34;jack\u0026#34;, \u0026#34;age\u0026#34;: 20}, {\u0026#34;name\u0026#34;: \u0026#34;lucy\u0026#34;, \u0026#34;age\u0026#34;: 18}, ] sorted(data, key=lambda x: x[\u0026#34;age\u0026#34;]) ğŸŸ© 5. å¤šå­—æ®µæ’åºï¼ˆæœ€å®ç”¨ï¼‰ æŒ‰ age å‡åºï¼Œå†æŒ‰ name å‡åº\nsorted(data, key=lambda x: (x[\u0026#34;age\u0026#34;], x[\u0026#34;name\u0026#34;])) æŒ‰ age å‡åºï¼Œä½† name é€†åº\nsorted(data, key=lambda x: (x[\u0026#34;age\u0026#34;], -ord(x[\u0026#34;name\u0026#34;][0]))) æ›´ä¼˜é›…æ–¹å¼ï¼š\nsorted(data, key=lambda x: (x[\u0026#34;age\u0026#34;], x[\u0026#34;name\u0026#34;]), reverse=False) ä½† reverse=True ä¼šç»™æ‰€æœ‰å­—æ®µå€’åºï¼Œä¸æ¨èç”¨äºå¤šå­—æ®µé€†åºã€‚\nğŸŸ¦ 6. æ’åºå¤æ‚å¯¹è±¡ï¼ˆä¾‹å¦‚ç±»ï¼‰ class User: def __init__(self, name, score): self.name = name self.score = score users = [ User(\u0026#34;a\u0026#34;, 80), User(\u0026#34;b\u0026#34;, 60), ] sorted(users, key=lambda u: u.score) ğŸŸ© 7. ä½¿ç”¨ operatorï¼ˆæ›´å¿«æ›´ä¼˜é›…ï¼‰ from operator import itemgetter, attrgetter å¯¹ dict æ’åºï¼ˆæ¯” lambda å¿«ï¼‰\nsorted(data, key=itemgetter(\u0026#34;age\u0026#34;)) å¯¹å¯¹è±¡æ’åº\nsorted(users, key=attrgetter(\u0026#34;score\u0026#34;)) ğŸŸ¦ 8. å¯¹ä¸­æ–‡æ’åºï¼ˆæ‹¼éŸ³ï¼‰ import locale locale.setlocale(locale.LC_ALL, \u0026#34;zh_CN.UTF-8\u0026#34;) sorted(names, key=locale.strxfrm) ğŸŸ© 9. è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼ˆå¾ˆå°‘ç”¨ï¼Œä½†å¼ºå¤§ï¼‰ ä½¿ç”¨ functools.cmp_to_keyï¼š\nfrom functools import cmp_to_key def cmp(a, b): if a[\u0026#34;score\u0026#34;] \u0026gt; b[\u0026#34;score\u0026#34;]: return -1 if a[\u0026#34;score\u0026#34;] \u0026lt; b[\u0026#34;score\u0026#34;]: return 1 return 0 sorted(data, key=cmp_to_key(cmp)) ğŸŸ¦ 10. sort ä¸è¿”å›å€¼ï¼å¸¸è§å‘ é”™è¯¯ï¼š\nresult = data.sort() # None! æ­£ç¡®ï¼š\ndata.sort() # or result = sorted(data) ğŸŸ© 11. å¯¹åµŒå¥—ç»“æ„æ’åº data = { \u0026#34;items\u0026#34;: [ {\u0026#34;code\u0026#34;: \u0026#34;600001\u0026#34;, \u0026#34;score\u0026#34;: 12}, {\u0026#34;code\u0026#34;: \u0026#34;000005\u0026#34;, \u0026#34;score\u0026#34;: 20}, ] } sorted_items = sorted(data[\u0026#34;items\u0026#34;], key=lambda x: x[\u0026#34;score\u0026#34;], reverse=True) ğŸŸ¦ 12. å¯¹ tuple åˆ—è¡¨æ’åº pairs = [(3, \u0026#34;a\u0026#34;), (1, \u0026#34;c\u0026#34;), (2, \u0026#34;b\u0026#34;)] sorted(pairs) # é»˜è®¤æŒ‰ç¬¬1ä¸ªï¼Œå†æŒ‰ç¬¬2ä¸ªå­—æ®µ ğŸŸ© 13. å®æˆ˜ï¼šæ’åºè‚¡ç¥¨ä»£ç  æŒ‰æ•°å­—æ’åºï¼ˆå­—ç¬¦ä¸²è½¬æ•´æ•°ï¼‰\nsorted(codes, key=lambda x: int(x)) åªæŒ‰å‰ä¸¤ä½ï¼ˆè¡Œä¸šåˆ†ç±»å¸¸ç”¨ï¼‰\nsorted(codes, key=lambda x: x[:2]) ğŸŸ¦ 14. å®æˆ˜ï¼šè‚¡ç¥¨æ•°æ®æŒ‰æ¶¨è·Œå¹…æ’åº sorted(data, key=lambda x: x[\u0026#34;change\u0026#34;], reverse=True) ğŸŸ¦ 15. sort vs sorted æ€»ç»“å¯¹æ¯”ï¼ˆæ”¶è—ï¼‰ åŠŸèƒ½ list.sort() sorted() æ˜¯å¦è¿”å›æ–°å¯¹è±¡ âŒ å¦ âœ… æ˜¯ æ˜¯å¦ä¿®æ”¹åŸå¯¹è±¡ âœ… æ˜¯ âŒ å¦ æ˜¯å¦é€‚ç”¨äºä»»æ„ iterable âŒ å¦ âœ… æ˜¯ æ¨èåœºæ™¯ é•¿åˆ—è¡¨é«˜æ€§èƒ½æ’åº ä»»ä½•æ’åºåœºæ™¯ ğŸŸ© 16. è¶…ç®€é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰ ä»»åŠ¡ å†™æ³• å‡åºæ’åº sorted(data) é™åºæ’åº sorted(data, reverse=True) æŒ‰å­—æ®µæ’åº sorted(data, key=lambda x: x[\u0026quot;k\u0026quot;]) å¤šå­—æ®µæ’åº sorted(data, key=lambda x: (x[\u0026quot;a\u0026quot;], x[\u0026quot;b\u0026quot;])) æ’åºå¯¹è±¡ sorted(users, key=lambda u: u.age) æ›´é«˜æ€§èƒ½æ’åº itemgetter/attrgetter è‡ªå®šä¹‰æ¯”è¾ƒè§„åˆ™ cmp_to_key åŸåœ°æ’åº data.sort() ","description":" ğŸ¯ 1. Python sort æ˜¯ä»€ä¹ˆï¼Ÿ Python æœ‰ä¸¤ç§æ’åºï¼š\nlist.sort() åŸåœ°æ’åºï¼ˆin-placeï¼‰ æ”¹å˜åŸåˆ—è¡¨ è¿”å›å€¼æ°¸è¿œæ˜¯ None sorted(iterable) è¿”å›ä¸€ä¸ªæ–°åˆ—è¡¨ åŸå¯¹è±¡ä¸å˜ï¼ˆé€‚ç”¨äº tupleã€dict keys ç­‰ä¸å¯å˜åºåˆ—ï¼‰ ğŸŸ¦ 2. æœ€å¸¸ç”¨ç¤ºä¾‹ åŸåœ°æ’åºï¼ˆå‡åºï¼‰ data = [5, 1, 3] data.sort() # data = [1, 3, 5] è¿”å›æ–°åˆ—è¡¨ï¼ˆæ¨èï¼‰ data = [5, 1, 3] new_list = sorted(data) # new_list = [1, 3, 5] ğŸŸ© 3. é™åºæ’åºï¼ˆreverse=Trueï¼‰ sorted(data, reverse=True) ç­‰ä»·äºï¼š\n"},{"id":427,"href":"/database/postgres/slow-search/","title":"SQL æŸ¥è¯¢å¾ˆæ…¢ï¼Œå¦‚ä½•æ’æŸ¥æ˜¯å¦æ˜¯ç¡¬ä»¶çš„é—®é¢˜ï¼Ÿ","parent":"PostgreSQL","content":"å†…å®¹ï¼šåˆ¤æ–­è·¯å¾„ -\u0026gt; å…·ä½“æ‰‹æ®µ -\u0026gt; å¯æ“ä½œæŒ‡æ ‡ -\u0026gt; ç»“è®ºæ–¹æ³•\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ SQL æ…¢ â‰  ä¸€å®šæ˜¯ç¡¬ä»¶é—®é¢˜\nä½†å¦‚æœå‡ºç°ä»¥ä¸‹ç‰¹å¾ï¼Œé«˜åº¦æ€€ç–‘æ˜¯ç¡¬ä»¶ç“¶é¢ˆï¼š\nåŒä¸€ SQLï¼ŒEXPLAIN è®¡åˆ’åˆç† æ‰§è¡Œæ—¶é—´ä¸ç¨³å®šï¼ˆæŠ–åŠ¨ï¼‰ CPU / IO / å†…å­˜ æŸä¸€é¡¹æŒç»­æ‰“æ»¡ æ•°æ®é‡æ²¡å˜ï¼Œä½† çªç„¶å˜æ…¢ äºŒã€æ’æŸ¥æ€»è·¯å¾„ï¼ˆå¼ºçƒˆå»ºè®®ç…§è¿™ä¸ªé¡ºåºï¼‰ SQL æ…¢ â†“ EXPLAIN ANALYZE æ˜¯å¦æ­£å¸¸ï¼Ÿ â†“ æ•°æ®åº“ç­‰å¾…äº‹ä»¶ï¼Ÿ â†“ CPU / å†…å­˜ / IO æŒ‡æ ‡ â†“ æ–‡ä»¶ç³»ç»Ÿ / ç£ç›˜ â†“ è™šæ‹ŸåŒ– / äº‘å®¿ä¸»æœº ä¸‰ã€ç¬¬ä¸€æ­¥ï¼šæ’é™¤ SQL / ç´¢å¼•é—®é¢˜ï¼ˆå¿…é¡»ï¼‰ 1ï¸âƒ£ EXPLAIN ANALYZE EXPLAIN (ANALYZE, BUFFERS) SELECT ...; å…³é”®åˆ¤æ–­ç‚¹\nç°è±¡ è¯´æ˜ Seq Scan æ‰«æç™¾ä¸‡è¡Œ ç´¢å¼•é—®é¢˜ Rows é¢„ä¼° vs å®é™…å·®å¼‚å·¨å¤§ ç»Ÿè®¡ä¿¡æ¯é—®é¢˜ Execution Time é«˜ å¯èƒ½ç¡¬ä»¶ Planning Time å¾ˆä½ æ­£å¸¸ çœ‹ BUFFERSï¼ˆå…³é”®ï¼‰\nBuffers: shared hit=120000 read=50000 hit é«˜ -\u0026gt; å†…å­˜å‘½ä¸­ read é«˜ -\u0026gt; ç£ç›˜ IO å‹åŠ› ğŸ‘‰ read é«˜ = æ€€ç–‘ç£ç›˜\nå››ã€ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“å†…éƒ¨ç­‰å¾…äº‹ä»¶ï¼ˆæ ¸å¿ƒï¼‰ æŸ¥çœ‹å½“å‰æ…¢æŸ¥è¯¢åœ¨ç­‰ä»€ä¹ˆ\nSELECT pid, wait_event_type, wait_event, state, query FROM pg_stat_activity WHERE state != \u0026#39;idle\u0026#39;; é‡ç‚¹çœ‹ï¼š\nwait_event_type å«ä¹‰ IO ç£ç›˜ç“¶é¢ˆ CPU è®¡ç®—ç“¶é¢ˆ Lock é”ç­‰å¾… LWLock å†…éƒ¨èµ„æºäº‰ç”¨ Client å®¢æˆ·ç«¯æ…¢ ğŸ‘‰ å¤§é‡ IO = ç¡¬ä»¶æˆ–å‚æ•°é—®é¢˜\näº”ã€ç¬¬ä¸‰æ­¥ï¼šCPU æ˜¯å¦ç“¶é¢ˆï¼Ÿ 1ï¸âƒ£ çœ‹ PostgreSQL è¿›ç¨‹ CPU top -Hp $(pidof postgres) åˆ¤æ–­ï¼š\nç°è±¡ ç»“è®º å•æ ¸ 100% SQL å•çº¿ç¨‹ æ‰€æœ‰æ ¸ 100% CPU ä¸å¤Ÿ load é«˜ï¼ŒCPU ä½ IO wait 2ï¸âƒ£ vmstatï¼ˆéå¸¸æœ‰ç”¨ï¼‰ vmstat 1 é‡ç‚¹åˆ—ï¼š\nåˆ— å«ä¹‰ us ç”¨æˆ·æ€ CPU sy å†…æ ¸æ€ wa IO wait ğŸ‘‰ wa \u0026gt; 20% = IO ç“¶é¢ˆ\nå…­ã€ç¬¬å››æ­¥ï¼šå†…å­˜æ˜¯å¦ä¸è¶³ï¼Ÿ 1ï¸âƒ£ çœ‹æ˜¯å¦é¢‘ç¹ç£ç›˜è¯» SELECT sum(blks_read) AS disk_read, sum(blks_hit) AS cache_hit FROM pg_stat_database; å‘½ä¸­ç‡è®¡ç®—\nhit_ratio = hit / (hit + read) ğŸ‘‰ \u0026lt; 99%ï¼Œè¯´æ˜å†…å­˜ä¸è¶³æˆ–å‚æ•°ä¸åˆç†\n2ï¸âƒ£ Linux å†…å­˜ free -h å…³æ³¨ï¼š\næ˜¯å¦é¢‘ç¹ swap cache æ˜¯å¦è¢«å›æ”¶ vmstat 1 si / so \u0026gt; 0 -\u0026gt; ç¾éš¾\nä¸ƒã€ç¬¬äº”æ­¥ï¼šç£ç›˜ IO æ˜¯å¦ç“¶é¢ˆï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ iostatï¼ˆå¿…é¡»ä¼šï¼‰ iostat -x 1 é‡ç‚¹çœ‹ï¼š\næŒ‡æ ‡ è¯´æ˜ %util \u0026gt;80% é¥±å’Œ await \u0026gt;20ms æ…¢ svctm æœåŠ¡æ—¶é—´ r/s w/s è¯»å†™é‡ ğŸ‘‰ %util 100% = ç£ç›˜æ‰“æ»¡\n2ï¸âƒ£ PostgreSQL ä¾§è¯æ® SELECT * FROM pg_stat_bgwriter; checkpoints é¢‘ç¹ buffers_backend é«˜ ğŸ‘‰ IO å‹åŠ›\nå…«ã€ç¬¬å…­æ­¥ï¼šæ–‡ä»¶ç³»ç»Ÿ / å­˜å‚¨é—®é¢˜ å¸¸è§å‘\né—®é¢˜ åæœ ext4 æœªè°ƒä¼˜ fsync æ…¢ NFS WAL ææ…¢ äº‘ç›˜ IOPS é™åˆ¶ æŠ–åŠ¨ RAID5 å†™å…¥æ…¢ WAL å•ç‹¬ç›˜ï¼Ÿ\ndf -h ğŸ‘‰ WAL å’Œ data åœ¨ä¸€èµ· = é£é™©\nä¹ã€è™šæ‹ŸåŒ– / äº‘ç¯å¢ƒï¼ˆæœ€å®¹æ˜“è¢«å¿½ç•¥ï¼‰ äº‘ä¸»æœºå…¸å‹é—®é¢˜\né‚»å±… IO å¹²æ‰° çªå‘å‹å®ä¾‹ç”¨å®Œ credit å­˜å‚¨é™é€Ÿ åˆ¤æ–­æ–¹æ³•\nåŒä¸€ SQL æ‰§è¡Œæ—¶é—´ä¸ç¨³å®š å¤œé—´æ›´å¿«ï¼Œç™½å¤©æ›´æ…¢ åã€å¦‚ä½•â€œç¡®è®¤å°±æ˜¯ç¡¬ä»¶é—®é¢˜â€ï¼Ÿï¼ˆç»“è®ºæ³•ï¼‰ æ»¡è¶³ â‰¥3 æ¡ï¼Œå‡ ä¹å¯ä»¥å®šæ€§ï¼š\nâœ… SQL è®¡åˆ’åˆç† âœ… ç´¢å¼•é½å…¨ âœ… BUFFERS read é«˜ âœ… wait_event_type = IO âœ… iostat %util â‰ˆ 100% âœ… vmstat wa é«˜ âœ… CPU æœªæ»¡ä½†æ…¢ ğŸ‘‰ ç»“è®ºï¼šç¡¬ä»¶ç“¶é¢ˆï¼ˆç£ç›˜ / å†…å­˜ / äº‘ç›˜ï¼‰\nåä¸€ã€ç¡¬ä»¶é—®é¢˜ vs å‚æ•°é—®é¢˜ï¼ˆå¯¹ç…§è¡¨ï¼‰ ç°è±¡ æ›´å¯èƒ½ IO ç­‰å¾…é«˜ ç£ç›˜ cache å‘½ä¸­ä½ å†…å­˜ checkpoint é¢‘ç¹ å‚æ•° load é«˜ CPU ä½ IO æŸ¥è¯¢æŠ–åŠ¨ å­˜å‚¨ åäºŒã€æœ€åç»™ä½ ä¸€ä¸ªâ€œæ’æŸ¥å£è¯€â€ å…ˆ SQL -\u0026gt; å†ç­‰å¾… -\u0026gt; çœ‹ IO -\u0026gt; æŸ¥ CPU -\u0026gt; æ ¸å†…å­˜ -\u0026gt; ç›˜æ€§èƒ½\n","description":"å†…å®¹ï¼šåˆ¤æ–­è·¯å¾„ -\u0026gt; å…·ä½“æ‰‹æ®µ -\u0026gt; å¯æ“ä½œæŒ‡æ ‡ -\u0026gt; ç»“è®ºæ–¹æ³•\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ SQL æ…¢ â‰  ä¸€å®šæ˜¯ç¡¬ä»¶é—®é¢˜\nä½†å¦‚æœå‡ºç°ä»¥ä¸‹ç‰¹å¾ï¼Œé«˜åº¦æ€€ç–‘æ˜¯ç¡¬ä»¶ç“¶é¢ˆï¼š\nåŒä¸€ SQLï¼ŒEXPLAIN è®¡åˆ’åˆç† æ‰§è¡Œæ—¶é—´ä¸ç¨³å®šï¼ˆæŠ–åŠ¨ï¼‰ CPU / IO / å†…å­˜ æŸä¸€é¡¹æŒç»­æ‰“æ»¡ æ•°æ®é‡æ²¡å˜ï¼Œä½† çªç„¶å˜æ…¢ äºŒã€æ’æŸ¥æ€»è·¯å¾„ï¼ˆå¼ºçƒˆå»ºè®®ç…§è¿™ä¸ªé¡ºåºï¼‰ SQL æ…¢ â†“ EXPLAIN ANALYZE æ˜¯å¦æ­£å¸¸ï¼Ÿ â†“ æ•°æ®åº“ç­‰å¾…äº‹ä»¶ï¼Ÿ â†“ CPU / å†…å­˜ / IO æŒ‡æ ‡ â†“ æ–‡ä»¶ç³»ç»Ÿ / ç£ç›˜ â†“ è™šæ‹ŸåŒ– / äº‘å®¿ä¸»æœº ä¸‰ã€ç¬¬ä¸€æ­¥ï¼šæ’é™¤ SQL / ç´¢å¼•é—®é¢˜ï¼ˆå¿…é¡»ï¼‰ 1ï¸âƒ£ EXPLAIN ANALYZE EXPLAIN (ANALYZE, BUFFERS) SELECT ...; å…³é”®åˆ¤æ–­ç‚¹\n"},{"id":428,"href":"/backend/python/sqlalchemy/","title":"SQLAlchemy","parent":"Python","content":"å®˜æ–¹æ–‡æ¡£:\nSQLAlchemy 2.0 æ–‡æ¡£ SQLAlchemy ç»Ÿä¸€æ•™ç¨‹ SQLAlchemy ORM SQLAlchemy Core å‚è€ƒæ–‡æ¡£:\nSQLAlchemy 2.0 ä¸­æ–‡æ–‡æ¡£ SQLAlchemy å¦‚ä½•è·å¾—ä¸€è¡Œä¸­çš„æ‰€æœ‰æ•°æ® Directory List:\nSQLAlchemy åŸºç¡€æ•™ç¨‹ Engine Insert Result Select åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ æ•°æ®å½¢æ€ ","description":"å®˜æ–¹æ–‡æ¡£:\nSQLAlchemy 2.0 æ–‡æ¡£ SQLAlchemy ç»Ÿä¸€æ•™ç¨‹ SQLAlchemy ORM SQLAlchemy Core å‚è€ƒæ–‡æ¡£:\nSQLAlchemy 2.0 ä¸­æ–‡æ–‡æ¡£ SQLAlchemy å¦‚ä½•è·å¾—ä¸€è¡Œä¸­çš„æ‰€æœ‰æ•°æ® Directory List:\nSQLAlchemy åŸºç¡€æ•™ç¨‹ Engine Insert Result Select åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ æ•°æ®å½¢æ€ "},{"id":429,"href":"/backend/python/official/string/","title":"String (å­—ç¬¦ä¸²)","parent":"Official","content":"Python str æ˜¯ ä¸å¯å˜å¯¹è±¡ï¼ˆimmutableï¼‰ï¼ŒåŸºäº Unicodeã€‚\n1. å­—ç¬¦ä¸²åŸºç¡€ç‰¹ç‚¹ ä¸å¯å˜ ä¿®æ”¹å­—ç¬¦ä¸²ä¼šäº§ç”Ÿæ–°å¯¹è±¡ã€‚\nUnicode æ–‡æœ¬ å¤©ç„¶æ”¯æŒä¸­æ–‡ã€Emoji ç­‰ã€‚\nsequence ç±»å‹ æ”¯æŒåˆ‡ç‰‡ã€ç´¢å¼•ã€lenã€inã€‚\n2. å¸¸ç”¨åˆ›å»ºæ–¹å¼ s = \u0026#34;hello\u0026#34; s = \u0026#39;hello\u0026#39; s = \u0026#34;\u0026#34;\u0026#34;å¤šè¡Œ å­—ç¬¦ä¸²\u0026#34;\u0026#34;\u0026#34; s = str(123) 3. åŸºæœ¬æ“ä½œ é•¿åº¦\nlen(s) ç´¢å¼•/åˆ‡ç‰‡\ns[0] s[-1] s[1:5] s[::-1] # åè½¬ æ‹¼æ¥\na + b \u0026#34; \u0026#34;.join(list_of_words) 4. æŸ¥æ‰¾ä¸åˆ¤æ–­ s.startswith(\u0026#34;abc\u0026#34;) # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»¥ prefix å¼€å¤´ s.endswith(\u0026#34;xyz\u0026#34;) # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»¥ suffix ç»“å°¾ s.find(\u0026#34;hello\u0026#34;) # æŸ¥æ‰¾å­å­—ç¬¦ä¸² sub åœ¨ s ä¸­é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ã€‚ # å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹çš„ç´¢å¼•ã€‚ # å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å› -1 s.index(\u0026#34;hello\u0026#34;) # ä¸ s.find(sub) ç±»ä¼¼ï¼ŒæŸ¥æ‰¾å­å­—ç¬¦ä¸² sub åœ¨ s ä¸­é¦–æ¬¡å‡ºç°çš„ç´¢å¼•ã€‚ # å¦‚æœæ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹çš„ç´¢å¼•ã€‚ # å¦‚æœæ‰¾ä¸åˆ°ï¼Œä¼šæŠ›å‡º ValueError å¼‚å¸¸ã€‚ \u0026#34;abc\u0026#34; in s # å¸ƒå°”åˆ¤æ–­ 5. å¤§å°å†™è½¬æ¢ s.upper() # å°†å­—ç¬¦ä¸² s ä¸­çš„æ‰€æœ‰å­—æ¯è½¬æ¢ä¸ºå¤§å†™ s.lower() # å°†å­—ç¬¦ä¸² s ä¸­çš„æ‰€æœ‰å­—æ¯è½¬æ¢ä¸ºå°å†™ s.title() # å°†å­—ç¬¦ä¸² s ä¸­æ¯ä¸ªå•è¯çš„é¦–å­—æ¯è½¬æ¢ä¸ºå¤§å†™ s.capitalize() # å°†å­—ç¬¦ä¸² s çš„ç¬¬ä¸€ä¸ªå­—æ¯è½¬æ¢ä¸ºå¤§å†™ s.swapcase() # äº¤æ¢å­—ç¬¦ä¸² s ä¸­æ‰€æœ‰å­—æ¯çš„å¤§å°å†™ï¼Œå¤§å†™å˜å°å†™ï¼Œå°å†™å˜å¤§å†™ 6. å»ç©ºç™½ / ä¿®å‰ªå­—ç¬¦ä¸² s.strip() # ç§»é™¤å­—ç¬¦ä¸² s é¦–å°¾çš„ç©ºç™½å­—ç¬¦ã€‚ï¼ˆå¦‚æœä¸æŒ‡å®šå‚æ•°ï¼Œé»˜è®¤ç§»é™¤æ‰€æœ‰çš„ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ç­‰ï¼‰ï¼‰ s.lstrip() # ç§»é™¤å­—ç¬¦ä¸² s å·¦ä¾§ï¼ˆå¼€å¤´ï¼‰çš„ç©ºç™½å­—ç¬¦ã€‚ï¼ˆä¸æŒ‡å®šå‚æ•°æ—¶é»˜è®¤ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼‰ s.rstrip() # ç§»é™¤å­—ç¬¦ä¸² s å³ä¾§ï¼ˆç»“å°¾ï¼‰çš„ç©ºç™½å­—ç¬¦ã€‚ï¼ˆä¸æŒ‡å®šå‚æ•°æ—¶é»˜è®¤ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼‰ s.strip(\u0026#34;xyz\u0026#34;) # ç§»é™¤å­—ç¬¦ä¸² s é¦–å°¾çš„ æŒ‡å®šå­—ç¬¦ä¸² \u0026#34;xyz\u0026#34; å­—ç¬¦ã€‚ 7. æ›¿æ¢ä¸åˆ†å‰² æ›¿æ¢\ns.replace(\u0026#34;old\u0026#34;, \u0026#34;new\u0026#34;) åˆ†å‰²\ns.split(\u0026#34;,\u0026#34;) # è¿”å› list s.splitlines() # æŒ‰è¡Œåˆ†å‰² åˆå¹¶\n\u0026#34;,\u0026#34;.join([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;]) 8. æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆè¶…é‡è¦ï¼‰ f-stringï¼ˆæ¨èï¼‰\nname = \u0026#34;martin\u0026#34; f\u0026#34;Hello {name}\u0026#34; æ”¯æŒè¡¨è¾¾å¼ï¼š\nf\u0026#34;{1+2}\u0026#34; f\u0026#34;{value:.2f}\u0026#34; format()\n\u0026#34;Hello {}, {}\u0026#34;.format(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;) \u0026#34;{name} is {age}\u0026#34;.format(name=\u0026#34;Tom\u0026#34;, age=20) ç™¾åˆ†å·æ ¼å¼ï¼ˆæ—§ï¼‰\n\u0026#34;%s %d\u0026#34; % (\u0026#34;hello\u0026#34;, 10) 9. å­—ç¬¦ä¸²åˆ¤æ–­æ–¹æ³•ï¼ˆPythonicï¼‰ s.isdigit() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»…ç”±æ•°å­—ç»„æˆ s.isalpha() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»…ç”±å­—æ¯ç»„æˆ s.isalnum() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»…ç”±å­—æ¯æˆ–æ•°å­—ç»„æˆ s.isascii() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»…åŒ…å« ASCII å­—ç¬¦ s.islower() # åˆ¤æ–­å­—ç¬¦ä¸² s ä¸­æ‰€æœ‰å­—æ¯å­—ç¬¦æ˜¯å¦éƒ½æ˜¯å°å†™ s.isupper() # åˆ¤æ–­å­—ç¬¦ä¸² s ä¸­æ‰€æœ‰å­—æ¯å­—ç¬¦æ˜¯å¦éƒ½æ˜¯å¤§å†™ s.isspace() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦ä»…ç”±ç©ºç™½å­—ç¬¦ç»„æˆ s.isidentifier() # åˆ¤æ–­å­—ç¬¦ä¸² s æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Python æ ‡è¯†ç¬¦ï¼ˆæ˜¯å¦åˆæ³•çš„å˜é‡åï¼‰ 10. æ­£åˆ™è¡¨è¾¾å¼å¸¸ç”¨ç¤ºä¾‹ import re re.match(pattern, s) # ä»å­—ç¬¦ä¸²çš„èµ·å§‹ä½ç½®åŒ¹é…ä¸€ä¸ªæ¨¡å¼ã€‚å¦‚æœå¼€å¤´ä¸åŒ¹é…ï¼Œåˆ™è¿”å› Noneã€‚ # å°è¯•ä»å­—ç¬¦ä¸² s çš„å¼€å¤´åŒ¹é… patternã€‚ re.search(pattern, s) # åœ¨æ•´ä¸ªå­—ç¬¦ä¸²ä¸­æœç´¢æ¨¡å¼ã€‚æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹åè¿”å›ï¼Œå¦åˆ™è¿”å› Noneã€‚ # åœ¨æ•´ä¸ªå­—ç¬¦ä¸² s ä¸­æœç´¢ pattern çš„ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ã€‚ re.findall(pattern, s) # æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„å­ä¸²ï¼Œå¹¶ä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›æ‰€æœ‰åŒ¹é…é¡¹ã€‚ # æŸ¥æ‰¾å¹¶è¿”å›å­—ç¬¦ä¸² s ä¸­æ‰€æœ‰ä¸ pattern åŒ¹é…çš„å­ä¸²åˆ—è¡¨ã€‚ re.sub(pattern, repl, s) # å°†å­—ç¬¦ä¸²ä¸­æ‰€æœ‰åŒ¹é…çš„å­ä¸²æ›¿æ¢ä¸ºå¦ä¸€ä¸ªå­—ç¬¦ä¸² replã€‚ # ç”¨ repl æ›¿æ¢å­—ç¬¦ä¸² s ä¸­æ‰€æœ‰ä¸ pattern åŒ¹é…çš„å­ä¸²ã€‚ ç¤ºä¾‹ æ£€æŸ¥æ‰‹æœºå·\nre.fullmatch(r\u0026#34;1\\d{10}\u0026#34;, phone) æå–æ•°å­—\nre.findall(r\u0026#34;\\d+\u0026#34;, text) 11. å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½ï¼ˆé‡ç‚¹ï¼‰ âŒ ä¸è¦è¿™æ ·åšï¼ˆæ…¢ï¼‰\ns = \u0026#34;\u0026#34; for i in range(10000): s += str(i) âœ… æ¨èä½¿ç”¨ join()\n\u0026#34;\u0026#34;.join(str(i) for i in range(10000)) join() åŸºäºä¸€æ¬¡æ€§åˆ†é…å†…å­˜ï¼Œæ•ˆç‡è¿œé«˜äºé‡å¤åˆ›å»ºå¯¹è±¡ã€‚\n12. å¤šè¡Œå­—ç¬¦ä¸²å¤„ç† ä¿ç•™æ¢è¡Œ\ncontent = \u0026#34;\u0026#34;\u0026#34;line1 line2 line3\u0026#34;\u0026#34;\u0026#34; åˆ é™¤ç¼©è¿›\nimport textwrap textwrap.dedent(\u0026#34;\u0026#34;\u0026#34; hello world \u0026#34;\u0026#34;\u0026#34;) 13. å¸¸è§å‘ âŒ s.replace() åªèƒ½æ›¿æ¢å­—é¢å†…å®¹ å¦‚æœä½ æƒ³â€œæ­£åˆ™æ›¿æ¢â€ï¼Œè¦ç”¨ re.subã€‚\nâŒ split() é»˜è®¤ä¸ä¼šä¿ç•™åˆ†éš”ç¬¦ å¦‚æœè¦ä¿ç•™ï¼š\nre.split(r\u0026#34;(,)\u0026#34;, \u0026#34;a,b,c\u0026#34;) âŒ å­—ç¬¦ä¸²ä¸å¯å˜ ä¿®æ”¹æ“ä½œä¸ä¼šåŸåœ°æ”¹å˜å­—ç¬¦ä¸²ã€‚\n14. å­—ç¬¦ä¸²ç¼–ç ï¼ˆè¿›é˜¶ï¼‰ s.encode(\u0026#34;utf-8\u0026#34;) b.decode(\u0026#34;utf-8\u0026#34;) å¸¸ç”¨ç¼–ç ï¼šUTF-8ã€GBKã€ASCIIã€‚\n15. é«˜çº§ç”¨æ³• 1) å­—ç¬¦ä¸²æ¨¡æ¿ from string import Template t = Template(\u0026#34;Hello $name\u0026#34;) t.substitute(name=\u0026#34;martin\u0026#34;) 2) å­—ç¬¦ä¸²ç¿»è½¬ reversed_s = s[::-1] 3) å­—ç¬¦é¢‘ç‡ç»Ÿè®¡ from collections import Counter Counter(s) 4) åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯å›æ–‡ s == s[::-1] 5) æå–æ•°å­— + join ç¾åŒ– \u0026#39;\u0026#39;.join(filter(str.isdigit, s)) 16. string æœ€ä½³å®è·µï¼ˆç²¾é€‰ï¼‰ ä½¿ç”¨ f-stringï¼ˆæ ¼å¼åŒ–æœ€æ¸…æ™°ï¼‰ å¤§é‡å­—ç¬¦ä¸²æ‹¼æ¥ç”¨ join() å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶å…ˆ .strip() ä½¿ç”¨æ­£åˆ™å¤„ç†å¤æ‚åŒ¹é… ç”¨ textwrap å¤„ç†å¤šè¡Œæ–‡æœ¬ é‡åˆ° ASCII åˆ¤æ–­æ—¶ç”¨ .isascii() å­—ç¬¦ä¸²æ ¼å¼åŒ– Python çš„ str.format() æ–¹æ³•é€šè¿‡åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨ {} ä½œä¸ºå ä½ç¬¦ï¼Œå¹¶ä¼ å…¥å‚æ•°æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚å®ƒå¯ä»¥é€šè¿‡ä½ç½®å‚æ•°ã€å…³é”®å­—å‚æ•°æˆ–ä¸¤è€…çš„ç»„åˆæ¥å®ç°çµæ´»çš„æ ¼å¼åŒ–ï¼Œæ”¯æŒå¯¹é½ã€å¡«å……ã€æŒ‡å®šå°æ•°ä½æ•°ã€åƒä½åˆ†éš”ç¬¦ç­‰å¤šç§æ ¼å¼æ§åˆ¶ã€‚\nåŸºæœ¬ç”¨æ³• ä½ç½®å‚æ•°: æŒ‰ç…§å‚æ•°çš„é¡ºåºæ›¿æ¢å ä½ç¬¦ã€‚ print(\u0026#34;æˆ‘å«{}ï¼Œæ¥è‡ª{}ã€‚\u0026#34;.format(\u0026#34;å°æ˜\u0026#34;, \u0026#34;åŒ—äº¬\u0026#34;)) å…³é”®å­—å‚æ•°: ä½¿ç”¨å˜é‡åä½œä¸ºå ä½ç¬¦ã€‚ print(\u0026#34;æˆ‘å«{name}ï¼Œæ¥è‡ª{city}ã€‚\u0026#34;.format(name=\u0026#34;å°æ˜\u0026#34;, city=\u0026#34;åŒ—äº¬\u0026#34;)) æ··åˆä½¿ç”¨: print(\u0026#34;æˆ‘å«{0}ï¼Œæ¥è‡ª{city}ã€‚\u0026#34;.format(\u0026#34;å°æ˜\u0026#34;, city=\u0026#34;åŒ—äº¬\u0026#34;)) æ ¼å¼è¯´æ˜ç¬¦ å¯ä»¥åœ¨ {} å ä½ç¬¦ä¸­ä½¿ç”¨å†’å· : æ¥æŒ‡å®šæ ¼å¼è¯´æ˜ç¬¦ã€‚\næ ¼å¼è¯´æ˜ç¬¦ å«ä¹‰ ç¤ºä¾‹ :\u0026lt; å·¦å¯¹é½ \u0026ldquo;{:\u0026lt;10}\u0026quot;.format(\u0026ldquo;å·¦å¯¹é½\u0026rdquo;) :\u0026gt; å³å¯¹é½ \u0026ldquo;{:\u0026gt;10}\u0026quot;.format(\u0026ldquo;å³å¯¹é½\u0026rdquo;) :^ å±…ä¸­å¯¹é½ \u0026ldquo;{:^10}\u0026quot;.format(\u0026ldquo;å±…ä¸­\u0026rdquo;) :\u0026lt;10 å·¦å¯¹é½ï¼Œå®½åº¦ä¸º 10 \u0026ldquo;{:\u0026lt;10}\u0026quot;.format(\u0026ldquo;å·¦å¯¹é½\u0026rdquo;) :\u0026lt;10s å·¦å¯¹é½ï¼Œå®½åº¦ä¸º 10ï¼Œå­—ç¬¦ä¸²ç±»å‹ \u0026ldquo;{:\u0026lt;10s}\u0026quot;.format(\u0026ldquo;å·¦å¯¹é½\u0026rdquo;) :d åè¿›åˆ¶æ•´æ•° \u0026ldquo;{:d}\u0026quot;.format(100) :f æµ®ç‚¹æ•° \u0026ldquo;{:.2f}\u0026quot;.format(3.14159) (ä¿ç•™ä¸¤ä½å°æ•°) :e ç§‘å­¦è®¡æ•°æ³•ï¼ˆå°å†™ eï¼‰ \u0026ldquo;{:.2e}\u0026quot;.format(1000000) :b äºŒè¿›åˆ¶ \u0026ldquo;{:b}\u0026quot;.format(10) :o å…«è¿›åˆ¶ \u0026ldquo;{:o}\u0026quot;.format(10) :x åå…­è¿›åˆ¶ï¼ˆå°å†™ï¼‰ \u0026ldquo;{:x}\u0026quot;.format(255) :+ æ˜¾ç¤ºæ­£è´Ÿå· \u0026ldquo;{:+f}\u0026quot;.format(10) : æ­£æ•°å‰åŠ ç©ºæ ¼ \u0026ldquo;{: f}\u0026quot;.format(10) :, åƒä½åˆ†éš”ç¬¦ \u0026ldquo;{:,}\u0026quot;.format(1000000) {{ è¾“å‡ºä¸€ä¸ª { å­—ç¬¦ \u0026ldquo;è¾“å‡º{{è¿™é‡Œæ˜¯å¤§æ‹¬å·}}\u0026rdquo; }} è¾“å‡ºä¸€ä¸ª } å­—ç¬¦ ç¤ºä¾‹ # æ ¼å¼åŒ–æµ®ç‚¹æ•° price = 123.4567 print(\u0026#34;ä»·æ ¼æ˜¯ {:.2f} å…ƒ\u0026#34;.format(price)) # è¾“å‡º: ä»·æ ¼æ˜¯ 123.46 å…ƒ # æŒ‡å®šå¯¹é½å’Œå¡«å…… text = \u0026#34;ä½ å¥½\u0026#34; print(\u0026#34;\u0026#39;{:-\u0026gt;10}\u0026#39;\u0026#34;.format(text)) # è¾“å‡º: \u0026#39;ä½ å¥½------\u0026#39; # æ ¼å¼åŒ–æ—¥æœŸï¼ˆéœ€è¦å¯¼å…¥ datetime æ¨¡å—ï¼‰ import datetime now = datetime.datetime.now() print(\u0026#34;æ—¥æœŸï¼š{:%Y-%m-%d %H:%M:%S}\u0026#34;.format(now)) # è¾“å‡ºç±»ä¼¼: æ—¥æœŸï¼š2025-11-26 10:52:56 ","description":"Python str æ˜¯ ä¸å¯å˜å¯¹è±¡ï¼ˆimmutableï¼‰ï¼ŒåŸºäº Unicodeã€‚\n1. å­—ç¬¦ä¸²åŸºç¡€ç‰¹ç‚¹ ä¸å¯å˜ ä¿®æ”¹å­—ç¬¦ä¸²ä¼šäº§ç”Ÿæ–°å¯¹è±¡ã€‚\nUnicode æ–‡æœ¬ å¤©ç„¶æ”¯æŒä¸­æ–‡ã€Emoji ç­‰ã€‚\nsequence ç±»å‹ æ”¯æŒåˆ‡ç‰‡ã€ç´¢å¼•ã€lenã€inã€‚\n"},{"id":430,"href":"/operations/linux/swap/","title":"swap","parent":"Linux","content":" ä¸€ã€swap æ˜¯ä»€ä¹ˆï¼ˆä¸è¦å†è¢«â€œè™šæ‹Ÿå†…å­˜â€å¸¦åï¼‰ 1ï¸âƒ£ swap çš„çœŸå®å®šä¹‰ swap = å†…æ ¸ç”¨äºå›æ”¶åŒ¿åé¡µï¼ˆanonymous pagesï¼‰çš„åå¤‡å­˜å‚¨\nå®ƒåªæœåŠ¡äºåŒ¿åé¡µï¼š\nè¿›ç¨‹å †ï¼ˆheapï¼‰ æ ˆï¼ˆstackï¼‰ malloc/new å‡ºæ¥çš„å†…å­˜ JVM / Python / Go runtime å†…å­˜ âŒ ä¸ç›´æ¥ç”¨äºï¼š\næ–‡ä»¶é¡µï¼ˆpage cacheï¼‰ ç£ç›˜æ˜ å°„æ–‡ä»¶ï¼ˆmmap æ–‡ä»¶ï¼‰ 2ï¸âƒ£ swap â‰  å†…å­˜æ‰©å®¹ è¯¯è§£ çœŸç›¸ swap æ˜¯æ…¢å†…å­˜ âŒ swap èƒ½å½“å†…å­˜ç”¨ âŒ swap ä¼šæ‹–æ…¢ç³»ç»Ÿ âŒ (å‰ææ˜¯æ²¡ä¹±ç”¨) æ­£ç¡®ç†è§£ï¼š\nswap æ˜¯ OOM ä¹‹å‰çš„ç¼“å†²åŒºï¼Œä¸æ˜¯ RAM çš„æ›¿ä»£å“\näºŒã€Linux å†…å­˜å›æ”¶è·¯å¾„é‡Œ swap åœ¨å“ªï¼Ÿ å†…æ ¸å›æ”¶é¡ºåºï¼ˆæç®€ç‰ˆï¼‰ï¼š\nå†…å­˜å‹åŠ› â†‘ â†“ å›æ”¶ page cache â†“ å›æ”¶ slab â†“ å›æ”¶åŒ¿åé¡µï¼ˆâ†’ swapï¼‰ â†“ OOM Killer ğŸ‘‰ æ²¡æœ‰ swapï¼ŒåŒ¿åé¡µå›æ”¶è¿™ä¸€æ­¥ç›´æ¥å¤±è´¥\nä¸‰ã€swap çš„ä¸‰ç§å½¢å¼ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ swap åˆ†åŒºï¼ˆæœ€ç¨³å®šï¼‰ /dev/sda2 swap swap defaults 0 0 âœ… ååç¨³å®š âœ… ä¸å—æ–‡ä»¶ç³»ç»Ÿå½±å“ âŒ çµæ´»æ€§å·® é€‚åˆï¼š\nè£¸æœºæ•°æ®åº“ ç‰©ç†æœåŠ¡å™¨ 2ï¸âƒ£ swap æ–‡ä»¶ï¼ˆæœ€å¸¸ç”¨ï¼‰ /data/swapfile/2G.swap âœ… å¯åŠ¨æ€è°ƒæ•´ âœ… äº‘ä¸»æœºå‹å¥½ âŒ è€å†…æ ¸å¯èƒ½ç¢ç‰‡åŒ–ï¼ˆæ–°å†…æ ¸å·²è§£å†³ï¼‰ ç°ä»£å†…æ ¸ï¼ˆâ‰¥ 4.0ï¼‰å®Œå…¨å¯ç”¨\n3ï¸âƒ£ zram / zswapï¼ˆå‹ç¼© swapï¼‰ æŠ€æœ¯ æœ¬è´¨ zram å†…å­˜é‡Œå‹ç¼© swap zswap swap å‰å‹ç¼©å±‚ âœ… å»¶è¿Ÿä½ âœ… å‡å°‘ç£ç›˜ IO é€‚åˆï¼š\nå°å†…å­˜ VPS æ¡Œé¢ å››ã€swap ä»€ä¹ˆæ—¶å€™â€œçœŸçš„è¢«ç”¨åˆ°â€ï¼Ÿ swap è§¦å‘çš„çœŸå®åœºæ™¯ å†…å­˜ç¢ç‰‡ åŒ¿åé¡µé•¿æœŸä¸è®¿é—® ç¬æ—¶å³°å€¼ fork / copy-on-write Python / JVM GC å‰ swap ä½¿ç”¨ â‰  æ€§èƒ½é—®é¢˜\nå¤§é‡ swap in/out æ‰æ˜¯é—®é¢˜\näº”ã€æ ¸å¿ƒå†…æ ¸å‚æ•°ï¼ˆå¿…é¡»æŒæ¡ï¼‰ 1ï¸âƒ£ vm.swappinessï¼ˆæœ€å¸¸è¢«è¯¯ç”¨ï¼‰ vm.swappiness = 0 ~ 200 å€¼ è¡Œä¸º 0 å‡ ä¹ä¸ç”¨ swap (ä¸æ˜¯å®Œå…¨ä¸ç”¨) 1 ä»…ä½œä¸ºå®‰å…¨é˜€ (æ¨è) 10 æ¸©å’Œ 60 é»˜è®¤ 100+ ç§¯æ swap æ¨èå€¼ åœºæ™¯ swappiness æ•°æ®åº“ 1 å®¹å™¨å®¿ä¸»æœº 1~5 é€šç”¨æœåŠ¡å™¨ 10 æ¡Œé¢ 60 2ï¸âƒ£ vm.overcommit_memoryï¼ˆå’Œ swap å¼ºç›¸å…³ï¼‰ å€¼ è¡Œä¸º 0 å¯å‘å¼ (é»˜è®¤) 1 å…è®¸è¶…é¢ 2 ä¸¥æ ¼é™åˆ¶ æ•°æ®åº“æ¨èï¼š\nvm.overcommit_memory = 0 3ï¸âƒ£ vm.min_free_kbytesï¼ˆé—´æ¥å½±å“ swapï¼‰ é˜²æ­¢ç³»ç»Ÿè¿›å…¥â€œå†…å­˜æŠ–åŠ¨â€\nvm.min_free_kbytes = 1% ~ 3% RAM å…­ã€swap ä¸æ•°æ®åº“ï¼ˆé‡ç‚¹ï¼‰ PostgreSQL / MySQL å®˜æ–¹å…±è¯† å° swap + æä½ swappiness æ˜¯æœ€ç¨³æ–¹æ¡ˆ\nåŸå› ï¼š\né¿å…åŒ¿åé¡µåˆ†é…å¤±è´¥ é˜²æ­¢ fork / bgwriter å¤±è´¥ é˜²æ­¢ OOM è¯¯æ€æ•°æ®åº“ æ¨èç»„åˆ vm.swappiness = 1 vm.overcommit_memory = 0 swapï¼š\n4~8GB å³å¯ï¼ˆä¸è¿½æ±‚ä½¿ç”¨ï¼‰ ä¸ƒã€swap ä¸å®¹å™¨ / Kubernetes ä¸ºä»€ä¹ˆ K8S ä¸å»ºè®®ç¦ swapï¼Ÿ cgroup OOM â‰  kernel OOM container çªå‘å†…å­˜ä¸å¯æ§ page cache ç«äº‰ä¸¥é‡ æ²¡æœ‰ swapï¼ŒOOM ä¼šæ›´æ—©ã€æ›´ç‹ \næ¨èï¼š\nswap = 8~16GB swappiness = 1 ä¸¥æ ¼ memory limit å…«ã€swap çš„æ€§èƒ½çœŸç›¸ swap æ…¢çš„æ ¹æœ¬åŸå› ä¸æ˜¯ swap çœŸæ­£åŸå›  è¡¨ç° å†…å­˜ä¸è¶³ æŒç»­ swap in/out swappiness è¿‡é«˜ ä¸å¿…è¦æ¢å‡º IO ç“¶é¢ˆ swap ç­‰å¾… æ­£ç¡®åˆ¤æ–­æ˜¯å¦â€œæœ‰é—®é¢˜â€ vmstat 1 å…³æ³¨ï¼š\nsi / so æ˜¯å¦æŒç»­é 0 ä¸æ˜¯å¶å°”å‡ºç° ä¹ã€å…³äºâ€œç¦ç”¨ swapâ€çš„çœŸè¯ ä»€ä¹ˆæ—¶å€™å¯ä»¥ç¦ï¼Ÿ âœ… å†…å­˜ â‰¥ 128GB âœ… å•ä¸€ã€å¯æ§è´Ÿè½½ âœ… æ— å®¹å™¨ / æ—  JVM âœ… æ˜ç¡® OOM ç­–ç•¥ ä»€ä¹ˆæ—¶å€™åˆ«ç¦ï¼Ÿ âŒ å®¹å™¨å®¿ä¸»æœº âŒ å¤šè¯­è¨€è¿è¡Œæ—¶ âŒ ç¬¬ä¸‰æ–¹ç¨‹åº âŒ äº‘ä¸»æœº åã€ä½ å¯ä»¥ç›´æ¥ç…§æŠ„çš„å·¥ç¨‹æ¨¡æ¿ é€šç”¨æœåŠ¡å™¨ vm.swappiness = 10 vm.overcommit_memory = 0 vm.min_free_kbytes = 262144 æ•°æ®åº“æœåŠ¡å™¨ vm.swappiness = 1 vm.overcommit_memory = 0 å®¹å™¨å®¿ä¸»æœº vm.swappiness = 1 vm.overcommit_memory = 0 æ€»ç»“ swap æ˜¯å†…æ ¸å›æ”¶åŒ¿åé¡µçš„é€€è·¯ï¼Œä¸æ˜¯å†…å­˜çš„æ›¿ä»£\næ²¡æœ‰ swapï¼Œç³»ç»Ÿæ›´å®¹æ˜“ OOMï¼›ä¹±ç”¨ swapï¼Œç³»ç»Ÿæ‰ä¼šæ…¢\nè¡¥å…… Swapï¼ˆäº¤æ¢ç©ºé—´ï¼‰æ˜¯ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰ä¸è¶³æ—¶çš„ç£ç›˜ç¼“å­˜ï¼ŒäºŒè€…é€šè¿‡â€œå€Ÿç”¨â€å…³ç³»ååŒå·¥ä½œä»¥é˜²æ­¢ç³»ç»Ÿå´©æºƒï¼Œç”¨äºä¼‘çœ æˆ–ç¼“è§£çªå‘å†…å­˜å‹åŠ›ã€‚\nSwap ä¸ç‰©ç†å†…å­˜çš„ä¾èµ–å…³ç³»\nåŠŸèƒ½äº’è¡¥ï¼šSwap æœ¬è´¨æ˜¯ç£ç›˜ä¸Šçš„ä¸€ä¸ªåŒºåŸŸï¼Œå½“ç‰©ç†å†…å­˜è¢«å æ»¡æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸å¸¸ç”¨çš„æ•°æ®ç§»åŠ¨åˆ° Swapï¼Œä»è€Œé‡Šæ”¾ç‰©ç†å†…å­˜ç»™ç´§æ€¥ç¨‹åºä½¿ç”¨ã€‚ æ€§èƒ½æƒè¡¡ï¼šç¡¬ç›˜ï¼ˆSwapï¼‰çš„é€Ÿåº¦è¿œæ…¢äº RAMï¼Œå¤§é‡ä½¿ç”¨ Swap ä¼šå¯¼è‡´ç³»ç»Ÿè¿è¡Œéå¸¸ç¼“æ…¢ï¼ˆç³»ç»Ÿå“åº”è¿Ÿé’ï¼‰ã€‚ ä¼‘çœ æ”¯æŒï¼šåœ¨ç¬”è®°æœ¬ç”µè„‘ä¸­ï¼Œè¦å®ç°â€œä¼‘çœ åˆ°ç¡¬ç›˜â€ï¼ˆSuspend to Diskï¼‰ï¼ŒSwap ç©ºé—´é€šå¸¸éœ€è¦ç­‰äºæˆ–å¤§äºç‰©ç†å†…å­˜ã€‚ ç‰¹æ®Šåœºæ™¯\næœåŠ¡å™¨ï¼šå¦‚æœç»å¸¸çˆ†å†…å­˜ï¼Œåº”ä¼˜å…ˆå¢åŠ ç‰©ç†å†…å­˜ï¼Œè€Œéä¾èµ– Swapã€‚ SSD ç¡¬ç›˜ï¼šåœ¨ä½¿ç”¨ SSD æ—¶ï¼Œè¿‡å¤§çš„ Swap äº¤æ¢å¯èƒ½ä¼šåŠ å¿«ç¡¬ç›˜å¯¿å‘½è¡°å‡ï¼Œåº”å°½é‡ä¿è¯è¶³å¤Ÿå¤§çš„ç‰©ç†å†…å­˜ã€‚ æ€»è€Œè¨€ä¹‹ï¼ŒSwap ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå…¶åˆç†å¤§å°ä¾èµ–äºç‰©ç†å†…å­˜çš„å¤§å°å’Œå®é™…å·¥ä½œè´Ÿè½½ã€‚\nä¸€å¥è¯ç»“è®ºï¼ˆå…ˆè®°ä½ï¼‰ å†…å­˜ â‰¤ 32GBï¼šswap æœ‰ç°å®æ„ä¹‰\nå†…å­˜ â‰¥ 64GBï¼šswap æ›´å¤šæ˜¯â€œå®‰å…¨é˜€â€ï¼Œè€Œä¸æ˜¯æ€§èƒ½å·¥å…·\nå†…å­˜ â‰¥ 128GBï¼šå¤§å¤šæ•°ç”Ÿäº§åœºæ™¯å¯ä»¥ä¸è¦ swap\nä½† \u0026ndash;\nğŸ‘‰ æ•°æ®åº“ / JVM / å®¹å™¨å®¿ä¸»æœºæ˜¯ä¾‹å¤–ï¼Œéœ€è¦å•ç‹¬çœ‹\næ ¸å¿ƒæœ¬è´¨ï¼ˆå…ˆæŠŠè®¤çŸ¥æ°æ­£ï¼‰ swap çš„æœ¬è´¨ä¸æ˜¯â€œæ‰©å®¹å†…å­˜â€ swap = ç»™å†…æ ¸ä¸€ä¸ªâ€œç¼“å†²å¸¦â€ï¼Œé¿å…ç¬æ—¶å†…å­˜å‹åŠ›ç›´æ¥è§¦å‘ OOM\nå®ƒè§£å†³çš„æ˜¯ä¸‰ä¸ªé—®é¢˜ï¼š\nåŒ¿åé¡µå›æ”¶å¤±è´¥ å†…å­˜ç¢ç‰‡åŒ– çªå‘å³°å€¼ï¼ˆspikeï¼‰ æŒ‰å†…å­˜è§„æ¨¡ç»™ä½ ä¸€ä»½â€œæ˜¯å¦æœ‰æ„ä¹‰â€çš„åˆ¤æ–­è¡¨ ğŸŸ¢ â‰¤ 8GB å†…å­˜ï¼ˆéå¸¸æœ‰æ„ä¹‰ï¼‰ ä½œç”¨ è¯´æ˜ é˜² OOM æå…¶å…³é”® å†…å­˜ç¢ç‰‡ éå¸¸æ˜æ˜¾ åå°ä»»åŠ¡ æœ‰ swap æ‰èƒ½æ´» âœ… å»ºè®®\nswap = å†…å­˜ Ã— 1ï½2 swappiness = 10~30 âŒ ä¸è¦ç¦ swap\nğŸŸ¢ 16GB å†…å­˜ï¼ˆä»ç„¶æœ‰æ„ä¹‰ï¼‰ åœºæ™¯ swap ä»·å€¼ Web / API æ˜æ˜¾ Python / Node æ˜æ˜¾ å°å‹æ•°æ®åº“ æœ‰ä»·å€¼ âœ… å»ºè®®\nswap = 8~16GB swappiness = 10 ğŸŸ¡ 32GB å†…å­˜ï¼ˆä¸´ç•Œç‚¹ï¼‰ è¿™æ˜¯ swapâ€œæœ‰æ²¡æœ‰æ„ä¹‰â€çš„åˆ†æ°´å²­\nåœºæ™¯ å»ºè®® é€šç”¨æœåŠ¡å™¨ ä¿ç•™å° swap æ•°æ®åº“ å° swap å®¹å™¨å®¿ä¸»æœº å¿…é¡»æœ‰ âœ… å»ºè®®\nswap = 8GBï¼ˆä¸æ˜¯ä¸ºäº†ç”¨ï¼Œæ˜¯ä¸ºäº†ä¸ OOMï¼‰ swappiness = 1~5 ğŸŸ  64GB å†…å­˜ï¼ˆå®‰å…¨é˜€çº§åˆ«ï¼‰ swap ä¸å†æ˜¯â€œèµ„æºâ€ï¼Œè€Œæ˜¯â€œä¿é™©ä¸â€\nä»·å€¼ è¯´æ˜ æ€§èƒ½ åŸºæœ¬æ—  ç¨³å®šæ€§ æœ‰ é˜²è¯¯æ€ æœ‰ âœ… å»ºè®®\nswap = 4~8GB swappiness = 1 âŒ ä¸å»ºè®®å®Œå…¨ç¦ç”¨ï¼ˆé™¤éä½ éå¸¸è‡ªä¿¡ï¼‰\nğŸ”´ â‰¥ 128GB å†…å­˜ï¼ˆå¤šæ•°åœºæ™¯å¯ä¸è¦ï¼‰ ç»å¤§å¤šæ•°å·¥ä½œè´Ÿè½½å·²ç»ä¸éœ€è¦ swap\nåœºæ™¯ å»ºè®® è£¸æœºæ•°æ®åº“ å¯ç¦ å¤§å†…å­˜ç¼“å­˜ å¯ç¦ HPC ç¦ âŒ ä½†ä»¥ä¸‹æƒ…å†µä¾‹å¤–ï¼š\nå®¹å™¨å®¿ä¸»æœº Kubernetes èŠ‚ç‚¹ JVM / Python æ··åˆè´Ÿè½½ æœ‰ä¸å¯æ§ç¬¬ä¸‰æ–¹è¿›ç¨‹ ç‰¹æ®Šåœºæ™¯ï¼šæ•°æ®åº“ï¼ˆä½ è¿™ä¸ªç”¨æˆ·éå¸¸å…³é”®ï¼‰ PostgreSQL / MySQL çš„çœŸå®å»ºè®® â€œå° swap + æä½ swappinessâ€ \u0026gt; â€œå®Œå…¨ç¦ swapâ€\nä¸ºä»€ä¹ˆï¼Ÿ é¿å…ï¼š\nå†…å­˜ç¢ç‰‡å¯¼è‡´ malloc å¤±è´¥ WAL / shared memory åˆ†é…å¤±è´¥ swap åªæ¢å‡º å†·åŒ¿åé¡µ\nä¸ä¼šæ¢æ•°æ®åº“ bufferï¼ˆpage cacheï¼‰\nâœ… æ¨èé…ç½®\nvm.swappiness = 1 vm.overcommit_memory = 0 swap å¤§å°ï¼š\nç‰©ç†å†…å­˜ â‰¤ 64GBï¼š4~8GB â‰¥ 128GBï¼šå¯ä¸è¦ Kubernetes / å®¹å™¨å®¿ä¸»æœºï¼ˆé‡ç‚¹ï¼‰ æ²¡æœ‰ swap çš„å®¿ä¸»æœºï¼Œæ›´å®¹æ˜“â€œæ•´èŠ‚ç‚¹ OOMâ€\nåŸå›  cgroups OOM â‰  kernel OOM container burst éå¸¸å¸¸è§ page cache ç«äº‰æ¿€çƒˆ âœ… æ¨è\nswap = 8~16GBï¼ˆä¸è¿½æ±‚ä½¿ç”¨ï¼‰ swappiness = 1 cgroup memory limit ä¸¥æ ¼ ä¸ºä»€ä¹ˆâ€œç¦ swapâ€åè€Œå®¹æ˜“ç¿»è½¦ï¼Ÿ çœŸå®æœºåˆ¶ å†…å­˜åˆ†é…æ˜¯æå‰çš„ OOM æ˜¯æœ€åæ‰‹æ®µ æ²¡ swap -\u0026gt; å›æ”¶è·¯å¾„æ›´çŸ­ ç›´æ¥ kill è¿›ç¨‹ æ¢å¥è¯è¯´ï¼š\nswap æ˜¯ OOM çš„â€œç¼“å†²å¸¦â€ï¼Œä¸æ˜¯æ€§èƒ½å·¥å…·\nä¸€ä¸ªâ€œå·¥ç¨‹çº§åˆ¤æ–­å…¬å¼â€ å¦‚æœä½ çš„å†…å­˜å³°å€¼ä¸å¯ç²¾ç¡®é¢„æµ‹ -\u0026gt; ä¿ç•™ swap å¦‚æœä½ çš„è¿›ç¨‹é›†åˆä¸å¯æ§ -\u0026gt; ä¿ç•™ swap å¦‚æœä½ è¿è¡Œçš„æ˜¯å®¹å™¨ / JVM / Python -\u0026gt; ä¿ç•™ swap\næœ€åçš„å…³é”®ä¸€å¥è¯ï¼ˆè¯·è®°ä½ï¼‰ swap ä¸æ˜¯æ…¢çš„æ ¹æºï¼Œä¹±ç”¨ swap æ‰æ˜¯ çœŸæ­£å±é™©çš„æ˜¯ï¼šæ²¡ swap + å†…å­˜ä¼°ç®—é”™è¯¯\n","description":" ä¸€ã€swap æ˜¯ä»€ä¹ˆï¼ˆä¸è¦å†è¢«â€œè™šæ‹Ÿå†…å­˜â€å¸¦åï¼‰ 1ï¸âƒ£ swap çš„çœŸå®å®šä¹‰ swap = å†…æ ¸ç”¨äºå›æ”¶åŒ¿åé¡µï¼ˆanonymous pagesï¼‰çš„åå¤‡å­˜å‚¨\nå®ƒåªæœåŠ¡äºåŒ¿åé¡µï¼š\nè¿›ç¨‹å †ï¼ˆheapï¼‰ æ ˆï¼ˆstackï¼‰ malloc/new å‡ºæ¥çš„å†…å­˜ JVM / Python / Go runtime å†…å­˜ âŒ ä¸ç›´æ¥ç”¨äºï¼š\næ–‡ä»¶é¡µï¼ˆpage cacheï¼‰ ç£ç›˜æ˜ å°„æ–‡ä»¶ï¼ˆmmap æ–‡ä»¶ï¼‰ 2ï¸âƒ£ swap â‰  å†…å­˜æ‰©å®¹ è¯¯è§£ çœŸç›¸ swap æ˜¯æ…¢å†…å­˜ âŒ swap èƒ½å½“å†…å­˜ç”¨ âŒ swap ä¼šæ‹–æ…¢ç³»ç»Ÿ âŒ (å‰ææ˜¯æ²¡ä¹±ç”¨) æ­£ç¡®ç†è§£ï¼š\n"},{"id":431,"href":"/operations/linux/swap-enable/","title":"swap | å¯ç”¨","parent":"Linux","content":"å°å†…å­˜çš„æœåŠ¡å™¨ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ swapï¼Œå¯é¿å… OOMã€‚\nåæœŸè¦ç›‘æ§ swap çš„ä½¿ç”¨æƒ…å†µã€‚å¦‚æœ swap ç»å¸¸ä½¿ç”¨ç‡è¿‡é«˜ï¼Œè¯´æ˜å†…å­˜ä¸è¶³ã€‚\nä¸€ã€åˆ›å»º swap æ–‡ä»¶ï¼ˆ/data/swapfile/2G.swapï¼‰ 1ï¸âƒ£ è§„åˆ’ swap å¤§å°ï¼ˆå»ºè®®ï¼‰ å®‰è£…ç³»ç»Ÿæ—¶ï¼Œåˆ›å»º swap åˆ†åŒºï¼Œå¤§å° 8Gã€‚\nå›ºå®šé…ç½®ï¼Œä»¥åå®‰è£…ç³»ç»Ÿæ—¶éƒ½æŒ‰è¿™ä¸ªæ ‡å‡†åˆ›å»º swap åˆ†åŒºã€‚ ç‰©ç†å†…å­˜ swap å»ºè®® â‰¤ 1GB 1GB â‰¤ 2GB 2GB â‰¤ 4GB 4GB â‰¤ 8GB 8GB â‰¥ 8GB 8GB (æ›´å¤šæ„ä¹‰ä¸å¤§) 2ï¸âƒ£ åˆ›å»ºç›®å½•ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰ mkdir -p /data/swapfile chmod 755 /data/swapfile 3ï¸âƒ£ åˆ›å»º swap æ–‡ä»¶ï¼ˆæ¨èæ–¹å¼ï¼‰ AlmaLinux 9 å†…æ ¸ + XFS/EXT4 æ”¯æŒ fallocate\nrm -fv /data/swapfile/2G.swap fallocate -l 2G /data/swapfile/2G.swap è‹¥åº•å±‚å­˜å‚¨ä¸æ”¯æŒ fallocateï¼ˆæå°‘æ•°æƒ…å†µï¼‰ï¼š\ndd if=/dev/zero of=/data/swapfile/2G.swap bs=1M count=2048 status=progress 4ï¸âƒ£ è®¾ç½®æƒé™ï¼ˆå¿…é¡»ï¼‰ chmod 600 /data/swapfile/2G.swap 5ï¸âƒ£ åˆå§‹åŒ– swap mkswap /data/swapfile/2G.swap 6ï¸âƒ£ å¯ç”¨ swapï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰ swapoff -a swapon /data/swapfile/2G.swap 7ï¸âƒ£ éªŒè¯ swapon --show free -m äºŒã€é…ç½® /etc/fstabï¼ˆå¼€æœºè‡ªåŠ¨æŒ‚è½½ï¼‰ æ­£ç¡®å†™æ³•ï¼ˆæ¨èï¼‰ /data/swapfile/2G.swap none swap defaults 0 0 ç«‹å³éªŒè¯ï¼ˆä¸é‡å¯ï¼‰ï¼š\nswapoff /data/swapfile/2G.swap swapon -a swapon --show free -m rc.local é…ç½® æ£€æŸ¥ /etc/rc.local æ–‡ä»¶ï¼Œæ³¨é‡Šæˆ–åˆ é™¤ swapon -a å‘½ä»¤ã€‚\nä¸‰ã€å†…æ ¸å‚æ•°ï¼ˆsysctlï¼‰ä¼˜åŒ–å»ºè®®ï¼ˆAlmaLinux 9ï¼‰ ç›®æ ‡ï¼šå°½é‡ä¸ç”¨ swapï¼Œä½†ä½œä¸º OOM ç¼“å†²å­˜åœ¨\n1ï¸âƒ£ åˆ›å»ºç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰ vi /etc/sysctl.d/99-swap.conf 2ï¸âƒ£ æ¨èé…ç½®ï¼ˆç”Ÿäº§é€šç”¨ï¼‰ # å°½é‡é¿å…ä½¿ç”¨ swap vm.swappiness = 10 # å†…å­˜å›æ”¶ç­–ç•¥ï¼ˆé˜²æ­¢è¿‡æ—© OOM) vm.overcommit_memory = 1 # è„é¡µå†™å›æ§åˆ¶ï¼ˆç¨³å®šä¼˜å…ˆï¼‰ vm.dirty_ratio = 20 vm.dirty_background_ratio = 10 # é™ä½å†…å­˜ç¢ç‰‡å‹åŠ› vm.min_free_kbytes = 131072 å¦‚æœæ˜¯ æ•°æ®åº“ / Redis / Elasticsearch\nvm.swappiness = 1 ä¸å»ºè®®è®¾ç½® vm.swappiness = 0\n0 å¹¶éâ€œå®Œå…¨ç¦ç”¨â€ åœ¨æç«¯å†…å­˜å‹åŠ›ä¸‹åè€Œæ›´å®¹æ˜“ OOM 3ï¸âƒ£ ç«‹å³åŠ è½½ sysctl --system 4ï¸âƒ£ éªŒè¯ sysctl vm.swappiness å››ã€systemd ä¸ swap çš„å…³ç³»ï¼ˆAlmaLinux 9ï¼‰ systemd ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š kvm-swapfile.swap æŸ¥çœ‹çŠ¶æ€ï¼š\nsystemctl status kvm-swapfile.swap åˆ—å‡ºæ‰€æœ‰ swap unitï¼š\nsystemctl list-units --type=swap äº”ã€OOM è¡Œä¸ºè¯´æ˜ï¼ˆéå¸¸é‡è¦ï¼‰ swap çš„çœŸå®ä½œç”¨ æœ‰ swap æ—  swap ç³»ç»Ÿæ›´æŠ—çªå‘å†…å­˜ OOM æ›´æ—© å»¶è¿Ÿ OOM å»¶è¿Ÿä½ä½†é£é™©é«˜ æ›´å¹³æ»‘ æ›´â€œç¡¬â€ swap â‰  æ€§èƒ½ä¼˜åŒ–\nswap = ç³»ç»Ÿä¿é™©ä¸\nå…­ã€å¸¸è§å‘ï¼ˆAlmaLinux 9 ç‰¹æœ‰ï¼‰ âŒ 1. SELinux é»˜è®¤ ä¸å½±å“ swapfile\nè‹¥ swap æ— æ³•å¯ç”¨ï¼š\nrestorecon -v /data/swapfile/2G.swap âŒ 2. Btrfs / CoW è‹¥ /data/swapfile åœ¨ Btrfs ä¸Šï¼š\nchattr +C /data/swapfile/2G.swap å¦åˆ™ swap ä¼šå¤±è´¥\nâŒ 3. å®¹å™¨å®¿ä¸»æœº Docker / Podman / K8S èŠ‚ç‚¹ å¼ºçƒˆå»ºè®®ä¿ç•™ swapï¼ˆä½†é™åˆ¶ä½¿ç”¨ï¼‰ vm.swappiness = 10 ä¸ƒã€å®Œæ•´å‘½ä»¤æ±‡æ€»ï¼ˆå¯å¤åˆ¶ï¼‰ mkdir -p /data/swapfile chmod 755 /data/swapfile rm -fv /data/swapfile/2G.swap fallocate -l 8G /data/swapfile/2G.swap chmod 600 /data/swapfile/2G.swap mkswap /data/swapfile/2G.swap swapoff -a swapon /data/swapfile/2G.swap echo \u0026#34;/data/swapfile/2G.swap none swap defaults 0 0\u0026#34; \u0026gt;\u0026gt; /etc/fstab cat \u0026gt;/etc/sysctl.d/99-swap.conf \u0026lt;\u0026lt;EOF vm.swappiness = 10 vm.overcommit_memory = 1 vm.dirty_ratio = 20 vm.dirty_background_ratio = 10 vm.min_free_kbytes = 131072 EOF sysctl --system å…«ã€æ€»ç»“ åœ¨ AlmaLinux 9 ä¸Šï¼Œswap æ–‡ä»¶åº”ä½œä¸ºâ€œä½é¢‘ä½¿ç”¨çš„å†…å­˜ä¿é™©â€ï¼Œæ­£ç¡®æ–¹å¼æ˜¯ï¼šå° swap + ä½ swappiness + æ˜ç¡® sysctl æ§åˆ¶ã€‚\n","description":"å°å†…å­˜çš„æœåŠ¡å™¨ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ swapï¼Œå¯é¿å… OOMã€‚\nåæœŸè¦ç›‘æ§ swap çš„ä½¿ç”¨æƒ…å†µã€‚å¦‚æœ swap ç»å¸¸ä½¿ç”¨ç‡è¿‡é«˜ï¼Œè¯´æ˜å†…å­˜ä¸è¶³ã€‚\nä¸€ã€åˆ›å»º swap æ–‡ä»¶ï¼ˆ/data/swapfile/2G.swapï¼‰ 1ï¸âƒ£ è§„åˆ’ swap å¤§å°ï¼ˆå»ºè®®ï¼‰ å®‰è£…ç³»ç»Ÿæ—¶ï¼Œåˆ›å»º swap åˆ†åŒºï¼Œå¤§å° 8Gã€‚\nå›ºå®šé…ç½®ï¼Œä»¥åå®‰è£…ç³»ç»Ÿæ—¶éƒ½æŒ‰è¿™ä¸ªæ ‡å‡†åˆ›å»º swap åˆ†åŒºã€‚ ç‰©ç†å†…å­˜ swap å»ºè®® â‰¤ 1GB 1GB â‰¤ 2GB 2GB â‰¤ 4GB 4GB â‰¤ 8GB 8GB â‰¥ 8GB 8GB (æ›´å¤šæ„ä¹‰ä¸å¤§) 2ï¸âƒ£ åˆ›å»ºç›®å½•ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰ mkdir -p /data/swapfile chmod 755 /data/swapfile 3ï¸âƒ£ åˆ›å»º swap æ–‡ä»¶ï¼ˆæ¨èæ–¹å¼ï¼‰ AlmaLinux 9 å†…æ ¸ + XFS/EXT4 æ”¯æŒ fallocate\n"},{"id":432,"href":"/operations/linux/swap-disable/","title":"swap | ç¦ç”¨","parent":"Linux","content":"ç¦ç”¨ swap\nswapoff -a å°† swapoff -a æ·»åŠ åˆ° /etc/rc.local ä¸­ã€‚\næŸ¥çœ‹ /etc/fstab, æ³¨é‡Šæˆ–åˆ é™¤ swap ç›¸å…³é…ç½®ã€‚\nä¿®æ”¹å†…æ ¸å‚æ•°ï¼š\nvm.swappiness = 0 ","description":"ç¦ç”¨ swap\nswapoff -a å°† swapoff -a æ·»åŠ åˆ° /etc/rc.local ä¸­ã€‚\næŸ¥çœ‹ /etc/fstab, æ³¨é‡Šæˆ–åˆ é™¤ swap ç›¸å…³é…ç½®ã€‚\nä¿®æ”¹å†…æ ¸å‚æ•°ï¼š\nvm.swappiness = 0 "},{"id":433,"href":"/operations/linux/sysbench/","title":"sysbench","parent":"Linux","content":" 1. Sysbench æ˜¯ä»€ä¹ˆï¼Ÿ Sysbench æ˜¯ä¸€ä¸ªè·¨å¹³å°ã€æ¨¡å—åŒ–ã€å¤šçº¿ç¨‹æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨äºå¯¹ä»¥ä¸‹å­ç³»ç»Ÿè¿›è¡Œå‹æµ‹ï¼š\nğŸ”¸ CPU ğŸ”¸ å†…å­˜ Memory ğŸ”¸ ç£ç›˜ I/O ğŸ”¸ æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€MariaDBï¼‰ ğŸ”¸ çº¿ç¨‹è°ƒåº¦ ğŸ”¸ Mutexï¼ˆé”ï¼‰ å®ƒç‰¹åˆ«é€‚åˆç”¨äº æ•°æ®åº“æ€§èƒ½åŸºå‡†æµ‹è¯•ã€‚\n2. å®‰è£… Sysbench CentOS / AlmaLinux / Rocky\nyum install -y epel-release yum install -y sysbench Ubuntu / Debian\napt install -y sysbench æºç ï¼ˆæ›´é«˜ç‰ˆæœ¬ï¼‰\ngit clone https://github.com/akopytov/sysbench.git cd sysbench ./autogen.sh ./configure make -j sudo make install 3. Sysbench å¸¸ç”¨æµ‹è¯•é¡¹ 3.1 CPU å‹æµ‹ æµ‹è¯• CPU åœ¨è®¡ç®—è´¨æ•°è¿‡ç¨‹ä¸­çš„èƒ½åŠ›ã€‚\nsysbench cpu --cpu-max-prime=20000 run å…³é”®å‚æ•°ï¼š\n\u0026ndash;threads=N çº¿ç¨‹æ•° \u0026ndash;cpu-max-prime=N è´¨æ•°ä¸Šé™ 3.2 å†…å­˜å‹æµ‹ å†™æµ‹è¯•ï¼š\nsysbench memory --memory-total-size=10G run è¯»æµ‹è¯•ï¼š\nsysbench memory --memory-total-size=10G --memory-oper=read run 3.3 ç£ç›˜ IO æµ‹è¯•ï¼ˆæœ€å¸¸ç”¨ï¼‰ åˆ›å»ºæµ‹è¯•æ–‡ä»¶\nsysbench fileio --file-total-size=10G prepare éšæœºè¯»å†™\nsysbench fileio --file-total-size=10G --file-test-mode=rndrw run æ¸…ç†\nsysbench fileio cleanup 3.4 çº¿ç¨‹è°ƒåº¦æµ‹è¯• sysbench threads --threads=50 run 3.5 Mutexï¼ˆé”æ€§èƒ½ï¼‰ sysbench mutex --threads=50 run 4. æ•°æ®åº“å‹æµ‹ï¼ˆé‡å¤´æˆï¼ï¼‰ Sysbench é»˜è®¤å†…ç½® Lua è„šæœ¬ç”¨äº MySQL/PostgreSQLã€‚\næ•°æ®åº“è¿æ¥å‚æ•°é€šç”¨å†™æ³•ï¼š\n--mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=123456 --mysql-db=test PostgreSQLï¼š\n--pgsql-host=127.0.0.1 --pgsql-port=5432 --pgsql-user=postgres --pgsql-password=123456 --pgsql-db=test 4.1 æ•°æ®å‡†å¤‡ï¼ˆPrepareï¼‰ ä»¥ OLTP è¯»å†™ï¼ˆæ··åˆè´Ÿè½½ï¼‰ä¸ºä¾‹ï¼š\nMySQLï¼š\nsysbench /usr/share/sysbench/oltp_read_write.lua \\ --tables=10 \\ --table-size=1000000 \\ --mysql-host=127.0.0.1 \\ --mysql-port=3306 \\ --mysql-user=root \\ --mysql-password=123456 \\ --mysql-db=test \\ prepare PostgreSQLï¼š\nsysbench /usr/share/sysbench/oltp_read_write.lua \\ --tables=10 \\ --table-size=1000000 \\ --pgsql-host=127.0.0.1 \\ --pgsql-port=5432 \\ --pgsql-user=postgres \\ --pgsql-password=123456 \\ --pgsql-db=test \\ prepare 4.2 å¼€å§‹å‹æµ‹ OLTP æ··åˆè¯»å†™\nsysbench /usr/share/sysbench/oltp_read_write.lua \\ --threads=64 \\ --time=60 \\ --report-interval=10 \\ --tables=10 \\ --table-size=1000000 \\ run OLTP çº¯è¯»\nsysbench /usr/share/sysbench/oltp_read_only.lua --threads=64 --time=60 run OLTP çº¯å†™\nsysbench /usr/share/sysbench/oltp_write_only.lua --threads=64 --time=60 run è‡ªå®šä¹‰ QPS é™åˆ¶\n--rate=3000 4.3 æ¸…ç†æ•°æ® sysbench /usr/share/sysbench/oltp_read_write.lua --tables=10 cleanup 5. è¾“å‡ºç»“æœå¦‚ä½•çœ‹ï¼Ÿ Sysbench è¾“å‡ºé‡ç‚¹å­—æ®µï¼š\nTPSï¼ˆtransactions per secondï¼‰ äº‹åŠ¡ååé‡ï¼Œæ˜¯æœ€é‡è¦æŒ‡æ ‡ã€‚\nQPSï¼ˆqueries per secondï¼‰ Ops/secï¼ˆè¯»+å†™æŸ¥è¯¢æ€»æ•°ï¼‰ã€‚\nLatency å¹³å‡å»¶è¿Ÿ å¹³å‡è¯·æ±‚å»¶æ—¶ã€‚\n95th percentile latency P95 å»¶è¿Ÿï¼ˆæœ€é‡è¦ï¼‰ã€‚\nErrors / Warnings ä¸šåŠ¡é”™è¯¯ã€‚\næ•°æ®åº“å‹æµ‹ä¸­ TPS å’Œ P95 å»¶è¿Ÿ æ˜¯æœ€æ ¸å¿ƒæŒ‡æ ‡ã€‚\n6. Sysbench æœ€ä½³å®è·µ â­ 6.1 è¦æŒ‰ç…§â€œå†·çƒ­è´Ÿè½½â€åˆ†åˆ«å‹æµ‹ ğŸ”¥ çƒ­æ•°æ®ï¼ˆå®Œå…¨åœ¨å†…å­˜ä¸­ï¼‰ \u0026ndash; ç”¨äºæµ‹è¯• CPU + buffer pool â„ å†·æ•°æ®ï¼ˆè¿œè¶…å†…å­˜ï¼‰ \u0026ndash; ç”¨äºæµ‹è¯•ç£ç›˜éšæœº IO ä¾‹å¦‚æœåŠ¡å™¨ 16GB å†…å­˜ï¼š\nçƒ­æµ‹è¯•ï¼štable-size 100 ä¸‡ å†·æµ‹è¯•ï¼štable-size 1000 ä¸‡ * 10 tables = 1 äº¿ â­ 6.2 æ³¨æ„çº¿ç¨‹æ•°æ¸è¿›å¢åŠ  å»ºè®®æµ‹è¯•çº¿ç¨‹ï¼š\n1, 2, 4, 8, 16, 32, 64, 128 ç”¨äºè§‚å¯Ÿç³»ç»Ÿ TPS éšçº¿ç¨‹å˜åŒ–æ˜¯å¦ï¼š\nçº¿æ€§å¢é•¿ï¼ˆä¼˜ï¼‰ ç“¶é¢ˆç‚¹ï¼ˆCPU æˆ– IO æ»¡è½½ï¼‰ å‡ºç°æŠ–åŠ¨ï¼ˆæ•°æ®åº“é”äº‰ç”¨ï¼‰ â­ 6.3 æ³¨æ„å…³é—­ CPU ç¿é¢‘ Turbo Boost å¦åˆ™å‹æµ‹ä¸ç¨³å®šï¼š\necho 1 \u0026gt; /sys/devices/system/cpu/intel_pstate/no_turbo â­ 6.4 SSD IO å‹æµ‹è¦å…³é—­ç¼“å­˜ sysbench fileio ... --file-extra-flags=direct å¦åˆ™ç»“æœè™šé«˜ã€‚\nâ­ 6.5 PostgreSQL è¯·è®¾ç½®åˆé€‚çš„å‚æ•° ä¾‹å¦‚ï¼š\nshared_buffers = 4GB wal_buffers = 256MB max_wal_size = 8GB checkpoint_timeout = 15min å¦åˆ™æ€§èƒ½å·®è·å·¨å¤§ã€‚\n7. å¸¸ç”¨æµ‹è¯•è„šæœ¬æ¨¡æ¿ï¼ˆä½ å¯ç›´æ¥å¤åˆ¶ç”¨ï¼‰ PostgreSQL OLTP æ··åˆè„šæœ¬ï¼ˆæœ€å¸¸ç”¨ï¼‰\nDB_ARGS=\u0026#34;--pgsql-host=127.0.0.1 \\ --pgsql-port=5432 \\ --pgsql-user=postgres \\ --pgsql-password=123456 \\ --pgsql-db=test\u0026#34; sysbench oltp_read_write.lua \\ --tables=10 \\ --table-size=1000000 \\ $DB_ARGS prepare sysbench oltp_read_write.lua \\ --threads=64 \\ --time=60 \\ --report-interval=10 \\ $DB_ARGS run sysbench oltp_read_write.lua \\ $DB_ARGS cleanup ","description":" 1. Sysbench æ˜¯ä»€ä¹ˆï¼Ÿ Sysbench æ˜¯ä¸€ä¸ªè·¨å¹³å°ã€æ¨¡å—åŒ–ã€å¤šçº¿ç¨‹æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œä¸»è¦ç”¨äºå¯¹ä»¥ä¸‹å­ç³»ç»Ÿè¿›è¡Œå‹æµ‹ï¼š\nğŸ”¸ CPU ğŸ”¸ å†…å­˜ Memory ğŸ”¸ ç£ç›˜ I/O ğŸ”¸ æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€MariaDBï¼‰ ğŸ”¸ çº¿ç¨‹è°ƒåº¦ ğŸ”¸ Mutexï¼ˆé”ï¼‰ å®ƒç‰¹åˆ«é€‚åˆç”¨äº æ•°æ®åº“æ€§èƒ½åŸºå‡†æµ‹è¯•ã€‚\n2. å®‰è£… Sysbench CentOS / AlmaLinux / Rocky\nyum install -y epel-release yum install -y sysbench Ubuntu / Debian\n"},{"id":434,"href":"/operations/linux/sysctl-net.core.default_qdisc/","title":"sysctl -- net.core.default_qdisc","parent":"Linux","content":"net.core.default_qdisc æ˜¯ Linux å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿä¸­çš„ä¸€ä¸ª å…¨å±€é»˜è®¤é˜Ÿåˆ—è°ƒåº¦å™¨ï¼ˆQueue Discipline, qdiscï¼‰ å‚æ•°ï¼Œç”¨æ¥å†³å®šï¼š\nå½“ç½‘ç»œæ¥å£æ²¡æœ‰æ˜¾å¼é…ç½® qdisc æ—¶ï¼Œå†…æ ¸é»˜è®¤ä½¿ç”¨å“ªä¸€ç§é˜Ÿåˆ—è°ƒåº¦ç®—æ³•æ¥å‘é€æ•°æ®åŒ…ã€‚\nä¸€å¥è¯ä¸“ä¸šå®šä¹‰ net.core.default_qdisc å†³å®šäº†ç½‘å¡å‘é€é˜Ÿåˆ—çš„é»˜è®¤è°ƒåº¦ç­–ç•¥ï¼Œç›´æ¥å½±å“ç½‘ç»œå»¶è¿Ÿã€ååé‡å’Œå…¬å¹³æ€§ã€‚\nqdisc æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¿«é€Ÿå›é¡¾ï¼‰ qdisc ä½äº å†…æ ¸ -\u0026gt; ç½‘ç»œæ ˆ -\u0026gt; ç½‘å¡é©±åŠ¨ä¹‹å‰\nä½œç”¨ï¼š\næ•°æ®åŒ…æ’é˜Ÿ æ‹¥å¡æ§åˆ¶ å…¬å¹³è°ƒåº¦ é™é€Ÿ / æ•´å½¢ ç®€åŒ–è·¯å¾„ï¼š\nåº”ç”¨ â†“ TCP/IP åè®®æ ˆ â†“ qdiscï¼ˆé˜Ÿåˆ—è°ƒåº¦ï¼‰ â†“ ç½‘å¡é©±åŠ¨ â†“ ç‰©ç†ç½‘å¡ default_qdisc çš„å¸¸è§å–å€¼ 1ï¸âƒ£ pfifo_fastï¼ˆä¼ ç»Ÿé»˜è®¤ï¼‰ net.core.default_qdisc = pfifo_fast ç‰¹ç‚¹\nå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ 3 ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ— ä¸æ„ŸçŸ¥å»¶è¿Ÿ ä¸åšæ‹¥å¡ç®¡ç† ä¼˜ç‚¹\nç®€å• CPU å¼€é”€ä½ ç¼ºç‚¹\nå®¹æ˜“ Bufferbloatï¼ˆå»¶è¿Ÿæš´æ¶¨ï¼‰ é«˜å¹¶å‘ä¸‹ä½“éªŒå·® é€‚åˆ\nè€å†…æ ¸ ä½å¹¶å‘ã€ç®€å•æœåŠ¡å™¨ 2ï¸âƒ£ fqï¼ˆFair Queueingï¼‰ net.core.default_qdisc = fq ç‰¹ç‚¹\næŒ‰æµå…¬å¹³è°ƒåº¦ æ¯ä¸ª TCP æµç‹¬ç«‹é˜Ÿåˆ— è‡ªåŠ¨ pacingï¼ˆå‘é€èŠ‚å¥æ§åˆ¶ï¼‰ ä¼˜ç‚¹\næ˜æ˜¾é™ä½å»¶è¿Ÿ é˜²æ­¢å•ä¸€è¿æ¥â€œéœ¸å å¸¦å®½â€ å¯¹ TCP éå¸¸å‹å¥½ ç¼ºç‚¹\nCPU æ¶ˆè€—ç•¥é«˜äº pfifo_fast é€‚åˆ\næ•°æ®åº“ RPC å¾®æœåŠ¡ å¤§å¤šæ•°æœåŠ¡å™¨åœºæ™¯ ğŸ“Œ RHEL 8+ / AlmaLinux 8+ æ¨è\n3ï¸âƒ£ fq_codelï¼ˆå…¬å¹³ + ä¸»åŠ¨é˜Ÿåˆ—ç®¡ç†ï¼‰ net.core.default_qdisc = fq_codel ç‰¹ç‚¹\nfq + CoDelï¼ˆä¸»åŠ¨ä¸¢åŒ…æ§åˆ¶ï¼‰ ä¸“é—¨è§£å†³ Bufferbloat å»¶è¿Ÿéå¸¸ç¨³å®š ä¼˜ç‚¹\næä½å»¶è¿Ÿ ç½‘ç»œä½“éªŒæœ€å¥½ ç¼ºç‚¹\nCPU æ¶ˆè€—æ›´é«˜ åœ¨è¶…é«˜åååœºæ™¯å¯èƒ½å½±å“æé™æ€§èƒ½ é€‚åˆ\nç½‘å…³ LVS / NAT äº‘ä¸»æœºå‡ºå£ å¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿçš„åœºæ™¯ å„åœºæ™¯æ¨èå€¼ï¼ˆå®æˆ˜å»ºè®®ï¼‰ âœ… é€šç”¨æœåŠ¡å™¨ï¼ˆæ•°æ®åº“ / Web / APIï¼‰ net.core.default_qdisc = fq âœ” å¹³è¡¡å»¶è¿Ÿä¸åå âœ” å‡ ä¹æ²¡æœ‰å‰¯ä½œç”¨ âœ” å¼ºçƒˆæ¨è\nâœ… ç½‘ç»œç½‘å…³ / LVS / NAT / é˜²ç«å¢™ net.core.default_qdisc = fq_codel âœ” é˜²æ­¢é˜Ÿåˆ—å †ç§¯ âœ” å»¶è¿Ÿç¨³å®š âœ” æŠ—çªå‘æµé‡èƒ½åŠ›å¼º\nâŒ ä¸æ¨èå†ç”¨ï¼ˆé™¤ééå¸¸è€çš„ç³»ç»Ÿï¼‰ net.core.default_qdisc = pfifo_fast ä¸ TCP æ‹¥å¡æ§åˆ¶çš„å…³ç³» default_qdisc ä¸ç­‰äº TCP æ‹¥å¡æ§åˆ¶ï¼Œä½†äºŒè€…å¼ºç›¸å…³ï¼š\nç»„ä»¶ ä½œç”¨ qdisc å†³å®š æ€ä¹ˆæ’é˜Ÿå‘åŒ… TCP æ‹¥å¡æ§åˆ¶ï¼ˆå¦‚ bbr/cubicï¼‰ å†³å®š å‘å¤šå°‘åŒ… æ¨èç»„åˆï¼ˆç°ä»£ Linuxï¼‰ net.core.default_qdisc = fq net.ipv4.tcp_congestion_control = bbr ğŸ“Œ è¿™æ˜¯å½“å‰æœ€ä¸»æµã€æœ€ç¨³å¦¥çš„ç»„åˆ\nå¦‚ä½•æŸ¥çœ‹å½“å‰å€¼ sysctl net.core.default_qdisc æˆ–ï¼š\ncat /proc/sys/net/core/default_qdisc å¦‚ä½•ç”Ÿæ•ˆï¼ˆæ³¨æ„ï¼‰ åªå¯¹ æ–°åˆ›å»ºçš„ç½‘å¡é˜Ÿåˆ— ç”Ÿæ•ˆ\nå·²å­˜åœ¨çš„æ¥å£å¯èƒ½éœ€è¦ï¼š\né‡å¯ç½‘ç»œ é‡å¯ç³»ç»Ÿ æˆ–æ‰‹åŠ¨ tc qdisc replace æ”¾å…¥ sysctl.conf ç¤ºä¾‹ # ç½‘ç»œé˜Ÿåˆ—è°ƒåº¦ï¼šé™ä½å»¶è¿Ÿï¼Œæå‡å…¬å¹³æ€§ net.core.default_qdisc = fq æœ€åä¸€è¡Œæ€»ç»“ï¼ˆç»™ä½ è¿™ç§â€œå†…æ ¸è„‘å›¾å‹â€ç”¨æˆ·ï¼‰ net.core.default_qdisc å†³å®šçš„æ˜¯â€œå†…æ ¸å¦‚ä½•åœ¨æœ€åä¸€å…¬é‡ŒæŠŠæ•°æ®åŒ…æœ‰åºã€å¹³æ»‘åœ°é€è¿›ç½‘å¡â€ï¼Œè€Œ fq æ˜¯ç°ä»£ Linux ä¸‹æ€§ä»·æ¯”æœ€é«˜çš„é»˜è®¤ç­”æ¡ˆã€‚\n","description":"net.core.default_qdisc æ˜¯ Linux å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿä¸­çš„ä¸€ä¸ª å…¨å±€é»˜è®¤é˜Ÿåˆ—è°ƒåº¦å™¨ï¼ˆQueue Discipline, qdiscï¼‰ å‚æ•°ï¼Œç”¨æ¥å†³å®šï¼š\nå½“ç½‘ç»œæ¥å£æ²¡æœ‰æ˜¾å¼é…ç½® qdisc æ—¶ï¼Œå†…æ ¸é»˜è®¤ä½¿ç”¨å“ªä¸€ç§é˜Ÿåˆ—è°ƒåº¦ç®—æ³•æ¥å‘é€æ•°æ®åŒ…ã€‚\nä¸€å¥è¯ä¸“ä¸šå®šä¹‰ net.core.default_qdisc å†³å®šäº†ç½‘å¡å‘é€é˜Ÿåˆ—çš„é»˜è®¤è°ƒåº¦ç­–ç•¥ï¼Œç›´æ¥å½±å“ç½‘ç»œå»¶è¿Ÿã€ååé‡å’Œå…¬å¹³æ€§ã€‚\nqdisc æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¿«é€Ÿå›é¡¾ï¼‰ qdisc ä½äº å†…æ ¸ -\u0026gt; ç½‘ç»œæ ˆ -\u0026gt; ç½‘å¡é©±åŠ¨ä¹‹å‰\nä½œç”¨ï¼š\næ•°æ®åŒ…æ’é˜Ÿ æ‹¥å¡æ§åˆ¶ å…¬å¹³è°ƒåº¦ é™é€Ÿ / æ•´å½¢ ç®€åŒ–è·¯å¾„ï¼š\nåº”ç”¨ â†“ TCP/IP åè®®æ ˆ â†“ qdiscï¼ˆé˜Ÿåˆ—è°ƒåº¦ï¼‰ â†“ ç½‘å¡é©±åŠ¨ â†“ ç‰©ç†ç½‘å¡ default_qdisc çš„å¸¸è§å–å€¼ 1ï¸âƒ£ pfifo_fastï¼ˆä¼ ç»Ÿé»˜è®¤ï¼‰ net.core.default_qdisc = pfifo_fast ç‰¹ç‚¹\n"},{"id":435,"href":"/operations/linux/sysctl-load/","title":"sysctl ä¼šåŠ è½½å“ªäº›ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼ŸåŠ è½½é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ","parent":"Linux","content":"è¿™æ˜¯ä¸€ä¸ªå¾ˆå…³é”®ã€ä½†ç»å¸¸è¢«è¯´é”™çš„é—®é¢˜ã€‚ä¸‹é¢æ˜¯ä¸€ä»½ RHEL / AlmaLinux / Debian / Ubuntu é€šç”¨ã€ä¸”å‡†ç¡®åˆ°å®ç°å±‚é¢çš„è¯´æ˜ã€‚\nä¸€ã€sysctl å®é™…ä¼šåŠ è½½å“ªäº›ç›®å½•ï¼Ÿ sysctl çš„é…ç½®æ¥æºåˆ†ä¸‰ç±»ï¼š\n1ï¸âƒ£ /etc/sysctl.confï¼ˆä¼ ç»Ÿä¸»é…ç½®ï¼‰ /etc/sysctl.conf å•ä¸€æ–‡ä»¶ æ—©æœŸ Linux åªæ”¯æŒå®ƒ ä»ç„¶è¢«æ”¯æŒ ä¼˜å…ˆçº§ ä½äº /etc/sysctl.d/ 2ï¸âƒ£ sysctl.d ç›®å½•ï¼ˆæ¨èæ–¹å¼ï¼‰ sysctl ä¼šæ‰«æä»¥ä¸‹ç›®å½•ï¼ˆä¸æ˜¯æ‰€æœ‰å‘è¡Œç‰ˆè·¯å¾„éƒ½ä¸€æ ·ï¼Œä½†é¡ºåºä¸€è‡´ï¼‰ï¼š\n/usr/lib/sysctl.d/*.conf /run/sysctl.d/*.conf /etc/sysctl.d/*.conf ğŸ“Œ è¿™æ˜¯ systemd è§„å®šçš„æ ‡å‡†é¡ºåº\n3ï¸âƒ£ å†…æ ¸è¿è¡Œæ—¶æ¥å£ï¼ˆä¸ç®—â€œé…ç½®æ–‡ä»¶â€ï¼‰ /proc/sys/* sysctl -w æˆ– echo å†™å…¥ é‡å¯å³å¤±æ•ˆ ä¼˜å…ˆçº§æœ€é«˜ï¼ˆä½†ä¸å¯æŒä¹…ï¼‰ äºŒã€å®Œæ•´åŠ è½½é¡ºåºï¼ˆéå¸¸é‡è¦ï¼‰ âœ… å®˜æ–¹æ­£ç¡®åŠ è½½é¡ºåºï¼ˆsystemd-sysctlï¼‰ æŒ‰ç›®å½•é¡ºåºåŠ è½½ -\u0026gt; åŒåå‚æ•°ååŠ è½½çš„è¦†ç›–å…ˆåŠ è½½çš„\n1. /usr/lib/sysctl.d/*.conf ï¼ˆç³»ç»Ÿ / å‘è¡Œç‰ˆé»˜è®¤ï¼‰ 2. /run/sysctl.d/*.conf ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼Œä¸´æ—¶ï¼‰ 3. /etc/sysctl.d/*.conf ï¼ˆç®¡ç†å‘˜è‡ªå®šä¹‰ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰ 4. /etc/sysctl.conf ï¼ˆæœ€ååŠ è½½ï¼Œä½†ä¼˜å…ˆçº§ä½äº /etc/sysctl.dï¼‰ âš ï¸ é‡ç‚¹ï¼š\nååŠ è½½çš„åŒåå‚æ•°ä¼šè¦†ç›–å…ˆåŠ è½½çš„ /etc/sysctl.conf æ˜¯æœ€åè¯»ï¼Œä½†ä¼˜å…ˆçº§ä½äº /etc/sysctl.d/*.conf è¿™ç‚¹å¾ˆå¤šæ–‡ç« å†™åäº†ï¼Œä½ è¿™é‡Œè¦è®°ä½æ­£ç¡®ç»“è®ºã€‚\nä¸‰ã€ç›®å½•å†…éƒ¨çš„åŠ è½½é¡ºåº åŒä¸€ç›®å½•å†… æŒ‰æ–‡ä»¶å ASCII å­—å…¸åºåŠ è½½ ä¾‹å¦‚ï¼š\n10-network.conf 20-vm.conf 99-custom.conf åŠ è½½é¡ºåºï¼š\n10 -\u0026gt; 20 -\u0026gt; 99 ğŸ“Œ æ•°å­—å‰ç¼€æ˜¯äº‹å®ä¸Šçš„â€œä¼˜å…ˆçº§æœºåˆ¶â€\nå››ã€ä¸ºä»€ä¹ˆæ¨èç”¨ /etc/sysctl.d/ è€Œä¸æ˜¯ sysctl.confï¼Ÿ åŸå› æ€»ç»“ä¸€å¥è¯ sysctl.conf æ˜¯â€œå•æ–‡ä»¶æ—¶ä»£â€çš„é—ç•™æ–¹æ¡ˆï¼Œsysctl.d æ˜¯ç°ä»£ systemd åŒ–ã€å¯ç»´æŠ¤ã€å¯åˆ†å±‚çš„æ–¹æ¡ˆã€‚\nå¯¹æ¯” æ–¹å¼ æ¨èåº¦ è¯´æ˜ /etc/sysctl.conf âŒ ä¸æ¨èæ–°å¢ æ˜“æ··ä¹±ã€ä¸å¯æ¨¡å—åŒ– /etc/sysctl.d/*.conf âœ… å¼ºçƒˆæ¨è å¯åˆ†ç±»ã€å¯è¦†ç›– /usr/lib/sysctl.d âš ï¸ ä¸è¦æ”¹ å‘è¡Œç‰ˆé»˜è®¤ /run/sysctl.d âš ï¸ ä¸´æ—¶ ç¨‹åºè‡ªåŠ¨ç”Ÿæˆ äº”ã€å…¸å‹æœ€ä½³å®è·µï¼ˆä½ è¿™ç§ç”¨æˆ·å¿…çœ‹ï¼‰ ç¤ºä¾‹ç›®å½•è§„åˆ’ /etc/sysctl.d/ â”œâ”€â”€ 10-kernel.conf # kernel / pid / numa â”œâ”€â”€ 20-vm.conf # å†…å­˜ / OOM / swap â”œâ”€â”€ 30-fs.conf # æ–‡ä»¶ç³»ç»Ÿ / inotify â”œâ”€â”€ 40-net-base.conf # åŸºç¡€ç½‘ç»œ â”œâ”€â”€ 50-net-tcp.conf # TCP è°ƒä¼˜ â”œâ”€â”€ 60-netfilter.conf # conntrack / nftables â”œâ”€â”€ 99-custom.conf # åº”æ€¥è¦†ç›– å…­ã€systemd æ˜¯ä»€ä¹ˆæ—¶å€™åŠ è½½ sysctl çš„ï¼Ÿ systemd-sysctl.service å¯åŠ¨é˜¶æ®µï¼šéå¸¸æ—© ç½‘ç»œã€å®¹å™¨ã€æ•°æ®åº“å¯åŠ¨å‰ å±äº åŸºç¡€ç³»ç»Ÿåˆå§‹åŒ– æŸ¥çœ‹çŠ¶æ€ï¼š\nsystemctl status systemd-sysctl é‡æ–°åŠ è½½ï¼ˆä¸é‡å¯ï¼‰ï¼š\nsysctl --system ç­‰ä»·äºï¼š\nsystemd-sysctl ä¸ƒã€å¦‚ä½•æŸ¥çœ‹â€œæœ€ç»ˆç”Ÿæ•ˆå€¼â€æ¥è‡ªå“ªé‡Œï¼Ÿ æŸ¥çœ‹å½“å‰å€¼ sysctl net.ipv4.tcp_tw_reuse æŸ¥æ‰¾æ˜¯å“ªä¸ªæ–‡ä»¶è®¾ç½®çš„ grep -R \u0026#34;net.ipv4.tcp_tw_reuse\u0026#34; \\ /etc/sysctl.conf \\ /etc/sysctl.d \\ /run/sysctl.d \\ /usr/lib/sysctl.d å…«ã€ä¸€å¥è¯ç»ˆææ€»ç»“ï¼ˆèƒŒä¸‹æ¥ï¼‰ sysctl å‚æ•°æŒ‰ /usr/lib -\u0026gt; /run -\u0026gt; /etc ç›®å½•é¡ºåºåŠ è½½ï¼ŒåŒç›®å½•æŒ‰æ–‡ä»¶åæ’åºï¼ŒååŠ è½½çš„å€¼è¦†ç›–å…ˆåŠ è½½çš„ï¼Œç”Ÿäº§ç³»ç»Ÿåº”åªåœ¨ /etc/sysctl.d/ ä¸­ç»´æŠ¤é…ç½®ã€‚\n","description":"è¿™æ˜¯ä¸€ä¸ªå¾ˆå…³é”®ã€ä½†ç»å¸¸è¢«è¯´é”™çš„é—®é¢˜ã€‚ä¸‹é¢æ˜¯ä¸€ä»½ RHEL / AlmaLinux / Debian / Ubuntu é€šç”¨ã€ä¸”å‡†ç¡®åˆ°å®ç°å±‚é¢çš„è¯´æ˜ã€‚\nä¸€ã€sysctl å®é™…ä¼šåŠ è½½å“ªäº›ç›®å½•ï¼Ÿ sysctl çš„é…ç½®æ¥æºåˆ†ä¸‰ç±»ï¼š\n1ï¸âƒ£ /etc/sysctl.confï¼ˆä¼ ç»Ÿä¸»é…ç½®ï¼‰ /etc/sysctl.conf å•ä¸€æ–‡ä»¶ æ—©æœŸ Linux åªæ”¯æŒå®ƒ ä»ç„¶è¢«æ”¯æŒ ä¼˜å…ˆçº§ ä½äº /etc/sysctl.d/ 2ï¸âƒ£ sysctl.d ç›®å½•ï¼ˆæ¨èæ–¹å¼ï¼‰ sysctl ä¼šæ‰«æä»¥ä¸‹ç›®å½•ï¼ˆä¸æ˜¯æ‰€æœ‰å‘è¡Œç‰ˆè·¯å¾„éƒ½ä¸€æ ·ï¼Œä½†é¡ºåºä¸€è‡´ï¼‰ï¼š\n"},{"id":436,"href":"/operations/linux/systemctl/","title":"systemctl","parent":"Linux","content":" ä¸€ã€systemctl æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ systemctl æ˜¯ systemd çš„ç»Ÿä¸€ç®¡ç†å…¥å£ï¼Œç”¨äºæ§åˆ¶ã€æŸ¥è¯¢å’Œè°ƒè¯• Linux ç³»ç»Ÿä¸­çš„æœåŠ¡ï¼ˆunitï¼‰ã€å¯åŠ¨æµç¨‹å’Œç³»ç»ŸçŠ¶æ€ã€‚\näºŒã€systemd / systemctl æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ 1ï¸âƒ£ Unitï¼ˆå•å…ƒï¼‰ systemd ç®¡ç†çš„ä¸€åˆ‡éƒ½æ˜¯ Unit\nç±»å‹ åç¼€ è¯´æ˜ Service .service æœåŠ¡ï¼ˆæœ€å¸¸ç”¨ï¼‰ Socket .socket å¥—æ¥å­—æ¿€æ´» Target .target å¯åŠ¨é˜¶æ®µ / é€»è¾‘åˆ†ç»„ Timer .timer å®šæ—¶ä»»åŠ¡ï¼ˆæ›¿ä»£ cronï¼‰ Mount .mount æŒ‚è½½ç‚¹ Path .path æ–‡ä»¶è·¯å¾„ç›‘æ§ Device .device è®¾å¤‡ Slice .slice èµ„æºæ§åˆ¶ç»„ Scope .scope å¤–éƒ¨è¿›ç¨‹ 2ï¸âƒ£ systemctl ç®¡ä»€ä¹ˆï¼Ÿ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ systemctl â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” systemd (PID 1) â”œâ”€ unit ç”Ÿå‘½å‘¨æœŸç®¡ç† â”œâ”€ ä¾èµ–å…³ç³» (After/Wants) â”œâ”€ èµ„æºæ§åˆ¶ (cgroups) â”œâ”€ æ—¥å¿— (journald) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ä¸‰ã€æœ€å¸¸ç”¨ systemctl å‘½ä»¤ï¼ˆå¿…é¡»ä¼šï¼‰ 1ï¸âƒ£ æœåŠ¡æ§åˆ¶ï¼ˆserviceï¼‰ systemctl start nginx systemctl stop nginx systemctl restart nginx systemctl reload nginx # ä¸é‡å¯ï¼Œé‡è½½é…ç½® restart vs reload restartï¼šè¿›ç¨‹é‡å¯ reloadï¼šå‘é€ä¿¡å·ï¼ˆå¦‚ HUPï¼‰ï¼Œä¸ä¸­æ–­æœåŠ¡ 2ï¸âƒ£ å¼€æœºè‡ªå¯æ§åˆ¶ systemctl enable nginx # å¼€æœºè‡ªå¯ systemctl disable nginx systemctl is-enabled nginx æœ¬è´¨ï¼šåˆ›å»º / åˆ é™¤ ç¬¦å·é“¾æ¥\n3ï¸âƒ£ æŸ¥çœ‹çŠ¶æ€ï¼ˆæœ€å¸¸ç”¨ï¼‰ systemctl status nginx ä½ èƒ½çœ‹åˆ°ï¼š\nActive çŠ¶æ€ Main PID æœ€è¿‘æ—¥å¿— å¤±è´¥åŸå› ï¼ˆexit codeï¼‰ 4ï¸âƒ£ åˆ—å‡ºæœåŠ¡ systemctl list-units --type=service systemctl list-units --state=failed systemctl list-unit-files å‘½ä»¤ ä½œç”¨ list-units å½“å‰åŠ è½½ list-unit-files ç£ç›˜ä¸Šå­˜åœ¨ å››ã€Targetï¼ˆå¯åŠ¨çº§åˆ«ï¼‰ç®¡ç† 1ï¸âƒ£ æŸ¥çœ‹å½“å‰å¯åŠ¨ç›®æ ‡ systemctl get-default å¸¸è§ï¼š\ntarget è¯´æ˜ multi-user.target å‘½ä»¤è¡ŒæœåŠ¡å™¨ graphical.target æ¡Œé¢ rescue.target å•ç”¨æˆ· emergency.target ç´§æ€¥æ¨¡å¼ 2ï¸âƒ£ ä¿®æ”¹é»˜è®¤å¯åŠ¨çº§åˆ« systemctl set-default multi-user.target 3ï¸âƒ£ åˆ‡æ¢è¿è¡Œçº§åˆ«ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰ systemctl isolate rescue.target äº”ã€Unit æ–‡ä»¶ç®¡ç†ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ unit æ–‡ä»¶åŠ è½½é¡ºåºï¼ˆæ ¸å¿ƒï¼‰ /etc/systemd/system/ # ç®¡ç†å‘˜è‡ªå®šä¹‰ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ /run/systemd/system/ # è¿è¡Œæ—¶ç”Ÿæˆ /usr/lib/systemd/system/ # å‘è¡Œç‰ˆæä¾› æ°¸è¿œä¸è¦ç›´æ¥æ”¹ /usr/lib\n2ï¸âƒ£ ä¿®æ”¹ unit çš„æ­£ç¡®æ–¹å¼ï¼ˆå¼ºçƒˆæ¨èï¼‰ ç¼–è¾‘è¦†ç›–é…ç½® systemctl edit nginx ç”Ÿæˆï¼š\n/etc/systemd/system/nginx.service.d/override.conf 3ï¸âƒ£ ä¿®æ”¹åå¿…é¡»æ‰§è¡Œ systemctl daemon-reload å‘½ä»¤ å«ä¹‰ daemon-reload é‡æ–°åŠ è½½ unit æ–‡ä»¶ daemon-reexec é‡æ–°æ‰§è¡Œ systemdï¼ˆæ›´é‡ï¼‰ å…­ã€Socket / Timerï¼ˆè¿›é˜¶ï¼‰ 1ï¸âƒ£ Socket æ¿€æ´» systemctl status rpcbind.socket systemctl start rpcbind.socket ç‰¹ç‚¹ï¼š\næœåŠ¡ æŒ‰éœ€å¯åŠ¨ socket å…ˆç›‘å¬ï¼Œservice åå¯åŠ¨ 2ï¸âƒ£ Timerï¼ˆæ›¿ä»£ cronï¼‰ systemctl list-timers å¯ç”¨ timerï¼š\nsystemctl enable --now backup.timer ä¸ƒã€æ—¥å¿—ä¸æ’éšœï¼ˆè¿ç»´å¿…å¤‡ï¼‰ 1ï¸âƒ£ ç»“åˆ journalctl journalctl -u nginx journalctl -u nginx -f journalctl -xe 2ï¸âƒ£ å¸¸è§å¤±è´¥åŸå› é€ŸæŸ¥ ç°è±¡ å¯èƒ½åŸå›  status=203/EXEC ExecStart è·¯å¾„é”™è¯¯ status=1/FAILURE ç¨‹åºè‡ªèº«é”™è¯¯ core-dump ç¨‹åº panic / assert Failed at step æƒé™ / SELinux 3ï¸âƒ£ æŸ¥çœ‹ unit è§£æç»“æœï¼ˆé«˜çº§ï¼‰ systemd-analyze verify nginx.service å…«ã€èµ„æºæ§åˆ¶ï¼ˆsystemctl + cgroupsï¼‰ systemd æ˜¯ cgroups çš„ç»Ÿä¸€å…¥å£\n[Service] MemoryMax=1G CPUQuota=50% TasksMax=200 æŸ¥çœ‹ï¼š\nsystemctl status nginx systemd-cgtop ä¹ã€systemctl ä¸å®¹å™¨ / Podman / runc çš„å…³ç³» systemctl ä¸ç›´æ¥ç®¡ç†å®¹å™¨\nä½†å¯ä»¥ï¼š\nç®¡ç† podman unit ç®¡ç† cri-o ç®¡ç† kubelet ä¾‹ï¼š\nsystemctl enable podman@mycontainer åã€å¸¸è§è¯¯åŒºï¼ˆéå¸¸é‡è¦ï¼‰ âŒ ç›´æ¥ä¿®æ”¹ /usr/lib/systemd/system/*.service âŒ å¿˜è®° daemon-reload âŒ ä¸åŒºåˆ† enable å’Œ start âŒ ç”¨ kill ç®¡æœåŠ¡è€Œä¸æ˜¯ systemctl åä¸€ã€ä¸€å¥è¯å¿ƒæ™ºæ¨¡å‹ï¼ˆè®°ä½è¿™ä¸ªï¼‰ systemctl æ˜¯ systemd çš„é¥æ§å™¨ï¼Œsystemd æ˜¯ Linux ä¸Šâ€œè¿›ç¨‹ + å¯åŠ¨ + èµ„æº + ä¾èµ–â€çš„ç»Ÿä¸€è°ƒåº¦å™¨ã€‚\nåäºŒã€é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—çº§ï¼‰ ## æœåŠ¡ systemctl start|stop|restart|reload xxx systemctl status xxx ## å¼€æœºè‡ªå¯ systemctl enable|disable xxx ## unit ç®¡ç† systemctl daemon-reload systemctl edit xxx ## å¯åŠ¨çº§åˆ« systemctl get-default systemctl set-default multi-user.target ## æ—¥å¿— journalctl -u xxx -f ## æ’éšœ systemd-analyze blame systemd-analyze critical-chain systemctl --type= å…¨éƒ¨å‚æ•°ï¼ˆUnit ç±»å‹ï¼‰ --type ç”¨äº æŒ‰ Unit ç±»å‹è¿‡æ»¤\nsystemctl list-units --type=TYPE systemctl list-unit-files --type=TYPE âœ… å…¨éƒ¨åˆæ³•ç±»å‹ type unit åç¼€ è¯´æ˜ service .service æœåŠ¡ï¼ˆæœ€å¸¸ç”¨ï¼‰ socket .socket å¥—æ¥å­—æ¿€æ´» target .target å¯åŠ¨ç›®æ ‡ / åˆ†ç»„ timer .timer å®šæ—¶å™¨ï¼ˆcron æ›¿ä»£ï¼‰ mount .mount æŒ‚è½½ç‚¹ automount .automount è‡ªåŠ¨æŒ‚è½½ path .path è·¯å¾„ç›‘æ§ device .device è®¾å¤‡ swap .swap swap åˆ†åŒº slice .slice cgroup èµ„æºåˆ‡ç‰‡ scope .scope å¤–éƒ¨è¿›ç¨‹ç»„ ğŸ”¹ ç¤ºä¾‹ systemctl list-units --type=service systemctl list-units --type=socket systemctl list-units --type=timer systemctl --state= å…¨éƒ¨å‚æ•°ï¼ˆUnit çŠ¶æ€ï¼‰ --state ç”¨äº æŒ‰è¿è¡ŒçŠ¶æ€è¿‡æ»¤\nsystemctl list-units --state=STATE 1ï¸âƒ£ æ´»è·ƒæ€ï¼ˆActive Statesï¼‰ state å«ä¹‰ active æ­£åœ¨è¿è¡Œ inactive æœªè¿è¡Œ activating æ­£åœ¨å¯åŠ¨ deactivating æ­£åœ¨åœæ­¢ reloading æ­£åœ¨ reload ç¤ºä¾‹ systemctl list-units --state=active systemctl list-units --state=activating 2ï¸âƒ£ å¤±è´¥æ€ï¼ˆFailedï¼‰ state å«ä¹‰ failed å¯åŠ¨æˆ–è¿è¡Œå¤±è´¥ systemctl list-units --state=failed 3ï¸âƒ£ Unit æ–‡ä»¶çŠ¶æ€ï¼ˆlist-unit-files ä¸“ç”¨ï¼‰ âš ï¸ åªç”¨äº list-unit-files\nsystemctl list-unit-files --state=STATE state å«ä¹‰ enabled å·²è®¾ç½®å¼€æœºè‡ªå¯ disabled æœªè®¾ç½®è‡ªå¯ static ä¸èƒ½å•ç‹¬å¯ç”¨ï¼ˆè¢«ä¾èµ–ï¼‰ masked è¢«å®Œå…¨å±è”½ generated systemd è‡ªåŠ¨ç”Ÿæˆ transient ä¸´æ—¶ unit indirect é—´æ¥å¯ç”¨ bad unit æ–‡ä»¶æŸå 4ï¸âƒ£ ç‰¹æ®ŠçŠ¶æ€ï¼ˆè¾ƒå°‘ä½¿ç”¨ä½†å­˜åœ¨ï¼‰ state è¯´æ˜ plugged è®¾å¤‡å·²å°±ç»ªï¼ˆdeviceï¼‰ mounted å·²æŒ‚è½½ï¼ˆmountï¼‰ waiting ç­‰å¾…æ¡ä»¶ï¼ˆpath / automountï¼‰ --type + --state å¸¸ç”¨ç»„åˆï¼ˆå®æˆ˜ï¼‰ 1ï¸âƒ£ æŸ¥çœ‹å¤±è´¥çš„æœåŠ¡ systemctl list-units --type=service --state=failed 2ï¸âƒ£ æŸ¥çœ‹æ­£åœ¨å¯åŠ¨çš„æœåŠ¡ï¼ˆæ’å¡å¯åŠ¨ï¼‰ systemctl list-units --state=activating 3ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰å®šæ—¶ä»»åŠ¡ systemctl list-units --type=timer systemctl list-timers 4ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰ socket æ¿€æ´»æœåŠ¡ systemctl list-units --type=socket 5ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰å·²å¯ç”¨ä½†æœªè¿è¡Œçš„æœåŠ¡ systemctl list-unit-files --state=enabled systemctl list-units --type=service --state=inactive å®¹æ˜“æ··æ·†çš„ç‚¹ï¼ˆé‡ç‚¹ï¼‰ â— list-units vs list-unit-files å‘½ä»¤ çœ‹ä»€ä¹ˆ list-units å½“å‰ å·²åŠ è½½ / è¿è¡Œæ€ list-unit-files ç£ç›˜ä¸Šçš„ unit æ–‡ä»¶ â— active â‰  running socket / target ä¹Ÿå¯ä»¥æ˜¯ active ä¸ä¸€å®šæœ‰è¿›ç¨‹ å®Œæ•´é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ï¼‰ ## æ‰€æœ‰ unit ç±»å‹ systemctl list-units --type=service systemctl list-units --type=socket systemctl list-units --type=timer systemctl list-units --type=mount systemctl list-units --type=target ## çŠ¶æ€è¿‡æ»¤ systemctl list-units --state=active systemctl list-units --state=failed systemctl list-units --state=activating ## unit æ–‡ä»¶çŠ¶æ€ systemctl list-unit-files --state=enabled systemctl list-unit-files --state=masked # æŸ¥çœ‹æ‰€æœ‰å·²å¯ç”¨çš„æœåŠ¡ systemctl list-unit-files --type=service --state=enabled # ä»…æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„æœåŠ¡ # ä¸ä¸€å®šåŒ…å«æ‰€æœ‰â€œå·²å¯ç”¨â€çš„æœåŠ¡ systemctl list-units --type=service --state=running # æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ˜¯å¦å¯ç”¨ systemctl is-enabled nginx æ€»ç»“ --type å†³å®šâ€œçœ‹å“ªç±» unitâ€ï¼Œ--state å†³å®šâ€œçœ‹ä»€ä¹ˆçŠ¶æ€â€ï¼Œä¸¤è€…ç»„åˆå°±æ˜¯ systemd çš„æ ¸å¿ƒè¿‡æ»¤èƒ½åŠ›ã€‚\n","description":" ä¸€ã€systemctl æ˜¯ä»€ä¹ˆï¼ˆä¸€å¥è¯ï¼‰ systemctl æ˜¯ systemd çš„ç»Ÿä¸€ç®¡ç†å…¥å£ï¼Œç”¨äºæ§åˆ¶ã€æŸ¥è¯¢å’Œè°ƒè¯• Linux ç³»ç»Ÿä¸­çš„æœåŠ¡ï¼ˆunitï¼‰ã€å¯åŠ¨æµç¨‹å’Œç³»ç»ŸçŠ¶æ€ã€‚\näºŒã€systemd / systemctl æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ 1ï¸âƒ£ Unitï¼ˆå•å…ƒï¼‰ systemd ç®¡ç†çš„ä¸€åˆ‡éƒ½æ˜¯ Unit\n"},{"id":437,"href":"/operations/linux/systemd-path/","title":"systemd ç¯å¢ƒå˜é‡ PATH","parent":"Linux","content":"åœ¨ systemd æœåŠ¡è„šæœ¬ä¸­æ‰©å±• PATH ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥é€šè¿‡ Environment= æˆ– EnvironmentFile= æŒ‡ä»¤åœ¨ [Service] èŠ‚è®¾ç½®ï¼Œä½¿ç”¨ PATH=/new/path:$PATH è¯­æ³•è¿½åŠ æ–°è·¯å¾„ï¼Œæˆ–åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­å®šä¹‰åå†å¼•ç”¨ã€‚\næ–¹æ³•ä¸€ï¼šç›´æ¥åœ¨æœåŠ¡å•å…ƒæ–‡ä»¶ä¸­æ‰©å±•ï¼ˆæ¨èå°å‹ä¿®æ”¹ï¼‰ åœ¨ systemd æœåŠ¡å•å…ƒæ–‡ä»¶ï¼ˆå¦‚ /etc/systemd/system/my-service.serviceï¼‰çš„ [Service] æ®µè½ä¸­æ·»åŠ  Environment æŒ‡ä»¤ï¼š\n[Unit] Description=My Custom Service [Service] Type=simple ExecStart=/usr/local/bin/my_app # æ‰©å±• PATHï¼Œå°† /opt/mytools/bin æ·»åŠ åˆ°ç°æœ‰ PATH çš„æœ€å‰é¢ Environment=\u0026#34;PATH=/opt/mytools/bin:$PATH\u0026#34; # æˆ–è€…æ·»åŠ åœ¨æœ«å°¾ # Environment=\u0026#34;PATH=$PATH:/opt/mytools/bin\u0026#34; User=myuser [Install] WantedBy=multi-user.target æ–¹æ³•äºŒï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆæ¨èå¤§å‹/å¤šæœåŠ¡å…±äº«ï¼‰ åˆ›å»ºä¸€ä¸ªåŒ…å«ç¯å¢ƒå˜é‡çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ /etc/sysconfig/my-app-env æˆ– /etc/default/my-app-envï¼š\n# /etc/sysconfig/my-app-env MY_APP_HOME=/usr/local/myapp # è¿½åŠ æ–°çš„è·¯å¾„ PATH=/usr/local/myapp/bin:$PATH # æˆ–è€…ç”¨æ›´æ ‡å‡†çš„æ–¹å¼è¦†ç›–å¹¶è¿½åŠ  # PATH=/opt/new_tools/bin:$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin åœ¨ systemd æœåŠ¡å•å…ƒæ–‡ä»¶ä¸­ä½¿ç”¨ EnvironmentFile æŒ‡ä»¤å¼•ç”¨ï¼š\n[Service] Type=simple ExecStart=/usr/local/bin/my_app EnvironmentFile=/etc/sysconfig/my-app-env User=myuser å…³é”®ç‚¹è¯´æ˜ $PATH å¼•ç”¨äº†ç³»ç»Ÿé»˜è®¤çš„ PATH å˜é‡å€¼ã€‚\nè·¯å¾„é¡ºåºå†³å®šä¼˜å…ˆçº§ï¼Œä½äº $PATH å‰é¢çš„è·¯å¾„ä¼šè¢«ä¼˜å…ˆæœç´¢ã€‚\nä¿®æ”¹åéœ€è¦æ‰§è¡Œ sudo systemctl daemon-reload å’Œ sudo systemctl restart my-service ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚\nPATH é”™è¯¯ # ç¯å¢ƒå˜é‡ Environment=\u0026#34;PATH=/usr/local/jdk/21.0.9/bin:$PATH\u0026#34; Environment=\u0026#34;JENKINS_HOME=/data/jenkins/data\u0026#34; # å·¥ä½œç›®å½• WorkingDirectory=/data/jenkins/war # å¯åŠ¨å‘½ä»¤ ExecStart=java -jar jenkins.war --httpPort=8910 --prefix=/jenkins Failed at step EXEC spawning java: No such file or directory\né€šå¸¸ ä¸æ˜¯ PATH é…ç½®çš„é—®é¢˜ï¼Œè€Œæ˜¯ systemd æ‰¾ä¸åˆ° java å¯æ‰§è¡Œæ–‡ä»¶ã€‚\nåŸå› å’Œè§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š\n1. é—®é¢˜åŸå›  ä½ å†™çš„ ExecStart æ˜¯ï¼š\nExecStart=java -jar jenkins.war --httpPort=8910 --prefix=/jenkins systemd ä¸ä¼šè‡ªåŠ¨åŠ è½½ shell ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ $PATHã€‚\nè™½ç„¶ä½ ç”¨ï¼š\nEnvironment=\u0026#34;PATH=/usr/local/jdk/21.0.9/bin:$PATH\u0026#34; ä½† $PATH åœ¨ systemd ç¯å¢ƒä¸­ ä¸è¢«æ‰©å±•ï¼Œ$PATH ä¼šè¢«å½“ä½œå­—é¢å€¼ã€‚\næ‰€ä»¥ systemd æ‰§è¡Œ java æ—¶æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŠ¥ No such file or directoryã€‚\n2. æ­£ç¡®å†™æ³• æ–¹æ³• Aï¼šå†™å…¨è·¯å¾„ ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpPort=8910 --prefix=/jenkins è¿™æ˜¯æœ€å¯é çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç”Ÿäº§ç¯å¢ƒæ¨èåšæ³•ã€‚\næ–¹æ³• Bï¼šä½¿ç”¨ Environment æŒ‡å®šå®Œæ•´ PATHï¼ˆä¸ä½¿ç”¨ $PATHï¼‰ Environment=\u0026#34;PATH=/usr/local/jdk/21.0.9/bin:/usr/bin:/bin\u0026#34; ExecStart=java -jar jenkins.war --httpPort=8910 --prefix=/jenkins æ³¨æ„ï¼šsystemd ä¸ä¼šå±•å¼€ $PATHï¼Œå¿…é¡»å†™å®Œæ•´è·¯å¾„ã€‚\næ–¹æ³• Cï¼šä½¿ç”¨ ExecStart=/bin/sh -c \u0026ldquo;\u0026hellip;\u0026quot;ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰ ExecStart=/bin/sh -c \u0026#39;java -jar jenkins.war --httpPort=8910 --prefix=/jenkins\u0026#39; systemd ä¼šè°ƒç”¨ shell å»è§£æ $PATHï¼Œå¯è¡Œä½†å¢åŠ ä¸€å±‚ shellï¼Œè°ƒè¯•ä¸æ–¹ä¾¿ã€‚\n3. å®Œæ•´ systemd ç¤ºä¾‹ï¼ˆæ¨èæ–¹å¼ï¼‰ [Unit] Description=Jenkins CI Server After=network.target [Service] Type=simple User=jenkins Group=jenkins Environment=\u0026#34;JENKINS_HOME=/data/jenkins/data\u0026#34; WorkingDirectory=/data/jenkins/war ExecStart=/usr/local/jdk/21.0.9/bin/java -jar jenkins.war --httpPort=8910 --prefix=/jenkins Restart=always RestartSec=5s StandardOutput=journal StandardError=journal LimitNOFILE=65536 [Install] WantedBy=multi-user.target 4. æ³¨æ„äº‹é¡¹ /data/jenkins/war/jenkins.war å¿…é¡»å­˜åœ¨å¹¶æœ‰ jenkins ç”¨æˆ·è®¿é—®æƒé™ã€‚\næ—¥å¿—æŸ¥çœ‹ï¼š\njournalctl -u jenkins -f ä¿®æ”¹ systemd æ–‡ä»¶ååˆ«å¿˜äº†ï¼š\nsystemctl daemon-reload systemctl restart jenkins âœ… æ€»ç»“ systemd ä¸ä¼šå±•å¼€ $PATH ç”Ÿäº§ç¯å¢ƒæ¨è ExecStart ç”¨ java å…¨è·¯å¾„ $PATH å¯ä»¥è®¾ç½®ï¼Œä½†ä¸è¦å†™ $PATHï¼Œå†™å®Œæ•´è·¯å¾„å³å¯ ","description":"åœ¨ systemd æœåŠ¡è„šæœ¬ä¸­æ‰©å±• PATH ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥é€šè¿‡ Environment= æˆ– EnvironmentFile= æŒ‡ä»¤åœ¨ [Service] èŠ‚è®¾ç½®ï¼Œä½¿ç”¨ PATH=/new/path:$PATH è¯­æ³•è¿½åŠ æ–°è·¯å¾„ï¼Œæˆ–åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­å®šä¹‰åå†å¼•ç”¨ã€‚\næ–¹æ³•ä¸€ï¼šç›´æ¥åœ¨æœåŠ¡å•å…ƒæ–‡ä»¶ä¸­æ‰©å±•ï¼ˆæ¨èå°å‹ä¿®æ”¹ï¼‰ åœ¨ systemd æœåŠ¡å•å…ƒæ–‡ä»¶ï¼ˆå¦‚ /etc/systemd/system/my-service.serviceï¼‰çš„ [Service] æ®µè½ä¸­æ·»åŠ  Environment æŒ‡ä»¤ï¼š\n[Unit] Description=My Custom Service [Service] Type=simple ExecStart=/usr/local/bin/my_app # æ‰©å±• PATHï¼Œå°† /opt/mytools/bin æ·»åŠ åˆ°ç°æœ‰ PATH çš„æœ€å‰é¢ Environment=\u0026#34;PATH=/opt/mytools/bin:$PATH\u0026#34; # æˆ–è€…æ·»åŠ åœ¨æœ«å°¾ # Environment=\u0026#34;PATH=$PATH:/opt/mytools/bin\u0026#34; User=myuser [Install] WantedBy=multi-user.target æ–¹æ³•äºŒï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆæ¨èå¤§å‹/å¤šæœåŠ¡å…±äº«ï¼‰ åˆ›å»ºä¸€ä¸ªåŒ…å«ç¯å¢ƒå˜é‡çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ /etc/sysconfig/my-app-env æˆ– /etc/default/my-app-envï¼š\n"},{"id":438,"href":"/tags/","title":"Tags","parent":"Documents","content":"","description":""},{"id":439,"href":"/backend/python/official/toml/","title":"TOML","parent":"Official","content":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/tomllib.html\nğŸ“Œ ä¸€ã€TOML æ˜¯ä»€ä¹ˆï¼Ÿ TOMLï¼ˆTom\u0026rsquo;s Obvious Minimal Languageï¼‰ æ˜¯ä¸€ç§ç»“æ„æ¸…æ™°ã€éå¸¸é€‚åˆä½œä¸ºé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œç±»ä¼¼ INIï¼Œä½†è¯­æ³•æ›´ä¸¥æ ¼ï¼Œæ”¯æŒæ›´å¤šæ•°æ®ç±»å‹ã€‚\nè¢«å¹¿æ³›ç”¨äºï¼š\npyproject.toml Poetry Black Ruff FastAPI é…ç½® å¼€å‘ç¯å¢ƒå˜é‡ ğŸ“Œ äºŒã€Python å¦‚ä½•è¯»å†™ TOML Python æ²¡æœ‰å†…ç½® TOMLï¼Œéœ€è¦å®‰è£…åº“ï¼š\nå®‰è£…æ¨èåº“ï¼štomliï¼ˆè¯»ï¼‰æˆ– tomllibï¼ˆPython 3.11+ å†…ç½®ï¼‰\nPython 3.11+ï¼šæ¨èä½¿ç”¨å†…ç½® tomllib Python 3.10-ï¼šæ¨èä½¿ç”¨éå¸¸è½»é‡çš„ tomli Python 3.11+ï¼š\nimport tomllib with open(\u0026#34;config.toml\u0026#34;, \u0026#34;rb\u0026#34;) as f: data = tomllib.load(f) Python 3.10 æˆ–æ›´ä½ï¼š\npip install tomli import tomli with open(\u0026#34;config.toml\u0026#34;, \u0026#34;rb\u0026#34;) as f: data = tomli.load(f) âœï¸ å†™å…¥ TOMLï¼šä½¿ç”¨ tomli_w æˆ– tomlkit æ¨èï¼š\npip install tomli-w ç¤ºä¾‹ï¼š\nimport tomli_w data = { \u0026#34;server\u0026#34;: {\u0026#34;host\u0026#34;: \u0026#34;127.0.0.1\u0026#34;, \u0026#34;port\u0026#34;: 8080}, \u0026#34;debug\u0026#34;: True, } with open(\u0026#34;config.toml\u0026#34;, \u0026#34;wb\u0026#34;) as f: tomli_w.dump(data, f) è¾“å‡ºï¼š\n[server] host = \u0026#34;127.0.0.1\u0026#34; port = 8080 debug = true ğŸ“Œ ä¸‰ã€TOML åŸºæœ¬è¯­æ³•é€ŸæŸ¥ 1. é”®å€¼å¯¹ title = \u0026#34;config system\u0026#34; port = 8080 enabled = true 2. è¡¨ï¼ˆç±»ä¼¼ dictï¼‰ [database] host = \u0026#34;localhost\u0026#34; port = 3306 3. åµŒå¥—è¡¨ [server.api] url = \u0026#34;/v1\u0026#34; timeout = 10 ç­‰åŒäº Pythonï¼š\n{\u0026#34;server\u0026#34;: {\u0026#34;api\u0026#34;: {\u0026#34;url\u0026#34;: \u0026#34;/v1\u0026#34;, \u0026#34;timeout\u0026#34;: 10}}} 4. æ•°ç»„ ports = [8001, 8002, 8003] 5. æ•°ç»„è¡¨ï¼ˆç±»ä¼¼ list of dictï¼‰ [[plugins]] name = \u0026#34;redis\u0026#34; enabled = true [[plugins]] name = \u0026#34;mysql\u0026#34; enabled = false ç­‰äº Pythonï¼š\n{ \u0026#34;plugins\u0026#34;: [ {\u0026#34;name\u0026#34;: \u0026#34;redis\u0026#34;, \u0026#34;enabled\u0026#34;: True}, {\u0026#34;name\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;enabled\u0026#34;: False}, ] } 6. æ—¥æœŸæ—¶é—´ï¼ˆå†…ç½®æ”¯æŒ RFC3339ï¼‰ time = 2025-02-20T08:00:00Z Python è¯»å– -\u0026gt; datetime å¯¹è±¡ã€‚\nğŸ“Œ å››ã€Python è¯»å– TOML æ–‡ä»¶ç¤ºä¾‹ config.tomlï¼š\n[server] host = \u0026#34;127.0.0.1\u0026#34; port = 8080 [auth] token = \u0026#34;abcd1234\u0026#34; expires = 30 Python è¯»å–ï¼š\nimport tomllib with open(\u0026#34;config.toml\u0026#34;, \u0026#34;rb\u0026#34;) as f: cfg = tomllib.load(f) print(cfg[\u0026#34;server\u0026#34;][\u0026#34;host\u0026#34;]) print(cfg[\u0026#34;auth\u0026#34;][\u0026#34;token\u0026#34;]) ğŸ“Œ äº”ã€åœ¨ FastAPI é¡¹ç›®ä¸­åŠ è½½ TOML é…ç½® settings.toml\n[database] url = \u0026#34;postgresql://user:pass@localhost/db\u0026#34; [api] debug = true settings.py\nimport tomllib from pathlib import Path BASE_DIR = Path(__file__).resolve().parent config_path = BASE_DIR / \u0026#34;settings.toml\u0026#34; with open(config_path, \u0026#34;rb\u0026#34;) as f: cfg = tomllib.load(f) DB_URL = cfg[\u0026#34;database\u0026#34;][\u0026#34;url\u0026#34;] DEBUG = cfg[\u0026#34;api\u0026#34;][\u0026#34;debug\u0026#34;] ğŸ“Œ å…­ã€å†™ä¸€ä¸ªç»Ÿä¸€çš„ utils.toml æ¨¡å— # utils/toml.py import tomllib import tomli_w from pathlib import Path from typing import Any def load(path: str | Path) -\u0026gt; dict: path = Path(path) with open(path, \u0026#34;rb\u0026#34;) as f: return tomllib.load(f) def save(path: str | Path, data: dict) -\u0026gt; None: path = Path(path) with open(path, \u0026#34;wb\u0026#34;) as f: tomli_w.dump(data, f) ä½¿ç”¨ï¼š\nfrom utils.toml import load, save config = load(\u0026#34;config.toml\u0026#34;) save(\u0026#34;out.toml\u0026#34;, config) ğŸ“Œ ä¸ƒã€pyproject.toml å¸¸ç”¨ç»“æ„ ä½ çš„é¡¹ç›®ä¸­è‚¯å®šä¼šç”¨åˆ°ã€‚\nå…¸å‹ pyproject.tomlï¼š\n[project] name = \u0026#34;my_app\u0026#34; version = \u0026#34;1.0.0\u0026#34; requires-python = \u0026#34;\u0026gt;=3.12\u0026#34; [tool.black] line-length = 100 [tool.ruff] select = [\u0026#34;E\u0026#34;, \u0026#34;F\u0026#34;] ignore = [\u0026#34;E501\u0026#34;] [tool.poetry] packages = [{ include = \u0026#34;app\u0026#34; }] ğŸ“Œ å…«ã€TOML vs JSON å“ªä¸ªæ›´é€‚åˆä½œä¸ºé…ç½®æ–‡ä»¶ï¼Ÿ ç‰¹æ€§ TOML JSON æ³¨é‡Šæ”¯æŒ âœ… âŒ æ›´é€‚åˆäººè¯»å†™ âœ… âŒ é…ç½®åˆ†èŠ‚ç»“æ„ âœ… âŒ é€‚åˆæ—¥å¿—/é…ç½® âœ… ä¸€èˆ¬ æ›´ä¸¥æ ¼ï¼ˆå°‘ bugï¼‰ âœ… âŒ æ”¯æŒå¤šè¡Œå­—ç¬¦ä¸² âœ… ä¸€èˆ¬ æ‰€ä»¥ï¼š\né…ç½®æ–‡ä»¶ï¼ˆsettingsã€å·¥å…·é…ç½®ï¼‰ -\u0026gt; ç”¨ TOML æ•°æ®ä¼ è¾“ï¼ˆAPIï¼‰ -\u0026gt; ç”¨ JSON / orjson ğŸ“Œ ä¹ã€æ€»ç»“ï¼ˆä½ åªéœ€è¦è®°ä½è¿™äº›ï¼‰\nPython 3.11 å†…ç½® tomllib -\u0026gt; åªèƒ½è¯» å†™å…¥ç”¨ï¼štomli_w TOML çš„ç»“æ„å°±æ˜¯ï¼š [table] [[array of table]] Python è¯»å–åå°±æ˜¯æ™®é€š dict æœ€é€‚åˆä½œä¸ºé¡¹ç›®é…ç½®æ–‡ä»¶ ","description":"å®˜æ–¹æ–‡æ¡£: https://docs.python.org/zh-cn/3.12/library/tomllib.html\nğŸ“Œ ä¸€ã€TOML æ˜¯ä»€ä¹ˆï¼Ÿ TOMLï¼ˆTom\u0026rsquo;s Obvious Minimal Languageï¼‰ æ˜¯ä¸€ç§ç»“æ„æ¸…æ™°ã€éå¸¸é€‚åˆä½œä¸ºé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œç±»ä¼¼ INIï¼Œä½†è¯­æ³•æ›´ä¸¥æ ¼ï¼Œæ”¯æŒæ›´å¤šæ•°æ®ç±»å‹ã€‚\nè¢«å¹¿æ³›ç”¨äºï¼š\npyproject.toml Poetry Black Ruff FastAPI é…ç½® å¼€å‘ç¯å¢ƒå˜é‡ ğŸ“Œ äºŒã€Python å¦‚ä½•è¯»å†™ TOML Python æ²¡æœ‰å†…ç½® TOMLï¼Œéœ€è¦å®‰è£…åº“ï¼š\nå®‰è£…æ¨èåº“ï¼štomliï¼ˆè¯»ï¼‰æˆ– tomllibï¼ˆPython 3.11+ å†…ç½®ï¼‰\n"},{"id":440,"href":"/backend/python/official/try/","title":"Try","parent":"Official","content":" ğŸŸ¦ 1. åŸºæœ¬ç»“æ„ try: ... except ExceptionType: ... else: ... finally: ... ä½œç”¨ï¼š\ntryï¼šæ‰§è¡Œå¯èƒ½å‡ºé”™çš„ä»£ç  exceptï¼šæ•è·å¼‚å¸¸å¹¶å¤„ç† elseï¼štry æ— å¼‚å¸¸æ—¶æ‰§è¡Œï¼ˆå°‘ç”¨ï¼Œä½†éå¸¸æœ‰ç”¨ï¼‰ finallyï¼šæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½æ‰§è¡Œï¼ˆå¸¸ç”¨äºé‡Šæ”¾èµ„æºï¼‰ ğŸŸ© 2. æœ€å¸¸è§çš„ try-except try: result = 10 / 0 except ZeroDivisionError: print(\u0026#34;ä¸èƒ½é™¤ä»¥ 0\u0026#34;) ğŸŸ¦ 3. æ•è·å¤šç§å¼‚å¸¸ try: ... except (KeyError, ValueError, TypeError): ... ğŸŸ© 4. æ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆå·¥ç¨‹ä¸­å¸¸ç”¨ï¼Œä½†å¿…é¡»è°¨æ…ï¼‰ try: ... except Exception as e: logger.exception(e) é€‚ç”¨ï¼š\nAPI æœåŠ¡ç«¯ çˆ†ç‚¸èŒƒå›´è¾ƒå¤§çš„ä»»åŠ¡ å®ˆæŠ¤ç¨‹åº æ•°æ®åŒæ­¥ ä¸é€‚åˆï¼š\nå°èŒƒå›´é€»è¾‘ï¼Œå¯¼è‡´éšè— bug ğŸŸ¦ 5. è·å–å¼‚å¸¸å¯¹è±¡ except Exception as e: print(type(e), e) ğŸŸ© 6. ä½¿ç”¨ elseï¼ˆéå¸¸ Pythonicï¼Œä½†å®¹æ˜“å¿½ç•¥ï¼‰ try: data = fetch() except Exception: log(\u0026#34;å¤±è´¥\u0026#34;) else: log(\u0026#34;æˆåŠŸï¼Œæ‰§è¡Œåç½®é€»è¾‘\u0026#34;) ä¼˜åŠ¿ï¼š\ntry åªåŒ…å«çœŸæ­£å¯èƒ½æŠ¥é”™çš„è¯­å¥ å…¶ä»–é€»è¾‘å†™åˆ° elseï¼Œä»£ç æ›´å¹²å‡€ ğŸŸ¦ 7. ä½¿ç”¨ finally åšæ¸…ç†ï¼ˆå¼ºçƒˆæ¨èç†Ÿç»ƒæŒæ¡ï¼‰ try: conn = connect() ... finally: conn.close() finally æ°¸è¿œæ‰§è¡Œï¼Œå³ä½¿ï¼š\nreturn break continue exception sys.exit() éƒ½æ— æ•ˆï¼Œfinally éƒ½ä¼šæ‰§è¡Œã€‚\nğŸŸ© 8. try-except-finally çš„å…¨ç»“æ„ä¾‹å­ try: x = risky() except ValueError: print(\u0026#34;å€¼é”™è¯¯\u0026#34;) else: print(\u0026#34;æ²¡æœ‰å¼‚å¸¸\u0026#34;) finally: print(\u0026#34;ä¸€å®šæ‰§è¡Œ\u0026#34;) ğŸŸ¦ 9. è‡ªå®šä¹‰æŠ›å¼‚å¸¸ if not isinstance(x, int): raise TypeError(\u0026#34;x å¿…é¡»æ˜¯ int\u0026#34;) ä½ é¡¹ç›®ä¸­å»ºè®®å¯¹æ‰€æœ‰è¾“å…¥è¿›è¡Œä¸¥æ ¼ç±»å‹æ£€æŸ¥ã€‚\nğŸŸ© 10. try + loguruï¼ˆä½ é¡¹ç›®ä¼šç”¨åˆ°ï¼‰ try: db.save(data) except Exception as e: logger.exception(f\u0026#34;ä¿å­˜å¤±è´¥: {e}\u0026#34;) loguru ä¼šåŒæ—¶æ‰“å°å †æ ˆï¼Œéå¸¸æ¸…æ™°ã€‚\nğŸŸ¦ 11. å¸¸è§å‘ï¼šexcept åé¢æ¼å†™ Exception é”™è¯¯ï¼š\nexcept: pass ä¸¥é‡é—®é¢˜ï¼š\næŠŠç³»ç»Ÿé€€å‡ºã€KeyboardInterrupt éƒ½åƒæ‰ å¯¼è‡´è°ƒè¯•å›°éš¾ éšè— bug æ­£ç¡®ï¼š\nexcept Exception: pass æˆ–è€…æ›´æ¨èï¼š\nexcept Exception as e: logger.error(e) ğŸŸ© 12. try åœ¨å®é™…é¡¹ç›®ä¸­çš„ä¼˜é›…ä½¿ç”¨æ–¹å¼ â‘  API è°ƒç”¨ï¼ˆä½ é¡¹ç›®çˆ¬å– cls / stock / news æ—¶å¸¸ç”¨ï¼‰ def fetch(url): try: resp = requests.get(url, timeout=10) resp.raise_for_status() return resp.json() except Exception as e: logger.exception(f\u0026#34;è¯·æ±‚å¤±è´¥: {url}\u0026#34;) return None â‘¡ æ•°æ®åº“äº‹åŠ¡ï¼ˆéå¸¸é‡è¦ï¼‰ try: with Session(engine) as session: session.add(obj) session.commit() except Exception: session.rollback() raise ä½ çš„é¡¹ç›®çš„ DatabaseObject ç±»å·²ç»æœ‰ç±»ä¼¼é€»è¾‘ã€‚\nâ‘¢ FastAPI ä¸­é—´ä»¶æ•è·å¼‚å¸¸ @app.exception_handler(Exception) async def global_exception_handler(request, exc): logger.exception(exc) return JSONResponse(status_code=500, content={\u0026#34;message\u0026#34;: \u0026#34;server error\u0026#34;}) â‘£ å¾ªç¯é‡è¯• + try for _ in range(3): try: return risky_operation() except Exception: time.sleep(1) ä½ é¡¹ç›®å¸¸å†™çš„ utils.retry() å°±æ˜¯è¿™æ ·ã€‚\nğŸŸ¦ 13. è¿›é˜¶ï¼štry ä¸ä¸Šä¸‹æ–‡ç®¡ç†å™¨é…åˆï¼ˆwithï¼‰ ä»£æ›¿ï¼š\ntry: f = open(\u0026#34;a.txt\u0026#34;) data = f.read() finally: f.close() ä½¿ç”¨ withï¼š\nwith open(\u0026#34;a.txt\u0026#34;) as f: data = f.read() æ›´æ¸…æ™°ã€‚\nğŸŸ© 14. try æœ€ä½³å®è·µï¼ˆä»ã€ŠEffective Pythonã€‹æ€»ç»“ï¼‰ 1. å°½é‡ç¼©å° try èŒƒå›´ é¿å…åæ‰å¤ªå¤šé€»è¾‘ã€‚\n2. ä»…æ•è·ä½ èƒ½å¤„ç†çš„å¼‚å¸¸ ä¸è¦ç”¨ç©º exceptã€‚\n3. ç”¨ finally åšèµ„æºé‡Šæ”¾ é€‚ç”¨äº I/Oã€dbã€é”ã€ç½‘ç»œæµã€‚\n4. å¯¹äºæµç¨‹æ§åˆ¶ï¼Œç”¨å¼‚å¸¸æ¯” if æ›´ç®€æ´ ä¾‹å¦‚åœæ­¢è¿­ä»£ã€‚\n5. å†™åº“æˆ–æ¡†æ¶æ—¶ï¼Œæ°¸è¿œä¸è¦åƒæ‰æ‰€æœ‰å¼‚å¸¸ åº”è¯¥é‡æ–° raise æˆ–è®°å½•æ—¥å¿—ã€‚\nğŸŸ¦ 15. æœ€åï¼šæœ€å¸¸ç”¨æ¨¡æ¿ï¼ˆæ”¶è—ï¼‰ å®‰å…¨æ‰§è¡Œå¸¦æ—¥å¿—\ntry: ... except Exception as e: logger.exception(e) å¸¦äº‹åŠ¡çš„è¯­å¥\ntry: ... commit() except: rollback() raise é‡è¯•æœºåˆ¶\nfor _ in range(3): try: return work() except: time.sleep(1) å®Œæ•´ç»“æ„\ntry: ... except Exception: ... else: ... finally: ... ","description":" ğŸŸ¦ 1. åŸºæœ¬ç»“æ„ try: ... except ExceptionType: ... else: ... finally: ... ä½œç”¨ï¼š\ntryï¼šæ‰§è¡Œå¯èƒ½å‡ºé”™çš„ä»£ç  exceptï¼šæ•è·å¼‚å¸¸å¹¶å¤„ç† elseï¼štry æ— å¼‚å¸¸æ—¶æ‰§è¡Œï¼ˆå°‘ç”¨ï¼Œä½†éå¸¸æœ‰ç”¨ï¼‰ finallyï¼šæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½æ‰§è¡Œï¼ˆå¸¸ç”¨äºé‡Šæ”¾èµ„æºï¼‰ ğŸŸ© 2. æœ€å¸¸è§çš„ try-except try: result = 10 / 0 except ZeroDivisionError: print(\u0026#34;ä¸èƒ½é™¤ä»¥ 0\u0026#34;) ğŸŸ¦ 3. æ•è·å¤šç§å¼‚å¸¸ try: ... except (KeyError, ValueError, TypeError): ... ğŸŸ© 4. æ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆå·¥ç¨‹ä¸­å¸¸ç”¨ï¼Œä½†å¿…é¡»è°¨æ…ï¼‰ try: ... except Exception as e: logger.exception(e) é€‚ç”¨ï¼š\n"},{"id":441,"href":"/backend/python/official/tuple/","title":"Tuple (å…ƒç»„)","parent":"Official","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿã€æœ€å®æˆ˜çš„ã€ŠPython å…ƒç»„ï¼ˆtupleï¼‰çŸ¥è¯†ä½“ç³»æ€»ç»“ã€‹ï¼Œè¦†ç›–åŸºç¡€ + é«˜çº§ + å®æˆ˜æŠ€å·§ï¼Œéå¸¸é€‚åˆæ”¶è—ã€‚\nğŸ¯ 1. ä»€ä¹ˆæ˜¯å…ƒç»„ï¼ˆtupleï¼‰ å…ƒç»„æ˜¯ä¸å¯å˜ï¼ˆimmutableï¼‰çš„æœ‰åºåºåˆ—ã€‚\nä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š\nä¸å¯å˜ç‰ˆçš„ list è½»é‡çº§æ•°æ®é¡¹å®¹å™¨ æ›´å®‰å…¨ã€æ›´å¿«ã€æ›´çœå†…å­˜ å®šä¹‰æ–¹å¼ï¼š\nt = (1, 2, 3) ğŸ§± 2. å…ƒç»„çš„æ ¸å¿ƒç‰¹ç‚¹ ç‰¹ç‚¹ è¯´æ˜ æœ‰åº æ”¯æŒç´¢å¼•ã€åˆ‡ç‰‡ ä¸å¯å˜ ä¸èƒ½ append / remove / ä¿®æ”¹å…ƒç´  å¯å“ˆå¸Œï¼ˆå‰æï¼šå†…éƒ¨å…ƒç´ å¯å“ˆå¸Œï¼‰ å¯ä»¥ä½œä¸º dict çš„ keyã€æ”¾å…¥ set è½»é‡ã€æ›´å¿« æ¯” list æ›´èŠ‚çœå†…å­˜ï¼Œé€Ÿåº¦æ›´å¿« å¯åŒ…å«ä¸åŒç±»å‹ å¦‚ (1, \u0026ldquo;abc\u0026rdquo;, True, []) ğŸ“Œ 3. å…ƒç»„çš„åˆ›å»ºæ–¹å¼ â‘  å°æ‹¬å· t = (1, 2, 3) â‘¡ ä¸åŠ æ‹¬å·ï¼ˆè‡ªåŠ¨æ‰“åŒ…ï¼‰ t = 1, 2, 3 â‘¢ å•å…ƒç´ å…ƒç»„ï¼ˆæœ€å®¹æ˜“çŠ¯é”™ï¼ï¼‰ t = (1,) # æ­£ç¡® t = (1) # é”™è¯¯ï¼Œç±»å‹ä¸º int â‘£ ä½¿ç”¨ tuple() t = tuple([1, 2, 3]) ğŸš€ 4. å…ƒç»„æ‰“åŒ…ï¼ˆpackingï¼‰ Python ä¼šè‡ªåŠ¨å°†å¤šä¸ªå€¼æ‰“åŒ…ä¸º tupleï¼š\nt = 10, 20, 30 print(t) # (10, 20, 30) ğŸš€ 5. å…ƒç»„è§£åŒ…ï¼ˆunpackingï¼‰ â‘  åŸºç¡€è§£åŒ… x, y = (10, 20) â‘¡ å¤šå€¼è§£åŒ… a, b, c = (1, 2, 3) â‘¢ æ˜Ÿå·è§£åŒ…ï¼ˆ*ï¼‰ a, *b = (1, 2, 3, 4) # a = 1, b = [2,3,4] *a, b = (1, 2, 3, 4) # a = [1,2,3], b = 4 a, *b, c = (1, 2, 3, 4, 5) # a = 1, b = [2,3,4], c = 5 â‘£ è§£åŒ…ç»™å‡½æ•°å‚æ•° def add(a, b, c): return a + b + c params = (1, 2, 3) add(*params) ğŸ”§ 6. å…ƒç»„æ“ä½œï¼ˆå®‰å…¨ä¸”å¸¸ç”¨ï¼‰ ç´¢å¼•ä¸åˆ‡ç‰‡\nt[0] t[1:3] è¿æ¥\nt1 + t2 é‡å¤\nt * 3 æˆå‘˜æ£€æŸ¥\nif 3 in t: ... ğŸ” 7. ä¸ºä»€ä¹ˆè¦ç”¨å…ƒç»„ï¼ˆtupleï¼‰ï¼Ÿ â‘  ä¸å¯å˜ -\u0026gt; æ›´å®‰å…¨ æ•°æ®ä¸ä¼šè¢«è¯¯ä¿®æ”¹ã€‚\nâ‘¡ å¯å“ˆå¸Œ -\u0026gt; å¯åš dict çš„ key ä¾‹å¦‚ï¼š\nlocations = {} locations[(35.1, 108.9)] = \u0026#34;Xi\u0026#39;an\u0026#34; â‘¢ é€Ÿåº¦å¿« \u0026amp; å ç”¨å†…å­˜å°‘ Python å†…éƒ¨ä¼˜åŒ–è¿‡çš„åªè¯»ç»“æ„ã€‚\nâ‘£ å‡½æ•°è¿”å›å¤šä¸ªå€¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ def get_user(): return 1, \u0026#34;Jack\u0026#34; uid, name = get_user() â˜˜ï¸ 8. å…ƒç»„ vs åˆ—è¡¨ï¼ˆtuple vs listï¼‰ å±æ€§ tuple list å¯å˜æ€§ âŒ ä¸å¯å˜ âœ… å¯å˜ å†…å­˜ æ›´çœ è¾ƒå¤§ é€Ÿåº¦ æ›´å¿« è¾ƒæ…¢ ç”¨é€” è¿”å›å€¼ï¼Œå¸¸é‡æ•°æ®ï¼Œå­—å…¸ key åŠ¨æ€æ•°æ®ã€å¯å˜ç»“æ„ å“ˆå¸Œæ€§ å¯å“ˆå¸Œï¼ˆå†…éƒ¨å…ƒç´ éƒ½å¯å“ˆå¸Œæ—¶ï¼‰ ä¸å¯å“ˆå¸Œ ğŸ›  9. å…ƒç»„é«˜çº§æŠ€å·§ â‘  äº¤æ¢å˜é‡ a, b = b, a â‘¡ è§£åŒ… + å¿½ç•¥ name, _, age = (\u0026#34;Tom\u0026#34;, \u0026#34;Male\u0026#34;, 23) â‘¢ åµŒå¥—è§£åŒ… (a, b), (c, d) = [(1, 2), (3, 4)] â‘£ ä½¿ç”¨ enumerate for idx, value in enumerate([\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;]): print(idx, value) è¿™é‡Œ (idx, value) å°±æ˜¯ tupleã€‚\nğŸ§° 10. å…ƒç»„æ˜¯ Python ç»“æ„åŒ–æ•°æ®çš„åŸºç¡€ ä¾‹å¦‚ï¼š\nzip äº§ç”Ÿå…ƒç»„\nzip_list = list(zip([1,2,3], [\u0026#34;a\u0026#34;,\u0026#34;b\u0026#34;,\u0026#34;c\u0026#34;])) # [(1,\u0026#39;a\u0026#39;), (2,\u0026#39;b\u0026#39;), (3,\u0026#39;c\u0026#39;)] dict.items() ä¹Ÿæ˜¯å…ƒç»„\nfor key, value in mydict.items(): ... SQLAlchemy æŸ¥è¯¢è¡Œç»“æœä¹Ÿæ˜¯ tuple-like\nâœ… 11. æ¨èä½¿ç”¨å…ƒç»„çš„åœºæ™¯ ä¸ä¼šæ”¹å˜çš„æ•°æ® å‡½æ•°è¿”å›å¤šä¸ªå€¼ ä½œä¸º dict çš„ key é…ç½®å¸¸é‡ å¿«é€Ÿä¸´æ—¶ç»“æ„ï¼ˆæ¯” list æ›´å¿«ï¼‰ ç»™ map/filter/reduce ç­‰å‡½æ•°ä¼ å‚æ•° å±•ç¤ºä¸€ä¸ªæ•°æ®è®°å½•ï¼ˆç±»ä¼¼ structï¼‰ â­ 12. ä¸€å±é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ï¼‰ tuple åŸºç¡€ï¼š\nä¸å¯å˜ï¼Œæœ‰åº æ”¯æŒç´¢å¼•ã€åˆ‡ç‰‡ã€è§£åŒ… å†…å­˜å°ã€é€Ÿåº¦å¿« å…³é”®æ¦‚å¿µï¼š\nè‡ªåŠ¨æ‰“åŒ…ï¼št = 1,2,3 è§£åŒ…ï¼ša,b = (1,2) æ˜Ÿå·è§£åŒ…ï¼ša,*b,c = \u0026hellip; å¸¸ç”¨åœºæ™¯ï¼š\nå‡½æ•°è¿”å›å€¼ dict çš„ key ä¸å¯å˜æ•°æ®ç»“æ„ zip / enumerate / dict.items å…ƒç»„æ‰“åŒ…å’Œè§£åŒ…ç¤ºä¾‹ ä»¥ä¸‹æ˜¯ æœ€å¸¸ç”¨ã€æœ€ç›´è§‚çš„ Python å…ƒç»„ â€œæ‰“åŒ… / è§£åŒ…â€ ç¤ºä¾‹ï¼ˆå«é«˜çº§ç”¨æ³•ï¼‰ã€‚\nğŸŸ¦ 1. å…ƒç»„æ‰“åŒ…ï¼ˆTuple Packingï¼‰ Python è‡ªåŠ¨æŠŠå¤šä¸ªå€¼æ‰“åŒ…æˆä¸€ä¸ªå…ƒç»„ï¼š\ntpl = 1, 2, 3 print(tpl) è¾“å‡ºï¼š\n(1, 2, 3) ä¹Ÿå¯ä»¥æ˜¾å¼å†™æ‹¬å·ï¼š\ntpl = (1, 2, 3) ğŸŸ© 2. å…ƒç»„è§£åŒ…ï¼ˆTuple Unpackingï¼‰ æŠŠå…ƒç»„ä¸­çš„å€¼æ‹†å¼€èµ‹ç»™å¤šä¸ªå˜é‡ï¼š\na, b, c = (1, 2, 3) print(a, b, c) è¾“å‡ºï¼š\n1 2 3 ğŸŸ¨ 3. è‡ªåŠ¨ç±»å‹è½¬æ¢ + è§£åŒ… æ™®é€šè¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è§£åŒ…ï¼š\ndef foo(): return 10, 20, 30 # å®é™…è¿”å›çš„æ˜¯ä¸€ä¸ª tuple x, y, z = foo() print(x, y, z) ğŸŸ§ 4. ä½¿ç”¨ *rest æ•è·å¤šä½™é¡¹ç›®ï¼ˆå¯å˜è§£åŒ…ï¼‰ â­ éå¸¸å®ç”¨ï¼\na, *middle, b = (1, 2, 3, 4, 5) print(a) # 1 print(middle) # [2, 3, 4] print(b) # 5 ğŸŸ¥ 5. äº¤æ¢å˜é‡ï¼ˆæœ€ç»å…¸çš„è§£åŒ…ç¤ºä¾‹ï¼‰ x, y = 10, 20 x, y = y, x print(x, y) è¾“å‡ºï¼š\n20 10 ğŸŸ¦ 6. ä¸¢å¼ƒä¸éœ€è¦çš„å€¼ï¼ˆä½¿ç”¨ _ï¼‰ a, _, c = (1, 2, 3) print(a, c) ğŸŸ© 7. å‡½æ•°æ¥æ”¶å¤šä¸ªè¿”å›å€¼ï¼ˆè‡ªåŠ¨è§£åŒ…ï¼‰ def get_user(): return \u0026#34;jack\u0026#34;, 18, \u0026#34;shenzhen\u0026#34; name, age, city = get_user() ğŸŸ¨ 8. å­—å…¸ items() è§£åŒ…ï¼ˆéå¸¸å¸¸ç”¨ï¼‰ d = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2} for key, value in d.items(): print(key, value) ğŸŸ§ 9. å¾ªç¯ä¸­åŒæ—¶è§£åŒ…å¤šä¸ªå…ƒç»„ coords = [(1, 2), (3, 4), (5, 6)] for x, y in coords: print(x, y) ğŸŸ¥ 10. è§£åŒ…åµŒå¥—ç»“æ„ nested = (\u0026#34;user\u0026#34;, (10, 20)) name, (x, y) = nested print(name, x, y) ğŸ”¥ Bonusï¼šæ˜Ÿå·è§£åŒ…ç›´æ¥ä¼ å‚ args = (1, 2, 3) def add(a, b, c): return a + b + c result = add(*args) print(result) ğŸ“Œ æ€»ç»“å£è¯€ å…ƒç»„æ‰“åŒ…ï¼š\na = 1, 2, 3 å…ƒç»„è§£åŒ…ï¼š\nx, y, z = a å¸¦ * çš„å¯å˜è§£åŒ…ï¼š\na, *b, c = some_tuple éå¸¸çµæ´»ã€Pythonicï¼\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€å®Œæ•´ã€æœ€ç³»ç»Ÿã€æœ€å®æˆ˜çš„ã€ŠPython å…ƒç»„ï¼ˆtupleï¼‰çŸ¥è¯†ä½“ç³»æ€»ç»“ã€‹ï¼Œè¦†ç›–åŸºç¡€ + é«˜çº§ + å®æˆ˜æŠ€å·§ï¼Œéå¸¸é€‚åˆæ”¶è—ã€‚\nğŸ¯ 1. ä»€ä¹ˆæ˜¯å…ƒç»„ï¼ˆtupleï¼‰ å…ƒç»„æ˜¯ä¸å¯å˜ï¼ˆimmutableï¼‰çš„æœ‰åºåºåˆ—ã€‚\nä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š\nä¸å¯å˜ç‰ˆçš„ list è½»é‡çº§æ•°æ®é¡¹å®¹å™¨ æ›´å®‰å…¨ã€æ›´å¿«ã€æ›´çœå†…å­˜ å®šä¹‰æ–¹å¼ï¼š\nt = (1, 2, 3) ğŸ§± 2. å…ƒç»„çš„æ ¸å¿ƒç‰¹ç‚¹ ç‰¹ç‚¹ è¯´æ˜ æœ‰åº æ”¯æŒç´¢å¼•ã€åˆ‡ç‰‡ ä¸å¯å˜ ä¸èƒ½ append / remove / ä¿®æ”¹å…ƒç´  å¯å“ˆå¸Œï¼ˆå‰æï¼šå†…éƒ¨å…ƒç´ å¯å“ˆå¸Œï¼‰ å¯ä»¥ä½œä¸º dict çš„ keyã€æ”¾å…¥ set è½»é‡ã€æ›´å¿« æ¯” list æ›´èŠ‚çœå†…å­˜ï¼Œé€Ÿåº¦æ›´å¿« å¯åŒ…å«ä¸åŒç±»å‹ å¦‚ (1, \u0026ldquo;abc\u0026rdquo;, True, []) ğŸ“Œ 3. å…ƒç»„çš„åˆ›å»ºæ–¹å¼ â‘  å°æ‹¬å· t = (1, 2, 3) â‘¡ ä¸åŠ æ‹¬å·ï¼ˆè‡ªåŠ¨æ‰“åŒ…ï¼‰ t = 1, 2, 3 â‘¢ å•å…ƒç´ å…ƒç»„ï¼ˆæœ€å®¹æ˜“çŠ¯é”™ï¼ï¼‰ t = (1,) # æ­£ç¡® t = (1) # é”™è¯¯ï¼Œç±»å‹ä¸º int â‘£ ä½¿ç”¨ tuple() t = tuple([1, 2, 3]) ğŸš€ 4. å…ƒç»„æ‰“åŒ…ï¼ˆpackingï¼‰ Python ä¼šè‡ªåŠ¨å°†å¤šä¸ªå€¼æ‰“åŒ…ä¸º tupleï¼š\n"},{"id":442,"href":"/backend/python/official/unpacking/","title":"Unpacking (è§£åŒ…)","parent":"Official","content":"ä¸‹é¢æ˜¯ æœ€å®Œæ•´ã€æœ€å®ç”¨ã€æœ€é€šä¿—æ˜“æ‡‚çš„ Python â€œè§£åŒ…ï¼ˆunpackingï¼‰â€ æ€»ç»“ã€‚\næ¶µç›– åˆ—è¡¨/å…ƒç»„/å­—å…¸/æ˜Ÿå·è§£åŒ…/åŒæ˜Ÿå·è§£åŒ…/åµŒå¥—è§£åŒ…/å³ä¾§è§£åŒ…/å‡½æ•°å‚æ•°è§£åŒ…/é«˜çº§æŠ€å·§ ç­‰æ‰€æœ‰çŸ¥è¯†ç‚¹ã€‚\nğŸš€ ä»€ä¹ˆæ˜¯ unpackingï¼Ÿ Unpackingï¼ˆè§£åŒ…ï¼‰å°±æ˜¯æŠŠå®¹å™¨é‡Œçš„å…ƒç´ â€œæ‹†å¼€â€èµ‹å€¼ç»™å¤šä¸ªå˜é‡ã€‚\nç¤ºä¾‹ï¼š\na, b, c = [1, 2, 3] Python ä¼šè‡ªåŠ¨æŒ‰é¡ºåºæ‹†å¼€ï¼Œç»™åˆ°å˜é‡é‡Œã€‚\n1. åŸºç¡€è§£åŒ…ï¼ˆå…ƒç»„ã€åˆ—è¡¨ï¼‰ å…ƒç»„è§£åŒ…\na, b = (1, 2) åˆ—è¡¨è§£åŒ…\nx, y, z = [10, 20, 30] å­—ç¬¦ä¸²ä¹Ÿèƒ½è§£åŒ…\na, b, c = \u0026#34;abc\u0026#34; 2. æ˜Ÿå·è§£åŒ…ï¼ˆ*ï¼‰\u0026ndash; é‡ç‚¹ ç”¨äºâ€œæ¥æ”¶å¤šä¸ªå‰©ä½™å…ƒç´ â€ã€‚\nåŸºæœ¬å½¢å¼\na, *b = [1, 2, 3, 4] # a = 1 # b = [2, 3, 4] æ”¾åœ¨ä¸­é—´\na, *middle, c = [1, 2, 3, 4, 5] # a=1, middle=[2,3,4], c=5 æ”¾åœ¨åé¢\n*a, b = [1, 2, 3] # a=[1,2], b=3 è§£å¼€ä»»æ„é•¿åº¦\nfirst, *_, last = [1, 2, 3, 4, 5] # _ è¡¨ç¤ºâ€œæˆ‘ä¸ç”¨ä¸­é—´çš„å€¼â€ 3. åŒæ˜Ÿå·è§£åŒ…ï¼ˆ**ï¼‰ç”¨äºå­—å…¸ è§£åŒ… dict â€”â€” keys è§£åŒ…\na, b = {\u0026#34;x\u0026#34;:1, \u0026#34;y\u0026#34;:2} # a=\u0026#39;x\u0026#39;, b=\u0026#39;y\u0026#39; ä¼ é€’å­—å…¸å‚æ•°ç»™å‡½æ•°\ndef add(x, y): return x + y params = {\u0026#34;x\u0026#34;: 10, \u0026#34;y\u0026#34;: 20} add(**params) # ç­‰åŒäº add(x=10, y=20) åˆå¹¶ dict\nd1 = {\u0026#34;a\u0026#34;: 1} d2 = {\u0026#34;b\u0026#34;: 2} d3 = {**d1, **d2} ğŸ”¹ æ•ˆæœåŒ Python 3.9 çš„ï¼š\nd3 = d1 | d2 4. åµŒå¥—è§£åŒ… Python æ”¯æŒ é€’å½’å¼è§£åŒ…ã€‚\näºŒç»´ç»“æ„\n(x1, y1), (x2, y2) = [(1, 2), (3, 4)] æ··åˆè§£åŒ…\n(a, (b, c)) = [1, (2, 3)] åµŒå¥— + æ˜Ÿå·\n(a, *b), c = ([1, 2, 3], 4) # a=1, b=[2,3], c=4 5. å³ä¾§è§£åŒ…ï¼ˆPython 3.8+ æ–°ç‰¹æ€§ï¼‰ Python å…è®¸åœ¨èµ‹å€¼è¯­å¥ å³è¾¹ä½¿ç”¨æ˜Ÿå·ï¼š\nvals = [*range(3), 99] # vals = [0, 1, 2, 99] æ‹¼æ¥åˆ—è¡¨æ›´ä¼˜é›…\na = [1, 2] b = [3, 4] c = [*a, *b] # [1,2,3,4] 6. å‡½æ•°å‚æ•°è§£åŒ… *args è§£åŒ…åºåˆ—\ndef add(a, b, c): return a + b + c vals = [1, 2, 3] add(*vals) **kwargs è§£åŒ…å­—å…¸\ndef hello(name, age): print(name, age) d = {\u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;age\u0026#34;: 20} hello(**d) 7. å‡½æ•°è¿”å›å€¼çš„è§£åŒ… å‡½æ•°è¿”å›å…ƒç»„æ—¶ï¼Œå¯ç›´æ¥è§£åŒ…ï¼š\ndef point(): return 3, 4 x, y = point() 8. å¾ªç¯ä¸­çš„è§£åŒ… éå† tuple åˆ—è¡¨\npairs = [(1,2), (3,4)] for x, y in pairs: print(x, y) dict.items() è§£åŒ…\nfor key, value in mydict.items(): ... 9. é«˜çº§æŠ€å·§ï¼šå¤šä¸ªåˆ—è¡¨åŒæ­¥è¿­ä»£ï¼ˆzip è§£åŒ…ï¼‰ æ‰“åŒ… -\u0026gt; è§£åŒ…\nnames = [\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;] ages = [10, 20, 30] for n, a in zip(names, ages): print(n, a) çŸ©é˜µè½¬ç½®\nmatrix = [ [1, 2, 3], [4, 5, 6], ] transposed = list(zip(*matrix)) # [(1, 4), (2, 5), (3, 6)] 10. è§£åŒ… + èµ‹å€¼è¡¨è¾¾å¼ï¼ˆ:=ï¼‰ if (x := data.get(\u0026#34;x\u0026#34;)): print(x) ç”šè‡³ï¼š\nif (a, b := point()) : ... 11. è§£åŒ…å¸¸è§é”™è¯¯ä¸é™·é˜± âŒ å…ƒç´ æ•°é‡ä¸åŒ¹é…\na, b = [1, 2, 3] # ValueError âœ… ä½¿ç”¨æ˜Ÿå·é¿å…é”™è¯¯\na, *b = [1, 2, 3] æ€»ç»“ï¼šPython Unpacking çš„ç²¾é«“ ç‰¹æ€§ ç¤ºä¾‹ ç”¨é€” æ™®é€šè§£åŒ… a, b = (1,2) æ‹†åºåˆ— æ˜Ÿå·è§£åŒ… (*) a, *b = lst æ•è·ä»»æ„ä¸ªæ•° åŒæ˜Ÿå·è§£åŒ… (**) {**d1, **d2} dict åˆå¹¶ã€å‚æ•°ä¼ é€’ åµŒå¥—è§£åŒ… (a,(b,c))=â€¦ å¤šç»´ç»“æ„ å³ä¾§è§£åŒ… lst = [*a,*b] æ„å»ºåˆ—è¡¨ å‚æ•°è§£åŒ… f(*args) f(**kwargs) å‡½æ•°çµæ´»è°ƒç”¨ Python çš„è§£åŒ…è®©æ•°æ®å¤„ç†å˜å¾—ï¼š\nç®€æ´ é«˜æ•ˆ å¯è¯» çµæ´» æ˜¯ Pythonic é£æ ¼çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚\n","description":"ä¸‹é¢æ˜¯ æœ€å®Œæ•´ã€æœ€å®ç”¨ã€æœ€é€šä¿—æ˜“æ‡‚çš„ Python â€œè§£åŒ…ï¼ˆunpackingï¼‰â€ æ€»ç»“ã€‚\næ¶µç›– åˆ—è¡¨/å…ƒç»„/å­—å…¸/æ˜Ÿå·è§£åŒ…/åŒæ˜Ÿå·è§£åŒ…/åµŒå¥—è§£åŒ…/å³ä¾§è§£åŒ…/å‡½æ•°å‚æ•°è§£åŒ…/é«˜çº§æŠ€å·§ ç­‰æ‰€æœ‰çŸ¥è¯†ç‚¹ã€‚\nğŸš€ ä»€ä¹ˆæ˜¯ unpackingï¼Ÿ Unpackingï¼ˆè§£åŒ…ï¼‰å°±æ˜¯æŠŠå®¹å™¨é‡Œçš„å…ƒç´ â€œæ‹†å¼€â€èµ‹å€¼ç»™å¤šä¸ªå˜é‡ã€‚\nç¤ºä¾‹ï¼š\na, b, c = [1, 2, 3] Python ä¼šè‡ªåŠ¨æŒ‰é¡ºåºæ‹†å¼€ï¼Œç»™åˆ°å˜é‡é‡Œã€‚\n1. åŸºç¡€è§£åŒ…ï¼ˆå…ƒç»„ã€åˆ—è¡¨ï¼‰ å…ƒç»„è§£åŒ…\na, b = (1, 2) åˆ—è¡¨è§£åŒ…\nx, y, z = [10, 20, 30] å­—ç¬¦ä¸²ä¹Ÿèƒ½è§£åŒ…\na, b, c = \u0026#34;abc\u0026#34; 2. æ˜Ÿå·è§£åŒ…ï¼ˆ*ï¼‰\u0026ndash; é‡ç‚¹ ç”¨äºâ€œæ¥æ”¶å¤šä¸ªå‰©ä½™å…ƒç´ â€ã€‚\n"},{"id":443,"href":"/backend/python/official/variable/","title":"Variable (å˜é‡)","parent":"Official","content":" 1. ä»€ä¹ˆæ˜¯ Python å˜é‡ï¼Ÿ Python å˜é‡æ˜¯ åå­—ç»‘å®šï¼ˆname bindingï¼‰ï¼Œä¸æ˜¯å­˜å‚¨ç©ºé—´ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼šâ€œå˜é‡â€ä¸æ˜¯è£…å€¼çš„ç›’å­ï¼Œè€Œæ˜¯ç»™æŸä¸ªå¯¹è±¡å–ä¸€ä¸ªåå­—ã€‚\nä¾‹å¦‚ï¼š\nx = 10 å¹¶ä¸æ˜¯æŠŠ 10 æ”¾å…¥ xï¼Œè€Œæ˜¯ï¼š\nx -\u0026gt; æŒ‡å‘å¯¹è±¡ 10 æ‰€æœ‰å˜é‡æœ¬è´¨ä¸Šéƒ½æ˜¯ æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨ã€‚\n2. Python æ˜¯å¼ºç±»å‹ + åŠ¨æ€ç±»å‹è¯­è¨€ å¼ºç±»å‹ï¼ˆStrong Typeï¼‰ï¼šä¸ä¼šè‡ªåŠ¨å°†ç±»å‹è½¬æ¢ï¼ˆæ¯”å¦‚â€1â€+2 ç›´æ¥æŠ¥é”™ï¼‰ åŠ¨æ€ç±»å‹ï¼ˆDynamic Typeï¼‰ï¼šå˜é‡ç±»å‹åœ¨è¿è¡Œæ—¶å†³å®šï¼Œå¯ä»¥éšæ—¶æ”¹å˜ç»‘å®šå¯¹è±¡ ä¾‹ï¼š\nx = 123 x = \u0026#34;abc\u0026#34; 3. å˜é‡çš„ä¸‰è¦ç´  æ¯ä¸ªå˜é‡éƒ½æœ‰ï¼š\nå±æ€§ è¯´æ˜ id å¯¹è±¡çš„å†…å­˜åœ°å€ type å¯¹è±¡çš„ç±»å‹ value å¯¹è±¡çš„å€¼ ä¾‹å¦‚ï¼š\nx = \u0026#34;hello\u0026#34; print(id(x), type(x), x) 4. Python å˜é‡çš„èµ‹å€¼ = åå­—ç»‘å®šï¼ˆname bindingï¼‰ å·¦è¾¹æ˜¯åç§°ï¼Œå³è¾¹æ˜¯å¯¹è±¡ï¼š\na = b = 100 è¡¨ç¤ºï¼š\na -----\u0026gt;(100) b -----\u0026gt;/ 5. å˜é‡çš„å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰ Python ä½¿ç”¨å¼•ç”¨è®¡æ•°å†³å®šæ˜¯å¦å›æ”¶å¯¹è±¡ï¼š\nx = [] y = x å¼•ç”¨è®¡æ•° +1\n6. å˜é‡ä½œç”¨åŸŸï¼ˆLEGB è§„åˆ™ï¼‰ çº§åˆ« è¯´æ˜ L Localï¼ˆå‡½æ•°å†…ï¼‰ E Enclosingï¼ˆå¤–å±‚å‡½æ•°ï¼‰ G Globalï¼ˆæ¨¡å—ï¼‰ B Built-inï¼ˆå†…ç½®ï¼‰ ä¾‹ï¼š\nx = 1 # global def outer(): x = 2 # enclosing def inner(): x = 3 # local 7. global ä¸ nonlocal globalï¼šä¿®æ”¹å…¨å±€å˜é‡\nx = 10 def foo(): global x x = 20 nonlocalï¼šä¿®æ”¹å¤–å±‚å‡½æ•°çš„å˜é‡\ndef outer(): x = 10 def inner(): nonlocal x x = 20 8. Python å˜é‡çš„å¸¸è§ç±»å‹ ç±»å‹ ç¤ºä¾‹ æ•°å­— int, float, complex å­—ç¬¦ä¸² str å¸ƒå°”å€¼ bool å®¹å™¨ç±»å‹ list, dict, tuple, set, frozenset æ–‡ä»¶ io.TextIOWrapper è‡ªå®šä¹‰å¯¹è±¡ class instance ç‰¹æ®Šå¯¹è±¡ None 9. å¯å˜ vs ä¸å¯å˜ï¼ˆéå¸¸é‡è¦ï¼‰ â„ï¸ ä¸å¯å˜å¯¹è±¡ï¼ˆé‡æ–°ç»‘å®šï¼‰\nint float bool str tuple frozenset ä¾‹ï¼š\nx = \u0026#34;a\u0026#34; x = \u0026#34;b\u0026#34; # å®é™…ä¸Šæ˜¯ç»‘å®šæ–°çš„å¯¹è±¡ï¼Œä¸æ˜¯ä¿®æ”¹ ğŸ”¥ å¯å˜å¯¹è±¡ï¼ˆåŸåœ°ä¿®æ”¹ï¼‰\nlist dict set è‡ªå®šä¹‰å¯¹è±¡å±æ€§ ä¾‹ï¼š\nlst = [1,2,3] lst.append(4) # ä¿®æ”¹å¯¹è±¡æœ¬èº« 10. å˜é‡å…±äº«ä¸å‘ï¼ˆå¸¸è§ bugï¼‰ a = [1,2,3] b = a b.append(4) print(a) # [1,2,3,4] # id ç›¸åŒ id(a) # 4367042880 id(b) # 4367042880 å› ä¸ºä¸¤ä¸ªå˜é‡æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚\nè§£å†³ï¼š\n# æµ…æ‹·è´ b = a.copy() # æµ…æ‹·è´ from copy import copy b = copy(a) # æ·±æ‹·è´ from copy import deepcopy b = deepcopy(a) # id ä¸åŒ id(a) # 4367042880 id(b) # 4370318400 11. é»˜è®¤å‚æ•°é™·é˜±ï¼ˆå¿…é¡»æŒæ¡ï¼‰ âŒ é”™è¯¯ï¼š\ndef add_item(item, lst=[]): lst.append(item) return lst âœ… æ­£ç¡®ï¼š\ndef add_item(item, lst=None): if lst is None: lst = [] lst.append(item) return lst 12. è§£åŒ…èµ‹å€¼ï¼ˆè¶…å¸¸ç”¨ï¼‰ a, b = 1, 2 x, *y = [1,2,3,4] å­—å…¸è§£åŒ…ï¼š\ndata = {\u0026#34;a\u0026#34;: 1, \u0026#34;b\u0026#34;: 2} new = {**data, \u0026#34;c\u0026#34;: 3} 13. æµ·è±¡è¿ç®—ç¬¦ := ç”¨äºè¡¨è¾¾å¼å†…èµ‹å€¼\nif (x := data.get(\u0026#34;x\u0026#34;)): print(x) if (a, b := point()): ... 14. Python ä¸­å¸¸é‡çº¦å®šï¼ˆä¸æ˜¯å¼ºåˆ¶ï¼‰ å¸¸é‡å‘½åå…¨éƒ¨å¤§å†™\nHOST = \u0026#34;localhost\u0026#34; VERSION = \u0026#34;1.0\u0026#34; 15. ç‰¹æ®Šå˜é‡ _ ä¿å­˜ä¸Šæ¬¡è®¡ç®—ç»“æœ è¡¨ç¤ºæ— ç”¨å˜é‡ (ä¸¢å¼ƒä¸éœ€è¦çš„å€¼) 1 + 2 print(_) # 3 a, _, c = (1, 2, 3) print(a, c) # 1 3 16. ç§æœ‰å˜é‡ï¼ˆä¼ªç§æœ‰ï¼‰ Python æ²¡æœ‰çœŸæ­£çš„ç§æœ‰å˜é‡ï¼Œä½†æ”¯æŒå‰ç¼€çº¦å®šï¼š\n_xï¼šå†…éƒ¨ä½¿ç”¨ __xï¼šç±»å†…ç§æœ‰ï¼ˆName Manglingï¼‰ ä¾‹ï¼š\nclass A: __secret = 123 è½¬æ¢ä¸ºï¼š\n_A__secret 17. ç±»å‹æ³¨è§£ï¼ˆé‡è¦!ï¼‰ å†™æ³•ï¼š\nage: int = 10 stock_list: list[str] = [] config: dict[str, str] = {} 18. å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ æ¨¡å—çº§å˜é‡ï¼šç¨‹åºè¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ å‡½æ•°å˜é‡ï¼šå‡½æ•°ç»“æŸåé”€æ¯ é—­åŒ…å˜é‡ï¼šå­˜æ´»äºå‡½æ•°å¯¹è±¡ä¸­ ç±»/å®ä¾‹å˜é‡ï¼šå¯¹è±¡è¢« GC åé‡Šæ”¾ 19. å·¥ç¨‹å®è·µä¸­çš„å˜é‡è®¾è®¡ åå­—æ¸…æ™°ã€è¯­ä¹‰æ˜ç¡® æ¯”å¦‚ï¼šwebsite, code, date, detail\né¿å…å¤§é‡é­”æ³•å­—ç¬¦ä¸²ï¼Œä½¿ç”¨å¸¸é‡ / Enum class Market(Enum): SH = \u0026#34;sh\u0026#34; SZ = \u0026#34;sz\u0026#34; é¿å…å…¨å±€å¯å˜å˜é‡ ä¾‹å¦‚ï¼š\nCACHE = {} # âŒ åº”æ”¹ä¸ºï¼š\nfrom functools import lru_cache é…ç½®é¡¹ç»Ÿä¸€æ”¶æ•› é€šå¸¸ä½¿ç”¨ï¼š\nconfig.py\nè¿™æ˜¯æ­£ç¡®çš„ã€‚\n20. æœ€ç»ˆæ€»ç»“ â˜˜ï¸ Python å˜é‡çš„æœ¬è´¨ å˜é‡ = åå­— å¯¹è±¡ = å€¼ èµ‹å€¼ = åå­—ç»‘å®šå¯¹è±¡ ğŸ”¥ å¿…ä¼š LEGB ä½œç”¨åŸŸ global / nonlocal å¯å˜ vs ä¸å¯å˜ é»˜è®¤å‚æ•°é™·é˜± æ­£ç¡®ä½¿ç”¨ç±»å‹æ³¨è§£ ğŸ“¦ å·¥ç¨‹æœ€ä½³å®è·µ ä½¿ç”¨å¸¸é‡ã€æšä¸¾ ä½¿ç”¨ dataclass / TypedDict ç®¡ç†å˜é‡ç»“æ„ æ¸…æ™°å‘½å é¿å…å…±äº«å¯å˜å¯¹è±¡ å˜é‡åç§° åœ¨ Python ä¸­ï¼Œå…¨éƒ¨å¤§å†™çš„å˜é‡åé€šå¸¸è¡¨ç¤ºå¸¸é‡ï¼Œå³ä¸åº”è¯¥è¢«ä¿®æ”¹çš„å€¼ã€‚è™½ç„¶ Python æ²¡æœ‰çœŸæ­£çš„å¸¸é‡ç±»å‹ï¼Œä½†çº¦å®šä¿—æˆåœ°ä½¿ç”¨å…¨å¤§å†™å˜é‡åæ¥è¡¨ç¤ºå¸¸é‡ï¼Œä»¥æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\nå…·ä½“æ¥è¯´ï¼ŒPython å˜é‡å‘½åè§„èŒƒå¦‚ä¸‹ï¼š\nå˜é‡å: æ¨èä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šmy_variable å¸¸é‡å: æ¨èä½¿ç”¨å…¨éƒ¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šMAX_VALUE ç±»å: æ¨èä½¿ç”¨é©¼å³°å‘½åæ³•ï¼Œæ¯ä¸ªå•è¯é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚ï¼šMyClass å‡½æ•°å: æ¨èä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œä¾‹å¦‚ï¼šmy_function ç¤ºä¾‹ï¼š\n# å˜é‡ my_variable = 10 # å¸¸é‡ PI = 3.14159 MAX_CONNECTIONS = 100 # ç±» class MyClass: def __init__(self, value): self.value = value # å‡½æ•° def my_function(x, y): return x + y æ€»ç»“: Python ä¸­ï¼Œå…¨å¤§å†™å˜é‡åæ˜¯çº¦å®šä¿—æˆçš„å¸¸é‡ï¼Œç”¨äºè¡¨ç¤ºä¸åº”è¢«ä¿®æ”¹çš„å€¼ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚åŒæ—¶ï¼Œä¹Ÿåº”è¯¥éµå®ˆå…¶ä»–å‘½åè§„èŒƒï¼Œå¦‚å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ç”¨äºå˜é‡å’Œå‡½æ•°åï¼Œé©¼å³°å‘½åæ³•ç”¨äºç±»åã€‚\nPython å‡½æ•°å’Œæ–¹æ³•çš„å‚æ•°ï¼Œä»¥åŠå…¨å±€å˜é‡ï¼Œæ¨èä½¿ç”¨å°å†™å­—æ¯åŠ ä¸‹åˆ’çº¿åˆ†éš”çš„å‘½åæ–¹å¼ï¼ˆsnake_caseï¼‰ï¼Œä¾‹å¦‚ my_variableã€‚å¸¸é‡åˆ™ä½¿ç”¨å…¨å¤§å†™å­—æ¯åŠ ä¸‹åˆ’çº¿åˆ†éš”çš„å‘½åæ–¹å¼ï¼ˆUPPER_SNAKE_CASEï¼‰ï¼Œä¾‹å¦‚ MY_CONSTANTã€‚\nè¯¦ç»†è§£é‡Š å°å†™å­—æ¯åŠ ä¸‹åˆ’çº¿(snake_case) è¿™æ˜¯ Python ä¸­æœ€å¸¸è§çš„å‘½åé£æ ¼ï¼Œé€‚ç”¨äºå‡½æ•°åã€æ–¹æ³•åã€å˜é‡åå’Œå‚æ•°åã€‚ ä¾‹å¦‚ï¼šdef calculate_sum(num1, num2): æˆ–è€… user_name = \u0026quot;John\u0026quot; å…¨å¤§å†™å­—æ¯åŠ ä¸‹åˆ’çº¿(UPPER_SNAKE_CASE) ç”¨äºè¡¨ç¤ºå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å…¶å€¼ä¸ä¼šæ”¹å˜çš„å˜é‡ã€‚ ä¾‹å¦‚ï¼šMAX_ITERATIONS = 100 é©¼å³°å‘½åæ³•(CamelCase) åœ¨ Python ä¸­ï¼Œé©¼å³°å‘½åæ³•ä¸»è¦ç”¨äºç±»åï¼Œä¾‹å¦‚ MyClass æˆ– MyClassNameã€‚ è™½ç„¶ä¹Ÿå¯ä»¥ç”¨äºå‡½æ•°å’Œå˜é‡ï¼Œä½† PEP 8 é£æ ¼æŒ‡å—æ¨èä½¿ç”¨ snake_case ç§æœ‰å˜é‡/æ–¹æ³• ä»¥ä¸€ä¸ªä¸‹åˆ’çº¿ _ å¼€å¤´çš„å˜é‡æˆ–æ–¹æ³•è¡¨ç¤ºç§æœ‰å˜é‡æˆ–æ–¹æ³•ï¼Œä¸åº”è¯¥ç›´æ¥ä»å¤–éƒ¨è®¿é—®ã€‚ ä¾‹å¦‚ï¼š_private_variable æ€»ç»“ å‡½æ•°ã€æ–¹æ³•å’Œå‚æ•°ï¼šå°å†™å­—æ¯åŠ ä¸‹åˆ’çº¿(snake_case) å¸¸é‡ï¼šå…¨å¤§å†™å­—æ¯åŠ ä¸‹åˆ’çº¿(UPPER_SNAKE_CASE) ç±»ï¼šé©¼å³°å‘½åæ³•(CamelCase) ç§æœ‰å˜é‡/æ–¹æ³•ï¼šå•ä¸‹åˆ’çº¿å‰ç¼€ ","description":" 1. ä»€ä¹ˆæ˜¯ Python å˜é‡ï¼Ÿ Python å˜é‡æ˜¯ åå­—ç»‘å®šï¼ˆname bindingï¼‰ï¼Œä¸æ˜¯å­˜å‚¨ç©ºé—´ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼šâ€œå˜é‡â€ä¸æ˜¯è£…å€¼çš„ç›’å­ï¼Œè€Œæ˜¯ç»™æŸä¸ªå¯¹è±¡å–ä¸€ä¸ªåå­—ã€‚\nä¾‹å¦‚ï¼š\nx = 10 å¹¶ä¸æ˜¯æŠŠ 10 æ”¾å…¥ xï¼Œè€Œæ˜¯ï¼š\nx -\u0026gt; æŒ‡å‘å¯¹è±¡ 10 æ‰€æœ‰å˜é‡æœ¬è´¨ä¸Šéƒ½æ˜¯ æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨ã€‚\n2. Python æ˜¯å¼ºç±»å‹ + åŠ¨æ€ç±»å‹è¯­è¨€ å¼ºç±»å‹ï¼ˆStrong Typeï¼‰ï¼šä¸ä¼šè‡ªåŠ¨å°†ç±»å‹è½¬æ¢ï¼ˆæ¯”å¦‚â€1â€+2 ç›´æ¥æŠ¥é”™ï¼‰ åŠ¨æ€ç±»å‹ï¼ˆDynamic Typeï¼‰ï¼šå˜é‡ç±»å‹åœ¨è¿è¡Œæ—¶å†³å®šï¼Œå¯ä»¥éšæ—¶æ”¹å˜ç»‘å®šå¯¹è±¡ ä¾‹ï¼š\n"},{"id":444,"href":"/operations/vsftpd/","title":"vsftpd","parent":"Operations","content":"Document List:\nvsftpd æ ¸å¿ƒæ¦‚å¿µ ","description":"Document List:\nvsftpd æ ¸å¿ƒæ¦‚å¿µ "},{"id":445,"href":"/database/design/wal/","title":"WAL","parent":"Design","content":" ä¸€ã€WAL çš„æ¦‚å¿µ WAL = Write-Ahead Loggingï¼ˆé¢„å†™æ—¥å¿—ï¼‰\næ ¸å¿ƒæ€æƒ³ï¼šå…ˆè®°å½•æ—¥å¿—ï¼Œå†ä¿®æ”¹æ•°æ®\næ‰€æœ‰å¯¹æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå…ˆå†™å…¥ WAL æ—¥å¿—æ–‡ä»¶ åªæœ‰æ—¥å¿—å†™å…¥æˆåŠŸï¼Œäº‹åŠ¡æ‰ç®—æäº¤ æ•°æ®é¡µå¯ä»¥å»¶è¿Ÿåˆ·ç›˜ï¼Œä¿è¯å´©æºƒæ¢å¤æ—¶å¯å›æ»šæˆ–é‡åš WAL çš„ç›®çš„ äº‹åŠ¡æŒä¹…æ€§ï¼ˆDurabilityï¼‰\næ•°æ®ä¿®æ”¹æœªè½ç›˜ï¼Œç³»ç»Ÿå´©æºƒä¹Ÿèƒ½æ¢å¤ å´©æºƒæ¢å¤ï¼ˆCrash Recoveryï¼‰\nç³»ç»ŸæŒ‚æ‰ï¼Œé‡æ”¾ WAL å¯æ¢å¤æœªè½ç›˜çš„æ•°æ® é«˜æ€§èƒ½å†™å…¥\né¿å…æ¯æ¬¡ä¿®æ”¹éƒ½ç›´æ¥åˆ·ç£ç›˜ é¡ºåºå†™æ—¥å¿—æ¯”éšæœºå†™æ•°æ®å¿«å¾ˆå¤š æ”¯æŒå¤åˆ¶\nWAL å¯ç”¨äºæµå¤åˆ¶ï¼ˆPostgreSQLï¼‰æˆ– binlogï¼ˆMySQLï¼‰ äºŒã€WAL çš„åŸç† äº‹åŠ¡ä¿®æ”¹ -\u0026gt; å†™ WAL æ—¥å¿— æ—¥å¿—åˆ·ç›˜ï¼ˆfsyncï¼‰ -\u0026gt; äº‹åŠ¡æäº¤ è„é¡µå»¶è¿Ÿåˆ·ç›˜ -\u0026gt; æ•°æ®é¡µå¼‚æ­¥å†™å…¥ç£ç›˜ å´©æºƒæ¢å¤ï¼š Redo æ—¥å¿—ï¼šå›æ”¾ WALï¼Œä¿è¯ä¿®æ”¹æŒä¹… Undo æ—¥å¿—ï¼šå›æ»šæœªæäº¤äº‹åŠ¡ï¼ˆéƒ¨åˆ†æ•°æ®åº“é€šè¿‡ MVCC æˆ– redo/undo å®ç°ï¼‰ WAL çš„å…¸å‹å†™å…¥é¡ºåº äº‹åŠ¡å¼€å§‹ | v ä¿®æ”¹ -\u0026gt; å†™ WAL | v fsync WALï¼ˆä¿è¯æŒä¹…ï¼‰ | v äº‹åŠ¡æäº¤ | v å¼‚æ­¥å†™å…¥æ•°æ®é¡µ ä¸‰ã€WAL çš„æ•°æ®ç»“æ„ ä»¥ PostgreSQL ä¸ºä¾‹ï¼š\nWAL è®°å½•ç»“æ„\nLog Sequence Number (LSN)ï¼šæ¯æ¡ WAL çš„å”¯ä¸€æ ‡è¯† é¡µçº§ä¿®æ”¹è®°å½•ï¼šè®°å½•æ•°æ®é¡µå˜åŒ– äº‹åŠ¡å·ã€æ—¶é—´æˆ³ã€æ“ä½œç±»å‹ ç£ç›˜å¸ƒå±€\nWAL åˆ†æ®µæ–‡ä»¶ï¼ˆé€šå¸¸ 16MB/32MBï¼‰ é¡ºåºå†™å…¥ï¼Œè¿½åŠ æ¨¡å¼ é¡ºåº fsyncï¼Œé¿å…éšæœºå†™ WAL é‡æ”¾\næŒ‰ LSN é¡ºåºæ‰«æ redo ä¿®æ”¹æ•°æ®é¡µ undo æ’¤é”€æœªæäº¤äº‹åŠ¡ å››ã€MySQL ä¸ PostgreSQL çš„ WAL å·®å¼‚ ç‰¹æ€§ PostgreSQL WAL MySQL InnoDB redo log å«æ³• WAL redo log (ä¹Ÿç§° redo) äº‹åŠ¡æäº¤ WAL å†™å…¥ fsync -\u0026gt; æäº¤ redo log å†™å…¥ buffer -\u0026gt; flush æˆ– group commit æ•°æ®é¡µå†™å…¥ å¼‚æ­¥åˆ·è„é¡µ å¼‚æ­¥åˆ·è„é¡µ æ–‡ä»¶ç±»å‹ WAL segment files redo log files (å¾ªç¯) äº‹åŠ¡æ¢å¤ é€šè¿‡é‡æ”¾ WAL redo log é‡åšï¼Œundo log å›æ»š MVCC å…³ç³» ç›´æ¥æ”¯æŒ MVCC InnoDB MVCC ä½¿ç”¨ undo log å¤åˆ¶ WAL å¯æµå¤åˆ¶ binlog å¤åˆ¶ï¼ˆé€»è¾‘å¤åˆ¶ï¼‰ äº”ã€WAL çš„æ€§èƒ½ä¼˜åŒ–ç‚¹ é¡ºåºå†™ä¼˜åŠ¿\nWAL å†™å…¥é¡ºåºï¼Œç£ç›˜ IO æ•ˆç‡é«˜ fsync ç­–ç•¥\næ¯äº‹åŠ¡ fsync -\u0026gt; æœ€å®‰å…¨ï¼Œä½†æ…¢ batch fsync / group commit -\u0026gt; æ€§èƒ½é«˜ æ—¥å¿—å‹ç¼©/åˆ†æ®µ\nPostgreSQL åˆ†æ®µæ–‡ä»¶ MySQL redo å¾ªç¯æ—¥å¿— å¼‚æ­¥åˆ·ç›˜\næ•°æ®é¡µå¯ä»¥å»¶è¿Ÿå†™å…¥ï¼Œæé«˜åå å…­ã€WAL çš„åº”ç”¨åœºæ™¯ å´©æºƒæ¢å¤\nPostgreSQL æŒ‚æ‰ -\u0026gt; é‡æ”¾ WAL -\u0026gt; å®Œæ•´æ¢å¤ MySQL InnoDB å´©æºƒ -\u0026gt; redo log å›æ»š/é‡åš é€»è¾‘/æµå¤åˆ¶\nPostgreSQL æµå¤åˆ¶ -\u0026gt; ç›´æ¥ä¼  WAL MySQL binlog -\u0026gt; redo + binlog é€»è¾‘å¤åˆ¶ çƒ­å¤‡ / å¢é‡å¤‡ä»½\nWAL å¯å¢é‡å¤‡ä»½ æ”¯æŒ PITRï¼ˆPoint-In-Time Recoveryï¼‰ ä¸ƒã€æ€»ç»“ WAL æ˜¯æ•°æ®åº“ä¿è¯äº‹åŠ¡æŒä¹…æ€§å’Œå´©æºƒæ¢å¤çš„æ ¸å¿ƒæœºåˆ¶ï¼šä¿®æ”¹å…ˆå†™æ—¥å¿—å†æ”¹æ•°æ®é¡µï¼Œæ—¥å¿—é¡ºåºå†™ç£ç›˜ï¼Œé«˜æ€§èƒ½å¹¶æ”¯æŒå¤åˆ¶å’Œå¢é‡å¤‡ä»½ã€‚\n","description":" ä¸€ã€WAL çš„æ¦‚å¿µ WAL = Write-Ahead Loggingï¼ˆé¢„å†™æ—¥å¿—ï¼‰\næ ¸å¿ƒæ€æƒ³ï¼šå…ˆè®°å½•æ—¥å¿—ï¼Œå†ä¿®æ”¹æ•°æ®\næ‰€æœ‰å¯¹æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå…ˆå†™å…¥ WAL æ—¥å¿—æ–‡ä»¶ åªæœ‰æ—¥å¿—å†™å…¥æˆåŠŸï¼Œäº‹åŠ¡æ‰ç®—æäº¤ æ•°æ®é¡µå¯ä»¥å»¶è¿Ÿåˆ·ç›˜ï¼Œä¿è¯å´©æºƒæ¢å¤æ—¶å¯å›æ»šæˆ–é‡åš WAL çš„ç›®çš„ äº‹åŠ¡æŒä¹…æ€§ï¼ˆDurabilityï¼‰\næ•°æ®ä¿®æ”¹æœªè½ç›˜ï¼Œç³»ç»Ÿå´©æºƒä¹Ÿèƒ½æ¢å¤ å´©æºƒæ¢å¤ï¼ˆCrash Recoveryï¼‰\nç³»ç»ŸæŒ‚æ‰ï¼Œé‡æ”¾ WAL å¯æ¢å¤æœªè½ç›˜çš„æ•°æ® é«˜æ€§èƒ½å†™å…¥\né¿å…æ¯æ¬¡ä¿®æ”¹éƒ½ç›´æ¥åˆ·ç£ç›˜ é¡ºåºå†™æ—¥å¿—æ¯”éšæœºå†™æ•°æ®å¿«å¾ˆå¤š æ”¯æŒå¤åˆ¶\nWAL å¯ç”¨äºæµå¤åˆ¶ï¼ˆPostgreSQLï¼‰æˆ– binlogï¼ˆMySQLï¼‰ äºŒã€WAL çš„åŸç† äº‹åŠ¡ä¿®æ”¹ -\u0026gt; å†™ WAL æ—¥å¿— æ—¥å¿—åˆ·ç›˜ï¼ˆfsyncï¼‰ -\u0026gt; äº‹åŠ¡æäº¤ è„é¡µå»¶è¿Ÿåˆ·ç›˜ -\u0026gt; æ•°æ®é¡µå¼‚æ­¥å†™å…¥ç£ç›˜ å´©æºƒæ¢å¤ï¼š Redo æ—¥å¿—ï¼šå›æ”¾ WALï¼Œä¿è¯ä¿®æ”¹æŒä¹… Undo æ—¥å¿—ï¼šå›æ»šæœªæäº¤äº‹åŠ¡ï¼ˆéƒ¨åˆ†æ•°æ®åº“é€šè¿‡ MVCC æˆ– redo/undo å®ç°ï¼‰ WAL çš„å…¸å‹å†™å…¥é¡ºåº äº‹åŠ¡å¼€å§‹ | v ä¿®æ”¹ -\u0026gt; å†™ WAL | v fsync WALï¼ˆä¿è¯æŒä¹…ï¼‰ | v äº‹åŠ¡æäº¤ | v å¼‚æ­¥å†™å…¥æ•°æ®é¡µ ä¸‰ã€WAL çš„æ•°æ®ç»“æ„ ä»¥ PostgreSQL ä¸ºä¾‹ï¼š\n"},{"id":446,"href":"/database/postgres/wal-buffers/","title":"wal_buffers","parent":"PostgreSQL","content":"å‚è€ƒæ–‡æ¡£ï¼šPostgreSQL é…ç½®å‚æ•° wal_buffers = -1è¯¦ç»†è®²è§£\nPostgreSQL çš„ wal_buffers å‚æ•°ç»å¤§å¤šæ•°åœºæ™¯å»ºè®®ä¿æŒé»˜è®¤å€¼ -1ï¼ˆè‡ªåŠ¨ï¼‰ï¼Œè¿™ä¼šæ ¹æ® shared_buffers çš„ 1/32 è‡ªåŠ¨è°ƒèŠ‚ï¼ˆä¸Šé™é€šå¸¸ 16MBï¼‰ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å·¥ä½œè´Ÿè½½ã€‚ä»…åœ¨æé«˜å¹¶å‘å†™å…¥ã€å¤§å‹äº‹åŠ¡åœºæ™¯ä¸‹ï¼Œæ‰‹åŠ¨è®¾ä¸º 16MB-64MB çš„å›ºå®šå€¼å¯èƒ½å¸¦æ¥è½»å¾®æ€§èƒ½æå‡ã€‚\nå…·ä½“åˆ†æä¸å»ºè®®ï¼š\né»˜è®¤å€¼ (-1, è‡ªåŠ¨) æœ€ä½³ï¼š è‡ªåŠ¨ç®¡ç†ä¼šæ ¹æ® shared_buffers çš„å¤§å°è‡ªåŠ¨åˆ†é… WAL ç¼“å†²åŒºå¤§å°ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼Œè¿™èƒ½å¹³è¡¡æ€§èƒ½ä¸å†…å­˜å ç”¨ï¼Œä¸éœ€è¦é¢å¤–ç»´æŠ¤ã€‚\næ‰‹åŠ¨å›ºå®šå€¼é€‚ç”¨åœºæ™¯ï¼š\né«˜å¹¶å‘å†™æ“ä½œï¼š è®¸å¤šå®¢æˆ·ç«¯åŒæ—¶æäº¤äº‹åŠ¡çš„ç¹å¿™æœåŠ¡å™¨ï¼Œé€‚å½“å¢å¤§è¯¥å€¼ï¼ˆå¦‚ 16MB-64MBï¼‰å¯èƒ½æå‡å†™å…¥æ€§èƒ½ã€‚ å¤§äº‹åŠ¡ï¼š å¤„ç†å¤§é‡ WAL æ•°æ®æ—¶ï¼Œè¾ƒå¤§çš„ç¼“å†²åŒºå¯å‡å°‘ I/O å‹åŠ›ã€‚ æ³¨æ„äº‹é¡¹ï¼š\nè¯¥å‚æ•°åªèƒ½åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è®¾ç½®ã€‚ å³ä½¿è®¾å¾—éå¸¸å¤§ï¼Œæ€§èƒ½å¢ç›Šä¹Ÿä¸ä¼šæ— é™åˆ¶å¢åŠ ï¼Œé€šå¸¸ 16MB åˆ° 64MB è¶³å¤Ÿäº†ã€‚ è®¾ç½®ä¸º -1 é€šå¸¸èƒ½è·å¾—åˆç†çš„ç»“æœã€‚ æ€»ç»“ï¼š é»˜è®¤ä½¿ç”¨è‡ªåŠ¨é…ç½® (-1)ï¼›å¦‚æœæœåŠ¡å™¨è§‚å¯Ÿåˆ°å¤§é‡çš„ WAL ç­‰å¾…æˆ–å¤„äºæé«˜è´Ÿè½½ä¸‹ï¼Œå†è€ƒè™‘å°†å…¶æ‰‹åŠ¨è®¾ä¸º 16MB-64MB çš„å›ºå®šå€¼ã€‚\n","description":"å‚è€ƒæ–‡æ¡£ï¼šPostgreSQL é…ç½®å‚æ•° wal_buffers = -1è¯¦ç»†è®²è§£\nPostgreSQL çš„ wal_buffers å‚æ•°ç»å¤§å¤šæ•°åœºæ™¯å»ºè®®ä¿æŒé»˜è®¤å€¼ -1ï¼ˆè‡ªåŠ¨ï¼‰ï¼Œè¿™ä¼šæ ¹æ® shared_buffers çš„ 1/32 è‡ªåŠ¨è°ƒèŠ‚ï¼ˆä¸Šé™é€šå¸¸ 16MBï¼‰ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å·¥ä½œè´Ÿè½½ã€‚ä»…åœ¨æé«˜å¹¶å‘å†™å…¥ã€å¤§å‹äº‹åŠ¡åœºæ™¯ä¸‹ï¼Œæ‰‹åŠ¨è®¾ä¸º 16MB-64MB çš„å›ºå®šå€¼å¯èƒ½å¸¦æ¥è½»å¾®æ€§èƒ½æå‡ã€‚\nå…·ä½“åˆ†æä¸å»ºè®®ï¼š\né»˜è®¤å€¼ (-1, è‡ªåŠ¨) æœ€ä½³ï¼š è‡ªåŠ¨ç®¡ç†ä¼šæ ¹æ® shared_buffers çš„å¤§å°è‡ªåŠ¨åˆ†é… WAL ç¼“å†²åŒºå¤§å°ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼Œè¿™èƒ½å¹³è¡¡æ€§èƒ½ä¸å†…å­˜å ç”¨ï¼Œä¸éœ€è¦é¢å¤–ç»´æŠ¤ã€‚\næ‰‹åŠ¨å›ºå®šå€¼é€‚ç”¨åœºæ™¯ï¼š\né«˜å¹¶å‘å†™æ“ä½œï¼š è®¸å¤šå®¢æˆ·ç«¯åŒæ—¶æäº¤äº‹åŠ¡çš„ç¹å¿™æœåŠ¡å™¨ï¼Œé€‚å½“å¢å¤§è¯¥å€¼ï¼ˆå¦‚ 16MB-64MBï¼‰å¯èƒ½æå‡å†™å…¥æ€§èƒ½ã€‚ å¤§äº‹åŠ¡ï¼š å¤„ç†å¤§é‡ WAL æ•°æ®æ—¶ï¼Œè¾ƒå¤§çš„ç¼“å†²åŒºå¯å‡å°‘ I/O å‹åŠ›ã€‚ æ³¨æ„äº‹é¡¹ï¼š\nè¯¥å‚æ•°åªèƒ½åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è®¾ç½®ã€‚ å³ä½¿è®¾å¾—éå¸¸å¤§ï¼Œæ€§èƒ½å¢ç›Šä¹Ÿä¸ä¼šæ— é™åˆ¶å¢åŠ ï¼Œé€šå¸¸ 16MB åˆ° 64MB è¶³å¤Ÿäº†ã€‚ è®¾ç½®ä¸º -1 é€šå¸¸èƒ½è·å¾—åˆç†çš„ç»“æœã€‚ æ€»ç»“ï¼š é»˜è®¤ä½¿ç”¨è‡ªåŠ¨é…ç½® (-1)ï¼›å¦‚æœæœåŠ¡å™¨è§‚å¯Ÿåˆ°å¤§é‡çš„ WAL ç­‰å¾…æˆ–å¤„äºæé«˜è´Ÿè½½ä¸‹ï¼Œå†è€ƒè™‘å°†å…¶æ‰‹åŠ¨è®¾ä¸º 16MB-64MB çš„å›ºå®šå€¼ã€‚\n"},{"id":447,"href":"/backend/python/official/while/","title":"While (å¾ªç¯)","parent":"Official","content":" ğŸŸ¦ 1. åŸºæœ¬è¯­æ³• while condition: # å¾ªç¯ä½“ else: # æ¡ä»¶ä¸æ»¡è¶³è‡ªåŠ¨æ‰§è¡Œï¼ˆå¯é€‰ï¼‰ æ³¨æ„ï¼š\nå½“ condition ä¸º False æ—¶åœæ­¢å¾ªç¯ else åªæœ‰å¾ªç¯ è‡ªç„¶ç»“æŸ æ‰æ‰§è¡Œï¼ˆä¸æ˜¯è¢« break ç»ˆæ­¢ï¼‰ ğŸŸ© 2. åŸºç¡€ç¤ºä¾‹ i = 0 while i \u0026lt; 5: print(i) i += 1 ğŸŸ¦ 3. while + elseï¼ˆPython ç‰¹æœ‰ï¼‰ i = 0 while i \u0026lt; 3: print(i) i += 1 else: print(\u0026#34;å¾ªç¯æ­£å¸¸ç»“æŸ\u0026#34;) å¦‚æœç”¨ break æå‰é€€å‡ºï¼Œelse ä¸æ‰§è¡Œï¼š\ni = 0 while i \u0026lt; 3: break else: print(\u0026#34;ä¸ä¼šæ‰§è¡Œ\u0026#34;) ğŸŸ© 4. æ— é™å¾ªç¯ï¼ˆå¸¸è§ï¼‰ while True: ... å¸¸ç”¨äºï¼š\næœåŠ¡å¸¸é©»è¿›ç¨‹ å®ˆæŠ¤ç¨‹åº è½®è¯¢ä»»åŠ¡ æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹ é€€å‡ºæ¡ä»¶å¿…é¡»åœ¨å¾ªç¯ä½“å†…æ§åˆ¶ï¼š\nwhile True: cmd = input(\u0026#34;\u0026gt; \u0026#34;) if cmd == \u0026#34;exit\u0026#34;: break ğŸŸ¦ 5. while çš„å¸¸è§æ§åˆ¶è¯­å¥ breakï¼šè·³å‡ºæ•´ä¸ªå¾ªç¯\nwhile True: if done: break continueï¼šè·³åˆ°ä¸‹ä¸€æ¬¡å¾ªç¯\nwhile i \u0026lt; 10: i += 1 if i % 2 == 0: continue print(i) ğŸŸ© 6. while vs for | åœºæ™¯ | ç”¨ for | ç”¨ while | | éå†åˆ—è¡¨ / å­—å…¸ / å­—ç¬¦ä¸² | âœ… æ¨è | ä¸æ¨è | | æ˜ç¡®æ¬¡æ•°ï¼ˆrangeï¼‰ | âœ… æ¨è | ä¸æ¨è | | ä¾é â€œæ¡ä»¶åˆ¤æ–­â€å¾ªç¯ | ä¸é€‚åˆ | âœ… æœ€é€‚åˆ | | æ— é™å¾ªç¯ | ä¹Ÿå¯ç”¨ | âœ… æœ€å¸¸ç”¨ | | I/O é˜»å¡ã€è½®è¯¢ | å¯ç”¨ | âœ… æ ‡å‡†å†™æ³• |\næ€»ç»“ï¼š\nèƒ½ç”¨ for å°±ä¸ç”¨ whileï¼› while ç”¨äºæ— æ³•é¢„å…ˆç¡®å®šå¾ªç¯æ¬¡æ•°çš„é€»è¾‘ã€‚ ğŸŸ¦ 7. while å¸¸è§ä½¿ç”¨åœºæ™¯ï¼ˆå·¥ç¨‹å®è·µï¼‰ â‘  ç½‘ç»œæœåŠ¡è½®è¯¢ while True: data = socket.recv(1024) if not data: break â‘¡ æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ— while True: msg = redis.lpop(\u0026#34;queue\u0026#34;) if msg: process(msg) â‘¢ é‡è¯•æœºåˆ¶ retries = 3 while retries \u0026gt; 0: if call_api(): break retries -= 1 â‘£ æµå¼è¯»å–æ–‡ä»¶ while chunk := f.read(1024): process(chunk) ï¼ˆPython 3.8+ æµ·è±¡è¿ç®—ç¬¦ï¼‰\nğŸŸ¦ 8. æœ€ä½³å®è·µï¼ˆé«˜è´¨é‡ä»£ç ï¼‰ â‘  é¿å…æ— é™å¾ªç¯æ²¡æœ‰å‡ºå£ while True: ... å¿…é¡»åŠ  break æˆ– returnã€‚\nâ‘¡ ä¼˜å…ˆä½¿ç”¨ for é”™è¯¯ï¼ˆä¸ pythonicï¼‰ï¼š\ni = 0 while i \u0026lt; len(items): print(items[i]) i += 1 æ­£ç¡®ï¼š\nfor item in items: print(item) â‘¢ ä½¿ç”¨æµ·è±¡è¿ç®—ç¬¦å‡å°‘é‡å¤ä»£ç  ä¼ ç»Ÿå†™æ³•ï¼š\nline = f.readline() while line: ... line = f.readline() Pythonicï¼š\nwhile line := f.readline(): ... â‘£ é¿å…æ­»å¾ªç¯æ¡ä»¶é”™è¯¯ å¸¸è§é”™è¯¯ï¼š\ni = 0 while i \u0026lt; 5: print(i) # å¿˜è®° i += 1 â‘¤ while + sleep æ¨¡æ‹Ÿå®šæ—¶ä»»åŠ¡ import time while True: run_job() time.sleep(60) ğŸŸ¦ 9. é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ç‰ˆï¼‰ åŠŸèƒ½ å†™æ³• åŸºæœ¬å¾ªç¯ while condition: æ— é™å¾ªç¯ while True: å¸¦ else while \u0026hellip; else: æ‰‹åŠ¨é€€å‡º break è·³è¿‡å½“å‰å¾ªç¯ continue æµ·è±¡è¿ç®—ç¬¦ while x := func(): éå†æ–‡ä»¶æµ while chunk := f.read(1024): é‡è¯• while retries \u0026gt; 0: ","description":" ğŸŸ¦ 1. åŸºæœ¬è¯­æ³• while condition: # å¾ªç¯ä½“ else: # æ¡ä»¶ä¸æ»¡è¶³è‡ªåŠ¨æ‰§è¡Œï¼ˆå¯é€‰ï¼‰ æ³¨æ„ï¼š\nå½“ condition ä¸º False æ—¶åœæ­¢å¾ªç¯ else åªæœ‰å¾ªç¯ è‡ªç„¶ç»“æŸ æ‰æ‰§è¡Œï¼ˆä¸æ˜¯è¢« break ç»ˆæ­¢ï¼‰ ğŸŸ© 2. åŸºç¡€ç¤ºä¾‹ i = 0 while i \u0026lt; 5: print(i) i += 1 ğŸŸ¦ 3. while + elseï¼ˆPython ç‰¹æœ‰ï¼‰ i = 0 while i \u0026lt; 3: print(i) i += 1 else: print(\u0026#34;å¾ªç¯æ­£å¸¸ç»“æŸ\u0026#34;) å¦‚æœç”¨ break æå‰é€€å‡ºï¼Œelse ä¸æ‰§è¡Œï¼š\n"},{"id":448,"href":"/backend/python/official/with/","title":"With","parent":"Official","content":" ğŸŸ¦ 1. ä»€ä¹ˆæ˜¯ withï¼Ÿ with ç”¨äºè‡ªåŠ¨å¤„ç† èµ„æºç”³è¯· -\u0026gt; ä½¿ç”¨ -\u0026gt; é‡Šæ”¾ çš„æµç¨‹ã€‚\nwith resource as r: r.do() å¥½å¤„ï¼š\nè‡ªåŠ¨å…³é—­æ–‡ä»¶ã€è¿æ¥ã€æ¸¸æ ‡ç­‰ é¿å…æ³„æ¼ é¿å… finally ä»£ç æ›´ç®€æ´ã€å¯è¯»æ€§æ›´é«˜ ğŸŸ© 2. æœ€å¸¸è§çš„ä¾‹å­ï¼šæ–‡ä»¶ with open(\u0026#34;data.txt\u0026#34;, \u0026#34;r\u0026#34;) as f: content = f.read() ç¦»å¼€ç¼©è¿›å—åï¼š\nè‡ªåŠ¨è°ƒç”¨ f.close() ğŸŸ¦ 3. with èƒŒåçš„åè®®ï¼ˆå¿…é¡»æŒæ¡ï¼‰ è¦è®©ä¸€ä¸ªå¯¹è±¡èƒ½è¢« with ä½¿ç”¨ï¼Œå®ƒå¿…é¡»å®ç°ï¼š\n__enter__(self) __exit__(self, exc_type, exc, tb) æµç¨‹ï¼š\nwith obj as x: # è¿›å…¥å‰ä¼šæ‰§è¡Œï¼šx = obj.__enter__() # ç¦»å¼€æ—¶ä¸€å®šæ‰§è¡Œï¼šobj.__exit__() ğŸŸ© 4. è‡ªå®šä¹‰ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆä½ é¡¹ç›®ä¼šç”¨åˆ°ï¼‰ class MyTimer: def __enter__(self): import time self.start = time.time() return self def __exit__(self, exc_type, exc, tb): import time print(\u0026#34;è€—æ—¶ï¼š\u0026#34;, time.time() - self.start) # è¿”å› False è¡¨ç¤ºå¼‚å¸¸ç»§ç»­å¾€å¤–æŠ› return False with MyTimer(): print(\u0026#34;doing something...\u0026#34;) è¾“å‡ºï¼š\ndoing something... è€—æ—¶ï¼š 0.00123 ğŸŸ¦ 5. æ›´ä¼˜é›…å†™æ³•ï¼šcontextlib.contextmanager é€‚åˆå¿«é€Ÿå†™ withï¼š\nfrom contextlib import contextmanager @contextmanager def open_db(): conn = create_connection() try: yield conn finally: conn.close() ä½¿ç”¨ï¼š\nwith open_db() as conn: conn.query(...) ğŸŸ© 6. with çš„å·¥ç¨‹çº§ä½¿ç”¨åœºæ™¯ â‘  æ–‡ä»¶è¯»å–/å†™å…¥ with open(\u0026#34;a.txt\u0026#34;) as f: ... â‘¡ æ•°æ®åº“è¿æ¥/äº‹åŠ¡ï¼ˆä½ é¡¹ç›®éå¸¸é€‚ç”¨ï¼‰ with SessionLocal() as session: session.add(...) session.commit() â‘¢ é” from threading import Lock lock = Lock() with lock: # è‡ªåŠ¨ acquire / release â‘£ ç½‘ç»œè¿æ¥ï¼ˆrequestsï¼‰ with requests.get(url, stream=True) as resp: ... â‘¤ å¤„ç†ä¸´æ—¶èµ„æº from tempfile import TemporaryDirectory with TemporaryDirectory() as tmpdir: ... â‘¥ å¼‚å¸¸å¤„ç†å°è£… from contextlib import suppress with suppress(FileNotFoundError): os.remove(\u0026#34;test.txt\u0026#34;) ğŸŸ¦ 7. ä¸Šä¸‹æ–‡ä¸­çš„å¼‚å¸¸å¤„ç†åŸç† __exit__ æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š\nå‚æ•° è¯´æ˜ exc_type å¼‚å¸¸ç±»å‹ exc å¼‚å¸¸å¯¹è±¡ tb traceback å¦‚æœ __exit__ è¿”å› Trueï¼š\nå¼‚å¸¸è¢«è®¤ä¸ºâ€œå·²å¤„ç†â€ï¼Œä¸ä¼šå‘ä¸ŠæŠ›å‡º ä¾‹å¦‚ï¼š\nclass IgnoreError: def __exit__(self, exc_type, exc, tb): return True # ä¸¢å¼ƒå¼‚å¸¸ ğŸŸ© 8. with + å¤šä¸ªä¸Šä¸‹æ–‡ with open(\u0026#34;a.txt\u0026#34;) as f1, open(\u0026#34;b.txt\u0026#34;) as f2: ... ğŸŸ¦ 9. å…³é”®ï¼šwith ä¸ä¼šæ•è·å¼‚å¸¸ï¼Œè€Œæ˜¯æŠŠå®ƒâ€œäº¤ç»™â€ exit ä½ å¯ä»¥é€‰æ‹©ï¼š\nä¸å¤„ç†ï¼ˆè¿”å› Falseï¼‰ åƒæ‰å¼‚å¸¸ï¼ˆè¿”å› Trueï¼‰ è‡ªå·±æŠ›å‡ºæ–°å¼‚å¸¸ ğŸŸ© 10. å·¥ç¨‹æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ ä¼˜å…ˆä½¿ç”¨ with ç®¡ç† IO / DB / ç½‘ç»œèµ„æº é¿å…æ‰‹åŠ¨ close\nè‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®€åŒ–å¤§é‡é‡å¤é€»è¾‘ å¦‚ä½ å¸¸ç”¨çš„ Database session\né¿å…åœ¨ with å—é‡Œå†™å¤ªå¤šé€»è¾‘ åŸåˆ™ï¼šwith å—è¶Šå°è¶Šå¥½\nå¦‚æœè¦ç¡®ä¿æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œå°±ç”¨ with æ¯”å¦‚é”ã€ä¸´æ—¶æ–‡ä»¶ã€ç½‘ç»œæµ\nğŸŸ¦ 11. é€ŸæŸ¥è¡¨ï¼ˆæ”¶è—ï¼‰ åŠŸèƒ½ å†™æ³• æ–‡ä»¶æ“ä½œ with open(...) as f: è‡ªå®šä¹‰ç±» å®šä¹‰ __enter__ + __exit__ å¿«é€Ÿè‡ªå®šä¹‰ @contextmanager å¿½ç•¥å¼‚å¸¸ with suppress(Exception): ç®¡ç†é” with lock: æ•°æ®åº“ä¼šè¯ with Session() as s: å¤šä¸Šä¸‹æ–‡ with A() as a, B() as b: é€€å‡ºæ¸…ç† å†™åœ¨ __exit__() æˆ– finally ","description":" ğŸŸ¦ 1. ä»€ä¹ˆæ˜¯ withï¼Ÿ with ç”¨äºè‡ªåŠ¨å¤„ç† èµ„æºç”³è¯· -\u0026gt; ä½¿ç”¨ -\u0026gt; é‡Šæ”¾ çš„æµç¨‹ã€‚\nwith resource as r: r.do() å¥½å¤„ï¼š\nè‡ªåŠ¨å…³é—­æ–‡ä»¶ã€è¿æ¥ã€æ¸¸æ ‡ç­‰ é¿å…æ³„æ¼ é¿å… finally ä»£ç æ›´ç®€æ´ã€å¯è¯»æ€§æ›´é«˜ ğŸŸ© 2. æœ€å¸¸è§çš„ä¾‹å­ï¼šæ–‡ä»¶ with open(\u0026#34;data.txt\u0026#34;, \u0026#34;r\u0026#34;) as f: content = f.read() ç¦»å¼€ç¼©è¿›å—åï¼š\nè‡ªåŠ¨è°ƒç”¨ f.close() ğŸŸ¦ 3. with èƒŒåçš„åè®®ï¼ˆå¿…é¡»æŒæ¡ï¼‰ è¦è®©ä¸€ä¸ªå¯¹è±¡èƒ½è¢« with ä½¿ç”¨ï¼Œå®ƒå¿…é¡»å®ç°ï¼š\n"},{"id":449,"href":"/operations/linux/xfs-log/","title":"XFS log","parent":"Linux","content":"XFS çš„ logbufs å’Œ logbsize ç”¨äºé…ç½®å†…å­˜ä¸­æ—¥å¿—ç¼“å†²åŒºæ•°é‡å’Œå¤§å°ï¼Œä¼˜åŒ–é«˜æ€§èƒ½å­˜å‚¨å†™å…¥ï¼Œä¸»è¦é€šè¿‡æŒ‚è½½å‚æ•°ï¼ˆlogbufs=8,logbsize=256kï¼‰è°ƒèŠ‚ã€‚å¢åŠ è¿™äº›å€¼å¯å‡å°‘å…ƒæ•°æ®åŒæ­¥ç“¶é¢ˆï¼Œæ¨èåœ¨ååé‡å¤§ã€æ—¥å¿—é«˜è´Ÿè·çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\næ ¸å¿ƒé…ç½®æŒ‡å—ï¼š\nlogbufs (ç¼“å†²åŒºæ•°é‡): é»˜è®¤å€¼é€šå¸¸ä¸º 2 æˆ– 8ï¼ˆå–å†³äºå†…æ ¸ç‰ˆæœ¬ï¼‰ã€‚å»ºè®®è®¾ç½®èŒƒå›´ä¸º 2 åˆ° 8ï¼Œé«˜å¹¶å‘å†™å…¥åœºæ™¯å¯é€‚å½“å¢åŠ ã€‚ logbsize (ç¼“å†²åŒºå¤§å°): é»˜è®¤å¤§å°é€šå¸¸ä¸º 32KBã€‚ä¸ºäº†æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ååç¯å¢ƒä¸­ï¼Œé€šå¸¸å°†å…¶å¢åŠ åˆ° 256KBã€‚ é€‚ç”¨åœºæ™¯: æ•°æ®åº“ã€å­˜å‚¨å¤§æ–‡ä»¶ã€å¹¶å‘å†™é«˜è´Ÿè½½çš„ç³»ç»Ÿã€‚\nç¤ºä¾‹æŒ‚è½½å‚æ•°ï¼š\nmount -o logbufs=8,logbsize=256k /dev/sdb1 /mnt/xfs è°ƒæ•´è¿™äº›å‚æ•°å¯ä»¥æœ‰æ•ˆå‡å°‘ I/O ç­‰å¾…ï¼Œæé«˜æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ã€‚\næŸ¥çœ‹æŒ‚è½½å‚æ•°ä¿¡æ¯ï¼š\nfindmnt findmnt / ","description":"XFS çš„ logbufs å’Œ logbsize ç”¨äºé…ç½®å†…å­˜ä¸­æ—¥å¿—ç¼“å†²åŒºæ•°é‡å’Œå¤§å°ï¼Œä¼˜åŒ–é«˜æ€§èƒ½å­˜å‚¨å†™å…¥ï¼Œä¸»è¦é€šè¿‡æŒ‚è½½å‚æ•°ï¼ˆlogbufs=8,logbsize=256kï¼‰è°ƒèŠ‚ã€‚å¢åŠ è¿™äº›å€¼å¯å‡å°‘å…ƒæ•°æ®åŒæ­¥ç“¶é¢ˆï¼Œæ¨èåœ¨ååé‡å¤§ã€æ—¥å¿—é«˜è´Ÿè·çš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\næ ¸å¿ƒé…ç½®æŒ‡å—ï¼š\nlogbufs (ç¼“å†²åŒºæ•°é‡): é»˜è®¤å€¼é€šå¸¸ä¸º 2 æˆ– 8ï¼ˆå–å†³äºå†…æ ¸ç‰ˆæœ¬ï¼‰ã€‚å»ºè®®è®¾ç½®èŒƒå›´ä¸º 2 åˆ° 8ï¼Œé«˜å¹¶å‘å†™å…¥åœºæ™¯å¯é€‚å½“å¢åŠ ã€‚ logbsize (ç¼“å†²åŒºå¤§å°): é»˜è®¤å¤§å°é€šå¸¸ä¸º 32KBã€‚ä¸ºäº†æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ååç¯å¢ƒä¸­ï¼Œé€šå¸¸å°†å…¶å¢åŠ åˆ° 256KBã€‚ é€‚ç”¨åœºæ™¯: æ•°æ®åº“ã€å­˜å‚¨å¤§æ–‡ä»¶ã€å¹¶å‘å†™é«˜è´Ÿè½½çš„ç³»ç»Ÿã€‚\nç¤ºä¾‹æŒ‚è½½å‚æ•°ï¼š\nmount -o logbufs=8,logbsize=256k /dev/sdb1 /mnt/xfs è°ƒæ•´è¿™äº›å‚æ•°å¯ä»¥æœ‰æ•ˆå‡å°‘ I/O ç­‰å¾…ï¼Œæé«˜æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½ã€‚\næŸ¥çœ‹æŒ‚è½½å‚æ•°ä¿¡æ¯ï¼š\nfindmnt findmnt / "},{"id":450,"href":"/operations/linux/xfs-disable-atime/","title":"XFS ç¦ç”¨ atime","parent":"Linux","content":" å‡å°‘ç£ç›˜ IOï¼Œæé«˜æ€§èƒ½ ç›®çš„ï¼šç”±äºæ—¥å¿—é¿å…ç³»ç»Ÿå˜æ…¢çš„é—®é¢˜\næ—¥å¿—æ›´æ”¹å†™å…¥åˆ°ç£ç›˜çš„é¡ºåºå¯èƒ½ä¸å®ƒä»¬åˆ°è¾¾çš„é¡ºåºä¸åŒã€‚å†…æ ¸ I/O ç³»ç»Ÿå¯é‡æ–°æ’åºæ—¥å¿—æ›´æ”¹ï¼Œä»¥ä¼˜åŒ–ä½¿ç”¨å¯ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚æ—¥å¿—æ´»åŠ¨å¯ä»¥é€šè¿‡é‡æ–°æ’åºæ—¥å¿—æ›´æ”¹å¹¶æäº¤æ•°æ®å’Œå…ƒæ•°æ®å¯¼è‡´ç³»ç»Ÿå»¶è¿Ÿã€‚å› æ­¤ï¼Œæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šé™ä½ç³»ç»Ÿé€Ÿåº¦ã€‚\nç¦ç”¨ atime é€šè¿‡é™åˆ¶å†™å…¥æ–‡ä»¶ç³»ç»Ÿæ—¥å¿—æ•°é‡æ¥æé«˜æ€§èƒ½å¹¶é™ä½åŠŸè€—ã€‚\nXFS æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ /etc/fstab ä¸­çš„æŒ‚è½½é€‰é¡¹æ¥ç¦ç”¨ atimeï¼ˆè®¿é—®æ—¶é—´æ›´æ–°ï¼‰ï¼Œå¸¸è§æ–¹æ³•æ˜¯æ·»åŠ  noatime æˆ– nodiratime é€‰é¡¹ï¼Œæˆ–è€…æ›´ç²¾ç»†åœ°ä½¿ç”¨ relatime (ç›¸å¯¹æ—¶é—´æ›´æ–°ï¼Œé»˜è®¤è¡Œä¸º) æ¥å‡å°‘æ€§èƒ½å¼€é”€ã€‚\nXFS ç¦ç”¨ atime çš„æ–¹æ³• ç¼–è¾‘ /etc/fstab æ–‡ä»¶ã€‚\næ‰¾åˆ°éœ€è¦ç¦ç”¨ atime çš„ XFS æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¡Œï¼Œä¾‹å¦‚ï¼š\n/dev/sda1 /data xfs defaults 0 0 ä¿®æ”¹ä¸ºä»¥ä¸‹ä»»ä¸€é€‰é¡¹ä¹‹ä¸€ï¼š\nå®Œå…¨ç¦ç”¨ atime å’Œ diratime (æ¨èç”¨äºé«˜æ€§èƒ½éœ€æ±‚)ï¼š\n/dev/sda1 /data xfs defaults,noatime,nodiratime 0 0 ä»…ç¦ç”¨ atime (æ–‡ä»¶è®¿é—®æ—¶ä¸æ›´æ–°ï¼Œç›®å½•è®¿é—®ä»æ›´æ–°)ï¼š\n/dev/sda1 /data xfs defaults,noatime 0 0 ä½¿ç”¨ relatime (ç›¸å¯¹æ—¶é—´æ›´æ–°) (é»˜è®¤è¡Œä¸ºï¼ŒXFS åœ¨è¾ƒæ–°å†…æ ¸ä¸­å¯èƒ½é»˜è®¤å¯ç”¨ï¼Œç›¸å¯¹é«˜æ•ˆï¼Œä»…åœ¨æ–‡ä»¶è¢«ä¿®æ”¹æˆ–ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´æ¯”å½“å‰æ—¶é—´æ—§æ—¶æ›´æ–°)ï¼š\n/dev/sda1 /data xfs defaults,relatime 0 0 é‡æ–°æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ ä¿®æ”¹ /etc/fstab åï¼Œå¯ä»¥é€šè¿‡ mount -o remount /data (å¦‚æœå·²æŒ‚è½½) æˆ–é‡å¯ç³»ç»Ÿä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚\né€‰é¡¹è¯´æ˜ atime: æ¯æ¬¡è®¿é—®æ–‡ä»¶æ—¶æ›´æ–°å…¶æœ€åè®¿é—®æ—¶é—´ã€‚ noatime: å®Œå…¨ç¦ç”¨æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•çš„è®¿é—®æ—¶é—´æ›´æ–°ã€‚ nodiratime: ç¦ç”¨ç›®å½•çš„è®¿é—®æ—¶é—´æ›´æ–° (å¸¸ä¸ relatime é…åˆä½¿ç”¨)ã€‚ relatime: ä»…åœ¨æ–‡ä»¶è¢«ä¿®æ”¹æˆ– atime æ¯” mtime/ctime æ—§æ—¶æ‰æ›´æ–° atime (æ˜¯Linuxå†…æ ¸çš„é»˜è®¤ä¼˜åŒ–è¡Œä¸ºï¼Œå¯æ˜¾è‘—å‡å°‘ç£ç›˜I/O)ã€‚ ","description":" å‡å°‘ç£ç›˜ IOï¼Œæé«˜æ€§èƒ½ ç›®çš„ï¼šç”±äºæ—¥å¿—é¿å…ç³»ç»Ÿå˜æ…¢çš„é—®é¢˜\næ—¥å¿—æ›´æ”¹å†™å…¥åˆ°ç£ç›˜çš„é¡ºåºå¯èƒ½ä¸å®ƒä»¬åˆ°è¾¾çš„é¡ºåºä¸åŒã€‚å†…æ ¸ I/O ç³»ç»Ÿå¯é‡æ–°æ’åºæ—¥å¿—æ›´æ”¹ï¼Œä»¥ä¼˜åŒ–ä½¿ç”¨å¯ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚æ—¥å¿—æ´»åŠ¨å¯ä»¥é€šè¿‡é‡æ–°æ’åºæ—¥å¿—æ›´æ”¹å¹¶æäº¤æ•°æ®å’Œå…ƒæ•°æ®å¯¼è‡´ç³»ç»Ÿå»¶è¿Ÿã€‚å› æ­¤ï¼Œæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šé™ä½ç³»ç»Ÿé€Ÿåº¦ã€‚\nç¦ç”¨ atime é€šè¿‡é™åˆ¶å†™å…¥æ–‡ä»¶ç³»ç»Ÿæ—¥å¿—æ•°é‡æ¥æé«˜æ€§èƒ½å¹¶é™ä½åŠŸè€—ã€‚\nXFS æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ /etc/fstab ä¸­çš„æŒ‚è½½é€‰é¡¹æ¥ç¦ç”¨ atimeï¼ˆè®¿é—®æ—¶é—´æ›´æ–°ï¼‰ï¼Œå¸¸è§æ–¹æ³•æ˜¯æ·»åŠ  noatime æˆ– nodiratime é€‰é¡¹ï¼Œæˆ–è€…æ›´ç²¾ç»†åœ°ä½¿ç”¨ relatime (ç›¸å¯¹æ—¶é—´æ›´æ–°ï¼Œé»˜è®¤è¡Œä¸º) æ¥å‡å°‘æ€§èƒ½å¼€é”€ã€‚\nXFS ç¦ç”¨ atime çš„æ–¹æ³• ç¼–è¾‘ /etc/fstab æ–‡ä»¶ã€‚\næ‰¾åˆ°éœ€è¦ç¦ç”¨ atime çš„ XFS æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¡Œï¼Œä¾‹å¦‚ï¼š\n"},{"id":451,"href":"/database/mysql/xtrabackup/","title":"XtraBackup åŸºç¡€æ•™ç¨‹","parent":"MySQL","content":"è¦†ç›–ï¼šæ ¸å¿ƒåŸç†ã€å¤‡ä»½ç±»å‹ã€ä½¿ç”¨æ–¹æ³•ã€æ¢å¤æµç¨‹ã€æ€§èƒ½ä¼˜åŒ–ã€ä¸ mysqldump/mydumper å¯¹æ¯”ã€ç”Ÿäº§æœ€ä½³å®è·µã€‚\nğŸ§± 1. XtraBackup æ˜¯ä»€ä¹ˆï¼Ÿ XtraBackupï¼ˆPercona XtraBackupï¼‰ æ˜¯ MySQL / MariaDB æœ€ä¸“ä¸šçš„ ç‰©ç†çƒ­å¤‡å·¥å…·ï¼Œæ”¯æŒ InnoDB çš„ æ— é”å¤‡ä»½ï¼ˆhot backupï¼‰ï¼Œä¼ä¸šç”Ÿäº§æœ€å¸¸ç”¨ã€‚\nç‰¹ç‚¹ï¼š\nç‰©ç†å¤‡ä»½ï¼ˆæ‹·è´æ•°æ®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å¯¼å‡º SQLï¼‰ ä¸é˜»å¡è¯»å†™ï¼ˆhot backupï¼‰ æ”¯æŒ å…¨å¤‡ã€å¢é‡å¤‡ä»½ã€å·®å¼‚å¤‡ä»½ å¤‡ä»½é€Ÿåº¦æå¿«ï¼ˆæ–‡ä»¶çº§åˆ«ï¼‰ æ”¯æŒ redo + undo æ¢å¤ä¸€è‡´æ€§ å¯ç”¨äº MySQLã€Percona Serverã€MariaDB ğŸ”¥ XtraBackup å¯è®¤ä¸ºæ˜¯ MySQL ç‰©ç†å¤‡ä»½çš„å·¥ä¸šæ ‡å‡†ã€‚\nğŸ§± 2. é€‚ç”¨åœºæ™¯ï¼ˆä¼ä¸šå¸¸ç”¨ï¼‰ åœ¨çº¿å¤‡ä»½ï¼Œä¸ä¸­æ–­ä¸šåŠ¡ æ•°æ®åº“è¶…è¿‡ 50GBã€100GBã€ç”šè‡³æ•° TB MHA / MGR / PXC é›†ç¾¤èŠ‚ç‚¹å¤åˆ¶ åšä»åº“ã€å»¶è¿Ÿåº“ è‡ªåŠ¨å¤‡ä»½è„šæœ¬ ç¾éš¾æ¢å¤ï¼ˆDRï¼‰ å¦‚æœä½ æ˜¯è¿ç»´ / DBAï¼Œåœ¨ä¼ä¸šé‡ŒåŸºæœ¬ç¦»ä¸å¼€å®ƒã€‚\nğŸ§± 3. æ ¸å¿ƒåŸç†ï¼ˆå›å¤2æ·±åº¦å†…å®¹èåˆï¼‰ XtraBackup çš„åŸç†åŸºäºï¼š\nï¼ˆ1ï¼‰æ‹·è´ InnoDB è¡¨ç©ºé—´/æ—¥å¿—æ–‡ä»¶ï¼ˆç‰©ç†æ–¹å¼ï¼‰ é€æ–‡ä»¶å¤åˆ¶ï¼š\nibdata1 *.ibd redo log undo log ï¼ˆ2ï¼‰MVCC + redo log ä¿è¯ä¸€è‡´æ€§ å¤‡ä»½è¿‡ç¨‹ä¸­ï¼š\næ‹·è´æ–‡ä»¶ åŒæ—¶è®°å½• redo log æœ€åé€šè¿‡ xtrabackup \u0026ndash;prepare åº”ç”¨ redoï¼Œä½¿æ•°æ®è¾¾åˆ°ç»Ÿä¸€æ—¶é—´ç‚¹çš„ crash-consistent çŠ¶æ€ ç±»ä¼¼ MySQL åœ¨å´©æºƒæ¢å¤æ—¶çš„ redo å›æ”¾ã€‚\nï¼ˆ3ï¼‰å¯¹ MyISAM éœ€è¦çŸ­æš‚è¡¨é” å› ä¸º MyISAM æ²¡æœ‰ MVCCï¼Œåªèƒ½é”è¡¨ä¿è¯ä¸€è‡´æ€§ã€‚\nğŸ§± 4. XtraBackup å¤‡ä»½ç±»å‹ï¼ˆå®Œæ•´ï¼‰ ç±»å‹ è¯´æ˜ æ˜¯å¦é”è¡¨ å®Œå…¨å¤‡ä»½ï¼ˆFull Backupï¼‰ æ‹·è´å…¨éƒ¨æ•°æ®æ–‡ä»¶ ä¸é” InnoDB å¢é‡å¤‡ä»½ï¼ˆIncrementalï¼‰ ä»…å¤‡ä»½æ¯”ä¸Šæ¬¡å¤‡ä»½æ›´æ–°çš„é¡µé¢ ä¸é” InnoDB å·®å¼‚å¤‡ä»½ï¼ˆDifferentialï¼‰ åŸºäºæœ€è¿‘ä¸€æ¬¡å®Œå…¨å¤‡ä»½çš„å·®å¼‚ ä¸é” InnoDB æµå¤‡ä»½ï¼ˆStream Backupï¼‰ å¤‡ä»½å¹¶é€šè¿‡ç®¡é“è¾“å‡ºï¼ˆå¦‚ .xbstreamï¼‰ ä¸é” å¤‡ä»½å‹ç¼© ä½¿ç”¨ qpress/zstd ä¸é” ğŸ§± 5. åŸºç¡€ä½¿ç”¨ï¼ˆæœ€å¸¸ç”¨å‘½ä»¤ï¼‰ 5.1 å®Œå…¨å¤‡ä»½ xtrabackup --backup \\ --target-dir=/data/backup/full_2025_01_01 5.2 å¢é‡å¤‡ä»½ xtrabackup --backup \\ --target-dir=/backup/inc1 \\ --incremental-basedir=/backup/full_2025_01_01 5.3 åˆå¹¶å¢é‡ï¼ˆprepareï¼‰ å¿…é¡»æ‰§è¡Œ prepare æ‰èƒ½æ¢å¤ã€‚\nxtrabackup --prepare \\ --target-dir=/backup/full_2025_01_01 åå¤ prepare åˆå¹¶å¢é‡ï¼š\nxtrabackup --prepare \\ --target-dir=/backup/full_2025_01_01 \\ --incremental-dir=/backup/inc1 5.4 æ¢å¤ï¼ˆrestoreï¼‰ systemctl stop mysql rsync -avP /backup/full_2025_01_01/ /var/lib/mysql/ chown -R mysql:mysql /var/lib/mysql/ systemctl start mysql ğŸ§± 6. å¤‡ä»½æµç¨‹å›¾ï¼ˆå¢å¼ºè¯´æ˜ï¼‰ Backup Stage:\næ‹·è´æ•°æ®æ–‡ä»¶ æ‹·è´ redo ç”Ÿæˆ xtrabackup_logfileï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰ Prepare Stage:\nå›æ”¾ redo æ¸…ç†æœªæäº¤äº‹åŠ¡ ç”Ÿæˆ crash-consistent æ•°æ®åŒ… prepare è¿‡ç¨‹æ˜¯ XtraBackup çš„æ ¸å¿ƒã€‚\nğŸ§± 7. XtraBackup å¤‡ä»½ + æ¢å¤å®Œæ•´æµç¨‹ï¼ˆä¼ä¸šå¸¸ç”¨ï¼‰ ï¼ˆ1ï¼‰å®Œå…¨å¤‡ä»½ xtrabackup --backup --compress --target-dir=/backup/full ï¼ˆ2ï¼‰å¢é‡å¤‡ä»½ æ¯å¤©åšï¼š\nxtrabackup --backup --incremental --incremental-basedir=/backup/full --target-dir=/backup/inc1 ï¼ˆ3ï¼‰prepareï¼ˆå¤šæ¬¡ prepare åˆå¹¶ï¼‰ xtrabackup --prepare --apply-log-only --target-dir=/backup/full xtrabackup --prepare --apply-log-only --target-dir=/backup/full --incremental-dir=/backup/inc1 xtrabackup --prepare --target-dir=/backup/full ï¼ˆ4ï¼‰æ¢å¤ rsync -avP /backup/full/ /var/lib/mysql/ ğŸ§± 8. æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡è¦ï¼‰ 8.1 æå‡å¤‡ä»½é€Ÿåº¦ ä½¿ç”¨ SSDï¼ˆæå¤§æå‡ï¼‰ å¢å¤§ \u0026ndash;parallel=4/8/16 ä½¿ç”¨ \u0026ndash;compress + zstdï¼ˆå‹ç¼©æå¿«ï¼‰ ä½¿ç”¨ \u0026ndash;encryptï¼ˆéœ€è¦å®‰å…¨æ€§æ—¶ï¼‰ ç¤ºä¾‹ï¼š\nxtrabackup --backup --parallel=8 --compress --compress-threads=8 âœ” 8.2 æå‡æ¢å¤é€Ÿåº¦ prepare æ—¶å¢åŠ å¹¶è¡Œåº¦ï¼š\n--prepare --parallel=8 æ¢å¤æ—¶ä½¿ç”¨ rsync æ›¿ä»£ cp\nğŸ§± 9. XtraBackup vs mysqldump / mydumperï¼ˆæ·±åº¦å¯¹æ¯”ï¼‰ å·¥å…· ç±»å‹ é€Ÿåº¦ ä¸€è‡´æ€§ é”è¡¨ æ¢å¤é€Ÿåº¦ XtraBackup ç‰©ç† æå¿« é«˜ æ— é”ï¼ˆInnoDBï¼‰ æå¿« mysqldump é€»è¾‘ æ…¢ éœ€åŠ é” é”è¡¨ æ…¢ mydumper é€»è¾‘å¤šçº¿ç¨‹ ä¸­ç­‰~å¿« å¯å¿«ç…§ æ— é” ä¸­ç­‰ ç»“è®ºï¼š\nå¤§å‹æ•°æ®åº“ï¼ˆ\u0026gt;50GBï¼‰ -\u0026gt; XtraBackup ä¸­å°è§„æ¨¡ï¼Œéœ€è¿ç§»åˆ°ä¸åŒç‰ˆæœ¬ -\u0026gt; mydumper ä»…å¯¼æ•°æ®ç»“æ„æˆ–å°æ•°æ® -\u0026gt; mysqldump ğŸ§± 10. XtraBackup çš„é—®é¢˜ä¸æ³¨æ„äº‹é¡¹ âš ï¸ 10.1 MySQL 8.0 ä¸ XtraBackup å…¼å®¹æ€§è¦ä¸¥æ ¼ XtraBackup ä¸ MySQLç‰ˆæœ¬å¼ºç›¸å…³ï¼š\nMySQL ç‰ˆæœ¬ XtraBackup ç‰ˆæœ¬ MySQL 8.x Percona XtraBackup 8.x MySQL 5.7 XtraBackup 2.4 ä¸èƒ½æ··ç”¨ã€‚\nâš ï¸ 10.2 åŠ å¯†å¤‡ä»½éœ€è¦ key æ–‡ä»¶ xtrabackup --backup --encrypt=AES256 --encrypt-key=mykey âš ï¸ 10.3 prepare å¿…é¡»æˆåŠŸï¼Œå¦åˆ™æ— æ³•æ¢å¤ prepare ä¼šå›æ”¾ redo prepare å¤±è´¥ = å¤‡ä»½æ— æ•ˆï¼ˆéå¸¸å…³é”®ï¼‰ ğŸ§± 11. ä¼ä¸šçº§æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ 11.1 æ¯å¤©è‡³å°‘ä¸€æ¬¡å®Œå…¨å¤‡ 11.2 å¢é‡å¤‡ä»½æœ€é•¿ä¸è¦è¶…è¿‡ 7 å¤© é“¾å¤ªé•¿ prepare æ—¶é—´å·¨å¤§\n11.3 ç”¨è„šæœ¬è‡ªåŠ¨åŒ–ï¼ˆå¯æä¾›è„šæœ¬æ¨¡æ¿ï¼‰ è‡ªåŠ¨å¤‡ä»½ è‡ªåŠ¨ prepare è‡ªåŠ¨æ¨é€åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆOSS/OBS/S3ï¼‰ è‡ªåŠ¨æ ¡éªŒ 11.4 æ¯å‘¨åšæ¢å¤æ¼”ç»ƒï¼ˆéå¸¸é‡è¦ï¼‰ å¤‡ä»½ä¸æ¼”ç»ƒ = ç­‰äºæ²¡æœ‰å¤‡ä»½\n11.5 é…åˆ binlog å®ç° point-in-time recoveryï¼ˆPITRï¼‰ å®Œæ•´æ¢å¤ç­–ç•¥ï¼š\nå…¨å¤‡ -\u0026gt; å¢é‡ -\u0026gt; binlog replayï¼ˆpoint-in-timeï¼‰\nğŸ§± 12. æœ€ç»ˆæ€»ç»“ï¼ˆæé€Ÿå¤ç›˜ï¼‰ XtraBackup æ˜¯ MySQL çš„çƒ­å¤‡ç¥å™¨ æ”¯æŒå®Œæ•´ã€å¢é‡ã€æµå¼å¤‡ä»½ prepare æ‰èƒ½è®©å¤‡ä»½å¯æ¢å¤ æ¢å¤æå¿« MySQL 8 éœ€ä½¿ç”¨ Percona XtraBackup 8 å¤§å‹æ•°æ®åº“å¼ºçƒˆæ¨è XtraBackup + binlog çš„æ–¹æ¡ˆ ä¼ä¸šå¿…é¡»æ­é…è‡ªåŠ¨åŒ–è„šæœ¬ä¸å®šæœŸæ¢å¤æ¼”ç»ƒ Percona XtraBackup (PXB) æ˜¯ç”¨äº MySQL çš„å¼€æºç‰©ç†çƒ­å¤‡å·¥å…·ï¼Œæ”¯æŒå…¨é‡ä¸å¢é‡å¤‡ä»½ã€‚\nå…¨é‡å¤‡ä»½æµç¨‹åŒ…æ‹¬ï¼šå¤‡ä»½æ•°æ®æ–‡ä»¶ (\u0026ndash;backup)ã€å‡†å¤‡æ•°æ® (\u0026ndash;prepare) ä»¥ç¡®ä¿ä¸€è‡´æ€§ã€æ¢å¤æ•°æ® (\u0026ndash;copy-back)ï¼Œæœ€åè°ƒæ•´æƒé™å¹¶é‡å¯æœåŠ¡ã€‚\nä¸€ã€ XtraBackup å…¨é‡å¤‡ä»½ (Backup) å…¨é‡å¤‡ä»½å°†æ•°æ®åº“æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°æŒ‡å®šç›®å½•ã€‚\næ‰§è¡Œå¤‡ä»½å‘½ä»¤ï¼š\nxtrabackup --defaults-file=/etc/my.cnf --backup --target-dir=/data/backups/full_base --user=root --password=your_password --backup: æ‰§è¡Œå¤‡ä»½æ¨¡å¼ã€‚ --target-dir: å¤‡ä»½æ–‡ä»¶å­˜å‚¨ç›®å½•ã€‚ éªŒè¯å¤‡ä»½ï¼šæŸ¥çœ‹å¤‡ä»½ç›®å½•ä¸‹çš„ xtrabackup_checkpoints æ–‡ä»¶ï¼Œç¡®ä¿æœ€åä¸€è¡Œæ˜¾ç¤º backup_type = full-backupedã€‚\näºŒã€ å‡†å¤‡å¤‡ä»½æ•°æ® (Prepare) å¤‡ä»½å®Œæˆåï¼Œæ•°æ®æ–‡ä»¶ä¸ä¸€è‡´ï¼Œéœ€è¦åº”ç”¨ Redo Log ä½¿æ•°æ®è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€ï¼Œæ­¤æ­¥éª¤å¿…é¡»åœ¨æ¢å¤å‰æ‰§è¡Œã€‚\nxtrabackup --prepare --target-dir=/data/backups/full_base --prepare: å¯¹å¤‡ä»½æ•°æ®è¿›è¡Œå‡†å¤‡ã€‚æ­¤æ“ä½œä¼šåº”ç”¨ redo æ—¥å¿—å¹¶å›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚ ä¸‰ã€ æ¢å¤å…¨é‡å¤‡ä»½ (Restore) å°†å‡†å¤‡å¥½çš„ä¸€è‡´æ€§æ•°æ®æ–‡ä»¶å¤åˆ¶å› MySQL æ•°æ®ç›®å½•ã€‚\nåœæ­¢ MySQL æœåŠ¡\nsystemctl stop mysqld æ¸…ç©ºæ•°æ®ç›®å½•\nç¡®ä¿æ•°æ®ç›®å½• datadir ä¸ºç©ºï¼ˆé€šå¸¸æ˜¯ /var/lib/mysqlï¼‰ã€‚\nrm -rf /var/lib/mysql/* æ¢å¤æ•°æ®\nxtrabackup --copy-back --target-dir=/data/backups/full_base --copy-back: å°†å¤‡ä»½æ–‡ä»¶ä»å¤‡ä»½ç›®å½•å¤åˆ¶å› MySQL çš„æ•°æ®ç›®å½•ã€‚ ä¿®æ”¹æƒé™ä¸é‡å¯\nchown -R mysql:mysql /var/lib/mysql systemctl start mysqld å…³é”®ç‚¹æ€»ç»“ ä¸€è‡´æ€§ï¼š--prepare é˜¶æ®µæ˜¯å¿…é¡»çš„ï¼Œå®ƒå°†å¤‡ä»½æ—¶é—´ç‚¹çš„ä¸ä¸€è‡´æ•°æ®æ–‡ä»¶æ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚ ç›®å½•è¦æ±‚ï¼š--copy-back è¦æ±‚ç›®æ ‡æ•°æ®åº“ç›®å½•ï¼ˆdatadirï¼‰ä¸ºç©ºã€‚ æƒé™ï¼šæ¢å¤æ•°æ®åï¼Œå¿…é¡»å°†ç›®å½•æ‰€æœ‰è€…ä¿®æ”¹ä¸º mysql ç”¨æˆ·ã€‚ å·¥å…·ç‰ˆæœ¬ï¼šXtraBackup 8.0 ç”¨äº MySQL 8.0ï¼Œæ—©æœŸç‰ˆæœ¬ï¼ˆå¦‚ 2.4ï¼‰ç”¨äº MySQL 5.7ã€‚\nç¤ºä¾‹ï¼š\nmkdir -p /data/mysql/8.0/backup/full # rm -rf /data/mysql/8.0/backup/full/20260101 # å…¨é‡å¤‡ä»½ # ä¸è¦æ·»åŠ  --compress å‚æ•° # å¦åˆ™æ¢å¤æ—¶ä¼šå‡ºç°é”™è¯¯: # 2026-01-01T21:26:36.470732+08:00 0 [ERROR] [MY-011825] [Xtrabackup] cannot open ./xtrabackup_info # 2026-01-01T21:26:36.470745+08:00 0 [ERROR] [MY-011825] [Xtrabackup] Failed to parse xtrabackup_info from \u0026#39;./xtrabackup_info\u0026#39; xtrabackup --backup --user=root --password=\u0026#39;KdX3V7nC!9#Q\u0026#39; --target-dir=/data/mysql/8.0/backup/full/20260101 xtrabackup --prepare --target-dir=/data/mysql/8.0/backup/full/20260101 systemctl stop mysqld mv /data/mysql/8.0/data /data/mysql/8.0/data_bak # rm -rf /data/mysql/8.0/data mkdir -p /data/mysql/8.0/data rsync -avP /data/mysql/8.0/backup/full/20260101/ /data/mysql/8.0/data/ xtrabackup --copy-back --target-dir=/data/mysql/8.0/backup/full/20260101 chown -R mysql:mysql /data/mysql/8.0/data systemctl start mysqld # å¢é‡å¤‡ä»½ mkdir -p /data/mysql/8.0/backup/incremental xtrabackup --backup --user=root --password=\u0026#39;KdX3V7nC!9#Q\u0026#39; \\ --incremental-basedir=/data/mysql/8.0/backup/full/20260101 \\ --target-dir=/data/mysql/8.0/backup/incremental/20260101_001 ","description":"è¦†ç›–ï¼šæ ¸å¿ƒåŸç†ã€å¤‡ä»½ç±»å‹ã€ä½¿ç”¨æ–¹æ³•ã€æ¢å¤æµç¨‹ã€æ€§èƒ½ä¼˜åŒ–ã€ä¸ mysqldump/mydumper å¯¹æ¯”ã€ç”Ÿäº§æœ€ä½³å®è·µã€‚\nğŸ§± 1. XtraBackup æ˜¯ä»€ä¹ˆï¼Ÿ XtraBackupï¼ˆPercona XtraBackupï¼‰ æ˜¯ MySQL / MariaDB æœ€ä¸“ä¸šçš„ ç‰©ç†çƒ­å¤‡å·¥å…·ï¼Œæ”¯æŒ InnoDB çš„ æ— é”å¤‡ä»½ï¼ˆhot backupï¼‰ï¼Œä¼ä¸šç”Ÿäº§æœ€å¸¸ç”¨ã€‚\nç‰¹ç‚¹ï¼š\nç‰©ç†å¤‡ä»½ï¼ˆæ‹·è´æ•°æ®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å¯¼å‡º SQLï¼‰ ä¸é˜»å¡è¯»å†™ï¼ˆhot backupï¼‰ æ”¯æŒ å…¨å¤‡ã€å¢é‡å¤‡ä»½ã€å·®å¼‚å¤‡ä»½ å¤‡ä»½é€Ÿåº¦æå¿«ï¼ˆæ–‡ä»¶çº§åˆ«ï¼‰ æ”¯æŒ redo + undo æ¢å¤ä¸€è‡´æ€§ å¯ç”¨äº MySQLã€Percona Serverã€MariaDB ğŸ”¥ XtraBackup å¯è®¤ä¸ºæ˜¯ MySQL ç‰©ç†å¤‡ä»½çš„å·¥ä¸šæ ‡å‡†ã€‚\nğŸ§± 2. é€‚ç”¨åœºæ™¯ï¼ˆä¼ä¸šå¸¸ç”¨ï¼‰ åœ¨çº¿å¤‡ä»½ï¼Œä¸ä¸­æ–­ä¸šåŠ¡ æ•°æ®åº“è¶…è¿‡ 50GBã€100GBã€ç”šè‡³æ•° TB MHA / MGR / PXC é›†ç¾¤èŠ‚ç‚¹å¤åˆ¶ åšä»åº“ã€å»¶è¿Ÿåº“ è‡ªåŠ¨å¤‡ä»½è„šæœ¬ ç¾éš¾æ¢å¤ï¼ˆDRï¼‰ å¦‚æœä½ æ˜¯è¿ç»´ / DBAï¼Œåœ¨ä¼ä¸šé‡ŒåŸºæœ¬ç¦»ä¸å¼€å®ƒã€‚\n"},{"id":452,"href":"/backend/python/official/yield/","title":"Yield å‡½æ•°","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€æœ€å®¹æ˜“ç†è§£çš„ yield è®²è§£ï¼Œå¸¦è¶…å¤šç¤ºä¾‹ï¼Œä¸€çœ‹å°±ä¼šã€‚\nâœ… yield æ˜¯ä»€ä¹ˆï¼Ÿ yield æ˜¯ Python ç”¨æ¥åˆ›å»º ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰å‡½æ•° çš„å…³é”®å­—ã€‚\nå¸¦æœ‰ yield çš„å‡½æ•°ä¸ä¼šä¸€æ¬¡æ€§è¿è¡Œå®Œæ¯•ï¼Œè€Œæ˜¯ä¸€æ¬¡è¿”å›ä¸€ä¸ªå€¼ï¼Œæ¯æ¬¡æš‚åœåœ¨ yield è¿™é‡Œï¼Œä¸‹æ¬¡ç»§ç»­è¿è¡Œã€‚\næ˜¯ â€œå¯ä»¥æš‚åœçš„ returnâ€ã€‚\nğŸ”¥ ä¸€å¥è¯è®°ä½ yield yield = return ä¸€ä¸ªå€¼ + æš‚åœå‡½æ•°æ‰§è¡Œï¼Œä¸‹æ¬¡ç»§ç»­ä»æš‚åœå¤„è¿è¡Œã€‚\nä¸€ã€æœ€ç®€å•çš„ä¾‹å­ def gen(): yield 1 yield 2 yield 3 g = gen() print(next(g)) # 1 print(next(g)) # 2 print(next(g)) # 3 è§£é‡Šï¼š\ngen() ä¸ä¼šç«‹å³æ‰§è¡Œ ç¬¬ä¸€æ¬¡ next(g) -\u0026gt; æ‰§è¡Œåˆ° yield 1 -\u0026gt; è¿”å› 1 -\u0026gt; æš‚åœ ç¬¬äºŒæ¬¡ next(g) -\u0026gt; ä»æš‚åœå¤„ç»§ç»­æ‰§è¡Œ -\u0026gt; è¿”å› 2 -\u0026gt; å†æš‚åœ ç¬¬ä¸‰æ¬¡ next(g) -\u0026gt; è¿”å› 3 å† next -\u0026gt; StopIteration äºŒã€ä¸ºä»€ä¹ˆä¸ç”¨æ™®é€š returnï¼Ÿ æ™®é€šå‡½æ•°ï¼š\nreturn ç›´æ¥ç»“æŸæ•´ä¸ªå‡½æ•° æƒ³è¿”å›å¤šä¸ªå€¼åªèƒ½ç”¨åˆ—è¡¨ã€å…ƒç»„ç­‰ä¸€æ¬¡æ€§å…¨éƒ¨è¿”å› ç”Ÿæˆå™¨ï¼š\nå¯ä»¥é€ä¸ªç”Ÿæˆ èŠ‚çœå†…å­˜ å¯å¤„ç†æ— é™å¤§ã€æµå¼æ•°æ® ä¸‰ã€çœŸå®ä¾‹å­ï¼šè¯»å–å¤§æ–‡ä»¶ï¼ˆèŠ‚çœå†…å­˜ï¼‰ def read_lines(filename): with open(filename) as f: for line in f: yield line.rstrip() for line in read_lines(\u0026#34;huge.log\u0026#34;): print(line) ä¸ç”¨ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶ï¼Œéå¸¸èŠ‚çœå†…å­˜ã€‚\nå››ã€æ— é™åºåˆ—ï¼ˆæ™®é€šå‡½æ•°åšä¸åˆ°ï¼‰ def count(): n = 1 while True: yield n n += 1 c = count() print(next(c)) # 1 print(next(c)) # 2 print(next(c)) # 3 å¯ç”Ÿæˆæ— é™åºåˆ—ï¼\näº”ã€yield fromï¼ˆå§”æ‰˜ç”Ÿæˆå™¨ï¼‰ è®©ç”Ÿæˆå™¨â€œåµŒå¥—â€æ›´ä¼˜é›…ï¼š\ndef gen1(): yield from [1, 2, 3] yield from [4, 5] print(list(gen1())) è¾“å‡ºï¼š\n[1, 2, 3, 4, 5] å…­ã€yield + sendï¼ˆåŒå‘é€šä¿¡ï¼‰ ç”Ÿæˆå™¨ä¸ä»…èƒ½è¿”å›å€¼ï¼Œè¿˜èƒ½æ¥æ”¶å€¼ï¼š\ndef echo(): while True: x = yield print(\u0026#34;Got:\u0026#34;, x) g = echo() next(g) # å¯åŠ¨ç”Ÿæˆå™¨ g.send(\u0026#34;hello\u0026#34;) # Got: hello g.send(\u0026#34;world\u0026#34;) # Got: world ä¸ƒã€yield çš„å…¸å‹ä½¿ç”¨åœºæ™¯ åœºæ™¯ ä¸ºä»€ä¹ˆç”¨ yield è¯»å–å¤§æ–‡ä»¶/æµå¼æ•°æ® ä¸å å¤ªå¤šå†…å­˜ æ— é™åºåˆ— ä¸éœ€è¦ä¸€æ¬¡æ€§è¿”å› ç®¡é“å¼æ•°æ®å¤„ç†ï¼ˆç±»ä¼¼ Linux pipeï¼‰ ä¼˜é›…ã€å¯ç»„åˆ ç”Ÿæˆå™¨è¡¨è¾¾å¼ æ›´èŠ‚çœå†…å­˜ å¼‚æ­¥ç¼–ç¨‹ï¼ˆå†å²ä¸Š asyncioï¼‰ yield from/await çš„å‰èº« å…«ã€yield çš„æœ¬è´¨ï¼ˆé«˜çº§ä½†æ¸…æ™°ï¼‰ yield ä¼šè®©å‡½æ•°å˜æˆä¸€ä¸ª çŠ¶æ€æœºï¼š\næ‰§è¡Œåˆ° yield æ—¶ -\u0026gt; è¿”å›å€¼ç»™è°ƒç”¨è€… -\u0026gt; æš‚åœå‡½æ•° ä¸‹æ¬¡è°ƒç”¨ next() -\u0026gt; æ¢å¤æ‰§è¡Œ -\u0026gt; ä» yield åç»§ç»­è¿è¡Œ ä½ å¯ä»¥ç†è§£æˆ â€œè¿”å›å€¼ + æš‚åœâ€ã€‚\nä¹ã€for å¾ªç¯ä¸ºä»€ä¹ˆèƒ½ç”¨åœ¨ç”Ÿæˆå™¨ä¸Šï¼Ÿ å› ä¸ºç”Ÿæˆå™¨å®ç°äº†è¿­ä»£åè®®ï¼š\n__iter__ __next__ for è‡ªåŠ¨è°ƒç”¨ next()ã€‚\nğŸ”¥ è¶…å®ç”¨æ¨¡æ¿ 1ï¼‰éå†ç”Ÿæˆæ•°æ® def generate_items(): for i in range(10): yield i 2ï¼‰è¿‡æ»¤æ•°æ®ï¼ˆç±»ä¼¼ filterï¼‰ def even_numbers(nums): for n in nums: if n % 2 == 0: yield n 3ï¼‰ç»„åˆç”Ÿæˆå™¨ï¼ˆyield fromï¼‰ def combined(): yield from gen_a() yield from gen_b() ğŸ¯ ç»ˆææ€»ç»“ yield è®©å‡½æ•°å˜æˆç”Ÿæˆå™¨ ç”Ÿæˆå™¨â€œæŒ‰éœ€ç”Ÿæˆâ€å€¼ æ‰§è¡Œåˆ° yield æš‚åœï¼Œä¸‹æ¬¡ç»§ç»­ èŠ‚çœå†…å­˜ã€é€‚åˆå¤§æ•°æ®æµ å¯æ— é™åºåˆ— é€‚åˆç®¡é“å¼ç¼–ç¨‹ Next éå†ç”Ÿæˆæ•°æ®\ndef generate_items(): for i in range(10): yield i ç”Ÿæˆçš„æ•°æ®åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•è·å–ï¼Ÿ\nyield ç”Ÿæˆçš„æ•°æ® ä¸ä¼šè‡ªåŠ¨å­˜èµ·æ¥ï¼Œå®ƒæ˜¯æƒ°æ€§ç”Ÿæˆçš„ï¼Œä½ å¿…é¡»ä¸»åŠ¨â€œå–â€å‡ºæ¥ã€‚\nä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š\nğŸ‘‰ ç”Ÿæˆå™¨ä¸ä¼šä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®ï¼Œè€Œæ˜¯æ¯æ¬¡å–ä¸€ä¸ªã€‚\nâœ… ä½ çš„ä»£ç  def generate_items(): for i in range(10): yield i è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ï¼Œè°ƒç”¨å®ƒåä¸ä¼šæ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª ç”Ÿæˆå™¨å¯¹è±¡ã€‚\nâœ… 1. å¦‚ä½•è·å–æ•°æ®ï¼Ÿï¼ˆ4 ç§å¸¸ç”¨æ–¹å¼ï¼‰ æ–¹å¼ 1ï¼šfor éå†ï¼ˆæœ€å¸¸ç”¨ï¼‰ for x in generate_items(): print(x) è¾“å‡ºï¼š\n0 1 2 ... 9 æ–¹å¼ 2ï¼šè½¬æ¢æˆ listï¼ˆä¸€æ¬¡æ€§å–å®Œï¼‰ items = list(generate_items()) print(items) è¾“å‡ºï¼š\n[0, 1, 2, 3, 4, 5, 6, 7, 8, 9] æ–¹å¼ 3ï¼šä½¿ç”¨ next() å•æ­¥è·å– gen = generate_items() print(next(gen)) # 0 print(next(gen)) # 1 print(next(gen)) # 2 ç›´åˆ°è€—å°½ä¼šæŠ› StopIterationã€‚\næ–¹å¼ 4ï¼šè§£åŒ…ï¼ˆä¸å¸¸ç”¨ä½†ä¼˜é›…ï¼‰ a, b, c, *rest = generate_items() print(a, b, c, rest) è¾“å‡ºï¼š\n0 1 2 [3,4,5,6,7,8,9] âœ… 2. ç”Ÿæˆå™¨æ˜¯ä»€ä¹ˆï¼Ÿ è°ƒç”¨ generate_items() ä¸ä¼šæ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼š\ngen = generate_items() print(gen) è¾“å‡ºï¼š\n\u0026lt;generator object generate_items at 0x...\u0026gt; ä½ å¿…é¡»ç”¨ï¼š\nfor next() list() è§£åŒ… æ¥â€œæ¶ˆè´¹â€å®ƒã€‚\nâš ï¸ æ³¨æ„ï¼šç”Ÿæˆå™¨ä¸€æ¬¡ç”¨å®Œå°±æ²¡äº† gen = generate_items() list(gen) list(gen) # ç¬¬äºŒæ¬¡æ˜¯ç©ºçš„ å› ä¸ºç¬¬ä¸€æ¬¡å·²ç»å…¨éƒ¨å–å®Œã€‚\nâ­ æœ€ä½³å®è·µï¼ˆä½ çš„åœºæ™¯ï¼‰ å¦‚æœä½ åªæ˜¯è¦éå†ï¼š\nfor item in generate_items(): print(item) å¦‚æœä½ è¦æ”¶é›†æˆåˆ—è¡¨ï¼š\nitems = list(generate_items()) start += 1 ä¸ºä»€ä¹ˆè¦æ”¾åœ¨ yield start ä¹‹åï¼Ÿ ä»£ç \ndef lazy_numbers(start, end): while start \u0026lt; end: yield start start += 1 æŠŠ start += 1 æ”¾åœ¨ yield start ä¹‹åï¼Œæ˜¯ä¸ºäº†ä¿è¯ç”Ÿæˆçš„åºåˆ—é¡ºåºæ­£ç¡®ã€å€¼ä¸ä¼šè·³è¿‡ã€‚\nä¸‹é¢ç»™ä½ è¯¦ç»†è§£é‡Šï¼š\nâœ… ç»“è®º yield start ä¼š å…ˆè¿”å›å½“å‰å€¼ï¼Œç„¶å start += 1 å†è®©ä¸‹æ¬¡è¿­ä»£è¿”å›ä¸‹ä¸€ä¸ªå€¼ã€‚\nå¦‚æœä½ æŠŠ start += 1 æ”¾å‰é¢ï¼Œä¼šå¯¼è‡´å°‘ä¸€ä¸ªå€¼ / ç¬¬ä¸€ä¸ªå€¼ä¸¢å¤±ã€‚\nâœ… ä¸ºä»€ä¹ˆè¦å†™åœ¨åé¢ï¼Ÿï¼ˆé€è¡Œæµç¨‹ï¼‰ ä»¥ä½ çš„ä»£ç ä¸ºä¾‹ï¼š\ndef lazy_numbers(start, end): while start \u0026lt; end: yield start # â‘  æŠŠå½“å‰ start è¿”å›ç»™è°ƒç”¨è€… start += 1 # â‘¡ æ›´æ–° startï¼Œä¸‹ä¸€è½®ä¼šè¿”å›æ–°å€¼ å¦‚æœ start=0 end=3ï¼š\nå¾ªç¯ yield è¿”å›å€¼ æ›´æ–°å start ç¬¬1æ¬¡ 0 1 ç¬¬2æ¬¡ 1 2 ç¬¬3æ¬¡ 2 3 -\u0026gt; while ç»“æŸ ç”Ÿæˆï¼š0, 1, 2\nè¡Œä¸ºå®Œå…¨ç¬¦åˆ range(start, end)ã€‚\nâŒ å¦‚æœ start += 1 æ”¾åœ¨ yield å‰é¢ï¼Ÿ æ”¹æˆè¿™æ ·ï¼š\ndef lazy_numbers(start, end): while start \u0026lt; end: start += 1 yield start å†çœ‹æµç¨‹ï¼š\nstart=0, end=3\nå¾ªç¯ start+=1 å yield è¿”å›å€¼ ç¬¬1æ¬¡ 1 1 ç¬¬2æ¬¡ 2 2 ç¬¬3æ¬¡ 3 while ç»ˆæ­¢ï¼ˆä¸ yieldï¼‰ ç»“æœï¼š1, 2\nğŸ‘‰ 0 è¢«è·³è¿‡äº† ğŸ‘‰ 3 æ²¡æœ‰è¢« yield è¿™æ˜¾ç„¶ä¸ç¬¦åˆé¢„æœŸã€‚\nğŸ“Œ å’Œ for i in range(start, end) ä¸€æ ·çš„é€»è¾‘ çœŸæ­£æ¨¡æ‹Ÿ range çš„å†™æ³•å¿…é¡»æ˜¯ï¼š\nç¬¬ä¸€æ¬¡äº§å‡º start æœ¬èº« ç„¶åå†å¢åŠ  start å¦åˆ™è¡Œä¸ºæ— æ³•ä¸ range å¯¹é½ã€‚\nğŸ¯ æœ€é€šä¿—çš„è§£é‡Š yield ç±»ä¼¼ï¼š\nâ€œæŠŠè¿™ä¸ªå€¼ç»™ä½ ï¼Œç­‰ä½ ä¸‹ä¸€æ¬¡æ¥æ‹¿çš„æ—¶å€™ï¼Œæˆ‘å†æ›´æ–°çŠ¶æ€ã€‚â€\næ‰€ä»¥å¿…é¡»ï¼š\nå…ˆç»™å½“å‰å€¼ (yield start) å†å‡†å¤‡ä¸‹ä¸€æ¬¡çš„å€¼ (start += 1) å¦‚æœé¡ºåºåäº†ï¼š\nâ€œæˆ‘å…ˆæ›´æ–°å†ç»™ä½ â€ï¼Œé‚£ç¬¬ä¸€æ¬¡å°±é”™äº†ã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€å®ç”¨ã€æœ€å®¹æ˜“ç†è§£çš„ yield è®²è§£ï¼Œå¸¦è¶…å¤šç¤ºä¾‹ï¼Œä¸€çœ‹å°±ä¼šã€‚\nâœ… yield æ˜¯ä»€ä¹ˆï¼Ÿ yield æ˜¯ Python ç”¨æ¥åˆ›å»º ç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰å‡½æ•° çš„å…³é”®å­—ã€‚\nå¸¦æœ‰ yield çš„å‡½æ•°ä¸ä¼šä¸€æ¬¡æ€§è¿è¡Œå®Œæ¯•ï¼Œè€Œæ˜¯ä¸€æ¬¡è¿”å›ä¸€ä¸ªå€¼ï¼Œæ¯æ¬¡æš‚åœåœ¨ yield è¿™é‡Œï¼Œä¸‹æ¬¡ç»§ç»­è¿è¡Œã€‚\næ˜¯ â€œå¯ä»¥æš‚åœçš„ returnâ€ã€‚\nğŸ”¥ ä¸€å¥è¯è®°ä½ yield yield = return ä¸€ä¸ªå€¼ + æš‚åœå‡½æ•°æ‰§è¡Œï¼Œä¸‹æ¬¡ç»§ç»­ä»æš‚åœå¤„è¿è¡Œã€‚\nä¸€ã€æœ€ç®€å•çš„ä¾‹å­ def gen(): yield 1 yield 2 yield 3 g = gen() print(next(g)) # 1 print(next(g)) # 2 print(next(g)) # 3 è§£é‡Šï¼š\n"},{"id":453,"href":"/operations/zabbix/","title":"Zabbix","parent":"Operations","content":"Document List:\nZabbix FAQ Zabbix vs Prometheus \u0026#43; Grafana Zabbix åŸºç¡€æ•™ç¨‹ Zabbix æ ¸å¿ƒæ¦‚å¿µ Zabbix æœ€ä½³å®è·µ ","description":"Document List:\nZabbix FAQ Zabbix vs Prometheus \u0026#43; Grafana Zabbix åŸºç¡€æ•™ç¨‹ Zabbix æ ¸å¿ƒæ¦‚å¿µ Zabbix æœ€ä½³å®è·µ "},{"id":454,"href":"/operations/zabbix/best-practices/","title":"Zabbix æœ€ä½³å®è·µ","parent":"Zabbix","content":"å†…å®¹è¦†ç›–ï¼šæ¶æ„ã€å®‰è£…ã€æ€§èƒ½ã€ç›‘æ§è§„èŒƒã€å‘Šè­¦ã€æ•°æ®å­˜å‚¨ã€Proxyã€Agentã€æ¨¡æ¿ã€è§¦å‘å™¨ã€ç»´æŠ¤ç­‰æ‰€æœ‰æ ¸å¿ƒæœ€ä½³å®è·µã€‚\n1. æ¶æ„è§„åˆ’æœ€ä½³å®è·µ 1.1 ä½¿ç”¨ Proxyï¼ˆå¼ºçƒˆæ¨èï¼‰ é€‚ç”¨ï¼š\nå¤šæœºæˆ¿ è®¾å¤‡æ•°é‡ â‰¥ 300 ç½‘ç»œå¤æ‚ã€è·¨åœ°åŸŸ éœ€è¦é™ä½ Zabbix Server å‹åŠ› Proxy Benefitsï¼š\nå‡å°‘æ•°æ®åº“å‹åŠ› å‡è½» Server é‡‡é›†å‹åŠ› æ–­ç½‘è‡ªåŠ¨ç¼“å­˜æ•°æ® åˆ†å¸ƒå¼æ¶æ„æ›´å¥å£® 2. æ•°æ®åº“æœ€ä½³å®è·µï¼ˆæœ€å…³é”®éƒ¨åˆ†ï¼‰ Zabbix = é‡æ•°æ®åº“åº”ç”¨ï¼Œ90% çš„æ€§èƒ½é—®é¢˜éƒ½æºäº DBã€‚\n2.1 ä½¿ç”¨ PostgreSQLï¼ˆä¼˜äº MySQLï¼‰ åŸå› ï¼š\nå†™å…¥æ€§èƒ½æ›´å¼º åŸç”Ÿæ”¯æŒåˆ†åŒº TimescaleDB æ’ä»¶æä½³ 2.2 ä½¿ç”¨ SSDï¼ˆæ•°æ®åº“å¿…é¡»åœ¨ SSDï¼‰ æå‡ï¼š\nå†™å…¥ TPS å†å²æ•°æ®æŸ¥è¯¢ Housekeeper é€Ÿåº¦ 2.3 å¼€å¯ TimescaleDBï¼ˆæ¨èï¼‰ å†å²è¡¨è‡ªåŠ¨åˆ†åŒº + å‹ç¼©ï¼Œæå‡ 10 å€æ€§èƒ½ã€‚\n2.4 æœ€ä½³ PostgreSQL å‚æ•° shared_buffers = 25% å†…å­˜ work_mem = 32MB maintenance_work_mem = 256MB wal_buffers = 16MB max_connections = 500 effective_cache_size = 50% å†…å­˜ 2.5 Housekeeping å»ºè®®å…³é—­è‡ªåŠ¨ HousekeepingFrequency=0 ä½¿ç”¨ TimescaleDB æˆ– cron æ¸…ç†æ›´é«˜æ•ˆã€‚\n3. Zabbix Server æœ€ä½³å®è·µ 3.1 StartPollers è°ƒä¼˜ æ ¸å¿ƒå¹¶å‘é…ç½®ï¼š\nStartPollers=50 StartIPMIPollers=10 StartPollersUnreachable=10 StartPingers=10 StartDiscoverers=10 StartHTTPPollers=20 3.2 æœ¬åœ°å®‰è£… Server+Frontend å‡å°‘ç½‘ç»œå»¶è¿Ÿã€‚\n3.3 é«˜å¯ç”¨å»ºè®® ä½¿ç”¨ Pacemaker/Keepalived åš Server HA PostgreSQL åšä¸»ä»å¤åˆ¶ï¼ˆæµå¤åˆ¶ï¼‰ 4. Zabbix Proxy æœ€ä½³å®è·µ 4.1 æ¯ä¸ªåŒºåŸŸéƒ¨ç½² Proxy æå‡ç¨³å®šæ€§ã€‚\n4.2 Proxy ä½¿ç”¨ SQLiteï¼ˆæœ€å¤š 5000 ä¸»æœºï¼‰ æ›´è½»é‡ï¼›\u0026gt;5000 ä¸»æœºå»ºè®® PostgreSQL Proxyã€‚\n4.3 Proxy ç¼“å­˜ç£ç›˜ä½¿ç”¨ SSD é¿å…æ–­ç½‘æ—¶å†™å…¥å µå¡ã€‚\n5. Zabbix Agent / Agent2 æœ€ä½³å®è·µ 5.1 ä½¿ç”¨ Zabbix Agent2ï¼ˆå¼ºçƒˆæ¨èï¼‰ ä¼˜ç‚¹ï¼š\næ€§èƒ½æ›´å¥½ æ’ä»¶æ›´ä¸°å¯Œï¼ˆMySQLã€Redisã€Nginxï¼‰ åŸç”Ÿæ”¯æŒ Go æ’ä»¶æ‰©å±• 5.2 ä½¿ç”¨ä¸»åŠ¨æ¨¡å¼ + TLS ä¸»åŠ¨æ¨¡å¼ï¼š\næ— éœ€é˜²ç«å¢™å¼€ inbound ç«¯å£ æ›´é€‚åˆå®¹å™¨ã€å¤šäº‘ç¯å¢ƒ å¯ç”¨åŠ å¯†ï¼š\nTLSConnect=psk TLSAccept=psk 5.3 è‡ªå®šä¹‰ç›‘æ§å»ºè®®ä½¿ç”¨ UserParameter æœ€ä½³å®è·µï¼š\nJSON è¾“å‡º ä¸€æ¬¡è„šæœ¬è¿”å›å¤šæŒ‡æ ‡ï¼ˆå‡å°‘è°ƒç”¨å¼€é”€ï¼‰ 6. æ¨¡æ¿æœ€ä½³å®è·µï¼ˆéå¸¸å…³é”®ï¼‰ 6.1 å¼ºçƒˆå»ºè®®ä½¿ç”¨å®˜æ–¹æ¨¡æ¿ï¼Œè€Œä¸æ˜¯è‡ªå»º å®˜æ–¹æ¨¡æ¿ç‰¹ç‚¹ï¼š\nè‡ªåŠ¨å‘ç°ï¼ˆLLDï¼‰ å·²å«ä¸Šç™¾ä¸ªç›‘æ§é¡¹ å·²ä¼˜åŒ–å‘Šè­¦é˜ˆå€¼ CPU/å†…å­˜/IO éƒ½æœ‰å›¾è¡¨ å®˜æ–¹æ¨¡æ¿ï¼š\nTemplate OS Linux Template OS Windows Template DB MySQL Template DB PostgreSQL Template App Nginx Template App Redis 6.2 è‡ªå»ºæ¨¡æ¿è§„èŒƒ å‘½åè§„èŒƒï¼š\nTemplate App XXX {CompanyName} Template VM KVM {CompanyName} æ¨¡æ¿å†…å¿…é¡»åŒ…å«ï¼š\nç›‘æ§é¡¹ï¼ˆItemï¼‰ è§¦å‘å™¨ï¼ˆTriggerï¼‰ LLDï¼ˆè‡ªåŠ¨å‘ç°ï¼‰ Item Prototypeï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰ Graphï¼ˆå›¾è¡¨ï¼‰ 7. Item æœ€ä½³å®è·µ 7.1 ç›‘æ§å‘¨æœŸä¸è¦å¤ªçŸ­ æ¨èï¼š\n30 ç§’ï¼šæ ¸å¿ƒæœåŠ¡ 60 ç§’ï¼šä¸€èˆ¬ç³»ç»Ÿ 300 ç§’ï¼šç½‘ç»œè®¾å¤‡ SNMP 7.2 é¿å…å¤–éƒ¨è„šæœ¬ï¼ˆå¤ªæ…¢ï¼‰ å°½é‡ä½¿ç”¨ï¼š\nZabbix agent å†…ç½® key agent2 æ’ä»¶ SNMP / HTTP Agent 7.3 ä½¿ç”¨ Preprocessing å‡å°‘è§¦å‘å™¨è¯¯æŠ¥ï¼š\nJSONPath æ­£åˆ™è¿‡æ»¤ æ•°å€¼è¿‡æ»¤ï¼ˆdiscard belowï¼‰ 8. Trigger æœ€ä½³å®è·µ 8.1 è®¾ç½®è¿Ÿæ»ï¼ˆhysteresisï¼‰ é¿å…é¢‘ç¹ä¸Šä¸‹æ³¢åŠ¨å‘Šè­¦ã€‚\nç¤ºä¾‹ï¼š\n{host:vfs.fs.size[/,pfree].last()}\u0026lt;20 {host:vfs.fs.size[/,pfree].last()}\u0026lt;25 8.2 ä½¿ç”¨è¶‹åŠ¿å€¼å‡å°‘æ³¢åŠ¨ avg(5m) min(10m) 8.3 ç¦æ­¢ä½¿ç”¨è¿‡äºæ•æ„Ÿçš„é˜ˆå€¼ å†…å­˜ä½åˆ° 10% ä¸ä»£è¡¨ä¸å¥½ï¼Œå¤§é‡ç¼“å­˜æ˜¯æ­£å¸¸çš„ã€‚\næ¨èé˜ˆå€¼ï¼š\nCPU load \u0026gt; (æ ¸å¿ƒæ•° * 1.5) å†…å­˜å¯ç”¨ \u0026lt;20% ç£ç›˜ä½¿ç”¨ç‡ \u0026gt;85% inode ä½¿ç”¨ \u0026gt;90% TCP CLOSE_WAIT \u0026gt; 100 9. å‘Šè­¦æœ€ä½³å®è·µï¼ˆéå¸¸å…³é”®ï¼‰ 9.1 ä½¿ç”¨ Webhookï¼ˆæ¨èï¼‰ ä¼˜äºé‚®ä»¶ï¼š\nä¼ä¸šå¾®ä¿¡ WebHook é’‰é’‰æœºå™¨äºº é£ä¹¦æœºå™¨äºº Telegram 9.2 å‘Šè­¦åˆ†çº§ çº§åˆ«ï¼š\nDisasterï¼šå¿…é¡»ç«‹å³å¤„ç†ï¼ˆæœåŠ¡ä¸å¯ç”¨ï¼‰ Highï¼šä¸¥é‡ï¼ˆç£ç›˜ \u0026gt;95%ï¼‰ Averageï¼šä¸€èˆ¬ Warningï¼šè½»å¾® 9.3 å‘Šè­¦æ”¶æ•›ï¼ˆå‡å°‘å™ªéŸ³ï¼‰ åŒä¸€äº‹ä»¶ä¸è¿ç»­å‘é€ ç¦æ­¢é‡å¤é€šçŸ¥ ä½¿ç”¨ç»´æŠ¤çª—å£ suppress 10. æ•°æ®å­˜å‚¨æœ€ä½³å®è·µ 10.1 æ•°æ®ä¿ç•™å‘¨æœŸ å†å²æ•°æ®ï¼š30 å¤© è¶‹åŠ¿æ•°æ®ï¼š365 å¤© äº‹ä»¶æ•°æ®ï¼š90 å¤© 10.2 å¼€å¯ TimescaleDB å‹ç¼© å‡å°‘ 70% å­˜å‚¨ç©ºé—´ã€‚\n11. å®‰å…¨æœ€ä½³å®è·µ 11.1 HTTPS è®¿é—® Frontend Nginx + Let\u0026rsquo;s Encryptã€‚\n11.2 TLS ä¿æŠ¤ Agent é€šä¿¡ é¿å…ä¸­é—´äººæ”»å‡»ã€‚\n11.3 API Token æœ€å°æƒé™ ä¸è¦ç»™è¶…çº§ç®¡ç†å‘˜ tokenã€‚\n12. å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ ç»„åˆç›‘æ§ï¼š\nZabbix + Prometheusï¼ˆæ—¶åºæ•°æ®ï¼‰ Zabbix + Grafana ï¼ˆå±•ç¤ºï¼‰ Zabbix + ELK ï¼ˆæ—¥å¿—ï¼‰ Zabbix + Jaegerï¼ˆé“¾è·¯è¿½è¸ªï¼‰ 13. ç»´æŠ¤æœ€ä½³å®è·µ 13.1 å®šæœŸæ¸…ç†æ— æ•ˆä¸»æœº è‡ªåŠ¨å‘ç°åˆ é™¤åœç”¨è®¾å¤‡ã€‚\n13.2 å®šæœŸæ£€æŸ¥ LLD æ˜¯å¦è¿‡å¤š è¿‡å¤š LLD -\u0026gt; æ•°æ®åº“å­˜å‚¨æš´æ¶¨ã€‚\n13.3 æ¯å‘¨æŸ¥çœ‹ top 20 ç›‘æ§é¡¹è€—æ—¶ ä¼˜åŒ–æ…¢è„šæœ¬ / SNMP å»¶è¿Ÿã€‚\n13.4 å®šæœŸå¤‡ä»½ PostgreSQL å…¨å¤‡ Zabbix é…ç½®å¤‡ä»½ï¼ˆSQL dump + /etc/zabbixï¼‰ æ€»ç»“ï¼šä¼ä¸šçº§ Zabbix æœ€ä½³å®è·µï¼ˆ15 æ¡å¿…åšï¼‰ ä½¿ç”¨ Proxy æŒ‰åœ°åŸŸ/æœºæˆ¿åˆ†å¸ƒã€‚ æ•°æ®åº“å¿…é¡»ä½¿ç”¨ PostgreSQL + SSDã€‚ ä½¿ç”¨ TimescaleDB åˆ†åŒºä¸å‹ç¼©ã€‚ ä½¿ç”¨ Agent2 + ä¸»åŠ¨æ¨¡å¼ + TLSã€‚ å°½é‡ä½¿ç”¨å®˜æ–¹æ¨¡æ¿è€Œä¸æ˜¯è‡ªå»ºã€‚ ç›‘æ§å‘¨æœŸæœ€çŸ­ 30sï¼Œä¸è¦å¤ªå¯†ã€‚ ä½¿ç”¨è¶‹åŠ¿å€¼ä¸ hysteresis é¿å…éœ‡è¡ã€‚ å‘Šè­¦é‡‡ç”¨ Webhookï¼Œåˆ†çº§ç®¡ç†ã€‚ å†å²æ•°æ®ä»…ä¿ç•™ 30 å¤©ï¼Œè¶‹åŠ¿ä¿ç•™ 1 å¹´ã€‚ ç¦æ­¢ä½¿ç”¨å¤§é‡å¤–éƒ¨è„šæœ¬ç›‘æ§ã€‚ Proxy ä½¿ç”¨ SSD ç¼“å­˜ã€‚ ç¦æ­¢è‡ªåŠ¨ Housekeepingã€‚ ä½¿ç”¨ Grafana åšå¯è§†åŒ–æ›´ç¾è§‚ã€‚ Zabbix Server éœ€è¦è°ƒé«˜ poller çº¿ç¨‹ã€‚ å®šæœŸæ¸…ç†æ— æ•ˆä¸»æœºã€å¤±æ•ˆ LLDã€åƒåœ¾äº‹ä»¶ã€‚ ","description":"å†…å®¹è¦†ç›–ï¼šæ¶æ„ã€å®‰è£…ã€æ€§èƒ½ã€ç›‘æ§è§„èŒƒã€å‘Šè­¦ã€æ•°æ®å­˜å‚¨ã€Proxyã€Agentã€æ¨¡æ¿ã€è§¦å‘å™¨ã€ç»´æŠ¤ç­‰æ‰€æœ‰æ ¸å¿ƒæœ€ä½³å®è·µã€‚\n1. æ¶æ„è§„åˆ’æœ€ä½³å®è·µ 1.1 ä½¿ç”¨ Proxyï¼ˆå¼ºçƒˆæ¨èï¼‰ é€‚ç”¨ï¼š\nå¤šæœºæˆ¿ è®¾å¤‡æ•°é‡ â‰¥ 300 ç½‘ç»œå¤æ‚ã€è·¨åœ°åŸŸ éœ€è¦é™ä½ Zabbix Server å‹åŠ› Proxy Benefitsï¼š\nå‡å°‘æ•°æ®åº“å‹åŠ› å‡è½» Server é‡‡é›†å‹åŠ› æ–­ç½‘è‡ªåŠ¨ç¼“å­˜æ•°æ® åˆ†å¸ƒå¼æ¶æ„æ›´å¥å£® 2. æ•°æ®åº“æœ€ä½³å®è·µï¼ˆæœ€å…³é”®éƒ¨åˆ†ï¼‰ Zabbix = é‡æ•°æ®åº“åº”ç”¨ï¼Œ90% çš„æ€§èƒ½é—®é¢˜éƒ½æºäº DBã€‚\n"},{"id":455,"href":"/backend/python/official/zip/","title":"Zip å‡½æ•°","parent":"Official","content":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€å…¨é¢ã€æœ€æ¸…æ™°çš„ Python zip å‡½æ•°çŸ¥è¯†æ•´ç†ï¼Œæ¶µç›–åŸç†ã€ç”¨æ³•ã€è¿›é˜¶æŠ€å·§ã€é™·é˜±ã€ä¼˜åŒ–æ–¹æ¡ˆä»¥åŠå®æˆ˜ç¤ºä¾‹ã€‚\n1ï¸âƒ£ åŸºæœ¬è¯­æ³• zip(*iterables) ä½œç”¨ï¼šæŠŠå¤šä¸ªå¯è¿­ä»£å¯¹è±¡â€œæ‹‰é“¾å¼â€é…å¯¹ï¼Œè¿”å›ä¸€ä¸ªæƒ°æ€§çš„ zip å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰\nç¤ºä¾‹ï¼š\na = [1, 2, 3] b = [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;] list(zip(a, b)) # [(1, \u0026#39;a\u0026#39;), (2, \u0026#39;b\u0026#39;), (3, \u0026#39;c\u0026#39;)] 2ï¸âƒ£ zip æ˜¯æƒ°æ€§çš„ï¼ˆiteratorï¼‰ zip() æœ¬è´¨ä¸Šæ˜¯ è¿­ä»£å™¨ï¼Œä¸ä¼šä¸€æ¬¡æ€§æŠŠæ•°æ®è£…è½½åˆ°å†…å­˜ä¸­ã€‚\nz = zip(a, b) next(z) # (1, \u0026#39;a\u0026#39;) 3ï¸âƒ£ zip ä¼šä»¥æœ€çŸ­åºåˆ—ä¸ºå‡†ï¼ˆé‡è¦è¡Œä¸ºï¼‰ a = [1, 2, 3] b = [\u0026#39;x\u0026#39;, \u0026#39;y\u0026#39;] list(zip(a, b)) # [(1, \u0026#39;x\u0026#39;), (2, \u0026#39;y\u0026#39;)] åªèµ°åˆ° æœ€çŸ­çš„ iterableã€‚\nå¦‚æœä½ éœ€è¦è¡¥å…¨ï¼Œè¯·ç”¨ itertools.zip_longestã€‚\n4ï¸âƒ£ ä¸ zip_longest å¯¹æ¯” from itertools import zip_longest list(zip_longest([1,2,3], [\u0026#39;a\u0026#39;], fillvalue=None)) è¾“å‡ºï¼š\n[(1, \u0026#39;a\u0026#39;), (2, None), (3, None)] 5ï¸âƒ£ zip å¸¸è§ç”¨æ³•å¤§å…¨ï¼ˆ20ä¸ªç¤ºä¾‹ï¼‰ 5.1 éå†å¤šä¸ªåºåˆ—ï¼ˆæœ€å¸¸ç”¨ï¼‰ for x, y in zip(nums, names): print(x, y) 5.2 æ„é€  dictï¼ˆKey-Value é…å¯¹ï¼‰ keys = [\u0026#39;name\u0026#39;, \u0026#39;age\u0026#39;, \u0026#39;addr\u0026#39;] values = [\u0026#39;Tom\u0026#39;, 20, \u0026#39;HZ\u0026#39;] d = dict(zip(keys, values)) 5.3 è§£å‹ï¼ˆåå‹ç¼©ï¼‰æŠ€å·§ zip(*) pairs = [(1, \u0026#39;a\u0026#39;), (2, \u0026#39;b\u0026#39;), (3, \u0026#39;c\u0026#39;)] nums, letters = zip(*pairs) # nums = (1, 2, 3) # letters = (\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;) 5.4 åŒæ­¥æ’åºå¤šä¸ªåºåˆ—ï¼ˆç»å…¸æŠ€å·§ï¼‰ æŒ‰ç…§æˆç»©æ’åºå­¦ç”Ÿå’Œè¯¾ç¨‹ï¼š\nstudents = [\u0026#34;Alice\u0026#34;, \u0026#34;Bob\u0026#34;, \u0026#34;Cindy\u0026#34;] scores = [90, 70, 85] # ç»„åˆæˆ [(90, Alice), (70, Bob), ...] sorted_students = [s for _, s in sorted(zip(scores, students))] 5.5 è½¬ç½®çŸ©é˜µï¼ˆéå¸¸å¸¸è§ï¼‰ matrix = [ [1, 2, 3], [4, 5, 6], ] list(zip(*matrix)) # [(1,4), (2,5), (3,6)] å³æŠŠè¡Œ -\u0026gt; åˆ—ã€‚\n5.6 åˆå¹¶å¤šä¸ªå¯è¿­ä»£ç»“æœï¼ˆmap, filter, generatorï¼‰ squares = (x*x for x in range(3)) cubes = (x**3 for x in range(3)) list(zip(squares, cubes)) zip éå¸¸é€‚åˆåˆå¹¶ç”Ÿæˆå™¨ã€‚\n5.7 ä½¿ç”¨ zip ä¸ enumerate ç»„åˆ for idx, (x, y) in enumerate(zip(a, b)): print(idx, x, y) 5.8 éå† JSON æ•°ç»„ä¸­çš„å¤šå­—æ®µ users = [ {\u0026#34;name\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;age\u0026#34;: 18}, {\u0026#34;name\u0026#34;: \u0026#34;Lucy\u0026#34;, \u0026#34;age\u0026#34;: 20}, ] names, ages = zip(*[(u[\u0026#34;name\u0026#34;], u[\u0026#34;age\u0026#34;]) for u in users]) 5.9 å¤šåˆ—è¡¨åˆå¹¶æˆ CSV è¡Œ rows = zip(name_list, age_list, city_list) for r in rows: print(\u0026#39;,\u0026#39;.join(map(str, r))) 5.10 ä¸ map ç»„åˆå¤„ç†å¤šåºåˆ— result = list(map(sum, zip([1,2,3], [4,5,6]))) # [5,7,9] 5.11 åˆ†æ‰¹å¤„ç† Stream / åˆ—è¡¨ å¦‚æœä½ è¦æŠŠåˆ—è¡¨æ¯ N ä¸ªæ‰“åŒ…ï¼š\ndef chunk(iterable, n): args = [iter(iterable)] * n return zip(*args) list(chunk([1,2,3,4,5,6], 3)) # [(1,2,3), (4,5,6)] è¿™æ˜¯ zip çš„é«˜çº§æŠ€å·§ï¼\n5.12 zip ç»“åˆ reduce æ±‚åˆ—çš„ç´¯åŠ  from functools import reduce matrix = [ [1,2,3], [4,5,6], [7,8,9], ] col_sum = [sum(col) for col in zip(*matrix)] 5.13 æ¯”è¾ƒä¸¤ä¸ªåºåˆ—æ˜¯å¦å…ƒç´ å¯¹åº”ç›¸ç­‰ all(x == y for x, y in zip(a, b)) 5.14 zip å¤šåºåˆ—å¹¶è¡Œè¿›åº¦æ¡ï¼ˆé…è¿›åº¦æ¡åœºæ™¯ï¼‰ å¯ä»¥ç”¨åœ¨ tqdm ä¸­ï¼š\nfor a, b in zip(data1, data2): ... 5.15 å°†äºŒç»´æ•°ç»„å†™æˆ CSVï¼ˆpy ä¿ä½‘ï¼‰ with open(\u0026#39;data.csv\u0026#39;,\u0026#39;w\u0026#39;) as f: for row in zip(*columns): f.write(\u0026#39;,\u0026#39;.join(map(str, row)) + \u0026#39;\\n\u0026#39;) 6ï¸âƒ£ zip çš„å¸¸è§å‘ç‚¹ âŒ 6.1 zip å¯¹è±¡æ˜¯ä¸€æ¬¡æ€§çš„ï¼ˆè¿­ä»£å™¨ï¼‰ z = zip(a, b) list(z) list(z) # ç¬¬äºŒæ¬¡æ˜¯ç©º åŠ¡å¿…æ³¨æ„ã€‚\nâŒ 6.2 zip ä¼šæˆªæ–­åˆ°æœ€çŸ­åºåˆ— å¦‚æœä½ ä»¥ä¸º zip ä¼šè¡¥é½ï¼Œé‚£ä½ åº”è¯¥ç”¨ï¼š\nzip_longest\n7ï¸âƒ£ zip çš„æ€§èƒ½ zip çš„æ€§èƒ½éå¸¸é«˜ï¼š\næ— æ‹·è´ æƒ°æ€§ C å®ç° å†…å­˜æçœ åœ¨ä½ è¦â€œå¹¶è¡Œéå†å¤šä¸ªåºåˆ—â€æ—¶ä¼˜å…ˆä½¿ç”¨ zipã€‚\n8ï¸âƒ£ zip åº•å±‚åŸç†ï¼ˆç®€ç‰ˆæºç è§£é‡Šï¼‰ å®é™…ä¸Š zip çš„å·¥ä½œæ–¹å¼ç­‰ä»·äºï¼š\ndef py_zip(*iterables): iters = [iter(it) for it in iterables] while True: try: yield tuple(next(it) for it in iters) except StopIteration: return 9ï¸âƒ£ æ€»ç»“ zip = å¤šåºåˆ—å¹¶è¡Œè¿­ä»£ï¼›ä»¥æœ€çŸ­ä¸ºå‡†ï¼›æƒ°æ€§è¿­ä»£å™¨ï¼›å¯ç”¨äºçŸ©é˜µè½¬ç½®ã€ç”Ÿæˆ dictã€è§£å‹ã€å¹¶è¡Œéå†ã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€ä»½ æœ€å…¨é¢ã€æœ€æ¸…æ™°çš„ Python zip å‡½æ•°çŸ¥è¯†æ•´ç†ï¼Œæ¶µç›–åŸç†ã€ç”¨æ³•ã€è¿›é˜¶æŠ€å·§ã€é™·é˜±ã€ä¼˜åŒ–æ–¹æ¡ˆä»¥åŠå®æˆ˜ç¤ºä¾‹ã€‚\n1ï¸âƒ£ åŸºæœ¬è¯­æ³• zip(*iterables) ä½œç”¨ï¼šæŠŠå¤šä¸ªå¯è¿­ä»£å¯¹è±¡â€œæ‹‰é“¾å¼â€é…å¯¹ï¼Œè¿”å›ä¸€ä¸ªæƒ°æ€§çš„ zip å¯¹è±¡ï¼ˆè¿­ä»£å™¨ï¼‰\nç¤ºä¾‹ï¼š\na = [1, 2, 3] b = [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;] list(zip(a, b)) # [(1, \u0026#39;a\u0026#39;), (2, \u0026#39;b\u0026#39;), (3, \u0026#39;c\u0026#39;)] 2ï¸âƒ£ zip æ˜¯æƒ°æ€§çš„ï¼ˆiteratorï¼‰ zip() æœ¬è´¨ä¸Šæ˜¯ è¿­ä»£å™¨ï¼Œä¸ä¼šä¸€æ¬¡æ€§æŠŠæ•°æ®è£…è½½åˆ°å†…å­˜ä¸­ã€‚\nz = zip(a, b) next(z) # (1, \u0026#39;a\u0026#39;) 3ï¸âƒ£ zip ä¼šä»¥æœ€çŸ­åºåˆ—ä¸ºå‡†ï¼ˆé‡è¦è¡Œä¸ºï¼‰ a = [1, 2, 3] b = [\u0026#39;x\u0026#39;, \u0026#39;y\u0026#39;] list(zip(a, b)) # [(1, \u0026#39;x\u0026#39;), (2, \u0026#39;y\u0026#39;)] åªèµ°åˆ° æœ€çŸ­çš„ iterableã€‚\n"},{"id":456,"href":"/database/postgres/oltp-olap/","title":"ä»€ä¹ˆæ˜¯ OLTP å’Œ OLAP ï¼Ÿ","parent":"PostgreSQL","content":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€æ˜“ç†è§£ çš„ OLTP ä¸ OLAP åŒºåˆ«ä¸ç”¨é€”è®²è§£ï¼ˆé€‚ç”¨äºå®é™…å·¥ä½œã€æ•°æ®åº“è®¾è®¡ã€æ•°æ®ä»“åº“ã€ä¸šåŠ¡ç³»ç»Ÿï¼‰ã€‚\nä»€ä¹ˆæ˜¯ OLTPï¼Ÿ OLTP = Online Transaction Processing\nğŸ‘‰ åœ¨çº¿äº‹åŠ¡å¤„ç†ç³»ç»Ÿ\nä½ æ¯å¤©ç”¨çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œ99% éƒ½æ˜¯ OLTPï¼Œæ¯”å¦‚ï¼š\nApp ç™»å½•ã€ä¸‹å• åå°ç®¡ç†ç³»ç»Ÿ ERPã€CRM é‡‘èæ”¯ä»˜ã€äº¤æ˜“ ç”µå•†è®¢å•ç³»ç»Ÿ ç”¨æˆ·è´¦å·ç³»ç»Ÿ OLTP ä¸»è¦ç‰¹ç‚¹ï¼š\nç‰¹æ€§ è¯´æ˜ å¤§é‡å°äº‹åŠ¡ insert/update/delete éå¸¸é¢‘ç¹ å¼ºä¸€è‡´æ€§ å¿…é¡»ä¿è¯äº‹åŠ¡æ­£ç¡®ï¼ˆACIDï¼‰ å“åº”æ—¶é—´æçŸ­ æ¯«ç§’çº§å“åº” å¹¶å‘æé«˜ å¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—® æ•°æ®å®æ—¶æ€§é«˜ ç«‹å³è¯»åˆ°æœ€æ–°æ•°æ® ğŸ’¡ æœ¬è´¨ï¼šä¸šåŠ¡ç³»ç»Ÿçš„å®æ—¶è¯»å†™æ•°æ®åº“\nå¸¸ç”¨æŠ€æœ¯ï¼š\nPostgreSQLã€MySQLã€Oracle Redisï¼ˆç¼“å­˜å±‚ï¼‰ ç´¢å¼•ä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ã€ä¸»ä»å¤åˆ¶ ä»€ä¹ˆæ˜¯ OLAPï¼Ÿ OLAP = Online Analytical Processing\nğŸ‘‰ åœ¨çº¿åˆ†æå¤„ç†ç³»ç»Ÿ\nä½ å¸¸è§çš„ BI åˆ†æç³»ç»Ÿã€æ•°æ®æŠ¥è¡¨ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ OLAPï¼š\næ•°æ®ä»“åº“ï¼ˆDWHï¼‰ é”€å”®è¶‹åŠ¿åˆ†æ ç”¨æˆ·ç”»åƒ ç»è¥åˆ†æå¤§å± å¤§æ•°æ®åˆ†æå¹³å° ç¦»çº¿æŠ¥è¡¨ OLAP ç‰¹ç‚¹ï¼š\nç‰¹æ€§ è¯´æ˜ å¤§é‡è¯»å– å‡ ä¹ä¸å†™ï¼Œåªè¯»å¤§æ•°æ® å¤æ‚æŸ¥è¯¢ åˆ†ç»„ã€èšåˆã€çª—å£å‡½æ•°ã€ç»Ÿè®¡åˆ†æ å¤„ç†æµ·é‡æ•°æ® TBã€PB çº§ å»¶è¿Ÿå…è®¸ ç§’çº§ã€åˆ†é’Ÿçº§éƒ½å¯ä»¥ æ•°æ®éå®æ—¶ T+1ã€å°æ—¶çº§åŒæ­¥ ğŸ’¡ æœ¬è´¨ï¼šç”¨æ¥åˆ†æå†å²æ•°æ®çš„æ•°æ®ä»“åº“\nå¸¸ç”¨æŠ€æœ¯ï¼š\nClickHouse Doris DuckDB Snowflake PostgreSQLï¼ˆå¤–éƒ¨è¡¨ï¼‰ Sparkã€Hive OLTP å’Œ OLAP çš„æœ¬è´¨åŒºåˆ«ï¼ˆæœ€å…³é”®ï¼‰ é¡¹ç›® OLTPï¼ˆä¸šåŠ¡åº“ï¼‰ OLAPï¼ˆåˆ†æåº“ï¼‰ ç›®çš„ æ”¯æ’‘ä¸šåŠ¡ åšåˆ†æ æ“ä½œ å°‘é‡è¯»å†™ å¤§é‡è¯»å– äº‹åŠ¡ è¦æ±‚å¼ºäº‹åŠ¡ å¼±äº‹åŠ¡ç”šè‡³æ— äº‹åŠ¡ æŸ¥è¯¢ ç®€å•ã€èµ°ç´¢å¼• å¤æ‚ã€å…¨è¡¨æ‰«æ å“åº” æ¯«ç§’ ç§’çº§ã€åˆ†é’Ÿ æ•°æ®é‡ GB çº§åˆ« TB~PB çº§åˆ« æ¨¡å¼ 3NF è®¾è®¡ï¼Œé¿å…å†—ä½™ Star Schemaï¼ˆç»´åº¦æ¨¡å‹ï¼‰ æ˜“å˜æ€§ ä¸æ–­å˜åŒ– ä¸å¸¸å˜åŒ–ï¼Œæ‰¹é‡å¯¼å…¥ ä¸¤è€…ä¸æ˜¯äº’æ–¥ï¼Œè€Œæ˜¯é…åˆä½¿ç”¨ã€‚\nğŸ§© ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ OLTP åš OLAPï¼Ÿ å› ä¸º OLTP æ˜¯ä¸ºå®æ—¶ä¸šåŠ¡è®¾è®¡çš„ï¼š\næœ‰å¤§é‡ç´¢å¼•ï¼ˆå†™å…¥æ…¢ï¼‰ äº‹åŠ¡å¼€é”€å¤§ æ“ä½œå°è€Œé¢‘ç¹ é‡åˆ°å¤§æŸ¥è¯¢ä¼šå µä¸šåŠ¡ -\u0026gt; æ‚²å‰§ å› æ­¤ä¸èƒ½ç”¨ OLTP åšæŠ¥è¡¨åˆ†æã€‚\nğŸ‘‰ å…¸å‹äº‹æ•…ï¼šå¤§ SQL æŠŠä¸šåŠ¡åº“æ‰“çˆ†ã€‚\nğŸ§© ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ OLAP åš OLTPï¼Ÿ å› ä¸º OLAP æ˜¯ä¸ºåˆ†æè®¾è®¡çš„ï¼š\næ¶‰åŠåˆ—å¼å­˜å‚¨ å†™å…¥æ…¢ äº‹åŠ¡å¼± ä¸é€‚åˆé¢‘ç¹æ›´æ–° æ‰€ä»¥ä¹Ÿä¸èƒ½ç”¨åˆ†æåº“æŠ—ä¸šåŠ¡æµé‡ã€‚\nâ­ çœŸå®ä¼ä¸šæ¶æ„ï¼ˆæœ€æ¨èï¼‰ ä¸šåŠ¡æ•°æ®åº“ (OLTP) â”‚ â–¼ (CDCã€Binlogã€WALã€ETL) â–¼ æ•°æ®ä»“åº“ (OLAP) â”‚ â–¼ BI æŠ¥è¡¨ ä¾‹å¦‚ï¼š\nPostgreSQL / MySQL -\u0026gt; ClickHouse / Doris PostgreSQL / MySQL s\u0026gt; Snowflake PostgreSQL -\u0026gt; TimescaleDBï¼ˆæ—¶åº OLAPï¼‰ å¦‚ä½•ç®€å•åˆ¤æ–­ä¸€ä¸ªç³»ç»Ÿå±äº OLTP è¿˜æ˜¯ OLAPï¼Ÿ åªé—® 3 ä¸ªé—®é¢˜ï¼š\n1ï¼‰æ˜¯å¦éœ€è¦å¼ºäº‹åŠ¡ã€ä¸€è‡´æ€§ï¼Ÿ æ˜¯ -\u0026gt; OLTP\nå¦ -\u0026gt; OLAP\n2ï¼‰æ˜¯å¦éœ€è¦å¤æ‚çš„èšåˆåˆ†æï¼Ÿ æ˜¯ -\u0026gt; OLAP\nå¦ -\u0026gt; OLTP\n3ï¼‰æ˜¯å¦éœ€è¦æ”¯æ’‘å¤§é‡å®æ—¶ä¸šåŠ¡ï¼Ÿ æ˜¯ -\u0026gt; OLTP\nå¦ -\u0026gt; OLAP\nğŸ¯ ç®€çŸ­æ€»ç»“ï¼ˆè®°ä½è¿™ 2 å¥è¯ï¼‰ OLTP = ä¸šåŠ¡æ•°æ®åº“ = å°äº‹åŠ¡ \u0026amp; å®æ—¶è¯»å†™\nOLAP = åˆ†ææ•°æ®åº“ = å¤§æŸ¥è¯¢ \u0026amp; æ‰¹é‡åˆ†æ\n","description":"ä¸‹é¢æ˜¯ä¸€ä»½ æœ€æ¸…æ™°ã€æœ€æ˜“ç†è§£ çš„ OLTP ä¸ OLAP åŒºåˆ«ä¸ç”¨é€”è®²è§£ï¼ˆé€‚ç”¨äºå®é™…å·¥ä½œã€æ•°æ®åº“è®¾è®¡ã€æ•°æ®ä»“åº“ã€ä¸šåŠ¡ç³»ç»Ÿï¼‰ã€‚\nä»€ä¹ˆæ˜¯ OLTPï¼Ÿ OLTP = Online Transaction Processing\nğŸ‘‰ åœ¨çº¿äº‹åŠ¡å¤„ç†ç³»ç»Ÿ\nä½ æ¯å¤©ç”¨çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œ99% éƒ½æ˜¯ OLTPï¼Œæ¯”å¦‚ï¼š\nApp ç™»å½•ã€ä¸‹å• åå°ç®¡ç†ç³»ç»Ÿ ERPã€CRM é‡‘èæ”¯ä»˜ã€äº¤æ˜“ ç”µå•†è®¢å•ç³»ç»Ÿ ç”¨æˆ·è´¦å·ç³»ç»Ÿ OLTP ä¸»è¦ç‰¹ç‚¹ï¼š\nç‰¹æ€§ è¯´æ˜ å¤§é‡å°äº‹åŠ¡ insert/update/delete éå¸¸é¢‘ç¹ å¼ºä¸€è‡´æ€§ å¿…é¡»ä¿è¯äº‹åŠ¡æ­£ç¡®ï¼ˆACIDï¼‰ å“åº”æ—¶é—´æçŸ­ æ¯«ç§’çº§å“åº” å¹¶å‘æé«˜ å¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—® æ•°æ®å®æ—¶æ€§é«˜ ç«‹å³è¯»åˆ°æœ€æ–°æ•°æ® ğŸ’¡ æœ¬è´¨ï¼šä¸šåŠ¡ç³»ç»Ÿçš„å®æ—¶è¯»å†™æ•°æ®åº“\nå¸¸ç”¨æŠ€æœ¯ï¼š\nPostgreSQLã€MySQLã€Oracle Redisï¼ˆç¼“å­˜å±‚ï¼‰ ç´¢å¼•ä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨ã€ä¸»ä»å¤åˆ¶ ä»€ä¹ˆæ˜¯ OLAPï¼Ÿ OLAP = Online Analytical Processing\n"},{"id":457,"href":"/management/beyond/learn-knowledge-with-management-thinking/","title":"ä»¥ç®¡ç†æ€ç»´å­¦ä¹ çŸ¥è¯†","parent":"Beyond","content":"ä»¥ç®¡ç†çš„æ€ç»´å­¦ä¹ çŸ¥è¯†æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºè¿™èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç»„ç»‡å­¦ä¹ å†…å®¹ï¼Œåˆ¶å®šæ˜ç¡®çš„ç›®æ ‡ï¼Œæé«˜å­¦ä¹ æ•ˆç‡ï¼Œå¹¶æœ€ç»ˆå°†çŸ¥è¯†è½¬åŒ–ä¸ºè¡ŒåŠ¨å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚\nç®¡ç†æ€ç»´åœ¨å­¦ä¹ ä¸­çš„å…·ä½“åº”ç”¨ åˆ¶å®šå­¦ä¹ è®¡åˆ’ï¼š åƒç®¡ç†é¡¹ç›®ä¸€æ ·ï¼Œä¸ºå­¦ä¹ è¿‡ç¨‹è®¾å®šæ˜ç¡®çš„ç›®æ ‡å’Œå¯è¡¡é‡çš„æŒ‡æ ‡ï¼Œå¹¶åˆ¶å®šè¯¦ç»†çš„å­¦ä¹ è®¡åˆ’ï¼ŒåŒ…æ‹¬å­¦ä¹ è¿›åº¦ã€æ—¶é—´åˆ†é…ç­‰ã€‚ æé«˜æ•ˆç‡ï¼š ç®¡ç†çš„æœ¬è´¨æ˜¯ä¼˜åŒ–èµ„æºï¼Œå­¦ä¹ ä¹Ÿä¸€æ ·ã€‚è¿ç”¨æ—¶é—´ç®¡ç†ã€ç²¾åŠ›ç®¡ç†ç­‰æ–¹æ³•ï¼Œè®©å­¦ä¹ è¿‡ç¨‹æ›´æœ‰æ¡ç†ï¼Œé¿å…â€œæŠ“ä¸ä½é‡ç‚¹â€çš„ä½æ•ˆå­¦ä¹ ã€‚ è¯„ä¼°å’Œè°ƒæ•´ï¼š é€šè¿‡å¯¹å­¦ä¹ è¿‡ç¨‹çš„æŒç»­åé¦ˆå’Œè¯„ä¼°ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å­¦ä¹ ç­–ç•¥ï¼Œç¡®ä¿å­¦ä¹ æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚ èšç„¦ç›®æ ‡ï¼š ç®¡ç†æ€ç»´å¼ºè°ƒâ€œç»“æœå¯¼å‘â€ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå§‹ç»ˆå°†çŸ¥è¯†ä¸ç›®æ ‡ï¼ˆå¦‚èŒä¸šå‘å±•ã€æŠ€èƒ½æå‡ç­‰ï¼‰è”ç³»èµ·æ¥ï¼Œç¡®ä¿å­¦ä¹ å†…å®¹ä¸ç›®æ ‡ç›¸ç¬¦ã€‚ ç»“åˆé¢†åŸŸçŸ¥è¯†å­¦ä¹ çš„å¥½å¤„ æå‡ç«äº‰åŠ›ï¼š åœ¨ç¬æ¯ä¸‡å˜çš„æ—¶ä»£ï¼ŒæŒç»­å­¦ä¹ èƒ½è®©ä½ æŒæ¡æœ€æ–°çš„æŠ€èƒ½å’ŒçŸ¥è¯†ï¼Œä¿æŒç«äº‰åŠ›ï¼Œå¹¶æå‡è‡ªèº«ä»·å€¼ã€‚ å¢å¼ºé€‚åº”æ€§ï¼š å­¦ä¹ å’Œå®è·µç›¸ç»“åˆï¼Œèƒ½å¤Ÿæ‹“å±•è§†é‡ï¼Œæå‡æŠ€èƒ½æ°´å¹³ï¼Œå¢å¼ºé€‚åº”èƒ½åŠ›å’Œåˆ›æ–°èƒ½åŠ›ã€‚ å®ç°è‡ªæˆ‘ä»·å€¼ï¼š é€šè¿‡ä¸æ–­å­¦ä¹ ï¼Œä¸ä»…èƒ½è·å–çŸ¥è¯†ï¼Œæ›´èƒ½æé«˜è‡ªæˆ‘æ„è¯†å’Œè‡ªæˆ‘ä»·å€¼ï¼Œæ›´å¥½åœ°èå…¥ç¤¾ä¼šå’Œç¯å¢ƒã€‚ ç»“è®º ç”¨ç®¡ç†çš„æ€ç»´å­¦ä¹ çŸ¥è¯†ï¼Œèƒ½å¤Ÿè®©ä½ ä»¥æ›´ç³»ç»Ÿã€æ›´æœ‰ç›®çš„æ€§åœ°è¿›è¡Œå­¦ä¹ ï¼Œä»è€Œåœ¨çŸ¥è¯†çš„æµ·æ´‹ä¸­æ›´æœ‰æ•ˆåœ°èˆªè¡Œï¼Œæœ€ç»ˆå®ç°çŸ¥è¯†çš„è½¬åŒ–å’Œä»·å€¼çš„åˆ›é€ ã€‚\n","description":"ä»¥ç®¡ç†çš„æ€ç»´å­¦ä¹ çŸ¥è¯†æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºè¿™èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç»„ç»‡å­¦ä¹ å†…å®¹ï¼Œåˆ¶å®šæ˜ç¡®çš„ç›®æ ‡ï¼Œæé«˜å­¦ä¹ æ•ˆç‡ï¼Œå¹¶æœ€ç»ˆå°†çŸ¥è¯†è½¬åŒ–ä¸ºè¡ŒåŠ¨å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚\nç®¡ç†æ€ç»´åœ¨å­¦ä¹ ä¸­çš„å…·ä½“åº”ç”¨ åˆ¶å®šå­¦ä¹ è®¡åˆ’ï¼š åƒç®¡ç†é¡¹ç›®ä¸€æ ·ï¼Œä¸ºå­¦ä¹ è¿‡ç¨‹è®¾å®šæ˜ç¡®çš„ç›®æ ‡å’Œå¯è¡¡é‡çš„æŒ‡æ ‡ï¼Œå¹¶åˆ¶å®šè¯¦ç»†çš„å­¦ä¹ è®¡åˆ’ï¼ŒåŒ…æ‹¬å­¦ä¹ è¿›åº¦ã€æ—¶é—´åˆ†é…ç­‰ã€‚ æé«˜æ•ˆç‡ï¼š ç®¡ç†çš„æœ¬è´¨æ˜¯ä¼˜åŒ–èµ„æºï¼Œå­¦ä¹ ä¹Ÿä¸€æ ·ã€‚è¿ç”¨æ—¶é—´ç®¡ç†ã€ç²¾åŠ›ç®¡ç†ç­‰æ–¹æ³•ï¼Œè®©å­¦ä¹ è¿‡ç¨‹æ›´æœ‰æ¡ç†ï¼Œé¿å…â€œæŠ“ä¸ä½é‡ç‚¹â€çš„ä½æ•ˆå­¦ä¹ ã€‚ è¯„ä¼°å’Œè°ƒæ•´ï¼š é€šè¿‡å¯¹å­¦ä¹ è¿‡ç¨‹çš„æŒç»­åé¦ˆå’Œè¯„ä¼°ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å­¦ä¹ ç­–ç•¥ï¼Œç¡®ä¿å­¦ä¹ æœç€æ­£ç¡®çš„æ–¹å‘å‰è¿›ã€‚ èšç„¦ç›®æ ‡ï¼š ç®¡ç†æ€ç»´å¼ºè°ƒâ€œç»“æœå¯¼å‘â€ã€‚åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå§‹ç»ˆå°†çŸ¥è¯†ä¸ç›®æ ‡ï¼ˆå¦‚èŒä¸šå‘å±•ã€æŠ€èƒ½æå‡ç­‰ï¼‰è”ç³»èµ·æ¥ï¼Œç¡®ä¿å­¦ä¹ å†…å®¹ä¸ç›®æ ‡ç›¸ç¬¦ã€‚ ç»“åˆé¢†åŸŸçŸ¥è¯†å­¦ä¹ çš„å¥½å¤„ æå‡ç«äº‰åŠ›ï¼š åœ¨ç¬æ¯ä¸‡å˜çš„æ—¶ä»£ï¼ŒæŒç»­å­¦ä¹ èƒ½è®©ä½ æŒæ¡æœ€æ–°çš„æŠ€èƒ½å’ŒçŸ¥è¯†ï¼Œä¿æŒç«äº‰åŠ›ï¼Œå¹¶æå‡è‡ªèº«ä»·å€¼ã€‚ å¢å¼ºé€‚åº”æ€§ï¼š å­¦ä¹ å’Œå®è·µç›¸ç»“åˆï¼Œèƒ½å¤Ÿæ‹“å±•è§†é‡ï¼Œæå‡æŠ€èƒ½æ°´å¹³ï¼Œå¢å¼ºé€‚åº”èƒ½åŠ›å’Œåˆ›æ–°èƒ½åŠ›ã€‚ å®ç°è‡ªæˆ‘ä»·å€¼ï¼š é€šè¿‡ä¸æ–­å­¦ä¹ ï¼Œä¸ä»…èƒ½è·å–çŸ¥è¯†ï¼Œæ›´èƒ½æé«˜è‡ªæˆ‘æ„è¯†å’Œè‡ªæˆ‘ä»·å€¼ï¼Œæ›´å¥½åœ°èå…¥ç¤¾ä¼šå’Œç¯å¢ƒã€‚ ç»“è®º ç”¨ç®¡ç†çš„æ€ç»´å­¦ä¹ çŸ¥è¯†ï¼Œèƒ½å¤Ÿè®©ä½ ä»¥æ›´ç³»ç»Ÿã€æ›´æœ‰ç›®çš„æ€§åœ°è¿›è¡Œå­¦ä¹ ï¼Œä»è€Œåœ¨çŸ¥è¯†çš„æµ·æ´‹ä¸­æ›´æœ‰æ•ˆåœ°èˆªè¡Œï¼Œæœ€ç»ˆå®ç°çŸ¥è¯†çš„è½¬åŒ–å’Œä»·å€¼çš„åˆ›é€ ã€‚\n"},{"id":458,"href":"/operations/jenkins/build-docker/","title":"ä½¿ç”¨ Docker éƒ¨ç½²çš„ Jenkins å¦‚ä½•æ‰“åŒ…å…¶ä»– Docker é•œåƒ","parent":"Jenkins","content":"Jenkins æ‰“åŒ…å…¶ä»– Docker é•œåƒçš„å¸¸è§æ–¹æ³•åŒ…æ‹¬ï¼šç›´æ¥å®‰è£… Docker å¼•æ“ï¼ˆDocker-in-Docker æˆ– DooDï¼‰ã€ä½¿ç”¨ Docker å‘½ä»¤è¡Œå·¥å…·è¿æ¥å®¿ä¸»æœº Dockerï¼ˆDooDå˜ç§ï¼‰ã€æˆ–é€šè¿‡ Jenkins Slave èŠ‚ç‚¹é¢„è£… Dockerã€‚ æœ€å¸¸è§ä¸”æ¨èçš„æ–¹å¼æ˜¯è®© Jenkins Slaveï¼ˆæ„å»ºèŠ‚ç‚¹ï¼‰å®‰è£… Dockerï¼Œå¹¶é…ç½®æƒé™ï¼Œæˆ–è€…ä½¿ç”¨ Docker-in-Docker (DinD) å®¹å™¨åŒ–è¿è¡Œæ„å»ºã€‚\nJenkins æ„å»º Docker é•œåƒçš„å‡ ç§æ–¹æ³• 1. åœ¨ Jenkins Slave èŠ‚ç‚¹ä¸Šå®‰è£… Docker å¼•æ“ (æ¨èæ–¹å¼) åœ¨è¿è¡Œ Jenkins Agentï¼ˆä»èŠ‚ç‚¹ï¼‰çš„æœºå™¨ä¸Šå®‰è£… Docker å®ˆæŠ¤è¿›ç¨‹ (dockerd)ã€‚\nJenkins Pipeline é€šè¿‡ SSH æˆ–ç›´æ¥è¿è¡Œ docker build å‘½ä»¤æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ Docker å¼•æ“ã€‚\néœ€è¦ç¡®ä¿ Jenkins ç”¨æˆ·ï¼ˆå¦‚jenkinsæˆ–hudsonï¼‰æœ‰æƒé™è®¿é—® Docker Socket (/var/run/dockerã€‚sock)ï¼Œé€šå¸¸é€šè¿‡å°†å…¶åŠ å…¥ docker ç”¨æˆ·ç»„å®ç°ã€‚\nDocker-in-Docker (DinD) æ¨¡å¼ Jenkins Slave æœ¬èº«ä½œä¸ºä¸€ä¸ª Docker å®¹å™¨å¯åŠ¨ (docker run \u0026ndash;privileged \u0026hellip; jenkins/agent)ï¼Œå¹¶åœ¨è¯¥å®¹å™¨å†…éƒ¨å†è¿è¡Œä¸€ä¸ªDockerå®ˆæŠ¤è¿›ç¨‹ã€‚\nPipeline è„šæœ¬ä¸­ç›´æ¥ä½¿ç”¨ docker buildï¼Œå®é™…ä¸Šæ˜¯åœ¨å®¹å™¨å†…éƒ¨çš„ Docker ç¯å¢ƒæ‰§è¡Œã€‚\nä¼˜ç‚¹æ˜¯ç¯å¢ƒéš”ç¦»å¥½ï¼Œç¼ºç‚¹æ˜¯éœ€è¦ \u0026ndash;privileged æƒé™ä¸”å¯èƒ½å­˜åœ¨å­˜å‚¨/ç¼“å­˜é—®é¢˜ã€‚\nDocker-outside-of-Docker (DooD / SSHè¿æ¥DooD) Jenkins Slave å®¹å™¨æŒ‚è½½å®¿ä¸»æœºçš„ /var/run/docker.sockã€‚\nPipeline ä¸­çš„ docker å‘½ä»¤å®é™…ä¸Šæ˜¯åœ¨æ“ä½œå®¿ä¸»æœºçš„ Docker å¼•æ“ã€‚\nè¿™ç§æ–¹å¼æ¯”è¾ƒè½»é‡ï¼Œä½†æƒé™ç®¡ç†å’Œè·¯å¾„æ˜ å°„éœ€è¦æ›´å°å¿ƒã€‚\nè¿œç¨‹ Docker API (ä¸å¸¸ç”¨) Jenkins Slave è¿æ¥åˆ°é…ç½®äº† TCP ç›‘å¬çš„è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹ã€‚\nä¸å®‰å…¨ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚\nJenkins Pipeline ç¤ºä¾‹ (Slaveå·²å®‰è£…Docker) pipeline { agent { label \u0026#39;docker-node\u0026#39; } // æ ‡ç­¾æŒ‡å‘å®‰è£…äº†Dockerçš„SlaveèŠ‚ç‚¹ stages { stage(\u0026#39;Build Image\u0026#39;) { steps { script { sh \u0026#39;docker build -t my-app:${BUILD_NUMBER} ã€‚\u0026#39; sh \u0026#39;docker tag my-app:${BUILD_NUMBER} my-app:latest\u0026#39; } } } stage(\u0026#39;Push Image\u0026#39;) { steps { script { dockerã€‚withRegistry(\u0026#39;https://registryã€‚hubã€‚dockerã€‚com\u0026#39;, \u0026#39;docker-hub-credentials-id\u0026#39;) { sh \u0026#39;docker push my-app:${BUILD_NUMBER}\u0026#39; sh \u0026#39;docker push my-app:latest\u0026#39; } } } } } } ","description":"Jenkins æ‰“åŒ…å…¶ä»– Docker é•œåƒçš„å¸¸è§æ–¹æ³•åŒ…æ‹¬ï¼šç›´æ¥å®‰è£… Docker å¼•æ“ï¼ˆDocker-in-Docker æˆ– DooDï¼‰ã€ä½¿ç”¨ Docker å‘½ä»¤è¡Œå·¥å…·è¿æ¥å®¿ä¸»æœº Dockerï¼ˆDooDå˜ç§ï¼‰ã€æˆ–é€šè¿‡ Jenkins Slave èŠ‚ç‚¹é¢„è£… Dockerã€‚ æœ€å¸¸è§ä¸”æ¨èçš„æ–¹å¼æ˜¯è®© Jenkins Slaveï¼ˆæ„å»ºèŠ‚ç‚¹ï¼‰å®‰è£… Dockerï¼Œå¹¶é…ç½®æƒé™ï¼Œæˆ–è€…ä½¿ç”¨ Docker-in-Docker (DinD) å®¹å™¨åŒ–è¿è¡Œæ„å»ºã€‚\nJenkins æ„å»º Docker é•œåƒçš„å‡ ç§æ–¹æ³• 1. åœ¨ Jenkins Slave èŠ‚ç‚¹ä¸Šå®‰è£… Docker å¼•æ“ (æ¨èæ–¹å¼) åœ¨è¿è¡Œ Jenkins Agentï¼ˆä»èŠ‚ç‚¹ï¼‰çš„æœºå™¨ä¸Šå®‰è£… Docker å®ˆæŠ¤è¿›ç¨‹ (dockerd)ã€‚\n"},{"id":459,"href":"/operations/gitlab/deploy-gitlab-ce/","title":"ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab CE","parent":"GitLab","content":"ä¸‹é¢æ˜¯ä¸€å¥— å¯ç›´æ¥ç”¨äºç”Ÿäº§ / å†…ç½‘çš„ podman-compose éƒ¨ç½² GitLab CEï¼ˆç¤¾åŒºç‰ˆï¼‰å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…å«ï¼š\nç›®å½•è§„åˆ’ podman-compose.yaml æ ¸å¿ƒé…ç½®é¡¹è¯´æ˜ é¦–æ¬¡å¯åŠ¨ \u0026amp; ç™»å½• å¸¸è§é—®é¢˜ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹ å†…å®¹å è¿ç»´çº§ï¼Œä¸æ˜¯åªè·‘èµ·æ¥é‚£ç§ã€‚\nä¸€ã€éƒ¨ç½²å‰å‡†å¤‡ï¼ˆå¿…é¡»ï¼‰ 1ï¸âƒ£ æœåŠ¡å™¨æœ€ä½é…ç½®ï¼ˆçœŸå®å¯ç”¨ï¼‰ é¡¹ç›® å»ºè®® CPU â‰¥ 2 Coreï¼ˆæ¨è 4 Coreï¼‰ å†…å­˜ â‰¥ 6Gï¼ˆæœ€ä½ï¼‰ï¼Œæ¨è 8G ç£ç›˜ â‰¥ 50Gï¼ˆä»£ç  + CI + æ—¥å¿—ï¼‰ OS Linuxï¼ˆAlmaLinux / Ubuntu / Debianï¼‰ âš ï¸ å†…å­˜å°äº 6G éå¸¸å®¹æ˜“ OOM\n2ï¸âƒ£ å®‰è£… podman \u0026amp; podman-compose ç¡®ä¿ç‰ˆæœ¬ï¼š\npodman version podman-compose version äºŒã€ç›®å½•è§„åˆ’ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ /data/gitlab-ce/ â”œâ”€â”€ compose/ # docker-compose â”œâ”€â”€ config/ # GitLab é…ç½® â”œâ”€â”€ data/ # Git ä»“åº“ + æ•°æ® â””â”€â”€ logs/ # æ—¥å¿— åˆ›å»ºç›®å½•ï¼š\nmkdir -p /data/gitlab-ce/{compose,config,data,logs} ä¸‰ã€docker-compose.yamlï¼ˆæ ¸å¿ƒï¼‰ âœ… æœ€å°å¯ç”¨ç”Ÿäº§æ¨¡æ¿ æ–‡ä»¶ï¼š/data/gitlab-ce/compose/docker-compose.yaml\nversion: \u0026#34;3\u0026#34; services: gitlab: image: gitlab/gitlab-ce:18.7.0-ce.0 container_name: gitlab-ce restart: always ports: # æ³¨æ„: ç«¯å£å·è¦å’Œ external_url çš„ç«¯å£ä¸€è‡´ - \u0026#34;8800:8800\u0026#34; volumes: - /data/gitlab-ce/config:/etc/gitlab - /data/gitlab-ce/logs:/var/log/gitlab - /data/gitlab-ce/data:/var/opt/gitlab environment: TZ: Asia/Shanghai GITLAB_OMNIBUS_CONFIG: | external_url \u0026#39;http://192.168.101.201:8800\u0026#39; gitlab_rails[\u0026#39;time_zone\u0026#39;] = \u0026#39;Asia/Shanghai\u0026#39; shm_size: \u0026#34;256m\u0026#34; æ³¨æ„ï¼šä¸€å®šè¦é…ç½® external_urlï¼Œå¦åˆ™åé¢å¯èƒ½å‡ºç°ä¸€äº›è«åå…¶å¦™çš„é”™è¯¯ã€‚\n# åæœŸä¿®æ”¹ sed -i \u0026#34;s|^# external_url .*|external_url \u0026#39;http://192.168.101.201:8800\u0026#39;|g\u0026#34; gitlab.rb å››ã€å¯åŠ¨ GitLab # æ‹‰å–é•œåƒ HTTP_PROXY=http://192.168.101.200:1080 HTTPS_PROXY=http://192.168.101.200:1080 podman pull gitlab/gitlab-ce:18.7.0-ce.0 # å¯åŠ¨ cd /data/gitlab-ce/compose podman-compose up -d é¦–æ¬¡å¯åŠ¨ 5ï½10 åˆ†é’Ÿæ˜¯æ­£å¸¸çš„ï¼š\npodman logs -f gitlab-ce çœ‹åˆ°ç±»ä¼¼ï¼š\ngitlab Reconfigured! è¡¨ç¤ºå¯åŠ¨å®Œæˆã€‚\næˆ–è€…å¯åŠ¨è¿‡ç¨‹ä¸­å¯ä»¥ä¸€ç›´åˆ·æ–° http://192.168.101.201:8800ï¼Œç›´åˆ°çœ‹åˆ° GitLab ç™»å½•é¡µé¢ã€‚\näº”ã€é¦–æ¬¡ç™»å½• GitLab 1ï¸âƒ£ è·å– root åˆå§‹å¯†ç  podman exec -it gitlab-ce grep \u0026#39;Password:\u0026#39; /etc/gitlab/initial_root_password âš ï¸ è¯¥æ–‡ä»¶ 24 å°æ—¶åä¼šè‡ªåŠ¨åˆ é™¤\n2ï¸âƒ£ ç™»å½• æµè§ˆå™¨è®¿é—®ï¼š\nhttp://192.168.101.201:8800 ç”¨æˆ·åï¼šroot å¯†ç ï¼šä¸Šä¸€æ­¥è·å–çš„å¯†ç  ä¿®æ”¹å¯†ç ï¼š\nå³ä¸Šè§’å¤´åƒ -\u0026gt; Edit Profile -\u0026gt; User settings -\u0026gt; Password # åœæ­¢å®¹å™¨ podman-compose stop # ä½¿ç”¨ systemd å¯åŠ¨ systemctl start podman@gitlab-ce # åˆ›å»ºç³»ç»ŸæœåŠ¡ systemctl enable podman@gitlab-ce å…­ã€å…³é”®é…ç½®è¯´æ˜ï¼ˆå¿…é¡»ç†è§£ï¼‰ 1ï¸âƒ£ external_urlï¼ˆæœ€é‡è¦ï¼‰ external_url \u0026#39;http://gitlab.example.com\u0026#39; å½±å“ï¼š\nGit clone URL Webhook CI/CD é‚®ä»¶é“¾æ¥ å¦‚æœæ˜¯ å†…ç½‘ IPï¼Œå¯å†™ï¼š\nexternal_url \u0026#39;http://192.168.101.201:8800\u0026#39; 2ï¸âƒ£ SSH ç«¯å£é…ç½® å¦‚æœä½ æ”¹äº†å®¿ä¸»æœº SSH ç«¯å£ï¼ˆå¦‚ 2222ï¼‰ï¼š\nports: - \u0026#34;2222:22\u0026#34; åŒæ—¶ï¼š\ngitlab_rails[\u0026#39;gitlab_shell_ssh_port\u0026#39;] = 2222 3ï¸âƒ£ GitLab æ•°æ®è¯´æ˜ï¼ˆé‡è¦ï¼‰ ç›®å½• å†…å®¹ /etc/gitlab gitlab.rb é…ç½® /var/log/gitlab æ—¥å¿— /var/lib/gitlab Git ä»“åº“ / DB / CI å¤‡ä»½çš„æ ¸å¿ƒå°±æ˜¯ /var/lib/gitlab\nä¸ƒã€å¸¸è§é«˜çº§é…ç½®ï¼ˆç”Ÿäº§æ¨èï¼‰ å¤‡ä»½é…ç½®æ–‡ä»¶:\ncd /data/gitlab-ce/config cp gitlab.rb gitlab.rb_default å…³é—­ä¸å¿…è¦ç»„ä»¶ï¼ˆçœå†…å­˜ï¼‰ # sed -i -E \u0026#34;s/^[[:space:]]*#?[[:space:]]*(alertmanager|prometheus_monitoring|prometheus)\\[\u0026#39;enable\u0026#39;\\][[:space:]]*=[[:space:]]*true|\\1[\u0026#39;enable\u0026#39;] = false|\u0026#34; gitlab.rb # sed -i -E \u0026#34;s/^# (alertmanager|prometheus_monitoring|prometheus)\\[\u0026#39;enable\u0026#39;\\] =.*/\\1[\u0026#39;enable\u0026#39;] = false/g\u0026#34; gitlab.rb # Puma Worker è¿›ç¨‹æ•° (æµ‹è¯•ç¯å¢ƒè°ƒå°ä¸€äº›, æ­£å¼ç¯å¢ƒè°ƒå¤§ä¸€äº›) # å†…å­˜ç´§å¼ æ—¶ï¼Œå°† puma[\u0026#39;worker_processes\u0026#39;] è°ƒå°ï¼Œå¯ä»¥ç¼“è§£å†…å­˜ä¸è¶³é—®é¢˜ # å°¤å…¶æ˜¯åœ¨è™šæ‹Ÿæœºä¸­æœ€å®éªŒçš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå†…å­˜ä¼šä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥å°† puma[\u0026#39;worker_processes\u0026#39;] è°ƒå° sed -i \u0026#34;s/^# \\(puma\\[\u0026#39;worker_processes\u0026#39;\\] =\\).*/\\1 2/g\u0026#34; gitlab.rb # Prometheus Alertmanager sed -i \u0026#34;s/^# \\(alertmanager\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # HA é…ç½®ï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(consul\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Geo å¯å…³é—­ sed -i \u0026#34;s/^# \\(geo_logcursor\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Geo äºŒçº§èŠ‚ç‚¹ï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(geo_postgresql\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å¯å…³é—­ï¼Œå¤‡ä»½å¯ç”¨å¤–éƒ¨å·¥å…· sed -i \u0026#34;s/^# \\(gitlab_backup_cli\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # GitLab Exporter sed -i \u0026#34;s/^# \\(gitlab_exporter\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Kubernetes Agent Serverï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(gitlab_kas\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # GitLab Pages æœåŠ¡ sed -i \u0026#34;s/^# \\(gitlab_pages\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # GitLab Shell SSH æœåŠ¡ (å¦‚æœéœ€è¦ SSH clone/push å¿…é¡»å¯ç”¨) sed -i \u0026#34;s/^# \\(gitlab_sshd\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å¦‚æœä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦ï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(letsencrypt\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å†…ç½®èŠå¤©æœåŠ¡ sed -i \u0026#34;s/^# \\(mattermost\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Mattermost Nginx sed -i \u0026#34;s/^# \\(mattermost_nginx\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # GitLab å†…ç½®ç›‘æ§ï¼Œå¯ä»¥å…³é—­ sed -i \u0026#34;s/^# \\(monitoring_role\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Prometheus Node Exporter sed -i \u0026#34;s/^# \\(node_exporter\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Pages Nginx é…åˆ Pagesï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(pages_nginx\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # é«˜å¯ç”¨ Postgresï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(patroni\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # HA standbyï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(patroni\\[\u0026#39;standby_cluster\u0026#39;\\]\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å¯å…³é—­ sed -i \u0026#34;s/^# \\(pgbouncer\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Prometheus pgbouncer Exporter sed -i \u0026#34;s/^# \\(pgbouncer_exporter\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Prometheus PostgreSQL Exporter sed -i \u0026#34;s/^# \\(postgres_exporter\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Gitaly é›†ç¾¤åè°ƒå™¨ï¼Œå¦‚æœåªæœ‰å•èŠ‚ç‚¹å¯å…³é—­ sed -i \u0026#34;s/^# \\(praefect\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å†…ç½® Prometheus sed -i \u0026#34;s/^# \\(prometheus\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # GitLab å†…ç½® Prometheus Dashboard sed -i \u0026#34;s/^# \\(prometheus_monitoring\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Prometheus Redis Exporter sed -i \u0026#34;s/^# \\(redis_exporter\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # é«˜å¯ç”¨ Sentinelï¼Œå¯å•èŠ‚ç‚¹å…³é—­ sed -i \u0026#34;s/^# \\(redis_sentinel_role\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å†…ç½® Docker Registry sed -i \u0026#34;s/^# \\(registry\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # Registry Nginx sed -i \u0026#34;s/^# \\(registry_nginx\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # é«˜å¯ç”¨ Sentinelï¼Œå¯å•èŠ‚ç‚¹å…³é—­ sed -i \u0026#34;s/^# \\(sentinel\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # é‚®ä»¶é˜²åƒåœ¾ï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(spamcheck\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # å®šæœŸå­˜å‚¨æ£€æŸ¥ï¼Œå¯å…³é—­ sed -i \u0026#34;s/^# \\(storage_check\\[\u0026#39;enable\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb # https://docs.gitlab.com/18.7/administration/settings/event_data/ sed -i \u0026#34;s/^# \\(gitlab_rails\\[\u0026#39;initial_gitlab_product_usage_data\u0026#39;\\] =\\).*/\\1 false/g\u0026#34; gitlab.rb ç¦æ­¢ SSH è®¿é—® Admin area -\u0026gt; Settings -\u0026gt; General -\u0026gt; Visibility and access controls -\u0026gt; Enabled Git access protocols -\u0026gt; Only HTTP(S)\né¡¹ç›®æ•°é‡é™åˆ¶ å¿…é¡»ç”±ç®¡ç†å‘˜åˆ›å»ºé¡¹ç›®ï¼Œç¦æ­¢ç”¨æˆ·åˆ›å»ºé¡¹ç›®ã€‚\nAdmin area -\u0026gt; Settings -\u0026gt; General -\u0026gt; Account and limit\nDefault projects limit -\u0026gt; 0 User restrictions -\u0026gt; å»æ‰æ‰€æœ‰çš„å‹¾ ç¦æ­¢å…¬å¼€æ³¨å†Œ Admin area -\u0026gt; Settings -\u0026gt; General -\u0026gt; Sign-up restrictions -\u0026gt; Sign-up Enabled: å–æ¶ˆå‰é¢çš„å‹¾ -\u0026gt; Save changes\nç¦æ­¢äº‹ä»¶ç»Ÿè®¡ Admin area -\u0026gt; Settings -\u0026gt; Metrics and profiling -\u0026gt; Event tracking -\u0026gt; Enable event tracking: å–æ¶ˆå‰é¢çš„å‹¾ -\u0026gt; Save changes\né‚®ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰ gitlab_rails[\u0026#39;smtp_enable\u0026#39;] = true gitlab_rails[\u0026#39;smtp_address\u0026#39;] = \u0026#34;smtp.example.com\u0026#34; gitlab_rails[\u0026#39;smtp_port\u0026#39;] = 465 gitlab_rails[\u0026#39;smtp_user_name\u0026#39;] = \u0026#34;gitlab@example.com\u0026#34; gitlab_rails[\u0026#39;smtp_password\u0026#39;] = \u0026#34;password\u0026#34; gitlab_rails[\u0026#39;smtp_tls\u0026#39;] = true æ—¶åŒº # gitlab_rails[\u0026#39;time_zone\u0026#39;] = \u0026#39;UTC\u0026#39; # gitlab_rails[\u0026#39;time_zone\u0026#39;] = \u0026#39;Asia/Shanghai\u0026#39; sed -i \u0026#34;s|^# \\(gitlab_rails\\[\u0026#39;time_zone\u0026#39;\\] =\\).*|\\1 \u0026#39;Asia/Shanghai\u0026#39;|g\u0026#34; gitlab.rb å…«ã€ä¿®æ”¹é…ç½®åçš„ç”Ÿæ•ˆæ–¹å¼ podman exec -it gitlab-ce gitlab-ctl reconfigure systemctl restart podman@gitlab-ce.service ä¹ã€GitLab å¤‡ä»½ä¸æ¢å¤ï¼ˆDocker ç‰ˆï¼‰ 1ï¸âƒ£ æ‰‹åŠ¨å¤‡ä»½ podman exec -it gitlab-ce gitlab-backup create å¤‡ä»½æ–‡ä»¶åœ¨ï¼š\n/data/gitlab-ce/data/backups/ 2ï¸âƒ£ æ¢å¤ï¼ˆç®€è¿°ï¼‰ docker exec -it gitlab gitlab-backup restore BACKUP=xxxx åã€å¸¸è§é—®é¢˜ï¼ˆé«˜é¢‘ï¼‰ âŒ 1. å¯åŠ¨å¡ä½ / OOM åŸå› ï¼šå†…å­˜ä¸è¶³\nè§£å†³ï¼š\nâ‰¥ 4G å†…å­˜ å…³é—­ Prometheus/Grafana âŒ 2. clone æç¤º 502 / 500 æ£€æŸ¥ï¼š\ndocker logs gitlab é€šå¸¸æ˜¯ï¼š\nexternal_url é…ç½®é”™è¯¯ Gitaly / Puma å¯åŠ¨å¤±è´¥ âŒ 3. CI Runner è¿æ¥ä¸ä¸Š è®°ä½ï¼š\nRunner æ˜¯ ç‹¬ç«‹éƒ¨ç½² GitLab â‰  Runner åä¸€ã€ç”Ÿäº§çº§éƒ¨ç½²å»ºè®®ï¼ˆé‡è¦ï¼‰ âœ… GitLab å’Œ Runner åˆ†ç¦» âœ… GitLab æ•°æ®å®šæœŸå¤‡ä»½ âœ… ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginxï¼‰+ HTTPS âœ… GitLab å‡çº§å‰ ë°˜ë“œì‹œ å¤‡ä»½ âœ… ä¸è¦é¢‘ç¹ docker pull latestï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ åäºŒã€æ¨èç‰ˆæœ¬å›ºå®šæ–¹å¼ï¼ˆç”Ÿäº§ï¼‰ image: gitlab/gitlab-ce:18.7.0-ce.0 é¿å…ç‰ˆæœ¬å‡çº§äº‹æ•…ã€‚\n","description":"ä¸‹é¢æ˜¯ä¸€å¥— å¯ç›´æ¥ç”¨äºç”Ÿäº§ / å†…ç½‘çš„ podman-compose éƒ¨ç½² GitLab CEï¼ˆç¤¾åŒºç‰ˆï¼‰å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…å«ï¼š\nç›®å½•è§„åˆ’ podman-compose.yaml æ ¸å¿ƒé…ç½®é¡¹è¯´æ˜ é¦–æ¬¡å¯åŠ¨ \u0026amp; ç™»å½• å¸¸è§é—®é¢˜ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹ å†…å®¹å è¿ç»´çº§ï¼Œä¸æ˜¯åªè·‘èµ·æ¥é‚£ç§ã€‚\nä¸€ã€éƒ¨ç½²å‰å‡†å¤‡ï¼ˆå¿…é¡»ï¼‰ 1ï¸âƒ£ æœåŠ¡å™¨æœ€ä½é…ç½®ï¼ˆçœŸå®å¯ç”¨ï¼‰ é¡¹ç›® å»ºè®® CPU â‰¥ 2 Coreï¼ˆæ¨è 4 Coreï¼‰ å†…å­˜ â‰¥ 6Gï¼ˆæœ€ä½ï¼‰ï¼Œæ¨è 8G ç£ç›˜ â‰¥ 50Gï¼ˆä»£ç  + CI + æ—¥å¿—ï¼‰ OS Linuxï¼ˆAlmaLinux / Ubuntu / Debianï¼‰ âš ï¸ å†…å­˜å°äº 6G éå¸¸å®¹æ˜“ OOM\n"},{"id":460,"href":"/operations/gitlab/deploy-gitlab-runner/","title":"ä½¿ç”¨ Podman Compose éƒ¨ç½² GitLab Runner","parent":"GitLab","content":"ä¸‹é¢æ˜¯ä¸€å¥— å¯ç›´æ¥è½åœ°çš„ podman-compose éƒ¨ç½² GitLab Runner å…¨æ•™ç¨‹ï¼Œè¦†ç›– åŸç† -\u0026gt; éƒ¨ç½² -\u0026gt; æ³¨å†Œ -\u0026gt; å¸¸è§å‘ -\u0026gt; ç”Ÿäº§æœ€ä½³å®è·µï¼Œåè¿ç»´ / CI å®æˆ˜ï¼Œè€Œä¸æ˜¯åªâ€œèƒ½è·‘â€ã€‚\nä¸€ã€GitLab Runner æ ¸å¿ƒè®¤çŸ¥ï¼ˆå…ˆææ¸…æ¥šï¼‰ GitLab / Runner / CI çš„å…³ç³» .gitlab-ci.yml â†“ GitLabï¼ˆè°ƒåº¦ï¼‰ â†“ GitLab Runnerï¼ˆæ‰§è¡Œï¼‰ â†“ Executorï¼ˆshell / docker / k8sï¼‰ âš ï¸ Runner â‰  GitLab\nRunner æ˜¯â€œå·¥äººâ€ å¯ä»¥éƒ¨ç½²åœ¨ä»»æ„æœºå™¨ å¯ä»¥å¤šä¸ª Runner å¯¹ä¸€ä¸ª GitLab äºŒã€éƒ¨ç½²æ–¹å¼é€‰æ‹©ï¼ˆé‡è¦ï¼‰ Executor åœºæ™¯ æ˜¯å¦æ¨è shell ç®€å• âŒï¼ˆæ±¡æŸ“å®¿ä¸»æœºï¼‰ docker æœ€å¸¸ç”¨ âœ… docker+machine å·²æ·˜æ±° âŒ kubernetes å¤§è§„æ¨¡ âœ… ssh å°‘è§ âŒ ğŸ‘‰ æœ¬æ–‡ä½¿ç”¨ docker executor\nä¸‰ã€ç›®å½•è§„åˆ’ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰ /data/gitlab-runner/ â”œâ”€â”€ cache/ # CI ç¼“å­˜ â”œâ”€â”€ compose/ # docker-compose â””â”€â”€ config/ # Runner é…ç½® mkdir -p /data/gitlab-runner/{cache,compose,config} å››ã€docker-compose.yamlï¼ˆæ ¸å¿ƒï¼‰ âœ… æ ‡å‡†ç”Ÿäº§å¯ç”¨æ¨¡æ¿ æ–‡ä»¶ï¼š/data/gitlab-runner/compose/docker-compose.yaml\nversion: \u0026#34;3\u0026#34; services: gitlab-runner: image: gitlab/gitlab-runner:v18.7.1 container_name: gitlab-runner restart: always volumes: - /data/gitlab-runner/cache:/cache - /data/gitlab-runner/config:/etc/gitlab-runner - /var/run/docker.sock:/var/run/docker.sock ç»‘å®š /var/run/docker.sock æ˜¯ docker executor çš„å…³é”®\näº”ã€å¯åŠ¨ Runner å®¹å™¨ # æ‹‰å–é•œåƒ HTTP_PROXY=http://127.0.0.1:1080 HTTPS_PROXY=http://127.0.0.1:1080 podman pull gitlab/gitlab-runner:v18.7.1 # å¯åŠ¨ cd /data/gitlab-runner podman-compose up -d æ£€æŸ¥ï¼š\ndocker ps | grep gitlab-runner podman logs -f gitlab-runner # æŠ¥ä»¥ä¸‹é”™è¯¯æ˜¯æ­£å¸¸çš„ # ERROR: Failed to load config stat /etc/gitlab-runner/config.toml: no such file or directory builds=0 max_builds=1 å…­ã€æ³¨å†Œ GitLab Runnerï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ è·å–æ³¨å†Œ Token GitLab Webï¼š\nç®¡ç†é¡µé¢ -\u0026gt; å³ä¸Šè§’: Admin -\u0026gt; CI/CD -\u0026gt; Runners -\u0026gt; Create instance runner å³è¾¹çš„ 3ä¸ªç‚¹ -\u0026gt; Registration token URL: http://192.168.101.200:8800/admin/runners æˆ– å®ä¾‹çº§ï¼š\nAdmin -\u0026gt; Runners 2ï¸âƒ£ è¿›å…¥ Runner å®¹å™¨ podman exec -it gitlab-runner gitlab-runner register 3ï¸âƒ£ æ³¨å†Œè¿‡ç¨‹ç¤ºä¾‹ï¼ˆé€é¡¹è§£é‡Šï¼‰ Enter the GitLab instance URL: http://gitlab.example.com Enter the registration token: xxxxxxxxxxxx Enter a description for the runner: docker-runner-01 Enter tags for the runner (comma-separated): docker,linux Enter optional maintenance note: (empty) Enter the executor: docker Enter the GitLab instance URL (for example, https://gitlab.com/): http://192.168.101.200:8800/ Enter the registration token: 5s9W1RxYfpDsdxcdYkq8 Enter a description for the runner: [1f31d0293f73]: docker-runner-01 Enter tags for the runner (comma-separated): docker,linux,shell Enter optional maintenance note for the runner: WARNING: Support for registration tokens and runner parameters in the \u0026#39;register\u0026#39; command has been deprecated in GitLab Runner 15.6 and will be replaced with support for authentication tokens. For more information, see https://docs.gitlab.com/ci/runners/new_creation_workflow/ Registering runner... succeeded correlation_id=01KDPQP3R9C5V0MN67XHCCSEBY runner=5s9W1RxYf Enter an executor: custom, shell, ssh, docker-windows, instance, parallels, virtualbox, docker, docker+machine, kubernetes, docker-autoscaler: docker Enter the default Docker image (for example, ruby:3.3): alpine:3.23.2 Runner registered successfully. Feel free to start it, but if it\u0026#39;s running already the config should be automatically reloaded! Configuration (with the authentication token) was saved in \u0026#34;/etc/gitlab-runner/config.toml\u0026#34; Create instance runner - Tags: docker,linux,shell - Runner description: docker-runner-01 Create runner podman exec -it gitlab-runner \\ gitlab-runner register \\ --url http://192.168.101.200:8800 \\ --token glrt-t5GBJG57vD0HR5C0J0KZ9286MQp0OjEKdToxCw.01.121av3c0y Enter the GitLab instance URL (for example, https://gitlab.com/): [http://192.168.101.200:8800]: Verifying runner... is valid correlation_id=01KDPXS3CYHDXXMNX8ADQ6QMH8 runner=t5GBJG57v Enter a name for the runner. This is stored only in the local config.toml file: [ce4938d68e70]: docker-runner-01 Enter an executor: ssh, parallels, kubernetes, docker-autoscaler, custom, shell, virtualbox, docker, docker-windows, docker+machine, instance: docker Enter the default Docker image (for example, ruby:3.3): alpine:3.23.2 Runner registered successfully. Feel free to start it, but if it\u0026#39;s running already the config should be automatically reloaded! Configuration (with the authentication token) was saved in \u0026#34;/etc/gitlab-runner/config.toml\u0026#34; 4ï¸âƒ£ Docker executor é…ç½®ï¼ˆå…³é”®ï¼‰ Enter the default Docker image: alpine:3.23.2 æ‹‰å–é•œåƒ\nHTTP_PROXY=http://127.0.0.1:1080 HTTPS_PROXY=http://127.0.0.1:1080 podman pull alpine:3.23.2 5ï¸âƒ£ æ˜¯å¦å¯ç”¨ privilegedï¼ˆæ˜¯å¦å…è®¸ Docker in Dockerï¼‰ Do you want to use Docker privileged mode? [true/false]: true å¦‚æœä½ è¦ï¼š\ndocker build docker push k8s é•œåƒæ„å»º ğŸ‘‰ å¿…é¡» true\nä¸ƒã€æ³¨å†Œå®Œæˆåçš„é…ç½®æ–‡ä»¶ è·¯å¾„ï¼š\n/data/gitlab-runner/config/config.toml ç¤ºä¾‹ï¼ˆå…³é”®å­—æ®µï¼‰ï¼š\nconcurrent = 4 [[runners]] name = \u0026#34;docker-runner-01\u0026#34; url = \u0026#34;http://gitlab.example.com\u0026#34; token = \u0026#34;xxxxxxxx\u0026#34; executor = \u0026#34;docker\u0026#34; [runners.docker] image = \u0026#34;alpine:3.19\u0026#34; privileged = true volumes = [ \u0026#34;/cache\u0026#34;, \u0026#34;/var/run/docker.sock:/var/run/docker.sock\u0026#34; ] å…«ã€æµ‹è¯• Runner æ˜¯å¦æ­£å¸¸ .gitlab-ci.yml ç¤ºä¾‹ï¼š\nstages: - test test-job: stage: test tags: - docker script: - echo \u0026#34;GitLab Runner is working\u0026#34; - docker version Push ååº”çœ‹åˆ°ï¼š\nRunner è¢«é€‰ä¸­ Job æˆåŠŸæ‰§è¡Œ ä¹ã€å¸¸è§é—®é¢˜ \u0026amp; å‘ï¼ˆéå¸¸é«˜é¢‘ï¼‰ âŒ 1. Job ä¸€ç›´ Pending åŸå› ï¼š\ntag ä¸åŒ¹é… Runner è¢« pause Runner scope é”™è¯¯ï¼ˆé¡¹ç›® / groupï¼‰ æ£€æŸ¥ï¼š\ngitlab-runner list âŒ 2. docker: command not found åŸå› ï¼š\næ²¡æŒ‚ docker.sock æ²¡ privileged âŒ 3. æƒé™é—®é¢˜ï¼ˆdocker.sockï¼‰ chmod 666 /var/run/docker.sock æˆ–ï¼š\nusermod -aG docker root âŒ 4. Runner å®¹å™¨è‡ªå·±è¢« CI æ€æ‰ åŸå› ï¼š\nç”¨ docker system prune Runner å’Œ CI ç”¨åŒä¸€ä¸ª Docker ğŸ‘‰ ç”Ÿäº§å»ºè®® Runner ç‹¬ç«‹èŠ‚ç‚¹\nåã€ç”Ÿäº§æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ Runner ä¸ GitLab åˆ†ç¦» GitLabï¼šç¨³å®š Runnerï¼šå¯éšæ„æ‰©ç¼© 2ï¸âƒ£ ä½¿ç”¨ Tag æ§åˆ¶ Runner tags: - docker 3ï¸âƒ£ ä¸€ä¸ª Runner â‰  ä¸€ä¸ªå¹¶å‘ concurrent = 4 4ï¸âƒ£ å›ºå®š Runner ç‰ˆæœ¬ image: gitlab/gitlab-runner:16.11.0 5ï¸âƒ£ CI é•œåƒç¼“å­˜ pull_policy = \u0026#34;if-not-present\u0026#34; åä¸€ã€å®‰å…¨å»ºè®®ï¼ˆå®¹æ˜“è¢«å¿½ç•¥ï¼‰ âš ï¸ docker.sock = root æƒé™ ç­‰ä»·äº å®¿ä¸»æœº root\nå»ºè®®ï¼š\nRunner ç‹¬ç«‹æœºå™¨ ä¸å¯¹å…¬ç½‘å¼€æ”¾ GitLab Runner ","description":"ä¸‹é¢æ˜¯ä¸€å¥— å¯ç›´æ¥è½åœ°çš„ podman-compose éƒ¨ç½² GitLab Runner å…¨æ•™ç¨‹ï¼Œè¦†ç›– åŸç† -\u0026gt; éƒ¨ç½² -\u0026gt; æ³¨å†Œ -\u0026gt; å¸¸è§å‘ -\u0026gt; ç”Ÿäº§æœ€ä½³å®è·µï¼Œåè¿ç»´ / CI å®æˆ˜ï¼Œè€Œä¸æ˜¯åªâ€œèƒ½è·‘â€ã€‚\nä¸€ã€GitLab Runner æ ¸å¿ƒè®¤çŸ¥ï¼ˆå…ˆææ¸…æ¥šï¼‰ GitLab / Runner / CI çš„å…³ç³» .gitlab-ci.yml â†“ GitLabï¼ˆè°ƒåº¦ï¼‰ â†“ GitLab Runnerï¼ˆæ‰§è¡Œï¼‰ â†“ Executorï¼ˆshell / docker / k8sï¼‰ âš ï¸ Runner â‰  GitLab\n"},{"id":461,"href":"/operations/troubleshooting/memory-and-kvm/","title":"å†…å­˜ä¸è¶³å¯¼è‡´ KVM è™šæ‹ŸæœºæŒ‚æ‰","parent":"Troubleshooting","content":"è¿è¡Œç¯å¢ƒï¼š\nCPUï¼šIntel(R) Pentium(R) CPU G4560 @ 3.50GHz (4æ ¸) å†…å­˜ï¼š8G ç¡¬ç›˜ï¼š1T (HDD) + 500G (SSD) æ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 å®¿ä¸»æœºç¦ç”¨äº† swap åˆ†åŒºã€‚\nè¿è¡Œäº† 3 ä¸ª KVM è™šæ‹Ÿæœºï¼Œç¬¬ä¸€ä¸ªè™šæ‹Ÿæœº 2æ ¸ 4G å†…å­˜ï¼Œå…¶å®ƒä¸¤ä¸ªè™šæ‹Ÿæœº 2æ ¸ 2G å†…å­˜ã€‚\nåœ¨ç¬¬ä¸€ä¸ªè™šæ‹Ÿæœºä¸Šå®‰è£… GitLab å’Œ Jinkinsï¼Œå†…å­˜è¦æ±‚ GitLab æ˜¯ 4Gï¼ŒJinkins æ˜¯ 1Gã€‚\nå†…å­˜ä¸è¶³ï¼ŒåŠ ä¸Šç¦ç”¨äº† swapï¼Œæ‰€ä»¥ 4G çš„å†…å­˜æ— æ³•æ­£å¸¸è¿è¡Œ GitLabï¼Œç®€å•çš„ä¸€ä¸ªæ“ä½œï¼ŒGitLab å°±ä¼šæŒ‚æ‰ï¼Œæˆ–è€… KVM è™šæ‹Ÿæœºå¡æ­»ã€‚\nè§£å†³æ–¹æ³•ï¼š\næ·»åŠ  SSD ç¡¬ç›˜ å¯ç”¨ swapï¼Œå¹¶åœ¨ SSD ç¡¬ç›˜ä¸Šåˆ›å»º swap æ–‡ä»¶ å°† KVM è™šæ‹Ÿæœºé•œåƒç§»åŠ¨åˆ°åˆ° SSD ç¡¬ç›˜ æ€»ç»“ï¼š\nå®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œå¿…é¡»åˆ›å»º swap åˆ†åŒºã€‚\nç‰©ç†æœºï¼š8G (è¶…è¿‡ 8G æ„ä¹‰ä¸å¤§) è™šæ‹Ÿæœºï¼š2G / 4G (å¯ä»¥è‡ªåŠ¨åˆ†åŒº, å¦‚æœè¶…è¿‡ 4G, åˆ™åˆ é™¤ swap åˆ†åŒº, æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª 4G çš„ swap åˆ†åŒº) å¦‚æœæ˜¯ HDD + SSDï¼Œç¦ç”¨ HDD ä¸Šçš„ swapï¼Œåœ¨ SSD ç¡¬ç›˜ä¸Šåˆ›å»º swap æ–‡ä»¶ï¼Œå¹¶æŒ‚è½½åˆ° swap åˆ†åŒºã€‚\nå¯æœ‰æ•ˆæå‡æ€§èƒ½ï¼Œç¼“è§£ OOM é—®é¢˜ã€‚ ","description":"è¿è¡Œç¯å¢ƒï¼š\nCPUï¼šIntel(R) Pentium(R) CPU G4560 @ 3.50GHz (4æ ¸) å†…å­˜ï¼š8G ç¡¬ç›˜ï¼š1T (HDD) + 500G (SSD) æ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 å®¿ä¸»æœºç¦ç”¨äº† swap åˆ†åŒºã€‚\nè¿è¡Œäº† 3 ä¸ª KVM è™šæ‹Ÿæœºï¼Œç¬¬ä¸€ä¸ªè™šæ‹Ÿæœº 2æ ¸ 4G å†…å­˜ï¼Œå…¶å®ƒä¸¤ä¸ªè™šæ‹Ÿæœº 2æ ¸ 2G å†…å­˜ã€‚\nåœ¨ç¬¬ä¸€ä¸ªè™šæ‹Ÿæœºä¸Šå®‰è£… GitLab å’Œ Jinkinsï¼Œå†…å­˜è¦æ±‚ GitLab æ˜¯ 4Gï¼ŒJinkins æ˜¯ 1Gã€‚\nå†…å­˜ä¸è¶³ï¼ŒåŠ ä¸Šç¦ç”¨äº† swapï¼Œæ‰€ä»¥ 4G çš„å†…å­˜æ— æ³•æ­£å¸¸è¿è¡Œ GitLabï¼Œç®€å•çš„ä¸€ä¸ªæ“ä½œï¼ŒGitLab å°±ä¼šæŒ‚æ‰ï¼Œæˆ–è€… KVM è™šæ‹Ÿæœºå¡æ­»ã€‚\nè§£å†³æ–¹æ³•ï¼š\næ·»åŠ  SSD ç¡¬ç›˜ å¯ç”¨ swapï¼Œå¹¶åœ¨ SSD ç¡¬ç›˜ä¸Šåˆ›å»º swap æ–‡ä»¶ å°† KVM è™šæ‹Ÿæœºé•œåƒç§»åŠ¨åˆ°åˆ° SSD ç¡¬ç›˜ æ€»ç»“ï¼š\nå®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œå¿…é¡»åˆ›å»º swap åˆ†åŒºã€‚\nç‰©ç†æœºï¼š8G (è¶…è¿‡ 8G æ„ä¹‰ä¸å¤§) è™šæ‹Ÿæœºï¼š2G / 4G (å¯ä»¥è‡ªåŠ¨åˆ†åŒº, å¦‚æœè¶…è¿‡ 4G, åˆ™åˆ é™¤ swap åˆ†åŒº, æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª 4G çš„ swap åˆ†åŒº) å¦‚æœæ˜¯ HDD + SSDï¼Œç¦ç”¨ HDD ä¸Šçš„ swapï¼Œåœ¨ SSD ç¡¬ç›˜ä¸Šåˆ›å»º swap æ–‡ä»¶ï¼Œå¹¶æŒ‚è½½åˆ° swap åˆ†åŒºã€‚\n"},{"id":462,"href":"/backend/summarize/function-parameters/","title":"å‡½æ•°å‚æ•°","parent":"Summarize","content":"JavaScript å’Œ Python çš„å‡½æ•°åœ¨å‚æ•°ä¼ é€’ä¸Šç•¥æœ‰ä¸åŒ\nPython å‡½æ•°ä¼ é€’å‚æ•°æ¯”è¾ƒçµæ´»\ndef doSomething(x, y): print(\u0026#39;x:\u0026#39;, x) print(\u0026#39;y:\u0026#39;, y) # æŒ‰é¡ºåºä¼ é€’å‚æ•° doSomething(123, \u0026#39;abc\u0026#39;) # ä½¿ç”¨å‚æ•°åç§°ä¼ é€’å‚æ•° doSomething(y=123, x=\u0026#39;abc\u0026#39;) JavaScript å‡½æ•°ä¼ é€’å‚æ•°ä¸å¦‚ Python é‚£æ ·çµæ´», JavaScript åªèƒ½ æŒ‰é¡ºåºä¼ é€’å‚æ•°, ä¸èƒ½ ä½¿ç”¨å‚æ•°åç§°ä¼ é€’å‚æ•°.\nJavaScript å¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ª Object å®ç°ç±»ä¼¼çš„åŠŸèƒ½\nfunction doSomething(obj) { var localX = obj.x || \u0026#39;Hello World\u0026#39;; var localY = obj.y || 999; console.log(localX); console.log(localY); } doSomething({ x: \u0026#39;OK\u0026#39;, y: 123 }); JavaScript ä¹Ÿå¯ä»¥é€šè¿‡ç®€å•çš„æ–¹æ³•å¿½ç•¥éƒ¨åˆ†å‚æ•°æ¥ä¼ é€’å‚æ•°\nfunction doSomething(x, y, z) { console.log(x); console.log(y); console.log(z); } var _ = undefined; doSomething(_, _, \u0026#39;Value\u0026#39;); å‚è€ƒæ–‡æ¡£:\nhttps://stackoverflow.com/a/32518672 https://stackoverflow.com/a/24596077 ","description":"JavaScript å’Œ Python çš„å‡½æ•°åœ¨å‚æ•°ä¼ é€’ä¸Šç•¥æœ‰ä¸åŒ\nPython å‡½æ•°ä¼ é€’å‚æ•°æ¯”è¾ƒçµæ´»\ndef doSomething(x, y): print(\u0026#39;x:\u0026#39;, x) print(\u0026#39;y:\u0026#39;, y) # æŒ‰é¡ºåºä¼ é€’å‚æ•° doSomething(123, \u0026#39;abc\u0026#39;) # ä½¿ç”¨å‚æ•°åç§°ä¼ é€’å‚æ•° doSomething(y=123, x=\u0026#39;abc\u0026#39;) JavaScript å‡½æ•°ä¼ é€’å‚æ•°ä¸å¦‚ Python é‚£æ ·çµæ´», JavaScript åªèƒ½ æŒ‰é¡ºåºä¼ é€’å‚æ•°, ä¸èƒ½ ä½¿ç”¨å‚æ•°åç§°ä¼ é€’å‚æ•°.\nJavaScript å¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ª Object å®ç°ç±»ä¼¼çš„åŠŸèƒ½\nfunction doSomething(obj) { var localX = obj.x || \u0026#39;Hello World\u0026#39;; var localY = obj.y || 999; console.log(localX); console.log(localY); } doSomething({ x: \u0026#39;OK\u0026#39;, y: 123 }); JavaScript ä¹Ÿå¯ä»¥é€šè¿‡ç®€å•çš„æ–¹æ³•å¿½ç•¥éƒ¨åˆ†å‚æ•°æ¥ä¼ é€’å‚æ•°\nfunction doSomething(x, y, z) { console.log(x); console.log(y); console.log(z); } var _ = undefined; doSomething(_, _, \u0026#39;Value\u0026#39;); å‚è€ƒæ–‡æ¡£:\nhttps://stackoverflow.com/a/32518672 https://stackoverflow.com/a/24596077 "},{"id":463,"href":"/operations/kvm/create-bridge/","title":"åˆ›å»ºæ¡¥æ¥ç½‘å¡","parent":"KVM","content":"ç¯å¢ƒï¼š\nç³»ç»Ÿï¼šAlmaLinux 9.7 ç½‘å¡ï¼šenp0s31f6 KVMï¼šqemu-kvm 9.1.0 ç›®æ ‡ï¼š\nåœ¨ç‰©ç†ç½‘å¡ enp0s31f6 çš„å‰æä¸‹ï¼Œåˆ›å»º br0ï¼Œå¹¶ä¸”â€œä¸ç ´åã€ä¸æ‰çº¿â€ç‰©ç†ä¸»æœºå½“å‰ç½‘ç»œ\nä¸‹é¢æ˜¯ã€Œä¸ä¸­æ–­ç½‘ç»œã€çš„æ ‡å‡†åšæ³•ï¼Œç”Ÿäº§ç¯å¢ƒå¯ç›´æ¥ç”¨çš„æ–¹æ¡ˆã€‚\nä¸€ã€æ ¸å¿ƒåŸåˆ™ï¼ˆå…ˆè®°ä½è¿™ 4 æ¡ï¼‰ ä¸ç ´åç½‘ç»œ = ä¸åŠ¨ IPã€ä¸åŠ¨ç½‘å…³ã€ä¸åŠ¨ DNSã€ä¸å¼ºåˆ¶ down ç½‘å¡\næ­£ç¡®æ¨¡å‹ï¼š\nenp0s31f6 (æ—  IPï¼Œä»… slave) â”‚ â””â”€â”€ br0 (ç»§æ‰¿åŸ enp0s31f6 çš„ IP / ç½‘å…³ / DNS) å…³é”®ç‚¹ï¼š\nâŒ enp0s31f6 ä¸å†é…ç½® IP âœ… br0 æ¥ç®¡åŸæœ‰ç½‘ç»œé…ç½® âœ… ä½¿ç”¨ NetworkManager çƒ­åˆ‡æ¢ï¼ˆä¸ä¸­æ–­ï¼‰ äºŒã€å¼€å§‹å‰ï¼šè®°å½•å½“å‰ç½‘ç»œé…ç½®ï¼ˆéå¸¸é‡è¦ï¼‰ è¿™æ˜¯â€œä¿é™©æ­¥éª¤â€ï¼Œé˜²æ­¢è¯¯æ“ä½œ\nnmcli device show enp0s31f6 GENERAL.DEVICE: enp0s31f6 GENERAL.TYPE: ethernet GENERAL.HWADDR: 4C:ED:FB:6B:D7:F7 GENERAL.MTU: 1500 GENERAL.STATE: 100 (connected) GENERAL.CONNECTION: enp0s31f6 GENERAL.CON-PATH: /org/freedesktop/NetworkManager/ActiveConnection/2 WIRED-PROPERTIES.CARRIER: on IP4.ADDRESS[1]: 192.168.101.200/24 IP4.GATEWAY: 192.168.101.1 IP4.ROUTE[1]: dst = 192.168.101.0/24, nh = 0.0.0.0, mt = 100 IP4.ROUTE[2]: dst = 0.0.0.0/0, nh = 192.168.101.1, mt = 100 IP4.DNS[1]: 223.5.5.5 IP4.DNS[2]: 223.6.6.6 IP6.GATEWAY: -- é‡ç‚¹è®°ä½ï¼š\nIP4.ADDRESS IP4.GATEWAY IP4.DNS ä¸‰ã€ä¸ä¸­æ–­ç½‘ç»œåˆ›å»ºæ¡¥æ¥ï¼ˆæ¨èåšæ³•ï¼‰ æ•´ä¸ªè¿‡ç¨‹ä¸ä¼šæ–­ç½‘\n1ï¸âƒ£ åˆ›å»º br0ï¼ˆå…ˆåˆ›å»ºï¼Œä¸å¯ç”¨ï¼‰ nmcli con add type bridge ifname br0 con-name br0 2ï¸âƒ£ å°† enp0s31f6 åŠ å…¥ br0ï¼ˆä½œä¸º slaveï¼‰ nmcli con add type ethernet ifname enp0s31f6 master br0 con-name br0-slave-enp0s31f6 âš ï¸ æ³¨æ„ï¼šæ­¤æ—¶ enp0s31f6 ä»ç„¶åœ¨çº¿ï¼Œä¸ä¼šæ–­ç½‘\n3ï¸âƒ£ æŠŠåŸ enp0s31f6 çš„ç½‘ç»œé…ç½®è¿ç§»ç»™ br0 ç”¨åˆšæ‰è®°å½•çš„ä¿¡æ¯æ›¿æ¢\nnmcli con modify br0 \\ ipv4.method manual \\ ipv4.addresses 192.168.101.200/24 \\ ipv4.gateway 192.168.101.1 \\ ipv4.dns \u0026#34;223.5.5.5 223.6.6.6\u0026#34; nmcli con modify br0 ipv6.method disabled 4ï¸âƒ£ ç¦ç”¨ enp0s31f6 çš„ç‹¬ç«‹ IPï¼ˆå…³é”®ä½†å®‰å…¨ï¼‰ nmcli con modify br0-slave-enp0s31f6 ipv4.method disabled nmcli con modify br0-slave-enp0s31f6 ipv6.method disabled 5ï¸âƒ£ å¹³æ»‘åˆ‡æ¢ï¼ˆå…³é”®æ­¥éª¤ï¼Œä¸ä¼šæ‰çº¿ï¼‰ nmcli con up br0 nmcli con up br0-slave-enp0s31f6 NetworkManager ä¼šï¼š\næŠŠ IP ä» enp0s31f6 è½¬ç§»åˆ° br0 å†…æ ¸ bridge çƒ­ç”Ÿæ•ˆ è¿æ¥ä¸ä¸­æ–­ 6ï¸âƒ£ åˆ é™¤åŸæ¥çš„ enp0s31f6 ç‹¬ç«‹è¿æ¥ï¼ˆæ¸…ç†ï¼‰ æŸ¥çœ‹ connection\nnmcli con show åˆ é™¤ connectionï¼ˆåªåˆ  connectionï¼Œä¸åˆ è®¾å¤‡ï¼‰ï¼š\nnmcli con delete enp0s31f6 å››ã€è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ï¼ˆå¿…é¡»ï¼‰ nmcli con modify br0 connection.autoconnect yes nmcli con modify br0-slave-enp0s31f6 connection.autoconnect yes æé«˜ä¼˜å…ˆçº§ï¼š\nnmcli con modify br0 connection.autoconnect-priority 10 nmcli con modify br0-slave-enp0s31f6 connection.autoconnect-priority 5 äº”ã€éªŒè¯ï¼ˆä¸€å®šè¦æ£€æŸ¥ï¼‰ æŸ¥çœ‹çŠ¶æ€\nnmcli device status æ­£ç¡®ç»“æœï¼š\nDEVICE TYPE STATE CONNECTION br0 bridge connected br0 enp0s31f6 ethernet connected br0-slave-enp0s31f6 æŸ¥çœ‹IP\nip addr âœ… IP åœ¨ br0 âœ… enp0s31f6 æ²¡æœ‰ IP å…­ã€KVM / libvirt ä½¿ç”¨æ–¹å¼ï¼ˆç°åœ¨å¯ä»¥äº†ï¼‰ ç”¨å‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºæ—¶ï¼š\n--network bridge=br0 åœ¨ Cockpit ä¸­ï¼š\nè¿›å…¥æŒ‡å®šçš„è™šæ‹Ÿæœºæ§åˆ¶å° ç½‘ç»œæ¥å£ -\u0026gt; ç¼–è¾‘ æ¥å£ç±»å‹: Bridge to LAN æº: br0 ä¸ƒã€å¸¸è§å¤±è´¥åŸå› ï¼ˆä¸€å®šè¦é¿ï¼‰ âŒ ç›´æ¥ down enp0s31f6 âŒ å…ˆåˆ åŸè¿æ¥å†å»º bridge âŒ IP åŒæ—¶å­˜åœ¨ enp0s31f6 å’Œ br0 âŒ å¿˜è®°è®¾ç½® autoconnect âŒ SSH è¿œç¨‹æ“ä½œå´æ²¡ç•™å›æ»šæ–¹æ¡ˆ å…«ã€ç´§æ€¥å›æ»šï¼ˆå¦‚æœä½ æ‰‹æ»‘äº†ï¼‰ nmcli con down br0 nmcli con up enp0s31f6 æˆ–é‡å¯ NMï¼š\nsystemctl restart NetworkManager ","description":"ç¯å¢ƒï¼š\nç³»ç»Ÿï¼šAlmaLinux 9.7 ç½‘å¡ï¼šenp0s31f6 KVMï¼šqemu-kvm 9.1.0 ç›®æ ‡ï¼š\nåœ¨ç‰©ç†ç½‘å¡ enp0s31f6 çš„å‰æä¸‹ï¼Œåˆ›å»º br0ï¼Œå¹¶ä¸”â€œä¸ç ´åã€ä¸æ‰çº¿â€ç‰©ç†ä¸»æœºå½“å‰ç½‘ç»œ\nä¸‹é¢æ˜¯ã€Œä¸ä¸­æ–­ç½‘ç»œã€çš„æ ‡å‡†åšæ³•ï¼Œç”Ÿäº§ç¯å¢ƒå¯ç›´æ¥ç”¨çš„æ–¹æ¡ˆã€‚\nä¸€ã€æ ¸å¿ƒåŸåˆ™ï¼ˆå…ˆè®°ä½è¿™ 4 æ¡ï¼‰ ä¸ç ´åç½‘ç»œ = ä¸åŠ¨ IPã€ä¸åŠ¨ç½‘å…³ã€ä¸åŠ¨ DNSã€ä¸å¼ºåˆ¶ down ç½‘å¡\næ­£ç¡®æ¨¡å‹ï¼š\nenp0s31f6 (æ—  IPï¼Œä»… slave) â”‚ â””â”€â”€ br0 (ç»§æ‰¿åŸ enp0s31f6 çš„ IP / ç½‘å…³ / DNS) å…³é”®ç‚¹ï¼š\nâŒ enp0s31f6 ä¸å†é…ç½® IP âœ… br0 æ¥ç®¡åŸæœ‰ç½‘ç»œé…ç½® âœ… ä½¿ç”¨ NetworkManager çƒ­åˆ‡æ¢ï¼ˆä¸ä¸­æ–­ï¼‰ äºŒã€å¼€å§‹å‰ï¼šè®°å½•å½“å‰ç½‘ç»œé…ç½®ï¼ˆéå¸¸é‡è¦ï¼‰ è¿™æ˜¯â€œä¿é™©æ­¥éª¤â€ï¼Œé˜²æ­¢è¯¯æ“ä½œ\n"},{"id":464,"href":"/backend/python/sqlalchemy/check-if-exists/","title":"åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨","parent":"SQLAlchemy","content":"ä¸‹é¢ç»™ä½  PostgreSQL + SQLAlchemy 2.0 ä¸‹å¸¸ç”¨çš„ â€œåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨â€ çš„æœ€ä½³å®è·µï¼Œåˆ†åˆ«åŒ…å«ï¼š\nâœ… åŸç”Ÿ SQL æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ âœ… ORM æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ âœ… æ¨èå†™æ³•ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰ âŒ ä½æ•ˆå†™æ³•ï¼ˆé¿å…ï¼‰ âœ… ä¸€ã€ä½¿ç”¨ åŸç”Ÿ SQL åˆ¤æ–­æ˜¯å¦å­˜åœ¨ 1.1 ä½¿ç”¨ EXISTSï¼ˆæ€§èƒ½æœ€ä½³ï¼‰ SELECT EXISTS ( SELECT 1 FROM users WHERE email = \u0026#39;test@example.com\u0026#39; ); è¿”å›ï¼š\nexists true 1.2 åªå–ä¸€è¡Œæ¥åˆ¤æ–­ï¼ˆæ¬¡ä¼˜ï¼‰ SELECT 1 FROM users WHERE email = \u0026#39;test@example.com\u0026#39; LIMIT 1; å¦‚æœè¿”å›è¡Œ -\u0026gt; å­˜åœ¨ å¦‚æœæ— è¿”å› -\u0026gt; ä¸å­˜åœ¨ âœ… äºŒã€SQLAlchemy 2.0 ORM åˆ¤æ–­æ˜¯å¦å­˜åœ¨ 2.1 ä½¿ç”¨ select + exists()ï¼ˆå®˜æ–¹æ¨èï¼‰ from sqlalchemy import select, exists from models import User stmt = select( exists().where(User.email == \u0026#34;test@example.com\u0026#34;) ) result = await session.scalar(stmt) print(result) # True / False ç‰¹ç‚¹ï¼š\nä¸è¿”å›å®ä½“ï¼Œä¸æ‰«æå…¨è¡¨ æ€§èƒ½æœ€å¥½ PostgreSQL ä¼šç”¨ EXISTS(\u0026hellip;) æ‰§è¡Œ 2.2 ä½¿ç”¨ select(1).where(\u0026hellip;).limit(1) stmt = select(1).where(User.email == \u0026#34;test@example.com\u0026#34;).limit(1) exists_ = await session.scalar(stmt) is not None âœ… ä¸‰ã€åˆ¤æ–­æ•°æ®å­˜åœ¨å¹¶è¿”å›æ•°æ® å¦‚æœéœ€è¦ã€Œåˆ¤æ–­å­˜åœ¨ä¸”è·å–å…·ä½“è¡Œã€ï¼Œç”¨ï¼š\n3.1 .first() stmt = select(User).where(User.email == \u0026#34;test@example.com\u0026#34;) row = await session.scalar(stmt) if row: print(\u0026#34;å­˜åœ¨\u0026#34;, row) else: print(\u0026#34;ä¸å­˜åœ¨\u0026#34;) 3.2 .one_or_none() æ›´ä¸¥æ ¼çš„å†™æ³•ï¼š\nrow = await session.scalar(select(User).where(User.id == 1)) if row is None: print(\u0026#34;ä¸å­˜åœ¨\u0026#34;) else: print(\u0026#34;å­˜åœ¨\u0026#34;) âŒ å››ã€ä½æ•ˆå†™æ³•ï¼ˆä¸è¦è¿™æ ·åšï¼‰ 4.1 ä¸åº”è¯¥ count å…¨éƒ¨æ•°æ® stmt = select(func.count()).where(User.email == \u0026#34;test@example.com\u0026#34;) count = await session.scalar(stmt) exists = count \u0026gt; 0 âš ï¸ æ€§èƒ½å·®ï¼Œå› ä¸º COUNT ä¼šæ‰«ææ»¡è¶³æ¡ä»¶çš„å…¨éƒ¨è¡Œã€‚\nğŸ”¥ äº”ã€æ€»ç»“ PostgreSQL ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œç”¨ EXISTS æ˜¯æ€§èƒ½æœ€ä¼˜ SQLAlchemy 2.0 ä¸­ç”¨ select(exists().where(\u0026hellip;)) ğŸ§© ç¤ºä¾‹ï¼šå°è£…ä¸€ä¸ªé€šç”¨çš„ exists() å·¥å…·å‡½æ•° æ”¯æŒ ORM model ä¸ä»»æ„ where æ¡ä»¶ã€‚\nfrom sqlalchemy import exists, select from sqlalchemy.ext.asyncio import AsyncSession async def exists_row(session: AsyncSession, model, *conditions) -\u0026gt; bool: stmt = select(exists().where(*conditions)) return await session.scalar(stmt) ä½¿ç”¨ï¼š exists_ = await exists_row( session, User, User.email == \u0026#34;test@example.com\u0026#34; ) print(exists_) # True / False ","description":"ä¸‹é¢ç»™ä½  PostgreSQL + SQLAlchemy 2.0 ä¸‹å¸¸ç”¨çš„ â€œåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨â€ çš„æœ€ä½³å®è·µï¼Œåˆ†åˆ«åŒ…å«ï¼š\nâœ… åŸç”Ÿ SQL æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ âœ… ORM æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ âœ… æ¨èå†™æ³•ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰ âŒ ä½æ•ˆå†™æ³•ï¼ˆé¿å…ï¼‰ âœ… ä¸€ã€ä½¿ç”¨ åŸç”Ÿ SQL åˆ¤æ–­æ˜¯å¦å­˜åœ¨ 1.1 ä½¿ç”¨ EXISTSï¼ˆæ€§èƒ½æœ€ä½³ï¼‰ SELECT EXISTS ( SELECT 1 FROM users WHERE email = \u0026#39;test@example.com\u0026#39; ); è¿”å›ï¼š\n"},{"id":465,"href":"/management/operations/release-system/","title":"å‘å¸ƒç³»ç»Ÿ","parent":"Operations","content":"ã€Œå‘å¸ƒç³»ç»Ÿï¼ˆå‘å¸ƒæ–¹å¼ / å‘å¸ƒå¹³å° / å‘å¸ƒæ¶æ„ï¼‰çš„å®Œæ•´å½’çº³æ€»ç»“ã€ï¼Œä» ä¼ ç»Ÿ -\u0026gt; è‡ªåŠ¨åŒ– -\u0026gt; äº‘åŸç”Ÿ -\u0026gt; å¤§è§„æ¨¡äº’è”ç½‘ å…¨è¦†ç›–ï¼Œé€‚åˆä½œä¸ºè¿ç»´/å¹³å°/æ¶æ„çŸ¥è¯†ä½“ç³»ã€‚\nå‘å¸ƒç³»ç»Ÿ = ä»£ç  / åˆ¶å“ -\u0026gt; ç›®æ ‡ç¯å¢ƒ -\u0026gt; å®‰å…¨ã€å¯æ§ã€å¯å›æ»šåœ°ä¸Šçº¿\nä¸€ã€æŒ‰â€œæŠ€æœ¯å½¢æ€â€åˆ†ç±»ï¼ˆæœ€å¸¸è§ï¼‰ 1ï¸âƒ£ æ‰‹å·¥å‘å¸ƒï¼ˆæœ€åŸå§‹ï¼‰ æ–¹å¼\nssh ç™»å½•æœåŠ¡å™¨ git pull / scp / rsync æ‰‹åŠ¨ restart æœåŠ¡ ç‰¹ç‚¹\nç®€å• é£é™©æé«˜ ä¸å¯å®¡è®¡ã€ä¸å¯å›æ»š é€‚ç”¨\nä¸ªäººé¡¹ç›® / éç”Ÿäº§ç¯å¢ƒ âŒ ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆä¸æ¨è\n2ï¸âƒ£ è„šæœ¬åŒ–å‘å¸ƒ æ–¹å¼\nShell / Python è„šæœ¬ rsync + systemctl è‡ªå®šä¹‰å‘å¸ƒè„šæœ¬ ç‰¹ç‚¹\næœ‰ä¸€å®šæ ‡å‡†åŒ– ä¾èµ–äººå·¥è§¦å‘ è„šæœ¬è´¨é‡å†³å®šç¨³å®šæ€§ é€‚ç”¨\nå°å›¢é˜Ÿ ä¼ ç»ŸæœåŠ¡å™¨æ¶æ„ 3ï¸âƒ£ CI/CD å‘å¸ƒç³»ç»Ÿï¼ˆä¸»æµï¼‰ å¸¸è§ç³»ç»Ÿ\nJenkins GitLab CI/CD GitHub Actions Gitea Actions æµç¨‹\nä»£ç æäº¤ -\u0026gt; æ„å»º -\u0026gt; æµ‹è¯• -\u0026gt; åˆ¶å“ç”Ÿæˆ -\u0026gt; å‘å¸ƒ -\u0026gt; å¥åº·æ£€æŸ¥ -\u0026gt; å›æ»šï¼ˆå¤±è´¥ï¼‰ ç‰¹ç‚¹\nè‡ªåŠ¨åŒ– å¯å®¡è®¡ å¯å›æ»š æ”¯æŒå¤šç¯å¢ƒ é€‚ç”¨\nä¸­å¤§å‹å›¢é˜Ÿ å¾®æœåŠ¡ âœ… ç›®å‰æœ€å¸¸è§\näºŒã€æŒ‰â€œå‘å¸ƒç­–ç•¥â€åˆ†ç±»ï¼ˆé‡ç‚¹ï¼‰ 4ï¸âƒ£ æ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰ ç‰¹ç‚¹\né€å°æ›´æ–° ä¸åœæœº å‘å¸ƒæ…¢ä½†ç¨³å®š é€‚ç”¨\nKubernetes Deployment æ— çŠ¶æ€æœåŠ¡ 5ï¸âƒ£ è“ç»¿å‘å¸ƒï¼ˆBlue-Greenï¼‰ ç‰¹ç‚¹\næ–°æ—§ä¸¤å¥—ç¯å¢ƒ ä¸€æ¬¡åˆ‡æ¢ å›æ»šæå¿« é€‚ç”¨\né‡è¦æ ¸å¿ƒç³»ç»Ÿ å¯¹ç¨³å®šæ€§è¦æ±‚é«˜ 6ï¸âƒ£ é‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰ ç‰¹ç‚¹\nå°æµé‡éªŒè¯ ç°åº¦å‘å¸ƒ é£é™©å¯æ§ é€‚ç”¨\nç”¨æˆ·é‡å¤§ æ–°åŠŸèƒ½é£é™©é«˜ 7ï¸âƒ£ A/B å‘å¸ƒ ç‰¹ç‚¹\nå¤šç‰ˆæœ¬å¹¶è¡Œ å¯¹æ¯”æ•ˆæœ å¸¸ç”¨äºäº§å“å®éªŒ ä¸‰ã€æŒ‰â€œéƒ¨ç½²è½½ä½“â€åˆ†ç±»ï¼ˆéå¸¸é‡è¦ï¼‰ 8ï¸âƒ£ ä¼ ç»ŸæœåŠ¡å™¨å‘å¸ƒç³»ç»Ÿ æ–¹å¼\nå‘å¸ƒåˆ°ç‰©ç†æœº / è™šæ‹Ÿæœº systemd ç®¡ç†æœåŠ¡ å¸¸è§æ–¹æ¡ˆ\nJenkins + SSH Ansible SaltStack 9ï¸âƒ£ å®¹å™¨å‘å¸ƒç³»ç»Ÿ æ–¹å¼\nDocker é•œåƒ å®¹å™¨è¿è¡Œ ç‰¹ç‚¹\nç¯å¢ƒä¸€è‡´ æ˜“å›æ»š ğŸ”Ÿ Kubernetes å‘å¸ƒç³»ç»Ÿï¼ˆäº‘åŸç”Ÿï¼‰ å¸¸è§å·¥å…·\nkubectl apply Helm Kustomize Argo CD Flux ç‰¹ç‚¹\nå£°æ˜å¼ è‡ªåŠ¨å›æ»š ä¸èµ„æºè°ƒåº¦æ·±åº¦ç»“åˆ âœ… äº‘åŸç”Ÿä¸»æµ\nå››ã€æŒ‰â€œå‘å¸ƒæ§åˆ¶æ¨¡å¼â€åˆ†ç±» 1ï¸âƒ£1ï¸âƒ£ Push æ¨¡å¼ï¼ˆæ¨é€å¼ï¼‰ ç‰¹ç‚¹\nCI ä¸»åŠ¨éƒ¨ç½² Jenkins -\u0026gt; æœåŠ¡å™¨/K8S ä¼˜ç‚¹\nç®€å•ç›´æ¥ ç¼ºç‚¹\nCI æƒé™å¤§ å®‰å…¨é£é™©é«˜ 1ï¸âƒ£2ï¸âƒ£ Pull æ¨¡å¼ï¼ˆæ‹‰å–å¼ / GitOpsï¼‰ ä»£è¡¨\nArgo CD Flux ç‰¹ç‚¹\né›†ç¾¤ä¸»åŠ¨æ‹‰é…ç½® Git å³çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰ ä¼˜ç‚¹\næ›´å®‰å…¨ æ˜“å®¡è®¡ æ˜“å›æ»š âœ… K8S æ¨è\näº”ã€æŒ‰â€œå‘å¸ƒå†…å®¹â€åˆ†ç±» 1ï¸âƒ£3ï¸âƒ£ ä»£ç å‘å¸ƒ åç«¯ä»£ç  å‰ç«¯ä»£ç  1ï¸âƒ£4ï¸âƒ£ é…ç½®å‘å¸ƒ é…ç½®å˜æ›´ Feature Toggle ConfigMap / Secret âš ï¸ é…ç½®å‘å¸ƒ â‰  ä»£ç å‘å¸ƒ\n1ï¸âƒ£5ï¸âƒ£ æ•°æ®åº“å‘å¸ƒ SQL å˜æ›´ è¡¨ç»“æ„å˜æ›´ æ•°æ®è¿ç§» å¸¸è§å·¥å…·\nFlyway Liquibase è‡ªç ” DB å‘å¸ƒç³»ç»Ÿ å…­ã€æŒ‰â€œç³»ç»Ÿå½¢æ€â€åˆ†ç±»ï¼ˆä¼ä¸šçº§ï¼‰ 1ï¸âƒ£6ï¸âƒ£ è‡ªç ”å‘å¸ƒç³»ç»Ÿ ç‰¹ç‚¹\næ·±åº¦å®šåˆ¶ æƒé™ç»† ä¸å…¬å¸æµç¨‹ç»‘å®š å¸¸è§èƒ½åŠ›\nå·¥å• å®¡æ‰¹ å¤šç¯å¢ƒ é£é™©è¯„ä¼° è‡ªåŠ¨å›æ»š 1ï¸âƒ£7ï¸âƒ£ å‘å¸ƒå¹³å° / DevOps å¹³å° å…¸å‹èƒ½åŠ›\nCI/CD ç¯å¢ƒç®¡ç† åˆ¶å“åº“ æƒé™å®¡è®¡ å‘å¸ƒè®°å½• SLA ç»Ÿè®¡ ä¸ƒã€å‘å¸ƒç³»ç»Ÿæ ¸å¿ƒèƒ½åŠ›æ¸…å•ï¼ˆè¯„åˆ¤æ ‡å‡†ï¼‰ ä¸€ä¸ªåˆæ ¼çš„å‘å¸ƒç³»ç»Ÿå¿…é¡»å…·å¤‡ï¼š\nå¤šç¯å¢ƒï¼ˆdev/test/stage/prodï¼‰ å‘å¸ƒç­–ç•¥ï¼ˆæ»šåŠ¨/è“ç»¿/é‡‘ä¸é›€ï¼‰ æƒé™æ§åˆ¶ï¼ˆRBACï¼‰ å®¡è®¡æ—¥å¿— å¤±è´¥è‡ªåŠ¨å›æ»š å¥åº·æ£€æŸ¥ ç°åº¦èƒ½åŠ› é…ç½®ä¸ä»£ç è§£è€¦ æ”¯æŒæ•°æ®åº“å˜æ›´ æ”¯æŒç´§æ€¥å›æ»š æ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰ å‘å¸ƒç³»ç»Ÿçš„è¿›åŒ–è·¯å¾„ï¼š\næ‰‹å·¥ -\u0026gt; è„šæœ¬ -\u0026gt; CI/CD -\u0026gt; å®¹å™¨åŒ– -\u0026gt; Kubernetes -\u0026gt; GitOps -\u0026gt; å¹³å°åŒ– / è‡ªç ” ","description":"ã€Œå‘å¸ƒç³»ç»Ÿï¼ˆå‘å¸ƒæ–¹å¼ / å‘å¸ƒå¹³å° / å‘å¸ƒæ¶æ„ï¼‰çš„å®Œæ•´å½’çº³æ€»ç»“ã€ï¼Œä» ä¼ ç»Ÿ -\u0026gt; è‡ªåŠ¨åŒ– -\u0026gt; äº‘åŸç”Ÿ -\u0026gt; å¤§è§„æ¨¡äº’è”ç½‘ å…¨è¦†ç›–ï¼Œé€‚åˆä½œä¸ºè¿ç»´/å¹³å°/æ¶æ„çŸ¥è¯†ä½“ç³»ã€‚\nå‘å¸ƒç³»ç»Ÿ = ä»£ç  / åˆ¶å“ -\u0026gt; ç›®æ ‡ç¯å¢ƒ -\u0026gt; å®‰å…¨ã€å¯æ§ã€å¯å›æ»šåœ°ä¸Šçº¿\nä¸€ã€æŒ‰â€œæŠ€æœ¯å½¢æ€â€åˆ†ç±»ï¼ˆæœ€å¸¸è§ï¼‰ 1ï¸âƒ£ æ‰‹å·¥å‘å¸ƒï¼ˆæœ€åŸå§‹ï¼‰ æ–¹å¼\nssh ç™»å½•æœåŠ¡å™¨ git pull / scp / rsync æ‰‹åŠ¨ restart æœåŠ¡ ç‰¹ç‚¹\n"},{"id":466,"href":"/management/operations/release-system-design/","title":"å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒæ¶æ„è®¾è®¡ä¸å®ç°","parent":"Operations","content":"ã€Œæ»šåŠ¨ / è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ å‘å¸ƒçš„æ¶æ„è®¾è®¡ä¸å®ç°æ€»è§ˆã€ã€‚\nç”¨ ç»Ÿä¸€çš„æ¶æ„è§†è§’ æ¥è®²ï¼šæµé‡åœ¨å“ªåˆ‡ã€ç‰ˆæœ¬å¦‚ä½•å…±å­˜ã€å¦‚ä½•å›æ»šã€å¦‚ä½•è½åœ°å®ç°ã€‚\nä¸€ã€ç»Ÿä¸€æ¶æ„æŠ½è±¡ï¼ˆå…ˆç«‹æ¨¡å‹ï¼‰ æ— è®ºå“ªç§å‘å¸ƒæ–¹å¼ï¼Œæœ¬è´¨éƒ½æ˜¯ 4 å±‚ç»“æ„ï¼š\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç”¨æˆ·æµé‡ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æµé‡æ§åˆ¶å±‚ â”‚ â† å…³é”® â”‚ (LB / Ingress / GW) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ åº”ç”¨è¿è¡Œå±‚ â”‚ â”‚ (å¤šç‰ˆæœ¬å®ä¾‹å…±å­˜) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æ•°æ®ä¸ä¾èµ–å±‚ â”‚ â”‚ (DB / Cache / MQ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ‘‰ åŒºåˆ«åªåœ¨ï¼š\næ˜¯å¦å¤šç‰ˆæœ¬å…±å­˜ æµé‡å¦‚ä½•åˆ‡ åˆ‡æµæ˜¯å¦åŸå­ å›æ»šæˆæœ¬ äºŒã€æ»šåŠ¨å‘å¸ƒï¼ˆRollingï¼‰â€”â€”æœ€åŸºç¡€å®ç° æ¶æ„è®¾è®¡\nLB â”‚ â”œâ”€ Pod v1 â”œâ”€ Pod v1 â”œâ”€ Pod v2 â† æ–°ç‰ˆæœ¬é€æ­¥æ›¿æ¢ â””â”€ Pod v1 å…³é”®ç‰¹å¾\næ— å¤šç‰ˆæœ¬æµé‡æ§åˆ¶ ç‰ˆæœ¬é€šè¿‡â€œå®ä¾‹æ›¿æ¢â€å®Œæˆ å¯¹ç”¨æˆ·é€æ˜ å®ç°æ–¹å¼ Kubernetes\nstrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 æ ¸å¿ƒå®ç°ç‚¹\nreadinessProbe æ§åˆ¶æ¥æµé‡ ä¼˜é›…å…³é—­ï¼ˆSIGTERMï¼‰ æ»šåŠ¨èŠ‚å¥æ§åˆ¶ å›æ»š\né‡æ–° rollout åˆ°æ—§ç‰ˆæœ¬ æˆæœ¬ï¼šä¸­ç­‰ï¼ˆéœ€è¦æ—¶é—´ï¼‰ ä¸‰ã€è“ç»¿å‘å¸ƒï¼ˆBlue-Greenï¼‰â€”â€”åŒç¯å¢ƒåˆ‡æµ æ¶æ„è®¾è®¡\nLB â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ è“ç¯å¢ƒ v1 ç»¿ç¯å¢ƒ v2 å…³é”®ç‰¹å¾\nä¸¤å¥—å®Œæ•´ç¯å¢ƒ ä¸€æ¬¡åˆ‡æµ å•ä¸€ç‰ˆæœ¬å¯¹å¤–æœåŠ¡ å®ç°æ–¹å¼ K8S ç¤ºä¾‹\nä¸¤ä¸ª Deploymentï¼šapp-blue / app-green ä¸€ä¸ª Service åˆ‡æ¢ Service selector æˆ– Ingress backend å›æ»š\nç§’çº§åˆ‡å› é£é™©æä½ å››ã€é‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰â€”â€”å°æµé‡è¯•è¿è¡Œ æ¶æ„è®¾è®¡\nLB / Gateway â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ Stable v1 (95%) Canary v2 (5%) å…³é”®ç‰¹å¾\nå¤šç‰ˆæœ¬å¹¶å­˜ æŒ‰æµé‡æ¯”ä¾‹ å®æ—¶è§‚å¯Ÿ å®ç°æ–¹å¼ ç½‘å…³å±‚\nNginx upstream æƒé‡ Ingress annotations Service Meshï¼ˆé«˜çº§ï¼‰\nIstio VirtualService ç²¾ç»†åˆ°è¯·æ±‚çº§åˆ« å›æ»š\næƒé‡ -\u0026gt; 0 æå¿« äº”ã€ç°åº¦å‘å¸ƒï¼ˆGrayï¼‰â€”â€”ç­–ç•¥æ€»ç§°ï¼ˆæœ€çµæ´»ï¼‰ æ¶æ„è®¾è®¡ï¼ˆç­–ç•¥åŒ–ï¼‰\nGateway â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ ç”¨æˆ·A ç”¨æˆ·B ç”¨æˆ·C v2 v1 v2 æ ¸å¿ƒç‰¹å¾\nè§„åˆ™é©±åŠ¨ ç”¨æˆ·ç»´åº¦ é•¿æœŸå¤šç‰ˆæœ¬ å®ç°æ–¹å¼ 1ï¸âƒ£ ç½‘å…³è§„åˆ™ Header / Cookie / UID åœ°åŸŸ / IP 2ï¸âƒ£ åº”ç”¨å†… Feature Toggle é…ç½®ä¸­å¿ƒ åŠ¨æ€å¼€å…³ 3ï¸âƒ£ Service Mesh æ ‡ç­¾è·¯ç”± å¤šæ¡ä»¶ç»„åˆ å›æ»š\nè§„åˆ™æ’¤é”€ æ— éœ€å›æ»šä»£ç  å…­ã€å››ç§å‘å¸ƒæ–¹å¼å¯¹æ¯”ï¼ˆæ¶æ„è§†è§’ï¼‰ ç»´åº¦ æ»šåŠ¨ è“ç»¿ é‡‘ä¸é›€ ç°åº¦ å¤šç‰ˆæœ¬å…±å­˜ âŒ âŒ âœ… âœ… æµé‡æ§åˆ¶ âŒ åŸå­ æ¯”ä¾‹ è§„åˆ™ å›æ»šé€Ÿåº¦ ä¸­ ç§’çº§ å¿« æå¿« å®ç°å¤æ‚åº¦ ä½ ä¸­ é«˜ æœ€é«˜ æˆæœ¬ ä½ é«˜ ä¸­ ä¸­ ä¸ƒã€ç»Ÿä¸€çš„å‘å¸ƒç³»ç»Ÿè®¾è®¡ï¼ˆæ¨èæ¶æ„ï¼‰ Git â†“ CI/CD â†“ åˆ¶å“åº“ â†“ éƒ¨ç½²å±‚ï¼ˆK8S / VMï¼‰ â†“ æµé‡æ²»ç†ï¼ˆIngress / Gateway / Meshï¼‰ â†“ ç›‘æ§ \u0026amp; è‡ªåŠ¨å›æ»š å‘å¸ƒç­–ç•¥ = å‚æ•°åŒ–é…ç½®\nå…«ã€æ•°æ®åº“ \u0026amp; çŠ¶æ€è®¾è®¡ï¼ˆæœ€å®¹æ˜“ç¿»è½¦ï¼‰ æ‰€æœ‰å‘å¸ƒæ–¹å¼ å¿…é¡»æ»¡è¶³ï¼š\nå‘å‰å…¼å®¹ ä¸¤é˜¶æ®µå‘å¸ƒ ç¦æ­¢ç ´åæ€§å˜æ›´ æ•°æ®è¿ç§»ç‹¬ç«‹æ‰§è¡Œ ä¹ã€è‡ªåŠ¨å›æ»šè®¾è®¡ï¼ˆé«˜çº§ï¼‰ è§¦å‘æ¡ä»¶ï¼š\né”™è¯¯ç‡ â†‘ å»¶è¿Ÿ â†‘ æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡ â†“ å®ç°ï¼š\nPrometheus + Alertmanager CI/CD å›æ»šé’©å­ Service Mesh åŠ¨æ€æƒé‡ åã€é€‰å‹å†³ç­–æ ‘ï¼ˆéå¸¸å®ç”¨ï¼‰ æ˜¯å¦å…è®¸åŒç¯å¢ƒï¼Ÿ â”œâ”€ æ˜¯ -\u0026gt; è“ç»¿ â””â”€ å¦ â”œâ”€ æ˜¯å¦æ”¯æŒç²¾ç»†æµé‡ï¼Ÿ â”‚ â”œâ”€ æ˜¯ -\u0026gt; é‡‘ä¸é›€ / ç°åº¦ â”‚ â””â”€ å¦ -\u0026gt; æ»šåŠ¨ æ€»ç»“ï¼ˆç»™æ¶æ„è®¾è®¡ç”¨ï¼‰ æ»šåŠ¨è§£å†³â€œä¸åœæœºâ€\nè“ç»¿è§£å†³â€œå¯å›æ»šâ€\né‡‘ä¸é›€è§£å†³â€œå…ˆéªŒè¯â€\nç°åº¦è§£å†³â€œå¯æ§é£é™©â€\n","description":"ã€Œæ»šåŠ¨ / è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ å‘å¸ƒçš„æ¶æ„è®¾è®¡ä¸å®ç°æ€»è§ˆã€ã€‚\nç”¨ ç»Ÿä¸€çš„æ¶æ„è§†è§’ æ¥è®²ï¼šæµé‡åœ¨å“ªåˆ‡ã€ç‰ˆæœ¬å¦‚ä½•å…±å­˜ã€å¦‚ä½•å›æ»šã€å¦‚ä½•è½åœ°å®ç°ã€‚\nä¸€ã€ç»Ÿä¸€æ¶æ„æŠ½è±¡ï¼ˆå…ˆç«‹æ¨¡å‹ï¼‰ æ— è®ºå“ªç§å‘å¸ƒæ–¹å¼ï¼Œæœ¬è´¨éƒ½æ˜¯ 4 å±‚ç»“æ„ï¼š\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç”¨æˆ·æµé‡ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æµé‡æ§åˆ¶å±‚ â”‚ â† å…³é”® â”‚ (LB / Ingress / GW) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ åº”ç”¨è¿è¡Œå±‚ â”‚ â”‚ (å¤šç‰ˆæœ¬å®ä¾‹å…±å­˜) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æ•°æ®ä¸ä¾èµ–å±‚ â”‚ â”‚ (DB / Cache / MQ) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ğŸ‘‰ åŒºåˆ«åªåœ¨ï¼š\n"},{"id":467,"href":"/management/operations/release-system-strategy/","title":"å‘å¸ƒç³»ç»Ÿï¼šå‘å¸ƒç­–ç•¥","parent":"Operations","content":"æ»šåŠ¨ / è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ åœ¨ Kubernetes \u0026amp; Nginx ä¸­çš„è¯¦ç»†è½åœ°æ“ä½œæŒ‡å—ã€‚\nä¸€ã€æ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰ âœ… Kubernetes ä¸­çš„æ»šåŠ¨å‘å¸ƒï¼ˆæœ€æ ‡å‡†ï¼‰ 1ï¸âƒ£ Deployment é…ç½® apiVersion: apps/v1 kind: Deployment metadata: name: app spec: replicas: 5 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 template: spec: terminationGracePeriodSeconds: 30 containers: - name: app image: app:v2 readinessProbe: httpGet: path: /health port: 8080 2ï¸âƒ£ æ‰§è¡Œå‘å¸ƒ kubectl set image deployment/app app=app:v2 kubectl rollout status deployment/app 3ï¸âƒ£ å›æ»š kubectl rollout undo deployment/app ğŸ“Œ å…³é”®ç‚¹\nreadinessProbe å†³å®šæ˜¯å¦æ¥æµé‡ ä¼˜é›…å…³é—­é˜²æ­¢è¯·æ±‚ä¸­æ–­ ä¸æ”¯æŒçœŸæ­£ç°åº¦ âŒ Nginx ä¸­ä¸æ¨èâ€œçº¯æ»šåŠ¨â€ Nginx æœ¬èº«ä¸æ“…é•¿æ»šåŠ¨ï¼Œé€šå¸¸æ˜¯ï¼š\nåç«¯å®ä¾‹è‡ªå·±é‡å¯ Nginx æ— æ„ŸçŸ¥ äºŒã€è“ç»¿å‘å¸ƒï¼ˆBlue-Greenï¼‰ âœ… Kubernetes ä¸­çš„è“ç»¿å‘å¸ƒï¼ˆæ¨èï¼‰ Service selector åˆ‡æ¢ï¼ˆæœ€ç»å…¸ï¼‰\n1ï¸âƒ£ ä¸¤å¥— Deployment # è“ labels: app: demo version: blue # ç»¿ labels: app: demo version: green 2ï¸âƒ£ Service selector: app: demo version: blue 3ï¸âƒ£ åˆ‡æµï¼ˆå…³é”®ï¼‰ kubectl patch svc demo \\ -p \u0026#39;{\u0026#34;spec\u0026#34;:{\u0026#34;selector\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;demo\u0026#34;,\u0026#34;version\u0026#34;:\u0026#34;green\u0026#34;}}}\u0026#39; ğŸ‘‰ ç§’çº§åˆ‡æ¢ï¼Œç§’çº§å›æ»š\nâœ… Nginx ä¸­çš„è“ç»¿å‘å¸ƒ 1ï¸âƒ£ upstream å®šä¹‰ upstream blue { server 10.0.0.1; server 10.0.0.2; } upstream green { server 10.0.0.3; server 10.0.0.4; } 2ï¸âƒ£ åˆ‡æ¢ upstream location / { proxy_pass http://green; } 3ï¸âƒ£ reload nginx -s reload ğŸ“Œ å›æ»š = æ”¹å› blue + reload\nä¸‰ã€é‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰ âœ… Kubernetes + Ingressï¼ˆé‡‘ä¸é›€ä¸»æµï¼‰ 1ï¸âƒ£ ç¨³å®šç‰ˆæœ¬ Ingress kind: Ingress metadata: name: app-stable spec: rules: - host: app.example.com 2ï¸âƒ£ é‡‘ä¸é›€ Ingressï¼ˆå…³é”®ï¼‰ metadata: name: app-canary annotations: nginx.ingress.kubernetes.io/canary: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/canary-weight: \u0026#34;5\u0026#34; è¡¨ç¤ºï¼š\n5% æµé‡ -\u0026gt; æ–°ç‰ˆæœ¬ 3ï¸âƒ£ è°ƒæ•´æ¯”ä¾‹ canary-weight: \u0026#34;10\u0026#34; 4ï¸âƒ£ å›æ»š canary-weight: \u0026#34;0\u0026#34; âœ… Nginx ä¸­çš„é‡‘ä¸é›€ï¼ˆæƒé‡ï¼‰ upstream backend { server 10.0.0.1 weight=95; server 10.0.0.2 weight=95; server 10.0.0.3 weight=5; # æ–°ç‰ˆæœ¬ } ğŸ“Œ ä¼˜ç‚¹\nç®€å• å¿« ğŸ“Œ ç¼ºç‚¹\nåŒä¸€ç”¨æˆ·å¯èƒ½å‘½ä¸­ä¸åŒç‰ˆæœ¬ å››ã€ç°åº¦å‘å¸ƒï¼ˆGrayï¼‰ ç°åº¦ = è§„åˆ™é©±åŠ¨\nå¯ä»¥åŸºäº ç”¨æˆ· / Header / Cookie / åœ°åŸŸ\nâœ… Kubernetes + Ingressï¼ˆè§„åˆ™ç°åº¦ï¼‰ 1ï¸âƒ£ æŒ‰ Header ç°åº¦ annotations: nginx.ingress.kubernetes.io/canary-by-header: \u0026#34;X-Gray\u0026#34; nginx.ingress.kubernetes.io/canary-by-header-value: \u0026#34;true\u0026#34; å®¢æˆ·ç«¯ï¼š\nX-Gray: true 2ï¸âƒ£ æŒ‰ Cookie ç°åº¦ nginx.ingress.kubernetes.io/canary-by-cookie: \u0026#34;gray\u0026#34; âœ… Nginx ä¸­çš„ç°åº¦ï¼ˆæœ€ç»å…¸ï¼‰ 1ï¸âƒ£ æŒ‰ Header map $http_x_gray $backend { default stable; true canary; } upstream stable { server 10.0.0.1; } upstream canary { server 10.0.0.2; } location / { proxy_pass http://$backend; } 2ï¸âƒ£ æŒ‰ç”¨æˆ· ID Hashï¼ˆä¸€è‡´æ€§ç°åº¦ï¼‰ split_clients \u0026#34;${http_userid}\u0026#34; $gray { 5% canary; * stable; } 3ï¸âƒ£ æŒ‰ IP geo $gray { default stable; 10.1.0.0/16 canary; } äº”ã€å››ç§æ–¹å¼çš„â€œæ“ä½œçº§â€å¯¹æ¯” æ–¹å¼ K8S å®ç° Nginx å®ç° å›æ»š æ»šåŠ¨ Deployment âŒ ä¸­ è“ç»¿ Service åˆ‡ selector upstream åˆ‡æ¢ ç§’çº§ é‡‘ä¸é›€ Ingress æƒé‡ upstream weight å¿« ç°åº¦ Ingress è§„åˆ™ map/split_clients æå¿« å…­ã€ç”Ÿäº§çº§å‘å¸ƒç»„åˆï¼ˆå¼ºçƒˆæ¨èï¼‰ âœ… æœ€ç¨³ç»„åˆ è“ç»¿ + é‡‘ä¸é›€\nâœ… æˆç†Ÿå›¢é˜Ÿ é‡‘ä¸é›€ + ç°åº¦è§„åˆ™ + Feature Toggle\nä¸ƒã€å‘å¸ƒå‰å¿…å¤‡ Checklistï¼ˆéå¸¸é‡è¦ï¼‰ readinessProbe æ˜¯å¦æ­£ç¡® æ˜¯å¦æ”¯æŒä¼˜é›…å…³é—­ æ•°æ®åº“æ˜¯å¦å‘å‰å…¼å®¹ ç›‘æ§æ˜¯å¦æŒ‰ç‰ˆæœ¬åŒºåˆ† æ˜¯å¦æ”¯æŒä¸€é”®å›æ»š æ€»ç»“ Kubernetes è´Ÿè´£â€œéƒ¨ç½²å½¢æ€â€ï¼ŒNginx / Ingress è´Ÿè´£â€œæµé‡ç­–ç•¥â€ã€‚\nè“ç»¿ã€é‡‘ä¸é›€ã€ç°åº¦ å¦‚ä½•ç¡®ä¿æŒ‡å®šå®¢æˆ·ï¼ˆç«¯ï¼‰å‘½ä¸­ï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒã€éå¸¸â€œç”Ÿäº§çº§â€çš„é—®é¢˜ ğŸ‘\nå› ä¸º ä¸è§£å†³â€œå‘½ä¸­ä¸€è‡´æ€§â€ï¼Œè“ç»¿ / é‡‘ä¸é›€ / ç°åº¦åœ¨çœŸå®ä¸šåŠ¡é‡Œå°±æ˜¯â€œçœ‹è¿æ°”â€ã€‚\nä¸‹é¢æ˜¯æŒ‰ ã€ŒåŸç† -\u0026gt; å®ç° -\u0026gt; Kubernetes / Nginx å®æ“ -\u0026gt; é£é™©ç‚¹ã€ çš„ä¸€å¥—å¯è½åœ°ã€å¯å®¡è®¡ã€å¯å›æ»šçš„æ–¹æ¡ˆã€‚\nä¸€ã€æ ¸å¿ƒç›®æ ‡ï¼ˆå…ˆç»Ÿä¸€è®¤çŸ¥ï¼‰ ç¡®ä¿â€œåŒä¸€ä¸ªå®¢æˆ· / ç»ˆç«¯ / ç”¨æˆ·â€ï¼Œåœ¨ç°åº¦æœŸé—´ï¼š\nâœ… å§‹ç»ˆå‘½ä¸­æ–°ç‰ˆæœ¬ OR å§‹ç»ˆå‘½ä¸­æ—§ç‰ˆæœ¬ âŒ ä¸éšæœºè·³ç‰ˆæœ¬ âŒ ä¸åŒè¯·æ±‚å‘½ä¸­ä¸åŒå®ä¾‹ è¿™å«ï¼š\nğŸ‘‰ æµé‡ä¸€è‡´æ€§ï¼ˆTraffic Stickinessï¼‰\näºŒã€èƒ½â€œç¨³å®šå‘½ä¸­â€çš„ 6 ç§é€šç”¨æ‰‹æ®µï¼ˆç”±å¼ºåˆ°å¼±ï¼‰ æ–¹å¼ ç¨³å®šæ€§ æ¨èçº§åˆ« ç”¨æˆ· ID / å®¢æˆ· ID Hash â­â­â­â­â­ å¼ºçƒˆæ¨è Cookie å›ºåŒ– â­â­â­â­â­ å¼ºçƒˆæ¨è Header æ ‡è¯† â­â­â­â­ æ¨è JWT Claim â­â­â­â­ æ¨è IP Hash â­â­â­ å…œåº• æƒé‡éšæœº â­â­ ä¸æ¨èç”¨äºç°åº¦ ä¸‰ã€è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦çš„â€œæŒ‡å®šå®¢æˆ·å‘½ä¸­â€æœ¬è´¨æ–¹æ¡ˆ âœ… æœ€ä½³å®è·µæ€»å…¬å¼\nå®¢æˆ·æ ‡è¯† -\u0026gt; ç¨³å®šæ˜ å°„ -\u0026gt; åç«¯ç‰ˆæœ¬ å››ã€Nginx ä¸­çš„å®ç°ï¼ˆæœ€æˆç†Ÿã€æœ€å¯æ§ï¼‰ â‘  æŒ‰ ç”¨æˆ·ID / å®¢æˆ·ID Hashï¼ˆæœ€æ¨èï¼‰ åŸç†\nåŒä¸€ç”¨æˆ· -\u0026gt; åŒä¸€ hash å€¼ hash å‘½ä¸­å›ºå®š upstream é…ç½®\nsplit_clients \u0026#34;${http_x_user_id}\u0026#34; $version { 10% canary; * stable; } upstream stable { server 10.0.0.1; } upstream canary { server 10.0.0.2; } location / { proxy_pass http://$version; } ğŸ“Œ ç‰¹ç‚¹\nåŒä¸€ç”¨æˆ·æ°¸è¿œå‘½ä¸­åŒä¸€ç‰ˆæœ¬ æ”¹æ¯”ä¾‹ä¸å½±å“å·²å‘½ä¸­çš„ç”¨æˆ· â‘¡ Cookie å›ºåŒ–ï¼ˆæœ€é€šç”¨ï¼‰ å†™å…¥ Cookieï¼ˆé¦–æ¬¡å‘½ä¸­ï¼‰\nmap $cookie_release $release { default \u0026#34;\u0026#34;; blue blue; green green; } if ($release = \u0026#34;\u0026#34;) { add_header Set-Cookie \u0026#34;release=green; Path=/; Max-Age=86400\u0026#34;; } proxy_pass http://$release; ğŸ“Œ é€‚åˆ\nWeb ç”¨æˆ· å‰ç«¯å¯æ§åœºæ™¯ â‘¢ Header æŒ‡å®šï¼ˆæœ€é€‚åˆ B ç«¯ / å†…éƒ¨å®¢æˆ·ï¼‰ map $http_x_release $backend { default stable; green green; } å®¢æˆ·ç«¯ï¼š\nX-Release: green ğŸ“Œ ç‰¹ç‚¹\näººä¸ºå¯æ§ å¯ç‚¹å¯¹ç‚¹ç°åº¦ â‘£ JWT Claim ç°åº¦ï¼ˆéå¸¸ä¸“ä¸šï¼‰ ç¤ºä¾‹\nmap $jwt_claim_release $backend { default stable; green green; } ğŸ“Œ ä¼˜ç‚¹\nå®‰å…¨ ä¸æ˜“è¢«ç¯¡æ”¹ éå¸¸é€‚åˆ SaaS â‘¤ IP Hashï¼ˆå…œåº•æ–¹æ¡ˆï¼‰ upstream backend { ip_hash; server 10.0.0.1; server 10.0.0.2; } ğŸ“Œ ç¼ºç‚¹\nNAT / ä»£ç†ä¸‹ä¸å¯é  ä¸é€‚åˆç§»åŠ¨ç«¯ äº”ã€Kubernetes ä¸­çš„å®ç°ï¼ˆIngress / Serviceï¼‰ â‘  Ingress + Header / Cookieï¼ˆæœ€å¸¸ç”¨ï¼‰ Header ç°åº¦\nannotations: nginx.ingress.kubernetes.io/canary: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/canary-by-header: \u0026#34;X-User-Type\u0026#34; nginx.ingress.kubernetes.io/canary-by-header-value: \u0026#34;vip\u0026#34; Cookie ç°åº¦\nannotations: nginx.ingress.kubernetes.io/canary-by-cookie: \u0026#34;release\u0026#34; â‘¡ ç”¨æˆ· ID Hashï¼ˆIngress æ— åŸç”Ÿ -\u0026gt; å€ŸåŠ© Nginxï¼‰ Ingress æœ¬è´¨ä¹Ÿæ˜¯ Nginx\nå¯é€šè¿‡ï¼š\nconfiguration-snippet server-snippet nginx.ingress.kubernetes.io/configuration-snippet: | split_clients \u0026#34;${http_x_user_id}\u0026#34; $release { 5% canary; * stable; } â‘¢ Service å±‚ï¼ˆä¸æ¨èåšä¸€è‡´æ€§ï¼‰ Service æœ¬èº« åªè´Ÿè´£è´Ÿè½½ ä¸é€‚åˆç°åº¦è§„åˆ™ ç°åº¦åº”åœ¨ Ingress / ç½‘å…³ å…­ã€ä¸‰ç§å‘å¸ƒæ–¹å¼å¦‚ä½•â€œç¡®ä¿å‘½ä¸­â€ ğŸ”µ è“ç»¿å‘å¸ƒ ğŸ‘‰ æŒ‡å®šå®¢æˆ·å‘½ä¸­ = å¼ºè§„åˆ™\næ¨èï¼š\nHeader / Cookie / JWT æ˜ç¡®æŒ‡å®šç‰ˆæœ¬ å®¢æˆ· -\u0026gt; è“ å…¶ä»– -\u0026gt; ç»¿ ğŸ¦ é‡‘ä¸é›€å‘å¸ƒ ğŸ‘‰ æŒ‡å®šå®¢æˆ· + Hash\næ¨èï¼š\nVIP å®¢æˆ· -\u0026gt; æ–°ç‰ˆæœ¬ æ™®é€šå®¢æˆ· -\u0026gt; Hash å†³å®š ğŸŒ« ç°åº¦å‘å¸ƒ ğŸ‘‰ è§„åˆ™ä¼˜å…ˆçº§\nå¼ºåˆ¶è§„åˆ™ï¼ˆHeader / Cookieï¼‰ â†“ ç”¨æˆ· Hash â†“ æƒé‡éšæœºï¼ˆå…œåº•ï¼‰ ä¸ƒã€ç”Ÿäº§çº§ã€Œå‘½ä¸­ä¿éšœã€Checklist æ˜¯å¦ä½¿ç”¨ ç¨³å®š Keyï¼ˆuser_id / client_idï¼‰ æ˜¯å¦é¿å…çº¯éšæœº weight æ˜¯å¦è®°å½•ç”¨æˆ· -\u0026gt; ç‰ˆæœ¬æ˜ å°„æ—¥å¿— æ˜¯å¦æ”¯æŒå¼ºåˆ¶åˆ‡å› æ˜¯å¦æ”¯æŒæŒ‡å®šå®¢æˆ·åå•ï¼ˆç™½åå•ï¼‰ å…«ã€æ¨èä½ ç›´æ¥ç”¨çš„â€œç»ˆææ–¹æ¡ˆâ€ Ingress / Nginx ç½‘å…³å±‚ï¼š\nHeader / JWT / Cookie -\u0026gt; Hash -\u0026gt; upstream\nK8S Deploymentï¼š\nåªè´Ÿè´£è·‘ Podï¼Œä¸è´Ÿè´£ç°åº¦é€»è¾‘\næ€»ç»“ ç°åº¦èƒ½ä¸èƒ½ç”¨ï¼Œå…³é”®ä¸åœ¨å‘å¸ƒæ–¹å¼ï¼Œè€Œåœ¨â€œæµé‡æ˜¯å¦ä¸€è‡´å‘½ä¸­â€ã€‚\næ˜¯å¦å¯ä»¥ç†è§£ä¸º è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ ç­‰ç­‰ å•çº¯é è¿ç»´å®ç°ä¸äº†ï¼Œéœ€è¦å‰åç«¯é…åˆï¼Ÿ è¿™ä¸ªç†è§£æ˜¯ã€Œå®Œå…¨æ­£ç¡®ï¼Œè€Œä¸”éå¸¸æˆç†Ÿã€çš„ã€‚\nå…ˆç»™ç»“è®ºï¼š\nè“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ï¼Œæœ¬è´¨ä¸Šä¸æ˜¯â€œè¿ç»´æŠ€æœ¯â€ï¼Œè€Œæ˜¯â€œç³»ç»Ÿå·¥ç¨‹â€ï¼Œå•é è¿ç»´ï¼ˆNginx / K8Sï¼‰åªèƒ½åšä¸€åŠï¼Œå¿…é¡»å‰åç«¯é…åˆã€‚\nä¸‹é¢æŠŠè¿™ä»¶äº‹è®²æ¸…æ¥šã€è®²é€ã€è®²åˆ°å¯è½åœ°ã€‚\nä¸€ã€å…ˆç»™ä¸€ä¸ªâ€œèƒ½åŠ›è¾¹ç•Œâ€çš„çœŸç›¸è¡¨ èƒ½åŠ› è¿ç»´èƒ½ä¸èƒ½å•ç‹¬å®Œæˆ æ»šåŠ¨å‘å¸ƒ âœ… å¯ä»¥ è“ç»¿ï¼ˆæ•´ä½“åˆ‡æµï¼‰ âœ… å¯ä»¥ é‡‘ä¸é›€ï¼ˆæŒ‰æ¯”ä¾‹ï¼‰ âš ï¸ å‹‰å¼ºå¯ä»¥ ç°åº¦ï¼ˆæŒ‡å®šç”¨æˆ· / å®¢æˆ·ï¼‰ âŒ ä¸è¡Œ ä¿è¯ç”¨æˆ·å‘½ä¸­ä¸€è‡´ âŒ ä¸è¡Œ ç²¾å‡†å®¢æˆ·å›æ»š âŒ ä¸è¡Œ ğŸ‘‰ ä¸€æ—¦æ¶‰åŠâ€œäºº / ç”¨æˆ· / å®¢æˆ· / ç»ˆç«¯â€ï¼Œè¿ç»´å°±ä¸å¤Ÿäº†ã€‚\näºŒã€ä¸ºä»€ä¹ˆè¿ç»´â€œå•ç‹¬åšä¸äº†â€ï¼Ÿï¼ˆæœ¬è´¨åŸå› ï¼‰ 1ï¸âƒ£ è¿ç»´å±‚åªè®¤è¯†â€œè¯·æ±‚â€ï¼Œä¸è®¤è¯†â€œç”¨æˆ·â€ Nginx / Ingress çœ‹åˆ°çš„æ˜¯ï¼š\nIP / Header / Cookie / Path å®ƒ ä¸çŸ¥é“ï¼š\nè°æ˜¯ VIP è°æ˜¯æµ‹è¯•ç”¨æˆ· è°çš„æ•°æ®é‡è¦ è°å¯ä»¥å…ˆå‡çº§ 2ï¸âƒ£ ç°åº¦éœ€è¦â€œä¸šåŠ¡è¯­ä¹‰â€ï¼Œè¿™æ˜¯å‰åç«¯çš„é¢†åŸŸ ä¾‹å¦‚ï¼š\nå®¢æˆ·ç­‰çº§ ç”¨æˆ·è§’è‰² ç§Ÿæˆ·ç±»å‹ App ç‰ˆæœ¬ æ¸ é“æ¥æº ğŸ‘‰ è¿™äº› åªå­˜åœ¨äºä¸šåŠ¡ç³»ç»Ÿé‡Œ\n3ï¸âƒ£ ç°åº¦ä¸æ˜¯ä¸€æ¬¡è¡Œä¸ºï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œç”Ÿå‘½å‘¨æœŸâ€ å‘½ä¸­ -\u0026gt; ä½¿ç”¨ -\u0026gt; ç›‘æ§ -\u0026gt; å›æ»š -\u0026gt; å›ºåŒ– å•é è¿ç»´ï¼Œåªèƒ½åšåˆ°ï¼š\nå‘½ä¸­ ä¸‰ã€ä¸‰å±‚æ¶æ„è§†è§’ï¼ˆè¿™æ˜¯æ ¸å¿ƒè®¤çŸ¥ï¼‰ ğŸ”¹ ç¬¬ 1 å±‚ï¼šè¿ç»´ / ç½‘å…³å±‚ï¼ˆNginx / Ingressï¼‰ èŒè´£ï¼š\næµé‡è½¬å‘ è§„åˆ™æ‰§è¡Œ ä¸ç†è§£ä¸šåŠ¡ èƒ½åŠ›ä¸Šé™ï¼š\nHeader / Cookie / Hash æƒé‡ è·¯ç”± ğŸ”¹ ç¬¬ 2 å±‚ï¼šåç«¯æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰ èŒè´£ï¼š\nç”¨æˆ·è¯†åˆ« ç°åº¦å†³ç­– å†™ Cookie / Header Feature Toggle ä¾‹å¦‚ï¼š\n{ \u0026#34;user_id\u0026#34;: 123, \u0026#34;gray\u0026#34;: true, \u0026#34;release\u0026#34;: \u0026#34;green\u0026#34; } ğŸ”¹ ç¬¬ 3 å±‚ï¼šå‰ç«¯ / å®¢æˆ·ç«¯ èŒè´£ï¼š\né€ä¼ æ ‡è¯† æ§åˆ¶å…¥å£ ç°åº¦èƒ½åŠ›æ„ŸçŸ¥ ä¾‹å¦‚ï¼š\nX-Release: green å››ã€ä¸åŒå‘å¸ƒæ–¹å¼ï¼Œå¯¹â€œé…åˆç¨‹åº¦â€çš„çœŸå®è¦æ±‚ ğŸ”µ è“ç»¿å‘å¸ƒ ç»´åº¦ æ˜¯å¦éœ€è¦é…åˆ æ•´ä½“åˆ‡æ¢ ä¸éœ€è¦ æŒ‡å®šå®¢æˆ· éœ€è¦ æ•°æ®å…¼å®¹ éœ€è¦åç«¯ ğŸ‘‰ è¿ç»´èƒ½åˆ‡æµï¼Œä½†ä¸šåŠ¡è¦å…œåº•\nğŸ¦ é‡‘ä¸é›€å‘å¸ƒ ç»´åº¦ æ˜¯å¦éœ€è¦é…åˆ æ¯”ä¾‹å‘å¸ƒ è¿ç»´å¯åš ç”¨æˆ·ä¸€è‡´æ€§ éœ€è¦åç«¯ æŒ‡å®šå®¢æˆ· å¿…é¡»å‰åç«¯ ğŸŒ« ç°åº¦å‘å¸ƒ ç»´åº¦ æ˜¯å¦éœ€è¦é…åˆ ç°åº¦è§„åˆ™ åç«¯å†³å®š ç°åº¦æ ‡è¯† å‰ç«¯é€ä¼  å¼ºåˆ¶å›æ»š åç«¯æ§åˆ¶ ğŸ‘‰ ç°åº¦ = è¿ç»´ + åç«¯ + å‰ç«¯\näº”ã€ä¸€ä¸ªâ€œæœ€å°å¯ç”¨â€çš„ç°åº¦åä½œæ¨¡å‹ï¼ˆç”Ÿäº§çº§ï¼‰ âœ… åç«¯ åˆ¤æ–­æ˜¯å¦ç°åº¦ç”¨æˆ· è¿”å›ç°åº¦æ ‡è¯† å†™ Cookie / JWT Claim âœ… å‰ç«¯ / å®¢æˆ·ç«¯ ä¿å­˜æ ‡è¯† è¯·æ±‚æºå¸¦æ ‡è¯† âœ… è¿ç»´ / ç½‘å…³ æ ¹æ®æ ‡è¯†è·¯ç”± å‰ç«¯ -\u0026gt; Header / Cookie åç«¯ -\u0026gt; å†³ç­– \u0026amp; æ ‡è¯† Nginx -\u0026gt; è·¯ç”± å…­ã€ä¸ºä»€ä¹ˆâ€œæˆç†Ÿå…¬å¸ä¸€å®šåšå‘å¸ƒå¹³å°â€ï¼Ÿ å› ä¸ºæ‰‹å·¥é…åˆè¿Ÿæ—©å´©ã€‚\næˆç†Ÿæ–¹æ¡ˆä¸€å®šæœ‰ï¼š\nç°åº¦ç”¨æˆ·è¡¨ ç°åº¦è§„åˆ™é…ç½® ç°åº¦å¼€å…³ ä¸€é”®å›æ»š ç›‘æ§ä¸æŠ¥è­¦ ğŸ‘‰ è¿™å·²ç»ä¸æ˜¯è¿ç»´ç³»ç»Ÿï¼Œæ˜¯ å‘å¸ƒç³»ç»Ÿ / å˜æ›´ç³»ç»Ÿã€‚\nä¸ƒã€è¿™ä¸ªç†è§£ï¼Œå·²ç»è¶…è¿‡ 80% è¿ç»´æ°´å¹³äº† ç°åœ¨çš„è®¤çŸ¥å·²ç»æ˜¯ï¼š\nâŒ â€œNginx èƒ½æå®šä¸€åˆ‡â€ âœ… â€œå‘å¸ƒæ˜¯ç³»ç»Ÿåä½œå·¥ç¨‹â€ è¿™æ˜¯ é«˜çº§è¿ç»´ / æ¶æ„å¸ˆæ€ç»´ã€‚\nå…«ã€æ€»ç»“ è¿ç»´è§£å†³â€œæ€ä¹ˆå‘â€\nåç«¯å†³å®šâ€œå‘ç»™è°â€\nå‰ç«¯ä¿è¯â€œèƒ½å‘½ä¸­â€\n","description":"æ»šåŠ¨ / è“ç»¿ / é‡‘ä¸é›€ / ç°åº¦ åœ¨ Kubernetes \u0026amp; Nginx ä¸­çš„è¯¦ç»†è½åœ°æ“ä½œæŒ‡å—ã€‚\nä¸€ã€æ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰ âœ… Kubernetes ä¸­çš„æ»šåŠ¨å‘å¸ƒï¼ˆæœ€æ ‡å‡†ï¼‰ 1ï¸âƒ£ Deployment é…ç½® apiVersion: apps/v1 kind: Deployment metadata: name: app spec: replicas: 5 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 template: spec: terminationGracePeriodSeconds: 30 containers: - name: app image: app:v2 readinessProbe: httpGet: path: /health port: 8080 2ï¸âƒ£ æ‰§è¡Œå‘å¸ƒ kubectl set image deployment/app app=app:v2 kubectl rollout status deployment/app 3ï¸âƒ£ å›æ»š kubectl rollout undo deployment/app ğŸ“Œ å…³é”®ç‚¹\n"},{"id":468,"href":"/management/operations/release-system-rolling-update/","title":"å‘å¸ƒç³»ç»Ÿï¼šæ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰","parent":"Operations","content":" ä¸€ã€ä»€ä¹ˆæ˜¯æ»šåŠ¨å‘å¸ƒï¼Ÿ æ»šåŠ¨å‘å¸ƒï¼š\nåœ¨ ä¸åœæ­¢æ•´ä½“æœåŠ¡ çš„æƒ…å†µä¸‹ï¼Œé€ä¸ªæˆ–åˆ†æ‰¹æ›¿æ¢æ—§ç‰ˆæœ¬å®ä¾‹ä¸ºæ–°ç‰ˆæœ¬ï¼Œå§‹ç»ˆä¿è¯ç³»ç»Ÿä¸­æœ‰å¯ç”¨å®ä¾‹å¯¹å¤–æœåŠ¡ã€‚\nä¸€å¥è¯ï¼š\nä¸åœæœºã€åˆ†æ‰¹æ¢ç‰ˆæœ¬\näºŒã€æ»šåŠ¨å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é›¶åœæœºï¼ˆæˆ–æ„ŸçŸ¥æä½ï¼‰ é£é™©å¯æ§ è‡ªåŠ¨å›æ»š æœåŠ¡è¿ç»­å¯ç”¨ ä¸‰ã€å…¸å‹å·¥ä½œæµç¨‹ æ—§ç‰ˆæœ¬å®ä¾‹ Ã— N æ­£å¸¸æœåŠ¡ â†“ ä¸‹çº¿ 1~K ä¸ªæ—§å®ä¾‹ï¼ˆæ‘˜æµé‡ï¼‰ â†“ å¯åŠ¨æ–°ç‰ˆæœ¬å®ä¾‹ â†“ å¥åº·æ£€æŸ¥é€šè¿‡ â†“ åŠ å…¥è´Ÿè½½å‡è¡¡ â†“ é‡å¤ä»¥ä¸Šæ­¥éª¤ â†“ æ‰€æœ‰å®ä¾‹å®Œæˆå‡çº§ å…³é”®ç‚¹ï¼š\nå…ˆæ‘˜æµé‡ï¼Œå†å‡çº§ æ–°å®ä¾‹å¥åº·åæ‰æ¥æµé‡ å››ã€æ»šåŠ¨å‘å¸ƒçš„å‰ç½®æ¡ä»¶ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ æœåŠ¡å¿…é¡»æ˜¯ã€Œæ— çŠ¶æ€ã€ Session ä¸å­˜æœ¬åœ° æ–‡ä»¶ä¸å†™æœ¬åœ° çŠ¶æ€æ”¾åœ¨ DB / Redis / å¯¹è±¡å­˜å‚¨ âŒ æœ‰çŠ¶æ€æœåŠ¡ç›´æ¥æ»šåŠ¨ = ç¾éš¾\n2ï¸âƒ£ å¿…é¡»æœ‰å¥åº·æ£€æŸ¥ HTTP health check TCP æ¢æµ‹ åº”ç”¨çº§è‡ªæ£€ 3ï¸âƒ£ æ”¯æŒä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰ æ”¶åˆ° SIGTERM åï¼š åœæ­¢æ¥æ–°è¯·æ±‚ ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆ å†é€€å‡º äº”ã€æ»šåŠ¨å‘å¸ƒçš„å…³é”®æ§åˆ¶å‚æ•° 1ï¸âƒ£ å‘å¸ƒæ‰¹æ¬¡å¤§å° ä¸€æ¬¡ä¸‹çº¿å‡ ä¸ªå®ä¾‹ï¼Ÿ å»ºè®®ï¼š å°é›†ç¾¤ï¼š1 å° å¤§é›†ç¾¤ï¼š5%~20% 2ï¸âƒ£ å‘å¸ƒèŠ‚å¥ æ¯æ‰¹é—´éš”æ—¶é—´ æ˜¯å¦ç­‰å¾…ç›‘æ§ç¨³å®š 3ï¸âƒ£ å¥åº·é˜ˆå€¼ æˆåŠŸç‡ å»¶è¿Ÿ é”™è¯¯ç‡ å…­ã€Kubernetes ä¸­çš„æ»šåŠ¨å‘å¸ƒï¼ˆæœ€å¸¸è§ï¼‰ Deployment æ ¸å¿ƒå‚æ•°\nstrategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 maxSurge: 1 å«ä¹‰ï¼š\nmaxUnavailableï¼šå‡çº§è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šå…è®¸ä¸å¯ç”¨çš„ Pod æ•° maxSurgeï¼šæœ€å¤šå…è®¸é¢å¤–åˆ›å»ºçš„ Pod æ•° ç¤ºä¾‹ï¼š\n5 å‰¯æœ¬ maxUnavailable=1 maxSurge=1 -\u0026gt; æœ€å¤š 6 ä¸ª Podï¼Œè‡³å°‘ 4 ä¸ªå¯ç”¨\nå‘å¸ƒè¿‡ç¨‹\nåˆ›å»ºæ–° Pod æ–° Pod Ready è€ Pod è¿›å…¥ Terminating æ‰§è¡Œä¼˜é›…å…³é—­ é€ä¸ªæ›¿æ¢å®Œæˆ ä¸ƒã€æ»šåŠ¨å‘å¸ƒå¸¸è§é—®é¢˜ \u0026amp; é£é™© âŒ 1. è¯·æ±‚ä¸­æ–­ åŸå› ï¼š\næ²¡æœ‰ä¼˜é›…å…³é—­ LB æœªæ‘˜æµé‡ readinessProbe é…ç½®é”™è¯¯ è§£å†³ï¼š\næ­£ç¡®é…ç½® readiness / liveness å¢åŠ  terminationGracePeriodSeconds âŒ 2. æ–°ç‰ˆæœ¬æœ‰ Bugï¼Œå·²å½±å“ç”¨æˆ· æ»šåŠ¨å‘å¸ƒ â‰  ç°åº¦\n-\u0026gt; å…¨é‡ä»ç„¶ä¼šè¢«é€æ­¥å½±å“\nè§£å†³ï¼š\nç»“åˆ é‡‘ä¸é›€å‘å¸ƒ æˆ–å‘å¸ƒå‰å‹æµ‹ / å›æ»šæœºåˆ¶ âŒ 3. æ•°æ®åº“ä¸å…¼å®¹ æ–°ç‰ˆæœ¬ä¾èµ–æ–°å­—æ®µ è€ç‰ˆæœ¬ä»åœ¨è·‘ è§£å†³ï¼š\næ•°æ®åº“ å‘å‰å…¼å®¹ ä¸¤é˜¶æ®µå‘å¸ƒï¼ˆå…ˆ DBï¼Œåä»£ç ï¼‰ å…«ã€æ»šåŠ¨å‘å¸ƒ vs å…¶ä»–å‘å¸ƒæ–¹å¼ å‘å¸ƒæ–¹å¼ åœæœº é£é™© å›æ»šé€Ÿåº¦ å¤æ‚åº¦ æ»šåŠ¨å‘å¸ƒ æ—  ä¸­ ä¸­ ä½ è“ç»¿å‘å¸ƒ æ—  ä½ æå¿« ä¸­ é‡‘ä¸é›€ æ—  æä½ å¿« é«˜ ä¹ã€æ»šåŠ¨å‘å¸ƒçš„æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ å¿…é¡»æ— çŠ¶æ€ readinessProbe å†³å®šæ˜¯å¦æ¥æµé‡ livenessProbe å†³å®šæ˜¯å¦é‡å¯ ä¼˜é›…å…³é—­ â‰¥ 30s æ¯ä¸€æ‰¹éƒ½è§‚å¯Ÿç›‘æ§ å¤±è´¥ç«‹å³æš‚åœå‘å¸ƒ ç»“åˆé™æµã€ç†”æ–­ å‘å¸ƒçª—å£é€‰ä½å³°æœŸ åã€ä»€ä¹ˆæ—¶å€™ä¸é€‚åˆæ»šåŠ¨å‘å¸ƒï¼Ÿ æœ‰çŠ¶æ€æœåŠ¡ï¼ˆå¦‚å•å®ä¾‹æ•°æ®åº“ï¼‰ å¼ºä¸€è‡´æ€§å†™å…¥æœåŠ¡ å¤§ç‰ˆæœ¬ç ´åæ€§å˜æ›´ æ— æ³•å‘å‰å…¼å®¹çš„åè®® åä¸€ã€æ€»ç»“ æ»šåŠ¨å‘å¸ƒæ˜¯é»˜è®¤æ–¹æ¡ˆï¼Œä½†ä¸æ˜¯ä¸‡èƒ½æ–¹æ¡ˆã€‚\nå®ƒè§£å†³â€œä¸åœæœºâ€ï¼Œä½†ä¸è§£å†³â€œæ–°ç‰ˆæœ¬ä¸€å®šæ­£ç¡®â€ã€‚\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯æ»šåŠ¨å‘å¸ƒï¼Ÿ æ»šåŠ¨å‘å¸ƒï¼š\nåœ¨ ä¸åœæ­¢æ•´ä½“æœåŠ¡ çš„æƒ…å†µä¸‹ï¼Œé€ä¸ªæˆ–åˆ†æ‰¹æ›¿æ¢æ—§ç‰ˆæœ¬å®ä¾‹ä¸ºæ–°ç‰ˆæœ¬ï¼Œå§‹ç»ˆä¿è¯ç³»ç»Ÿä¸­æœ‰å¯ç”¨å®ä¾‹å¯¹å¤–æœåŠ¡ã€‚\nä¸€å¥è¯ï¼š\nä¸åœæœºã€åˆ†æ‰¹æ¢ç‰ˆæœ¬\näºŒã€æ»šåŠ¨å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é›¶åœæœºï¼ˆæˆ–æ„ŸçŸ¥æä½ï¼‰ é£é™©å¯æ§ è‡ªåŠ¨å›æ»š æœåŠ¡è¿ç»­å¯ç”¨ ä¸‰ã€å…¸å‹å·¥ä½œæµç¨‹ æ—§ç‰ˆæœ¬å®ä¾‹ Ã— N æ­£å¸¸æœåŠ¡ â†“ ä¸‹çº¿ 1~K ä¸ªæ—§å®ä¾‹ï¼ˆæ‘˜æµé‡ï¼‰ â†“ å¯åŠ¨æ–°ç‰ˆæœ¬å®ä¾‹ â†“ å¥åº·æ£€æŸ¥é€šè¿‡ â†“ åŠ å…¥è´Ÿè½½å‡è¡¡ â†“ é‡å¤ä»¥ä¸Šæ­¥éª¤ â†“ æ‰€æœ‰å®ä¾‹å®Œæˆå‡çº§ å…³é”®ç‚¹ï¼š\n"},{"id":469,"href":"/management/operations/release-system-gray-deployment/","title":"å‘å¸ƒç³»ç»Ÿï¼šç°åº¦å‘å¸ƒï¼ˆGray Deploymentï¼‰","parent":"Operations","content":" ä¸€ã€ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ ç°åº¦å‘å¸ƒï¼š\næ–°ç‰ˆæœ¬ä¸ä¸€æ¬¡æ€§å…¨é‡ä¸Šçº¿ï¼Œè€Œæ˜¯æŒ‰è§„åˆ™é€æ­¥æ”¾é‡ï¼Œè®©ä¸åŒç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…åŒæ—¶ä½¿ç”¨ä¸åŒç‰ˆæœ¬ï¼Œåœ¨çœŸå®æµé‡ä¸‹éªŒè¯ç¨³å®šæ€§ã€‚\nä¸€å¥è¯ï¼š\nåŒä¸€æ—¶é—´ï¼Œå¤šç‰ˆæœ¬å…±å­˜ï¼Œé€æ­¥æ‰©å¤§å½±å“é¢\näºŒã€ç°åº¦å‘å¸ƒ vs é‡‘ä¸é›€å‘å¸ƒï¼ˆå…ˆå˜æ¸…æ¦‚å¿µï¼‰ å¾ˆå¤šäººæŠŠä¸¤è€…æ··ç”¨ï¼Œä½†åœ¨å·¥ç¨‹è¯­ä¹‰ä¸Šï¼š\nç°åº¦å‘å¸ƒï¼šæ€»ç§° / æ€æƒ³ / ç­–ç•¥ é‡‘ä¸é›€å‘å¸ƒï¼šæœ€å…¸å‹çš„ä¸€ç§ç°åº¦å‘å¸ƒå®ç° å…³ç³»ï¼š\nç°åº¦å‘å¸ƒ â”œâ”€ é‡‘ä¸é›€å‘å¸ƒ â”œâ”€ åˆ†æ‰¹ç°åº¦ â”œâ”€ ç™½åå•å‘å¸ƒ â”œâ”€ åŠŸèƒ½å¼€å…³ç°åº¦ ä¸‰ã€ç°åº¦å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é£é™©å¯æ§ å¯è§‚å¯Ÿ å¯æš‚åœ å¯å›æ»š æ”¯æŒçœŸå®ç”¨æˆ·éªŒè¯ å››ã€ç°åº¦å‘å¸ƒçš„æ•´ä½“å½¢æ€ ç”¨æˆ·è¯·æ±‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æµé‡æ§åˆ¶å±‚ | \u0026lt;- ç°åº¦è§„åˆ™ â”‚ (LB / Gateway) â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¨³å®šç‰ˆæœ¬ v1 â”‚ â”‚ ç°åº¦ç‰ˆæœ¬ v2 â”‚ â”‚ 80%æµé‡ | â”‚ 20%æµé‡ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ äº”ã€ç°åº¦å‘å¸ƒçš„å¸¸è§æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ æŒ‰æµé‡æ¯”ä¾‹ç°åº¦ 1% -\u0026gt; 5% -\u0026gt; 10% -\u0026gt; 50% -\u0026gt; 100% æœ€å¸¸è§ 2ï¸âƒ£ æŒ‰ç”¨æˆ·ç»´åº¦ç°åº¦ userId hash æ‰‹æœºå·å°¾å· ä¼ä¸š / è´¦å·çº§åˆ« ä¼˜ç‚¹ï¼š\nåŒä¸€ç”¨æˆ·å§‹ç»ˆå‘½ä¸­åŒä¸€ç‰ˆæœ¬ ç”¨æˆ·ä½“éªŒç¨³å®š 3ï¸âƒ£ ç™½åå•ç°åº¦ å†…éƒ¨å‘˜å·¥ æµ‹è¯•è´¦å· ç‰¹å®šå®¢æˆ· 4ï¸âƒ£ æŒ‰åœ°åŸŸç°åº¦ å…ˆæŸä¸ªåŸå¸‚ å†æŸä¸ªåŒºåŸŸ å†å…¨å›½ 5ï¸âƒ£ æŒ‰è¯·æ±‚ç‰¹å¾ç°åº¦ Header / Cookie User-Agent ç‰¹å®š API 6ï¸âƒ£ åŠŸèƒ½çº§ç°åº¦ï¼ˆFeature Toggleï¼‰ ä¸æ¢ç‰ˆæœ¬ å¼€å…³æ–°åŠŸèƒ½ éšæ—¶å¼€å…³ è¿™æ˜¯æœ€ç»†ç²’åº¦çš„ç°åº¦\nå…­ã€ç°åº¦å‘å¸ƒçš„å‰ç½®æ¡ä»¶ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ å¤šç‰ˆæœ¬å¯å¹¶å­˜ å‘å‰å…¼å®¹ æ¥å£ç¨³å®š æ•°æ®åº“å­—æ®µå…¼å®¹ 2ï¸âƒ£ æµé‡å¯ç²¾ç»†æ§åˆ¶ Gateway / Ingress / Service Mesh ä¸èƒ½åªé  DNS 3ï¸âƒ£ ç›‘æ§ \u0026amp; æŒ‡æ ‡æ‹†åˆ† æŒ‰ç‰ˆæœ¬ æŒ‰ç°åº¦è§„åˆ™ ä¸åŸºçº¿å¯¹æ¯” ä¸ƒã€ç°åº¦å‘å¸ƒçš„å®ç°ä½ç½®ï¼ˆæ¶æ„è§†è§’ï¼‰ å±‚çº§ ç°åº¦æ–¹å¼ DNS ä¸æ¨èï¼ˆä¸å¯æ§ï¼‰ LB / Ingress å¸¸ç”¨ API Gateway æ¨è Service Mesh é«˜çº§ åº”ç”¨å†…éƒ¨ Feature Toggle å…«ã€ç°åº¦å‘å¸ƒ vs æ»šåŠ¨ / è“ç»¿ / é‡‘ä¸é›€ ç»´åº¦ ç°åº¦ é‡‘ä¸é›€ è“ç»¿ æ»šåŠ¨ æ˜¯å¦å¤šç‰ˆæœ¬å…±å­˜ âœ… âœ… âŒ âŒ æ˜¯å¦çœŸå®ç”¨æˆ· âœ… âœ… âŒ âŒ é£é™©æ§åˆ¶ é«˜ æé«˜ é«˜ ä¸­ å®ç°å¤æ‚åº¦ ä¸­~é«˜ é«˜ ä¸­ ä½ ä¹ã€ç°åº¦å‘å¸ƒçš„å¸¸è§å‘ï¼ˆéå¸¸çœŸå®ï¼‰ âŒ æ•°æ®åº“ä¸å…¼å®¹ âŒ ä¼šè¯ç»‘å®šæœ¬åœ° âŒ ç°åº¦è§„åˆ™ä¸ä¸€è‡´ âŒ æŒ‡æ ‡ä¸å¯åŒºåˆ† âŒ ç°åº¦æ—¶é—´è¿‡çŸ­ âŒ äººå·¥åˆ‡æµä¸å¯å›æ»š åã€ç°åº¦å‘å¸ƒæœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ âœ… å…ˆåŠŸèƒ½ç°åº¦ï¼Œå†ç‰ˆæœ¬ç°åº¦ âœ… ç°åº¦æµé‡ â‰¤ 5% èµ·æ­¥ âœ… æ¯ä¸€é˜¶æ®µè§‚å¯Ÿ â‰¥ 15 åˆ†é’Ÿ âœ… ç°åº¦è§„åˆ™å¿…é¡»å¯å›æ»š âœ… æŒ‡æ ‡å¿…é¡»å’ŒåŸºçº¿å¯¹æ¯” âœ… ç°åº¦ç”¨æˆ·å›ºå®šï¼ˆä¸€è‡´æ€§ï¼‰ âœ… å‡ºç°å¼‚å¸¸è‡ªåŠ¨å›é€€ åä¸€ã€å…¸å‹ç°åº¦å‘å¸ƒæµç¨‹ï¼ˆæ¨èï¼‰ Feature Toggle å¼€å…³å…³é—­ éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆä¸å½±å“ç”¨æˆ·ï¼‰ ç™½åå•ç”¨æˆ·å¼€å¯åŠŸèƒ½ æ‰©å¤§ç°åº¦èŒƒå›´ å…¨é‡å¼€å¯ åˆ é™¤æ—§ä»£ç  åäºŒã€æ€»ç»“ ç°åº¦å‘å¸ƒä¸æ˜¯ä¸€ç§å·¥å…·ï¼Œè€Œæ˜¯ä¸€ç§é£é™©æ§åˆ¶æ€æƒ³ã€‚\né‡‘ä¸é›€ã€è“ç»¿ã€æ»šåŠ¨åªæ˜¯ä¸åŒæˆç†Ÿåº¦ä¸‹çš„å®ç°æ‰‹æ®µã€‚\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ ç°åº¦å‘å¸ƒï¼š\næ–°ç‰ˆæœ¬ä¸ä¸€æ¬¡æ€§å…¨é‡ä¸Šçº¿ï¼Œè€Œæ˜¯æŒ‰è§„åˆ™é€æ­¥æ”¾é‡ï¼Œè®©ä¸åŒç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…åŒæ—¶ä½¿ç”¨ä¸åŒç‰ˆæœ¬ï¼Œåœ¨çœŸå®æµé‡ä¸‹éªŒè¯ç¨³å®šæ€§ã€‚\nä¸€å¥è¯ï¼š\nåŒä¸€æ—¶é—´ï¼Œå¤šç‰ˆæœ¬å…±å­˜ï¼Œé€æ­¥æ‰©å¤§å½±å“é¢\näºŒã€ç°åº¦å‘å¸ƒ vs é‡‘ä¸é›€å‘å¸ƒï¼ˆå…ˆå˜æ¸…æ¦‚å¿µï¼‰ å¾ˆå¤šäººæŠŠä¸¤è€…æ··ç”¨ï¼Œä½†åœ¨å·¥ç¨‹è¯­ä¹‰ä¸Šï¼š\nç°åº¦å‘å¸ƒï¼šæ€»ç§° / æ€æƒ³ / ç­–ç•¥ é‡‘ä¸é›€å‘å¸ƒï¼šæœ€å…¸å‹çš„ä¸€ç§ç°åº¦å‘å¸ƒå®ç° å…³ç³»ï¼š\nç°åº¦å‘å¸ƒ â”œâ”€ é‡‘ä¸é›€å‘å¸ƒ â”œâ”€ åˆ†æ‰¹ç°åº¦ â”œâ”€ ç™½åå•å‘å¸ƒ â”œâ”€ åŠŸèƒ½å¼€å…³ç°åº¦ ä¸‰ã€ç°åº¦å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é£é™©å¯æ§ å¯è§‚å¯Ÿ å¯æš‚åœ å¯å›æ»š æ”¯æŒçœŸå®ç”¨æˆ·éªŒè¯ å››ã€ç°åº¦å‘å¸ƒçš„æ•´ä½“å½¢æ€ ç”¨æˆ·è¯·æ±‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æµé‡æ§åˆ¶å±‚ | \u0026lt;- ç°åº¦è§„åˆ™ â”‚ (LB / Gateway) â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ ç¨³å®šç‰ˆæœ¬ v1 â”‚ â”‚ ç°åº¦ç‰ˆæœ¬ v2 â”‚ â”‚ 80%æµé‡ | â”‚ 20%æµé‡ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ äº”ã€ç°åº¦å‘å¸ƒçš„å¸¸è§æ–¹å¼ï¼ˆé‡ç‚¹ï¼‰ 1ï¸âƒ£ æŒ‰æµé‡æ¯”ä¾‹ç°åº¦ 1% -\u0026gt; 5% -\u0026gt; 10% -\u0026gt; 50% -\u0026gt; 100% æœ€å¸¸è§ 2ï¸âƒ£ æŒ‰ç”¨æˆ·ç»´åº¦ç°åº¦ userId hash æ‰‹æœºå·å°¾å· ä¼ä¸š / è´¦å·çº§åˆ« ä¼˜ç‚¹ï¼š\n"},{"id":470,"href":"/management/operations/release-system-blue-green-deployment/","title":"å‘å¸ƒç³»ç»Ÿï¼šè“ç»¿å‘å¸ƒï¼ˆBlue-Green Deploymentï¼‰","parent":"Operations","content":" ä¸€ã€ä»€ä¹ˆæ˜¯è“ç»¿å‘å¸ƒï¼Ÿ è“ç»¿å‘å¸ƒï¼š\nåŒæ—¶ç»´æŠ¤ ä¸¤å¥—å®Œå…¨ç‹¬ç«‹ã€ç­‰ä»·çš„ç”Ÿäº§ç¯å¢ƒï¼š\nè“ç¯å¢ƒï¼ˆBlueï¼‰ï¼šå½“å‰çº¿ä¸Šæ­£åœ¨å¯¹å¤–æœåŠ¡çš„ç¨³å®šç‰ˆæœ¬ ç»¿ç¯å¢ƒï¼ˆGreenï¼‰ï¼šæ–°ç‰ˆæœ¬ç¯å¢ƒï¼Œåªæ¥æ”¶æµ‹è¯•æµé‡ å‘å¸ƒæ—¶ é€šè¿‡ä¸€æ¬¡æµé‡åˆ‡æ¢ï¼Œå°†æ‰€æœ‰ç”¨æˆ·ä»è“ç¯å¢ƒåˆ‡åˆ°ç»¿ç¯å¢ƒã€‚\nä¸€å¥è¯ï¼š\nåŒç¯å¢ƒï¼Œä¸€æ¬¡åˆ‡æµï¼Œç§’çº§å›æ»š\näºŒã€è“ç»¿å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é›¶åœæœº æä½å‘å¸ƒé£é™© æé€Ÿå›æ»š å‘å¸ƒè¿‡ç¨‹å¯æ§ã€å¯éªŒè¯ ä¸‰ã€è“ç»¿å‘å¸ƒæ•´ä½“æ¶æ„ ç”¨æˆ·æµé‡ â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚ LB / DNS â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ è“ç¯å¢ƒï¼ˆv1ï¼‰ ç»¿ç¯å¢ƒï¼ˆv2ï¼‰ ç¨³å®šç‰ˆæœ¬ æ–°ç‰ˆæœ¬ å…³é”®ç‚¹\nä¸¤å¥—ç¯å¢ƒé…ç½®ä¸€è‡´ æµé‡åˆ‡æ¢æ˜¯â€œåŸå­æ“ä½œâ€ å››ã€è“ç»¿å‘å¸ƒçš„å®Œæ•´æµç¨‹ï¼ˆæ ‡å‡†ç‰ˆï¼‰ 1ï¸âƒ£ å‡†å¤‡ç»¿ç¯å¢ƒ éƒ¨ç½²æ–°ç‰ˆæœ¬ä»£ç  ä½¿ç”¨åŒæ ·é…ç½®ï¼ˆå‚æ•°ã€èµ„æºï¼‰ è¿æ¥åŒä¸€æˆ–å…¼å®¹çš„æ•°æ®æº 2ï¸âƒ£ ç»¿ç¯å¢ƒè‡ªæµ‹ åŠŸèƒ½æµ‹è¯• æ¥å£å›å½’ å¥åº·æ£€æŸ¥ å‹æµ‹ï¼ˆå¯é€‰ï¼‰ æ­¤æ—¶ï¼š\nçº¿ä¸Šç”¨æˆ·ä»åœ¨è“ç¯å¢ƒ\n3ï¸âƒ£ åˆ‡æ¢æµé‡ï¼ˆå…³é”®ä¸€æ­¥ï¼‰ åˆ‡æ¢æ–¹å¼ï¼š\nè´Ÿè½½å‡è¡¡ï¼ˆNginx / SLB / ALBï¼‰ DNS åˆ‡æ¢ Ingress åˆ‡æ¢ åˆ‡æ¢åŠ¨ä½œ\nç§’çº§å®Œæˆ ä¸å½±å“è¿æ¥ï¼ˆå–å†³äºå®ç°ï¼‰ 4ï¸âƒ£ è§‚å¯Ÿ \u0026amp; éªŒè¯ é”™è¯¯ç‡ å»¶è¿Ÿ ä¸šåŠ¡æŒ‡æ ‡ æ—¥å¿—å¼‚å¸¸ 5ï¸âƒ£ å›æ»š or ä¸‹çº¿è“ç¯å¢ƒ æœ‰é—®é¢˜ï¼šç«‹å³åˆ‡å›è“ç¯å¢ƒ ç¨³å®šåï¼šä¸‹çº¿è“ç¯å¢ƒï¼Œæˆ–ä¿ç•™ä½œä¸ºä¸‹ä¸€æ¬¡å‘å¸ƒå¤‡ç”¨ äº”ã€è“ç»¿å‘å¸ƒçš„å‰ç½®æ¡ä»¶ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ ç¯å¢ƒå¿…é¡»å®Œå…¨ä¸€è‡´ ç³»ç»Ÿç‰ˆæœ¬ é…ç½® ç½‘ç»œ æƒé™ âŒ ç¯å¢ƒä¸ä¸€è‡´ = å‘å¸ƒç»“æœä¸å¯æ§\n2ï¸âƒ£ æ•°æ®åº“å…¼å®¹æ€§ ä¸¤å¥—ç¯å¢ƒå…±äº«æ•°æ®åº“ï¼Œæˆ– æ•°æ®åº“å‡çº§å‘å‰å…¼å®¹ âš ï¸ è“ç»¿å‘å¸ƒ â‰  æ•°æ®åº“å¯éšä¾¿æ”¹\n3ï¸âƒ£ ä¼šè¯ç®¡ç† Session ä¸ä¾èµ–æœ¬åœ° Cookie / Token å¯è·¨ç¯å¢ƒ å…­ã€è“ç»¿å‘å¸ƒçš„å¸¸è§å®ç°æ–¹å¼ 1ï¸âƒ£ è´Ÿè½½å‡è¡¡åˆ‡æ¢ï¼ˆæœ€å¸¸è§ï¼‰ ä¿®æ”¹ upstream æŒ‡å‘ Ingress backend åˆ‡æ¢ æƒé‡ä» 100/0 -\u0026gt; 0/100 ä¼˜ç‚¹ï¼š\nå¿« å¯æ§ å¯è‡ªåŠ¨åŒ– 2ï¸âƒ£ DNS åˆ‡æ¢ ä¿®æ”¹ A/AAAA è®°å½• ä¾èµ– TTL ç¼ºç‚¹ï¼š\nç”Ÿæ•ˆä¸å¯æ§ å›æ»šæ…¢ âš ï¸ ç”Ÿäº§ç¯å¢ƒä¸æ¨èä½œä¸ºå”¯ä¸€æ–¹å¼\n3ï¸âƒ£ Kubernetes ä¸­çš„è“ç»¿ å®ç°æ–¹å¼ï¼š\nä¸¤å¥— Deploymentï¼ˆblue / greenï¼‰ ä¸€ä¸ª Service åˆ‡æ¢ selector æˆ– Ingress ä¸ƒã€è“ç»¿å‘å¸ƒ vs æ»šåŠ¨å‘å¸ƒ ç»´åº¦ è“ç»¿å‘å¸ƒ æ»šåŠ¨å‘å¸ƒ åœæœº æ—  æ—  å›æ»š ç§’çº§ è¾ƒæ…¢ é£é™© æä½ ä¸­ æˆæœ¬ é«˜ï¼ˆåŒç¯å¢ƒï¼‰ ä½ å®ç°å¤æ‚åº¦ ä¸­ ä½ å…«ã€è“ç»¿å‘å¸ƒçš„ä¼˜ç‚¹ \u0026amp; ç¼ºç‚¹ âœ… ä¼˜ç‚¹\nå›æ»šæå¿« å‘å¸ƒå½±å“é¢å° å‘å¸ƒç»“æœæ˜ç¡® éå¸¸é€‚åˆæ ¸å¿ƒç³»ç»Ÿ âŒ ç¼ºç‚¹\nèµ„æºæˆæœ¬é«˜ æ•°æ®åº“å˜æ›´å¤æ‚ åŒç¯å¢ƒç»´æŠ¤æˆæœ¬ ä¹ã€è“ç»¿å‘å¸ƒçš„æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ åˆ‡æµå‰å¿…é¡»å…¨é‡éªŒè¯ åˆ‡æµåŠ¨ä½œå¿…é¡»è‡ªåŠ¨åŒ– åˆ‡æµå¿…é¡»æ”¯æŒä¸€é”®å›æ»š æ•°æ®åº“å…ˆåšå…¼å®¹å‡çº§ åˆ‡æµåè§‚å¯Ÿ 10~30 åˆ†é’Ÿ ä¿ç•™è“ç¯å¢ƒè‡³å°‘ 1 ä¸ªå‘å¸ƒå‘¨æœŸ åˆ‡æµå¿…é¡»æœ‰ç›‘æ§ä¸å‘Šè­¦å…œåº• åã€ä»€ä¹ˆæ—¶å€™æœ€é€‚åˆç”¨è“ç»¿å‘å¸ƒï¼Ÿ æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿ ç”¨æˆ·é‡å¤§ ä¸å…è®¸å¤±è´¥ å¯¹å›æ»šæ—¶é—´æåº¦æ•æ„Ÿ SLA è¦æ±‚é«˜ï¼ˆ99.99%+ï¼‰ åä¸€ã€æ€»ç»“ è“ç»¿å‘å¸ƒç”¨â€œèµ„æºæ¢ç¡®å®šæ€§â€ï¼Œæ˜¯é«˜å¯é ç³»ç»Ÿæœ€å€¼å¾—æŠ•å…¥çš„å‘å¸ƒæ–¹å¼ã€‚\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯è“ç»¿å‘å¸ƒï¼Ÿ è“ç»¿å‘å¸ƒï¼š\nåŒæ—¶ç»´æŠ¤ ä¸¤å¥—å®Œå…¨ç‹¬ç«‹ã€ç­‰ä»·çš„ç”Ÿäº§ç¯å¢ƒï¼š\nè“ç¯å¢ƒï¼ˆBlueï¼‰ï¼šå½“å‰çº¿ä¸Šæ­£åœ¨å¯¹å¤–æœåŠ¡çš„ç¨³å®šç‰ˆæœ¬ ç»¿ç¯å¢ƒï¼ˆGreenï¼‰ï¼šæ–°ç‰ˆæœ¬ç¯å¢ƒï¼Œåªæ¥æ”¶æµ‹è¯•æµé‡ å‘å¸ƒæ—¶ é€šè¿‡ä¸€æ¬¡æµé‡åˆ‡æ¢ï¼Œå°†æ‰€æœ‰ç”¨æˆ·ä»è“ç¯å¢ƒåˆ‡åˆ°ç»¿ç¯å¢ƒã€‚\nä¸€å¥è¯ï¼š\nåŒç¯å¢ƒï¼Œä¸€æ¬¡åˆ‡æµï¼Œç§’çº§å›æ»š\näºŒã€è“ç»¿å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ é›¶åœæœº æä½å‘å¸ƒé£é™© æé€Ÿå›æ»š å‘å¸ƒè¿‡ç¨‹å¯æ§ã€å¯éªŒè¯ ä¸‰ã€è“ç»¿å‘å¸ƒæ•´ä½“æ¶æ„ ç”¨æˆ·æµé‡ â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚ LB / DNS â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ è“ç¯å¢ƒï¼ˆv1ï¼‰ ç»¿ç¯å¢ƒï¼ˆv2ï¼‰ ç¨³å®šç‰ˆæœ¬ æ–°ç‰ˆæœ¬ å…³é”®ç‚¹\n"},{"id":471,"href":"/management/operations/release-system-canary-deployment/","title":"å‘å¸ƒç³»ç»Ÿï¼šé‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deploymentï¼‰","parent":"Operations","content":" ä¸€ã€ä»€ä¹ˆæ˜¯é‡‘ä¸é›€å‘å¸ƒï¼Ÿ é‡‘ä¸é›€å‘å¸ƒï¼š\nå…ˆå°†æ–°ç‰ˆæœ¬åªå¼€æ”¾ç»™æå°‘é‡ç”¨æˆ·æˆ–æµé‡ï¼Œè§‚å¯Ÿç³»ç»Ÿä¸ä¸šåŠ¡æŒ‡æ ‡ï¼› ç¡®è®¤ç¨³å®šåï¼Œå†é€æ­¥æ‰©å¤§æµé‡ï¼Œæœ€ç»ˆå…¨é‡å‘å¸ƒã€‚\nä¸€å¥è¯ï¼š\nå…ˆå°æµé‡è¯•æ¯’ï¼Œå†é€æ­¥æ”¾é‡\nåç§°æ¥æºï¼š\nçŸ¿äº•é‡Œçš„é‡‘ä¸é›€â€”â€”æœ€æ—©æ„ŸçŸ¥å±é™©\näºŒã€é‡‘ä¸é›€å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ æŠŠé£é™©æ§åˆ¶åœ¨æœ€å°èŒƒå›´ åœ¨çœŸå®ç”¨æˆ·æµé‡ä¸‹éªŒè¯ éšæ—¶å¯æš‚åœã€å¯å›æ»š æ”¯æŒç°åº¦ã€AB å®éªŒ ä¸‰ã€é‡‘ä¸é›€å‘å¸ƒæ•´ä½“æ¶æ„ ç”¨æˆ·æµé‡ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚ LB / Gateway â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ ç¨³å®šç‰ˆæœ¬ï¼ˆv1ï¼‰ é‡‘ä¸é›€ç‰ˆæœ¬ï¼ˆv2ï¼‰ 95% æµé‡ 5% æµé‡ å››ã€é‡‘ä¸é›€å‘å¸ƒçš„å®Œæ•´æµç¨‹ï¼ˆæ ‡å‡†ç‰ˆï¼‰ 1ï¸âƒ£ éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬ æ–°ç‰ˆæœ¬åªéƒ¨ç½²å°‘é‡å®ä¾‹ ä¸æ­£å¼ç‰ˆæœ¬å¹¶å­˜ é…ç½®ä¿æŒä¸€è‡´ 2ï¸âƒ£ æµé‡åˆ†é…ï¼ˆå…³é”®ï¼‰ å¸¸è§æ–¹å¼ï¼š\næŒ‰æ¯”ä¾‹ï¼ˆ1% / 5% / 10%ï¼‰ æŒ‰ç”¨æˆ·ç‰¹å¾ userId hash IP åœ°åŒº UA æŒ‰è¯·æ±‚å¤´ Header / Cookie å†…éƒ¨ç™½åå• 3ï¸âƒ£ ç›‘æ§ \u0026amp; éªŒè¯ é‡ç‚¹æŒ‡æ ‡ï¼š\né”™è¯¯ç‡ å»¶è¿Ÿï¼ˆP99ï¼‰ æˆåŠŸç‡ ä¸šåŠ¡æŒ‡æ ‡ï¼ˆä¸‹å•ç‡ã€è½¬åŒ–ç‡ï¼‰ 4ï¸âƒ£ å†³ç­– æ­£å¸¸ -\u0026gt; æ‰©å¤§æµé‡ å¼‚å¸¸ -\u0026gt; ç«‹å³å›æ»š ä¸ç¡®å®š -\u0026gt; ä¿æŒæ¯”ä¾‹ç»§ç»­è§‚å¯Ÿ 5ï¸âƒ£ å…¨é‡å‘å¸ƒ æµé‡é€æ­¥æ”¾å¤§åˆ° 100% ä¸‹çº¿æ—§ç‰ˆæœ¬ äº”ã€é‡‘ä¸é›€å‘å¸ƒçš„å‰ç½®æ¡ä»¶ï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ æµé‡å¯æ§ å¿…é¡»èƒ½ç²¾ç¡®æ§åˆ¶æµé‡ LB / Ingress / API Gateway æ”¯æŒæƒé‡æˆ–è§„åˆ™ 2ï¸âƒ£ ç›‘æ§å¿…é¡»å®Œå–„ å®æ—¶ç›‘æ§ æŒ‡æ ‡å¿…é¡»åŒºåˆ†ç‰ˆæœ¬ å»¶è¿Ÿã€é”™è¯¯ç‡è¦æœ‰åŸºçº¿ 3ï¸âƒ£ ç‰ˆæœ¬å¯å¹¶å­˜ å‘å‰å…¼å®¹ æ•°æ®åº“å­—æ®µä¸ç ´åæ—§ç‰ˆæœ¬ å…­ã€é‡‘ä¸é›€å‘å¸ƒçš„å®ç°æ–¹å¼ 1ï¸âƒ£ ç½‘å…³ / è´Ÿè½½å‡è¡¡ï¼ˆæœ€å¸¸è§ï¼‰ Nginx æƒé‡ Ingress annotations API Gateway è·¯ç”±è§„åˆ™ 2ï¸âƒ£ Kubernetes + Service Mesh Istio / Linkerd ç²¾ç»†æµé‡æ²»ç† æŒ‰è¯·æ±‚çº§åˆ«æ§åˆ¶ 3ï¸âƒ£ åº”ç”¨å†…ç°åº¦ Feature Toggle é…ç½®ä¸­å¿ƒ åŠ¨æ€å¼€å…³ ä¸ƒã€é‡‘ä¸é›€å‘å¸ƒ vs è“ç»¿ vs æ»šåŠ¨ ç»´åº¦ é‡‘ä¸é›€ è“ç»¿ æ»šåŠ¨ é£é™© æä½ ä½ ä¸­ å›æ»š å¿« ç§’çº§ è¾ƒæ…¢ æˆæœ¬ ä¸­ é«˜ ä½ å¤æ‚åº¦ é«˜ ä¸­ ä½ æ˜¯å¦ç°åº¦ âœ… âŒ âŒ å…«ã€é‡‘ä¸é›€å‘å¸ƒçš„ä¼˜ç‚¹ \u0026amp; ç¼ºç‚¹ âœ… ä¼˜ç‚¹\né£é™©æœ€ä½ æœ€æ¥è¿‘çœŸå®ç”¨æˆ· æ”¯æŒä¸šåŠ¡å®éªŒ éå¸¸é€‚åˆé«˜å¹¶å‘ç³»ç»Ÿ âŒ ç¼ºç‚¹\nå®ç°å¤æ‚ ç›‘æ§è¦æ±‚é«˜ é—®é¢˜å¤ç°å¯èƒ½å›°éš¾ æµ‹è¯•å‘¨æœŸè¾ƒé•¿ ä¹ã€é‡‘ä¸é›€å‘å¸ƒçš„æœ€ä½³å®è·µï¼ˆé‡ç‚¹ï¼‰ é‡‘ä¸é›€æµé‡ â‰¤ 5% èµ·æ­¥ æ¯ä¸€é˜¶æ®µè‡³å°‘è§‚å¯Ÿ 10~30 åˆ†é’Ÿ æŒ‡æ ‡å¿…é¡»ä¸ç¨³å®šç‰ˆæœ¬å¯¹æ¯” å‡ºç°å¼‚å¸¸ç«‹å³è‡ªåŠ¨å›æ»š ç»“åˆé™æµã€ç†”æ–­ã€é™çº§ é‡è¦å˜æ›´å¿…é¡»å…ˆé‡‘ä¸é›€ ä¸ Feature Toggle æ­é…ä½¿ç”¨ åã€ä»€ä¹ˆæ—¶å€™æœ€é€‚åˆé‡‘ä¸é›€å‘å¸ƒï¼Ÿ ç”¨æˆ·è§„æ¨¡å·¨å¤§ æ–°åŠŸèƒ½é£é™©æœªçŸ¥ æ€§èƒ½æ”¹åŠ¨æ˜æ˜¾ ç®—æ³• / æ¨è / ç­–ç•¥å˜æ›´ æ ¸å¿ƒé“¾è·¯ç³»ç»Ÿ åä¸€ã€æ€»ç»“ é‡‘ä¸é›€å‘å¸ƒæ˜¯é£é™©æ§åˆ¶çš„ç»ˆæå½¢æ€ï¼Œæ˜¯é«˜æˆç†Ÿåº¦ç³»ç»Ÿçš„æ ‡å¿—ã€‚\n","description":" ä¸€ã€ä»€ä¹ˆæ˜¯é‡‘ä¸é›€å‘å¸ƒï¼Ÿ é‡‘ä¸é›€å‘å¸ƒï¼š\nå…ˆå°†æ–°ç‰ˆæœ¬åªå¼€æ”¾ç»™æå°‘é‡ç”¨æˆ·æˆ–æµé‡ï¼Œè§‚å¯Ÿç³»ç»Ÿä¸ä¸šåŠ¡æŒ‡æ ‡ï¼› ç¡®è®¤ç¨³å®šåï¼Œå†é€æ­¥æ‰©å¤§æµé‡ï¼Œæœ€ç»ˆå…¨é‡å‘å¸ƒã€‚\nä¸€å¥è¯ï¼š\nå…ˆå°æµé‡è¯•æ¯’ï¼Œå†é€æ­¥æ”¾é‡\nåç§°æ¥æºï¼š\nçŸ¿äº•é‡Œçš„é‡‘ä¸é›€â€”â€”æœ€æ—©æ„ŸçŸ¥å±é™©\näºŒã€é‡‘ä¸é›€å‘å¸ƒçš„æ ¸å¿ƒç›®æ ‡ æŠŠé£é™©æ§åˆ¶åœ¨æœ€å°èŒƒå›´ åœ¨çœŸå®ç”¨æˆ·æµé‡ä¸‹éªŒè¯ éšæ—¶å¯æš‚åœã€å¯å›æ»š æ”¯æŒç°åº¦ã€AB å®éªŒ ä¸‰ã€é‡‘ä¸é›€å‘å¸ƒæ•´ä½“æ¶æ„ ç”¨æˆ·æµé‡ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚ LB / Gateway â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ ç¨³å®šç‰ˆæœ¬ï¼ˆv1ï¼‰ é‡‘ä¸é›€ç‰ˆæœ¬ï¼ˆv2ï¼‰ 95% æµé‡ 5% æµé‡ å››ã€é‡‘ä¸é›€å‘å¸ƒçš„å®Œæ•´æµç¨‹ï¼ˆæ ‡å‡†ç‰ˆï¼‰ 1ï¸âƒ£ éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬ æ–°ç‰ˆæœ¬åªéƒ¨ç½²å°‘é‡å®ä¾‹ ä¸æ­£å¼ç‰ˆæœ¬å¹¶å­˜ é…ç½®ä¿æŒä¸€è‡´ 2ï¸âƒ£ æµé‡åˆ†é…ï¼ˆå…³é”®ï¼‰ å¸¸è§æ–¹å¼ï¼š\n"},{"id":472,"href":"/operations/kvm/install-kvm-on-almalinux-9/","title":"åœ¨ AlmaLinux 9 ä¸Šå®‰è£… KVM","parent":"KVM","content":" ä¸€ã€ç¯å¢ƒä¸å‰ç½®æ¡ä»¶ ç¡¬ä»¶è¦æ±‚\nCPUï¼šæ”¯æŒ Intel VT-x / AMD-V BIOSï¼šå¼€å¯ Virtualization å†…å­˜ï¼šâ‰¥ 16 GBï¼ˆ8 GB å‹‰å¼ºï¼‰ ç£ç›˜ï¼šâ‰¥ 100 GB éªŒè¯ CPU è™šæ‹ŸåŒ–\negrep -c \u0026#39;(vmx|svm)\u0026#39; /proc/cpuinfo â‰¥1 å³æ”¯æŒ\näºŒã€å®‰è£… KVM æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ å®‰è£…è™šæ‹ŸåŒ–ç»„ä»¶ dnf install -y \\ qemu-kvm \\ libvirt \\ virt-install \\ virt-manager \\ virt-viewer \\ bridge-utils \\ cockpit \\ cockpit-files \\ cockpit-machines \\ cockpit-podman \\ cockpit-storaged å°†æœ‰ sudo æƒé™çš„ç”¨æˆ·åŠ å…¥ libvirt ç»„ï¼š\nusermod -aG libvirt admin usermod -aG wheel admin Web ç™»å½•æ—¶, ä¹Ÿæ¨èä½¿ç”¨æœ‰ sudo æƒé™çš„ç”¨æˆ· 2ï¸âƒ£ å¯åŠ¨ libvirt systemctl enable --now libvirtd éªŒè¯\nvirsh list --all ä¸‰ã€å­˜å‚¨è§„åˆ’ ç›®å½•å­˜å‚¨\nmkdir -p /data/kvm/images chown -R qemu:qemu /data/kvm virsh pool-define-as default dir - - - - \u0026#34;/data/kvm/images\u0026#34; virsh pool-start default virsh pool-autostart default ä¸‹è½½ ISO\nmkdir -p /data/isos wget -P /data/isos https://repo.almalinux.org/almalinux/9/isos/x86_64/AlmaLinux-9.7-x86_64-minimal.iso å››ã€Cockpit Web ç®¡ç†ï¼ˆæ¨èï¼‰ systemctl enable --now cockpit.socket è®¿é—®ï¼š\nhttps://\u0026lt;IP\u0026gt;:9090 Web ç®¡ç† VM è½»é‡ã€å®˜æ–¹æ”¯æŒ ä¸èƒ½ä½¿ç”¨ root ç™»å½• ä½¿ç”¨ sudo æƒé™çš„ç”¨æˆ·ç™»å½•ï¼Œæ¯”å¦‚ admin å¦‚æœå³ä¸Šè§’æ˜¾ç¤º ğŸ”’è¢«é™åˆ¶çš„è®¿é—®ï¼Œç‚¹å‡»ï¼Œåˆ‡æ¢ä¸º ç®¡ç†å‘˜æ¨¡å¼ã€‚\næ¥ä¸‹æ¥ åˆ›å»ºæ¡¥æ¥ç½‘å¡ï¼Œç„¶å åˆ›å»ºè™šæ‹Ÿæœºï¼Œæœ€å é…ç½®ç½‘ç»œã€‚\näº”ã€ç›‘æ§ systemctl enable --now pmlogger.service ","description":" ä¸€ã€ç¯å¢ƒä¸å‰ç½®æ¡ä»¶ ç¡¬ä»¶è¦æ±‚\nCPUï¼šæ”¯æŒ Intel VT-x / AMD-V BIOSï¼šå¼€å¯ Virtualization å†…å­˜ï¼šâ‰¥ 16 GBï¼ˆ8 GB å‹‰å¼ºï¼‰ ç£ç›˜ï¼šâ‰¥ 100 GB éªŒè¯ CPU è™šæ‹ŸåŒ–\negrep -c \u0026#39;(vmx|svm)\u0026#39; /proc/cpuinfo â‰¥1 å³æ”¯æŒ\näºŒã€å®‰è£… KVM æ ¸å¿ƒç»„ä»¶ 1ï¸âƒ£ å®‰è£…è™šæ‹ŸåŒ–ç»„ä»¶ dnf install -y \\ qemu-kvm \\ libvirt \\ virt-install \\ virt-manager \\ virt-viewer \\ bridge-utils \\ cockpit \\ cockpit-files \\ cockpit-machines \\ cockpit-podman \\ cockpit-storaged å°†æœ‰ sudo æƒé™çš„ç”¨æˆ·åŠ å…¥ libvirt ç»„ï¼š\n"},{"id":473,"href":"/database/mysql/install-mysql-8.4-on-almalinux-9/","title":"åœ¨ AlmaLinux 9 ä¸Šå®‰è£… MySQL 8.4","parent":"MySQL","content":"è¿ç»´ç¯å¢ƒï¼š\næ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 æ•°æ®åº“ç‰ˆæœ¬ï¼šPercona Server 8.4 å‡†å¤‡å·¥ä½œ âš ï¸ ä¸æ¨è Percona å®˜æ–¹çš„ YUM ä»“åº“ï¼Œå› ä¸ºæœ‰äº›ç‰ˆæœ¬å¯èƒ½è¾ƒä½ï¼Œæˆ–è€…å…¼å®¹æ€§æœ‰é—®é¢˜ã€‚\nâœ… æ¨èä¸‹è½½ RPM åŒ…ï¼Œå¹¶æ‰‹åŠ¨å®‰è£…ã€‚\nä¸‹è½½ RPM åŒ… Percona å®˜æ–¹ä¸‹è½½é“¾æ¥ï¼šhttps://www.percona.com/downloads\nPercona Distribution for MySQL\nSelect Productï¼šPercona Distribution for MySQL Select Product Versionï¼šPERCONA-DISTRIBUTION-MYSQL-PS-8.4.7 Select Platformï¼šRED HAT ENTERPRISE LINUX / CENTOS / ORACLE LINUX 9 ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶\næ³¨æ„ï¼šå¹³å°æ˜¯ x86_64 jemalloc jemalloc-devel percona-icu-data-files percona-mysql-router percona-mysql-shell percona-orchestrator percona-orchestrator-cli percona-orchestrator-client percona-server-client percona-server-devel percona-server-js percona-server-rocksdb percona-server-server percona-server-shared percona-telemetry-agent percona-toolkit percona-xtrabackup-84 perl-DBD-MySQL proxysql2 qpress-11 Percona Server 8.4.7 çš„ç›¸å…³æ–‡ä»¶\njemalloc-3.6.0-1.el9.x86_64.rpm jemalloc-devel-3.6.0-1.el9.x86_64.rpm percona-icu-data-files-8.4.7-7.1.el9.x86_64.rpm percona-mysql-router-8.4.7-7.1.el9.x86_64.rpm percona-mysql-shell-8.4.7-1.el9.x86_64.rpm percona-orchestrator-3.2.6-19.el9.x86_64.rpm percona-orchestrator-cli-3.2.6-19.el9.x86_64.rpm percona-orchestrator-client-3.2.6-19.el9.x86_64.rpm percona-server-client-8.4.7-7.1.el9.x86_64.rpm percona-server-devel-8.4.7-7.1.el9.x86_64.rpm percona-server-js-8.4.7-7.1.el9.x86_64.rpm percona-server-rocksdb-8.4.7-7.1.el9.x86_64.rpm percona-server-server-8.4.7-7.1.el9.x86_64.rpm percona-server-shared-8.4.7-7.1.el9.x86_64.rpm percona-telemetry-agent-1.0.7-1.el9.x86_64.rpm percona-toolkit-3.7.1-2.el9.x86_64.rpm percona-xtrabackup-84-8.4.0-5.1.el9.x86_64.rpm perl-DBD-MySQL-5.013-1.el9.x86_64.rpm proxysql2-2.7.3-1.1.el9.x86_64.rpm qpress-11-4.el9.x86_64.rpm å®‰è£… Percona MySQL ç¦ç”¨ç³»ç»Ÿé»˜è®¤çš„ MySQL ä»“åº“ dnf module disable mysql å®‰è£… MySQL æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ã€è¿ç»´å·¥å…· dnf install -y \\ percona-icu-data-files-*.rpm \\ percona-mysql-shell-*.rpm \\ percona-server-client-*.rpm \\ percona-server-devel-*.rpm \\ percona-server-server-*.rpm \\ percona-server-shared-*.rpm \\ percona-telemetry-agent-*.rpm \\ percona-toolkit-*.rpm \\ percona-xtrabackup-84-*.rpm \\ perl-DBD-MySQL-*.rpm å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯ # å¤‡ä»½é…ç½®æ–‡ä»¶ cp -v /etc/my.cnf /etc/my.cnf_default # ä½¿ç”¨ Go è¯­è¨€ç¼–å†™çš„ gen-mysql-cnf ç”Ÿæˆé…ç½®æ–‡ä»¶ mysql.cnf ./gen-mysql-cnf-linux-amd64 -version 8.4 # æ‹·è´é…ç½®æ–‡ä»¶ cp -v mysql.cnf /etc/my.cnf # åˆ é™¤æ•°æ®ç›®å½• rm -rf /data/mysql/8.4/{data,log} /var/lib/mysql /var/run/mysqld # åˆ›å»ºæ•°æ®ç›®å½• mkdir -p /data/mysql/8.4/{data,log} /var/lib/mysql /var/run/mysqld # è®¾ç½®æƒé™ chown -R mysql:mysql /data/mysql/8.4/{data,log} /var/lib/mysql /var/run/mysqld # å¯åŠ¨æœåŠ¡ systemctl start mysqld # é¦–æ¬¡å¯åŠ¨éœ€è¦ç­‰å¾…ä¸€ä¼š, MySQL éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ # æŸ¥çœ‹çŠ¶æ€ systemctl status mysqld # æŸ¥çœ‹æ—¥å¿— cat /data/mysql/8.4/log/mysqld.log # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable mysqld ä¿®æ”¹ MySQL root å¯†ç  # è·å– MySQL åˆå§‹ root å¯†ç  grep \u0026#39;temporary password\u0026#39; /data/mysql/8.4/log/mysqld.log # ç™»å½• MySQL mysql -uroot -p ä¿®æ”¹å¯†ç ï¼š\nALTER USER \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;KdX3V7nC!9#Q\u0026#39;; CREATE USER \u0026#39;root\u0026#39;@\u0026#39;127.0.0.1\u0026#39; IDENTIFIED BY \u0026#39;KdX3V7nC!9#Q\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;root\u0026#39;@\u0026#39;127.0.0.1\u0026#39; WITH GRANT OPTION; CREATE USER \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;KdX3V7nC!9#Q\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;root\u0026#39;@\u0026#39;%\u0026#39; WITH GRANT OPTION; FLUSH PRIVILEGES; ","description":"è¿ç»´ç¯å¢ƒï¼š\næ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 æ•°æ®åº“ç‰ˆæœ¬ï¼šPercona Server 8.4 å‡†å¤‡å·¥ä½œ âš ï¸ ä¸æ¨è Percona å®˜æ–¹çš„ YUM ä»“åº“ï¼Œå› ä¸ºæœ‰äº›ç‰ˆæœ¬å¯èƒ½è¾ƒä½ï¼Œæˆ–è€…å…¼å®¹æ€§æœ‰é—®é¢˜ã€‚\nâœ… æ¨èä¸‹è½½ RPM åŒ…ï¼Œå¹¶æ‰‹åŠ¨å®‰è£…ã€‚\nä¸‹è½½ RPM åŒ… Percona å®˜æ–¹ä¸‹è½½é“¾æ¥ï¼šhttps://www.percona.com/downloads\nPercona Distribution for MySQL\nSelect Productï¼šPercona Distribution for MySQL Select Product Versionï¼šPERCONA-DISTRIBUTION-MYSQL-PS-8.4.7 Select Platformï¼šRED HAT ENTERPRISE LINUX / CENTOS / ORACLE LINUX 9 ä¸‹è½½ä»¥ä¸‹æ–‡ä»¶\n"},{"id":474,"href":"/database/postgres/install-postgres-18-on-almalinux-9/","title":"åœ¨ AlmaLinux 9 ä¸Šå®‰è£… PostgreSQL 18","parent":"PostgreSQL","content":"å®˜æ–¹æ–‡æ¡£ï¼šLinux downloads (Red Hat family)\nè¿ç»´ç¯å¢ƒï¼š\næ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 æ•°æ®åº“ç‰ˆæœ¬ï¼šPostgreSQL 18 å‡†å¤‡å·¥ä½œ å®‰è£… Percona å®˜æ–¹ YUM ä»“åº“ dnf install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm éªŒè¯ä»“åº“çŠ¶æ€ï¼š\npercona-release show âš ï¸ å»ºè®®ä¸è¦åŒæ—¶å¯ç”¨å®˜æ–¹ PostgreSQLï¼ˆPGDGï¼‰æˆ– MySQL Oracle å®˜æ–¹ä»“åº“ï¼Œé¿å…ç‰ˆæœ¬å†²çªã€‚\nå®‰è£… Percona PostgreSQL 18 å¯ç”¨ PostgreSQL 18 ä»“åº“ dnf -qy module disable postgresql percona-release setup ppg-18 è¯´æ˜ï¼š\nppg = Percona PostgreSQL 18 = PostgreSQL 18ï¼ˆå½“å‰ç¨³å®šå¤§ç‰ˆæœ¬ï¼‰ å®‰è£… PostgreSQL 18 åŠå¸¸ç”¨ç»„ä»¶ # å¦‚æœ dnf install é€Ÿåº¦å¾ˆæ…¢, å¯ä»¥è®¾ç½®ä»£ç† # export http_proxy=http://127.0.0.1:1080;export https_proxy=http://127.0.0.1:1080; dnf install -y \\ --enablerepo=crb perl-IPC-Run \\ percona-postgresql18 \\ percona-postgresql18-devel \\ percona-postgresql18-libs \\ percona-postgresql18-server \\ percona-patroni \\ percona-pg_repack18 \\ percona-pgbackrest \\ percona-pgbouncer \\ percona-pgvector_18 ç»„ä»¶è¯´æ˜ åŒ…å ä½œç”¨ percona-postgresql18 PostgreSQL å®¢æˆ·ç«¯ percona-postgresql18-server PostgreSQL æœåŠ¡ç«¯ percona-postgresql18-libs è¿è¡Œæ—¶åº“ percona-postgresql18-devel ç¼–è¯‘æ‰©å±•ç”¨ percona-pgbackrest ç”Ÿäº§çº§å¤‡ä»½å·¥å…· percona-pgbouncer è¿æ¥æ±  åˆå§‹åŒ–æ•°æ®åº“ # é»˜è®¤æ•°æ®ç›®å½• # /var/lib/pgsql/18/data # ä¿®æ”¹ä¸º # /data/pgsql/18/data # åˆ›å»ºç›®å½•å¹¶è®¾ç½®æƒé™ # /var/lib/pgsql/18 ç›®å½•å¿…é¡»åˆ›å»º, å¦åˆ™ä¼šæŠ¥é”™ # /usr/pgsql-18/bin/postgresql-18-setup initdb # Initializing database ... touch: cannot touch \u0026#39;/var/lib/pgsql/18/initdb.log\u0026#39;: No such file or directory rm -rf /data/pgsql/18 /var/lib/pgsql/18 mkdir -p /data/pgsql/18/{backup,data} /var/lib/pgsql/18 chown -R postgres:postgres /data/pgsql/18/{backup,data} chmod 700 /data/pgsql/18/{backup,data} # initdb å‚æ•° # ä¸è¦æ·»åŠ  --pwprompt export PGSETUP_INITDB_OPTIONS=\u0026#34; --pgdata=/data/pgsql/18/data --encoding=UTF8 --locale=C --auth-host=scram-sha-256 --data-checksums \u0026#34; # åˆå§‹åŒ– /usr/pgsql-18/bin/postgresql-18-setup initdb # è¿›å…¥æ•°æ®ç›®å½• cd /data/pgsql/18/data # å¤‡ä»½é…ç½®æ–‡ä»¶ cp pg_hba.conf pg_hba.conf_default cp postgresql.conf postgresql.conf_default # ä¿®æ”¹é…ç½®æ–‡ä»¶ tee pg_hba.conf \u0026gt;/dev/null \u0026lt;\u0026lt;\u0026#39;EOF\u0026#39; #TYPE DATABASE USER ADDRESS METHOD local all all trust host all all 127.0.0.1/32 trust host all all all scram-sha-256 EOF # ä¿®æ”¹ç›‘å¬åœ°å€ sed -i \u0026#34;s/^#\\(listen_addresses =\\).*/\\1 \u0026#39;*\u0026#39;/g\u0026#34; postgresql.conf # ä¿®æ”¹ systemd å‚æ•° sed -i \u0026#39;s|^Environment=PGDATA=.*|Environment=PGDATA=/data/pgsql/18/data|g\u0026#39; /usr/lib/systemd/system/postgresql-18.service # é‡è½½ systemd systemctl daemon-reload # å¯åŠ¨ systemctl start postgresql-18 # æŸ¥çœ‹çŠ¶æ€ systemctl status postgresql-18 # æŸ¥çœ‹ç«¯å£ ss -netlap | grep postgres # psql: symbol lookup error: psql: undefined symbol: PQpipelineStatus # rpm -qa | grep -E \u0026#39;postgresql.*libs|libpq\u0026#39; # dnf remove libpq # ä¿®æ”¹å¯†ç  /usr/pgsql-18/bin/psql -d postgres -U postgres -c \u0026#34;ALTER USER postgres WITH PASSWORD \u0026#39;KdX3V7nC\u0026#39;;\u0026#34; # éªŒè¯ PostgreSQL ç‰ˆæœ¬ /usr/pgsql-18/bin/psql -d postgres -U postgres -c \u0026#34;SELECT version();\u0026#34; # è®¾ç½®å¼€æœºè‡ªå¯ systemctl enable postgresql-18 å®˜æ–¹ä»“åº“å®‰è£…æ–¹æ³• # å› ä¸º HTTPä»£ç† çš„é—®é¢˜, ä¸è¦ç”¨ sudo, ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œ su - root # å¦‚æœ dnf install é€Ÿåº¦å¾ˆæ…¢, å¯ä»¥è®¾ç½®ä»£ç† # export http_proxy=http://127.0.0.1:1080;export https_proxy=http://127.0.0.1:1080; # æ·»åŠ  PostgreSQL ä»“åº“ dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm # ç¦ç”¨æ‰€æœ‰ PostgreSQL æ¨¡å— sed -i \u0026#39;s/enabled=1/enabled=0/g\u0026#39; /etc/yum.repos.d/pgdg-redhat-all.repo # å…³é—­æ‰€æœ‰ PostgreSQL æ¨¡å— dnf -qy module disable postgresql # å®‰è£… Perl æ¨¡å— dnf install -y --enablerepo=crb perl-IPC-Run # å®‰è£… PostgreSQL 18 åŸºç¡€åŒ… dnf install -y --enablerepo=pgdg18 postgresql18 postgresql18-devel postgresql18-libs ","description":"å®˜æ–¹æ–‡æ¡£ï¼šLinux downloads (Red Hat family)\nè¿ç»´ç¯å¢ƒï¼š\næ“ä½œç³»ç»Ÿï¼šAlmaLinux 9.7 æ•°æ®åº“ç‰ˆæœ¬ï¼šPostgreSQL 18 å‡†å¤‡å·¥ä½œ å®‰è£… Percona å®˜æ–¹ YUM ä»“åº“ dnf install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm éªŒè¯ä»“åº“çŠ¶æ€ï¼š\npercona-release show âš ï¸ å»ºè®®ä¸è¦åŒæ—¶å¯ç”¨å®˜æ–¹ PostgreSQLï¼ˆPGDGï¼‰æˆ– MySQL Oracle å®˜æ–¹ä»“åº“ï¼Œé¿å…ç‰ˆæœ¬å†²çªã€‚\nå®‰è£… Percona PostgreSQL 18 å¯ç”¨ PostgreSQL 18 ä»“åº“ dnf -qy module disable postgresql percona-release setup ppg-18 è¯´æ˜ï¼š\n"},{"id":475,"href":"/operations/linux/check-user-exist/","title":"å¦‚ä½•åˆ¤æ–­ç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨","parent":"Linux","content":"åœ¨ Linuxï¼ˆåŒ…æ‹¬ AlmaLinuxï¼‰ä¸­ï¼Œå¯ä»¥ç”¨å‡ ç§æ–¹æ³•æ¥åˆ¤æ–­ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š\nâœ… æ–¹æ³•ä¸€ï¼šid å‘½ä»¤ï¼ˆæ¨èï¼‰ id ç”¨æˆ·å å¦‚æœç”¨æˆ·å­˜åœ¨ï¼Œä¼šæ˜¾ç¤º UIDã€GID ç­‰ä¿¡æ¯ï¼š\nuid=1000(martin) gid=1000(martin) groups=1000(martin),10(wheel) å¦‚æœä¸å­˜åœ¨ï¼Œä¼šè¿”å›é”™è¯¯ï¼š\nid: â€˜abcâ€™: no such user ğŸ‘‰ å¯ä»¥ç»“åˆ \u0026amp;\u0026amp; / || ç”¨åœ¨è„šæœ¬é‡Œï¼š\nif id \u0026#34;abc\u0026#34; \u0026amp;\u0026gt;/dev/null; then echo \u0026#34;ç”¨æˆ·å­˜åœ¨\u0026#34; else echo \u0026#34;ç”¨æˆ·ä¸å­˜åœ¨\u0026#34; fi id admin \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo yes || echo no id test \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo yes || echo no âœ… æ–¹æ³•äºŒï¼šgetent passwd getent passwd ç”¨æˆ·å ç”¨æˆ·å­˜åœ¨ -\u0026gt; è¿”å›ä¸€è¡Œç”¨æˆ·ä¿¡æ¯ï¼ˆå’Œ /etc/passwd æ ¼å¼ä¸€è‡´ï¼‰ ç”¨æˆ·ä¸å­˜åœ¨ -\u0026gt; æ— è¾“å‡ºï¼Œè¿”å›ç é 0 è„šæœ¬åˆ¤æ–­ï¼š\nif getent passwd \u0026#34;abc\u0026#34; \u0026gt; /dev/null; then echo \u0026#34;ç”¨æˆ·å­˜åœ¨\u0026#34; else echo \u0026#34;ç”¨æˆ·ä¸å­˜åœ¨\u0026#34; fi âœ… æ–¹æ³•ä¸‰ï¼šç›´æ¥æŸ¥ /etc/passwd grep -q \u0026#34;^ç”¨æˆ·å:\u0026#34; /etc/passwd ä¾‹å¦‚ï¼š\ngrep -q \u0026#34;^abc:\u0026#34; /etc/passwd \u0026amp;\u0026amp; echo \u0026#34;å­˜åœ¨\u0026#34; || echo \u0026#34;ä¸å­˜åœ¨\u0026#34; ä½† âš ï¸ è¿™ç§æ–¹å¼åªæ£€æŸ¥æœ¬åœ°ç”¨æˆ·ï¼Œä¸é€‚ç”¨äº NIS/LDAP/SSSD ç­‰é›†ä¸­è®¤è¯ç¯å¢ƒï¼Œæ‰€ä»¥æ›´æ¨è id æˆ– getentã€‚\nğŸ“ æ€»ç»“ è„šæœ¬ç”¨æ³•æ¨è -\u0026gt; id ç”¨æˆ·å æˆ– getent passwd ç”¨æˆ·å å•çº¯æœ¬åœ°æ£€æŸ¥ -\u0026gt; grep \u0026quot;^ç”¨æˆ·å:\u0026quot; /etc/passwd ","description":"åœ¨ Linuxï¼ˆåŒ…æ‹¬ AlmaLinuxï¼‰ä¸­ï¼Œå¯ä»¥ç”¨å‡ ç§æ–¹æ³•æ¥åˆ¤æ–­ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼š\nâœ… æ–¹æ³•ä¸€ï¼šid å‘½ä»¤ï¼ˆæ¨èï¼‰ id ç”¨æˆ·å å¦‚æœç”¨æˆ·å­˜åœ¨ï¼Œä¼šæ˜¾ç¤º UIDã€GID ç­‰ä¿¡æ¯ï¼š\nuid=1000(martin) gid=1000(martin) groups=1000(martin),10(wheel) å¦‚æœä¸å­˜åœ¨ï¼Œä¼šè¿”å›é”™è¯¯ï¼š\nid: â€˜abcâ€™: no such user ğŸ‘‰ å¯ä»¥ç»“åˆ \u0026amp;\u0026amp; / || ç”¨åœ¨è„šæœ¬é‡Œï¼š\nif id \u0026#34;abc\u0026#34; \u0026amp;\u0026gt;/dev/null; then echo \u0026#34;ç”¨æˆ·å­˜åœ¨\u0026#34; else echo \u0026#34;ç”¨æˆ·ä¸å­˜åœ¨\u0026#34; fi id admin \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo yes || echo no id test \u0026amp;\u0026gt;/dev/null \u0026amp;\u0026amp; echo yes || echo no âœ… æ–¹æ³•äºŒï¼šgetent passwd getent passwd ç”¨æˆ·å ç”¨æˆ·å­˜åœ¨ -\u0026gt; è¿”å›ä¸€è¡Œç”¨æˆ·ä¿¡æ¯ï¼ˆå’Œ /etc/passwd æ ¼å¼ä¸€è‡´ï¼‰ ç”¨æˆ·ä¸å­˜åœ¨ -\u0026gt; æ— è¾“å‡ºï¼Œè¿”å›ç é 0 è„šæœ¬åˆ¤æ–­ï¼š\n"},{"id":476,"href":"/operations/linux/mem-available/","title":"å¦‚ä½•è®¡ç®—å†…å­˜å®é™…å‰©ä½™å¤šå°‘","parent":"Linux","content":"åœ¨ Linuxï¼ˆåŒ…æ‹¬ AlmaLinuxï¼‰ä¸­ï¼Œè®¡ç®—å®é™…å¯ç”¨å†…å­˜ä¸èƒ½å•çº¯çœ‹ â€œfreeâ€ ä¸€åˆ—ï¼Œè€Œæ˜¯è¦è€ƒè™‘ç¼“å­˜å’Œ buffer ç­‰å› ç´ ã€‚\nâ˜˜ï¸ æ­£ç¡®ç†è§£â€œå®é™…å‰©ä½™å†…å­˜â€ å®é™…å¯ç”¨å†…å­˜ = free + buffers + cached\næˆ–è€…ç›´æ¥çœ‹ available å­—æ®µ\nğŸ“Œ æ¨èå‘½ä»¤ä¸€ï¼šfree -h free -h è¾“å‡ºç¤ºä¾‹ï¼š\ntotal used free shared buff/cache available Mem: 7.6G 2.1G 1.2G 90M 4.3G 5.0G å„åˆ—è¯´æ˜ï¼š\nfreeï¼šçœŸæ­£ç©ºé—²çš„å†…å­˜ï¼ˆæ²¡è¢«ç”¨è¿‡çš„ï¼‰ buff/cacheï¼šè¢«ç³»ç»Ÿç¼“å­˜å’Œ buffer ä½¿ç”¨çš„å†…å­˜ï¼Œå¯è¢«å›æ”¶ availableï¼šæœ€é‡è¦ï¼Œè¡¨ç¤ºå®é™…å¯ç”¨äºæ–°ç¨‹åºçš„å†…å­˜ï¼ˆåŒ…æ‹¬ç¼“å­˜ä¸­å¯ä»¥é‡Šæ”¾çš„ï¼‰ ğŸ‘‰ ç»“è®ºï¼š available æ‰æ˜¯ä½ è¦çš„â€œå®é™…å‰©ä½™å†…å­˜â€ã€‚\nğŸ“Œ æ¨èå‘½ä»¤äºŒï¼štop æˆ– htop top å¯åŠ¨åçœ‹ç¬¬ä¸€å± Mem è¡Œçš„ avail Memï¼š\ntop htop æ›´ç¾è§‚ï¼Œå»ºè®®å®‰è£…ï¼š\nsudo dnf install -y htop htop ğŸ“Œ æ¨èå‘½ä»¤ä¸‰ï¼švmstat vmstat -s æˆ–ï¼š\nvmstat 1 å¯æŸ¥çœ‹å†…å­˜æ¯ç§’å˜åŒ–ï¼ˆå•ä½ä¸º KBï¼‰ã€‚\nğŸ“Œ æŸ¥çœ‹ç³»ç»Ÿå†…å­˜ä¿¡æ¯åŸå§‹æ–‡ä»¶ cat /proc/meminfo å…³é”®å­—æ®µè¯´æ˜ï¼š\nMemTotalï¼šæ€»å†…å­˜ MemFreeï¼šç©ºé—²å†…å­˜ Buffers / Cachedï¼šå¯å›æ”¶ç¼“å­˜ MemAvailableï¼šå®é™…å¯ç”¨å†…å­˜ï¼ˆæ¨èçœ‹ï¼‰ grep MemAvailable /proc/meminfo âœ… æ€»ç»“ ç›®çš„ æ¨èå‘½ä»¤ æŸ¥çœ‹å®é™…å‰©ä½™å†…å­˜ free -hï¼ˆçœ‹ availableï¼‰ å®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨ top / htop æ›´è¯¦ç»†ç»Ÿè®¡ cat /proc/meminfo ç³»ç»Ÿæ€§èƒ½å¿«ç…§ vmstat 1 ","description":"åœ¨ Linuxï¼ˆåŒ…æ‹¬ AlmaLinuxï¼‰ä¸­ï¼Œè®¡ç®—å®é™…å¯ç”¨å†…å­˜ä¸èƒ½å•çº¯çœ‹ â€œfreeâ€ ä¸€åˆ—ï¼Œè€Œæ˜¯è¦è€ƒè™‘ç¼“å­˜å’Œ buffer ç­‰å› ç´ ã€‚\nâ˜˜ï¸ æ­£ç¡®ç†è§£â€œå®é™…å‰©ä½™å†…å­˜â€ å®é™…å¯ç”¨å†…å­˜ = free + buffers + cached\næˆ–è€…ç›´æ¥çœ‹ available å­—æ®µ\nğŸ“Œ æ¨èå‘½ä»¤ä¸€ï¼šfree -h free -h è¾“å‡ºç¤ºä¾‹ï¼š\ntotal used free shared buff/cache available Mem: 7.6G 2.1G 1.2G 90M 4.3G 5.0G å„åˆ—è¯´æ˜ï¼š\n"},{"id":477,"href":"/management/development/how-to-reduce-the-mental-burden-of-error-handling-in-programming/","title":"å¦‚ä½•é™ä½ç¼–ç¨‹ä¸­å¯¹é”™è¯¯å¤„ç†çš„å¿ƒæ™ºè´Ÿæ‹…","parent":"Development","content":" ğŸš€ æ ¸å¿ƒåŸåˆ™ï¼šå‡å°‘é‡å¤ã€æå‰è¿”å›ã€ç»“æ„åŒ–å¤„ç†ã€è¯­ä¹‰æ˜ç¡®ã€å¯ç»„åˆ é”™è¯¯å¤„ç†çš„å¿ƒæ™ºè´Ÿæ‹…æ¥è‡ªï¼š\né”™è¯¯æ£€æŸ¥å¤ªé¢‘ç¹ é”™è¯¯å¤„ç†æ•£è½åœ¨ä»£ç å„å¤„ é”™è¯¯è¯­ä¹‰ä¸ç»Ÿä¸€ é”™è¯¯ç¼ºå°‘ä¸Šä¸‹æ–‡ è¿‡åº¦ try/except / if err != nil ç¼ºä¹é›†ä¸­å¤„ç†æœºåˆ¶ â­ ä½¿ç”¨ Guard Clausesï¼ˆæå‰è¿”å›åŸåˆ™ï¼‰ è¿™æ˜¯æœ€å¼ºã€æœ€é€šç”¨ã€ç«‹ç«¿è§å½±çš„åŠæ³•ã€‚\nâŒ åé¢ç¤ºä¾‹ï¼ˆåµŒå¥—å¤šå±‚ï¼Œé«˜å¿ƒæ™ºè´Ÿæ‹…ï¼‰ï¼š\nif user: if user.active: if has_permission(user): process(user) else: raise PermissionError(\u0026#34;No permission\u0026#34;) else: raise ValueError(\u0026#34;Inactive user\u0026#34;) else: raise ValueError(\u0026#34;User not found\u0026#34;) âœ… æ­£é¢ç¤ºä¾‹ï¼ˆç®€å•ã€è½»é‡ï¼‰ï¼š\nif not user: raise ValueError(\u0026#34;User not found\u0026#34;) if not user.active: raise ValueError(\u0026#34;Inactive user\u0026#34;) if not has_permission(user): raise PermissionError(\u0026#34;No permission\u0026#34;) process(user) å‡å°‘åµŒå¥— == é™ä½è„‘åŠ›æ¶ˆè€— é€»è¾‘æ›´åŠ çº¿æ€§ï¼Œæ›´æ˜“è¯»ï¼Œæ›´æ˜“ç»´æŠ¤ â­ å¤±è´¥ä¼˜å…ˆï¼ˆFail Fastï¼‰+ é»˜è®¤æˆåŠŸ å¦‚ä¸‹æ¨¡å¼ï¼š\nif é”™è¯¯: å¤„ç† ä¸»é€»è¾‘ æ¯”ï¼š\nä¸»é€»è¾‘ if é”™è¯¯: å¤„ç† æ›´å®¹æ˜“è¯»ã€‚\næŠŠé”™è¯¯çš„åˆ†æ”¯æå‰æš´éœ² å‡å°‘å›æº¯æ€è€ƒ å¤§è„‘ä¸éœ€è¦â€œè®°ä½â€å†³å®šç‚¹ â­ ç»Ÿä¸€é”™è¯¯åŒ…è£…ï¼ˆç»Ÿä¸€ä¸Šä¸‹æ–‡ï¼‰ åƒä¸‡ä¸è¦åœ¨ä»£ç é‡Œå‡ºç°è¿™ç§ï¼š\nreturn \u0026#34;error\u0026#34; åº”å½“ï¼š\nâœ… å¸¦ä¸Šä¸‹æ–‡ + åŸå§‹é”™è¯¯ä¿¡æ¯\nGoï¼š\nreturn fmt.Errorf(\u0026#34;query user %d failed: %w\u0026#34;, uid, err) Pythonï¼š\nraise DatabaseError(f\u0026#34;query user {uid} failed\u0026#34;) from err JSï¼š\nthrow new Error(`query user ${uid} failed: ${err.message}`) -\u0026gt; å½“é”™è¯¯æ ¼å¼ç»Ÿä¸€åï¼Œä½ ä¸éœ€è¦â€œæƒ³æ€ä¹ˆå†™é”™è¯¯â€ï¼Œå¿ƒæ™ºè´Ÿæ‹…ç«‹å³ä¸‹é™ã€‚\nâ­ æŠŠé”™è¯¯å¤„ç† â€œå¤–åŒ…â€ï¼Œä¸è¦åœ¨ä¸šåŠ¡ä»£ç ä¸­å¤„ç† æœ€æœ‰æ•ˆæ€è·¯ï¼š\nâœ… ä¸šåŠ¡ä»£ç åªè´Ÿè´£â€œæŠ›é”™â€\nâœ… æ¡†æ¶å±‚è´Ÿè´£ç»Ÿä¸€æ•è·å’Œè®°å½•æ—¥å¿—\nä¾‹å¦‚ FastAPIï¼š\n@app.exception_handler(Exception) async def global_exception_handler(request, exc): log.error(f\u0026#34;{request.url}: {exc}\u0026#34;) return JSONResponse({\u0026#34;error\u0026#34;: str(exc)}, status_code=500) ä¸šåŠ¡é€»è¾‘é‡Œå°±å¯ä»¥éå¸¸å¹²å‡€ï¼š\nif not user: raise UserNotFound() if not user.active: raise UserInactive() return user å¤§å¹…å‡å°‘ â€œæ¯ä¸ªå‡½æ•°éƒ½è¦ try/exceptâ€ çš„è´Ÿæ‹… æ‰€æœ‰é”™è¯¯æœ€ç»ˆè¢«ç»Ÿä¸€å¤„ç† ä½ åªç®¡æŠ›ï¼Œä¸ç®¡æ”¶ â­ ä¸ºä¸åŒé”™è¯¯è®¾è®¡æ¸…æ™°çš„è¯­ä¹‰-åˆ†å±‚é”™è¯¯æ¨¡å‹ å»ºè®®é”™è¯¯è‡³å°‘åˆ† 3 å±‚ï¼š\né¢†åŸŸé”™è¯¯ï¼ˆDomainErrorï¼‰ ä¸šåŠ¡é”™è¯¯ï¼ˆBusinessErrorï¼‰ ç³»ç»Ÿé”™è¯¯ï¼ˆSystemErrorï¼‰ ä¾‹å¦‚ï¼š\nUserNotFoundï¼ˆä¸šåŠ¡é”™è¯¯ï¼‰ OrderExpiredï¼ˆä¸šåŠ¡é”™è¯¯ï¼‰ DatabaseTimeoutï¼ˆç³»ç»Ÿé”™è¯¯ï¼‰ PermissionDeniedï¼ˆé¢†åŸŸ/ä¸šåŠ¡é”™è¯¯ï¼‰ ä¸ºä»€ä¹ˆé™ä½å¿ƒæ™ºè´Ÿæ‹…ï¼Ÿ\nå†™ä»£ç æ—¶ä¸ç”¨â€œæ€è€ƒç”¨ä»€ä¹ˆé”™è¯¯â€ï¼Œç›´æ¥æŒ‰æ¨¡å‹åˆ†ç±»å³å¯ å›¢é˜Ÿå†…æ¯ä¸ªäººéƒ½èƒ½ç»Ÿä¸€é”™è¯¯è¯­ä¹‰ æ•è·é”™è¯¯æ—¶æ›´ç®€å• â­ ä¸­é—´å±‚å°è£…é”™è¯¯ï¼ˆå¦‚æ•°æ®åº“ã€HTTP å®¢æˆ·ç«¯ï¼‰ å°†å¤æ‚çš„åº•å±‚é”™è¯¯è½¬æ¢ä¸ºç»Ÿä¸€ç»“æ„ï¼Œæ¯”å¦‚ï¼š\nâŒ ä¸è¦åœ¨ä¸šåŠ¡ä»£ç å†™ï¼š\ntry: r = requests.get(...) except Timeout as e: ... except JSONDecodeError as e: ... âœ… æ¨èï¼šå†™ä¸€ä¸ª request_wrapperï¼š\ndef http_get(url): try: return requests.get(url) except Exception as e: raise HttpError(f\u0026#34;GET {url} failed\u0026#34;) from e ç„¶åä¸šåŠ¡ä»£ç å°±åªæœ‰ï¼š\nr = http_get(url) æ¯ä¸ªåº•å±‚æ¨¡å—è´Ÿè´£æ¸…æ´—è‡ªå·±çš„é”™è¯¯ ä¸šåŠ¡ä»£ç è¶…çº§å¹²å‡€ é”™è¯¯å¤„ç†å®Œå…¨æ¨¡å—åŒ– â­ ç”¨å·¥å…·å‡å°‘äººè‚‰å¤„ç†ï¼ˆOptional / Result æ¨¡å¼ï¼‰ ä¾‹å¦‚ Rustã€Go çš„æ€è·¯ï¼š\nOption Result Either monad é“¾å¼å¤„ç† Python ä¹Ÿå¯ä»¥å®ç°ï¼š\ndef get_user(uid) -\u0026gt; Result[User]: ... JS/TS å¯ä»¥ç”¨ï¼š\nconst res = await safeFetch(url) if (res.err) { ... } æ˜ç¡®åŒºåˆ†æ­£å¸¸å€¼ vs é”™è¯¯ é€»è¾‘æ›´æœºæ¢°åŒ–ï¼Œæ— éœ€æ€è€ƒåˆ†æ”¯ éå¸¸å¼ºçš„å¯ç»„åˆæ€§ â­ é”™è¯¯æ—¥å¿—ä¸ç”¨æˆ·é”™è¯¯åˆ†ç¦»ï¼ˆæå…³é”®ï¼‰ ä¸è¦æŠŠé”™è¯¯ç»†èŠ‚ç›´æ¥æš´éœ²ç»™ç”¨æˆ·ã€‚\nä¸šåŠ¡å±‚ï¼š\nif not user: raise UserNotFound() æ¡†æ¶å±‚ï¼š\nlog.error(exc.stack) return {\u0026#34;msg\u0026#34;: \u0026#34;User not found\u0026#34;} ç”¨æˆ·é”™è¯¯ â‰  é”™è¯¯æ—¥å¿—\nç”¨æˆ·çœ‹åˆ°çš„åªæ˜¯å¹²å‡€å¯æ§çš„æç¤º å¼€å‘çœ‹åˆ°çš„æ˜¯å®Œæ•´å †æ ˆå’Œä¸Šä¸‹æ–‡ ä¸éœ€è¦æ¯ä¸ªåœ°æ–¹éƒ½æ€è€ƒâ€œè¦ä¸è¦ç»™ç”¨æˆ·çœ‹è¿™ä¸ªé”™è¯¯ï¼Ÿâ€ å¿ƒæ™ºè´Ÿæ‹…ç¬é—´ä¸‹é™ã€‚\nâ­ é”™è¯¯å¤„ç†é€»è¾‘ä¸è¶…è¿‡ 3 è¡Œï¼Œå¦åˆ™ä¸€å®šéœ€è¦æŠ½å‡½æ•° âŒ\ntry: r = http.get() except: rollback() notify() log.error() save_state() # ... âœ… ç›´æ¥æŠ½å‡ºå»ï¼š\ntry: r = http.get() except Exception as e: return handle_http_error(e) é”™è¯¯å¤„ç†æœ¬èº«ä¹Ÿä¸è¦å¤ªå¤æ‚ æŠ½å‡½æ•°è®©é€»è¾‘æ›´çº¿æ€§ å‡½æ•°æ›´æ˜“å¤ç”¨ â­ æ°¸è¿œä¿æŒçº¿æ€§æµç¨‹ï¼Œä¸è¦çº ç¼ äºå‘ä½ åç¤ºä¾‹ï¼š\nå¹²æ´»() æ£€æŸ¥é”™è¯¯ å†å¹²æ´»() æ£€æŸ¥é”™è¯¯ å†å¼„ç‚¹ä¸œè¥¿() å†æ£€æŸ¥é”™è¯¯ å¥½ç¤ºä¾‹ï¼š\nvalidate() prepare() execute() cleanup() æ¯ä¸€æ­¥å¿…é¡»æ‰¾ä¸åˆ°é”™è¯¯æ‰ç»§ç»­\næ¯ä¸€æ­¥çš„é”™è¯¯ç›´æ¥å‘ä¸ŠæŠ›\nå¼ºåˆ¶çº¿æ€§æ€è€ƒ ä¸ä¼šåœ¨å‡½æ•°å†…éƒ¨æ¥å›è·³ ğŸ¯ æ€»ç»“ è®©â€œé”™è¯¯å¤„ç†â€å˜æˆç»“æ„åŒ–ã€æ¨¡å¼åŒ–ã€å¯ç»„åˆï¼Œè€Œä¸æ˜¯æ¯ä¸€æ®µä»£ç éƒ½ä»é›¶æ€è€ƒã€‚\n","description":" ğŸš€ æ ¸å¿ƒåŸåˆ™ï¼šå‡å°‘é‡å¤ã€æå‰è¿”å›ã€ç»“æ„åŒ–å¤„ç†ã€è¯­ä¹‰æ˜ç¡®ã€å¯ç»„åˆ é”™è¯¯å¤„ç†çš„å¿ƒæ™ºè´Ÿæ‹…æ¥è‡ªï¼š\né”™è¯¯æ£€æŸ¥å¤ªé¢‘ç¹ é”™è¯¯å¤„ç†æ•£è½åœ¨ä»£ç å„å¤„ é”™è¯¯è¯­ä¹‰ä¸ç»Ÿä¸€ é”™è¯¯ç¼ºå°‘ä¸Šä¸‹æ–‡ è¿‡åº¦ try/except / if err != nil ç¼ºä¹é›†ä¸­å¤„ç†æœºåˆ¶ â­ ä½¿ç”¨ Guard Clausesï¼ˆæå‰è¿”å›åŸåˆ™ï¼‰ è¿™æ˜¯æœ€å¼ºã€æœ€é€šç”¨ã€ç«‹ç«¿è§å½±çš„åŠæ³•ã€‚\nâŒ åé¢ç¤ºä¾‹ï¼ˆåµŒå¥—å¤šå±‚ï¼Œé«˜å¿ƒæ™ºè´Ÿæ‹…ï¼‰ï¼š\nif user: if user.active: if has_permission(user): process(user) else: raise PermissionError(\u0026#34;No permission\u0026#34;) else: raise ValueError(\u0026#34;Inactive user\u0026#34;) else: raise ValueError(\u0026#34;User not found\u0026#34;) âœ… æ­£é¢ç¤ºä¾‹ï¼ˆç®€å•ã€è½»é‡ï¼‰ï¼š\n"},{"id":478,"href":"/database/design/string-text/","title":"å­—ç¬¦ä¸²å­˜å‚¨ç±»å‹é€‰æ‹©","parent":"Design","content":" ä¸€ã€PostgreSQL å­—ç¬¦ç±»å‹ PostgreSQL æ”¯æŒå‡ ç§å­—ç¬¦ç±»å‹ï¼š\nç±»å‹ è¯´æ˜ ç‰¹ç‚¹ é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ char(n) å›ºå®šé•¿åº¦ n å­—ç¬¦ ä¸å¤Ÿä¼šè¡¥ç©ºæ ¼ é€‚åˆå›ºå®šé•¿åº¦å­—æ®µï¼Œå¦‚æ€§åˆ«ã€çŠ¶æ€ç  ä¼˜ç‚¹ï¼šå ç”¨å›ºå®šé•¿åº¦ï¼Œæ£€ç´¢å¿«ï¼›ç¼ºç‚¹ï¼šç©ºé—´æµªè´¹ï¼Œæ“ä½œéœ€ TRIM varchar(n) å¯å˜é•¿åº¦ï¼Œé•¿åº¦ä¸Šé™ n å®é™…å­˜å‚¨é•¿åº¦ + 1~4 å­—èŠ‚ å¸¸è§„çŸ­æ–‡æœ¬ï¼Œå¦‚ç”¨æˆ·åã€é‚®ç®± ä¼˜ç‚¹ï¼šèŠ‚çœç©ºé—´ï¼Œé•¿åº¦å¯æ§ï¼›ç¼ºç‚¹ï¼šé•¿åº¦å—é™ï¼Œè¶…é•¿æŠ¥é”™ text å¯å˜é•¿åº¦ï¼Œæ— ä¸Šé™ ä»»æ„é•¿åº¦æ–‡æœ¬ é•¿æ–‡æœ¬å­—æ®µï¼Œå¦‚æ–‡ç« å†…å®¹ã€æ—¥å¿— ä¼˜ç‚¹ï¼šæ— é™åˆ¶ï¼›ç¼ºç‚¹ï¼šéƒ¨åˆ†å‡½æ•°å¯èƒ½ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼ˆB-Tree é»˜è®¤å¯ï¼ŒLIKE \u0026lsquo;%xxx%\u0026rsquo; æ— ç´¢å¼•ï¼‰ å®è·µå»ºè®®ï¼š\næ ‡é¢˜ã€ç”¨æˆ·åã€çŠ¶æ€å­—æ®µ -\u0026gt; varchar(n) å†…å®¹ã€æè¿°ã€æ—¥å¿— -\u0026gt; text é¿å…ç”¨ char(n)ï¼Œé™¤éä¸šåŠ¡æ˜ç¡®å›ºå®šé•¿åº¦ï¼ˆæ¯”å¦‚çŠ¶æ€ç ã€å›½åˆ«ç ï¼‰ äºŒã€MySQL å­—ç¬¦ç±»å‹ MySQL å¸¸ç”¨å­—ç¬¦ç±»å‹ï¼š\nç±»å‹ è¯´æ˜ ç‰¹ç‚¹ é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ CHAR(n) å›ºå®šé•¿åº¦ n å­—èŠ‚ ä¸å¤Ÿè¡¥ç©ºæ ¼ æ€§åˆ«ã€çŠ¶æ€ç  ä¼˜ç‚¹ï¼šæ£€ç´¢å¿«ï¼›ç¼ºç‚¹ï¼šç©ºé—´æµªè´¹ VARCHAR(n) å¯å˜é•¿åº¦ n å­—èŠ‚ å®é™…é•¿åº¦ + 1~2 å­—èŠ‚ å¸¸è§„çŸ­æ–‡æœ¬ ä¼˜ç‚¹ï¼šèŠ‚çœç©ºé—´ï¼Œæ”¯æŒç´¢å¼•ï¼Œå…¼å®¹æ€§å¥½ï¼›ç¼ºç‚¹ï¼šè¶…é•¿æŠ¥é”™ TEXT / TINYTEXT / MEDIUMTEXT / LONGTEXT å¤§æ–‡æœ¬ LOB å­˜å‚¨ å†…å®¹ã€æ—¥å¿— ä¼˜ç‚¹ï¼šå¯å­˜å‚¨å¤§æ–‡æœ¬ï¼›ç¼ºç‚¹ï¼šç´¢å¼•æœ‰é™åˆ¶ï¼Œå†™å…¥ç¨æ…¢ å®è·µå»ºè®®ï¼š\nç”¨æˆ·åã€emailã€code -\u0026gt; VARCHAR(n) æè¿°ã€æ–‡ç« ã€æ—¥å¿— -\u0026gt; TEXT å°‘ç”¨ CHAR(n)ï¼Œåªé€‚åˆå°å›ºå®šå­—æ®µ ä¸‰ã€å¯¹æ¯” PostgreSQL vs MySQL ç‰¹æ€§ PostgreSQL MySQL å»ºè®® å¯å˜é•¿åº¦çŸ­æ–‡æœ¬ varchar(n) VARCHAR(n) äºŒè€…ç±»ä¼¼ æ— é•¿åº¦é™åˆ¶é•¿æ–‡æœ¬ text TEXT / MEDIUMTEXT PostgreSQL æ›´ç»Ÿä¸€ï¼ŒMySQL æœ‰å¤šç§ TEXT ç±»å‹ï¼Œéœ€æ ¹æ®å¤§å°é€‰æ‹© ç´¢å¼•æ”¯æŒ varchar ä¸ text é»˜è®¤æ”¯æŒ B-Treeï¼Œä½† text LIKE \u0026lsquo;%xxx%\u0026rsquo; ä¸èµ°ç´¢å¼• VARCHAR å¯å»ºç´¢å¼•ï¼ŒTEXT é»˜è®¤åªèƒ½ç´¢å¼•å‰ 255 å­—èŠ‚ çŸ­æ–‡æœ¬å»º varcharï¼Œé•¿æ–‡æœ¬å»º text/mediumtext ç©ºé—´æ¶ˆè€— char(n) è¡¥ç©ºæ ¼ï¼Œvarchar(n) ä¸ text æŒ‰é•¿åº¦å­˜ åŒ PostgreSQL å°½é‡å°‘ç”¨ charï¼Œvarchar å¯æ§ æŸ¥è¯¢æ€§èƒ½ varchar + ç´¢å¼•æ€§èƒ½é«˜ï¼Œtext æŸ¥è¯¢å¤§æ–‡æœ¬æ…¢ åŒ PostgreSQL é•¿æ–‡æœ¬å°½é‡é¿å…é¢‘ç¹ LIKE \u0026lsquo;%xxx%\u0026rsquo; å››ã€å®æˆ˜æœ€ä½³å®è·µ çŸ­æ–‡æœ¬å­—æ®µï¼ˆé•¿åº¦å¯æ§ï¼‰\nPostgreSQL: varchar(n) MySQL: VARCHAR(n) ä¾‹ï¼šç”¨æˆ·åã€é‚®ç®±ã€è‚¡ç¥¨ä»£ç  é•¿æ–‡æœ¬å­—æ®µï¼ˆé•¿åº¦ä¸å›ºå®šï¼‰\nPostgreSQL: text MySQL: TEXT / MEDIUMTEXTï¼ˆæ ¹æ®æœ€å¤§é•¿åº¦é€‰æ‹©ï¼‰ ä¾‹ï¼šæ–‡ç« å†…å®¹ã€æ—¥å¿—ã€æè¿°å­—æ®µ å›ºå®šé•¿åº¦å­—æ®µï¼ˆä»…å°‘é‡ä½¿ç”¨ï¼‰\nPostgreSQL / MySQL: char(n) ä¾‹ï¼šçŠ¶æ€ç ï¼ˆâ€œAâ€/â€œBâ€/â€œCâ€ï¼‰ã€å›½åˆ«ç ï¼ˆâ€œCNâ€ã€â€œUSâ€ï¼‰ ç´¢å¼•è€ƒè™‘\nçŸ­æ–‡æœ¬å­—æ®µ -\u0026gt; å¯åŠ  B-Tree ç´¢å¼• é•¿æ–‡æœ¬ -\u0026gt; é¿å… LIKE \u0026lsquo;%xxx%\u0026rsquo;ï¼Œç”¨ GIN / trigram / fulltext ç´¢å¼• äº”ã€æ€»ç»“ çŸ­æ–‡æœ¬ -\u0026gt; varchar(n)ï¼ˆå—é•¿åº¦æ§åˆ¶ + æ”¯æŒç´¢å¼•ï¼‰ é•¿æ–‡æœ¬ -\u0026gt; textï¼ˆæ— é™åˆ¶ + çµæ´»ï¼Œä½†ç´¢å¼•å—é™ï¼‰ å›ºå®šé•¿åº¦ -\u0026gt; char(n)ï¼ˆå°‘ç”¨ï¼Œç©ºé—´å›ºå®šä½†æµªè´¹ï¼‰ PostgreSQL text/varchar å¯ä»¥å­˜å‚¨ä»»æ„é•¿åº¦ï¼›MySQL TEXT éœ€é€‰åˆé€‚ç±»å‹ï¼ˆTINY / MEDIUM / LONGï¼‰ ç´¢å¼•ç­–ç•¥å¿…é¡»ç»“åˆå­—æ®µç±»å‹è€ƒè™‘ æ–‡ç« æ ‡é¢˜ï¼Œä¸ç¡®å®šé•¿åº¦ï¼Œä½†æ˜¯åœ¨æŸä¸ªé•¿åº¦èŒƒå›´å†…ï¼Œè¦ç»å¸¸ä½¿ç”¨ LIKE \u0026lsquo;%xxx%\u0026rsquo; æŸ¥è¯¢ éœ€æ±‚ï¼š\næ–‡ç« æ ‡é¢˜ é•¿åº¦ä¸ç¡®å®šï¼Œä½†é€šå¸¸åœ¨æŸä¸ªé•¿åº¦èŒƒå›´å†… ç»å¸¸åšæ¨¡ç³ŠæŸ¥è¯¢ LIKE \u0026lsquo;%xxx%\u0026rsquo; è¿™åœ¨ PostgreSQL å’Œ MySQL ä¸‹å¤„ç†æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œå› ä¸ºåŸç”Ÿ B-Tree ç´¢å¼•æ— æ³•é«˜æ•ˆæ”¯æŒå‰ç½® % çš„æ¨¡ç³ŠæŸ¥è¯¢ã€‚\nä¸€ã€PostgreSQL å­˜å‚¨ç±»å‹ text æˆ– varchar(n)ï¼ˆé•¿åº¦å¯æ§ï¼Œtext æ›´çµæ´»ï¼‰ å› ä¸ºæ–‡ç« æ ‡é¢˜é•¿åº¦ä¸å›ºå®šï¼Œtext æ›´æ–¹ä¾¿ varchar(n) ä¹Ÿå¯ä»¥ï¼Œå¦‚æœä½ æƒ³é™åˆ¶æœ€å¤§é•¿åº¦ ç´¢å¼•æ–¹æ¡ˆ B-Tree æ— æ³•åŠ é€Ÿ LIKE \u0026lsquo;%xxx%\u0026rsquo; æ¨èä½¿ç”¨ pg_trgm æ‰©å±• + GIN æˆ– GiST ç´¢å¼• -- å®‰è£…æ‰©å±• CREATE EXTENSION IF NOT EXISTS pg_trgm; -- åˆ›å»º trigram GIN ç´¢å¼• CREATE INDEX idx_articles_title_trgm ON articles USING GIN (title gin_trgm_ops); æŸ¥è¯¢ï¼š\nSELECT * FROM articles WHERE title LIKE \u0026#39;%å…³é”®è¯%\u0026#39;; æ€§èƒ½ä¼šæ¯”å…¨è¡¨æ‰«æå¿«å¾ˆå¤šï¼ˆç™¾ä¸‡çº§æ•°æ®ä¹Ÿå¯æ¥å—ï¼‰ã€‚\näºŒã€MySQL å­˜å‚¨ç±»å‹ VARCHAR(n) æˆ– TEXT VARCHAR(n)ï¼šå¦‚æœæ ‡é¢˜é•¿åº¦æœ‰æœ€å¤§å€¼ï¼ˆå¦‚ 500ï¼‰ï¼Œæ¨è TEXTï¼šé•¿åº¦ä¸ç¡®å®šä¸”å¯èƒ½å¾ˆé•¿ ç´¢å¼•æ–¹æ¡ˆ B-Tree ç´¢å¼•åªèƒ½åŠ é€Ÿå‰ç¼€åŒ¹é…ï¼šLIKE \u0026lsquo;xxx%\u0026rsquo; LIKE \u0026lsquo;%xxx%\u0026rsquo; æ— æ³•ç”¨ B-Tree æ¨èä½¿ç”¨ FULLTEXT ç´¢å¼•ï¼ˆMySQL 5.6+ æ”¯æŒ InnoDBï¼‰ -- VARCHAR ç±»å‹ç¤ºä¾‹ ALTER TABLE articles ADD FULLTEXT INDEX ft_title(title); -- æŸ¥è¯¢ SELECT * FROM articles WHERE MATCH(title) AGAINST(\u0026#39;å…³é”®è¯\u0026#39;); FULLTEXT æ”¯æŒè‡ªç„¶è¯­è¨€æœç´¢ï¼Œæ€§èƒ½ä¼˜äº LIKE \u0026lsquo;%xxx%\u0026rsquo;ã€‚\nå¦‚æœéœ€è¦ä¸¥æ ¼ LIKE æ¨¡ç³ŠåŒ¹é…ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å°†å…³é”®å­—æ‹†åˆ†åˆ°å¦ä¸€ä¸ªåˆ—å­˜å‚¨æˆ–è€…ä½¿ç”¨ ElasticSearchã€‚\nä¸‰ã€æ€»ç»“å¯¹æ¯” ç‰¹æ€§ PostgreSQL MySQL å­˜å‚¨ç±»å‹ text æˆ– varchar(n) VARCHAR(n) æˆ– TEXT æ¨¡ç³Šæœç´¢ä¼˜åŒ– pg_trgm + GIN/GiST FULLTEXT ç´¢å¼• LIKE \u0026lsquo;%xxx%\u0026rsquo; ä¸èµ° B-Treeï¼Œéœ€ trigram ä¸èµ° B-Treeï¼Œéœ€ FULLTEXT æ•°æ®é‡ æ”¯æŒç™¾ä¸‡ä»¥ä¸Š æ”¯æŒç™¾ä¸‡ä»¥ä¸Š é€‚åˆåœºæ™¯ çµæ´»ã€å¤æ‚æŸ¥è¯¢ å¸¸è§„æœç´¢ã€ç®€å•åŒ¹é… æ¨èå®è·µ PostgreSQLï¼štext + pg_trgm GIN ç´¢å¼• MySQLï¼šVARCHAR(500) + FULLTEXT éƒ½å¯ä»¥æ»¡è¶³æ ‡é¢˜é•¿åº¦ä¸ç¡®å®š + é«˜é¢‘æ¨¡ç³Šæœç´¢çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¿è¯æŸ¥è¯¢æ€§èƒ½ã€‚\n","description":" ä¸€ã€PostgreSQL å­—ç¬¦ç±»å‹ PostgreSQL æ”¯æŒå‡ ç§å­—ç¬¦ç±»å‹ï¼š\nç±»å‹ è¯´æ˜ ç‰¹ç‚¹ é€‚ç”¨åœºæ™¯ ä¼˜ç¼ºç‚¹ char(n) å›ºå®šé•¿åº¦ n å­—ç¬¦ ä¸å¤Ÿä¼šè¡¥ç©ºæ ¼ é€‚åˆå›ºå®šé•¿åº¦å­—æ®µï¼Œå¦‚æ€§åˆ«ã€çŠ¶æ€ç  ä¼˜ç‚¹ï¼šå ç”¨å›ºå®šé•¿åº¦ï¼Œæ£€ç´¢å¿«ï¼›ç¼ºç‚¹ï¼šç©ºé—´æµªè´¹ï¼Œæ“ä½œéœ€ TRIM varchar(n) å¯å˜é•¿åº¦ï¼Œé•¿åº¦ä¸Šé™ n å®é™…å­˜å‚¨é•¿åº¦ + 1~4 å­—èŠ‚ å¸¸è§„çŸ­æ–‡æœ¬ï¼Œå¦‚ç”¨æˆ·åã€é‚®ç®± ä¼˜ç‚¹ï¼šèŠ‚çœç©ºé—´ï¼Œé•¿åº¦å¯æ§ï¼›ç¼ºç‚¹ï¼šé•¿åº¦å—é™ï¼Œè¶…é•¿æŠ¥é”™ text å¯å˜é•¿åº¦ï¼Œæ— ä¸Šé™ ä»»æ„é•¿åº¦æ–‡æœ¬ é•¿æ–‡æœ¬å­—æ®µï¼Œå¦‚æ–‡ç« å†…å®¹ã€æ—¥å¿— ä¼˜ç‚¹ï¼šæ— é™åˆ¶ï¼›ç¼ºç‚¹ï¼šéƒ¨åˆ†å‡½æ•°å¯èƒ½ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼ˆB-Tree é»˜è®¤å¯ï¼ŒLIKE \u0026lsquo;%xxx%\u0026rsquo; æ— ç´¢å¼•ï¼‰ å®è·µå»ºè®®ï¼š\næ ‡é¢˜ã€ç”¨æˆ·åã€çŠ¶æ€å­—æ®µ -\u0026gt; varchar(n) å†…å®¹ã€æè¿°ã€æ—¥å¿— -\u0026gt; text é¿å…ç”¨ char(n)ï¼Œé™¤éä¸šåŠ¡æ˜ç¡®å›ºå®šé•¿åº¦ï¼ˆæ¯”å¦‚çŠ¶æ€ç ã€å›½åˆ«ç ï¼‰ äºŒã€MySQL å­—ç¬¦ç±»å‹ MySQL å¸¸ç”¨å­—ç¬¦ç±»å‹ï¼š\n"},{"id":479,"href":"/operations/hardware/computers-vs-servers/","title":"å®¶ç”¨ç”µè„‘å’ŒæœåŠ¡å™¨ç¡¬ä»¶å¯¹æ¯”","parent":"Hardware","content":" ä¸€ã€æ ¸å¿ƒç»“è®º å®¶ç”¨ç”µè„‘ = æ€§èƒ½ä¼˜å…ˆã€æˆæœ¬ä¼˜å…ˆã€çŸ­æ—¶é—´é«˜è´Ÿè½½\næœåŠ¡å™¨ = ç¨³å®šä¼˜å…ˆã€å¯ç»´æŠ¤æ€§ä¼˜å…ˆã€7Ã—24 å°æ—¶è¿è¡Œ\näºŒã€ç¡¬ä»¶å±‚é¢å¯¹æ¯” 1ï¸âƒ£ CPU é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ç±»å‹ i5 / i7 / Ryzen Xeon / EPYC æ ¸å¿ƒæ•° ä¸­ç­‰ å¤šæ ¸ä¸ºä¸» ä¸»é¢‘ é«˜ ç•¥ä½ ç¼“å­˜ è¾ƒå° å¤§ L3 æŒ‡ä»¤é›† åŸºæœ¬ å®Œæ•´ï¼ˆAESã€AVXï¼‰ ç¨³å®šæ€§ æ™®é€š 7Ã—24 ğŸ“Œ ç»“è®ºï¼š\nå®¶ç”¨ï¼šè¿½æ±‚â€œå¿«â€ æœåŠ¡å™¨ï¼šè¿½æ±‚â€œç¨³ + å¹¶å‘â€ 2ï¸âƒ£ å†…å­˜ é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ECC âŒ âœ… å®¹é‡ 16â€“64G 64Gâ€“1TB+ é€šé“ å°‘ å¤šé€šé“ çƒ­æ’æ‹” âŒ éƒ¨åˆ†æ”¯æŒ ğŸ“Œ ECC æ˜¯æœåŠ¡å™¨çš„çµé­‚ï¼ˆé˜²æ­¢å†…å­˜ç¿»è½¬å¯¼è‡´æ•°æ®åº“æŸåï¼‰\n3ï¸âƒ£ å­˜å‚¨ é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ç£ç›˜ SATA / NVMe SAS / ä¼ä¸šçº§ NVMe RAID ä¸»æ¿è½¯ RAID ç¡¬ RAID / HBA çƒ­æ’æ‹” âŒ âœ… å†™å…¥å¯¿å‘½ ä½ é«˜ 4ï¸âƒ£ ä¸»æ¿ é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ æ’æ§½ å•è·¯ å•è·¯ / åŒè·¯ PCIe å°‘ å¤š BMC âŒ âœ…ï¼ˆIPMIï¼‰ è¿œç¨‹ç®¡ç† æ—  å®Œæ•´ 5ï¸âƒ£ ç½‘ç»œ é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ç½‘å¡ 1G 10G / 25G å†—ä½™ âŒ å¯åš Bond SR-IOV âŒ âœ… 6ï¸âƒ£ ç”µæº \u0026amp; æ•£çƒ­ é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ç”µæº å•ç”µæº å†—ä½™ç”µæº è®¤è¯ 80PLUS Gold Platinum / Titanium æ•£çƒ­ é£æ‰‡ / æ°´å†· é£é“ + å†—ä½™é£æ‰‡ ä¸‰ã€è½¯ä»¶ \u0026amp; ä½¿ç”¨å±‚é¢å¯¹æ¯” é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ è¿è¡Œæ—¶é—´ é—´æ­‡ 7Ã—24 é‡å¯æˆæœ¬ ä½ æé«˜ ç³»ç»Ÿ Windows / macOS Linux å‡çº§ç»´æŠ¤ æ‰‹åŠ¨ è‡ªåŠ¨åŒ– æ•…éšœå®¹å¿ ä½ é«˜ å››ã€ä»·æ ¼ \u0026amp; æ€§ä»·æ¯” é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ å•æ ¸æ€§èƒ½ é«˜ ä¸€èˆ¬ æ€»ä½“ä»·æ ¼ ä½ é«˜ é•¿æœŸç¨³å®š âŒ âœ… è¿ç»´æˆæœ¬ ä½ é«˜ ğŸ“Œ æœåŠ¡å™¨è´µåœ¨â€œå¯é æ€§ + å¯ç»´æŠ¤æ€§â€\näº”ã€å…¸å‹ä½¿ç”¨åœºæ™¯ å®¶ç”¨ç”µè„‘é€‚åˆ\næ¸¸æˆ ğŸ® è®¾è®¡ / å‰ªè¾‘ ä¸ªäººå¼€å‘ è½»é‡ NAS æœåŠ¡å™¨é€‚åˆ\næ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰ ä¼ä¸šç½‘ç«™ K8S / è™šæ‹ŸåŒ– å­˜å‚¨ / å¤‡ä»½ å…³é”®ä¸šåŠ¡ç³»ç»Ÿ å…­ã€èƒ½ä¸èƒ½ç”¨å®¶ç”¨ç”µè„‘å½“æœåŠ¡å™¨ï¼Ÿ ç­”æ¡ˆï¼šå¯ä»¥ï¼Œä½†æœ‰é™åˆ¶\nâœ… é€‚åˆ\nå­¦ä¹  / æµ‹è¯•ç¯å¢ƒ å†…ç½‘æœåŠ¡ éå…³é”®ä¸šåŠ¡ âŒ ä¸é€‚åˆ\né‡‘è / æ•°æ®åº“ä¸»åº“ 7Ã—24 é«˜å¹¶å‘ æ•°æ®ä¸å¯ä¸¢åœºæ™¯ ä¸ƒã€æ€»ç»“ å®¶ç”¨ç”µè„‘æ˜¯â€œè·‘å¾—å¿«â€ï¼ŒæœåŠ¡å™¨æ˜¯â€œè·‘å¾—ä¹…â€ã€‚\nä¸€ä¸ªæ‹¼æ€§èƒ½ï¼Œä¸€ä¸ªæ‹¼ç¨³å®šã€‚\n","description":" ä¸€ã€æ ¸å¿ƒç»“è®º å®¶ç”¨ç”µè„‘ = æ€§èƒ½ä¼˜å…ˆã€æˆæœ¬ä¼˜å…ˆã€çŸ­æ—¶é—´é«˜è´Ÿè½½\næœåŠ¡å™¨ = ç¨³å®šä¼˜å…ˆã€å¯ç»´æŠ¤æ€§ä¼˜å…ˆã€7Ã—24 å°æ—¶è¿è¡Œ\näºŒã€ç¡¬ä»¶å±‚é¢å¯¹æ¯” 1ï¸âƒ£ CPU é¡¹ç›® å®¶ç”¨ç”µè„‘ æœåŠ¡å™¨ ç±»å‹ i5 / i7 / Ryzen Xeon / EPYC æ ¸å¿ƒæ•° ä¸­ç­‰ å¤šæ ¸ä¸ºä¸» ä¸»é¢‘ é«˜ ç•¥ä½ ç¼“å­˜ è¾ƒå° å¤§ L3 æŒ‡ä»¤é›† åŸºæœ¬ å®Œæ•´ï¼ˆAESã€AVXï¼‰ ç¨³å®šæ€§ æ™®é€š 7Ã—24 ğŸ“Œ ç»“è®ºï¼š\n"},{"id":480,"href":"/management/operations/troubleshooting/","title":"æ•…éšœæ’æŸ¥æ€è·¯","parent":"Operations","content":" ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯ï¼ˆç³»ç»ŸåŒ– + æœ€ä½³å®è·µï¼‰ æ•…éšœæ’æŸ¥ = ç°è±¡ç¡®è®¤ -\u0026gt; å¿«é€Ÿå®šä½ -\u0026gt; å±‚å±‚æ’é™¤ -\u0026gt; æ ¹å› åˆ†æ -\u0026gt; é˜²æ­¢å¤å‘\næ‰©å±•ï¼š4 ä¸ªå¤§é˜¶æ®µ + 18 ä¸ªæ¨¡å—ã€‚\nğŸ”¥ ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•…éšœç°è±¡ç¡®è®¤ï¼ˆWHATï¼‰ 1. å¤ç°æ•…éšœ / è¡Œä¸ºç¡®è®¤ æ˜¯å¦ç¨³å®šå¤ç°ï¼Ÿæ˜¯å¦æœ‰æ¦‚ç‡æ€§ï¼Ÿ å•ç”¨æˆ· vs å¤šç”¨æˆ·ï¼Ÿ æŸä¸ªæ¥å£ vs å…¨ç«™ï¼Ÿ æŸç»„ä»¶ vs æ•´ä¸ªé›†ç¾¤ï¼Ÿ æ ¸å¿ƒï¼šç¡®ä¿ä¸æ˜¯è¯¯æŠ¥\nâš™ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šè¿è¡Œç¯å¢ƒæ£€æŸ¥ï¼ˆWHEREï¼‰ åŒ…å«ä½ åˆ—çš„å†…å®¹ï¼Œå¹¶ç³»ç»ŸåŒ–æ‰©å±•ã€‚\n2. ç¨‹åºè¿è¡ŒçŠ¶æ€ï¼ˆåº”ç”¨å±‚ï¼‰ æ£€æŸ¥ï¼š\nä¸»è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼Ÿï¼ˆpsã€systemctlã€docker psã€kubectlï¼‰ æ˜¯å¦é¢‘ç¹é‡å¯ï¼Ÿï¼ˆPod restartCountï¼‰ çº¿ç¨‹æ•°æ˜¯å¦å¼‚å¸¸ï¼Ÿ ç¨‹åºæ˜¯å¦æŒ‚æ­»ï¼ˆæ— å“åº”ä½†æœªé€€å‡ºï¼‰ è¿æ¥æ± æ˜¯å¦è€—å°½ï¼ˆæ•°æ®åº“/redisï¼‰ å·¥å…·ï¼š\nps -ef systemctl status xxx docker logs kubectl describe pod kubectl logs 3. é›†ç¾¤çŠ¶æ€ï¼ˆå®¹å™¨ / åˆ†å¸ƒå¼ / æœåŠ¡ç½‘æ ¼ï¼‰ æ£€æŸ¥ï¼š\nPod æ˜¯å¦ Pending / CrashLoopBackOff / OOMKilled èŠ‚ç‚¹æ˜¯å¦ NotReady æœåŠ¡å‘ç°æ˜¯å¦æ­£å¸¸ï¼ˆDNS/CoreDNSï¼‰ è´Ÿè½½å‡è¡¡æ˜¯å¦æ­£ç¡®è½¬å‘ é…ç½®æ˜¯å¦ä¸€è‡´ ä¾èµ–æœåŠ¡æ˜¯å¦å¯ç”¨ï¼ˆDBã€Cacheã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰ å·¥å…·ï¼š\nkubectl get pod -A kubectl describe node kubectl get event --sort-by=\u0026#39;.lastTimestamp\u0026#39; 4. ç«¯å£çŠ¶æ€ï¼ˆç½‘ç»œå±‚ï¼‰ æ£€æŸ¥ï¼š\nç›‘å¬ç«¯å£æ˜¯å¦å­˜åœ¨ï¼ˆnetstatã€ssï¼‰ æœåŠ¡æ˜¯å¦çœŸæ­£ listening è€Œä¸æ˜¯ TIME_WAIT å¤–éƒ¨è®¿é—®æ˜¯å¦è¢«é˜²ç«å¢™é˜»æ–­ NAT è½¬å‘æ˜¯å¦æ­£å¸¸ å·¥å…·ï¼š\nss -lntp curl -v telnet iptables -L -n 5. æ—¥å¿—ä¿¡æ¯ï¼ˆæ—¥å¿—å±‚ï¼‰ ä¸‰ç±»æ—¥å¿—å¿…é¡»æ£€æŸ¥ï¼š\nåº”ç”¨æ—¥å¿—ï¼ˆerror/exception/stackï¼‰ ç³»ç»Ÿæ—¥å¿—ï¼ˆdmesgã€journalctlï¼‰ ä¸­é—´ä»¶æ—¥å¿—ï¼ˆNginxã€Redisã€MySQLã€Kafkaï¼‰ å…³é”®ç‚¹ï¼š\næ˜¯å¦ OOM æ˜¯å¦æ®µé”™è¯¯ æ˜¯å¦è¶…æ—¶ or è¿æ¥æ‹’ç» æ˜¯å¦èµ„æºä¸è¶³ï¼ˆtoo many open filesï¼‰ æ˜¯å¦æƒé™é—®é¢˜ï¼ˆpermission deniedï¼‰ 6. å®¢æˆ·ç«¯é”™è¯¯ï¼ˆç”¨æˆ·ä¾§/æµè§ˆå™¨/API è°ƒç”¨ï¼‰ å…³æ³¨ï¼š\nHTTP çŠ¶æ€ç ï¼ˆ4xxã€5xxï¼‰ è¶…æ—¶ vs ç›´æ¥æŠ¥é”™ å®¢æˆ·ç«¯ DNS æ˜¯å¦æ­£å¸¸ API æ˜¯å¦é™æµã€èŠ‚æµ Token / æƒé™é—®é¢˜ å®¢æˆ·ç«¯æ—¥å¿—ä½ç½®ï¼š\næµè§ˆå™¨ï¼šF12 Network Appï¼šè°ƒç”¨é“¾è·¯æ—¥å¿— SDKï¼šå¼‚å¸¸å †æ ˆ ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šç³»ç»Ÿèµ„æºçŠ¶æ€ï¼ˆWHYï¼‰ 7. CPU ä½¿ç”¨ç‡ å…³æ³¨ï¼š\nç³»ç»Ÿæ•´ä½“ CPUæ˜¯å¦ 100%ï¼Ÿ æŸä¸ªè¿›ç¨‹æ˜¯å¦å æ»¡ï¼Ÿ å†…æ ¸æ€å æ¯”æ˜¯å¦å¼‚å¸¸ï¼Ÿ run queue æ˜¯å¦è¿‡é«˜ï¼Ÿ å·¥å…·ï¼š\ntop / htop pidstat -u 1 mpstat -P ALL 1 é—®é¢˜åˆ¤æ–­ï¼š\nCPU é«˜ï¼šå¯èƒ½æ˜¯å¾ªç¯ã€æ­»é”ã€é¢‘ç¹ GC CPU ä½ä½†ç¨‹åºå¡ä½ï¼šå¯èƒ½æ˜¯é”äº‰ç”¨ã€IO ç­‰å¾… 8. å†…å­˜ä½¿ç”¨ç‡ å…³æ³¨ï¼š\nOOM å‘ç”Ÿäº†å—ï¼Ÿ resident memory æ˜¯å¦æŒç»­å¢é•¿ï¼ˆå†…å­˜æ³„æ¼ï¼‰ ç¨‹åºæ˜¯å¦ cache è¿‡å¤§ swap æ˜¯å¦è¢«ä½¿ç”¨ï¼ˆswap = æ€§èƒ½ç¾éš¾ï¼‰ å·¥å…·ï¼š\nfree -m top dmesg | grep -i oom åˆ¤æ–­ï¼š\nå†…å­˜æ˜æ˜¾æ³„æ¼ -\u0026gt; çœ‹åº”ç”¨å±‚ cache å¤ªé«˜ -\u0026gt; æ­£å¸¸ï¼Œæ— éœ€ panic swap é¢‘ç¹ -\u0026gt; ä¼šå¯¼è‡´å»¶è¿Ÿå‡é«˜å‡ ç™¾å€ 9. ç£ç›˜ä½¿ç”¨ç‡ï¼ˆç©ºé—´ + I/Oï¼‰ ä¸¤ä¸ªç»´åº¦ï¼š\nï¼ˆ1ï¼‰ç£ç›˜ç©ºé—´ æ˜¯å¦è¢«æ—¥å¿—å æ»¡ï¼ˆ/var/logï¼‰ æ˜¯å¦ df å·²æ»¡ï¼ˆ100% ä¼šå¯¼è‡´ä»»ä½•å†™å…¥å¤±è´¥ï¼‰ df -h du -sh /var/log/* ï¼ˆ2ï¼‰ç£ç›˜ I/O IOPSã€IO wait æ˜¯å¦è¿‡é«˜ï¼Ÿ iostat -x 1 dstat -d IO é«˜ -\u0026gt; æ•°æ®åº“æ…¢ã€å†™æ—¥å¿—æ…¢ã€åº”ç”¨é˜»å¡\n10. ç½‘ç»œçŠ¶æ€ï¼ˆå¸¦å®½ + å»¶è¿Ÿ + ä¸¢åŒ…ï¼‰ å…³æ³¨ï¼š\nDNS æ˜¯å¦æ­£å¸¸è§£æ æ˜¯å¦ä¸¢åŒ… æ˜¯å¦å»¶è¿Ÿé«˜ æ˜¯å¦å‡ºå£å¸¦å®½æ‰“æ»¡ æ˜¯å¦æœ‰ SYN æ´ªæ°´ å·¥å…·ï¼š\npingã€mtrã€traceroute iftopã€iptraf ss -s tcpdump curl -I åˆ¤æ–­ï¼š\nä¸¢åŒ… -\u0026gt; ç½‘ç»œæŠ–åŠ¨ or ç”¨æˆ·ç«¯ WiFi RT å»¶è¿Ÿé«˜ -\u0026gt; ä¸Šæ¸¸ç½‘ç»œæ³¢åŠ¨ iftop æ˜¾ç¤ºå¸¦å®½æ»¡ -\u0026gt; é™æµ or å‡çº§å¸¦å®½ SYN Recv å¤š -\u0026gt; è¢«æ”»å‡» ğŸ§© ç¬¬å››éƒ¨åˆ†ï¼šä¾èµ–æœåŠ¡æ£€æŸ¥ï¼ˆUPSTREAMï¼‰ 11. æ•°æ®åº“çŠ¶æ€ï¼ˆMySQL/Postgresï¼‰ æ£€æŸ¥ï¼š\næ˜¯å¦è¿æ¥æ•°æ»¡ï¼Ÿ æ˜¯å¦é”ç­‰å¾…ï¼Ÿ æ…¢ SQL æ˜¯å¦æš´å¢ï¼Ÿ ä¸»ä»å»¶è¿Ÿï¼Ÿ å­˜å‚¨ç©ºé—´ï¼Ÿ å·¥å…·ï¼š\nshow processlist pg_stat_activity explain æ…¢æŸ¥è¯¢æ—¥å¿— 12. ç¼“å­˜æœåŠ¡ï¼ˆRedis/Memcachedï¼‰ é‡ç‚¹ï¼š\næ˜¯å¦å†…å­˜ä¸è¶³ï¼Ÿ æ˜¯å¦è¢«é©±é€ï¼Ÿ æ˜¯å¦é˜»å¡å‘½ä»¤ï¼Ÿ é›†ç¾¤æ§½ä½æ˜¯å¦è¿ç§»å¼‚å¸¸ï¼Ÿ 13. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQï¼‰ é‡ç‚¹ï¼š\nå †ç§¯ï¼Ÿï¼ˆlagï¼‰ broker æ˜¯å¦æŒ‚æ‰ï¼Ÿ partition æ˜¯å¦å‡è¡¡ï¼Ÿ æ¶ˆè´¹è€…å¼‚å¸¸é€€å‡ºï¼Ÿ 14. åå‘ä»£ç† / ç½‘å…³ï¼ˆNginx/APISIX/Envoyï¼‰ æ£€æŸ¥ï¼š\nupstream å¥åº·æ£€æŸ¥æ˜¯å¦å¤±è´¥ timeout æ˜¯å¦è¿‡ä½ 502/504 æ˜¯å¦ç”±ä¸Šæ¸¸å¯¼è‡´ é™æµ / é»‘åå• æ˜¯å¦ç”Ÿæ•ˆ 15. è´Ÿè½½å‡è¡¡ï¼ˆL4/L7ï¼‰ å…³æ³¨ï¼š\næ˜¯å¦åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹åœ¨å·¥ä½œï¼Ÿ æƒé‡é…ç½®é”™è¯¯ï¼Ÿ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Ÿ 16. DNS ç›¸å…³ æ£€æŸ¥ï¼š\nè§£æè®°å½•æ˜¯å¦é”™è¯¯ï¼Ÿ æ˜¯å¦ç¼“å­˜æ—§ IPï¼Ÿï¼ˆå®¢æˆ·ç«¯ï¼‰ æ˜¯å¦æ”»å‡»å¯¼è‡´ DNS è¶…æ—¶ï¼Ÿ å·¥å…·ï¼š\ndig nslookup ğŸ” ç¬¬äº”éƒ¨åˆ†ï¼šé…ç½®æ£€æŸ¥ï¼ˆHOWï¼‰ 17. ç¨‹åºé…ç½®å˜æ›´ å…³æ³¨ï¼š\næœ€è¿‘æ˜¯å¦å‘å¸ƒã€å˜æ›´è¿‡ï¼Ÿ ConfigMap æ˜¯å¦åŒæ­¥ï¼Ÿ ç¯å¢ƒå˜é‡æ˜¯å¦ç¼ºå¤±ï¼Ÿ é…ç½®æ˜¯å¦å¤šç¯å¢ƒæ··ç”¨ï¼Ÿ 18. æƒé™ \u0026amp; è¯ä¹¦ Linux æ–‡ä»¶æƒé™ æ•°æ®åº“æƒé™ Token è¿‡æœŸ TLS/SSL è¯ä¹¦è¿‡æœŸ å®¹å™¨ securityContext é—®é¢˜ ğŸŒˆ æ•…éšœæ’æŸ¥å®Œæ•´æµç¨‹ï¼ˆæœ€ç»ˆç‰ˆï¼‰ å¤ç°é—®é¢˜ï¼ˆç¡®è®¤ï¼‰ çœ‹ç›‘æ§ï¼ˆCPU/å†…å­˜/IO/ç½‘ç»œï¼‰ çœ‹ç¨‹åºæ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œ çœ‹é›†ç¾¤çŠ¶æ€ çœ‹ç«¯å£ä¸è¿é€šæ€§ çœ‹æ—¥å¿—ï¼ˆåº”ç”¨ + ç³»ç»Ÿ + ä¸­é—´ä»¶ï¼‰ çœ‹å®¢æˆ·ç«¯æŠ¥é”™ æ£€æŸ¥ç³»ç»Ÿèµ„æº æ£€æŸ¥ä¾èµ–æœåŠ¡ï¼ˆDBã€Redis ç­‰ï¼‰ æ£€æŸ¥é…ç½®ã€æƒé™ã€è¯ä¹¦ æœ€è¿‘å˜æ›´æ’æŸ¥ æ‰¾åˆ°æ ¹å› å¹¶å¤ç°éªŒè¯ ç»™å‡ºä¿®å¤æ–¹æ¡ˆ é˜²æ­¢å¤å‘æªæ–½ï¼ˆè¡¥ç›‘æ§ã€è¡¥å‘Šè­¦ã€è¡¥æ–‡æ¡£ï¼‰ ä½¿ç”¨è°ƒè¯•å·¥å…· (gdb, strace, tcpdumpç­‰) æŸ¥é˜…æ–‡æ¡£ (å®˜æ–¹æ–‡æ¡£ï¼Œç¤¾åŒºè®ºå›ç­‰) å¯»æ±‚å¸®åŠ© (åŒäº‹ï¼ŒæŠ€æœ¯æ”¯æŒï¼Œç¤¾åŒºç­‰) ","description":" ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯ï¼ˆç³»ç»ŸåŒ– + æœ€ä½³å®è·µï¼‰ æ•…éšœæ’æŸ¥ = ç°è±¡ç¡®è®¤ -\u0026gt; å¿«é€Ÿå®šä½ -\u0026gt; å±‚å±‚æ’é™¤ -\u0026gt; æ ¹å› åˆ†æ -\u0026gt; é˜²æ­¢å¤å‘\næ‰©å±•ï¼š4 ä¸ªå¤§é˜¶æ®µ + 18 ä¸ªæ¨¡å—ã€‚\nğŸ”¥ ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•…éšœç°è±¡ç¡®è®¤ï¼ˆWHATï¼‰ 1. å¤ç°æ•…éšœ / è¡Œä¸ºç¡®è®¤ æ˜¯å¦ç¨³å®šå¤ç°ï¼Ÿæ˜¯å¦æœ‰æ¦‚ç‡æ€§ï¼Ÿ å•ç”¨æˆ· vs å¤šç”¨æˆ·ï¼Ÿ æŸä¸ªæ¥å£ vs å…¨ç«™ï¼Ÿ æŸç»„ä»¶ vs æ•´ä¸ªé›†ç¾¤ï¼Ÿ æ ¸å¿ƒï¼šç¡®ä¿ä¸æ˜¯è¯¯æŠ¥\n"},{"id":481,"href":"/backend/summarize/data-merge/","title":"æ•°æ®åˆå¹¶","parent":"Summarize","content":" JavaScript Object æ•°æ®è¿½åŠ \nlet a = { a: 1, b: 2 } let b = { c: 3, d: 4 } // å°† b è¿½åŠ åˆ° a a = { ...a, ...b } // a: { a: 1, b: 2, c: 3, d: 4 } æ³¨æ„: å¦‚æœ a å’Œ b ä¸­æœ‰ç›¸åŒçš„ key, è¢«è¿½åŠ çš„ key ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„ key\nlet c = { a: 1, b: 2 } let d = { a: 3, d: 4 } // å°† d è¿½åŠ åˆ° c c = { ...c, ...d } // c: { a: 3, b: 2, d: 4 } åˆå¹¶ä¸¤ä¸ª Object åˆ°ä¸€ä¸ªæ–°çš„ Object:\nlet a = { a: 1, b: 2 } let b = { c: 3, d: 4 } let c = { ...a, ...b } // c: { a: 1, b: 2, c: 3, d: 4 } å‚è€ƒæ–‡æ¡£:\nhttps://stackoverflow.com/a/171256 ","description":" JavaScript Object æ•°æ®è¿½åŠ \nlet a = { a: 1, b: 2 } let b = { c: 3, d: 4 } // å°† b è¿½åŠ åˆ° a a = { ...a, ...b } // a: { a: 1, b: 2, c: 3, d: 4 } æ³¨æ„: å¦‚æœ a å’Œ b ä¸­æœ‰ç›¸åŒçš„ key, è¢«è¿½åŠ çš„ key ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„ key\nlet c = { a: 1, b: 2 } let d = { a: 3, d: 4 } // å°† d è¿½åŠ åˆ° c c = { ...c, ...d } // c: { a: 3, b: 2, d: 4 } åˆå¹¶ä¸¤ä¸ª Object åˆ°ä¸€ä¸ªæ–°çš„ Object:\n"},{"id":482,"href":"/database/elasticsearch/data-synchronization-solution/","title":"æ•°æ®åŒæ­¥æ–¹æ¡ˆ","parent":"ElasticSearch","content":"æ²¡æœ‰â€œå”¯ä¸€æ­£ç¡®æ–¹æ¡ˆâ€ï¼Œåªæœ‰â€œæ˜¯å¦ç¬¦åˆä½ ä¸šåŠ¡ç‰¹æ€§â€çš„æ–¹æ¡ˆã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆé€‰å‹é€Ÿè§ˆï¼‰ åœºæ™¯ æ¨èæ–¹æ¡ˆ ä¸€æ¬¡æ€§å…¨é‡åŒæ­¥ Logstash JDBC å®šæ—¶å¢é‡åŒæ­¥ï¼ˆä½å®æ—¶ï¼‰ Logstash JDBCï¼ˆå¢é‡å­—æ®µï¼‰ å‡†å®æ—¶ / å®æ—¶åŒæ­¥ Debeziumï¼ˆCDCï¼‰+ Kafka + ES äº‘å‚å•† / å®˜æ–¹æ–¹æ¡ˆ Elastic å®˜æ–¹ Connector ä¸šåŠ¡é€»è¾‘å¤æ‚ è‡ªç ”åŒæ­¥ç¨‹åºï¼ˆPython/Javaï¼‰ äºŒã€æ–¹æ¡ˆä¸€ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼šLogstash JDBC åŒæ­¥ âœ… é€‚åˆåœºæ™¯ æ•°æ®æºï¼šMySQL / PostgreSQL å»¶è¿Ÿï¼šåˆ†é’Ÿçº§ ç»“æ„åŒ–è¡¨æ•°æ® å®ç°ç®€å•ã€ç¨³å®š ğŸ”§ åŒæ­¥åŸç† DB -\u0026gt; JDBC -\u0026gt; Logstash -\u0026gt; ElasticSearch é€šè¿‡ SQL + å¢é‡å­—æ®µï¼ˆå¦‚ updated_atï¼‰æ‹‰å–æ•°æ®ã€‚\nğŸ§± å…¨é‡åŒæ­¥ç¤ºä¾‹ Logstash é…ç½®ï¼ˆPostgreSQLï¼‰\ninput { jdbc { jdbc_driver_library =\u0026gt; \u0026#34;/usr/share/logstash/postgresql.jar\u0026#34; jdbc_driver_class =\u0026gt; \u0026#34;org.postgresql.Driver\u0026#34; jdbc_connection_string =\u0026gt; \u0026#34;jdbc:postgresql://db:5432/app\u0026#34; jdbc_user =\u0026gt; \u0026#34;user\u0026#34; jdbc_password =\u0026gt; \u0026#34;pwd\u0026#34; statement =\u0026gt; \u0026#34;SELECT * FROM users\u0026#34; } } output { elasticsearch { hosts =\u0026gt; [\u0026#34;http://es:9200\u0026#34;] index =\u0026gt; \u0026#34;users\u0026#34; document_id =\u0026gt; \u0026#34;%{id}\u0026#34; } } ğŸ” å¢é‡åŒæ­¥ï¼ˆç”Ÿäº§å¿…ç”¨ï¼‰ æ¡ä»¶\nè¡¨ä¸­å¿…é¡»æœ‰ï¼š\nupdated_at æˆ–è‡ªå¢ id jdbc { statement =\u0026gt; \u0026#34; SELECT * FROM users WHERE updated_at \u0026gt; :sql_last_value \u0026#34; use_column_value =\u0026gt; true tracking_column =\u0026gt; \u0026#34;updated_at\u0026#34; schedule =\u0026gt; \u0026#34;*/5 * * * *\u0026#34; } ğŸ“Œ Logstash ä¼šè‡ªåŠ¨ä¿å­˜ sql_last_value\nâš ï¸ ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹\nç®€å• æˆç†Ÿç¨³å®š è¿ç»´æˆæœ¬ä½ ç¼ºç‚¹\nå»¶è¿Ÿé«˜ æ— æ³•æ„ŸçŸ¥ deleteï¼ˆéœ€è½¯åˆ é™¤ï¼‰ é«˜å¹¶å‘æ›´æ–°æ—¶å‹åŠ›å¤§ ä¸‰ã€æ–¹æ¡ˆäºŒï¼ˆç”Ÿäº§çº§å®æ—¶ï¼‰ï¼šDebezium CDC + Kafka âœ… é€‚åˆåœºæ™¯ é«˜å®æ—¶æ€§ï¼ˆç§’çº§ï¼‰ æ•°æ®é¢‘ç¹æ›´æ–° å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ å¤§å‹ç³»ç»Ÿ ğŸ”¥ åŒæ­¥æ¶æ„ Postgres/MySQL â†“ binlog / WAL Debezium â†“ Kafka â†“ ElasticSearch Sink ğŸš€ ä¼˜ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰ åŸºäº binlog / WAL ä¸æŸ¥æ•°æ®åº“ å¯æ„ŸçŸ¥ INSERT / UPDATE / DELETE æ”¯æŒå›æ”¾ï¼ˆKafkaï¼‰ çœŸæ­£â€œå‡†å®æ—¶â€ âŒ ç¼ºç‚¹ æ¶æ„å¤æ‚ ç»„ä»¶å¤šï¼ˆKafkaã€Connectï¼‰ è¿ç»´æˆæœ¬é«˜ â˜˜ï¸ æ€»ç»“ Debezium åŸºäºæ•°æ®åº“æ—¥å¿—ï¼ˆbinlog/WALï¼‰ é€šè¿‡ CDC æ•è·å˜æ›´å¹¶æŠ•é€’åˆ° Kafka å†ç”± Sink å†™å…¥ Elasticsearch å®ç°ä½å»¶è¿Ÿã€é«˜å¯é ã€å¯å›æ”¾çš„æ•°æ®åŒæ­¥ å››ã€æ–¹æ¡ˆä¸‰ï¼šElastic å®˜æ–¹ Connectorï¼ˆ8.x æ¨èï¼‰ âœ… ç‰¹ç‚¹ å®˜æ–¹ç»´æŠ¤ æ”¯æŒ MySQL / PostgreSQL æ”¯æŒå…¨é‡ + å¢é‡ ç®¡ç†ç•Œé¢åœ¨ Kibana æ¶æ„ï¼š\nDB -\u0026gt; Elastic Connector -\u0026gt; ElasticSearch ä¼˜ç‚¹ æœ€çœå¿ƒ ä¸ ES ç‰ˆæœ¬å¼ºä¸€è‡´ ç¼ºç‚¹ çµæ´»æ€§ç•¥ä½ é«˜çº§ç©æ³•ä¸å¦‚ Debezium äº”ã€æ–¹æ¡ˆå››ï¼šè‡ªç ”åŒæ­¥ç¨‹åºï¼ˆPython / Javaï¼‰ âœ… é€‚åˆä½ ï¼ˆä½ æœ‰ FastAPI + SQLAlchemy èƒŒæ™¯ï¼‰ æ¶æ„\nDB -\u0026gt; ç¨‹åº -\u0026gt; ElasticSearch Python ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰\nfrom elasticsearch import ElasticSearch es = ElasticSearch(\u0026#34;http://localhost:9200\u0026#34;) es.index( index=\u0026#34;users\u0026#34;, id=user.id, document={ \u0026#34;name\u0026#34;: user.name, \u0026#34;email\u0026#34;: user.email } ) åŒæ­¥ç­–ç•¥\nDB å†™æˆåŠŸ -\u0026gt; åŒæ­¥å†™ ES MQ / äº‹ä»¶é©±åŠ¨ å®šæ—¶æ‰«æè¡¥å¿ âš ï¸ æ³¨æ„ äº‹åŠ¡ä¸€è‡´æ€§è¦è‡ªå·±å¤„ç† å¤±è´¥é‡è¯• å¹‚ç­‰ï¼ˆdocument_id å¿…é¡»ç¨³å®šï¼‰ å…­ã€DELETE å¦‚ä½•åŒæ­¥ï¼Ÿ æ–¹æ¡ˆ æ–¹å¼ Logstash JDBC è½¯åˆ é™¤å­—æ®µï¼ˆis_deletedï¼‰ Debezium è‡ªåŠ¨æ•è· DELETE è‡ªç ” DB delete -\u0026gt; ES delete å®˜æ–¹ Connector æ”¯æŒ ä¸ƒã€ç´¢å¼•è®¾è®¡ï¼ˆéå¸¸å…³é”®ï¼‰ å¿…åšäº‹é¡¹\nDB ä¸»é”® -\u0026gt; ES _id keyword / text åˆç† mapping ä¸è¦è®© ES åŠ¨æ€å»ºå­—æ®µï¼ˆdynamic=falseï¼‰ ä½¿ç”¨ index template å…«ã€æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“ ä½å®æ—¶ã€ç®€å•åŒæ­¥ï¼šLogstash JDBC é«˜å®æ—¶ã€å¼ºä¸€è‡´ï¼šDebezium + Kafka å®˜æ–¹çœå¿ƒï¼šElastic Connector å¼ºä¸šåŠ¡å®šåˆ¶ï¼šè‡ªç ”åŒæ­¥æœåŠ¡ ä¹ã€æ€»ç»“ PostgreSQL/MySQL åŒæ­¥åˆ° Elasticsearchï¼š\nå¦‚æœæ˜¯ç¦»çº¿æˆ–åˆ†é’Ÿçº§åŒæ­¥ï¼Œæ¨èä½¿ç”¨ Logstash JDBC å¦‚æœæ˜¯å‡†å®æ—¶ã€å¹¶ä¸”éœ€è¦æ„ŸçŸ¥ deleteï¼Œæ¨èä½¿ç”¨ Debezium åŸºäº binlog/WAL çš„ CDC åŒæ­¥ ç”¨æ•°æ®åº“ä¸»é”®ä½œä¸º ES çš„ document_idã€‚\né€šè¿‡ ILMã€mapping æ§åˆ¶ç´¢å¼•ç”Ÿå‘½å‘¨æœŸå’Œç»“æ„ï¼Œä¿è¯é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚\n","description":"æ²¡æœ‰â€œå”¯ä¸€æ­£ç¡®æ–¹æ¡ˆâ€ï¼Œåªæœ‰â€œæ˜¯å¦ç¬¦åˆä½ ä¸šåŠ¡ç‰¹æ€§â€çš„æ–¹æ¡ˆã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆé€‰å‹é€Ÿè§ˆï¼‰ åœºæ™¯ æ¨èæ–¹æ¡ˆ ä¸€æ¬¡æ€§å…¨é‡åŒæ­¥ Logstash JDBC å®šæ—¶å¢é‡åŒæ­¥ï¼ˆä½å®æ—¶ï¼‰ Logstash JDBCï¼ˆå¢é‡å­—æ®µï¼‰ å‡†å®æ—¶ / å®æ—¶åŒæ­¥ Debeziumï¼ˆCDCï¼‰+ Kafka + ES äº‘å‚å•† / å®˜æ–¹æ–¹æ¡ˆ Elastic å®˜æ–¹ Connector ä¸šåŠ¡é€»è¾‘å¤æ‚ è‡ªç ”åŒæ­¥ç¨‹åºï¼ˆPython/Javaï¼‰ äºŒã€æ–¹æ¡ˆä¸€ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼šLogstash JDBC åŒæ­¥ âœ… é€‚åˆåœºæ™¯ æ•°æ®æºï¼šMySQL / PostgreSQL å»¶è¿Ÿï¼šåˆ†é’Ÿçº§ ç»“æ„åŒ–è¡¨æ•°æ® å®ç°ç®€å•ã€ç¨³å®š ğŸ”§ åŒæ­¥åŸç† DB -\u0026gt; JDBC -\u0026gt; Logstash -\u0026gt; ElasticSearch é€šè¿‡ SQL + å¢é‡å­—æ®µï¼ˆå¦‚ updated_atï¼‰æ‹‰å–æ•°æ®ã€‚\n"},{"id":483,"href":"/operations/linux/irqbalance-database/","title":"æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰æ˜¯å¦åº”è¯¥å…³é—­ irqbalance","parent":"Linux","content":"ä¸‹é¢ç»™ä½ ä¸€ä¸ªæ˜ç¡®ç»“è®º + åŸç†è§£é‡Š + å¯æ‰§è¡Œå»ºè®®çš„ç­”æ¡ˆï¼Œé€‚ç”¨äº MySQL / PostgreSQLï¼Œå¹¶åŒºåˆ† å•æœº / NUMA / äº‘ç¯å¢ƒã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ æ•°æ®åº“æ˜¯å¦å…³é—­ irqbalanceï¼Œå–å†³äºä½ æ˜¯å¦â€œäººå·¥æ¥ç®¡äº†ä¸­æ–­è°ƒåº¦â€ã€‚\næ€»ç»“è¡¨ï¼ˆç›´æ¥å¯ç”¨ï¼‰ åœºæ™¯ æ˜¯å¦å…³é—­ irqbalance åŸå›  å•è·¯æœåŠ¡å™¨ / æ™®é€šäº‘ä¸»æœº âŒ ä¸å…³é—­ è‡ªåŠ¨è°ƒåº¦æ¯”äººå·¥æ›´ç¨³ åŒè·¯ NUMA æœåŠ¡å™¨ âŒ é€šå¸¸ä¸å…³é—­ NUMA æ„ŸçŸ¥åˆ†é…æ›´åˆç† å·²æ‰‹åŠ¨ç»‘å®šç½‘å¡ / NVMe IRQ âœ… å¿…é¡»å…³é—­ é¿å…è¢«è¦†ç›– æè‡´ä½å»¶è¿Ÿæ•°æ®åº“ âœ… å…³é—­ ä¿è¯ä¸­æ–­å¯é¢„æµ‹ äº‘å‚å•†æ‰˜ç®¡æ•°æ®åº“ âŒ ä¸å…³é—­ å¹³å°å·²è°ƒä¼˜ äºŒã€ä¸ºä»€ä¹ˆâ€œé»˜è®¤ä¸è¯¥å…³ irqbalanceâ€ 1. æ•°æ®åº“ä¸¥é‡ä¾èµ– I/O ä¸­æ–­ MySQL / PostgreSQL å¯¹ä»¥ä¸‹ä¸­æ–­éå¸¸æ•æ„Ÿï¼š\nç£ç›˜ I/O å®Œæˆä¸­æ–­ï¼ˆNVMe / SATAï¼‰ ç½‘ç»œä¸­æ–­ï¼ˆå¤åˆ¶ã€å®¢æˆ·ç«¯è¿æ¥ï¼‰ å®šæ—¶å™¨ä¸­æ–­ï¼ˆåå°è¿›ç¨‹ï¼‰ irqbalance çš„ä»·å€¼ï¼š\né˜²æ­¢ä¸­æ–­é›†ä¸­åœ¨ CPU0 åˆ†æ•£è½¯ä¸­æ–­è´Ÿè½½ å‡å°‘æŠ–åŠ¨å’Œå°¾å»¶è¿Ÿ 2. NUMA ç³»ç»Ÿä¸‹ irqbalance æ˜¯â€œæ­£æ”¶ç›Šâ€ åœ¨åŒè·¯æœåŠ¡å™¨ä¸­ï¼š\nè®¾å¤‡ç‰©ç†æŒ‚åœ¨æŸä¸ª NUMA èŠ‚ç‚¹ irqbalance ä¼šï¼š ä¼˜å…ˆç»‘å®šåˆ°æœ¬åœ° CPU å‡å°‘è·¨ NUMA å†…å­˜è®¿é—® äººå·¥åšå¾—æ¯”å®ƒå¥½å¾ˆéš¾ã€‚\nä¸‰ã€ä»€ä¹ˆæ—¶å€™å¿…é¡»å…³é—­ irqbalance åœºæ™¯ 1ï¼šä½ å·²ç»æ‰‹åŠ¨ç»‘å®š IRQ ä¾‹å¦‚ï¼š\necho 000000f0 \u0026gt; /proc/irq/123/smp_affinity æ­¤æ—¶ï¼š\nirqbalance ä¼šåœ¨ä¸‹ä¸€è½®é‡æ–°åˆ†é…ï¼Œç›´æ¥è¦†ç›–ä½ çš„ä¼˜åŒ–\nç»“è®ºï¼š\næ‰‹åŠ¨ IRQ ç»‘å®š â‰  irqbalance äºŒè€…åªèƒ½é€‰ä¸€ä¸ª åœºæ™¯ 2ï¼šæè‡´ä½å»¶è¿Ÿæ•°æ®åº“ ç‰¹å¾ï¼š\né‡‘èäº¤æ˜“ é«˜é¢‘å†™å…¥ P99 / P999 å»¶è¿Ÿæ•æ„Ÿ è¦æ±‚ï¼š\nä¸­æ–­è·¯å¾„ç¨³å®š ä¸å…è®¸åŠ¨æ€æ¼‚ç§» æ­¤æ—¶å»ºè®®ï¼š\nå…³é—­ irqbalance å›ºå®š IRQ -\u0026gt; CPU å›ºå®šæ•°æ®åº“è¿›ç¨‹ -\u0026gt; CPU åœºæ™¯ 3ï¼šæ•°æ®åº“ç‹¬å æœåŠ¡å™¨ å¦‚æœï¼š\næœåŠ¡å™¨åªè·‘æ•°æ®åº“ CPU æ ¸å¿ƒæœ‰æ˜ç¡®åˆ†å·¥ ç¤ºä¾‹ï¼š\nCPU0â€“1ï¼šç³»ç»Ÿ CPU2â€“15ï¼šæ•°æ®åº“ CPU16â€“23ï¼šIRQ ğŸ‘‰ è¿™ç±»æ¶æ„ å¿…é¡»å…³é—­ irqbalance\nå››ã€MySQL / PostgreSQL å®˜æ–¹æ€åº¦ï¼ˆå·¥ç¨‹ç°å®ï¼‰ MySQL å®˜æ–¹æ–‡æ¡£ ä¸å»ºè®®å…³é—­ irqbalance é™¤éï¼š ä½ æ˜ç¡®çŸ¥é“æ¯ä¸ªä¸­æ–­ä½ç½® æœ‰å®Œæ•´å‹æµ‹æ•°æ®æ”¯æ’‘ PostgreSQL æ›´å¼ºè°ƒç³»ç»Ÿæ•´ä½“ç¨³å®š é»˜è®¤å»ºè®®ï¼š ä¿ç•™ irqbalance ä¼˜å…ˆè°ƒä¼˜ NUMA / hugepage / I/O äº”ã€æ­£ç¡®çš„å®è·µè·¯å¾„ï¼ˆéå¸¸å…³é”®ï¼‰ è·¯å¾„ä¸€ï¼šæ¨èï¼ˆ90% åœºæ™¯ï¼‰ å¼€å¯ irqbalance + ä¸æ‰‹åŠ¨ç»‘å®š IRQ\nåªåšï¼š\nNUMA ç»‘å®šæ•°æ®åº“è¿›ç¨‹ åˆç†è®¾ç½® CPU äº²å’Œæ€§ è°ƒæ•´ sysctl / I/O è·¯å¾„äºŒï¼šé«˜é˜¶ä¼˜åŒ–ï¼ˆ10% åœºæ™¯ï¼‰ æ­¥éª¤å¿…é¡»å®Œæ•´ï¼š\nåœæ­¢ irqbalance\nsystemctl disable --now irqbalance æ‰‹åŠ¨ç»‘å®š IRQï¼ˆç½‘å¡ / NVMeï¼‰\nå›ºå®šæ•°æ®åº“è¿›ç¨‹ CPU äº²å’Œæ€§\nå›ºå®š NUMA å†…å­˜ç­–ç•¥\nå‹æµ‹éªŒè¯ï¼ˆä¸æ˜¯å‡­æ„Ÿè§‰ï¼‰\nå…­ã€ä¸€ä¸ªéå¸¸é‡è¦çš„è¯¯åŒºï¼ˆè­¦å‘Šï¼‰ âŒ â€œæ•°æ®åº“æ€§èƒ½ä¸å¥½ -\u0026gt; å…ˆå…³ irqbalanceâ€\nè¿™æ˜¯é”™è¯¯åšæ³•ã€‚\næ­£ç¡®é¡ºåºï¼š\næ£€æŸ¥ NUMA æ£€æŸ¥ I/O è°ƒåº¦ æ£€æŸ¥å†…å­˜ç­–ç•¥ å†è€ƒè™‘ IRQ ä¸ƒã€ç®€å•åˆ¤æ–­è§„åˆ™ï¼ˆå®æˆ˜ç‰ˆï¼‰ å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š\nä½ æ˜¯å¦æ”¹è¿‡ /proc/irq/*/smp_affinityï¼Ÿ ä½ æ˜¯å¦çŸ¥é“ç½‘å¡ / ç£ç›˜æŒ‚åœ¨å“ªä¸ª NUMA èŠ‚ç‚¹ï¼Ÿ ä½ æ˜¯å¦æœ‰å‹æµ‹å¯¹æ¯”æ•°æ®ï¼Ÿ å¦‚æœ ä»»ä¸€ç­”æ¡ˆæ˜¯â€œå¦â€ï¼š\nä¸è¦å…³é—­ irqbalance\nå…«ã€ä¸€å¥è¯å·¥ç¨‹æ€»ç»“ irqbalance æ˜¯æ•°æ®åº“ç³»ç»Ÿçš„â€œé»˜è®¤å®‰å…¨ç½‘â€ï¼Œ åªæœ‰åœ¨ä½ å®Œå…¨æ¥ç®¡ CPU ä¸ä¸­æ–­è°ƒåº¦æ—¶ï¼Œæ‰åº”è¯¥å…³é—­å®ƒã€‚\n","description":"ä¸‹é¢ç»™ä½ ä¸€ä¸ªæ˜ç¡®ç»“è®º + åŸç†è§£é‡Š + å¯æ‰§è¡Œå»ºè®®çš„ç­”æ¡ˆï¼Œé€‚ç”¨äº MySQL / PostgreSQLï¼Œå¹¶åŒºåˆ† å•æœº / NUMA / äº‘ç¯å¢ƒã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰ æ•°æ®åº“æ˜¯å¦å…³é—­ irqbalanceï¼Œå–å†³äºä½ æ˜¯å¦â€œäººå·¥æ¥ç®¡äº†ä¸­æ–­è°ƒåº¦â€ã€‚\næ€»ç»“è¡¨ï¼ˆç›´æ¥å¯ç”¨ï¼‰ åœºæ™¯ æ˜¯å¦å…³é—­ irqbalance åŸå›  å•è·¯æœåŠ¡å™¨ / æ™®é€šäº‘ä¸»æœº âŒ ä¸å…³é—­ è‡ªåŠ¨è°ƒåº¦æ¯”äººå·¥æ›´ç¨³ åŒè·¯ NUMA æœåŠ¡å™¨ âŒ é€šå¸¸ä¸å…³é—­ NUMA æ„ŸçŸ¥åˆ†é…æ›´åˆç† å·²æ‰‹åŠ¨ç»‘å®šç½‘å¡ / NVMe IRQ âœ… å¿…é¡»å…³é—­ é¿å…è¢«è¦†ç›– æè‡´ä½å»¶è¿Ÿæ•°æ®åº“ âœ… å…³é—­ ä¿è¯ä¸­æ–­å¯é¢„æµ‹ äº‘å‚å•†æ‰˜ç®¡æ•°æ®åº“ âŒ ä¸å…³é—­ å¹³å°å·²è°ƒä¼˜ äºŒã€ä¸ºä»€ä¹ˆâ€œé»˜è®¤ä¸è¯¥å…³ irqbalanceâ€ 1. æ•°æ®åº“ä¸¥é‡ä¾èµ– I/O ä¸­æ–­ MySQL / PostgreSQL å¯¹ä»¥ä¸‹ä¸­æ–­éå¸¸æ•æ„Ÿï¼š\n"},{"id":484,"href":"/database/design/ruthless/","title":"æ•°æ®åº“è®¾è®¡ä¸‰å¤§èŒƒå¼","parent":"Design","content":"æ•°æ®åº“è®¾è®¡ä¸‰å¤§èŒƒå¼ï¼ˆ1NFã€2NFã€3NFï¼‰æ˜¯ä¿è¯æ•°æ®åº“è§„èŒƒåŒ–ã€æé«˜æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€å‡å°‘æ•°æ®å†—ä½™å’Œæ“ä½œå¼‚å¸¸çš„é‡è¦åŸåˆ™ã€‚å…·ä½“æ¥è¯´ï¼š\nç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰è¦æ±‚æ•°æ®åº“è¡¨ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œä¸å¯å†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®åˆ—éƒ½å¿…é¡»å®Œå…¨ä¾èµ–äºæ•´ä¸ªä¸»é”®ï¼Œè€Œä¸æ˜¯ä¸»é”®çš„æŸä¸ªéƒ¨åˆ†ï¼Œæ¶ˆé™¤éä¸»é”®åˆ—å¯¹ä¸»é”®çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®åˆ—ä¹‹é—´ä¸èƒ½å­˜åœ¨ä¼ é€’ä¾èµ–å…³ç³»ï¼Œéä¸»é”®åˆ—åº”è¯¥ç›´æ¥ä¾èµ–äºä¸»é”®ã€‚ å…·ä½“è§£é‡Š ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ï¼šåŸå­æ€§\næ¦‚å¿µï¼šè¡¨ä¸­çš„æ¯ä¸€ä¸ªåˆ—éƒ½å¿…é¡»æ˜¯ä¸å¯åˆ†å‰²çš„åŸå­æ•°æ®é¡¹ã€‚ ä¾‹å­ï¼šå¦‚æœä¸€ä¸ªåœ°å€åˆ—å¯ä»¥è¢«æ‹†åˆ†ä¸ºå›½å®¶ã€çœã€å¸‚ã€å¿ç­‰å¤šä¸ªéƒ¨åˆ†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€åˆ—å°±ä¸æ»¡è¶³ç¬¬ä¸€èŒƒå¼ï¼Œéœ€è¦è¿›è¡Œæ‹†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰ï¼šå®Œå…¨ä¾èµ–äºä¸»é”®\nå‰æï¼šè¡¨å¿…é¡»æ»¡è¶³ç¬¬ä¸€èŒƒå¼ã€‚ æ¦‚å¿µï¼šæ‰€æœ‰éä¸»é”®çš„åˆ—éƒ½å¿…é¡»å®Œå…¨ä¾èµ–äºæ•´ä¸ªå€™é€‰ä¸»é”®ï¼ˆç ï¼‰ã€‚å¯¹äºè”åˆä¸»é”®ï¼Œéä¸»é”®å±æ€§å¿…é¡»ä¾èµ–äºå…¨éƒ¨ä¸»é”®åˆ—ã€‚ ä½œç”¨ï¼šé¿å…äº†æ•°æ®å†—ä½™ï¼Œè§£å†³äº†åœ¨æ›´æ–°ã€æ’å…¥ã€åˆ é™¤æ•°æ®æ—¶å¯èƒ½å‡ºç°çš„å¼‚å¸¸ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼šä¸å­˜åœ¨ä¼ é€’ä¾èµ–\nå‰æï¼šè¡¨å¿…é¡»æ»¡è¶³ç¬¬äºŒèŒƒå¼ã€‚ æ¦‚å¿µï¼šæ‰€æœ‰éä¸»é”®åˆ—ä¹‹é—´ä¸åº”å­˜åœ¨ä¼ é€’ä¾èµ–å…³ç³»ã€‚æ¢å¥è¯è¯´ï¼Œéä¸»é”®åˆ—ä¹‹é—´ä¸èƒ½äº’ç›¸ä¾èµ–ï¼Œå®ƒä»¬åº”è¯¥ç›´æ¥ä¾èµ–äºä¸»é”®ã€‚ ä½œç”¨ï¼šè¿›ä¸€æ­¥å‡å°‘äº†æ•°æ®å†—ä½™ï¼Œæé«˜äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚ æ€»ç»“ ä¸‰å¤§èŒƒå¼ä¸ºæ•°æ®åº“è®¾è®¡è€…æä¾›äº†ä¸€å¥—æ ‡å‡†ï¼Œä»¥åˆ›å»ºé«˜æ•ˆã€ç¨³å®šã€æ— å†—ä½™çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚è™½ç„¶åœ¨å®é™…å¼€å‘ä¸­å¯èƒ½ä¸ºäº†æ€§èƒ½éœ€è¦é€‚å½“æ‰“ç ´èŒƒå¼åŸåˆ™ï¼Œä½†è¿™é€šå¸¸æ˜¯ç¬¬ä¸‰ä¸ªå¢ƒç•Œï¼ˆç»éªŒä¸°å¯Œåï¼‰æ‰è€ƒè™‘çš„é—®é¢˜ï¼Œä¸åº”åœ¨å…¥é—¨é˜¶æ®µç›²ç›®è¿½æ±‚ã€‚\nä»€ä¹ˆæ˜¯èŒƒå¼: ç®€è¨€ä¹‹å°±æ˜¯, æ•°æ®åº“è®¾è®¡å¯¹æ•°æ®çš„å­˜å‚¨æ€§èƒ½, è¿˜æœ‰å¼€å‘äººå‘˜å¯¹æ•°æ®çš„æ“ä½œéƒ½æœ‰è«å¤§çš„å…³ç³». æ‰€ä»¥å»ºç«‹ç§‘å­¦çš„ã€è§„èŒƒçš„çš„æ•°æ®åº“æ˜¯éœ€è¦æ»¡è¶³ä¸€äº›è§„èŒƒçš„æ¥ä¼˜åŒ–æ•°æ®æ•°æ®å­˜å‚¨æ–¹å¼. åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­è¿™äº›è§„èŒƒå°±å¯ä»¥ç§°ä¸ºèŒƒå¼.\nä»€ä¹ˆæ˜¯ä¸‰å¤§èŒƒå¼ ç¬¬ä¸€èŒƒå¼: å½“å…³ç³»æ¨¡å¼ R çš„æ‰€æœ‰å±æ€§éƒ½ä¸èƒ½åœ¨åˆ†è§£ä¸ºæ›´åŸºæœ¬çš„æ•°æ®å•ä½æ—¶, ç§° R æ˜¯æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„, ç®€è®°ä¸º 1NF.\næ»¡è¶³ç¬¬ä¸€èŒƒå¼æ˜¯å…³ç³»æ¨¡å¼è§„èŒƒåŒ–çš„æœ€ä½è¦æ±‚, å¦åˆ™, å°†æœ‰å¾ˆå¤šåŸºæœ¬æ“ä½œåœ¨è¿™æ ·çš„å…³ç³»æ¨¡å¼ä¸­å®ç°ä¸äº†. ç¬¬äºŒèŒƒå¼: å¦‚æœå…³ç³»æ¨¡å¼ R æ»¡è¶³ç¬¬ä¸€èŒƒå¼, å¹¶ä¸” R çš„æ‰€æœ‰éä¸»å±æ€§éƒ½å®Œå…¨ä¾èµ–äº R çš„æ¯ä¸€ä¸ªå€™é€‰å…³é”®å±æ€§, ç§° R æ»¡è¶³ç¬¬äºŒèŒƒå¼, ç®€è®°ä¸º 2NF.\nç¬¬ä¸‰èŒƒå¼: è®¾ R æ˜¯ä¸€ä¸ªæ»¡è¶³ç¬¬ä¸€èŒƒå¼æ¡ä»¶çš„å…³ç³»æ¨¡å¼, X æ˜¯ R çš„ä»»æ„å±æ€§é›†, å¦‚æœ X éä¼ é€’ä¾èµ–äº R çš„ä»»æ„ä¸€ä¸ªå€™é€‰å…³é”®å­—, ç§° R æ»¡è¶³ç¬¬ä¸‰èŒƒå¼, ç®€è®°ä¸º 3NF.\næ³¨: å…³ç³»å®è´¨ä¸Šæ˜¯ä¸€å¼ äºŒç»´è¡¨, å…¶ä¸­æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªå…ƒç»„, æ¯ä¸€åˆ—æ˜¯ä¸€ä¸ªå±æ€§.\nç¬¬ä¸€èŒƒå¼ æ¯ä¸€åˆ—å±æ€§éƒ½æ˜¯ä¸å¯å†åˆ†çš„å±æ€§å€¼, ç¡®ä¿æ¯ä¸€åˆ—çš„åŸå­æ€§.\nä¸¤åˆ—çš„å±æ€§ç›¸è¿‘æˆ–ç›¸ä¼¼æˆ–ä¸€æ ·, å°½é‡åˆå¹¶å±æ€§ä¸€æ ·çš„åˆ—, ç¡®ä¿ä¸äº§ç”Ÿå†—ä½™æ•°æ®.\nå¦‚æœéœ€è¦çŸ¥é“å“ªä¸ªçœå“ªä¸ªå¸‚å¹¶æŒ‰å…¶åˆ†ç±», é‚£ä¹ˆæ˜¾ç„¶ç¬¬ä¸€ä¸ªè¡¨æ ¼æ˜¯ä¸å®¹æ˜“æ»¡è¶³éœ€æ±‚çš„, ä¹Ÿä¸ç¬¦åˆç¬¬ä¸€èŒƒå¼.\næ˜¾ç„¶ç¬¬ä¸€ä¸ªè¡¨ç»“æ„ä¸ä½†ä¸èƒ½æ»¡è¶³è¶³å¤Ÿå¤šç‰©å“çš„è¦æ±‚, è¿˜ä¼šåœ¨ç‰©å“å°‘æ—¶äº§ç”Ÿå†—ä½™. ä¹Ÿæ˜¯ä¸ç¬¦åˆç¬¬ä¸€èŒƒå¼çš„.\nç¬¬äºŒèŒƒå¼ æ¯ä¸€è¡Œçš„æ•°æ®åªèƒ½ä¸å…¶ä¸­ä¸€åˆ—ç›¸å…³, å³ä¸€è¡Œæ•°æ®åªåšä¸€ä»¶äº‹. åªè¦æ•°æ®åˆ—ä¸­å‡ºç°æ•°æ®é‡å¤, å°±è¦æŠŠè¡¨æ‹†åˆ†å¼€æ¥.\nä¸€ä¸ªäººåŒæ—¶è®¢å‡ ä¸ªæˆ¿é—´, å°±ä¼šå‡ºæ¥ä¸€ä¸ªè®¢å•å·å¤šæ¡æ•°æ®, è¿™æ ·å­è”ç³»äººéƒ½æ˜¯é‡å¤çš„, å°±ä¼šé€ æˆæ•°æ®å†—ä½™. æˆ‘ä»¬åº”è¯¥æŠŠä»–æ‹†å¼€æ¥.\nè¿™æ ·ä¾¿å®ç°äº†ä¸€æ¡æ•°æ®åšä¸€ä»¶äº‹, ä¸æºæ‚å¤æ‚çš„å…³ç³»é€»è¾‘. åŒæ—¶å¯¹è¡¨æ•°æ®çš„æ›´æ–°ç»´æŠ¤ä¹Ÿæ›´æ˜“æ“ä½œ.\nç¬¬ä¸‰èŒƒå¼ æ•°æ®ä¸èƒ½å­˜åœ¨ä¼ é€’å…³ç³», å³æ¯ä¸ªå±æ€§éƒ½è·Ÿä¸»é”®æœ‰ç›´æ¥å…³ç³»è€Œä¸æ˜¯é—´æ¥å…³ç³». åƒ: a -\u0026gt; b -\u0026gt; c, å±æ€§ä¹‹é—´å«æœ‰è¿™æ ·çš„å…³ç³», æ˜¯ä¸ç¬¦åˆç¬¬ä¸‰èŒƒå¼çš„.\næ¯”å¦‚ Studentè¡¨ (å­¦å·, å§“å, å¹´é¾„, æ€§åˆ«, æ‰€åœ¨é™¢æ ¡, é™¢æ ¡åœ°å€, é™¢æ ¡ç”µè¯)\nè¿™æ ·ä¸€ä¸ªè¡¨ç»“æ„, å°±å­˜åœ¨ä¸Šè¿°å…³ç³»: å­¦å· -\u0026gt; æ‰€åœ¨é™¢æ ¡ -\u0026gt; (é™¢æ ¡åœ°å€, é™¢æ ¡ç”µè¯)\nè¿™æ ·çš„è¡¨ç»“æ„, æˆ‘ä»¬åº”è¯¥æ‹†å¼€æ¥: (å­¦å·, å§“å, å¹´é¾„, æ€§åˆ«, æ‰€åœ¨é™¢æ ¡) \u0026ndash; (æ‰€åœ¨é™¢æ ¡, é™¢æ ¡åœ°å€, é™¢æ ¡ç”µè¯)\næœ€å ä¸‰å¤§èŒƒå¼åªæ˜¯ä¸€èˆ¬è®¾è®¡æ•°æ®åº“çš„åŸºæœ¬ç†å¿µ, å¯ä»¥å»ºç«‹å†—ä½™è¾ƒå°ã€ç»“æ„åˆç†çš„æ•°æ®åº“.\nå¦‚æœæœ‰ç‰¹æ®Šæƒ…å†µ, å½“ç„¶è¦ç‰¹æ®Šå¯¹å¾…, æ•°æ®åº“è®¾è®¡æœ€é‡è¦çš„æ˜¯çœ‹éœ€æ±‚è·Ÿæ€§èƒ½, éœ€æ±‚ \u0026gt; æ€§èƒ½ \u0026gt; è¡¨ç»“æ„. æ‰€ä»¥ä¸èƒ½ä¸€å‘³çš„å»è¿½æ±‚èŒƒå¼å»ºç«‹æ•°æ®åº“.\n","description":"æ•°æ®åº“è®¾è®¡ä¸‰å¤§èŒƒå¼ï¼ˆ1NFã€2NFã€3NFï¼‰æ˜¯ä¿è¯æ•°æ®åº“è§„èŒƒåŒ–ã€æé«˜æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€å‡å°‘æ•°æ®å†—ä½™å’Œæ“ä½œå¼‚å¸¸çš„é‡è¦åŸåˆ™ã€‚å…·ä½“æ¥è¯´ï¼š\nç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰è¦æ±‚æ•°æ®åº“è¡¨ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œä¸å¯å†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®åˆ—éƒ½å¿…é¡»å®Œå…¨ä¾èµ–äºæ•´ä¸ªä¸»é”®ï¼Œè€Œä¸æ˜¯ä¸»é”®çš„æŸä¸ªéƒ¨åˆ†ï¼Œæ¶ˆé™¤éä¸»é”®åˆ—å¯¹ä¸»é”®çš„éƒ¨åˆ†å‡½æ•°ä¾èµ–ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ‰€æœ‰éä¸»é”®åˆ—ä¹‹é—´ä¸èƒ½å­˜åœ¨ä¼ é€’ä¾èµ–å…³ç³»ï¼Œéä¸»é”®åˆ—åº”è¯¥ç›´æ¥ä¾èµ–äºä¸»é”®ã€‚ å…·ä½“è§£é‡Š ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ï¼šåŸå­æ€§\næ¦‚å¿µï¼šè¡¨ä¸­çš„æ¯ä¸€ä¸ªåˆ—éƒ½å¿…é¡»æ˜¯ä¸å¯åˆ†å‰²çš„åŸå­æ•°æ®é¡¹ã€‚ ä¾‹å­ï¼šå¦‚æœä¸€ä¸ªåœ°å€åˆ—å¯ä»¥è¢«æ‹†åˆ†ä¸ºå›½å®¶ã€çœã€å¸‚ã€å¿ç­‰å¤šä¸ªéƒ¨åˆ†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€åˆ—å°±ä¸æ»¡è¶³ç¬¬ä¸€èŒƒå¼ï¼Œéœ€è¦è¿›è¡Œæ‹†åˆ†ã€‚ ç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰ï¼šå®Œå…¨ä¾èµ–äºä¸»é”®\nå‰æï¼šè¡¨å¿…é¡»æ»¡è¶³ç¬¬ä¸€èŒƒå¼ã€‚ æ¦‚å¿µï¼šæ‰€æœ‰éä¸»é”®çš„åˆ—éƒ½å¿…é¡»å®Œå…¨ä¾èµ–äºæ•´ä¸ªå€™é€‰ä¸»é”®ï¼ˆç ï¼‰ã€‚å¯¹äºè”åˆä¸»é”®ï¼Œéä¸»é”®å±æ€§å¿…é¡»ä¾èµ–äºå…¨éƒ¨ä¸»é”®åˆ—ã€‚ ä½œç”¨ï¼šé¿å…äº†æ•°æ®å†—ä½™ï¼Œè§£å†³äº†åœ¨æ›´æ–°ã€æ’å…¥ã€åˆ é™¤æ•°æ®æ—¶å¯èƒ½å‡ºç°çš„å¼‚å¸¸ã€‚ ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼šä¸å­˜åœ¨ä¼ é€’ä¾èµ–\nå‰æï¼šè¡¨å¿…é¡»æ»¡è¶³ç¬¬äºŒèŒƒå¼ã€‚ æ¦‚å¿µï¼šæ‰€æœ‰éä¸»é”®åˆ—ä¹‹é—´ä¸åº”å­˜åœ¨ä¼ é€’ä¾èµ–å…³ç³»ã€‚æ¢å¥è¯è¯´ï¼Œéä¸»é”®åˆ—ä¹‹é—´ä¸èƒ½äº’ç›¸ä¾èµ–ï¼Œå®ƒä»¬åº”è¯¥ç›´æ¥ä¾èµ–äºä¸»é”®ã€‚ ä½œç”¨ï¼šè¿›ä¸€æ­¥å‡å°‘äº†æ•°æ®å†—ä½™ï¼Œæé«˜äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚ æ€»ç»“ ä¸‰å¤§èŒƒå¼ä¸ºæ•°æ®åº“è®¾è®¡è€…æä¾›äº†ä¸€å¥—æ ‡å‡†ï¼Œä»¥åˆ›å»ºé«˜æ•ˆã€ç¨³å®šã€æ— å†—ä½™çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚è™½ç„¶åœ¨å®é™…å¼€å‘ä¸­å¯èƒ½ä¸ºäº†æ€§èƒ½éœ€è¦é€‚å½“æ‰“ç ´èŒƒå¼åŸåˆ™ï¼Œä½†è¿™é€šå¸¸æ˜¯ç¬¬ä¸‰ä¸ªå¢ƒç•Œï¼ˆç»éªŒä¸°å¯Œåï¼‰æ‰è€ƒè™‘çš„é—®é¢˜ï¼Œä¸åº”åœ¨å…¥é—¨é˜¶æ®µç›²ç›®è¿½æ±‚ã€‚\nä»€ä¹ˆæ˜¯èŒƒå¼: ç®€è¨€ä¹‹å°±æ˜¯, æ•°æ®åº“è®¾è®¡å¯¹æ•°æ®çš„å­˜å‚¨æ€§èƒ½, è¿˜æœ‰å¼€å‘äººå‘˜å¯¹æ•°æ®çš„æ“ä½œéƒ½æœ‰è«å¤§çš„å…³ç³». æ‰€ä»¥å»ºç«‹ç§‘å­¦çš„ã€è§„èŒƒçš„çš„æ•°æ®åº“æ˜¯éœ€è¦æ»¡è¶³ä¸€äº›è§„èŒƒçš„æ¥ä¼˜åŒ–æ•°æ®æ•°æ®å­˜å‚¨æ–¹å¼. åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­è¿™äº›è§„èŒƒå°±å¯ä»¥ç§°ä¸ºèŒƒå¼.\nä»€ä¹ˆæ˜¯ä¸‰å¤§èŒƒå¼ ç¬¬ä¸€èŒƒå¼: å½“å…³ç³»æ¨¡å¼ R çš„æ‰€æœ‰å±æ€§éƒ½ä¸èƒ½åœ¨åˆ†è§£ä¸ºæ›´åŸºæœ¬çš„æ•°æ®å•ä½æ—¶, ç§° R æ˜¯æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„, ç®€è®°ä¸º 1NF.\n"},{"id":485,"href":"/backend/python/sqlalchemy/data-form/","title":"æ•°æ®å½¢æ€","parent":"SQLAlchemy","content":"ä¸‹é¢ç»™ä½ ä¸€ä¸ªé«˜ä»·å€¼å¯é•¿æœŸå¤ç”¨çš„æ€»ç»“ï¼š\nå¸¸ç”¨çš„æ•°æ®æŸ¥è¯¢åœºæ™¯ -\u0026gt; SQL æŸ¥è¯¢å½¢æ€ -\u0026gt; æŸ¥è¯¢ç»“æœçš„æ•°æ®ç»“æ„ -\u0026gt; Python ä¸­çš„å¯¹åº”æ•°æ®æ ¼å¼ã€‚\nè¿™æ˜¯ä¸€ä¸ªå®Œå…¨è´´è¿‘ä½ åœ¨ FastAPI + SQLAlchemy + PostgreSQL é¡¹ç›®ä¸­ä½¿ç”¨çš„â€œå®æˆ˜é€ŸæŸ¥è¡¨â€ï¼Œå¯ä»¥ç›´æ¥ç”¨åœ¨ä½ çš„ä¸šåŠ¡é€»è¾‘ã€ORM æŸ¥è¯¢ã€æ•°æ®è½¬æ¢å·¥å…·å‡½æ•°ä¸­ã€‚\nâœ… ä¸€ã€å•å€¼æŸ¥è¯¢ï¼ˆSingle Valueï¼‰ åœºæ™¯ æŸ¥è¯¢æ€»æ•° æŸ¥è¯¢æœ€å¤§å€¼/æœ€å°å€¼/å¹³å‡å€¼ æŸ¥è¯¢æŸä¸ªå­—æ®µæ˜¯å¦å­˜åœ¨ è·å–æŸä¸ª ID æ˜¯å¦å­˜åœ¨ SQL ç¤ºä¾‹ SELECT COUNT(*) FROM users; SELECT MAX(age) FROM users; SELECT EXISTS(SELECT 1 FROM users WHERE id=1); PostgreSQL è¿”å›å½¢æ€ ç±»å‹ ç¤ºä¾‹ å•ä¸ªæ•°å€¼ï¼ˆint/bigint/numericï¼‰ 123 å¸ƒå°”å€¼ true/false å•ä¸ªå­—ç¬¦ä¸² \u0026lsquo;hello\u0026rsquo; Python å¯¹åº”æ ¼å¼ Python ç±»å‹ ç¤ºä¾‹ int 123 float 12.34 str \u0026ldquo;hello\u0026rdquo; bool True/False SQLAlchemy æŸ¥è¯¢ count = session.execute(stmt).scalar_one() âœ… äºŒã€å•è¡ŒæŸ¥è¯¢ï¼ˆSingle Rowï¼‰ åœºæ™¯ æŸ¥è¯¢å•ä¸ªç”¨æˆ· æŸ¥è¯¢è¯¦æƒ…é¡µæ•°æ® æŸ¥è¯¢æœ€æ–°ä¸€æ¡è®°å½• SQL ç¤ºä¾‹ SELECT id, name, age FROM users WHERE id = 1; PostgreSQL è¿”å›å½¢æ€ ç±»ä¼¼ï¼š\n(1, \u0026#39;Alice\u0026#39;, 20) Python å¯¹åº”æ ¼å¼ Python ç±»å‹ ç¤ºä¾‹ tuple (1, \u0026ldquo;Alice\u0026rdquo;, 20) ORM å¯¹è±¡ User(id=1, name=\u0026ldquo;Alice\u0026rdquo;) dictï¼ˆè½¬æ¢åï¼‰ {\u0026lsquo;id\u0026rsquo;:1, \u0026rsquo;name\u0026rsquo;:\u0026lsquo;Alice\u0026rsquo;, \u0026lsquo;age\u0026rsquo;:20} SQLAlchemy æŸ¥è¯¢ obj = session.execute(stmt).scalar_one() âœ… ä¸‰ã€å•åˆ—å¤šè¡Œï¼ˆSingle Column, Multiple Rowsï¼‰ åœºæ™¯ æŸ¥è¯¢æ‰€æœ‰ code æŸ¥è¯¢è‚¡ç¥¨åç§°åˆ—è¡¨ æŸ¥è¯¢æŸè¡¨æ‰€æœ‰ä¸»é”® æŸ¥è¯¢ä¸€ç»„æ•°å€¼ç”¨äº IN æŸ¥è¯¢ SQL ç¤ºä¾‹ SELECT code FROM ashare; PostgreSQL è¿”å›å½¢æ€ [\u0026#39;000001\u0026#39;, \u0026#39;000002\u0026#39;, \u0026#39;000003\u0026#39;] Python å¯¹åº”æ ¼å¼ Python ç±»å‹ ç¤ºä¾‹ list[str] [\u0026quot;000001\u0026quot;, \u0026quot;000002\u0026quot;] list[int] [1, 2, 3] SQLAlchemy æŸ¥è¯¢ codes = session.execute(stmt).scalars().all() âœ… å››ã€å¤šè¡Œå¤šåˆ—ï¼ˆRows -\u0026gt; Table Dataï¼‰ åœºæ™¯ åˆ—è¡¨é¡µ åˆ†é¡µæ•°æ® ä»»æ„ JOIN æŠ¥è¡¨æ•°æ® ç”¨æˆ·åˆ—è¡¨ã€è‚¡ç¥¨åˆ—è¡¨ç­‰ SQL ç¤ºä¾‹ SELECT code, name, price FROM ashare ORDER BY code LIMIT 10; PostgreSQL è¿”å›å½¢æ€ [(\u0026#39;000001\u0026#39;, \u0026#39;å¹³å®‰é“¶è¡Œ\u0026#39;, 10.5), (\u0026#39;000002\u0026#39;, \u0026#39;ä¸‡ç§‘A\u0026#39;, 13.2)] Python å¯¹åº”æ ¼å¼ Python æ ¼å¼ ç¤ºä¾‹ list[tuple] [(\u0026quot;000001\u0026quot;,\u0026quot;å¹³å®‰é“¶è¡Œ\u0026quot;,10.5)] list[ORM å¯¹è±¡] [Ashare(...), Ashare(...)] list[dict]ï¼ˆä½ é¡¹ç›®å¸¸ç”¨ï¼‰ [{\u0026quot;code\u0026quot;:\u0026quot;000001\u0026quot;, \u0026quot;name\u0026quot;:\u0026quot;å¹³å®‰é“¶è¡Œ\u0026quot;}] SQLAlchemy æŸ¥è¯¢ rows = session.execute( select(Ashare.code, Ashare.name, Ashare.price) ).all() # list of tuples è‹¥ä½¿ç”¨ ORM æ¨¡å¼ï¼š\nobjs = session.execute(select(Ashare)).scalars().all() âœ… äº”ã€èšåˆå½¢æ€ï¼ˆAggregateï¼‰ åœºæ™¯ èšåˆç»Ÿè®¡ åˆ†ç»„ç»Ÿè®¡ï¼ˆgroup byï¼‰ ä¸šåŠ¡æŠ¥è¡¨ æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾æ•°æ®æº SQL ç¤ºä¾‹ SELECT plate, COUNT(*) FROM ashare GROUP BY plate; PostgreSQL è¿”å›å½¢æ€ [(\u0026#39;é“¶è¡Œ\u0026#39;, 32), (\u0026#39;ç§‘æŠ€\u0026#39;, 20)] Python æ ¼å¼ list[tuple]\nè½¬ dictï¼š\n{\u0026#34;é“¶è¡Œ\u0026#34;: 32, \u0026#34;ç§‘æŠ€\u0026#34;: 20} âœ… å…­ã€JSON æŸ¥è¯¢ï¼ˆJSON / JSONBï¼‰ åœºæ™¯ jsonb å­—æ®µå­˜å‚¨ åŠ¨æ€å±æ€§ èšåˆç”Ÿæˆ JSON å¯¹è±¡ SQL ç¤ºä¾‹ SELECT json_build_object(\u0026#39;code\u0026#39;, code, \u0026#39;name\u0026#39;, name) FROM ashare LIMIT 1; PostgreSQL è¿”å›å½¢æ€ {\u0026#34;code\u0026#34;:\u0026#34;000001\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;å¹³å®‰é“¶è¡Œ\u0026#34;} Python å¯¹åº”æ ¼å¼ Python ç±»å‹ ç¤ºä¾‹ dict {\u0026quot;code\u0026quot;: \u0026quot;000001\u0026quot;, \u0026quot;name\u0026quot;: \u0026quot;å¹³å®‰é“¶è¡Œ\u0026quot;} list[dict] [{}, {}] âœ… ä¸ƒã€æ•°ç»„æŸ¥è¯¢ï¼ˆArrayï¼‰ åœºæ™¯ è‚¡ç¥¨æ ‡ç­¾ ç”¨æˆ·è§’è‰²åˆ—è¡¨ æ–‡ç« æ ‡ç­¾ ANY/ALL æŸ¥è¯¢ SQL ç¤ºä¾‹ SELECT tags FROM articles; PostgreSQL è¿”å› {\u0026#34;ç§‘æŠ€\u0026#34;,\u0026#34;AI\u0026#34;,\u0026#34;å¤§æ¨¡å‹\u0026#34;} Python å¯¹åº” [\u0026#34;ç§‘æŠ€\u0026#34;, \u0026#34;AI\u0026#34;, \u0026#34;å¤§æ¨¡å‹\u0026#34;] âœ… å…«ã€å­æŸ¥è¯¢ä¸åµŒå¥—ç»“æ„ï¼ˆSubquery / Nestedï¼‰ åœºæ™¯ å¤æ‚ç­›é€‰ Top1 å­æŸ¥è¯¢ åˆ†ç»„åå–æœ€æ–°è®°å½• SQL ç¤ºä¾‹ SELECT * FROM stock s WHERE s.id = ( SELECT id FROM stock ORDER BY date DESC LIMIT 1 ); Python å¯¹åº”æ ¼å¼ ORM å¯¹è±¡æˆ– tupleã€‚\nâœ… ä¹ã€JOIN æŸ¥è¯¢ï¼ˆè·¨è¡¨ã€å¤šè¡¨ï¼‰ åœºæ™¯ ç”¨æˆ·ä¸è§’è‰² è‚¡ç¥¨ä¸æ¦‚å¿µæ¿å— æ•°æ®å…³è”æŸ¥è¯¢ å¤šè¡¨æŠ¥è¡¨ SQL ç¤ºä¾‹ SELECT u.id, u.name, r.role FROM users u JOIN roles r ON u.role_id = r.id; Python å¯¹åº”æ ¼å¼ æ ¼å¼ ç¤ºä¾‹ tuple (1, \u0026quot;å¼ ä¸‰\u0026quot;, \u0026quot;admin\u0026quot;) dictï¼ˆè½¬æ¢åï¼‰ {\u0026quot;id\u0026quot;:1,\u0026quot;name\u0026quot;:\u0026quot;å¼ ä¸‰\u0026quot;,\u0026quot;role\u0026quot;:\u0026quot;admin\u0026quot;} âœ… åã€åˆ†é¡µæŸ¥è¯¢ï¼ˆPaginationï¼‰ SQL ç¤ºä¾‹ SELECT id, name FROM users ORDER BY id LIMIT 10 OFFSET 20; Python ç»“æœ list[dict] | list[tuple] | list[ORM] ğŸ§© æœ€ç»ˆæ€»ç»“ï¼šå¸¸ç”¨ SQL æŸ¥è¯¢å½¢æ€ -\u0026gt; Python æ•°æ®ç±»å‹æ€»è§ˆ åœºæ™¯ SQL ç»“æœ Python å½¢å¼ å•å€¼ 5 int/str/float/bool å•è¡Œ (1, \u0026quot;A\u0026quot;) tuple / dict / ORM å•åˆ— ['a','b'] list[str] å¤šè¡Œå¤šåˆ— [(...),(...)] list[tuple] / list[dict] / ORM èšåˆç»Ÿè®¡ [(key, val)] list[tuple] / dict JSON {\u0026quot;a\u0026quot;:1} dict æ•°ç»„ {1,2,3} list JOIN [(...)] list[tuple] / list[dict] åˆ†é¡µ [(...)] list[...] ","description":"ä¸‹é¢ç»™ä½ ä¸€ä¸ªé«˜ä»·å€¼å¯é•¿æœŸå¤ç”¨çš„æ€»ç»“ï¼š\nå¸¸ç”¨çš„æ•°æ®æŸ¥è¯¢åœºæ™¯ -\u0026gt; SQL æŸ¥è¯¢å½¢æ€ -\u0026gt; æŸ¥è¯¢ç»“æœçš„æ•°æ®ç»“æ„ -\u0026gt; Python ä¸­çš„å¯¹åº”æ•°æ®æ ¼å¼ã€‚\nè¿™æ˜¯ä¸€ä¸ªå®Œå…¨è´´è¿‘ä½ åœ¨ FastAPI + SQLAlchemy + PostgreSQL é¡¹ç›®ä¸­ä½¿ç”¨çš„â€œå®æˆ˜é€ŸæŸ¥è¡¨â€ï¼Œå¯ä»¥ç›´æ¥ç”¨åœ¨ä½ çš„ä¸šåŠ¡é€»è¾‘ã€ORM æŸ¥è¯¢ã€æ•°æ®è½¬æ¢å·¥å…·å‡½æ•°ä¸­ã€‚\nâœ… ä¸€ã€å•å€¼æŸ¥è¯¢ï¼ˆSingle Valueï¼‰ åœºæ™¯ æŸ¥è¯¢æ€»æ•° æŸ¥è¯¢æœ€å¤§å€¼/æœ€å°å€¼/å¹³å‡å€¼ æŸ¥è¯¢æŸä¸ªå­—æ®µæ˜¯å¦å­˜åœ¨ è·å–æŸä¸ª ID æ˜¯å¦å­˜åœ¨ SQL ç¤ºä¾‹ SELECT COUNT(*) FROM users; SELECT MAX(age) FROM users; SELECT EXISTS(SELECT 1 FROM users WHERE id=1); PostgreSQL è¿”å›å½¢æ€ ç±»å‹ ç¤ºä¾‹ å•ä¸ªæ•°å€¼ï¼ˆint/bigint/numericï¼‰ 123 å¸ƒå°”å€¼ true/false å•ä¸ªå­—ç¬¦ä¸² \u0026lsquo;hello\u0026rsquo; Python å¯¹åº”æ ¼å¼ Python ç±»å‹ ç¤ºä¾‹ int 123 float 12.34 str \u0026ldquo;hello\u0026rdquo; bool True/False SQLAlchemy æŸ¥è¯¢ count = session.execute(stmt).scalar_one() âœ… äºŒã€å•è¡ŒæŸ¥è¯¢ï¼ˆSingle Rowï¼‰ åœºæ™¯ æŸ¥è¯¢å•ä¸ªç”¨æˆ· æŸ¥è¯¢è¯¦æƒ…é¡µæ•°æ® æŸ¥è¯¢æœ€æ–°ä¸€æ¡è®°å½• SQL ç¤ºä¾‹ SELECT id, name, age FROM users WHERE id = 1; PostgreSQL è¿”å›å½¢æ€ ç±»ä¼¼ï¼š\n"},{"id":486,"href":"/backend/summarize/data-types/","title":"æ•°æ®ç±»å‹","parent":"Summarize","content":" JavaScript å’Œ Python æ˜¯å¼±ç±»å‹è¯­è¨€ Go æ˜¯å¼ºç±»å‹è¯­è¨€ JavaScript:\nvar a = 123 Object.prototype.toString.call(a); // \u0026#39;[object Number]\u0026#39; var a = \u0026#39;abc\u0026#39; Object.prototype.toString.call(a); // \u0026#39;[object String]\u0026#39; Python:\na = 123 print(a, type(a)) # 123 \u0026lt;class \u0026#39;int\u0026#39;\u0026gt; a = \u0026#39;abc\u0026#39; print(a, type(a)) # abc \u0026lt;class \u0026#39;str\u0026#39;\u0026gt; Go:\npackage main import \u0026#34;fmt\u0026#34; func main() { a := 123 a = \u0026#34;abc\u0026#34; fmt.Printf(\u0026#34;%v %T\\n\u0026#34;, a, a) } è¾“å‡ºç»“æœ\n# command-line-arguments ./1.go:7:9: cannot use \u0026#34;abc\u0026#34; (type string) as type int in assignment å‚è€ƒæ–‡æ¡£:\nGo by Example: String Formatting ","description":" JavaScript å’Œ Python æ˜¯å¼±ç±»å‹è¯­è¨€ Go æ˜¯å¼ºç±»å‹è¯­è¨€ JavaScript:\nvar a = 123 Object.prototype.toString.call(a); // \u0026#39;[object Number]\u0026#39; var a = \u0026#39;abc\u0026#39; Object.prototype.toString.call(a); // \u0026#39;[object String]\u0026#39; Python:\na = 123 print(a, type(a)) # 123 \u0026lt;class \u0026#39;int\u0026#39;\u0026gt; a = \u0026#39;abc\u0026#39; print(a, type(a)) # abc \u0026lt;class \u0026#39;str\u0026#39;\u0026gt; Go:\npackage main import \u0026#34;fmt\u0026#34; func main() { a := 123 a = \u0026#34;abc\u0026#34; fmt.Printf(\u0026#34;%v %T\\n\u0026#34;, a, a) } è¾“å‡ºç»“æœ\n# command-line-arguments ./1.go:7:9: cannot use \u0026#34;abc\u0026#34; (type string) as type int in assignment å‚è€ƒæ–‡æ¡£:\n"},{"id":487,"href":"/operations/linux/log-cleanup/","title":"æ—¥å¿—æ¸…ç†","parent":"Linux","content":"æœ¬æ–‡æ‰€æœ‰çš„è„šæœ¬ä¿å­˜åœ¨ /data/septvean/bash/log-cleanup ç›®å½•\næ‰§è¡Œ deploy.sh è„šæœ¬éƒ¨ç½²è„šæœ¬ã€‚\nä¸€ã€è®¾è®¡åŸåˆ™ï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰ âœ… åªæ¸…ç†æ—¥å¿—ï¼Œä¸ç ´åç›®å½•ç»“æ„ âœ… truncate ä¼˜å…ˆäº rmï¼ˆç³»ç»ŸæœåŠ¡æ›´å®‰å…¨ï¼‰ âœ… journalctl ç”¨å®˜æ–¹ vacuum âœ… å¯æ‰©å±•å…¶å®ƒæ—¥å¿— âœ… é€‚åˆæ¯å‘¨æ‰§è¡Œä¸€æ¬¡ äºŒã€æ—¥å¿—æ¸…ç†è„šæœ¬ï¼ˆæ¨èç‰ˆæœ¬ï¼‰ ğŸ“„ /usr/sbin/log-cleanup.sh\n#!/bin/bash set -euo pipefail # ------------------------ # åŸºæœ¬å˜é‡ # ------------------------ LOG_DATE=\u0026#34;$(date \u0026#39;+%F %T\u0026#39;)\u0026#34; LOG_FILE=\u0026#34;/var/log/log-cleanup.log\u0026#34; echo \u0026#34;[$LOG_DATE] log cleanup start\u0026#34; \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; # ------------------------ # 1. æ¸…ç† dnf æ—¥å¿— # ------------------------ rm -fv /var/log/dnf.* \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 || true # ------------------------ # 2. truncate ç³»ç»Ÿæ—¥å¿—ï¼ˆä¸åˆ é™¤æ–‡ä»¶ï¼‰ # ------------------------ : \u0026gt;/var/log/cron : \u0026gt;/var/log/messages # å¯é€‰æ‰©å±• : \u0026gt;/var/log/secure || true : \u0026gt;/var/log/maillog || true : \u0026gt;/var/log/spooler || true # ------------------------ # 3. systemd journal æ¸…ç†ï¼ˆä¿ç•™ 1 å‘¨ï¼‰ # ------------------------ journalctl --vacuum-time=1w \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 # ------------------------ # 4. æ‰©å±•ï¼šæ¸…ç†è¿‡æœŸ .gz / .old æ—¥å¿—ï¼ˆä¿ç•™ 7 å¤©ï¼‰ # ------------------------ find /var/log -type f \\ \\( -name \u0026#34;*.gz\u0026#34; -o -name \u0026#34;*.old\u0026#34; -o -name \u0026#34;*.log.*\u0026#34; \\) \\ -mtime +7 -print -delete \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 # ------------------------ # ç»“æŸ # ------------------------ echo \u0026#34;[$(date \u0026#39;+%F %T\u0026#39;)] log cleanup done\u0026#34; \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; ä¸‰ã€è„šæœ¬è¯´æ˜ï¼ˆå…³é”®ç‚¹ï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆç”¨ : \u0026gt; file : \u0026gt;/var/log/messages ä¸åˆ é™¤ inode systemd / rsyslog ä¸ä¼šå´© è¿™æ˜¯ ç”Ÿäº§ç¯å¢ƒæ ‡å‡†åšæ³• 2ï¸âƒ£ ä¸ºä»€ä¹ˆ dnf ç”¨ rm rm -fv /var/log/dnf.* dnf ä¸ä¾èµ–é•¿æœŸæ—¥å¿— åˆ é™¤æ¯” truncate æ›´å¹²å‡€ 3ï¸âƒ£ journalctl æ­£ç¡®å§¿åŠ¿ journalctl --vacuum-time=1w å®˜æ–¹æ”¯æŒ ä¸è¦æ‰‹åŠ¨ rm /var/log/journal 4ï¸âƒ£ æ‰©å±•æ—¥å¿—æ¸…ç†è§„åˆ™ï¼ˆå®‰å…¨ï¼‰ *.gz *.old *.log.1 *.log.2 åªæ¸…ç† è½®è½¬åçš„å†å²æ—¥å¿—\nå››ã€æƒé™è®¾ç½® chmod +x /usr/sbin/log-cleanup.sh chown root:root /usr/sbin/log-cleanup.sh äº”ã€æ¯å‘¨æ‰§è¡Œä¸€æ¬¡ï¼ˆä¸¤ç§æ–¹å¼ï¼‰ âœ… æ–¹å¼ä¸€ï¼šcronï¼ˆæœ€é€šç”¨ï¼‰ crontab -e æ·»åŠ ï¼š\n0 3 * * 0 /usr/sbin/log-cleanup.sh å«ä¹‰ï¼š\næ¯å‘¨æ—¥ å‡Œæ™¨ 03:00 root æ‰§è¡Œ âœ… æ–¹å¼äºŒï¼šsystemd timerï¼ˆæ›´ç°ä»£ï¼Œæ¨èï¼‰ 1ï¸âƒ£ service ğŸ“„ /etc/systemd/system/log-cleanup.service\n[Unit] Description=Weekly Log Cleanup [Service] Type=oneshot ExecStart=/usr/sbin/log-cleanup.sh 2ï¸âƒ£ timer ğŸ“„ /etc/systemd/system/log-cleanup.timer\n[Unit] Description=Run log cleanup weekly [Timer] OnCalendar=weekly Persistent=true [Install] WantedBy=timers.target å¯ç”¨ï¼š\nsystemctl daemon-reload systemctl enable --now log-cleanup.timer å…­ã€å¯é€‰å¢å¼º ğŸ”¹ é™åˆ¶ journal æœ€å¤§ç©ºé—´ï¼ˆåŒä¿é™©ï¼‰ journalctl --vacuum-size=500M æˆ–é…ç½®ï¼š\n# /etc/systemd/journald.conf SystemMaxUse=500M ğŸ”¹ Dry-run æ¨¡å¼ï¼ˆæµ‹è¯•ç”¨ï¼‰ find ... -print ä¸ƒã€æ€»ç»“ é€‚åˆ AlmaLinux 9 ç”Ÿäº§ç¯å¢ƒ ä¸ä¼šç ´å systemd / rsyslog å¯æ‰©å±•ã€å¯å®¡è®¡ã€æœ‰æ—¥å¿— cron / timer éƒ½æ”¯æŒ ","description":"æœ¬æ–‡æ‰€æœ‰çš„è„šæœ¬ä¿å­˜åœ¨ /data/septvean/bash/log-cleanup ç›®å½•\næ‰§è¡Œ deploy.sh è„šæœ¬éƒ¨ç½²è„šæœ¬ã€‚\nä¸€ã€è®¾è®¡åŸåˆ™ï¼ˆå…ˆè¯´æ¸…æ¥šï¼‰ âœ… åªæ¸…ç†æ—¥å¿—ï¼Œä¸ç ´åç›®å½•ç»“æ„ âœ… truncate ä¼˜å…ˆäº rmï¼ˆç³»ç»ŸæœåŠ¡æ›´å®‰å…¨ï¼‰ âœ… journalctl ç”¨å®˜æ–¹ vacuum âœ… å¯æ‰©å±•å…¶å®ƒæ—¥å¿— âœ… é€‚åˆæ¯å‘¨æ‰§è¡Œä¸€æ¬¡ äºŒã€æ—¥å¿—æ¸…ç†è„šæœ¬ï¼ˆæ¨èç‰ˆæœ¬ï¼‰ ğŸ“„ /usr/sbin/log-cleanup.sh\n#!/bin/bash set -euo pipefail # ------------------------ # åŸºæœ¬å˜é‡ # ------------------------ LOG_DATE=\u0026#34;$(date \u0026#39;+%F %T\u0026#39;)\u0026#34; LOG_FILE=\u0026#34;/var/log/log-cleanup.log\u0026#34; echo \u0026#34;[$LOG_DATE] log cleanup start\u0026#34; \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; # ------------------------ # 1. æ¸…ç† dnf æ—¥å¿— # ------------------------ rm -fv /var/log/dnf.* \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 || true # ------------------------ # 2. truncate ç³»ç»Ÿæ—¥å¿—ï¼ˆä¸åˆ é™¤æ–‡ä»¶ï¼‰ # ------------------------ : \u0026gt;/var/log/cron : \u0026gt;/var/log/messages # å¯é€‰æ‰©å±• : \u0026gt;/var/log/secure || true : \u0026gt;/var/log/maillog || true : \u0026gt;/var/log/spooler || true # ------------------------ # 3. systemd journal æ¸…ç†ï¼ˆä¿ç•™ 1 å‘¨ï¼‰ # ------------------------ journalctl --vacuum-time=1w \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 # ------------------------ # 4. æ‰©å±•ï¼šæ¸…ç†è¿‡æœŸ .gz / .old æ—¥å¿—ï¼ˆä¿ç•™ 7 å¤©ï¼‰ # ------------------------ find /var/log -type f \\ \\( -name \u0026#34;*.gz\u0026#34; -o -name \u0026#34;*.old\u0026#34; -o -name \u0026#34;*.log.*\u0026#34; \\) \\ -mtime +7 -print -delete \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; 2\u0026gt;\u0026amp;1 # ------------------------ # ç»“æŸ # ------------------------ echo \u0026#34;[$(date \u0026#39;+%F %T\u0026#39;)] log cleanup done\u0026#34; \u0026gt;\u0026gt;\u0026#34;$LOG_FILE\u0026#34; ä¸‰ã€è„šæœ¬è¯´æ˜ï¼ˆå…³é”®ç‚¹ï¼‰ 1ï¸âƒ£ ä¸ºä»€ä¹ˆç”¨ : \u0026gt; file : \u0026gt;/var/log/messages ä¸åˆ é™¤ inode systemd / rsyslog ä¸ä¼šå´© è¿™æ˜¯ ç”Ÿäº§ç¯å¢ƒæ ‡å‡†åšæ³• 2ï¸âƒ£ ä¸ºä»€ä¹ˆ dnf ç”¨ rm rm -fv /var/log/dnf.* dnf ä¸ä¾èµ–é•¿æœŸæ—¥å¿— åˆ é™¤æ¯” truncate æ›´å¹²å‡€ 3ï¸âƒ£ journalctl æ­£ç¡®å§¿åŠ¿ journalctl --vacuum-time=1w å®˜æ–¹æ”¯æŒ ä¸è¦æ‰‹åŠ¨ rm /var/log/journal 4ï¸âƒ£ æ‰©å±•æ—¥å¿—æ¸…ç†è§„åˆ™ï¼ˆå®‰å…¨ï¼‰ *.gz *.old *.log.1 *.log.2 åªæ¸…ç† è½®è½¬åçš„å†å²æ—¥å¿—\n"},{"id":488,"href":"/management/beyond/time-management/","title":"æ—¶é—´ç®¡ç†","parent":"Beyond","content":"æ—¶é—´ç®¡ç†æ˜¯é€šè¿‡è§„åˆ’å’Œè¿ç”¨æŠ€å·§ï¼Œä»¥æé«˜æ•ˆç‡ã€å®ç°ç›®æ ‡çš„ä¸€ç§ç®¡ç†æ–¹æ³•ã€‚å…¶æ ¸å¿ƒåœ¨äºå¹³è¡¡è®¡åˆ’ä¸çµæ´»æ€§ï¼Œæ–¹æ³•åŒ…æ‹¬è®¾å®šç›®æ ‡ã€åŒºåˆ†ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼ˆå¦‚å››è±¡é™æ³•ï¼‰ã€åˆ†è§£å¤§é¡¹ç›®ã€æ¶ˆé™¤å¹²æ‰°ï¼ˆå¦‚æ‰‹æœºå‹¿æ‰°æ¨¡å¼ï¼‰ï¼Œå¹¶ç»“åˆä¼‘æ¯å’Œåæ€ã€‚\næ ¸å¿ƒåŸåˆ™ä¸æ„ä¹‰ æå‡æ•ˆç‡ï¼š åˆç†åˆ†é…æ—¶é—´ï¼Œä¼˜å…ˆå¤„ç†é‡è¦å’Œç´§æ€¥çš„ä»»åŠ¡ï¼Œå¯ä»¥é¿å…ä»»åŠ¡å †ç§¯ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚ æé«˜ä¸“æ³¨åŠ›ï¼š é€šè¿‡è®¾å®šè®¡åˆ’å’Œå‡å°‘å¹²æ‰°ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨å·¥ä½œä¸­é›†ä¸­æ³¨æ„åŠ›ï¼Œæé«˜å·¥ä½œè´¨é‡ã€‚ å‡å°‘å‹åŠ›ï¼š åˆç†å®‰æ’æ—¶é—´ï¼Œå¯ä»¥å‡å°‘å·¥ä½œå‹åŠ›å’Œç„¦è™‘ï¼Œä¿æŒèº«å¿ƒå¥åº·ã€‚ åŸ¹å…»ä¹ æƒ¯ï¼š è‰¯å¥½çš„æ—¶é—´ç®¡ç†ä¹ æƒ¯æœ‰åŠ©äºå½¢æˆæ›´è§„å¾‹å’Œæœ‰æ•ˆçš„å·¥ä½œæ–¹å¼ã€‚ å®æ“æ–¹æ³• è®¾å®šç›®æ ‡ä¸ä¼˜å…ˆçº§ï¼š\nè®¾å®šæ˜ç¡®ã€å¯å®ç°çš„ç›®æ ‡ï¼Œå¹¶æ ¹æ®é‡è¦æ€§å’Œç´§æ€¥æ€§å¯¹ä»»åŠ¡è¿›è¡Œä¼˜å…ˆæ’åºï¼Œä¾‹å¦‚ä½¿ç”¨â€œå››è±¡é™æ—¶é—´ç®¡ç†æ³•â€ã€‚ å°†é‡è¦ä½†ä¸ç´§æ€¥çš„ä»»åŠ¡ï¼ˆç¬¬äºŒè±¡é™ï¼‰ä½œä¸ºé‡ç‚¹ï¼Œä»¥å‡å°‘æœªæ¥ç´§æ€¥äº‹åŠ¡çš„å‘ç”Ÿã€‚ è§„åˆ’ä¸åˆ†è§£ï¼š\nä½¿ç”¨æ¯æ—¥è®¡åˆ’æ¨¡æ¿ï¼Œæˆ–å°†å¤§å‹é¡¹ç›®åˆ†è§£æˆæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„ä»»åŠ¡ã€‚ é¢„ä¼°æ¯é¡¹ä»»åŠ¡æ‰€éœ€çš„æ—¶é—´ã€‚ æ¶ˆé™¤å¹²æ‰°ï¼š\nå°†æ‰‹æœºè°ƒè‡³é™éŸ³æˆ–å‹¿æ‰°æ¨¡å¼ï¼Œå…³é—­ä¸å¿…è¦çš„é€šçŸ¥ã€‚ é€‰æ‹©ä¸€ä¸ªå®‰é™çš„å·¥ä½œç¯å¢ƒï¼Œå¹¶å‘ŠçŸ¥ä»–äººå‹¿æ‰°ã€‚ å½“è¿›è¡Œä¸€é¡¹ä»»åŠ¡æ—¶ï¼Œé¿å…æ¼«æ— ç›®çš„åœ°æµè§ˆç½‘é¡µæˆ–ç¤¾äº¤åª’ä½“ã€‚ èŠ‚å¥ä¸ä¼‘æ¯ï¼š\næ³¨æ„èº«ä½“çš„èƒ½é‡é«˜å³°å’Œä½è°·ï¼Œé€‚æ—¶ä¼‘æ¯å’Œæ”¾æ¾ã€‚ ä½¿ç”¨ç•ªèŒ„é’Ÿç­‰å·¥å…·ï¼Œå°†å·¥ä½œå’Œä¼‘æ¯æ—¶é—´æ˜ç¡®åˆ†éš”å¼€ã€‚ è‡ªæˆ‘åæ€ï¼š\nå®šæœŸå®¡è§†è‡ªå·±çš„æ—¶é—´ä½¿ç”¨æƒ…å†µï¼Œäº†è§£æ—¶é—´æµªè´¹åœ¨å“ªé‡Œã€‚ å°†ç®¡ç†æ—¶é—´è§†ä¸ºç®¡ç†è‡ªå·±ç”Ÿæ´»å’Œæƒ…ç»ªçš„ä¸€éƒ¨åˆ†ã€‚ ","description":"æ—¶é—´ç®¡ç†æ˜¯é€šè¿‡è§„åˆ’å’Œè¿ç”¨æŠ€å·§ï¼Œä»¥æé«˜æ•ˆç‡ã€å®ç°ç›®æ ‡çš„ä¸€ç§ç®¡ç†æ–¹æ³•ã€‚å…¶æ ¸å¿ƒåœ¨äºå¹³è¡¡è®¡åˆ’ä¸çµæ´»æ€§ï¼Œæ–¹æ³•åŒ…æ‹¬è®¾å®šç›®æ ‡ã€åŒºåˆ†ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼ˆå¦‚å››è±¡é™æ³•ï¼‰ã€åˆ†è§£å¤§é¡¹ç›®ã€æ¶ˆé™¤å¹²æ‰°ï¼ˆå¦‚æ‰‹æœºå‹¿æ‰°æ¨¡å¼ï¼‰ï¼Œå¹¶ç»“åˆä¼‘æ¯å’Œåæ€ã€‚\næ ¸å¿ƒåŸåˆ™ä¸æ„ä¹‰ æå‡æ•ˆç‡ï¼š åˆç†åˆ†é…æ—¶é—´ï¼Œä¼˜å…ˆå¤„ç†é‡è¦å’Œç´§æ€¥çš„ä»»åŠ¡ï¼Œå¯ä»¥é¿å…ä»»åŠ¡å †ç§¯ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚ æé«˜ä¸“æ³¨åŠ›ï¼š é€šè¿‡è®¾å®šè®¡åˆ’å’Œå‡å°‘å¹²æ‰°ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨å·¥ä½œä¸­é›†ä¸­æ³¨æ„åŠ›ï¼Œæé«˜å·¥ä½œè´¨é‡ã€‚ å‡å°‘å‹åŠ›ï¼š åˆç†å®‰æ’æ—¶é—´ï¼Œå¯ä»¥å‡å°‘å·¥ä½œå‹åŠ›å’Œç„¦è™‘ï¼Œä¿æŒèº«å¿ƒå¥åº·ã€‚ åŸ¹å…»ä¹ æƒ¯ï¼š è‰¯å¥½çš„æ—¶é—´ç®¡ç†ä¹ æƒ¯æœ‰åŠ©äºå½¢æˆæ›´è§„å¾‹å’Œæœ‰æ•ˆçš„å·¥ä½œæ–¹å¼ã€‚ å®æ“æ–¹æ³• è®¾å®šç›®æ ‡ä¸ä¼˜å…ˆçº§ï¼š\nè®¾å®šæ˜ç¡®ã€å¯å®ç°çš„ç›®æ ‡ï¼Œå¹¶æ ¹æ®é‡è¦æ€§å’Œç´§æ€¥æ€§å¯¹ä»»åŠ¡è¿›è¡Œä¼˜å…ˆæ’åºï¼Œä¾‹å¦‚ä½¿ç”¨â€œå››è±¡é™æ—¶é—´ç®¡ç†æ³•â€ã€‚ å°†é‡è¦ä½†ä¸ç´§æ€¥çš„ä»»åŠ¡ï¼ˆç¬¬äºŒè±¡é™ï¼‰ä½œä¸ºé‡ç‚¹ï¼Œä»¥å‡å°‘æœªæ¥ç´§æ€¥äº‹åŠ¡çš„å‘ç”Ÿã€‚ è§„åˆ’ä¸åˆ†è§£ï¼š\nä½¿ç”¨æ¯æ—¥è®¡åˆ’æ¨¡æ¿ï¼Œæˆ–å°†å¤§å‹é¡¹ç›®åˆ†è§£æˆæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„ä»»åŠ¡ã€‚ é¢„ä¼°æ¯é¡¹ä»»åŠ¡æ‰€éœ€çš„æ—¶é—´ã€‚ æ¶ˆé™¤å¹²æ‰°ï¼š\nå°†æ‰‹æœºè°ƒè‡³é™éŸ³æˆ–å‹¿æ‰°æ¨¡å¼ï¼Œå…³é—­ä¸å¿…è¦çš„é€šçŸ¥ã€‚ é€‰æ‹©ä¸€ä¸ªå®‰é™çš„å·¥ä½œç¯å¢ƒï¼Œå¹¶å‘ŠçŸ¥ä»–äººå‹¿æ‰°ã€‚ å½“è¿›è¡Œä¸€é¡¹ä»»åŠ¡æ—¶ï¼Œé¿å…æ¼«æ— ç›®çš„åœ°æµè§ˆç½‘é¡µæˆ–ç¤¾äº¤åª’ä½“ã€‚ èŠ‚å¥ä¸ä¼‘æ¯ï¼š\næ³¨æ„èº«ä½“çš„èƒ½é‡é«˜å³°å’Œä½è°·ï¼Œé€‚æ—¶ä¼‘æ¯å’Œæ”¾æ¾ã€‚ ä½¿ç”¨ç•ªèŒ„é’Ÿç­‰å·¥å…·ï¼Œå°†å·¥ä½œå’Œä¼‘æ¯æ—¶é—´æ˜ç¡®åˆ†éš”å¼€ã€‚ è‡ªæˆ‘åæ€ï¼š\nå®šæœŸå®¡è§†è‡ªå·±çš„æ—¶é—´ä½¿ç”¨æƒ…å†µï¼Œäº†è§£æ—¶é—´æµªè´¹åœ¨å“ªé‡Œã€‚ å°†ç®¡ç†æ—¶é—´è§†ä¸ºç®¡ç†è‡ªå·±ç”Ÿæ´»å’Œæƒ…ç»ªçš„ä¸€éƒ¨åˆ†ã€‚ "},{"id":489,"href":"/backend/python/beautiful-soup/best-practices/","title":"æœ€ä½³å®è·µ","parent":"Beautiful Soup","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ Beautiful Soup æœ€ä½³å®è·µï¼ˆä¸“ä¸šçº§ï¼‰ï¼Œæ¶µç›–ï¼šåˆå§‹åŒ–ã€æŸ¥è¯¢æ¨¡å¼ã€æ€§èƒ½ä¼˜åŒ–ã€å¥å£®æ€§ã€åçˆ¬å¤„ç†ã€ç¼–ç ã€é”™è¯¯å¤„ç†ã€ä¸ requests/å¹¶å‘çš„é…åˆã€çœŸå®çˆ¬è™«åœºæ™¯ç­‰ã€‚\nå†…å®¹æ˜¯é«˜è´¨é‡ã€å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ æœ€ä½³å®è·µåˆé›†ã€‚\nâœ… 1. å§‹ç»ˆä½¿ç”¨ lxml ä½œä¸ºè§£æå™¨ lxml é€Ÿåº¦æœ€å¿«ã€å®¹é”™æœ€å¼ºï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ç”¨å®ƒã€‚\nsoup = BeautifulSoup(html, \u0026#34;lxml\u0026#34;) ä¸è¦ä½¿ç”¨é»˜è®¤çš„ html.parser â€”â€” å¤ªæ…¢ã€å®¹é”™å·®ã€‚\nâœ… 2. ç”¨ select / select_one æ›¿ä»£ find / find_all CSS é€‰æ‹©å™¨å¯è¯»æ€§æ›´å¼ºï¼Œæ›´çµæ´»ã€‚\ntitle = soup.select_one(\u0026#34;.post-title\u0026#34;).text.strip() items = soup.select(\u0026#34;ul.list \u0026gt; li\u0026#34;) âœ… 3. å¯¹æ‰€æœ‰ text ä½¿ç”¨ .strip() ç½‘é¡µä¸­å¾ˆå¤šæ–‡æœ¬æœ‰æ¢è¡Œã€ç©ºæ ¼ã€‚\ntext = element.get_text(strip=True) strip=True æ˜¯ BeautifulSoup æœ€ä½³æ–¹å¼ã€‚\nâœ… 4. å–å±æ€§ç”¨ .get()ï¼Œè€Œä¸æ˜¯ element[â€œhrefâ€] é¿å… KeyErrorï¼Œæé«˜å®¹é”™æ€§ã€‚\nlink = a.get(\u0026#34;href\u0026#34;) âœ… 5. å»é™¤æ— å…³æ ‡ç­¾ï¼ˆscript/styleï¼‰ å‡å°‘å™ªå£°ï¼Œä½¿è§£ææ›´å‡†ç¡®ã€‚\nfor tag in soup([\u0026#34;script\u0026#34;, \u0026#34;style\u0026#34;]): tag.decompose() âœ… 6. find / select æ—¶æ€»æ˜¯ä½¿ç”¨æ¡ä»¶é™åˆ¶ é¿å…åŒ¹é…åˆ°å¤ªå¤šä¸å¿…è¦çš„èŠ‚ç‚¹ã€‚\nsoup.select(\u0026#34;.item .title\u0026#34;) soup.find(\u0026#34;a\u0026#34;, class_=\u0026#34;download\u0026#34;) âœ… 7. ä¼˜å…ˆä½¿ç”¨ CSS ç±»é€‰æ‹©å™¨ æ›´å¿«æ›´å¹²å‡€ï¼š\nsoup.select(\u0026#34;.price\u0026#34;) é¿å…è¿™æ ·å†™ï¼š\nsoup.find_all(\u0026#34;span\u0026#34;, {\u0026#34;class\u0026#34;: \u0026#34;price\u0026#34;}) âœ… 8. ç”¨ list comprehension æé«˜æ•°æ®å¤„ç†æ•ˆç‡ items = [li.get_text(strip=True) for li in soup.select(\u0026#34;ul li\u0026#34;)] âœ… 9. è§£æè¡¨æ ¼æ—¶ç»Ÿä¸€å†™æ³• é¿å…æ‰‹å†™å¤æ‚é€»è¾‘ã€‚\nrows = [ [cell.get_text(strip=True) for cell in row.select(\u0026#34;td, th\u0026#34;)] for row in soup.select(\u0026#34;table tr\u0026#34;) ] âœ… 10. è§£æåˆ—è¡¨ä¸å­—å…¸ç»“æ„æ—¶ï¼Œç”¨ safe get [ { \u0026#34;title\u0026#34;: item.select_one(\u0026#34;.title\u0026#34;) and item.select_one(\u0026#34;.title\u0026#34;).text.strip(), \u0026#34;link\u0026#34;: item.select_one(\u0026#34;a\u0026#34;) and item.select_one(\u0026#34;a\u0026#34;).get(\u0026#34;href\u0026#34;), } for item in soup.select(\u0026#34;.item\u0026#34;) ] âš¡ 11. æ€§èƒ½ä¼˜åŒ–ï¼ˆé‡ç‚¹ï¼‰ é¿å…è¿‡åº¦ä½¿ç”¨ select(\u0026quot;*\u0026quot;)ã€select(\u0026ldquo;div\u0026rdquo;) ä¼šæ‰«ææ•´ä¸ª DOMï¼Œéå¸¸æ…¢ã€‚\nå°½é‡å‡å°‘ DOM æ“ä½œ æ¯”å¦‚ .decompose() å–ä»£ .extract()ã€‚\nä½¿ç”¨ soup.select(\u0026quot;\u0026hellip; \u0026gt; \u0026hellip; \u0026gt; \u0026hellip;\u0026quot;) å‡å°‘æœç´¢èŒƒå›´ã€‚\nğŸ” 12. å¿…è¦æ—¶ä½¿ç”¨æµè§ˆå™¨ headers ä¼ªè£… headers = { \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 ...\u0026#34; } requests.get(url, headers=headers) ğŸš« 13. é¿å…ä¸€æ¬¡æ€§å¤„ç†è¶…å¤§ html æ–‡æœ¬ å¦‚æœé¡µé¢è¶…è¿‡ 20MBï¼ˆè¶…å¤šç½‘é¡µåˆ—è¡¨ï¼‰ï¼Œåº”ï¼š\nåˆ†å—å¤„ç† åˆ†é¡µè·å– ç”¨ lxml.etree.iterparse()ï¼ˆäº‹ä»¶æµè§£æå™¨ï¼‰ ğŸ§µ 14. ä¸ Requests ç»“åˆä½¿ç”¨ï¼ˆç¨³å®šç‰ˆï¼‰ import requests from bs4 import BeautifulSoup def fetch(url): r = requests.get(url, timeout=10) r.raise_for_status() r.encoding = r.apparent_encoding return BeautifulSoup(r.text, \u0026#34;lxml\u0026#34;) é¿å…å¸¸è§é—®é¢˜ï¼š\næœªè®¾ç½® timeout -\u0026gt; å¡æ­» æœª raise_for_status -\u0026gt; è¯¯è§£æé”™è¯¯é¡µé¢ æœªå¤„ç†ç¼–ç  -\u0026gt; ä¹±ç  âš ï¸ 15. å¸¸è§é”™è¯¯å¤„ç† element = soup.select_one(â€¦) -\u0026gt; None å¿…é¡»åˆ¤æ–­ï¼š\ntitle_tag = soup.select_one(\u0026#34;.title\u0026#34;) title = title_tag.get_text(strip=True) if title_tag else None AttributeError é˜²æ­¢ title = (soup.select_one(\u0026#34;.title\u0026#34;) or {}).get(\u0026#34;href\u0026#34;) ğŸ§¬ 16. æŠ“å–é¢‘ç‡æ§åˆ¶ï¼ˆé¿å…å° IPï¼‰ import time time.sleep(1 + random.random()) # éšæœºå»¶æ—¶ çœŸå®çˆ¬è™«å¿…é¡»è¦åŠ ï¼\nğŸ§ª 17. æœç´¢æ–‡æœ¬æ—¶ä½¿ç”¨ lambda soup.find_all(string=lambda t: \u0026#34;å…³é”®å­—\u0026#34; in t) ğŸ“Œ 18. è¯†åˆ«åŠ¨æ€ç½‘é¡µ è‹¥å‘ç°ï¼š\nHTML å†…å®¹æ˜¯ç©ºçš„ æ•°æ®é€šè¿‡ JS æ¸²æŸ“ è¦ä¹ˆï¼š\næŠ“å– API æ¥å£ ä½¿ç”¨ Playwright / Selenium ğŸ” 19. æœ€ä½³ç»“æ„ï¼šçˆ¬å– -\u0026gt; è§£æ -\u0026gt; æå– -\u0026gt; ç»“æ„åŒ– ä½ å¯ä»¥å»ºç«‹ä¸€ä¸ªæ ‡å‡†æ¨¡æ¿ï¼š\ndef parse_item(item): return { \u0026#34;title\u0026#34;: item.select_one(\u0026#34;.title\u0026#34;).get_text(strip=True), \u0026#34;link\u0026#34;: item.select_one(\u0026#34;a\u0026#34;).get(\u0026#34;href\u0026#34;), \u0026#34;price\u0026#34;: item.select_one(\u0026#34;.price\u0026#34;).get_text(strip=True) if item.select_one(\u0026#34;.price\u0026#34;) else None } def crawl(url): soup = fetch(url) return [parse_item(item) for item in soup.select(\u0026#34;.item\u0026#34;)] ğŸ›  20. å¤§å‹é¡¹ç›®æ¨èç›®å½•ç»“æ„ crawler/ â”œâ”€â”€ fetch.py # requests å°è£… â”œâ”€â”€ parse.py # beautiful soup è§£æ â”œâ”€â”€ models.py # æ•°æ®ç»“æ„ â”œâ”€â”€ pipeline.py # å­˜å‚¨åˆ° DB / æ–‡ä»¶ â”œâ”€â”€ utils.py â””â”€â”€ run.py ğŸ”¥ BONUSï¼šçœŸå®åœºæ™¯æç®€ç¤ºä¾‹ å¦‚çˆ¬å–æ–°é—»æ ‡é¢˜+é“¾æ¥ï¼š\nimport requests from bs4 import BeautifulSoup def fetch(url): r = requests.get(url, timeout=8) r.raise_for_status() return BeautifulSoup(r.text, \u0026#34;lxml\u0026#34;) soup = fetch(\u0026#34;https://news.ycombinator.com\u0026#34;) data = [ { \u0026#34;title\u0026#34;: a.get_text(strip=True), \u0026#34;link\u0026#34;: a.get(\u0026#34;href\u0026#34;) } for a in soup.select(\u0026#34;.titleline \u0026gt; a\u0026#34;) ] print(data) ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ Beautiful Soup æœ€ä½³å®è·µï¼ˆä¸“ä¸šçº§ï¼‰ï¼Œæ¶µç›–ï¼šåˆå§‹åŒ–ã€æŸ¥è¯¢æ¨¡å¼ã€æ€§èƒ½ä¼˜åŒ–ã€å¥å£®æ€§ã€åçˆ¬å¤„ç†ã€ç¼–ç ã€é”™è¯¯å¤„ç†ã€ä¸ requests/å¹¶å‘çš„é…åˆã€çœŸå®çˆ¬è™«åœºæ™¯ç­‰ã€‚\nå†…å®¹æ˜¯é«˜è´¨é‡ã€å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ æœ€ä½³å®è·µåˆé›†ã€‚\nâœ… 1. å§‹ç»ˆä½¿ç”¨ lxml ä½œä¸ºè§£æå™¨ lxml é€Ÿåº¦æœ€å¿«ã€å®¹é”™æœ€å¼ºï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ç”¨å®ƒã€‚\nsoup = BeautifulSoup(html, \u0026#34;lxml\u0026#34;) ä¸è¦ä½¿ç”¨é»˜è®¤çš„ html.parser â€”â€” å¤ªæ…¢ã€å®¹é”™å·®ã€‚\nâœ… 2. ç”¨ select / select_one æ›¿ä»£ find / find_all CSS é€‰æ‹©å™¨å¯è¯»æ€§æ›´å¼ºï¼Œæ›´çµæ´»ã€‚\n"},{"id":490,"href":"/backend/python/fastapi/best-practices/","title":"æœ€ä½³å®è·µ","parent":"FastAPI","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å¯è½åœ°çš„ Python FastAPI æœ€ä½³å®è·µå¤§å…¨ï¼Œç»“åˆä½ ç°æœ‰çš„æŠ€æœ¯æ ˆï¼ˆPostgreSQLã€SQLAlchemy ORMã€JWTã€Casbinã€UMIã€AntDã€Pythonâ‰¥3.12ï¼‰ï¼Œå…¨éƒ¨å†…å®¹å¯ç›´æ¥ç”¨äºä¼ä¸šçº§é¡¹ç›®ã€‚\næ•´ç†æˆ ç»“æ„åŒ–çš„ 30 æ¡é»„é‡‘å‡†åˆ™ï¼Œæ¶µç›–ï¼šé¡¹ç›®ç»“æ„ã€é…ç½®ç®¡ç†ã€æ•°æ®åº“ã€æƒé™ã€ä¾èµ–æ³¨å…¥ã€è·¯ç”±ã€å“åº”æ ¼å¼ã€é”™è¯¯å¤„ç†ã€å·¥å…·å‡½æ•°ã€æ€§èƒ½ä¼˜åŒ–ã€éƒ¨ç½²ç»éªŒç­‰ã€‚\n1. é¡¹ç›®ç»“æ„æœ€ä½³å®è·µï¼ˆç›®å½•ï¼‰ âœ… åˆ†å±‚æ¸…æ™°ï¼šAPIã€Serviceã€Repositoryã€Schemaã€Coreã€DB\napp/ â”œâ”€â”€ api/ # è·¯ç”±å±‚ï¼šè¾“å…¥è¾“å‡ºã€æƒé™æ ¡éªŒ â”‚ â”œâ”€â”€ auth.py â”‚ â”œâ”€â”€ users.py â”‚ â””â”€â”€ roles.py â”œâ”€â”€ services/ # ä¸šåŠ¡å±‚ï¼šé€»è¾‘å¤„ç† â”‚ â””â”€â”€ users.py â”œâ”€â”€ repositories/ # æ•°æ®å±‚ï¼šDB CRUD â”‚ â””â”€â”€ users.py â”œâ”€â”€ schemas/ # Pydantic æ¨¡å‹ â”‚ â””â”€â”€ user.py â”œâ”€â”€ db/ â”‚ â”œâ”€â”€ session.py # engine, async_sessionmaker â”‚ â”œâ”€â”€ base.py â”‚ â””â”€â”€ models/ â”œâ”€â”€ core/ â”‚ â”œâ”€â”€ config.py # ç»Ÿä¸€é…ç½® â”‚ â”œâ”€â”€ security.py # JWT + bcrypt â”‚ â”œâ”€â”€ casbin.py # æƒé™ â”‚ â””â”€â”€ middleware.py # æ—¥å¿—ã€CORSã€å¼‚å¸¸ â”œâ”€â”€ utils/ â”‚ â”œâ”€â”€ json.py # ORM 2 JSON â”‚ â””â”€â”€ pagination.py â”œâ”€â”€ main.py â””â”€â”€ __init__.py 2. ä½¿ç”¨ pydantic-settings ç®¡ç†é…ç½® pip install pydantic-settings # core/config.py from pydantic_settings import BaseSettings class Settings(BaseSettings): env: str = \u0026#34;dev\u0026#34; db_url: str jwt_secret: str class Config: env_file = \u0026#34;.env\u0026#34; settings = Settings() ä¿æŒå¼€å‘/ç”Ÿäº§éš”ç¦»ã€‚\n3. å¿…é¡»ä½¿ç”¨ Async SQLAlchemy 2.0ï¼ˆä½ å·²ç»åœ¨ç”¨ï¼‰ from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker engine = create_async_engine(settings.db_url) SessionLocal = async_sessionmaker(engine, expire_on_commit=False) 4. ç»Ÿä¸€ä¾èµ–æ³¨å…¥ async def get_db(): async with SessionLocal() as session: yield session å‡å°‘å…¨å±€å˜é‡æ±¡æŸ“ã€‚\n5. Repository æ¨¡å¼ï¼ˆæ•°æ®å±‚ï¼‰ æ¯ä¸ªæ¨¡å‹ä¸€ä¸ª Repository æ‰€æœ‰ CRUD é›†ä¸­ç»´æŠ¤ class UserRepo: @staticmethod async def get_by_id(db, id): return await db.get(User, id) ä¸šåŠ¡å±‚(service)ä¸åº”è¯¥ç›´æ¥æ“ä½œ ORMã€‚\n6. Service å±‚ï¼šåªåšä¸šåŠ¡é€»è¾‘ class UserService: async def create_user(data, db): hashed = hash_password(data.password) user = User(**data.model_dump(), password=hashed) await UserRepo.save(db, user) return user ä¿è¯æ¸…æ™°èŒè´£åˆ’åˆ†ã€‚\n7. è·¯ç”±å±‚ï¼šåªåšè¾“å…¥/è¾“å‡ºä¸æƒé™æ ¡éªŒ @router.post(\u0026#34;/\u0026#34;) async def create(user: UserCreate, db=Depends(get_db), u=Depends(check_perm(\u0026#34;users\u0026#34;, \u0026#34;create\u0026#34;))): return await UserService.create_user(user, db) 8. ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆéå¸¸é‡è¦ï¼‰ def ok(data=None, msg=\u0026#34;success\u0026#34;): return {\u0026#34;code\u0026#34;: 0, \u0026#34;msg\u0026#34;: msg, \u0026#34;data\u0026#34;: data} def err(msg=\u0026#34;error\u0026#34;, code=400): return {\u0026#34;code\u0026#34;: code, \u0026#34;msg\u0026#34;: msg, \u0026#34;data\u0026#34;: None} å‰ç«¯ï¼ˆUMIï¼‰æ›´å®¹æ˜“å¤„ç†ã€‚\n9. ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†å¼‚å¸¸ @app.exception_handler(Exception) async def common_exception(request, exc): return JSONResponse(err(\u0026#34;æœåŠ¡å™¨å¼‚å¸¸\u0026#34;, 500)) é¿å…æ¯ä¸ªæ¥å£å†™ try/exceptã€‚\n10. JWT + bcryptï¼ˆä½ å·²ç»åœ¨ç”¨ï¼‰ å¯†ç å¿…é¡» bcrypt å­˜å‚¨ï¼š\npwd_context = CryptContext(schemes=[\u0026#34;bcrypt\u0026#34;], deprecated=\u0026#34;auto\u0026#34;) JWT æ¨èï¼š\naccess_token 1 å°æ—¶ refresh_token 7 å¤© éœ€è¦ refresh æ¥å£ 11. JWT + Casbin åšæç»†æƒé™æ§åˆ¶ï¼ˆä½ çš„éœ€æ±‚ï¼‰ ç”¨æˆ·ç™»å½•ååŠ è½½æƒé™ å‰ç«¯ç¼“å­˜æƒé™ åç«¯è·¯ç”±ç”¨ Decorator æ ¡éªŒ ä¾‹å¦‚æƒé™ï¼šâ€œmodule:action:path:platformâ€\ndef check_perm(obj, act): def wrapper(user=Depends(get_current_user)): if not enforcer.enforce(user.role, obj, act): raise HTTPException(403, \u0026#34;æƒé™ä¸è¶³\u0026#34;) return user return wrapper 12. æ•°æ®åº“æ¨¡å‹æœ€ä½³å®è·µï¼ˆSQLAlchemy 2.0ï¼‰ ä½¿ç”¨ mapped_column ä½¿ç”¨ UUID æˆ– Identity å­—æ®µç±»å‹å®Œæ•´å®šä¹‰ åˆ›å»ºè”åˆç´¢å¼•ä¸å”¯ä¸€çº¦æŸï¼ˆä½ å·²ç»åœ¨ç”¨ï¼‰ ç¤ºä¾‹ï¼š\nid: Mapped[int] = mapped_column(primary_key=True) email: Mapped[str] = mapped_column(String(100), unique=True) 13. å¿…é¡»å®šä¹‰ BaseModel çš„ from_attributes class UserOut(BaseModel): class Config: from_attributes = True å¦åˆ™ ORM -\u0026gt; schema ä¼šå‡ºé”™ã€‚\n14. ç»Ÿä¸€ ORM -\u0026gt; JSON å·¥å…·ï¼ˆä½ ä¸€ç›´åœ¨å®Œå–„ï¼‰ ä½ çš„æœ€ä½³ç‰ˆæœ¬ï¼š\ndef to_dict_list(items, fields=None): ... å¹¶è‡ªåŠ¨å¤„ç†ï¼š\ndatetime -\u0026gt; str strip() å¿½ç•¥ SQLAlchemy å†…éƒ¨å­—æ®µ è¿™æ˜¯æœ€ä½³å®è·µã€‚\n15. åˆ†é¡µæœ€ä½³å®è·µï¼ˆå…¨å±€å¤ç”¨ï¼‰ def paginate(query, page: int, size: int): return query.offset((page - 1) * size).limit(size) 16. è·¯ç”± prefix å¿…é¡»ç»Ÿä¸€ app.include_router(user_router, prefix=\u0026#34;/api/users\u0026#34;, tags=[\u0026#34;users\u0026#34;]) tags è®© Swagger æ›´æ¸…æ™°ã€‚\n17. ä½¿ç”¨ ORJSONResponseï¼ˆåŠ é€Ÿ 30%ï¼‰ from fastapi.responses import ORJSONResponse app = FastAPI(default_response_class=ORJSONResponse) 18. é…ç½® CORS app.add_middleware(CORSMiddleware, allow_origins=[\u0026#34;*\u0026#34;], allow_methods=[\u0026#34;*\u0026#34;]) 19. æ—¥å¿—ä½¿ç”¨ loguru æŒ‰æ—¥æœŸåˆ†å‰² JSON æ ¼å¼ æ¥å£è‡ªåŠ¨è®°å½•è¯·æ±‚/å“åº” 20. ä¸Šä¼ æ–‡ä»¶å¿…é¡»é™åˆ¶å¤§å° æ·»åŠ ä¸­é—´ä»¶ï¼š\n@app.middleware(\u0026#34;http\u0026#34;) async def limit_upload(request, call_next): if request.url.path.startswith(\u0026#34;/upload\u0026#34;) and request.headers.get(\u0026#34;content-length\u0026#34;): if int(request.headers[\u0026#34;content-length\u0026#34;]) \u0026gt; 10 * 1024 * 1024: return err(\u0026#34;æ–‡ä»¶å¤ªå¤§\u0026#34;, 413) return await call_next(request) 21. åº”é¿å…é•¿é˜»å¡ï¼Œä½¿ç”¨åå°ä»»åŠ¡ from fastapi import BackgroundTasks background.add_task(send_email, user.email) 22. ä½¿ç”¨ lifespan åŠ è½½ Casbinã€é…ç½®ç­‰ @app.on_event(\u0026#34;startup\u0026#34;) async def start(): init_casbin() 23. è·¯å¾„è®¾è®¡ä½¿ç”¨ RESTful åŠŸèƒ½ Method Path è·å–åˆ—è¡¨ GET /users åˆ›å»º POST /users è·å–è¯¦æƒ… GET /users/{id} åˆ é™¤ DELETE /users/{id} 24. ä¸¥æ ¼çš„å“åº”æ¨¡å‹ @router.get(\u0026#34;/\u0026#34;, response_model=list[UserOut]) 25. ä½¿ç”¨ HTTP çŠ¶æ€ç è¯­ä¹‰æ¸…æ™° 200 æ­£å¸¸ 201 åˆ›å»ºæˆåŠŸ 400 å‚æ•°é”™è¯¯ 401 æœªç™»å½• 403 æƒé™ä¸è¶³ 404 ä¸å­˜åœ¨ 500 æœåŠ¡ç«¯é”™è¯¯ 26. é™åˆ¶æ•°æ®åº“ Session ç”Ÿå‘½å‘¨æœŸ ä¸€å®šä¸èƒ½å¤ç”¨ Global Sessionã€‚\n27. æ•°æ®åº“è¿æ¥æ± é…ç½® engine = create_async_engine( url, pool_size=20, max_overflow=40, pool_timeout=30, ) 28. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Gunicorn + Uvicorn gunicorn main:app -k uvicorn.workers.UvicornWorker -w 4 29. ä½¿ç”¨ Nginx åšåå‘ä»£ç† + HTTPS æ¨èå¼€å¯ï¼š\nhttp2 gzip cache-control 30. è‡ªåŠ¨åŒ–æ–‡æ¡£åˆ†ä¸ºä¸¤å¥— /docs -\u0026gt; Swaggerï¼ˆé¢å‘å‰ç«¯ï¼‰ /redoc -\u0026gt; ReDocï¼ˆé¢å‘äº§å“ã€æµ‹è¯•ï¼‰ ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£å¯è½åœ°çš„ Python FastAPI æœ€ä½³å®è·µå¤§å…¨ï¼Œç»“åˆä½ ç°æœ‰çš„æŠ€æœ¯æ ˆï¼ˆPostgreSQLã€SQLAlchemy ORMã€JWTã€Casbinã€UMIã€AntDã€Pythonâ‰¥3.12ï¼‰ï¼Œå…¨éƒ¨å†…å®¹å¯ç›´æ¥ç”¨äºä¼ä¸šçº§é¡¹ç›®ã€‚\næ•´ç†æˆ ç»“æ„åŒ–çš„ 30 æ¡é»„é‡‘å‡†åˆ™ï¼Œæ¶µç›–ï¼šé¡¹ç›®ç»“æ„ã€é…ç½®ç®¡ç†ã€æ•°æ®åº“ã€æƒé™ã€ä¾èµ–æ³¨å…¥ã€è·¯ç”±ã€å“åº”æ ¼å¼ã€é”™è¯¯å¤„ç†ã€å·¥å…·å‡½æ•°ã€æ€§èƒ½ä¼˜åŒ–ã€éƒ¨ç½²ç»éªŒç­‰ã€‚\n1. é¡¹ç›®ç»“æ„æœ€ä½³å®è·µï¼ˆç›®å½•ï¼‰ âœ… åˆ†å±‚æ¸…æ™°ï¼šAPIã€Serviceã€Repositoryã€Schemaã€Coreã€DB\napp/ â”œâ”€â”€ api/ # è·¯ç”±å±‚ï¼šè¾“å…¥è¾“å‡ºã€æƒé™æ ¡éªŒ â”‚ â”œâ”€â”€ auth.py â”‚ â”œâ”€â”€ users.py â”‚ â””â”€â”€ roles.py â”œâ”€â”€ services/ # ä¸šåŠ¡å±‚ï¼šé€»è¾‘å¤„ç† â”‚ â””â”€â”€ users.py â”œâ”€â”€ repositories/ # æ•°æ®å±‚ï¼šDB CRUD â”‚ â””â”€â”€ users.py â”œâ”€â”€ schemas/ # Pydantic æ¨¡å‹ â”‚ â””â”€â”€ user.py â”œâ”€â”€ db/ â”‚ â”œâ”€â”€ session.py # engine, async_sessionmaker â”‚ â”œâ”€â”€ base.py â”‚ â””â”€â”€ models/ â”œâ”€â”€ core/ â”‚ â”œâ”€â”€ config.py # ç»Ÿä¸€é…ç½® â”‚ â”œâ”€â”€ security.py # JWT + bcrypt â”‚ â”œâ”€â”€ casbin.py # æƒé™ â”‚ â””â”€â”€ middleware.py # æ—¥å¿—ã€CORSã€å¼‚å¸¸ â”œâ”€â”€ utils/ â”‚ â”œâ”€â”€ json.py # ORM 2 JSON â”‚ â””â”€â”€ pagination.py â”œâ”€â”€ main.py â””â”€â”€ __init__.py 2. ä½¿ç”¨ pydantic-settings ç®¡ç†é…ç½® pip install pydantic-settings # core/config.py from pydantic_settings import BaseSettings class Settings(BaseSettings): env: str = \u0026#34;dev\u0026#34; db_url: str jwt_secret: str class Config: env_file = \u0026#34;.env\u0026#34; settings = Settings() ä¿æŒå¼€å‘/ç”Ÿäº§éš”ç¦»ã€‚\n"},{"id":491,"href":"/backend/python/orjson/best-practices/","title":"æœ€ä½³å®è·µ","parent":"orjson","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ ã€ŒPython orjson æœ€ä½³å®è·µï¼ˆå…¨å¥—è®¾è®¡ï¼‰ã€ï¼Œæ¶µç›–ï¼š\nä¸ºä»€ä¹ˆç”¨ orjson orjson dumps/loads æœ€ä½³å°è£… Pydantic / FastAPI é›†æˆæ–¹å¼ Datetime å¤„ç†æ–¹æ¡ˆ ç±»å‹æ ‡æ³¨æœ€ä½³å®è·µ VSCode/Pylance è¯¯æŠ¥è§£å†³ å®Œæ•´ utils.orjson_utils æ¨¡å— é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆFastAPI + Python 3.12ï¼‰ã€‚\nâœ… 1. ä¸ºä»€ä¹ˆ orjson æ˜¯ Python æœ€å¿« JSON åº“ï¼Ÿ orjson çš„ä¼˜åŠ¿ï¼š\nC ç¼–å†™ï¼Œé€Ÿåº¦æ˜¯ json/ujson/rapidjson ä¸­æœ€å¿« dumps è¿”å› bytes è€Œä¸æ˜¯ strï¼ˆé¿å…é‡å¤ç¼–ç ï¼‰ å†…ç½®æ”¯æŒ datetime -\u0026gt; RFC3339ï¼ˆISO 8601ï¼‰ å‡†ç¡®ã€é«˜æ•ˆã€å®‰å…¨ é€‚åˆï¼š\né«˜æ€§èƒ½ API é«˜é¢‘ JSON åºåˆ—åŒ– å¤§é‡æ•°æ®åºåˆ—åŒ– âœ… 2. â˜… æœ€ä½³å®è·µï¼šç»Ÿä¸€å°è£… dumps/loads ä½ çš„é¡¹ç›®ä¸­ä¸åº”è¯¥ç›´æ¥è°ƒç”¨ orjson.dumps()ã€‚\nğŸ‘‡ å®˜æ–¹æ¨è + ç”Ÿäº§ç¯å¢ƒæœ€ä¼˜è®¾è®¡\nutils/orjson_utils.py\n# utils/orjson_utils.py from __future__ import annotations import orjson from typing import Any def dumps(obj: Any, *, option: int | None = None) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34; å®‰å…¨çš„ JSON åºåˆ—åŒ–ï¼Œè¿”å› str orjson.dumps -\u0026gt; bytesï¼Œå› æ­¤éœ€è¦ decode \u0026#34;\u0026#34;\u0026#34; if option is None: option = orjson.OPT_NON_STR_KEYS | orjson.OPT_SERIALIZE_NUMPY return orjson.dumps(obj, option=option).decode(\u0026#34;utf-8\u0026#34;) def loads(data: str | bytes) -\u0026gt; Any: \u0026#34;\u0026#34;\u0026#34;ååºåˆ—åŒ– JSON å­—ç¬¦ä¸²/bytes\u0026#34;\u0026#34;\u0026#34; return orjson.loads(data) ä½¿ç”¨ï¼š\nfrom utils.orjson_utils import dumps, loads json_str = dumps({\u0026#34;a\u0026#34;: 1}) obj = loads(json_str) âœ… 3. â˜… datetime æœ€ä½³å¤„ç†æ–¹å¼ orjson æ”¯æŒ datetime è‡ªåŠ¨åºåˆ—åŒ–ï¼š\nimport datetime, orjson orjson.dumps({\u0026#34;t\u0026#34;: datetime.datetime.now()}) é»˜è®¤è¾“å‡º ISO8601ï¼š\n{\u0026#34;t\u0026#34;:\u0026#34;2025-01-01T12:00:00+08:00\u0026#34;} è¦æ ¼å¼åŒ–ä¸º \u0026ldquo;YYYY-MM-DD HH:mm:ss\u0026rdquo; -\u0026gt; è‡ªå®šä¹‰ default å¤„ç†å™¨ï¼š\ndef default(obj): if isinstance(obj, datetime.datetime): return obj.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) raise TypeError å°è£…ï¼š\ndef dumps_datetime(obj: Any) -\u0026gt; str: return orjson.dumps( obj, option=orjson.OPT_NON_STR_KEYS, default=lambda o: o.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) if hasattr(o, \u0026#34;strftime\u0026#34;) else TypeError ).decode() âœ… 4. â˜… ä¸ FastAPI é›†æˆï¼ˆæœ€æ¨èçš„å†™æ³•ï¼‰ FastAPI æ”¯æŒæ›¿æ¢ JSON Encoderï¼š\nmain.pyï¼š\nfrom fastapi import FastAPI from fastapi.responses import ORJSONResponse app = FastAPI(default_response_class=ORJSONResponse) â³ æ€§èƒ½ä¼˜åŒ–ï¼šå¼€ç®±å³ç”¨ã€‚\nğŸ”¥ FastAPI æ¨¡å‹é‡Œä¼˜é›…åºåˆ—åŒ– datetime Pydantic è®¾ç½®ï¼š\nfrom pydantic import BaseModel from datetime import datetime class Item(BaseModel): name: str created_at: datetime model_config = { \u0026#34;ser_json_timedelta\u0026#34;: \u0026#34;iso8601\u0026#34;, \u0026#34;ser_json_bytes\u0026#34;: \u0026#34;base64\u0026#34;, } âœ… 5. è§£å†³ VSCode â€œModule \u0026lsquo;orjson\u0026rsquo; has no member dumpsâ€ è¯¯æŠ¥ å®‰è£…ç±»å‹ stubï¼š\npip install types-orjson æ²¡æœ‰ç±»å‹æç¤ºæ—¶ï¼ŒVSCode ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚\nâœ… 6. â˜… orjson æœ€ä½³ option ç»„åˆ æ€§èƒ½æœ€ä½³ + æœ€å¸¸ç”¨ï¼š\nORJSON_OPTIONS = ( orjson.OPT_NON_STR_KEYS | orjson.OPT_SERIALIZE_NUMPY | orjson.OPT_UTC_Z | orjson.OPT_SORT_KEYS ) å…¶ä¸­ï¼š\nOPT_NON_STR_KEYSï¼šå…è®¸ dict key ä¸ºæ•°å­—/éå­—ç¬¦ä¸² OPT_SERIALIZE_NUMPYï¼šè‡ªåŠ¨åºåˆ—åŒ– numpy æ•°æ® OPT_SORT_KEYSï¼šæ’åºé”®ï¼ˆåˆ©äº diffï¼‰ OPT_UTC_Zï¼šUTC æ—¶é—´åŠ  Z âœ… 7. orjson ä¸æ”¯æŒçš„ç±»å‹ï¼ˆå¿…é¡»æ³¨æ„ï¼‰ è¿™äº›ç±»å‹éœ€æ‰‹åŠ¨è½¬æ¢ï¼š\nset complex Decimalï¼ˆéœ€è¦ str æˆ– floatï¼‰ UUID bytesï¼ˆé»˜è®¤æ”¯æŒï¼‰ ç¤ºä¾‹ï¼š\norjson.dumps({\u0026#34;set\u0026#34;: {1,2}}) # TypeError å¿…é¡»é€šè¿‡ default å¤„ç†ï¼š\ndef default(obj): if isinstance(obj, set): return list(obj) raise TypeError âœ… 8. å®Œæ•´ utils/orjson_utils.pyï¼ˆæœ€ä½³å®è·µæ ‡å‡†ç‰ˆï¼‰ ä½ ç›´æ¥å¤åˆ¶å³å¯ç”¨ï¼š\n# utils/orjson_utils.py from __future__ import annotations import orjson from typing import Any from datetime import datetime, date ORJSON_OPTIONS = ( orjson.OPT_NON_STR_KEYS | orjson.OPT_SERIALIZE_NUMPY | orjson.OPT_SORT_KEYS ) def _default(obj: Any): \u0026#34;\u0026#34;\u0026#34;è‡ªå®šä¹‰ fallback å¤„ç†å™¨\u0026#34;\u0026#34;\u0026#34; if isinstance(obj, (datetime, date)): return obj.strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;) if isinstance(obj, datetime) else obj.strftime(\u0026#34;%Y-%m-%d\u0026#34;) if isinstance(obj, set): return list(obj) raise TypeError(f\u0026#34;Object of type {type(obj)} is not JSON serializable\u0026#34;) def dumps(obj: Any, *, option: int | None = None) -\u0026gt; str: \u0026#34;\u0026#34;\u0026#34;orjson.dumps çš„å°è£…ï¼Œè¾“å‡º str\u0026#34;\u0026#34;\u0026#34; if option is None: option = ORJSON_OPTIONS return orjson.dumps(obj, option=option, default=_default).decode(\u0026#34;utf-8\u0026#34;) def loads(data: str | bytes) -\u0026gt; Any: \u0026#34;\u0026#34;\u0026#34;JSON ååºåˆ—åŒ–\u0026#34;\u0026#34;\u0026#34; return orjson.loads(data) ğŸ¯ æœ€ä½³ä½¿ç”¨æ–¹å¼ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ from utils.orjson_utils import dumps, loads print(dumps({\u0026#34;a\u0026#34;: 1, \u0026#34;t\u0026#34;: datetime.now()})) FastAPIï¼š\napp = FastAPI(default_response_class=ORJSONResponse) ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ ã€ŒPython orjson æœ€ä½³å®è·µï¼ˆå…¨å¥—è®¾è®¡ï¼‰ã€ï¼Œæ¶µç›–ï¼š\nä¸ºä»€ä¹ˆç”¨ orjson orjson dumps/loads æœ€ä½³å°è£… Pydantic / FastAPI é›†æˆæ–¹å¼ Datetime å¤„ç†æ–¹æ¡ˆ ç±»å‹æ ‡æ³¨æœ€ä½³å®è·µ VSCode/Pylance è¯¯æŠ¥è§£å†³ å®Œæ•´ utils.orjson_utils æ¨¡å— é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼ˆFastAPI + Python 3.12ï¼‰ã€‚\nâœ… 1. ä¸ºä»€ä¹ˆ orjson æ˜¯ Python æœ€å¿« JSON åº“ï¼Ÿ orjson çš„ä¼˜åŠ¿ï¼š\nC ç¼–å†™ï¼Œé€Ÿåº¦æ˜¯ json/ujson/rapidjson ä¸­æœ€å¿« dumps è¿”å› bytes è€Œä¸æ˜¯ strï¼ˆé¿å…é‡å¤ç¼–ç ï¼‰ å†…ç½®æ”¯æŒ datetime -\u0026gt; RFC3339ï¼ˆISO 8601ï¼‰ å‡†ç¡®ã€é«˜æ•ˆã€å®‰å…¨ é€‚åˆï¼š\n"},{"id":492,"href":"/backend/python/redis/best-practices/","title":"æœ€ä½³å®è·µ","parent":"Redis","content":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨çš„ Python Redis æœ€ä½³å®è·µï¼ˆç»“åˆä½ çš„åœºæ™¯ï¼šFastAPI + SQLAlchemy + PostgreSQL + Kubernetesï¼‰ã€‚\nå†…å®¹æç®€ä½†ä¸“ä¸šï¼Œå¯ç›´æ¥å¤åˆ¶è¿›ä½ é¡¹ç›®ã€‚\nğŸš€ Python Redis æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§ï¼‰ ğŸ“Œ ç›®å½•\nè¿æ¥æ–¹å¼æœ€ä½³å®è·µ é”®åï¼ˆKeyï¼‰å‘½åè§„èŒƒ æ•°æ®ç»“æ„ä½¿ç”¨æœ€ä½³å®è·µ åŸå­æ“ä½œæœ€ä½³å®è·µ é«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ– é«˜å¯é æ€§ç”¨æ³• FastAPI é¡¹ç›®ç»“æ„æ¨è å¯ç›´æ¥ä½¿ç”¨çš„å°è£…å·¥å…·ç±» 1. è¿æ¥æ–¹å¼æœ€ä½³å®è·µ ä½¿ç”¨ è¿æ¥æ± ï¼ˆå¿…é€‰ï¼‰ é¿å…é«˜å¹¶å‘æ—¶ Redis è¢«æ‰“çˆ†ï¼š\nimport redis redis_pool = redis.ConnectionPool( host=\u0026#34;localhost\u0026#34;, port=6379, db=0, max_connections=200, decode_responses=True, ) r = redis.Redis(connection_pool=redis_pool) âš ï¸ ä¸è¦åœ¨æ¯æ¬¡è¯·æ±‚é‡Œåˆ›å»º Redis()ï¼Œé‚£ä¼šå¯¼è‡´è¿æ¥æ³„æ¼ã€CPU æ¿€å¢ã€‚\n2. Key å‘½åæœ€ä½³å®è·µ ç»Ÿä¸€ä½¿ç”¨ å†’å· : åˆ†éš”å±‚çº§ï¼š\nuser:1:profile user:1:token cache:stock:600519 rate_limit:login:192.168.1.1 è§„åˆ™ï¼š\nä¸€å¾‹å°å†™ å±‚çº§ä½¿ç”¨å†’å· ä¸šåŠ¡æ¨¡å—å‰ç¼€ï¼Œå¦‚ cache:ã€session:ã€token: ä¸è¦ç”¨å¤§å†™ã€å¤§æ®µè‹±æ–‡ã€ä¸­æ–‡ 3. æ•°æ®ç»“æ„é€‰å‹æœ€ä½³å®è·µ å­—ç¬¦ä¸² String -\u0026gt; æœ€ç¨³é€‰æ‹© è®¡æ•°å™¨ åˆ†å¸ƒå¼é” ç®€å• KV ç¼“å­˜ ä½¿ç”¨ï¼š\nr.set(\u0026#34;user:1:name\u0026#34;, \u0026#34;martin\u0026#34;, ex=3600) Hash -\u0026gt; å¤šå­—æ®µå¯¹è±¡ï¼ˆæ¨èï¼‰ æ›´èŠ‚çœå†…å­˜ï¼Œé€‚åˆç”¨æˆ·ä¿¡æ¯ã€é…ç½®ç­‰ã€‚\nr.hset(\u0026#34;user:1\u0026#34;, mapping={ \u0026#34;name\u0026#34;: \u0026#34;martin\u0026#34;, \u0026#34;vip\u0026#34;: \u0026#34;1\u0026#34; }) List -\u0026gt; é˜Ÿåˆ—ï¼ˆè½»é‡ï¼‰ é€‚åˆï¼š\nç®€å•æ¶ˆæ¯é˜Ÿåˆ— å¾…å¤„ç†ä»»åŠ¡ ä¸é€‚åˆè¶…å¤§åˆ—è¡¨ã€‚\nSet -\u0026gt; å»é‡é›†åˆ å¦‚ï¼š\nr.sadd(\u0026#34;online_users\u0026#34;, \u0026#34;martin\u0026#34;) ZSet -\u0026gt; æ’åºæ’è¡Œæ¦œ å¦‚ç§¯åˆ†æ¦œã€çƒ­åº¦æ¦œã€‚\n4. åŸå­æ“ä½œæœ€ä½³å®è·µï¼ˆéå¸¸å…³é”®ï¼‰ å¿…é¡»ä½¿ç”¨åŸå­æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯ get + setã€‚\nè®¡æ•°å™¨\nr.incr(\u0026#34;counter\u0026#34;) è·å–å¹¶å¢åŠ \nvalue = r.incrby(\u0026#34;counter\u0026#34;, 1) åˆ†å¸ƒå¼é”\nlock = r.lock(\u0026#34;my_lock\u0026#34;, timeout=5) with lock: # å®‰å…¨æ‰§è¡Œ 5. é«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ– ä½¿ç”¨ Pipeline æ‰¹é‡æäº¤ï¼ˆå‡å°‘ RTTï¼‰ pipe = r.pipeline() pipe.incr(\u0026#34;views\u0026#34;) pipe.sadd(\u0026#34;active_user\u0026#34;, 1) result = pipe.execute() ä½¿ç”¨ SCAN æ›¿ä»£ KEYS â­â­â­ è¶…çº§é‡è¦ï¼Œé¿å… Redis å¡æ­»\nfor key in r.scan_iter(\u0026#34;user:*\u0026#34;): print(key) 6. é«˜å¯é æ€§ä½¿ç”¨æ–¹å¼ è®¾ç½® TTL é˜²æ­¢ç¼“å­˜ç‚¸åº“ r.set(\u0026#34;session:xxx\u0026#34;, \u0026#34;data\u0026#34;, ex=3600) ç¼“å­˜é›ªå´©ä¿æŠ¤ï¼ˆéšæœº TTLï¼‰ import random r.set(\u0026#34;user:1\u0026#34;, \u0026#34;data\u0026#34;, ex=3600 + random.randint(0, 300)) ç¼“å­˜å‡»ç©¿ä¿æŠ¤ï¼ˆçƒ­ç‚¹ key é”ï¼‰ lock = r.lock(\u0026#34;lock:hot_key\u0026#34;, timeout=3) 7. ä¸ FastAPI é›†æˆæœ€ä½³å®è·µï¼ˆä½ å¼ºçƒˆéœ€è¦ï¼‰ ç›®å½•ç»“æ„æ¨èï¼š\napp/ â”œâ”€ core/ â”‚ â”œâ”€ config.py â”‚ â””â”€ redis.py â”œâ”€ api/ â”‚ â””â”€ users.py â””â”€ main.py redis.pyï¼ˆç”Ÿäº§çº§ä¾èµ–æ³¨å…¥ï¼‰\nimport redis redis_pool = redis.ConnectionPool( host=\u0026#34;localhost\u0026#34;, port=6379, db=0, decode_responses=True, max_connections=200, ) redis_client = redis.Redis(connection_pool=redis_pool) def get_redis(): return redis_client FastAPI ä¾èµ–ï¼š\nfrom fastapi import Depends @app.get(\u0026#34;/counter\u0026#34;) def counter(r = Depends(get_redis)): return r.incr(\u0026#34;counter\u0026#34;) 8. ç”Ÿäº§å¯ç”¨ Redis å·¥å…·ç±»ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰ import redis import json import random from typing import Any, Optional class RedisClient: def __init__(self, host=\u0026#34;localhost\u0026#34;, port=6379, db=0, max_conn=200): pool = redis.ConnectionPool( host=host, port=port, db=db, decode_responses=True, max_connections=max_conn, ) self.r = redis.Redis(connection_pool=pool) # ---------- String ---------- def set(self, key: str, value: Any, ex: int | None = None, random_ttl: bool = False): if random_ttl and ex: ex = ex + random.randint(1, 300) if not isinstance(value, str): value = json.dumps(value) return self.r.set(key, value, ex=ex) def get(self, key: str) -\u0026gt; Optional[str]: return self.r.get(key) # ---------- Hash ---------- def hset(self, key: str, mapping: dict): return self.r.hset(key, mapping=mapping) def hgetall(self, key: str): return self.r.hgetall(key) # ---------- List ---------- def push(self, key: str, *values): return self.r.rpush(key, *values) def pop(self, key: str): return self.r.lpop(key) # ---------- Set ---------- def sadd(self, key: str, *values): return self.r.sadd(key, *values) def sismember(self, key: str, value): return self.r.sismember(key, value) # ---------- Atomic ops ---------- def incr(self, key: str, step: int = 1): return self.r.incrby(key, step) # ---------- Lock ---------- def lock(self, key: str, timeout=5): return self.r.lock(key, timeout=timeout) # ---------- Scan ---------- def scan(self, pattern: str): for key in self.r.scan_iter(pattern): yield key ä½¿ç”¨ï¼š\nrc = RedisClient() rc.set(\u0026#34;user:1:name\u0026#34;, \u0026#34;martin\u0026#34;, ex=3600) print(rc.get(\u0026#34;user:1:name\u0026#34;)) ğŸ¯ æ€»ç»“ï¼šPython Redis æœ€ä½³å®è·µæ ¸å¿ƒè¦ç‚¹ æœ€ä½³å®è·µ å¿…é¡»æ‰§è¡Œï¼Ÿ è¯´æ˜ ä½¿ç”¨ ConnectionPool âœ… å¿…é¡» é¿å…é«˜å¹¶å‘ä¸‹å¡æ­» ä½¿ç”¨ decode_responses æ¨è é¿å…å¤§é‡ bytes ç”¨ incr ä»£æ›¿ get+set è¶…çº§å…³é”® é˜²æ­¢ç«æ€ ä½¿ç”¨ Pipeline æ¨è é™ä½ RTT ç¦ç”¨ KEYSï¼Œç”¨ SCAN å¿…é¡» é˜²æ­¢å¡æ­» éšæœº TTL é˜²é›ªå´© æ¨è ä¼ä¸šå¸¸ç”¨ åˆ†å¸ƒå¼é”ç”¨ redis.lock æ¨è é¿å…å¹¶å‘é—®é¢˜ key åç§°è§„èŒƒåŒ– æ¨è ä»£ç æ¸…æ™°ç¨³å®š æ‰©å±•\nRedis + FastAPI å®Œæ•´å°è£…ï¼ˆé€‚ç”¨äºä½ é¡¹ç›®ï¼‰ Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ Redis ç¼“å­˜è®¾è®¡ï¼ˆç©¿é€ã€å‡»ç©¿ã€é›ªå´©é˜²å¾¡ï¼‰ Redis Stream æ¶ˆæ¯é˜Ÿåˆ—æœ€ä½³å®è·µ Redis åœ¨ Kubernetes ä¸Šç”Ÿäº§éƒ¨ç½² YAML ","description":"ä¸‹é¢ç»™ä½ ä¸€ä»½ çœŸæ­£ç”Ÿäº§å¯ç”¨çš„ Python Redis æœ€ä½³å®è·µï¼ˆç»“åˆä½ çš„åœºæ™¯ï¼šFastAPI + SQLAlchemy + PostgreSQL + Kubernetesï¼‰ã€‚\nå†…å®¹æç®€ä½†ä¸“ä¸šï¼Œå¯ç›´æ¥å¤åˆ¶è¿›ä½ é¡¹ç›®ã€‚\nğŸš€ Python Redis æœ€ä½³å®è·µï¼ˆç”Ÿäº§çº§ï¼‰ ğŸ“Œ ç›®å½•\nè¿æ¥æ–¹å¼æœ€ä½³å®è·µ é”®åï¼ˆKeyï¼‰å‘½åè§„èŒƒ æ•°æ®ç»“æ„ä½¿ç”¨æœ€ä½³å®è·µ åŸå­æ“ä½œæœ€ä½³å®è·µ é«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ– é«˜å¯é æ€§ç”¨æ³• FastAPI é¡¹ç›®ç»“æ„æ¨è å¯ç›´æ¥ä½¿ç”¨çš„å°è£…å·¥å…·ç±» 1. è¿æ¥æ–¹å¼æœ€ä½³å®è·µ ä½¿ç”¨ è¿æ¥æ± ï¼ˆå¿…é€‰ï¼‰ é¿å…é«˜å¹¶å‘æ—¶ Redis è¢«æ‰“çˆ†ï¼š\n"},{"id":493,"href":"/backend/python/requests/best-practices/","title":"æœ€ä½³å®è·µ","parent":"Requests","content":"ä¸‹é¢æ˜¯ä¸€ä»½ Python Requests æœ€ä½³å®è·µï¼ˆä¸“ä¸šçº§ï¼‰ï¼ŒåŒ…å«å·¥ç¨‹åŒ–ã€ç¨³å®šæ€§ã€å¯ç»´æŠ¤æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½å…¨æ–¹é¢çš„æ€»ç»“ã€‚\n1. ä¼˜å…ˆä½¿ç”¨ Sessionï¼ˆä¿æŒè¿æ¥ã€å‡å°‘å¼€é”€ï¼‰ âŒ ä¸è¦æ¯æ¬¡éƒ½ requests.get\nrequests.get(url) requests.post(url) âœ… ç”¨ Session() ä¿æŒ TCP è¿æ¥ + è‡ªåŠ¨å¤ç”¨ Cookie + æé«˜æ€§èƒ½\nimport requests session = requests.Session() session.headers.update({\u0026#34;User-Agent\u0026#34;: \u0026#34;MyApp/1.0\u0026#34;}) def get(url, **kwargs): return session.get(url, timeout=(3, 10), **kwargs) r = get(\u0026#34;https://example.com\u0026#34;) Session èƒ½å‡å°‘ 80% ä»¥ä¸Šçš„ TCP å»ºç«‹å¼€é”€ï¼Œé€‚åˆé«˜é¢‘ API è°ƒç”¨å’Œçˆ¬è™«ã€‚\n2. ä½¿ç”¨ Retry é‡è¯•æœºåˆ¶ï¼ˆå¯¹ 500/è¶…æ—¶å¾ˆé‡è¦ï¼‰ from requests.adapters import HTTPAdapter from urllib3.util.retry import Retry import requests session = requests.Session() retry = Retry( total=3, backoff_factor=0.5, status_forcelist=[500, 502, 503, 504], allowed_methods=[\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;], ) adapter = HTTPAdapter(max_retries=retry) session.mount(\u0026#34;http://\u0026#34;, adapter) session.mount(\u0026#34;https://\u0026#34;, adapter) ğŸ“Œ å¥½å¤„\né¿å…å¶å‘ç½‘ç»œæ•…éšœ è‡ªåŠ¨é‡è¯• HTTP 5xx backoff é˜²æ­¢è¯·æ±‚é£æš´ 3. æ°¸è¿œè®¾ç½® Timeoutï¼ˆå¦åˆ™ç¨‹åºä¼šå¡æ­»ï¼‰ âŒ è¿™ä¼šå¡ä½ä¸€æ•´å¤©\nrequests.get(url) âœ… æ­£ç¡®å†™æ³•\nrequests.get(url, timeout=(3, 10)) è§£é‡Šï¼š\n3 -\u0026gt; è¿æ¥è¶…æ—¶ï¼ˆTCP è¿æ¥ï¼‰ 10 -\u0026gt; è¯»å–è¶…æ—¶ï¼ˆæœåŠ¡å™¨å¤„ç†æ—¶é—´ï¼‰ ç”Ÿäº§ç¯å¢ƒå¿…é¡»å†™ï¼\n4. Bearer Tokenã€Cookieã€UA ç­‰ç»Ÿä¸€è®¾ç½® ğŸ§± æœ€ä½³å®è·µï¼šåˆå§‹åŒ– Session æ—¶ç»Ÿä¸€è®¾å®š\nsession = requests.Session() session.headers.update({ \u0026#34;User-Agent\u0026#34;: \u0026#34;MyApp/1.0\u0026#34;, \u0026#34;Authorization\u0026#34;: f\u0026#34;Bearer {token}\u0026#34;, }) é¿å…æ¯ä¸ªè¯·æ±‚é‡å¤ä¼ ã€‚\n5. ä½¿ç”¨æµå¼ä¸‹è½½ï¼ˆé¿å…å ç”¨å†…å­˜ï¼‰ âŒ é”™è¯¯æ–¹å¼ï¼ˆæ–‡ä»¶å¤§äº 1G ä¼šç‚¸å†…å­˜ï¼‰\nr = requests.get(url) open(\u0026#34;a.zip\u0026#34;, \u0026#34;wb\u0026#34;).write(r.content) âœ… æ­£ç¡®æ–¹å¼\nwith requests.get(url, stream=True) as r: r.raise_for_status() with open(\u0026#34;a.zip\u0026#34;, \u0026#34;wb\u0026#34;) as f: for chunk in r.iter_content(chunk_size=8192): if chunk: f.write(chunk) 6. ä½¿ç”¨ .raise_for_status() è‡ªåŠ¨æŠ›å¼‚å¸¸ï¼ˆå‡å°‘çŠ¶æ€ç åˆ¤æ–­ï¼‰ âŒ è€å†™æ³•\nif r.status_code != 200: print(\u0026#34;è¯·æ±‚å¤±è´¥\u0026#34;) âœ… æ–°å†™æ³•\ntry: r = requests.get(url) r.raise_for_status() except requests.RequestException as e: print(\u0026#34;è¯·æ±‚å¤±è´¥:\u0026#34;, e) ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰ç½‘ç»œã€çŠ¶æ€ç å¼‚å¸¸ã€‚\n7. JSON è¯·æ±‚ç”¨ json= è€Œä¸æ˜¯ data= âŒ é”™è¯¯å†™æ³•ï¼ˆå‘é€ x-www-form-urlencodedï¼‰\nrequests.post(url, data={\u0026#34;a\u0026#34;: 1}) âœ… æ­£ç¡®å†™æ³•ï¼ˆæ ‡å‡† JSON è¯·æ±‚ï¼‰\nrequests.post(url, json={\u0026#34;a\u0026#34;: 1}) requests ä¼šè‡ªåŠ¨åŠ  Content-Type: application/jsonã€‚\n8. å¥å£®çš„å¼‚å¸¸æ•è·ç»“æ„ å®Œæ•´ç»“æ„åº”è¯¥æ˜¯ï¼š\nimport requests try: r = session.get(url, timeout=(3, 10)) r.raise_for_status() data = r.json() except requests.Timeout: print(\u0026#34;è¯·æ±‚è¶…æ—¶\u0026#34;) except requests.ConnectionError: print(\u0026#34;ç½‘ç»œè¿æ¥å¤±è´¥\u0026#34;) except requests.HTTPError as e: print(\u0026#34;HTTP é”™è¯¯:\u0026#34;, e) except ValueError: print(\u0026#34;JSON è§£æå¤±è´¥\u0026#34;) except Exception as e: print(\u0026#34;æœªçŸ¥é”™è¯¯:\u0026#34;, e) é«˜è´¨é‡ç”Ÿäº§ç¯å¢ƒå¿…å¤‡ã€‚\n9. ä½¿ç”¨ Proxyï¼ˆè°ƒè¯•æŠ“åŒ… or ç¿»å¢™ï¼‰ Charles / Fiddler / mitmproxy è°ƒè¯•å¿…éœ€ï¼š\nproxies = { \u0026#34;http\u0026#34;: \u0026#34;http://127.0.0.1:8888\u0026#34;, \u0026#34;https\u0026#34;: \u0026#34;http://127.0.0.1:8888\u0026#34;, } session.get(url, proxies=proxies, verify=False) 10. è¯·æ±‚è®°å½•ï¼ˆè°ƒè¯•è¶…å¥½ç”¨ï¼‰ r = session.get(url) print(\u0026#34;URL:\u0026#34;, r.request.url) print(\u0026#34;Method:\u0026#34;, r.request.method) print(\u0026#34;Request Headers:\u0026#34;, r.request.headers) print(\u0026#34;Request Body:\u0026#34;, r.request.body) print(\u0026#34;Status:\u0026#34;, r.status_code) print(\u0026#34;Response Headers:\u0026#34;, r.headers) é…åˆ API è°ƒè¯•éå¸¸æœ‰ç”¨ã€‚\n11. ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆä¸è¦å†™æ­» Tokenï¼‰ import os TOKEN = os.getenv(\u0026#34;API_TOKEN\u0026#34;) é¿å… Token æ³„æ¼ã€‚\n12. å°è£…æˆé€šç”¨ API Clientï¼ˆé¡¹ç›®çº§æœ€ä½³å®è·µï¼‰ å»ºè®®åœ¨å·¥ç¨‹ä¸­å°æˆç±»ï¼š\nclass APIClient: def __init__(self, base_url: str, token: str = None): self.session = requests.Session() self.base_url = base_url self.session.headers.update({ \u0026#34;User-Agent\u0026#34;: \u0026#34;MyApp/1.0\u0026#34;, }) if token: self.session.headers[\u0026#34;Authorization\u0026#34;] = f\u0026#34;Bearer {token}\u0026#34; # åŠ ä¸Šé‡è¯• retry = Retry(total=3, backoff_factor=0.3, allowed_methods=[\u0026#34;GET\u0026#34;,\u0026#34;POST\u0026#34;]) adapter = HTTPAdapter(max_retries=retry) self.session.mount(\u0026#34;http://\u0026#34;, adapter) self.session.mount(\u0026#34;https://\u0026#34;, adapter) def get(self, path, **kwargs): return self.session.get(self.base_url + path, timeout=(3,10), **kwargs) def post(self, path, **kwargs): return self.session.post(self.base_url + path, timeout=(3,10), **kwargs) ä¹‹åæ‰€æœ‰æ¥å£å˜å¾—éå¸¸ç®€æ´ï¼š\nclient = APIClient(\u0026#34;https://api.example.com\u0026#34;, token=\u0026#34;jwt_token_here\u0026#34;) data = client.get(\u0026#34;/user/info\u0026#34;).json() è¿™æ˜¯ä¼ä¸šçº§é¡¹ç›®æ ‡å‡†å†™æ³•ã€‚\n13. å»ºè®®å…³é—­ SSL éªŒè¯ä»…åœ¨æµ‹è¯•ç¯å¢ƒ requests.get(url, verify=False) âš ï¸ ç”Ÿäº§ç¯å¢ƒä¸è¦å…³é—­ SSLï¼\n14. è®°å½•æ—¥å¿—ï¼ˆæ–¹ä¾¿åˆ†ææ¥å£å¤±è´¥ï¼‰ é…åˆ loguruï¼š\nlogger.info(f\u0026#34;Request -\u0026gt; {url}, params={params}\u0026#34;) logger.info(f\u0026#34;Response \u0026lt;- {r.status_code}, body={r.text}\u0026#34;) API Debug éå¸¸æ–¹ä¾¿ã€‚\n15. å¯¹å¤§è§„æ¨¡å¤šçº¿ç¨‹è¯·æ±‚ï¼Œä½¿ç”¨ requests + ThreadPoolExecutor from concurrent.futures import ThreadPoolExecutor import requests session = requests.Session() def fetch(url): return session.get(url).text with ThreadPoolExecutor(max_workers=10) as pool: results = list(pool.map(fetch, urls)) é«˜æ•ˆåˆç®€å•ã€‚\nâ­ æ€»ç»“ï¼šRequests æœ€ä½³å®è·µæ ¸å¿ƒ 12 æ¡ é¡¹ç›® æœ€ä½³å®è·µ 1 ç”¨ Session()ï¼Œä¸è¦æ¯æ¬¡ requests.get 2 å¼ºåˆ¶ä½¿ç”¨ timeout 3 åŠ é‡è¯•æœºåˆ¶ï¼ˆRetryï¼‰ 4 ç”¨ .raise_for_status() 5 JSON è¯·æ±‚ç”¨ json= 6 æµå¼ä¸‹è½½å¤§æ–‡ä»¶ 7 ä¼˜é›…çš„å¼‚å¸¸æ•è·ç»“æ„ 8 æ‰€æœ‰ headers/Tokens é›†ä¸­è®¾ç½® 9 ç”¨ Proxy åšæŠ“åŒ…/è°ƒè¯• 10 æ‰“å°è¯·æ±‚/å“åº”ç”¨äºè°ƒè¯• 11 æ•æ„Ÿä¿¡æ¯ç”¨ç¯å¢ƒå˜é‡ 12 å·¥ç¨‹çº§å°è£…æˆ API Client Next ç¤ºä¾‹:\nclient = APIClient(base_url=\u0026#34;https://example.com/api\u0026#34;) client.session.headers.update({\u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 ...\u0026#34;}) response = client.get(f\u0026#34;?id=100\u0026#34;) if response is None: exit() response_dict: dict = response.json() data: list[dict] = response_dict.get(\u0026#34;data\u0026#34;, []) ","description":"ä¸‹é¢æ˜¯ä¸€ä»½ Python Requests æœ€ä½³å®è·µï¼ˆä¸“ä¸šçº§ï¼‰ï¼ŒåŒ…å«å·¥ç¨‹åŒ–ã€ç¨³å®šæ€§ã€å¯ç»´æŠ¤æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½å…¨æ–¹é¢çš„æ€»ç»“ã€‚\n1. ä¼˜å…ˆä½¿ç”¨ Sessionï¼ˆä¿æŒè¿æ¥ã€å‡å°‘å¼€é”€ï¼‰ âŒ ä¸è¦æ¯æ¬¡éƒ½ requests.get\nrequests.get(url) requests.post(url) âœ… ç”¨ Session() ä¿æŒ TCP è¿æ¥ + è‡ªåŠ¨å¤ç”¨ Cookie + æé«˜æ€§èƒ½\nimport requests session = requests.Session() session.headers.update({\u0026#34;User-Agent\u0026#34;: \u0026#34;MyApp/1.0\u0026#34;}) def get(url, **kwargs): return session.get(url, timeout=(3, 10), **kwargs) r = get(\u0026#34;https://example.com\u0026#34;) Session èƒ½å‡å°‘ 80% ä»¥ä¸Šçš„ TCP å»ºç«‹å¼€é”€ï¼Œé€‚åˆé«˜é¢‘ API è°ƒç”¨å’Œçˆ¬è™«ã€‚\n2. ä½¿ç”¨ Retry é‡è¯•æœºåˆ¶ï¼ˆå¯¹ 500/è¶…æ—¶å¾ˆé‡è¦ï¼‰ from requests.adapters import HTTPAdapter from urllib3.util.retry import Retry import requests session = requests.Session() retry = Retry( total=3, backoff_factor=0.5, status_forcelist=[500, 502, 503, 504], allowed_methods=[\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;], ) adapter = HTTPAdapter(max_retries=retry) session.mount(\u0026#34;http://\u0026#34;, adapter) session.mount(\u0026#34;https://\u0026#34;, adapter) ğŸ“Œ å¥½å¤„\n"},{"id":494,"href":"/operations/hardware/servers/","title":"æœåŠ¡å™¨ç¡¬ä»¶","parent":"Hardware","content":" ä¸€ã€æœåŠ¡å™¨ç¡¬ä»¶æ•´ä½“æ¶æ„ CPU â”œâ”€ å†…å­˜ï¼ˆRAMï¼‰ â”œâ”€ ä¸»æ¿ / èŠ¯ç‰‡ç»„ â”‚ â”œâ”€ PCIe â”‚ â”œâ”€ SATA / SAS / NVMe â”‚ â””â”€ BMCï¼ˆIPMIï¼‰ â”œâ”€ å­˜å‚¨ â”œâ”€ ç½‘ç»œ â”œâ”€ ç”µæº â””â”€ æ•£çƒ­ äºŒã€æ ¸å¿ƒéƒ¨ä»¶è¯¦è§£ 1ï¸âƒ£ CPUï¼ˆå¤„ç†å™¨ï¼‰ å…³é”®æŒ‡æ ‡\næ ¸å¿ƒæ•° / çº¿ç¨‹æ•° ä¸»é¢‘ / ç¿é¢‘ ç¼“å­˜ï¼ˆL3 å¾ˆå…³é”®ï¼‰ NUMA æ¶æ„ æŒ‡ä»¤é›†ï¼ˆAVXã€AES-NIï¼‰ ä¸»æµå¹³å°\nIntel Xeonï¼ˆç¨³å®šã€ç”Ÿæ€æˆç†Ÿï¼‰ AMD EPYCï¼ˆæ ¸å¿ƒå¤šã€æ€§ä»·æ¯”é«˜ã€NUMA æ˜æ˜¾ï¼‰ é€‰å‹å»ºè®®\næ•°æ®åº“ / è™šæ‹ŸåŒ–ï¼šå¤šæ ¸ + å¤§ç¼“å­˜ é«˜å¹¶å‘ Webï¼šé«˜ä¸»é¢‘ å®¹å™¨ / K8Sï¼šæ ¸å¿ƒæ•°ä¼˜å…ˆ 2ï¸âƒ£ å†…å­˜ï¼ˆRAMï¼‰ å…³é”®ç‚¹\nECCï¼ˆå¿…é¡»ï¼‰ é¢‘ç‡ \u0026amp; é€šé“æ•° DIMM æ•°é‡ï¼ˆå½±å“å¸¦å®½ï¼‰ NUMA äº²å’Œæ€§ å¸¸è§é—®é¢˜\nå†…å­˜ä¸å‡ -\u0026gt; NUMA è·¨èŠ‚ç‚¹è®¿é—®æ…¢ æ··æ’ä¸åŒé¢‘ç‡ -\u0026gt; è‡ªåŠ¨é™é¢‘ ç»éªŒå€¼\nDBï¼šå†…å­˜ \u0026gt; CPU K8S Nodeï¼šé¢„ç•™ 20% ç»™ç³»ç»Ÿ 3ï¸âƒ£ ä¸»æ¿ \u0026amp; èŠ¯ç‰‡ç»„ å…³æ³¨ç‚¹\nCPU æ’æ§½æ•°é‡ï¼ˆå•è·¯ / åŒè·¯ï¼‰ PCIe ç‰ˆæœ¬ \u0026amp; é€šé“æ•° RAID å¡ / HBA æ”¯æŒ BMCï¼ˆIPMI / iDRAC / iLOï¼‰ BMC åŠŸèƒ½\nè¿œç¨‹å¼€å…³æœº KVM over IP ç¡¬ä»¶ç›‘æ§ ç‹¬ç«‹ç®¡ç†ç½‘å£ 4ï¸âƒ£ å­˜å‚¨ï¼ˆéå¸¸å…³é”®ï¼‰ â‘  ç¡¬ç›˜ç±»å‹ ç±»å‹ ç‰¹ç‚¹ åœºæ™¯ SATA HDD å®¹é‡å¤§ å½’æ¡£ SATA SSD æ€§ä»·æ¯” é€šç”¨ NVMe SSD å»¶è¿Ÿä½ æ•°æ®åº“ / æ—¥å¿— SAS ç¨³å®š ä¼ä¸šçº§ â‘¡ RAID RAID0ï¼šå¿«ï¼Œä¸å®‰å…¨ RAID1ï¼šå®‰å…¨ RAID5ï¼šå®¹é‡åˆ©ç”¨é«˜ RAID10ï¼šæ€§èƒ½ + å®‰å…¨ï¼ˆæœ€æ¨èï¼‰ âš ï¸ æ•°æ®åº“ ä¸å»ºè®® RAID5\n5ï¸âƒ£ ç½‘ç»œ å…³é”®å‚æ•°\nç½‘å¡é€Ÿç‡ï¼š1G / 10G / 25G / 40G å¤šé˜Ÿåˆ—ï¼ˆRSSï¼‰ SR-IOVï¼ˆè™šæ‹ŸåŒ–ï¼‰ å…¸å‹é…ç½®\nä¸šåŠ¡ç½‘ å­˜å‚¨ç½‘ ç®¡ç†ç½‘ï¼ˆBMCï¼‰ 6ï¸âƒ£ ç”µæºï¼ˆPSUï¼‰ å†—ä½™ç”µæºï¼ˆ1+1ï¼‰ 80 PLUS Platinum / Titanium åŠŸç‡å†—ä½™ â‰¥ 30% 7ï¸âƒ£ æ•£çƒ­ é£é“è®¾è®¡ï¼ˆå‰è¿›åå‡ºï¼‰ é£æ‰‡å†—ä½™ æœºæˆ¿æ¸©åº¦ \u0026lt; 27â„ƒ ä¸‰ã€æœåŠ¡å™¨å½¢æ€ ç±»å‹ ç‰¹ç‚¹ ä½¿ç”¨åœºæ™¯ å¡”å¼ å®‰é™ åŠå…¬å®¤ 1U å¯†åº¦é«˜ Web 2U æ‰©å±•å¼º DB / è™šæ‹ŸåŒ– åˆ€ç‰‡ é›†ä¸­ç®¡ç† å¤§å‹ IDC å››ã€ä¸åŒä¸šåŠ¡çš„æ¨èé…ç½® Web / API\nCPUï¼šé«˜ä¸»é¢‘ å†…å­˜ï¼š16â€“64G ç£ç›˜ï¼šNVMe ç½‘ç»œï¼š10G æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰\nCPUï¼šå¤šæ ¸ + å¤§ç¼“å­˜ å†…å­˜ï¼š128G+ ç£ç›˜ï¼šNVMe + RAID10 NUMA ç»‘å®š K8S / è™šæ‹ŸåŒ–\nCPUï¼šæ ¸å¿ƒæ•°ä¼˜å…ˆ å†…å­˜ï¼šå¤§ ç½‘ç»œï¼šåŒ 10G æ”¯æŒ VT-x / IOMMU äº”ã€å¸¸è§ç¡¬ä»¶é—®é¢˜æ’æŸ¥æ–¹å‘\næ€§èƒ½ä½ -\u0026gt; CPU é¢‘ç‡ / NUMA IO æ…¢ -\u0026gt; RAID / ç£ç›˜é˜Ÿåˆ— éšæœºé‡å¯ -\u0026gt; ç”µæº / å†…å­˜ ECC ç½‘ç»œæŠ–åŠ¨ -\u0026gt; ç½‘å¡é˜Ÿåˆ— / é©±åŠ¨ ","description":" ä¸€ã€æœåŠ¡å™¨ç¡¬ä»¶æ•´ä½“æ¶æ„ CPU â”œâ”€ å†…å­˜ï¼ˆRAMï¼‰ â”œâ”€ ä¸»æ¿ / èŠ¯ç‰‡ç»„ â”‚ â”œâ”€ PCIe â”‚ â”œâ”€ SATA / SAS / NVMe â”‚ â””â”€ BMCï¼ˆIPMIï¼‰ â”œâ”€ å­˜å‚¨ â”œâ”€ ç½‘ç»œ â”œâ”€ ç”µæº â””â”€ æ•£çƒ­ äºŒã€æ ¸å¿ƒéƒ¨ä»¶è¯¦è§£ 1ï¸âƒ£ CPUï¼ˆå¤„ç†å™¨ï¼‰ å…³é”®æŒ‡æ ‡\n"},{"id":495,"href":"/operations/linux/check-if-ssd/","title":"æ£€æŸ¥ç¡¬ç›˜æ˜¯ SSD è¿˜æ˜¯ HDD","parent":"Linux","content":" æ–¹æ³•ä¸€ï¼šä½¿ç”¨ lsblk (æ¨è) lsblk -d -o name,rota ç»“æœè§£é‡Š: ROTA åˆ—ï¼Œ0 è¡¨ç¤º SSDï¼ˆéæ—‹è½¬ï¼‰ï¼Œ1 è¡¨ç¤º HDDï¼ˆæ—‹è½¬ï¼‰ã€‚\næ–¹æ³•äºŒï¼šæ£€æŸ¥ /sys ç›®å½• cat /sys/block/\u0026lt;è®¾å¤‡å\u0026gt;/queue/rotational ç¤ºä¾‹: cat /sys/block/sda/queue/rotational.\nç»“æœè§£é‡Š: è¿”å› 0 æ˜¯ SSDï¼Œ1 æ˜¯ HDDã€‚\næ–¹æ³•ä¸‰ï¼šä½¿ç”¨ smartctl å®‰è£…: sudo apt install smartmontools (Debian/Ubuntu) æˆ– sudo yum install smartmontools (RHEL/CentOS).\nå‘½ä»¤: sudo smartctl -a /dev/\u0026lt;è®¾å¤‡å\u0026gt;\nç»“æœè§£é‡Š: æŸ¥æ‰¾è¾“å‡ºä¸­åŒ…å« \u0026ldquo;Rotation Rate: Solid State Device\u0026rdquo; çš„è¡Œï¼Œè¡¨ç¤º SSDã€‚\næ–¹æ³•å››ï¼šä½¿ç”¨ fdisk (é—´æ¥åˆ¤æ–­) sudo fdisk -l /dev/\u0026lt;è®¾å¤‡å\u0026gt; ç»“æœè§£é‡Š: å¦‚æœè¾“å‡ºä¸­æœ‰ \u0026ldquo;heads\u0026rdquo;ã€\u0026ldquo;sectors/track\u0026rdquo;ã€\u0026ldquo;cylinders\u0026rdquo; ç­‰ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯ HDDï¼›è‹¥æ²¡æœ‰æˆ–æ˜¾ç¤º \u0026ldquo;Disk identifier\u0026rdquo; ä»¥å¤–çš„è¯¦ç»†æœºæ¢°å‚æ•°ï¼Œåˆ™æ›´å¯èƒ½æ˜¯ SSDã€‚ æ³¨æ„: è¯·å°†å‘½ä»¤ä¸­çš„ \u0026lt;è®¾å¤‡å\u0026gt; æ›¿æ¢ä¸ºå®é™…çš„ç¡¬ç›˜è®¾å¤‡åï¼Œå¦‚ sda, sdb, nvme0n1 ç­‰ã€‚\n","description":" æ–¹æ³•ä¸€ï¼šä½¿ç”¨ lsblk (æ¨è) lsblk -d -o name,rota ç»“æœè§£é‡Š: ROTA åˆ—ï¼Œ0 è¡¨ç¤º SSDï¼ˆéæ—‹è½¬ï¼‰ï¼Œ1 è¡¨ç¤º HDDï¼ˆæ—‹è½¬ï¼‰ã€‚\næ–¹æ³•äºŒï¼šæ£€æŸ¥ /sys ç›®å½• cat /sys/block/\u0026lt;è®¾å¤‡å\u0026gt;/queue/rotational ç¤ºä¾‹: cat /sys/block/sda/queue/rotational.\nç»“æœè§£é‡Š: è¿”å› 0 æ˜¯ SSDï¼Œ1 æ˜¯ HDDã€‚\næ–¹æ³•ä¸‰ï¼šä½¿ç”¨ smartctl å®‰è£…: sudo apt install smartmontools (Debian/Ubuntu) æˆ– sudo yum install smartmontools (RHEL/CentOS).\n"},{"id":496,"href":"/operations/linux/check-disk-speed/","title":"æ£€æŸ¥ç¡¬ç›˜è¯»å†™é€Ÿåº¦","parent":"Linux","content":"Linux æ£€æŸ¥ç¡¬ç›˜è¯»å†™é€Ÿåº¦ä¸»è¦ä½¿ç”¨ ddï¼ˆç®€æ˜“æµ‹è¯•ï¼‰ã€fioï¼ˆä¸“ä¸šæµ‹è¯•ï¼‰ã€hdparmï¼ˆè¯»å–æµ‹è¯•ï¼‰åŠ iostatï¼ˆå®æ—¶ç›‘æ§ï¼‰å‘½ä»¤ã€‚dd é€‚åˆå¿«é€Ÿè¯„ä¼°ï¼Œfio é€‚ç”¨å¤æ‚éšæœºè¯»å†™ï¼Œhdparm ç”¨äºæŸ¥çœ‹ç¼“å­˜è¯»å–é€Ÿåº¦ï¼Œå¸¸ç”¨æŒ‡æ ‡ä¸º MB/s å’Œ IOPSã€‚\nä½¿ç”¨ dd å‘½ä»¤ï¼ˆç®€å•ã€ç›´è§‚ï¼‰ dd æ˜¯æœ€å¸¸ç”¨çš„æµ‹è¯•å·¥å…·ï¼Œé€šè¿‡è¯»å–æˆ–å†™å…¥ç‰¹å®šå¤§å°çš„æ•°æ®å—æ¥è®¡ç®—é€Ÿåº¦ã€‚\noflag=direct å¯è·³è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™å…¥ç¡¬ç›˜ï¼Œåæ˜ æ›´çœŸå®ã€‚\nè¿›å…¥ä¸´æ—¶ç›®å½•\ncd /tmp æµ‹è¯•å†™å…¥é€Ÿåº¦ (æµ‹è¯•ç¡¬ç›˜å†™èƒ½åŠ›) è¯¥å‘½ä»¤åˆ›å»ºä¸€ä¸ª 1GB çš„æ–‡ä»¶å¹¶æµ‹è¯•å†™å…¥é€Ÿåº¦ã€‚\ndd if=/dev/zero of=testfile bs=1G count=1 oflag=direct æ™®é€šæœºæ¢°ç¡¬ç›˜çš„å†™å…¥é€Ÿåº¦è‡³å°‘åœ¨ 100MB/s ä»¥ä¸Šã€‚\næµ‹è¯•è¯»å–é€Ÿåº¦ (æµ‹è¯•ç¡¬ç›˜è¯»èƒ½åŠ›) è¯¥å‘½ä»¤è¯»å–åˆšåˆ›å»ºçš„æ–‡ä»¶ï¼Œæµ‹è¯•è¯»å–é€Ÿåº¦ã€‚\ndd if=testfile of=/dev/null bs=1G count=1 iflag=direct æ™®é€šæœºæ¢°ç¡¬ç›˜çš„è¯»å–é€Ÿåº¦è‡³å°‘åœ¨ 100MB/s ä»¥ä¸Šã€‚\næµ‹è¯•åŒæ—¶è¯»å†™é€Ÿåº¦ dd if=testfile of=testfile1 bs=1M count=1024 æ™®é€šæœºæ¢°ç¡¬ç›˜çš„è¯»å†™é€Ÿåº¦è‡³å°‘åœ¨ 50MB/s ä»¥ä¸Šã€‚\n","description":"Linux æ£€æŸ¥ç¡¬ç›˜è¯»å†™é€Ÿåº¦ä¸»è¦ä½¿ç”¨ ddï¼ˆç®€æ˜“æµ‹è¯•ï¼‰ã€fioï¼ˆä¸“ä¸šæµ‹è¯•ï¼‰ã€hdparmï¼ˆè¯»å–æµ‹è¯•ï¼‰åŠ iostatï¼ˆå®æ—¶ç›‘æ§ï¼‰å‘½ä»¤ã€‚dd é€‚åˆå¿«é€Ÿè¯„ä¼°ï¼Œfio é€‚ç”¨å¤æ‚éšæœºè¯»å†™ï¼Œhdparm ç”¨äºæŸ¥çœ‹ç¼“å­˜è¯»å–é€Ÿåº¦ï¼Œå¸¸ç”¨æŒ‡æ ‡ä¸º MB/s å’Œ IOPSã€‚\nä½¿ç”¨ dd å‘½ä»¤ï¼ˆç®€å•ã€ç›´è§‚ï¼‰ dd æ˜¯æœ€å¸¸ç”¨çš„æµ‹è¯•å·¥å…·ï¼Œé€šè¿‡è¯»å–æˆ–å†™å…¥ç‰¹å®šå¤§å°çš„æ•°æ®å—æ¥è®¡ç®—é€Ÿåº¦ã€‚\noflag=direct å¯è·³è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™å…¥ç¡¬ç›˜ï¼Œåæ˜ æ›´çœŸå®ã€‚\nè¿›å…¥ä¸´æ—¶ç›®å½•\ncd /tmp æµ‹è¯•å†™å…¥é€Ÿåº¦ (æµ‹è¯•ç¡¬ç›˜å†™èƒ½åŠ›) è¯¥å‘½ä»¤åˆ›å»ºä¸€ä¸ª 1GB çš„æ–‡ä»¶å¹¶æµ‹è¯•å†™å…¥é€Ÿåº¦ã€‚\ndd if=/dev/zero of=testfile bs=1G count=1 oflag=direct æ™®é€šæœºæ¢°ç¡¬ç›˜çš„å†™å…¥é€Ÿåº¦è‡³å°‘åœ¨ 100MB/s ä»¥ä¸Šã€‚\næµ‹è¯•è¯»å–é€Ÿåº¦ (æµ‹è¯•ç¡¬ç›˜è¯»èƒ½åŠ›) è¯¥å‘½ä»¤è¯»å–åˆšåˆ›å»ºçš„æ–‡ä»¶ï¼Œæµ‹è¯•è¯»å–é€Ÿåº¦ã€‚\n"},{"id":497,"href":"/operations/summary-of-knowledge-points/","title":"çŸ¥è¯†ç‚¹æ€»ç»“","parent":"Operations","content":"å…ˆåŸç†ï¼Œååº”ç”¨ã€‚\nç›®å½•ï¼š\nç¡¬ä»¶ Linux ç³»ç»Ÿ è™šæ‹ŸåŒ– å®¹å™¨ä¸å®¹å™¨ç¼–æ’ Docker Kubernetes é…ç½®ç®¡ç†ä¸è‡ªåŠ¨åŒ–è¿ç»´ Ansible CI / CD ä¸ä»£ç ç®¡ç† Git GitLab Jenkins æ—¥å¿—ã€æœç´¢ä¸åˆ†æ ElasticSearch æ¶ˆæ¯é˜Ÿåˆ—ä¸æµå¤„ç† Kafka è´Ÿè½½å‡è¡¡ä¸æµé‡è°ƒåº¦ LVS Nginx æ•°æ®åº“ä¸æ•°æ®å­˜å‚¨ MySQL PostgreSQL MongoDB Redis æ–‡ä»¶ä¼ è¾“ä¸æ•°æ®åŒæ­¥ FTP rsync ç›‘æ§ä¸å‘Šè­¦ Zabbix Prometheus å‘å¸ƒç³»ç»Ÿ æ»šåŠ¨å‘å¸ƒ è“ç»¿å‘å¸ƒ é‡‘ä¸é›€å‘å¸ƒ æ€»è§ˆï¼šä»ç¡¬ä»¶åˆ°å®¹å™¨çš„åˆ†å±‚\n+-------------------------------------------------------------------+ åº”ç”¨ç¨‹åº / æœåŠ¡ MySQL / Nginx / Redis / Java / Python +-------------------------------------------------------------------+ å®¹å™¨å¹³å° (å¯é€‰) Docker / containerd / Podman / Kubernetes +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´ï¼šå®¹å™¨è¿è¡Œæ—¶ runc +-------------------------------------------------------------------+ Linux ç”¨æˆ·ç©ºé—´ï¼šåŸºç¡€ç»„ä»¶ shell / libc / systemd / coreutils +-------------------------------------------------------------------+ Linux å†…æ ¸ç©ºé—´ - äº”å¤§å­ç³»ç»Ÿï¼šè¿›ç¨‹ç®¡ç† / å†…å­˜ç®¡ç† / æ–‡ä»¶ç³»ç»Ÿ / ç½‘ç»œå­ç³»ç»Ÿ / è®¾å¤‡ä¸é©±åŠ¨ - å¢å¼ºæœºåˆ¶ï¼šNamespaces / cgroups / UnionFS +-------------------------------------------------------------------+ ç¡¬ä»¶å±‚ CPU / å†…å­˜ / ç¡¬ç›˜ / ç½‘å¡ +-------------------------------------------------------------------+ ç¡¬ä»¶ ç¡¬ä»¶æ˜¯ä¸€åˆ‡èµ„æºçš„æºå¤´ã€‚\nä¸»è¦åŒ…æ‹¬ï¼šCPUã€å†…å­˜ã€ç¡¬ç›˜ã€ä¸»æ¿ã€ç½‘å¡ã€æ˜¾å¡ã€é˜µåˆ—å¡ã€ç”µæºã€æœºç®±\nCPU å®¶ç”¨ï¼šå¥”è…¾ï¼Œé…·ç¿ï¼Œæ ¸å¿ƒæ•°å°‘ï¼Œä¸»é¢‘é«˜ï¼Œç¼“å­˜å°ï¼Œè¿½æ±‚â€œå¿«â€ æœåŠ¡å™¨ï¼šè‡³å¼ºï¼Œæ ¸å¿ƒæ•°å¤šï¼Œä¸»é¢‘ä½ï¼Œç¼“å­˜å¤§ï¼Œè¿½æ±‚â€œç¨³ + å¹¶å‘â€ è™šæ‹ŸåŒ–ï¼šå®¶ç”¨å’ŒæœåŠ¡å™¨CPUç°åœ¨åŸºæœ¬éƒ½æ”¯æŒè™šæ‹ŸåŒ– å†…å­˜ æœåŠ¡å™¨ï¼šæ”¯æŒ ECC æ ¡éªŒ å’Œ å¤šé€šé“ ECC æ˜¯æœåŠ¡å™¨çš„çµé­‚ï¼ˆé˜²æ­¢å†…å­˜ç¿»è½¬å¯¼è‡´æ•°æ®åº“æŸåï¼‰ ç¡¬ç›˜ å®¶ç”¨ï¼šSATAæ¥å£ï¼Œ7200è½¬ï¼Œè¯»å†™é€Ÿåº¦80M/så·¦å³ï¼Œ æœåŠ¡å™¨ï¼šSASæ¥å£ï¼Œ15000è½¬ï¼Œè¯»å†™é€Ÿåº¦150M/s å·¦å³ SSDï¼šç°åœ¨åŸºæœ¬éƒ½æ”¯æŒ NVMe ä¸»æ¿ å®¶ç”¨ï¼šä¸€å—CPUï¼Œ2åˆ°4æ ¹å†…å­˜ï¼Œ2åˆ°4å—ç¡¬ç›˜ æœåŠ¡å™¨ï¼šæ”¯æŒæ›´å¤šçš„CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œæ”¯æŒç¡¬ç›˜çƒ­æ’æ‹” ç½‘å¡ å®¶ç”¨ï¼š1G æœåŠ¡å™¨ï¼š10G æ˜¾å¡ PCI-E æ’æ§½ é˜µåˆ—å¡ RAIDï¼š0ï¼Œ1ï¼Œ5ï¼Œ10 ç”µæº å®¶ç”¨ï¼šå•ç”µæº æœåŠ¡å™¨ï¼šåŒç”µæºï¼ˆå†—ä½™ï¼‰ æœºç®± å¡”å¼æœºç®± æœºæ¶å¼æœºç®±ï¼š1Uã€2Uã€4U åˆ€ç‰‡æœºç®± æœåŠ¡å™¨ä¸»æœºæœ‰æ›´å¥½çš„æ‰©å±•æ€§å’Œç¨³å®šæ€§ã€‚\nLinux ç³»ç»Ÿ Linux ç³»ç»Ÿä¸»è¦ç”± å†…æ ¸ç©ºé—´ + ç”¨æˆ·ç©ºé—´ + åº”ç”¨ç¨‹åº ç»„æˆã€‚\nå†…æ ¸ç©ºé—´ å†…æ ¸ç©ºé—´æ˜¯èµ„æºçš„â€œç®¡ç†è€…â€ï¼Œæ˜¯ Linux ç³»ç»Ÿçš„æ ¹åŸºã€‚\nå†…æ ¸ç©ºé—´åŒ…æ‹¬ï¼šäº”å¤§æ ¸å¿ƒå­ç³»ç»Ÿ\nè¿›ç¨‹ç®¡ç† å†…å­˜ç®¡ç† æ–‡ä»¶ç³»ç»Ÿ ç½‘ç»œå­ç³»ç»Ÿ è®¾å¤‡ä¸é©±åŠ¨ è¿›ç¨‹ç®¡ç† è´Ÿè´£å¤„ç†è¿›ç¨‹çš„åˆ›å»ºã€è°ƒåº¦ã€ç»ˆæ­¢ä»¥åŠè¿›ç¨‹é—´é€šä¿¡ç­‰ç­‰ã€‚\nå†³å®šâ€œå“ªä¸ªç¨‹åºåœ¨ä»€ä¹ˆæ—¶å€™ç”¨ CPU è·‘å¤šä¹…â€ã€‚\nå†…å­˜ç®¡ç† è´Ÿè´£ç®¡ç†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚\nå†³å®šâ€œå†…å­˜æ€ä¹ˆåˆ†é…ã€æ€ä¹ˆå›æ”¶ã€æ€ä¹ˆæ˜ å°„â€ã€‚\næ–‡ä»¶ç³»ç»Ÿ è´Ÿè´£æä¾›å¯¹å­˜å‚¨è®¾å¤‡ä¸Šæ•°æ®çš„ç»„ç»‡ã€å­˜å‚¨å’Œè®¿é—®èƒ½åŠ›ã€‚\nç»Ÿä¸€â€œæ–‡ä»¶â€è¿™ä¸€æŠ½è±¡ï¼Œè®©ç¨‹åºä¸å…³å¿ƒåº•å±‚å­˜å‚¨ã€‚\nå¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæœ‰ï¼šxfsã€ext4ï¼Œç°åœ¨æœ€å¸¸ç”¨çš„æ˜¯ xfsã€‚\nç½‘ç»œå­ç³»ç»Ÿ è´Ÿè´£å®ç°å„ç§ç½‘ç»œåè®®ï¼ŒåŒ…æ‹¬ TCP/IP åè®®æ ˆï¼ŒSocketï¼ŒNetfilterï¼Œä½¿ Linux èƒ½å¤Ÿè¿›è¡Œç½‘ç»œé€šä¿¡ã€‚\nè´Ÿè´£â€œæ•°æ®åŒ…å¦‚ä½•è¿›å…¥ã€å¤„ç†ã€å‘é€å‡ºç³»ç»Ÿâ€ã€‚\nè®¾å¤‡ä¸é©±åŠ¨ è´Ÿè´£å……å½“ç¡¬ä»¶ä¸è½¯ä»¶ä¹‹é—´çš„æ¥å£ï¼Œæ˜¯å†…æ ¸ä¸ç¡¬ä»¶è®¾å¤‡é€šä¿¡çš„æ¡¥æ¢ã€‚\nLinux å†…æ ¸å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶ Linux å†…æ ¸\né€šè¿‡è°ƒåº¦å™¨ä½¿ç”¨ CPU é€šè¿‡å†…å­˜ç®¡ç†å­ç³»ç»Ÿç®¡ç†å†…å­˜ é€šè¿‡å—å±‚ä¸æ–‡ä»¶ç³»ç»Ÿè®¿é—®ç¡¬ç›˜ é€šè¿‡ç½‘ç»œåè®®æ ˆé©±åŠ¨ç½‘å¡ å®ç°å¯¹ç¡¬ä»¶èµ„æºçš„ç»Ÿä¸€æŠ½è±¡ä¸é«˜æ•ˆè°ƒåº¦ã€‚\nå†…æ ¸å¢å¼ºæœºåˆ¶ ä¸æ˜¯å­ç³»ç»Ÿ\nç›®å‰æœ€å¸¸è§çš„ä¸‰ä¸ªï¼Œä¹Ÿæ˜¯å®¹å™¨çš„åŸºçŸ³ï¼šNamespacesã€cgroupsã€UnionFS\nNamespaces (éš”ç¦»è§†å›¾)ï¼šå†³å®šâ€œä½ çœ‹åˆ°ä»€ä¹ˆâ€ï¼Œéš”ç¦»å¯¹è±¡ï¼šPIDã€ç½‘ç»œã€æŒ‚è½½ã€ç”¨æˆ· cgroups (èµ„æºé™åˆ¶)ï¼šå†³å®šâ€œä½ èƒ½ç”¨å¤šå°‘â€ï¼Œèµ„æºï¼šCPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œ UnionFS (è”åˆæ–‡ä»¶ç³»ç»Ÿ)ï¼šæ–‡ä»¶ç³»ç»Ÿå­ç³»ç»Ÿå†…éƒ¨æœºåˆ¶ï¼Œæ–‡ä»¶ç³»ç»Ÿå±‚å ï¼Œåªè¯»é•œåƒ + å¯å†™å±‚ï¼ŒUnionFS æ˜¯ â€œè®¾è®¡æ€æƒ³â€ï¼Œoverlay2 æ˜¯ â€œå…·ä½“å®ç°â€ ç”¨æˆ·ç©ºé—´ ç”¨æˆ·ç©ºé—´çš„å‡ ä¸ªé‡è¦ç»„æˆï¼šshellï¼Œlibcï¼Œsystemdï¼Œrunc ç­‰ç­‰ã€‚\nshell è´Ÿè´£ ç”¨æˆ·å’Œå†…æ ¸ä»¥åŠåº”ç”¨ç¨‹åºç­‰ä¹‹é—´è¿›è¡Œäº¤äº’ï¼Œæ˜¯ä¸€ä¸ªæ¡¥æ¢ã€‚\næœ¬è´¨æ˜¯ä¸€ä¸ªæ™®é€šè¿›ç¨‹ï¼Œç”¨äº è§£æå‘½ä»¤ï¼Œç®¡ç†è¿›ç¨‹ï¼Œæ§åˆ¶ IOï¼Œåè°ƒç¨‹åºè¿è¡Œ ç­‰ å¸¸è§çš„ shellï¼šBash libc è´Ÿè´£ ç³»ç»Ÿè°ƒç”¨å°è£…ï¼Œæä¾›æ ‡å‡† C æ¥å£ã€‚\nåº”ç”¨ç¨‹åº ä¸ç›´æ¥è°ƒç”¨å†…æ ¸ï¼Œè€Œæ˜¯é€šè¿‡ libcã€‚ å¸¸è§çš„ libcï¼šglibc å’Œ muslã€‚ systemd è´Ÿè´£ ç³»ç»Ÿåˆå§‹åŒ–ï¼ŒæœåŠ¡ç®¡ç†ï¼Œcgroups ç®¡ç†ã€‚\nsystemd ä¸æ˜¯â€œå¯åŠ¨è„šæœ¬å·¥å…·â€ï¼Œæ˜¯ ç³»ç»Ÿçº§è¿›ç¨‹ç¼–æ’å™¨ã€‚ runc è´Ÿè´£ æŠŠ namespacesã€cgroups ç­‰é…ç½®ï¼Œè½¬åŒ–ä¸ºä¸€ä¸ªçœŸæ­£è¿è¡Œä¸­çš„ Linux è¿›ç¨‹ã€‚\nrunc æ˜¯ å®¹å™¨è¿è¡Œæ—¶ï¼ŒDockerã€Podman ç­‰ç­‰ï¼Œåº•å±‚éƒ½ä½¿ç”¨çš„æ˜¯ runcã€‚ åº”ç”¨ç¨‹åº åŒ…æ‹¬ Dockerã€Nginxã€MySQLã€Redisã€Javaã€Python ç­‰ã€‚\nLinux ç³»ç»Ÿæ•´ä½“è§’è‰² Linux ç³»ç»Ÿ = å†…æ ¸ + ç”¨æˆ·ç©ºé—´å·¥å…· + æœåŠ¡ç®¡ç† + é…ç½®ä½“ç³»\nå®ƒçš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š\nç®¡ç†ç¡¬ä»¶ æä¾›ç¨³å®šæ¥å£ æ”¯æ’‘åº”ç”¨ç¨‹åºè¿è¡Œ Linux ç³»ç»Ÿå¸¸è§çš„æœ‰ RHELç³»åˆ— å’Œ Debianç³»åˆ—ã€‚\nè¿™ä¸¤ä¸ªç³»åˆ—æœ€å¤§çš„åŒºåˆ«çš„æ˜¯åŒ…ç®¡ç†æ–¹å¼ä¸åŒï¼šRHELç³»åˆ—ä½¿ç”¨ RPM åŒ…ç®¡ç†ï¼ŒDebianç³»åˆ—ä½¿ç”¨ DEB åŒ…ç®¡ç†ã€‚\näº”å¤§å­ç³»ç»Ÿå¦‚ä½•ååŒ ä»¥ MySQL ä¸€æ¬¡æŸ¥è¯¢ ä¸ºä¾‹ï¼š\nMySQL è¿›ç¨‹ â†“ è¿›ç¨‹è°ƒåº¦ï¼ˆCPU æ—¶é—´ç‰‡ï¼‰ â†“ å†…å­˜ç®¡ç†ï¼ˆBuffer Pool / Page Cacheï¼‰ â†“ æ–‡ä»¶ç³»ç»Ÿï¼ˆVFS -\u0026gt; ext4 / xfsï¼‰ â†“ å—è®¾å¤‡å±‚ â†“ è®¾å¤‡é©±åŠ¨ï¼ˆNVMe / SATAï¼‰ â†“ ç¡¬ä»¶ ç½‘ç»œè¯·æ±‚åˆ™ä¼šå¤šèµ°ä¸€æ¡ï¼š\nç½‘å¡ -\u0026gt; é©±åŠ¨ -\u0026gt; ç½‘ç»œæ ˆ -\u0026gt; Socket -\u0026gt; MySQL åŸºäº ç¡¬ä»¶ å’Œ Linux ç³»ç»Ÿä¹‹ä¸Šï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼šè™šæ‹ŸåŒ–\nè™šæ‹ŸåŒ– è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰ æ˜¯æŠŠä¸€å¥—ç‰©ç†èµ„æºï¼ˆCPU / å†…å­˜ / ç£ç›˜ / ç½‘ç»œï¼‰æŠ½è±¡æˆå¤šå¥—é€»è¾‘èµ„æºï¼Œè®©å¤šå¥—ç³»ç»Ÿæˆ–åº”ç”¨ç›¸äº’éš”ç¦»ã€åŒæ—¶è¿è¡Œçš„æŠ€æœ¯ã€‚\nè™šæ‹ŸåŒ–çš„æœ¬è´¨ åœ¨ä¸å¢åŠ ç‰©ç†æœºå™¨çš„å‰æä¸‹ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ã€éš”ç¦»æ€§å’Œå¯ç®¡ç†æ€§ã€‚\nè™šæ‹ŸåŒ–åŒ…æ‹¬ï¼šç¡¬ä»¶è™šæ‹ŸåŒ–ã€æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ã€ç½‘ç»œè™šæ‹ŸåŒ–ã€å­˜å‚¨è™šæ‹ŸåŒ–\nç¡¬ä»¶è™šæ‹ŸåŒ– ä¹Ÿå°±æ˜¯è™šæ‹Ÿæœº\næœ¬è´¨ï¼šè™šæ‹Ÿæœºé€šè¿‡è™šæ‹ŸåŒ–ç¡¬ä»¶å¹¶è¿è¡Œå®Œæ•´æ“ä½œç³»ç»Ÿï¼Œåœ¨åŒä¸€ç‰©ç†ä¸»æœºä¸Šå®ç°å¼ºéš”ç¦»çš„å¤šç³»ç»Ÿè¿è¡Œã€‚\næ¯ä¸ªè™šæ‹Ÿæœºéƒ½æœ‰è‡ªå·±çš„å†…æ ¸ï¼Œèµ„æºéš”ç¦»é ç¡¬ä»¶è™šæ‹ŸåŒ–\nå¸¸è§åº”ç”¨\nESXi KVM XEN VirtualBox VMware Workstation æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ– ä¹Ÿå°±æ˜¯å®¹å™¨\næœ¬è´¨ï¼šé€šè¿‡å†…æ ¸çº§éš”ç¦»ä¸èµ„æºé™åˆ¶ï¼Œåœ¨å…±äº«åŒä¸€å†…æ ¸çš„å‰æä¸‹è¿è¡Œå½¼æ­¤éš”ç¦»çš„è¿›ç¨‹ç¯å¢ƒã€‚\nå®¹å™¨åŒ–ï¼šä¸è™šæ‹Ÿå†…æ ¸ï¼Œåªè™šæ‹Ÿâ€œä½¿ç”¨æ–¹å¼â€\nå¸¸è§åº”ç”¨\nDocker Podman Kubernetes ç½‘ç»œè™šæ‹ŸåŒ– æŠŠç‰©ç†ç½‘ç»œæŠ½è±¡æˆé€»è¾‘ç½‘ç»œ\nVLAN Kubernetes CNI å­˜å‚¨è™šæ‹ŸåŒ– å¤šå—ç‰©ç†ç›˜ -\u0026gt; ç»Ÿä¸€é€»è¾‘å­˜å‚¨æ± \nLVM Ceph SAN / NAS å®¹å™¨ä¸å®¹å™¨ç¼–æ’ Docker å®šä½ï¼šåº”ç”¨å®¹å™¨åŒ–è¿è¡Œæ—¶ï¼Œç”¨äºæ„å»ºã€æ‰“åŒ…å’Œè¿è¡Œå®¹å™¨ã€‚\nDocker = åˆ©ç”¨ Linux å†…æ ¸èƒ½åŠ›ï¼ˆNamespace + cgroups + UnionFSï¼‰ï¼Œ æŠŠåº”ç”¨è¿›ç¨‹â€œéš”ç¦»ã€é™åˆ¶ã€æ‰“åŒ…ã€åˆ†å‘ã€è¿è¡Œâ€çš„ä¸€æ•´å¥—å·¥ç¨‹ä½“ç³»ã€‚\nDocker æœ¬è´¨æ˜¯Â è¿›ç¨‹ç®¡ç† + æ–‡ä»¶ç³»ç»ŸæŠ½è±¡\nDocker è§£å†³äº†ä»€ä¹ˆé—®é¢˜\nç¯å¢ƒä¸€è‡´æ€§ éƒ¨ç½²å¤æ‚åº¦ èµ„æºåˆ©ç”¨ç‡ å®¹å™¨çš„ä¸‰å¤§åº•å±‚åŸºçŸ³ï¼šNamespaceï¼Œcgroupsï¼ŒUnionFS\nNamespace \u0026mdash;- éš”ç¦»\nLinux å†…æ ¸æä¾›çš„ã€Œèµ„æºè§†å›¾éš”ç¦»æœºåˆ¶ã€ æœ¬è´¨ï¼šåŒä¸€å†…æ ¸ï¼Œä¸åŒè§†è§’ Namespace ç»‘å®šçš„æ˜¯ã€Œè¿›ç¨‹ã€ï¼ŒNamespace ä¸æ˜¯ç³»ç»Ÿçº§ï¼Œæ˜¯ è¿›ç¨‹å±æ€§ è¿›ç¨‹çœ‹åˆ°çš„æ˜¯â€œè‡ªå·±çš„â€ï¼šPID / ç½‘ç»œ / æŒ‚è½½ç‚¹ / ä¸»æœºå / ç”¨æˆ· å®¹å™¨ç”¨å®ƒï¼šè®©å®¹å™¨â€œåƒä¸€å°ç‹¬ç«‹ä¸»æœºâ€ cgroups \u0026mdash;- èµ„æºé™åˆ¶\nLinux å†…æ ¸çš„ã€Œèµ„æºé…é¢ä¸æ§åˆ¶ç³»ç»Ÿã€ Namespaceï¼šä½  èƒ½çœ‹åˆ°ä»€ä¹ˆ cgroupsï¼šä½  èƒ½ç”¨å¤šå°‘ é™åˆ¶ CPU / å†…å­˜ / IO / PIDs å®¹å™¨ = Namespace + cgroups å®¹å™¨ç”¨å®ƒï¼šæ§åˆ¶æ¯ä¸ªå®¹å™¨æœ€å¤šèƒ½ç”¨å¤šå°‘èµ„æº UnionFS \u0026mdash;- æ–‡ä»¶ç³»ç»Ÿåˆ†å±‚\næ˜¯ä¸€ç§â€œæŠŠå¤šä¸ªç›®å½•ï¼ˆåˆ†æ”¯ï¼‰å åŠ æˆä¸€ä¸ªç»Ÿä¸€è§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæœºåˆ¶ UnionFS æŠŠå¤šå±‚ç›®å½•å æˆä¸€å±‚ åº•å±‚ï¼šåªè¯»é•œåƒå±‚ ä¸Šå±‚ï¼šå¯å†™å±‚ å¯¹è¿›ç¨‹ï¼šçœ‹èµ·æ¥åªæœ‰ä¸€ä¸ªç›®å½•æ ‘ å®¹å™¨ç”¨å®ƒï¼šé•œåƒå¯å¤ç”¨ overlay2 æ˜¯ Linux åŸç”Ÿã€é«˜æ€§èƒ½çš„ UnionFS UnionFSï¼šä¸€ç±»â€œæŠŠå¤šå±‚ç›®å½•åˆå¹¶æˆä¸€ä¸ªè§†å›¾â€çš„æ–‡ä»¶ç³»ç»Ÿæ€æƒ³\noverlay2ï¼šåŸºäº Linux OverlayFS çš„ Docker å­˜å‚¨é©±åŠ¨å®ç°\nUnionFS æ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿçš„ç»Ÿç§°ï¼Œoverlay2 æ˜¯ Docker åŸºäº Linux OverlayFS å®ç°çš„ UnionFS å­˜å‚¨é©±åŠ¨ï¼Œä¹Ÿæ˜¯å½“å‰é»˜è®¤å’Œæœ€æ¨èçš„å®ç°ã€‚\noverlay2 ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ Docker ä½¿ç”¨ OverlayFS çš„æ–¹å¼ã€‚\nDocker å››å¤§æ ¸å¿ƒå¯¹è±¡\nImageï¼ˆé•œåƒï¼‰ï¼šåº”ç”¨çš„æ¨¡ç‰ˆï¼Œåªè¯»ï¼Œä¸å¯å˜ï¼Œåˆ†å±‚ Containerï¼ˆå®¹å™¨ï¼‰ï¼šé•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ª Linux è¿›ç¨‹ Dockerfileï¼šæ„å»ºé•œåƒçš„æ–‡ä»¶ï¼Œæè¿°â€œå¦‚ä½•æ„å»ºé•œåƒâ€ï¼Œæ¯æ¡æŒ‡ä»¤ -\u0026gt; ä¸€ä¸ªé•œåƒå±‚ Registryï¼šé•œåƒä»“åº“ï¼Œé•œåƒçš„åˆ†å‘ç³»ç»Ÿ Docker ç½‘ç»œçš„å››ä¸ªæ ¸å¿ƒç»„ä»¶\nNetwork Namespaceï¼ˆç½‘ç»œéš”ç¦»ï¼‰ veth pairï¼ˆè™šæ‹Ÿç½‘çº¿ï¼‰ Linux bridgeï¼ˆdocker0 iptables / NATï¼ˆåœ°å€è½¬æ¢ï¼‰ é»˜è®¤ bridge ç½‘ç»œ\n[container] --veth--\u0026gt; [docker0] --NAT--\u0026gt; [eth0] --\u0026gt; Internet å¤–éƒ¨ -\u0026gt; å®¹å™¨ï¼ˆç«¯å£æ˜ å°„åŸç†ï¼‰\nClient â†“ å®¿ä¸»æœº 8080 â†“ (DNAT) å®¹å™¨ 80 å®¹å™¨ -\u0026gt; å¤–éƒ¨ï¼ˆSNAT\ncontainer 172.17.0.2 â†“ docker0 â†“ (SNAT) å®¿ä¸»æœº IP â†“ Internet host ç½‘ç»œï¼šä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œæ ˆï¼Œå®¹å™¨ç«¯å£ = å®¿ä¸»æœºç«¯å£\nDockerfile\nFROM å®šä¹‰åŸºç¡€é•œåƒ, å¿…é¡»æ˜¯ç¬¬ä¸€æ¡ ARG æ„å»ºå‚æ•° ENV ç¯å¢ƒå˜é‡ RUN æ„å»ºæ—¶æ‰§è¡Œ COPY/ADD æ‹·è´æ–‡ä»¶, 90% åœºæ™¯ç”¨ COPY WORKDIR å·¥ä½œç›®å½• CMD å®¹å™¨å¯åŠ¨å‘½ä»¤ (docker run å¯ä»¥è¦†ç›–) ENTRYPOINT å…¥å£ç‚¹ (å›ºå®šå‘½ä»¤, docker run ä¸èƒ½è¦†ç›–) EXPOSE å£°æ˜ç«¯å£ VOLUME å£°æ˜æŒ‚è½½ç‚¹ USER ç”¨æˆ· å¯ä»¥å¤šé˜¶æ®µæ„å»º\nPodman å®šä½ï¼šæ— å®ˆæŠ¤è¿›ç¨‹çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå…¼å®¹ Docker CLIï¼Œå¼ºè°ƒå®‰å…¨æ€§ã€‚\nKubernetes å®šä½ï¼šå®¹å™¨ç¼–æ’ä¸é›†ç¾¤ç®¡ç†å¹³å°ï¼Œè´Ÿè´£å®¹å™¨çš„è°ƒåº¦ã€ä¼¸ç¼©ä¸é«˜å¯ç”¨ã€‚\nKubernetes è§£å†³çš„æ˜¯ï¼šå®¹å™¨çš„è‡ªåŠ¨éƒ¨ç½²ã€è°ƒåº¦ã€æ‰©ç¼©å®¹ã€è‡ªæ„ˆã€ç½‘ç»œã€å­˜å‚¨ã€å‡çº§\nKubernetes çš„æ•´ä½“æ¶æ„ +----------------------------+ | ç”¨æˆ· / kubectl | +-------------+--------------+ | +-------------v--------------+ | Control Plane | | apiserver / scheduler | | controller / etcd | +-------------+--------------+ | +-------------v--------------+ | Node | | kubelet / containerd | | kube-proxy / CNI | +----------------------------+ æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ etcdï¼šä¿å­˜ é›†ç¾¤æ‰€æœ‰çŠ¶æ€ kube-apiserverï¼šæ‰€æœ‰è¯·æ±‚å…¥å£ï¼Œè®¤è¯ã€é‰´æƒã€å‡†å…¥ï¼Œå”¯ä¸€å’Œ etcd é€šä¿¡çš„ç»„ä»¶ kube-schedulerï¼šä»»åŠ¡è°ƒåº¦ï¼Œç»™ Pod é€‰æ‹©è¿è¡Œçš„ Nodeï¼Œä¸åˆ›å»º Podï¼Œåªâ€œå†³ç­–â€ kube-controller-managerï¼šä¸€å †æ§åˆ¶å™¨çš„é›†åˆ kube-scheduler æµç¨‹ï¼ˆè°ƒåº¦æµç¨‹ï¼‰ï¼š\nFilterï¼ˆé¢„é€‰ï¼‰ï¼šè¿‡æ»¤èŠ‚ç‚¹ï¼Œèƒ½è·‘çš„èŠ‚ç‚¹ï¼Ÿï¼ˆèµ„æºã€æ±¡ç‚¹ã€äº²å’Œæ€§ï¼‰ Scoreï¼ˆæ‰“åˆ†ï¼‰ï¼šå“ªä¸ªèŠ‚ç‚¹æ›´é€‚åˆï¼Ÿ Bindï¼ˆç»‘å®šï¼‰ï¼šæŠŠ Pod æŒ‡å®šåˆ°èŠ‚ç‚¹ å·¥ä½œèŠ‚ç‚¹ï¼ˆNodeï¼‰ kubeletï¼šç®¡ç† Pod ç”Ÿå‘½å‘¨æœŸï¼Œä¸ kube-apiserver é€šä¿¡ kube-proxyï¼šæä¾›ç½‘ç»œä»£ç†ï¼Œå°† Pod çš„ Service æš´éœ²ä¸ºç½‘ç»œæœåŠ¡ container runtimeï¼šè¿è¡Œå®¹å™¨ CNIï¼šç½‘ç»œæ’ä»¶ æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆObject Modelï¼‰ Kubernetes ä¸€åˆ‡çš†èµ„æºï¼Œæ¯ä¸ªèµ„æºéƒ½æ˜¯ä¸€ä¸ª YAML å¯¹è±¡ Podï¼šæœ€å°è°ƒåº¦å•ä½ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„ç»„åˆ Workloadï¼šå·¥ä½œè´Ÿè½½ Deploymentï¼šæ— çŠ¶æ€åº”ç”¨ StatefulSetï¼šæœ‰çŠ¶æ€æœåŠ¡ DaemonSetï¼šæ¯èŠ‚ç‚¹ä¸€ä¸ª Jobï¼šä¸€æ¬¡æ€§ä»»åŠ¡ CronJobï¼šå®šæ—¶ä»»åŠ¡ Serviceï¼šæœåŠ¡ï¼Œè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆPod IP ä¼šå˜ï¼ŒPod ä¼šé‡å»ºï¼Œéœ€è¦ç»Ÿä¸€è®¿é—®å…¥å£ï¼‰ï¼ŒService æä¾›ï¼šè™šæ‹Ÿ IPï¼ˆVIPï¼‰ï¼ŒDNS åç§°ï¼Œè´Ÿè½½å‡è¡¡ Ingressï¼šä¸ƒå±‚æµé‡å…¥å£ï¼ŒHTTP/HTTPS è·¯ç”±ï¼ŒåŸŸåè½¬å‘ Ingress = è§„åˆ™ Ingress Controller = å®ç°è€…ï¼ˆNginx / Traefik è°ƒåº¦ä¸èµ„æºç®¡ç†ï¼ˆHowï¼‰ è°ƒåº¦ç›¸å…³æ¦‚å¿µï¼š\nNodeSelectorï¼šæœ€ç®€å•èŠ‚ç‚¹é€‰æ‹© NodeAffinityï¼šæ›´çµæ´»çš„èŠ‚ç‚¹äº²å’Œ PodAffinity / AntiAffinityï¼šPod ä¹‹é—´å…³ç³» Taint / Tolerationï¼š\næ±¡ç‚¹ Node æ‹’ç» Pod Pod å£°æ˜æˆ‘èƒ½å¿ èµ„æºç®¡ç†ï¼š\nrequestsï¼šå†³å®šè°ƒåº¦ limitsï¼šå†³å®šä¸Šé™ HPAï¼ˆè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰\nåŸºäº CPU / å†…å­˜ / è‡ªå®šä¹‰æŒ‡æ ‡ éœ€è¦ metrics-server å­˜å‚¨ï¼ˆPersistenceï¼‰ PVï¼šå®é™…å­˜å‚¨ PVCï¼šå­˜å‚¨ç”³è¯· StorageClassï¼šåŠ¨æ€åˆ›å»º Volume ç±»å‹\nemptyDir hostPath NFS CSIï¼ˆäº‘ç›˜ï¼‰ ç”Ÿå‘½å‘¨æœŸ \u0026amp; è‡ªæ„ˆ Pod ç”Ÿå‘½å‘¨æœŸ\nPending Running Succeeded Failed Unknown å®¹å™¨çŠ¶æ€ï¼š\nWaitingï¼ˆæ‹‰é•œåƒï¼‰ Running Terminatedï¼ˆé€€å‡ºç ï¼‰ æ¢é’ˆï¼š\nstartupProbe readinessProbe livenessProbe è‡ªæ„ˆæœºåˆ¶\nPod å´©æºƒ -\u0026gt; é‡å¯ Node æ‰çº¿ -\u0026gt; Pod æ¼‚ç§» å‰¯æœ¬ä¸è¶³ -\u0026gt; è‡ªåŠ¨è¡¥é½ ç½‘ç»œç»„ä»¶ Calicoï¼šç‰¹ç‚¹ï¼ˆé«˜æ€§èƒ½ã€BGPã€eBPFï¼‰ï¼ŒæŠ€æœ¯ï¼ˆè·¯ç”±ä¸ºä¸»ï¼‰ Flannelï¼šç‰¹ç‚¹ï¼ˆç®€å•ã€å…¼å®¹æ€§é«˜ï¼‰ï¼ŒæŠ€æœ¯ï¼ˆVXLANã€å°åŒ…ï¼‰ Ciliumï¼šç‰¹ç‚¹ï¼ˆeBPFã€L7ã€ç½‘ç»œå®‰å…¨ï¼‰ï¼ŒæŠ€æœ¯ï¼ˆeBPFï¼‰ å¦‚ä½•ä¼˜é›…å…³é—­ä¸€ä¸ª Podï¼Ÿ SIGTERMï¼ˆgrace periodï¼‰ readiness probe fail -\u0026gt; ä» LB ç§»é™¤ ç­‰å¾… preStop SIGKILLï¼ˆåˆ°è¾¾ timeoutï¼‰ æ•…éšœæ’æŸ¥ kubectl logs pod kubectl describe deployment/service/pod å‡çº§ æ›´æ–°åº”ç”¨ç¨‹åº ä¸‹è½½æ–°çš„é•œåƒ å‡çº§è®¡åˆ’ï¼škubeadm upgrade plan å‡çº§ï¼škubeadm upgrade apply é…ç½®ç®¡ç†ä¸è‡ªåŠ¨åŒ–è¿ç»´ Ansible Ansible æ˜¯ä¸€æ¬¾æ—  Agent çš„è‡ªåŠ¨åŒ–è¿ç»´ä¸é…ç½®ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ SSH å®ç°æ‰¹é‡éƒ¨ç½²å’Œç¯å¢ƒä¸€è‡´æ€§ã€‚\nå¸¸ç”¨å‘½ä»¤ï¼š\n# ping æ£€æµ‹ ansible all -m ping # æ‰¹é‡æ‰§è¡Œå‘½ä»¤ ansible all -m shell -a \u0026#34;ps aux | grep nginx\u0026#34; # åŒæ­¥æ–‡ä»¶ (æ‹‰å–) ansible all -m synchronize -a \u0026#34;src=/opt/file dest=/tmp/ mode=pull\u0026#34; # åŒæ­¥æ–‡ä»¶ (æ¨é€) ansible all -m synchronize -a \u0026#34;src=/opt/file dest=/tmp/ mode=push\u0026#34; shell å’Œ command çš„åŒºåˆ«ï¼š\ncommandï¼šé»˜è®¤ï¼Œä¸è§£æ shell shellï¼šå…è®¸ç®¡é“ã€é‡å®šå‘ CI / CD ä¸ä»£ç ç®¡ç† Git å®šä½ï¼šåˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç”¨äºæºä»£ç ç®¡ç†ã€‚\nGit å·¥ä½œåŒºã€æš‚å­˜åŒºã€ç‰ˆæœ¬åº“åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\nå·¥ä½œåŒºï¼ˆworking directoryï¼‰ï¼šä½ çš„ä»£ç æ‰€åœ¨ç›®å½•ã€‚ æš‚å­˜åŒºï¼ˆstage/indexï¼‰ï¼šgit add åè¿›å…¥çš„åŒºåŸŸã€‚ æœ¬åœ°ä»“åº“ï¼ˆrepositoryï¼‰ï¼š.git ç›®å½•ï¼Œå­˜å‚¨ commitã€tree å¯¹è±¡ã€‚ è¿œç¨‹ä»“åº“ï¼ˆoriginï¼‰ï¼šGitLab/GitHub ä¸Šçš„ä»“åº“ã€‚ æµç¨‹å›¾ï¼š\nå·¥ä½œåŒº -\u0026gt; git add -\u0026gt; æš‚å­˜åŒº -\u0026gt; git commit -\u0026gt; æœ¬åœ°åº“ -\u0026gt; git push -\u0026gt; è¿œç¨‹åº“ Git ä¸æ˜¯â€œæ–‡ä»¶å·®å¼‚ç³»ç»Ÿâ€ï¼Œæ˜¯ä¸€ä¸ª å†…å®¹å¯»å€ï¼ˆContent-addressableï¼‰çš„å¯¹è±¡æ•°æ®åº“ã€‚\nSVNï¼šå­˜â€œæ–‡ä»¶ + å·®å¼‚â€ Gitï¼šå­˜â€œå†…å®¹å¿«ç…§ + æŒ‡é’ˆâ€ åˆ†å¸ƒå¼æ˜¯â€œå®Œæ•´ä»“åº“å¤åˆ¶â€ï¼Œæ¯ä¸ª Git ä»“åº“éƒ½åŒ…å«ï¼š\nå®Œæ•´å†å² æ‰€æœ‰åˆ†æ”¯ æ‰€æœ‰å¯¹è±¡ Git ä»“åº“æœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°æ®åº“ï¼Œåªæœ‰ 4 ç§å¯¹è±¡ï¼š\nblob æ–‡ä»¶å†…å®¹ tree ç›®å½•ç»“æ„ commit ä¸€æ¬¡æäº¤ tag æ ‡ç­¾ï¼ˆæŒ‡å‘ commitï¼‰ HEAD çš„æœ¬è´¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰åˆ†æ”¯æˆ– commit\nåˆ†æ”¯ä¸æ˜¯æ‹·è´ï¼ŒGit åˆ†æ”¯çš„æœ¬è´¨æ˜¯ä¸€ä¸ª æŒ‡å‘ commit çš„å¯ç§»åŠ¨æŒ‡é’ˆ\nGitLab å®šä½ï¼šé›†æˆä»£ç ç®¡ç†ã€CI/CDã€Issue å’Œæƒé™æ§åˆ¶çš„ DevOps å¹³å°ã€‚\nGitLab æ˜¯ä¸€ä¸ª åŸºäº Git çš„ä»£ç æ‰˜ç®¡ + DevOps å¹³å°ï¼Œé›†æˆ ä»£ç ç®¡ç†ã€CI/CDã€Issueã€WIKIã€è‡ªåŠ¨åŒ–ã€å®‰å…¨æ‰«æã€éƒ¨ç½² ç­‰åŠŸèƒ½ã€‚\nGitLab Runner æ˜¯ä¸€ä¸ª ç‹¬ç«‹äº GitLab çš„ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä¸“é—¨ç”¨æ¥æ‰§è¡Œ .gitlab-ci.yml ä¸­çš„ jobã€‚\nGitLab Runner çš„å·¥ä½œåŸç†ï¼š\nGitLab CI -\u0026gt; è°ƒåº¦ job -\u0026gt; åˆ†é…ç»™ Runner -\u0026gt; Runner æ‰§è¡Œ -\u0026gt; ä¸Šä¼ ç»“æœ -\u0026gt; Pipeline å®Œæˆ Jenkins å®šä½ï¼šæŒç»­é›†æˆä¸æŒç»­äº¤ä»˜å·¥å…·ï¼Œè´Ÿè´£è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ä¸å‘å¸ƒã€‚\næ—¥å¿—ã€æœç´¢ä¸åˆ†æ ElasticSearch å®šä½ï¼šåˆ†å¸ƒå¼æœç´¢ä¸æ—¥å¿—åˆ†æå¼•æ“ï¼Œç”¨äºæ—¥å¿—æ£€ç´¢å’Œæ•°æ®åˆ†æã€‚\næ¶ˆæ¯é˜Ÿåˆ—ä¸æµå¤„ç† Kafka å®šä½ï¼šé«˜ååã€åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸æµå¤„ç†å¹³å°ï¼Œç”¨äºç³»ç»Ÿè§£è€¦å’Œå¼‚æ­¥é€šä¿¡ã€‚\nè´Ÿè½½å‡è¡¡ä¸æµé‡è°ƒåº¦ LVS å®šä½ï¼šå†…æ ¸çº§å››å±‚è´Ÿè½½å‡è¡¡ï¼Œç”¨äºé«˜æ€§èƒ½æµé‡åˆ†å‘ã€‚\nNginx å®šä½ï¼šé«˜æ€§èƒ½ Web æœåŠ¡å™¨ä¸ä¸ƒå±‚åå‘ä»£ç†ï¼Œå¸¸ç”¨äºè´Ÿè½½å‡è¡¡ä¸ç½‘å…³ã€‚\næ•°æ®åº“ä¸æ•°æ®å­˜å‚¨ MySQL å®šä½ï¼šå…³ç³»å‹æ•°æ®åº“ï¼Œå¹¿æ³›ç”¨äºä¸šåŠ¡æ•°æ®å­˜å‚¨ã€‚\nPostgreSQL å®šä½ï¼šé«˜çº§å…³ç³»å‹æ•°æ®åº“ï¼Œå¼ºè°ƒä¸€è‡´æ€§ã€æ‰©å±•æ€§å’Œå¤æ‚æŸ¥è¯¢èƒ½åŠ›ã€‚\nMongoDB å®šä½ï¼šæ–‡æ¡£å‹ NoSQL æ•°æ®åº“ï¼Œé€‚åˆéç»“æ„åŒ–å’ŒåŠç»“æ„åŒ–æ•°æ®ã€‚\nRedis å®šä½ï¼šå†…å­˜å‹æ•°æ®å­˜å‚¨ï¼Œå¸¸ç”¨äºç¼“å­˜ã€ä¼šè¯å’Œæ¶ˆæ¯åœºæ™¯ã€‚\næ–‡ä»¶ä¼ è¾“ä¸æ•°æ®åŒæ­¥ FTP å®šä½ï¼šä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“åè®®ï¼Œç”¨äºæ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½ã€‚\nrsync å®šä½ï¼šé«˜æ•ˆçš„æ•°æ®åŒæ­¥å·¥å…·ï¼Œæ”¯æŒå¢é‡ä¼ è¾“ä¸è¿œç¨‹å¤‡ä»½ã€‚\nç›‘æ§ä¸å‘Šè­¦ Zabbix å®šä½ï¼šä¼ ç»Ÿä¸€ä½“åŒ–ç›‘æ§ç³»ç»Ÿï¼Œæ“…é•¿ä¸»æœºã€ç½‘ç»œå’Œä¸­é—´ä»¶ç›‘æ§ã€‚\nPrometheus å®šä½ï¼šäº‘åŸç”Ÿç›‘æ§ä¸æ—¶åºæ•°æ®åº“ï¼Œå¼ºè°ƒæŒ‡æ ‡é‡‡é›†å’ŒæœåŠ¡ç›‘æ§ã€‚\n","description":"å…ˆåŸç†ï¼Œååº”ç”¨ã€‚\nç›®å½•ï¼š\nç¡¬ä»¶ Linux ç³»ç»Ÿ è™šæ‹ŸåŒ– å®¹å™¨ä¸å®¹å™¨ç¼–æ’ Docker Kubernetes é…ç½®ç®¡ç†ä¸è‡ªåŠ¨åŒ–è¿ç»´ Ansible CI / CD ä¸ä»£ç ç®¡ç† Git GitLab Jenkins æ—¥å¿—ã€æœç´¢ä¸åˆ†æ ElasticSearch æ¶ˆæ¯é˜Ÿåˆ—ä¸æµå¤„ç† Kafka è´Ÿè½½å‡è¡¡ä¸æµé‡è°ƒåº¦ LVS Nginx æ•°æ®åº“ä¸æ•°æ®å­˜å‚¨ MySQL PostgreSQL MongoDB Redis æ–‡ä»¶ä¼ è¾“ä¸æ•°æ®åŒæ­¥ FTP rsync ç›‘æ§ä¸å‘Šè­¦ Zabbix Prometheus å‘å¸ƒç³»ç»Ÿ æ»šåŠ¨å‘å¸ƒ è“ç»¿å‘å¸ƒ é‡‘ä¸é›€å‘å¸ƒ æ€»è§ˆï¼šä»ç¡¬ä»¶åˆ°å®¹å™¨çš„åˆ†å±‚\n"},{"id":498,"href":"/operations/kvm/vm-vs-container/","title":"ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVMï¼‰ vs æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰","parent":"KVM","content":"ä¸‹é¢æ˜¯ ã€Œç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVMï¼‰ vs æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰ã€çš„æœ¬è´¨çº§ã€æ¶æ„çº§ã€æœºåˆ¶çº§å¯¹æ¯”ã€‚\nä¸æ˜¯ â€œVM æ…¢ã€å®¹å™¨å¿«â€ è¿™ç§è¡¨å±‚è¯´æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸ã€éš”ç¦»æ¨¡å‹ã€èµ„æºæŠ½è±¡ã€é€‚ç”¨è¾¹ç•ŒæŠŠè¯è®²é€ã€‚\nå…ˆç»™ç»“è®º\nVM æ˜¯ â€œè™šæ‹Ÿä¸€å°å®Œæ•´è®¡ç®—æœºâ€ï¼Œå®¹å™¨æ˜¯ â€œåœ¨åŒä¸€ä¸ªå†…æ ¸é‡Œåˆ‡è¿›ç¨‹ç©ºé—´â€ã€‚\nä¸€ã€æœ¬è´¨åŒºåˆ«ï¼ˆæœ€æ ¸å¿ƒï¼‰ ç»´åº¦ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVM / KVMï¼‰ æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ / Dockerï¼‰ æœ¬è´¨ è™šæ‹Ÿç¡¬ä»¶ éš”ç¦»è¿›ç¨‹ éš”ç¦»å±‚çº§ ç¡¬ä»¶å±‚ å†…æ ¸å±‚ æ˜¯å¦å…±äº«å†…æ ¸ âŒ ä¸å…±äº« âœ… å…±äº«å®¿ä¸»æœºå†…æ ¸ æœ€å°å•ä½ ä¸€å°â€œæœºå™¨â€ ä¸€ä¸ªâ€œè¿›ç¨‹ç»„â€ ä¸€å¥è¯ç†è§£ï¼š\nVMï¼šæˆ‘ç»™ä½ ä¸€å°â€œå‡çš„ç”µè„‘â€ å®¹å™¨ï¼šæˆ‘åœ¨åŒä¸€ä¸ª OS é‡Œç»™ä½ ä¸€ä¸ªâ€œéš”ç¦»çš„è¿è¡Œç©ºé—´â€ äºŒã€æ¶æ„å±‚é¢å¯¹æ¯”ï¼ˆä¸€å®šè¦çœ‹ï¼‰ 1ï¸âƒ£ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆKVM æ¶æ„ï¼‰ ç¡¬ä»¶ â””â”€â”€ Hypervisorï¼ˆKVMï¼‰ â””â”€â”€ Guest OSï¼ˆå®Œæ•´å†…æ ¸ï¼‰ â””â”€â”€ App å…³é”®ç‚¹\næ¯ä¸ª VM éƒ½æœ‰ è‡ªå·±çš„å†…æ ¸ OS ç±»å‹å¯ä¸åŒï¼ˆLinux / Windows / BSDï¼‰ éš”ç¦»è¾¹ç•Œ = ç¡¬ä»¶ 2ï¸âƒ£ å®¹å™¨ï¼ˆDocker / containerd æ¶æ„ï¼‰ ç¡¬ä»¶ â””â”€â”€ Host OS Kernelï¼ˆå”¯ä¸€ï¼‰ â””â”€â”€ Namespace / cgroups â””â”€â”€ Containerï¼ˆAppï¼‰ å…³é”®ç‚¹\nåªæœ‰ä¸€ä¸ªå†…æ ¸ å®¹å™¨ â‰  OS æœ¬è´¨æ˜¯è¿›ç¨‹ ä¸‰ã€æ ¸å¿ƒæŠ€æœ¯æœºåˆ¶å¯¹æ¯”ï¼ˆåº•å±‚ï¼‰ 1ï¸âƒ£ CPU è™šæ‹ŸåŒ– é¡¹ VM å®¹å™¨ æŠ€æœ¯ VT-x / AMD-V åŸç”Ÿ CPU æ‰§è¡Œæ¨¡å¼ VMX ç”¨æˆ·æ€ æ€§èƒ½ æ¥è¿‘è£¸æœº ç­‰äºè£¸æœº ğŸ‘‰ å®¹å™¨æ²¡æœ‰ CPU è™šæ‹ŸåŒ–ï¼Œå°±æ˜¯æ™®é€šè¿›ç¨‹\n2ï¸âƒ£ å†…å­˜ç®¡ç† VM\nGuest VA -\u0026gt; Guest PA -\u0026gt; Host PA EPT / NPT Balloon HugePage å®¹å™¨\nç›´æ¥ä½¿ç”¨å®¿ä¸»æœºå†…å­˜ cgroup.limit_memory ğŸ‘‰ VM æ˜¯ è™šæ‹Ÿå†…å­˜ç³»ç»Ÿ\nğŸ‘‰ å®¹å™¨æ˜¯ é™åˆ¶å†…å­˜é…é¢\n3ï¸âƒ£ è¿›ç¨‹éš”ç¦» é¡¹ VM å®¹å™¨ PID ç‹¬ç«‹ Namespace init å„è‡ª init å…±äº«å®¿ä¸» ç³»ç»Ÿè°ƒç”¨ Trap ç›´æ¥è°ƒç”¨ 4ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿ VM å®¹å™¨ ç‹¬ç«‹ç£ç›˜ Union FS ext4/xfs overlay2 çœŸæ­£éš”ç¦» é€»è¾‘éš”ç¦» å››ã€éš”ç¦»ä¸å®‰å…¨æœ¬è´¨å·®å¼‚ï¼ˆé‡ç‚¹ï¼‰ VM çš„éš”ç¦» ç¡¬ä»¶çº§éš”ç¦»\nVM å´©æºƒ â‰  Host å´©æºƒ Guest Kernel æ¼æ´ â‰  Host å®‰å…¨è¾¹ç•Œå¼º ğŸ‘‰ å¤šç§Ÿæˆ·å®‰å…¨é¦–é€‰\nå®¹å™¨çš„éš”ç¦» å†…æ ¸çº§éš”ç¦»\nå†…æ ¸æ¼æ´ = æ‰€æœ‰å®¹å™¨é£é™© éœ€è¦é¢å¤–åŠ å›ºï¼š seccomp AppArmor / SELinux rootless ğŸ‘‰ ä¸æ˜¯â€œä¸å®‰å…¨â€ï¼Œè€Œæ˜¯â€œè¾¹ç•Œæ›´é åâ€\näº”ã€å¯åŠ¨é€Ÿåº¦ \u0026amp; èµ„æºå¼€é”€ é¡¹ VM å®¹å™¨ å¯åŠ¨æ—¶é—´ ç§’çº§ æ¯«ç§’çº§ å†…å­˜å ç”¨ OS çº§ æä½ é•œåƒä½“ç§¯ GB MB å…­ã€æ“ä½œç³»ç»Ÿæ”¯æŒèƒ½åŠ›ï¼ˆå¾ˆå¤šäººå¿½ç•¥ï¼‰ åœºæ™¯ VM å®¹å™¨ Windows on Linux âœ… âŒ ä¸åŒå†…æ ¸ç‰ˆæœ¬ âœ… âŒ è‡ªå®šä¹‰å†…æ ¸ âœ… âŒ ğŸ‘‰ å®¹å™¨æ— æ³•è·¨å†…æ ¸\nä¸ƒã€è¿ç»´ä¸äº¤ä»˜æ¨¡å‹å·®å¼‚ VM åƒç®¡ç†æœåŠ¡å™¨ è¿ç»´é‡ ç¨³å®šæ€§å¼º å®¹å™¨ åƒç®¡ç†è¿›ç¨‹ DevOps å‹å¥½ å¿«é€Ÿäº¤ä»˜ å…«ã€å…¸å‹ä½¿ç”¨åœºæ™¯å¯¹æ¯”ï¼ˆçœŸå®ç”Ÿäº§ï¼‰ åœºæ™¯ æ¨è å¤šç§Ÿæˆ·äº‘å¹³å° VM é‡‘è / æ”¿åºœ VM Kubernetes èŠ‚ç‚¹ VM å¾®æœåŠ¡ å®¹å™¨ CI/CD å®¹å™¨ æœ¬åœ°å¼€å‘ å®¹å™¨ ğŸ‘‰ VM æ˜¯åŸºç¡€è®¾æ–½ï¼Œå®¹å™¨æ˜¯åº”ç”¨äº¤ä»˜å±‚\nä¹ã€VM + å®¹å™¨çš„ç°å®ç»„åˆï¼ˆé‡ç‚¹ï¼‰ ä¸æ˜¯äºŒé€‰ä¸€ï¼Œè€Œæ˜¯åˆ†å±‚\nç‰©ç†æœº â””â”€â”€ KVM VM â””â”€â”€ Kubernetes â””â”€â”€ Container åŸå› ï¼š\nVM æä¾›å¼ºéš”ç¦» å®¹å™¨æä¾›é«˜æ•ˆç‡ åã€å¸¸è§è¯¯åŒºï¼ˆé«˜é¢‘ï¼‰ âŒ å®¹å™¨æ¯” VM æ›´å®‰å…¨ âŒ VM ä¼šè¢«æ·˜æ±° âŒ å®¹å™¨å°±æ˜¯è½»é‡ VM âŒ K8S ä¸éœ€è¦ VM âŒ ä¸€ä¸ªåº”ç”¨ä¸€ä¸ª VM å¤ªé‡ åä¸€ã€æ€»ç»“ ç¡¬ä»¶è™šæ‹ŸåŒ–é€šè¿‡è™šæ‹Ÿç¡¬ä»¶å®ç°å¼ºéš”ç¦»ï¼Œæ¯ä¸ªå®ä¾‹æ‹¥æœ‰ç‹¬ç«‹å†…æ ¸ï¼›å®¹å™¨é€šè¿‡å†…æ ¸èƒ½åŠ›éš”ç¦»è¿›ç¨‹ï¼Œè½»é‡é«˜æ•ˆä½†å…±äº«å†…æ ¸ã€‚\nVM æ˜¯åŸºç¡€è®¾æ–½æŠ½è±¡ï¼Œå®¹å™¨æ˜¯åº”ç”¨äº¤ä»˜æŠ½è±¡ã€‚\nåäºŒã€ç»ˆæå¯¹æ¯”è¡¨ ç»´åº¦ VM å®¹å™¨ éš”ç¦»çº§åˆ« ç¡¬ä»¶ å†…æ ¸ å†…æ ¸ ç‹¬ç«‹ å…±äº« å®‰å…¨ å¼º ä¾èµ–åŠ å›º å¯åŠ¨ æ…¢ æå¿« çµæ´»æ€§ OS çº§ App çº§ é€‚åˆè§’è‰² IaaS PaaS ","description":"ä¸‹é¢æ˜¯ ã€Œç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVMï¼‰ vs æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ï¼‰ã€çš„æœ¬è´¨çº§ã€æ¶æ„çº§ã€æœºåˆ¶çº§å¯¹æ¯”ã€‚\nä¸æ˜¯ â€œVM æ…¢ã€å®¹å™¨å¿«â€ è¿™ç§è¡¨å±‚è¯´æ³•ï¼Œè€Œæ˜¯ä»å†…æ ¸ã€éš”ç¦»æ¨¡å‹ã€èµ„æºæŠ½è±¡ã€é€‚ç”¨è¾¹ç•ŒæŠŠè¯è®²é€ã€‚\nå…ˆç»™ç»“è®º\nVM æ˜¯ â€œè™šæ‹Ÿä¸€å°å®Œæ•´è®¡ç®—æœºâ€ï¼Œå®¹å™¨æ˜¯ â€œåœ¨åŒä¸€ä¸ªå†…æ ¸é‡Œåˆ‡è¿›ç¨‹ç©ºé—´â€ã€‚\nä¸€ã€æœ¬è´¨åŒºåˆ«ï¼ˆæœ€æ ¸å¿ƒï¼‰ ç»´åº¦ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆVM / KVMï¼‰ æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–ï¼ˆå®¹å™¨ / Dockerï¼‰ æœ¬è´¨ è™šæ‹Ÿç¡¬ä»¶ éš”ç¦»è¿›ç¨‹ éš”ç¦»å±‚çº§ ç¡¬ä»¶å±‚ å†…æ ¸å±‚ æ˜¯å¦å…±äº«å†…æ ¸ âŒ ä¸å…±äº« âœ… å…±äº«å®¿ä¸»æœºå†…æ ¸ æœ€å°å•ä½ ä¸€å°â€œæœºå™¨â€ ä¸€ä¸ªâ€œè¿›ç¨‹ç»„â€ ä¸€å¥è¯ç†è§£ï¼š\nVMï¼šæˆ‘ç»™ä½ ä¸€å°â€œå‡çš„ç”µè„‘â€ å®¹å™¨ï¼šæˆ‘åœ¨åŒä¸€ä¸ª OS é‡Œç»™ä½ ä¸€ä¸ªâ€œéš”ç¦»çš„è¿è¡Œç©ºé—´â€ äºŒã€æ¶æ„å±‚é¢å¯¹æ¯”ï¼ˆä¸€å®šè¦çœ‹ï¼‰ 1ï¸âƒ£ ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ˆKVM æ¶æ„ï¼‰ ç¡¬ä»¶ â””â”€â”€ Hypervisorï¼ˆKVMï¼‰ â””â”€â”€ Guest OSï¼ˆå®Œæ•´å†…æ ¸ï¼‰ â””â”€â”€ App å…³é”®ç‚¹\n"},{"id":499,"href":"/database/postgres/classic-issues/","title":"ç»å…¸é—®é¢˜","parent":"PostgreSQL","content":"PostgreSQL çš„é—®é¢˜æ›´å¤šé›†ä¸­åœ¨ï¼šæ•°æ®ä¸€è‡´æ€§ã€æ€§èƒ½ã€å¹¶å‘ã€è¿ç»´ä¸å¯ç”¨æ€§ã€‚\nä¸€ã€PostgreSQL åœ¨ã€Œå¼€å‘å±‚ã€å¸¸è§é—®é¢˜ 1ï¸âƒ£ æ…¢ SQL / æŸ¥è¯¢æ€§èƒ½å·®ï¼ˆæœ€å¸¸è§ï¼‰ è¡¨ç°\næŸ¥è¯¢å¶å‘æˆ–æŒç»­å˜æ…¢ EXPLAIN æ˜¾ç¤º Seq Scan åŒæ · SQL åœ¨ä¸åŒæ—¶é—´æ€§èƒ½å·®å¼‚å¤§ æ ¹å› \nç¼ºç´¢å¼• / ç´¢å¼•è®¾è®¡ä¸åˆç† ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ï¼ˆæœª ANALYZEï¼‰ é”™è¯¯çš„æ•°æ®ç±»å‹ï¼ˆchar / varchar / timestamptzï¼‰ LIKE %xxx% æ— æ³•ä½¿ç”¨ B-Tree JOIN é¡ºåºé”™è¯¯ è¿”å›åˆ—è¿‡å¤šï¼ˆSELECT *ï¼‰ å¯¹ç­–\nEXPLAIN (ANALYZE, BUFFERS) åˆç†ä½¿ç”¨ï¼š B-Tree / GIN / BRIN pg_trgm å®šæœŸ ANALYZE æ˜ç¡®å­—æ®µç±»å‹ï¼ˆæ—¶é—´ç”¨ TIMESTAMPTZï¼‰ æ‹† SQLï¼Œè€Œä¸æ˜¯å † SQL 2ï¸âƒ£ é”å†²çª / æ­»é” è¡¨ç°\nUPDATE / DELETE å¡ä½ å‡ºç° deadlock detected é«˜å¹¶å‘å†™å…¥æ€§èƒ½æ€¥å‰§ä¸‹é™ æ ¹å› \né•¿äº‹åŠ¡ ä¸åˆç†çš„ UPDATE é¡ºåº SELECT FOR UPDATE æ»¥ç”¨ å¤–é”®çº§è”å¯¼è‡´éšå¼é” å¯¹ç­–\næ§åˆ¶äº‹åŠ¡ç²’åº¦ï¼ˆçŸ­äº‹åŠ¡ï¼‰ å›ºå®šè®¿é—®é¡ºåº é¿å…é•¿æ—¶é—´ HOLD äº‹åŠ¡ ä½¿ç”¨ï¼š SELECT * FROM pg_locks; 3ï¸âƒ£ MVCC è†¨èƒ€ï¼ˆè¡¨è¶Šç”¨è¶Šæ…¢ï¼‰ è¡¨ç°\nè¡¨è¶Šæ¥è¶Šå¤§ æŸ¥è¯¢è¶Šæ¥è¶Šæ…¢ VACUUM è·‘ä¸åŠ¨ æ ¹å› \nUPDATE / DELETE å¤š autovacuum å‚æ•°ä¸åˆç† é•¿äº‹åŠ¡é˜»æ­¢ vacuum å¯¹ç­–\nè°ƒæ•´ autovacuum å®šæœŸï¼š VACUUM (ANALYZE); VACUUM FULL; -- ä»…ä½å³° ç›‘æ§ï¼š n_dead_tup 4ï¸âƒ£ æ•°æ®ä¸€è‡´æ€§è¯¯ç”¨ï¼ˆé€»è¾‘é—®é¢˜ï¼‰ è¡¨ç°\nè¯»åˆ°â€œæ—§æ•°æ®â€ å¹»è¯» / ä¸å¯é‡å¤è¯»ç†è§£é”™è¯¯ æ ¹å› \nä¸ç†è§£ PostgreSQL çš„éš”ç¦»çº§åˆ« è¯¯ç”¨ READ COMMITTED å¯¹ç­–\nç†è§£éš”ç¦»çº§åˆ«ï¼š READ COMMITTED REPEATABLE READ SERIALIZABLE é‡‘è / ç»“ç®—ä½¿ç”¨æ›´é«˜éš”ç¦» 5ï¸âƒ£ æ—¶é—´å­—æ®µè®¾è®¡é”™è¯¯ è¡¨ç°\nä¸åŒæ—¶åŒºæ•°æ®æ··ä¹± æ—¥å¿—æ—¶é—´ä¸ä¸€è‡´ æ ¹å› \nä½¿ç”¨ TIMESTAMP è€Œä¸æ˜¯ TIMESTAMPTZ å¯¹ç­–\næ—¥å¿— / äº‹ä»¶ / å®¡è®¡ï¼šå¿…é¡» TIMESTAMPTZ ç»Ÿä¸€ UTC å­˜å‚¨ 6ï¸âƒ£ è¯¯ä»¥ä¸º PostgreSQL = MySQL å¸¸è§è¯¯åŒº\nCOUNT(*) å¾ˆå¿«ï¼ˆé”™ï¼‰ ç´¢å¼•è¶Šå¤šè¶Šå¥½ï¼ˆé”™ï¼‰ CHAR æ¯” VARCHAR å¿«ï¼ˆé”™ï¼‰ è‡ªåŠ¨ VACUUM = ä¸‡èƒ½ï¼ˆé”™ï¼‰ äºŒã€PostgreSQL åœ¨ã€Œè¿ç»´å±‚ã€å¸¸è§é—®é¢˜ 7ï¸âƒ£ ç£ç›˜ IO æˆç“¶é¢ˆ è¡¨ç°\næŸ¥è¯¢æ…¢ä½† CPU ç©ºé—² iowait é«˜ æ ¹å› \néšæœº IO WAL å†™å…¥å‹åŠ› ç´¢å¼•è¿‡å¤š å¯¹ç­–\nSSD / NVMe è°ƒæ•´ï¼š shared_buffers effective_cache_size wal_buffers WAL ç‹¬ç«‹ç£ç›˜ 8ï¸âƒ£ WAL çˆ†ç›˜ / ç£ç›˜å†™æ»¡ è¡¨ç°\næ•°æ®åº“åœæ­¢æœåŠ¡ WAL ç›®å½•æš´æ¶¨ æ ¹å› \næ²¡æœ‰å¤‡åº“ å¤åˆ¶æ§½æœªé‡Šæ”¾ å¤‡ä»½å¤±è´¥ å¯¹ç­–\nç›‘æ§ï¼š pg_replication_slots; å®šæœŸæ¸…ç†å¤±æ•ˆ slot pgBackRest / WAL å½’æ¡£ 9ï¸âƒ£ å¤‡ä»½ä¸å¯ç”¨ï¼ˆç¾éš¾çº§ï¼‰ è¡¨ç°\næ¢å¤å¤±è´¥ backup.info ä¸¢å¤± æ ¹å› \nåªåšé€»è¾‘å¤‡ä»½ æœªéªŒè¯æ¢å¤ WAL ä¸å®Œæ•´ å¯¹ç­–\nç‰©ç†å¤‡ä»½ + WAL å®šæœŸæ¼”ç»ƒæ¢å¤ ä½¿ç”¨ pgBackRest ğŸ”Ÿ ä¸»ä»å»¶è¿Ÿ / ä¸ä¸€è‡´ è¡¨ç°\nè¯»ä»åº“æ•°æ®æ—§ åº”ç”¨å¼‚å¸¸ æ ¹å› \nåŒæ­¥å¤åˆ¶é…ç½®é”™è¯¯ ç½‘ç»œå»¶è¿Ÿ å¤§äº‹åŠ¡ å¯¹ç­–\nåŒºåˆ†ï¼š åŒæ­¥å¤åˆ¶ å¼‚æ­¥å¤åˆ¶ ç›‘æ§ replication lag 1ï¸âƒ£1ï¸âƒ£ OOM / å†…å­˜è€—å°½ è¡¨ç°\næ•°æ®åº“è¢« OOM Killer æ€æ‰ æ ¹å› \nwork_mem è®¾ç½®è¿‡å¤§ é«˜å¹¶å‘ JOIN / SORT å¯¹ç­–\nwork_mem Ã— å¹¶å‘æ•° â‰  æ€»å†…å­˜ ä½¿ç”¨ LIMIT ä¼˜åŒ– SQL 1ï¸âƒ£2ï¸âƒ£ è¡¨è¡Œæ•°ç»Ÿè®¡ä¸å‡† è¡¨ç°\nCOUNT å¾ˆæ…¢ è¡Œæ•°æ˜¾ç¤ºä¸å‡† æ ¹å› \nPostgreSQL ä¸ç»´æŠ¤ç²¾ç¡®è¡Œæ•° å¯¹ç­–\nä½¿ç”¨ï¼š pg_stat_all_tables.n_live_tup 1ï¸âƒ£3ï¸âƒ£ å‡çº§ / æ‰©å±•å…¼å®¹é—®é¢˜ è¡¨ç°\nå‡çº§åæ‰©å±•ä¸å¯ç”¨ TimescaleDB / pg_trgm æŠ¥é”™ æ ¹å› \nä¸»ç‰ˆæœ¬å‡çº§ æ‰©å±•æœªåŒ¹é… å¯¹ç­–\nå‡çº§å‰éªŒè¯ï¼š æ‰©å±•æ”¯æŒç‰ˆæœ¬ ä½¿ç”¨ pg_upgrade ä¸‰ã€æ€»ç»“ ç³»ç»Ÿ æ ¸å¿ƒé—®é¢˜ Redis ç©¿é€ / å‡»ç©¿ / é›ªå´© PostgreSQL æ…¢ SQL / é” / è†¨èƒ€ / WAL / å¤‡ä»½ / æ—¶é—´ / å†…å­˜ PostgreSQL çš„â€œä¸ƒå®—ç½ªâ€ğŸ‘‡\nSQL æ…¢ã€é”ä¹±ã€è¡¨è†¨èƒ€ã€WAL çˆ†ã€å¤‡ä»½å‡ã€æ—¶é—´é”™ã€å†…å­˜ç‚¸\n","description":"PostgreSQL çš„é—®é¢˜æ›´å¤šé›†ä¸­åœ¨ï¼šæ•°æ®ä¸€è‡´æ€§ã€æ€§èƒ½ã€å¹¶å‘ã€è¿ç»´ä¸å¯ç”¨æ€§ã€‚\nä¸€ã€PostgreSQL åœ¨ã€Œå¼€å‘å±‚ã€å¸¸è§é—®é¢˜ 1ï¸âƒ£ æ…¢ SQL / æŸ¥è¯¢æ€§èƒ½å·®ï¼ˆæœ€å¸¸è§ï¼‰ è¡¨ç°\næŸ¥è¯¢å¶å‘æˆ–æŒç»­å˜æ…¢ EXPLAIN æ˜¾ç¤º Seq Scan åŒæ · SQL åœ¨ä¸åŒæ—¶é—´æ€§èƒ½å·®å¼‚å¤§ æ ¹å› \nç¼ºç´¢å¼• / ç´¢å¼•è®¾è®¡ä¸åˆç† ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ï¼ˆæœª ANALYZEï¼‰ é”™è¯¯çš„æ•°æ®ç±»å‹ï¼ˆchar / varchar / timestamptzï¼‰ LIKE %xxx% æ— æ³•ä½¿ç”¨ B-Tree JOIN é¡ºåºé”™è¯¯ è¿”å›åˆ—è¿‡å¤šï¼ˆSELECT *ï¼‰ å¯¹ç­–\n"},{"id":500,"href":"/management/development/coding-style/","title":"ç¼–ç¨‹é£æ ¼","parent":"Development","content":"ä»¥ä¸‹å†…å®¹å…¨éƒ¨å›´ç»• â€œé™ä½å¤æ‚åº¦ã€å‡å°‘å¿ƒæ™ºè´Ÿæ‹…ã€æé«˜ç»´æŠ¤æ€§â€ å±•å¼€ã€‚\né€‚ç”¨æ‰€æœ‰è¯­è¨€ï¼ˆPython/Go/JS/TS/Java/C++ï¼‰ã€‚\nif åªåšå¸ƒå°”åˆ¤æ–­ï¼Œä¸å†™é•¿é€»è¾‘ï¼›å¼‚å¸¸æƒ…å†µæå‰è¿”å›ï¼ˆGuard Clausesï¼‰ âœ… ä¿ç•™ if åªç”¨äºåˆ¤æ–­ï¼Œè€Œä¸æ˜¯æ‰§è¡Œå¤§é‡é€»è¾‘\nâŒ ä¸è¦è¿™æ ·ï¼š\nif a and b and c: # éå¸¸é•¿çš„å¤§æ®µä»£ç  # â€¦â€¦ âœ… æ¨èæå‰é€€å‡ºï¼ˆå‡å°‘åµŒå¥—ï¼‰\næ¡ä»¶æˆç«‹åˆ™ returnã€exitã€raiseã€breakã€continue ç­‰ç­‰ if not valid: return None # æˆ– raise æˆ– exit æˆ– continue ç­‰ç­‰ # ä¸»é€»è¾‘æ›´æ¸…æ™° process() save() âœ… if å†…çš„ä»£ç è¶…è¿‡ 5ï½8 è¡Œï¼šå¿…é¡»æŠ½å‡½æ•°\nè¿™å¯¹å¯è¯»æ€§ã€æµ‹è¯•æ€§éƒ½æ˜¯å·¨å¤§æ”¶ç›Šã€‚\né¿å…å†™åªä½¿ç”¨ä¸€æ¬¡çš„ç¯å¢ƒå˜é‡ã€é…ç½®å˜é‡ âŒ ä¸æ¨èï¼š\nROOT = \u0026#34;/var/data\u0026#34; # åªç”¨ä¸€æ¬¡ path = ROOT + \u0026#34;/user.json\u0026#34; âœ… æ¨èï¼š\nç›´æ¥å†™åœ¨ä½¿ç”¨çš„åœ°æ–¹ï¼Œé™¤éæ˜¯çœŸé…ç½®ï¼ˆå¯å¤ç”¨ï¼‰ã€‚\nä¼˜å…ˆä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹ï¼ˆå‡½æ•°ä¸ºä¸€ç­‰å…¬æ°‘ï¼‰ âœ… å‡½æ•°å¯ä½œä¸ºå‚æ•°ã€è¿”å›å€¼ã€å˜é‡\nä¾‹å¦‚ï¼š\næŠŠé€»è¾‘å°è£…æˆå›è°ƒ ä¼ é€’ lambda/map/filter ä½¿ç”¨é«˜é˜¶å‡½æ•°å‡å°‘é‡å¤é€»è¾‘ å¥½å¤„ï¼š\næ›´å°‘å‰¯ä½œç”¨ æ›´å¥½æµ‹è¯• æ›´å®¹æ˜“å¹¶å‘/å¹¶è¡Œ æ¨¡å—åŒ–æ›´è‡ªç„¶ âœ… å‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰è¿”å›å€¼åˆ™è¿”å› None æˆ–è€… Bool\né¿å…æ·±å±‚åµŒå¥—ï¼šè¶…è¿‡ 3 å±‚å°±è¦æ‹† ä¾‹å­ï¼š\nif a: if b: if c: do() æ›¿æ¢ä¸ºï¼š\nif not a or not b or not c: return do() å˜é‡ç”Ÿå‘½å‘¨æœŸè¶ŠçŸ­è¶Šå¥½ åªåœ¨ç”¨çš„åœ°æ–¹å®šä¹‰ï¼Œä¸è¦æå‰ 20 è¡Œå£°æ˜å˜é‡ã€‚\næ¯ä¸ªå‡½æ•°æ§åˆ¶åœ¨ 20ï½30 è¡Œå†… è¶…è¿‡ 30 è¡Œï¼Œä¸€èˆ¬æ„å‘³ç€èŒè´£ä¸å¤Ÿå•ä¸€ã€‚\nå‡½æ•°è¿”å›æ˜ç¡®ç»“æœ ä½¿ç”¨ try / except åŒ…è£¹ï¼ˆä¸è¦çº ç»“ Exceptionï¼‰ï¼Œå¼‚å¸¸ è¿”å› å¯¹åº”ç±»å‹ çš„ False å¸ƒå°”å€¼ã€‚\næ¯”å¦‚ï¼šNone, False, 0, 0.0, \u0026ldquo;\u0026rdquo;, [], (), {}, set() ç‰¹æ®Šçš„è¿”å› Noneã€‚\næ¯”å¦‚ï¼šResult | None å‡½æ•°è¿”å›çš„å€¼ï¼Œå¿…é¡»åš å¸ƒå°” åˆ¤æ–­ã€‚\nç»å…¸ç»“æ„ï¼š\ndef func() -\u0026gt; bool: try: return True except Exception as e: logger.error(e) return False result = func() if not result: return é¿å…å‰¯ä½œç”¨ï¼šå‡½æ•°åªåšä¸€ä»¶äº‹ä¸”æ— éšè—è¡Œä¸º âŒ å‡½æ•°å†…éƒ¨å·å·ä¿®æ”¹å…¨å±€å˜é‡ âŒ å‡½æ•°å†…éƒ¨è¯»å†™ç£ç›˜ã€ç½‘ç»œï¼ˆé™¤éå°±æ˜¯ IO å‡½æ•°ï¼‰ âŒ å‡½æ•°å†…éƒ¨æ”¹å˜ä¼ å…¥çš„å¯¹è±¡ç»“æ„ï¼ˆä¸å¯é¢„æœŸï¼‰ âœ… å‡½æ•°è¾“å…¥ -\u0026gt; è¾“å‡ºå¯é¢„æµ‹\né­”æ³•æ•°å­—ç¦æ­¢å‡ºç°ï¼ˆMagic Numbersï¼‰ âŒ\nif timeout \u0026gt; 1200 { âœ…\nconst MAX_TIMEOUT = 1200 if timeout \u0026gt; MAX_TIMEOUT { switch-caseï¼ˆæˆ– matchï¼‰ä¼˜å…ˆäºå¤æ‚ if-else é“¾ if-else é“¾æ˜¯ä»£ç åå‘³é“ã€‚\né¿å…å†™ä¸‡èƒ½å‡½æ•°ï¼›è¶Šé€šç”¨çš„å‡½æ•°ï¼Œè¶Šéš¾ç»´æŠ¤ âŒ utils.py é‡Œå¡ä¸€å †æ— å…³å‡½æ•° âŒ doEverything(data) âŒ è¿‡åº¦æŠ½è±¡ âœ… ç”¨ â€œå¯ç»„åˆçš„å°å‡½æ•°â€ ä»£æ›¿ â€œä¸€ä¸ªå¤§è€Œé€šçš„å‡½æ•°â€ã€‚\næ—¥å¿—è¦ç²¾ç®€ä½†ç»“æ„åŒ–ï¼ˆå¯æ£€ç´¢ï¼‰ æ¨èæ ¼å¼ï¼š\nINFO: action=DeleteUser user_id=33 cost=120ms result=ok JSON æ ¼å¼æ›´ä½³ã€‚\né”™è¯¯ä¿¡æ¯å¿…é¡»åŒ…å«ä¸Šä¸‹æ–‡ï¼Œå¦åˆ™æ— æ³•æ’æŸ¥ âŒ\nError: failed âœ…\nError: db query failed, user_id=233, sql=xxx ä¼˜å…ˆä¸å¯å˜æ•°æ®ç»“æ„ï¼ˆimmutableï¼‰ å¥½å¤„ï¼š\næ›´å®¹æ˜“æ¨ç† æ›´å°‘å‡º bug æ›´é€‚åˆé›†ç¾¤/å¹¶å‘åœºæ™¯ å¾ªç¯ä¸­é¿å…åˆ›å»ºä¸´æ—¶å¤§å¯¹è±¡æˆ–é‡å¤è¿ç®— å¦‚ï¼šä¸è¦æ¯æ¬¡å¾ªç¯éƒ½æ­£åˆ™ç¼–è¯‘ã€‚\næ¥å£ï¼ˆå‡½æ•°ï¼‰å‚æ•°ä¸å¾—è¶…è¿‡ 3 ä¸ª è¶…è¿‡ 3 ä¸ªå°±åŒ…è£…æˆ å¯¹è±¡ / ç»“æ„ä½“ / dataclassã€‚\næ¨¡å—ä¹‹é—´ä¿æŒä½è€¦åˆï¼Œé«˜å†…èš ä½è€¦åˆï¼š\næ¨¡å—ä¹‹é—´ä¾èµ–å°‘ã€æ¥å£æ¸…æ™°\né«˜å†…èšï¼š\næ¨¡å—å†…éƒ¨åŠŸèƒ½ç›¸å…³æ€§å¼º\nä¾¿äºé‡æ„å’Œæ‹†æ¨¡å— ä¼˜å…ˆæ˜¾å¼ï¼Œè€Œä¸æ˜¯éšå¼ï¼ˆExplicit \u0026gt; Implicitï¼‰ ä¾‹å¦‚ï¼š\nPython é‡Œä¼˜å…ˆå†™æ¸…æ¥šå‚æ•°å å˜é‡åä¸è¦ç¼©å†™ï¼Œé™¤éæ˜¯æ•°å­¦å˜é‡ ä¸è¦çœç•¥ return/await ä¹‹ç±» å†™ä»£ç å‰å…ˆå†™ç»“æ„ å…ˆæƒ³ï¼š\næ•°æ®ç»“æ„ è¾“å…¥è¾“å‡º è´£ä»»åˆ’åˆ† å†å†™ä»£ç ã€‚\nèƒ½å‡å°‘ 50% é‡æ„ã€‚\næ—©å¤±è´¥ï¼ˆFail Fastï¼‰ã€æ—©æš´éœ²é—®é¢˜ å‚æ•°æ ¡éªŒæå‰åš å†…éƒ¨æ–­è¨€ é‡åˆ°å¼‚å¸¸ç«‹å³æŠ¥é”™ï¼Œè€Œä¸æ˜¯é»˜é»˜åæ‰ ä¿æŒä¸€è‡´æ€§æ¯”èªæ˜æ›´é‡è¦ï¼ˆConsistency \u0026gt; Clevernessï¼‰ å›¢é˜Ÿåä½œæœ€é‡è¦çš„ä¸æ˜¯â€œå†™å¾—å¤šå‰å®³â€ï¼Œæ˜¯â€œå†™å¾—å¤§å®¶éƒ½çœ‹å¾—æ‡‚â€ã€‚\næ•°æ®æ ¼å¼ï¼šæ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ Pythonï¼š\nSQLAlchemy ORM Create åªæ¥æ”¶ dict æˆ–è€… list[dict] FastAPI åªæ¥æ”¶ JSON æˆ–è€… JSON åˆ—è¡¨ åŸå› ï¼š\nå­—æ®µå¯¹åº”ï¼Œå¼ºä¸€è‡´æ€§ï¼Œé¿å…æ•°æ®ä¿å­˜é”™è¯¯ æœ‰äº› ID æ˜¯è‡ªå¢çš„ï¼Œé¿å… ID å†²çª æ—¥æœŸæ—¶é—´æ ¼å¼ ç»Ÿä¸€ä½¿ç”¨ ISO 8601 æ ¼å¼ YYYY-MM-DD HH:MM:SS\nç¤ºä¾‹ï¼š2021-01-01 00:00:00\n","description":"ä»¥ä¸‹å†…å®¹å…¨éƒ¨å›´ç»• â€œé™ä½å¤æ‚åº¦ã€å‡å°‘å¿ƒæ™ºè´Ÿæ‹…ã€æé«˜ç»´æŠ¤æ€§â€ å±•å¼€ã€‚\né€‚ç”¨æ‰€æœ‰è¯­è¨€ï¼ˆPython/Go/JS/TS/Java/C++ï¼‰ã€‚\nif åªåšå¸ƒå°”åˆ¤æ–­ï¼Œä¸å†™é•¿é€»è¾‘ï¼›å¼‚å¸¸æƒ…å†µæå‰è¿”å›ï¼ˆGuard Clausesï¼‰ âœ… ä¿ç•™ if åªç”¨äºåˆ¤æ–­ï¼Œè€Œä¸æ˜¯æ‰§è¡Œå¤§é‡é€»è¾‘\nâŒ ä¸è¦è¿™æ ·ï¼š\nif a and b and c: # éå¸¸é•¿çš„å¤§æ®µä»£ç  # â€¦â€¦ âœ… æ¨èæå‰é€€å‡ºï¼ˆå‡å°‘åµŒå¥—ï¼‰\næ¡ä»¶æˆç«‹åˆ™ returnã€exitã€raiseã€breakã€continue ç­‰ç­‰ if not valid: return None # æˆ– raise æˆ– exit æˆ– continue ç­‰ç­‰ # ä¸»é€»è¾‘æ›´æ¸…æ™° process() save() âœ… if å†…çš„ä»£ç è¶…è¿‡ 5ï½8 è¡Œï¼šå¿…é¡»æŠ½å‡½æ•°\nè¿™å¯¹å¯è¯»æ€§ã€æµ‹è¯•æ€§éƒ½æ˜¯å·¨å¤§æ”¶ç›Šã€‚\né¿å…å†™åªä½¿ç”¨ä¸€æ¬¡çš„ç¯å¢ƒå˜é‡ã€é…ç½®å˜é‡ âŒ ä¸æ¨èï¼š\n"},{"id":501,"href":"/operations/hardware/mdadm-vs-hard/","title":"è½¯RAID vs ç¡¬RAID","parent":"Hardware","content":"mdadmï¼ˆè½¯RAIDï¼‰ä¾èµ–CPUè®¡ç®—ã€æˆæœ¬ä½ã€é…ç½®çµæ´»ï¼Œé€‚ç”¨äºLinuxç¯å¢ƒï¼›é˜µåˆ—å¡ï¼ˆç¡¬RAIDï¼‰ä½¿ç”¨ç‹¬ç«‹èŠ¯ç‰‡å’Œç¼“å­˜ã€ä¸å CPUèµ„æºã€æ€§èƒ½æ›´ç¨³ï¼Œé€‚ç”¨äºä¼ä¸šçº§é«˜å¹¶å‘åœºæ™¯ã€‚å…³é”®åŒºåˆ«åœ¨äºè®¡ç®—æ ¸å¿ƒã€æ€§èƒ½å½±å“ã€ç¡¬ä»¶ä¾èµ–åŠè¿ç§»ä¾¿åˆ©æ€§ã€‚\nä»¥ä¸‹æ˜¯è¯¦ç»†åŒºåˆ«å¯¹æ¯”ï¼š\n1. æ ¸å¿ƒæ¶æ„ä¸æ€§èƒ½æ¥æº mdadmï¼ˆè½¯ä»¶RAIDï¼‰ï¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿï¼ˆLinuxå†…æ ¸ï¼‰çš„CPUèµ„æºæ¥å¤„ç†RAIDé€»è¾‘å’Œæ•°æ®æ ¡éªŒã€‚åœ¨é«˜I/Oè´Ÿè½½ä¸‹ï¼Œä¼šå ç”¨è¾ƒé«˜çš„CPUä½¿ç”¨ç‡ã€‚ é˜µåˆ—å¡ï¼ˆç¡¬ä»¶RAIDï¼‰ï¼šæ‹¥æœ‰ä¸€å—ä¸“é—¨çš„èŠ¯ç‰‡å’Œç‹¬ç«‹çš„ç¼“å­˜æ¥å¤„ç†RAIDä»»åŠ¡ï¼Œå®Œå…¨ä¸å ç”¨ä¸»æœºçš„CPUèµ„æºã€‚ 2. æ€§èƒ½ä¸ç¼“å­˜ mdadmï¼šæ€§èƒ½å—CPUé€Ÿåº¦å½±å“ï¼Œç¼“å­˜ä½¿ç”¨ç³»ç»Ÿå†…å­˜ï¼Œå¤§æ–‡ä»¶è¯»å†™é€Ÿåº¦ä¸é”™ï¼Œä½†éšæœºI/Oé€šå¸¸ä½äºç¡¬ä»¶RAIDã€‚ é˜µåˆ—å¡ï¼šæ‹¥æœ‰é«˜é€Ÿç¼“å­˜ï¼ˆå¦‚512MB-4GBæˆ–æ›´å¤šï¼‰ï¼Œå¯è¿›è¡Œå†™ç¼“å­˜ç­–ç•¥ç®¡ç†ï¼Œå³ä½¿åœ¨æ–­ç”µæ—¶ä¹Ÿæœ‰ç”µæ± ä¿æŠ¤æ•°æ®ï¼Œéšæœºè¯»å†™æ€§èƒ½æé«˜ã€‚ 3. å¯ç§»æ¤æ€§ä¸å…¼å®¹æ€§ mdadmï¼šé˜µåˆ—ä¿¡æ¯å­˜å‚¨åœ¨ç£ç›˜å…ƒæ•°æ®ä¸­ï¼Œåªè¦æ›´æ¢çš„ç³»ç»Ÿæ”¯æŒLinuxï¼Œå°±å¯ä»¥ç›´æ¥è¿ç§»ç¡¬ç›˜ï¼Œå…¼å®¹æ€§æå¥½ã€‚ é˜µåˆ—å¡ï¼šé˜µåˆ—ä¿¡æ¯å­˜å‚¨åœ¨ç¡¬ä»¶å¡ä¸Šï¼Œé€šå¸¸å¿…é¡»åœ¨åŒå“ç‰Œæˆ–å…¼å®¹çš„ç¡¬ä»¶å¡ä¸‹æ‰èƒ½è¿ç§»æ•°æ®ï¼Œæ¢å¡å¯èƒ½å¯¼è‡´é˜µåˆ—æŸåã€‚ 4. æˆæœ¬ä¸éƒ¨ç½² mdadmï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€é¢å¤–ç¡¬ä»¶ã€‚ é˜µåˆ—å¡ï¼šæˆæœ¬è¾ƒé«˜ï¼Œéœ€è¦å•ç‹¬è´­ä¹°ç¡¬ä»¶å¡ã€‚ 5. ç»´æŠ¤ä¸ä¿®å¤ mdadmï¼šé…ç½®çµæ´»ï¼Œæ•…éšœä¿®å¤ä¸»è¦é è½¯ä»¶å‘½ä»¤è¡Œæ“ä½œã€‚ é˜µåˆ—å¡ï¼šéœ€è¦åœ¨BIOS/UEFIä¸­é…ç½®ï¼Œæ”¯æŒç£ç›˜çƒ­æ’æ‹”ä¿æŠ¤æ›´å¥½ã€‚ æ€»ç»“å»ºè®® ä½¿ç”¨mdadmï¼šé€‚ç”¨äºLinuxç³»ç»Ÿã€é¢„ç®—æœ‰é™ã€è¿½æ±‚é«˜å…¼å®¹æ€§å’Œçµæ´»æ€§çš„åœºæ™¯ï¼ˆå¦‚NASã€å®¶åº­æœåŠ¡å™¨ï¼‰ã€‚ ä½¿ç”¨é˜µåˆ—å¡ï¼šé€‚ç”¨äºæ€§èƒ½è¦æ±‚æé«˜ã€é«˜å¹¶å‘ã€éœ€è¦ä¿æŠ¤ç³»ç»Ÿæ ¸å¿ƒæ€§èƒ½çš„ä¼ä¸šçº§æœåŠ¡å™¨åœºæ™¯ã€‚ ","description":"mdadmï¼ˆè½¯RAIDï¼‰ä¾èµ–CPUè®¡ç®—ã€æˆæœ¬ä½ã€é…ç½®çµæ´»ï¼Œé€‚ç”¨äºLinuxç¯å¢ƒï¼›é˜µåˆ—å¡ï¼ˆç¡¬RAIDï¼‰ä½¿ç”¨ç‹¬ç«‹èŠ¯ç‰‡å’Œç¼“å­˜ã€ä¸å CPUèµ„æºã€æ€§èƒ½æ›´ç¨³ï¼Œé€‚ç”¨äºä¼ä¸šçº§é«˜å¹¶å‘åœºæ™¯ã€‚å…³é”®åŒºåˆ«åœ¨äºè®¡ç®—æ ¸å¿ƒã€æ€§èƒ½å½±å“ã€ç¡¬ä»¶ä¾èµ–åŠè¿ç§»ä¾¿åˆ©æ€§ã€‚\nä»¥ä¸‹æ˜¯è¯¦ç»†åŒºåˆ«å¯¹æ¯”ï¼š\n1. æ ¸å¿ƒæ¶æ„ä¸æ€§èƒ½æ¥æº mdadmï¼ˆè½¯ä»¶RAIDï¼‰ï¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿï¼ˆLinuxå†…æ ¸ï¼‰çš„CPUèµ„æºæ¥å¤„ç†RAIDé€»è¾‘å’Œæ•°æ®æ ¡éªŒã€‚åœ¨é«˜I/Oè´Ÿè½½ä¸‹ï¼Œä¼šå ç”¨è¾ƒé«˜çš„CPUä½¿ç”¨ç‡ã€‚ é˜µåˆ—å¡ï¼ˆç¡¬ä»¶RAIDï¼‰ï¼šæ‹¥æœ‰ä¸€å—ä¸“é—¨çš„èŠ¯ç‰‡å’Œç‹¬ç«‹çš„ç¼“å­˜æ¥å¤„ç†RAIDä»»åŠ¡ï¼Œå®Œå…¨ä¸å ç”¨ä¸»æœºçš„CPUèµ„æºã€‚ 2. æ€§èƒ½ä¸ç¼“å­˜ mdadmï¼šæ€§èƒ½å—CPUé€Ÿåº¦å½±å“ï¼Œç¼“å­˜ä½¿ç”¨ç³»ç»Ÿå†…å­˜ï¼Œå¤§æ–‡ä»¶è¯»å†™é€Ÿåº¦ä¸é”™ï¼Œä½†éšæœºI/Oé€šå¸¸ä½äºç¡¬ä»¶RAIDã€‚ é˜µåˆ—å¡ï¼šæ‹¥æœ‰é«˜é€Ÿç¼“å­˜ï¼ˆå¦‚512MB-4GBæˆ–æ›´å¤šï¼‰ï¼Œå¯è¿›è¡Œå†™ç¼“å­˜ç­–ç•¥ç®¡ç†ï¼Œå³ä½¿åœ¨æ–­ç”µæ—¶ä¹Ÿæœ‰ç”µæ± ä¿æŠ¤æ•°æ®ï¼Œéšæœºè¯»å†™æ€§èƒ½æé«˜ã€‚ 3. å¯ç§»æ¤æ€§ä¸å…¼å®¹æ€§ mdadmï¼šé˜µåˆ—ä¿¡æ¯å­˜å‚¨åœ¨ç£ç›˜å…ƒæ•°æ®ä¸­ï¼Œåªè¦æ›´æ¢çš„ç³»ç»Ÿæ”¯æŒLinuxï¼Œå°±å¯ä»¥ç›´æ¥è¿ç§»ç¡¬ç›˜ï¼Œå…¼å®¹æ€§æå¥½ã€‚ é˜µåˆ—å¡ï¼šé˜µåˆ—ä¿¡æ¯å­˜å‚¨åœ¨ç¡¬ä»¶å¡ä¸Šï¼Œé€šå¸¸å¿…é¡»åœ¨åŒå“ç‰Œæˆ–å…¼å®¹çš„ç¡¬ä»¶å¡ä¸‹æ‰èƒ½è¿ç§»æ•°æ®ï¼Œæ¢å¡å¯èƒ½å¯¼è‡´é˜µåˆ—æŸåã€‚ 4. æˆæœ¬ä¸éƒ¨ç½² mdadmï¼šå®Œå…¨å…è´¹ï¼Œæ— éœ€é¢å¤–ç¡¬ä»¶ã€‚ é˜µåˆ—å¡ï¼šæˆæœ¬è¾ƒé«˜ï¼Œéœ€è¦å•ç‹¬è´­ä¹°ç¡¬ä»¶å¡ã€‚ 5. ç»´æŠ¤ä¸ä¿®å¤ mdadmï¼šé…ç½®çµæ´»ï¼Œæ•…éšœä¿®å¤ä¸»è¦é è½¯ä»¶å‘½ä»¤è¡Œæ“ä½œã€‚ é˜µåˆ—å¡ï¼šéœ€è¦åœ¨BIOS/UEFIä¸­é…ç½®ï¼Œæ”¯æŒç£ç›˜çƒ­æ’æ‹”ä¿æŠ¤æ›´å¥½ã€‚ æ€»ç»“å»ºè®® ä½¿ç”¨mdadmï¼šé€‚ç”¨äºLinuxç³»ç»Ÿã€é¢„ç®—æœ‰é™ã€è¿½æ±‚é«˜å…¼å®¹æ€§å’Œçµæ´»æ€§çš„åœºæ™¯ï¼ˆå¦‚NASã€å®¶åº­æœåŠ¡å™¨ï¼‰ã€‚ ä½¿ç”¨é˜µåˆ—å¡ï¼šé€‚ç”¨äºæ€§èƒ½è¦æ±‚æé«˜ã€é«˜å¹¶å‘ã€éœ€è¦ä¿æŠ¤ç³»ç»Ÿæ ¸å¿ƒæ€§èƒ½çš„ä¼ä¸šçº§æœåŠ¡å™¨åœºæ™¯ã€‚ "},{"id":502,"href":"/database/design/delete-and-data-lifecycle-management/","title":"è½¯åˆ é™¤ + ç”Ÿå‘½å‘¨æœŸ","parent":"Design","content":"ä»¥ä¸‹æ˜¯ä¸€å¥— â€œè½¯åˆ é™¤ + ç”Ÿå‘½å‘¨æœŸï¼ˆData Lifecycle Managementï¼‰â€çš„å®Œæ•´å·¥ç¨‹çº§æ–¹æ¡ˆã€‚\nè¿™æ˜¯å¤§å‚ / é‡‘è / æ ¸å¿ƒç³»ç»Ÿé‡Œéå¸¸æˆç†Ÿçš„ä¸€ç§è®¾è®¡æ–¹å¼ã€‚\nå†…å®¹ï¼šè®¾è®¡ç›®æ ‡ -\u0026gt; è¡¨ç»“æ„ -\u0026gt; çŠ¶æ€æµè½¬ -\u0026gt; æŸ¥è¯¢ä¸ç´¢å¼• -\u0026gt; å½’æ¡£ä¸æ¸…ç† -\u0026gt; å¸¸è§å‘\nä¸€ã€è®¾è®¡ç›®æ ‡ï¼ˆå…ˆå®šåŸåˆ™ï¼‰ æ•°æ®ä¸ä¸¢ã€å¯è¿½æº¯ã€å¯å›æ»šã€å¯æ§åˆ¶æˆæœ¬\næ ¸å¿ƒæ€æƒ³ä¸æ˜¯â€œä¸åˆ â€ï¼Œè€Œæ˜¯ï¼š\nä¸šåŠ¡åˆ é™¤ â‰  ç‰©ç†åˆ é™¤ åˆ é™¤åªæ˜¯ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸€ä¸ªçŠ¶æ€ ç‰©ç†åˆ é™¤æ˜¯æœ€åä¸€æ­¥ã€å¯æ§çš„åå°è¡Œä¸º äºŒã€ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ï¼ˆæ¨èï¼‰ âœ… 4 ä¸ªçŠ¶æ€è¶³å¤Ÿè¦†ç›– 95% ä¸šåŠ¡ ACTIVE -\u0026gt; SOFT_DELETED -\u0026gt; ARCHIVED -\u0026gt; PURGED çŠ¶æ€ å«ä¹‰ ACTIVE æ­£å¸¸å¯ç”¨ SOFT_DELETED ä¸šåŠ¡ä¸å¯è§ï¼ˆå›æ”¶ç«™ï¼‰ ARCHIVED å½’æ¡£ï¼ˆåªè¯»ã€å†·æ•°æ®ï¼‰ PURGED ç‰©ç†åˆ é™¤ ä¸‰ã€æ¨èè¡¨ç»“æ„ï¼ˆç”Ÿäº§çº§ï¼‰ CREATE TABLE orders ( id BIGSERIAL PRIMARY KEY, -- ä¸šåŠ¡å­—æ®µ user_id BIGINT NOT NULL, amount NUMERIC(10,2) NOT NULL, -- ç”Ÿå‘½å‘¨æœŸå­—æ®µ status SMALLINT NOT NULL DEFAULT 1, -- 1=active, 2=soft_deleted, 3=archived deleted_at TIMESTAMPTZ, deleted_by TEXT, archived_at TIMESTAMPTZ, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now() ); ğŸ‘‰ ä¸è¦åªç”¨ is_deletedï¼Œä¸€å®šè¦æœ‰æ—¶é—´å’ŒçŠ¶æ€\nå››ã€çŠ¶æ€æµè½¬è§„åˆ™ï¼ˆéå¸¸å…³é”®ï¼‰ 1ï¸âƒ£ ACTIVE -\u0026gt; SOFT_DELETEDï¼ˆä¸šåŠ¡åˆ é™¤ï¼‰ UPDATE orders SET status = 2, deleted_at = now(), deleted_by = \u0026#39;user:123\u0026#39; WHERE id = 1001 AND status = 1; è§„åˆ™\nåªå…è®¸ä» ACTIVE åˆ é™¤ ä¸å…è®¸é‡å¤åˆ é™¤ å¯æ¢å¤ 2ï¸âƒ£ SOFT_DELETED -\u0026gt; ACTIVEï¼ˆæ¢å¤ï¼‰ UPDATE orders SET status = 1, deleted_at = NULL, deleted_by = NULL WHERE id = 1001 AND status = 2; 3ï¸âƒ£ SOFT_DELETED -\u0026gt; ARCHIVEDï¼ˆå½’æ¡£ï¼‰ åå°ä»»åŠ¡ï¼š\nUPDATE orders SET status = 3, archived_at = now() WHERE status = 2 AND deleted_at \u0026lt; now() - interval \u0026#39;30 days\u0026#39;; ç‰¹ç‚¹\nä¸å†å‚ä¸åœ¨çº¿ä¸šåŠ¡ åªè¯» è®¿é—®é¢‘ç‡æä½ 4ï¸âƒ£ ARCHIVED -\u0026gt; PURGEDï¼ˆç‰©ç†åˆ é™¤ï¼‰ DELETE FROM orders WHERE status = 3 AND archived_at \u0026lt; now() - interval \u0026#39;1 year\u0026#39;; ğŸ‘‰ è¿™ä¸€æ­¥å¿…é¡»æ˜¯åå°ä»»åŠ¡ + å¯å®¡è®¡\näº”ã€æŸ¥è¯¢ä¸ç´¢å¼•è®¾è®¡ï¼ˆå†³å®šæˆè´¥ï¼‰ 1ï¸âƒ£ æ‰€æœ‰åœ¨çº¿æŸ¥è¯¢åªçœ‹ ACTIVE PostgreSQLï¼ˆæœ€ä½³ï¼‰ CREATE INDEX idx_orders_active_user ON orders(user_id) WHERE status = 1; MySQLï¼ˆé€€è€Œæ±‚å…¶æ¬¡ï¼‰ CREATE INDEX idx_orders_user_status ON orders(user_id, status); 2ï¸âƒ£ å”¯ä¸€çº¦æŸï¼ˆéå¸¸å¸¸è§éœ€æ±‚ï¼‰ ä¾‹å¦‚ï¼š\nğŸ‘‰ åŒä¸€ç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ªâ€œæ´»è·ƒè®¢å•â€\nPostgreSQLï¼ˆä¼˜é›…ï¼‰ CREATE UNIQUE INDEX uniq_active_order ON orders(user_id) WHERE status = 1; MySQLï¼ˆåº”ç”¨å±‚ä¿è¯ï¼‰ 3ï¸âƒ£ View å°è£…ï¼ˆå¼ºçƒˆæ¨èï¼‰ CREATE VIEW orders_active AS SELECT * FROM orders WHERE status = 1; åº”ç”¨å±‚åªæŸ¥ orders_active\nå…­ã€å½’æ¡£è®¾è®¡ï¼ˆé¿å…è¡¨æ— é™è†¨èƒ€ï¼‰ æ–¹æ¡ˆä¸€ï¼šå½’æ¡£è¡¨ï¼ˆæœ€å¸¸è§ï¼‰ CREATE TABLE orders_archive (LIKE orders); INSERT INTO orders_archive SELECT * FROM orders WHERE status = 3; DELETE FROM orders WHERE status = 3; æ–¹æ¡ˆäºŒï¼šåˆ†åŒºè¡¨ï¼ˆæ›´é«˜çº§ï¼‰ PARTITION BY RANGE (created_at); ACTIVE åœ¨æ–°åˆ†åŒº è€åˆ†åŒºç›´æ¥ DETACH + DROP ä¸ƒã€å®¡è®¡ä¸åˆè§„ï¼ˆæ ¸å¿ƒç³»ç»Ÿå¿…å¤‡ï¼‰ CREATE TABLE order_audit ( id BIGSERIAL PRIMARY KEY, order_id BIGINT, action TEXT, operator TEXT, action_time TIMESTAMPTZ DEFAULT now(), detail JSONB ); delete restore archive purge å…«ã€å¸¸è§å‘ï¼ˆçœŸå®è¸©è¿‡ï¼‰ âŒ åªåŠ  is_deleted æ— æ³•å®¡è®¡ æ— æ³•å½’æ¡£ æ— æ³•æ¢å¤ âŒ æŸ¥è¯¢ä¸ç»Ÿä¸€ ä¸€æ¬¡å¿˜åŠ æ¡ä»¶ = äº‹æ•… âŒ æ²¡æœ‰ç´¢å¼• deleted æ•°æ®è¶Šå¤šï¼ŒæŸ¥è¯¢è¶Šæ…¢ âŒ æ°¸ä¸ purge è¡¨æ— é™å¤§ VACUUM / purge å‹åŠ›æš´å¢ ä¹ã€PostgreSQL vs MySQL çš„å®è·µå»ºè®® ç»´åº¦ PostgreSQL MySQL ç”Ÿå‘½å‘¨æœŸè®¾è®¡ â­â­â­â­â­ â­â­â­â­ éƒ¨åˆ†ç´¢å¼• å¼º æ—  View / RLS å¼º ä¸€èˆ¬ å†·çƒ­æ•°æ® åˆ†åŒºæå¼º å¯ç”¨ åã€æ€»ç»“ è½¯åˆ é™¤ä¸æ˜¯ä¸ºäº†â€œä¸åˆ â€ï¼Œè€Œæ˜¯ä¸ºäº†â€œå¯æ§åœ°åˆ â€ã€‚\nç”Ÿå‘½å‘¨æœŸè®¾è®¡çš„ç›®æ ‡ï¼Œæ˜¯æŠŠâ€œå±é™©æ“ä½œâ€å˜æˆâ€œåå°ã€å¯å®¡è®¡ã€å¯å›æ»šçš„æµç¨‹â€ã€‚\næ ¸å¿ƒæ•°æ®ï¼Œä¸åšç ´åæ€§åˆ é™¤ï¼ˆdelete from xxxï¼‰ï¼Œåšé€»è¾‘åˆ é™¤(is_deleted)ï¼Œå¯ä»¥è¿™æ ·è®¾è®¡å—ï¼Ÿå¦‚æœå¯ä»¥è¿™æ ·è®¾è®¡ï¼Œä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ å¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯éå¸¸å¸¸è§ã€ä¹Ÿéå¸¸æˆç†Ÿçš„ä¸€ç§è®¾è®¡ã€‚\nä½†å®ƒ**ä¸æ˜¯â€œé“¶å¼¹â€ï¼Œå¿…é¡»é…åˆæ­£ç¡®çš„è¡¨è®¾è®¡ã€ç´¢å¼•ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œ**å¦åˆ™åæœŸä¸€å®šä¼šå‡ºé—®é¢˜ã€‚\nä» ç»“è®º -\u0026gt; è®¾è®¡æ–¹å¼ -\u0026gt; ä¼˜ç¼ºç‚¹ -\u0026gt; ä»€ä¹ˆæ—¶å€™ä¸è¯¥ç”¨ -\u0026gt; æœ€ä½³å®è·µ äº”ä¸ªå±‚æ¬¡è®²ã€‚\nä¸€ã€å…ˆç»™ç»“è®ºï¼ˆç›´æ¥å›ç­”ä½ ï¼‰ âœ… æ ¸å¿ƒæ•°æ®å®Œå…¨å¯ä»¥â€œä¸åšç‰©ç†åˆ é™¤â€ï¼Œç»Ÿä¸€ç”¨é€»è¾‘åˆ é™¤ï¼ˆis_deletedï¼‰\nâ— ä½†å‰ææ˜¯ï¼šä½ çŸ¥é“è‡ªå·±åœ¨æ‰¿æ‹…ä»€ä¹ˆæˆæœ¬ï¼Œå¹¶ä¸”æœ‰é…å¥—æ–¹æ¡ˆ\näºŒã€å…¸å‹é€»è¾‘åˆ é™¤è®¾è®¡æ–¹å¼ 1ï¸âƒ£ æœ€åŸºç¡€ç‰ˆæœ¬ï¼ˆä¸æ¨èå•ç‹¬ç”¨ï¼‰ is_deleted BOOLEAN NOT NULL DEFAULT false é—®é¢˜\næ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™åˆ çš„ æ— æ³•çŸ¥é“è°åˆ çš„ æ— æ³•åšå›æ”¶ç«™ æ— æ³•åšæ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç† 2ï¸âƒ£ æ¨èç‰ˆæœ¬ï¼ˆç”Ÿäº§å¯ç”¨ï¼‰ is_deleted BOOLEAN NOT NULL DEFAULT false, deleted_at TIMESTAMPTZ, deleted_by TEXT è¡Œä¸ºçº¦å®š\nä¸šåŠ¡åˆ é™¤ = UPDATE æ‰€æœ‰æŸ¥è¯¢é»˜è®¤åŠ  is_deleted = false åˆ é™¤ä¸æ˜¯ç»ˆæ€ï¼Œåªæ˜¯â€œä¸å¯è§â€ 3ï¸âƒ£ æ›´é«˜çº§ç‰ˆæœ¬ï¼ˆè½¯åˆ é™¤ + ç”Ÿå‘½å‘¨æœŸï¼‰[æœ¬æ–‡æ ¸å¿ƒ] status SMALLINT NOT NULL DEFAULT 1 -- 1=active, 2=deleted, 3=archived æˆ–è€…ï¼š\nvalid_from TIMESTAMPTZ, valid_to TIMESTAMPTZ ä¸‰ã€ä¸ºä»€ä¹ˆæ ¸å¿ƒæ•°æ®â€œå–œæ¬¢â€é€»è¾‘åˆ é™¤ï¼Ÿ âœ… ä¼˜ç‚¹ï¼ˆè¿™æ˜¯å®ƒå­˜åœ¨çš„åŸå› ï¼‰\n1ï¸âƒ£ æ•°æ®å®‰å…¨ï¼ˆæœ€é‡è¦ï¼‰ é˜²è¯¯åˆ  æ”¯æŒå›æ»š æ”¯æŒå®¡è®¡ æ»¡è¶³åˆè§„ï¼ˆé‡‘èã€å®¡è®¡ã€é£æ§ï¼‰ delete ä¸€æ¡ = æ°¸ä¹…ç ´å\nupdate ä¸€æ¡ = å¯æ§çŠ¶æ€å˜æ›´\n2ï¸âƒ£ å®¡è®¡ä¸è¿½æº¯ è°åˆ çš„ï¼Ÿ ä»€ä¹ˆæ—¶å€™åˆ çš„ï¼Ÿ åˆ ä¹‹å‰æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ ğŸ‘‰ é€»è¾‘åˆ é™¤æ˜¯å®¡è®¡çš„åŸºç¡€\n3ï¸âƒ£ å¤–é”® \u0026amp; ä¸šåŠ¡ä¸€è‡´æ€§æ›´å®¹æ˜“ ä¸ç ´åå†å²è®¢å•ã€è´¦åŠ¡ã€æ—¥å¿— é¿å…å¤§é‡ ON DELETE RESTRICT 4ï¸âƒ£ ä¸ MVCC / WAL æœºåˆ¶å¤©ç„¶é€‚é… UPDATE æœ¬è´¨å°±æ˜¯æ–°ç‰ˆæœ¬ ä¸è§¦å‘å¤§è§„æ¨¡é¡µæ¸…ç† å¯¹ PostgreSQL / InnoDB éƒ½å‹å¥½ å››ã€é€»è¾‘åˆ é™¤çš„ä»£ä»·ï¼ˆå¿…é¡»æ¸…æ¥šï¼‰ âŒ ç¼ºç‚¹ï¼ˆéå¸¸ç°å®ï¼‰\n1ï¸âƒ£ æŸ¥è¯¢å¤æ‚åº¦ä¸Šå‡ï¼ˆæœ€å¸¸è§å‘ï¼‰ å¿˜åŠ æ¡ä»¶ = æ•°æ®äº‹æ•…\nSELECT * FROM orders; -- âŒ SELECT * FROM orders WHERE is_deleted = false; -- âœ… è§£å†³æ–¹å¼ï¼š\nORM å…¨å±€è¿‡æ»¤ View Row Level Securityï¼ˆPGï¼‰ 2ï¸âƒ£ ç´¢å¼•å˜å¤æ‚ å¦‚æœä½ ä¸è®¾è®¡å¥½ç´¢å¼•ï¼š\ndeleted æ•°æ®è¶Šæ¥è¶Šå¤š ç´¢å¼•è†¨èƒ€ æŸ¥è¯¢è¶Šæ¥è¶Šæ…¢ ğŸ‘‰ å¿…é¡»æœ‰ç»„åˆç´¢å¼•\nCREATE INDEX idx_orders_active ON orders (user_id) WHERE is_deleted = false; ï¼ˆPostgreSQL éƒ¨åˆ†ç´¢å¼•æå…¶é‡è¦ï¼‰\n3ï¸âƒ£ å”¯ä¸€çº¦æŸå˜éº»çƒ¦ï¼ˆé«˜é¢‘è¸©å‘ï¼‰ ä¾‹å¦‚ï¼š\nUNIQUE (username) å¦‚æœé€»è¾‘åˆ é™¤åæƒ³å…è®¸é‡å»ºåŒåç”¨æˆ·ï¼Ÿ\nâŒ è¡Œä¸é€š\næ­£ç¡®åšæ³•ï¼ˆPGï¼‰\nCREATE UNIQUE INDEX uniq_user_active ON users(username) WHERE is_deleted = false; 4ï¸âƒ£ è¡¨ä¼šâ€œæ— é™é•¿â€ deleted æ•°æ®æ°¸è¿œå­˜åœ¨ VACUUM å‹åŠ›å˜å¤§ å†·æ•°æ®æ‹–æ…¢çƒ­æŸ¥è¯¢ ğŸ‘‰ è¿™ä¸æ˜¯ bugï¼Œæ˜¯è®¾è®¡é€‰æ‹©\näº”ã€ä»€ä¹ˆæ—¶å€™ ä¸é€‚åˆ é€»è¾‘åˆ é™¤ï¼Ÿ âŒ ä¸æ¨èåœºæ™¯\nåœºæ™¯ åŸå›  ä¸´æ—¶æ•°æ® æ— ä»·å€¼ ç¼“å­˜è¡¨ å¯é‡å»º ä¸­é—´è®¡ç®—è¡¨ å¯ä¸¢ é«˜é¢‘å†™ + æ— å®¡è®¡ çº¯æ€§èƒ½ä¼˜å…ˆ æ—¥å¿—å‹è¡¨ append-only è¿™äº›è¡¨ï¼š\nç›´æ¥ DELETE æˆ– TRUNCATE æˆ–ç›´æ¥åˆ†åŒº DROP å…­ã€æˆç†Ÿç³»ç»Ÿçš„æœ€ä½³å®è·µï¼ˆéå¸¸é‡è¦ï¼‰ 1ï¸âƒ£ åˆ†å±‚å¤„ç†ï¼ˆå¼ºçƒˆæ¨èï¼‰ æ•°æ®ç±»å‹ ç­–ç•¥ æ ¸å¿ƒä¸šåŠ¡æ•°æ® é€»è¾‘åˆ é™¤ å†å²å½’æ¡£ ç‰©ç†è¿ç§» å†·æ•°æ® åˆ†åŒº + DROP ä¸­é—´è¡¨ ç‰©ç†åˆ é™¤ 2ï¸âƒ£ é…å¥—æœºåˆ¶ï¼ˆç¼ºä¸€ä¸å¯ï¼‰ ğŸ”¹ ç»Ÿä¸€æŸ¥è¯¢å…¥å£\nORM é»˜è®¤åŠ  is_deleted=false ç¦æ­¢è£¸ SQLï¼ˆæˆ– code reviewï¼‰ ğŸ”¹ éƒ¨åˆ†ç´¢å¼• / è¿‡æ»¤ç´¢å¼•\nPostgreSQLï¼šå¿…é¡»ç”¨ MySQLï¼šåªèƒ½é ç»„åˆç´¢å¼• ğŸ”¹ å®šæœŸå½’æ¡£\ndeleted è¶…è¿‡ 6 / 12 ä¸ªæœˆ è¿ç§»åˆ° history è¡¨ æˆ–å†·åº“ 3ï¸âƒ£ PostgreSQL vs MySQL å·®å¼‚ é¡¹ç›® PostgreSQL MySQL éƒ¨åˆ†ç´¢å¼• âœ… å¼º âŒ æŸ¥è¯¢æ§åˆ¶ RLS / View åº”ç”¨å±‚ VACUUM é‡è¦ purge é€‚åˆé€»è¾‘åˆ é™¤ éå¸¸é€‚åˆ å¯ç”¨ä½†è¦è°¨æ… ä¸ƒã€æ€»ç»“ é€»è¾‘åˆ é™¤é€‚åˆæ ¸å¿ƒã€å¯å®¡è®¡ã€ä¸å¯ä¸¢çš„æ•°æ®ï¼Œä½†å®ƒæ˜¯â€œç©ºé—´æ¢å®‰å…¨ã€å¤æ‚åº¦æ¢å¯æ§â€çš„è®¾è®¡ï¼Œå¿…é¡»é…åˆç´¢å¼•ã€æŸ¥è¯¢çº¦æŸå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¦åˆ™ä¸€å®šä¼šæ‹–æ…¢ç³»ç»Ÿã€‚\n","description":"ä»¥ä¸‹æ˜¯ä¸€å¥— â€œè½¯åˆ é™¤ + ç”Ÿå‘½å‘¨æœŸï¼ˆData Lifecycle Managementï¼‰â€çš„å®Œæ•´å·¥ç¨‹çº§æ–¹æ¡ˆã€‚\nè¿™æ˜¯å¤§å‚ / é‡‘è / æ ¸å¿ƒç³»ç»Ÿé‡Œéå¸¸æˆç†Ÿçš„ä¸€ç§è®¾è®¡æ–¹å¼ã€‚\nå†…å®¹ï¼šè®¾è®¡ç›®æ ‡ -\u0026gt; è¡¨ç»“æ„ -\u0026gt; çŠ¶æ€æµè½¬ -\u0026gt; æŸ¥è¯¢ä¸ç´¢å¼• -\u0026gt; å½’æ¡£ä¸æ¸…ç† -\u0026gt; å¸¸è§å‘\nä¸€ã€è®¾è®¡ç›®æ ‡ï¼ˆå…ˆå®šåŸåˆ™ï¼‰ æ•°æ®ä¸ä¸¢ã€å¯è¿½æº¯ã€å¯å›æ»šã€å¯æ§åˆ¶æˆæœ¬\næ ¸å¿ƒæ€æƒ³ä¸æ˜¯â€œä¸åˆ â€ï¼Œè€Œæ˜¯ï¼š\nä¸šåŠ¡åˆ é™¤ â‰  ç‰©ç†åˆ é™¤ åˆ é™¤åªæ˜¯ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸€ä¸ªçŠ¶æ€ ç‰©ç†åˆ é™¤æ˜¯æœ€åä¸€æ­¥ã€å¯æ§çš„åå°è¡Œä¸º äºŒã€ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ï¼ˆæ¨èï¼‰ âœ… 4 ä¸ªçŠ¶æ€è¶³å¤Ÿè¦†ç›– 95% ä¸šåŠ¡ ACTIVE -\u0026gt; SOFT_DELETED -\u0026gt; ARCHIVED -\u0026gt; PURGED çŠ¶æ€ å«ä¹‰ ACTIVE æ­£å¸¸å¯ç”¨ SOFT_DELETED ä¸šåŠ¡ä¸å¯è§ï¼ˆå›æ”¶ç«™ï¼‰ ARCHIVED å½’æ¡£ï¼ˆåªè¯»ã€å†·æ•°æ®ï¼‰ PURGED ç‰©ç†åˆ é™¤ ä¸‰ã€æ¨èè¡¨ç»“æ„ï¼ˆç”Ÿäº§çº§ï¼‰ CREATE TABLE orders ( id BIGSERIAL PRIMARY KEY, -- ä¸šåŠ¡å­—æ®µ user_id BIGINT NOT NULL, amount NUMERIC(10,2) NOT NULL, -- ç”Ÿå‘½å‘¨æœŸå­—æ®µ status SMALLINT NOT NULL DEFAULT 1, -- 1=active, 2=soft_deleted, 3=archived deleted_at TIMESTAMPTZ, deleted_by TEXT, archived_at TIMESTAMPTZ, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), updated_at TIMESTAMPTZ NOT NULL DEFAULT now() ); ğŸ‘‰ ä¸è¦åªç”¨ is_deletedï¼Œä¸€å®šè¦æœ‰æ—¶é—´å’ŒçŠ¶æ€\n"}]